<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diffusion & Brownian Motion | Chemistry</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            color: #e0e0e0;
            min-height: 100vh;
            overflow: hidden;
        }
        #canvas { display: block; }
        .controls {
            position: fixed;
            top: 20px; right: 20px;
            background: rgba(0,0,0,0.85);
            padding: 20px; border-radius: 15px;
            min-width: 280px;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        h1 { color: #10b981; font-size: 1.3em; margin-bottom: 15px; }
        .control-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; color: #aaa; font-size: 0.9em; }
        input[type="range"], select { width: 100%; }
        .value { float: right; color: #10b981; }
        button {
            width: 100%; padding: 10px; margin: 5px 0;
            border: none; border-radius: 8px;
            background: #10b981; color: white;
            font-weight: bold; cursor: pointer;
        }
        button:hover { background: #34d399; }
        .stats { margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); }
        .stat-row { display: flex; justify-content: space-between; padding: 5px 0; font-size: 0.9em; }
        .stat-label { color: #888; }
        .stat-value { color: #10b981; font-weight: bold; }
        .info { font-size: 0.8em; color: #666; margin-top: 15px; line-height: 1.5; }
        a.back-link {
            position: fixed; top: 20px; left: 20px;
            color: #10b981; text-decoration: none;
            background: rgba(0,0,0,0.8); padding: 10px 20px;
            border-radius: 25px; font-size: 0.9em;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <a href="index.html" class="back-link">‚Üê Back to Chemistry</a>

    <div class="controls">
        <h1>Diffusion & Brownian Motion</h1>
        <p style="font-size:0.85em; color:#888; margin-bottom:15px;">Random walk dynamics</p>

        <div class="control-group">
            <label>Particles: <span class="value" id="particlesValue">200</span></label>
            <input type="range" id="particles" min="50" max="500" step="50" value="200">
        </div>

        <div class="control-group">
            <label>Temperature: <span class="value" id="tempValue">1.0</span></label>
            <input type="range" id="temperature" min="0.1" max="3" step="0.1" value="1.0">
        </div>

        <div class="control-group">
            <label>Mode</label>
            <select id="mode">
                <option value="brownian">Brownian Motion (Track One)</option>
                <option value="diffusion">Diffusion (Two Chambers)</option>
                <option value="gradient">Concentration Gradient</option>
            </select>
        </div>

        <div class="control-group">
            <label>Membrane Permeability: <span class="value" id="permValue">0.5</span></label>
            <input type="range" id="permeability" min="0" max="1" step="0.1" value="0.5">
        </div>

        <button id="runBtn">Start Simulation</button>
        <button id="resetBtn" style="background:#444;color:#fff">Reset</button>

        <div class="stats">
            <div class="stat-row">
                <span class="stat-label">Time</span>
                <span class="stat-value" id="timeStep">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Left Chamber</span>
                <span class="stat-value" id="leftCount">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Right Chamber</span>
                <span class="stat-value" id="rightCount">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Mean Squared Disp.</span>
                <span class="stat-value" id="msd">0</span>
            </div>
        </div>

        <div class="info">
            <strong>Brownian:</strong> Random motion from molecular collisions.<br>
            <strong>Fick's Law:</strong> J = -D (dC/dx)
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            initParticles();
        }
        resize();
        window.onresize = resize;

        let particles = [];
        let trackedParticle = null;
        let trackedPath = [];
        let nParticles = 200;
        let temperature = 1.0;
        let mode = 'brownian';
        let permeability = 0.5;
        let running = false;
        let timeStep = 0;

        function initParticles() {
            particles = [];
            trackedPath = [];
            timeStep = 0;

            const w = canvas.width - 400;
            const h = canvas.height - 100;
            const midX = 50 + w / 2;

            for (let i = 0; i < nParticles; i++) {
                let x, y;

                if (mode === 'diffusion') {
                    // All start in left chamber
                    x = 50 + Math.random() * (w / 2 - 20);
                    y = 50 + Math.random() * h;
                } else if (mode === 'gradient') {
                    // Gradient from left to right
                    if (i < nParticles * 0.7) {
                        x = 50 + Math.random() * (w * 0.3);
                    } else {
                        x = 50 + Math.random() * w;
                    }
                    y = 50 + Math.random() * h;
                } else {
                    // Random distribution
                    x = 50 + Math.random() * w;
                    y = 50 + Math.random() * h;
                }

                particles.push({
                    x, y,
                    startX: x,
                    startY: y,
                    vx: 0, vy: 0,
                    color: mode === 'brownian' && i === 0 ? '#ef4444' : '#10b981'
                });
            }

            if (mode === 'brownian') {
                trackedParticle = particles[0];
                particles[0].color = '#ef4444';
            }

            updateStats();
        }

        function update() {
            if (!running) return;

            const w = canvas.width - 400;
            const h = canvas.height - 100;
            const midX = 50 + w / 2;

            for (const p of particles) {
                // Random Brownian motion
                const kickStrength = Math.sqrt(temperature) * 2;
                p.vx += (Math.random() - 0.5) * kickStrength;
                p.vy += (Math.random() - 0.5) * kickStrength;

                // Damping
                p.vx *= 0.9;
                p.vy *= 0.9;

                p.x += p.vx;
                p.y += p.vy;

                // Wall collisions
                if (p.x < 55) { p.x = 55; p.vx = -p.vx * 0.5; }
                if (p.x > 45 + w) { p.x = 45 + w; p.vx = -p.vx * 0.5; }
                if (p.y < 55) { p.y = 55; p.vy = -p.vy * 0.5; }
                if (p.y > 45 + h) { p.y = 45 + h; p.vy = -p.vy * 0.5; }

                // Membrane in diffusion mode
                if (mode === 'diffusion' || mode === 'gradient') {
                    // Check if crossing membrane
                    const membraneGap = 30;
                    const gapY = 50 + h / 2;

                    if (Math.abs(p.x - midX) < 10) {
                        // Near membrane
                        if (p.y < gapY - membraneGap || p.y > gapY + membraneGap) {
                            // Blocked by membrane
                            if (Math.random() > permeability) {
                                if (p.x < midX) {
                                    p.x = midX - 10;
                                } else {
                                    p.x = midX + 10;
                                }
                                p.vx = -p.vx * 0.5;
                            }
                        }
                    }
                }
            }

            // Track path for Brownian mode
            if (mode === 'brownian' && trackedParticle) {
                trackedPath.push({ x: trackedParticle.x, y: trackedParticle.y });
                if (trackedPath.length > 1000) trackedPath.shift();
            }

            timeStep++;
            updateStats();
        }

        function updateStats() {
            const w = canvas.width - 400;
            const midX = 50 + w / 2;

            const leftCount = particles.filter(p => p.x < midX).length;
            const rightCount = particles.filter(p => p.x >= midX).length;

            // Mean squared displacement
            let msd = 0;
            for (const p of particles) {
                const dx = p.x - p.startX;
                const dy = p.y - p.startY;
                msd += dx * dx + dy * dy;
            }
            msd /= particles.length;

            document.getElementById('timeStep').textContent = timeStep;
            document.getElementById('leftCount').textContent = leftCount;
            document.getElementById('rightCount').textContent = rightCount;
            document.getElementById('msd').textContent = msd.toFixed(1);
        }

        function draw() {
            ctx.fillStyle = '#0f172a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            update();

            const w = canvas.width - 400;
            const h = canvas.height - 100;
            const midX = 50 + w / 2;

            // Draw container
            ctx.strokeStyle = '#10b981';
            ctx.lineWidth = 2;
            ctx.strokeRect(50, 50, w, h);

            // Draw membrane in diffusion mode
            if (mode === 'diffusion' || mode === 'gradient') {
                const gapY = 50 + h / 2;
                const membraneGap = 30;

                ctx.strokeStyle = '#fbbf24';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.moveTo(midX, 50);
                ctx.lineTo(midX, gapY - membraneGap);
                ctx.moveTo(midX, gapY + membraneGap);
                ctx.lineTo(midX, 50 + h);
                ctx.stroke();

                // Labels
                ctx.fillStyle = '#888';
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('Left Chamber', 50 + w / 4, 40);
                ctx.fillText('Right Chamber', 50 + w * 3 / 4, 40);
            }

            // Draw Brownian path
            if (mode === 'brownian' && trackedPath.length > 1) {
                ctx.beginPath();
                ctx.strokeStyle = 'rgba(239, 68, 68, 0.3)';
                ctx.lineWidth = 1;
                for (let i = 0; i < trackedPath.length; i++) {
                    if (i === 0) {
                        ctx.moveTo(trackedPath[i].x, trackedPath[i].y);
                    } else {
                        ctx.lineTo(trackedPath[i].x, trackedPath[i].y);
                    }
                }
                ctx.stroke();
            }

            // Draw particles
            for (const p of particles) {
                ctx.beginPath();
                ctx.arc(p.x, p.y, p === trackedParticle ? 8 : 4, 0, Math.PI * 2);
                ctx.fillStyle = p.color;
                ctx.fill();

                if (p === trackedParticle) {
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            }

            // Draw concentration histogram in gradient mode
            if (mode === 'gradient' || mode === 'diffusion') {
                const bins = 20;
                const binWidth = w / bins;
                const binCounts = new Array(bins).fill(0);

                for (const p of particles) {
                    const binIdx = Math.floor((p.x - 50) / binWidth);
                    if (binIdx >= 0 && binIdx < bins) {
                        binCounts[binIdx]++;
                    }
                }

                const maxCount = Math.max(...binCounts);
                ctx.fillStyle = 'rgba(16, 185, 129, 0.3)';
                for (let i = 0; i < bins; i++) {
                    const barHeight = (binCounts[i] / maxCount) * 60;
                    ctx.fillRect(50 + i * binWidth, 50 + h + 10, binWidth - 2, barHeight);
                }
            }

            // Title
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 18px sans-serif';
            ctx.textAlign = 'left';
            const titles = {
                brownian: 'Brownian Motion',
                diffusion: 'Diffusion Through Membrane',
                gradient: 'Concentration Gradient'
            };
            ctx.fillText(titles[mode], 50, 30);

            requestAnimationFrame(draw);
        }

        // Event listeners
        document.getElementById('particles').oninput = (e) => {
            nParticles = parseInt(e.target.value);
            document.getElementById('particlesValue').textContent = nParticles;
        };

        document.getElementById('temperature').oninput = (e) => {
            temperature = parseFloat(e.target.value);
            document.getElementById('tempValue').textContent = temperature.toFixed(1);
        };

        document.getElementById('mode').onchange = (e) => {
            mode = e.target.value;
            initParticles();
        };

        document.getElementById('permeability').oninput = (e) => {
            permeability = parseFloat(e.target.value);
            document.getElementById('permValue').textContent = permeability.toFixed(1);
        };

        document.getElementById('runBtn').onclick = () => {
            running = !running;
            document.getElementById('runBtn').textContent = running ? 'Pause' : 'Start Simulation';
        };

        document.getElementById('resetBtn').onclick = initParticles;

        // Initialize
        initParticles();
        draw();
    </script>
</body>
</html>
