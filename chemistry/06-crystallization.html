<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crystallization | Chemistry</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            color: #e0e0e0;
            min-height: 100vh;
            overflow: hidden;
        }
        #canvas { display: block; }
        .controls {
            position: fixed;
            top: 20px; right: 20px;
            background: rgba(0,0,0,0.85);
            padding: 20px; border-radius: 15px;
            min-width: 280px;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        h1 { color: #10b981; font-size: 1.3em; margin-bottom: 15px; }
        .control-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; color: #aaa; font-size: 0.9em; }
        input[type="range"], select { width: 100%; }
        .value { float: right; color: #10b981; }
        button {
            width: 100%; padding: 10px; margin: 5px 0;
            border: none; border-radius: 8px;
            background: #10b981; color: white;
            font-weight: bold; cursor: pointer;
        }
        button:hover { background: #34d399; }
        .stats { margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); }
        .stat-row { display: flex; justify-content: space-between; padding: 5px 0; font-size: 0.9em; }
        .stat-label { color: #888; }
        .stat-value { color: #10b981; font-weight: bold; }
        .info { font-size: 0.8em; color: #666; margin-top: 15px; line-height: 1.5; }
        a.back-link {
            position: fixed; top: 20px; left: 20px;
            color: #10b981; text-decoration: none;
            background: rgba(0,0,0,0.8); padding: 10px 20px;
            border-radius: 25px; font-size: 0.9em;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <a href="index.html" class="back-link">‚Üê Back to Chemistry</a>

    <div class="controls">
        <h1>Crystallization</h1>
        <p style="font-size:0.85em; color:#888; margin-bottom:15px;">Nucleation and growth</p>

        <div class="control-group">
            <label>Supersaturation: <span class="value" id="satValue">1.5</span></label>
            <input type="range" id="saturation" min="1.0" max="3.0" step="0.1" value="1.5">
        </div>

        <div class="control-group">
            <label>Temperature: <span class="value" id="tempValue">0.5</span></label>
            <input type="range" id="temperature" min="0.1" max="1.5" step="0.1" value="0.5">
        </div>

        <div class="control-group">
            <label>Nucleation Rate: <span class="value" id="nucValue">0.001</span></label>
            <input type="range" id="nucleation" min="0.0005" max="0.01" step="0.0005" value="0.001">
        </div>

        <div class="control-group">
            <label>Crystal Structure</label>
            <select id="structure">
                <option value="cubic">Cubic</option>
                <option value="hexagonal">Hexagonal</option>
                <option value="dendritic">Dendritic (Snowflake)</option>
            </select>
        </div>

        <button id="runBtn">Start Crystallization</button>
        <button id="resetBtn" style="background:#444;color:#fff">Reset</button>
        <button id="seedBtn" style="background:#3b82f6">Add Seed Crystal</button>

        <div class="stats">
            <div class="stat-row">
                <span class="stat-label">Dissolved</span>
                <span class="stat-value" id="dissolved">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Crystallized</span>
                <span class="stat-value" id="crystallized">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Crystal Size</span>
                <span class="stat-value" id="crystalSize">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Nuclei Count</span>
                <span class="stat-value" id="nuclei">0</span>
            </div>
        </div>

        <div class="info">
            <strong>Nucleation:</strong> Formation of crystal seeds.<br>
            <strong>Growth:</strong> Addition of solute to existing crystals.
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            initSimulation();
        }
        resize();
        window.onresize = resize;

        let dissolved = [];
        let crystals = [];
        let supersaturation = 1.5;
        let temperature = 0.5;
        let nucleationRate = 0.001;
        let structure = 'cubic';
        let running = false;
        let timeStep = 0;

        function initSimulation() {
            dissolved = [];
            crystals = [];
            timeStep = 0;

            const w = canvas.width - 400;
            const h = canvas.height - 100;

            const nParticles = Math.floor(200 * supersaturation);
            for (let i = 0; i < nParticles; i++) {
                dissolved.push({
                    x: 60 + Math.random() * (w - 20),
                    y: 60 + Math.random() * (h - 20),
                    vx: (Math.random() - 0.5) * 2 * temperature,
                    vy: (Math.random() - 0.5) * 2 * temperature
                });
            }

            updateStats();
        }

        function addSeed() {
            const w = canvas.width - 400;
            const h = canvas.height - 100;

            crystals.push({
                x: 50 + w / 2,
                y: 50 + h / 2,
                particles: [{ x: 0, y: 0 }],
                growth: [[0, 0]],
                color: `hsl(${180 + Math.random() * 60}, 70%, 60%)`
            });
        }

        function getLatticePositions(crystal, newPos) {
            const positions = [];
            const spacing = 8;

            switch (structure) {
                case 'cubic':
                    positions.push(
                        { x: newPos.x + spacing, y: newPos.y },
                        { x: newPos.x - spacing, y: newPos.y },
                        { x: newPos.x, y: newPos.y + spacing },
                        { x: newPos.x, y: newPos.y - spacing }
                    );
                    break;
                case 'hexagonal':
                    const s60 = Math.sin(Math.PI / 3);
                    const c60 = Math.cos(Math.PI / 3);
                    for (let i = 0; i < 6; i++) {
                        const angle = i * Math.PI / 3;
                        positions.push({
                            x: newPos.x + spacing * Math.cos(angle),
                            y: newPos.y + spacing * Math.sin(angle)
                        });
                    }
                    break;
                case 'dendritic':
                    // Snowflake-like growth - favor 6-fold symmetry
                    for (let i = 0; i < 6; i++) {
                        const angle = i * Math.PI / 3;
                        const r = Math.sqrt(newPos.x * newPos.x + newPos.y * newPos.y);
                        const weight = 1 + 0.5 * Math.cos(6 * Math.atan2(newPos.y, newPos.x));
                        if (Math.random() < weight) {
                            positions.push({
                                x: newPos.x + spacing * Math.cos(angle),
                                y: newPos.y + spacing * Math.sin(angle)
                            });
                        }
                    }
                    break;
            }

            return positions;
        }

        function isPositionOccupied(crystal, pos) {
            for (const p of crystal.particles) {
                const dx = p.x - pos.x;
                const dy = p.y - pos.y;
                if (dx * dx + dy * dy < 25) return true;
            }
            return false;
        }

        function update() {
            if (!running) return;

            const w = canvas.width - 400;
            const h = canvas.height - 100;

            // Move dissolved particles
            for (const p of dissolved) {
                p.vx += (Math.random() - 0.5) * temperature * 0.5;
                p.vy += (Math.random() - 0.5) * temperature * 0.5;
                p.vx *= 0.95;
                p.vy *= 0.95;

                p.x += p.vx;
                p.y += p.vy;

                if (p.x < 55) { p.x = 55; p.vx = -p.vx; }
                if (p.x > 45 + w) { p.x = 45 + w; p.vx = -p.vx; }
                if (p.y < 55) { p.y = 55; p.vy = -p.vy; }
                if (p.y > 45 + h) { p.y = 45 + h; p.vy = -p.vy; }
            }

            // Nucleation
            if (Math.random() < nucleationRate * supersaturation && dissolved.length > 50) {
                const idx = Math.floor(Math.random() * dissolved.length);
                const p = dissolved[idx];

                crystals.push({
                    x: p.x,
                    y: p.y,
                    particles: [{ x: 0, y: 0 }],
                    growth: [[0, 0]],
                    color: `hsl(${180 + Math.random() * 60}, 70%, 60%)`
                });

                dissolved.splice(idx, 1);
            }

            // Crystal growth
            for (const crystal of crystals) {
                // Check each surface site for growth
                const surfaceSites = [];
                for (const p of crystal.particles) {
                    const neighbors = getLatticePositions(crystal, p);
                    for (const n of neighbors) {
                        if (!isPositionOccupied(crystal, n)) {
                            surfaceSites.push(n);
                        }
                    }
                }

                // Try to attach dissolved particles
                for (let i = dissolved.length - 1; i >= 0; i--) {
                    const p = dissolved[i];
                    const relX = p.x - crystal.x;
                    const relY = p.y - crystal.y;

                    for (const site of surfaceSites) {
                        const dx = relX - site.x;
                        const dy = relY - site.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);

                        if (dist < 15) {
                            // Growth probability depends on supersaturation and temperature
                            const growthProb = 0.1 * supersaturation / (1 + temperature);

                            if (structure === 'dendritic') {
                                // Favor tips of branches
                                const r = Math.sqrt(site.x * site.x + site.y * site.y);
                                const tipBonus = r / 100;
                                if (Math.random() < growthProb * (1 + tipBonus)) {
                                    crystal.particles.push({ x: site.x, y: site.y });
                                    dissolved.splice(i, 1);
                                    break;
                                }
                            } else {
                                if (Math.random() < growthProb) {
                                    crystal.particles.push({ x: site.x, y: site.y });
                                    dissolved.splice(i, 1);
                                    break;
                                }
                            }
                        }
                    }
                }
            }

            timeStep++;
            updateStats();
        }

        function updateStats() {
            let totalCrystallized = 0;
            let maxSize = 0;

            for (const c of crystals) {
                totalCrystallized += c.particles.length;
                maxSize = Math.max(maxSize, c.particles.length);
            }

            document.getElementById('dissolved').textContent = dissolved.length;
            document.getElementById('crystallized').textContent = totalCrystallized;
            document.getElementById('crystalSize').textContent = maxSize;
            document.getElementById('nuclei').textContent = crystals.length;
        }

        function draw() {
            ctx.fillStyle = '#0f172a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            update();

            const w = canvas.width - 400;
            const h = canvas.height - 100;

            // Draw container (solution)
            ctx.fillStyle = 'rgba(16, 185, 129, 0.1)';
            ctx.fillRect(50, 50, w, h);
            ctx.strokeStyle = '#10b981';
            ctx.lineWidth = 2;
            ctx.strokeRect(50, 50, w, h);

            // Draw dissolved particles
            ctx.fillStyle = 'rgba(16, 185, 129, 0.5)';
            for (const p of dissolved) {
                ctx.beginPath();
                ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
                ctx.fill();
            }

            // Draw crystals
            for (const crystal of crystals) {
                ctx.fillStyle = crystal.color;

                for (const p of crystal.particles) {
                    ctx.beginPath();

                    if (structure === 'hexagonal' || structure === 'dendritic') {
                        // Draw hexagon
                        const size = 4;
                        ctx.moveTo(crystal.x + p.x + size, crystal.y + p.y);
                        for (let i = 1; i <= 6; i++) {
                            const angle = i * Math.PI / 3;
                            ctx.lineTo(
                                crystal.x + p.x + size * Math.cos(angle),
                                crystal.y + p.y + size * Math.sin(angle)
                            );
                        }
                    } else {
                        // Draw square for cubic
                        ctx.rect(crystal.x + p.x - 3, crystal.y + p.y - 3, 6, 6);
                    }

                    ctx.fill();
                }

                // Crystal outline
                if (crystal.particles.length > 1) {
                    ctx.strokeStyle = 'rgba(255,255,255,0.3)';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                }
            }

            // Title
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 18px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('Crystal Growth Simulation', 50, 30);

            requestAnimationFrame(draw);
        }

        // Event listeners
        document.getElementById('saturation').oninput = (e) => {
            supersaturation = parseFloat(e.target.value);
            document.getElementById('satValue').textContent = supersaturation.toFixed(1);
        };

        document.getElementById('temperature').oninput = (e) => {
            temperature = parseFloat(e.target.value);
            document.getElementById('tempValue').textContent = temperature.toFixed(1);
        };

        document.getElementById('nucleation').oninput = (e) => {
            nucleationRate = parseFloat(e.target.value);
            document.getElementById('nucValue').textContent = nucleationRate.toFixed(4);
        };

        document.getElementById('structure').onchange = (e) => {
            structure = e.target.value;
        };

        document.getElementById('runBtn').onclick = () => {
            running = !running;
            document.getElementById('runBtn').textContent = running ? 'Pause' : 'Start Crystallization';
        };

        document.getElementById('resetBtn').onclick = initSimulation;
        document.getElementById('seedBtn').onclick = addSeed;

        // Initialize
        initSimulation();
        draw();
    </script>
</body>
</html>
