<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Van der Pol Oscillator - Limit Cycle - CCAB</title>
    <meta name="description" content="Interactive Van der Pol oscillator visualization showing limit cycle dynamics. Explore phase portraits and relaxation oscillations with adjustable damping parameter μ.">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #0a0a1a 0%, #1a0a2e 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }

        .back-link {
            position: fixed;
            top: 15px;
            left: 15px;
            padding: 10px 18px;
            background: rgba(0, 0, 0, 0.6);
            color: #e91e63;
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(233, 30, 99, 0.3);
            transition: all 0.3s ease;
        }

        .back-link:hover {
            background: rgba(233, 30, 99, 0.2);
            transform: translateX(-4px);
        }

        .main-container {
            display: flex;
            height: 100vh;
            padding: 80px 20px 100px;
            gap: 20px;
        }

        .canvas-container {
            flex: 1;
            display: flex;
            gap: 20px;
        }

        .viz-panel {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .viz-panel h4 {
            color: #e91e63;
            margin-bottom: 10px;
            font-size: 14px;
            text-align: center;
        }

        canvas {
            flex: 1;
            width: 100%;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.5);
        }

        #info {
            position: fixed;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.85);
            padding: 15px 20px;
            border-radius: 12px;
            color: #e91e63;
            font-size: 13px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(233, 30, 99, 0.2);
            z-index: 1000;
            max-width: 280px;
        }

        #info h3 {
            margin-bottom: 10px;
            color: #f48fb1;
        }

        #info .stat {
            margin: 5px 0;
        }

        #info .stat-label {
            color: #888;
            font-size: 11px;
        }

        #info .stat-value {
            color: #e91e63;
            font-weight: bold;
        }

        #info p {
            font-size: 11px;
            opacity: 0.8;
            line-height: 1.5;
            margin-top: 10px;
            color: #aaa;
        }

        .equation {
            background: rgba(233, 30, 99, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-family: 'Times New Roman', serif;
            font-style: italic;
            text-align: center;
            color: #f48fb1;
        }

        #controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            z-index: 1000;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-group {
            background: rgba(0, 0, 0, 0.7);
            padding: 12px 16px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(233, 30, 99, 0.2);
        }

        .control-group label {
            color: #e91e63;
            font-size: 11px;
            display: block;
            margin-bottom: 5px;
        }

        .control-group input[type="range"] {
            width: 100px;
            accent-color: #e91e63;
        }

        .control-group span {
            color: #fff;
            font-size: 10px;
            margin-left: 6px;
        }

        button {
            background: rgba(233, 30, 99, 0.15);
            border: 1px solid rgba(233, 30, 99, 0.4);
            color: #e91e63;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        button:hover {
            background: rgba(233, 30, 99, 0.3);
        }

        button.active {
            background: rgba(233, 30, 99, 0.4);
            border-color: #e91e63;
        }

        #fps-display {
            position: fixed;
            bottom: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 12px;
            border-radius: 6px;
            color: #e91e63;
            font-size: 12px;
            z-index: 1000;
        }

        @media (max-width: 1000px) {
            .canvas-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <a href="../index.html" class="back-link">← Back to Gallery</a>

    <div class="main-container">
        <div class="canvas-container">
            <div class="viz-panel" style="flex: 1.5;">
                <h4>Phase Portrait (x vs dx/dt)</h4>
                <canvas id="phaseCanvas"></canvas>
            </div>
            <div class="viz-panel">
                <h4>Time Series</h4>
                <canvas id="timeCanvas"></canvas>
            </div>
        </div>
    </div>

    <div id="info">
        <h3>Van der Pol Oscillator</h3>
        <div class="stat">
            <span class="stat-label">Parameter μ</span>
            <span class="stat-value" id="mu-display">1.00</span>
        </div>
        <div class="stat">
            <span class="stat-label">Position x</span>
            <span class="stat-value" id="x-display">0.00</span>
        </div>
        <div class="stat">
            <span class="stat-label">Velocity dx/dt</span>
            <span class="stat-value" id="v-display">0.00</span>
        </div>
        <div class="stat">
            <span class="stat-label">Behavior</span>
            <span class="stat-value" id="behavior">Limit Cycle</span>
        </div>
        <div class="equation">
            d²x/dt² − μ(1−x²)dx/dt + x = 0
        </div>
        <p>Discovered by Balthasar van der Pol in 1927. When μ > 0, all trajectories spiral toward a stable limit cycle - a key example of self-sustained oscillation.</p>
    </div>

    <div id="controls">
        <div class="control-group">
            <label>Damping μ: <span id="mu-val">1.00</span></label>
            <input type="range" id="mu-slider" min="0" max="5" step="0.1" value="1">
        </div>
        <div class="control-group">
            <label>Initial x: <span id="x0-val">2.00</span></label>
            <input type="range" id="x0-slider" min="-4" max="4" step="0.1" value="2">
        </div>
        <div class="control-group">
            <label>Initial v: <span id="v0-val">0.00</span></label>
            <input type="range" id="v0-slider" min="-4" max="4" step="0.1" value="0">
        </div>
        <div class="control-group">
            <label>Speed: <span id="speed-val">1.0</span>x</label>
            <input type="range" id="speed-slider" min="0.1" max="3" step="0.1" value="1">
        </div>
        <button id="reset-btn">Reset</button>
        <button id="multi-btn">Multiple ICs</button>
        <button id="pause-btn">Pause</button>
    </div>

    <div id="fps-display">FPS: <span id="fps">0</span></div>

    <script>
        // Canvas setup
        const phaseCanvas = document.getElementById('phaseCanvas');
        const timeCanvas = document.getElementById('timeCanvas');
        const phaseCtx = phaseCanvas.getContext('2d');
        const timeCtx = timeCanvas.getContext('2d');

        function resizeCanvases() {
            const panels = document.querySelectorAll('.viz-panel');
            panels.forEach((panel) => {
                const canvas = panel.querySelector('canvas');
                const rect = panel.getBoundingClientRect();
                canvas.width = rect.width - 30;
                canvas.height = rect.height - 50;
            });
        }

        // State
        let mu = 1.0;        // Damping parameter
        let x0 = 2.0;        // Initial position
        let v0 = 0.0;        // Initial velocity
        let speed = 1.0;
        let running = true;
        let showMultiple = false;

        // Trajectories
        let trajectories = [];
        const historyLength = 1000;
        let time = 0;
        const dt = 0.01;

        // Initialize single trajectory
        function initSingle() {
            trajectories = [{
                x: x0,
                v: v0,
                history: [],
                color: '#e91e63'
            }];
            time = 0;
        }

        // Initialize multiple trajectories with different initial conditions
        function initMultiple() {
            trajectories = [];
            const colors = ['#e91e63', '#00bcd4', '#4caf50', '#ff9800', '#9c27b0', '#2196f3'];
            const offsets = [
                [0.5, 0.5], [-0.5, 0.5], [0.5, -0.5], [-0.5, -0.5],
                [3, 0], [-3, 0]
            ];

            offsets.forEach((offset, i) => {
                trajectories.push({
                    x: offset[0],
                    v: offset[1],
                    history: [],
                    color: colors[i % colors.length]
                });
            });
            time = 0;
        }

        // Van der Pol equations: dx/dt = v, dv/dt = μ(1-x²)v - x
        function derivative(x, v) {
            return {
                dx: v,
                dv: mu * (1 - x * x) * v - x
            };
        }

        // Runge-Kutta 4th order integration
        function rk4Step(x, v, h) {
            const k1 = derivative(x, v);
            const k2 = derivative(x + h/2 * k1.dx, v + h/2 * k1.dv);
            const k3 = derivative(x + h/2 * k2.dx, v + h/2 * k2.dv);
            const k4 = derivative(x + h * k3.dx, v + h * k3.dv);

            return {
                x: x + h/6 * (k1.dx + 2*k2.dx + 2*k3.dx + k4.dx),
                v: v + h/6 * (k1.dv + 2*k2.dv + 2*k3.dv + k4.dv)
            };
        }

        // Update simulation
        function update() {
            const steps = Math.round(speed * 5);

            for (let s = 0; s < steps; s++) {
                trajectories.forEach(traj => {
                    const result = rk4Step(traj.x, traj.v, dt);
                    traj.x = result.x;
                    traj.v = result.v;

                    traj.history.push({ x: traj.x, v: traj.v, t: time });
                    if (traj.history.length > historyLength) {
                        traj.history.shift();
                    }
                });
                time += dt;
            }
        }

        // Draw phase portrait
        function drawPhase() {
            const w = phaseCanvas.width;
            const h = phaseCanvas.height;
            const cx = w / 2;
            const cy = h / 2;
            const scale = Math.min(w, h) / 10;

            // Semi-transparent background for trail effect
            phaseCtx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            phaseCtx.fillRect(0, 0, w, h);

            // Draw axes
            phaseCtx.strokeStyle = 'rgba(233, 30, 99, 0.2)';
            phaseCtx.lineWidth = 1;
            phaseCtx.beginPath();
            phaseCtx.moveTo(0, cy);
            phaseCtx.lineTo(w, cy);
            phaseCtx.moveTo(cx, 0);
            phaseCtx.lineTo(cx, h);
            phaseCtx.stroke();

            // Draw grid
            phaseCtx.strokeStyle = 'rgba(233, 30, 99, 0.1)';
            for (let i = -4; i <= 4; i++) {
                if (i === 0) continue;
                phaseCtx.beginPath();
                phaseCtx.moveTo(cx + i * scale, 0);
                phaseCtx.lineTo(cx + i * scale, h);
                phaseCtx.moveTo(0, cy + i * scale);
                phaseCtx.lineTo(w, cy + i * scale);
                phaseCtx.stroke();
            }

            // Draw trajectories
            trajectories.forEach(traj => {
                if (traj.history.length < 2) return;

                phaseCtx.strokeStyle = traj.color;
                phaseCtx.lineWidth = 2;
                phaseCtx.beginPath();

                for (let i = 0; i < traj.history.length; i++) {
                    const pt = traj.history[i];
                    const px = cx + pt.x * scale;
                    const py = cy - pt.v * scale;

                    if (i === 0) {
                        phaseCtx.moveTo(px, py);
                    } else {
                        phaseCtx.lineTo(px, py);
                    }
                }
                phaseCtx.stroke();

                // Draw current position
                const last = traj.history[traj.history.length - 1];
                phaseCtx.fillStyle = traj.color;
                phaseCtx.beginPath();
                phaseCtx.arc(cx + last.x * scale, cy - last.v * scale, 6, 0, 2 * Math.PI);
                phaseCtx.fill();
            });

            // Axis labels
            phaseCtx.fillStyle = '#e91e63';
            phaseCtx.font = '12px sans-serif';
            phaseCtx.fillText('x', w - 20, cy - 10);
            phaseCtx.fillText('v', cx + 10, 20);
        }

        // Draw time series
        function drawTime() {
            const w = timeCanvas.width;
            const h = timeCanvas.height;

            timeCtx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            timeCtx.fillRect(0, 0, w, h);

            // Draw zero line
            timeCtx.strokeStyle = 'rgba(233, 30, 99, 0.2)';
            timeCtx.lineWidth = 1;
            timeCtx.beginPath();
            timeCtx.moveTo(0, h/2);
            timeCtx.lineTo(w, h/2);
            timeCtx.stroke();

            // Draw trajectories (just x vs time)
            trajectories.forEach(traj => {
                if (traj.history.length < 2) return;

                const scale = h / 8;
                timeCtx.strokeStyle = traj.color;
                timeCtx.lineWidth = 2;
                timeCtx.beginPath();

                for (let i = 0; i < traj.history.length; i++) {
                    const pt = traj.history[i];
                    const px = (i / historyLength) * w;
                    const py = h/2 - pt.x * scale;

                    if (i === 0) {
                        timeCtx.moveTo(px, py);
                    } else {
                        timeCtx.lineTo(px, py);
                    }
                }
                timeCtx.stroke();
            });

            // Labels
            timeCtx.fillStyle = '#e91e63';
            timeCtx.font = '10px sans-serif';
            timeCtx.fillText('x(t)', w - 30, h/2 - 10);
            timeCtx.fillText('t', w - 15, h - 5);
        }

        // Update stats
        function updateStats() {
            const traj = trajectories[0];
            document.getElementById('mu-display').textContent = mu.toFixed(2);
            document.getElementById('x-display').textContent = traj.x.toFixed(3);
            document.getElementById('v-display').textContent = traj.v.toFixed(3);

            // Determine behavior
            let behavior = 'Limit Cycle';
            if (mu === 0) {
                behavior = 'Harmonic';
            } else if (mu < 0) {
                behavior = 'Damped';
            } else if (mu > 2) {
                behavior = 'Relaxation';
            }
            document.getElementById('behavior').textContent = behavior;
        }

        // FPS tracking
        let lastTime = 0;
        let frameCount = 0;
        let fps = 0;

        // Animation loop
        function animate(currentTime) {
            requestAnimationFrame(animate);

            // FPS calculation
            frameCount++;
            if (currentTime - lastTime >= 1000) {
                fps = frameCount;
                frameCount = 0;
                lastTime = currentTime;
                document.getElementById('fps').textContent = fps;
            }

            if (running) {
                update();
                drawPhase();
                drawTime();
                updateStats();
            }
        }

        // Event listeners
        document.getElementById('mu-slider').addEventListener('input', (e) => {
            mu = parseFloat(e.target.value);
            document.getElementById('mu-val').textContent = mu.toFixed(2);
        });

        document.getElementById('x0-slider').addEventListener('input', (e) => {
            x0 = parseFloat(e.target.value);
            document.getElementById('x0-val').textContent = x0.toFixed(2);
            if (!showMultiple) initSingle();
        });

        document.getElementById('v0-slider').addEventListener('input', (e) => {
            v0 = parseFloat(e.target.value);
            document.getElementById('v0-val').textContent = v0.toFixed(2);
            if (!showMultiple) initSingle();
        });

        document.getElementById('speed-slider').addEventListener('input', (e) => {
            speed = parseFloat(e.target.value);
            document.getElementById('speed-val').textContent = speed.toFixed(1);
        });

        document.getElementById('reset-btn').addEventListener('click', () => {
            // Clear canvases
            phaseCtx.fillStyle = 'rgba(0, 0, 0, 1)';
            phaseCtx.fillRect(0, 0, phaseCanvas.width, phaseCanvas.height);
            if (showMultiple) {
                initMultiple();
            } else {
                initSingle();
            }
        });

        document.getElementById('multi-btn').addEventListener('click', () => {
            showMultiple = !showMultiple;
            document.getElementById('multi-btn').classList.toggle('active', showMultiple);
            // Clear canvas
            phaseCtx.fillStyle = 'rgba(0, 0, 0, 1)';
            phaseCtx.fillRect(0, 0, phaseCanvas.width, phaseCanvas.height);
            if (showMultiple) {
                initMultiple();
            } else {
                initSingle();
            }
        });

        document.getElementById('pause-btn').addEventListener('click', () => {
            running = !running;
            document.getElementById('pause-btn').textContent = running ? 'Pause' : 'Resume';
        });

        // Initialize
        window.addEventListener('resize', resizeCanvases);
        resizeCanvases();
        initSingle();
        animate(0);
    </script>
</body>
</html>
