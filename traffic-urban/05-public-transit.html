<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Public Transit - Traffic/Urban Simulations</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e2e8f0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #facc15;
            text-decoration: none;
            font-size: 0.9rem;
            margin-bottom: 20px;
            transition: gap 0.3s ease;
        }

        .back-link:hover {
            gap: 12px;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #facc15;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #94a3b8;
            font-size: 1.1rem;
        }

        .simulation-container {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 20px;
            margin-bottom: 30px;
        }

        .canvas-wrapper {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(250, 204, 21, 0.2);
        }

        canvas {
            display: block;
            width: 100%;
            height: 500px;
            border-radius: 8px;
            background: #0f172a;
        }

        .controls-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(250, 204, 21, 0.2);
        }

        .control-section {
            margin-bottom: 20px;
        }

        .control-section h3 {
            color: #facc15;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            color: #94a3b8;
            font-size: 0.85rem;
            margin-bottom: 6px;
        }

        .control-group input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #1e293b;
            outline: none;
            -webkit-appearance: none;
        }

        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #facc15;
            cursor: pointer;
        }

        .control-value {
            text-align: right;
            color: #facc15;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .route-toggles {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .route-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
        }

        .route-toggle input {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .route-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .route-name {
            color: #e2e8f0;
            font-size: 0.85rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .stat-item {
            background: rgba(250, 204, 21, 0.1);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #facc15;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 4px;
        }

        .btn-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-primary {
            background: #facc15;
            color: #1a1a2e;
        }

        .btn-secondary {
            background: rgba(250, 204, 21, 0.2);
            color: #facc15;
        }

        .info-box {
            background: rgba(250, 204, 21, 0.1);
            border: 1px solid rgba(250, 204, 21, 0.3);
            border-radius: 12px;
            padding: 20px;
        }

        .info-box h3 {
            color: #facc15;
            margin-bottom: 10px;
        }

        .info-box p {
            color: #94a3b8;
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        @media (max-width: 900px) {
            .simulation-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="index.html" class="back-link">
                <span>‚Üê</span>
                <span>Back to Traffic/Urban</span>
            </a>
            <h1>Public Transit</h1>
            <p class="subtitle">Bus and metro system simulation</p>
        </header>

        <div class="simulation-container">
            <div class="canvas-wrapper">
                <canvas id="simCanvas"></canvas>
            </div>

            <div class="controls-panel">
                <div class="control-section">
                    <h3>Transit Lines</h3>
                    <div class="route-toggles">
                        <label class="route-toggle">
                            <input type="checkbox" id="routeRed" checked>
                            <div class="route-dot" style="background: #ef4444;"></div>
                            <span class="route-name">Red Line (Metro)</span>
                        </label>
                        <label class="route-toggle">
                            <input type="checkbox" id="routeBlue" checked>
                            <div class="route-dot" style="background: #3b82f6;"></div>
                            <span class="route-name">Blue Line (Metro)</span>
                        </label>
                        <label class="route-toggle">
                            <input type="checkbox" id="routeGreen" checked>
                            <div class="route-dot" style="background: #22c55e;"></div>
                            <span class="route-name">Green Bus</span>
                        </label>
                        <label class="route-toggle">
                            <input type="checkbox" id="routeOrange" checked>
                            <div class="route-dot" style="background: #f97316;"></div>
                            <span class="route-name">Orange Bus</span>
                        </label>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Parameters</h3>
                    <div class="control-group">
                        <label>Passenger Demand</label>
                        <input type="range" id="demand" min="10" max="100" value="50">
                        <div class="control-value"><span id="demandVal">50</span>%</div>
                    </div>
                    <div class="control-group">
                        <label>Service Frequency</label>
                        <input type="range" id="frequency" min="1" max="10" value="5">
                        <div class="control-value"><span id="frequencyVal">5</span> veh/line</div>
                    </div>
                    <div class="control-group">
                        <label>Dwell Time</label>
                        <input type="range" id="dwell" min="2" max="20" value="8">
                        <div class="control-value"><span id="dwellVal">8</span>s</div>
                    </div>
                    <div class="control-group">
                        <label>Time Scale</label>
                        <input type="range" id="timeScale" min="1" max="10" value="3">
                        <div class="control-value"><span id="timeScaleVal">3</span>x</div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="passengers">0</div>
                            <div class="stat-label">Passengers</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="avgWait">0</div>
                            <div class="stat-label">Avg Wait</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="avgLoad">0</div>
                            <div class="stat-label">Avg Load %</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="delivered">0</div>
                            <div class="stat-label">Delivered</div>
                        </div>
                    </div>
                </div>

                <div class="btn-row">
                    <button class="btn btn-primary" id="resetBtn">Reset</button>
                    <button class="btn btn-secondary" id="pauseBtn">Pause</button>
                </div>
            </div>
        </div>

        <div class="info-box">
            <h3>Public Transit Network</h3>
            <p>
                This simulation models a city's transit network with metro lines (high capacity, fixed routes)
                and bus lines (lower capacity, street-level). Passengers wait at stations and board vehicles
                heading toward their destination. Watch how headway bunching affects service quality.
            </p>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');

        function resizeCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * window.devicePixelRatio;
            canvas.height = rect.height * window.devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Parameters
        const params = {
            demand: 50,
            frequency: 5,
            dwell: 8,
            timeScale: 3
        };

        // Statistics
        let stats = {
            totalPassengers: 0,
            waitTimes: [],
            delivered: 0
        };

        let paused = false;

        // Route definitions
        const routes = {
            red: {
                color: '#ef4444',
                type: 'metro',
                capacity: 200,
                speed: 4,
                enabled: true,
                stations: []
            },
            blue: {
                color: '#3b82f6',
                type: 'metro',
                capacity: 200,
                speed: 4,
                enabled: true,
                stations: []
            },
            green: {
                color: '#22c55e',
                type: 'bus',
                capacity: 50,
                speed: 2,
                enabled: true,
                stations: []
            },
            orange: {
                color: '#f97316',
                type: 'bus',
                capacity: 50,
                speed: 2,
                enabled: true,
                stations: []
            }
        };

        let vehicles = [];

        class Station {
            constructor(x, y, name, routes) {
                this.x = x;
                this.y = y;
                this.name = name;
                this.routes = routes;
                this.waiting = {};
                routes.forEach(r => this.waiting[r] = []);
            }

            addPassenger(route, destination) {
                this.waiting[route].push({
                    destination: destination,
                    waitStart: Date.now()
                });
                stats.totalPassengers++;
            }

            draw(ctx) {
                const totalWaiting = Object.values(this.waiting).reduce((sum, arr) => sum + arr.length, 0);

                // Station circle
                ctx.fillStyle = '#1e293b';
                ctx.strokeStyle = '#facc15';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(this.x, this.y, 15, 0, Math.PI * 2);
                ctx.fill();
                ctx.stroke();

                // Waiting count
                if (totalWaiting > 0) {
                    ctx.fillStyle = '#facc15';
                    ctx.font = 'bold 10px system-ui';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(totalWaiting, this.x, this.y);
                }

                // Station name
                ctx.fillStyle = '#94a3b8';
                ctx.font = '10px system-ui';
                ctx.textAlign = 'center';
                ctx.fillText(this.name, this.x, this.y + 25);
            }
        }

        class Vehicle {
            constructor(route, routeName, stationIndex, direction) {
                this.route = route;
                this.routeName = routeName;
                this.stationIndex = stationIndex;
                this.direction = direction; // 1 or -1
                this.progress = 0;
                this.passengers = [];
                this.dwelling = false;
                this.dwellStart = 0;
            }

            get currentStation() {
                return this.route.stations[this.stationIndex];
            }

            get nextStation() {
                const nextIdx = this.stationIndex + this.direction;
                if (nextIdx < 0 || nextIdx >= this.route.stations.length) {
                    return null;
                }
                return this.route.stations[nextIdx];
            }

            update(dt) {
                if (this.dwelling) {
                    const dwellTime = params.dwell * 1000 / params.timeScale;
                    if (Date.now() - this.dwellStart > dwellTime) {
                        this.dwelling = false;
                        this.progress = 0;

                        // Reverse at end of line
                        const nextIdx = this.stationIndex + this.direction;
                        if (nextIdx < 0 || nextIdx >= this.route.stations.length) {
                            this.direction *= -1;
                        }
                    }
                    return;
                }

                // Move toward next station
                this.progress += this.route.speed * dt * params.timeScale / 100;

                if (this.progress >= 1) {
                    // Arrive at next station
                    this.stationIndex += this.direction;
                    this.progress = 0;
                    this.arriveAtStation();
                }
            }

            arriveAtStation() {
                const station = this.currentStation;

                // Passengers disembark
                const disembarking = this.passengers.filter(p => p.destination === station);
                this.passengers = this.passengers.filter(p => p.destination !== station);
                stats.delivered += disembarking.length;

                // Passengers board
                const waiting = station.waiting[this.routeName];
                const space = this.route.capacity - this.passengers.length;
                const boarding = waiting.splice(0, space);

                boarding.forEach(p => {
                    const waitTime = (Date.now() - p.waitStart) / 1000;
                    stats.waitTimes.push(waitTime);
                    this.passengers.push(p);
                });

                if (disembarking.length > 0 || boarding.length > 0) {
                    this.dwelling = true;
                    this.dwellStart = Date.now();
                }
            }

            get position() {
                const current = this.currentStation;
                const next = this.nextStation;

                if (!next) {
                    return { x: current.x, y: current.y };
                }

                return {
                    x: current.x + (next.x - current.x) * this.progress,
                    y: current.y + (next.y - current.y) * this.progress
                };
            }

            draw(ctx) {
                const pos = this.position;
                const size = this.route.type === 'metro' ? 20 : 14;
                const load = this.passengers.length / this.route.capacity;

                // Vehicle body
                ctx.fillStyle = this.route.color;
                if (this.route.type === 'metro') {
                    ctx.beginPath();
                    ctx.roundRect(pos.x - size / 2, pos.y - size / 3, size, size * 0.66, 4);
                    ctx.fill();
                } else {
                    ctx.beginPath();
                    ctx.roundRect(pos.x - size / 2, pos.y - size / 3, size, size * 0.66, 3);
                    ctx.fill();
                }

                // Load indicator
                ctx.fillStyle = load > 0.8 ? '#ef4444' : load > 0.5 ? '#facc15' : '#22c55e';
                ctx.beginPath();
                ctx.arc(pos.x, pos.y - size / 2 - 5, 4, 0, Math.PI * 2);
                ctx.fill();

                // Passenger count
                if (this.passengers.length > 0) {
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 8px system-ui';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(this.passengers.length, pos.x, pos.y);
                }
            }
        }

        function initializeNetwork() {
            const width = canvas.width / window.devicePixelRatio;
            const height = canvas.height / window.devicePixelRatio;

            // Red line (horizontal metro)
            routes.red.stations = [
                new Station(50, height * 0.3, 'West', ['red']),
                new Station(150, height * 0.3, 'Park', ['red', 'blue']),
                new Station(width / 2, height * 0.3, 'Central', ['red', 'green', 'orange']),
                new Station(width - 150, height * 0.3, 'East Mall', ['red']),
                new Station(width - 50, height * 0.3, 'Airport', ['red'])
            ];

            // Blue line (vertical metro)
            routes.blue.stations = [
                new Station(150, 50, 'North', ['blue']),
                new Station(150, height * 0.3, 'Park', ['red', 'blue']),
                new Station(150, height * 0.6, 'University', ['blue', 'green']),
                new Station(150, height - 50, 'South', ['blue'])
            ];

            // Green bus (circular)
            routes.green.stations = [
                new Station(width / 2, height * 0.3, 'Central', ['red', 'green', 'orange']),
                new Station(width * 0.7, height * 0.45, 'Hospital', ['green']),
                new Station(width * 0.7, height * 0.7, 'Stadium', ['green', 'orange']),
                new Station(width / 2, height * 0.85, 'Beach', ['green']),
                new Station(150, height * 0.6, 'University', ['blue', 'green'])
            ];

            // Orange bus (cross-town)
            routes.orange.stations = [
                new Station(width - 50, height * 0.6, 'Tech Park', ['orange']),
                new Station(width * 0.7, height * 0.7, 'Stadium', ['green', 'orange']),
                new Station(width / 2, height * 0.3, 'Central', ['red', 'green', 'orange']),
                new Station(50, height * 0.5, 'Old Town', ['orange'])
            ];

            // Initialize vehicles
            vehicles = [];
            Object.entries(routes).forEach(([name, route]) => {
                for (let i = 0; i < params.frequency; i++) {
                    const startIdx = Math.floor(i * route.stations.length / params.frequency);
                    vehicles.push(new Vehicle(route, name, startIdx, 1));
                }
            });
        }

        function generatePassengers() {
            if (Math.random() > params.demand / 500) return;

            // Pick random route and stations
            const enabledRoutes = Object.entries(routes).filter(([_, r]) => r.enabled);
            if (enabledRoutes.length === 0) return;

            const [routeName, route] = enabledRoutes[Math.floor(Math.random() * enabledRoutes.length)];
            if (route.stations.length < 2) return;

            const originIdx = Math.floor(Math.random() * route.stations.length);
            let destIdx;
            do {
                destIdx = Math.floor(Math.random() * route.stations.length);
            } while (destIdx === originIdx);

            route.stations[originIdx].addPassenger(routeName, route.stations[destIdx]);
        }

        function drawRoutes(ctx) {
            // Draw route lines
            Object.entries(routes).forEach(([name, route]) => {
                if (!route.enabled) return;

                ctx.strokeStyle = route.color;
                ctx.lineWidth = route.type === 'metro' ? 6 : 3;
                ctx.lineCap = 'round';
                ctx.setLineDash(route.type === 'bus' ? [10, 5] : []);

                ctx.beginPath();
                route.stations.forEach((station, i) => {
                    if (i === 0) {
                        ctx.moveTo(station.x, station.y);
                    } else {
                        ctx.lineTo(station.x, station.y);
                    }
                });
                ctx.stroke();
            });

            ctx.setLineDash([]);

            // Draw stations (after lines so they appear on top)
            const allStations = new Set();
            Object.values(routes).forEach(route => {
                if (route.enabled) {
                    route.stations.forEach(s => allStations.add(s));
                }
            });
            allStations.forEach(station => station.draw(ctx));
        }

        function updateStats() {
            document.getElementById('passengers').textContent = stats.totalPassengers;

            const avgWait = stats.waitTimes.length > 0 ?
                (stats.waitTimes.reduce((a, b) => a + b, 0) / stats.waitTimes.length).toFixed(0) : 0;
            document.getElementById('avgWait').textContent = avgWait + 's';

            const loads = vehicles.filter(v => routes[v.routeName].enabled)
                .map(v => v.passengers.length / v.route.capacity);
            const avgLoad = loads.length > 0 ?
                (loads.reduce((a, b) => a + b, 0) / loads.length * 100).toFixed(0) : 0;
            document.getElementById('avgLoad').textContent = avgLoad + '%';

            document.getElementById('delivered').textContent = stats.delivered;

            // Limit wait time history
            if (stats.waitTimes.length > 100) {
                stats.waitTimes = stats.waitTimes.slice(-50);
            }
        }

        let lastTime = 0;
        function animate(timestamp) {
            if (paused) {
                lastTime = timestamp;
                requestAnimationFrame(animate);
                return;
            }

            const dt = (timestamp - lastTime) / 16.67;
            lastTime = timestamp;

            const width = canvas.width / window.devicePixelRatio;
            const height = canvas.height / window.devicePixelRatio;

            ctx.clearRect(0, 0, width, height);

            // Generate passengers
            generatePassengers();

            // Draw routes
            drawRoutes(ctx);

            // Update and draw vehicles
            vehicles.forEach(v => {
                if (routes[v.routeName].enabled) {
                    v.update(dt);
                    v.draw(ctx);
                }
            });

            updateStats();
            requestAnimationFrame(animate);
        }

        // Event listeners
        ['red', 'blue', 'green', 'orange'].forEach(color => {
            document.getElementById('route' + color.charAt(0).toUpperCase() + color.slice(1))
                .addEventListener('change', (e) => {
                    routes[color].enabled = e.target.checked;
                });
        });

        document.getElementById('demand').addEventListener('input', (e) => {
            params.demand = parseInt(e.target.value);
            document.getElementById('demandVal').textContent = params.demand;
        });

        document.getElementById('frequency').addEventListener('input', (e) => {
            params.frequency = parseInt(e.target.value);
            document.getElementById('frequencyVal').textContent = params.frequency;
            initializeNetwork();
        });

        document.getElementById('dwell').addEventListener('input', (e) => {
            params.dwell = parseInt(e.target.value);
            document.getElementById('dwellVal').textContent = params.dwell;
        });

        document.getElementById('timeScale').addEventListener('input', (e) => {
            params.timeScale = parseInt(e.target.value);
            document.getElementById('timeScaleVal').textContent = params.timeScale;
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            stats = { totalPassengers: 0, waitTimes: [], delivered: 0 };
            initializeNetwork();
        });

        document.getElementById('pauseBtn').addEventListener('click', () => {
            paused = !paused;
            document.getElementById('pauseBtn').textContent = paused ? 'Resume' : 'Pause';
        });

        // Initialize and start
        initializeNetwork();
        requestAnimationFrame(animate);
    </script>
</body>
</html>
