<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffic Flow Simulation - Nagel-Schreckenberg Model - CCAB</title>
    <meta name="description" content="Watch phantom traffic jams emerge from simple rules. Interactive Nagel-Schreckenberg cellular automaton model for traffic flow simulation.">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }

        canvas {
            display: block;
        }

        .back-link {
            position: fixed;
            top: 15px;
            left: 15px;
            padding: 10px 18px;
            background: rgba(0, 0, 0, 0.6);
            color: #ffc107;
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 193, 7, 0.3);
            transition: all 0.3s ease;
        }

        .back-link:hover {
            background: rgba(255, 193, 7, 0.2);
            transform: translateX(-4px);
        }

        #info {
            position: fixed;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 20px;
            border-radius: 12px;
            color: #ffc107;
            font-size: 13px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 193, 7, 0.2);
            z-index: 1000;
            max-width: 300px;
        }

        #info h3 {
            margin-bottom: 10px;
            color: #fff;
        }

        #info .stat {
            margin: 5px 0;
        }

        #info .stat-label {
            color: #aaa;
            font-size: 11px;
        }

        #info .stat-value {
            color: #ffc107;
            font-weight: bold;
        }

        #info p {
            font-size: 11px;
            opacity: 0.8;
            line-height: 1.5;
            margin-top: 10px;
            color: #ddd;
        }

        #presets {
            position: fixed;
            top: 280px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1000;
        }

        button {
            background: rgba(255, 193, 7, 0.15);
            border: 1px solid rgba(255, 193, 7, 0.4);
            color: #ffc107;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        button:hover {
            background: rgba(255, 193, 7, 0.3);
        }

        button.active {
            background: rgba(255, 193, 7, 0.4);
            border-color: #ffc107;
        }

        #controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            z-index: 1000;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-group {
            background: rgba(0, 0, 0, 0.7);
            padding: 12px 16px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 193, 7, 0.2);
        }

        .control-group label {
            color: #ffc107;
            font-size: 11px;
            display: block;
            margin-bottom: 5px;
        }

        .control-group input[type="range"] {
            width: 100px;
            accent-color: #ffc107;
        }

        .control-group span {
            color: #fff;
            font-size: 10px;
            margin-left: 6px;
        }

        #fps-display {
            position: fixed;
            bottom: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 12px;
            border-radius: 6px;
            color: #ffc107;
            font-size: 12px;
            z-index: 1000;
        }

        .legend {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 1000;
            font-size: 11px;
            color: #aaa;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 20px;
            height: 10px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <a href="../index.html" class="back-link">← Back to Gallery</a>

    <canvas id="canvas"></canvas>

    <div id="info">
        <h3>Traffic Flow Simulation</h3>
        <div class="stat">
            <span class="stat-label">Model</span>
            <span class="stat-value">Nagel-Schreckenberg</span>
        </div>
        <div class="stat">
            <span class="stat-label">Cars</span>
            <span class="stat-value" id="car-count">0</span>
        </div>
        <div class="stat">
            <span class="stat-label">Density</span>
            <span class="stat-value" id="density">0%</span>
        </div>
        <div class="stat">
            <span class="stat-label">Avg Speed</span>
            <span class="stat-value" id="avg-speed">0</span>
        </div>
        <div class="stat">
            <span class="stat-label">Flow</span>
            <span class="stat-value" id="flow">0</span>
        </div>
        <p>Nagel-Schreckenberg cellular automaton model. Watch "phantom jams" emerge spontaneously from random braking. Time flows downward.</p>
    </div>

    <div id="presets">
        <button class="active" data-preset="freeflow">Free Flow</button>
        <button data-preset="congested">Congested</button>
        <button data-preset="critical">Critical Density</button>
        <button data-preset="jam">Traffic Jam</button>
    </div>

    <div id="controls">
        <div class="control-group">
            <label>Density: <span id="density-val">30%</span></label>
            <input type="range" id="density-slider" min="5" max="80" step="5" value="30">
        </div>
        <div class="control-group">
            <label>Slow-down Prob (p): <span id="p-val">0.3</span></label>
            <input type="range" id="p-slider" min="0" max="0.5" step="0.05" value="0.3">
        </div>
        <div class="control-group">
            <label>Max Velocity: <span id="vmax-val">5</span></label>
            <input type="range" id="vmax-slider" min="1" max="10" step="1" value="5">
        </div>
        <div class="control-group">
            <label>Speed: <span id="speed-val">1x</span></label>
            <input type="range" id="speed" min="1" max="5" step="1" value="1">
        </div>
    </div>

    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(90deg, #f44336, #ff9800, #4caf50)"></div>
            <span>Speed: Stopped → Fast</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #333"></div>
            <span>Empty Road</span>
        </div>
    </div>

    <div id="fps-display">FPS: <span id="fps">0</span></div>

    <script>
        // Canvas setup
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resize();
        window.addEventListener('resize', resize);

        // DOM elements
        const carCountDisplay = document.getElementById('car-count');
        const densityDisplay = document.getElementById('density');
        const avgSpeedDisplay = document.getElementById('avg-speed');
        const flowDisplay = document.getElementById('flow');
        const fpsDisplay = document.getElementById('fps');
        const densitySlider = document.getElementById('density-slider');
        const densityVal = document.getElementById('density-val');
        const pSlider = document.getElementById('p-slider');
        const pVal = document.getElementById('p-val');
        const vmaxSlider = document.getElementById('vmax-slider');
        const vmaxVal = document.getElementById('vmax-val');
        const speedSlider = document.getElementById('speed');
        const speedVal = document.getElementById('speed-val');

        // Configuration
        let config = {
            roadLength: 200,       // Number of cells
            density: 0.3,          // Car density (0-1)
            p: 0.3,                // Slow-down probability
            vmax: 5,               // Maximum velocity
            speed: 1,              // Simulation speed
            cellSize: 4,           // Pixels per cell
            historyLength: 150     // Number of time steps to show
        };

        // State
        let road = [];             // Current road state (-1 = empty, >=0 = car velocity)
        let history = [];          // History for space-time diagram

        // Initialize road
        function initRoad() {
            road = new Array(config.roadLength).fill(-1);

            // Place cars randomly
            const numCars = Math.floor(config.roadLength * config.density);
            const positions = [];

            for (let i = 0; i < config.roadLength; i++) {
                positions.push(i);
            }

            // Shuffle and take first numCars positions
            for (let i = positions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [positions[i], positions[j]] = [positions[j], positions[i]];
            }

            for (let i = 0; i < numCars; i++) {
                // Random initial velocity
                road[positions[i]] = Math.floor(Math.random() * (config.vmax + 1));
            }

            history = [];
        }

        // Get distance to next car
        function distanceToNext(pos) {
            let distance = 1;
            while (distance < config.roadLength) {
                const nextPos = (pos + distance) % config.roadLength;
                if (road[nextPos] >= 0) {
                    return distance - 1; // Gap (cells between cars)
                }
                distance++;
            }
            return config.roadLength; // No car ahead (shouldn't happen with periodic boundary)
        }

        // Nagel-Schreckenberg update rules
        function updateRoad() {
            const newRoad = new Array(config.roadLength).fill(-1);

            for (let i = 0; i < config.roadLength; i++) {
                if (road[i] >= 0) {
                    let v = road[i];
                    const gap = distanceToNext(i);

                    // Rule 1: Acceleration
                    if (v < config.vmax) {
                        v++;
                    }

                    // Rule 2: Slowing down (avoid collision)
                    if (v > gap) {
                        v = gap;
                    }

                    // Rule 3: Randomization (with probability p)
                    if (v > 0 && Math.random() < config.p) {
                        v--;
                    }

                    // Rule 4: Car motion
                    const newPos = (i + v) % config.roadLength;
                    newRoad[newPos] = v;
                }
            }

            road = newRoad;

            // Save to history
            history.push([...road]);
            if (history.length > config.historyLength) {
                history.shift();
            }
        }

        // Calculate statistics
        function calcStats() {
            let carCount = 0;
            let totalVelocity = 0;

            for (let i = 0; i < config.roadLength; i++) {
                if (road[i] >= 0) {
                    carCount++;
                    totalVelocity += road[i];
                }
            }

            const density = carCount / config.roadLength;
            const avgSpeed = carCount > 0 ? totalVelocity / carCount : 0;
            const flow = density * avgSpeed;

            carCountDisplay.textContent = carCount;
            densityDisplay.textContent = `${(density * 100).toFixed(0)}%`;
            avgSpeedDisplay.textContent = avgSpeed.toFixed(2);
            flowDisplay.textContent = flow.toFixed(2);
        }

        // Get color based on velocity
        function getColor(velocity) {
            if (velocity < 0) return '#1a1a2e'; // Empty

            const ratio = velocity / config.vmax;
            if (ratio < 0.3) {
                // Red to orange
                const t = ratio / 0.3;
                return `rgb(${244}, ${Math.floor(67 + t * 85)}, ${Math.floor(54 + t * 100)})`;
            } else if (ratio < 0.7) {
                // Orange to yellow
                const t = (ratio - 0.3) / 0.4;
                return `rgb(${Math.floor(255 - t * 50)}, ${Math.floor(152 + t * 50)}, ${Math.floor(0)})`;
            } else {
                // Yellow to green
                const t = (ratio - 0.7) / 0.3;
                return `rgb(${Math.floor(205 - t * 129)}, ${Math.floor(202 + t * 30)}, ${Math.floor(t * 80)})`;
            }
        }

        // Draw space-time diagram
        function draw() {
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const cellWidth = Math.max(2, Math.floor((canvas.width - 340) / config.roadLength));
            const cellHeight = Math.max(2, Math.floor((canvas.height - 150) / config.historyLength));
            const offsetX = 20;
            const offsetY = 70;

            // Draw history (space-time diagram)
            for (let t = 0; t < history.length; t++) {
                const row = history[t];
                for (let x = 0; x < row.length; x++) {
                    ctx.fillStyle = getColor(row[x]);
                    ctx.fillRect(
                        offsetX + x * cellWidth,
                        offsetY + t * cellHeight,
                        cellWidth - 1,
                        cellHeight - 1
                    );
                }
            }

            // Draw current state as a road at the bottom
            const roadY = offsetY + config.historyLength * cellHeight + 20;
            ctx.fillStyle = '#333';
            ctx.fillRect(offsetX, roadY, config.roadLength * cellWidth, 30);

            // Lane markings
            ctx.strokeStyle = '#ffc107';
            ctx.setLineDash([20, 15]);
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(offsetX, roadY + 15);
            ctx.lineTo(offsetX + config.roadLength * cellWidth, roadY + 15);
            ctx.stroke();
            ctx.setLineDash([]);

            // Draw cars
            for (let i = 0; i < road.length; i++) {
                if (road[i] >= 0) {
                    ctx.fillStyle = getColor(road[i]);
                    ctx.fillRect(
                        offsetX + i * cellWidth + 1,
                        roadY + 8,
                        cellWidth - 2,
                        14
                    );
                }
            }

            // Draw time arrow
            ctx.fillStyle = '#ffc107';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('Time ↓', offsetX + config.roadLength * cellWidth + 10, offsetY + 20);

            // Draw axis labels
            ctx.fillText('Position →', offsetX, offsetY - 10);
        }

        // Presets
        function applyPreset(preset) {
            switch (preset) {
                case 'freeflow':
                    config.density = 0.15;
                    config.p = 0.2;
                    break;
                case 'congested':
                    config.density = 0.4;
                    config.p = 0.3;
                    break;
                case 'critical':
                    config.density = 0.25;
                    config.p = 0.3;
                    break;
                case 'jam':
                    config.density = 0.5;
                    config.p = 0.4;
                    break;
            }

            densitySlider.value = config.density * 100;
            densityVal.textContent = `${Math.round(config.density * 100)}%`;
            pSlider.value = config.p;
            pVal.textContent = config.p.toFixed(2);

            initRoad();
        }

        // Animation loop
        let lastTime = 0;
        let frameCount = 0;
        let fps = 0;
        let updateAccum = 0;

        function animate(currentTime) {
            requestAnimationFrame(animate);

            // FPS calculation
            frameCount++;
            if (currentTime - lastTime >= 1000) {
                fps = frameCount;
                frameCount = 0;
                lastTime = currentTime;
                fpsDisplay.textContent = fps;
            }

            // Update simulation
            updateAccum += config.speed;
            while (updateAccum >= 2) {
                updateRoad();
                updateAccum -= 2;
            }

            calcStats();
            draw();
        }

        // Event listeners
        densitySlider.addEventListener('input', (e) => {
            config.density = parseInt(e.target.value) / 100;
            densityVal.textContent = `${e.target.value}%`;
            initRoad();
        });

        pSlider.addEventListener('input', (e) => {
            config.p = parseFloat(e.target.value);
            pVal.textContent = config.p.toFixed(2);
        });

        vmaxSlider.addEventListener('input', (e) => {
            config.vmax = parseInt(e.target.value);
            vmaxVal.textContent = config.vmax;
        });

        speedSlider.addEventListener('input', (e) => {
            config.speed = parseInt(e.target.value);
            speedVal.textContent = `${config.speed}x`;
        });

        // Preset buttons
        document.querySelectorAll('#presets button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('#presets button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                applyPreset(btn.dataset.preset);
            });
        });

        // Initialize
        // Expose for enhance.js keyboard shortcuts
        window.reset = initRoad;

        initRoad();
        requestAnimationFrame(animate);
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
