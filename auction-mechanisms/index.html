<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Auction Mechanisms</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
canvas { display: block; }
#title { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); color: #fbbf24; font-size: 20px; font-weight: 700; z-index: 999; text-shadow: 0 0 20px rgba(251,191,36,0.5); font-family: sans-serif; }
#controls { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; z-index: 999; background: rgba(0,0,0,0.75); padding: 12px 16px; border-radius: 10px; flex-wrap: wrap; justify-content: center; }
#controls button { background: rgba(251,191,36,0.15); color: #fbbf24; border: 1px solid rgba(251,191,36,0.4); padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.2s; }
#controls button:hover { background: rgba(251,191,36,0.3); }
#controls button.active { background: rgba(251,191,36,0.5); border-color: #fbbf24; }
#info { position: fixed; top: 50px; right: 15px; color: #ccc; font-size: 12px; z-index: 999; background: rgba(0,0,0,0.7); padding: 12px; border-radius: 8px; line-height: 2; max-width: 220px; }
</style>
</head>
<body>
<a href="../index.html" style="position:fixed;top:10px;left:10px;padding:8px 16px;background:rgba(0,0,0,0.7);color:#fbbf24;text-decoration:none;border-radius:6px;font-size:14px;z-index:999;font-family:sans-serif;">‚Üê Back to Gallery</a>
<div id="title">Auction Mechanisms</div>
<div id="info">
    <div style="color:#fbbf24;font-weight:bold;" id="auctionType">English Auction</div>
    <div id="statusText">Click Start to begin</div>
    <div style="margin-top:6px;">
        <div>Current Price: <span style="color:#4ade80;" id="curPrice">$0</span></div>
        <div>Winner: <span style="color:#60a5fa;" id="winner">--</span></div>
        <div>Revenue: <span style="color:#f472b6;" id="revenue">--</span></div>
    </div>
    <div style="margin-top:8px;font-size:10px;color:#888;" id="explanation"></div>
</div>
<canvas id="canvas"></canvas>
<div id="controls">
    <button id="btnEnglish" class="active">English (Ascending)</button>
    <button id="btnDutch">Dutch (Descending)</button>
    <button id="btnFirst">Sealed 1st Price</button>
    <button id="btnSecond">Sealed 2nd Price</button>
    <button id="btnStart">Start Auction</button>
    <button id="btnReset">Reset</button>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
resize();
window.addEventListener('resize', resize);

const NUM_BIDDERS = 8;
const colors = ['#4ade80','#60a5fa','#f472b6','#fbbf24','#a78bfa','#f97316','#22d3ee','#e879f9'];
const names = ['Alice','Bob','Carol','Dave','Eve','Frank','Grace','Henry'];

let auctionType = 'english';
let bidders = [];
let currentPrice = 0;
let running = false;
let finished = false;
let winnerIdx = -1;
let finalPrice = 0;
let priceHistory = [];
let auctionStep = 0;
let animTimer = 0;
let sealedBids = [];
let dutchPrice = 0;
let activeBidders = [];
let lastBidderIdx = -1;
let revenueHistory = { english: [], dutch: [], first: [], second: [] };

const explanations = {
    english: 'Ascending price. Bidders drop out when price exceeds their value. Winner pays just above the second-highest valuation.',
    dutch: 'Descending price. First bidder to accept wins. Tends to yield lower revenue as bidders wait.',
    first: 'Sealed bids. Highest bidder wins and pays their bid. Bidders shade bids below true value.',
    second: 'Sealed bids. Highest bidder wins but pays second-highest bid. Truthful bidding is optimal (Vickrey).'
};

function initBidders() {
    bidders = [];
    for (let i = 0; i < NUM_BIDDERS; i++) {
        const trueValue = 30 + Math.random() * 70;
        bidders.push({
            name: names[i],
            color: colors[i],
            trueValue: trueValue,
            bid: 0,
            active: true,
            paddleUp: false,
            paddleAnim: 0,
            y: 0
        });
    }
    bidders.sort((a, b) => b.trueValue - a.trueValue);
}

function resetAuction() {
    initBidders();
    currentPrice = 0;
    running = false;
    finished = false;
    winnerIdx = -1;
    finalPrice = 0;
    priceHistory = [];
    auctionStep = 0;
    animTimer = 0;
    sealedBids = [];
    dutchPrice = 120;
    activeBidders = bidders.map((_, i) => i);
    lastBidderIdx = -1;
    document.getElementById('curPrice').textContent = '$0';
    document.getElementById('winner').textContent = '--';
    document.getElementById('revenue').textContent = '--';
    document.getElementById('statusText').textContent = 'Click Start to begin';
}

function setType(type) {
    auctionType = type;
    document.getElementById('auctionType').textContent =
        type === 'english' ? 'English Auction' :
        type === 'dutch' ? 'Dutch Auction' :
        type === 'first' ? 'Sealed 1st Price' : 'Sealed 2nd Price';
    document.getElementById('explanation').textContent = explanations[type];
    document.querySelectorAll('#controls button').forEach(b => b.classList.remove('active'));
    document.getElementById('btn' + type.charAt(0).toUpperCase() + type.slice(1)).classList.add('active');
    resetAuction();
}

document.getElementById('btnEnglish').onclick = () => setType('english');
document.getElementById('btnDutch').onclick = () => setType('dutch');
document.getElementById('btnFirst').onclick = () => setType('first');
document.getElementById('btnSecond').onclick = () => setType('second');
document.getElementById('btnStart').onclick = () => {
    if (!running && !finished) {
        running = true;
        document.getElementById('statusText').textContent = 'Auction in progress...';
    }
};
document.getElementById('btnReset').onclick = resetAuction;

function stepEnglish() {
    currentPrice += 1 + Math.random() * 2;
    priceHistory.push(currentPrice);

    // Bidders drop out when price exceeds their value
    let remaining = [];
    bidders.forEach((b, i) => {
        if (b.active && currentPrice > b.trueValue) {
            b.active = false;
            b.paddleUp = false;
        }
        if (b.active) {
            remaining.push(i);
            b.paddleUp = true;
            b.paddleAnim = 1;
        }
    });

    if (remaining.length <= 1) {
        finished = true;
        running = false;
        if (remaining.length === 1) {
            winnerIdx = remaining[0];
            finalPrice = currentPrice;
        }
        revenueHistory.english.push(finalPrice);
    }
}

function stepDutch() {
    dutchPrice -= 0.5 + Math.random();
    currentPrice = dutchPrice;
    priceHistory.push(currentPrice);

    // Check if any bidder accepts
    for (let i = 0; i < bidders.length; i++) {
        if (bidders[i].active && dutchPrice <= bidders[i].trueValue * (0.7 + Math.random() * 0.25)) {
            winnerIdx = i;
            finalPrice = dutchPrice;
            bidders[i].paddleUp = true;
            bidders[i].paddleAnim = 1;
            finished = true;
            running = false;
            revenueHistory.dutch.push(finalPrice);
            return;
        }
    }

    if (dutchPrice <= 5) {
        finished = true;
        running = false;
    }
}

function stepSealed(type) {
    // Generate all bids at once
    bidders.forEach((b, i) => {
        if (type === 'first') {
            // Shade bid below true value
            b.bid = b.trueValue * (0.6 + Math.random() * 0.3);
        } else {
            // Second price - truthful bidding is optimal
            b.bid = b.trueValue * (0.9 + Math.random() * 0.15);
        }
        sealedBids.push({ idx: i, bid: b.bid });
    });

    sealedBids.sort((a, b) => b.bid - a.bid);
    winnerIdx = sealedBids[0].idx;

    if (type === 'first') {
        finalPrice = sealedBids[0].bid;
        revenueHistory.first.push(finalPrice);
    } else {
        finalPrice = sealedBids[1].bid;
        revenueHistory.second.push(finalPrice);
    }

    currentPrice = finalPrice;
    bidders[winnerIdx].paddleUp = true;
    bidders[winnerIdx].paddleAnim = 1;
    finished = true;
    running = false;
}

function drawBidder(x, y, w, h, bidder, idx) {
    // Body
    const isWinner = finished && idx === winnerIdx;
    const alpha = bidder.active || finished ? 1 : 0.3;

    ctx.globalAlpha = alpha;

    // Body circle
    ctx.beginPath();
    ctx.arc(x + w / 2, y + h * 0.55, w * 0.25, 0, Math.PI * 2);
    ctx.fillStyle = isWinner ? bidder.color : 'rgba(255,255,255,0.1)';
    ctx.fill();
    ctx.strokeStyle = bidder.color;
    ctx.lineWidth = 2;
    ctx.stroke();

    // Head
    ctx.beginPath();
    ctx.arc(x + w / 2, y + h * 0.25, w * 0.15, 0, Math.PI * 2);
    ctx.fillStyle = isWinner ? bidder.color : 'rgba(255,255,255,0.15)';
    ctx.fill();
    ctx.strokeStyle = bidder.color;
    ctx.stroke();

    // Paddle
    if (bidder.paddleUp) {
        bidder.paddleAnim = Math.min(1, bidder.paddleAnim + 0.05);
        const paddleY = y + h * 0.25 - bidder.paddleAnim * h * 0.35;
        ctx.fillStyle = bidder.color;
        ctx.fillRect(x + w / 2 + w * 0.12, paddleY, 4, h * 0.25);
        ctx.beginPath();
        ctx.arc(x + w / 2 + w * 0.12 + 2, paddleY, 12, 0, Math.PI * 2);
        ctx.fillStyle = bidder.color;
        ctx.fill();

        // Number on paddle
        ctx.fillStyle = '#0a0e1a';
        ctx.font = 'bold 9px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('$' + Math.round(bidder.bid || currentPrice), x + w / 2 + w * 0.12 + 2, paddleY + 3);
    }

    // Name
    ctx.fillStyle = bidder.color;
    ctx.font = 'bold 11px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(bidder.name, x + w / 2, y + h * 0.85);

    // True value (semi-hidden)
    ctx.fillStyle = 'rgba(255,255,255,0.25)';
    ctx.font = '9px sans-serif';
    ctx.fillText('val: $' + bidder.trueValue.toFixed(0), x + w / 2, y + h * 0.95);

    if (isWinner) {
        ctx.strokeStyle = '#fbbf24';
        ctx.lineWidth = 2;
        ctx.setLineDash([3, 3]);
        ctx.strokeRect(x + 2, y + 2, w - 4, h - 4);
        ctx.setLineDash([]);

        ctx.fillStyle = '#fbbf24';
        ctx.font = 'bold 12px sans-serif';
        ctx.fillText('WINNER!', x + w / 2, y + h + 14);
    }

    ctx.globalAlpha = 1;
}

function draw() {
    animTimer++;

    if (running) {
        if (animTimer % 8 === 0) {
            if (auctionType === 'english') stepEnglish();
            else if (auctionType === 'dutch') stepDutch();
            else if (auctionType === 'first' || auctionType === 'second') stepSealed(auctionType);
        }
    }

    const W = canvas.width, H = canvas.height;
    ctx.fillStyle = '#0a0e1a';
    ctx.fillRect(0, 0, W, H);

    // Draw bidders in a row
    const bidderAreaTop = H * 0.08;
    const bidderAreaH = H * 0.40;
    const bidderW = Math.min(120, (W - 60) / NUM_BIDDERS);
    const startX = (W - bidderW * NUM_BIDDERS) / 2;

    bidders.forEach((b, i) => {
        drawBidder(startX + i * bidderW, bidderAreaTop, bidderW, bidderAreaH, b, i);
    });

    // Auctioneer podium
    const podX = W / 2, podY = H * 0.52;
    ctx.fillStyle = 'rgba(251,191,36,0.15)';
    ctx.fillRect(podX - 60, podY, 120, 30);
    ctx.strokeStyle = '#fbbf24';
    ctx.lineWidth = 1;
    ctx.strokeRect(podX - 60, podY, 120, 30);
    ctx.fillStyle = '#fbbf24';
    ctx.font = 'bold 12px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('$' + currentPrice.toFixed(0), podX, podY + 20);

    // Price history chart
    const chartLeft = W * 0.08, chartRight = W * 0.55;
    const chartTop = H * 0.60, chartBottom = H * 0.85;
    const chartW = chartRight - chartLeft, chartH = chartBottom - chartTop;

    // Chart background
    ctx.fillStyle = 'rgba(255,255,255,0.02)';
    ctx.fillRect(chartLeft, chartTop, chartW, chartH);

    ctx.fillStyle = 'rgba(255,255,255,0.3)';
    ctx.font = '10px sans-serif';
    ctx.textAlign = 'left';
    ctx.fillText('Price History', chartLeft, chartTop - 5);

    if (priceHistory.length > 1) {
        const maxP = Math.max(...priceHistory) * 1.2;
        const minP = Math.min(...priceHistory) * 0.8;

        ctx.beginPath();
        ctx.strokeStyle = auctionType === 'dutch' ? '#ef4444' : '#4ade80';
        ctx.lineWidth = 2;
        priceHistory.forEach((p, i) => {
            const x = chartLeft + (i / (priceHistory.length - 1)) * chartW;
            const y = chartBottom - ((p - minP) / (maxP - minP)) * chartH;
            if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
        });
        ctx.stroke();
    }

    // Revenue comparison (right side)
    const revLeft = W * 0.60, revRight = W * 0.92;
    const revTop = H * 0.60, revBottom = H * 0.85;
    const revW = revRight - revLeft, revH = revBottom - revTop;

    ctx.fillStyle = 'rgba(255,255,255,0.3)';
    ctx.font = '10px sans-serif';
    ctx.textAlign = 'left';
    ctx.fillText('Revenue Comparison (avg)', revLeft, revTop - 5);

    const types = ['english', 'dutch', 'first', 'second'];
    const typeColors = ['#4ade80', '#ef4444', '#60a5fa', '#a78bfa'];
    const typeNames = ['English', 'Dutch', '1st Price', '2nd Price'];
    const barH = revH / 5;

    let maxRev = 1;
    types.forEach(t => {
        const arr = revenueHistory[t];
        if (arr.length > 0) {
            const avg = arr.reduce((a, b) => a + b, 0) / arr.length;
            if (avg > maxRev) maxRev = avg;
        }
    });

    types.forEach((t, i) => {
        const arr = revenueHistory[t];
        const avg = arr.length > 0 ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
        const y = revTop + i * barH + 5;
        const w = (avg / maxRev) * revW * 0.7;

        ctx.fillStyle = typeColors[i];
        ctx.globalAlpha = 0.3;
        ctx.fillRect(revLeft + 80, y, w, barH - 10);
        ctx.globalAlpha = 1;
        ctx.strokeStyle = typeColors[i];
        ctx.lineWidth = 1;
        ctx.strokeRect(revLeft + 80, y, w, barH - 10);

        ctx.fillStyle = typeColors[i];
        ctx.font = '10px sans-serif';
        ctx.textAlign = 'right';
        ctx.fillText(typeNames[i], revLeft + 75, y + barH / 2);

        if (arr.length > 0) {
            ctx.textAlign = 'left';
            ctx.fillText('$' + avg.toFixed(1) + ' (' + arr.length + ')', revLeft + 85 + w, y + barH / 2);
        }
    });

    // Sealed bid display
    if ((auctionType === 'first' || auctionType === 'second') && sealedBids.length > 0 && finished) {
        ctx.fillStyle = 'rgba(255,255,255,0.3)';
        ctx.font = '10px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('Sealed Bids (revealed):', W / 2, podY + 50);

        sealedBids.forEach((sb, i) => {
            const b = bidders[sb.idx];
            const isWin = sb.idx === winnerIdx;
            ctx.fillStyle = isWin ? '#fbbf24' : b.color;
            ctx.font = (isWin ? 'bold ' : '') + '10px sans-serif';
            ctx.fillText(b.name + ': $' + sb.bid.toFixed(1) + (isWin ? ' (WINS)' : ''), W / 2, podY + 65 + i * 14);
        });

        if (auctionType === 'second') {
            ctx.fillStyle = '#fbbf24';
            ctx.font = '10px sans-serif';
            ctx.fillText('Pays 2nd highest: $' + finalPrice.toFixed(1), W / 2, podY + 70 + sealedBids.length * 14);
        }
    }

    // Update info
    document.getElementById('curPrice').textContent = '$' + currentPrice.toFixed(0);
    if (finished) {
        document.getElementById('winner').textContent = winnerIdx >= 0 ? bidders[winnerIdx].name : 'None';
        document.getElementById('revenue').textContent = '$' + finalPrice.toFixed(1);
        document.getElementById('statusText').textContent = 'Auction complete! Click Reset to try again.';
    }

    requestAnimationFrame(draw);
}

setType('english');
requestAnimationFrame(draw);
</script>
</body>
</html>
