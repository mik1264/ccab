name: CCAB Test Suite

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  # Quick validation tests (no browser needed)
  validate:
    name: Validate HTML/CSS & Links
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run link validation
        run: python tests/test_links.py

      - name: Run HTML/CSS validation
        run: python tests/test_html_css_validation.py

  # Unit tests for JavaScript utilities
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run demo-utils unit tests
        run: node tests/test-demo-utils.js

  # Browser tests (Playwright)
  browser-tests:
    name: Browser Tests (${{ matrix.browser }})
    runs-on: ubuntu-latest
    needs: validate

    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install playwright
          playwright install ${{ matrix.browser }}
          playwright install-deps ${{ matrix.browser }}

      - name: Start HTTP server
        run: |
          python -m http.server 8000 &
          sleep 3

      - name: Run demo tests (sample)
        run: python test_demos.py
        env:
          BROWSER: ${{ matrix.browser }}

  # Accessibility tests
  accessibility:
    name: Accessibility Tests
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install playwright
          playwright install chromium
          playwright install-deps chromium

      - name: Start HTTP server
        run: |
          python -m http.server 8000 &
          sleep 3

      - name: Run accessibility tests
        run: python tests/test_accessibility.py
        continue-on-error: true

      - name: Upload accessibility results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: accessibility-results
          path: test_results_accessibility.json

  # Template validation
  templates:
    name: Template Validation
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install playwright
          playwright install chromium
          playwright install-deps chromium

      - name: Start HTTP server
        run: |
          python -m http.server 8000 &
          sleep 3

      - name: Run template validation
        run: python tests/test_templates.py

  # Visual regression tests (optional, requires baseline)
  visual-regression:
    name: Visual Regression
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install playwright pillow
          playwright install chromium
          playwright install-deps chromium

      - name: Start HTTP server
        run: |
          python -m http.server 8000 &
          sleep 3

      - name: Run visual regression tests
        run: python tests/test_visual_regression.py
        continue-on-error: true

      - name: Upload visual diffs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-diffs
          path: |
            tests/visual_current/
            tests/visual_diffs/
            test_results_visual.json

  # Performance tests (optional)
  performance:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: browser-tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install playwright
          playwright install chromium
          playwright install-deps chromium

      - name: Start HTTP server
        run: |
          python -m http.server 8000 &
          sleep 3

      - name: Run performance tests
        run: python tests/test_performance.py
        continue-on-error: true

      - name: Upload performance results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-results
          path: test_results_performance.json

  # Cross-browser comprehensive tests (weekly)
  cross-browser-full:
    name: Cross-Browser Full Test
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install playwright
          playwright install
          playwright install-deps

      - name: Start HTTP server
        run: |
          python -m http.server 8000 &
          sleep 3

      - name: Run cross-browser tests
        run: python tests/test_cross_browser.py

      - name: Upload cross-browser results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cross-browser-results
          path: test_results_cross_browser.json

  # Summary job
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [validate, unit-tests, browser-tests, accessibility, templates]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | ${{ needs.validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Browser Tests | ${{ needs.browser-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Accessibility | ${{ needs.accessibility.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Templates | ${{ needs.templates.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any test failed
        if: contains(needs.*.result, 'failure')
        run: exit 1
