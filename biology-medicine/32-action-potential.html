<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neuron Action Potential - CCAB</title>
    <link rel="stylesheet" href="../assets/css/gallery-standard.css">
    <style>
        body {
            background: #fff;
            color: #333;
            font-family: system-ui;
            padding: 2rem;
            text-align: center;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        
        .membrane {
            height: 200px;
            background: #e0f2fe;
            border-top: 4px solid #333;
            border-bottom: 4px solid #333;
            position: relative;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .channel {
            position: absolute;
            top: -4px;
            width: 40px;
            height: 208px;
            background: #cbd5e1;
            border: 2px solid #64748b;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: background 0.2s;
        }
        
        .channel.open { background: #86efac; } /* Green */
        .channel.na { left: 30%; color: #ef4444; }
        .channel.k { left: 60%; color: #3b82f6; }
        
        .ion {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            transition: top 0.5s linear;
        }
        .ion.na { background: #ef4444; } /* Na+ Red */
        .ion.k { background: #3b82f6; } /* K+ Blue */
        
        canvas {
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        
        .controls {
            margin: 20px;
        }
        
        button {
            padding: 10px 20px;
            background: #eab308;
            color: black;
            font-weight: bold;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:disabled { background: #ccc; }
        
        .label-row {
            display: flex;
            justify-content: space-between;
            padding: 0 30%;
            font-weight: bold;
        }
        
    </style>
</head>
<body>

<div class="container">
    <a href="../index.html" class="gallery-back">‚Üê Back to Gallery</a>
    <h1>Neuron Action Potential</h1>
    <p>Simulating voltage-gated ion channels.</p>
    
    <div class="membrane" id="membrane">
        <div class="label-row" style="position:absolute; top:10px; width:100%;">
            <span>Extracellular (High Na+)</span>
        </div>
        
        <div id="chan-na" class="channel na">Na+</div>
        <div id="chan-k" class="channel k">K+</div>
        
        <div class="label-row" style="position:absolute; bottom:10px; width:100%;">
            <span>Intracellular (High K+)</span>
        </div>
    </div>
    
    <canvas id="graph" width="800" height="300"></canvas>
    
    <div class="controls">
        <button onclick="stimulate()" id="btn-stim">Stimulate Neuron</button>
    </div>
    
    <div id="status">Resting Potential (-70mV)</div>
</div>

<script>
    const canvas = document.getElementById('graph');
    const ctx = canvas.getContext('2d');
    const chanNa = document.getElementById('chan-na');
    const chanK = document.getElementById('chan-k');
    const membrane = document.getElementById('membrane');
    
    // Model Params
    let voltage = -70; // mV
    let time = 0;
    let state = 'resting'; // resting, depol, repol, hyperpol
    
    // Hodgkin-Huxley simplified
    const restingV = -70;
    const threshold = -55;
    const peak = 40;
    
    let trace = [];
    
    function init() {
        // Create Ions
        for(let i=0; i<20; i++) createIon('na', true); // Outside
        for(let i=0; i<20; i++) createIon('k', false); // Inside
        requestAnimationFrame(loop);
    }
    
    function createIon(type, outside) {
        const el = document.createElement('div');
        el.className = `ion ${type}`;
        // Random pos
        el.style.left = (Math.random() * 90 + 5) + '%';
        el.style.top = outside ? (Math.random() * 80 + 10) + 'px' : (Math.random() * 80 + 110) + 'px';
        membrane.appendChild(el);
    }
    
    function stimulate() {
        if (state !== 'resting') return;
        voltage = -50; // Boost above threshold
    }
    
    function loop() {
        // Physics update
        if (voltage > threshold && state === 'resting') {
            state = 'depol';
        }
        
        if (state === 'depol') {
            voltage += 2; // Na+ influx
            chanNa.classList.add('open');
            moveIons('na', 'in');
            
            if (voltage >= peak) {
                state = 'repol';
            }
        } else if (state === 'repol') {
            voltage -= 2; // K+ efflux
            chanNa.classList.remove('open');
            chanK.classList.add('open');
            moveIons('k', 'out');
            
            if (voltage <= -80) {
                state = 'hyperpol';
            }
        } else if (state === 'hyperpol') {
            voltage += 0.5; // Pump restores
            chanK.classList.remove('open');
            
            if (voltage >= restingV) {
                voltage = restingV;
                state = 'resting';
            }
        } else {
            // Decay to rest
            voltage += (restingV - voltage) * 0.1;
        }
        
        // Graph
        trace.push(voltage);
        if (trace.length > 800) trace.shift();
        
        drawGraph();
        document.getElementById('status').textContent = `Voltage: ${voltage.toFixed(1)} mV (${state})`;
        
        requestAnimationFrame(loop);
    }
    
    function moveIons(type, dir) {
        // Visual effect only - animate a few ions moving through channel
        if (Math.random() > 0.2) return;
        
        const ions = document.querySelectorAll(`.ion.${type}`);
        const ion = ions[Math.floor(Math.random() * ions.length)];
        
        const rect = (type === 'na' ? chanNa : chanK).getBoundingClientRect();
        const membRect = membrane.getBoundingClientRect();
        
        // Move towards channel x
        // ion.style.left ... complex to animate generic DOM nodes smoothly in loop without layout thrashing
        // Skip detailed ion physics, just channel color is enough for concept.
    }
    
    function drawGraph() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Axes
        ctx.strokeStyle = '#999';
        ctx.beginPath();
        // Y axis: Map -100 to 100 mV -> height
        // 0V line
        const zeroY = mapY(0);
        ctx.moveTo(0, zeroY); ctx.lineTo(800, zeroY);
        ctx.stroke();
        
        // Threshold line
        ctx.strokeStyle = '#fcd34d';
        ctx.setLineDash([5, 5]);
        const thY = mapY(threshold);
        ctx.beginPath(); ctx.moveTo(0, thY); ctx.lineTo(800, thY); ctx.stroke();
        ctx.setLineDash([]);
        
        // Trace
        ctx.strokeStyle = '#ef4444';
        ctx.lineWidth = 2;
        ctx.beginPath();
        trace.forEach((v, i) => {
            const x = i;
            const y = mapY(v);
            if(i===0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        });
        ctx.stroke();
    }
    
    function mapY(v) {
        // Range -90 to +50
        // Canvas height 300
        const min = -100;
        const max = 60;
        return 300 - ((v - min) / (max - min)) * 300;
    }
    
    init();

</script>
</body>
</html>
