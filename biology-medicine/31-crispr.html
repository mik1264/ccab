<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRISPR-Cas9 Simulator - CCAB</title>
    <link rel="stylesheet" href="../assets/css/gallery-standard.css">
    <style>
        body {
            background: #111827;
            color: #fff;
            font-family: system-ui;
            padding: 2rem;
            text-align: center;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        
        .viewport {
            height: 400px;
            background: #1f2937;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            border: 1px solid #374151;
        }
        
        .dna-strand {
            position: absolute;
            top: 200px;
            left: 0;
            white-space: nowrap;
            font-family: monospace;
            font-size: 24px;
            letter-spacing: 15px;
            transition: transform 0.5s linear;
        }
        
        .base {
            display: inline-block;
            width: 20px;
            text-align: center;
            position: relative;
        }
        .base.target { color: #fcd34d; font-weight: bold; }
        .base.pam { color: #ef4444; font-weight: bold; text-decoration: underline; }
        
        .cas9 {
            position: absolute;
            top: 150px;
            left: 400px;
            width: 100px;
            height: 100px;
            background: rgba(59, 130, 246, 0.3);
            border: 2px solid #3b82f6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #93c5fd;
            font-weight: bold;
            box-shadow: 0 0 20px #3b82f6;
            transition: all 0.3s;
        }
        
        .guide-rna {
            position: absolute;
            top: 180px;
            left: 400px;
            font-family: monospace;
            color: #fcd34d;
            font-weight: bold;
            letter-spacing: 15px;
            white-space: nowrap;
            pointer-events: none;
        }
        
        .controls {
            margin-top: 20px;
            background: #374151;
            padding: 20px;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        
        button {
            padding: 10px 20px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        button:disabled { background: #6b7280; }
        
        .message {
            margin-top: 10px;
            font-size: 1.2rem;
            min-height: 30px;
            color: #60a5fa;
        }
        
        .cut-line {
            position: absolute;
            top: 190px;
            left: 480px;
            width: 4px;
            height: 40px;
            background: #ef4444;
            display: none;
        }
        
    </style>
</head>
<body>

<div class="container">
    <a href="../index.html" class="gallery-back">‚Üê Back to Gallery</a>
    <h1>CRISPR-Cas9 Simulator</h1>
    <p>Simulating the search for a target DNA sequence guided by RNA.</p>
    
    <div class="viewport">
        <div class="dna-strand" id="dna">
            <!-- DNA bases injected here -->
        </div>
        
        <div class="cas9" id="cas9">Cas9</div>
        <div class="guide-rna" id="grna">GATTC</div>
        <div class="cut-line" id="cut"></div>
    </div>
    
    <div class="message" id="msg">Scanning...</div>
    
    <div class="controls">
        <button onclick="scan()" id="btn-scan">Start Scan</button>
        <button onclick="reset()" id="btn-reset">Reset</button>
    </div>
</div>

<script>
    const dnaEl = document.getElementById('dna');
    const msgEl = document.getElementById('msg');
    const cutEl = document.getElementById('cut');
    
    // Config
    const TARGET = "GATTC";
    const PAM = "GG"; // SpCas9 looks for NGG. Let's simplify to GG suffix.
    const LENGTH = 50;
    
    let sequence = "";
    let pos = 0;
    let scanning = false;
    
    function generateDNA() {
        const bases = ['A', 'T', 'G', 'C'];
        sequence = "";
        for(let i=0; i<LENGTH; i++) {
            sequence += bases[Math.floor(Math.random() * bases.length)];
        }
        
        // Insert Target + PAM at random spot
        const insertPos = Math.floor(Math.random() * (LENGTH - 10)) + 5;
        sequence = sequence.substring(0, insertPos) + TARGET + "T" + PAM + sequence.substring(insertPos + TARGET.length + 3);
        
        // Render
        dnaEl.innerHTML = sequence.split('').map((b, i) => {
            let cls = 'base';
            // Cheat: highlight target for debugging? No, let user find it.
            // Highlight PAM if near
            return `<span class="${cls}">${b}</span>`;
        }).join('');
        
        // Initial pos
        dnaEl.style.transform = `translateX(0px)`;
    }
    
    function reset() {
        scanning = false;
        pos = 0;
        cutEl.style.display = 'none';
        document.getElementById('cas9').style.borderColor = '#3b82f6';
        msgEl.textContent = "Ready to scan.";
        generateDNA();
        document.getElementById('btn-scan').disabled = false;
    }
    
    function scan() {
        if (scanning) return;
        scanning = true;
        msgEl.textContent = "Scanning for PAM sequence (GG)...";
        loop();
    }
    
    function loop() {
        if (!scanning) return;
        
        // Move DNA left (simulate Cas9 moving right along strand)
        // Center is index 400px / (char width + spacing) approx index 10-15
        // Let's say index 0 is at left 400.
        // We scan index 'pos'.
        // Shift amount = -pos * 30px (approx char width)
        
        const charW = 27; // approx with spacing
        const offset = 400;
        
        dnaEl.style.transform = `translateX(${offset - pos * charW}px)`;
        
        // Check current position
        // Cas9 checks for PAM (NGG)
        // Let's say PAM is at pos+len+1
        // We look at window of text
        const window = sequence.substring(pos, pos + TARGET.length + 3); // Target + N + GG
        
        // Logic:
        // 1. Check for PAM at end
        // 2. If PAM found, unzip and check Guide RNA match
        
        // Check local window
        // Actually, simplistic view: We match TARGET.
        // PAM is usually downstream.
        // Let's check if we match TARGET
        
        const currentSegment = sequence.substring(pos, pos + TARGET.length);
        
        // Visual feedback
        if (currentSegment === TARGET) {
            // Check PAM
            const pamCheck = sequence.substring(pos + TARGET.length + 1, pos + TARGET.length + 3);
            
            if (pamCheck === "GG") {
                // Match Found!
                scanning = false;
                matchFound();
                return;
            }
        }
        
        pos++;
        if (pos > sequence.length - TARGET.length) {
            scanning = false;
            msgEl.textContent = "Scan complete. No target found.";
            return;
        }
        
        setTimeout(loop, 100);
    }
    
    function matchFound() {
        msgEl.textContent = "Match Found! Target + PAM detected. Binding...";
        document.getElementById('cas9').style.borderColor = '#10b981'; // Green
        document.getElementById('cas9').style.boxShadow = '0 0 30px #10b981';
        
        // Highlight DNA
        const bases = dnaEl.children;
        for(let i=0; i<TARGET.length; i++) {
            bases[pos + i].classList.add('target');
        }
        bases[pos + TARGET.length + 1].classList.add('pam');
        bases[pos + TARGET.length + 2].classList.add('pam');
        
        // Cut animation
        setTimeout(() => {
            msgEl.textContent = "Cutting DNA strand...";
            cutEl.style.display = 'block';
            
            setTimeout(() => {
                msgEl.textContent = "DNA Cleaved. Repair mechanisms triggered.";
                // Split visual?
                // Hard with simple text div. Just show line.
            }, 1000);
        }, 1000);
    }
    
    generateDNA();

</script>
</body>
</html>
