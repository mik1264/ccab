<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nephron Function - CCAB</title>
    <link rel="stylesheet" href="../assets/css/gallery-standard.css">
    <style>
        body {
            background: #fffbeb;
            color: #333;
            font-family: system-ui;
            padding: 2rem;
            text-align: center;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        
        canvas {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .controls {
            margin: 20px;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            font-weight: bold;
        }
        .dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
        
    </style>
</head>
<body>

<div class="container">
    <a href="../index.html" class="gallery-back">‚Üê Back to Gallery</a>
    <h1>Kidney Nephron Function</h1>
    <p>Filtration in Glomerulus, Reabsorption in Tubules, Concentration in Loop of Henle.</p>
    
    <div class="legend">
        <span><div class="dot" style="background:#ef4444"></div> RBC (Too big)</span>
        <span><div class="dot" style="background:#3b82f6"></div> Water</span>
        <span><div class="dot" style="background:#fcd34d"></div> Glucose</span>
        <span><div class="dot" style="background:#78350f"></div> Urea</span>
    </div>
    
    <canvas id="canvas" width="800" height="500"></canvas>
    
    <div class="controls">
        <!-- <button onclick="reset()">Reset</button> -->
    </div>
</div>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    let particles = [];
    
    // Geometry path for nephron
    // Blood: 0,100 -> 200,100 (Glomerulus) -> Out
    // Tubule: 200,100 -> 300,100 (Proximal) -> 300,400 -> 500,400 (Loop) -> 500,100 (Distal) -> 600,100 -> 600,500 (Collecting)
    
    const tubulePath = [
        {x: 200, y: 150},
        {x: 300, y: 150}, // Proximal
        {x: 300, y: 400}, // Descending Loop
        {x: 500, y: 400}, // Ascending Loop
        {x: 500, y: 150}, // Distal
        {x: 600, y: 150}, // Collecting Start
        {x: 600, y: 500}  // Collecting End
    ];
    
    function spawnParticle() {
        const r = Math.random();
        let type = 'water';
        if (r < 0.1) type = 'rbc';
        else if (r < 0.3) type = 'glucose';
        else if (r < 0.5) type = 'urea';
        
        particles.push({
            type: type,
            x: 0,
            y: 120 + (Math.random()-0.5)*20,
            pathPos: 0, // 0 to 1 along path
            location: 'blood', // blood, tubule, reabsorbed, urine
            segment: 0
        });
    }
    
    function loop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        drawNephronBackground();
        
        if (Math.random() < 0.2) spawnParticle();
        
        for (let i = particles.length - 1; i >= 0; i--) {
            let p = particles[i];
            
            if (p.location === 'blood') {
                p.x += 2;
                // Glomerulus check (x > 200)
                if (p.x > 200) {
                    if (p.type === 'rbc') {
                        // Keep in blood (Efferent arteriole)
                        p.y -= 1; // Exit top
                    } else {
                        // Filter into Bowman's Capsule
                        p.location = 'tubule';
                        p.x = 200;
                        p.y = 150;
                        p.segment = 0;
                        p.segmentProgress = 0;
                    }
                }
                if (p.y < 0) particles.splice(i, 1); // Exit screen
            } 
            else if (p.location === 'tubule') {
                // Move along path segments
                const start = tubulePath[p.segment];
                const end = tubulePath[p.segment+1];
                
                if (!end) { // End of line (Urine)
                    p.location = 'urine';
                    continue;
                }
                
                const dx = end.x - start.x;
                const dy = end.y - start.y;
                const len = Math.hypot(dx, dy);
                
                p.segmentProgress += 2 / len; // speed
                
                p.x = start.x + dx * p.segmentProgress + (Math.random()-0.5)*10;
                p.y = start.y + dy * p.segmentProgress + (Math.random()-0.5)*10;
                
                // Reabsorption Logic
                if (p.segment === 1) { // Proximal (Glucose & Water)
                    if (p.type === 'glucose') {
                        // 100% reabsorbed
                        p.location = 'reabsorbed';
                    }
                    if (p.type === 'water' && Math.random() < 0.01) p.location = 'reabsorbed';
                }
                else if (p.segment === 2) { // Descending Loop (Water out)
                    if (p.type === 'water' && Math.random() < 0.02) p.location = 'reabsorbed';
                }
                // Segment 3 Ascending (Salt out - simplified)
                // Segment 5 Collecting (Water out if ADH)
                else if (p.segment === 5) {
                    if (p.type === 'water' && Math.random() < 0.02) p.location = 'reabsorbed';
                }
                
                if (p.segmentProgress >= 1) {
                    p.segment++;
                    p.segmentProgress = 0;
                }
            }
            else if (p.location === 'reabsorbed') {
                // Fade out / move to blood capillaries
                p.y -= 1;
                //ctx.globalAlpha = 0.5;
                if (p.y < 0) particles.splice(i, 1);
            }
            else if (p.location === 'urine') {
                p.y += 2;
                if (p.y > 500) particles.splice(i, 1);
            }
            
            // Draw
            ctx.fillStyle = getColor(p.type);
            ctx.beginPath(); ctx.arc(p.x, p.y, p.type==='rbc'?6:4, 0, Math.PI*2); ctx.fill();
        }
        
        requestAnimationFrame(loop);
    }
    
    function getColor(type) {
        if (type === 'rbc') return '#ef4444';
        if (type === 'water') return '#3b82f6';
        if (type === 'glucose') return '#fcd34d';
        return '#78350f'; // Urea
    }
    
    function drawNephronBackground() {
        ctx.lineJoin = 'round';
        ctx.lineCap = 'round';
        
        // Glomerulus
        ctx.fillStyle = '#fee2e2';
        ctx.beginPath(); ctx.arc(200, 120, 40, 0, Math.PI*2); ctx.fill();
        
        // Tubule
        ctx.strokeStyle = '#fef3c7'; // Yellowish
        ctx.lineWidth = 30;
        ctx.beginPath();
        ctx.moveTo(200, 150);
        for(let i=1; i<tubulePath.length; i++) {
            ctx.lineTo(tubulePath[i].x, tubulePath[i].y);
        }
        ctx.stroke();
        
        // Outline
        ctx.strokeStyle = '#d97706';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(200, 150);
        for(let i=1; i<tubulePath.length; i++) {
            ctx.lineTo(tubulePath[i].x, tubulePath[i].y);
        }
        ctx.stroke();
        
        // Labels
        ctx.fillStyle = '#333';
        ctx.font = '14px sans-serif';
        ctx.fillText("Glomerulus", 150, 80);
        ctx.fillText("Proximal", 250, 130);
        ctx.fillText("Loop of Henle", 400, 420);
        ctx.fillText("Distal", 500, 130);
        ctx.fillText("Collecting Duct", 620, 300);
    }
    
    requestAnimationFrame(loop);

</script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
