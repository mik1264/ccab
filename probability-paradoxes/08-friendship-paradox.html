<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Friendship Paradox - Your Friends Are More Popular Than You</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; overflow: hidden; font-family: 'Segoe UI', Arial, sans-serif; color: #cde; }
canvas { display: block; cursor: pointer; }
a.back { position: fixed; top: 20px; left: 20px; color: #8af; text-decoration: none; z-index: 100; font-size: 1.1em; }
a.back:hover { color: #bdf; }

#controls {
    position: fixed; top: 20px; right: 20px;
    background: rgba(20,20,40,0.85); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(138,170,255,0.15); border-radius: 12px;
    padding: 18px; z-index: 100; width: 260px; font-size: 13px;
}
#controls h3 { margin-bottom: 10px; color: #8af; font-size: 15px; }
.ctrl-row { margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
.ctrl-row label { flex: 0 0 90px; font-size: 12px; }
.ctrl-row input[type=range] { flex: 1; margin: 0 8px; accent-color: #8af; }
.ctrl-row .val { flex: 0 0 30px; text-align: right; color: #8af; font-size: 12px; }
button {
    background: rgba(138,170,255,0.15); color: #8af; border: 1px solid rgba(138,170,255,0.3);
    border-radius: 6px; padding: 5px 12px; cursor: pointer; font-size: 12px; margin: 2px;
}
button:hover { background: rgba(138,170,255,0.3); }

#node-info {
    position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
    background: rgba(20,20,40,0.9); backdrop-filter: blur(10px);
    border: 1px solid rgba(138,170,255,0.2); border-radius: 12px;
    padding: 14px 20px; z-index: 100; font-size: 14px; text-align: center;
    display: none; min-width: 300px;
}
#node-info .name { color: #8af; font-weight: 700; font-size: 16px; }
#node-info .stat { margin: 4px 0; }
#node-info .highlight { color: #f8a; font-weight: 700; }
#node-info .less { color: #f66; }
#node-info .more { color: #6f6; }

#stats-panel {
    position: fixed; bottom: 20px; left: 20px;
    background: rgba(20,20,40,0.85); backdrop-filter: blur(10px);
    border: 1px solid rgba(138,170,255,0.15); border-radius: 12px;
    padding: 14px 18px; z-index: 100; font-size: 13px; min-width: 260px;
}
#stats-panel .row { display: flex; justify-content: space-between; margin: 3px 0; }
#stats-panel .val { color: #8af; font-weight: 600; }
#stats-panel .red { color: #f66; }

#info {
    position: fixed; bottom: 20px; right: 20px;
    background: rgba(20,20,40,0.85); backdrop-filter: blur(10px);
    border: 1px solid rgba(138,170,255,0.15); border-radius: 12px;
    padding: 14px 18px; z-index: 100; font-size: 12px; max-width: 300px; line-height: 1.5;
}
#info h4 { color: #8af; margin-bottom: 6px; font-size: 14px; }
#info .formula { color: #f8a; font-family: 'Courier New', monospace; margin: 6px 0; font-size: 12px; }
</style>
</head>
<body>
<a href="index.html" class="back">&#8592; Back</a>
<canvas id="canvas"></canvas>

<div id="controls">
    <h3>Friendship Paradox</h3>
    <div class="ctrl-row">
        <label>Nodes</label>
        <input type="range" id="nodeCount" min="15" max="80" value="35">
        <span class="val" id="nodeCountVal">35</span>
    </div>
    <div class="ctrl-row">
        <label>Connectivity</label>
        <input type="range" id="connectivity" min="1" max="8" value="3">
        <span class="val" id="connectVal">3</span>
    </div>
    <div style="display:flex;gap:6px;margin-top:6px;">
        <button onclick="generate()">New Network</button>
        <button onclick="window.reset()">Reset</button>
    </div>
    <p style="font-size:11px;opacity:0.6;margin-top:10px;">Click any node to inspect it</p>
</div>

<div id="node-info"></div>

<div id="stats-panel">
    <div class="row"><span>Nodes:</span><span class="val" id="nNodes">0</span></div>
    <div class="row"><span>Edges:</span><span class="val" id="nEdges">0</span></div>
    <div class="row"><span>Avg friends:</span><span class="val" id="avgFriends">0</span></div>
    <div class="row"><span>Avg friends-of-friends:</span><span class="val" id="avgFoF">0</span></div>
    <div class="row"><span>Nodes less popular than friends:</span><span class="red" id="lessPop">0</span></div>
</div>

<div id="info">
    <h4>The Paradox</h4>
    <p>On average, your friends have more friends than you do. This is mathematically guaranteed!</p>
    <div class="formula">E[friends of friends] &ge; E[friends]</div>
    <p>Why? People with many connections appear as "your friend" more often, skewing the average upward. This is a sampling bias: high-degree nodes are overrepresented in everyone's friend list.</p>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let W, H;
let nodes = [], edges = [];
let selectedNode = null;
let dragging = null, dragOffX = 0, dragOffY = 0;
let animId;

function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
}

function generate() {
    const n = parseInt(document.getElementById('nodeCount').value);
    const k = parseInt(document.getElementById('connectivity').value);
    nodes = [];
    edges = [];
    selectedNode = null;
    document.getElementById('node-info').style.display = 'none';

    for (let i = 0; i < n; i++) {
        nodes.push({
            x: W * 0.15 + Math.random() * W * 0.7,
            y: H * 0.15 + Math.random() * H * 0.7,
            vx: 0, vy: 0,
            friends: [],
            id: i,
            label: 'Person ' + (i + 1)
        });
    }

    // Barabasi-Albert preferential attachment for realistic degree distribution
    for (let i = 0; i < n; i++) {
        const targets = Math.min(k, i);
        const connected = new Set();
        for (let t = 0; t < targets; t++) {
            let attempts = 0;
            while (attempts < 100) {
                let j;
                if (edges.length === 0 || Math.random() < 0.3) {
                    j = Math.floor(Math.random() * i);
                } else {
                    // preferential attachment
                    const e = edges[Math.floor(Math.random() * edges.length)];
                    j = Math.random() < 0.5 ? e.a : e.b;
                }
                if (j !== i && !connected.has(j)) {
                    connected.add(j);
                    edges.push({ a: i, b: j });
                    nodes[i].friends.push(j);
                    nodes[j].friends.push(i);
                    break;
                }
                attempts++;
            }
        }
    }

    computeStats();
}

function computeStats() {
    const n = nodes.length;
    let totalFriends = 0;
    let totalFoF = 0;
    let lessPop = 0;

    for (const node of nodes) {
        const myFriends = node.friends.length;
        totalFriends += myFriends;

        if (myFriends > 0) {
            let fofSum = 0;
            for (const f of node.friends) {
                fofSum += nodes[f].friends.length;
            }
            node.avgFoF = fofSum / myFriends;
        } else {
            node.avgFoF = 0;
        }

        node.lessPopular = node.avgFoF > myFriends;
        if (node.lessPopular) lessPop++;
    }

    const avgF = totalFriends / n;
    for (const node of nodes) {
        if (node.friends.length > 0) {
            totalFoF += node.avgFoF;
        }
    }
    const avgFoF = totalFoF / n;

    document.getElementById('nNodes').textContent = n;
    document.getElementById('nEdges').textContent = edges.length;
    document.getElementById('avgFriends').textContent = avgF.toFixed(2);
    document.getElementById('avgFoF').textContent = avgFoF.toFixed(2);
    document.getElementById('lessPop').textContent = lessPop + ' / ' + n + ' (' + Math.round(lessPop / n * 100) + '%)';
}

function forceLayout() {
    const repulsion = 3000;
    const attraction = 0.005;
    const damping = 0.85;
    const centerPull = 0.001;

    for (let i = 0; i < nodes.length; i++) {
        let fx = 0, fy = 0;
        // repulsion from all nodes
        for (let j = 0; j < nodes.length; j++) {
            if (i === j) continue;
            const dx = nodes[i].x - nodes[j].x;
            const dy = nodes[i].y - nodes[j].y;
            const dist = Math.sqrt(dx * dx + dy * dy) + 1;
            fx += (dx / dist) * repulsion / (dist * dist);
            fy += (dy / dist) * repulsion / (dist * dist);
        }
        // attraction to friends
        for (const f of nodes[i].friends) {
            const dx = nodes[f].x - nodes[i].x;
            const dy = nodes[f].y - nodes[i].y;
            fx += dx * attraction;
            fy += dy * attraction;
        }
        // center pull
        fx += (W / 2 - nodes[i].x) * centerPull;
        fy += (H / 2 - nodes[i].y) * centerPull;

        if (dragging !== i) {
            nodes[i].vx = (nodes[i].vx + fx) * damping;
            nodes[i].vy = (nodes[i].vy + fy) * damping;
            nodes[i].x += nodes[i].vx;
            nodes[i].y += nodes[i].vy;
            nodes[i].x = Math.max(30, Math.min(W - 30, nodes[i].x));
            nodes[i].y = Math.max(30, Math.min(H - 30, nodes[i].y));
        }
    }
}

function draw() {
    ctx.clearRect(0, 0, W, H);

    // edges
    for (const e of edges) {
        const a = nodes[e.a], b = nodes[e.b];
        const isHighlighted = selectedNode !== null &&
            (e.a === selectedNode || e.b === selectedNode);
        ctx.beginPath();
        ctx.moveTo(a.x, a.y);
        ctx.lineTo(b.x, b.y);
        ctx.strokeStyle = isHighlighted ? 'rgba(138,170,255,0.6)' : 'rgba(138,170,255,0.08)';
        ctx.lineWidth = isHighlighted ? 2 : 0.8;
        ctx.stroke();
    }

    // nodes
    for (let i = 0; i < nodes.length; i++) {
        const node = nodes[i];
        const isSelected = i === selectedNode;
        const isFriend = selectedNode !== null && nodes[selectedNode].friends.includes(i);
        const r = Math.max(5, 3 + node.friends.length * 1.2);

        ctx.beginPath();
        ctx.arc(node.x, node.y, r, 0, Math.PI * 2);

        if (isSelected) {
            ctx.fillStyle = '#fff';
            ctx.shadowColor = '#8af';
            ctx.shadowBlur = 20;
        } else if (isFriend) {
            ctx.fillStyle = '#8af';
            ctx.shadowColor = '#8af';
            ctx.shadowBlur = 10;
        } else if (node.lessPopular) {
            ctx.fillStyle = 'rgba(255,100,100,0.7)';
            ctx.shadowBlur = 0;
        } else {
            ctx.fillStyle = 'rgba(100,255,100,0.7)';
            ctx.shadowBlur = 0;
        }
        ctx.fill();
        ctx.shadowBlur = 0;

        // degree label
        if (r > 6 || isSelected || isFriend) {
            ctx.fillStyle = isSelected || isFriend ? '#fff' : 'rgba(200,220,240,0.6)';
            ctx.font = (isSelected ? 'bold 12px' : '10px') + ' sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(node.friends.length, node.x, node.y - r - 4);
        }
    }

    // legend
    ctx.fillStyle = 'rgba(255,100,100,0.7)';
    ctx.beginPath(); ctx.arc(W - 200, H - 60, 6, 0, Math.PI * 2); ctx.fill();
    ctx.fillStyle = '#aaa';
    ctx.font = '11px sans-serif';
    ctx.textAlign = 'left';
    ctx.fillText('Less popular than friends', W - 188, H - 56);

    ctx.fillStyle = 'rgba(100,255,100,0.7)';
    ctx.beginPath(); ctx.arc(W - 200, H - 40, 6, 0, Math.PI * 2); ctx.fill();
    ctx.fillStyle = '#aaa';
    ctx.fillText('More popular (or equal)', W - 188, H - 36);
}

function animate() {
    forceLayout();
    draw();
    animId = requestAnimationFrame(animate);
}

function getNodeAt(mx, my) {
    for (let i = nodes.length - 1; i >= 0; i--) {
        const dx = mx - nodes[i].x, dy = my - nodes[i].y;
        const r = Math.max(8, 3 + nodes[i].friends.length * 1.2);
        if (dx * dx + dy * dy < (r + 5) * (r + 5)) return i;
    }
    return null;
}

canvas.addEventListener('mousedown', function(e) {
    const idx = getNodeAt(e.clientX, e.clientY);
    if (idx !== null) {
        dragging = idx;
        dragOffX = nodes[idx].x - e.clientX;
        dragOffY = nodes[idx].y - e.clientY;
    }
});

canvas.addEventListener('mousemove', function(e) {
    if (dragging !== null) {
        nodes[dragging].x = e.clientX + dragOffX;
        nodes[dragging].y = e.clientY + dragOffY;
        nodes[dragging].vx = 0;
        nodes[dragging].vy = 0;
    }
});

canvas.addEventListener('mouseup', function(e) {
    if (dragging !== null) {
        const moved = Math.abs(nodes[dragging].x - (e.clientX + dragOffX)) + Math.abs(nodes[dragging].y - (e.clientY + dragOffY));
        if (moved < 3) {
            selectNode(dragging);
        }
        dragging = null;
    }
});

canvas.addEventListener('click', function(e) {
    if (dragging !== null) return;
    const idx = getNodeAt(e.clientX, e.clientY);
    selectNode(idx);
});

function selectNode(idx) {
    selectedNode = idx;
    const infoEl = document.getElementById('node-info');
    if (idx === null) {
        infoEl.style.display = 'none';
        return;
    }
    const node = nodes[idx];
    const myF = node.friends.length;
    const fofAvg = node.avgFoF.toFixed(1);
    const cls = node.lessPopular ? 'less' : 'more';
    const verdict = node.lessPopular
        ? 'Your friends ARE more popular than you!'
        : 'You are at least as popular as your average friend.';

    infoEl.innerHTML = `
        <div class="name">${node.label}</div>
        <div class="stat">Your friends: <span class="highlight">${myF}</span></div>
        <div class="stat">Avg friends of your friends: <span class="highlight">${fofAvg}</span></div>
        <div class="stat ${cls}">${verdict}</div>
    `;
    infoEl.style.display = 'block';
}

document.getElementById('nodeCount').addEventListener('input', function() {
    document.getElementById('nodeCountVal').textContent = this.value;
});
document.getElementById('connectivity').addEventListener('input', function() {
    document.getElementById('connectVal').textContent = this.value;
});

window.addEventListener('resize', resize);

window.reset = function() {
    generate();
};

resize();
generate();
animate();
</script>
<script src="../assets/js/enhance.js"></script>
</body>
</html>
