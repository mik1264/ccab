<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Benford's Law - First Digit Frequencies</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; overflow: hidden; font-family: 'Segoe UI', Arial, sans-serif; color: #c8d8e8; }
canvas { display: block; }
a.back { position: fixed; top: 20px; left: 20px; color: #8af; text-decoration: none; z-index: 100; font-size: 1.1em; }
a.back:hover { color: #bdf; }

#controls {
  position: fixed; top: 20px; right: 20px; z-index: 100;
  background: rgba(20,20,40,0.85); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(120,160,255,0.15); border-radius: 12px;
  padding: 16px 20px; min-width: 240px; max-width: 280px;
}
#controls h3 { color: #8af; margin-bottom: 10px; font-size: 0.95em; text-transform: uppercase; letter-spacing: 1px; }
.ctrl-row { margin-bottom: 10px; }
.ctrl-row label { display: block; font-size: 0.8em; color: #8ab; margin-bottom: 3px; }
.ctrl-row select, .ctrl-row textarea {
  width: 100%; background: rgba(30,40,70,0.8); border: 1px solid rgba(120,160,255,0.2);
  color: #c8d8e8; padding: 5px 8px; border-radius: 6px; font-size: 0.85em; font-family: inherit;
}
.ctrl-row textarea { height: 50px; resize: vertical; }
.btn {
  background: rgba(100,160,255,0.15); border: 1px solid rgba(100,160,255,0.3);
  color: #8af; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; margin: 2px;
}
.btn:hover { background: rgba(100,160,255,0.3); }
.btn.active { background: rgba(100,200,150,0.25); border-color: rgba(100,200,150,0.5); color: #8fa; }

#info {
  position: fixed; bottom: 20px; left: 20px; z-index: 100; max-width: 380px;
  background: rgba(20,20,40,0.85); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(120,160,255,0.1); border-radius: 12px;
  padding: 14px 18px; font-size: 0.82em; line-height: 1.5; color: #8ab;
}
#info h4 { color: #8af; margin-bottom: 6px; }
#info .formula { color: #f8a; font-family: 'Courier New', monospace; font-size: 0.95em; }

#chi2 {
  position: fixed; bottom: 20px; right: 20px; z-index: 100;
  background: rgba(20,20,40,0.85); backdrop-filter: blur(10px); border: 1px solid rgba(120,160,255,0.1);
  border-radius: 12px; padding: 14px 18px; min-width: 180px; text-align: center;
}
#chi2 h4 { color: #8af; margin-bottom: 8px; font-size: 0.85em; text-transform: uppercase; letter-spacing: 1px; }
#chi2 .value { font-size: 1.8em; font-weight: bold; }
#chi2 .verdict { margin-top: 6px; font-size: 0.85em; }

#stream {
  position: fixed; top: 50%; left: 20px; transform: translateY(-50%);
  z-index: 50; width: 120px; height: 300px; overflow: hidden; pointer-events: none;
}
.stream-num {
  position: absolute; font-family: 'Courier New', monospace; font-size: 1em;
  opacity: 0; animation: streamDown 3s linear forwards; white-space: nowrap;
}
@keyframes streamDown {
  0% { opacity: 0; transform: translateY(-20px); }
  10% { opacity: 0.8; }
  90% { opacity: 0.6; }
  100% { opacity: 0; transform: translateY(300px); }
}
</style>
</head>
<body>
<a href="index.html" class="back">&larr; Back</a>
<canvas id="c"></canvas>
<div id="stream"></div>

<div id="controls">
  <h3>Benford's Law</h3>
  <div class="ctrl-row">
    <label>Dataset</label>
    <select id="dataset">
      <option value="fibonacci">Fibonacci Numbers</option>
      <option value="powers2">Powers of 2</option>
      <option value="population" selected>World Populations</option>
      <option value="stocks">Stock Prices</option>
      <option value="fabricated">Fabricated Data (Uniform)</option>
      <option value="custom">Custom Data</option>
    </select>
  </div>
  <div class="ctrl-row" id="customRow" style="display:none;">
    <label>Enter numbers (comma-separated)</label>
    <textarea id="customData" placeholder="e.g. 123, 456, 789, 1024, 55, 8901">123, 456, 789, 1024, 55, 8901, 345, 2100, 67, 950, 1, 23, 678, 999, 4321, 8765, 11, 222, 3000, 51</textarea>
    <button class="btn" onclick="loadCustom()" style="margin-top:4px;">Analyze</button>
  </div>
  <div class="ctrl-row">
    <label>Sample Size <span style="float:right; color:#adf;" id="vSize">1000</span></label>
    <input type="range" id="sSize" min="100" max="10000" step="100" value="1000" style="width:100%; accent-color:#6af;">
  </div>
  <div style="margin-top:8px;">
    <button class="btn" onclick="generate()">Regenerate</button>
    <button class="btn" id="bAnimate" onclick="toggleAnimate()">Animate</button>
  </div>
</div>

<div id="info">
  <h4>The Paradox</h4>
  In many real-world datasets, the leading digit is '1' about 30% of the time, not 11% as you might expect.
  Benford's Law states:<br>
  <span class="formula">P(d) = log<sub>10</sub>(1 + 1/d)</span><br>
  This applies to populations, stock prices, Fibonacci numbers, and more.
  Fabricated data often fails this test -- a tool used in forensic accounting.
</div>

<div id="chi2">
  <h4>Goodness of Fit</h4>
  <div class="value" id="chi2val">--</div>
  <div class="verdict" id="verdict">--</div>
</div>

<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let W, H;

function resize() {
  W = canvas.width = window.innerWidth;
  H = canvas.height = window.innerHeight;
  draw();
}

const benford = [];
for (let d = 1; d <= 9; d++) benford.push(Math.log10(1 + 1 / d));

let observed = new Array(9).fill(0);
let totalCount = 0;
let animating = false;
let animFrame = null;
let animData = [];
let animIdx = 0;
let targetBars = new Array(9).fill(0);
let displayBars = new Array(9).fill(0);

function firstDigit(n) {
  n = Math.abs(n);
  if (n === 0) return 0;
  while (n >= 10) n /= 10;
  while (n < 1) n *= 10;
  return Math.floor(n);
}

function generateFibonacci(count) {
  const nums = [];
  let a = 1, b = 1;
  for (let i = 0; i < count; i++) {
    nums.push(a);
    const t = a + b; a = b; b = t;
    if (a > 1e15) { a = 1; b = 1; }
  }
  return nums;
}

function generatePowers2(count) {
  const nums = [];
  for (let i = 1; i <= count; i++) nums.push(Math.pow(2, i));
  return nums;
}

function generatePopulation(count) {
  const nums = [];
  for (let i = 0; i < count; i++) {
    const exp = Math.random() * 7 + 2;
    nums.push(Math.pow(10, exp));
  }
  return nums;
}

function generateStocks(count) {
  const nums = [];
  let price = 50;
  for (let i = 0; i < count; i++) {
    price *= Math.exp((Math.random() - 0.48) * 0.1);
    if (price < 1) price = 1 + Math.random() * 10;
    nums.push(price);
  }
  return nums;
}

function generateFabricated(count) {
  const nums = [];
  for (let i = 0; i < count; i++) {
    nums.push(Math.floor(Math.random() * 9000) + 1000);
  }
  return nums;
}

function analyze(data) {
  observed = new Array(9).fill(0);
  totalCount = 0;
  for (const n of data) {
    const d = firstDigit(n);
    if (d >= 1 && d <= 9) {
      observed[d - 1]++;
      totalCount++;
    }
  }
  targetBars = observed.map(c => totalCount > 0 ? c / totalCount : 0);
  computeChi2();
}

function computeChi2() {
  if (totalCount < 10) {
    document.getElementById('chi2val').textContent = '--';
    document.getElementById('verdict').textContent = 'Need more data';
    return;
  }
  let chi2 = 0;
  for (let i = 0; i < 9; i++) {
    const expected = benford[i] * totalCount;
    chi2 += Math.pow(observed[i] - expected, 2) / expected;
  }
  document.getElementById('chi2val').textContent = chi2.toFixed(2);
  const el = document.getElementById('chi2val');
  const vEl = document.getElementById('verdict');
  if (chi2 < 15.51) {
    el.style.color = '#4f8'; vEl.textContent = 'Passes Benford test'; vEl.style.color = '#4f8';
  } else if (chi2 < 20.09) {
    el.style.color = '#fa4'; vEl.textContent = 'Marginal fit'; vEl.style.color = '#fa4';
  } else {
    el.style.color = '#f55'; vEl.textContent = 'Fails Benford test!'; vEl.style.color = '#f55';
  }
}

function generate() {
  stopAnimate();
  const sel = document.getElementById('dataset').value;
  const count = parseInt(document.getElementById('sSize').value);
  let data;
  switch (sel) {
    case 'fibonacci': data = generateFibonacci(count); break;
    case 'powers2': data = generatePowers2(count); break;
    case 'population': data = generatePopulation(count); break;
    case 'stocks': data = generateStocks(count); break;
    case 'fabricated': data = generateFabricated(count); break;
    case 'custom': loadCustom(); return;
  }
  animData = data;
  analyze(data);
  draw();
}

function loadCustom() {
  stopAnimate();
  const text = document.getElementById('customData').value;
  const nums = text.split(/[,\s]+/).map(Number).filter(n => !isNaN(n) && n !== 0);
  if (nums.length < 2) return;
  animData = nums;
  analyze(nums);
  draw();
}

function toggleAnimate() {
  if (animating) { stopAnimate(); return; }
  animating = true;
  document.getElementById('bAnimate').classList.add('active');
  observed = new Array(9).fill(0);
  totalCount = 0;
  displayBars = new Array(9).fill(0);
  targetBars = new Array(9).fill(0);
  animIdx = 0;
  if (animData.length === 0) {
    const sel = document.getElementById('dataset').value;
    const count = parseInt(document.getElementById('sSize').value);
    switch (sel) {
      case 'fibonacci': animData = generateFibonacci(count); break;
      case 'powers2': animData = generatePowers2(count); break;
      case 'population': animData = generatePopulation(count); break;
      case 'stocks': animData = generateStocks(count); break;
      case 'fabricated': animData = generateFabricated(count); break;
      case 'custom': { const text = document.getElementById('customData').value; animData = text.split(/[,\s]+/).map(Number).filter(n => !isNaN(n) && n !== 0); break; }
    }
  }
  animStep();
}

function stopAnimate() {
  animating = false;
  document.getElementById('bAnimate').classList.remove('active');
  if (animFrame) cancelAnimationFrame(animFrame);
}

let streamContainer = document.getElementById('stream');
let streamCount = 0;

function addStreamNumber(num) {
  if (streamCount > 20) return;
  streamCount++;
  const el = document.createElement('div');
  el.className = 'stream-num';
  const d = firstDigit(num);
  const str = Math.round(num).toString();
  el.innerHTML = '<span style="color:#f84;font-weight:bold;">' + str[0] + '</span>' + str.slice(1);
  el.style.top = (Math.random() * 20) + 'px';
  el.style.left = (Math.random() * 40) + 'px';
  el.style.fontSize = (0.7 + Math.random() * 0.5) + 'em';
  streamContainer.appendChild(el);
  setTimeout(() => { el.remove(); streamCount--; }, 3000);
}

function animStep() {
  if (!animating) return;
  const batchSize = Math.max(1, Math.floor(animData.length / 200));
  for (let i = 0; i < batchSize && animIdx < animData.length; i++, animIdx++) {
    const n = animData[animIdx];
    const d = firstDigit(n);
    if (d >= 1 && d <= 9) { observed[d - 1]++; totalCount++; }
    if (i === 0) addStreamNumber(n);
  }
  targetBars = observed.map(c => totalCount > 0 ? c / totalCount : 0);
  computeChi2();
  draw();
  if (animIdx < animData.length) {
    animFrame = requestAnimationFrame(animStep);
  } else {
    animating = false;
    document.getElementById('bAnimate').classList.remove('active');
  }
}

function draw() {
  ctx.clearRect(0, 0, W, H);

  // Smooth interpolation
  for (let i = 0; i < 9; i++) {
    displayBars[i] += (targetBars[i] - displayBars[i]) * 0.15;
  }

  const chartLeft = W * 0.2;
  const chartRight = W * 0.75;
  const chartTop = H * 0.12;
  const chartBottom = H * 0.82;
  const chartW = chartRight - chartLeft;
  const chartH = chartBottom - chartTop;
  const barW = chartW / 9;
  const gap = barW * 0.15;

  // Title
  ctx.fillStyle = '#c8d8e8';
  ctx.font = 'bold 20px Segoe UI, Arial, sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText("First Digit Frequency Distribution", (chartLeft + chartRight) / 2, chartTop - 30);
  ctx.font = '13px Segoe UI, Arial, sans-serif';
  ctx.fillStyle = '#6a8';
  ctx.fillText(`n = ${totalCount}`, (chartLeft + chartRight) / 2, chartTop - 10);

  // Axes
  ctx.strokeStyle = 'rgba(120,160,255,0.2)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(chartLeft, chartTop);
  ctx.lineTo(chartLeft, chartBottom);
  ctx.lineTo(chartRight, chartBottom);
  ctx.stroke();

  // Y axis labels
  ctx.fillStyle = '#6a8';
  ctx.font = '11px Segoe UI, Arial, sans-serif';
  ctx.textAlign = 'right';
  for (let p = 0; p <= 0.35; p += 0.05) {
    const y = chartBottom - (p / 0.4) * chartH;
    ctx.fillText((p * 100).toFixed(0) + '%', chartLeft - 8, y + 4);
    ctx.strokeStyle = 'rgba(120,160,255,0.07)';
    ctx.beginPath();
    ctx.moveTo(chartLeft, y);
    ctx.lineTo(chartRight, y);
    ctx.stroke();
  }

  for (let i = 0; i < 9; i++) {
    const x = chartLeft + i * barW + gap;
    const w = barW - gap * 2;

    // Observed bar
    const obsH = (displayBars[i] / 0.4) * chartH;
    const grad = ctx.createLinearGradient(x, chartBottom - obsH, x, chartBottom);
    grad.addColorStop(0, 'rgba(100,180,255,0.9)');
    grad.addColorStop(1, 'rgba(60,100,200,0.5)');
    ctx.fillStyle = grad;
    ctx.fillRect(x, chartBottom - obsH, w, obsH);

    // Benford expected line
    const benH = (benford[i] / 0.4) * chartH;
    const benY = chartBottom - benH;
    ctx.strokeStyle = '#f84';
    ctx.lineWidth = 2.5;
    ctx.beginPath();
    ctx.moveTo(x - 4, benY);
    ctx.lineTo(x + w + 4, benY);
    ctx.stroke();

    // Digit label
    ctx.fillStyle = '#c8d8e8';
    ctx.font = 'bold 14px Segoe UI, Arial, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(String(i + 1), x + w / 2, chartBottom + 20);

    // Percentage labels
    if (totalCount > 0) {
      ctx.fillStyle = '#8cf';
      ctx.font = '10px Segoe UI, Arial, sans-serif';
      ctx.fillText((displayBars[i] * 100).toFixed(1) + '%', x + w / 2, chartBottom - obsH - 6);
    }
  }

  // Legend
  ctx.fillStyle = 'rgba(100,180,255,0.8)';
  ctx.fillRect(chartRight + 20, chartTop + 10, 14, 14);
  ctx.fillStyle = '#c8d8e8';
  ctx.font = '12px Segoe UI, Arial, sans-serif';
  ctx.textAlign = 'left';
  ctx.fillText('Observed', chartRight + 40, chartTop + 22);

  ctx.strokeStyle = '#f84';
  ctx.lineWidth = 2.5;
  ctx.beginPath();
  ctx.moveTo(chartRight + 20, chartTop + 40);
  ctx.lineTo(chartRight + 34, chartTop + 40);
  ctx.stroke();
  ctx.fillStyle = '#c8d8e8';
  ctx.fillText('Benford', chartRight + 40, chartTop + 44);

  if (animating) requestAnimationFrame(() => { draw(); });
}

// Event listeners
document.getElementById('dataset').addEventListener('change', function() {
  document.getElementById('customRow').style.display = this.value === 'custom' ? 'block' : 'none';
  generate();
});
document.getElementById('sSize').addEventListener('input', function() {
  document.getElementById('vSize').textContent = this.value;
});
document.getElementById('sSize').addEventListener('change', generate);

window.addEventListener('resize', resize);

window.reset = function() {
  stopAnimate();
  observed = new Array(9).fill(0);
  totalCount = 0;
  targetBars = new Array(9).fill(0);
  displayBars = new Array(9).fill(0);
  animData = [];
  animIdx = 0;
  generate();
};

resize();
generate();
</script>
<script src="../assets/js/enhance.js"></script>
</body>
</html>
