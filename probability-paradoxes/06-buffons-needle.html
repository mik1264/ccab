<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Buffon's Needle - Estimating Pi</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; overflow: hidden; font-family: 'Segoe UI', Arial, sans-serif; color: #cde; }
canvas { display: block; }
a.back { position: fixed; top: 20px; left: 20px; color: #8af; text-decoration: none; z-index: 100; font-size: 1.1em; }
a.back:hover { color: #bdf; }

#controls {
    position: fixed; top: 20px; right: 20px;
    background: rgba(20,20,40,0.85); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(138,170,255,0.15); border-radius: 12px;
    padding: 18px; z-index: 100; width: 260px; font-size: 13px;
}
#controls h3 { margin-bottom: 12px; color: #8af; font-size: 15px; }
.ctrl-row { margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
.ctrl-row label { flex: 0 0 80px; }
.ctrl-row input[type=range] { flex: 1; margin: 0 8px; accent-color: #8af; }
.ctrl-row .val { flex: 0 0 45px; text-align: right; color: #8af; font-size: 12px; }
button {
    background: rgba(138,170,255,0.15); color: #8af; border: 1px solid rgba(138,170,255,0.3);
    border-radius: 6px; padding: 6px 14px; cursor: pointer; font-size: 12px; margin: 2px;
}
button:hover { background: rgba(138,170,255,0.3); }
.btn-row { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px; }

#pi-display {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    pointer-events: none; z-index: 50; text-align: center;
    opacity: 0.12;
}
#pi-display .big { font-size: 120px; font-weight: 700; color: #8af; line-height: 1; }
#pi-display .label { font-size: 18px; color: #6af; margin-top: 4px; }

#stats {
    position: fixed; bottom: 20px; left: 20px;
    background: rgba(20,20,40,0.85); backdrop-filter: blur(10px);
    border: 1px solid rgba(138,170,255,0.15); border-radius: 12px;
    padding: 14px 18px; z-index: 100; font-size: 13px; min-width: 220px;
}
#stats .row { display: flex; justify-content: space-between; margin: 3px 0; }
#stats .val { color: #8af; font-weight: 600; }

#info {
    position: fixed; bottom: 20px; right: 20px;
    background: rgba(20,20,40,0.85); backdrop-filter: blur(10px);
    border: 1px solid rgba(138,170,255,0.15); border-radius: 12px;
    padding: 14px 18px; z-index: 100; font-size: 12px; max-width: 300px; line-height: 1.5;
}
#info h4 { color: #8af; margin-bottom: 6px; font-size: 14px; }
#info .formula { color: #f8a; font-family: 'Courier New', monospace; margin: 6px 0; font-size: 13px; }

#graph-container {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
    z-index: 80; pointer-events: none;
}
</style>
</head>
<body>
<a href="index.html" class="back">&#8592; Back</a>

<div id="pi-display">
    <div class="big" id="piValue">-</div>
    <div class="label">Estimated &pi;</div>
</div>

<canvas id="canvas"></canvas>
<canvas id="graph" width="400" height="120"></canvas>

<div id="controls">
    <h3>Buffon's Needle</h3>
    <div class="ctrl-row">
        <label>Speed</label>
        <input type="range" id="speed" min="0" max="3" value="1" step="1">
        <span class="val" id="speedLabel">10x</span>
    </div>
    <div class="ctrl-row">
        <label>Needle len</label>
        <input type="range" id="needleLen" min="20" max="100" value="50" step="5">
        <span class="val" id="needleLenVal">50</span>
    </div>
    <div class="btn-row">
        <button onclick="dropBatch(100)">+100</button>
        <button onclick="dropBatch(1000)">+1K</button>
        <button onclick="dropBatch(10000)">+10K</button>
        <button onclick="window.reset()">Reset</button>
    </div>
</div>

<div id="stats">
    <div class="row"><span>Total needles:</span><span class="val" id="totalCount">0</span></div>
    <div class="row"><span>Crossing:</span><span class="val" id="crossCount">0</span></div>
    <div class="row"><span>Not crossing:</span><span class="val" id="noCrossCount">0</span></div>
    <div class="row"><span>&pi; estimate:</span><span class="val" id="piEst">-</span></div>
    <div class="row"><span>Actual &pi;:</span><span class="val">3.14159265...</span></div>
    <div class="row"><span>Error:</span><span class="val" id="errorVal">-</span></div>
</div>

<div id="info">
    <h4>The Paradox</h4>
    <p>Drop a needle of length L onto parallel lines spaced D apart. The probability it crosses a line is:</p>
    <div class="formula">P = 2L / (&pi;D)</div>
    <p>So &pi; = 2L&middot;N / (D&middot;C) where N = total needles, C = crossings. A physical experiment can estimate &pi;!</p>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const graphCanvas = document.getElementById('graph');
const gctx = graphCanvas.getContext('2d');

let W, H, lineSpacing, needleLength;
let needles = [];
let totalDropped = 0, crossings = 0;
let piHistory = [];
let paused = false;
let animId;
const speedMap = [1, 10, 100, 1000];
let speedIdx = 1;
const MAX_VISIBLE = 5000;

function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
    lineSpacing = 80;
    needleLength = parseInt(document.getElementById('needleLen').value);
    graphCanvas.style.position = 'fixed';
    graphCanvas.style.bottom = '150px';
    graphCanvas.style.left = (W / 2 - 200) + 'px';
    graphCanvas.width = 400;
    graphCanvas.height = 120;
}

function dropNeedle() {
    const L = needleLength;
    const D = lineSpacing;
    const cx = Math.random() * W;
    const cy = Math.random() * H;
    const angle = Math.random() * Math.PI;
    const dx = (L / 2) * Math.cos(angle);
    const dy = (L / 2) * Math.sin(angle);
    const x1 = cx - dx, y1 = cy - dy;
    const x2 = cx + dx, y2 = cy + dy;

    const lineY1 = Math.floor(y1 / D) * D;
    const lineY2 = Math.floor(y2 / D) * D;
    const crosses = lineY1 !== lineY2;

    totalDropped++;
    if (crosses) crossings++;

    if (needles.length < MAX_VISIBLE) {
        needles.push({ x1, y1, x2, y2, crosses });
    } else {
        const idx = Math.floor(Math.random() * needles.length);
        needles[idx] = { x1, y1, x2, y2, crosses };
    }

    if (totalDropped % 50 === 0 && crossings > 0) {
        const est = (2 * needleLength * totalDropped) / (lineSpacing * crossings);
        piHistory.push(est);
        if (piHistory.length > 400) piHistory.shift();
    }
}

function dropBatch(n) {
    for (let i = 0; i < n; i++) dropNeedle();
    updateDisplay();
}

function updateDisplay() {
    const piEst = crossings > 0 ? (2 * needleLength * totalDropped) / (lineSpacing * crossings) : 0;
    document.getElementById('totalCount').textContent = totalDropped.toLocaleString();
    document.getElementById('crossCount').textContent = crossings.toLocaleString();
    document.getElementById('noCrossCount').textContent = (totalDropped - crossings).toLocaleString();
    if (crossings > 0) {
        document.getElementById('piEst').textContent = piEst.toFixed(8);
        document.getElementById('piValue').textContent = piEst.toFixed(6);
        const err = Math.abs(piEst - Math.PI) / Math.PI * 100;
        document.getElementById('errorVal').textContent = err.toFixed(4) + '%';
    }
}

function drawLines() {
    ctx.strokeStyle = 'rgba(138,170,255,0.15)';
    ctx.lineWidth = 1;
    for (let y = 0; y < H; y += lineSpacing) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(W, y);
        ctx.stroke();
    }
}

function drawNeedles() {
    for (const n of needles) {
        ctx.beginPath();
        ctx.moveTo(n.x1, n.y1);
        ctx.lineTo(n.x2, n.y2);
        ctx.strokeStyle = n.crosses ? 'rgba(255,80,80,0.7)' : 'rgba(80,180,255,0.4)';
        ctx.lineWidth = 1.5;
        ctx.stroke();
    }
}

function drawGraph() {
    const gw = graphCanvas.width, gh = graphCanvas.height;
    gctx.clearRect(0, 0, gw, gh);
    gctx.fillStyle = 'rgba(20,20,40,0.7)';
    gctx.beginPath();
    gctx.roundRect(0, 0, gw, gh, 10);
    gctx.fill();
    gctx.strokeStyle = 'rgba(138,170,255,0.2)';
    gctx.lineWidth = 1;
    gctx.beginPath();
    gctx.roundRect(0, 0, gw, gh, 10);
    gctx.stroke();

    if (piHistory.length < 2) return;

    const piLine = gh / 2;
    gctx.strokeStyle = 'rgba(255,200,80,0.4)';
    gctx.setLineDash([4, 4]);
    gctx.beginPath();
    gctx.moveTo(0, piLine);
    gctx.lineTo(gw, piLine);
    gctx.stroke();
    gctx.setLineDash([]);

    gctx.fillStyle = 'rgba(255,200,80,0.6)';
    gctx.font = '10px monospace';
    gctx.fillText('\u03C0 = 3.14159...', 6, piLine - 4);

    const minY = 2.5, maxY = 3.8;
    const range = maxY - minY;

    gctx.beginPath();
    gctx.strokeStyle = '#8af';
    gctx.lineWidth = 1.5;
    for (let i = 0; i < piHistory.length; i++) {
        const x = (i / (piHistory.length - 1)) * gw;
        const val = Math.max(minY, Math.min(maxY, piHistory[i]));
        const y = gh - ((val - minY) / range) * gh;
        if (i === 0) gctx.moveTo(x, y);
        else gctx.lineTo(x, y);
    }
    gctx.stroke();

    gctx.fillStyle = '#8af';
    gctx.font = '10px sans-serif';
    gctx.fillText('Convergence to \u03C0', gw - 110, 14);
}

function draw() {
    ctx.clearRect(0, 0, W, H);
    drawLines();
    drawNeedles();
    drawGraph();
    updateDisplay();
}

function animate() {
    if (!paused) {
        const count = speedMap[speedIdx];
        for (let i = 0; i < count; i++) dropNeedle();
    }
    draw();
    animId = requestAnimationFrame(animate);
}

document.getElementById('speed').addEventListener('input', function() {
    speedIdx = parseInt(this.value);
    const labels = ['1x', '10x', '100x', '1000x'];
    document.getElementById('speedLabel').textContent = labels[speedIdx];
});

document.getElementById('needleLen').addEventListener('input', function() {
    needleLength = parseInt(this.value);
    document.getElementById('needleLenVal').textContent = this.value;
});

window.addEventListener('resize', resize);

window.reset = function() {
    needles = [];
    totalDropped = 0;
    crossings = 0;
    piHistory = [];
    document.getElementById('piValue').textContent = '-';
    updateDisplay();
};

window.addEventListener('keydown', function(e) {
    if (e.code === 'Space') { e.preventDefault(); paused = !paused; }
});

resize();
animate();
</script>
<script src="../assets/js/enhance.js"></script>
</body>
</html>
