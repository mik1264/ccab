<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simpson's Paradox</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; color: #e0e0e0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }
canvas { display: block; }
#controls {
    position: fixed; top: 16px; right: 16px; z-index: 10;
    background: rgba(20,20,40,0.85); backdrop-filter: blur(10px);
    border: 1px solid rgba(100,140,255,0.2); border-radius: 12px;
    padding: 16px; min-width: 260px;
}
#controls h3 { color: #7aa2f7; margin-bottom: 10px; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
#controls label { display: block; font-size: 12px; color: #8090b0; margin-top: 8px; }
#controls input[type=range] { width: 100%; margin: 4px 0; accent-color: #7aa2f7; }
#controls .val { font-size: 12px; color: #7aa2f7; text-align: right; }
#controls button {
    width: 100%; padding: 8px; margin-top: 8px; border: 1px solid rgba(100,140,255,0.3);
    background: rgba(40,50,80,0.6); color: #c0d0ff; border-radius: 6px;
    cursor: pointer; font-size: 13px; transition: background 0.2s;
}
#controls button:hover { background: rgba(60,80,140,0.7); }
.view-btn { display: inline-block !important; width: 48% !important; }
.view-btn.active { background: rgba(80,110,200,0.6) !important; border-color: #7aa2f7 !important; }
#info {
    position: fixed; bottom: 16px; left: 16px; z-index: 10;
    background: rgba(20,20,40,0.85); backdrop-filter: blur(10px);
    border: 1px solid rgba(100,140,255,0.2); border-radius: 12px;
    padding: 16px; max-width: 380px; font-size: 13px; line-height: 1.5;
}
#info h3 { color: #7aa2f7; margin-bottom: 8px; }
#info em { color: #bb9af7; }
a.back { position: fixed; top: 16px; left: 16px; color: #7aa2f7; text-decoration: none; font-size: 14px; z-index: 20; }
a.back:hover { text-decoration: underline; }
</style>
</head>
<body>
<a href="index.html" class="back">&larr; Back</a>
<canvas id="c"></canvas>
<div id="controls">
    <h3>Simpson's Paradox</h3>
    <label>Group 1 Size (Easy cases): <span id="vG1" class="val">80</span></label>
    <input type="range" id="sG1" min="20" max="200" value="80">
    <label>Group 2 Size (Hard cases): <span id="vG2" class="val">80</span></label>
    <input type="range" id="sG2" min="20" max="200" value="80">
    <label>Treatment A Boost (Easy): <span id="vAE" class="val">0.85</span></label>
    <input type="range" id="sAE" min="50" max="99" value="85">
    <label>Treatment A Boost (Hard): <span id="vAH" class="val">0.45</span></label>
    <input type="range" id="sAH" min="10" max="70" value="45">
    <label>Treatment B Boost (Easy): <span id="vBE" class="val">0.80</span></label>
    <input type="range" id="sBE" min="50" max="99" value="80">
    <label>Treatment B Boost (Hard): <span id="vBH" class="val">0.40</span></label>
    <input type="range" id="sBH" min="10" max="70" value="40">
    <label>A patients in Easy Group: <span id="vAD" class="val">70%</span></label>
    <input type="range" id="sAD" min="10" max="90" value="70">
    <hr style="border-color: rgba(100,140,255,0.15); margin: 10px 0;">
    <div>
        <button class="view-btn active" id="btnSep" style="margin-right:2%">Separated</button>
        <button class="view-btn" id="btnComb">Combined</button>
    </div>
    <button id="btnAnimate">Animate Merge</button>
    <button id="btnBerkeley">UC Berkeley Data</button>
    <button id="btnReset">Reset to Default</button>
</div>
<div id="info">
    <h3>Simpson's Paradox</h3>
    <p>A trend that appears in several groups of data <em>reverses</em> when the groups are combined.</p>
    <p style="margin-top:6px;">Treatment A beats B in Group 1 AND Group 2. But combined, B appears better! The trick: Treatment A is disproportionately given to the <em>easy</em> group, inflating its combined rate relative to B which tackles the <em>hard</em> group.</p>
    <p style="margin-top:6px;"><em>Real example:</em> UC Berkeley 1973 admissions seemed to favor men overall, but department-by-department, women were admitted at equal or higher rates.</p>
</div>
<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');

let W, H;
function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
    generateData();
}
resize();
window.addEventListener('resize', resize);

let view = 'separated'; // 'separated' or 'combined'
let mergeT = 0; // 0=separated, 1=combined
let mergeTarget = 0;
let animating = false;

// Parameters
let g1Size = 80, g2Size = 80;
let aEasyRate = 0.85, aHardRate = 0.45;
let bEasyRate = 0.80, bHardRate = 0.40;
let aDistEasy = 0.70; // fraction of A patients in easy group

// Data points
let points = [];

function generateData() {
    points = [];
    let aEasyN = Math.round(g1Size * aDistEasy);
    let aHardN = Math.round(g2Size * (1 - aDistEasy));
    let bEasyN = g1Size - aEasyN;
    let bHardN = g2Size - aHardN;

    // Generate scattered points for each sub-group
    // Treatment A, Easy group
    for (let i = 0; i < aEasyN; i++) {
        let success = Math.random() < aEasyRate;
        points.push({
            treatment: 'A', group: 'easy', success,
            baseX: 0, baseY: 0, // will be set below
            sepX: 0, sepY: 0, combX: 0, combY: 0,
            x: 0, y: 0
        });
    }
    // Treatment A, Hard group
    for (let i = 0; i < aHardN; i++) {
        let success = Math.random() < aHardRate;
        points.push({ treatment: 'A', group: 'hard', success, baseX:0,baseY:0,sepX:0,sepY:0,combX:0,combY:0,x:0,y:0 });
    }
    // Treatment B, Easy group
    for (let i = 0; i < bEasyN; i++) {
        let success = Math.random() < bEasyRate;
        points.push({ treatment: 'B', group: 'easy', success, baseX:0,baseY:0,sepX:0,sepY:0,combX:0,combY:0,x:0,y:0 });
    }
    // Treatment B, Hard group
    for (let i = 0; i < bHardN; i++) {
        let success = Math.random() < bHardRate;
        points.push({ treatment: 'B', group: 'hard', success, baseX:0,baseY:0,sepX:0,sepY:0,combX:0,combY:0,x:0,y:0 });
    }

    layoutPoints();
}

function layoutPoints() {
    let chartW = Math.min(W * 0.32, 350);
    let chartH = Math.min(H * 0.3, 250);
    let gap = 50;

    // Separated: two charts side by side
    let leftCX = W * 0.28;
    let rightCX = W * 0.58;
    let topCY = H * 0.28;
    let botCY = H * 0.62;

    // In separated view: Easy group on top, Hard group on bottom
    // Each chart: x=treatment (A left, B right), y=outcome (success top, fail bottom)
    let easyA = points.filter(p => p.group === 'easy' && p.treatment === 'A');
    let easyB = points.filter(p => p.group === 'easy' && p.treatment === 'B');
    let hardA = points.filter(p => p.group === 'hard' && p.treatment === 'A');
    let hardB = points.filter(p => p.group === 'hard' && p.treatment === 'B');

    function layoutGroup(arr, cx, cy, cw, ch) {
        let successPts = arr.filter(p => p.success);
        let failPts = arr.filter(p => !p.success);
        let cols = Math.ceil(Math.sqrt(arr.length));

        successPts.forEach((p, i) => {
            let col = i % cols;
            let row = Math.floor(i / cols);
            p.sepX = cx - cw/2 + (col + 0.5) * (cw / cols);
            p.sepY = cy - ch * 0.05 - row * 7;
        });
        failPts.forEach((p, i) => {
            let col = i % cols;
            let row = Math.floor(i / cols);
            p.sepX = cx - cw/2 + (col + 0.5) * (cw / cols);
            p.sepY = cy + ch * 0.15 + row * 7;
        });
    }

    let subW = chartW * 0.4;
    let subH = chartH * 0.6;
    layoutGroup(easyA, leftCX - subW * 0.6, topCY, subW, subH);
    layoutGroup(easyB, leftCX + subW * 0.6, topCY, subW, subH);
    layoutGroup(hardA, rightCX - subW * 0.6, topCY, subW, subH);
    layoutGroup(hardB, rightCX + subW * 0.6, topCY, subW, subH);

    // Combined view: all in one big chart
    let combCX = W * 0.42;
    let combCY = H * 0.45;
    let allA = points.filter(p => p.treatment === 'A');
    let allB = points.filter(p => p.treatment === 'B');

    function layoutCombined(arr, cx, cy, cw, ch) {
        let successPts = arr.filter(p => p.success);
        let failPts = arr.filter(p => !p.success);
        let cols = Math.ceil(Math.sqrt(arr.length * 1.5));

        successPts.forEach((p, i) => {
            let col = i % cols;
            let row = Math.floor(i / cols);
            p.combX = cx - cw/2 + (col + 0.5) * (cw / Math.max(cols, 1));
            p.combY = cy - ch * 0.1 - row * 6;
        });
        failPts.forEach((p, i) => {
            let col = i % cols;
            let row = Math.floor(i / cols);
            p.combX = cx - cw/2 + (col + 0.5) * (cw / Math.max(cols, 1));
            p.combY = cy + ch * 0.2 + row * 6;
        });
    }

    let combSubW = chartW * 0.45;
    let combSubH = chartH;
    layoutCombined(allA, combCX - combSubW * 0.7, combCY, combSubW, combSubH);
    layoutCombined(allB, combCX + combSubW * 0.7, combCY, combSubW, combSubH);

    // Initialize positions
    points.forEach(p => {
        p.x = p.sepX;
        p.y = p.sepY;
    });
}

function computeRates() {
    let easyA = points.filter(p => p.group === 'easy' && p.treatment === 'A');
    let easyB = points.filter(p => p.group === 'easy' && p.treatment === 'B');
    let hardA = points.filter(p => p.group === 'hard' && p.treatment === 'A');
    let hardB = points.filter(p => p.group === 'hard' && p.treatment === 'B');
    let allA = points.filter(p => p.treatment === 'A');
    let allB = points.filter(p => p.treatment === 'B');

    return {
        easyA: easyA.length > 0 ? easyA.filter(p => p.success).length / easyA.length : 0,
        easyB: easyB.length > 0 ? easyB.filter(p => p.success).length / easyB.length : 0,
        hardA: hardA.length > 0 ? hardA.filter(p => p.success).length / hardA.length : 0,
        hardB: hardB.length > 0 ? hardB.filter(p => p.success).length / hardB.length : 0,
        combA: allA.length > 0 ? allA.filter(p => p.success).length / allA.length : 0,
        combB: allB.length > 0 ? allB.filter(p => p.success).length / allB.length : 0,
        easyAN: easyA.length, easyBN: easyB.length,
        hardAN: hardA.length, hardBN: hardB.length,
        allAN: allA.length, allBN: allB.length
    };
}

function draw() {
    ctx.clearRect(0, 0, W, H);

    // Grid
    ctx.strokeStyle = 'rgba(50,60,100,0.1)';
    ctx.lineWidth = 1;
    for (let x = 0; x < W; x += 40) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke(); }
    for (let y = 0; y < H; y += 40) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke(); }

    // Title
    ctx.fillStyle = '#7aa2f7';
    ctx.font = 'bold 22px "Segoe UI"';
    ctx.textAlign = 'center';
    ctx.fillText("Simpson's Paradox", W * 0.42, 36);

    let rates = computeRates();

    // Interpolate positions
    points.forEach(p => {
        let tx = p.sepX + (p.combX - p.sepX) * mergeT;
        let ty = p.sepY + (p.combY - p.sepY) * mergeT;
        p.x += (tx - p.x) * 0.12;
        p.y += (ty - p.y) * 0.12;
    });

    // Draw points
    points.forEach(p => {
        let r = 3;
        ctx.beginPath();
        ctx.arc(p.x, p.y, r, 0, Math.PI * 2);
        if (p.treatment === 'A') {
            ctx.fillStyle = p.success ? 'rgba(100,180,255,0.8)' : 'rgba(100,180,255,0.3)';
        } else {
            ctx.fillStyle = p.success ? 'rgba(255,150,100,0.8)' : 'rgba(255,150,100,0.3)';
        }
        ctx.fill();

        // Group indicator (in separated view)
        if (mergeT < 0.5) {
            ctx.strokeStyle = p.group === 'easy' ? 'rgba(100,255,100,0.2)' : 'rgba(255,100,100,0.2)';
            ctx.lineWidth = 0.5;
            ctx.stroke();
        }
    });

    // Rate labels
    ctx.font = '13px "Segoe UI"';
    ctx.textAlign = 'center';

    if (mergeT < 0.7) {
        let alpha = 1 - mergeT / 0.7;
        ctx.globalAlpha = alpha;

        // Separated labels
        let leftCX = W * 0.28;
        let rightCX = W * 0.58;

        ctx.fillStyle = '#80c0ff';
        ctx.font = 'bold 14px "Segoe UI"';
        ctx.fillText('Easy Cases', leftCX, H * 0.1);
        ctx.fillText('Hard Cases', rightCX, H * 0.1);

        ctx.font = '12px "Segoe UI"';
        // Easy group rates
        let easyWinner = rates.easyA > rates.easyB ? 'A' : 'B';
        ctx.fillStyle = '#80c0ff';
        ctx.fillText('A: ' + (rates.easyA * 100).toFixed(1) + '% (' + rates.easyAN + ')', leftCX - 60, H * 0.48);
        ctx.fillStyle = '#ffa060';
        ctx.fillText('B: ' + (rates.easyB * 100).toFixed(1) + '% (' + rates.easyBN + ')', leftCX + 60, H * 0.48);

        ctx.fillStyle = easyWinner === 'A' ? '#80c0ff' : '#ffa060';
        ctx.font = 'bold 11px "Segoe UI"';
        ctx.fillText(easyWinner + ' wins in Easy!', leftCX, H * 0.5);

        // Hard group rates
        let hardWinner = rates.hardA > rates.hardB ? 'A' : 'B';
        ctx.fillStyle = '#80c0ff';
        ctx.font = '12px "Segoe UI"';
        ctx.fillText('A: ' + (rates.hardA * 100).toFixed(1) + '% (' + rates.hardAN + ')', rightCX - 60, H * 0.48);
        ctx.fillStyle = '#ffa060';
        ctx.fillText('B: ' + (rates.hardB * 100).toFixed(1) + '% (' + rates.hardBN + ')', rightCX + 60, H * 0.48);

        ctx.fillStyle = hardWinner === 'A' ? '#80c0ff' : '#ffa060';
        ctx.font = 'bold 11px "Segoe UI"';
        ctx.fillText(hardWinner + ' wins in Hard!', rightCX, H * 0.5);

        // Success/failure labels
        ctx.fillStyle = 'rgba(100,255,100,0.4)';
        ctx.font = '10px "Segoe UI"';
        ctx.fillText('Success', leftCX, H * 0.15);
        ctx.fillText('Success', rightCX, H * 0.15);
        ctx.fillStyle = 'rgba(255,100,100,0.4)';
        ctx.fillText('Failure', leftCX, H * 0.42);
        ctx.fillText('Failure', rightCX, H * 0.42);

        ctx.globalAlpha = 1;
    }

    if (mergeT > 0.3) {
        let alpha = (mergeT - 0.3) / 0.7;
        ctx.globalAlpha = alpha;

        // Combined labels
        let combCX = W * 0.42;
        ctx.fillStyle = '#e0e0e0';
        ctx.font = 'bold 14px "Segoe UI"';
        ctx.fillText('Combined (All Cases)', combCX, H * 0.13);

        ctx.font = '13px "Segoe UI"';
        ctx.fillStyle = '#80c0ff';
        ctx.fillText('A overall: ' + (rates.combA * 100).toFixed(1) + '%', combCX - 100, H * 0.75);
        ctx.fillStyle = '#ffa060';
        ctx.fillText('B overall: ' + (rates.combB * 100).toFixed(1) + '%', combCX + 100, H * 0.75);

        let combWinner = rates.combA > rates.combB ? 'A' : 'B';
        let paradox = (rates.easyA > rates.easyB && rates.hardA > rates.hardB && rates.combB > rates.combA) ||
                      (rates.easyB > rates.easyA && rates.hardB > rates.hardA && rates.combA > rates.combB);

        ctx.fillStyle = paradox ? '#f76c6c' : '#7dda58';
        ctx.font = 'bold 14px "Segoe UI"';
        ctx.fillText(paradox ? 'PARADOX! ' + combWinner + ' wins combined despite losing both groups!' : combWinner + ' wins (no paradox with current settings)', combCX, H * 0.79);

        ctx.globalAlpha = 1;
    }

    // Legend
    ctx.globalAlpha = 0.8;
    ctx.fillStyle = '#80c0ff';
    ctx.font = '11px "Segoe UI"';
    ctx.textAlign = 'left';
    ctx.beginPath(); ctx.arc(W * 0.02, H * 0.95, 4, 0, Math.PI * 2); ctx.fill();
    ctx.fillText('Treatment A', W * 0.035, H * 0.953);
    ctx.fillStyle = '#ffa060';
    ctx.beginPath(); ctx.arc(W * 0.12, H * 0.95, 4, 0, Math.PI * 2); ctx.fill();
    ctx.fillText('Treatment B', W * 0.135, H * 0.953);
    ctx.fillStyle = 'rgba(200,200,200,0.5)';
    ctx.fillText('Bright = Success, Dim = Failure', W * 0.23, H * 0.953);
    ctx.globalAlpha = 1;

    // Animate merge
    mergeT += (mergeTarget - mergeT) * 0.04;

    requestAnimationFrame(draw);
}

// Controls
function bindSlider(id, valId, cb, format) {
    let el = document.getElementById(id);
    el.addEventListener('input', () => {
        document.getElementById(valId).textContent = format ? format(el.value) : el.value;
        cb(parseFloat(el.value));
        generateData();
    });
}

bindSlider('sG1', 'vG1', v => g1Size = v);
bindSlider('sG2', 'vG2', v => g2Size = v);
bindSlider('sAE', 'vAE', v => aEasyRate = v / 100, v => (v / 100).toFixed(2));
bindSlider('sAH', 'vAH', v => aHardRate = v / 100, v => (v / 100).toFixed(2));
bindSlider('sBE', 'vBE', v => bEasyRate = v / 100, v => (v / 100).toFixed(2));
bindSlider('sBH', 'vBH', v => bHardRate = v / 100, v => (v / 100).toFixed(2));
bindSlider('sAD', 'vAD', v => aDistEasy = v / 100, v => v + '%');

document.getElementById('btnSep').addEventListener('click', () => {
    mergeTarget = 0; view = 'separated';
    document.getElementById('btnSep').classList.add('active');
    document.getElementById('btnComb').classList.remove('active');
});
document.getElementById('btnComb').addEventListener('click', () => {
    mergeTarget = 1; view = 'combined';
    document.getElementById('btnComb').classList.add('active');
    document.getElementById('btnSep').classList.remove('active');
});
document.getElementById('btnAnimate').addEventListener('click', () => {
    if (animating) return;
    animating = true;
    mergeTarget = 0; mergeT = 0;
    setTimeout(() => { mergeTarget = 1; }, 1500);
    setTimeout(() => { mergeTarget = 0; }, 4500);
    setTimeout(() => { animating = false; }, 6500);
});
document.getElementById('btnBerkeley').addEventListener('click', () => {
    // Set approximate Berkeley admission data params
    g1Size = 150; g2Size = 150;
    aEasyRate = 0.62; aHardRate = 0.33;
    bEasyRate = 0.58; bHardRate = 0.28;
    aDistEasy = 0.30; // Men applied more to hard departments
    document.getElementById('sG1').value = 150;
    document.getElementById('vG1').textContent = '150';
    document.getElementById('sG2').value = 150;
    document.getElementById('vG2').textContent = '150';
    document.getElementById('sAE').value = 62;
    document.getElementById('vAE').textContent = '0.62';
    document.getElementById('sAH').value = 33;
    document.getElementById('vAH').textContent = '0.33';
    document.getElementById('sBE').value = 58;
    document.getElementById('vBE').textContent = '0.58';
    document.getElementById('sBH').value = 28;
    document.getElementById('vBH').textContent = '0.28';
    document.getElementById('sAD').value = 30;
    document.getElementById('vAD').textContent = '30%';
    generateData();
});
document.getElementById('btnReset').addEventListener('click', () => {
    g1Size = 80; g2Size = 80;
    aEasyRate = 0.85; aHardRate = 0.45;
    bEasyRate = 0.80; bHardRate = 0.40;
    aDistEasy = 0.70;
    document.getElementById('sG1').value = 80; document.getElementById('vG1').textContent = '80';
    document.getElementById('sG2').value = 80; document.getElementById('vG2').textContent = '80';
    document.getElementById('sAE').value = 85; document.getElementById('vAE').textContent = '0.85';
    document.getElementById('sAH').value = 45; document.getElementById('vAH').textContent = '0.45';
    document.getElementById('sBE').value = 80; document.getElementById('vBE').textContent = '0.80';
    document.getElementById('sBH').value = 40; document.getElementById('vBH').textContent = '0.40';
    document.getElementById('sAD').value = 70; document.getElementById('vAD').textContent = '70%';
    mergeTarget = 0; mergeT = 0;
    document.getElementById('btnSep').classList.add('active');
    document.getElementById('btnComb').classList.remove('active');
    generateData();
});

generateData();
draw();

window.reset = function() {
    document.getElementById('btnReset').click();
};
</script>
<script src="../assets/js/enhance.js"></script>
</body>
</html>
