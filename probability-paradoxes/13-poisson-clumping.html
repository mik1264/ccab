<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poisson Clumping - Why Bad Things Come in Threes</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0a0e1a; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        canvas { display: block; }
        .back-link {
            position: fixed; top: 18px; left: 18px; z-index: 100;
            color: #8A9A5B; text-decoration: none; font-size: 14px; font-weight: 600;
            background: rgba(10,14,26,0.8); padding: 8px 18px; border-radius: 25px;
            border: 2px solid #8A9A5B; transition: all 0.3s ease;
        }
        .back-link:hover { background: #8A9A5B; color: #0a0e1a; }
        .controls {
            position: fixed; top: 18px; right: 18px; z-index: 100;
            background: rgba(20,20,40,0.85); backdrop-filter: blur(10px);
            border-radius: 10px; padding: 18px; color: #c8d0e0;
            min-width: 280px; max-width: 320px; border: 1px solid rgba(138,154,91,0.3);
        }
        .controls h2 { color: #DDA15E; font-size: 16px; margin-bottom: 4px; }
        .controls p.desc { font-size: 11px; color: #8899aa; margin-bottom: 12px; line-height: 1.4; }
        .control-row { margin-bottom: 10px; }
        .control-row label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 3px; color: #a0b0c0; }
        .control-row label span { color: #DDA15E; font-family: monospace; }
        input[type="range"] {
            width: 100%; height: 4px; -webkit-appearance: none; appearance: none;
            background: #1a2035; border-radius: 2px; outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 14px; height: 14px; border-radius: 50%;
            background: #8A9A5B; cursor: pointer;
        }
        .btn {
            background: rgba(138,154,91,0.2); color: #8A9A5B; border: 1px solid rgba(138,154,91,0.4);
            padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;
            transition: all 0.2s;
        }
        .btn:hover { background: rgba(138,154,91,0.4); }
        .btn-row { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
        .stats-box {
            margin-top: 12px; padding: 10px; background: rgba(10,14,26,0.6);
            border-radius: 6px; font-size: 11px; line-height: 1.7;
        }
        .stats-box .label { color: #8899aa; }
        .stats-box .value { color: #DDA15E; font-family: monospace; font-weight: 600; }
        .stats-box .highlight { color: #e06060; font-weight: 700; }
        .info-panel {
            position: fixed; bottom: 18px; left: 18px; z-index: 100;
            background: rgba(20,20,40,0.85); backdrop-filter: blur(10px);
            border-radius: 10px; padding: 16px; color: #c8d0e0;
            max-width: 400px; border: 1px solid rgba(138,154,91,0.3);
        }
        .info-panel h3 { color: #DDA15E; font-size: 14px; margin-bottom: 6px; }
        .info-panel p { font-size: 11px; color: #8899aa; line-height: 1.5; }
        .info-panel .key { color: #8A9A5B; font-weight: 600; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">&larr; Probability Paradoxes</a>
    <div class="controls">
        <h2>Poisson Clumping</h2>
        <p class="desc">Random events naturally cluster. Compare truly random timelines to "too regular" ones people mistake for random.</p>
        <div class="control-row">
            <label>Event rate (per unit) <span id="rateVal">5</span></label>
            <input type="range" id="rate" min="1" max="20" step="1" value="5">
        </div>
        <div class="control-row">
            <label>Cluster window <span id="windowVal">0.5</span></label>
            <input type="range" id="clusterWindow" min="0.1" max="2.0" step="0.1" value="0.5">
        </div>
        <div class="stats-box">
            <div><span class="label">Random events: </span><span class="value" id="statRandom">0</span></div>
            <div><span class="label">Random clusters: </span><span class="highlight" id="statRandClust">0</span></div>
            <div><span class="label">Largest cluster: </span><span class="highlight" id="statLargest">0</span></div>
            <div><span class="label">Regular events: </span><span class="value" id="statRegular">0</span></div>
            <div><span class="label">Regular clusters: </span><span class="value" id="statRegClust">0</span></div>
        </div>
        <div class="btn-row">
            <button class="btn" onclick="window.reset()">Regenerate</button>
        </div>
    </div>
    <div class="info-panel">
        <h3>Why Bad Things "Come in Threes"</h3>
        <p>Humans expect random events to be <span class="key">evenly spaced</span>. But true randomness produces <span class="key">clusters and gaps</span> far more often than we expect.</p>
        <p style="margin-top:6px;">This is <span class="key">Poisson clumping</span>: in any random process, clusters are the norm, not the exception. Celebrity deaths, bus arrivals, server crashes -- they clump because they're random, not because of some hidden cause.</p>
    </div>
    <canvas id="canvas"></canvas>

    <script>
    (function() {
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let W, H;
        function resize() {
            W = canvas.width = window.innerWidth;
            H = canvas.height = window.innerHeight;
            generate();
        }

        let rate = 5;
        let clusterWindow = 0.5;

        // State
        let randomEvents = [];
        let regularEvents = [];
        let humanEvents = [];
        let randomClusters = [];
        let regularClusters = [];
        let humanClusters = [];
        let timeSpan = 20;
        let animPhase = 0;

        function poissonEvents(lambda, span) {
            const events = [];
            let t = 0;
            while (t < span) {
                t += -Math.log(1 - Math.random()) / lambda;
                if (t < span) events.push(t);
            }
            return events;
        }

        function regularEventsGen(lambda, span) {
            const events = [];
            const interval = 1 / lambda;
            for (let t = interval / 2; t < span; t += interval) {
                events.push(t);
            }
            return events;
        }

        function humanRandomEvents(lambda, span) {
            // What people THINK is random: slightly jittered regular
            const events = [];
            const interval = 1 / lambda;
            for (let t = interval / 2; t < span; t += interval) {
                const jitter = (Math.random() - 0.5) * interval * 0.6;
                events.push(Math.max(0, Math.min(span, t + jitter)));
            }
            events.sort((a, b) => a - b);
            return events;
        }

        function findClusters(events, window) {
            const clusters = [];
            let i = 0;
            while (i < events.length) {
                let j = i;
                while (j + 1 < events.length && events[j + 1] - events[j] < window) {
                    j++;
                }
                if (j > i) {
                    clusters.push({ start: events[i], end: events[j], count: j - i + 1, indices: [] });
                    for (let k = i; k <= j; k++) clusters[clusters.length - 1].indices.push(k);
                }
                i = j + 1;
            }
            return clusters;
        }

        function generate() {
            timeSpan = 20;
            randomEvents = poissonEvents(rate, timeSpan);
            regularEvents = regularEventsGen(rate, timeSpan);
            humanEvents = humanRandomEvents(rate, timeSpan);
            randomClusters = findClusters(randomEvents, clusterWindow);
            regularClusters = findClusters(regularEvents, clusterWindow);
            humanClusters = findClusters(humanEvents, clusterWindow);
            updateStats();
        }

        function updateStats() {
            document.getElementById('statRandom').textContent = randomEvents.length;
            document.getElementById('statRandClust').textContent = randomClusters.length;
            const largest = randomClusters.length > 0 ? Math.max(...randomClusters.map(c => c.count)) : 0;
            document.getElementById('statLargest').textContent = largest;
            document.getElementById('statRegular').textContent = regularEvents.length;
            document.getElementById('statRegClust').textContent = regularClusters.length;
        }

        window.reset = function() {
            generate();
        };

        document.getElementById('rate').addEventListener('input', function() {
            rate = +this.value;
            document.getElementById('rateVal').textContent = rate;
            generate();
        });
        document.getElementById('clusterWindow').addEventListener('input', function() {
            clusterWindow = +this.value;
            document.getElementById('windowVal').textContent = clusterWindow.toFixed(1);
            generate();
        });

        function drawTimeline(events, clusters, y, label, sublabel, color, clusterColor) {
            const left = 0.08 * W;
            const right = 0.65 * W;
            const width = right - left;

            // Label
            ctx.fillStyle = color;
            ctx.font = 'bold 14px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText(label, left, y - 28);
            ctx.fillStyle = '#667788';
            ctx.font = '11px sans-serif';
            ctx.fillText(sublabel, left + ctx.measureText(label).width + 10, y - 28);

            // Axis
            ctx.strokeStyle = '#2a3050';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(left, y);
            ctx.lineTo(right, y);
            ctx.stroke();

            // Cluster highlights
            for (const c of clusters) {
                const x1 = left + (c.start / timeSpan) * width - 4;
                const x2 = left + (c.end / timeSpan) * width + 4;
                ctx.fillStyle = clusterColor;
                ctx.beginPath();
                ctx.roundRect(x1, y - 16, x2 - x1, 32, 6);
                ctx.fill();
                // Cluster size
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 9px monospace';
                ctx.textAlign = 'center';
                ctx.fillText(c.count.toString(), (x1 + x2) / 2, y + 26);
            }

            // Events
            const pulse = Math.sin(animPhase * 2) * 0.3 + 0.7;
            for (let i = 0; i < events.length; i++) {
                const x = left + (events[i] / timeSpan) * width;
                const inCluster = clusters.some(c => c.indices.includes(i));
                ctx.fillStyle = inCluster ? '#fff' : color;
                const r = inCluster ? 5 + pulse * 2 : 4;
                ctx.beginPath();
                ctx.arc(x, y, r, 0, Math.PI * 2);
                ctx.fill();
                if (inCluster) {
                    ctx.strokeStyle = 'rgba(255,255,255,0.3)';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.arc(x, y, r + 3, 0, Math.PI * 2);
                    ctx.stroke();
                }
            }

            // Time marks
            ctx.fillStyle = '#445566';
            ctx.font = '9px monospace';
            ctx.textAlign = 'center';
            for (let t = 0; t <= timeSpan; t += 5) {
                const x = left + (t / timeSpan) * width;
                ctx.fillText(t.toString(), x, y + 38);
                ctx.strokeStyle = '#1a2035';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x, y - 4);
                ctx.lineTo(x, y + 4);
                ctx.stroke();
            }
        }

        function drawClusterComparison() {
            const cx = 0.7 * W;
            const cy = 0.15 * H;
            const cw = 0.25 * W;
            const ch = 0.7 * H;

            ctx.fillStyle = 'rgba(15,18,30,0.7)';
            ctx.beginPath();
            ctx.roundRect(cx - 10, cy - 30, cw + 20, ch + 50, 8);
            ctx.fill();

            ctx.fillStyle = '#DDA15E';
            ctx.font = 'bold 13px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('Cluster Comparison', cx, cy - 10);

            // Bar chart: clusters per timeline
            const data = [
                { label: 'True Random', count: randomClusters.length, color: '#e06060' },
                { label: 'Human "Random"', count: humanClusters.length, color: '#60a0e0' },
                { label: 'Perfectly Regular', count: regularClusters.length, color: '#8A9A5B' }
            ];

            const barH = 35;
            const maxCount = Math.max(1, ...data.map(d => d.count));

            data.forEach((d, i) => {
                const by = cy + 30 + i * (barH + 30);
                ctx.fillStyle = '#8899aa';
                ctx.font = '11px sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText(d.label, cx, by - 4);

                const bw = (d.count / maxCount) * (cw - 20);
                ctx.fillStyle = d.color;
                ctx.beginPath();
                ctx.roundRect(cx, by, Math.max(4, bw), barH, 4);
                ctx.fill();

                ctx.fillStyle = '#fff';
                ctx.font = 'bold 14px monospace';
                ctx.textAlign = 'left';
                ctx.fillText(d.count + ' clusters', cx + Math.max(4, bw) + 8, by + barH / 2 + 5);
            });

            // Cluster size distribution for random
            if (randomClusters.length > 0) {
                const dy = cy + 200;
                ctx.fillStyle = '#DDA15E';
                ctx.font = 'bold 12px sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText('Cluster Sizes (Random)', cx, dy);

                const sizes = {};
                for (const c of randomClusters) {
                    sizes[c.count] = (sizes[c.count] || 0) + 1;
                }
                const keys = Object.keys(sizes).map(Number).sort((a, b) => a - b);
                const maxS = Math.max(1, ...Object.values(sizes));
                const sbw = Math.min(40, (cw - 20) / keys.length);

                keys.forEach((k, i) => {
                    const x = cx + i * (sbw + 6);
                    const h = (sizes[k] / maxS) * 80;
                    ctx.fillStyle = `hsl(${0 + k * 30}, 60%, 55%)`;
                    ctx.fillRect(x, dy + 90 - h, sbw, h);
                    ctx.fillStyle = '#8899aa';
                    ctx.font = '9px monospace';
                    ctx.textAlign = 'center';
                    ctx.fillText(k.toString(), x + sbw / 2, dy + 104);
                    ctx.fillText(sizes[k].toString(), x + sbw / 2, dy + 86 - h);
                });

                ctx.fillStyle = '#667788';
                ctx.font = '9px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('events in cluster', cx + cw / 2, dy + 118);
            }

            // Explanation
            const ey = cy + ch - 80;
            ctx.fillStyle = '#8899aa';
            ctx.font = '11px sans-serif';
            ctx.textAlign = 'left';
            const lines = [
                'True randomness creates more clusters',
                'than people expect. We mistake',
                '"evenly spaced" for "random".',
                '',
                'This is why celebrity deaths seem',
                'to come in threes -- they\'re random!'
            ];
            lines.forEach((line, i) => {
                ctx.fillText(line, cx, ey + i * 16);
            });
        }

        function drawGapDistribution() {
            const gx = 0.08 * W;
            const gy = 0.78 * H;
            const gw = 0.55 * W;
            const gh = 0.16 * H;

            ctx.fillStyle = 'rgba(15,18,30,0.5)';
            ctx.beginPath();
            ctx.roundRect(gx - 10, gy - 25, gw + 20, gh + 40, 8);
            ctx.fill();

            ctx.fillStyle = '#DDA15E';
            ctx.font = 'bold 12px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('Gap Distribution: Random (red) vs Regular (green)', gx, gy - 8);

            if (randomEvents.length < 3) return;

            // Compute gaps
            const randomGaps = [];
            for (let i = 1; i < randomEvents.length; i++) randomGaps.push(randomEvents[i] - randomEvents[i - 1]);
            const regularGaps = [];
            for (let i = 1; i < regularEvents.length; i++) regularGaps.push(regularEvents[i] - regularEvents[i - 1]);

            const bins = 20;
            const maxGap = Math.max(...randomGaps, ...regularGaps) * 1.1;
            const rHist = new Array(bins).fill(0);
            const gHist = new Array(bins).fill(0);

            for (const g of randomGaps) { const b = Math.min(bins - 1, Math.floor(g / maxGap * bins)); rHist[b]++; }
            for (const g of regularGaps) { const b = Math.min(bins - 1, Math.floor(g / maxGap * bins)); gHist[b]++; }

            const maxH = Math.max(1, ...rHist, ...gHist);
            const binW = gw / bins;

            for (let i = 0; i < bins; i++) {
                const x = gx + i * binW;
                // Random (red, semi-transparent)
                const rh = (rHist[i] / maxH) * gh * 0.85;
                ctx.fillStyle = 'rgba(224, 96, 96, 0.5)';
                ctx.fillRect(x + 1, gy + gh - rh, binW / 2 - 1, rh);
                // Regular (green, semi-transparent)
                const gh2 = (gHist[i] / maxH) * gh * 0.85;
                ctx.fillStyle = 'rgba(138, 154, 91, 0.5)';
                ctx.fillRect(x + binW / 2, gy + gh - gh2, binW / 2 - 1, gh2);
            }

            ctx.fillStyle = '#556677';
            ctx.font = '9px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('Random gaps: exponential (many short + some very long)', gx, gy + gh + 14);
        }

        let lastTime = 0;
        function animate(ts) {
            const dt = lastTime ? (ts - lastTime) / 1000 : 0;
            lastTime = ts;
            animPhase += dt;

            ctx.fillStyle = '#0a0e1a';
            ctx.fillRect(0, 0, W, H);

            // Title
            ctx.fillStyle = '#DDA15E';
            ctx.font = 'bold 22px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Poisson Clumping', W * 0.38, 40);
            ctx.fillStyle = '#667788';
            ctx.font = '13px sans-serif';
            ctx.fillText('Why bad things "come in threes"', W * 0.38, 60);

            // Three timelines
            const tl1y = 0.17 * H;
            const tl2y = 0.35 * H;
            const tl3y = 0.53 * H;

            drawTimeline(randomEvents, randomClusters, tl1y, 'True Random (Poisson)', `${randomClusters.length} clusters`, '#e06060', 'rgba(224,96,96,0.2)');
            drawTimeline(humanEvents, humanClusters, tl2y, 'Human "Random"', `${humanClusters.length} clusters`, '#60a0e0', 'rgba(96,160,224,0.2)');
            drawTimeline(regularEvents, regularClusters, tl3y, 'Perfectly Regular', `${regularClusters.length} clusters`, '#8A9A5B', 'rgba(138,154,91,0.2)');

            drawClusterComparison();
            drawGapDistribution();

            requestAnimationFrame(animate);
        }

        resize();
        window.addEventListener('resize', resize);
        requestAnimationFrame(animate);
    })();
    </script>
    <script src="../assets/js/enhance.js"></script>
</body>
</html>
