<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>R-naught (R0) Explorer</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
canvas { display: block; }
#title-overlay { position: fixed; top: 18px; left: 50%; transform: translateX(-50%); color: #fbbf24; font-size: 22px; font-weight: 700; text-shadow: 0 2px 10px rgba(0,0,0,0.7); z-index: 10; pointer-events: none; }
#controls { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); padding: 18px 28px; border-radius: 14px; color: #e0e0e0; z-index: 10; display: flex; gap: 24px; align-items: center; border: 1px solid rgba(251,191,36,0.3); font-size: 13px; }
#controls button { padding: 8px 18px; background: #fbbf24; color: #0a0e1a; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 13px; }
#controls button:hover { background: #f59e0b; }
#controls input[type=range] { width: 250px; accent-color: #fbbf24; }
.val { color: #fbbf24; font-weight: 700; font-size: 18px; }
#r0display { position: fixed; top: 60px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); padding: 16px 30px; border-radius: 14px; color: #e0e0e0; z-index: 10; text-align: center; border: 1px solid rgba(251,191,36,0.3); }
#r0display .big { font-size: 48px; font-weight: 700; color: #fbbf24; line-height: 1; }
#r0display .sub { font-size: 13px; color: #aaa; margin-top: 4px; }
#stats { position: fixed; top: 60px; right: 20px; background: rgba(0,0,0,0.85); padding: 14px 18px; border-radius: 10px; color: #e0e0e0; font-size: 13px; z-index: 10; border: 1px solid rgba(251,191,36,0.2); }
#disease-ref { position: fixed; top: 60px; left: 20px; background: rgba(0,0,0,0.85); padding: 14px 18px; border-radius: 10px; color: #e0e0e0; font-size: 11px; z-index: 10; border: 1px solid rgba(251,191,36,0.2); line-height: 1.6; }
#disease-ref .disease-name { color: #fbbf24; }
</style>
</head>
<body>
<a href="../index.html" style="position:fixed;top:10px;left:10px;padding:8px 16px;background:rgba(0,0,0,0.7);color:#fbbf24;text-decoration:none;border-radius:6px;font-size:14px;z-index:999;font-family:sans-serif;">&#8592; Back to Gallery</a>
<div id="title-overlay">R&#8320; (Basic Reproduction Number) Explorer</div>
<div id="r0display">
    <div class="big" id="r0big">2.0</div>
    <div class="sub">R&#8320; - Average secondary infections</div>
    <div class="sub" id="totalMsg" style="margin-top:8px;color:#ff4a4a;"></div>
</div>
<div id="stats">
    <div>Generation: <span id="genNum" style="color:#fbbf24;">0</span></div>
    <div>Total Infected: <span id="totalInf" style="color:#ff4a4a;">0</span></div>
    <div>Active: <span id="activeInf" style="color:#ff8c00;">0</span></div>
    <div>Herd Immunity Threshold:</div>
    <div style="color:#4aff88;font-weight:700;" id="hitVal">50%</div>
</div>
<div id="disease-ref">
    <div style="font-weight:700;margin-bottom:4px;">Reference R&#8320; values:</div>
    <div><span class="disease-name">Measles:</span> 12-18</div>
    <div><span class="disease-name">Chickenpox:</span> 10-12</div>
    <div><span class="disease-name">COVID-19 (Delta):</span> 5-8</div>
    <div><span class="disease-name">Smallpox:</span> 5-7</div>
    <div><span class="disease-name">COVID-19 (Original):</span> 2-3</div>
    <div><span class="disease-name">Ebola:</span> 1.5-2.5</div>
    <div><span class="disease-name">Seasonal Flu:</span> 1.2-1.4</div>
    <div><span class="disease-name">MERS:</span> 0.3-0.8</div>
</div>
<div id="controls">
    <label style="display:flex;align-items:center;gap:12px;">R&#8320; <input type="range" id="r0slider" min="0.5" max="15" step="0.1" value="2.0"><span class="val" id="r0val">2.0</span></label>
    <label>Generations <input type="range" id="genSlider" min="3" max="10" step="1" value="6" style="width:100px;"><span class="val" id="genVal">6</span></label>
    <button id="resetBtn">Regenerate</button>
</div>
<canvas id="canvas"></canvas>
<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let W, H;

let treeNodes = [], treeEdges = [];
let animProgress = 0;
const ANIM_SPEED = 0.008;

function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
}

function buildTree() {
    const r0 = parseFloat(document.getElementById('r0slider').value);
    const maxGen = parseInt(document.getElementById('genSlider').value);
    treeNodes = [];
    treeEdges = [];
    animProgress = 0;

    const centerX = W / 2;
    const topY = 180;
    const bottomY = H - 120;
    const genHeight = (bottomY - topY) / maxGen;

    // BFS tree generation
    let queue = [{ id: 0, gen: 0, x: centerX, y: topY, parentId: -1 }];
    treeNodes.push({ id: 0, gen: 0, x: centerX, y: topY, children: [], size: 8 });

    let nextId = 1;
    let totalByGen = [1];

    for (let g = 0; g < maxGen; g++) {
        let nextQueue = [];
        let childrenThisGen = [];

        for (let node of queue) {
            // Number of children is Poisson-like around R0
            let numChildren;
            if (r0 < 1) {
                numChildren = Math.random() < r0 ? 1 : 0;
            } else {
                // Poisson approximation
                numChildren = poissonSample(r0);
            }
            numChildren = Math.min(numChildren, 20); // Cap for performance

            const parent = treeNodes[node.id];

            for (let c = 0; c < numChildren; c++) {
                childrenThisGen.push({
                    id: nextId,
                    parentId: node.id,
                    gen: g + 1
                });
                nextId++;
            }
        }

        // Limit total nodes per generation for visual clarity
        const maxPerGen = Math.min(childrenThisGen.length, 300);
        if (childrenThisGen.length > maxPerGen) {
            childrenThisGen = childrenThisGen.slice(0, maxPerGen);
        }

        // Position children
        const genY = topY + (g + 1) * genHeight;
        const totalWidth = W - 100;
        const spacing = totalWidth / Math.max(childrenThisGen.length + 1, 2);

        for (let i = 0; i < childrenThisGen.length; i++) {
            const child = childrenThisGen[i];
            const x = 50 + (i + 1) * spacing;
            const jitter = (Math.random() - 0.5) * spacing * 0.3;
            const nodeData = {
                id: child.id,
                gen: child.gen,
                x: Math.max(30, Math.min(W - 30, x + jitter)),
                y: genY + (Math.random() - 0.5) * genHeight * 0.2,
                children: [],
                size: Math.max(2, 8 - child.gen * 0.8)
            };
            treeNodes.push(nodeData);
            treeNodes[child.parentId].children.push(child.id);
            treeEdges.push({ from: child.parentId, to: child.id, gen: child.gen });
            nextQueue.push({ id: child.id, gen: child.gen });
        }

        totalByGen.push(childrenThisGen.length);
        queue = nextQueue;
        if (queue.length === 0) break;
    }

    updateStats(totalByGen);
}

function poissonSample(lambda) {
    let L = Math.exp(-lambda);
    let k = 0;
    let p = 1;
    do {
        k++;
        p *= Math.random();
    } while (p > L);
    return k - 1;
}

function updateStats(totalByGen) {
    const r0 = parseFloat(document.getElementById('r0slider').value);
    const total = treeNodes.length;
    const active = totalByGen.length > 0 ? totalByGen[totalByGen.length - 1] : 0;
    const hit = r0 > 1 ? ((1 - 1/r0) * 100).toFixed(0) : 0;

    document.getElementById('genNum').textContent = totalByGen.length - 1;
    document.getElementById('totalInf').textContent = total;
    document.getElementById('activeInf').textContent = active;
    document.getElementById('hitVal').textContent = r0 > 1 ? hit + '%' : 'N/A (R0 < 1)';

    const msg = document.getElementById('totalMsg');
    if (r0 < 1) {
        msg.textContent = 'Epidemic dies out naturally';
        msg.style.color = '#4aff88';
    } else if (r0 < 2) {
        msg.textContent = 'Slow spread - containable';
        msg.style.color = '#fbbf24';
    } else if (r0 < 5) {
        msg.textContent = 'Significant epidemic potential';
        msg.style.color = '#ff8c00';
    } else {
        msg.textContent = 'Highly contagious - explosive spread!';
        msg.style.color = '#ff4a4a';
    }
}

function getGenColor(gen) {
    const maxGen = parseInt(document.getElementById('genSlider').value);
    const t = gen / maxGen;
    // Gradient from yellow to red
    const r = 255;
    const g = Math.floor(255 * (1 - t * 0.7));
    const b = Math.floor(74 * t);
    return `rgb(${r},${g},${b})`;
}

function draw() {
    ctx.fillStyle = '#0a0e1a';
    ctx.fillRect(0, 0, W, H);

    animProgress = Math.min(animProgress + ANIM_SPEED, 1);
    const maxVisibleGen = Math.floor(animProgress * (parseInt(document.getElementById('genSlider').value) + 1));

    // Draw edges
    for (let edge of treeEdges) {
        if (edge.gen > maxVisibleGen) continue;
        const from = treeNodes[edge.from];
        const to = treeNodes[edge.to];

        const edgeProgress = edge.gen < maxVisibleGen ? 1 : (animProgress * (parseInt(document.getElementById('genSlider').value) + 1)) % 1;
        const tx = from.x + (to.x - from.x) * edgeProgress;
        const ty = from.y + (to.y - from.y) * edgeProgress;

        ctx.beginPath();
        ctx.moveTo(from.x, from.y);
        // Curved edge
        const midY = (from.y + ty) / 2;
        ctx.quadraticCurveTo(from.x, midY, tx, ty);
        ctx.strokeStyle = getGenColor(edge.gen) + '44';
        ctx.lineWidth = Math.max(0.3, 2 - edge.gen * 0.2);
        ctx.stroke();
    }

    // Draw nodes
    for (let node of treeNodes) {
        if (node.gen > maxVisibleGen) continue;
        const nodeAlpha = node.gen < maxVisibleGen ? 1 : Math.min(1, ((animProgress * (parseInt(document.getElementById('genSlider').value) + 1)) % 1) * 2);

        ctx.beginPath();
        ctx.arc(node.x, node.y, node.size, 0, Math.PI * 2);
        const color = getGenColor(node.gen);
        ctx.fillStyle = color;
        ctx.globalAlpha = nodeAlpha;

        if (node.gen === 0) {
            ctx.shadowBlur = 20;
            ctx.shadowColor = '#fbbf24';
        } else if (node.gen <= 2) {
            ctx.shadowBlur = 8;
            ctx.shadowColor = color;
        } else {
            ctx.shadowBlur = 3;
            ctx.shadowColor = color;
        }
        ctx.fill();
        ctx.shadowBlur = 0;
        ctx.globalAlpha = 1;

        // Patient zero label
        if (node.gen === 0) {
            ctx.fillStyle = '#fbbf24';
            ctx.font = 'bold 11px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Patient Zero', node.x, node.y - 14);
            ctx.textAlign = 'left';
        }
    }

    // Generation labels on the right
    const maxGen = parseInt(document.getElementById('genSlider').value);
    const topY = 180, bottomY = H - 120;
    const genHeight = (bottomY - topY) / maxGen;
    ctx.font = '11px sans-serif';
    ctx.textAlign = 'right';
    for (let g = 0; g <= Math.min(maxGen, maxVisibleGen); g++) {
        const y = topY + g * genHeight;
        ctx.fillStyle = 'rgba(255,255,255,0.3)';
        ctx.setLineDash([2, 6]);
        ctx.beginPath();
        ctx.moveTo(30, y);
        ctx.lineTo(W - 30, y);
        ctx.strokeStyle = 'rgba(255,255,255,0.04)';
        ctx.lineWidth = 0.5;
        ctx.stroke();
        ctx.setLineDash([]);

        ctx.fillStyle = 'rgba(251,191,36,0.5)';
        ctx.fillText('Gen ' + g, W - 10, y + 4);

        // Count nodes at this generation
        const count = treeNodes.filter(n => n.gen === g).length;
        ctx.fillStyle = 'rgba(255,255,255,0.3)';
        ctx.fillText('(' + count + ')', W - 10, y + 16);
    }
    ctx.textAlign = 'left';

    // Exponential growth bar chart on left side
    const barX = 20, barW = 60, barMaxH = 80;
    ctx.fillStyle = 'rgba(0,0,0,0.4)';
    ctx.fillRect(barX - 5, topY - 5, barW + 10, bottomY - topY + 10);
    ctx.fillStyle = 'rgba(255,255,255,0.2)';
    ctx.font = '9px sans-serif';
    ctx.fillText('Per Gen', barX, topY - 8);

    const maxCount = Math.max(...Array.from({ length: maxGen + 1 }, (_, g) =>
        treeNodes.filter(n => n.gen === g).length), 1);

    for (let g = 0; g <= Math.min(maxGen, maxVisibleGen); g++) {
        const count = treeNodes.filter(n => n.gen === g).length;
        const y = topY + g * genHeight;
        const bh = (count / maxCount) * barW;
        ctx.fillStyle = getGenColor(g) + '88';
        ctx.fillRect(barX, y - 4, bh, 8);
        ctx.fillStyle = '#fff';
        ctx.font = '9px sans-serif';
        ctx.fillText(count, barX + bh + 3, y + 3);
    }
}

function animate() {
    draw();
    requestAnimationFrame(animate);
}

document.getElementById('r0slider').oninput = function() {
    const v = parseFloat(this.value);
    document.getElementById('r0val').textContent = v.toFixed(1);
    document.getElementById('r0big').textContent = v.toFixed(1);
    buildTree();
};
document.getElementById('genSlider').oninput = function() {
    document.getElementById('genVal').textContent = this.value;
    buildTree();
};
document.getElementById('resetBtn').onclick = buildTree;
window.addEventListener('resize', () => { resize(); buildTree(); });

resize();
buildTree();
animate();
</script>
</body>
</html>
