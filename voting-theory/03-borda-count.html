<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Borda Count - Points-Based Voting</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; color: #e0e0e0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }
canvas { display: block; }
#controls {
    position: fixed; top: 15px; right: 15px; z-index: 10;
    background: rgba(20,20,40,0.85); backdrop-filter: blur(10px);
    border: 1px solid rgba(100,140,255,0.2); border-radius: 12px;
    padding: 18px; width: 300px; max-height: 90vh; overflow-y: auto;
}
#controls h2 { font-size: 16px; color: #7ba4ff; margin-bottom: 10px; }
#controls h3 { font-size: 13px; color: #9ab4e0; margin: 12px 0 6px; }
.btn {
    display: inline-block; padding: 8px 14px; margin: 3px;
    background: rgba(100,140,255,0.15); border: 1px solid rgba(100,140,255,0.3);
    border-radius: 6px; color: #b0c8ff; cursor: pointer; font-size: 12px;
    transition: all 0.2s;
}
.btn:hover { background: rgba(100,140,255,0.3); color: #fff; }
.btn.danger { background: rgba(255,80,80,0.15); border-color: rgba(255,80,80,0.3); color: #ffaaaa; }
.btn.danger:hover { background: rgba(255,80,80,0.3); color: #fff; }
.comparison {
    display: flex; gap: 8px; margin-top: 8px;
}
.comp-panel {
    flex: 1; padding: 8px; border-radius: 8px;
    background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06);
    font-size: 11px;
}
.comp-panel h4 { font-size: 11px; color: #99bbdd; margin-bottom: 6px; text-align: center; }
.score-row { display: flex; align-items: center; margin: 3px 0; }
.score-row .cname { width: 55px; font-size: 10px; text-align: right; padding-right: 5px; }
.score-row .bar-bg { flex: 1; height: 16px; background: rgba(255,255,255,0.04); border-radius: 3px; overflow: hidden; }
.score-row .bar-fill { height: 100%; border-radius: 3px; transition: width 0.4s; display: flex; align-items: center; padding-left: 4px; font-size: 9px; color: #fff; }
.score-row .pts { width: 35px; text-align: right; font-size: 10px; color: #778; padding-left: 3px; }
.winner-tag { color: #80ffaa; font-weight: bold; font-size: 11px; text-align: center; margin-top: 4px; }
.changed-tag { color: #ff8866; font-weight: bold; font-size: 11px; text-align: center; margin-top: 4px; }
#ballot-display {
    margin-top: 8px; max-height: 150px; overflow-y: auto;
    font-size: 10px; line-height: 1.8;
    background: rgba(0,0,0,0.2); padding: 6px; border-radius: 6px;
}
.ballot-row { display: flex; gap: 3px; align-items: center; }
.ballot-rank { display: inline-block; width: 18px; height: 18px; border-radius: 50%; text-align: center; line-height: 18px; font-size: 9px; font-weight: bold; }
#info {
    position: fixed; bottom: 15px; left: 15px; z-index: 10;
    background: rgba(20,20,40,0.85); backdrop-filter: blur(10px);
    border: 1px solid rgba(100,140,255,0.2); border-radius: 12px;
    padding: 16px; width: 320px; font-size: 12px; line-height: 1.6;
}
#info h3 { color: #7ba4ff; margin-bottom: 8px; font-size: 14px; }
#info p { color: #99aabb; margin-bottom: 6px; }
#info .highlight { color: #ffaa66; font-weight: bold; }
a.back { position: fixed; top: 15px; left: 15px; color: #7ba4ff; text-decoration: none; font-size: 13px; z-index: 20; }
a.back:hover { color: #aaccff; }
.label { font-size: 11px; color: #8899bb; margin-bottom: 6px; }
</style>
</head>
<body>
<a href="index.html" class="back">‚Üê Back</a>
<canvas id="c"></canvas>

<div id="controls">
    <h2>Borda Count</h2>
    <div class="label">Voters rank by proximity. Click canvas to add voters. Drag candidates.</div>
    <div>
        <button class="btn" onclick="addRandomVoters(20)">+20 Voters</button>
        <button class="btn" onclick="addRandomVoters(50)">+50 Voters</button>
    </div>
    <div style="margin-top:6px">
        <button class="btn danger" id="spoilerBtn" onclick="toggleSpoiler()">Add Irrelevant Candidate</button>
        <button class="btn" onclick="window.reset()">Reset</button>
    </div>
    <h3>Side-by-Side Comparison</h3>
    <div class="comparison">
        <div class="comp-panel" id="beforePanel">
            <h4>Without Spoiler</h4>
            <div id="beforeScores"></div>
            <div id="beforeWinner" class="winner-tag"></div>
        </div>
        <div class="comp-panel" id="afterPanel" style="opacity:0.3">
            <h4>With Spoiler</h4>
            <div id="afterScores"></div>
            <div id="afterWinner" class="winner-tag"></div>
        </div>
    </div>
    <h3>Sample Ballots</h3>
    <div id="ballot-display"></div>
</div>

<div id="info">
    <h3>How Borda Count Works</h3>
    <p>Each voter <span class="highlight">ranks all candidates</span>. With N candidates, 1st place gets N-1 points, 2nd gets N-2, ... last gets 0.</p>
    <p>The candidate with the <span class="highlight">most total points</span> wins.</p>
    <p>Critical flaw: violates <span class="highlight">Independence of Irrelevant Alternatives</span>. Adding a losing candidate can change who wins!</p>
    <p>Try the <span class="highlight">"Add Irrelevant Candidate"</span> button -- watch the winner flip.</p>
</div>

<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let W, H;

const COLORS = ['#4488ff', '#ff4466', '#44dd88', '#ffaa22', '#cc66ff', '#ff6644'];
const NAMES = ['Blue', 'Red', 'Green', 'Orange', 'Purple', 'Coral'];

let baseCandidates = []; // original 3
let spoilerCandidate = null;
let spoilerActive = false;
let voters = [];
let dragging = null;
let dragOffset = { x: 0, y: 0 };
let animFrame;

function resize() { W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; }
function dist(a, b) { return Math.sqrt((a.x - b.x) ** 2 + (a.y - b.y) ** 2); }

function initCandidates() {
    const cx = W * 0.38, cy = H / 2;
    baseCandidates = [
        { x: cx - 120, y: cy - 60, color: COLORS[0], name: NAMES[0], r: 20 },
        { x: cx + 120, y: cy + 40, color: COLORS[1], name: NAMES[1], r: 20 },
        { x: cx + 20, y: cy - 130, color: COLORS[2], name: NAMES[2], r: 20 },
    ];
    // Spoiler placed near one candidate but clearly loses
    spoilerCandidate = { x: cx + 200, y: cy + 150, color: COLORS[3], name: NAMES[3] + '*', r: 20 };
}

function getCandidates(includeSpoiler) {
    return includeSpoiler ? [...baseCandidates, spoilerCandidate] : [...baseCandidates];
}

function rankFor(voter, cands) {
    return cands.map((c, i) => ({ idx: i, d: dist(voter, c) }))
                .sort((a, b) => a.d - b.d)
                .map(x => x.idx);
}

function bordaScores(cands) {
    const n = cands.length;
    const scores = new Array(n).fill(0);
    for (const v of voters) {
        const ranking = rankFor(v, cands);
        ranking.forEach((cidx, rank) => {
            scores[cidx] += (n - 1 - rank);
        });
    }
    return scores;
}

function renderScores(cands, scores, container, winnerContainer) {
    const maxS = Math.max(...scores, 1);
    let html = '';
    let winIdx = 0;
    for (let i = 1; i < scores.length; i++) if (scores[i] > scores[winIdx]) winIdx = i;

    for (let i = 0; i < cands.length; i++) {
        const c = cands[i];
        const barW = (scores[i] / maxS * 100);
        html += `<div class="score-row">
            <span class="cname" style="color:${c.color}">${c.name}</span>
            <span class="bar-bg"><span class="bar-fill" style="width:${barW}%;background:${c.color}">${scores[i]}</span></span>
            <span class="pts">${scores[i]}pts</span>
        </div>`;
    }
    container.innerHTML = html;
    winnerContainer.innerHTML = `<span style="color:${cands[winIdx].color}">&#9733; ${cands[winIdx].name}</span>`;
    return winIdx;
}

function updateBallots(cands) {
    const container = document.getElementById('ballot-display');
    const shown = Math.min(voters.length, 15);
    let html = '';
    for (let i = 0; i < shown; i++) {
        const ranking = rankFor(voters[i], cands);
        html += `<div class="ballot-row">V${i + 1}: `;
        ranking.forEach((cidx, r) => {
            html += `<span class="ballot-rank" style="background:${cands[cidx].color}44;color:${cands[cidx].color}">${r + 1}</span>`;
        });
        html += `</div>`;
    }
    if (voters.length > shown) html += `<div style="color:#556">... and ${voters.length - shown} more</div>`;
    container.innerHTML = html;
}

function tally() {
    // Without spoiler
    const candsA = getCandidates(false);
    const scoresA = bordaScores(candsA);
    const winA = renderScores(candsA, scoresA, document.getElementById('beforeScores'), document.getElementById('beforeWinner'));

    // With spoiler
    const afterPanel = document.getElementById('afterPanel');
    if (spoilerActive) {
        afterPanel.style.opacity = '1';
        const candsB = getCandidates(true);
        const scoresB = bordaScores(candsB);
        const winB = renderScores(candsB, scoresB, document.getElementById('afterScores'), document.getElementById('afterWinner'));

        // Check if winner changed (compare original candidates only)
        const origWinnerA = candsA[winA].name;
        const origWinnerB = candsB[winB].name.replace('*', '');
        if (origWinnerA !== origWinnerB) {
            document.getElementById('afterWinner').classList.add('changed-tag');
            document.getElementById('afterWinner').innerHTML += '<br><span style="color:#ff8866">Winner changed!</span>';
        }
        updateBallots(candsB);
    } else {
        afterPanel.style.opacity = '0.3';
        document.getElementById('afterScores').innerHTML = '<div style="color:#556;text-align:center">Click "Add Irrelevant Candidate"</div>';
        document.getElementById('afterWinner').innerHTML = '';
        updateBallots(candsA);
    }
}

function addRandomVoters(n) {
    const margin = 80;
    const allC = getCandidates(false);
    for (let i = 0; i < n; i++) {
        if (allC.length > 0 && Math.random() < 0.7) {
            const c = allC[Math.floor(Math.random() * allC.length)];
            voters.push({ x: c.x + (Math.random() - 0.5) * 260, y: c.y + (Math.random() - 0.5) * 260 });
        } else {
            voters.push({ x: margin + Math.random() * (W * 0.6 - margin), y: margin + Math.random() * (H - 2 * margin) });
        }
    }
    tally();
}

function toggleSpoiler() {
    spoilerActive = !spoilerActive;
    const btn = document.getElementById('spoilerBtn');
    btn.textContent = spoilerActive ? 'Remove Spoiler' : 'Add Irrelevant Candidate';
    btn.className = spoilerActive ? 'btn' : 'btn danger';
    tally();
}

function draw() {
    ctx.clearRect(0, 0, W, H);

    ctx.strokeStyle = 'rgba(100,140,255,0.04)';
    for (let x = 0; x < W; x += 50) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke(); }
    for (let y = 0; y < H; y += 50) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke(); }

    const cands = getCandidates(spoilerActive);

    // Voters
    for (const v of voters) {
        const ranking = rankFor(v, cands);
        const col = cands[ranking[0]].color;
        ctx.beginPath(); ctx.arc(v.x, v.y, 4, 0, Math.PI * 2);
        ctx.fillStyle = col + '88'; ctx.fill();
    }

    // Candidates
    for (const c of cands) {
        const grad = ctx.createRadialGradient(c.x, c.y, 0, c.x, c.y, 45);
        grad.addColorStop(0, c.color + '44');
        grad.addColorStop(1, c.color + '00');
        ctx.beginPath(); ctx.arc(c.x, c.y, 45, 0, Math.PI * 2);
        ctx.fillStyle = grad; ctx.fill();

        ctx.beginPath(); ctx.arc(c.x, c.y, c.r, 0, Math.PI * 2);
        ctx.fillStyle = c.color; ctx.fill();
        ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.stroke();

        ctx.fillStyle = '#fff'; ctx.font = 'bold 11px sans-serif'; ctx.textAlign = 'center';
        ctx.fillText(c.name, c.x, c.y - c.r - 8);

        // Show Borda score
        const scores = bordaScores(cands);
        const idx = cands.indexOf(c);
        ctx.fillStyle = '#aabbcc'; ctx.font = '11px sans-serif';
        ctx.fillText(scores[idx] + ' pts', c.x, c.y + c.r + 16);
    }

    animFrame = requestAnimationFrame(draw);
}

canvas.addEventListener('mousedown', (e) => {
    const mx = e.clientX, my = e.clientY;
    const cands = getCandidates(spoilerActive);
    for (const c of cands) {
        if (dist({ x: mx, y: my }, c) < c.r + 5) {
            dragging = c; dragOffset.x = mx - c.x; dragOffset.y = my - c.y; return;
        }
    }
    voters.push({ x: mx, y: my });
    tally();
});
canvas.addEventListener('mousemove', (e) => {
    if (dragging) { dragging.x = e.clientX - dragOffset.x; dragging.y = e.clientY - dragOffset.y; tally(); }
});
canvas.addEventListener('mouseup', () => { dragging = null; });

canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    const t = e.touches[0]; const mx = t.clientX, my = t.clientY;
    const cands = getCandidates(spoilerActive);
    for (const c of cands) {
        if (dist({ x: mx, y: my }, c) < c.r + 15) {
            dragging = c; dragOffset.x = mx - c.x; dragOffset.y = my - c.y; return;
        }
    }
    voters.push({ x: mx, y: my }); tally();
}, { passive: false });
canvas.addEventListener('touchmove', (e) => {
    e.preventDefault();
    if (dragging) { const t = e.touches[0]; dragging.x = t.clientX - dragOffset.x; dragging.y = t.clientY - dragOffset.y; tally(); }
}, { passive: false });
canvas.addEventListener('touchend', () => { dragging = null; });

window.addEventListener('resize', resize);

window.reset = function() {
    cancelAnimationFrame(animFrame);
    voters = []; spoilerActive = false;
    document.getElementById('spoilerBtn').textContent = 'Add Irrelevant Candidate';
    document.getElementById('spoilerBtn').className = 'btn danger';
    resize(); initCandidates(); tally(); draw();
};

resize(); initCandidates(); addRandomVoters(80); draw();
</script>
<script src="../assets/js/enhance.js"></script>
</body>
</html>
