<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Proportional Representation - Voting Theory</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; color: #e0e0e0; font-family: 'Segoe UI', system-ui, sans-serif; overflow: hidden; }
canvas { display: block; }
a.back-link {
    position: fixed; top: 16px; left: 16px; color: #8ab4f8; text-decoration: none;
    font-size: 14px; z-index: 100; opacity: 0.8; transition: opacity 0.2s;
}
a.back-link:hover { opacity: 1; }

.controls {
    position: fixed; top: 16px; right: 16px; z-index: 100;
    background: rgba(20,20,40,0.85); backdrop-filter: blur(10px);
    border-radius: 12px; padding: 16px; min-width: 250px;
    border: 1px solid rgba(255,255,255,0.08);
}
.controls h3 { font-size: 14px; color: #8ab4f8; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
.controls label { display: block; font-size: 12px; color: #aaa; margin-top: 8px; }
.controls input[type=range] { width: 100%; margin: 4px 0; accent-color: #8ab4f8; }
.controls .value { font-size: 11px; color: #666; text-align: right; }
.btn {
    display: inline-block; margin: 4px 2px; padding: 6px 14px; border: none; border-radius: 6px;
    background: #1a3a5c; color: #8ab4f8; font-size: 12px; cursor: pointer; transition: background 0.2s;
}
.btn:hover { background: #244a6c; }
.btn-row { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 4px; }

.party-control { display: flex; align-items: center; gap: 8px; margin: 6px 0; }
.party-swatch { width: 14px; height: 14px; border-radius: 3px; flex-shrink: 0; }
.party-control input[type=range] { flex: 1; }
.party-control .pct { width: 35px; text-align: right; font-size: 11px; font-family: 'Courier New', monospace; color: #ccc; }

.info-panel {
    position: fixed; bottom: 16px; right: 16px; z-index: 100;
    background: rgba(20,20,40,0.85); backdrop-filter: blur(10px);
    border-radius: 12px; padding: 14px 18px; max-width: 320px;
    border: 1px solid rgba(255,255,255,0.08); font-size: 12px; line-height: 1.6;
}
.info-panel h4 { color: #8ab4f8; margin-bottom: 6px; }
.info-panel p { color: #aaa; }
</style>
</head>
<body>
<a href="index.html" class="back-link">&#8592; Back to Gallery</a>
<canvas id="canvas"></canvas>

<div class="controls">
    <h3>Proportional Rep.</h3>
    <label>Total Seats: <span id="seatsVal">20</span></label>
    <input type="range" id="totalSeats" min="5" max="40" value="20">
    <label>Threshold: <span id="threshVal">0</span>%</label>
    <input type="range" id="threshold" min="0" max="10" value="0">
    <div style="height:1px;background:#333;margin:8px 0"></div>
    <label>Party Vote Shares</label>
    <div id="partyControls"></div>
    <div class="btn-row">
        <button class="btn" id="resetBtn">Reset</button>
    </div>
</div>

<div class="info-panel">
    <h4>Proportional Representation</h4>
    <p>Compare three PR methods: D'Hondt (favors large parties), Sainte-Lague (more proportional), and Largest Remainder (Hamilton). Adjust votes and threshold to see how seats shift. The parliament semicircle shows each method's allocation.</p>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let W, H;
function resize() { W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; }
resize();
window.addEventListener('resize', resize);

const parties = [
    { name: 'Red Party', color: '#e63946', votes: 35 },
    { name: 'Blue Party', color: '#457b9d', votes: 28 },
    { name: 'Green Party', color: '#2a9d8f', votes: 18 },
    { name: 'Yellow Party', color: '#e9c46a', votes: 10 },
    { name: 'Purple Party', color: '#9b5de5', votes: 6 },
    { name: 'Orange Party', color: '#f4845f', votes: 3 }
];

function buildControls() {
    const container = document.getElementById('partyControls');
    container.innerHTML = '';
    parties.forEach((p, i) => {
        const div = document.createElement('div');
        div.className = 'party-control';
        div.innerHTML = `<div class="party-swatch" style="background:${p.color}"></div>
            <input type="range" min="0" max="50" value="${p.votes}" data-party="${i}">
            <span class="pct" id="pct${i}">${p.votes}%</span>`;
        div.querySelector('input').addEventListener('input', function() {
            parties[i].votes = parseInt(this.value);
            document.getElementById('pct' + i).textContent = this.value + '%';
        });
        container.appendChild(div);
    });
}
buildControls();

document.getElementById('totalSeats').addEventListener('input', function() {
    document.getElementById('seatsVal').textContent = this.value;
});
document.getElementById('threshold').addEventListener('input', function() {
    document.getElementById('threshVal').textContent = this.value;
});
document.getElementById('resetBtn').addEventListener('click', () => window.reset());

// Allocation methods
function getEligible(threshold) {
    const total = parties.reduce((s, p) => s + p.votes, 0);
    return parties.map((p, i) => ({
        index: i,
        votes: p.votes,
        pct: total > 0 ? p.votes / total * 100 : 0,
        eligible: total > 0 ? (p.votes / total * 100) >= threshold : false
    }));
}

function dhondt(seats, threshold) {
    const eligible = getEligible(threshold);
    const allocation = new Array(parties.length).fill(0);
    const totalEligible = eligible.filter(e => e.eligible).reduce((s, e) => s + e.votes, 0);
    if (totalEligible === 0) return allocation;

    for (let s = 0; s < seats; s++) {
        let bestIdx = -1, bestQ = -1;
        for (const e of eligible) {
            if (!e.eligible) continue;
            const q = e.votes / (allocation[e.index] + 1);
            if (q > bestQ) { bestQ = q; bestIdx = e.index; }
        }
        if (bestIdx >= 0) allocation[bestIdx]++;
    }
    return allocation;
}

function sainteLague(seats, threshold) {
    const eligible = getEligible(threshold);
    const allocation = new Array(parties.length).fill(0);
    const totalEligible = eligible.filter(e => e.eligible).reduce((s, e) => s + e.votes, 0);
    if (totalEligible === 0) return allocation;

    for (let s = 0; s < seats; s++) {
        let bestIdx = -1, bestQ = -1;
        for (const e of eligible) {
            if (!e.eligible) continue;
            const q = e.votes / (2 * allocation[e.index] + 1);
            if (q > bestQ) { bestQ = q; bestIdx = e.index; }
        }
        if (bestIdx >= 0) allocation[bestIdx]++;
    }
    return allocation;
}

function largestRemainder(seats, threshold) {
    const eligible = getEligible(threshold);
    const allocation = new Array(parties.length).fill(0);
    const totalEligible = eligible.filter(e => e.eligible).reduce((s, e) => s + e.votes, 0);
    if (totalEligible === 0) return allocation;

    const quota = totalEligible / seats;
    const remainders = [];

    for (const e of eligible) {
        if (!e.eligible) continue;
        const exact = e.votes / quota;
        const floor = Math.floor(exact);
        allocation[e.index] = floor;
        remainders.push({ index: e.index, remainder: exact - floor });
    }

    let assigned = allocation.reduce((s, v) => s + v, 0);
    remainders.sort((a, b) => b.remainder - a.remainder);
    for (const r of remainders) {
        if (assigned >= seats) break;
        allocation[r.index]++;
        assigned++;
    }
    return allocation;
}

function drawSemicircle(cx, cy, radius, allocation, label, y_label) {
    const totalSeats = allocation.reduce((s, v) => s + v, 0);
    if (totalSeats === 0) {
        ctx.fillStyle = '#444';
        ctx.font = '12px Segoe UI, system-ui';
        ctx.textAlign = 'center';
        ctx.fillText('No seats', cx, cy);
        return;
    }

    // Build seat positions in a semicircle (rows)
    const seats = [];
    for (let i = 0; i < parties.length; i++) {
        for (let j = 0; j < allocation[i]; j++) {
            seats.push(i);
        }
    }

    // Layout seats in semicircle rows
    const rows = totalSeats <= 10 ? 2 : totalSeats <= 20 ? 3 : 4;
    const seatRadius = Math.min(radius / (rows * 3), 10);
    let seatIdx = 0;

    for (let row = 0; row < rows && seatIdx < totalSeats; row++) {
        const rowRadius = radius * (0.45 + 0.55 * (row / (rows - 1 || 1)));
        const seatsInRow = Math.ceil((totalSeats - seatIdx) / (rows - row));
        for (let s = 0; s < seatsInRow && seatIdx < totalSeats; s++) {
            const angle = Math.PI + (Math.PI * (s + 0.5) / seatsInRow);
            const sx = cx + Math.cos(angle) * rowRadius;
            const sy = cy + Math.sin(angle) * rowRadius;
            ctx.beginPath();
            ctx.arc(sx, sy, seatRadius, 0, Math.PI * 2);
            ctx.fillStyle = parties[seats[seatIdx]].color;
            ctx.fill();
            seatIdx++;
        }
    }

    // Label
    ctx.fillStyle = '#8ab4f8';
    ctx.font = 'bold 13px Segoe UI, system-ui';
    ctx.textAlign = 'center';
    ctx.fillText(label, cx, y_label);

    // Seat counts
    ctx.font = '10px Courier New, monospace';
    let textY = cy + radius * 0.15;
    for (let i = 0; i < parties.length; i++) {
        if (allocation[i] > 0) {
            ctx.fillStyle = parties[i].color;
            ctx.fillText(`${parties[i].name.split(' ')[0]}: ${allocation[i]}`, cx, textY);
            textY += 14;
        }
    }
}

function drawBarChart(x, y, w, h, allocation, label) {
    const totalSeats = parseInt(document.getElementById('totalSeats').value);
    const totalVotes = parties.reduce((s, p) => s + p.votes, 0);

    ctx.fillStyle = '#8ab4f8';
    ctx.font = 'bold 12px Segoe UI, system-ui';
    ctx.textAlign = 'center';
    ctx.fillText(label, x + w / 2, y - 8);

    const barH = (h - 10) / parties.length;
    for (let i = 0; i < parties.length; i++) {
        const by = y + i * barH;
        const pct = totalSeats > 0 ? allocation[i] / totalSeats : 0;
        const votePct = totalVotes > 0 ? parties[i].votes / totalVotes : 0;

        // Vote share reference line
        ctx.strokeStyle = '#444';
        ctx.lineWidth = 1;
        ctx.setLineDash([3, 3]);
        const refX = x + votePct * w;
        ctx.beginPath();
        ctx.moveTo(refX, by + 2);
        ctx.lineTo(refX, by + barH - 4);
        ctx.stroke();
        ctx.setLineDash([]);

        // Seat share bar
        ctx.fillStyle = parties[i].color + 'cc';
        ctx.fillRect(x, by + 4, pct * w, barH - 8);

        // Label
        ctx.fillStyle = '#ccc';
        ctx.font = '10px Segoe UI, system-ui';
        ctx.textAlign = 'left';
        ctx.fillText(`${allocation[i]}`, x + pct * w + 4, by + barH / 2 + 3);
    }
}

function animate() {
    ctx.clearRect(0, 0, W, H);

    const seats = parseInt(document.getElementById('totalSeats').value);
    const threshold = parseInt(document.getElementById('threshold').value);

    const dh = dhondt(seats, threshold);
    const sl = sainteLague(seats, threshold);
    const lr = largestRemainder(seats, threshold);

    // Title
    ctx.fillStyle = '#8ab4f8';
    ctx.font = 'bold 20px Segoe UI, system-ui';
    ctx.textAlign = 'center';
    ctx.fillText('Proportional Representation Methods', W / 2, 30);
    ctx.fillStyle = '#666';
    ctx.font = '13px Segoe UI, system-ui';
    ctx.fillText(`${seats} seats | ${threshold}% threshold | Dashed line = actual vote share`, W / 2, 52);

    // Three semicircles side by side
    const semiW = Math.min((W - 80) / 3, 350);
    const semiR = Math.min(semiW * 0.4, H * 0.22);
    const semiY = H * 0.35;
    const startX = (W - semiW * 3) / 2 + semiW / 2;

    drawSemicircle(startX, semiY, semiR, dh, "D'Hondt (Jefferson)", semiY - semiR - 20);
    drawSemicircle(startX + semiW, semiY, semiR, sl, 'Sainte-Lague (Webster)', semiY - semiR - 20);
    drawSemicircle(startX + semiW * 2, semiY, semiR, lr, 'Largest Remainder', semiY - semiR - 20);

    // Bar charts below
    const barY = H * 0.55;
    const barH = H * 0.32;
    const barW = semiW * 0.7;

    drawBarChart(startX - barW / 2, barY, barW, barH, dh, "D'Hondt");
    drawBarChart(startX + semiW - barW / 2, barY, barW, barH, sl, 'Sainte-Lague');
    drawBarChart(startX + semiW * 2 - barW / 2, barY, barW, barH, lr, 'Largest Rem.');

    // Legend at bottom
    const legendY = H - 30;
    const legendStartX = W / 2 - parties.length * 70;
    ctx.font = '11px Segoe UI, system-ui';
    ctx.textAlign = 'left';
    const totalVotes = parties.reduce((s, p) => s + p.votes, 0);
    parties.forEach((p, i) => {
        const lx = legendStartX + i * 140;
        ctx.fillStyle = p.color;
        ctx.fillRect(lx, legendY - 8, 10, 10);
        ctx.fillText(`${p.name} (${totalVotes > 0 ? (p.votes / totalVotes * 100).toFixed(1) : 0}%)`, lx + 14, legendY);
    });

    requestAnimationFrame(animate);
}

window.reset = function() {
    parties[0].votes = 35; parties[1].votes = 28; parties[2].votes = 18;
    parties[3].votes = 10; parties[4].votes = 6; parties[5].votes = 3;
    document.getElementById('totalSeats').value = 20;
    document.getElementById('seatsVal').textContent = '20';
    document.getElementById('threshold').value = 0;
    document.getElementById('threshVal').textContent = '0';
    buildControls();
};

animate();
</script>
<script src="../assets/js/enhance.js"></script>
</body>
</html>
