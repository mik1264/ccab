<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Power Indices - Shapley-Shubik & Banzhaf</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; color: #e0e0e0; font-family: 'Segoe UI', system-ui, sans-serif; overflow: hidden; }
canvas { display: block; }
#controls {
    position: fixed; top: 10px; right: 10px; width: 320px;
    background: rgba(20,20,40,0.85); backdrop-filter: blur(10px);
    border-radius: 12px; padding: 16px; z-index: 10;
    border: 1px solid rgba(100,140,200,0.3);
    max-height: 90vh; overflow-y: auto;
}
#info {
    position: fixed; bottom: 10px; left: 10px; max-width: 380px;
    background: rgba(20,20,40,0.85); backdrop-filter: blur(10px);
    border-radius: 12px; padding: 16px; z-index: 10;
    border: 1px solid rgba(100,140,200,0.3); font-size: 13px; line-height: 1.5;
}
h3 { color: #7eb8f0; margin-bottom: 8px; font-size: 15px; }
label { display: block; margin: 6px 0 3px; font-size: 12px; color: #a0b4d0; }
input[type="range"], input[type="number"] {
    width: 100%; background: rgba(50,60,90,0.5); border: 1px solid rgba(100,140,200,0.3);
    border-radius: 4px; color: #e0e0e0; padding: 4px 8px; font-size: 13px;
}
input[type="number"] { width: 70px; }
button {
    background: rgba(60,80,140,0.6); color: #c0d4f0; border: 1px solid rgba(100,140,200,0.4);
    border-radius: 6px; padding: 6px 14px; cursor: pointer; font-size: 12px; margin: 3px 2px;
    transition: background 0.2s;
}
button:hover { background: rgba(80,110,180,0.7); }
.player-row { display: flex; align-items: center; gap: 6px; margin: 4px 0; }
.player-row span { font-size: 13px; min-width: 70px; }
.player-row input { width: 60px; }
.remove-btn { background: rgba(180,60,60,0.5); padding: 3px 8px; font-size: 11px; }
.remove-btn:hover { background: rgba(200,80,80,0.6); }
a { color: #7eb8f0; text-decoration: none; }
a:hover { text-decoration: underline; }
.preset-btn { font-size: 11px; padding: 4px 8px; }
#backLink { position: fixed; top: 10px; left: 10px; z-index: 20; font-size: 13px; }
</style>
</head>
<body>
<a id="backLink" href="index.html">&#8592; Back</a>
<canvas id="canvas"></canvas>

<div id="controls">
    <h3>Power Indices</h3>
    <label>Quota (votes needed to pass):</label>
    <div style="display:flex;align-items:center;gap:8px;">
        <input type="number" id="quotaInput" value="52" min="1" style="width:70px;">
        <span id="quotaInfo" style="font-size:11px;color:#a0b4d0;"></span>
    </div>
    <div id="playerList"></div>
    <div style="margin-top:8px;">
        <button id="addPlayer">+ Add Player</button>
    </div>
    <label style="margin-top:10px;">Presets:</label>
    <div>
        <button class="preset-btn" onclick="loadPreset('unequal')">51-49-1</button>
        <button class="preset-btn" onclick="loadPreset('eu')">EU-like</button>
        <button class="preset-btn" onclick="loadPreset('un')">UN Security</button>
        <button class="preset-btn" onclick="loadPreset('equal')">Equal 5</button>
    </div>
</div>

<div id="info">
    <h3>How Power Indices Work</h3>
    <p>Vote weight does NOT equal power! A player with 49% of votes can have <strong>0% power</strong> if another player always has enough alone.</p>
    <p style="margin-top:6px;"><strong>Shapley-Shubik:</strong> How often is a player the pivotal vote in every possible ordering?</p>
    <p style="margin-top:4px;"><strong>Banzhaf:</strong> How often does a player's vote change the outcome (swing voter)?</p>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let W, H;

const colors = ['#4e9af0','#f0c040','#50d890','#f06070','#b070f0','#f09040','#40d0d0','#d070a0','#80b040','#c0c0c0'];

let players = [
    { name: 'A', weight: 51 },
    { name: 'B', weight: 49 },
    { name: 'C', weight: 1 }
];
let quota = 52;

let shapley = [];
let banzhaf = [];
let animProgress = 0;
let targetProgress = 1;

function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

function factorial(n) {
    let r = 1;
    for (let i = 2; i <= n; i++) r *= i;
    return r;
}

function computeShapley() {
    const n = players.length;
    const result = new Array(n).fill(0);
    const perm = Array.from({length: n}, (_, i) => i);
    const totalPerms = factorial(n);

    function permute(arr, l) {
        if (l === arr.length - 1) {
            let sum = 0;
            for (let i = 0; i < arr.length; i++) {
                sum += players[arr[i]].weight;
                if (sum >= quota) {
                    result[arr[i]]++;
                    break;
                }
            }
            return;
        }
        for (let i = l; i < arr.length; i++) {
            [arr[l], arr[i]] = [arr[i], arr[l]];
            permute(arr, l + 1);
            [arr[l], arr[i]] = [arr[i], arr[l]];
        }
    }

    if (n <= 10) {
        permute(perm, 0);
        shapley = result.map(r => r / totalPerms);
    } else {
        shapley = result.map(() => 1 / n);
    }
}

function computeBanzhaf() {
    const n = players.length;
    const result = new Array(n).fill(0);
    const totalCoalitions = 1 << n;

    for (let mask = 0; mask < totalCoalitions; mask++) {
        let sum = 0;
        for (let i = 0; i < n; i++) {
            if (mask & (1 << i)) sum += players[i].weight;
        }
        for (let i = 0; i < n; i++) {
            if (mask & (1 << i)) {
                if (sum >= quota && sum - players[i].weight < quota) {
                    result[i]++;
                }
            }
        }
    }

    const total = result.reduce((a, b) => a + b, 0);
    banzhaf = total > 0 ? result.map(r => r / total) : result.map(() => 0);
}

function recalculate() {
    quota = parseInt(document.getElementById('quotaInput').value) || 1;
    const totalWeight = players.reduce((s, p) => s + p.weight, 0);
    document.getElementById('quotaInfo').textContent = `of ${totalWeight} total`;

    if (players.length <= 20) {
        computeShapley();
        computeBanzhaf();
    } else {
        shapley = players.map(() => 0);
        banzhaf = players.map(() => 0);
    }

    animProgress = 0;
    targetProgress = 1;
}

function renderPlayerList() {
    const list = document.getElementById('playerList');
    list.innerHTML = '';
    players.forEach((p, i) => {
        const row = document.createElement('div');
        row.className = 'player-row';
        row.innerHTML = `
            <span style="color:${colors[i % colors.length]}">Player ${p.name}</span>
            <input type="number" value="${p.weight}" min="0" max="9999"
                onchange="updateWeight(${i}, this.value)">
            <button class="remove-btn" onclick="removePlayer(${i})">x</button>
        `;
        list.appendChild(row);
    });
}

function updateWeight(i, val) {
    players[i].weight = parseInt(val) || 0;
    recalculate();
}

function removePlayer(i) {
    if (players.length <= 2) return;
    players.splice(i, 1);
    players.forEach((p, idx) => p.name = String.fromCharCode(65 + idx));
    renderPlayerList();
    recalculate();
}

document.getElementById('addPlayer').addEventListener('click', () => {
    if (players.length >= 10) return;
    players.push({ name: String.fromCharCode(65 + players.length), weight: 10 });
    renderPlayerList();
    recalculate();
});

window.loadPreset = function(name) {
    if (name === 'unequal') {
        players = [{name:'A',weight:51},{name:'B',weight:49},{name:'C',weight:1}];
        quota = 52;
    } else if (name === 'eu') {
        players = [{name:'DE',weight:29},{name:'FR',weight:29},{name:'IT',weight:29},{name:'ES',weight:27},{name:'PL',weight:27},{name:'NL',weight:13},{name:'BE',weight:12}];
        quota = 84;
    } else if (name === 'un') {
        players = [{name:'US',weight:7},{name:'UK',weight:7},{name:'FR',weight:7},{name:'RU',weight:7},{name:'CN',weight:7},{name:'A',weight:1},{name:'B',weight:1},{name:'C',weight:1},{name:'D',weight:1},{name:'E',weight:1}];
        quota = 39;
    } else if (name === 'equal') {
        players = [{name:'A',weight:1},{name:'B',weight:1},{name:'C',weight:1},{name:'D',weight:1},{name:'E',weight:1}];
        quota = 3;
    }
    document.getElementById('quotaInput').value = quota;
    renderPlayerList();
    recalculate();
};

function draw() {
    ctx.clearRect(0, 0, W, H);

    // Background grid
    ctx.strokeStyle = 'rgba(60,80,120,0.15)';
    ctx.lineWidth = 1;
    for (let x = 0; x < W; x += 40) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke(); }
    for (let y = 0; y < H; y += 40) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke(); }

    animProgress += (targetProgress - animProgress) * 0.06;

    const n = players.length;
    if (n === 0) return;

    const chartLeft = 60;
    const chartRight = Math.min(W - 360, W * 0.6);
    const chartTop = 80;
    const chartBottom = H - 100;
    const chartW = chartRight - chartLeft;
    const chartH = chartBottom - chartTop;

    const totalWeight = players.reduce((s, p) => s + p.weight, 0) || 1;

    const groupWidth = chartW / n;
    const barWidth = Math.min(groupWidth * 0.25, 40);
    const gap = barWidth * 0.3;

    // Title
    ctx.fillStyle = '#c0d4f0';
    ctx.font = 'bold 18px system-ui';
    ctx.textAlign = 'center';
    ctx.fillText('Vote Weight vs Actual Power', (chartLeft + chartRight) / 2, 40);

    // Y axis
    ctx.strokeStyle = 'rgba(100,140,200,0.3)';
    ctx.fillStyle = '#8090b0';
    ctx.font = '11px system-ui';
    ctx.textAlign = 'right';
    for (let i = 0; i <= 10; i++) {
        const y = chartBottom - (i / 10) * chartH;
        const pct = (i * 10);
        ctx.beginPath(); ctx.moveTo(chartLeft, y); ctx.lineTo(chartRight, y); ctx.stroke();
        ctx.fillText(pct + '%', chartLeft - 8, y + 4);
    }

    // Bars
    for (let i = 0; i < n; i++) {
        const cx = chartLeft + groupWidth * (i + 0.5);
        const weightPct = players[i].weight / totalWeight;
        const shapleyPct = shapley[i] || 0;
        const banzhafPct = banzhaf[i] || 0;

        const anim = Math.min(animProgress, 1);

        // Weight bar
        const wh = weightPct * chartH * anim;
        ctx.fillStyle = colors[i % colors.length];
        ctx.globalAlpha = 0.5;
        ctx.fillRect(cx - barWidth * 1.5 - gap, chartBottom - wh, barWidth, wh);
        ctx.globalAlpha = 1;

        // Shapley bar
        const sh = shapleyPct * chartH * anim;
        ctx.fillStyle = colors[i % colors.length];
        ctx.globalAlpha = 0.8;
        ctx.fillRect(cx - barWidth * 0.5, chartBottom - sh, barWidth, sh);
        ctx.globalAlpha = 1;

        // Banzhaf bar
        const bh = banzhafPct * chartH * anim;
        ctx.fillStyle = colors[i % colors.length];
        ctx.globalAlpha = 0.65;
        ctx.fillRect(cx + barWidth * 0.5 + gap, chartBottom - bh, barWidth, bh);
        ctx.globalAlpha = 1;

        // Labels
        ctx.fillStyle = '#c0d0e0';
        ctx.font = 'bold 13px system-ui';
        ctx.textAlign = 'center';
        ctx.fillText(players[i].name, cx, chartBottom + 18);
        ctx.font = '10px system-ui';
        ctx.fillStyle = '#8899bb';
        ctx.fillText(`w:${players[i].weight}`, cx, chartBottom + 32);

        // Values above bars
        ctx.font = '10px system-ui';
        ctx.fillStyle = '#b0c0d0';
        if (anim > 0.5) {
            ctx.fillText((weightPct * 100).toFixed(1) + '%', cx - barWidth - gap, chartBottom - wh - 5);
            ctx.fillText((shapleyPct * 100).toFixed(1) + '%', cx, chartBottom - sh - 5);
            ctx.fillText((banzhafPct * 100).toFixed(1) + '%', cx + barWidth + gap, chartBottom - bh - 5);
        }
    }

    // Legend
    const legX = chartLeft + 10;
    const legY = chartBottom + 50;
    ctx.font = '12px system-ui';
    ctx.textAlign = 'left';

    ctx.globalAlpha = 0.5;
    ctx.fillStyle = '#7eb8f0';
    ctx.fillRect(legX, legY, 14, 10);
    ctx.globalAlpha = 1;
    ctx.fillStyle = '#a0b4d0';
    ctx.fillText('Vote Weight', legX + 20, legY + 9);

    ctx.globalAlpha = 0.8;
    ctx.fillStyle = '#7eb8f0';
    ctx.fillRect(legX + 120, legY, 14, 10);
    ctx.globalAlpha = 1;
    ctx.fillStyle = '#a0b4d0';
    ctx.fillText('Shapley-Shubik', legX + 140, legY + 9);

    ctx.globalAlpha = 0.65;
    ctx.fillStyle = '#7eb8f0';
    ctx.fillRect(legX + 280, legY, 14, 10);
    ctx.globalAlpha = 1;
    ctx.fillStyle = '#a0b4d0';
    ctx.fillText('Banzhaf', legX + 300, legY + 9);

    // Swing voter highlight
    let maxBanzhaf = Math.max(...banzhaf);
    let swingIdx = banzhaf.indexOf(maxBanzhaf);
    if (maxBanzhaf > 0 && animProgress > 0.8) {
        const cx = chartLeft + groupWidth * (swingIdx + 0.5);
        ctx.strokeStyle = '#f0c040';
        ctx.lineWidth = 2;
        ctx.setLineDash([4, 4]);
        ctx.strokeRect(cx - barWidth * 2, chartTop - 5, barWidth * 4, chartH + 10);
        ctx.setLineDash([]);
        ctx.fillStyle = '#f0c040';
        ctx.font = 'bold 11px system-ui';
        ctx.textAlign = 'center';
        ctx.fillText('Most Powerful', cx, chartTop - 12);
    }

    requestAnimationFrame(draw);
}

window.reset = function() {
    players = [{name:'A',weight:51},{name:'B',weight:49},{name:'C',weight:1}];
    quota = 52;
    document.getElementById('quotaInput').value = 52;
    renderPlayerList();
    recalculate();
};

renderPlayerList();
recalculate();
draw();
</script>
<script src="../assets/js/enhance.js"></script>
</body>
</html>
