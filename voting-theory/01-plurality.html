<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plurality Voting - First Past the Post</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; color: #e0e0e0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }
canvas { display: block; }
#controls {
    position: fixed; top: 15px; right: 15px; z-index: 10;
    background: rgba(20,20,40,0.85); backdrop-filter: blur(10px);
    border: 1px solid rgba(100,140,255,0.2); border-radius: 12px;
    padding: 18px; width: 280px; max-height: 90vh; overflow-y: auto;
}
#controls h2 { font-size: 16px; color: #7ba4ff; margin-bottom: 12px; }
#controls h3 { font-size: 13px; color: #9ab4e0; margin: 10px 0 6px; }
.btn {
    display: inline-block; padding: 8px 14px; margin: 3px;
    background: rgba(100,140,255,0.15); border: 1px solid rgba(100,140,255,0.3);
    border-radius: 6px; color: #b0c8ff; cursor: pointer; font-size: 12px;
    transition: all 0.2s;
}
.btn:hover { background: rgba(100,140,255,0.3); color: #fff; }
.btn.danger { background: rgba(255,80,80,0.15); border-color: rgba(255,80,80,0.3); color: #ffaaaa; }
.btn.danger:hover { background: rgba(255,80,80,0.3); color: #fff; }
#results { margin-top: 12px; }
.result-bar {
    display: flex; align-items: center; margin: 4px 0; font-size: 12px;
}
.result-bar .name { width: 70px; text-align: right; padding-right: 8px; }
.result-bar .bar-bg {
    flex: 1; height: 22px; background: rgba(255,255,255,0.05);
    border-radius: 4px; overflow: hidden; position: relative;
}
.result-bar .bar-fill {
    height: 100%; border-radius: 4px; transition: width 0.4s ease;
    display: flex; align-items: center; padding-left: 6px; font-size: 11px;
    font-weight: bold; color: #fff; min-width: 0;
}
.result-bar .pct { width: 45px; text-align: right; font-size: 11px; color: #8899bb; padding-left: 4px; }
#winner-display {
    margin-top: 10px; padding: 8px; border-radius: 8px;
    background: rgba(100,255,140,0.08); border: 1px solid rgba(100,255,140,0.2);
    font-size: 13px; text-align: center; color: #80ffaa;
}
#info {
    position: fixed; bottom: 15px; left: 15px; z-index: 10;
    background: rgba(20,20,40,0.85); backdrop-filter: blur(10px);
    border: 1px solid rgba(100,140,255,0.2); border-radius: 12px;
    padding: 16px; width: 320px; font-size: 12px; line-height: 1.6;
}
#info h3 { color: #7ba4ff; margin-bottom: 8px; font-size: 14px; }
#info p { color: #99aabb; margin-bottom: 6px; }
#info .highlight { color: #ffaa66; font-weight: bold; }
a.back { position: fixed; top: 15px; left: 15px; color: #7ba4ff; text-decoration: none; font-size: 13px; z-index: 20; }
a.back:hover { color: #aaccff; }
.label { font-size: 11px; color: #8899bb; margin-bottom: 4px; }
</style>
</head>
<body>
<a href="index.html" class="back">‚Üê Back</a>
<canvas id="c"></canvas>

<div id="controls">
    <h2>Plurality Voting</h2>
    <div class="label">Click canvas to add voters. Drag candidates (large circles).</div>
    <div>
        <button class="btn" onclick="addRandomVoters(20)">+20 Voters</button>
        <button class="btn" onclick="addRandomVoters(50)">+50 Voters</button>
    </div>
    <div style="margin-top:6px">
        <button class="btn danger" onclick="addSpoiler()">Add Spoiler Candidate</button>
        <button class="btn" onclick="window.reset()">Reset</button>
    </div>
    <h3>Vote Totals</h3>
    <div id="results"></div>
    <div id="winner-display">Click to add voters</div>
</div>

<div id="info">
    <h3>How Plurality Voting Works</h3>
    <p>Each voter casts <span class="highlight">one vote</span> for their most preferred candidate. The candidate with the most votes wins.</p>
    <p>The fatal flaw: <span class="highlight">vote splitting</span>. When two similar candidates run, they split their base, letting an unlike candidate win with a minority.</p>
    <p>Try the <span class="highlight">"Add Spoiler"</span> button to see this effect in action.</p>
</div>

<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let W, H;

const CANDIDATE_COLORS = [
    '#4488ff', '#ff4466', '#44dd88', '#ffaa22', '#cc66ff',
    '#ff6644', '#22dddd', '#dddd44'
];
const CANDIDATE_NAMES = ['Blue', 'Red', 'Green', 'Orange', 'Purple', 'Coral', 'Teal', 'Gold'];

let candidates = [];
let voters = [];
let dragging = null;
let dragOffset = { x: 0, y: 0 };
let spoilerAdded = false;
let animFrame;

function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
}

function initCandidates() {
    const cx = W / 2, cy = H / 2;
    candidates = [
        { x: cx - 160, y: cy - 60, color: CANDIDATE_COLORS[0], name: CANDIDATE_NAMES[0], votes: 0, r: 22 },
        { x: cx + 160, y: cy + 60, color: CANDIDATE_COLORS[1], name: CANDIDATE_NAMES[1], votes: 0, r: 22 },
        { x: cx, y: cy - 140, color: CANDIDATE_COLORS[2], name: CANDIDATE_NAMES[2], votes: 0, r: 22 },
    ];
}

function dist(a, b) {
    return Math.sqrt((a.x - b.x) ** 2 + (a.y - b.y) ** 2);
}

function nearestCandidate(voter) {
    let best = null, bestD = Infinity;
    for (const c of candidates) {
        const d = dist(voter, c);
        if (d < bestD) { bestD = d; best = c; }
    }
    return best;
}

function tally() {
    for (const c of candidates) c.votes = 0;
    for (const v of voters) {
        const nearest = nearestCandidate(v);
        v.candidate = nearest;
        if (nearest) nearest.votes++;
    }
}

function addRandomVoters(n) {
    const margin = 80;
    for (let i = 0; i < n; i++) {
        // Cluster voters around candidate positions with some spread
        if (candidates.length > 0 && Math.random() < 0.7) {
            const c = candidates[Math.floor(Math.random() * candidates.length)];
            voters.push({
                x: c.x + (Math.random() - 0.5) * 260,
                y: c.y + (Math.random() - 0.5) * 260,
                candidate: null
            });
        } else {
            voters.push({
                x: margin + Math.random() * (W - 2 * margin),
                y: margin + Math.random() * (H - 2 * margin),
                candidate: null
            });
        }
    }
    tally();
}

function addSpoiler() {
    if (spoilerAdded) return;
    spoilerAdded = true;
    // Find leading candidate and place spoiler near them
    tally();
    let leader = candidates[0];
    for (const c of candidates) {
        if (c.votes > leader.votes) leader = c;
    }
    const spoiler = {
        x: leader.x + (Math.random() > 0.5 ? 1 : -1) * (60 + Math.random() * 40),
        y: leader.y + (Math.random() > 0.5 ? 1 : -1) * (60 + Math.random() * 40),
        color: CANDIDATE_COLORS[candidates.length],
        name: CANDIDATE_NAMES[candidates.length] + '*',
        votes: 0, r: 22
    };
    candidates.push(spoiler);
    tally();
}

function updateResults() {
    const resultsDiv = document.getElementById('results');
    const winnerDiv = document.getElementById('winner-display');
    const totalVotes = voters.length;
    if (totalVotes === 0) {
        resultsDiv.innerHTML = '';
        winnerDiv.textContent = 'Click to add voters';
        return;
    }

    let maxVotes = 0;
    for (const c of candidates) if (c.votes > maxVotes) maxVotes = c.votes;

    let html = '';
    for (const c of candidates) {
        const pct = totalVotes > 0 ? (c.votes / totalVotes * 100).toFixed(1) : 0;
        const barW = maxVotes > 0 ? (c.votes / maxVotes * 100) : 0;
        html += `<div class="result-bar">
            <span class="name" style="color:${c.color}">${c.name}</span>
            <span class="bar-bg"><span class="bar-fill" style="width:${barW}%;background:${c.color}">${c.votes}</span></span>
            <span class="pct">${pct}%</span>
        </div>`;
    }
    resultsDiv.innerHTML = html;

    let winner = candidates[0];
    for (const c of candidates) if (c.votes > winner.votes) winner = c;
    const wpct = (winner.votes / totalVotes * 100).toFixed(1);
    const isMajority = winner.votes > totalVotes / 2;
    winnerDiv.innerHTML = `<span style="color:${winner.color}">&#9733; ${winner.name}</span> wins with ${wpct}%` +
        (isMajority ? '' : '<br><span style="color:#ffaa66;font-size:11px">No majority - wins with minority!</span>');
}

function draw() {
    ctx.clearRect(0, 0, W, H);

    // Draw grid
    ctx.strokeStyle = 'rgba(100,140,255,0.04)';
    ctx.lineWidth = 1;
    for (let x = 0; x < W; x += 50) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke(); }
    for (let y = 0; y < H; y += 50) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke(); }

    // Draw Voronoi-ish regions (simple: color background per nearest candidate)
    // Too expensive per-pixel, so draw voter->candidate lines instead

    // Lines from voters to their candidate
    for (const v of voters) {
        if (!v.candidate) continue;
        ctx.beginPath();
        ctx.moveTo(v.x, v.y);
        ctx.lineTo(v.candidate.x, v.candidate.y);
        ctx.strokeStyle = v.candidate.color + '15';
        ctx.lineWidth = 1;
        ctx.stroke();
    }

    // Draw voters
    for (const v of voters) {
        const col = v.candidate ? v.candidate.color : '#555';
        ctx.beginPath();
        ctx.arc(v.x, v.y, 4, 0, Math.PI * 2);
        ctx.fillStyle = col + '99';
        ctx.fill();
        ctx.strokeStyle = col;
        ctx.lineWidth = 0.5;
        ctx.stroke();
    }

    // Draw candidates
    for (const c of candidates) {
        // Glow
        const grad = ctx.createRadialGradient(c.x, c.y, 0, c.x, c.y, 50);
        grad.addColorStop(0, c.color + '44');
        grad.addColorStop(1, c.color + '00');
        ctx.beginPath();
        ctx.arc(c.x, c.y, 50, 0, Math.PI * 2);
        ctx.fillStyle = grad;
        ctx.fill();

        // Body
        ctx.beginPath();
        ctx.arc(c.x, c.y, c.r, 0, Math.PI * 2);
        ctx.fillStyle = c.color;
        ctx.fill();
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.stroke();

        // Label
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 11px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(c.name, c.x, c.y - c.r - 8);
        ctx.font = '11px sans-serif';
        ctx.fillStyle = '#aabbcc';
        ctx.fillText(c.votes + ' votes', c.x, c.y + c.r + 16);
    }

    updateResults();
    animFrame = requestAnimationFrame(draw);
}

// Interaction
canvas.addEventListener('mousedown', (e) => {
    const mx = e.clientX, my = e.clientY;
    // Check if clicking a candidate
    for (const c of candidates) {
        if (dist({ x: mx, y: my }, c) < c.r + 5) {
            dragging = c;
            dragOffset.x = mx - c.x;
            dragOffset.y = my - c.y;
            return;
        }
    }
    // Otherwise add a voter
    voters.push({ x: mx, y: my, candidate: null });
    tally();
});

canvas.addEventListener('mousemove', (e) => {
    if (dragging) {
        dragging.x = e.clientX - dragOffset.x;
        dragging.y = e.clientY - dragOffset.y;
        tally();
    }
});

canvas.addEventListener('mouseup', () => { dragging = null; });

canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    const t = e.touches[0];
    const mx = t.clientX, my = t.clientY;
    for (const c of candidates) {
        if (dist({ x: mx, y: my }, c) < c.r + 15) {
            dragging = c;
            dragOffset.x = mx - c.x;
            dragOffset.y = my - c.y;
            return;
        }
    }
    voters.push({ x: mx, y: my, candidate: null });
    tally();
}, { passive: false });

canvas.addEventListener('touchmove', (e) => {
    e.preventDefault();
    if (dragging) {
        const t = e.touches[0];
        dragging.x = t.clientX - dragOffset.x;
        dragging.y = t.clientY - dragOffset.y;
        tally();
    }
}, { passive: false });

canvas.addEventListener('touchend', () => { dragging = null; });

window.addEventListener('resize', resize);

window.reset = function() {
    cancelAnimationFrame(animFrame);
    voters = [];
    spoilerAdded = false;
    resize();
    initCandidates();
    tally();
    draw();
};

resize();
initCandidates();
addRandomVoters(80);
tally();
draw();
</script>
<script src="../assets/js/enhance.js"></script>
</body>
</html>
