<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Duverger's Law - Voting Theory</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; color: #e0e0e0; font-family: 'Segoe UI', system-ui, sans-serif; overflow: hidden; }
canvas { display: block; }
a.back-link {
    position: fixed; top: 16px; left: 16px; color: #8ab4f8; text-decoration: none;
    font-size: 14px; z-index: 100; opacity: 0.8; transition: opacity 0.2s;
}
a.back-link:hover { opacity: 1; }

.controls {
    position: fixed; top: 16px; right: 16px; z-index: 100;
    background: rgba(20,20,40,0.85); backdrop-filter: blur(10px);
    border-radius: 12px; padding: 16px; min-width: 230px;
    border: 1px solid rgba(255,255,255,0.08);
}
.controls h3 { font-size: 14px; color: #8ab4f8; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
.controls label { display: block; font-size: 12px; color: #aaa; margin-top: 8px; }
.controls input[type=range] { width: 100%; margin: 4px 0; accent-color: #8ab4f8; }
.controls .value { font-size: 11px; color: #666; text-align: right; }
.btn {
    display: inline-block; margin: 4px 2px; padding: 6px 14px; border: none; border-radius: 6px;
    background: #1a3a5c; color: #8ab4f8; font-size: 12px; cursor: pointer; transition: background 0.2s;
}
.btn:hover { background: #244a6c; }
.btn.active { background: #2e6b3e; color: #8f8; }
.btn-row { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 4px; }

.stats {
    position: fixed; bottom: 16px; left: 16px; z-index: 100;
    background: rgba(20,20,40,0.85); backdrop-filter: blur(10px);
    border-radius: 12px; padding: 14px 18px;
    border: 1px solid rgba(255,255,255,0.08); font-size: 13px; min-width: 200px;
}
.stats .stat-row { display: flex; justify-content: space-between; gap: 20px; margin: 3px 0; }
.stats .stat-label { color: #888; }
.stats .stat-value { color: #8ab4f8; font-family: 'Courier New', monospace; }

.info-panel {
    position: fixed; bottom: 16px; right: 16px; z-index: 100;
    background: rgba(20,20,40,0.85); backdrop-filter: blur(10px);
    border-radius: 12px; padding: 14px 18px; max-width: 320px;
    border: 1px solid rgba(255,255,255,0.08); font-size: 12px; line-height: 1.6;
}
.info-panel h4 { color: #8ab4f8; margin-bottom: 6px; }
.info-panel p { color: #aaa; }
</style>
</head>
<body>
<a href="index.html" class="back-link">&#8592; Back to Gallery</a>
<canvas id="canvas"></canvas>

<div class="controls">
    <h3>Duverger's Law</h3>
    <label>Initial Parties: <span id="partiesVal">5</span></label>
    <input type="range" id="numParties" min="3" max="8" value="5">
    <label>Strategic Intensity: <span id="strategyVal">0.15</span></label>
    <input type="range" id="strategy" min="5" max="30" value="15">
    <label>Generations: <span id="genVal">30</span></label>
    <input type="range" id="maxGen" min="10" max="60" value="30">
    <label>Speed: <span id="speedVal">0.5</span>s</label>
    <input type="range" id="speed" min="1" max="20" value="5">
    <div class="btn-row">
        <button class="btn" id="playBtn">Play</button>
        <button class="btn" id="stepBtn">Step</button>
        <button class="btn" id="resetBtn">Reset</button>
    </div>
</div>

<div class="stats">
    <div class="stat-row"><span class="stat-label">Generation</span><span class="stat-value" id="genDisplay">0</span></div>
    <div class="stat-row"><span class="stat-label">Active Parties (Plur.)</span><span class="stat-value" id="activePlur">0</span></div>
    <div class="stat-row"><span class="stat-label">Active Parties (PR)</span><span class="stat-value" id="activePR">0</span></div>
    <div class="stat-row"><span class="stat-label">System</span><span class="stat-value" id="systemType">Multi-party</span></div>
</div>

<div class="info-panel">
    <h4>Duverger's Law</h4>
    <p>Under plurality (winner-take-all) voting, voters strategically abandon losing parties, creating a feedback loop that kills third parties. Under proportional representation, small parties survive. Watch both systems evolve side by side.</p>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let W, H;
function resize() { W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; }
resize();
window.addEventListener('resize', resize);

const partyColors = [
    '#e63946', '#457b9d', '#2a9d8f', '#e9c46a', '#9b5de5',
    '#f4845f', '#00bbf9', '#fee440'
];
const partyNames = ['Red', 'Blue', 'Green', 'Yellow', 'Purple', 'Orange', 'Cyan', 'Gold'];

let numParties, generation, playing, playInterval;
let pluralityHistory, prHistory;

function initSim() {
    numParties = parseInt(document.getElementById('numParties').value);
    generation = 0;
    playing = false;
    if (playInterval) clearInterval(playInterval);
    document.getElementById('playBtn').textContent = 'Play';
    document.getElementById('playBtn').classList.remove('active');

    // Start with roughly equal share + small random perturbation
    const initShare = 100 / numParties;
    const plurStart = [];
    const prStart = [];
    for (let i = 0; i < numParties; i++) {
        const noise = (Math.random() - 0.5) * 8;
        plurStart.push(Math.max(2, initShare + noise));
        prStart.push(Math.max(2, initShare + noise));
    }
    // Normalize
    const plurTotal = plurStart.reduce((s, v) => s + v, 0);
    const prTotal = prStart.reduce((s, v) => s + v, 0);
    pluralityHistory = [plurStart.map(v => v / plurTotal * 100)];
    prHistory = [prStart.map(v => v / prTotal * 100)];
}

function stepSimulation() {
    const maxGen = parseInt(document.getElementById('maxGen').value);
    if (generation >= maxGen) {
        if (playing) togglePlay();
        return;
    }

    const strategy = parseInt(document.getElementById('strategy').value) / 100;
    const prevPlur = pluralityHistory[pluralityHistory.length - 1];
    const prevPR = prHistory[prHistory.length - 1];

    // Plurality: strategic voting - voters leave losing parties
    const newPlur = [...prevPlur];
    // Find the two largest parties
    const sorted = prevPlur.map((v, i) => ({ v, i })).sort((a, b) => b.v - a.v);
    const top2 = new Set([sorted[0].i, sorted[1].i]);

    for (let i = 0; i < numParties; i++) {
        if (top2.has(i)) continue;
        // Voters leave this party proportional to how far behind it is
        const loss = newPlur[i] * strategy * (1 + Math.random() * 0.3);
        const actualLoss = Math.min(newPlur[i] * 0.5, loss);
        newPlur[i] -= actualLoss;
        // Distribute to closest of top 2
        const dest = Math.random() < 0.5 ? sorted[0].i : sorted[1].i;
        newPlur[dest] += actualLoss;
    }
    // Small random noise for top parties
    if (newPlur[sorted[0].i] > 0 && newPlur[sorted[1].i] > 0) {
        const shift = (Math.random() - 0.5) * 2;
        newPlur[sorted[0].i] += shift;
        newPlur[sorted[1].i] -= shift;
    }
    // Normalize
    const plurTotal = newPlur.reduce((s, v) => s + v, 0);
    const normPlur = newPlur.map(v => Math.max(0, v / plurTotal * 100));
    pluralityHistory.push(normPlur);

    // PR: much less strategic pressure, parties mostly maintain share
    const newPR = [...prevPR];
    for (let i = 0; i < numParties; i++) {
        // Small random walk - parties can grow or shrink slightly
        const change = (Math.random() - 0.5) * 3;
        newPR[i] = Math.max(0.5, newPR[i] + change);
        // Very weak strategic pressure (much less than plurality)
        if (newPR[i] < 5) {
            const loss = newPR[i] * strategy * 0.1;
            newPR[i] -= loss;
            newPR[(i + 1) % numParties] += loss;
        }
    }
    const prTotal = newPR.reduce((s, v) => s + v, 0);
    const normPR = newPR.map(v => Math.max(0, v / prTotal * 100));
    prHistory.push(normPR);

    generation++;
}

function togglePlay() {
    playing = !playing;
    document.getElementById('playBtn').textContent = playing ? 'Pause' : 'Play';
    document.getElementById('playBtn').classList.toggle('active', playing);
    if (playing) {
        const speed = parseInt(document.getElementById('speed').value) / 10;
        playInterval = setInterval(stepSimulation, speed * 1000);
    } else {
        if (playInterval) clearInterval(playInterval);
    }
}

document.getElementById('numParties').addEventListener('input', function() {
    document.getElementById('partiesVal').textContent = this.value;
});
document.getElementById('strategy').addEventListener('input', function() {
    document.getElementById('strategyVal').textContent = (this.value / 100).toFixed(2);
});
document.getElementById('maxGen').addEventListener('input', function() {
    document.getElementById('genVal').textContent = this.value;
});
document.getElementById('speed').addEventListener('input', function() {
    document.getElementById('speedVal').textContent = (this.value / 10).toFixed(1) + 's';
    if (playing) { togglePlay(); togglePlay(); } // restart interval with new speed
});
document.getElementById('playBtn').addEventListener('click', togglePlay);
document.getElementById('stepBtn').addEventListener('click', stepSimulation);
document.getElementById('resetBtn').addEventListener('click', () => window.reset());

function drawGraph(x, y, w, h, history, title, isPlurality) {
    const maxGen = parseInt(document.getElementById('maxGen').value);
    const gens = history.length;

    // Background
    ctx.fillStyle = '#0d1225';
    ctx.fillRect(x, y, w, h);
    ctx.strokeStyle = '#1a1a3a';
    ctx.lineWidth = 1;
    ctx.strokeRect(x, y, w, h);

    // Title
    ctx.fillStyle = '#8ab4f8';
    ctx.font = 'bold 15px Segoe UI, system-ui';
    ctx.textAlign = 'center';
    ctx.fillText(title, x + w / 2, y - 10);

    // Grid lines
    ctx.strokeStyle = '#1a1a3a';
    ctx.setLineDash([3, 6]);
    for (let pct = 20; pct <= 80; pct += 20) {
        const gy = y + h - (pct / 100) * h;
        ctx.beginPath();
        ctx.moveTo(x, gy);
        ctx.lineTo(x + w, gy);
        ctx.stroke();

        ctx.fillStyle = '#444';
        ctx.font = '10px Courier New, monospace';
        ctx.textAlign = 'right';
        ctx.fillText(pct + '%', x - 4, gy + 3);
    }
    ctx.setLineDash([]);

    // X axis labels
    ctx.fillStyle = '#444';
    ctx.font = '10px Courier New, monospace';
    ctx.textAlign = 'center';
    for (let g = 0; g <= maxGen; g += 5) {
        const gx = x + (g / maxGen) * w;
        ctx.fillText(g, gx, y + h + 14);
    }
    ctx.fillText('Generation', x + w / 2, y + h + 28);

    // Draw lines for each party
    for (let p = 0; p < numParties; p++) {
        ctx.strokeStyle = partyColors[p];
        ctx.lineWidth = 2.5;
        ctx.beginPath();
        for (let g = 0; g < gens; g++) {
            const gx = x + (g / maxGen) * w;
            const gy = y + h - (history[g][p] / 100) * h;
            if (g === 0) ctx.moveTo(gx, gy);
            else ctx.lineTo(gx, gy);
        }
        ctx.stroke();

        // End label
        if (gens > 0) {
            const lastVal = history[gens - 1][p];
            if (lastVal > 1) {
                const lx = x + ((gens - 1) / maxGen) * w + 6;
                const ly = y + h - (lastVal / 100) * h;
                ctx.fillStyle = partyColors[p];
                ctx.font = 'bold 11px Segoe UI, system-ui';
                ctx.textAlign = 'left';
                ctx.fillText(`${partyNames[p]} ${lastVal.toFixed(1)}%`, lx, ly + 3);
            }
        }
    }

    // Outcome annotation
    if (gens > 1) {
        const last = history[gens - 1];
        const active = last.filter(v => v > 2).length;
        ctx.fillStyle = isPlurality ? '#ff6b6b' : '#4ecdc4';
        ctx.font = 'bold 12px Segoe UI, system-ui';
        ctx.textAlign = 'center';
        const outcomeText = active <= 2 ? 'Two-party system' : active <= 3 ? 'Three parties remain' : `${active} parties active`;
        ctx.fillText(outcomeText, x + w / 2, y + h - 10);
    }
}

function drawCurrentBars(x, y, w, h, values, title) {
    ctx.fillStyle = '#8ab4f8';
    ctx.font = 'bold 12px Segoe UI, system-ui';
    ctx.textAlign = 'center';
    ctx.fillText(title, x + w / 2, y - 6);

    const barW = w / numParties - 4;
    for (let i = 0; i < numParties; i++) {
        const bx = x + i * (w / numParties) + 2;
        const barH = (values[i] / 100) * h;
        ctx.fillStyle = partyColors[i] + 'cc';
        ctx.fillRect(bx, y + h - barH, barW, barH);

        if (values[i] > 3) {
            ctx.fillStyle = '#fff';
            ctx.font = '9px Courier New, monospace';
            ctx.textAlign = 'center';
            ctx.fillText(values[i].toFixed(0) + '%', bx + barW / 2, y + h - barH - 4);
        }
    }
}

function updateStats() {
    document.getElementById('genDisplay').textContent = generation;
    const lastPlur = pluralityHistory[pluralityHistory.length - 1];
    const lastPR = prHistory[prHistory.length - 1];
    const activePlur = lastPlur.filter(v => v > 2).length;
    const activePR = lastPR.filter(v => v > 2).length;
    document.getElementById('activePlur').textContent = activePlur;
    document.getElementById('activePR').textContent = activePR;
    document.getElementById('systemType').textContent = activePlur <= 2 ? 'Two-party' : 'Multi-party';
}

function animate() {
    ctx.clearRect(0, 0, W, H);

    // Title
    ctx.fillStyle = '#8ab4f8';
    ctx.font = 'bold 20px Segoe UI, system-ui';
    ctx.textAlign = 'center';
    ctx.fillText("Duverger's Law: Plurality vs Proportional Representation", W / 2, 30);
    ctx.fillStyle = '#666';
    ctx.font = '13px Segoe UI, system-ui';
    ctx.fillText('Under plurality, third parties die. Under PR, they survive.', W / 2, 52);

    const margin = 60;
    const graphW = (W - margin * 3) / 2;
    const graphH = H * 0.45;
    const graphY = 90;

    drawGraph(margin, graphY, graphW, graphH, pluralityHistory, 'Plurality (Winner-Take-All)', true);
    drawGraph(margin * 2 + graphW, graphY, graphW, graphH, prHistory, 'Proportional Representation', false);

    // Current state bars below
    const barY = graphY + graphH + 60;
    const barH = H - barY - 60;
    if (barH > 40) {
        const lastPlur = pluralityHistory[pluralityHistory.length - 1];
        const lastPR = prHistory[prHistory.length - 1];
        drawCurrentBars(margin, barY, graphW, barH, lastPlur, 'Current: Plurality');
        drawCurrentBars(margin * 2 + graphW, barY, graphW, barH, lastPR, 'Current: PR');
    }

    // VS divider
    ctx.fillStyle = '#333';
    ctx.font = 'bold 24px Segoe UI, system-ui';
    ctx.textAlign = 'center';
    ctx.fillText('VS', W / 2, graphY + graphH / 2);

    updateStats();
    requestAnimationFrame(animate);
}

window.reset = function() {
    document.getElementById('numParties').value = 5;
    document.getElementById('partiesVal').textContent = '5';
    document.getElementById('strategy').value = 15;
    document.getElementById('strategyVal').textContent = '0.15';
    document.getElementById('maxGen').value = 30;
    document.getElementById('genVal').textContent = '30';
    document.getElementById('speed').value = 5;
    document.getElementById('speedVal').textContent = '0.5s';
    initSim();
};

initSim();
animate();
</script>
<script src="../assets/js/enhance.js"></script>
</body>
</html>
