<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Approval Voting - Approve All You Like</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; color: #e0e0e0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }
canvas { display: block; }
#controls {
    position: fixed; top: 15px; right: 15px; z-index: 10;
    background: rgba(20,20,40,0.85); backdrop-filter: blur(10px);
    border: 1px solid rgba(100,140,255,0.2); border-radius: 12px;
    padding: 18px; width: 290px; max-height: 90vh; overflow-y: auto;
}
#controls h2 { font-size: 16px; color: #7ba4ff; margin-bottom: 10px; }
#controls h3 { font-size: 13px; color: #9ab4e0; margin: 12px 0 6px; }
.btn {
    display: inline-block; padding: 8px 14px; margin: 3px;
    background: rgba(100,140,255,0.15); border: 1px solid rgba(100,140,255,0.3);
    border-radius: 6px; color: #b0c8ff; cursor: pointer; font-size: 12px;
    transition: all 0.2s;
}
.btn:hover { background: rgba(100,140,255,0.3); color: #fff; }
.btn.active { background: rgba(100,255,140,0.15); border-color: rgba(100,255,140,0.3); color: #aaffcc; }
.slider-row { display: flex; align-items: center; margin: 6px 0; font-size: 12px; }
.slider-row label { width: 110px; color: #8899bb; }
.slider-row input[type=range] { flex: 1; }
.slider-row .val { width: 35px; text-align: right; color: #aabbcc; font-size: 11px; }
.result-bar { display: flex; align-items: center; margin: 4px 0; font-size: 12px; }
.result-bar .cname { width: 55px; text-align: right; padding-right: 6px; font-size: 11px; }
.result-bar .bar-bg { flex: 1; height: 20px; background: rgba(255,255,255,0.04); border-radius: 4px; overflow: hidden; }
.result-bar .bar-fill { height: 100%; border-radius: 4px; transition: width 0.4s; display: flex; align-items: center; padding-left: 5px; font-size: 10px; color: #fff; font-weight: bold; }
.result-bar .pct { width: 40px; text-align: right; font-size: 10px; color: #778; padding-left: 4px; }
#winner-box {
    margin-top: 8px; padding: 8px; border-radius: 8px;
    background: rgba(100,255,140,0.08); border: 1px solid rgba(100,255,140,0.2);
    font-size: 13px; text-align: center; color: #80ffaa;
}
#plurality-box {
    margin-top: 6px; padding: 6px; border-radius: 6px;
    background: rgba(255,170,100,0.06); border: 1px solid rgba(255,170,100,0.12);
    font-size: 11px; color: #ddaa77; text-align: center;
}
.mode-toggle { display: flex; gap: 4px; margin: 8px 0; }
#info {
    position: fixed; bottom: 15px; left: 15px; z-index: 10;
    background: rgba(20,20,40,0.85); backdrop-filter: blur(10px);
    border: 1px solid rgba(100,140,255,0.2); border-radius: 12px;
    padding: 16px; width: 320px; font-size: 12px; line-height: 1.6;
}
#info h3 { color: #7ba4ff; margin-bottom: 8px; font-size: 14px; }
#info p { color: #99aabb; margin-bottom: 6px; }
#info .highlight { color: #ffaa66; font-weight: bold; }
a.back { position: fixed; top: 15px; left: 15px; color: #7ba4ff; text-decoration: none; font-size: 13px; z-index: 20; }
a.back:hover { color: #aaccff; }
.label { font-size: 11px; color: #8899bb; margin-bottom: 6px; }
</style>
</head>
<body>
<a href="index.html" class="back">‚Üê Back</a>
<canvas id="c"></canvas>

<div id="controls">
    <h2>Approval Voting</h2>
    <div class="label">Voters approve all candidates within their radius circle. Click to add voters. Drag candidates.</div>
    <div>
        <button class="btn" onclick="addRandomVoters(20)">+20 Voters</button>
        <button class="btn" onclick="addRandomVoters(50)">+50 Voters</button>
        <button class="btn" onclick="window.reset()">Reset</button>
    </div>
    <div class="slider-row">
        <label>Approval Radius:</label>
        <input type="range" id="radiusSlider" min="50" max="300" value="150" oninput="updateRadius(this.value)">
        <span class="val" id="radiusVal">150</span>
    </div>
    <div class="mode-toggle">
        <button class="btn active" id="btnHonest" onclick="setMode('honest')">Honest</button>
        <button class="btn" id="btnStrategic" onclick="setMode('strategic')">Strategic</button>
    </div>
    <h3>Approval Totals</h3>
    <div id="approval-results"></div>
    <div id="winner-box">Add voters to see results</div>
    <h3>Plurality Comparison</h3>
    <div id="plurality-results"></div>
    <div id="plurality-box"></div>
</div>

<div id="info">
    <h3>How Approval Voting Works</h3>
    <p>Each voter <span class="highlight">approves or disapproves</span> each candidate independently. No ranking needed.</p>
    <p>Here, voters approve all candidates within their <span class="highlight">approval radius</span> (the circle around each voter).</p>
    <p><span class="highlight">Honest mode:</span> approve all acceptable candidates.<br>
    <span class="highlight">Strategic mode:</span> only approve your top choice + anyone you prefer over the frontrunner.</p>
    <p>Approval voting <span class="highlight">resists vote splitting</span> because liking one candidate doesn't prevent approving another.</p>
</div>

<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let W, H;

const COLORS = ['#4488ff', '#ff4466', '#44dd88', '#ffaa22', '#cc66ff'];
const NAMES = ['Blue', 'Red', 'Green', 'Orange', 'Purple'];

let candidates = [];
let voters = [];
let approvalRadius = 150;
let mode = 'honest'; // 'honest' | 'strategic'
let dragging = null;
let dragOffset = { x: 0, y: 0 };
let animFrame;
let showRadii = true;

function resize() { W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; }
function dist(a, b) { return Math.sqrt((a.x - b.x) ** 2 + (a.y - b.y) ** 2); }

function initCandidates() {
    const cx = W * 0.38, cy = H / 2;
    candidates = [
        { x: cx - 130, y: cy - 70, color: COLORS[0], name: NAMES[0], r: 20 },
        { x: cx + 130, y: cy + 50, color: COLORS[1], name: NAMES[1], r: 20 },
        { x: cx, y: cy - 140, color: COLORS[2], name: NAMES[2], r: 20 },
        { x: cx - 50, y: cy + 120, color: COLORS[3], name: NAMES[3], r: 20 },
    ];
}

function getApprovals(voter) {
    const dists = candidates.map((c, i) => ({ i, d: dist(voter, c) })).sort((a, b) => a.d - b.d);

    if (mode === 'honest') {
        // Approve all within radius
        return dists.filter(x => x.d <= approvalRadius).map(x => x.i);
    } else {
        // Strategic: approve top choice + anyone preferred over assumed frontrunner
        // Frontrunner = candidate with most honest approvals
        const honestCounts = new Array(candidates.length).fill(0);
        for (const v of voters) {
            for (let i = 0; i < candidates.length; i++) {
                if (dist(v, candidates[i]) <= approvalRadius) honestCounts[i]++;
            }
        }
        let frontrunner = 0;
        for (let i = 1; i < honestCounts.length; i++) if (honestCounts[i] > honestCounts[frontrunner]) frontrunner = i;

        const myTop = dists[0].i;
        const frontDist = dist(voter, candidates[frontrunner]);
        const approved = [myTop];
        for (const x of dists) {
            if (x.i !== myTop && x.d < frontDist && x.d <= approvalRadius * 1.2) {
                approved.push(x.i);
            }
        }
        return approved;
    }
}

function tally() {
    const approvalCounts = new Array(candidates.length).fill(0);
    const pluralityCounts = new Array(candidates.length).fill(0);

    for (const v of voters) {
        // Approval
        const appr = getApprovals(v);
        v.approvals = appr;
        for (const i of appr) approvalCounts[i]++;

        // Plurality (nearest only)
        let nearest = 0, nearD = Infinity;
        candidates.forEach((c, i) => { const d = dist(v, c); if (d < nearD) { nearD = d; nearest = i; } });
        pluralityCounts[nearest]++;
        v.plurality = nearest;
    }

    // Render approval results
    const maxA = Math.max(...approvalCounts, 1);
    const total = voters.length;
    let approvalHtml = '';
    let approvalWinner = 0;
    for (let i = 0; i < candidates.length; i++) {
        if (approvalCounts[i] > approvalCounts[approvalWinner]) approvalWinner = i;
        const pct = total > 0 ? (approvalCounts[i] / total * 100).toFixed(1) : 0;
        const barW = (approvalCounts[i] / maxA * 100);
        approvalHtml += `<div class="result-bar">
            <span class="cname" style="color:${candidates[i].color}">${candidates[i].name}</span>
            <span class="bar-bg"><span class="bar-fill" style="width:${barW}%;background:${candidates[i].color}">${approvalCounts[i]}</span></span>
            <span class="pct">${pct}%</span>
        </div>`;
    }
    document.getElementById('approval-results').innerHTML = approvalHtml;

    if (total > 0) {
        document.getElementById('winner-box').innerHTML =
            `<span style="color:${candidates[approvalWinner].color}">&#9733; ${candidates[approvalWinner].name}</span> wins approval vote`;
    }

    // Plurality
    const maxP = Math.max(...pluralityCounts, 1);
    let pluralityHtml = '';
    let pluralityWinner = 0;
    for (let i = 0; i < candidates.length; i++) {
        if (pluralityCounts[i] > pluralityCounts[pluralityWinner]) pluralityWinner = i;
        const barW = (pluralityCounts[i] / maxP * 100);
        pluralityHtml += `<div class="result-bar">
            <span class="cname" style="color:${candidates[i].color}">${candidates[i].name}</span>
            <span class="bar-bg"><span class="bar-fill" style="width:${barW}%;background:${candidates[i].color}88">${pluralityCounts[i]}</span></span>
            <span class="pct"></span>
        </div>`;
    }
    document.getElementById('plurality-results').innerHTML = pluralityHtml;

    if (total > 0) {
        if (pluralityWinner !== approvalWinner) {
            document.getElementById('plurality-box').innerHTML =
                `Plurality: <span style="color:${candidates[pluralityWinner].color}">${candidates[pluralityWinner].name}</span> ` +
                `vs Approval: <span style="color:${candidates[approvalWinner].color}">${candidates[approvalWinner].name}</span> -- Different winners!`;
        } else {
            document.getElementById('plurality-box').textContent = 'Same winner as approval voting.';
        }
    }
}

function updateRadius(val) {
    approvalRadius = parseInt(val);
    document.getElementById('radiusVal').textContent = val;
    tally();
}

function setMode(m) {
    mode = m;
    document.getElementById('btnHonest').className = m === 'honest' ? 'btn active' : 'btn';
    document.getElementById('btnStrategic').className = m === 'strategic' ? 'btn active' : 'btn';
    tally();
}

function addRandomVoters(n) {
    const margin = 80;
    for (let i = 0; i < n; i++) {
        if (candidates.length > 0 && Math.random() < 0.65) {
            const c = candidates[Math.floor(Math.random() * candidates.length)];
            voters.push({ x: c.x + (Math.random() - 0.5) * 280, y: c.y + (Math.random() - 0.5) * 280, approvals: [], plurality: 0 });
        } else {
            voters.push({ x: margin + Math.random() * (W * 0.6 - margin), y: margin + Math.random() * (H - 2 * margin), approvals: [], plurality: 0 });
        }
    }
    tally();
}

function draw() {
    ctx.clearRect(0, 0, W, H);

    // Grid
    ctx.strokeStyle = 'rgba(100,140,255,0.04)';
    for (let x = 0; x < W; x += 50) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke(); }
    for (let y = 0; y < H; y += 50) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke(); }

    // Draw voter approval circles (subtle)
    if (showRadii && voters.length <= 200) {
        for (const v of voters) {
            ctx.beginPath();
            ctx.arc(v.x, v.y, approvalRadius, 0, Math.PI * 2);
            ctx.strokeStyle = 'rgba(150,180,255,0.04)';
            ctx.lineWidth = 0.5;
            ctx.stroke();
        }
    }

    // Approval lines
    for (const v of voters) {
        if (!v.approvals) continue;
        for (const ci of v.approvals) {
            ctx.beginPath();
            ctx.moveTo(v.x, v.y);
            ctx.lineTo(candidates[ci].x, candidates[ci].y);
            ctx.strokeStyle = candidates[ci].color + '0c';
            ctx.lineWidth = 1;
            ctx.stroke();
        }
    }

    // Voters
    for (const v of voters) {
        const col = v.approvals && v.approvals.length > 0 ? candidates[v.approvals[0]].color : '#555';
        ctx.beginPath(); ctx.arc(v.x, v.y, 4, 0, Math.PI * 2);
        ctx.fillStyle = col + '88'; ctx.fill();
        // If approves multiple, show little ring
        if (v.approvals && v.approvals.length > 1) {
            ctx.beginPath(); ctx.arc(v.x, v.y, 6, 0, Math.PI * 2);
            ctx.strokeStyle = '#ffffff22'; ctx.lineWidth = 1; ctx.stroke();
        }
    }

    // Candidates
    for (const c of candidates) {
        // Approval radius ring
        ctx.beginPath(); ctx.arc(c.x, c.y, approvalRadius, 0, Math.PI * 2);
        ctx.strokeStyle = c.color + '18'; ctx.lineWidth = 1.5; ctx.setLineDash([4, 4]); ctx.stroke();
        ctx.setLineDash([]);

        // Glow
        const grad = ctx.createRadialGradient(c.x, c.y, 0, c.x, c.y, 45);
        grad.addColorStop(0, c.color + '44');
        grad.addColorStop(1, c.color + '00');
        ctx.beginPath(); ctx.arc(c.x, c.y, 45, 0, Math.PI * 2); ctx.fillStyle = grad; ctx.fill();

        ctx.beginPath(); ctx.arc(c.x, c.y, c.r, 0, Math.PI * 2);
        ctx.fillStyle = c.color; ctx.fill();
        ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.stroke();

        ctx.fillStyle = '#fff'; ctx.font = 'bold 11px sans-serif'; ctx.textAlign = 'center';
        ctx.fillText(c.name, c.x, c.y - c.r - 8);
    }

    animFrame = requestAnimationFrame(draw);
}

canvas.addEventListener('mousedown', (e) => {
    const mx = e.clientX, my = e.clientY;
    for (const c of candidates) {
        if (dist({ x: mx, y: my }, c) < c.r + 5) {
            dragging = c; dragOffset.x = mx - c.x; dragOffset.y = my - c.y; return;
        }
    }
    voters.push({ x: mx, y: my, approvals: [], plurality: 0 });
    tally();
});
canvas.addEventListener('mousemove', (e) => {
    if (dragging) { dragging.x = e.clientX - dragOffset.x; dragging.y = e.clientY - dragOffset.y; tally(); }
});
canvas.addEventListener('mouseup', () => { dragging = null; });

canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    const t = e.touches[0]; const mx = t.clientX, my = t.clientY;
    for (const c of candidates) {
        if (dist({ x: mx, y: my }, c) < c.r + 15) {
            dragging = c; dragOffset.x = mx - c.x; dragOffset.y = my - c.y; return;
        }
    }
    voters.push({ x: mx, y: my, approvals: [], plurality: 0 }); tally();
}, { passive: false });
canvas.addEventListener('touchmove', (e) => {
    e.preventDefault();
    if (dragging) { const t = e.touches[0]; dragging.x = t.clientX - dragOffset.x; dragging.y = t.clientY - dragOffset.y; tally(); }
}, { passive: false });
canvas.addEventListener('touchend', () => { dragging = null; });

window.addEventListener('resize', resize);

window.reset = function() {
    cancelAnimationFrame(animFrame);
    voters = []; mode = 'honest'; approvalRadius = 150;
    document.getElementById('radiusSlider').value = 150;
    document.getElementById('radiusVal').textContent = '150';
    document.getElementById('btnHonest').className = 'btn active';
    document.getElementById('btnStrategic').className = 'btn';
    resize(); initCandidates(); tally(); draw();
};

resize(); initCandidates(); addRandomVoters(80); draw();
</script>
<script src="../assets/js/enhance.js"></script>
</body>
</html>
