<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Score & STAR Voting</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; color: #e0e0e0; font-family: 'Segoe UI', system-ui, sans-serif; overflow: hidden; }
canvas { display: block; }
#controls {
    position: fixed; top: 10px; right: 10px; width: 340px;
    background: rgba(20,20,40,0.85); backdrop-filter: blur(10px);
    border-radius: 12px; padding: 16px; z-index: 10;
    border: 1px solid rgba(100,140,200,0.3);
    max-height: 92vh; overflow-y: auto;
}
#info {
    position: fixed; bottom: 10px; left: 10px; max-width: 380px;
    background: rgba(20,20,40,0.85); backdrop-filter: blur(10px);
    border-radius: 12px; padding: 16px; z-index: 10;
    border: 1px solid rgba(100,140,200,0.3); font-size: 13px; line-height: 1.5;
}
h3 { color: #7eb8f0; margin-bottom: 8px; font-size: 15px; }
h4 { color: #a0c0e0; margin: 10px 0 6px; font-size: 13px; }
label { display: block; margin: 6px 0 3px; font-size: 12px; color: #a0b4d0; }
button {
    background: rgba(60,80,140,0.6); color: #c0d4f0; border: 1px solid rgba(100,140,200,0.4);
    border-radius: 6px; padding: 6px 14px; cursor: pointer; font-size: 12px; margin: 3px 2px;
    transition: background 0.2s;
}
button:hover { background: rgba(80,110,180,0.7); }
.ballot-row { display: flex; align-items: center; gap: 6px; margin: 5px 0; }
.ballot-row .cname { min-width: 70px; font-size: 13px; }
.star-btn {
    width: 24px; height: 24px; background: none; border: none; cursor: pointer;
    color: #555; font-size: 18px; padding: 0; margin: 0; transition: color 0.15s;
}
.star-btn.filled { color: #f0c040; }
.star-btn:hover { color: #f0d070; }
.result-line { font-size: 12px; margin: 3px 0; color: #b0c4e0; }
.winner { color: #50d890; font-weight: bold; }
a { color: #7eb8f0; text-decoration: none; }
a:hover { text-decoration: underline; }
#backLink { position: fixed; top: 10px; left: 10px; z-index: 20; font-size: 13px; }
input[type="number"] {
    background: rgba(50,60,90,0.5); border: 1px solid rgba(100,140,200,0.3);
    border-radius: 4px; color: #e0e0e0; padding: 4px 8px; font-size: 13px; width: 60px;
}
</style>
</head>
<body>
<a id="backLink" href="index.html">&#8592; Back</a>
<canvas id="canvas"></canvas>

<div id="controls">
    <h3>Score & STAR Voting</h3>
    <h4>Your Ballot (rate 0-5)</h4>
    <div id="ballotArea"></div>
    <h4>Simulation</h4>
    <label>Number of random voters:</label>
    <input type="number" id="numVoters" value="100" min="10" max="1000">
    <button id="runSim" style="margin-top:6px;">Run Simulation</button>
    <button id="resetBtn">Reset</button>
    <div id="resultsArea" style="margin-top:10px;"></div>
</div>

<div id="info">
    <h3>Score & STAR Voting</h3>
    <p><strong>Score:</strong> Rate each candidate 0-5. Highest total score wins.</p>
    <p style="margin-top:4px;"><strong>STAR:</strong> Score + Automatic Runoff. Top 2 by score, then head-to-head using the same ballots.</p>
    <p style="margin-top:4px;">STAR resists strategic "bullet voting" better than pure Score.</p>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let W, H;

const candidates = [
    { name: 'Alice', color: '#4e9af0' },
    { name: 'Bob', color: '#f0c040' },
    { name: 'Carlos', color: '#50d890' },
    { name: 'Diana', color: '#f06070' },
    { name: 'Eve', color: '#b070f0' }
];

let userBallot = [4, 2, 5, 1, 3];
let simVoters = [];
let results = null;
let animProgress = 0;

function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

function renderBallot() {
    const area = document.getElementById('ballotArea');
    area.innerHTML = '';
    candidates.forEach((c, ci) => {
        const row = document.createElement('div');
        row.className = 'ballot-row';
        let html = `<span class="cname" style="color:${c.color}">${c.name}</span>`;
        for (let s = 0; s <= 5; s++) {
            const filled = s <= userBallot[ci] && s > 0;
            html += `<button class="star-btn ${filled ? 'filled' : ''}" onclick="setScore(${ci},${s})">${s === 0 ? '0' : '\u2605'}</button>`;
        }
        html += `<span style="font-size:11px;color:#8899bb;margin-left:4px;">${userBallot[ci]}</span>`;
        row.innerHTML = html;
        area.appendChild(row);
    });
}

window.setScore = function(ci, score) {
    userBallot[ci] = score;
    renderBallot();
};

function generateVoters(n) {
    const voters = [];
    // Generate clustered preferences
    const archetypes = [
        [5,1,3,0,2],
        [1,5,2,3,1],
        [2,2,5,1,4],
        [0,3,1,5,2],
        [3,1,4,2,5]
    ];
    for (let i = 0; i < n; i++) {
        const base = archetypes[Math.floor(Math.random() * archetypes.length)];
        const ballot = base.map(v => Math.max(0, Math.min(5, v + Math.floor(Math.random() * 3) - 1)));
        voters.push(ballot);
    }
    return voters;
}

function computeResults(allBallots) {
    const n = candidates.length;
    const totalBallots = allBallots.length;

    // Score totals
    const scoreTotals = new Array(n).fill(0);
    allBallots.forEach(ballot => {
        ballot.forEach((s, i) => { scoreTotals[i] += s; });
    });
    const scoreAvg = scoreTotals.map(s => s / totalBallots);

    // Score winner
    let scoreWinner = 0;
    scoreAvg.forEach((s, i) => { if (s > scoreAvg[scoreWinner]) scoreWinner = i; });

    // STAR: top 2 by score
    const ranked = scoreAvg.map((s, i) => ({i, s})).sort((a, b) => b.s - a.s);
    const top2 = [ranked[0].i, ranked[1].i];

    // Head to head
    let h2h = [0, 0];
    allBallots.forEach(ballot => {
        if (ballot[top2[0]] > ballot[top2[1]]) h2h[0]++;
        else if (ballot[top2[1]] > ballot[top2[0]]) h2h[1]++;
    });
    const starWinner = h2h[0] >= h2h[1] ? top2[0] : top2[1];

    // Plurality (highest score = first choice proxy)
    const pluralityVotes = new Array(n).fill(0);
    allBallots.forEach(ballot => {
        let best = 0;
        ballot.forEach((s, i) => { if (s > ballot[best]) best = i; });
        pluralityVotes[best]++;
    });
    let pluralityWinner = 0;
    pluralityVotes.forEach((v, i) => { if (v > pluralityVotes[pluralityWinner]) pluralityWinner = i; });

    return {
        scoreAvg, scoreWinner, scoreTotals,
        top2, h2h, starWinner,
        pluralityVotes, pluralityWinner,
        totalBallots
    };
}

document.getElementById('runSim').addEventListener('click', () => {
    const nVoters = parseInt(document.getElementById('numVoters').value) || 100;
    simVoters = generateVoters(nVoters);
    const allBallots = [userBallot, ...simVoters];
    results = computeResults(allBallots);
    animProgress = 0;
    renderResults();
});

function renderResults() {
    if (!results) return;
    const area = document.getElementById('resultsArea');
    let html = '<h4>Results</h4>';
    html += `<div class="result-line">Total ballots: ${results.totalBallots}</div>`;
    html += '<h4>Score Averages</h4>';
    candidates.forEach((c, i) => {
        const isWinner = i === results.scoreWinner;
        html += `<div class="result-line ${isWinner ? 'winner' : ''}">
            ${c.name}: ${results.scoreAvg[i].toFixed(2)} ${isWinner ? '(Score Winner)' : ''}</div>`;
    });
    html += '<h4>STAR Runoff</h4>';
    html += `<div class="result-line">${candidates[results.top2[0]].name} vs ${candidates[results.top2[1]].name}</div>`;
    html += `<div class="result-line">${results.h2h[0]} vs ${results.h2h[1]}</div>`;
    html += `<div class="result-line winner">STAR Winner: ${candidates[results.starWinner].name}</div>`;
    html += '<h4>Plurality</h4>';
    html += `<div class="result-line winner">Plurality Winner: ${candidates[results.pluralityWinner].name}</div>`;

    if (results.scoreWinner !== results.starWinner || results.scoreWinner !== results.pluralityWinner) {
        html += '<div style="color:#f0c040;font-size:12px;margin-top:6px;padding:6px;background:rgba(240,192,64,0.1);border-radius:6px;">Different methods chose different winners!</div>';
    }
    area.innerHTML = html;
}

function draw() {
    ctx.clearRect(0, 0, W, H);

    // Grid
    ctx.strokeStyle = 'rgba(60,80,120,0.12)';
    for (let x = 0; x < W; x += 40) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke(); }
    for (let y = 0; y < H; y += 40) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke(); }

    animProgress = Math.min(animProgress + 0.015, 1);

    const n = candidates.length;

    // Title
    ctx.fillStyle = '#c0d4f0';
    ctx.font = 'bold 20px system-ui';
    ctx.textAlign = 'center';
    ctx.fillText('Score & STAR Voting Comparison', W * 0.35, 45);

    if (!results) {
        ctx.fillStyle = '#6080a0';
        ctx.font = '16px system-ui';
        ctx.fillText('Set your ballot and run simulation to see results', W * 0.35, H / 2);
        requestAnimationFrame(draw);
        return;
    }

    const chartLeft = 80;
    const chartRight = Math.min(W - 380, W * 0.58);
    const chartW = chartRight - chartLeft;
    const chartTop = 80;

    // Score averages bar chart
    const barH = 30;
    const rowGap = 50;

    ctx.fillStyle = '#a0b8d0';
    ctx.font = 'bold 14px system-ui';
    ctx.textAlign = 'left';
    ctx.fillText('Score Averages (0-5)', chartLeft, chartTop);

    for (let i = 0; i < n; i++) {
        const y = chartTop + 20 + i * rowGap;
        const avgNorm = (results.scoreAvg[i] / 5) * animProgress;

        // Name
        ctx.fillStyle = candidates[i].color;
        ctx.font = '13px system-ui';
        ctx.textAlign = 'right';
        ctx.fillText(candidates[i].name, chartLeft - 10, y + barH / 2 + 5);

        // Bar
        ctx.fillStyle = candidates[i].color;
        ctx.globalAlpha = 0.6;
        ctx.fillRect(chartLeft, y, chartW * avgNorm, barH);
        ctx.globalAlpha = 1;

        // Stars
        const stars = Math.round(results.scoreAvg[i]);
        ctx.font = '14px system-ui';
        ctx.textAlign = 'left';
        ctx.fillStyle = '#f0c040';
        let starStr = '';
        for (let s = 0; s < 5; s++) starStr += s < stars ? '\u2605' : '\u2606';
        ctx.fillText(starStr + ' ' + results.scoreAvg[i].toFixed(2), chartLeft + chartW * avgNorm + 8, y + barH / 2 + 5);

        // Winner marker
        if (i === results.scoreWinner) {
            ctx.fillStyle = '#50d890';
            ctx.font = 'bold 11px system-ui';
            ctx.fillText('SCORE WINNER', chartLeft + chartW * avgNorm + 100, y + barH / 2 + 5);
        }
    }

    // STAR Runoff
    const runoffY = chartTop + 20 + n * rowGap + 30;
    ctx.fillStyle = '#a0b8d0';
    ctx.font = 'bold 14px system-ui';
    ctx.textAlign = 'left';
    ctx.fillText('STAR Runoff', chartLeft, runoffY);

    const c1 = results.top2[0], c2 = results.top2[1];
    const total = results.h2h[0] + results.h2h[1] || 1;
    const frac1 = results.h2h[0] / total * animProgress;
    const frac2 = results.h2h[1] / total * animProgress;

    const ry = runoffY + 20;
    const rbarH = 40;

    // Two-tone bar
    ctx.fillStyle = candidates[c1].color;
    ctx.globalAlpha = 0.7;
    ctx.fillRect(chartLeft, ry, chartW * frac1, rbarH);
    ctx.fillStyle = candidates[c2].color;
    ctx.fillRect(chartLeft + chartW * frac1, ry, chartW * frac2, rbarH);
    ctx.globalAlpha = 1;

    // Labels
    ctx.font = 'bold 13px system-ui';
    ctx.textAlign = 'left';
    ctx.fillStyle = '#fff';
    ctx.fillText(`${candidates[c1].name}: ${results.h2h[0]}`, chartLeft + 8, ry + rbarH / 2 + 5);
    ctx.textAlign = 'right';
    ctx.fillText(`${candidates[c2].name}: ${results.h2h[1]}`, chartLeft + chartW - 8, ry + rbarH / 2 + 5);

    // STAR winner
    ctx.fillStyle = '#50d890';
    ctx.font = 'bold 13px system-ui';
    ctx.textAlign = 'center';
    ctx.fillText('STAR Winner: ' + candidates[results.starWinner].name, (chartLeft + chartRight) / 2, ry + rbarH + 25);

    // Plurality
    const pY = ry + rbarH + 55;
    ctx.fillStyle = '#a0b8d0';
    ctx.font = 'bold 14px system-ui';
    ctx.textAlign = 'left';
    ctx.fillText('Plurality Votes', chartLeft, pY);

    const maxPlural = Math.max(...results.pluralityVotes, 1);
    for (let i = 0; i < n; i++) {
        const y2 = pY + 15 + i * 28;
        const norm = (results.pluralityVotes[i] / maxPlural) * animProgress;
        ctx.fillStyle = candidates[i].color;
        ctx.globalAlpha = 0.5;
        ctx.fillRect(chartLeft, y2, chartW * 0.6 * norm, 20);
        ctx.globalAlpha = 1;
        ctx.font = '12px system-ui';
        ctx.textAlign = 'right';
        ctx.fillStyle = candidates[i].color;
        ctx.fillText(candidates[i].name, chartLeft - 10, y2 + 15);
        ctx.textAlign = 'left';
        ctx.fillStyle = '#b0c4e0';
        ctx.fillText(results.pluralityVotes[i].toString(), chartLeft + chartW * 0.6 * norm + 8, y2 + 15);
        if (i === results.pluralityWinner) {
            ctx.fillStyle = '#50d890';
            ctx.font = 'bold 11px system-ui';
            ctx.fillText('PLURALITY WINNER', chartLeft + chartW * 0.6 * norm + 40, y2 + 15);
        }
    }

    requestAnimationFrame(draw);
}

window.reset = function() {
    userBallot = [4, 2, 5, 1, 3];
    simVoters = [];
    results = null;
    animProgress = 0;
    document.getElementById('numVoters').value = '100';
    document.getElementById('resultsArea').innerHTML = '';
    renderBallot();
};

renderBallot();
draw();
</script>
<script src="../assets/js/enhance.js"></script>
</body>
</html>
