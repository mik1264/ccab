<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duffing Oscillator - Chaotic Strange Attractor - CCAB</title>
    <meta name="description" content="Interactive Duffing oscillator visualization showing chaotic dynamics and strange attractors. Explore period doubling route to chaos with Poincaré sections.">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #0a1a0a 0%, #1a2e1a 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }

        .back-link {
            position: fixed;
            top: 15px;
            left: 15px;
            padding: 10px 18px;
            background: rgba(0, 0, 0, 0.6);
            color: #4caf50;
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(76, 175, 80, 0.3);
            transition: all 0.3s ease;
        }

        .back-link:hover {
            background: rgba(76, 175, 80, 0.2);
            transform: translateX(-4px);
        }

        .main-container {
            display: flex;
            height: 100vh;
            padding: 80px 20px 100px;
            gap: 20px;
        }

        .canvas-container {
            flex: 1;
            display: flex;
            gap: 20px;
        }

        .viz-panel {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .viz-panel h4 {
            color: #4caf50;
            margin-bottom: 10px;
            font-size: 14px;
            text-align: center;
        }

        canvas {
            flex: 1;
            width: 100%;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.5);
        }

        #info {
            position: fixed;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.85);
            padding: 15px 20px;
            border-radius: 12px;
            color: #4caf50;
            font-size: 13px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(76, 175, 80, 0.2);
            z-index: 1000;
            max-width: 280px;
        }

        #info h3 {
            margin-bottom: 10px;
            color: #81c784;
        }

        #info .stat {
            margin: 5px 0;
        }

        #info .stat-label {
            color: #888;
            font-size: 11px;
        }

        #info .stat-value {
            color: #4caf50;
            font-weight: bold;
        }

        #info p {
            font-size: 11px;
            opacity: 0.8;
            line-height: 1.5;
            margin-top: 10px;
            color: #aaa;
        }

        .equation {
            background: rgba(76, 175, 80, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-family: 'Times New Roman', serif;
            font-style: italic;
            text-align: center;
            color: #81c784;
            font-size: 12px;
        }

        #controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            z-index: 1000;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-group {
            background: rgba(0, 0, 0, 0.7);
            padding: 12px 16px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(76, 175, 80, 0.2);
        }

        .control-group label {
            color: #4caf50;
            font-size: 11px;
            display: block;
            margin-bottom: 5px;
        }

        .control-group input[type="range"] {
            width: 90px;
            accent-color: #4caf50;
        }

        .control-group span {
            color: #fff;
            font-size: 10px;
            margin-left: 6px;
        }

        button {
            background: rgba(76, 175, 80, 0.15);
            border: 1px solid rgba(76, 175, 80, 0.4);
            color: #4caf50;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        button:hover {
            background: rgba(76, 175, 80, 0.3);
        }

        button.active {
            background: rgba(76, 175, 80, 0.4);
            border-color: #4caf50;
        }

        #fps-display {
            position: fixed;
            bottom: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 12px;
            border-radius: 6px;
            color: #4caf50;
            font-size: 12px;
            z-index: 1000;
        }

        #presets {
            position: fixed;
            top: 280px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            z-index: 1000;
        }

        #presets button {
            font-size: 11px;
            padding: 8px 12px;
        }

        @media (max-width: 1000px) {
            .canvas-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <a href="../index.html" class="back-link">← Back to Gallery</a>

    <div class="main-container">
        <div class="canvas-container">
            <div class="viz-panel" style="flex: 1.2;">
                <h4>Phase Portrait / Strange Attractor</h4>
                <canvas id="phaseCanvas"></canvas>
            </div>
            <div class="viz-panel">
                <h4>Poincaré Section</h4>
                <canvas id="poincareCanvas"></canvas>
            </div>
            <div class="viz-panel">
                <h4>Time Series</h4>
                <canvas id="timeCanvas"></canvas>
            </div>
        </div>
    </div>

    <div id="info">
        <h3>Duffing Oscillator</h3>
        <div class="stat">
            <span class="stat-label">Forcing γ</span>
            <span class="stat-value" id="gamma-display">0.30</span>
        </div>
        <div class="stat">
            <span class="stat-label">Damping δ</span>
            <span class="stat-value" id="delta-display">0.20</span>
        </div>
        <div class="stat">
            <span class="stat-label">Driving ω</span>
            <span class="stat-value" id="omega-display">1.00</span>
        </div>
        <div class="stat">
            <span class="stat-label">Behavior</span>
            <span class="stat-value" id="behavior">Chaotic</span>
        </div>
        <div class="equation">
            ẍ + δẋ − x + x³ = γcos(ωt)
        </div>
        <p>Discovered by Georg Duffing in 1918. The double-well potential creates chaos through stretching and folding of phase space trajectories.</p>
    </div>

    <div id="presets">
        <button data-preset="periodic">Periodic</button>
        <button data-preset="period2">Period-2</button>
        <button data-preset="chaotic" class="active">Chaotic</button>
        <button data-preset="chaos2">High Chaos</button>
    </div>

    <div id="controls">
        <div class="control-group">
            <label>Forcing γ: <span id="gamma-val">0.30</span></label>
            <input type="range" id="gamma-slider" min="0" max="0.6" step="0.01" value="0.30">
        </div>
        <div class="control-group">
            <label>Damping δ: <span id="delta-val">0.20</span></label>
            <input type="range" id="delta-slider" min="0" max="0.5" step="0.01" value="0.20">
        </div>
        <div class="control-group">
            <label>Frequency ω: <span id="omega-val">1.00</span></label>
            <input type="range" id="omega-slider" min="0.5" max="2" step="0.05" value="1.00">
        </div>
        <div class="control-group">
            <label>Speed: <span id="speed-val">1.0</span>x</label>
            <input type="range" id="speed-slider" min="0.5" max="3" step="0.1" value="1">
        </div>
        <button id="reset-btn">Reset</button>
        <button id="clear-btn">Clear</button>
        <button id="pause-btn">Pause</button>
    </div>

    <div id="fps-display">FPS: <span id="fps">0</span></div>

    <script>
        // Canvas setup
        const phaseCanvas = document.getElementById('phaseCanvas');
        const poincareCanvas = document.getElementById('poincareCanvas');
        const timeCanvas = document.getElementById('timeCanvas');
        const phaseCtx = phaseCanvas.getContext('2d');
        const poincareCtx = poincareCanvas.getContext('2d');
        const timeCtx = timeCanvas.getContext('2d');

        function resizeCanvases() {
            const panels = document.querySelectorAll('.viz-panel');
            panels.forEach((panel) => {
                const canvas = panel.querySelector('canvas');
                const rect = panel.getBoundingClientRect();
                canvas.width = rect.width - 30;
                canvas.height = rect.height - 50;
            });
            clearCanvases();
        }

        function clearCanvases() {
            [phaseCtx, poincareCtx, timeCtx].forEach(ctx => {
                ctx.fillStyle = 'rgba(0, 0, 0, 1)';
                ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            });
        }

        // Duffing parameters
        let gamma = 0.30;    // Forcing amplitude
        let delta = 0.20;    // Damping
        let omega = 1.0;     // Driving frequency
        let alpha = -1;      // Linear stiffness (negative for double well)
        let beta = 1;        // Nonlinear stiffness

        let speed = 1.0;
        let running = true;

        // State
        let x = 0.5;         // Position
        let v = 0.0;         // Velocity
        let t = 0;           // Time
        const dt = 0.005;

        // History
        const phaseHistory = [];
        const poincarePoints = [];
        const timeHistory = [];
        const maxHistory = 5000;
        const maxTimeHistory = 500;
        let lastPoincarePhase = 0;

        // Duffing equation: ẍ + δẋ + αx + βx³ = γcos(ωt)
        // State form: dx/dt = v, dv/dt = -δv - αx - βx³ + γcos(ωt)
        function derivative(x, v, t) {
            return {
                dx: v,
                dv: -delta * v - alpha * x - beta * x * x * x + gamma * Math.cos(omega * t)
            };
        }

        // RK4 integration
        function rk4Step(x, v, t, h) {
            const k1 = derivative(x, v, t);
            const k2 = derivative(x + h/2 * k1.dx, v + h/2 * k1.dv, t + h/2);
            const k3 = derivative(x + h/2 * k2.dx, v + h/2 * k2.dv, t + h/2);
            const k4 = derivative(x + h * k3.dx, v + h * k3.dv, t + h);

            return {
                x: x + h/6 * (k1.dx + 2*k2.dx + 2*k3.dx + k4.dx),
                v: v + h/6 * (k1.dv + 2*k2.dv + 2*k3.dv + k4.dv)
            };
        }

        // Update simulation
        function update() {
            const steps = Math.round(speed * 10);

            for (let s = 0; s < steps; s++) {
                const result = rk4Step(x, v, t, dt);
                x = result.x;
                v = result.v;
                t += dt;

                // Store phase history
                phaseHistory.push({ x, v });
                if (phaseHistory.length > maxHistory) phaseHistory.shift();

                // Store time history
                timeHistory.push({ t, x });
                if (timeHistory.length > maxTimeHistory) timeHistory.shift();

                // Poincaré section: sample when driving force phase crosses 0
                const phase = (omega * t) % (2 * Math.PI);
                if (lastPoincarePhase > Math.PI && phase < Math.PI) {
                    poincarePoints.push({ x, v });
                    if (poincarePoints.length > 2000) poincarePoints.shift();
                }
                lastPoincarePhase = phase;
            }
        }

        // Draw phase portrait
        function drawPhase() {
            const w = phaseCanvas.width;
            const h = phaseCanvas.height;
            const cx = w / 2;
            const cy = h / 2;
            const scale = Math.min(w, h) / 6;

            // Fade effect
            phaseCtx.fillStyle = 'rgba(0, 0, 0, 0.02)';
            phaseCtx.fillRect(0, 0, w, h);

            // Draw potential wells (fixed points at x = ±1)
            phaseCtx.fillStyle = 'rgba(76, 175, 80, 0.3)';
            phaseCtx.beginPath();
            phaseCtx.arc(cx + 1 * scale, cy, 5, 0, 2 * Math.PI);
            phaseCtx.fill();
            phaseCtx.beginPath();
            phaseCtx.arc(cx - 1 * scale, cy, 5, 0, 2 * Math.PI);
            phaseCtx.fill();

            // Draw recent trajectory
            if (phaseHistory.length > 1) {
                const startIdx = Math.max(0, phaseHistory.length - 1000);
                phaseCtx.strokeStyle = '#4caf50';
                phaseCtx.lineWidth = 1;
                phaseCtx.beginPath();

                for (let i = startIdx; i < phaseHistory.length; i++) {
                    const pt = phaseHistory[i];
                    const px = cx + pt.x * scale;
                    const py = cy - pt.v * scale;

                    if (i === startIdx) {
                        phaseCtx.moveTo(px, py);
                    } else {
                        phaseCtx.lineTo(px, py);
                    }
                }
                phaseCtx.stroke();
            }

            // Draw current position
            phaseCtx.fillStyle = '#fff';
            phaseCtx.beginPath();
            phaseCtx.arc(cx + x * scale, cy - v * scale, 4, 0, 2 * Math.PI);
            phaseCtx.fill();

            // Axis labels
            phaseCtx.fillStyle = 'rgba(76, 175, 80, 0.5)';
            phaseCtx.font = '11px sans-serif';
            phaseCtx.fillText('x', w - 15, cy - 5);
            phaseCtx.fillText('ẋ', cx + 5, 15);
        }

        // Draw Poincaré section
        function drawPoincare() {
            const w = poincareCanvas.width;
            const h = poincareCanvas.height;
            const cx = w / 2;
            const cy = h / 2;
            const scale = Math.min(w, h) / 5;

            // Clear with slight fade
            poincareCtx.fillStyle = 'rgba(0, 0, 0, 0.01)';
            poincareCtx.fillRect(0, 0, w, h);

            // Draw axes
            poincareCtx.strokeStyle = 'rgba(76, 175, 80, 0.2)';
            poincareCtx.lineWidth = 1;
            poincareCtx.beginPath();
            poincareCtx.moveTo(0, cy);
            poincareCtx.lineTo(w, cy);
            poincareCtx.moveTo(cx, 0);
            poincareCtx.lineTo(cx, h);
            poincareCtx.stroke();

            // Draw Poincaré points
            poincarePoints.forEach((pt, i) => {
                const age = i / poincarePoints.length;
                poincareCtx.fillStyle = `rgba(76, 175, 80, ${0.3 + age * 0.7})`;
                poincareCtx.beginPath();
                poincareCtx.arc(cx + pt.x * scale, cy - pt.v * scale, 2, 0, 2 * Math.PI);
                poincareCtx.fill();
            });

            // Labels
            poincareCtx.fillStyle = 'rgba(76, 175, 80, 0.5)';
            poincareCtx.font = '10px sans-serif';
            poincareCtx.fillText('x', w - 12, cy - 5);
            poincareCtx.fillText('ẋ', cx + 5, 12);
        }

        // Draw time series
        function drawTime() {
            const w = timeCanvas.width;
            const h = timeCanvas.height;

            timeCtx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            timeCtx.fillRect(0, 0, w, h);

            if (timeHistory.length < 2) return;

            const scale = h / 6;

            // Draw zero line
            timeCtx.strokeStyle = 'rgba(76, 175, 80, 0.2)';
            timeCtx.lineWidth = 1;
            timeCtx.beginPath();
            timeCtx.moveTo(0, h/2);
            timeCtx.lineTo(w, h/2);
            timeCtx.stroke();

            // Draw ±1 reference lines (potential well minima)
            timeCtx.setLineDash([5, 5]);
            timeCtx.beginPath();
            timeCtx.moveTo(0, h/2 - scale);
            timeCtx.lineTo(w, h/2 - scale);
            timeCtx.moveTo(0, h/2 + scale);
            timeCtx.lineTo(w, h/2 + scale);
            timeCtx.stroke();
            timeCtx.setLineDash([]);

            // Draw x(t)
            timeCtx.strokeStyle = '#4caf50';
            timeCtx.lineWidth = 1.5;
            timeCtx.beginPath();

            for (let i = 0; i < timeHistory.length; i++) {
                const pt = timeHistory[i];
                const px = (i / maxTimeHistory) * w;
                const py = h/2 - pt.x * scale;

                if (i === 0) {
                    timeCtx.moveTo(px, py);
                } else {
                    timeCtx.lineTo(px, py);
                }
            }
            timeCtx.stroke();

            // Labels
            timeCtx.fillStyle = 'rgba(76, 175, 80, 0.5)';
            timeCtx.font = '10px sans-serif';
            timeCtx.fillText('x(t)', w - 25, h/2 - scale - 5);
            timeCtx.fillText('t', w - 12, h - 5);
        }

        // Update stats
        function updateStats() {
            document.getElementById('gamma-display').textContent = gamma.toFixed(2);
            document.getElementById('delta-display').textContent = delta.toFixed(2);
            document.getElementById('omega-display').textContent = omega.toFixed(2);

            // Estimate behavior from Poincaré section
            let behavior = 'Unknown';
            if (poincarePoints.length > 50) {
                // Count distinct clusters
                const spread = Math.max(...poincarePoints.map(p => Math.abs(p.x))) -
                               Math.min(...poincarePoints.map(p => Math.abs(p.x)));
                if (spread < 0.1) {
                    behavior = 'Periodic';
                } else if (spread < 0.5) {
                    behavior = 'Quasi-periodic';
                } else {
                    behavior = 'Chaotic';
                }
            }
            document.getElementById('behavior').textContent = behavior;
        }

        // FPS tracking
        let lastTime = 0;
        let frameCount = 0;
        let fps = 0;

        // Animation loop
        function animate(currentTime) {
            requestAnimationFrame(animate);

            // FPS calculation
            frameCount++;
            if (currentTime - lastTime >= 1000) {
                fps = frameCount;
                frameCount = 0;
                lastTime = currentTime;
                document.getElementById('fps').textContent = fps;
            }

            if (running) {
                update();
                drawPhase();
                drawPoincare();
                drawTime();
                updateStats();
            }
        }

        // Preset parameters
        const presets = {
            periodic: { gamma: 0.20, delta: 0.25, omega: 1.0 },
            period2: { gamma: 0.28, delta: 0.20, omega: 1.0 },
            chaotic: { gamma: 0.30, delta: 0.20, omega: 1.0 },
            chaos2: { gamma: 0.50, delta: 0.15, omega: 1.2 }
        };

        // Event listeners
        document.getElementById('gamma-slider').addEventListener('input', (e) => {
            gamma = parseFloat(e.target.value);
            document.getElementById('gamma-val').textContent = gamma.toFixed(2);
        });

        document.getElementById('delta-slider').addEventListener('input', (e) => {
            delta = parseFloat(e.target.value);
            document.getElementById('delta-val').textContent = delta.toFixed(2);
        });

        document.getElementById('omega-slider').addEventListener('input', (e) => {
            omega = parseFloat(e.target.value);
            document.getElementById('omega-val').textContent = omega.toFixed(2);
        });

        document.getElementById('speed-slider').addEventListener('input', (e) => {
            speed = parseFloat(e.target.value);
            document.getElementById('speed-val').textContent = speed.toFixed(1);
        });

        document.getElementById('reset-btn').addEventListener('click', () => {
            x = 0.5;
            v = 0;
            t = 0;
            phaseHistory.length = 0;
            poincarePoints.length = 0;
            timeHistory.length = 0;
            clearCanvases();
        });

        document.getElementById('clear-btn').addEventListener('click', () => {
            phaseHistory.length = 0;
            poincarePoints.length = 0;
            timeHistory.length = 0;
            clearCanvases();
        });

        document.getElementById('pause-btn').addEventListener('click', () => {
            running = !running;
            document.getElementById('pause-btn').textContent = running ? 'Pause' : 'Resume';
        });

        // Preset buttons
        document.querySelectorAll('#presets button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('#presets button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const preset = presets[btn.dataset.preset];
                gamma = preset.gamma;
                delta = preset.delta;
                omega = preset.omega;

                document.getElementById('gamma-slider').value = gamma;
                document.getElementById('delta-slider').value = delta;
                document.getElementById('omega-slider').value = omega;
                document.getElementById('gamma-val').textContent = gamma.toFixed(2);
                document.getElementById('delta-val').textContent = delta.toFixed(2);
                document.getElementById('omega-val').textContent = omega.toFixed(2);

                // Reset state
                x = 0.5;
                v = 0;
                t = 0;
                phaseHistory.length = 0;
                poincarePoints.length = 0;
                timeHistory.length = 0;
                clearCanvases();
            });
        });

        // Initialize
        window.addEventListener('resize', resizeCanvases);
        resizeCanvases();
        animate(0);
    </script>
</body>
</html>
