<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>String Vibration | Music Acoustics</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            overflow: hidden;
        }
        #canvas { display: block; cursor: pointer; }
        .controls {
            position: fixed;
            top: 20px; right: 20px;
            background: rgba(0,0,0,0.85);
            padding: 20px; border-radius: 15px;
            min-width: 280px;
            border: 1px solid rgba(251, 146, 60, 0.3);
        }
        h1 { color: #fb923c; font-size: 1.3em; margin-bottom: 15px; }
        .control-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; color: #aaa; font-size: 0.9em; }
        input[type="range"], select { width: 100%; }
        .value { float: right; color: #fb923c; }
        button {
            width: 100%; padding: 10px; margin: 5px 0;
            border: none; border-radius: 8px;
            background: #fb923c; color: white;
            font-weight: bold; cursor: pointer;
        }
        button:hover { background: #fdba74; }
        .mode-btns { display: flex; gap: 5px; flex-wrap: wrap; }
        .mode-btn {
            flex: 1; min-width: 50px; padding: 8px;
            background: #333; border: 1px solid #fb923c;
            color: #fb923c; border-radius: 5px;
            cursor: pointer; font-size: 0.9em;
        }
        .mode-btn.active { background: #fb923c; color: white; }
        .stats { margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); }
        .stat-row { display: flex; justify-content: space-between; padding: 5px 0; font-size: 0.9em; }
        .stat-label { color: #888; }
        .stat-value { color: #fb923c; font-weight: bold; }
        .info { font-size: 0.8em; color: #666; margin-top: 15px; line-height: 1.5; }
        a.back-link {
            position: fixed; top: 20px; left: 20px;
            color: #fb923c; text-decoration: none;
            background: rgba(0,0,0,0.8); padding: 10px 20px;
            border-radius: 25px; font-size: 0.9em;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <a href="index.html" class="back-link">← Back to Music Acoustics</a>

    <div class="controls">
        <h1>String Vibration</h1>
        <p style="font-size:0.85em; color:#888; margin-bottom:15px;">Standing wave modes</p>

        <div class="control-group">
            <label>Vibration Mode (Harmonic)</label>
            <div class="mode-btns">
                <button class="mode-btn active" data-mode="1">1</button>
                <button class="mode-btn" data-mode="2">2</button>
                <button class="mode-btn" data-mode="3">3</button>
                <button class="mode-btn" data-mode="4">4</button>
                <button class="mode-btn" data-mode="5">5</button>
                <button class="mode-btn" data-mode="6">6</button>
            </div>
        </div>

        <div class="control-group">
            <label>Fundamental Frequency: <span class="value" id="freqValue">110</span> Hz</label>
            <input type="range" id="fundamental" min="55" max="440" step="1" value="110">
        </div>

        <div class="control-group">
            <label>Damping: <span class="value" id="dampValue">0.02</span></label>
            <input type="range" id="damping" min="0" max="0.1" step="0.005" value="0.02">
        </div>

        <div class="control-group">
            <label>String Tension</label>
            <select id="tension">
                <option value="low">Low (loose)</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High (tight)</option>
            </select>
        </div>

        <button id="pluckBtn">Pluck String</button>
        <button id="playBtn">Play Sound</button>
        <button id="resetBtn" style="background:#444">Reset</button>

        <div class="stats">
            <div class="stat-row">
                <span class="stat-label">Mode Frequency</span>
                <span class="stat-value" id="modeFreq">110 Hz</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Wavelength</span>
                <span class="stat-value" id="wavelength">2L</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Nodes</span>
                <span class="stat-value" id="nodes">2</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Antinodes</span>
                <span class="stat-value" id="antinodes">1</span>
            </div>
        </div>

        <div class="info">
            <strong>Click on string</strong> to pluck at that position.<br>
            <strong>Modes:</strong> Integer wavelengths that fit in string.<br>
            <strong>Formula:</strong> fₙ = n × f₁
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resize();
        window.onresize = resize;

        let mode = 1;
        let fundamental = 110;
        let damping = 0.02;
        let amplitude = 0;
        let time = 0;
        let pluckPosition = 0.5;
        let audioCtx = null;
        let isPlaying = false;
        let oscillator = null;

        const stringLength = 600;
        const numPoints = 200;

        function updateStats() {
            const modeFreq = mode * fundamental;
            document.getElementById('modeFreq').textContent = modeFreq + ' Hz';
            document.getElementById('wavelength').textContent = `2L/${mode}`;
            document.getElementById('nodes').textContent = mode + 1;
            document.getElementById('antinodes').textContent = mode;
        }

        function pluck(position) {
            pluckPosition = position;
            amplitude = 1;
            time = 0;
        }

        function getDisplacement(x, t) {
            // Standing wave: sum of modes excited by pluck
            let y = 0;
            const decay = Math.exp(-damping * t * 10);

            // Fourier coefficients based on pluck position
            for (let n = 1; n <= 6; n++) {
                const coeff = (2 / (n * Math.PI)) * Math.sin(n * Math.PI * pluckPosition);
                const modeAmp = n === mode ? 1 : 0.3 * Math.abs(coeff);
                const freq = n * fundamental;
                y += modeAmp * coeff * Math.sin(n * Math.PI * x) * Math.cos(2 * Math.PI * freq * t / 1000);
            }

            return y * amplitude * decay;
        }

        function draw() {
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const centerX = canvas.width / 2 - 100;
            const stringY = 200;
            const startX = (canvas.width - 400 - stringLength) / 2;

            time += 16;
            updateStats();

            ctx.fillStyle = '#fff';
            ctx.font = 'bold 24px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('String Vibration Modes', centerX, 40);

            // Draw bridge/nut
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(startX - 15, stringY - 30, 15, 60);
            ctx.fillRect(startX + stringLength, stringY - 30, 15, 60);

            // Draw string at rest (reference)
            ctx.strokeStyle = 'rgba(255,255,255,0.2)';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(startX, stringY);
            ctx.lineTo(startX + stringLength, stringY);
            ctx.stroke();
            ctx.setLineDash([]);

            // Draw vibrating string
            ctx.beginPath();
            ctx.strokeStyle = '#fb923c';
            ctx.lineWidth = 3;

            for (let i = 0; i <= numPoints; i++) {
                const x = i / numPoints;
                const px = startX + x * stringLength;
                const displacement = getDisplacement(x, time) * 80;
                const py = stringY + displacement;

                if (i === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            }
            ctx.stroke();

            // Draw nodes and antinodes for current mode
            ctx.fillStyle = '#22c55e';
            for (let i = 0; i <= mode; i++) {
                const x = startX + (i / mode) * stringLength;
                ctx.beginPath();
                ctx.arc(x, stringY, 8, 0, Math.PI * 2);
                ctx.fill();
            }

            ctx.fillStyle = '#ef4444';
            for (let i = 0; i < mode; i++) {
                const x = startX + ((i + 0.5) / mode) * stringLength;
                ctx.beginPath();
                ctx.arc(x, stringY, 6, 0, Math.PI * 2);
                ctx.fill();
            }

            // Legend
            ctx.fillStyle = '#22c55e';
            ctx.beginPath();
            ctx.arc(50, stringY + 100, 6, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#888';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('Nodes (zero displacement)', 65, stringY + 104);

            ctx.fillStyle = '#ef4444';
            ctx.beginPath();
            ctx.arc(250, stringY + 100, 6, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#888';
            ctx.fillText('Antinodes (max displacement)', 265, stringY + 104);

            // Draw mode shapes comparison
            const modeY = 380;
            ctx.fillStyle = '#888';
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('Standing Wave Modes:', 50, modeY - 20);

            const modeHeight = 40;
            const modeWidth = (canvas.width - 450) / 3;

            for (let m = 1; m <= 6; m++) {
                const col = (m - 1) % 3;
                const row = Math.floor((m - 1) / 3);
                const mx = 50 + col * (modeWidth + 20);
                const my = modeY + row * (modeHeight + 50);

                // Background
                ctx.fillStyle = m === mode ? 'rgba(251, 146, 60, 0.2)' : 'rgba(0,0,0,0.2)';
                ctx.fillRect(mx, my, modeWidth, modeHeight);

                // Mode shape
                ctx.beginPath();
                ctx.strokeStyle = m === mode ? '#fb923c' : '#666';
                ctx.lineWidth = 2;

                for (let i = 0; i <= 100; i++) {
                    const x = i / 100;
                    const px = mx + x * modeWidth;
                    const py = my + modeHeight / 2 + Math.sin(m * Math.PI * x) * modeHeight / 3;
                    if (i === 0) ctx.moveTo(px, py);
                    else ctx.lineTo(px, py);
                }
                ctx.stroke();

                // Label
                ctx.fillStyle = m === mode ? '#fb923c' : '#888';
                ctx.font = '11px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(`Mode ${m}: f = ${m * fundamental} Hz`, mx + modeWidth / 2, my + modeHeight + 15);
            }

            // Draw waveform over time
            const waveY = canvas.height - 120;
            const waveW = canvas.width - 400;

            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.fillRect(50, waveY - 60, waveW, 60);

            ctx.fillStyle = '#888';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('Displacement at center over time:', 50, waveY - 70);

            ctx.beginPath();
            ctx.strokeStyle = '#fb923c';
            ctx.lineWidth = 2;

            for (let i = 0; i < waveW; i++) {
                const t = i * 10;
                const y = getDisplacement(0.5, time - (waveW - i) * 10) * 25;
                const py = waveY - 30 + y;
                if (i === 0) ctx.moveTo(50 + i, py);
                else ctx.lineTo(50 + i, py);
            }
            ctx.stroke();

            requestAnimationFrame(draw);
        }

        function playSound() {
            if (isPlaying) {
                oscillator.stop();
                isPlaying = false;
                document.getElementById('playBtn').textContent = 'Play Sound';
                return;
            }

            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            oscillator = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            oscillator.frequency.value = mode * fundamental;
            oscillator.type = 'sine';
            gain.gain.value = 0.3;

            oscillator.connect(gain);
            gain.connect(audioCtx.destination);
            oscillator.start();

            isPlaying = true;
            document.getElementById('playBtn').textContent = 'Stop Sound';
        }

        // Event listeners
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                mode = parseInt(btn.dataset.mode);
                if (oscillator) oscillator.frequency.value = mode * fundamental;
            };
        });

        document.getElementById('fundamental').oninput = (e) => {
            fundamental = parseInt(e.target.value);
            document.getElementById('freqValue').textContent = fundamental;
            if (oscillator) oscillator.frequency.value = mode * fundamental;
        };

        document.getElementById('damping').oninput = (e) => {
            damping = parseFloat(e.target.value);
            document.getElementById('dampValue').textContent = damping.toFixed(3);
        };

        document.getElementById('pluckBtn').onclick = () => pluck(0.2 + Math.random() * 0.6);
        document.getElementById('playBtn').onclick = playSound;
        document.getElementById('resetBtn').onclick = () => {
            amplitude = 0;
            mode = 1;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('.mode-btn[data-mode="1"]').classList.add('active');
        };

        canvas.onclick = (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const startX = (canvas.width - 400 - stringLength) / 2;

            if (x >= startX && x <= startX + stringLength) {
                const position = (x - startX) / stringLength;
                pluck(position);
            }
        };

        // Initialize
        pluck(0.3);
        draw();
    </script>
</body>
</html>
