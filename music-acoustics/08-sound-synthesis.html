<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sound Synthesis | Music Acoustics</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            overflow: hidden;
        }
        #canvas { display: block; }
        .controls {
            position: fixed;
            top: 20px; right: 20px;
            background: rgba(0,0,0,0.85);
            padding: 20px; border-radius: 15px;
            min-width: 300px;
            border: 1px solid rgba(251, 146, 60, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }
        h1 { color: #fb923c; font-size: 1.3em; margin-bottom: 15px; }
        .control-group { margin: 12px 0; }
        label { display: block; margin-bottom: 5px; color: #aaa; font-size: 0.9em; }
        input[type="range"], select { width: 100%; }
        .value { float: right; color: #fb923c; }
        button {
            width: 100%; padding: 10px; margin: 5px 0;
            border: none; border-radius: 8px;
            background: #fb923c; color: white;
            font-weight: bold; cursor: pointer;
        }
        button:hover { background: #fdba74; }
        .section-title {
            color: #fb923c; font-size: 0.95em;
            margin-top: 15px; padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .keyboard {
            display: flex; gap: 2px; margin: 10px 0;
            justify-content: center;
        }
        .key {
            width: 30px; height: 80px;
            background: white; border-radius: 0 0 5px 5px;
            cursor: pointer; position: relative;
        }
        .key.black {
            width: 20px; height: 50px;
            background: #333; margin: 0 -10px;
            z-index: 1;
        }
        .key:hover { background: #ddd; }
        .key.black:hover { background: #555; }
        .key.active { background: #fb923c; }
        .key.black.active { background: #c2410c; }
        .info { font-size: 0.8em; color: #666; margin-top: 15px; line-height: 1.5; }
        a.back-link {
            position: fixed; top: 20px; left: 20px;
            color: #fb923c; text-decoration: none;
            background: rgba(0,0,0,0.8); padding: 10px 20px;
            border-radius: 25px; font-size: 0.9em;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <a href="index.html" class="back-link">‚Üê Back to Music Acoustics</a>

    <div class="controls">
        <h1>Sound Synthesis</h1>
        <p style="font-size:0.85em; color:#888; margin-bottom:15px;">Subtractive & FM synthesis</p>

        <div class="control-group">
            <label>Synthesis Type</label>
            <select id="synthType">
                <option value="subtractive">Subtractive</option>
                <option value="fm">FM Synthesis</option>
                <option value="additive">Additive</option>
            </select>
        </div>

        <div class="section-title">Oscillator</div>

        <div class="control-group">
            <label>Waveform</label>
            <select id="waveform">
                <option value="sawtooth">Sawtooth</option>
                <option value="square">Square</option>
                <option value="triangle">Triangle</option>
                <option value="sine">Sine</option>
            </select>
        </div>

        <div class="control-group">
            <label>Detune: <span class="value" id="detuneValue">0</span> cents</label>
            <input type="range" id="detune" min="-50" max="50" step="1" value="0">
        </div>

        <div class="section-title">Filter (Subtractive)</div>

        <div class="control-group">
            <label>Cutoff: <span class="value" id="cutoffValue">2000</span> Hz</label>
            <input type="range" id="cutoff" min="100" max="8000" step="100" value="2000">
        </div>

        <div class="control-group">
            <label>Resonance (Q): <span class="value" id="resValue">1</span></label>
            <input type="range" id="resonance" min="0.5" max="20" step="0.5" value="1">
        </div>

        <div class="section-title">FM Parameters</div>

        <div class="control-group">
            <label>Mod Ratio: <span class="value" id="ratioValue">2</span></label>
            <input type="range" id="modRatio" min="0.5" max="8" step="0.5" value="2">
        </div>

        <div class="control-group">
            <label>Mod Index: <span class="value" id="indexValue">5</span></label>
            <input type="range" id="modIndex" min="0" max="20" step="1" value="5">
        </div>

        <div class="section-title">Envelope (ADSR)</div>

        <div class="control-group">
            <label>Attack: <span class="value" id="attackValue">0.1</span>s</label>
            <input type="range" id="attack" min="0.01" max="1" step="0.01" value="0.1">
        </div>

        <div class="control-group">
            <label>Decay: <span class="value" id="decayValue">0.2</span>s</label>
            <input type="range" id="decay" min="0.01" max="1" step="0.01" value="0.2">
        </div>

        <div class="control-group">
            <label>Sustain: <span class="value" id="sustainValue">0.7</span></label>
            <input type="range" id="sustain" min="0" max="1" step="0.05" value="0.7">
        </div>

        <div class="control-group">
            <label>Release: <span class="value" id="releaseValue">0.3</span>s</label>
            <input type="range" id="release" min="0.01" max="2" step="0.01" value="0.3">
        </div>

        <div class="section-title">Keyboard</div>
        <div class="keyboard" id="keyboard"></div>

        <div class="info">
            <strong>Subtractive:</strong> Filter harmonics from rich waveform.<br>
            <strong>FM:</strong> Modulate frequency for complex timbres.<br>
            <strong>Keys:</strong> A-L or click to play.
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resize();
        window.onresize = resize;

        let audioCtx = null;
        let synthType = 'subtractive';
        let waveform = 'sawtooth';
        let detune = 0;
        let cutoff = 2000;
        let resonance = 1;
        let modRatio = 2;
        let modIndex = 5;
        let attack = 0.1;
        let decay = 0.2;
        let sustain = 0.7;
        let release = 0.3;

        let activeNotes = {};
        let waveformData = new Float32Array(512);
        let time = 0;

        const notes = [
            { note: 'C4', freq: 261.63, key: 'a' },
            { note: 'C#4', freq: 277.18, key: 'w', black: true },
            { note: 'D4', freq: 293.66, key: 's' },
            { note: 'D#4', freq: 311.13, key: 'e', black: true },
            { note: 'E4', freq: 329.63, key: 'd' },
            { note: 'F4', freq: 349.23, key: 'f' },
            { note: 'F#4', freq: 369.99, key: 't', black: true },
            { note: 'G4', freq: 392.00, key: 'g' },
            { note: 'G#4', freq: 415.30, key: 'y', black: true },
            { note: 'A4', freq: 440.00, key: 'h' },
            { note: 'A#4', freq: 466.16, key: 'u', black: true },
            { note: 'B4', freq: 493.88, key: 'j' },
            { note: 'C5', freq: 523.25, key: 'k' }
        ];

        function createKeyboard() {
            const keyboard = document.getElementById('keyboard');
            keyboard.innerHTML = '';

            notes.forEach((n, i) => {
                const key = document.createElement('div');
                key.className = 'key' + (n.black ? ' black' : '');
                key.dataset.freq = n.freq;
                key.dataset.note = n.note;

                key.onmousedown = () => playNote(n.freq, n.note);
                key.onmouseup = () => stopNote(n.note);
                key.onmouseleave = () => stopNote(n.note);

                keyboard.appendChild(key);
            });
        }

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playNote(freq, noteName) {
            initAudio();

            if (activeNotes[noteName]) return;

            const now = audioCtx.currentTime;
            let source, gainNode;

            if (synthType === 'subtractive') {
                source = audioCtx.createOscillator();
                source.type = waveform;
                source.frequency.value = freq;
                source.detune.value = detune;

                const filter = audioCtx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.value = cutoff;
                filter.Q.value = resonance;

                gainNode = audioCtx.createGain();
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(0.5, now + attack);
                gainNode.gain.linearRampToValueAtTime(sustain * 0.5, now + attack + decay);

                source.connect(filter);
                filter.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                source.start();

            } else if (synthType === 'fm') {
                // FM Synthesis
                const carrier = audioCtx.createOscillator();
                const modulator = audioCtx.createOscillator();
                const modGain = audioCtx.createGain();

                carrier.frequency.value = freq;
                modulator.frequency.value = freq * modRatio;
                modGain.gain.value = freq * modIndex;

                modulator.connect(modGain);
                modGain.connect(carrier.frequency);

                gainNode = audioCtx.createGain();
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(0.3, now + attack);
                gainNode.gain.linearRampToValueAtTime(sustain * 0.3, now + attack + decay);

                carrier.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                carrier.start();
                modulator.start();

                source = { carrier, modulator };

            } else if (synthType === 'additive') {
                // Additive synthesis
                const oscillators = [];
                gainNode = audioCtx.createGain();
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(0.3, now + attack);
                gainNode.gain.linearRampToValueAtTime(sustain * 0.3, now + attack + decay);

                for (let h = 1; h <= 8; h++) {
                    const osc = audioCtx.createOscillator();
                    const oscGain = audioCtx.createGain();
                    osc.frequency.value = freq * h;
                    oscGain.gain.value = 1 / (h * h);
                    osc.connect(oscGain);
                    oscGain.connect(gainNode);
                    osc.start();
                    oscillators.push(osc);
                }

                gainNode.connect(audioCtx.destination);
                source = { oscillators };
            }

            activeNotes[noteName] = { source, gainNode };

            // Update keyboard visual
            const keyEl = document.querySelector(`[data-note="${noteName}"]`);
            if (keyEl) keyEl.classList.add('active');
        }

        function stopNote(noteName) {
            const note = activeNotes[noteName];
            if (!note) return;

            const now = audioCtx.currentTime;
            note.gainNode.gain.cancelScheduledValues(now);
            note.gainNode.gain.setValueAtTime(note.gainNode.gain.value, now);
            note.gainNode.gain.linearRampToValueAtTime(0, now + release);

            setTimeout(() => {
                if (note.source.stop) {
                    note.source.stop();
                } else if (note.source.carrier) {
                    note.source.carrier.stop();
                    note.source.modulator.stop();
                } else if (note.source.oscillators) {
                    note.source.oscillators.forEach(o => o.stop());
                }
            }, release * 1000);

            delete activeNotes[noteName];

            const keyEl = document.querySelector(`[data-note="${noteName}"]`);
            if (keyEl) keyEl.classList.remove('active');
        }

        function generateWaveformPreview() {
            const freq = 2;
            for (let i = 0; i < waveformData.length; i++) {
                const t = i / waveformData.length * freq * Math.PI * 2;
                switch (waveform) {
                    case 'sine':
                        waveformData[i] = Math.sin(t);
                        break;
                    case 'sawtooth':
                        waveformData[i] = 2 * ((t / (2 * Math.PI)) % 1) - 1;
                        break;
                    case 'square':
                        waveformData[i] = Math.sin(t) > 0 ? 1 : -1;
                        break;
                    case 'triangle':
                        waveformData[i] = Math.abs(2 * ((t / (2 * Math.PI)) % 1) - 1) * 2 - 1;
                        break;
                }
            }
        }

        function draw() {
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            time += 0.02;
            generateWaveformPreview();

            const centerX = canvas.width / 2 - 150;

            ctx.fillStyle = '#fff';
            ctx.font = 'bold 24px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Sound Synthesis', centerX, 40);

            // Draw waveform
            const waveX = 50;
            const waveY = 100;
            const waveW = canvas.width - 450;
            const waveH = 150;

            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.fillRect(waveX, waveY, waveW, waveH);

            ctx.fillStyle = '#888';
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('Oscillator Waveform: ' + waveform.toUpperCase(), waveX, waveY - 10);

            ctx.beginPath();
            ctx.strokeStyle = '#fb923c';
            ctx.lineWidth = 2;
            for (let i = 0; i < waveformData.length; i++) {
                const x = waveX + (i / waveformData.length) * waveW;
                const y = waveY + waveH / 2 - waveformData[i] * waveH / 2 * 0.8;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            // Draw ADSR envelope
            const envX = 50;
            const envY = 300;
            const envW = canvas.width - 450;
            const envH = 120;

            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.fillRect(envX, envY, envW, envH);

            ctx.fillStyle = '#888';
            ctx.fillText('ADSR Envelope', envX, envY - 10);

            const totalTime = attack + decay + 0.5 + release;
            const aX = envX + (attack / totalTime) * envW;
            const dX = envX + ((attack + decay) / totalTime) * envW;
            const sX = envX + ((attack + decay + 0.5) / totalTime) * envW;
            const rX = envX + envW;

            ctx.beginPath();
            ctx.strokeStyle = '#22c55e';
            ctx.lineWidth = 3;
            ctx.moveTo(envX, envY + envH);
            ctx.lineTo(aX, envY + 10);
            ctx.lineTo(dX, envY + envH - sustain * (envH - 20));
            ctx.lineTo(sX, envY + envH - sustain * (envH - 20));
            ctx.lineTo(rX, envY + envH);
            ctx.stroke();

            // Labels
            ctx.fillStyle = '#666';
            ctx.font = '11px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('A', (envX + aX) / 2, envY + envH + 15);
            ctx.fillText('D', (aX + dX) / 2, envY + envH + 15);
            ctx.fillText('S', (dX + sX) / 2, envY + envH + 15);
            ctx.fillText('R', (sX + rX) / 2, envY + envH + 15);

            // Draw filter response (for subtractive)
            if (synthType === 'subtractive') {
                const filtX = 50;
                const filtY = 470;
                const filtW = canvas.width - 450;
                const filtH = 100;

                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.fillRect(filtX, filtY, filtW, filtH);

                ctx.fillStyle = '#888';
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText('Filter Response (Lowpass)', filtX, filtY - 10);

                ctx.beginPath();
                ctx.strokeStyle = '#3b82f6';
                ctx.lineWidth = 2;

                for (let f = 20; f <= 20000; f *= 1.05) {
                    const x = filtX + (Math.log10(f / 20) / Math.log10(1000)) * filtW;
                    const ratio = f / cutoff;
                    let gain = 1 / Math.sqrt(1 + Math.pow(ratio, 4));
                    if (ratio > 0.7 && ratio < 1.3) {
                        gain *= 1 + (resonance - 1) * 0.5 * Math.exp(-Math.pow(ratio - 1, 2) * 10);
                    }
                    const y = filtY + filtH - gain * filtH * 0.9;
                    if (f === 20) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();

                // Cutoff marker
                const cutoffX = filtX + (Math.log10(cutoff / 20) / Math.log10(1000)) * filtW;
                ctx.strokeStyle = '#ef4444';
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(cutoffX, filtY);
                ctx.lineTo(cutoffX, filtY + filtH);
                ctx.stroke();
                ctx.setLineDash([]);

                ctx.fillStyle = '#ef4444';
                ctx.font = '11px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(cutoff + 'Hz', cutoffX, filtY + filtH + 15);
            }

            // Draw FM visualization
            if (synthType === 'fm') {
                const fmX = 50;
                const fmY = 470;
                const fmW = canvas.width - 450;
                const fmH = 100;

                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.fillRect(fmX, fmY, fmW, fmH);

                ctx.fillStyle = '#888';
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText(`FM Synthesis (Ratio: ${modRatio}, Index: ${modIndex})`, fmX, fmY - 10);

                // Draw FM waveform
                ctx.beginPath();
                ctx.strokeStyle = '#8b5cf6';
                ctx.lineWidth = 2;

                for (let i = 0; i < fmW; i++) {
                    const t = i / fmW * 4 * Math.PI;
                    const carrier = 1;
                    const modulator = modRatio;
                    const y = Math.sin(carrier * t + modIndex * Math.sin(modulator * t));
                    const py = fmY + fmH / 2 - y * fmH / 2 * 0.7;
                    if (i === 0) ctx.moveTo(fmX + i, py);
                    else ctx.lineTo(fmX + i, py);
                }
                ctx.stroke();
            }

            // Active notes indicator
            const activeCount = Object.keys(activeNotes).length;
            if (activeCount > 0) {
                ctx.fillStyle = '#22c55e';
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText(`Playing: ${Object.keys(activeNotes).join(', ')}`, 50, canvas.height - 30);
            }

            requestAnimationFrame(draw);
        }

        // Event listeners
        document.getElementById('synthType').onchange = (e) => {
            synthType = e.target.value;
        };

        document.getElementById('waveform').onchange = (e) => {
            waveform = e.target.value;
        };

        document.getElementById('detune').oninput = (e) => {
            detune = parseInt(e.target.value);
            document.getElementById('detuneValue').textContent = detune;
        };

        document.getElementById('cutoff').oninput = (e) => {
            cutoff = parseInt(e.target.value);
            document.getElementById('cutoffValue').textContent = cutoff;
        };

        document.getElementById('resonance').oninput = (e) => {
            resonance = parseFloat(e.target.value);
            document.getElementById('resValue').textContent = resonance;
        };

        document.getElementById('modRatio').oninput = (e) => {
            modRatio = parseFloat(e.target.value);
            document.getElementById('ratioValue').textContent = modRatio;
        };

        document.getElementById('modIndex').oninput = (e) => {
            modIndex = parseInt(e.target.value);
            document.getElementById('indexValue').textContent = modIndex;
        };

        document.getElementById('attack').oninput = (e) => {
            attack = parseFloat(e.target.value);
            document.getElementById('attackValue').textContent = attack;
        };

        document.getElementById('decay').oninput = (e) => {
            decay = parseFloat(e.target.value);
            document.getElementById('decayValue').textContent = decay;
        };

        document.getElementById('sustain').oninput = (e) => {
            sustain = parseFloat(e.target.value);
            document.getElementById('sustainValue').textContent = sustain;
        };

        document.getElementById('release').oninput = (e) => {
            release = parseFloat(e.target.value);
            document.getElementById('releaseValue').textContent = release;
        };

        // Keyboard input
        document.addEventListener('keydown', (e) => {
            if (e.repeat) return;
            const note = notes.find(n => n.key === e.key.toLowerCase());
            if (note) playNote(note.freq, note.note);
        });

        document.addEventListener('keyup', (e) => {
            const note = notes.find(n => n.key === e.key.toLowerCase());
            if (note) stopNote(note.note);
        });

        // Initialize
        createKeyboard();
        draw();
    </script>
</body>
</html>
