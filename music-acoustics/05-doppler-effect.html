<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doppler Effect | Music Acoustics</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            overflow: hidden;
        }
        #canvas { display: block; }
        .controls {
            position: fixed;
            top: 20px; right: 20px;
            background: rgba(0,0,0,0.85);
            padding: 20px; border-radius: 15px;
            min-width: 280px;
            border: 1px solid rgba(251, 146, 60, 0.3);
        }
        h1 { color: #fb923c; font-size: 1.3em; margin-bottom: 15px; }
        .control-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; color: #aaa; font-size: 0.9em; }
        input[type="range"], select { width: 100%; }
        .value { float: right; color: #fb923c; }
        button {
            width: 100%; padding: 10px; margin: 5px 0;
            border: none; border-radius: 8px;
            background: #fb923c; color: white;
            font-weight: bold; cursor: pointer;
        }
        button:hover { background: #fdba74; }
        .stats { margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); }
        .stat-row { display: flex; justify-content: space-between; padding: 5px 0; font-size: 0.9em; }
        .stat-label { color: #888; }
        .stat-value { color: #fb923c; font-weight: bold; }
        .info { font-size: 0.8em; color: #666; margin-top: 15px; line-height: 1.5; }
        a.back-link {
            position: fixed; top: 20px; left: 20px;
            color: #fb923c; text-decoration: none;
            background: rgba(0,0,0,0.8); padding: 10px 20px;
            border-radius: 25px; font-size: 0.9em;
        }
        .formula {
            background: rgba(251, 146, 60, 0.1);
            padding: 8px; border-radius: 8px;
            font-family: monospace; margin: 10px 0;
            text-align: center; font-size: 0.85em;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <a href="index.html" class="back-link">← Back to Music Acoustics</a>

    <div class="controls">
        <h1>Doppler Effect</h1>
        <p style="font-size:0.85em; color:#888; margin-bottom:15px;">Frequency shift from motion</p>

        <div class="formula">f' = f × (v + v₀) / (v + vₛ)</div>

        <div class="control-group">
            <label>Source Speed: <span class="value" id="speedValue">50</span> m/s</label>
            <input type="range" id="sourceSpeed" min="0" max="300" step="5" value="50">
        </div>

        <div class="control-group">
            <label>Source Frequency: <span class="value" id="freqValue">440</span> Hz</label>
            <input type="range" id="sourceFreq" min="220" max="880" step="10" value="440">
        </div>

        <div class="control-group">
            <label>Sound Speed: <span class="value" id="soundValue">343</span> m/s</label>
            <input type="range" id="soundSpeed" min="300" max="400" step="1" value="343">
        </div>

        <div class="control-group">
            <label>Scenario</label>
            <select id="scenario">
                <option value="passing">Car Passing By</option>
                <option value="ambulance">Ambulance Siren</option>
                <option value="train">Train Horn</option>
            </select>
        </div>

        <button id="startBtn">Start Animation</button>
        <button id="playBtn">Play Doppler Sound</button>
        <button id="resetBtn" style="background:#444">Reset</button>

        <div class="stats">
            <div class="stat-row">
                <span class="stat-label">Approaching Freq</span>
                <span class="stat-value" id="approachFreq">0 Hz</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Receding Freq</span>
                <span class="stat-value" id="recedeFreq">0 Hz</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Frequency Shift</span>
                <span class="stat-value" id="freqShift">0 Hz</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Mach Number</span>
                <span class="stat-value" id="machNumber">0</span>
            </div>
        </div>

        <div class="info">
            <strong>Approaching:</strong> Waves compressed → higher pitch.<br>
            <strong>Receding:</strong> Waves stretched → lower pitch.<br>
            <strong>Supersonic:</strong> Mach > 1 creates sonic boom.
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resize();
        window.onresize = resize;

        let sourceSpeed = 50;
        let sourceFreq = 440;
        let soundSpeed = 343;
        let running = false;
        let sourceX = -100;
        let waves = [];
        let time = 0;
        let audioCtx = null;
        let oscillator = null;
        let isPlaying = false;

        const observerX = canvas.width / 2 - 100;
        const observerY = 300;

        function calculateDopplerFreq(approaching) {
            const vs = approaching ? -sourceSpeed : sourceSpeed;
            return sourceFreq * soundSpeed / (soundSpeed + vs);
        }

        function updateStats() {
            const approachFreq = calculateDopplerFreq(true);
            const recedeFreq = calculateDopplerFreq(false);
            const shift = approachFreq - recedeFreq;
            const mach = sourceSpeed / soundSpeed;

            document.getElementById('approachFreq').textContent = approachFreq.toFixed(0) + ' Hz';
            document.getElementById('recedeFreq').textContent = recedeFreq.toFixed(0) + ' Hz';
            document.getElementById('freqShift').textContent = shift.toFixed(0) + ' Hz';
            document.getElementById('machNumber').textContent = mach.toFixed(2);
        }

        function emitWave() {
            waves.push({
                x: sourceX,
                y: observerY,
                radius: 0,
                emitTime: time
            });
        }

        function draw() {
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            time += 16;
            updateStats();

            const graphWidth = canvas.width - 400;

            ctx.fillStyle = '#fff';
            ctx.font = 'bold 24px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Doppler Effect', canvas.width / 2 - 100, 40);

            // Update source position
            if (running) {
                sourceX += sourceSpeed * 0.05;
                if (sourceX > canvas.width - 300) {
                    sourceX = -100;
                    waves = [];
                }

                // Emit waves periodically
                if (time % Math.floor(50000 / sourceFreq) < 16) {
                    emitWave();
                }
            }

            // Draw road
            ctx.fillStyle = '#333';
            ctx.fillRect(0, observerY + 50, canvas.width - 320, 60);

            // Road markings
            ctx.strokeStyle = '#666';
            ctx.lineWidth = 3;
            ctx.setLineDash([30, 20]);
            ctx.beginPath();
            ctx.moveTo(0, observerY + 80);
            ctx.lineTo(canvas.width - 320, observerY + 80);
            ctx.stroke();
            ctx.setLineDash([]);

            // Draw waves
            for (let i = waves.length - 1; i >= 0; i--) {
                const wave = waves[i];
                wave.radius += soundSpeed * 0.05;

                if (wave.radius > 800) {
                    waves.splice(i, 1);
                    continue;
                }

                const alpha = Math.max(0, 1 - wave.radius / 400);
                ctx.strokeStyle = `rgba(251, 146, 60, ${alpha * 0.5})`;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(wave.x, wave.y, wave.radius, 0, Math.PI * 2);
                ctx.stroke();
            }

            // Draw source (car/ambulance)
            ctx.fillStyle = '#ef4444';
            ctx.beginPath();
            ctx.ellipse(sourceX, observerY + 30, 40, 20, 0, 0, Math.PI * 2);
            ctx.fill();

            // Windows
            ctx.fillStyle = '#60a5fa';
            ctx.fillRect(sourceX - 15, observerY + 15, 25, 15);

            // Wheels
            ctx.fillStyle = '#333';
            ctx.beginPath();
            ctx.arc(sourceX - 20, observerY + 50, 10, 0, Math.PI * 2);
            ctx.arc(sourceX + 20, observerY + 50, 10, 0, Math.PI * 2);
            ctx.fill();

            // Sound waves from source indicator
            if (running) {
                for (let i = 1; i <= 3; i++) {
                    const r = 20 + (time / 50 * i) % 30;
                    ctx.strokeStyle = `rgba(251, 146, 60, ${0.5 - i * 0.15})`;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(sourceX, observerY + 20, r, 0, Math.PI * 2);
                    ctx.stroke();
                }
            }

            // Draw observer
            ctx.fillStyle = '#22c55e';
            ctx.beginPath();
            ctx.arc(observerX, observerY + 80, 15, 0, Math.PI * 2);
            ctx.fill();

            // Observer body
            ctx.fillRect(observerX - 8, observerY + 95, 16, 30);

            ctx.fillStyle = '#888';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Observer', observerX, observerY + 140);

            // Draw frequency display for observer
            const distToSource = sourceX - observerX;
            const approaching = distToSource < 0;
            const perceivedFreq = approaching ? calculateDopplerFreq(true) : calculateDopplerFreq(false);

            ctx.fillStyle = approaching ? '#22c55e' : '#ef4444';
            ctx.font = 'bold 16px sans-serif';
            ctx.fillText(`Perceived: ${perceivedFreq.toFixed(0)} Hz`, observerX, observerY - 20);
            ctx.fillStyle = '#888';
            ctx.font = '12px sans-serif';
            ctx.fillText(approaching ? '(Approaching - Higher)' : '(Receding - Lower)', observerX, observerY - 5);

            // Draw wavelength comparison
            const compY = canvas.height - 200;

            ctx.fillStyle = '#888';
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('Wavelength Compression/Expansion:', 50, compY - 20);

            // At rest
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.fillRect(50, compY, 200, 50);

            const restWavelength = soundSpeed / sourceFreq;
            const numWavesRest = 5;
            ctx.strokeStyle = '#888';
            ctx.lineWidth = 2;
            for (let i = 0; i <= numWavesRest; i++) {
                const x = 50 + (i / numWavesRest) * 200;
                ctx.beginPath();
                ctx.arc(x, compY + 25, 3, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.fillStyle = '#888';
            ctx.font = '11px sans-serif';
            ctx.fillText('At Rest (λ = ' + restWavelength.toFixed(1) + ' m)', 50, compY + 65);

            // Approaching (compressed)
            ctx.fillStyle = 'rgba(34, 197, 94, 0.2)';
            ctx.fillRect(280, compY, 200, 50);

            const approachWavelength = soundSpeed / calculateDopplerFreq(true);
            const compressionRatio = approachWavelength / restWavelength;
            ctx.fillStyle = '#22c55e';
            for (let i = 0; i <= numWavesRest; i++) {
                const x = 280 + (i / numWavesRest) * 200 * compressionRatio;
                if (x < 480) {
                    ctx.beginPath();
                    ctx.arc(x, compY + 25, 3, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            ctx.fillStyle = '#22c55e';
            ctx.font = '11px sans-serif';
            ctx.fillText('Approaching (λ = ' + approachWavelength.toFixed(1) + ' m)', 280, compY + 65);

            // Receding (expanded)
            ctx.fillStyle = 'rgba(239, 68, 68, 0.2)';
            ctx.fillRect(510, compY, 200, 50);

            const recedeWavelength = soundSpeed / calculateDopplerFreq(false);
            const expansionRatio = recedeWavelength / restWavelength;
            ctx.fillStyle = '#ef4444';
            for (let i = 0; i <= numWavesRest; i++) {
                const x = 510 + (i / numWavesRest) * 200 * Math.min(expansionRatio, 1.5);
                if (x < 710) {
                    ctx.beginPath();
                    ctx.arc(x, compY + 25, 3, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            ctx.fillStyle = '#ef4444';
            ctx.font = '11px sans-serif';
            ctx.fillText('Receding (λ = ' + recedeWavelength.toFixed(1) + ' m)', 510, compY + 65);

            // Update audio if playing
            if (isPlaying && oscillator) {
                const currentFreq = approaching ? calculateDopplerFreq(true) : calculateDopplerFreq(false);
                oscillator.frequency.setValueAtTime(currentFreq, audioCtx.currentTime);
            }

            requestAnimationFrame(draw);
        }

        function toggleAnimation() {
            running = !running;
            document.getElementById('startBtn').textContent = running ? 'Pause' : 'Start Animation';
            if (running && sourceX > canvas.width - 400) {
                sourceX = -100;
                waves = [];
            }
        }

        function playDopplerSound() {
            if (isPlaying) {
                oscillator.stop();
                isPlaying = false;
                document.getElementById('playBtn').textContent = 'Play Doppler Sound';
                return;
            }

            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            oscillator = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            oscillator.frequency.value = sourceFreq;
            oscillator.type = 'sine';
            gain.gain.value = 0.3;

            oscillator.connect(gain);
            gain.connect(audioCtx.destination);
            oscillator.start();

            isPlaying = true;
            document.getElementById('playBtn').textContent = 'Stop Sound';
        }

        // Event listeners
        document.getElementById('sourceSpeed').oninput = (e) => {
            sourceSpeed = parseInt(e.target.value);
            document.getElementById('speedValue').textContent = sourceSpeed;
        };

        document.getElementById('sourceFreq').oninput = (e) => {
            sourceFreq = parseInt(e.target.value);
            document.getElementById('freqValue').textContent = sourceFreq;
        };

        document.getElementById('soundSpeed').oninput = (e) => {
            soundSpeed = parseInt(e.target.value);
            document.getElementById('soundValue').textContent = soundSpeed;
        };

        document.getElementById('scenario').onchange = (e) => {
            switch (e.target.value) {
                case 'passing':
                    sourceSpeed = 50; sourceFreq = 440;
                    break;
                case 'ambulance':
                    sourceSpeed = 30; sourceFreq = 700;
                    break;
                case 'train':
                    sourceSpeed = 80; sourceFreq = 300;
                    break;
            }
            document.getElementById('sourceSpeed').value = sourceSpeed;
            document.getElementById('sourceFreq').value = sourceFreq;
            document.getElementById('speedValue').textContent = sourceSpeed;
            document.getElementById('freqValue').textContent = sourceFreq;
        };

        document.getElementById('startBtn').onclick = toggleAnimation;
        document.getElementById('playBtn').onclick = playDopplerSound;
        document.getElementById('resetBtn').onclick = () => {
            sourceX = -100;
            waves = [];
            running = false;
            document.getElementById('startBtn').textContent = 'Start Animation';
        };

        draw();
    </script>
</body>
</html>
