<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fireflies - Screensaver Patterns</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #050810; overflow: hidden; }
        canvas { display: block; cursor: pointer; }
        .back-link {
            position: fixed; top: 20px; left: 20px; z-index: 100;
            color: #8A9A5B; text-decoration: none; font-family: system-ui;
            background: rgba(0,0,0,0.5); padding: 8px 16px; border-radius: 20px;
            font-size: 14px; transition: all 0.3s;
        }
        .back-link:hover { background: rgba(138,154,91,0.3); }
        #info {
            position: fixed; bottom: 20px; right: 20px; z-index: 100;
            color: rgba(255,255,255,0.5); font-family: monospace; font-size: 12px;
        }
        #paused {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-family: system-ui; font-size: 24px;
            opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        #paused.show { opacity: 0.7; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Gallery</a>
    <div id="info">FPS: <span id="fps">0</span></div>
    <div id="paused">PAUSED</div>
    <canvas id="canvas"></canvas>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let isPaused = false;
        let lastTime = performance.now();
        let frameCount = 0;
        let time = 0;

        canvas.addEventListener('click', () => {
            isPaused = !isPaused;
            document.getElementById('paused').classList.toggle('show', isPaused);
        });

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            initFireflies();
        }
        window.addEventListener('resize', resize);

        class Firefly {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 0.5;
                this.vy = (Math.random() - 0.5) * 0.5;
                this.phase = Math.random() * Math.PI * 2;
                this.frequency = 0.5 + Math.random() * 1.5;
                this.trail = [];
                this.maxTrail = 10;
                this.wanderAngle = Math.random() * Math.PI * 2;

                // Kuramoto model coupling
                this.naturalFreq = 0.8 + Math.random() * 0.4;
                this.couplingStrength = 0.1;
            }

            update(time, fireflies) {
                // Kuramoto synchronization
                let phaseInfluence = 0;
                fireflies.forEach(other => {
                    if (other !== this) {
                        const dx = other.x - this.x;
                        const dy = other.y - this.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        if (dist < 200) {
                            const coupling = this.couplingStrength * (1 - dist / 200);
                            phaseInfluence += coupling * Math.sin(other.phase - this.phase);
                        }
                    }
                });

                this.phase += (this.naturalFreq + phaseInfluence) * 0.05;

                // Wandering movement
                this.wanderAngle += (Math.random() - 0.5) * 0.3;
                this.vx += Math.cos(this.wanderAngle) * 0.02;
                this.vy += Math.sin(this.wanderAngle) * 0.02;

                // Damping
                this.vx *= 0.98;
                this.vy *= 0.98;

                // Speed limit
                const speed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
                if (speed > 1.5) {
                    this.vx = (this.vx / speed) * 1.5;
                    this.vy = (this.vy / speed) * 1.5;
                }

                this.x += this.vx;
                this.y += this.vy;

                // Soft boundaries
                const margin = 50;
                if (this.x < margin) this.vx += 0.05;
                if (this.x > canvas.width - margin) this.vx -= 0.05;
                if (this.y < margin) this.vy += 0.05;
                if (this.y > canvas.height - margin) this.vy -= 0.05;

                // Trail
                this.trail.push({ x: this.x, y: this.y, brightness: this.getBrightness() });
                if (this.trail.length > this.maxTrail) this.trail.shift();
            }

            getBrightness() {
                // Pulse pattern
                const pulse = (Math.sin(this.phase) + 1) / 2;
                return pulse * pulse * pulse; // Sharper pulse
            }

            draw(ctx) {
                const brightness = this.getBrightness();

                // Draw trail
                this.trail.forEach((point, i) => {
                    const alpha = (i / this.trail.length) * point.brightness * 0.3;
                    const size = 2 + point.brightness * 3;
                    ctx.fillStyle = `rgba(200, 255, 100, ${alpha})`;
                    ctx.beginPath();
                    ctx.arc(point.x, point.y, size, 0, Math.PI * 2);
                    ctx.fill();
                });

                // Glow
                if (brightness > 0.1) {
                    const glowSize = 20 + brightness * 30;
                    const gradient = ctx.createRadialGradient(
                        this.x, this.y, 0,
                        this.x, this.y, glowSize
                    );
                    gradient.addColorStop(0, `rgba(200, 255, 100, ${brightness * 0.5})`);
                    gradient.addColorStop(0.3, `rgba(150, 255, 50, ${brightness * 0.2})`);
                    gradient.addColorStop(1, 'rgba(100, 200, 0, 0)');
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, glowSize, 0, Math.PI * 2);
                    ctx.fill();
                }

                // Core
                const coreSize = 3 + brightness * 4;
                ctx.fillStyle = `rgba(255, 255, 200, ${0.3 + brightness * 0.7})`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, coreSize, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        const fireflies = [];
        const numFireflies = 60;

        function initFireflies() {
            fireflies.length = 0;
            for (let i = 0; i < numFireflies; i++) {
                fireflies.push(new Firefly(
                    Math.random() * canvas.width,
                    Math.random() * canvas.height
                ));
            }
        }

        resize();

        function render() {
            if (!isPaused) {
                time += 0.016;
                fireflies.forEach(f => f.update(time, fireflies));
            }

            // Dark background with slight gradient
            const bgGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            bgGradient.addColorStop(0, 'rgba(5, 8, 16, 0.2)');
            bgGradient.addColorStop(1, 'rgba(8, 12, 20, 0.2)');
            ctx.fillStyle = bgGradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw fireflies
            fireflies.forEach(f => f.draw(ctx));

            // Subtle ambient glow when many sync up
            let totalBrightness = 0;
            fireflies.forEach(f => totalBrightness += f.getBrightness());
            const avgBrightness = totalBrightness / fireflies.length;

            if (avgBrightness > 0.5) {
                ctx.fillStyle = `rgba(150, 200, 50, ${(avgBrightness - 0.5) * 0.02})`;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            frameCount++;
            const now = performance.now();
            if (now - lastTime >= 1000) {
                document.getElementById('fps').textContent = frameCount;
                frameCount = 0;
                lastTime = now;
            }

            requestAnimationFrame(render);
        }
        render();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
