<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spirograph - Hypotrochoid</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; overflow: hidden; font-family: 'Segoe UI', Arial, sans-serif; }
canvas { display: block; }
a.back { position: fixed; top: 20px; left: 20px; color: #8af; text-decoration: none; z-index: 100; font-size: 1.2em; }
a.back:hover { color: #bdf; }
#controls {
    position: fixed; top: 20px; right: 20px; background: rgba(10,14,30,0.7);
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(138,170,255,0.15); border-radius: 12px;
    padding: 18px; color: #cde; z-index: 100; width: 240px; font-size: 13px;
}
#controls h3 { margin-bottom: 10px; color: #8af; font-size: 15px; }
.ctrl-row { margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
.ctrl-row label { flex: 0 0 65px; }
.ctrl-row input[type=range] { flex: 1; margin: 0 8px; accent-color: #8af; }
.ctrl-row .val { flex: 0 0 35px; text-align: right; color: #8af; font-size: 12px; }
button {
    background: rgba(138,170,255,0.15); color: #8af; border: 1px solid rgba(138,170,255,0.3);
    border-radius: 6px; padding: 5px 10px; cursor: pointer; font-size: 12px; margin: 2px;
}
button:hover { background: rgba(138,170,255,0.3); }
.presets { display: flex; flex-wrap: wrap; margin-top: 8px; }
.toggle-row { margin: 8px 0; display: flex; align-items: center; gap: 8px; }
.toggle-row input { accent-color: #8af; }
select { background: #1a1e2a; color: #cde; border: 1px solid rgba(138,170,255,0.3); border-radius: 4px; padding: 3px; font-size: 12px; }
#progress { margin-top: 8px; }
#progress-bar { width: 100%; height: 4px; background: rgba(138,170,255,0.1); border-radius: 2px; overflow: hidden; }
#progress-fill { height: 100%; background: linear-gradient(90deg, #f0f, #0ff, #ff0); width: 0%; transition: width 0.1s; }
</style>
</head>
<body>
<a href="index.html" class="back">&#8592; Back</a>
<canvas id="canvas"></canvas>
<div id="controls">
    <h3>Spirograph</h3>
    <div class="ctrl-row"><label>R (outer)</label><input type="range" id="R" min="50" max="300" value="200"><span class="val" id="Rv">200</span></div>
    <div class="ctrl-row"><label>r (inner)</label><input type="range" id="r" min="10" max="150" value="80"><span class="val" id="rv">80</span></div>
    <div class="ctrl-row"><label>d (pen)</label><input type="range" id="d" min="0" max="200" value="150"><span class="val" id="dv">150</span></div>
    <div class="ctrl-row"><label>Speed</label><input type="range" id="speed" min="1" max="50" value="15"><span class="val" id="speedv">15</span></div>
    <div class="ctrl-row"><label>Width</label><input type="range" id="lw" min="1" max="6" value="2" step="0.5"><span class="val" id="lwv">2</span></div>
    <div class="ctrl-row"><label>Color</label><select id="colorMode"><option value="rainbow">Rainbow</option><option value="solid">Solid</option><option value="gradient">Gradient</option></select></div>
    <div class="toggle-row"><input type="checkbox" id="showMech" checked><label for="showMech">Show mechanism</label></div>
    <div class="presets">
        <button onclick="preset(200,80,150)">Star</button>
        <button onclick="preset(200,120,100)">Flower</button>
        <button onclick="preset(200,146,100)">Spiral</button>
        <button onclick="preset(200,66,66)">Pentagon</button>
    </div>
    <div id="progress"><div id="progress-bar"><div id="progress-fill"></div></div></div>
</div>

<canvas id="trail"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const trail = document.getElementById('trail');
const tCtx = trail.getContext('2d');
trail.style.cssText = 'position:absolute;top:0;left:0;pointer-events:none;';

let W, H, cx, cy;
function resize() {
    W = canvas.width = trail.width = window.innerWidth;
    H = canvas.height = trail.height = window.innerHeight;
    cx = W / 2; cy = H / 2;
    redrawTrail();
}

const sliders = { R: 200, r: 80, d: 150, speed: 15, lw: 2 };
const els = {};
['R','r','d','speed','lw'].forEach(k => {
    els[k] = document.getElementById(k);
    els[k].oninput = () => { sliders[k] = parseFloat(els[k].value); document.getElementById(k+'v').textContent = sliders[k]; };
});

let colorMode = 'rainbow';
document.getElementById('colorMode').onchange = e => colorMode = e.target.value;
let showMech = true;
document.getElementById('showMech').onchange = e => showMech = e.target.checked;

let t = 0;
let points = [];
let paused = false;
let animId;

function hypotrochoid(t, R, r, d) {
    const diff = R - r;
    const ratio = diff / r;
    return {
        x: diff * Math.cos(t) + d * Math.cos(ratio * t),
        y: diff * Math.sin(t) - d * Math.sin(ratio * t)
    };
}

function getColor(t) {
    if (colorMode === 'solid') return '#8af';
    if (colorMode === 'gradient') {
        const hue = (t * 10) % 360;
        return `hsl(${hue}, 60%, 70%)`;
    }
    const hue = (t * 15) % 360;
    return `hsl(${hue}, 80%, 60%)`;
}

function closurePeriod(R, r) {
    function gcd(a, b) { a = Math.round(a); b = Math.round(b); while(b) { [a,b] = [b, a%b]; } return a; }
    const g = gcd(R, r);
    return (2 * Math.PI * r) / g;
}

function preset(R, r, d) {
    sliders.R = R; sliders.r = r; sliders.d = d;
    els.R.value = R; els.r.value = r; els.d.value = d;
    document.getElementById('Rv').textContent = R;
    document.getElementById('rv').textContent = r;
    document.getElementById('dv').textContent = d;
    resetAnim();
}

function resetAnim() {
    t = 0; points = [];
    tCtx.clearRect(0, 0, W, H);
}

function redrawTrail() {
    tCtx.clearRect(0, 0, W, H);
    if (points.length < 2) return;
    for (let i = 1; i < points.length; i++) {
        tCtx.beginPath();
        tCtx.moveTo(points[i-1].x + cx, points[i-1].y + cy);
        tCtx.lineTo(points[i].x + cx, points[i].y + cy);
        tCtx.strokeStyle = points[i].color;
        tCtx.lineWidth = sliders.lw;
        tCtx.shadowBlur = 8;
        tCtx.shadowColor = points[i].color;
        tCtx.stroke();
    }
    tCtx.shadowBlur = 0;
}

function animate() {
    animId = requestAnimationFrame(animate);
    ctx.clearRect(0, 0, W, H);

    const { R, r, d, speed } = sliders;
    const maxT = closurePeriod(R, r);
    const dt = speed * 0.002;

    if (!paused && t < maxT + dt) {
        for (let i = 0; i < 3; i++) {
            if (t > maxT) break;
            t += dt;
            const p = hypotrochoid(t, R, r, d);
            p.color = getColor(t);
            points.push(p);
            if (points.length > 1) {
                const prev = points[points.length - 2];
                tCtx.beginPath();
                tCtx.moveTo(prev.x + cx, prev.y + cy);
                tCtx.lineTo(p.x + cx, p.y + cy);
                tCtx.strokeStyle = p.color;
                tCtx.lineWidth = sliders.lw;
                tCtx.shadowBlur = 8;
                tCtx.shadowColor = p.color;
                tCtx.stroke();
                tCtx.shadowBlur = 0;
            }
        }
    }

    // Progress bar
    const pct = Math.min(100, (t / maxT) * 100);
    document.getElementById('progress-fill').style.width = pct + '%';

    // Draw mechanism
    if (showMech) {
        const diff = R - r;
        const ratio = diff / r;
        const cAngle = t;
        const innerCx = cx + diff * Math.cos(cAngle);
        const innerCy = cy + diff * Math.sin(cAngle);

        // Outer circle
        ctx.beginPath();
        ctx.arc(cx, cy, R, 0, Math.PI * 2);
        ctx.strokeStyle = 'rgba(138,170,255,0.25)';
        ctx.lineWidth = 1;
        ctx.stroke();

        // Inner rolling circle
        ctx.beginPath();
        ctx.arc(innerCx, innerCy, r, 0, Math.PI * 2);
        ctx.strokeStyle = 'rgba(138,170,255,0.4)';
        ctx.lineWidth = 1.5;
        ctx.stroke();

        // Center of inner circle
        ctx.beginPath();
        ctx.arc(innerCx, innerCy, 3, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(138,170,255,0.5)';
        ctx.fill();

        // Pen point
        const penX = cx + diff * Math.cos(cAngle) + d * Math.cos(ratio * cAngle);
        const penY = cy + diff * Math.sin(cAngle) - d * Math.sin(ratio * cAngle);
        ctx.beginPath();
        ctx.moveTo(innerCx, innerCy);
        ctx.lineTo(penX, penY);
        ctx.strokeStyle = 'rgba(255,140,100,0.5)';
        ctx.lineWidth = 1;
        ctx.stroke();

        ctx.beginPath();
        ctx.arc(penX, penY, 4, 0, Math.PI * 2);
        ctx.fillStyle = '#f84';
        ctx.shadowBlur = 12;
        ctx.shadowColor = '#f84';
        ctx.fill();
        ctx.shadowBlur = 0;
    }
}

window.reset = function() {
    resetAnim();
};

window.addEventListener('resize', resize);
resize();
animate();
</script>
<script src="../assets/js/enhance.js"></script>
</body>
</html>
