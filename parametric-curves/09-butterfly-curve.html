<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Butterfly Curve</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
canvas { display: block; }
a { position: fixed; top: 20px; left: 20px; color: #8af; text-decoration: none; z-index: 100; font-size: 1.2em; }
a:hover { color: #bdf; }
#controls {
    position: fixed; top: 20px; right: 20px; background: rgba(10,14,26,0.7);
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(138,170,255,0.2); border-radius: 12px;
    padding: 18px; color: #cde; z-index: 100; min-width: 220px;
}
#controls h3 { margin-bottom: 12px; color: #8af; font-size: 1.1em; }
.ctrl { margin-bottom: 10px; }
.ctrl label { display: block; font-size: 0.82em; margin-bottom: 3px; color: #9ab; }
.ctrl input[type=range] { width: 100%; accent-color: #8af; }
.ctrl .val { float: right; color: #8af; font-size: 0.82em; }
.toggle-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
.toggle-row label { font-size: 0.82em; color: #9ab; cursor: pointer; }
.toggle-row input { accent-color: #8af; }
select {
    width: 100%; padding: 4px; background: rgba(10,14,26,0.8); color: #8af;
    border: 1px solid rgba(138,170,255,0.3); border-radius: 4px; font-size: 0.82em;
}
#progress {
    position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%);
    color: #8af; font-size: 1em; font-weight: bold;
}
#info {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
    color: rgba(138,170,255,0.6); font-size: 0.82em; text-align: center;
    max-width: 500px;
}
</style>
</head>
<body>
<a href="index.html">&#8592; Back</a>
<canvas id="c"></canvas>
<canvas id="stars" style="position:fixed;top:0;left:0;pointer-events:none;z-index:0;"></canvas>
<div id="controls">
    <h3>Butterfly Curve</h3>
    <div class="ctrl">
        <label>Speed <span class="val" id="spVal">3</span></label>
        <input type="range" id="spSlider" min="0.5" max="10" step="0.5" value="3">
    </div>
    <div class="ctrl">
        <label>Line Width <span class="val" id="lwVal">1.5</span></label>
        <input type="range" id="lwSlider" min="0.5" max="5" step="0.5" value="1.5">
    </div>
    <div class="ctrl">
        <label>Scale <span class="val" id="scVal">1</span></label>
        <input type="range" id="scSlider" min="0.5" max="2" step="0.1" value="1">
    </div>
    <div class="ctrl">
        <label>Wing Factor (cos coeff) <span class="val" id="wfVal">2</span></label>
        <input type="range" id="wfSlider" min="0.5" max="5" step="0.1" value="2">
    </div>
    <div class="ctrl">
        <label>Body Exponent <span class="val" id="beVal">5</span></label>
        <input type="range" id="beSlider" min="1" max="9" step="2" value="5">
    </div>
    <div class="ctrl">
        <label>Color Mode</label>
        <select id="colorMode">
            <option value="rainbow">Rainbow</option>
            <option value="warm">Warm Wings</option>
            <option value="cool">Cool Glow</option>
            <option value="solid">Solid</option>
        </select>
    </div>
    <div class="toggle-row">
        <input type="checkbox" id="glowToggle" checked><label for="glowToggle">Glow effect</label>
    </div>
    <div class="toggle-row">
        <input type="checkbox" id="fillToggle"><label for="fillToggle">Fill wings</label>
    </div>
</div>
<div id="progress"></div>
<div id="info">r = e^sin(&theta;) - 2cos(4&theta;) + sin((2&theta;-&pi;)/24)^5 &mdash; Temple Fay, 1989</div>

<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
const starCanvas = document.getElementById('stars');
const sctx = starCanvas.getContext('2d');
let W, H, cx, cy, R;
let theta = 0;
let points = [];
let animating = true;
let starField = [];

function resize() {
    W = canvas.width = starCanvas.width = window.innerWidth;
    H = canvas.height = starCanvas.height = window.innerHeight;
    cx = W / 2;
    cy = H / 2;
    R = Math.min(W, H) * 0.1;
    initStars();
    drawStarField();
    resetDraw();
}

function initStars() {
    starField = [];
    for (let i = 0; i < 200; i++) {
        starField.push({
            x: Math.random() * W,
            y: Math.random() * H,
            r: Math.random() * 1.5 + 0.3,
            a: Math.random() * 0.5 + 0.1,
            twinkle: Math.random() * Math.PI * 2
        });
    }
}

function drawStarField() {
    sctx.clearRect(0, 0, W, H);
    starField.forEach(s => {
        const alpha = s.a * (0.5 + 0.5 * Math.sin(s.twinkle));
        sctx.beginPath();
        sctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
        sctx.fillStyle = `rgba(200,210,255,${alpha})`;
        sctx.fill();
    });
}

function getSpeed() { return parseFloat(document.getElementById('spSlider').value); }
function getLW() { return parseFloat(document.getElementById('lwSlider').value); }
function getScale() { return parseFloat(document.getElementById('scSlider').value); }
function getWingFactor() { return parseFloat(document.getElementById('wfSlider').value); }
function getBodyExp() { return parseInt(document.getElementById('beSlider').value); }
function getColorMode() { return document.getElementById('colorMode').value; }
function hasGlow() { return document.getElementById('glowToggle').checked; }
function hasFill() { return document.getElementById('fillToggle').checked; }

const MAX_THETA = Math.PI * 24;

function butterflyR(t) {
    const wf = getWingFactor();
    const be = getBodyExp();
    return Math.exp(Math.sin(t)) - wf * Math.cos(4 * t) + Math.pow(Math.sin((2 * t - Math.PI) / 24), be);
}

function resetDraw() {
    theta = 0;
    points = [];
}

function getColor(t, mode) {
    const frac = t / MAX_THETA;
    switch (mode) {
        case 'rainbow': return `hsl(${frac * 360 * 3 % 360}, 85%, 60%)`;
        case 'warm': return `hsl(${20 + frac * 40}, 90%, ${55 + Math.sin(frac * 20) * 15}%)`;
        case 'cool': return `hsl(${200 + frac * 80}, 80%, ${50 + Math.sin(frac * 15) * 20}%)`;
        default: return `hsl(280, 80%, 65%)`;
    }
}

let frame = 0;

function draw() {
    frame++;

    // Twinkle stars every 3 frames
    if (frame % 3 === 0) {
        starField.forEach(s => s.twinkle += 0.03);
        drawStarField();
    }

    if (!animating) { requestAnimationFrame(draw); return; }

    ctx.fillStyle = 'rgba(10,14,26,0.06)';
    ctx.fillRect(0, 0, W, H);

    const speed = getSpeed();
    const lw = getLW();
    const scale = getScale();
    const mode = getColorMode();
    const glow = hasGlow();
    const step = 0.01 * speed;

    // Advance
    const batch = 8;
    for (let b = 0; b < batch; b++) {
        if (theta <= MAX_THETA) {
            const r = butterflyR(theta) * R * scale;
            const x = cx + r * Math.cos(theta);
            const y = cy - r * Math.sin(theta);
            points.push({ x, y, t: theta });
            theta += step * 0.01;
        }
    }

    // Draw new segments
    if (points.length > 1) {
        const start = Math.max(0, points.length - batch - 1);
        for (let i = start + 1; i < points.length; i++) {
            const p0 = points[i - 1];
            const p1 = points[i];
            ctx.beginPath();
            ctx.moveTo(p0.x, p0.y);
            ctx.lineTo(p1.x, p1.y);
            const color = getColor(p1.t, mode);
            ctx.strokeStyle = color;
            ctx.lineWidth = lw;
            if (glow) {
                ctx.shadowColor = color;
                ctx.shadowBlur = 8;
            } else {
                ctx.shadowBlur = 0;
            }
            ctx.stroke();
        }

        // Bright tip
        const tip = points[points.length - 1];
        if (theta <= MAX_THETA) {
            const tipGlow = ctx.createRadialGradient(tip.x, tip.y, 0, tip.x, tip.y, 15);
            tipGlow.addColorStop(0, 'rgba(255,255,255,0.9)');
            tipGlow.addColorStop(0.5, getColor(tip.t, mode).replace(')', ',0.4)').replace('hsl(', 'hsla('));
            tipGlow.addColorStop(1, 'transparent');
            ctx.shadowBlur = 0;
            ctx.fillStyle = tipGlow;
            ctx.fillRect(tip.x - 15, tip.y - 15, 30, 30);
        }
    }

    // Progress
    const pct = Math.min(100, (theta / MAX_THETA) * 100).toFixed(0);
    document.getElementById('progress').textContent = theta <= MAX_THETA ? `${pct}%` : '';

    // Restart
    if (theta > MAX_THETA + 3) {
        ctx.fillStyle = '#0a0e1a';
        ctx.fillRect(0, 0, W, H);
        resetDraw();
    }

    requestAnimationFrame(draw);
}

['spSlider','lwSlider','scSlider','wfSlider','beSlider'].forEach(id => {
    document.getElementById(id).addEventListener('input', function() {
        document.getElementById(id.replace('Slider','Val')).textContent = this.value;
        if (id === 'wfSlider' || id === 'beSlider' || id === 'scSlider') resetDraw();
    });
});

document.addEventListener('keydown', function(e) {
    if (e.code === 'Space') { e.preventDefault(); animating = !animating; }
});

window.addEventListener('resize', resize);

window.reset = function() {
    document.getElementById('wfSlider').value = 2;
    document.getElementById('wfVal').textContent = '2';
    document.getElementById('beSlider').value = 5;
    document.getElementById('beVal').textContent = '5';
    document.getElementById('scSlider').value = 1;
    document.getElementById('scVal').textContent = '1';
    ctx.fillStyle = '#0a0e1a';
    ctx.fillRect(0, 0, W, H);
    resetDraw();
    animating = true;
};

resize();
draw();
</script>
<script src="../assets/js/enhance.js"></script>
</body>
</html>
