<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Epitrochoid - Circle Rolling Outside</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; overflow: hidden; font-family: 'Segoe UI', Arial, sans-serif; }
canvas { display: block; }
a.back { position: fixed; top: 20px; left: 20px; color: #8af; text-decoration: none; z-index: 100; font-size: 1.2em; }
a.back:hover { color: #bdf; }
#controls {
    position: fixed; top: 20px; right: 20px; background: rgba(10,14,30,0.7);
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(138,170,255,0.15); border-radius: 12px;
    padding: 18px; color: #cde; z-index: 100; width: 240px; font-size: 13px;
}
#controls h3 { margin-bottom: 10px; color: #8af; font-size: 15px; }
.ctrl-row { margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
.ctrl-row label { flex: 0 0 65px; }
.ctrl-row input[type=range] { flex: 1; margin: 0 8px; accent-color: #8af; }
.ctrl-row .val { flex: 0 0 35px; text-align: right; color: #8af; font-size: 12px; }
button {
    background: rgba(138,170,255,0.15); color: #8af; border: 1px solid rgba(138,170,255,0.3);
    border-radius: 6px; padding: 5px 10px; cursor: pointer; font-size: 12px; margin: 2px;
}
button:hover { background: rgba(138,170,255,0.3); }
.presets { display: flex; flex-wrap: wrap; margin-top: 8px; }
.toggle-row { margin: 8px 0; display: flex; align-items: center; gap: 8px; }
.toggle-row input { accent-color: #8af; }
select { background: #1a1e2a; color: #cde; border: 1px solid rgba(138,170,255,0.3); border-radius: 4px; padding: 3px; font-size: 12px; }
.info { margin-top: 10px; font-size: 11px; color: #89a; line-height: 1.4; }
#progress-bar { width: 100%; height: 4px; background: rgba(138,170,255,0.1); border-radius: 2px; overflow: hidden; margin-top: 8px; }
#progress-fill { height: 100%; background: linear-gradient(90deg, #f80, #f0f, #08f); width: 0%; }
</style>
</head>
<body>
<a href="index.html" class="back">&#8592; Back</a>
<canvas id="canvas"></canvas>
<div id="controls">
    <h3>Epitrochoid</h3>
    <div class="ctrl-row"><label>R (fixed)</label><input type="range" id="R" min="30" max="200" value="80"><span class="val" id="Rv">80</span></div>
    <div class="ctrl-row"><label>r (roll)</label><input type="range" id="r" min="10" max="120" value="40"><span class="val" id="rv">40</span></div>
    <div class="ctrl-row"><label>d (pen)</label><input type="range" id="d" min="5" max="150" value="40"><span class="val" id="dv">40</span></div>
    <div class="ctrl-row"><label>Speed</label><input type="range" id="speed" min="1" max="40" value="12"><span class="val" id="speedv">12</span></div>
    <div class="ctrl-row"><label>Width</label><input type="range" id="lw" min="1" max="5" value="2" step="0.5"><span class="val" id="lwv">2</span></div>
    <div class="ctrl-row"><label>Color</label><select id="colorMode"><option value="rainbow">Rainbow</option><option value="fire">Fire</option><option value="solid">Solid</option></select></div>
    <div class="toggle-row"><input type="checkbox" id="showMech" checked><label for="showMech">Show mechanism</label></div>
    <div class="presets">
        <button onclick="preset(80,80,80)">Cardioid</button>
        <button onclick="preset(80,80,50)">Lima&ccedil;on</button>
        <button onclick="preset(80,27,27)">Wankel</button>
        <button onclick="preset(80,30,60)">Loops</button>
    </div>
    <div id="progress-bar"><div id="progress-fill"></div></div>
    <div class="info" id="info">d=r: epicycloid (cusps touch)<br>d&lt;r: rounded | d&gt;r: self-intersecting</div>
</div>

<canvas id="trail"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const trail = document.getElementById('trail');
const tCtx = trail.getContext('2d');
trail.style.cssText = 'position:absolute;top:0;left:0;pointer-events:none;';

let W, H, cx, cy;
function resize() {
    W = canvas.width = trail.width = window.innerWidth;
    H = canvas.height = trail.height = window.innerHeight;
    cx = W / 2; cy = H / 2;
    redrawTrail();
}

const sliders = { R: 80, r: 40, d: 40, speed: 12, lw: 2 };
const els = {};
['R','r','d','speed','lw'].forEach(k => {
    els[k] = document.getElementById(k);
    els[k].oninput = () => { sliders[k] = parseFloat(els[k].value); document.getElementById(k+'v').textContent = sliders[k]; };
});

let colorMode = 'rainbow';
document.getElementById('colorMode').onchange = e => colorMode = e.target.value;
let showMech = true;
document.getElementById('showMech').onchange = e => showMech = e.target.checked;

let t = 0;
let points = [];
let paused = false;

function epitrochoid(t, R, r, d) {
    const sum = R + r;
    const ratio = sum / r;
    return {
        x: sum * Math.cos(t) - d * Math.cos(ratio * t),
        y: sum * Math.sin(t) - d * Math.sin(ratio * t)
    };
}

function getColor(t) {
    if (colorMode === 'solid') return '#f84';
    if (colorMode === 'fire') {
        const hue = ((t * 12) % 80) - 10;
        return `hsl(${hue}, 100%, ${55 + Math.sin(t*5)*10}%)`;
    }
    return `hsl(${(t * 15) % 360}, 80%, 60%)`;
}

function gcd(a, b) { a = Math.round(a); b = Math.round(b); while(b) { [a,b] = [b, a%b]; } return Math.max(a, 1); }

function closurePeriod(R, r) {
    const g = gcd(R, r);
    return (2 * Math.PI * r) / g;
}

function preset(R, r, d) {
    sliders.R = R; sliders.r = r; sliders.d = d;
    els.R.value = R; els.r.value = r; els.d.value = d;
    document.getElementById('Rv').textContent = R;
    document.getElementById('rv').textContent = r;
    document.getElementById('dv').textContent = d;
    resetAnim();
}

function resetAnim() {
    t = 0; points = [];
    tCtx.clearRect(0, 0, W, H);
}

function redrawTrail() {
    tCtx.clearRect(0, 0, W, H);
    if (points.length < 2) return;
    for (let i = 1; i < points.length; i++) {
        tCtx.beginPath();
        tCtx.moveTo(points[i-1].x + cx, points[i-1].y + cy);
        tCtx.lineTo(points[i].x + cx, points[i].y + cy);
        tCtx.strokeStyle = points[i].color;
        tCtx.lineWidth = sliders.lw;
        tCtx.shadowBlur = 8;
        tCtx.shadowColor = points[i].color;
        tCtx.stroke();
    }
    tCtx.shadowBlur = 0;
}

function updateInfo() {
    const { r, d } = sliders;
    let type = '';
    if (Math.abs(d - r) < 2) type = 'Epicycloid (cusps touch)';
    else if (d < r) type = 'Rounded loops (d < r)';
    else type = 'Self-intersecting (d > r)';
    document.getElementById('info').textContent = type;
}

function animate() {
    requestAnimationFrame(animate);
    ctx.clearRect(0, 0, W, H);

    const { R, r, d, speed } = sliders;
    const maxT = closurePeriod(R, r);
    const dt = speed * 0.002;

    if (!paused && t < maxT + dt) {
        for (let i = 0; i < 3; i++) {
            if (t > maxT) break;
            t += dt;
            const p = epitrochoid(t, R, r, d);
            p.color = getColor(t);
            points.push(p);
            if (points.length > 1) {
                const prev = points[points.length - 2];
                tCtx.beginPath();
                tCtx.moveTo(prev.x + cx, prev.y + cy);
                tCtx.lineTo(p.x + cx, p.y + cy);
                tCtx.strokeStyle = p.color;
                tCtx.lineWidth = sliders.lw;
                tCtx.shadowBlur = 10;
                tCtx.shadowColor = p.color;
                tCtx.stroke();
                tCtx.shadowBlur = 0;
            }
        }
    }

    document.getElementById('progress-fill').style.width = Math.min(100, (t / maxT) * 100) + '%';
    updateInfo();

    if (showMech) {
        const sum = R + r;
        const ratio = sum / r;

        // Fixed inner circle
        ctx.beginPath();
        ctx.arc(cx, cy, R, 0, Math.PI * 2);
        ctx.strokeStyle = 'rgba(138,170,255,0.25)';
        ctx.lineWidth = 1;
        ctx.stroke();

        // Rolling outer circle
        const rollCx = cx + sum * Math.cos(t);
        const rollCy = cy + sum * Math.sin(t);
        ctx.beginPath();
        ctx.arc(rollCx, rollCy, r, 0, Math.PI * 2);
        ctx.strokeStyle = 'rgba(138,170,255,0.4)';
        ctx.lineWidth = 1.5;
        ctx.stroke();

        // Center of rolling circle
        ctx.beginPath();
        ctx.arc(rollCx, rollCy, 3, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(138,170,255,0.5)';
        ctx.fill();

        // Pen arm
        const penX = cx + sum * Math.cos(t) - d * Math.cos(ratio * t);
        const penY = cy + sum * Math.sin(t) - d * Math.sin(ratio * t);
        ctx.beginPath();
        ctx.moveTo(rollCx, rollCy);
        ctx.lineTo(penX, penY);
        ctx.strokeStyle = 'rgba(255,140,100,0.5)';
        ctx.lineWidth = 1;
        ctx.stroke();

        ctx.beginPath();
        ctx.arc(penX, penY, 4, 0, Math.PI * 2);
        ctx.fillStyle = '#f84';
        ctx.shadowBlur = 12;
        ctx.shadowColor = '#f84';
        ctx.fill();
        ctx.shadowBlur = 0;

        // Contact point indicator
        const contactX = cx + R * Math.cos(t);
        const contactY = cy + R * Math.sin(t);
        ctx.beginPath();
        ctx.arc(contactX, contactY, 3, 0, Math.PI * 2);
        ctx.fillStyle = '#4f8';
        ctx.fill();
    }
}

window.reset = function() {
    resetAnim();
};

window.addEventListener('resize', resize);
resize();
animate();
</script>
<script src="../assets/js/enhance.js"></script>
</body>
</html>
