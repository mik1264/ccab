<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pursuit Curves - The Geometry of Chasing</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; overflow: hidden; font-family: 'Segoe UI', Arial, sans-serif; }
canvas { display: block; }
a.back { position: fixed; top: 20px; left: 20px; color: #8af; text-decoration: none; z-index: 100; font-size: 1.2em; }
a.back:hover { color: #bdf; }
#controls {
  position: fixed; top: 20px; right: 20px; background: rgba(10,14,26,0.8);
  backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
  padding: 18px; border-radius: 12px; color: #cde; z-index: 100;
  border: 1px solid rgba(138,170,255,0.15); min-width: 210px; font-size: 0.9em;
}
#controls h3 { margin-bottom: 10px; color: #8af; font-size: 1.05em; }
.ctrl-row { margin-bottom: 8px; }
.ctrl-row label { display: block; margin-bottom: 3px; font-size: 0.85em; color: #9ab; }
.ctrl-row select, .ctrl-row input[type=range] { width: 100%; }
select { background: #161c30; color: #cde; border: 1px solid #335; padding: 4px; border-radius: 4px; }
input[type=range] { accent-color: #8af; }
.ctrl-row .cb { display: flex; align-items: center; gap: 6px; }
.ctrl-row .cb input { accent-color: #8af; }
button { background: #1a2540; color: #8af; border: 1px solid #335; padding: 6px 14px; border-radius: 6px; cursor: pointer; width: 100%; margin-top: 4px; }
button:hover { background: #253060; }
#stats {
  position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
  background: rgba(10,14,26,0.8); backdrop-filter: blur(10px);
  padding: 12px 20px; border-radius: 10px; color: #9ab; font-size: 0.82em;
  border: 1px solid rgba(138,170,255,0.1); text-align: center; max-width: 600px; z-index: 100;
}
</style>
</head>
<body>
<a href="index.html" class="back">&#8592; Back</a>
<canvas id="c"></canvas>
<div id="controls">
  <h3>Pursuit Curves</h3>
  <div class="ctrl-row">
    <label>Agents: <span id="numVal">4</span></label>
    <input type="range" id="numAgents" min="3" max="12" step="1" value="4">
  </div>
  <div class="ctrl-row">
    <label>Speed: <span id="speedVal">1.0</span></label>
    <input type="range" id="speed" min="0.2" max="3" step="0.1" value="1">
  </div>
  <div class="ctrl-row">
    <label>Chase Target</label>
    <select id="chaseMode">
      <option value="1">Next agent (+1)</option>
      <option value="2">Skip one (+2)</option>
      <option value="3">Skip two (+3)</option>
    </select>
  </div>
  <div class="ctrl-row">
    <label>Polygon Size: <span id="sizeVal">250</span></label>
    <input type="range" id="polySize" min="80" max="400" step="10" value="250">
  </div>
  <div class="ctrl-row">
    <div class="cb"><input type="checkbox" id="showLines" checked><label>Show Pursuit Lines</label></div>
  </div>
  <div class="ctrl-row">
    <div class="cb"><input type="checkbox" id="showPoly"><label>Show Starting Polygon</label></div>
  </div>
  <div class="ctrl-row">
    <button id="resetBtn">Reset</button>
  </div>
</div>
<div id="stats">
  N agents at polygon vertices, each chasing the next clockwise. The resulting paths are logarithmic spirals converging to the center.
  <span id="pathLen"></span>
</div>
<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let W, H;
function resize() { W = canvas.width = innerWidth; H = canvas.height = innerHeight; }
resize();
window.addEventListener('resize', resize);

const numAgentsEl = document.getElementById('numAgents');
const speedEl = document.getElementById('speed');
const chaseModeEl = document.getElementById('chaseMode');
const polySizeEl = document.getElementById('polySize');
const showLinesEl = document.getElementById('showLines');
const showPolyEl = document.getElementById('showPoly');
const resetBtn = document.getElementById('resetBtn');
const pathLenEl = document.getElementById('pathLen');

numAgentsEl.oninput = () => { document.getElementById('numVal').textContent = numAgentsEl.value; initAgents(); };
speedEl.oninput = () => document.getElementById('speedVal').textContent = parseFloat(speedEl.value).toFixed(1);
polySizeEl.oninput = () => { document.getElementById('sizeVal').textContent = polySizeEl.value; initAgents(); };
chaseModeEl.onchange = initAgents;
resetBtn.onclick = initAgents;

const agentColors = [
  '#ff4466', '#ffaa22', '#44ff88', '#44aaff', '#cc66ff',
  '#ff8844', '#88ff44', '#44ffcc', '#8866ff', '#ff44aa',
  '#ffff44', '#44ffff'
];

let agents = [];
let trails = [];
let startPositions = [];
let converged = false;
let totalDist = [];

function initAgents() {
  const n = parseInt(numAgentsEl.value);
  const r = parseInt(polySizeEl.value);
  const cx = W / 2, cy = H / 2;

  agents = [];
  trails = [];
  startPositions = [];
  totalDist = [];
  converged = false;

  for (let i = 0; i < n; i++) {
    const angle = (i / n) * Math.PI * 2 - Math.PI / 2;
    const x = cx + r * Math.cos(angle);
    const y = cy + r * Math.sin(angle);
    agents.push({ x, y });
    startPositions.push({ x, y });
    trails.push([{ x, y }]);
    totalDist.push(0);
  }

  ctx.clearRect(0, 0, W, H);
}

function step() {
  if (converged) return;

  const n = agents.length;
  const skip = parseInt(chaseModeEl.value);
  const spd = parseFloat(speedEl.value) * 1.2;

  // Check convergence
  let maxDist = 0;
  for (let i = 0; i < n; i++) {
    const target = agents[(i + skip) % n];
    const dx = target.x - agents[i].x;
    const dy = target.y - agents[i].y;
    maxDist = Math.max(maxDist, Math.sqrt(dx * dx + dy * dy));
  }
  if (maxDist < 2) { converged = true; return; }

  // Move each agent toward its target
  const newPos = agents.map((a, i) => {
    const target = agents[(i + skip) % n];
    const dx = target.x - a.x;
    const dy = target.y - a.y;
    const dist = Math.sqrt(dx * dx + dy * dy);
    if (dist < 1) return { x: a.x, y: a.y };
    const moveD = Math.min(spd, dist);
    return { x: a.x + (dx / dist) * moveD, y: a.y + (dy / dist) * moveD };
  });

  for (let i = 0; i < n; i++) {
    const dx = newPos[i].x - agents[i].x;
    const dy = newPos[i].y - agents[i].y;
    totalDist[i] += Math.sqrt(dx * dx + dy * dy);
    agents[i] = newPos[i];
    trails[i].push({ x: agents[i].x, y: agents[i].y });
    // Limit trail length
    if (trails[i].length > 5000) trails[i].shift();
  }
}

function drawStartingPolygon() {
  if (!showPolyEl.checked || startPositions.length < 3) return;
  ctx.beginPath();
  for (let i = 0; i < startPositions.length; i++) {
    const p = startPositions[i];
    i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y);
  }
  ctx.closePath();
  ctx.strokeStyle = 'rgba(255,255,255,0.1)';
  ctx.lineWidth = 1;
  ctx.stroke();
}

function animate() {
  ctx.fillStyle = 'rgba(10,14,26,0.06)';
  ctx.fillRect(0, 0, W, H);

  // Multiple steps per frame for smoother animation
  for (let s = 0; s < 3; s++) step();

  const n = agents.length;
  const skip = parseInt(chaseModeEl.value);

  // Draw starting polygon
  drawStartingPolygon();

  // Draw trails
  for (let i = 0; i < n; i++) {
    const trail = trails[i];
    if (trail.length < 2) continue;

    ctx.beginPath();
    ctx.moveTo(trail[0].x, trail[0].y);
    for (let j = 1; j < trail.length; j++) {
      ctx.lineTo(trail[j].x, trail[j].y);
    }
    ctx.strokeStyle = agentColors[i % agentColors.length];
    ctx.lineWidth = 2;
    ctx.shadowColor = agentColors[i % agentColors.length];
    ctx.shadowBlur = 6;
    ctx.stroke();
    ctx.shadowBlur = 0;
  }

  // Draw pursuit lines
  if (showLinesEl.checked && !converged) {
    for (let i = 0; i < n; i++) {
      const a = agents[i];
      const target = agents[(i + skip) % n];
      ctx.beginPath();
      ctx.moveTo(a.x, a.y);
      ctx.lineTo(target.x, target.y);
      ctx.strokeStyle = 'rgba(255,255,255,0.12)';
      ctx.lineWidth = 0.8;
      ctx.stroke();
    }
  }

  // Draw agents
  for (let i = 0; i < n; i++) {
    const a = agents[i];
    ctx.beginPath();
    ctx.arc(a.x, a.y, converged ? 3 : 5, 0, Math.PI * 2);
    ctx.fillStyle = agentColors[i % agentColors.length];
    ctx.shadowColor = agentColors[i % agentColors.length];
    ctx.shadowBlur = converged ? 5 : 15;
    ctx.fill();
    ctx.shadowBlur = 0;
  }

  // Center point glow when converged
  if (converged) {
    const cx = W / 2, cy = H / 2;
    const grad = ctx.createRadialGradient(cx, cy, 0, cx, cy, 30);
    grad.addColorStop(0, 'rgba(255,255,255,0.5)');
    grad.addColorStop(1, 'rgba(255,255,255,0)');
    ctx.beginPath();
    ctx.arc(cx, cy, 30, 0, Math.PI * 2);
    ctx.fillStyle = grad;
    ctx.fill();

    ctx.fillStyle = '#8af';
    ctx.font = 'bold 16px "Segoe UI", sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('All agents converged at the center!', W / 2, H * 0.08);
  }

  // Path length
  if (totalDist[0] > 0) {
    const avgDist = totalDist.reduce((a, b) => a + b, 0) / n;
    // Theoretical: for n agents on polygon of side s, total path = s / (1 - cos(2pi/n))
    // per agent = s / (n * (1 - cos(2pi/n))) ... but simpler: side / (1 - cos(2pi/n))
    pathLenEl.textContent = ` | Avg path length: ${avgDist.toFixed(0)}px`;
  }

  requestAnimationFrame(animate);
}

window.reset = function() { initAgents(); };

initAgents();
animate();
</script>
<script src="../assets/js/enhance.js"></script>
</body>
</html>
