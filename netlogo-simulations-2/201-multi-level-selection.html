<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Level Selection - CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #1a1a2e; color: #e8e6e1; overflow: hidden; }
        #container { display: flex; height: 100vh; }
        #canvas-container { flex: 1; position: relative; }
        canvas { display: block; width: 100%; height: 100%; }
        #controls { width: 300px; background: rgba(0,0,0,0.8); padding: 20px; overflow-y: auto; }
        h1 { font-size: 1.2rem; margin-bottom: 15px; color: #10b981; }
        .control-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: #aaa; }
        input[type="range"] { width: 100%; }
        button { width: 100%; padding: 10px; margin-bottom: 10px; background: #10b981; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { opacity: 0.9; }
        .stats { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; font-size: 0.8rem; }
        .back-link { position: fixed; top: 10px; left: 10px; padding: 8px 16px; background: rgba(0,0,0,0.7); color: #10b981; text-decoration: none; border-radius: 6px; font-size: 14px; z-index: 999; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Gallery</a>
    <div id="container">
        <div id="canvas-container"><canvas id="canvas"></canvas></div>
        <div id="controls">
            <h1>Multi-Level Selection</h1>
            <div class="control-group">
                <label>Selection Strength: <span id="p1Value">0.5</span></label>
                <input type="range" id="p1" min="0" max="1" step="0.1" value="0.5">
            </div>
            <div class="control-group">
                <label>Modification Rate: <span id="p2Value">0.5</span></label>
                <input type="range" id="p2" min="0" max="1" step="0.1" value="0.5">
            </div>
            <button id="reset">Reset</button>
            <button id="action">Generation</button>
            <button id="run">Run/Pause</button>
            <div class="stats">
                <div>Population: <span id="count">0</span></div>
                <div>Fitness: <span id="metric">0</span></div>
            </div>
        </div>
    </div>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let params = { p1: 0.5, p2: 0.5 };
        let agents = [];
        let environment = [];
        let generation = 0;
        let running = false;
        const color = '#10b981';
        const GRID = 30;

        function resize() { canvas.width = document.getElementById('canvas-container').clientWidth; canvas.height = document.getElementById('canvas-container').clientHeight; }
        
        function init() {
            resize();
            agents = [];
            environment = [];
            generation = 0;
            
            const w = Math.floor((canvas.width - 350) / GRID);
            const h = Math.floor((canvas.height - 50) / GRID);
            
            // Initialize environment
            for (let i = 0; i < w * h; i++) {
                environment.push(Math.random());
            }
            
            // Initialize agents
            for (let i = 0; i < 50; i++) {
                agents.push({
                    x: Math.floor(Math.random() * w),
                    y: Math.floor(Math.random() * h),
                    trait: Math.random(),
                    fitness: 0
                });
            }
        }

        function step() {
            const w = Math.floor((canvas.width - 350) / GRID);
            
            // Calculate fitness based on environment match
            for (let a of agents) {
                const idx = a.y * w + a.x;
                const envValue = environment[idx] || 0;
                a.fitness = 1 - Math.abs(a.trait - envValue);
                
                // Niche construction: modify environment
                if (Math.random() < params.p2 * 0.1) {
                    environment[idx] = environment[idx] * 0.9 + a.trait * 0.1;
                }
            }
            
            // Selection
            agents.sort((a, b) => b.fitness - a.fitness);
            const survivors = agents.slice(0, Math.floor(agents.length * 0.5));
            
            // Reproduction
            agents = [];
            while (agents.length < 50) {
                const parent = survivors[Math.floor(Math.random() * survivors.length)];
                const mutation = (Math.random() - 0.5) * params.p1 * 0.2;
                agents.push({
                    x: parent.x + Math.floor(Math.random() * 3) - 1,
                    y: parent.y + Math.floor(Math.random() * 3) - 1,
                    trait: Math.max(0, Math.min(1, parent.trait + mutation)),
                    fitness: 0
                });
            }
            
            generation++;
        }

        function draw() {
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const w = Math.floor((canvas.width - 350) / GRID);
            const h = Math.floor((canvas.height - 50) / GRID);
            
            // Draw environment
            for (let y = 0; y < h; y++) {
                for (let x = 0; x < w; x++) {
                    const idx = y * w + x;
                    const val = environment[idx] || 0;
                    ctx.fillStyle = 'hsl(' + (val * 120) + ', 50%, ' + (20 + val * 30) + '%)';
                    ctx.fillRect(25 + x * GRID, 25 + y * GRID, GRID - 1, GRID - 1);
                }
            }
            
            // Draw agents
            for (let a of agents) {
                ctx.beginPath();
                ctx.arc(25 + a.x * GRID + GRID/2, 25 + a.y * GRID + GRID/2, GRID/3, 0, Math.PI * 2);
                ctx.fillStyle = 'hsl(' + (a.trait * 120) + ', 80%, 50%)';
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 1;
                ctx.stroke();
            }

            const avgFitness = agents.reduce((s, a) => s + a.fitness, 0) / agents.length;
            document.getElementById('count').textContent = agents.length + ' (Gen ' + generation + ')';
            document.getElementById('metric').textContent = avgFitness.toFixed(3);
        }

        function animate() {
            if (running) step();
            draw();
            requestAnimationFrame(animate);
        }

        document.getElementById('p1').addEventListener('input', e => { params.p1 = parseFloat(e.target.value); document.getElementById('p1Value').textContent = params.p1; });
        document.getElementById('p2').addEventListener('input', e => { params.p2 = parseFloat(e.target.value); document.getElementById('p2Value').textContent = params.p2; });
        document.getElementById('reset').addEventListener('click', init);
        document.getElementById('action').addEventListener('click', step);
        document.getElementById('run').addEventListener('click', () => { running = !running; document.getElementById('run').textContent = running ? 'Pause' : 'Run'; });
        window.addEventListener('resize', resize);

        init(); animate();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
