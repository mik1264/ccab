<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urban Air Quality - Pollution Dispersion Simulation</title>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600&family=Nunito:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Nunito', sans-serif; background: linear-gradient(135deg, #FEFAE0 0%, #F4F1DE 50%, #EDE8D5 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 20px; }
        h1 { font-family: 'Lora', serif; color: #606C38; font-size: 2rem; margin-bottom: 8px; }
        .subtitle { color: #8A9A5B; font-size: 1rem; }
        .back-link { position: absolute; top: 20px; left: 20px; text-decoration: none; color: #606C38; font-weight: 600; }
        .main-content { display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        .canvas-container { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        canvas { width: 100%; border-radius: 8px; display: block; }
        .controls { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); height: fit-content; }
        .control-group { margin-bottom: 18px; }
        .control-group label { display: block; color: #606C38; font-weight: 600; margin-bottom: 5px; font-size: 0.9rem; }
        .control-group input[type="range"] { width: 100%; accent-color: #8A9A5B; }
        .control-group select { width: 100%; padding: 8px; border: 1px solid #DDA15E; border-radius: 6px; font-family: inherit; }
        .control-value { text-align: right; color: #8A9A5B; font-size: 0.85rem; }
        button { width: 100%; padding: 10px; margin-top: 5px; border: none; border-radius: 8px; cursor: pointer; font-family: 'Nunito', sans-serif; font-weight: 600; font-size: 0.9rem; transition: all 0.3s; }
        .btn-primary { background: #8A9A5B; color: white; }
        .btn-secondary { background: #DDA15E; color: white; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .stat-box { background: linear-gradient(135deg, #FEFAE0, #F4F1DE); padding: 10px; border-radius: 8px; text-align: center; }
        .stat-value { font-family: 'Lora', serif; color: #606C38; font-size: 1.1rem; font-weight: 600; }
        .stat-label { color: #8A9A5B; font-size: 0.75rem; }
        .info-panel { margin-top: 15px; padding: 12px; background: #F4F1DE; border-radius: 8px; font-size: 0.8rem; color: #606C38; }
        .aqi-scale { display: flex; height: 20px; border-radius: 4px; overflow: hidden; margin-top: 10px; }
        .aqi-segment { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; color: white; }
        .source-toggle { display: flex; gap: 5px; flex-wrap: wrap; }
        .source-btn { flex: 1; min-width: 80px; padding: 6px; font-size: 0.75rem; border: 2px solid #8A9A5B; background: white; color: #606C38; border-radius: 4px; }
        .source-btn.active { background: #8A9A5B; color: white; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Gallery</a>
    <div class="container">
        <header>
            <h1>Urban Air Quality Model</h1>
            <p class="subtitle">Gaussian plume dispersion with PM2.5, NOx, and O3 from multiple emission sources</p>
        </header>
        <div class="main-content">
            <div class="canvas-container">
                <canvas id="simCanvas"></canvas>
            </div>
            <div class="controls">
                <div class="control-group">
                    <label>Atmospheric Stability</label>
                    <select id="stability">
                        <option value="A">A - Very Unstable (sunny)</option>
                        <option value="B">B - Moderately Unstable</option>
                        <option value="C">C - Slightly Unstable</option>
                        <option value="D" selected>D - Neutral</option>
                        <option value="E">E - Slightly Stable</option>
                        <option value="F">F - Stable (night)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Wind Speed (m/s)</label>
                    <input type="range" id="windSpeed" min="1" max="15" value="5">
                    <div class="control-value"><span id="windSpeedVal">5</span></div>
                </div>
                <div class="control-group">
                    <label>Mixing Height (m)</label>
                    <input type="range" id="mixingHeight" min="200" max="2000" value="800">
                    <div class="control-value"><span id="mixingHeightVal">800</span></div>
                </div>
                <div class="control-group">
                    <label>Emission Sources</label>
                    <div class="source-toggle">
                        <button class="source-btn active" id="toggleTraffic" onclick="toggleSource('traffic')">üöó Traffic</button>
                        <button class="source-btn active" id="toggleIndustry" onclick="toggleSource('industry')">üè≠ Industry</button>
                        <button class="source-btn" id="togglePower" onclick="toggleSource('power')">‚ö° Power</button>
                        <button class="source-btn" id="toggleResidential" onclick="toggleSource('residential')">üè† Heating</button>
                    </div>
                </div>
                <div class="control-group">
                    <label>Pollutant Display</label>
                    <select id="pollutant">
                        <option value="pm25" selected>PM2.5</option>
                        <option value="nox">NOx</option>
                        <option value="o3">Ozone (O3)</option>
                        <option value="aqi">Combined AQI</option>
                    </select>
                </div>
                <button class="btn-primary" onclick="toggleSimulation()">Start/Pause</button>
                <button class="btn-secondary" onclick="resetSimulation()">Reset</button>

                <div class="stats-grid">
                    <div class="stat-box"><div class="stat-value" id="avgPM25">0</div><div class="stat-label">Avg PM2.5 Œºg/m¬≥</div></div>
                    <div class="stat-box"><div class="stat-value" id="maxPM25">0</div><div class="stat-label">Max PM2.5</div></div>
                    <div class="stat-box"><div class="stat-value" id="avgAQI">0</div><div class="stat-label">Avg AQI</div></div>
                    <div class="stat-box"><div class="stat-value" id="exceedances">0%</div><div class="stat-label">>WHO Limit</div></div>
                </div>

                <div style="margin-top: 15px;">
                    <label style="color: #606C38; font-weight: 600; font-size: 0.85rem;">AQI Scale</label>
                    <div class="aqi-scale">
                        <div class="aqi-segment" style="background:#00e400">Good</div>
                        <div class="aqi-segment" style="background:#ffff00; color:#333">Mod</div>
                        <div class="aqi-segment" style="background:#ff7e00">USG</div>
                        <div class="aqi-segment" style="background:#ff0000">Unhlt</div>
                        <div class="aqi-segment" style="background:#8f3f97">V.Unh</div>
                        <div class="aqi-segment" style="background:#7e0023">Hazrd</div>
                    </div>
                </div>

                <div class="info-panel">
                    <strong>Gaussian Plume Model:</strong> EPA AERMOD-inspired dispersion using Pasquill-Gifford stability classes. Concentrations depend on emission rate, wind speed, and atmospheric turbulence.
                </div>
            </div>
        </div>
    </div>
    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');

        function setupCanvas() {
            const rect = canvas.parentElement.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            canvas.width = rect.width * dpr;
            canvas.height = (rect.width * 0.65) * dpr;
            canvas.style.height = (rect.width * 0.65) + 'px';
            ctx.scale(dpr, dpr);
            return { width: rect.width, height: rect.width * 0.65 };
        }

        let dims = setupCanvas();
        window.addEventListener('resize', () => { dims = setupCanvas(); draw(); });

        // Pasquill-Gifford dispersion coefficients
        const stabilityCoeffs = {
            A: { sy: { a: 0.22, b: 0.0001, c: 0.5 }, sz: { a: 0.20, b: 0 } },
            B: { sy: { a: 0.16, b: 0.0001, c: 0.5 }, sz: { a: 0.12, b: 0 } },
            C: { sy: { a: 0.11, b: 0.0001, c: 0.5 }, sz: { a: 0.08, b: 0.0002 } },
            D: { sy: { a: 0.08, b: 0.0001, c: 0.5 }, sz: { a: 0.06, b: 0.0015 } },
            E: { sy: { a: 0.06, b: 0.0001, c: 0.5 }, sz: { a: 0.03, b: 0.0003 } },
            F: { sy: { a: 0.04, b: 0.0001, c: 0.5 }, sz: { a: 0.016, b: 0.0003 } }
        };

        // Emission sources
        const sources = {
            traffic: {
                active: true,
                locations: [],
                emission: { pm25: 50, nox: 200, voc: 100 },
                height: 2,
                color: '#ff6b6b'
            },
            industry: {
                active: true,
                locations: [],
                emission: { pm25: 500, nox: 800, voc: 300 },
                height: 50,
                color: '#4ecdc4'
            },
            power: {
                active: false,
                locations: [],
                emission: { pm25: 200, nox: 1500, voc: 50 },
                height: 100,
                color: '#ffe66d'
            },
            residential: {
                active: false,
                locations: [],
                emission: { pm25: 30, nox: 50, voc: 80 },
                height: 10,
                color: '#95e1d3'
            }
        };

        let state = {
            running: false,
            time: 0,
            windAngle: 0,
            concentrationGrid: null,
            gridSize: 80
        };

        function initSources() {
            // Traffic sources (roads)
            sources.traffic.locations = [];
            for (let i = 0; i < 15; i++) {
                sources.traffic.locations.push({
                    x: dims.width * 0.1 + Math.random() * dims.width * 0.8,
                    y: dims.height * 0.2 + Math.random() * dims.height * 0.6
                });
            }

            // Industrial sources
            sources.industry.locations = [
                { x: dims.width * 0.15, y: dims.height * 0.25 },
                { x: dims.width * 0.85, y: dims.height * 0.3 }
            ];

            // Power plant
            sources.power.locations = [
                { x: dims.width * 0.1, y: dims.height * 0.8 }
            ];

            // Residential heating
            sources.residential.locations = [];
            for (let i = 0; i < 20; i++) {
                sources.residential.locations.push({
                    x: dims.width * 0.3 + Math.random() * dims.width * 0.4,
                    y: dims.height * 0.3 + Math.random() * dims.height * 0.4
                });
            }

            // Initialize concentration grid
            state.concentrationGrid = new Float32Array(state.gridSize * state.gridSize * 4);
        }

        function gaussianPlume(x, y, source, wind, stability, mixingHeight) {
            const dx = x - source.x;
            const dy = y - source.y;

            // Rotate to wind coordinates
            const cos = Math.cos(wind.angle);
            const sin = Math.sin(wind.angle);
            const downwind = dx * cos + dy * sin;
            const crosswind = -dx * sin + dy * cos;

            if (downwind < 10) return { pm25: 0, nox: 0, o3: 0 };

            const coeff = stabilityCoeffs[stability];

            // Dispersion parameters (simplified Briggs formulas)
            const sigmaY = coeff.sy.a * downwind * Math.pow(1 + coeff.sy.b * downwind, -coeff.sy.c);
            const sigmaZ = coeff.sz.a * downwind / Math.pow(1 + coeff.sz.b * downwind, 0.5);

            // Effective stack height (simplified)
            const H = source.height;

            // Gaussian concentration formula
            const lateralTerm = Math.exp(-0.5 * Math.pow(crosswind / sigmaY, 2));

            // Reflection from ground and mixing height
            const z = 2; // receptor height
            const verticalTerm = Math.exp(-0.5 * Math.pow((z - H) / sigmaZ, 2)) +
                                 Math.exp(-0.5 * Math.pow((z + H) / sigmaZ, 2));

            // Add reflection from mixing height if plume reaches it
            let mixingReflection = 0;
            if (sigmaZ > mixingHeight * 0.5) {
                mixingReflection = Math.exp(-0.5 * Math.pow((2 * mixingHeight - z - H) / sigmaZ, 2));
            }

            const Q_factor = 1 / (2 * Math.PI * wind.speed * sigmaY * sigmaZ);
            const concentration = Q_factor * lateralTerm * (verticalTerm + mixingReflection);

            return {
                pm25: source.emission.pm25 * concentration * 1000,
                nox: source.emission.nox * concentration * 1000,
                o3: 0 // Will be calculated from NOx photochemistry
            };
        }

        function calculateOzone(nox, time) {
            // Simplified photochemistry: O3 forms from NOx + VOC + sunlight
            const hour = (time * 0.5) % 24;
            const sunlight = Math.max(0, Math.sin((hour - 6) / 12 * Math.PI));
            return nox * 0.1 * sunlight; // Very simplified
        }

        function update() {
            if (!state.running) return;

            const stability = document.getElementById('stability').value;
            const windSpeed = parseInt(document.getElementById('windSpeed').value);
            const mixingHeight = parseInt(document.getElementById('mixingHeight').value);

            state.time += 0.1;
            state.windAngle += (Math.random() - 0.5) * 0.02;

            const wind = { speed: windSpeed, angle: state.windAngle };
            const cellW = dims.width / state.gridSize;
            const cellH = dims.height / state.gridSize;

            // Calculate concentrations at each grid point
            let totalPM25 = 0, maxPM25 = 0, totalAQI = 0, exceedCount = 0;
            let gridCount = 0;

            for (let i = 0; i < state.gridSize; i++) {
                for (let j = 0; j < state.gridSize; j++) {
                    const x = (i + 0.5) * cellW;
                    const y = (j + 0.5) * cellH;

                    let pm25 = 0, nox = 0;

                    // Sum contributions from all active sources
                    Object.values(sources).forEach(source => {
                        if (!source.active) return;
                        source.locations.forEach(loc => {
                            const conc = gaussianPlume(x, y, { ...loc, ...source }, wind, stability, mixingHeight);
                            pm25 += conc.pm25;
                            nox += conc.nox;
                        });
                    });

                    // Background concentrations
                    pm25 += 5;
                    nox += 10;

                    const o3 = calculateOzone(nox, state.time) + 30; // Background O3

                    // Store in grid
                    const idx = (j * state.gridSize + i) * 4;
                    state.concentrationGrid[idx] = pm25;
                    state.concentrationGrid[idx + 1] = nox;
                    state.concentrationGrid[idx + 2] = o3;
                    state.concentrationGrid[idx + 3] = pm25ToAQI(pm25);

                    // Stats
                    totalPM25 += pm25;
                    maxPM25 = Math.max(maxPM25, pm25);
                    totalAQI += state.concentrationGrid[idx + 3];
                    if (pm25 > 15) exceedCount++; // WHO annual guideline
                    gridCount++;
                }
            }

            // Update stats display
            document.getElementById('avgPM25').textContent = (totalPM25 / gridCount).toFixed(1);
            document.getElementById('maxPM25').textContent = maxPM25.toFixed(0);
            document.getElementById('avgAQI').textContent = Math.round(totalAQI / gridCount);
            document.getElementById('exceedances').textContent = (exceedCount / gridCount * 100).toFixed(0) + '%';

            draw();
            requestAnimationFrame(update);
        }

        function pm25ToAQI(pm25) {
            // EPA AQI breakpoints for PM2.5
            if (pm25 <= 12) return pm25 / 12 * 50;
            if (pm25 <= 35.4) return 50 + (pm25 - 12) / 23.4 * 50;
            if (pm25 <= 55.4) return 100 + (pm25 - 35.4) / 20 * 50;
            if (pm25 <= 150.4) return 150 + (pm25 - 55.4) / 95 * 50;
            if (pm25 <= 250.4) return 200 + (pm25 - 150.4) / 100 * 100;
            return 300 + (pm25 - 250.4) / 100 * 100;
        }

        function aqiToColor(aqi) {
            if (aqi <= 50) return `rgba(0, 228, 0, ${0.3 + aqi/50 * 0.4})`;
            if (aqi <= 100) return `rgba(255, 255, 0, ${0.4 + (aqi-50)/50 * 0.3})`;
            if (aqi <= 150) return `rgba(255, 126, 0, ${0.5 + (aqi-100)/50 * 0.3})`;
            if (aqi <= 200) return `rgba(255, 0, 0, ${0.6 + (aqi-150)/50 * 0.2})`;
            if (aqi <= 300) return `rgba(143, 63, 151, ${0.7 + (aqi-200)/100 * 0.2})`;
            return `rgba(126, 0, 35, 0.9)`;
        }

        function draw() {
            // Sky gradient based on air quality
            const gradient = ctx.createLinearGradient(0, 0, 0, dims.height);
            gradient.addColorStop(0, '#87CEEB');
            gradient.addColorStop(1, '#E0F0FF');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, dims.width, dims.height);

            const pollutant = document.getElementById('pollutant').value;
            const cellW = dims.width / state.gridSize;
            const cellH = dims.height / state.gridSize;

            // Draw concentration heatmap
            if (state.concentrationGrid) {
                for (let i = 0; i < state.gridSize; i++) {
                    for (let j = 0; j < state.gridSize; j++) {
                        const idx = (j * state.gridSize + i) * 4;
                        let value, color;

                        switch (pollutant) {
                            case 'pm25':
                                value = state.concentrationGrid[idx];
                                color = aqiToColor(pm25ToAQI(value));
                                break;
                            case 'nox':
                                value = state.concentrationGrid[idx + 1];
                                const noxNorm = Math.min(value / 200, 1);
                                color = `rgba(139, 69, 19, ${noxNorm * 0.7})`;
                                break;
                            case 'o3':
                                value = state.concentrationGrid[idx + 2];
                                const o3Norm = Math.min(value / 150, 1);
                                color = `rgba(150, 100, 200, ${o3Norm * 0.6})`;
                                break;
                            case 'aqi':
                                color = aqiToColor(state.concentrationGrid[idx + 3]);
                                break;
                        }

                        ctx.fillStyle = color;
                        ctx.fillRect(i * cellW, j * cellH, cellW + 1, cellH + 1);
                    }
                }
            }

            // Draw city elements
            // Buildings
            ctx.fillStyle = '#555';
            for (let i = 0; i < 30; i++) {
                const bx = dims.width * 0.25 + (i % 10) * dims.width * 0.05;
                const by = dims.height * 0.35 + Math.floor(i / 10) * dims.height * 0.15;
                const bh = 20 + Math.random() * 30;
                ctx.fillRect(bx, by - bh, 15, bh);
            }

            // Draw emission sources
            Object.entries(sources).forEach(([type, source]) => {
                if (!source.active) return;
                ctx.fillStyle = source.color;
                source.locations.forEach(loc => {
                    if (type === 'industry' || type === 'power') {
                        // Smokestack
                        ctx.fillRect(loc.x - 4, loc.y - source.height * 0.3, 8, source.height * 0.3);
                        // Smoke plume
                        ctx.globalAlpha = 0.3;
                        for (let i = 0; i < 5; i++) {
                            const plumeX = loc.x + Math.cos(state.windAngle) * (i * 20 + state.time * 5);
                            const plumeY = loc.y - source.height * 0.3 + Math.sin(state.windAngle) * (i * 20 + state.time * 5);
                            ctx.beginPath();
                            ctx.arc(plumeX, plumeY, 10 + i * 5, 0, Math.PI * 2);
                            ctx.fill();
                        }
                        ctx.globalAlpha = 1;
                    } else {
                        ctx.beginPath();
                        ctx.arc(loc.x, loc.y, 4, 0, Math.PI * 2);
                        ctx.fill();
                    }
                });
            });

            // Wind indicator
            const windSpeed = parseInt(document.getElementById('windSpeed').value);
            ctx.save();
            ctx.translate(dims.width - 60, 40);
            ctx.rotate(state.windAngle);
            ctx.fillStyle = 'rgba(0,0,0,0.6)';
            ctx.beginPath();
            ctx.moveTo(windSpeed * 2, 0);
            ctx.lineTo(-10, -6);
            ctx.lineTo(-10, 6);
            ctx.closePath();
            ctx.fill();
            ctx.restore();
            ctx.fillStyle = '#333';
            ctx.font = '11px Nunito';
            ctx.fillText(`Wind: ${windSpeed} m/s`, dims.width - 85, 65);

            // Stability indicator
            const stability = document.getElementById('stability').value;
            ctx.fillText(`Stability: ${stability}`, dims.width - 85, 80);

            // Time display
            const hour = Math.floor((state.time * 0.5) % 24);
            ctx.font = '14px Lora';
            ctx.fillStyle = '#606C38';
            ctx.fillText(`Time: ${hour.toString().padStart(2, '0')}:00`, 20, 25);

            // Scale bar for pollutant
            ctx.font = '10px Nunito';
            ctx.fillStyle = '#333';
            const scaleLabels = {
                pm25: 'PM2.5 (Œºg/m¬≥)',
                nox: 'NOx (ppb)',
                o3: 'O3 (ppb)',
                aqi: 'AQI'
            };
            ctx.fillText(scaleLabels[pollutant], 20, dims.height - 10);
        }

        function toggleSource(type) {
            sources[type].active = !sources[type].active;
            document.getElementById('toggle' + type.charAt(0).toUpperCase() + type.slice(1))
                .classList.toggle('active');
        }

        function toggleSimulation() {
            state.running = !state.running;
            if (state.running) update();
        }

        function resetSimulation() {
            state.running = false;
            state.time = 0;
            state.windAngle = 0;
            initSources();
            draw();
        }

        // Slider displays
        function updateSliderDisplays() {
            document.getElementById('windSpeedVal').textContent = document.getElementById('windSpeed').value;
            document.getElementById('mixingHeightVal').textContent = document.getElementById('mixingHeight').value;
        }

        document.querySelectorAll('input[type="range"]').forEach(s => s.addEventListener('input', updateSliderDisplays));
        initSources();
        draw();
    </script>
</body>
</html>
