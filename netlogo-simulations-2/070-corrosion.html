<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electrochemical Corrosion Simulation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1510 0%, #2a2015 50%, #1a1510 100%);
            min-height: 100vh;
            color: #e0d8d0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            font-family: 'Lora', serif;
            font-size: 2rem;
            color: #cc6644;
            text-shadow: 0 0 20px rgba(204, 102, 68, 0.5);
            margin-bottom: 5px;
        }

        .subtitle {
            color: #aa8866;
            font-size: 0.95rem;
        }

        .back-link {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #cc6644;
            text-decoration: none;
            font-size: 0.9rem;
            opacity: 0.8;
            transition: opacity 0.3s;
        }

        .back-link:hover {
            opacity: 1;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        .simulation-area {
            background: rgba(30, 25, 20, 0.9);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(204, 102, 68, 0.3);
        }

        canvas {
            display: block;
            width: 100%;
            border-radius: 10px;
            background: #151210;
        }

        .controls-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .control-group {
            background: rgba(40, 30, 25, 0.9);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(204, 102, 68, 0.3);
        }

        .control-group h3 {
            color: #cc6644;
            font-size: 0.85rem;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .control-row {
            margin-bottom: 10px;
        }

        .control-row label {
            display: block;
            font-size: 0.8rem;
            color: #aa8866;
            margin-bottom: 4px;
        }

        .control-row input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(204, 102, 68, 0.2);
            outline: none;
            -webkit-appearance: none;
        }

        .control-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #cc6644;
            cursor: pointer;
        }

        .control-row select {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            background: rgba(25, 20, 15, 0.9);
            border: 1px solid rgba(204, 102, 68, 0.3);
            color: #e0d8d0;
            font-size: 0.85rem;
        }

        .buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            min-width: 70px;
            padding: 10px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #cc6644, #995533);
            color: #fff;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6688cc, #445588);
            color: #fff;
        }

        .btn-tertiary {
            background: linear-gradient(135deg, #66cc66, #449944);
            color: #000;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(204, 102, 68, 0.4);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .stat-item {
            background: rgba(25, 20, 15, 0.6);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 1rem;
            font-weight: bold;
            color: #cc6644;
        }

        .stat-label {
            font-size: 0.65rem;
            color: #888;
            text-transform: uppercase;
        }

        .info-box {
            background: rgba(50, 35, 25, 0.6);
            border-radius: 10px;
            padding: 12px;
            font-size: 0.8rem;
            line-height: 1.5;
            border-left: 3px solid #cc6644;
        }

        .info-box h4 {
            color: #cc6644;
            margin-bottom: 8px;
        }

        .legend {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
        }

        .legend-dot {
            width: 14px;
            height: 14px;
            border-radius: 3px;
        }

        .metal {
            background: linear-gradient(135deg, #888888, #666666);
        }

        .oxide {
            background: linear-gradient(135deg, #cc6644, #884422);
        }

        .pit {
            background: #221100;
        }

        .electrolyte {
            background: rgba(100, 150, 200, 0.4);
        }

        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back to Simulations</a>

    <div class="container">
        <header>
            <h1>⚗️ Electrochemical Corrosion</h1>
            <p class="subtitle">Pitting, Crevice Corrosion & Protective Layer Formation</p>
        </header>

        <div class="main-content">
            <div class="simulation-area">
                <canvas id="canvas"></canvas>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-dot metal"></div>
                        <span>Metal</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot oxide"></div>
                        <span>Oxide Layer</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot pit"></div>
                        <span>Pit/Corroded</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot electrolyte"></div>
                        <span>Electrolyte</span>
                    </div>
                </div>
            </div>

            <div class="controls-panel">
                <div class="control-group">
                    <div class="buttons">
                        <button class="btn-primary" id="startBtn">▶ Start</button>
                        <button class="btn-secondary" id="resetBtn">↺ Reset</button>
                        <button class="btn-tertiary" id="addDefectBtn">+ Defect</button>
                    </div>
                </div>

                <div class="control-group">
                    <h3>Corrosion Type</h3>
                    <div class="control-row">
                        <select id="corrosionType">
                            <option value="uniform">Uniform Corrosion</option>
                            <option value="pitting">Pitting Corrosion</option>
                            <option value="crevice">Crevice Corrosion</option>
                            <option value="galvanic">Galvanic Corrosion</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <label>Material</label>
                        <select id="material">
                            <option value="iron">Iron/Steel</option>
                            <option value="aluminum">Aluminum</option>
                            <option value="stainless">Stainless Steel</option>
                            <option value="copper">Copper</option>
                        </select>
                    </div>
                </div>

                <div class="control-group">
                    <h3>Environment</h3>
                    <div class="control-row">
                        <label>Chloride Concentration: <span id="chlorideVal">0.5</span> M</label>
                        <input type="range" id="chloride" min="0" max="2" value="0.5" step="0.1">
                    </div>
                    <div class="control-row">
                        <label>pH: <span id="phVal">7.0</span></label>
                        <input type="range" id="ph" min="1" max="14" value="7.0" step="0.5">
                    </div>
                    <div class="control-row">
                        <label>Oxygen Level: <span id="oxygenVal">0.8</span></label>
                        <input type="range" id="oxygen" min="0" max="1" value="0.8" step="0.05">
                    </div>
                </div>

                <div class="control-group">
                    <h3>Electrochemistry</h3>
                    <div class="control-row">
                        <label>Applied Potential: <span id="potentialVal">0.0</span> V</label>
                        <input type="range" id="potential" min="-1" max="1" value="0" step="0.1">
                    </div>
                    <div class="control-row">
                        <label>Passivation Rate: <span id="passivationVal">0.1</span></label>
                        <input type="range" id="passivation" min="0" max="0.5" value="0.1" step="0.01">
                    </div>
                </div>

                <div class="control-group">
                    <h3>Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="metalRemaining">100%</div>
                            <div class="stat-label">Metal</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="oxideLayer">0%</div>
                            <div class="stat-label">Oxide</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="pitCount">0</div>
                            <div class="stat-label">Pits</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="maxPitDepth">0</div>
                            <div class="stat-label">Max Depth</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="corrosionRate">0</div>
                            <div class="stat-label">Rate (μm/yr)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="time">0</div>
                            <div class="stat-label">Time</div>
                        </div>
                    </div>
                </div>

                <div class="control-group info-box">
                    <h4>Corrosion Mechanisms</h4>
                    <p>
                        <b>Anodic:</b> M → M⁺ + e⁻ (metal dissolution)<br>
                        <b>Cathodic:</b> O₂ + 2H₂O + 4e⁻ → 4OH⁻
                    </p>
                    <ul style="margin-top: 8px; padding-left: 15px;">
                        <li><b>Pitting:</b> Local passive film breakdown</li>
                        <li><b>Crevice:</b> Oxygen depletion in gaps</li>
                        <li><b>Passivation:</b> Protective oxide layer</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Canvas setup
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // Grid dimensions
        const cellSize = 4;
        let gridWidth, gridHeight;

        function resizeCanvas() {
            const container = canvas.parentElement;
            const width = container.clientWidth - 30;
            const height = Math.min(width * 0.6, window.innerHeight - 300);
            canvas.width = width;
            canvas.height = height;

            gridWidth = Math.floor(width / cellSize);
            gridHeight = Math.floor(height / cellSize);

            initialize();
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Cell states
        const ELECTROLYTE = 0;
        const METAL = 1;
        const OXIDE = 2;
        const PIT = 3;
        const CREVICE = 4;

        // State
        let running = false;
        let time = 0;
        let grid = [];
        let pitDepths = [];

        // Parameters
        let corrosionType = 'uniform';
        let material = 'iron';
        let chlorideConc = 0.5;
        let ph = 7.0;
        let oxygenLevel = 0.8;
        let appliedPotential = 0;
        let passivationRate = 0.1;

        // Material properties
        const materials = {
            iron: { passivationPotential: -0.4, pitPotential: 0.2, corrosionRate: 1.0 },
            aluminum: { passivationPotential: -1.0, pitPotential: -0.5, corrosionRate: 0.6 },
            stainless: { passivationPotential: -0.2, pitPotential: 0.4, corrosionRate: 0.3 },
            copper: { passivationPotential: 0.0, pitPotential: 0.3, corrosionRate: 0.5 }
        };

        // Initialize grid
        function initialize() {
            grid = [];
            pitDepths = [];
            time = 0;

            for (let y = 0; y < gridHeight; y++) {
                grid[y] = [];
                for (let x = 0; x < gridWidth; x++) {
                    // Metal in lower portion, electrolyte above
                    const metalLine = gridHeight * 0.4;
                    if (y > metalLine) {
                        grid[y][x] = METAL;
                    } else {
                        grid[y][x] = ELECTROLYTE;
                    }
                }
            }

            // Add initial oxide layer
            const metalLine = Math.floor(gridHeight * 0.4);
            for (let x = 0; x < gridWidth; x++) {
                if (Math.random() < 0.7) {
                    grid[metalLine][x] = OXIDE;
                    if (metalLine + 1 < gridHeight && Math.random() < 0.3) {
                        grid[metalLine + 1][x] = OXIDE;
                    }
                }
            }

            // Add crevice geometry if needed
            if (corrosionType === 'crevice') {
                addCrevice();
            }

            // Add galvanic couple if needed
            if (corrosionType === 'galvanic') {
                addGalvanicCouple();
            }
        }

        function addCrevice() {
            const cx = Math.floor(gridWidth / 2);
            const metalLine = Math.floor(gridHeight * 0.4);

            // Create a crevice (narrow gap with covering)
            for (let y = metalLine - 10; y <= metalLine; y++) {
                for (let x = cx - 15; x <= cx + 15; x++) {
                    if (x >= 0 && x < gridWidth && y >= 0) {
                        if (y < metalLine - 2 && (x === cx - 15 || x === cx + 15)) {
                            grid[y][x] = METAL;  // Crevice walls
                        }
                        if (y === metalLine - 10 && x > cx - 15 && x < cx + 15) {
                            grid[y][x] = METAL;  // Crevice top
                        }
                    }
                }
            }
        }

        function addGalvanicCouple() {
            // Mark right half as a different metal (visualized differently)
            // In this simplified model, we just increase corrosion rate on one side
        }

        function addDefect() {
            const metalLine = Math.floor(gridHeight * 0.4);

            // Random position on the surface
            const x = Math.floor(Math.random() * (gridWidth - 20)) + 10;

            // Remove oxide at this location
            for (let y = metalLine - 2; y <= metalLine + 2; y++) {
                if (y >= 0 && y < gridHeight) {
                    if (grid[y][x] === OXIDE) {
                        grid[y][x] = ELECTROLYTE;
                    }
                }
            }
        }

        // Corrosion step using cellular automata rules
        function step() {
            time++;
            const matProps = materials[material];

            // Create new grid
            const newGrid = grid.map(row => [...row]);

            // Calculate local probabilities
            const baseCorrosionProb = matProps.corrosionRate * 0.01 *
                (1 + chlorideConc) * (1 + (7 - ph) * 0.1) * oxygenLevel;

            // Passivation probability (reduced by chloride and low pH)
            const passivationProb = passivationRate * (1 - chlorideConc * 0.3) *
                (ph > 4 ? 1 : 0.1);

            // Pit probability (increased by applied potential above pit potential)
            const pitProb = appliedPotential > matProps.pitPotential ?
                (appliedPotential - matProps.pitPotential) * 0.1 : 0;

            for (let y = 1; y < gridHeight - 1; y++) {
                for (let x = 1; x < gridWidth - 1; x++) {
                    const cell = grid[y][x];

                    if (cell === METAL) {
                        // Check if exposed to electrolyte
                        let exposedToElectrolyte = false;
                        let hasOxideNeighbor = false;

                        for (let dy = -1; dy <= 1; dy++) {
                            for (let dx = -1; dx <= 1; dx++) {
                                if (dx === 0 && dy === 0) continue;
                                const neighbor = grid[y + dy][x + dx];
                                if (neighbor === ELECTROLYTE || neighbor === PIT) {
                                    exposedToElectrolyte = true;
                                }
                                if (neighbor === OXIDE) {
                                    hasOxideNeighbor = true;
                                }
                            }
                        }

                        if (exposedToElectrolyte) {
                            // Corrosion probability
                            let corrProb = baseCorrosionProb;

                            // Pitting: higher probability at defects and existing pits
                            if (corrosionType === 'pitting') {
                                // Check for nearby pits (autocatalytic)
                                let nearbyPits = 0;
                                for (let dy = -2; dy <= 2; dy++) {
                                    for (let dx = -2; dx <= 2; dx++) {
                                        if (y + dy >= 0 && y + dy < gridHeight &&
                                            x + dx >= 0 && x + dx < gridWidth) {
                                            if (grid[y + dy][x + dx] === PIT) {
                                                nearbyPits++;
                                            }
                                        }
                                    }
                                }
                                corrProb += pitProb * (1 + nearbyPits * 0.5);
                            }

                            // Crevice: reduced oxygen inside
                            if (corrosionType === 'crevice') {
                                // Check if in crevice (surrounded by metal/oxide on sides)
                                const left = grid[y][x - 1];
                                const right = grid[y][x + 1];
                                if ((left === METAL || left === OXIDE) &&
                                    (right === METAL || right === OXIDE)) {
                                    corrProb *= 2;  // Oxygen depletion accelerates
                                }
                            }

                            // Galvanic: enhanced on anodic side
                            if (corrosionType === 'galvanic' && x > gridWidth / 2) {
                                corrProb *= 1.5;
                            }

                            // Protected by oxide
                            if (hasOxideNeighbor) {
                                corrProb *= 0.1;
                            }

                            // Apply corrosion
                            if (Math.random() < corrProb) {
                                newGrid[y][x] = corrosionType === 'pitting' ? PIT : ELECTROLYTE;
                            }
                            // Try passivation
                            else if (Math.random() < passivationProb && !hasOxideNeighbor) {
                                newGrid[y][x] = OXIDE;
                            }
                        }
                    }
                    else if (cell === OXIDE) {
                        // Oxide breakdown probability (increased by chloride, low pH)
                        const breakdownProb = chlorideConc * 0.02 * (1 + (7 - ph) * 0.05);

                        if (Math.random() < breakdownProb) {
                            newGrid[y][x] = ELECTROLYTE;
                        }
                    }
                }
            }

            grid = newGrid;
            updateStats();
        }

        // Calculate statistics
        function updateStats() {
            let metalCount = 0;
            let oxideCount = 0;
            let pitCount = 0;
            let totalCells = gridWidth * gridHeight;
            const metalLine = Math.floor(gridHeight * 0.4);

            // Track pit depths
            pitDepths = [];

            for (let x = 0; x < gridWidth; x++) {
                let foundPit = false;
                let pitDepth = 0;

                for (let y = metalLine; y < gridHeight; y++) {
                    if (grid[y][x] === METAL) {
                        metalCount++;
                    } else if (grid[y][x] === OXIDE) {
                        oxideCount++;
                    } else if (grid[y][x] === PIT || grid[y][x] === ELECTROLYTE) {
                        if (y > metalLine && grid[y][x] === PIT) {
                            foundPit = true;
                            pitDepth = y - metalLine;
                        }
                    }
                }

                if (foundPit) {
                    pitDepths.push(pitDepth);
                }
            }

            const initialMetal = gridWidth * (gridHeight - metalLine);
            const metalPercent = Math.round((metalCount / initialMetal) * 100);
            const oxidePercent = Math.round((oxideCount / totalCells) * 100);
            const maxDepth = pitDepths.length > 0 ? Math.max(...pitDepths) : 0;

            // Corrosion rate estimation (simplified)
            const lostMetal = initialMetal - metalCount - oxideCount;
            const corrRate = time > 0 ? Math.round((lostMetal / initialMetal) * 1000 / time * 100) : 0;

            document.getElementById('metalRemaining').textContent = metalPercent + '%';
            document.getElementById('oxideLayer').textContent = oxidePercent + '%';
            document.getElementById('pitCount').textContent = pitDepths.length;
            document.getElementById('maxPitDepth').textContent = maxDepth;
            document.getElementById('corrosionRate').textContent = corrRate;
            document.getElementById('time').textContent = time;
        }

        // Render
        function render() {
            const width = canvas.width;
            const height = canvas.height;

            ctx.fillStyle = '#151210';
            ctx.fillRect(0, 0, width, height);

            for (let y = 0; y < gridHeight; y++) {
                for (let x = 0; x < gridWidth; x++) {
                    const cell = grid[y][x];
                    let color;

                    switch (cell) {
                        case ELECTROLYTE:
                            // Electrolyte with slight variation
                            const alpha = 0.3 + Math.sin(x * 0.1 + y * 0.1 + time * 0.1) * 0.05;
                            color = `rgba(100, 150, 200, ${alpha})`;
                            break;
                        case METAL:
                            // Metal gradient
                            const metalShade = 100 + (y / gridHeight) * 50;
                            color = `rgb(${metalShade}, ${metalShade}, ${metalShade})`;
                            break;
                        case OXIDE:
                            // Rust/oxide color
                            color = `rgb(${180 + Math.random() * 20}, ${80 + Math.random() * 20}, ${40 + Math.random() * 10})`;
                            break;
                        case PIT:
                            // Dark pit
                            color = '#110800';
                            break;
                        default:
                            color = '#000000';
                    }

                    ctx.fillStyle = color;
                    ctx.fillRect(x * cellSize, y * cellSize, cellSize, cellSize);
                }
            }

            // Draw electrode markers for galvanic
            if (corrosionType === 'galvanic') {
                ctx.fillStyle = '#ffff00';
                ctx.font = '12px sans-serif';
                ctx.fillText('Cathode', 20, 20);
                ctx.fillText('Anode', gridWidth * cellSize - 60, 20);

                // Dividing line
                ctx.strokeStyle = 'rgba(255, 255, 0, 0.5)';
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(gridWidth * cellSize / 2, 0);
                ctx.lineTo(gridWidth * cellSize / 2, gridHeight * cellSize);
                ctx.stroke();
                ctx.setLineDash([]);
            }

            // Info overlay
            ctx.fillStyle = '#666666';
            ctx.font = '11px sans-serif';
            ctx.fillText(`${corrosionType.charAt(0).toUpperCase() + corrosionType.slice(1)} Corrosion | ${material.charAt(0).toUpperCase() + material.slice(1)}`, 10, height - 10);
        }

        // Animation loop
        function animate() {
            if (running) {
                step();
            }
            render();
            requestAnimationFrame(animate);
        }

        // Event listeners
        document.getElementById('startBtn').addEventListener('click', () => {
            running = !running;
            document.getElementById('startBtn').textContent = running ? '⏸ Pause' : '▶ Start';
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            running = false;
            document.getElementById('startBtn').textContent = '▶ Start';
            initialize();
        });

        document.getElementById('addDefectBtn').addEventListener('click', () => {
            addDefect();
        });

        // Parameter controls
        document.getElementById('corrosionType').addEventListener('change', (e) => {
            corrosionType = e.target.value;
            initialize();
        });

        document.getElementById('material').addEventListener('change', (e) => {
            material = e.target.value;
        });

        document.getElementById('chloride').addEventListener('input', (e) => {
            chlorideConc = parseFloat(e.target.value);
            document.getElementById('chlorideVal').textContent = chlorideConc.toFixed(1);
        });

        document.getElementById('ph').addEventListener('input', (e) => {
            ph = parseFloat(e.target.value);
            document.getElementById('phVal').textContent = ph.toFixed(1);
        });

        document.getElementById('oxygen').addEventListener('input', (e) => {
            oxygenLevel = parseFloat(e.target.value);
            document.getElementById('oxygenVal').textContent = oxygenLevel.toFixed(2);
        });

        document.getElementById('potential').addEventListener('input', (e) => {
            appliedPotential = parseFloat(e.target.value);
            document.getElementById('potentialVal').textContent = appliedPotential.toFixed(1);
        });

        document.getElementById('passivation').addEventListener('input', (e) => {
            passivationRate = parseFloat(e.target.value);
            document.getElementById('passivationVal').textContent = passivationRate.toFixed(2);
        });

        // Initialize and start
        initialize();
        animate();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
