<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecological Succession - Pioneer to Climax Community</title>
    <style>
        :root {
            --sage: #8A9A5B;
            --moss: #606C38;
            --earth: #DDA15E;
            --cream: #FEFAE0;
            --terracotta: #BC6C25;
            --dark-moss: #3d4423;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, #f5f5dc 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        h1 {
            color: var(--dark-moss);
            font-size: 1.8rem;
            margin-bottom: 8px;
        }

        .subtitle {
            color: var(--moss);
            font-size: 1rem;
        }

        .back-link {
            position: absolute;
            top: 20px;
            left: 20px;
            color: var(--moss);
            text-decoration: none;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.3s;
        }

        .back-link:hover {
            color: var(--terracotta);
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }

        .control-panel {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            height: fit-content;
        }

        .control-section {
            margin-bottom: 20px;
        }

        .control-section h3 {
            color: var(--dark-moss);
            font-size: 0.95rem;
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 2px solid var(--sage);
        }

        .control-group {
            margin-bottom: 12px;
        }

        .control-group label {
            display: block;
            color: var(--moss);
            font-size: 0.8rem;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .control-group input[type="range"] {
            width: 100%;
            accent-color: var(--sage);
        }

        .control-group select {
            width: 100%;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--dark-moss);
            background: white;
        }

        .value-display {
            text-align: right;
            font-size: 0.75rem;
            color: var(--terracotta);
            font-weight: 600;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 16px;
        }

        button {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
        }

        .btn-primary {
            background: var(--sage);
            color: white;
        }

        .btn-primary:hover {
            background: var(--moss);
        }

        .btn-secondary {
            background: var(--earth);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--terracotta);
        }

        .btn-full {
            grid-column: span 2;
        }

        .btn-disturbance {
            background: var(--terracotta);
            color: white;
            grid-column: span 2;
        }

        .btn-disturbance:hover {
            background: #a55a1f;
        }

        .visualization-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 16px;
        }

        .viz-panel {
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .viz-panel h4 {
            color: var(--dark-moss);
            font-size: 0.85rem;
            margin-bottom: 10px;
            text-align: center;
        }

        .canvas-container {
            position: relative;
            width: 100%;
            height: 280px;
        }

        canvas {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            background: #1a1a1a;
        }

        .stats-panel {
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-top: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }

        .stat-item {
            text-align: center;
            padding: 12px;
            background: var(--cream);
            border-radius: 10px;
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--terracotta);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--moss);
            margin-top: 4px;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #eee;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--dark-moss);
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 4px;
        }

        .succession-stage {
            text-align: center;
            padding: 12px;
            background: var(--cream);
            border-radius: 10px;
            margin-top: 12px;
        }

        .succession-stage .stage-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--moss);
        }

        .succession-stage .stage-years {
            font-size: 0.8rem;
            color: var(--terracotta);
        }

        .info-panel {
            grid-column: span 2;
            background: linear-gradient(135deg, var(--sage) 0%, var(--moss) 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin-top: 12px;
        }

        .info-panel h4 {
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .info-panel p {
            font-size: 0.8rem;
            opacity: 0.95;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back to Simulations</a>

    <div class="container">
        <header>
            <h1>Ecological Succession</h1>
            <p class="subtitle">Pioneer Species to Climax Community - Facilitation, Inhibition & Tolerance Models</p>
        </header>

        <div class="main-content">
            <div class="control-panel">
                <div class="control-section">
                    <h3>Succession Model</h3>
                    <div class="control-group">
                        <label>Primary Mechanism</label>
                        <select id="successionModel">
                            <option value="facilitation">Facilitation</option>
                            <option value="tolerance">Tolerance</option>
                            <option value="inhibition">Inhibition</option>
                            <option value="mixed">Mixed (Realistic)</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Succession Type</label>
                        <select id="successionType">
                            <option value="primary">Primary (Bare Ground)</option>
                            <option value="secondary">Secondary (Post-Disturbance)</option>
                        </select>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Environment</h3>
                    <div class="control-group">
                        <label>Soil Development Rate</label>
                        <input type="range" id="soilRate" min="0.1" max="2" step="0.1" value="1">
                        <div class="value-display" id="soilRateValue">1.0x</div>
                    </div>
                    <div class="control-group">
                        <label>Light Availability</label>
                        <input type="range" id="lightLevel" min="20" max="100" step="5" value="100">
                        <div class="value-display" id="lightLevelValue">100%</div>
                    </div>
                    <div class="control-group">
                        <label>Moisture Level</label>
                        <input type="range" id="moistureLevel" min="20" max="100" step="5" value="60">
                        <div class="value-display" id="moistureLevelValue">60%</div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Species Parameters</h3>
                    <div class="control-group">
                        <label>Pioneer Colonization Rate</label>
                        <input type="range" id="pioneerRate" min="0.01" max="0.2" step="0.01" value="0.1">
                        <div class="value-display" id="pioneerRateValue">0.10</div>
                    </div>
                    <div class="control-group">
                        <label>Competitive Intensity</label>
                        <input type="range" id="competition" min="0.1" max="1" step="0.05" value="0.5">
                        <div class="value-display" id="competitionValue">0.50</div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Disturbance</h3>
                    <div class="control-group">
                        <label>Disturbance Intensity</label>
                        <input type="range" id="disturbanceIntensity" min="0.1" max="1" step="0.1" value="0.5">
                        <div class="value-display" id="disturbanceIntensityValue">50%</div>
                    </div>
                    <button class="btn-disturbance" id="triggerDisturbance">Trigger Disturbance (Fire/Storm)</button>
                </div>

                <div class="button-group">
                    <button class="btn-primary" id="startBtn">Start</button>
                    <button class="btn-secondary" id="pauseBtn">Pause</button>
                    <button class="btn-secondary btn-full" id="resetBtn">Reset Succession</button>
                </div>

                <div class="succession-stage">
                    <div class="stage-name" id="currentStage">Bare Ground</div>
                    <div class="stage-years" id="successionalAge">Year 0</div>
                </div>

                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #a0522d;"></div>
                        <span>Bare Soil</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #90EE90;"></div>
                        <span>Lichens/Mosses</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #32CD32;"></div>
                        <span>Grasses/Herbs</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #228B22;"></div>
                        <span>Shrubs</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #006400;"></div>
                        <span>Pioneer Trees</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #013220;"></div>
                        <span>Climax Forest</span>
                    </div>
                </div>
            </div>

            <div class="visualization-area">
                <div class="viz-panel">
                    <h4>Landscape View</h4>
                    <div class="canvas-container">
                        <canvas id="landscapeCanvas"></canvas>
                    </div>
                </div>

                <div class="viz-panel">
                    <h4>Species Composition Over Time</h4>
                    <div class="canvas-container">
                        <canvas id="compositionCanvas"></canvas>
                    </div>
                </div>

                <div class="viz-panel">
                    <h4>Environmental Conditions</h4>
                    <div class="canvas-container">
                        <canvas id="environmentCanvas"></canvas>
                    </div>
                </div>

                <div class="viz-panel">
                    <h4>Succession Mechanisms</h4>
                    <div class="canvas-container">
                        <canvas id="mechanismCanvas"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-panel">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="speciesRichness">0</div>
                    <div class="stat-label">Species Richness</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="biomass">0</div>
                    <div class="stat-label">Total Biomass (kg/m²)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="soilDepth">0</div>
                    <div class="stat-label">Soil Depth (cm)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="canopyClosure">0%</div>
                    <div class="stat-label">Canopy Closure</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="disturbanceCount">0</div>
                    <div class="stat-label">Disturbances</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="dominantSpecies">None</div>
                    <div class="stat-label">Dominant Stage</div>
                </div>
            </div>
            <div class="info-panel">
                <h4>Connell & Slatyer (1977) Succession Models</h4>
                <p><strong>Facilitation:</strong> Pioneer species modify the environment, making it suitable for later species (e.g., lichens create soil for plants).
                <strong>Tolerance:</strong> Later species succeed due to life history traits (arrive slowly, live longer) regardless of pioneers.
                <strong>Inhibition:</strong> Pioneers inhibit later species until they die from disturbance or senescence. All three mechanisms can operate in real ecosystems.</p>
            </div>
        </div>
    </div>

    <script>
        // Canvas setup
        const landscapeCanvas = document.getElementById('landscapeCanvas');
        const compositionCanvas = document.getElementById('compositionCanvas');
        const environmentCanvas = document.getElementById('environmentCanvas');
        const mechanismCanvas = document.getElementById('mechanismCanvas');

        const lCtx = landscapeCanvas.getContext('2d');
        const cCtx = compositionCanvas.getContext('2d');
        const eCtx = environmentCanvas.getContext('2d');
        const mCtx = mechanismCanvas.getContext('2d');

        function resizeCanvas(canvas) {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }

        [landscapeCanvas, compositionCanvas, environmentCanvas, mechanismCanvas].forEach(resizeCanvas);
        window.addEventListener('resize', () => {
            [landscapeCanvas, compositionCanvas, environmentCanvas, mechanismCanvas].forEach(resizeCanvas);
        });

        // Species definitions
        const SPECIES = {
            bare: { name: 'Bare Ground', color: '#8B4513', tolerance: { light: [80, 100], moisture: [0, 100], soil: [0, 100] }, biomass: 0, maxAge: Infinity, canopy: 0 },
            lichen: { name: 'Lichens/Mosses', color: '#90EE90', tolerance: { light: [70, 100], moisture: [20, 80], soil: [0, 5] }, biomass: 0.5, maxAge: 50, canopy: 0.05, facilitation: 0.3 },
            grass: { name: 'Grasses/Herbs', color: '#32CD32', tolerance: { light: [50, 100], moisture: [30, 80], soil: [3, 30] }, biomass: 2, maxAge: 20, canopy: 0.2, facilitation: 0.4 },
            shrub: { name: 'Shrubs', color: '#228B22', tolerance: { light: [30, 90], moisture: [35, 75], soil: [10, 50] }, biomass: 8, maxAge: 80, canopy: 0.5, facilitation: 0.3 },
            pioneerTree: { name: 'Pioneer Trees', color: '#006400', tolerance: { light: [40, 100], moisture: [40, 70], soil: [20, 80] }, biomass: 25, maxAge: 100, canopy: 0.7, facilitation: 0.2 },
            climax: { name: 'Climax Forest', color: '#013220', tolerance: { light: [10, 60], moisture: [40, 70], soil: [30, 100] }, biomass: 50, maxAge: 500, canopy: 0.95, facilitation: 0 }
        };

        const SUCCESSION_ORDER = ['bare', 'lichen', 'grass', 'shrub', 'pioneerTree', 'climax'];

        // Simulation state
        let grid = [];
        let gridSize = 50;
        let params = {};
        let isRunning = false;
        let tick = 0;
        let compositionHistory = [];
        let environmentHistory = [];
        let mechanismEvents = [];
        let disturbanceCount = 0;

        // Initialize grid
        function initGrid() {
            grid = [];
            const successionType = document.getElementById('successionType').value;

            for (let x = 0; x < gridSize; x++) {
                grid[x] = [];
                for (let y = 0; y < gridSize; y++) {
                    if (successionType === 'primary') {
                        // Primary succession - all bare ground, minimal soil
                        grid[x][y] = {
                            species: 'bare',
                            age: 0,
                            soilDepth: Math.random() * 0.5,
                            moisture: params.moistureLevel,
                            nutrients: 0.1,
                            inhibition: 0
                        };
                    } else {
                        // Secondary succession - some soil, maybe remnant seeds
                        const hasRemnants = Math.random() < 0.3;
                        grid[x][y] = {
                            species: hasRemnants ? (Math.random() < 0.5 ? 'grass' : 'lichen') : 'bare',
                            age: hasRemnants ? Math.floor(Math.random() * 5) : 0,
                            soilDepth: 15 + Math.random() * 10,
                            moisture: params.moistureLevel,
                            nutrients: 0.4 + Math.random() * 0.2,
                            inhibition: 0
                        };
                    }
                }
            }

            tick = 0;
            compositionHistory = [];
            environmentHistory = [];
            mechanismEvents = [];
            disturbanceCount = 0;
        }

        function updateParams() {
            params = {
                successionModel: document.getElementById('successionModel').value,
                soilRate: parseFloat(document.getElementById('soilRate').value),
                lightLevel: parseFloat(document.getElementById('lightLevel').value),
                moistureLevel: parseFloat(document.getElementById('moistureLevel').value),
                pioneerRate: parseFloat(document.getElementById('pioneerRate').value),
                competition: parseFloat(document.getElementById('competition').value),
                disturbanceIntensity: parseFloat(document.getElementById('disturbanceIntensity').value)
            };
        }

        function getAvailableLight(x, y) {
            // Light decreases with canopy closure of neighbors
            let totalCanopy = 0;
            let count = 0;

            for (let dx = -2; dx <= 2; dx++) {
                for (let dy = -2; dy <= 2; dy++) {
                    const nx = x + dx;
                    const ny = y + dy;
                    if (nx >= 0 && nx < gridSize && ny >= 0 && ny < gridSize) {
                        const species = SPECIES[grid[nx][ny].species];
                        totalCanopy += species.canopy;
                        count++;
                    }
                }
            }

            const avgCanopy = totalCanopy / count;
            return params.lightLevel * (1 - avgCanopy * 0.8);
        }

        function canEstablish(speciesKey, cell, availableLight) {
            const species = SPECIES[speciesKey];
            const lightOK = availableLight >= species.tolerance.light[0] && availableLight <= species.tolerance.light[1];
            const moistureOK = cell.moisture >= species.tolerance.moisture[0] && cell.moisture <= species.tolerance.moisture[1];
            const soilOK = cell.soilDepth >= species.tolerance.soil[0] && cell.soilDepth <= species.tolerance.soil[1];

            return lightOK && moistureOK && soilOK;
        }

        function processCell(x, y) {
            const cell = grid[x][y];
            const currentSpecies = SPECIES[cell.species];
            const availableLight = getAvailableLight(x, y);
            const currentIndex = SUCCESSION_ORDER.indexOf(cell.species);

            // Soil development (facilitated by current vegetation)
            if (cell.species !== 'bare') {
                cell.soilDepth += currentSpecies.facilitation * params.soilRate * 0.1;
                cell.nutrients = Math.min(1, cell.nutrients + currentSpecies.facilitation * 0.01);
            }

            // Age the current vegetation
            cell.age++;

            // Inhibition decay
            cell.inhibition = Math.max(0, cell.inhibition - 0.01);

            // Check for mortality
            let died = false;
            if (cell.species !== 'bare') {
                // Natural mortality increases with age
                const mortalityChance = Math.pow(cell.age / currentSpecies.maxAge, 2) * 0.1;
                if (Math.random() < mortalityChance) {
                    died = true;
                    mechanismEvents.push({ type: 'death', species: cell.species, x, y, tick });
                }
            }

            if (died) {
                // Death creates opportunity - what replaces it depends on model
                cell.species = 'bare';
                cell.age = 0;
                return;
            }

            // Succession based on model
            const model = params.successionModel;

            // Try to establish next successional stage
            for (let i = currentIndex + 1; i < SUCCESSION_ORDER.length; i++) {
                const nextSpecies = SUCCESSION_ORDER[i];
                if (!canEstablish(nextSpecies, cell, availableLight)) continue;

                let establishmentChance = params.pioneerRate * (1 - i * 0.15);

                if (model === 'facilitation') {
                    // Pioneers make conditions better for later species
                    establishmentChance *= (1 + currentSpecies.facilitation * 2);
                    if (Math.random() < establishmentChance) {
                        cell.species = nextSpecies;
                        cell.age = 0;
                        mechanismEvents.push({ type: 'facilitation', from: SUCCESSION_ORDER[currentIndex], to: nextSpecies, x, y, tick });
                        break;
                    }
                } else if (model === 'tolerance') {
                    // Success depends on life history, not pioneer effects
                    const lifeHistoryFactor = SPECIES[nextSpecies].maxAge / 500; // Longer-lived species accumulate
                    establishmentChance *= lifeHistoryFactor;
                    if (Math.random() < establishmentChance) {
                        cell.species = nextSpecies;
                        cell.age = 0;
                        mechanismEvents.push({ type: 'tolerance', from: SUCCESSION_ORDER[currentIndex], to: nextSpecies, x, y, tick });
                        break;
                    }
                } else if (model === 'inhibition') {
                    // Pioneers inhibit later species until they die
                    if (cell.inhibition > 0.2) continue;
                    establishmentChance *= 0.3; // Harder to establish
                    if (Math.random() < establishmentChance) {
                        cell.species = nextSpecies;
                        cell.age = 0;
                        cell.inhibition = 0.8; // New species creates inhibition
                        mechanismEvents.push({ type: 'inhibition', from: SUCCESSION_ORDER[currentIndex], to: nextSpecies, x, y, tick });
                        break;
                    }
                } else {
                    // Mixed model - uses all mechanisms
                    const facEffect = currentSpecies.facilitation * 0.5;
                    const tolEffect = SPECIES[nextSpecies].maxAge / 1000;
                    const inhEffect = cell.inhibition > 0.3 ? 0.2 : 1;

                    establishmentChance *= (1 + facEffect) * (1 + tolEffect) * inhEffect;
                    if (Math.random() < establishmentChance) {
                        cell.species = nextSpecies;
                        cell.age = 0;
                        cell.inhibition = 0.3;
                        mechanismEvents.push({ type: 'mixed', from: SUCCESSION_ORDER[currentIndex], to: nextSpecies, x, y, tick });
                        break;
                    }
                }
            }

            // Competition from neighbors (can cause regression)
            if (Math.random() < params.competition * 0.02) {
                // Check if neighbors have stronger competitors
                let strongerNeighbor = false;
                for (let dx = -1; dx <= 1; dx++) {
                    for (let dy = -1; dy <= 1; dy++) {
                        if (dx === 0 && dy === 0) continue;
                        const nx = x + dx;
                        const ny = y + dy;
                        if (nx >= 0 && nx < gridSize && ny >= 0 && ny < gridSize) {
                            const neighborIndex = SUCCESSION_ORDER.indexOf(grid[nx][ny].species);
                            if (neighborIndex > currentIndex && SPECIES[grid[nx][ny].species].biomass > currentSpecies.biomass) {
                                strongerNeighbor = true;
                            }
                        }
                    }
                }

                // Stronger neighbors can displace weaker species
                if (strongerNeighbor && Math.random() < 0.1) {
                    // Regress one stage
                    if (currentIndex > 0) {
                        cell.species = SUCCESSION_ORDER[currentIndex - 1];
                        cell.age = 0;
                    }
                }
            }
        }

        function triggerDisturbance() {
            const intensity = params.disturbanceIntensity;
            disturbanceCount++;

            // Create disturbance patch (random location and size)
            const centerX = Math.floor(Math.random() * gridSize);
            const centerY = Math.floor(Math.random() * gridSize);
            const radius = Math.floor(5 + intensity * 15);

            for (let x = 0; x < gridSize; x++) {
                for (let y = 0; y < gridSize; y++) {
                    const dist = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
                    if (dist < radius) {
                        const impactChance = intensity * (1 - dist / radius);
                        if (Math.random() < impactChance) {
                            const speciesIndex = SUCCESSION_ORDER.indexOf(grid[x][y].species);
                            // Higher succession stages more vulnerable
                            if (Math.random() < 0.3 + speciesIndex * 0.15) {
                                grid[x][y].species = 'bare';
                                grid[x][y].age = 0;
                                // Some soil remains for secondary succession
                                grid[x][y].soilDepth *= 0.7;
                            }
                        }
                    }
                }
            }

            mechanismEvents.push({ type: 'disturbance', x: centerX, y: centerY, radius, tick });
        }

        function calculateStats() {
            let counts = {};
            let totalBiomass = 0;
            let totalSoil = 0;
            let totalCanopy = 0;

            SUCCESSION_ORDER.forEach(s => counts[s] = 0);

            for (let x = 0; x < gridSize; x++) {
                for (let y = 0; y < gridSize; y++) {
                    const cell = grid[x][y];
                    counts[cell.species]++;
                    totalBiomass += SPECIES[cell.species].biomass;
                    totalSoil += cell.soilDepth;
                    totalCanopy += SPECIES[cell.species].canopy;
                }
            }

            const total = gridSize * gridSize;

            // Count species present (>1% coverage)
            let speciesRichness = 0;
            let dominant = 'bare';
            let maxCount = 0;

            SUCCESSION_ORDER.forEach(s => {
                if (counts[s] / total > 0.01) speciesRichness++;
                if (counts[s] > maxCount && s !== 'bare') {
                    maxCount = counts[s];
                    dominant = s;
                }
            });

            return {
                counts,
                proportions: Object.fromEntries(Object.entries(counts).map(([k, v]) => [k, v / total])),
                speciesRichness,
                biomass: totalBiomass / total,
                soilDepth: totalSoil / total,
                canopy: totalCanopy / total,
                dominant: SPECIES[dominant].name
            };
        }

        function getSuccessionStage(proportions) {
            if (proportions.climax > 0.3) return { name: 'Climax Forest', years: '200+' };
            if (proportions.pioneerTree > 0.3) return { name: 'Pioneer Forest', years: '50-200' };
            if (proportions.shrub > 0.3) return { name: 'Shrubland', years: '20-50' };
            if (proportions.grass > 0.3) return { name: 'Grassland/Meadow', years: '5-20' };
            if (proportions.lichen > 0.3) return { name: 'Lichen/Moss Stage', years: '1-5' };
            return { name: 'Bare Ground', years: '0' };
        }

        function drawLandscape() {
            const width = landscapeCanvas.width;
            const height = landscapeCanvas.height;
            const cellWidth = width / gridSize;
            const cellHeight = height / gridSize;

            lCtx.fillStyle = '#1a1a1a';
            lCtx.fillRect(0, 0, width, height);

            for (let x = 0; x < gridSize; x++) {
                for (let y = 0; y < gridSize; y++) {
                    const cell = grid[x][y];
                    const species = SPECIES[cell.species];

                    // Base color with age variation
                    let baseColor = species.color;
                    const ageFactor = Math.min(1, cell.age / (species.maxAge * 0.5));

                    lCtx.fillStyle = baseColor;
                    lCtx.fillRect(x * cellWidth, y * cellHeight, cellWidth + 0.5, cellHeight + 0.5);

                    // Add texture for vegetation
                    if (cell.species !== 'bare') {
                        lCtx.globalAlpha = 0.2 + ageFactor * 0.2;
                        lCtx.fillStyle = '#ffffff';
                        if (Math.random() < 0.3) {
                            lCtx.fillRect(x * cellWidth + cellWidth * 0.3, y * cellHeight + cellHeight * 0.3,
                                         cellWidth * 0.4, cellHeight * 0.4);
                        }
                        lCtx.globalAlpha = 1;
                    }
                }
            }

            // Draw recent disturbance markers
            const recentDisturbances = mechanismEvents.filter(e => e.type === 'disturbance' && tick - e.tick < 50);
            recentDisturbances.forEach(d => {
                lCtx.strokeStyle = 'rgba(255, 100, 0, ' + (1 - (tick - d.tick) / 50) + ')';
                lCtx.lineWidth = 2;
                lCtx.beginPath();
                lCtx.arc(d.x * cellWidth + cellWidth/2, d.y * cellHeight + cellHeight/2,
                        d.radius * cellWidth, 0, Math.PI * 2);
                lCtx.stroke();
            });
        }

        function drawComposition() {
            const width = compositionCanvas.width;
            const height = compositionCanvas.height;

            cCtx.fillStyle = '#1a1a1a';
            cCtx.fillRect(0, 0, width, height);

            if (compositionHistory.length < 2) return;

            const margin = { top: 30, right: 20, bottom: 40, left: 50 };
            const plotWidth = width - margin.left - margin.right;
            const plotHeight = height - margin.top - margin.bottom;

            // Draw stacked area chart
            const maxTicks = compositionHistory.length;
            const xScale = plotWidth / Math.max(1, maxTicks - 1);

            // Draw areas from top to bottom (climax to bare)
            for (let i = SUCCESSION_ORDER.length - 1; i >= 0; i--) {
                const species = SUCCESSION_ORDER[i];
                cCtx.fillStyle = SPECIES[species].color;
                cCtx.globalAlpha = 0.8;
                cCtx.beginPath();

                // Bottom line (cumulative of all below)
                cCtx.moveTo(margin.left, margin.top + plotHeight);

                compositionHistory.forEach((data, t) => {
                    let cumulative = 0;
                    for (let j = 0; j <= i; j++) {
                        cumulative += data.proportions[SUCCESSION_ORDER[j]] || 0;
                    }
                    const x = margin.left + t * xScale;
                    const y = margin.top + plotHeight - (cumulative * plotHeight);
                    cCtx.lineTo(x, y);
                });

                // Top line (cumulative of all below minus current)
                for (let t = compositionHistory.length - 1; t >= 0; t--) {
                    let cumulative = 0;
                    for (let j = 0; j < i; j++) {
                        cumulative += compositionHistory[t].proportions[SUCCESSION_ORDER[j]] || 0;
                    }
                    const x = margin.left + t * xScale;
                    const y = margin.top + plotHeight - (cumulative * plotHeight);
                    cCtx.lineTo(x, y);
                }

                cCtx.closePath();
                cCtx.fill();
            }

            cCtx.globalAlpha = 1;

            // Axes
            cCtx.strokeStyle = '#666';
            cCtx.lineWidth = 1;
            cCtx.beginPath();
            cCtx.moveTo(margin.left, margin.top);
            cCtx.lineTo(margin.left, margin.top + plotHeight);
            cCtx.lineTo(margin.left + plotWidth, margin.top + plotHeight);
            cCtx.stroke();

            // Labels
            cCtx.fillStyle = '#aaa';
            cCtx.font = '11px sans-serif';
            cCtx.textAlign = 'center';
            cCtx.fillText('Time (years)', margin.left + plotWidth/2, height - 5);

            cCtx.save();
            cCtx.translate(15, margin.top + plotHeight/2);
            cCtx.rotate(-Math.PI/2);
            cCtx.fillText('Coverage (%)', 0, 0);
            cCtx.restore();

            // Y-axis labels
            cCtx.textAlign = 'right';
            [0, 50, 100].forEach(v => {
                const y = margin.top + plotHeight - (v/100 * plotHeight);
                cCtx.fillText(v + '%', margin.left - 5, y + 4);
            });

            // Title
            cCtx.textAlign = 'center';
            cCtx.fillStyle = '#fff';
            cCtx.font = 'bold 12px sans-serif';
            cCtx.fillText('Species Composition Over Time', width/2, 18);
        }

        function drawEnvironment() {
            const width = environmentCanvas.width;
            const height = environmentCanvas.height;

            eCtx.fillStyle = '#1a1a1a';
            eCtx.fillRect(0, 0, width, height);

            if (environmentHistory.length < 2) return;

            const margin = { top: 30, right: 20, bottom: 40, left: 50 };
            const plotWidth = width - margin.left - margin.right;
            const plotHeight = height - margin.top - margin.bottom;

            const metrics = [
                { key: 'soilDepth', label: 'Soil Depth', color: '#8B4513', scale: 50 },
                { key: 'canopy', label: 'Canopy', color: '#228B22', scale: 1 },
                { key: 'biomass', label: 'Biomass', color: '#90EE90', scale: 50 }
            ];

            const maxTicks = environmentHistory.length;
            const xScale = plotWidth / Math.max(1, maxTicks - 1);

            metrics.forEach((metric, idx) => {
                eCtx.strokeStyle = metric.color;
                eCtx.lineWidth = 2;
                eCtx.beginPath();

                environmentHistory.forEach((data, t) => {
                    const x = margin.left + t * xScale;
                    const value = data[metric.key] / metric.scale;
                    const y = margin.top + plotHeight - (Math.min(1, value) * plotHeight);

                    if (t === 0) eCtx.moveTo(x, y);
                    else eCtx.lineTo(x, y);
                });

                eCtx.stroke();
            });

            // Legend
            metrics.forEach((metric, idx) => {
                const x = margin.left + 10 + idx * 90;
                const y = margin.top + 15;

                eCtx.fillStyle = metric.color;
                eCtx.fillRect(x, y - 8, 12, 12);
                eCtx.fillStyle = '#aaa';
                eCtx.font = '10px sans-serif';
                eCtx.textAlign = 'left';
                eCtx.fillText(metric.label, x + 16, y + 3);
            });

            // Axes
            eCtx.strokeStyle = '#666';
            eCtx.lineWidth = 1;
            eCtx.beginPath();
            eCtx.moveTo(margin.left, margin.top);
            eCtx.lineTo(margin.left, margin.top + plotHeight);
            eCtx.lineTo(margin.left + plotWidth, margin.top + plotHeight);
            eCtx.stroke();

            // Title
            eCtx.textAlign = 'center';
            eCtx.fillStyle = '#fff';
            eCtx.font = 'bold 12px sans-serif';
            eCtx.fillText('Environmental Development', width/2, 18);
        }

        function drawMechanism() {
            const width = mechanismCanvas.width;
            const height = mechanismCanvas.height;

            mCtx.fillStyle = '#1a1a1a';
            mCtx.fillRect(0, 0, width, height);

            const margin = { top: 40, right: 20, bottom: 40, left: 60 };
            const plotWidth = width - margin.left - margin.right;
            const plotHeight = height - margin.top - margin.bottom;

            // Count mechanism events
            const eventTypes = ['facilitation', 'tolerance', 'inhibition', 'mixed', 'disturbance', 'death'];
            const eventCounts = {};
            eventTypes.forEach(t => eventCounts[t] = 0);

            mechanismEvents.forEach(e => {
                if (eventCounts.hasOwnProperty(e.type)) {
                    eventCounts[e.type]++;
                }
            });

            const maxCount = Math.max(1, ...Object.values(eventCounts));
            const barWidth = plotWidth / eventTypes.length - 10;

            const eventColors = {
                facilitation: '#4CAF50',
                tolerance: '#2196F3',
                inhibition: '#FF9800',
                mixed: '#9C27B0',
                disturbance: '#f44336',
                death: '#795548'
            };

            eventTypes.forEach((type, idx) => {
                const x = margin.left + idx * (barWidth + 10) + 5;
                const barHeight = (eventCounts[type] / maxCount) * plotHeight;
                const y = margin.top + plotHeight - barHeight;

                mCtx.fillStyle = eventColors[type];
                mCtx.fillRect(x, y, barWidth, barHeight);

                // Label
                mCtx.fillStyle = '#aaa';
                mCtx.font = '9px sans-serif';
                mCtx.textAlign = 'center';
                mCtx.save();
                mCtx.translate(x + barWidth/2, margin.top + plotHeight + 10);
                mCtx.rotate(-Math.PI/4);
                mCtx.fillText(type.charAt(0).toUpperCase() + type.slice(1), 0, 0);
                mCtx.restore();

                // Count
                mCtx.fillStyle = '#fff';
                mCtx.font = '10px sans-serif';
                mCtx.fillText(eventCounts[type], x + barWidth/2, y - 5);
            });

            // Title
            mCtx.textAlign = 'center';
            mCtx.fillStyle = '#fff';
            mCtx.font = 'bold 12px sans-serif';
            mCtx.fillText('Succession Mechanism Events', width/2, 20);

            // Current model indicator
            mCtx.fillStyle = '#888';
            mCtx.font = '11px sans-serif';
            mCtx.fillText('Model: ' + params.successionModel.charAt(0).toUpperCase() + params.successionModel.slice(1), width/2, 35);
        }

        function updateStats(stats) {
            document.getElementById('speciesRichness').textContent = stats.speciesRichness;
            document.getElementById('biomass').textContent = stats.biomass.toFixed(1);
            document.getElementById('soilDepth').textContent = stats.soilDepth.toFixed(1);
            document.getElementById('canopyClosure').textContent = (stats.canopy * 100).toFixed(0) + '%';
            document.getElementById('disturbanceCount').textContent = disturbanceCount;
            document.getElementById('dominantSpecies').textContent = stats.dominant;

            const stage = getSuccessionStage(stats.proportions);
            document.getElementById('currentStage').textContent = stage.name;
            document.getElementById('successionalAge').textContent = 'Year ' + tick + ' (' + stage.years + ' typical)';
        }

        function update() {
            // Process each cell
            for (let x = 0; x < gridSize; x++) {
                for (let y = 0; y < gridSize; y++) {
                    processCell(x, y);
                }
            }

            tick++;

            // Record history (every 2 ticks for performance)
            if (tick % 2 === 0) {
                const stats = calculateStats();
                compositionHistory.push(stats);
                environmentHistory.push({
                    soilDepth: stats.soilDepth,
                    canopy: stats.canopy,
                    biomass: stats.biomass
                });

                // Limit history length
                if (compositionHistory.length > 300) {
                    compositionHistory.shift();
                    environmentHistory.shift();
                }
            }
        }

        function draw() {
            const stats = calculateStats();

            drawLandscape();
            drawComposition();
            drawEnvironment();
            drawMechanism();
            updateStats(stats);
        }

        function animate() {
            if (!isRunning) return;

            update();
            draw();

            requestAnimationFrame(animate);
        }

        // Event listeners
        document.getElementById('startBtn').addEventListener('click', () => {
            isRunning = true;
            animate();
        });

        document.getElementById('pauseBtn').addEventListener('click', () => {
            isRunning = false;
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            isRunning = false;
            updateParams();
            initGrid();
            draw();
        });

        document.getElementById('triggerDisturbance').addEventListener('click', () => {
            triggerDisturbance();
            draw();
        });

        // Parameter sliders
        const sliders = ['soilRate', 'lightLevel', 'moistureLevel', 'pioneerRate', 'competition', 'disturbanceIntensity'];
        sliders.forEach(id => {
            const slider = document.getElementById(id);
            const display = document.getElementById(id + 'Value');

            slider.addEventListener('input', () => {
                let value = parseFloat(slider.value);
                if (id === 'soilRate') display.textContent = value.toFixed(1) + 'x';
                else if (id === 'lightLevel' || id === 'moistureLevel' || id === 'disturbanceIntensity') {
                    display.textContent = value + '%';
                } else {
                    display.textContent = value.toFixed(2);
                }
                updateParams();
            });
        });

        // Dropdowns
        ['successionModel', 'successionType'].forEach(id => {
            document.getElementById(id).addEventListener('change', updateParams);
        });

        // Initialize
        updateParams();
        initGrid();
        draw();
    </script>
</body>
</html>
