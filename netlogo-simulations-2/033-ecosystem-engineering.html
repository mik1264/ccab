<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecosystem Engineering - Beaver & Termite Habitat Modification</title>
    <style>
        :root {
            --sage: #8A9A5B;
            --moss: #606C38;
            --earth: #DDA15E;
            --cream: #FEFAE0;
            --terracotta: #BC6C25;
            --dark-moss: #3d4423;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, #f5f5dc 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        h1 {
            color: var(--dark-moss);
            font-size: 1.8rem;
            margin-bottom: 8px;
        }

        .subtitle {
            color: var(--moss);
            font-size: 1rem;
        }

        .back-link {
            position: absolute;
            top: 20px;
            left: 20px;
            color: var(--moss);
            text-decoration: none;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.3s;
        }

        .back-link:hover {
            color: var(--terracotta);
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }

        .control-panel {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            height: fit-content;
        }

        .control-section {
            margin-bottom: 20px;
        }

        .control-section h3 {
            color: var(--dark-moss);
            font-size: 0.95rem;
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 2px solid var(--sage);
        }

        .control-group {
            margin-bottom: 12px;
        }

        .control-group label {
            display: block;
            color: var(--moss);
            font-size: 0.8rem;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .control-group input[type="range"] {
            width: 100%;
            accent-color: var(--sage);
        }

        .control-group select {
            width: 100%;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--dark-moss);
            background: white;
        }

        .value-display {
            text-align: right;
            font-size: 0.75rem;
            color: var(--terracotta);
            font-weight: 600;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 16px;
        }

        button {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
        }

        .btn-primary {
            background: var(--sage);
            color: white;
        }

        .btn-primary:hover {
            background: var(--moss);
        }

        .btn-secondary {
            background: var(--earth);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--terracotta);
        }

        .btn-full {
            grid-column: span 2;
        }

        .btn-event {
            background: var(--terracotta);
            color: white;
            grid-column: span 2;
            margin-top: 8px;
        }

        .btn-event:hover {
            background: #a55a1f;
        }

        .visualization-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 16px;
        }

        .viz-panel {
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .viz-panel h4 {
            color: var(--dark-moss);
            font-size: 0.85rem;
            margin-bottom: 10px;
            text-align: center;
        }

        .canvas-container {
            position: relative;
            width: 100%;
            height: 280px;
        }

        canvas {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            background: #1a1a1a;
        }

        .stats-panel {
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-top: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 12px;
        }

        .stat-item {
            text-align: center;
            padding: 12px;
            background: var(--cream);
            border-radius: 10px;
        }

        .stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--terracotta);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--moss);
            margin-top: 4px;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #eee;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.7rem;
            color: var(--dark-moss);
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .info-panel {
            grid-column: span 2;
            background: linear-gradient(135deg, var(--sage) 0%, var(--moss) 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin-top: 12px;
        }

        .info-panel h4 {
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .info-panel p {
            font-size: 0.8rem;
            opacity: 0.95;
            line-height: 1.5;
        }

        .engineer-tab {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .engineer-tab button {
            flex: 1;
            padding: 8px;
            font-size: 0.8rem;
        }

        .engineer-tab button.active {
            background: var(--moss);
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Simulations</a>

    <div class="container">
        <header>
            <h1>Ecosystem Engineering</h1>
            <p class="subtitle">Habitat Modification, Niche Construction & Legacy Effects</p>
        </header>

        <div class="main-content">
            <div class="control-panel">
                <div class="control-section">
                    <h3>Engineer Type</h3>
                    <div class="engineer-tab">
                        <button class="btn-primary active" id="beaverTab">Beaver</button>
                        <button class="btn-primary" id="termiteTab">Termite</button>
                    </div>
                    <div class="control-group">
                        <label>Engineer Density</label>
                        <input type="range" id="engineerDensity" min="1" max="20" step="1" value="5">
                        <div class="value-display" id="engineerDensityValue">5</div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Environment</h3>
                    <div class="control-group">
                        <label>Base Productivity</label>
                        <input type="range" id="productivity" min="0.1" max="1" step="0.1" value="0.5">
                        <div class="value-display" id="productivityValue">0.50</div>
                    </div>
                    <div class="control-group">
                        <label>Disturbance Rate</label>
                        <input type="range" id="disturbanceRate" min="0" max="0.1" step="0.01" value="0.02">
                        <div class="value-display" id="disturbanceRateValue">0.02</div>
                    </div>
                    <div class="control-group">
                        <label>Legacy Persistence</label>
                        <input type="range" id="legacyPersistence" min="10" max="200" step="10" value="50">
                        <div class="value-display" id="legacyPersistenceValue">50 years</div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Modification Effects</h3>
                    <div class="control-group">
                        <label>Habitat Creation Rate</label>
                        <input type="range" id="creationRate" min="0.01" max="0.2" step="0.01" value="0.05">
                        <div class="value-display" id="creationRateValue">0.05</div>
                    </div>
                    <div class="control-group">
                        <label>Biodiversity Bonus</label>
                        <input type="range" id="biodiversityBonus" min="1" max="3" step="0.1" value="1.5">
                        <div class="value-display" id="biodiversityBonusValue">1.5x</div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Events</h3>
                    <button class="btn-event" id="addEngineer">Add Engineer Colony</button>
                    <button class="btn-event" id="removeEngineers">Remove All Engineers</button>
                    <button class="btn-event" id="floodEvent">Major Flood Event</button>
                </div>

                <div class="button-group">
                    <button class="btn-primary" id="startBtn">Start</button>
                    <button class="btn-secondary" id="pauseBtn">Pause</button>
                    <button class="btn-secondary btn-full" id="resetBtn">Reset</button>
                </div>

                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4a90d9;"></div>
                        <span>Water/Pond</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #8B4513;"></div>
                        <span>Dam/Mound</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #228B22;"></div>
                        <span>Wetland/Modified</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #90EE90;"></div>
                        <span>Grassland</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #006400;"></div>
                        <span>Forest</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FF6B6B;"></div>
                        <span>Engineer</span>
                    </div>
                </div>
            </div>

            <div class="visualization-area">
                <div class="viz-panel">
                    <h4>Landscape View</h4>
                    <div class="canvas-container">
                        <canvas id="landscapeCanvas"></canvas>
                    </div>
                </div>

                <div class="viz-panel">
                    <h4>Habitat Diversity Over Time</h4>
                    <div class="canvas-container">
                        <canvas id="diversityCanvas"></canvas>
                    </div>
                </div>

                <div class="viz-panel">
                    <h4>Engineer Activity & Legacy</h4>
                    <div class="canvas-container">
                        <canvas id="legacyCanvas"></canvas>
                    </div>
                </div>

                <div class="viz-panel">
                    <h4>Species Richness by Habitat</h4>
                    <div class="canvas-container">
                        <canvas id="richnessCanvas"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-panel">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="engineerCount">0</div>
                    <div class="stat-label">Active Engineers</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="modifiedArea">0%</div>
                    <div class="stat-label">Modified Habitat</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="legacyArea">0%</div>
                    <div class="stat-label">Legacy Habitats</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="speciesRichness">0</div>
                    <div class="stat-label">Species Richness</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="habitatTypes">0</div>
                    <div class="stat-label">Habitat Types</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="waterRetention">0%</div>
                    <div class="stat-label">Water Retention</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="carbonStorage">0</div>
                    <div class="stat-label">Carbon (t/ha)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="landscageAge">0</div>
                    <div class="stat-label">Years</div>
                </div>
            </div>
            <div class="info-panel">
                <h4>Ecosystem Engineers (Jones et al. 1994)</h4>
                <p><strong>Beavers:</strong> Allogenic engineers that dam streams, creating wetland habitats, increasing water retention, and promoting biodiversity spillover 100m+ from water's edge.
                <strong>Termites:</strong> Modify soil properties, create mounds that alter nutrient cycling and provide microhabitats.
                <strong>Legacy Effects:</strong> Modifications persist long after engineers leave, continuing to influence ecosystem processes and community assembly.</p>
            </div>
        </div>
    </div>

    <script>
        // Canvas setup
        const landscapeCanvas = document.getElementById('landscapeCanvas');
        const diversityCanvas = document.getElementById('diversityCanvas');
        const legacyCanvas = document.getElementById('legacyCanvas');
        const richnessCanvas = document.getElementById('richnessCanvas');

        const lCtx = landscapeCanvas.getContext('2d');
        const dCtx = diversityCanvas.getContext('2d');
        const gCtx = legacyCanvas.getContext('2d');
        const rCtx = richnessCanvas.getContext('2d');

        function resizeCanvas(canvas) {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }

        [landscapeCanvas, diversityCanvas, legacyCanvas, richnessCanvas].forEach(resizeCanvas);
        window.addEventListener('resize', () => {
            [landscapeCanvas, diversityCanvas, legacyCanvas, richnessCanvas].forEach(resizeCanvas);
        });

        // Habitat types
        const HABITATS = {
            water: { color: '#4a90d9', richness: 15, carbon: 5 },
            wetland: { color: '#228B22', richness: 25, carbon: 30 },
            dam: { color: '#8B4513', richness: 5, carbon: 50 },
            mound: { color: '#D2691E', richness: 10, carbon: 40 },
            grassland: { color: '#90EE90', richness: 10, carbon: 8 },
            forest: { color: '#006400', richness: 20, carbon: 25 },
            legacy: { color: '#9ACD32', richness: 18, carbon: 20 }
        };

        // Model state
        let grid = [];
        let gridSize = 60;
        let engineers = [];
        let params = {};
        let isRunning = false;
        let tick = 0;
        let engineerType = 'beaver';
        let history = [];

        function initGrid() {
            grid = [];
            engineers = [];
            history = [];
            tick = 0;

            for (let x = 0; x < gridSize; x++) {
                grid[x] = [];
                for (let y = 0; y < gridSize; y++) {
                    // Initial landscape - mostly forest and grassland
                    const noise = Math.random();
                    let habitat;
                    if (noise < 0.4) habitat = 'forest';
                    else if (noise < 0.8) habitat = 'grassland';
                    else habitat = 'grassland';

                    // Add a river through the middle (for beavers)
                    if (engineerType === 'beaver' && Math.abs(y - gridSize/2) < 2 + Math.sin(x * 0.3) * 2) {
                        habitat = 'water';
                    }

                    grid[x][y] = {
                        habitat: habitat,
                        modified: false,
                        legacyAge: 0,
                        engineer: null,
                        productivity: params.productivity,
                        moisture: habitat === 'water' ? 1 : 0.3
                    };
                }
            }

            // Add initial engineers
            for (let i = 0; i < params.engineerDensity; i++) {
                addEngineerColony();
            }
        }

        function updateParams() {
            params = {
                engineerDensity: parseInt(document.getElementById('engineerDensity').value),
                productivity: parseFloat(document.getElementById('productivity').value),
                disturbanceRate: parseFloat(document.getElementById('disturbanceRate').value),
                legacyPersistence: parseInt(document.getElementById('legacyPersistence').value),
                creationRate: parseFloat(document.getElementById('creationRate').value),
                biodiversityBonus: parseFloat(document.getElementById('biodiversityBonus').value)
            };
        }

        function addEngineerColony() {
            let x, y;
            const attempts = 100;

            for (let a = 0; a < attempts; a++) {
                x = Math.floor(Math.random() * gridSize);
                y = Math.floor(Math.random() * gridSize);

                if (engineerType === 'beaver') {
                    // Beavers need water nearby
                    let hasWater = false;
                    for (let dx = -3; dx <= 3; dx++) {
                        for (let dy = -3; dy <= 3; dy++) {
                            const nx = x + dx;
                            const ny = y + dy;
                            if (nx >= 0 && nx < gridSize && ny >= 0 && ny < gridSize) {
                                if (grid[nx][ny].habitat === 'water') hasWater = true;
                            }
                        }
                    }
                    if (hasWater) break;
                } else {
                    // Termites prefer dry areas
                    if (grid[x][y].habitat !== 'water' && grid[x][y].moisture < 0.5) break;
                }
            }

            engineers.push({
                x, y,
                age: 0,
                active: true,
                type: engineerType,
                structures: []
            });
        }

        function processEngineer(eng) {
            if (!eng.active) return;

            eng.age++;

            // Engineer activity
            if (engineerType === 'beaver') {
                processBeaverActivity(eng);
            } else {
                processTermiteActivity(eng);
            }

            // Engineer mortality
            if (Math.random() < 0.001 + eng.age * 0.00001) {
                eng.active = false;
                // Structures become legacy
                eng.structures.forEach(s => {
                    if (grid[s.x] && grid[s.x][s.y]) {
                        grid[s.x][s.y].legacyAge = 1;
                    }
                });
            }
        }

        function processBeaverActivity(eng) {
            // Build dam - modify adjacent cells
            for (let dx = -2; dx <= 2; dx++) {
                for (let dy = -2; dy <= 2; dy++) {
                    const nx = eng.x + dx;
                    const ny = eng.y + dy;
                    if (nx < 0 || nx >= gridSize || ny < 0 || ny >= gridSize) continue;

                    const cell = grid[nx][ny];
                    const dist = Math.sqrt(dx*dx + dy*dy);

                    if (Math.random() < params.creationRate / (dist + 1)) {
                        if (cell.habitat === 'water' && dist < 1.5) {
                            // Build dam
                            cell.habitat = 'dam';
                            cell.modified = true;
                            eng.structures.push({ x: nx, y: ny });
                        } else if (cell.habitat === 'grassland' || cell.habitat === 'forest') {
                            // Create wetland/pond
                            if (Math.random() < 0.3) {
                                cell.habitat = 'wetland';
                                cell.modified = true;
                                cell.moisture = Math.min(1, cell.moisture + 0.3);
                            } else if (Math.random() < 0.2) {
                                cell.habitat = 'water';
                                cell.modified = true;
                                cell.moisture = 1;
                            }
                            eng.structures.push({ x: nx, y: ny });
                        }
                    }
                }
            }

            // Spread moisture effects (water retention)
            for (let dx = -5; dx <= 5; dx++) {
                for (let dy = -5; dy <= 5; dy++) {
                    const nx = eng.x + dx;
                    const ny = eng.y + dy;
                    if (nx < 0 || nx >= gridSize || ny < 0 || ny >= gridSize) continue;

                    const dist = Math.sqrt(dx*dx + dy*dy);
                    grid[nx][ny].moisture = Math.min(1, grid[nx][ny].moisture + 0.01 / (dist + 1));
                }
            }
        }

        function processTermiteActivity(eng) {
            // Build mound
            const cell = grid[eng.x][eng.y];
            if (cell.habitat !== 'mound' && cell.habitat !== 'water') {
                if (Math.random() < params.creationRate * 2) {
                    cell.habitat = 'mound';
                    cell.modified = true;
                    eng.structures.push({ x: eng.x, y: eng.y });
                }
            }

            // Modify surrounding soil (nutrient cycling)
            for (let dx = -3; dx <= 3; dx++) {
                for (let dy = -3; dy <= 3; dy++) {
                    const nx = eng.x + dx;
                    const ny = eng.y + dy;
                    if (nx < 0 || nx >= gridSize || ny < 0 || ny >= gridSize) continue;

                    const adj = grid[nx][ny];
                    const dist = Math.sqrt(dx*dx + dy*dy);

                    if (adj.habitat === 'grassland' && Math.random() < params.creationRate / (dist + 1)) {
                        adj.productivity = Math.min(1, adj.productivity + 0.05);
                        adj.modified = true;
                    }
                }
            }
        }

        function processLegacy() {
            // Age legacy effects and decay
            for (let x = 0; x < gridSize; x++) {
                for (let y = 0; y < gridSize; y++) {
                    const cell = grid[x][y];

                    if (cell.legacyAge > 0) {
                        cell.legacyAge++;

                        // Legacy decay
                        if (cell.legacyAge > params.legacyPersistence) {
                            // Transition back to natural state
                            if (cell.habitat === 'dam' || cell.habitat === 'mound') {
                                cell.habitat = 'legacy';
                            } else if (cell.habitat === 'wetland') {
                                cell.habitat = 'grassland';
                                cell.moisture *= 0.9;
                            } else if (cell.habitat === 'legacy') {
                                cell.habitat = Math.random() < 0.5 ? 'grassland' : 'forest';
                                cell.legacyAge = 0;
                                cell.modified = false;
                            }
                        }
                    }

                    // Natural moisture decay
                    if (cell.habitat !== 'water') {
                        cell.moisture = Math.max(0.1, cell.moisture - 0.001);
                    }
                }
            }
        }

        function processDisturbance() {
            if (Math.random() < params.disturbanceRate) {
                // Random disturbance event
                const cx = Math.floor(Math.random() * gridSize);
                const cy = Math.floor(Math.random() * gridSize);
                const radius = 3 + Math.random() * 5;

                for (let x = 0; x < gridSize; x++) {
                    for (let y = 0; y < gridSize; y++) {
                        const dist = Math.sqrt(Math.pow(x - cx, 2) + Math.pow(y - cy, 2));
                        if (dist < radius && Math.random() < 0.5) {
                            const cell = grid[x][y];
                            if (cell.habitat === 'dam') {
                                cell.habitat = 'water';
                                cell.legacyAge = 1;
                            } else if (cell.habitat === 'mound') {
                                cell.habitat = 'grassland';
                                cell.legacyAge = 1;
                            }
                        }
                    }
                }
            }
        }

        function calculateStats() {
            let modified = 0;
            let legacy = 0;
            let totalRichness = 0;
            let waterCells = 0;
            let totalCarbon = 0;
            const habitatCounts = {};

            for (let x = 0; x < gridSize; x++) {
                for (let y = 0; y < gridSize; y++) {
                    const cell = grid[x][y];
                    const hab = HABITATS[cell.habitat];

                    if (cell.modified) modified++;
                    if (cell.legacyAge > 0) legacy++;
                    if (cell.habitat === 'water' || cell.habitat === 'wetland') waterCells++;

                    // Richness bonus from engineering
                    let richness = hab.richness;
                    if (cell.modified) richness *= params.biodiversityBonus;
                    totalRichness += richness;

                    totalCarbon += hab.carbon;

                    habitatCounts[cell.habitat] = (habitatCounts[cell.habitat] || 0) + 1;
                }
            }

            const total = gridSize * gridSize;
            return {
                modifiedPercent: (modified / total) * 100,
                legacyPercent: (legacy / total) * 100,
                speciesRichness: Math.round(totalRichness / 10),
                habitatTypes: Object.keys(habitatCounts).filter(h => habitatCounts[h] > 0).length,
                waterRetention: (waterCells / total) * 100,
                carbonStorage: totalCarbon / total,
                habitatCounts
            };
        }

        function update() {
            tick++;

            // Process each engineer
            engineers.forEach(eng => processEngineer(eng));

            // Process legacy effects
            processLegacy();

            // Random disturbances
            processDisturbance();

            // Remove inactive engineers after some time
            engineers = engineers.filter(e => e.active || e.age < params.legacyPersistence * 2);

            // Record history
            if (tick % 5 === 0) {
                const stats = calculateStats();
                history.push({
                    tick,
                    ...stats,
                    activeEngineers: engineers.filter(e => e.active).length
                });

                if (history.length > 200) history.shift();
            }
        }

        function drawLandscape() {
            const width = landscapeCanvas.width;
            const height = landscapeCanvas.height;
            const cellWidth = width / gridSize;
            const cellHeight = height / gridSize;

            lCtx.fillStyle = '#1a1a1a';
            lCtx.fillRect(0, 0, width, height);

            // Draw cells
            for (let x = 0; x < gridSize; x++) {
                for (let y = 0; y < gridSize; y++) {
                    const cell = grid[x][y];
                    const hab = HABITATS[cell.habitat];

                    lCtx.fillStyle = hab.color;
                    lCtx.fillRect(x * cellWidth, y * cellHeight, cellWidth + 0.5, cellHeight + 0.5);

                    // Highlight modified areas
                    if (cell.modified && cell.legacyAge === 0) {
                        lCtx.fillStyle = 'rgba(255, 255, 0, 0.2)';
                        lCtx.fillRect(x * cellWidth, y * cellHeight, cellWidth, cellHeight);
                    }

                    // Show legacy
                    if (cell.legacyAge > 0) {
                        const alpha = Math.max(0, 0.3 - cell.legacyAge / params.legacyPersistence * 0.3);
                        lCtx.fillStyle = `rgba(255, 200, 100, ${alpha})`;
                        lCtx.fillRect(x * cellWidth, y * cellHeight, cellWidth, cellHeight);
                    }
                }
            }

            // Draw engineers
            engineers.filter(e => e.active).forEach(eng => {
                lCtx.fillStyle = '#FF6B6B';
                lCtx.beginPath();
                lCtx.arc((eng.x + 0.5) * cellWidth, (eng.y + 0.5) * cellHeight,
                        cellWidth * 1.2, 0, Math.PI * 2);
                lCtx.fill();

                // Activity radius
                lCtx.strokeStyle = 'rgba(255, 100, 100, 0.3)';
                lCtx.lineWidth = 1;
                lCtx.beginPath();
                lCtx.arc((eng.x + 0.5) * cellWidth, (eng.y + 0.5) * cellHeight,
                        cellWidth * 5, 0, Math.PI * 2);
                lCtx.stroke();
            });
        }

        function drawDiversity() {
            const width = diversityCanvas.width;
            const height = diversityCanvas.height;

            dCtx.fillStyle = '#1a1a1a';
            dCtx.fillRect(0, 0, width, height);

            if (history.length < 2) return;

            const margin = { top: 30, right: 20, bottom: 40, left: 50 };
            const plotWidth = width - margin.left - margin.right;
            const plotHeight = height - margin.top - margin.bottom;

            // Draw species richness over time
            const maxRichness = Math.max(...history.map(h => h.speciesRichness)) || 100;
            const xScale = plotWidth / Math.max(1, history.length - 1);
            const yScale = plotHeight / maxRichness;

            dCtx.strokeStyle = '#4CAF50';
            dCtx.lineWidth = 2;
            dCtx.beginPath();

            history.forEach((h, i) => {
                const x = margin.left + i * xScale;
                const y = margin.top + plotHeight - h.speciesRichness * yScale;
                if (i === 0) dCtx.moveTo(x, y);
                else dCtx.lineTo(x, y);
            });

            dCtx.stroke();

            // Axes
            dCtx.strokeStyle = '#666';
            dCtx.lineWidth = 1;
            dCtx.beginPath();
            dCtx.moveTo(margin.left, margin.top);
            dCtx.lineTo(margin.left, margin.top + plotHeight);
            dCtx.lineTo(margin.left + plotWidth, margin.top + plotHeight);
            dCtx.stroke();

            // Labels
            dCtx.fillStyle = '#aaa';
            dCtx.font = '10px sans-serif';
            dCtx.textAlign = 'center';
            dCtx.fillText('Time (years)', width / 2, height - 5);

            dCtx.save();
            dCtx.translate(12, height / 2);
            dCtx.rotate(-Math.PI / 2);
            dCtx.fillText('Species Richness', 0, 0);
            dCtx.restore();

            dCtx.fillStyle = '#fff';
            dCtx.font = 'bold 12px sans-serif';
            dCtx.fillText('Biodiversity Over Time', width / 2, 18);
        }

        function drawLegacy() {
            const width = legacyCanvas.width;
            const height = legacyCanvas.height;

            gCtx.fillStyle = '#1a1a1a';
            gCtx.fillRect(0, 0, width, height);

            if (history.length < 2) return;

            const margin = { top: 30, right: 80, bottom: 40, left: 50 };
            const plotWidth = width - margin.left - margin.right;
            const plotHeight = height - margin.top - margin.bottom;

            const xScale = plotWidth / Math.max(1, history.length - 1);

            // Draw modified area
            gCtx.strokeStyle = '#FFC107';
            gCtx.lineWidth = 2;
            gCtx.beginPath();
            history.forEach((h, i) => {
                const x = margin.left + i * xScale;
                const y = margin.top + plotHeight - (h.modifiedPercent / 100) * plotHeight;
                if (i === 0) gCtx.moveTo(x, y);
                else gCtx.lineTo(x, y);
            });
            gCtx.stroke();

            // Draw legacy area
            gCtx.strokeStyle = '#9C27B0';
            gCtx.lineWidth = 2;
            gCtx.beginPath();
            history.forEach((h, i) => {
                const x = margin.left + i * xScale;
                const y = margin.top + plotHeight - (h.legacyPercent / 100) * plotHeight;
                if (i === 0) gCtx.moveTo(x, y);
                else gCtx.lineTo(x, y);
            });
            gCtx.stroke();

            // Draw active engineers count
            const maxEng = Math.max(...history.map(h => h.activeEngineers), 1);
            gCtx.strokeStyle = '#FF6B6B';
            gCtx.lineWidth = 2;
            gCtx.beginPath();
            history.forEach((h, i) => {
                const x = margin.left + i * xScale;
                const y = margin.top + plotHeight - (h.activeEngineers / maxEng) * plotHeight;
                if (i === 0) gCtx.moveTo(x, y);
                else gCtx.lineTo(x, y);
            });
            gCtx.stroke();

            // Legend
            const legendItems = [
                { color: '#FFC107', label: 'Modified' },
                { color: '#9C27B0', label: 'Legacy' },
                { color: '#FF6B6B', label: 'Engineers' }
            ];

            legendItems.forEach((item, i) => {
                const y = margin.top + 10 + i * 18;
                gCtx.fillStyle = item.color;
                gCtx.fillRect(width - 75, y, 12, 12);
                gCtx.fillStyle = '#aaa';
                gCtx.font = '10px sans-serif';
                gCtx.textAlign = 'left';
                gCtx.fillText(item.label, width - 60, y + 10);
            });

            // Axes
            gCtx.strokeStyle = '#666';
            gCtx.lineWidth = 1;
            gCtx.beginPath();
            gCtx.moveTo(margin.left, margin.top);
            gCtx.lineTo(margin.left, margin.top + plotHeight);
            gCtx.lineTo(margin.left + plotWidth, margin.top + plotHeight);
            gCtx.stroke();

            gCtx.fillStyle = '#fff';
            gCtx.font = 'bold 12px sans-serif';
            gCtx.textAlign = 'center';
            gCtx.fillText('Engineer Activity & Legacy Effects', width / 2, 18);
        }

        function drawRichness() {
            const width = richnessCanvas.width;
            const height = richnessCanvas.height;

            rCtx.fillStyle = '#1a1a1a';
            rCtx.fillRect(0, 0, width, height);

            const margin = { top: 30, right: 20, bottom: 50, left: 50 };
            const plotWidth = width - margin.left - margin.right;
            const plotHeight = height - margin.top - margin.bottom;

            const stats = calculateStats();
            const habitats = Object.entries(stats.habitatCounts)
                .filter(([h, c]) => c > 0)
                .sort((a, b) => b[1] - a[1]);

            if (habitats.length === 0) return;

            const barWidth = plotWidth / habitats.length - 10;
            const maxCount = Math.max(...habitats.map(h => h[1]));

            habitats.forEach(([habitat, count], i) => {
                const x = margin.left + i * (barWidth + 10) + 5;
                const barHeight = (count / maxCount) * plotHeight;
                const y = margin.top + plotHeight - barHeight;

                const hab = HABITATS[habitat];
                rCtx.fillStyle = hab.color;
                rCtx.fillRect(x, y, barWidth, barHeight);

                // Richness indicator (dot)
                const richness = hab.richness * (stats.habitatCounts[habitat] > 0 &&
                    grid.some(row => row.some(cell => cell.habitat === habitat && cell.modified)) ?
                    params.biodiversityBonus : 1);
                const dotY = margin.top + plotHeight - (richness / 30) * plotHeight;

                rCtx.fillStyle = '#fff';
                rCtx.beginPath();
                rCtx.arc(x + barWidth / 2, dotY, 4, 0, Math.PI * 2);
                rCtx.fill();

                // Label
                rCtx.fillStyle = '#aaa';
                rCtx.font = '9px sans-serif';
                rCtx.textAlign = 'center';
                rCtx.save();
                rCtx.translate(x + barWidth / 2, margin.top + plotHeight + 10);
                rCtx.rotate(-Math.PI / 4);
                rCtx.fillText(habitat, 0, 0);
                rCtx.restore();
            });

            rCtx.fillStyle = '#fff';
            rCtx.font = 'bold 12px sans-serif';
            rCtx.textAlign = 'center';
            rCtx.fillText('Habitat Area (bars) & Richness (dots)', width / 2, 18);
        }

        function updateStats() {
            const stats = calculateStats();
            const activeEngineers = engineers.filter(e => e.active).length;

            document.getElementById('engineerCount').textContent = activeEngineers;
            document.getElementById('modifiedArea').textContent = stats.modifiedPercent.toFixed(1) + '%';
            document.getElementById('legacyArea').textContent = stats.legacyPercent.toFixed(1) + '%';
            document.getElementById('speciesRichness').textContent = stats.speciesRichness;
            document.getElementById('habitatTypes').textContent = stats.habitatTypes;
            document.getElementById('waterRetention').textContent = stats.waterRetention.toFixed(1) + '%';
            document.getElementById('carbonStorage').textContent = stats.carbonStorage.toFixed(1);
            document.getElementById('landscageAge').textContent = tick;
        }

        function draw() {
            drawLandscape();
            drawDiversity();
            drawLegacy();
            drawRichness();
            updateStats();
        }

        function animate() {
            if (!isRunning) return;

            update();
            draw();

            requestAnimationFrame(animate);
        }

        // Event listeners
        document.getElementById('startBtn').addEventListener('click', () => {
            isRunning = true;
            animate();
        });

        document.getElementById('pauseBtn').addEventListener('click', () => {
            isRunning = false;
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            isRunning = false;
            updateParams();
            initGrid();
            draw();
        });

        document.getElementById('addEngineer').addEventListener('click', () => {
            addEngineerColony();
            draw();
        });

        document.getElementById('removeEngineers').addEventListener('click', () => {
            engineers.forEach(e => {
                e.active = false;
                e.structures.forEach(s => {
                    if (grid[s.x] && grid[s.x][s.y]) {
                        grid[s.x][s.y].legacyAge = 1;
                    }
                });
            });
            draw();
        });

        document.getElementById('floodEvent').addEventListener('click', () => {
            // Major flood destroys dams
            for (let x = 0; x < gridSize; x++) {
                for (let y = 0; y < gridSize; y++) {
                    if (grid[x][y].habitat === 'dam' && Math.random() < 0.7) {
                        grid[x][y].habitat = 'water';
                        grid[x][y].legacyAge = 1;
                    }
                }
            }
            draw();
        });

        // Engineer type tabs
        document.getElementById('beaverTab').addEventListener('click', () => {
            engineerType = 'beaver';
            document.getElementById('beaverTab').classList.add('active');
            document.getElementById('termiteTab').classList.remove('active');
            updateParams();
            initGrid();
            draw();
        });

        document.getElementById('termiteTab').addEventListener('click', () => {
            engineerType = 'termite';
            document.getElementById('termiteTab').classList.add('active');
            document.getElementById('beaverTab').classList.remove('active');
            updateParams();
            initGrid();
            draw();
        });

        // Sliders
        const sliders = ['engineerDensity', 'productivity', 'disturbanceRate', 'legacyPersistence', 'creationRate', 'biodiversityBonus'];
        sliders.forEach(id => {
            const slider = document.getElementById(id);
            const display = document.getElementById(id + 'Value');

            slider.addEventListener('input', () => {
                let value = parseFloat(slider.value);
                if (id === 'legacyPersistence') display.textContent = value + ' years';
                else if (id === 'biodiversityBonus') display.textContent = value.toFixed(1) + 'x';
                else if (id === 'engineerDensity') display.textContent = value;
                else display.textContent = value.toFixed(2);
                updateParams();
            });
        });

        // Initialize
        updateParams();
        initGrid();
        draw();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
