<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pathogen Virulence Evolution - Trade-Off Hypothesis</title>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&family=Nunito:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --sage: #8A9A5B;
            --moss: #606C38;
            --earth: #DDA15E;
            --cream: #FEFAE0;
            --terracotta: #BC6C25;
            --dark-moss: #3d4423;
            --strain1: #4A90D9;
            --strain2: #D94A4A;
            --strain3: #9B59B6;
            --optimal: #27AE60;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, #F4F1DE 50%, #EDE8D5 100%);
            min-height: 100vh;
            color: var(--dark-moss);
            padding: 20px;
        }

        .organic-back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            text-decoration: none;
            color: var(--moss);
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .organic-back-link:hover {
            background: var(--moss);
            color: white;
            transform: translateX(-5px);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding-top: 60px;
        }

        h1 {
            font-family: 'Lora', serif;
            font-size: 2.5rem;
            color: var(--moss);
            text-align: center;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: var(--terracotta);
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        .simulation-area {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 20px;
        }

        .controls {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            max-height: calc(100vh - 150px);
            overflow-y: auto;
        }

        .control-section {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(96, 108, 56, 0.2);
        }

        .control-section:last-child {
            border-bottom: none;
        }

        .control-section h3 {
            color: var(--moss);
            font-size: 1rem;
            margin-bottom: 12px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            font-weight: 600;
            color: var(--moss);
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .control-group input[type="range"] {
            width: 100%;
            accent-color: var(--moss);
        }

        .control-group .value {
            text-align: right;
            font-size: 0.85rem;
            color: var(--terracotta);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            accent-color: var(--moss);
            width: 18px;
            height: 18px;
        }

        button {
            width: 100%;
            padding: 12px;
            background: var(--moss);
            color: white;
            border: none;
            border-radius: 10px;
            font-family: 'Nunito', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        button:hover {
            background: var(--terracotta);
            transform: translateY(-2px);
        }

        button.secondary {
            background: var(--sage);
        }

        .main-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .canvas-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        canvas {
            width: 100%;
            border-radius: 10px;
            background: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .stat-box {
            background: linear-gradient(135deg, var(--sage) 0%, var(--moss) 100%);
            color: white;
            padding: 15px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-box.strain1 {
            background: linear-gradient(135deg, #5BA3E8 0%, var(--strain1) 100%);
        }

        .stat-box.strain2 {
            background: linear-gradient(135deg, #E85B5B 0%, var(--strain2) 100%);
        }

        .stat-box.optimal {
            background: linear-gradient(135deg, #2ECC71 0%, var(--optimal) 100%);
        }

        .stat-box .label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .stat-box .value {
            font-size: 1.3rem;
            font-weight: 700;
            font-family: 'Lora', serif;
        }

        .dual-canvas {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .tradeoff-display {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .tradeoff-display h4 {
            color: var(--moss);
            font-size: 1rem;
            margin-bottom: 10px;
            text-align: center;
        }

        .strain-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 15px;
        }

        .strain-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            border-left: 4px solid var(--strain1);
        }

        .strain-card.s2 { border-left-color: var(--strain2); }
        .strain-card.s3 { border-left-color: var(--strain3); }

        .strain-card h5 {
            color: var(--moss);
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .strain-stat {
            font-size: 0.8rem;
            margin: 4px 0;
        }

        .strain-stat .val {
            font-weight: 700;
        }

        .info-panel {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .equation {
            font-family: 'Times New Roman', serif;
            font-size: 1rem;
            text-align: center;
            padding: 8px;
            background: rgba(96, 108, 56, 0.1);
            border-radius: 8px;
            margin: 8px 0;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 3px;
        }

        @media (max-width: 1100px) {
            .simulation-area {
                grid-template-columns: 1fr;
            }
            .dual-canvas {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .strain-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <a href="index.html" class="organic-back-link">
        <span>←</span>
        <span>Back to Gallery</span>
    </a>

    <div class="container">
        <h1>Pathogen Virulence Evolution</h1>
        <p class="subtitle">Trade-Off Hypothesis: Transmission vs. Host Mortality</p>

        <div class="simulation-area">
            <div class="controls">
                <div class="control-section">
                    <h3>Host Population</h3>
                    <div class="control-group">
                        <label>Population Size (N)</label>
                        <input type="range" id="popSize" min="1000" max="50000" step="1000" value="10000">
                        <div class="value" id="popSizeValue">10,000</div>
                    </div>
                    <div class="control-group">
                        <label>Background Mortality (μ)</label>
                        <input type="range" id="mortality" min="0.001" max="0.05" step="0.001" value="0.01">
                        <div class="value" id="mortalityValue">0.010</div>
                    </div>
                    <div class="control-group">
                        <label>Recovery Rate (γ)</label>
                        <input type="range" id="recovery" min="0.01" max="0.3" step="0.01" value="0.1">
                        <div class="value" id="recoveryValue">0.10</div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Trade-Off Parameters</h3>
                    <div class="control-group">
                        <label>Max Transmission (β_max)</label>
                        <input type="range" id="betaMax" min="0.5" max="3" step="0.1" value="1.5">
                        <div class="value" id="betaMaxValue">1.50</div>
                    </div>
                    <div class="control-group">
                        <label>Trade-Off Shape (k)</label>
                        <input type="range" id="tradeoffK" min="0.5" max="3" step="0.1" value="1">
                        <div class="value" id="tradeoffKValue">1.0 (linear)</div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Strain Competition</h3>
                    <div class="control-group">
                        <label>Strain 1 Virulence (ν₁)</label>
                        <input type="range" id="virulence1" min="0.01" max="0.5" step="0.01" value="0.05">
                        <div class="value" id="virulence1Value">0.05</div>
                    </div>
                    <div class="control-group">
                        <label>Strain 2 Virulence (ν₂)</label>
                        <input type="range" id="virulence2" min="0.01" max="0.5" step="0.01" value="0.15">
                        <div class="value" id="virulence2Value">0.15</div>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="multipleInfection">
                        <label for="multipleInfection">Allow Multiple Infections</label>
                    </div>
                    <div class="control-group" id="coinfectionGroup" style="display: none;">
                        <label>Coinfection Competition</label>
                        <input type="range" id="competition" min="0" max="2" step="0.1" value="1">
                        <div class="value" id="competitionValue">1.0 (neutral)</div>
                    </div>
                </div>

                <button id="runBtn">▶ Run Evolution</button>
                <button id="stepBtn" class="secondary">Step (10 gen)</button>
                <button id="resetBtn" class="secondary">Reset</button>

                <div class="info-panel">
                    <h3 style="color: var(--moss); margin-bottom: 8px;">Trade-Off Hypothesis</h3>
                    <p>Parasites face a trade-off: higher virulence (ν) increases transmission (β) but shortens infection duration.</p>
                    <div class="equation">R₀ = β(ν) / (μ + ν + γ)</div>
                    <div class="equation">β(ν) = β_max × (ν / (ν + k))</div>
                    <p style="margin-top: 8px;">Optimal virulence maximizes R₀. With competition, virulence often increases.</p>
                </div>
            </div>

            <div class="main-area">
                <div class="dual-canvas">
                    <div class="canvas-container">
                        <canvas id="dynamicsCanvas"></canvas>
                        <div class="legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--strain1);"></div>
                                <span>Strain 1 (low ν)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--strain2);"></div>
                                <span>Strain 2 (high ν)</span>
                            </div>
                        </div>
                    </div>
                    <div class="canvas-container">
                        <canvas id="tradeoffCanvas"></canvas>
                        <div class="legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--optimal);"></div>
                                <span>Optimal Virulence</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--earth);"></div>
                                <span>R₀ Curve</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-box strain1">
                        <div class="label">Strain 1 Prevalence</div>
                        <div class="value" id="prev1">0%</div>
                    </div>
                    <div class="stat-box strain2">
                        <div class="label">Strain 2 Prevalence</div>
                        <div class="value" id="prev2">0%</div>
                    </div>
                    <div class="stat-box optimal">
                        <div class="label">Optimal Virulence</div>
                        <div class="value" id="optVir">0.00</div>
                    </div>
                    <div class="stat-box">
                        <div class="label">Generation</div>
                        <div class="value" id="genCount">0</div>
                    </div>
                </div>

                <div class="strain-cards">
                    <div class="strain-card">
                        <h5>Strain 1</h5>
                        <div class="strain-stat">Virulence: <span class="val" id="s1vir">0.05</span></div>
                        <div class="strain-stat">β: <span class="val" id="s1beta">0.00</span></div>
                        <div class="strain-stat">R₀: <span class="val" id="s1r0">0.00</span></div>
                        <div class="strain-stat">Duration: <span class="val" id="s1dur">0</span> days</div>
                    </div>
                    <div class="strain-card s2">
                        <h5>Strain 2</h5>
                        <div class="strain-stat">Virulence: <span class="val" id="s2vir">0.15</span></div>
                        <div class="strain-stat">β: <span class="val" id="s2beta">0.00</span></div>
                        <div class="strain-stat">R₀: <span class="val" id="s2r0">0.00</span></div>
                        <div class="strain-stat">Duration: <span class="val" id="s2dur">0</span> days</div>
                    </div>
                    <div class="strain-card s3">
                        <h5>Predicted Winner</h5>
                        <div class="strain-stat">Higher R₀: <span class="val" id="winner">-</span></div>
                        <div class="strain-stat">Competitive Outcome: <span class="val" id="outcome">-</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Canvas setup
        const dynCanvas = document.getElementById('dynamicsCanvas');
        const dynCtx = dynCanvas.getContext('2d');
        const tradeCanvas = document.getElementById('tradeoffCanvas');
        const tradeCtx = tradeCanvas.getContext('2d');

        function setupCanvas(canvas, ctx) {
            const rect = canvas.parentElement.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            canvas.width = (rect.width - 40) * dpr;
            canvas.height = 280 * dpr;
            canvas.style.width = (rect.width - 40) + 'px';
            canvas.style.height = '280px';
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.scale(dpr, dpr);
        }

        function setupAllCanvases() {
            setupCanvas(dynCanvas, dynCtx);
            setupCanvas(tradeCanvas, tradeCtx);
        }
        setupAllCanvases();
        window.addEventListener('resize', () => { setupAllCanvases(); draw(); });

        // Simulation state
        let S, I1, I2, I12; // Susceptible, Infected with strain 1, strain 2, or both
        let N;
        let generation = 0;
        let history = { I1: [], I2: [], gens: [] };
        let running = false;
        let animationId = null;

        // Parameters
        let popSize = 10000;
        let mu = 0.01;      // background mortality
        let gamma = 0.1;    // recovery rate
        let betaMax = 1.5;  // max transmission rate
        let tradeoffK = 1;  // trade-off shape parameter
        let v1 = 0.05;      // virulence strain 1
        let v2 = 0.15;      // virulence strain 2
        let multipleInfection = false;
        let competition = 1; // within-host competition factor

        // Trade-off function: β(ν) = βmax * ν/(ν + k) (saturating)
        function getBeta(virulence) {
            return betaMax * Math.pow(virulence / (virulence + tradeoffK), 0.7);
        }

        // Calculate R0 for a strain
        function calculateR0(virulence) {
            const beta = getBeta(virulence);
            return beta / (mu + virulence + gamma);
        }

        // Find optimal virulence (maximize R0)
        function findOptimalVirulence() {
            let bestV = 0.01;
            let bestR0 = 0;
            for (let v = 0.01; v <= 1; v += 0.01) {
                const r0 = calculateR0(v);
                if (r0 > bestR0) {
                    bestR0 = r0;
                    bestV = v;
                }
            }
            return bestV;
        }

        // Initialize simulation
        function init() {
            N = popSize;
            const initInf = Math.floor(N * 0.01);
            I1 = initInf;
            I2 = initInf;
            I12 = 0;
            S = N - I1 - I2;
            generation = 0;
            history = { I1: [I1/N], I2: [I2/N], gens: [0] };
            updateStats();
            updateStrainCards();
        }

        // Simulation step (one generation)
        function step() {
            generation++;

            const beta1 = getBeta(v1);
            const beta2 = getBeta(v2);

            // Force of infection
            const totalI1 = I1 + (multipleInfection ? I12 * competition : 0);
            const totalI2 = I2 + (multipleInfection ? I12 * competition : 0);

            const lambda1 = beta1 * totalI1 / N;
            const lambda2 = beta2 * totalI2 / N;

            // Transitions (discrete time approximation)
            const dt = 1;

            // New infections
            const newI1fromS = Math.min(S, Math.floor(lambda1 * S * dt));
            const newI2fromS = Math.min(S - newI1fromS, Math.floor(lambda2 * S * dt));

            // Coinfection (if enabled)
            let newI12fromI1 = 0;
            let newI12fromI2 = 0;
            if (multipleInfection) {
                newI12fromI1 = Math.min(I1, Math.floor(lambda2 * I1 * 0.3 * dt)); // reduced secondary infection
                newI12fromI2 = Math.min(I2, Math.floor(lambda1 * I2 * 0.3 * dt));
            }

            // Deaths and recoveries
            const deaths1 = Math.floor((mu + v1) * I1 * dt);
            const deaths2 = Math.floor((mu + v2) * I2 * dt);
            const deaths12 = multipleInfection ? Math.floor((mu + Math.max(v1, v2) * competition) * I12 * dt) : 0;

            const recover1 = Math.floor(gamma * I1 * dt);
            const recover2 = Math.floor(gamma * I2 * dt);
            const recover12 = multipleInfection ? Math.floor(gamma * I12 * dt) : 0;

            const deathsS = Math.floor(mu * S * dt);

            // Update populations
            S = S - newI1fromS - newI2fromS - deathsS + recover1 + recover2 + recover12;
            I1 = I1 + newI1fromS - deaths1 - recover1 - newI12fromI1;
            I2 = I2 + newI2fromS - deaths2 - recover2 - newI12fromI2;
            I12 = I12 + newI12fromI1 + newI12fromI2 - deaths12 - recover12;

            // Add births to maintain population
            const totalDeaths = deaths1 + deaths2 + deaths12 + deathsS;
            S += totalDeaths; // births replace deaths as susceptibles

            // Ensure non-negative
            S = Math.max(0, S);
            I1 = Math.max(0, I1);
            I2 = Math.max(0, I2);
            I12 = Math.max(0, I12);

            // Record history
            history.I1.push(I1 / N);
            history.I2.push(I2 / N);
            history.gens.push(generation);

            // Limit history
            const maxHistory = 500;
            if (history.gens.length > maxHistory) {
                history.I1.shift();
                history.I2.shift();
                history.gens.shift();
            }

            updateStats();
        }

        // Update statistics
        function updateStats() {
            const prev1 = I1 / N * 100;
            const prev2 = I2 / N * 100;
            const optV = findOptimalVirulence();

            document.getElementById('prev1').textContent = prev1.toFixed(1) + '%';
            document.getElementById('prev2').textContent = prev2.toFixed(1) + '%';
            document.getElementById('optVir').textContent = optV.toFixed(3);
            document.getElementById('genCount').textContent = generation;
        }

        // Update strain info cards
        function updateStrainCards() {
            const beta1 = getBeta(v1);
            const beta2 = getBeta(v2);
            const r0_1 = calculateR0(v1);
            const r0_2 = calculateR0(v2);
            const dur1 = 1 / (mu + v1 + gamma);
            const dur2 = 1 / (mu + v2 + gamma);

            document.getElementById('s1vir').textContent = v1.toFixed(3);
            document.getElementById('s1beta').textContent = beta1.toFixed(3);
            document.getElementById('s1r0').textContent = r0_1.toFixed(2);
            document.getElementById('s1dur').textContent = dur1.toFixed(1);

            document.getElementById('s2vir').textContent = v2.toFixed(3);
            document.getElementById('s2beta').textContent = beta2.toFixed(3);
            document.getElementById('s2r0').textContent = r0_2.toFixed(2);
            document.getElementById('s2dur').textContent = dur2.toFixed(1);

            // Prediction
            let winner, outcome;
            if (Math.abs(r0_1 - r0_2) < 0.1) {
                winner = 'Coexistence';
                outcome = 'Similar fitness';
            } else if (r0_1 > r0_2) {
                winner = 'Strain 1';
                outcome = 'Lower virulence wins';
            } else {
                winner = 'Strain 2';
                outcome = 'Higher virulence wins';
            }

            if (multipleInfection && competition > 1) {
                outcome = 'Competition favors high ν';
            }

            document.getElementById('winner').textContent = winner;
            document.getElementById('outcome').textContent = outcome;
        }

        // Draw dynamics canvas
        function drawDynamics() {
            const width = dynCanvas.width / (window.devicePixelRatio || 1);
            const height = dynCanvas.height / (window.devicePixelRatio || 1);
            const padding = { top: 35, right: 20, bottom: 40, left: 50 };
            const plotWidth = width - padding.left - padding.right;
            const plotHeight = height - padding.top - padding.bottom;

            // Clear
            dynCtx.fillStyle = '#FEFAE0';
            dynCtx.fillRect(0, 0, width, height);

            // Grid
            dynCtx.strokeStyle = '#E0DCC8';
            dynCtx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding.top + (plotHeight * i / 5);
                dynCtx.beginPath();
                dynCtx.moveTo(padding.left, y);
                dynCtx.lineTo(width - padding.right, y);
                dynCtx.stroke();
            }

            // Axes
            dynCtx.strokeStyle = '#606C38';
            dynCtx.lineWidth = 2;
            dynCtx.beginPath();
            dynCtx.moveTo(padding.left, padding.top);
            dynCtx.lineTo(padding.left, height - padding.bottom);
            dynCtx.lineTo(width - padding.right, height - padding.bottom);
            dynCtx.stroke();

            // Labels
            dynCtx.fillStyle = '#3d4423';
            dynCtx.font = '12px Nunito';
            dynCtx.textAlign = 'center';
            dynCtx.fillText('Generation', width / 2, height - 8);

            dynCtx.save();
            dynCtx.translate(12, height / 2);
            dynCtx.rotate(-Math.PI / 2);
            dynCtx.fillText('Prevalence', 0, 0);
            dynCtx.restore();

            // Y-axis ticks
            dynCtx.textAlign = 'right';
            const maxPrev = Math.max(0.5, Math.max(...history.I1, ...history.I2) * 1.2);
            for (let i = 0; i <= 5; i++) {
                const y = padding.top + (plotHeight * i / 5);
                const val = ((5 - i) / 5 * maxPrev * 100).toFixed(0);
                dynCtx.fillText(val + '%', padding.left - 8, y + 4);
            }

            // X-axis ticks
            dynCtx.textAlign = 'center';
            const maxGen = Math.max(100, generation);
            const minGen = history.gens[0] || 0;
            for (let g = 0; g <= 5; g++) {
                const genVal = Math.round(minGen + (maxGen - minGen) * g / 5);
                const x = padding.left + plotWidth * g / 5;
                dynCtx.fillText(genVal.toString(), x, height - padding.bottom + 15);
            }

            // Draw lines
            function drawLine(data, color) {
                if (data.length < 2) return;
                dynCtx.strokeStyle = color;
                dynCtx.lineWidth = 3;
                dynCtx.beginPath();

                for (let i = 0; i < data.length; i++) {
                    const x = padding.left + plotWidth * (history.gens[i] - minGen) / (maxGen - minGen);
                    const y = padding.top + plotHeight * (1 - data[i] / maxPrev);
                    if (i === 0) dynCtx.moveTo(x, y);
                    else dynCtx.lineTo(x, y);
                }
                dynCtx.stroke();
            }

            drawLine(history.I1, '#4A90D9');
            drawLine(history.I2, '#D94A4A');

            // Title
            dynCtx.fillStyle = '#606C38';
            dynCtx.font = 'bold 14px Lora';
            dynCtx.textAlign = 'left';
            dynCtx.fillText('Strain Competition Dynamics', padding.left, 20);
        }

        // Draw trade-off canvas
        function drawTradeoff() {
            const width = tradeCanvas.width / (window.devicePixelRatio || 1);
            const height = tradeCanvas.height / (window.devicePixelRatio || 1);
            const padding = { top: 35, right: 20, bottom: 40, left: 50 };
            const plotWidth = width - padding.left - padding.right;
            const plotHeight = height - padding.top - padding.bottom;

            // Clear
            tradeCtx.fillStyle = '#FEFAE0';
            tradeCtx.fillRect(0, 0, width, height);

            // Grid
            tradeCtx.strokeStyle = '#E0DCC8';
            tradeCtx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding.top + (plotHeight * i / 5);
                tradeCtx.beginPath();
                tradeCtx.moveTo(padding.left, y);
                tradeCtx.lineTo(width - padding.right, y);
                tradeCtx.stroke();
            }

            // Axes
            tradeCtx.strokeStyle = '#606C38';
            tradeCtx.lineWidth = 2;
            tradeCtx.beginPath();
            tradeCtx.moveTo(padding.left, padding.top);
            tradeCtx.lineTo(padding.left, height - padding.bottom);
            tradeCtx.lineTo(width - padding.right, height - padding.bottom);
            tradeCtx.stroke();

            // Labels
            tradeCtx.fillStyle = '#3d4423';
            tradeCtx.font = '12px Nunito';
            tradeCtx.textAlign = 'center';
            tradeCtx.fillText('Virulence (ν)', width / 2, height - 8);

            tradeCtx.save();
            tradeCtx.translate(12, height / 2);
            tradeCtx.rotate(-Math.PI / 2);
            tradeCtx.fillText('R₀', 0, 0);
            tradeCtx.restore();

            // Calculate R0 curve
            const r0Values = [];
            const vMax = 0.5;
            let maxR0 = 0;
            let optV = 0;
            for (let v = 0.01; v <= vMax; v += 0.01) {
                const r0 = calculateR0(v);
                r0Values.push({ v, r0 });
                if (r0 > maxR0) {
                    maxR0 = r0;
                    optV = v;
                }
            }
            maxR0 = Math.max(maxR0, 3);

            // Y-axis ticks
            tradeCtx.textAlign = 'right';
            for (let i = 0; i <= 5; i++) {
                const y = padding.top + (plotHeight * i / 5);
                const val = ((5 - i) / 5 * maxR0).toFixed(1);
                tradeCtx.fillText(val, padding.left - 8, y + 4);
            }

            // X-axis ticks
            tradeCtx.textAlign = 'center';
            for (let i = 0; i <= 5; i++) {
                const v = (i / 5 * vMax).toFixed(2);
                const x = padding.left + plotWidth * i / 5;
                tradeCtx.fillText(v, x, height - padding.bottom + 15);
            }

            // Draw R0 curve
            tradeCtx.strokeStyle = '#DDA15E';
            tradeCtx.lineWidth = 3;
            tradeCtx.beginPath();
            for (let i = 0; i < r0Values.length; i++) {
                const x = padding.left + plotWidth * (r0Values[i].v / vMax);
                const y = padding.top + plotHeight * (1 - r0Values[i].r0 / maxR0);
                if (i === 0) tradeCtx.moveTo(x, y);
                else tradeCtx.lineTo(x, y);
            }
            tradeCtx.stroke();

            // Mark optimal virulence
            const optX = padding.left + plotWidth * (optV / vMax);
            const optY = padding.top + plotHeight * (1 - calculateR0(optV) / maxR0);

            tradeCtx.setLineDash([5, 5]);
            tradeCtx.strokeStyle = '#27AE60';
            tradeCtx.lineWidth = 2;
            tradeCtx.beginPath();
            tradeCtx.moveTo(optX, height - padding.bottom);
            tradeCtx.lineTo(optX, optY);
            tradeCtx.stroke();
            tradeCtx.setLineDash([]);

            tradeCtx.fillStyle = '#27AE60';
            tradeCtx.beginPath();
            tradeCtx.arc(optX, optY, 8, 0, Math.PI * 2);
            tradeCtx.fill();

            // Mark strain positions
            function markStrain(v, color, label) {
                if (v > vMax) return;
                const x = padding.left + plotWidth * (v / vMax);
                const y = padding.top + plotHeight * (1 - calculateR0(v) / maxR0);

                tradeCtx.fillStyle = color;
                tradeCtx.beginPath();
                tradeCtx.arc(x, y, 6, 0, Math.PI * 2);
                tradeCtx.fill();

                tradeCtx.strokeStyle = 'white';
                tradeCtx.lineWidth = 2;
                tradeCtx.stroke();

                tradeCtx.fillStyle = color;
                tradeCtx.font = 'bold 11px Nunito';
                tradeCtx.textAlign = 'center';
                tradeCtx.fillText(label, x, y - 12);
            }

            markStrain(v1, '#4A90D9', 'S1');
            markStrain(v2, '#D94A4A', 'S2');

            // Title
            tradeCtx.fillStyle = '#606C38';
            tradeCtx.font = 'bold 14px Lora';
            tradeCtx.textAlign = 'left';
            tradeCtx.fillText('Transmission-Virulence Trade-Off', padding.left, 20);

            // Update optimal virulence display
            document.getElementById('optVir').textContent = optV.toFixed(3);
        }

        function draw() {
            drawDynamics();
            drawTradeoff();
        }

        // Animation loop
        function animate() {
            if (!running) return;

            for (let i = 0; i < 5; i++) step();
            draw();

            if (generation < 2000) {
                animationId = requestAnimationFrame(animate);
            } else {
                running = false;
                document.getElementById('runBtn').textContent = '▶ Run Evolution';
            }
        }

        // Event handlers
        document.getElementById('runBtn').addEventListener('click', () => {
            if (running) {
                running = false;
                cancelAnimationFrame(animationId);
                document.getElementById('runBtn').textContent = '▶ Run Evolution';
            } else {
                running = true;
                document.getElementById('runBtn').textContent = '⏸ Pause';
                animate();
            }
        });

        document.getElementById('stepBtn').addEventListener('click', () => {
            if (!running) {
                for (let i = 0; i < 10; i++) step();
                draw();
            }
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            running = false;
            cancelAnimationFrame(animationId);
            document.getElementById('runBtn').textContent = '▶ Run Evolution';
            init();
            draw();
        });

        // Parameter controls
        document.getElementById('popSize').addEventListener('input', function() {
            popSize = parseInt(this.value);
            document.getElementById('popSizeValue').textContent = popSize.toLocaleString();
        });

        document.getElementById('mortality').addEventListener('input', function() {
            mu = parseFloat(this.value);
            document.getElementById('mortalityValue').textContent = mu.toFixed(3);
            updateStrainCards();
            draw();
        });

        document.getElementById('recovery').addEventListener('input', function() {
            gamma = parseFloat(this.value);
            document.getElementById('recoveryValue').textContent = gamma.toFixed(2);
            updateStrainCards();
            draw();
        });

        document.getElementById('betaMax').addEventListener('input', function() {
            betaMax = parseFloat(this.value);
            document.getElementById('betaMaxValue').textContent = betaMax.toFixed(2);
            updateStrainCards();
            draw();
        });

        document.getElementById('tradeoffK').addEventListener('input', function() {
            tradeoffK = parseFloat(this.value);
            const desc = tradeoffK < 0.8 ? '(accelerating)' : tradeoffK > 1.2 ? '(decelerating)' : '(linear)';
            document.getElementById('tradeoffKValue').textContent = tradeoffK.toFixed(1) + ' ' + desc;
            updateStrainCards();
            draw();
        });

        document.getElementById('virulence1').addEventListener('input', function() {
            v1 = parseFloat(this.value);
            document.getElementById('virulence1Value').textContent = v1.toFixed(2);
            updateStrainCards();
            draw();
        });

        document.getElementById('virulence2').addEventListener('input', function() {
            v2 = parseFloat(this.value);
            document.getElementById('virulence2Value').textContent = v2.toFixed(2);
            updateStrainCards();
            draw();
        });

        document.getElementById('multipleInfection').addEventListener('change', function() {
            multipleInfection = this.checked;
            document.getElementById('coinfectionGroup').style.display = this.checked ? 'block' : 'none';
            updateStrainCards();
        });

        document.getElementById('competition').addEventListener('input', function() {
            competition = parseFloat(this.value);
            const desc = competition < 0.8 ? '(cooperation)' : competition > 1.2 ? '(competition)' : '(neutral)';
            document.getElementById('competitionValue').textContent = competition.toFixed(1) + ' ' + desc;
            updateStrainCards();
        });

        // Initialize
        init();
        draw();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
