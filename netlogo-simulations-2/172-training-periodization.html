<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Training Periodization - CCAB</title>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600&family=Nunito:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Nunito', sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: #e8e6e1; min-height: 100vh; }
        .back-link { position: fixed; top: 20px; left: 20px; color: #8b5cf6; text-decoration: none; font-size: 14px; z-index: 100; opacity: 0.8; }
        .back-link:hover { opacity: 1; }

        #container { display: flex; height: 100vh; }
        #canvas-container { flex: 1; display: flex; align-items: center; justify-content: center; }
        canvas { background: #0d1117; border-radius: 8px; }

        #controls { width: 320px; background: rgba(0,0,0,0.4); padding: 25px; overflow-y: auto; }
        h1 { font-family: 'Lora', serif; font-size: 1.5rem; margin-bottom: 10px; color: #8b5cf6; }
        .subtitle { font-size: 0.85rem; color: #888; margin-bottom: 20px; line-height: 1.5; }

        .control-group { margin-bottom: 20px; }
        label { display: block; font-size: 0.8rem; margin-bottom: 8px; color: #aaa; }
        input[type="range"] { width: 100%; margin-bottom: 5px; }
        select { width: 100%; padding: 8px; background: #333; color: #e8e6e1; border: 1px solid #555; border-radius: 4px; }
        .value { font-size: 0.75rem; color: #8b5cf6; }

        button { width: 100%; padding: 12px; margin-bottom: 10px; background: #8b5cf6; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-family: 'Nunito', sans-serif; }
        button:hover { background: #a78bfa; }
        .btn-secondary { background: #444; color: #e8e6e1; }
        .btn-secondary:hover { background: #555; }

        .stats-box { background: rgba(139,92,246,0.1); border: 1px solid rgba(139,92,246,0.3); border-radius: 8px; padding: 15px; margin-top: 20px; }
        .stats-box h3 { font-family: 'Lora', serif; font-size: 0.9rem; margin-bottom: 10px; color: #8b5cf6; }
        .stat-row { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 5px; }
        .stat-label { color: #888; }
        .stat-value { color: #e8e6e1; font-weight: 600; }

        .info-panel { background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; margin-top: 20px; font-size: 0.75rem; line-height: 1.6; color: #888; }
        .info-panel strong { color: #8b5cf6; }

        .legend { display: flex; gap: 15px; margin-top: 15px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 5px; font-size: 0.75rem; }
        .legend-color { width: 12px; height: 12px; border-radius: 2px; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back to Gallery</a>

    <div id="container">
        <div id="canvas-container">
            <canvas id="canvas"></canvas>
        </div>

        <div id="controls">
            <h1>Training Periodization</h1>
            <p class="subtitle">Fitness-Fatigue model: Balance training load to peak performance at competition</p>

            <div class="control-group">
                <label>Training Period:</label>
                <select id="periodType">
                    <option value="linear">Linear Periodization</option>
                    <option value="block">Block Periodization</option>
                    <option value="undulating">Undulating</option>
                    <option value="custom">Custom (Click to Set)</option>
                </select>
            </div>

            <div class="control-group">
                <label>Fitness Decay Rate (τ₁): <span class="value" id="fitnessDecayValue">42</span> days</label>
                <input type="range" id="fitnessDecay" min="20" max="80" step="2" value="42">
            </div>

            <div class="control-group">
                <label>Fatigue Decay Rate (τ₂): <span class="value" id="fatigueDecayValue">7</span> days</label>
                <input type="range" id="fatigueDecay" min="3" max="21" step="1" value="7">
            </div>

            <div class="control-group">
                <label>Fatigue Multiplier (k₂): <span class="value" id="fatigueMultValue">2.0</span></label>
                <input type="range" id="fatigueMult" min="1" max="4" step="0.1" value="2">
            </div>

            <button id="startBtn">Start Simulation</button>
            <button id="resetBtn" class="btn-secondary">Reset</button>

            <div class="stats-box">
                <h3>Athlete Status</h3>
                <div class="stat-row">
                    <span class="stat-label">Day:</span>
                    <span class="stat-value" id="day">0 / 90</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Fitness Level:</span>
                    <span class="stat-value" id="fitness">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Fatigue Level:</span>
                    <span class="stat-value" id="fatigue">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Performance:</span>
                    <span class="stat-value" id="performance">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Peak Performance:</span>
                    <span class="stat-value" id="peak">-</span>
                </div>
            </div>

            <div class="legend">
                <div class="legend-item"><div class="legend-color" style="background: #22c55e;"></div> Fitness</div>
                <div class="legend-item"><div class="legend-color" style="background: #ef4444;"></div> Fatigue</div>
                <div class="legend-item"><div class="legend-color" style="background: #8b5cf6;"></div> Performance</div>
                <div class="legend-item"><div class="legend-color" style="background: #3b82f6;"></div> Training Load</div>
            </div>

            <div class="info-panel">
                <strong>Fitness-Fatigue Model:</strong> Training builds both fitness (slow decay) and fatigue (fast decay). Performance = Fitness - Fatigue. Taper before competition to let fatigue dissipate while retaining fitness gains.
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function setupCanvas() {
            const container = document.getElementById('canvas-container');
            const dpr = window.devicePixelRatio || 1;
            const rect = container.getBoundingClientRect();
            const width = Math.min(rect.width - 40, 900);
            const height = Math.min(rect.height - 40, 600);

            canvas.width = width * dpr;
            canvas.height = height * dpr;
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';
            ctx.scale(dpr, dpr);

            return { width, height };
        }

        let canvasDims = setupCanvas();

        // Simulation parameters
        const totalDays = 90; // 3 month training cycle
        const competitionDay = 84; // Competition near end
        let fitnessDecay = 42;
        let fatigueDecay = 7;
        let fatigueMult = 2.0;

        let trainingLoads = [];
        let fitnessHistory = [];
        let fatigueHistory = [];
        let performanceHistory = [];
        let currentDay = 0;
        let running = false;
        let animationId = null;
        let peakPerformance = 0;
        let peakDay = 0;

        // Generate training program
        function generateProgram(type) {
            trainingLoads = [];

            for (let day = 0; day < totalDays; day++) {
                let load = 0;

                switch(type) {
                    case 'linear':
                        // Linear: Build up then taper
                        if (day < 70) {
                            load = 40 + (day / 70) * 40; // Build from 40 to 80
                        } else {
                            load = 80 - ((day - 70) / 14) * 60; // Taper down
                        }
                        break;

                    case 'block':
                        // Block: High, medium, low intensity blocks
                        const block = Math.floor(day / 21);
                        if (block === 0) load = 80; // High volume
                        else if (block === 1) load = 60; // Medium
                        else if (block === 2) load = 70; // Intensity focus
                        else load = 20; // Taper
                        break;

                    case 'undulating':
                        // Daily undulating
                        const weekDay = day % 7;
                        if (weekDay === 0) load = 80;
                        else if (weekDay === 1) load = 50;
                        else if (weekDay === 2) load = 70;
                        else if (weekDay === 3) load = 40;
                        else if (weekDay === 4) load = 75;
                        else if (weekDay === 5) load = 30;
                        else load = 0; // Rest day

                        // Still taper at end
                        if (day > 77) load *= Math.max(0, 1 - (day - 77) / 7);
                        break;

                    case 'custom':
                        // Start with moderate
                        load = 50;
                        break;
                }

                trainingLoads.push(load);
            }
        }

        function init() {
            currentDay = 0;
            fitnessHistory = [0];
            fatigueHistory = [0];
            performanceHistory = [0];
            peakPerformance = 0;
            peakDay = 0;

            fitnessDecay = parseInt(document.getElementById('fitnessDecay').value);
            fatigueDecay = parseInt(document.getElementById('fatigueDecay').value);
            fatigueMult = parseFloat(document.getElementById('fatigueMult').value);

            generateProgram(document.getElementById('periodType').value);
            updateStats();
            draw();
        }

        function simulateDay() {
            if (currentDay >= totalDays) {
                running = false;
                return;
            }

            const load = trainingLoads[currentDay];
            const prevFitness = fitnessHistory[currentDay];
            const prevFatigue = fatigueHistory[currentDay];

            // Fitness-Fatigue impulse response model
            const fitnessGain = load / 100; // Normalize
            const fatigueGain = (load / 100) * fatigueMult;

            // Decay previous values and add new gains
            const newFitness = prevFitness * Math.exp(-1 / fitnessDecay) + fitnessGain;
            const newFatigue = prevFatigue * Math.exp(-1 / fatigueDecay) + fatigueGain;
            const performance = (newFitness - newFatigue) * 100;

            fitnessHistory.push(newFitness);
            fatigueHistory.push(newFatigue);
            performanceHistory.push(performance);

            if (performance > peakPerformance) {
                peakPerformance = performance;
                peakDay = currentDay + 1;
            }

            currentDay++;
            updateStats();
        }

        function updateStats() {
            document.getElementById('day').textContent = `${currentDay} / ${totalDays}`;

            const fitness = fitnessHistory[currentDay] || 0;
            const fatigue = fatigueHistory[currentDay] || 0;
            const perf = performanceHistory[currentDay] || 0;

            document.getElementById('fitness').textContent = (fitness * 100).toFixed(1);
            document.getElementById('fatigue').textContent = (fatigue * 100).toFixed(1);
            document.getElementById('performance').textContent = perf.toFixed(1);
            document.getElementById('peak').textContent = `${peakPerformance.toFixed(1)} (Day ${peakDay})`;
        }

        function draw() {
            const { width, height } = canvasDims;
            ctx.fillStyle = '#0d1117';
            ctx.fillRect(0, 0, width, height);

            const padding = { top: 40, right: 40, bottom: 60, left: 60 };
            const plotWidth = width - padding.left - padding.right;
            const plotHeight = height - padding.top - padding.bottom;

            // Draw axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding.left, padding.top);
            ctx.lineTo(padding.left, height - padding.bottom);
            ctx.lineTo(width - padding.right, height - padding.bottom);
            ctx.stroke();

            // Axis labels
            ctx.fillStyle = '#888';
            ctx.font = '12px Nunito';
            ctx.textAlign = 'center';
            ctx.fillText('Days', width / 2, height - 10);

            ctx.save();
            ctx.translate(15, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Value', 0, 0);
            ctx.restore();

            // Draw competition day marker
            const compX = padding.left + (competitionDay / totalDays) * plotWidth;
            ctx.strokeStyle = '#fbbf24';
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(compX, padding.top);
            ctx.lineTo(compX, height - padding.bottom);
            ctx.stroke();
            ctx.setLineDash([]);

            ctx.fillStyle = '#fbbf24';
            ctx.textAlign = 'center';
            ctx.fillText('Competition', compX, padding.top - 10);

            // Scale for values
            const maxVal = 150;
            const minVal = -50;
            const valToY = (val) => padding.top + plotHeight * (1 - (val - minVal) / (maxVal - minVal));
            const dayToX = (day) => padding.left + (day / totalDays) * plotWidth;

            // Draw zero line
            ctx.strokeStyle = '#444';
            ctx.beginPath();
            ctx.moveTo(padding.left, valToY(0));
            ctx.lineTo(width - padding.right, valToY(0));
            ctx.stroke();

            // Draw training load bars
            ctx.fillStyle = 'rgba(59, 130, 246, 0.3)';
            const barWidth = plotWidth / totalDays;
            for (let i = 0; i < trainingLoads.length; i++) {
                const x = dayToX(i);
                const barHeight = (trainingLoads[i] / 100) * (plotHeight * 0.3);
                ctx.fillRect(x, height - padding.bottom - barHeight, barWidth - 1, barHeight);
            }

            // Draw fitness curve
            if (fitnessHistory.length > 1) {
                ctx.strokeStyle = '#22c55e';
                ctx.lineWidth = 2;
                ctx.beginPath();
                for (let i = 0; i < fitnessHistory.length; i++) {
                    const x = dayToX(i);
                    const y = valToY(fitnessHistory[i] * 100);
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
            }

            // Draw fatigue curve
            if (fatigueHistory.length > 1) {
                ctx.strokeStyle = '#ef4444';
                ctx.lineWidth = 2;
                ctx.beginPath();
                for (let i = 0; i < fatigueHistory.length; i++) {
                    const x = dayToX(i);
                    const y = valToY(fatigueHistory[i] * 100);
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
            }

            // Draw performance curve
            if (performanceHistory.length > 1) {
                ctx.strokeStyle = '#8b5cf6';
                ctx.lineWidth = 3;
                ctx.beginPath();
                for (let i = 0; i < performanceHistory.length; i++) {
                    const x = dayToX(i);
                    const y = valToY(performanceHistory[i]);
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
            }

            // Draw current day marker
            if (currentDay > 0) {
                const cx = dayToX(currentDay);
                ctx.strokeStyle = '#fff';
                ctx.setLineDash([3, 3]);
                ctx.beginPath();
                ctx.moveTo(cx, padding.top);
                ctx.lineTo(cx, height - padding.bottom);
                ctx.stroke();
                ctx.setLineDash([]);
            }

            // Draw peak marker
            if (peakDay > 0) {
                const px = dayToX(peakDay);
                const py = valToY(peakPerformance);
                ctx.fillStyle = '#fbbf24';
                ctx.beginPath();
                ctx.arc(px, py, 6, 0, Math.PI * 2);
                ctx.fill();
            }

            // Y-axis labels
            ctx.fillStyle = '#666';
            ctx.textAlign = 'right';
            for (let v = minVal; v <= maxVal; v += 50) {
                const y = valToY(v);
                ctx.fillText(v.toString(), padding.left - 10, y + 4);
            }

            // X-axis labels
            ctx.textAlign = 'center';
            for (let d = 0; d <= totalDays; d += 15) {
                const x = dayToX(d);
                ctx.fillText(d.toString(), x, height - padding.bottom + 20);
            }
        }

        function animate() {
            if (running) {
                simulateDay();
                draw();
                if (currentDay < totalDays) {
                    animationId = setTimeout(animate, 50);
                } else {
                    running = false;
                    document.getElementById('startBtn').textContent = 'Complete';
                }
            }
        }

        // Handle custom training load clicks
        canvas.addEventListener('click', (e) => {
            if (document.getElementById('periodType').value !== 'custom') return;

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const padding = { left: 60, right: 40, top: 40, bottom: 60 };
            const plotWidth = canvasDims.width - padding.left - padding.right;
            const plotHeight = canvasDims.height - padding.top - padding.bottom;

            const day = Math.floor(((x - padding.left) / plotWidth) * totalDays);
            const load = Math.max(0, Math.min(100, (1 - (y - padding.top) / plotHeight) * 100));

            if (day >= 0 && day < totalDays) {
                // Set load for a range of days around click
                for (let d = Math.max(0, day - 2); d <= Math.min(totalDays - 1, day + 2); d++) {
                    trainingLoads[d] = load;
                }
                draw();
            }
        });

        // Event listeners
        document.getElementById('fitnessDecay').addEventListener('input', e => {
            document.getElementById('fitnessDecayValue').textContent = e.target.value;
        });

        document.getElementById('fatigueDecay').addEventListener('input', e => {
            document.getElementById('fatigueDecayValue').textContent = e.target.value;
        });

        document.getElementById('fatigueMult').addEventListener('input', e => {
            document.getElementById('fatigueMultValue').textContent = e.target.value;
        });

        document.getElementById('periodType').addEventListener('change', init);

        document.getElementById('startBtn').addEventListener('click', () => {
            if (running) {
                running = false;
                clearTimeout(animationId);
                document.getElementById('startBtn').textContent = 'Resume';
            } else {
                if (currentDay >= totalDays) {
                    init();
                }
                running = true;
                document.getElementById('startBtn').textContent = 'Pause';
                animate();
            }
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            running = false;
            clearTimeout(animationId);
            document.getElementById('startBtn').textContent = 'Start Simulation';
            init();
        });

        window.addEventListener('resize', () => {
            canvasDims = setupCanvas();
            draw();
        });

        init();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
