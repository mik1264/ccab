<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Precision Agriculture - Variable Rate Farming</title>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600&family=Nunito:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Nunito', sans-serif; background: linear-gradient(135deg, #FEFAE0 0%, #F4F1DE 50%, #EDE8D5 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 20px; }
        h1 { font-family: 'Lora', serif; color: #606C38; font-size: 2rem; margin-bottom: 8px; }
        .subtitle { color: #8A9A5B; font-size: 1rem; }
        .back-link { position: absolute; top: 20px; left: 20px; text-decoration: none; color: #606C38; font-weight: 600; display: flex; align-items: center; gap: 5px; transition: color 0.3s; }
        .back-link:hover { color: #BC6C25; }
        .main-content { display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        .canvas-container { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        canvas { width: 100%; border-radius: 8px; display: block; }
        .controls { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); height: fit-content; }
        .control-group { margin-bottom: 18px; }
        .control-group label { display: block; color: #606C38; font-weight: 600; margin-bottom: 5px; font-size: 0.9rem; }
        .control-group input[type="range"] { width: 100%; accent-color: #8A9A5B; }
        .control-value { text-align: right; color: #8A9A5B; font-size: 0.85rem; }
        button { width: 100%; padding: 10px; margin-top: 5px; border: none; border-radius: 8px; cursor: pointer; font-family: 'Nunito', sans-serif; font-weight: 600; font-size: 0.9rem; transition: all 0.3s; }
        .btn-primary { background: #8A9A5B; color: white; }
        .btn-primary:hover { background: #606C38; }
        .btn-secondary { background: #DDA15E; color: white; }
        .btn-secondary:hover { background: #BC6C25; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .stat-box { background: linear-gradient(135deg, #FEFAE0, #F4F1DE); padding: 10px; border-radius: 8px; text-align: center; }
        .stat-value { font-family: 'Lora', serif; color: #606C38; font-size: 1.1rem; font-weight: 600; }
        .stat-label { color: #8A9A5B; font-size: 0.75rem; }
        .info-panel { margin-top: 15px; padding: 12px; background: #F4F1DE; border-radius: 8px; font-size: 0.8rem; color: #606C38; }
        select { width: 100%; padding: 8px; border: 1px solid #DDA15E; border-radius: 6px; font-family: 'Nunito', sans-serif; background: white; color: #606C38; }
        .scenario-btn { width: 100%; padding: 8px; margin-top: 5px; font-size: 0.8rem; }
        .roi-indicator { margin-top: 10px; padding: 10px; border-radius: 6px; text-align: center; font-weight: 600; }
        .positive { background: #90EE90; color: #228B22; }
        .negative { background: #FFB6C1; color: #DC143C; }
        .legend { display: flex; justify-content: space-around; font-size: 0.75rem; margin-top: 10px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 4px; margin: 2px; }
        .legend-color { width: 14px; height: 14px; border-radius: 2px; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Gallery</a>
    <div class="container">
        <header>
            <h1>Precision Agriculture</h1>
            <p class="subtitle">Variable-rate farming with spatial yield data and input optimization</p>
        </header>
        <div class="main-content">
            <div class="canvas-container">
                <canvas id="simCanvas"></canvas>
            </div>
            <div class="controls">
                <div class="roi-indicator positive" id="roiIndicator">ROI: +$0/ha</div>
                <div class="control-group">
                    <label>Management Strategy</label>
                    <select id="strategy">
                        <option value="uniform">Uniform Application</option>
                        <option value="variable" selected>Variable Rate (VRT)</option>
                        <option value="zone">Zone Management</option>
                        <option value="sensor">Real-time Sensor</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Map Layer</label>
                    <select id="mapLayer">
                        <option value="yield">Yield Map</option>
                        <option value="soil" selected>Soil Fertility</option>
                        <option value="application">Input Application</option>
                        <option value="profit">Profit Map</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Base N Rate (kg/ha)</label>
                    <input type="range" id="baseN" min="50" max="250" value="150">
                    <div class="control-value"><span id="baseNVal">150</span></div>
                </div>
                <div class="control-group">
                    <label>Input Cost ($/kg N)</label>
                    <input type="range" id="inputCost" min="0.5" max="3" step="0.1" value="1.5">
                    <div class="control-value">$<span id="inputCostVal">1.5</span></div>
                </div>
                <div class="control-group">
                    <label>Grain Price ($/kg)</label>
                    <input type="range" id="grainPrice" min="0.15" max="0.40" step="0.01" value="0.25">
                    <div class="control-value">$<span id="grainPriceVal">0.25</span></div>
                </div>
                <button class="btn-primary" onclick="runSeason()">Run Season</button>
                <button class="btn-secondary" onclick="resetSimulation()">Reset Field</button>
                <div class="stats-grid">
                    <div class="stat-box"><div class="stat-value" id="avgYield">0</div><div class="stat-label">Avg Yield (kg/ha)</div></div>
                    <div class="stat-box"><div class="stat-value" id="totalN">0</div><div class="stat-label">Total N (kg)</div></div>
                    <div class="stat-box"><div class="stat-value" id="revenue">$0</div><div class="stat-label">Revenue</div></div>
                    <div class="stat-box"><div class="stat-value" id="inputCostTotal">$0</div><div class="stat-label">Input Cost</div></div>
                    <div class="stat-box"><div class="stat-value" id="nue">0</div><div class="stat-label">NUE (kg/kg)</div></div>
                    <div class="stat-box"><div class="stat-value" id="profit">$0</div><div class="stat-label">Net Profit</div></div>
                </div>
                <div class="legend">
                    <div class="legend-item"><div class="legend-color" style="background:#FF6347"></div>Low</div>
                    <div class="legend-item"><div class="legend-color" style="background:#FFD700"></div>Med</div>
                    <div class="legend-item"><div class="legend-color" style="background:#228B22"></div>High</div>
                </div>
                <div class="info-panel">
                    <strong>VRT:</strong> Variable Rate Technology adjusts inputs per zone.<br>
                    <strong>NUE:</strong> Nitrogen Use Efficiency (yield per N applied).
                </div>
                <div class="control-group" style="margin-top:15px">
                    <label>Scenarios</label>
                    <button class="scenario-btn btn-secondary" onclick="loadPreset('uniform')">Compare Uniform</button>
                    <button class="scenario-btn btn-secondary" onclick="loadPreset('variable')">Compare VRT</button>
                    <button class="scenario-btn btn-secondary" onclick="loadPreset('expensive')">High Input Costs</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        function setupCanvas() {
            const rect = canvas.parentElement.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            canvas.width = rect.width * dpr;
            canvas.height = (rect.width * 0.65) * dpr;
            canvas.style.height = (rect.width * 0.65) + 'px';
            ctx.scale(dpr, dpr);
            return { width: rect.width, height: rect.width * 0.65 };
        }
        let dims = setupCanvas();
        window.addEventListener('resize', () => { dims = setupCanvas(); draw(); });

        const gridSize = 20;
        let state = { cells: [], harvested: false };

        function initSimulation() {
            state = { cells: [], harvested: false };
            // Generate spatially correlated soil fertility using simple smoothing
            const rawFertility = [];
            for (let i = 0; i < gridSize; i++) {
                rawFertility[i] = [];
                for (let j = 0; j < gridSize; j++) {
                    rawFertility[i][j] = Math.random();
                }
            }
            // Smooth to create zones
            for (let i = 0; i < gridSize; i++) {
                state.cells[i] = [];
                for (let j = 0; j < gridSize; j++) {
                    let sum = 0, count = 0;
                    for (let di = -2; di <= 2; di++) {
                        for (let dj = -2; dj <= 2; dj++) {
                            const ni = i + di, nj = j + dj;
                            if (ni >= 0 && ni < gridSize && nj >= 0 && nj < gridSize) {
                                sum += rawFertility[ni][nj];
                                count++;
                            }
                        }
                    }
                    const baseFertility = sum / count;
                    state.cells[i][j] = {
                        soilFertility: baseFertility,
                        appliedN: 0,
                        yield: 0,
                        profit: 0
                    };
                }
            }
        }

        function runSeason() {
            const strategy = document.getElementById('strategy').value;
            const baseN = parseInt(document.getElementById('baseN').value);
            const inputCost = parseFloat(document.getElementById('inputCost').value);
            const grainPrice = parseFloat(document.getElementById('grainPrice').value);

            let totalYield = 0, totalN = 0, totalProfit = 0;

            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                    const cell = state.cells[i][j];
                    let nRate = baseN;

                    // Determine N rate based on strategy
                    switch (strategy) {
                        case 'uniform':
                            nRate = baseN;
                            break;
                        case 'variable':
                            // Adjust based on soil fertility - less N for high fertility
                            const fertAdjust = (cell.soilFertility - 0.5) * -60;
                            nRate = Math.max(50, Math.min(250, baseN + fertAdjust));
                            break;
                        case 'zone':
                            // 3 zones
                            if (cell.soilFertility > 0.66) nRate = baseN * 0.8;
                            else if (cell.soilFertility > 0.33) nRate = baseN;
                            else nRate = baseN * 1.2;
                            break;
                        case 'sensor':
                            // Real-time adjustment with noise
                            const sensorReading = cell.soilFertility + (Math.random() - 0.5) * 0.1;
                            nRate = baseN * (1.3 - sensorReading * 0.6);
                            break;
                    }

                    cell.appliedN = nRate;
                    totalN += nRate;

                    // Yield response: Mitscherlich diminishing returns curve
                    const maxYield = 12000 * (0.5 + cell.soilFertility * 0.7);
                    const optimalN = 150 * (1.2 - cell.soilFertility * 0.4);
                    const yieldResponse = maxYield * (1 - Math.exp(-nRate / optimalN));
                    cell.yield = yieldResponse * (0.9 + Math.random() * 0.2);
                    totalYield += cell.yield;

                    // Economics
                    const revenue = cell.yield * grainPrice;
                    const cost = nRate * inputCost;
                    cell.profit = revenue - cost;
                    totalProfit += cell.profit;
                }
            }

            state.harvested = true;
            const numCells = gridSize * gridSize;
            const avgYield = totalYield / numCells;
            const revenue = totalYield * grainPrice;
            const inputCostTotal = totalN * inputCost;
            const nue = totalYield / totalN;

            document.getElementById('avgYield').textContent = Math.round(avgYield);
            document.getElementById('totalN').textContent = Math.round(totalN);
            document.getElementById('revenue').textContent = '$' + Math.round(revenue);
            document.getElementById('inputCostTotal').textContent = '$' + Math.round(inputCostTotal);
            document.getElementById('nue').textContent = nue.toFixed(1);
            document.getElementById('profit').textContent = '$' + Math.round(totalProfit);

            const roiPerHa = totalProfit / numCells;
            const indicator = document.getElementById('roiIndicator');
            if (roiPerHa >= 0) {
                indicator.className = 'roi-indicator positive';
                indicator.textContent = `ROI: +$${Math.round(roiPerHa)}/ha`;
            } else {
                indicator.className = 'roi-indicator negative';
                indicator.textContent = `ROI: -$${Math.round(Math.abs(roiPerHa))}/ha`;
            }

            draw();
        }

        function draw() {
            ctx.clearRect(0, 0, dims.width, dims.height);
            const mapLayer = document.getElementById('mapLayer').value;

            const fieldX = 20, fieldY = 50;
            const fieldSize = Math.min(dims.width * 0.55, dims.height - 80);
            const cellSize = fieldSize / gridSize;

            // Draw field grid
            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                    const cell = state.cells[i][j];
                    const x = fieldX + i * cellSize;
                    const y = fieldY + j * cellSize;

                    let value, color;
                    switch (mapLayer) {
                        case 'soil':
                            value = cell.soilFertility;
                            break;
                        case 'yield':
                            value = state.harvested ? cell.yield / 12000 : cell.soilFertility;
                            break;
                        case 'application':
                            value = state.harvested ? (cell.appliedN - 50) / 200 : 0.5;
                            break;
                        case 'profit':
                            const maxProfit = 3000;
                            value = state.harvested ? Math.max(0, Math.min(1, (cell.profit + maxProfit) / (2 * maxProfit))) : 0.5;
                            break;
                    }

                    // Color gradient: red -> yellow -> green
                    if (value < 0.5) {
                        const t = value * 2;
                        color = `rgb(${255 - Math.floor(t * 56)}, ${Math.floor(99 + t * 116)}, ${Math.floor(71 - t * 71)})`;
                    } else {
                        const t = (value - 0.5) * 2;
                        color = `rgb(${199 - Math.floor(t * 165)}, ${215 - Math.floor(t * 72)}, 0)`;
                    }

                    ctx.fillStyle = color;
                    ctx.fillRect(x, y, cellSize - 1, cellSize - 1);
                }
            }

            // Field border
            ctx.strokeStyle = '#8B7355';
            ctx.lineWidth = 2;
            ctx.strokeRect(fieldX, fieldY, fieldSize, fieldSize);

            // Legend
            const legendX = fieldX + fieldSize + 30;
            const legendW = 20, legendH = fieldSize;
            const legendGrad = ctx.createLinearGradient(legendX, fieldY + legendH, legendX, fieldY);
            legendGrad.addColorStop(0, '#FF6347');
            legendGrad.addColorStop(0.5, '#FFD700');
            legendGrad.addColorStop(1, '#228B22');
            ctx.fillStyle = legendGrad;
            ctx.fillRect(legendX, fieldY, legendW, legendH);
            ctx.strokeStyle = '#333';
            ctx.strokeRect(legendX, fieldY, legendW, legendH);

            ctx.fillStyle = '#606C38';
            ctx.font = '10px Nunito';
            ctx.fillText('High', legendX + legendW + 5, fieldY + 10);
            ctx.fillText('Low', legendX + legendW + 5, fieldY + legendH);

            // Statistics visualization on right
            if (state.harvested) {
                const chartX = dims.width * 0.65;
                const chartW = dims.width * 0.3;

                // Histogram of yields
                drawHistogram(chartX, 50, chartW, 80, 'yield', 'Yield Distribution');
                drawHistogram(chartX, 150, chartW, 80, 'appliedN', 'N Application Distribution');
            }

            // Title
            ctx.fillStyle = '#606C38';
            ctx.font = '14px Lora';
            const layerNames = { soil: 'Soil Fertility', yield: 'Yield', application: 'N Applied', profit: 'Profit' };
            ctx.fillText(`${layerNames[mapLayer]} Map | Strategy: ${document.getElementById('strategy').options[document.getElementById('strategy').selectedIndex].text}`, fieldX, 35);
        }

        function drawHistogram(x, y, w, h, field, label) {
            ctx.fillStyle = 'rgba(255,255,255,0.9)';
            ctx.fillRect(x, y, w, h);
            ctx.strokeStyle = '#ddd';
            ctx.strokeRect(x, y, w, h);

            ctx.fillStyle = '#606C38';
            ctx.font = '10px Nunito';
            ctx.fillText(label, x + 5, y - 3);

            // Collect data
            const values = [];
            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                    values.push(state.cells[i][j][field]);
                }
            }

            const numBins = 10;
            const minVal = Math.min(...values);
            const maxVal = Math.max(...values);
            const binWidth = (maxVal - minVal) / numBins || 1;
            const bins = new Array(numBins).fill(0);

            values.forEach(v => {
                const bin = Math.min(numBins - 1, Math.floor((v - minVal) / binWidth));
                bins[bin]++;
            });

            const maxBin = Math.max(...bins, 1);
            const barW = (w - 10) / numBins;

            bins.forEach((count, i) => {
                const barH = (count / maxBin) * (h - 15);
                ctx.fillStyle = '#8A9A5B';
                ctx.fillRect(x + 5 + i * barW, y + h - 5 - barH, barW - 2, barH);
            });
        }

        function resetSimulation() {
            initSimulation();
            document.getElementById('avgYield').textContent = '0';
            document.getElementById('totalN').textContent = '0';
            document.getElementById('revenue').textContent = '$0';
            document.getElementById('inputCostTotal').textContent = '$0';
            document.getElementById('nue').textContent = '0';
            document.getElementById('profit').textContent = '$0';
            document.getElementById('roiIndicator').textContent = 'ROI: +$0/ha';
            document.getElementById('roiIndicator').className = 'roi-indicator positive';
            draw();
        }

        function loadPreset(name) {
            if (name === 'uniform') {
                document.getElementById('strategy').value = 'uniform';
            } else if (name === 'variable') {
                document.getElementById('strategy').value = 'variable';
            } else if (name === 'expensive') {
                document.getElementById('inputCost').value = 2.5;
                document.getElementById('strategy').value = 'variable';
            }
            updateSliderDisplays();
            resetSimulation();
            runSeason();
        }

        function updateSliderDisplays() {
            document.getElementById('baseNVal').textContent = document.getElementById('baseN').value;
            document.getElementById('inputCostVal').textContent = document.getElementById('inputCost').value;
            document.getElementById('grainPriceVal').textContent = document.getElementById('grainPrice').value;
        }

        document.querySelectorAll('input[type="range"]').forEach(s => s.addEventListener('input', updateSliderDisplays));
        document.getElementById('mapLayer').addEventListener('change', draw);

        initSimulation();
        draw();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
