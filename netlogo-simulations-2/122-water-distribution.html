<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Distribution Network</title>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600&family=Nunito:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Nunito', sans-serif; background: linear-gradient(135deg, #FEFAE0 0%, #F4F1DE 50%, #EDE8D5 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 20px; }
        h1 { font-family: 'Lora', serif; color: #606C38; font-size: 2rem; margin-bottom: 8px; }
        .subtitle { color: #8A9A5B; font-size: 1rem; }
        .back-link { position: absolute; top: 20px; left: 20px; text-decoration: none; color: #606C38; font-weight: 600; }
        .main-content { display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        .canvas-container { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        canvas { width: 100%; border-radius: 8px; display: block; }
        .controls { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); height: fit-content; }
        .control-group { margin-bottom: 18px; }
        .control-group label { display: block; color: #606C38; font-weight: 600; margin-bottom: 5px; font-size: 0.9rem; }
        .control-group input[type="range"] { width: 100%; accent-color: #8A9A5B; }
        .control-value { text-align: right; color: #8A9A5B; font-size: 0.85rem; }
        button { width: 100%; padding: 10px; margin-top: 5px; border: none; border-radius: 8px; cursor: pointer; font-family: 'Nunito', sans-serif; font-weight: 600; font-size: 0.9rem; transition: all 0.3s; }
        .btn-primary { background: #8A9A5B; color: white; }
        .btn-secondary { background: #DDA15E; color: white; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .stat-box { background: linear-gradient(135deg, #FEFAE0, #F4F1DE); padding: 10px; border-radius: 8px; text-align: center; }
        .stat-value { font-family: 'Lora', serif; color: #606C38; font-size: 1.1rem; font-weight: 600; }
        .stat-label { color: #8A9A5B; font-size: 0.75rem; }
        .info-panel { margin-top: 15px; padding: 12px; background: #F4F1DE; border-radius: 8px; font-size: 0.8rem; color: #606C38; }
        .system-status { padding: 10px; border-radius: 8px; text-align: center; font-weight: 600; margin-bottom: 15px; }
        .normal { background: #4682B4; color: white; }
        .low-pressure { background: #FFD700; color: #333; }
        .leak-detected { background: #FF6347; color: white; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Gallery</a>
    <div class="container">
        <header>
            <h1>Water Distribution Network</h1>
            <p class="subtitle">Pressure zones, demand patterns, and leak detection</p>
        </header>
        <div class="main-content">
            <div class="canvas-container">
                <canvas id="simCanvas"></canvas>
            </div>
            <div class="controls">
                <div class="system-status normal" id="systemStatus">System: Normal Operation</div>
                <div class="control-group">
                    <label>Time of Day</label>
                    <input type="range" id="timeOfDay" min="0" max="23" value="12">
                    <div class="control-value"><span id="timeOfDayVal">12</span>:00</div>
                </div>
                <div class="control-group">
                    <label>Pump Station 1 (%)</label>
                    <input type="range" id="pump1" min="0" max="100" value="80">
                    <div class="control-value"><span id="pump1Val">80</span>%</div>
                </div>
                <div class="control-group">
                    <label>Pump Station 2 (%)</label>
                    <input type="range" id="pump2" min="0" max="100" value="60">
                    <div class="control-value"><span id="pump2Val">60</span>%</div>
                </div>
                <div class="control-group">
                    <label>Network Age (years)</label>
                    <input type="range" id="networkAge" min="10" max="80" value="30">
                    <div class="control-value"><span id="networkAgeVal">30</span></div>
                </div>
                <button class="btn-primary" onclick="runSimulation()">Run 24h Simulation</button>
                <button class="btn-secondary" onclick="injectLeak()">Simulate Leak</button>
                <button class="btn-secondary" onclick="resetSimulation()">Reset</button>
                <div class="stats-grid">
                    <div class="stat-box"><div class="stat-value" id="totalFlow">0</div><div class="stat-label">Flow (m¬≥/h)</div></div>
                    <div class="stat-box"><div class="stat-value" id="avgPressure">0</div><div class="stat-label">Avg Pressure (bar)</div></div>
                    <div class="stat-box"><div class="stat-value" id="leakLoss">0%</div><div class="stat-label">Leak Loss</div></div>
                    <div class="stat-box"><div class="stat-value" id="energyCost">$0</div><div class="stat-label">Energy Cost</div></div>
                </div>
                <div class="info-panel">
                    <strong>Network:</strong> Pump stations maintain pressure. Older pipes have higher leak rates. Peak demand at morning and evening.
                </div>
            </div>
        </div>
    </div>
    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        function setupCanvas() {
            const rect = canvas.parentElement.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            canvas.width = rect.width * dpr;
            canvas.height = (rect.width * 0.65) * dpr;
            canvas.style.height = (rect.width * 0.65) + 'px';
            ctx.scale(dpr, dpr);
            return { width: rect.width, height: rect.width * 0.65 };
        }
        let dims = setupCanvas();
        window.addEventListener('resize', () => { dims = setupCanvas(); draw(); });

        // Network topology
        const nodes = [
            { id: 0, x: 0.1, y: 0.3, type: 'source', name: 'Reservoir' },
            { id: 1, x: 0.2, y: 0.3, type: 'pump', name: 'Pump 1' },
            { id: 2, x: 0.35, y: 0.2, type: 'junction', elevation: 10 },
            { id: 3, x: 0.35, y: 0.4, type: 'junction', elevation: 5 },
            { id: 4, x: 0.5, y: 0.15, type: 'demand', name: 'Zone A' },
            { id: 5, x: 0.5, y: 0.3, type: 'demand', name: 'Zone B' },
            { id: 6, x: 0.5, y: 0.45, type: 'demand', name: 'Zone C' },
            { id: 7, x: 0.1, y: 0.7, type: 'source', name: 'Well' },
            { id: 8, x: 0.2, y: 0.7, type: 'pump', name: 'Pump 2' },
            { id: 9, x: 0.35, y: 0.7, type: 'junction', elevation: 0 },
            { id: 10, x: 0.5, y: 0.7, type: 'demand', name: 'Zone D' },
            { id: 11, x: 0.65, y: 0.4, type: 'tank', name: 'Storage Tank' }
        ];

        const pipes = [
            { from: 0, to: 1, diameter: 400 },
            { from: 1, to: 2, diameter: 300 },
            { from: 1, to: 3, diameter: 300 },
            { from: 2, to: 4, diameter: 200 },
            { from: 2, to: 5, diameter: 200 },
            { from: 3, to: 5, diameter: 200 },
            { from: 3, to: 6, diameter: 200 },
            { from: 7, to: 8, diameter: 300 },
            { from: 8, to: 9, diameter: 250 },
            { from: 9, to: 10, diameter: 200 },
            { from: 9, to: 6, diameter: 150 },
            { from: 5, to: 11, diameter: 250 },
            { from: 11, to: 6, diameter: 200 }
        ];

        let state = { hour: 12, running: false, leaks: [], flows: [], pressures: [], flowHistory: [], demandHistory: [], leakLoss: 0, energyCost: 0 };

        function getDemandFactor(hour) {
            const pattern = [0.5, 0.4, 0.35, 0.3, 0.35, 0.5, 0.8, 1.0, 0.9, 0.75, 0.7, 0.7, 0.75, 0.7, 0.65, 0.7, 0.8, 0.95, 1.0, 0.9, 0.8, 0.7, 0.6, 0.55];
            return pattern[hour];
        }

        function calculateNetwork() {
            const hour = parseInt(document.getElementById('timeOfDay').value);
            const pump1 = parseInt(document.getElementById('pump1').value) / 100;
            const pump2 = parseInt(document.getElementById('pump2').value) / 100;
            const age = parseInt(document.getElementById('networkAge').value);

            const demandFactor = getDemandFactor(hour);
            const baseDemand = 100; // m¬≥/h per zone

            // Calculate flows and pressures (simplified)
            state.flows = [];
            state.pressures = [];

            nodes.forEach((node, i) => {
                let pressure = 4; // bar base
                if (node.type === 'pump') {
                    const pumpRate = i === 1 ? pump1 : pump2;
                    pressure = 6 * pumpRate;
                } else if (node.type === 'demand') {
                    pressure = 3.5 - demandFactor * 0.5;
                } else if (node.type === 'tank') {
                    pressure = 5;
                }
                state.pressures[i] = pressure;
            });

            let totalFlow = 0;
            let leakFlow = 0;
            pipes.forEach((pipe, i) => {
                const fromPressure = state.pressures[pipe.from];
                const toPressure = state.pressures[pipe.to];
                const flow = Math.max(0, (fromPressure - toPressure) * pipe.diameter / 10);

                // Leak calculation based on age
                const leakRate = (age / 100) * 0.1;
                const leakAmount = flow * leakRate;

                // Check for injected leaks
                const leak = state.leaks.find(l => l.pipeIndex === i);
                const extraLeak = leak ? flow * 0.2 : 0;

                state.flows[i] = { flow: flow - leakAmount - extraLeak, leak: leakAmount + extraLeak };
                totalFlow += flow;
                leakFlow += leakAmount + extraLeak;
            });

            state.leakLoss = totalFlow > 0 ? (leakFlow / totalFlow) * 100 : 0;
            state.energyCost += (pump1 * 50 + pump2 * 40) / 24;

            // Update UI
            document.getElementById('totalFlow').textContent = totalFlow.toFixed(0);
            document.getElementById('avgPressure').textContent = (state.pressures.reduce((a, b) => a + b, 0) / state.pressures.length).toFixed(1);
            document.getElementById('leakLoss').textContent = state.leakLoss.toFixed(1) + '%';
            document.getElementById('energyCost').textContent = '$' + state.energyCost.toFixed(0);

            const status = document.getElementById('systemStatus');
            if (state.leaks.length > 0) {
                status.className = 'system-status leak-detected';
                status.textContent = 'LEAK DETECTED!';
            } else if (state.pressures.some(p => p < 2)) {
                status.className = 'system-status low-pressure';
                status.textContent = 'Low Pressure Warning';
            } else {
                status.className = 'system-status normal';
                status.textContent = 'System: Normal Operation';
            }
        }

        function draw() {
            ctx.clearRect(0, 0, dims.width, dims.height);

            const netW = dims.width * 0.7;
            const netH = dims.height - 60;
            const offsetX = 30;
            const offsetY = 40;

            // Draw pipes
            pipes.forEach((pipe, i) => {
                const from = nodes[pipe.from];
                const to = nodes[pipe.to];
                const x1 = offsetX + from.x * netW;
                const y1 = offsetY + from.y * netH;
                const x2 = offsetX + to.x * netW;
                const y2 = offsetY + to.y * netH;

                const flow = state.flows[i] || { flow: 0, leak: 0 };
                const flowRatio = Math.min(1, flow.flow / 200);

                ctx.strokeStyle = `rgb(${70 + (1 - flowRatio) * 185}, ${130 + flowRatio * 70}, ${180 + flowRatio * 75})`;
                ctx.lineWidth = 3 + pipe.diameter / 100;
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();

                // Leak indicator
                if (flow.leak > 10 || state.leaks.find(l => l.pipeIndex === i)) {
                    const midX = (x1 + x2) / 2;
                    const midY = (y1 + y2) / 2;
                    ctx.fillStyle = '#FF6347';
                    ctx.beginPath();
                    ctx.arc(midX, midY, 8, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = 'white';
                    ctx.font = '10px Nunito';
                    ctx.textAlign = 'center';
                    ctx.fillText('!', midX, midY + 4);
                }
            });
            ctx.lineWidth = 1;

            // Draw nodes
            nodes.forEach((node, i) => {
                const x = offsetX + node.x * netW;
                const y = offsetY + node.y * netH;
                const pressure = state.pressures[i] || 4;

                let color, size, icon;
                switch (node.type) {
                    case 'source':
                        color = '#1E88E5'; size = 20; icon = 'üíß'; break;
                    case 'pump':
                        color = '#43A047'; size = 18; icon = '‚ö°'; break;
                    case 'junction':
                        color = '#757575'; size = 10; icon = ''; break;
                    case 'demand':
                        color = '#FF7043'; size = 16; icon = 'üè†'; break;
                    case 'tank':
                        color = '#5C6BC0'; size = 22; icon = 'üèóÔ∏è'; break;
                }

                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2);
                ctx.fill();

                if (icon) {
                    ctx.font = '14px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(icon, x, y + 5);
                }

                // Pressure indicator
                ctx.fillStyle = pressure < 2 ? '#FF6347' : pressure < 3 ? '#FFD700' : '#4CAF50';
                ctx.font = '9px Nunito';
                ctx.fillText(pressure.toFixed(1) + ' bar', x, y + size + 12);
                if (node.name) {
                    ctx.fillStyle = '#333';
                    ctx.fillText(node.name, x, y - size - 5);
                }
            });
            ctx.textAlign = 'left';

            // Demand chart
            const chartX = dims.width * 0.72;
            const chartW = dims.width * 0.25;
            const chartH = 80;
            const hour = parseInt(document.getElementById('timeOfDay').value);

            ctx.fillStyle = 'rgba(255,255,255,0.9)';
            ctx.fillRect(chartX, 50, chartW, chartH);
            ctx.strokeRect(chartX, 50, chartW, chartH);
            ctx.fillStyle = '#606C38';
            ctx.font = '10px Nunito';
            ctx.fillText('Daily Demand Pattern', chartX + 5, 45);

            ctx.beginPath();
            ctx.strokeStyle = '#4682B4';
            ctx.lineWidth = 2;
            for (let h = 0; h < 24; h++) {
                const px = chartX + (h / 23) * chartW;
                const py = 50 + chartH - getDemandFactor(h) * chartH;
                if (h === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            }
            ctx.stroke();

            // Current hour marker
            const hourX = chartX + (hour / 23) * chartW;
            ctx.strokeStyle = '#FF6347';
            ctx.beginPath();
            ctx.moveTo(hourX, 50);
            ctx.lineTo(hourX, 50 + chartH);
            ctx.stroke();
            ctx.lineWidth = 1;

            // Title
            ctx.fillStyle = '#606C38';
            ctx.font = '14px Lora';
            ctx.fillText(`Water Distribution Network | ${hour}:00`, 30, 25);
        }

        function runSimulation() {
            state.running = true;
            state.energyCost = 0;
            let hour = 0;

            function step() {
                if (hour >= 24) { state.running = false; return; }
                document.getElementById('timeOfDay').value = hour;
                document.getElementById('timeOfDayVal').textContent = hour;
                calculateNetwork();
                draw();
                hour++;
                setTimeout(step, 200);
            }
            step();
        }

        function injectLeak() {
            const pipeIndex = Math.floor(Math.random() * pipes.length);
            state.leaks.push({ pipeIndex, severity: 0.2 });
            calculateNetwork();
            draw();
        }

        function resetSimulation() {
            state = { hour: 12, running: false, leaks: [], flows: [], pressures: [], flowHistory: [], demandHistory: [], leakLoss: 0, energyCost: 0 };
            document.getElementById('timeOfDay').value = 12;
            updateSliderDisplays();
            calculateNetwork();
            draw();
        }

        function updateSliderDisplays() {
            document.getElementById('timeOfDayVal').textContent = document.getElementById('timeOfDay').value;
            document.getElementById('pump1Val').textContent = document.getElementById('pump1').value;
            document.getElementById('pump2Val').textContent = document.getElementById('pump2').value;
            document.getElementById('networkAgeVal').textContent = document.getElementById('networkAge').value;
        }

        document.querySelectorAll('input[type="range"]').forEach(s => s.addEventListener('input', () => { updateSliderDisplays(); calculateNetwork(); draw(); }));
        calculateNetwork();
        draw();
    </script>
</body>
</html>
