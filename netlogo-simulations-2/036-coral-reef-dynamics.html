<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coral Reef Dynamics - Phase Shifts & Alternative Stable States</title>
    <style>
        :root {
            --sage: #8A9A5B;
            --moss: #606C38;
            --earth: #DDA15E;
            --cream: #FEFAE0;
            --terracotta: #BC6C25;
            --dark-moss: #3d4423;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, #f5f5dc 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        h1 {
            color: var(--dark-moss);
            font-size: 1.8rem;
            margin-bottom: 8px;
        }

        .subtitle {
            color: var(--moss);
            font-size: 1rem;
        }

        .back-link {
            position: absolute;
            top: 20px;
            left: 20px;
            color: var(--moss);
            text-decoration: none;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.3s;
        }

        .back-link:hover {
            color: var(--terracotta);
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }

        .control-panel {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            height: fit-content;
        }

        .control-section {
            margin-bottom: 20px;
        }

        .control-section h3 {
            color: var(--dark-moss);
            font-size: 0.95rem;
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 2px solid var(--sage);
        }

        .control-group {
            margin-bottom: 12px;
        }

        .control-group label {
            display: block;
            color: var(--moss);
            font-size: 0.8rem;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .control-group input[type="range"] {
            width: 100%;
            accent-color: var(--sage);
        }

        .control-group select {
            width: 100%;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--dark-moss);
            background: white;
        }

        .value-display {
            text-align: right;
            font-size: 0.75rem;
            color: var(--terracotta);
            font-weight: 600;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 16px;
        }

        button {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
        }

        .btn-primary {
            background: var(--sage);
            color: white;
        }

        .btn-primary:hover {
            background: var(--moss);
        }

        .btn-secondary {
            background: var(--earth);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--terracotta);
        }

        .btn-full {
            grid-column: span 2;
        }

        .btn-event {
            background: var(--terracotta);
            color: white;
            grid-column: span 2;
            margin-top: 8px;
        }

        .btn-event:hover {
            background: #a55a1f;
        }

        .btn-bleaching {
            background: #e74c3c;
        }

        .btn-hurricane {
            background: #9b59b6;
        }

        .visualization-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 16px;
        }

        .viz-panel {
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .viz-panel h4 {
            color: var(--dark-moss);
            font-size: 0.85rem;
            margin-bottom: 10px;
            text-align: center;
        }

        .canvas-container {
            position: relative;
            width: 100%;
            height: 280px;
        }

        canvas {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            background: #1a1a1a;
        }

        .stats-panel {
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-top: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 12px;
        }

        .stat-item {
            text-align: center;
            padding: 12px;
            background: var(--cream);
            border-radius: 10px;
        }

        .stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--terracotta);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--moss);
            margin-top: 4px;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #eee;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.7rem;
            color: var(--dark-moss);
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .info-panel {
            grid-column: span 2;
            background: linear-gradient(135deg, var(--sage) 0%, var(--moss) 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin-top: 12px;
        }

        .info-panel h4 {
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .info-panel p {
            font-size: 0.8rem;
            opacity: 0.95;
            line-height: 1.5;
        }

        .state-indicator {
            text-align: center;
            padding: 12px;
            border-radius: 10px;
            margin-top: 12px;
            font-weight: 700;
        }

        .state-coral {
            background: linear-gradient(135deg, #FF6B6B, #FF8E8E);
            color: white;
        }

        .state-transition {
            background: linear-gradient(135deg, #FFC107, #FFD54F);
            color: #333;
        }

        .state-algae {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            color: white;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back to Simulations</a>

    <div class="container">
        <header>
            <h1>Coral Reef Dynamics</h1>
            <p class="subtitle">Coral-Algae Phase Shifts, Herbivory & Alternative Stable States</p>
        </header>

        <div class="main-content">
            <div class="control-panel">
                <div class="control-section">
                    <h3>Herbivory</h3>
                    <div class="control-group">
                        <label>Fishing Pressure</label>
                        <input type="range" id="fishingPressure" min="0" max="1" step="0.05" value="0.2">
                        <div class="value-display" id="fishingPressureValue">0.20</div>
                    </div>
                    <div class="control-group">
                        <label>Grazer Abundance</label>
                        <input type="range" id="grazerAbundance" min="0" max="1" step="0.05" value="0.5">
                        <div class="value-display" id="grazerAbundanceValue">0.50</div>
                    </div>
                    <div class="control-group">
                        <label>Browser Abundance</label>
                        <input type="range" id="browserAbundance" min="0" max="1" step="0.05" value="0.3">
                        <div class="value-display" id="browserAbundanceValue">0.30</div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Climate Stress</h3>
                    <div class="control-group">
                        <label>Sea Surface Temperature (+°C)</label>
                        <input type="range" id="sst" min="0" max="3" step="0.1" value="0">
                        <div class="value-display" id="sstValue">+0.0°C</div>
                    </div>
                    <div class="control-group">
                        <label>Ocean Acidification</label>
                        <input type="range" id="acidification" min="0" max="1" step="0.1" value="0">
                        <div class="value-display" id="acidificationValue">0.0</div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Reef Parameters</h3>
                    <div class="control-group">
                        <label>Coral Growth Rate</label>
                        <input type="range" id="coralGrowth" min="0.01" max="0.1" step="0.01" value="0.05">
                        <div class="value-display" id="coralGrowthValue">0.05</div>
                    </div>
                    <div class="control-group">
                        <label>Algae Growth Rate</label>
                        <input type="range" id="algaeGrowth" min="0.05" max="0.3" step="0.01" value="0.15">
                        <div class="value-display" id="algaeGrowthValue">0.15</div>
                    </div>
                    <div class="control-group">
                        <label>Coral Recruitment</label>
                        <input type="range" id="coralRecruitment" min="0" max="0.1" step="0.01" value="0.03">
                        <div class="value-display" id="coralRecruitmentValue">0.03</div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Disturbance Events</h3>
                    <button class="btn-event btn-bleaching" id="bleachingBtn">Bleaching Event</button>
                    <button class="btn-event btn-hurricane" id="hurricaneBtn">Hurricane</button>
                </div>

                <div class="button-group">
                    <button class="btn-primary" id="startBtn">Start</button>
                    <button class="btn-secondary" id="pauseBtn">Pause</button>
                    <button class="btn-secondary btn-full" id="resetBtn">Reset Reef</button>
                </div>

                <div class="state-indicator state-coral" id="stateIndicator">
                    Coral-Dominated State
                </div>

                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FF6B6B;"></div>
                        <span>Coral</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #8BC34A;"></div>
                        <span>Turf Algae</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #2E7D32;"></div>
                        <span>Macroalgae</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #F5DEB3;"></div>
                        <span>Sand/Bare</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #fff;"></div>
                        <span>Bleached</span>
                    </div>
                </div>
            </div>

            <div class="visualization-area">
                <div class="viz-panel">
                    <h4>Reef Benthos</h4>
                    <div class="canvas-container">
                        <canvas id="reefCanvas"></canvas>
                    </div>
                </div>

                <div class="viz-panel">
                    <h4>Cover Dynamics Over Time</h4>
                    <div class="canvas-container">
                        <canvas id="dynamicsCanvas"></canvas>
                    </div>
                </div>

                <div class="viz-panel">
                    <h4>Phase Space (Hysteresis)</h4>
                    <div class="canvas-container">
                        <canvas id="phaseCanvas"></canvas>
                    </div>
                </div>

                <div class="viz-panel">
                    <h4>Herbivore Functional Groups</h4>
                    <div class="canvas-container">
                        <canvas id="herbivoreCanvas"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-panel">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="coralCover">0%</div>
                    <div class="stat-label">Coral Cover</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="macroalgaeCover">0%</div>
                    <div class="stat-label">Macroalgae Cover</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="turfCover">0%</div>
                    <div class="stat-label">Turf Algae</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="herbivoreBiomass">0</div>
                    <div class="stat-label">Herbivore Biomass</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="resilience">High</div>
                    <div class="stat-label">Resilience</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="bleachingRisk">Low</div>
                    <div class="stat-label">Bleaching Risk</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="disturbanceCount">0</div>
                    <div class="stat-label">Disturbances</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="yearsSimulated">0</div>
                    <div class="stat-label">Years</div>
                </div>
            </div>
            <div class="info-panel">
                <h4>Alternative Stable States & Hysteresis (Mumby et al. 2007)</h4>
                <p><strong>Coral State:</strong> High coral cover suppresses algae through competition for space.
                <strong>Macroalgae State:</strong> Dense macroalgae inhibit coral recruitment and recovery.
                <strong>Hysteresis:</strong> Once shifted to algae, reef may not recover even if stressors removed - herbivory must exceed original threshold.
                Browser fish are critical for preventing macroalgae from reaching size refuge.</p>
            </div>
        </div>
    </div>

    <script>
        // Canvas setup
        const reefCanvas = document.getElementById('reefCanvas');
        const dynamicsCanvas = document.getElementById('dynamicsCanvas');
        const phaseCanvas = document.getElementById('phaseCanvas');
        const herbivoreCanvas = document.getElementById('herbivoreCanvas');

        const rCtx = reefCanvas.getContext('2d');
        const dCtx = dynamicsCanvas.getContext('2d');
        const pCtx = phaseCanvas.getContext('2d');
        const hCtx = herbivoreCanvas.getContext('2d');

        function resizeCanvas(canvas) {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }

        [reefCanvas, dynamicsCanvas, phaseCanvas, herbivoreCanvas].forEach(resizeCanvas);
        window.addEventListener('resize', () => {
            [reefCanvas, dynamicsCanvas, phaseCanvas, herbivoreCanvas].forEach(resizeCanvas);
        });

        // Cover types
        const COVER_TYPES = {
            coral: { color: '#FF6B6B', bleached: '#FFFFFF' },
            turf: { color: '#8BC34A' },
            macroalgae: { color: '#2E7D32' },
            sand: { color: '#F5DEB3' }
        };

        // Model state
        let grid = [];
        let gridSize = 50;
        let params = {};
        let isRunning = false;
        let tick = 0;
        let history = [];
        let phaseHistory = [];
        let disturbanceCount = 0;
        let herbivores = {
            grazers: 0.5,
            browsers: 0.3,
            generalists: 0.2
        };

        function initGrid() {
            grid = [];
            history = [];
            phaseHistory = [];
            tick = 0;
            disturbanceCount = 0;

            // Start with coral-dominated reef
            for (let x = 0; x < gridSize; x++) {
                grid[x] = [];
                for (let y = 0; y < gridSize; y++) {
                    const rand = Math.random();
                    let cover;
                    if (rand < 0.6) cover = 'coral';
                    else if (rand < 0.75) cover = 'turf';
                    else if (rand < 0.85) cover = 'macroalgae';
                    else cover = 'sand';

                    grid[x][y] = {
                        cover: cover,
                        health: 1,
                        bleached: false,
                        macroalgaeAge: cover === 'macroalgae' ? Math.random() * 10 : 0
                    };
                }
            }

            herbivores = {
                grazers: params.grazerAbundance,
                browsers: params.browserAbundance,
                generalists: 0.2
            };
        }

        function updateParams() {
            params = {
                fishingPressure: parseFloat(document.getElementById('fishingPressure').value),
                grazerAbundance: parseFloat(document.getElementById('grazerAbundance').value),
                browserAbundance: parseFloat(document.getElementById('browserAbundance').value),
                sst: parseFloat(document.getElementById('sst').value),
                acidification: parseFloat(document.getElementById('acidification').value),
                coralGrowth: parseFloat(document.getElementById('coralGrowth').value),
                algaeGrowth: parseFloat(document.getElementById('algaeGrowth').value),
                coralRecruitment: parseFloat(document.getElementById('coralRecruitment').value)
            };
        }

        function calculateCovers() {
            let counts = { coral: 0, turf: 0, macroalgae: 0, sand: 0, bleached: 0 };
            const total = gridSize * gridSize;

            for (let x = 0; x < gridSize; x++) {
                for (let y = 0; y < gridSize; y++) {
                    counts[grid[x][y].cover]++;
                    if (grid[x][y].bleached) counts.bleached++;
                }
            }

            return {
                coral: counts.coral / total,
                turf: counts.turf / total,
                macroalgae: counts.macroalgae / total,
                sand: counts.sand / total,
                bleached: counts.bleached / total
            };
        }

        function getNeighbors(x, y) {
            const neighbors = [];
            const dirs = [[-1,0], [1,0], [0,-1], [0,1], [-1,-1], [1,-1], [-1,1], [1,1]];

            dirs.forEach(([dx, dy]) => {
                const nx = x + dx;
                const ny = y + dy;
                if (nx >= 0 && nx < gridSize && ny >= 0 && ny < gridSize) {
                    neighbors.push(grid[nx][ny]);
                }
            });

            return neighbors;
        }

        function update() {
            tick++;

            // Update herbivore populations based on food availability
            const covers = calculateCovers();
            const totalHerbivory = (herbivores.grazers + herbivores.browsers + herbivores.generalists) *
                                  (1 - params.fishingPressure);

            // Herbivore dynamics
            const turfFood = covers.turf;
            const macroFood = covers.macroalgae;

            herbivores.grazers = Math.max(0.05, Math.min(1,
                herbivores.grazers * (1 + 0.1 * turfFood - 0.05 - params.fishingPressure * 0.2)
            ));
            herbivores.browsers = Math.max(0.05, Math.min(1,
                herbivores.browsers * (1 + 0.1 * macroFood - 0.05 - params.fishingPressure * 0.2)
            ));

            // Bleaching probability based on SST
            const bleachingProb = Math.min(0.3, params.sst * 0.1);

            // Process each cell
            for (let x = 0; x < gridSize; x++) {
                for (let y = 0; y < gridSize; y++) {
                    const cell = grid[x][y];
                    const neighbors = getNeighbors(x, y);

                    // Coral dynamics
                    if (cell.cover === 'coral') {
                        // Bleaching
                        if (!cell.bleached && Math.random() < bleachingProb) {
                            cell.bleached = true;
                            cell.health = 0.5;
                        }

                        // Recovery from bleaching
                        if (cell.bleached) {
                            if (Math.random() < 0.02 && params.sst < 1) {
                                cell.bleached = false;
                                cell.health = Math.min(1, cell.health + 0.1);
                            } else {
                                cell.health -= 0.01;
                                if (cell.health <= 0) {
                                    cell.cover = 'turf'; // Dead coral becomes turf
                                    cell.bleached = false;
                                }
                            }
                        } else {
                            // Coral growth - climate stress reduces growth
                            const growthRate = params.coralGrowth * (1 - params.sst * 0.2) * (1 - params.acidification * 0.3);

                            // Competition with algae
                            const neighborAlgae = neighbors.filter(n => n.cover === 'macroalgae' || n.cover === 'turf').length;
                            const algaeCompetition = neighborAlgae / 8 * 0.3;

                            // Overgrow adjacent turf/sand
                            const growthTargets = neighbors.filter(n => n.cover === 'turf' || n.cover === 'sand');
                            if (growthTargets.length > 0 && Math.random() < growthRate - algaeCompetition) {
                                const target = growthTargets[Math.floor(Math.random() * growthTargets.length)];
                                const targetIdx = neighbors.indexOf(target);
                                // Find actual grid position - approximate
                            }
                        }

                        // Coral mortality from macroalgae overgrowth
                        const macroNeighbors = neighbors.filter(n => n.cover === 'macroalgae' && n.macroalgaeAge > 5).length;
                        if (macroNeighbors > 3 && Math.random() < 0.05) {
                            cell.cover = 'macroalgae';
                            cell.macroalgaeAge = 0;
                        }
                    }

                    // Turf algae dynamics
                    else if (cell.cover === 'turf') {
                        // Grazing by herbivores (grazers eat turf)
                        const grazingPressure = (herbivores.grazers * 0.8 + herbivores.generalists * 0.4) *
                                               (1 - params.fishingPressure);

                        if (Math.random() < grazingPressure * 0.3) {
                            cell.cover = 'sand'; // Grazed clean
                        } else {
                            // Turf can become macroalgae
                            const macroNeighbors = neighbors.filter(n => n.cover === 'macroalgae').length;
                            if (Math.random() < params.algaeGrowth * 0.3 * (1 + macroNeighbors * 0.1)) {
                                cell.cover = 'macroalgae';
                                cell.macroalgaeAge = 0;
                            }
                        }

                        // Coral recruitment on turf
                        const coralNeighbors = neighbors.filter(n => n.cover === 'coral' && !n.bleached).length;
                        if (coralNeighbors > 0 && Math.random() < params.coralRecruitment * coralNeighbors / 8) {
                            cell.cover = 'coral';
                            cell.health = 0.5;
                        }
                    }

                    // Macroalgae dynamics
                    else if (cell.cover === 'macroalgae') {
                        cell.macroalgaeAge += 0.1;

                        // Size refuge from herbivory - older macroalgae harder to eat
                        const sizeRefuge = Math.min(1, cell.macroalgaeAge / 10);
                        const browsingPressure = (herbivores.browsers * (1 - sizeRefuge * 0.7) +
                                                 herbivores.generalists * (1 - sizeRefuge * 0.9)) *
                                                (1 - params.fishingPressure);

                        if (Math.random() < browsingPressure * 0.2) {
                            cell.cover = 'turf';
                            cell.macroalgaeAge = 0;
                        } else {
                            // Macroalgae spread
                            const spreadTargets = neighbors.filter(n => n.cover === 'turf' || n.cover === 'sand');
                            if (spreadTargets.length > 0 && Math.random() < params.algaeGrowth * 0.2) {
                                const target = spreadTargets[Math.floor(Math.random() * spreadTargets.length)];
                                // Would need to track position properly
                            }
                        }
                    }

                    // Sand dynamics
                    else if (cell.cover === 'sand') {
                        // Colonization by turf
                        if (Math.random() < 0.1) {
                            cell.cover = 'turf';
                        }

                        // Coral recruitment
                        const coralNeighbors = neighbors.filter(n => n.cover === 'coral' && !n.bleached).length;
                        if (coralNeighbors > 1 && Math.random() < params.coralRecruitment * 0.5) {
                            cell.cover = 'coral';
                            cell.health = 0.3;
                        }
                    }
                }
            }

            // Spread dynamics (second pass for clarity)
            const spreadUpdates = [];
            for (let x = 0; x < gridSize; x++) {
                for (let y = 0; y < gridSize; y++) {
                    const cell = grid[x][y];
                    const neighbors = getNeighbors(x, y);

                    if (cell.cover === 'coral' && !cell.bleached) {
                        // Coral overgrowth
                        neighbors.forEach(n => {
                            if ((n.cover === 'turf' || n.cover === 'sand') &&
                                Math.random() < params.coralGrowth * 0.3) {
                                spreadUpdates.push({ cell: n, newCover: 'coral' });
                            }
                        });
                    }

                    if (cell.cover === 'macroalgae' && cell.macroalgaeAge > 3) {
                        neighbors.forEach(n => {
                            if (n.cover === 'turf' && Math.random() < params.algaeGrowth * 0.15) {
                                spreadUpdates.push({ cell: n, newCover: 'macroalgae' });
                            }
                        });
                    }
                }
            }

            // Apply spread updates (limited to avoid overwhelming)
            const limitedUpdates = spreadUpdates.slice(0, Math.floor(spreadUpdates.length * 0.3));
            limitedUpdates.forEach(update => {
                update.cell.cover = update.newCover;
                if (update.newCover === 'coral') {
                    update.cell.health = 0.5;
                    update.cell.bleached = false;
                }
                if (update.newCover === 'macroalgae') {
                    update.cell.macroalgaeAge = 0;
                }
            });

            // Record history
            if (tick % 2 === 0) {
                const currentCovers = calculateCovers();
                history.push({
                    tick,
                    ...currentCovers,
                    herbivory: totalHerbivory
                });

                phaseHistory.push({
                    coral: currentCovers.coral,
                    macroalgae: currentCovers.macroalgae,
                    herbivory: totalHerbivory
                });

                if (history.length > 200) {
                    history.shift();
                    phaseHistory.shift();
                }
            }
        }

        function triggerBleaching() {
            disturbanceCount++;
            for (let x = 0; x < gridSize; x++) {
                for (let y = 0; y < gridSize; y++) {
                    if (grid[x][y].cover === 'coral' && Math.random() < 0.7) {
                        grid[x][y].bleached = true;
                        grid[x][y].health *= 0.5;
                    }
                }
            }
        }

        function triggerHurricane() {
            disturbanceCount++;
            // Create damage path
            const startY = Math.floor(Math.random() * gridSize);
            const pathWidth = 10 + Math.floor(Math.random() * 15);

            for (let x = 0; x < gridSize; x++) {
                const centerY = startY + Math.sin(x * 0.1) * 5;
                for (let y = 0; y < gridSize; y++) {
                    if (Math.abs(y - centerY) < pathWidth / 2) {
                        const damage = 1 - Math.abs(y - centerY) / (pathWidth / 2);
                        if (Math.random() < damage * 0.8) {
                            if (grid[x][y].cover === 'coral') {
                                grid[x][y].cover = 'turf';
                                grid[x][y].health = 0;
                            } else if (grid[x][y].cover === 'macroalgae') {
                                grid[x][y].cover = 'turf';
                                grid[x][y].macroalgaeAge = 0;
                            }
                        }
                    }
                }
            }
        }

        function getReefState() {
            const covers = calculateCovers();
            if (covers.coral > 0.4) return 'coral';
            if (covers.macroalgae > 0.3) return 'algae';
            return 'transition';
        }

        function updateStateIndicator() {
            const state = getReefState();
            const indicator = document.getElementById('stateIndicator');

            indicator.className = 'state-indicator';
            if (state === 'coral') {
                indicator.classList.add('state-coral');
                indicator.textContent = 'Coral-Dominated State';
            } else if (state === 'algae') {
                indicator.classList.add('state-algae');
                indicator.textContent = 'Algae-Dominated State';
            } else {
                indicator.classList.add('state-transition');
                indicator.textContent = 'Transition Zone';
            }
        }

        function drawReef() {
            const width = reefCanvas.width;
            const height = reefCanvas.height;
            const cellWidth = width / gridSize;
            const cellHeight = height / gridSize;

            rCtx.fillStyle = '#0a2472'; // Deep blue background
            rCtx.fillRect(0, 0, width, height);

            for (let x = 0; x < gridSize; x++) {
                for (let y = 0; y < gridSize; y++) {
                    const cell = grid[x][y];
                    let color;

                    if (cell.cover === 'coral') {
                        color = cell.bleached ? '#FFFFFF' : COVER_TYPES.coral.color;
                        // Vary coral color slightly
                        if (!cell.bleached) {
                            const hue = 0 + Math.sin(x * 0.5 + y * 0.3) * 10;
                            color = `hsl(${hue}, 70%, ${50 + cell.health * 20}%)`;
                        }
                    } else {
                        color = COVER_TYPES[cell.cover].color;
                    }

                    rCtx.fillStyle = color;
                    rCtx.fillRect(x * cellWidth, y * cellHeight, cellWidth + 0.5, cellHeight + 0.5);

                    // Add some texture
                    if (cell.cover === 'macroalgae') {
                        rCtx.fillStyle = 'rgba(0,50,0,0.3)';
                        if (Math.random() < 0.3) {
                            rCtx.fillRect(x * cellWidth, y * cellHeight, cellWidth * 0.5, cellHeight * 0.5);
                        }
                    }
                }
            }

            // Draw some fish indicators
            const totalHerb = herbivores.grazers + herbivores.browsers + herbivores.generalists;
            for (let i = 0; i < totalHerb * 20; i++) {
                const fx = Math.random() * width;
                const fy = Math.random() * height;
                rCtx.fillStyle = 'rgba(255, 200, 100, 0.6)';
                rCtx.beginPath();
                rCtx.ellipse(fx, fy, 3, 2, Math.random() * Math.PI, 0, Math.PI * 2);
                rCtx.fill();
            }
        }

        function drawDynamics() {
            const width = dynamicsCanvas.width;
            const height = dynamicsCanvas.height;

            dCtx.fillStyle = '#1a1a1a';
            dCtx.fillRect(0, 0, width, height);

            if (history.length < 2) return;

            const margin = { top: 30, right: 80, bottom: 40, left: 50 };
            const plotWidth = width - margin.left - margin.right;
            const plotHeight = height - margin.top - margin.bottom;

            const xScale = plotWidth / Math.max(1, history.length - 1);

            // Draw stacked areas
            const coverTypes = ['coral', 'turf', 'macroalgae', 'sand'];
            const colors = { coral: '#FF6B6B', turf: '#8BC34A', macroalgae: '#2E7D32', sand: '#F5DEB3' };

            coverTypes.forEach((cover, idx) => {
                dCtx.fillStyle = colors[cover];
                dCtx.globalAlpha = 0.8;
                dCtx.beginPath();
                dCtx.moveTo(margin.left, margin.top + plotHeight);

                history.forEach((h, i) => {
                    let cumulative = 0;
                    for (let j = 0; j <= idx; j++) {
                        cumulative += h[coverTypes[j]];
                    }
                    const x = margin.left + i * xScale;
                    const y = margin.top + plotHeight - cumulative * plotHeight;
                    dCtx.lineTo(x, y);
                });

                for (let i = history.length - 1; i >= 0; i--) {
                    let cumulative = 0;
                    for (let j = 0; j < idx; j++) {
                        cumulative += history[i][coverTypes[j]];
                    }
                    const x = margin.left + i * xScale;
                    const y = margin.top + plotHeight - cumulative * plotHeight;
                    dCtx.lineTo(x, y);
                }

                dCtx.closePath();
                dCtx.fill();
            });

            dCtx.globalAlpha = 1;

            // Legend
            coverTypes.forEach((cover, i) => {
                const y = margin.top + 5 + i * 18;
                dCtx.fillStyle = colors[cover];
                dCtx.fillRect(width - 75, y, 12, 12);
                dCtx.fillStyle = '#aaa';
                dCtx.font = '10px sans-serif';
                dCtx.textAlign = 'left';
                dCtx.fillText(cover.charAt(0).toUpperCase() + cover.slice(1), width - 60, y + 10);
            });

            // Axes
            dCtx.strokeStyle = '#666';
            dCtx.lineWidth = 1;
            dCtx.beginPath();
            dCtx.moveTo(margin.left, margin.top);
            dCtx.lineTo(margin.left, margin.top + plotHeight);
            dCtx.lineTo(margin.left + plotWidth, margin.top + plotHeight);
            dCtx.stroke();

            dCtx.fillStyle = '#fff';
            dCtx.font = 'bold 12px sans-serif';
            dCtx.textAlign = 'center';
            dCtx.fillText('Benthic Cover Over Time', width / 2, 18);
        }

        function drawPhase() {
            const width = phaseCanvas.width;
            const height = phaseCanvas.height;

            pCtx.fillStyle = '#1a1a1a';
            pCtx.fillRect(0, 0, width, height);

            const margin = { top: 30, right: 20, bottom: 40, left: 50 };
            const plotWidth = width - margin.left - margin.right;
            const plotHeight = height - margin.top - margin.bottom;

            // Draw phase space trajectory
            if (phaseHistory.length > 1) {
                pCtx.strokeStyle = 'rgba(100, 150, 255, 0.5)';
                pCtx.lineWidth = 1;
                pCtx.beginPath();

                phaseHistory.forEach((p, i) => {
                    const x = margin.left + p.herbivory * plotWidth;
                    const y = margin.top + plotHeight - p.coral * plotHeight;

                    if (i === 0) pCtx.moveTo(x, y);
                    else pCtx.lineTo(x, y);
                });

                pCtx.stroke();

                // Current position
                const current = phaseHistory[phaseHistory.length - 1];
                const cx = margin.left + current.herbivory * plotWidth;
                const cy = margin.top + plotHeight - current.coral * plotHeight;

                pCtx.fillStyle = '#FF6B6B';
                pCtx.beginPath();
                pCtx.arc(cx, cy, 6, 0, Math.PI * 2);
                pCtx.fill();
            }

            // Draw approximate hysteresis curve (theoretical)
            pCtx.strokeStyle = 'rgba(255, 200, 100, 0.5)';
            pCtx.setLineDash([5, 5]);
            pCtx.beginPath();

            // Upper branch (coral state)
            for (let h = 0; h <= 1; h += 0.05) {
                const coral = Math.max(0, 0.7 - h * 0.5 - (h > 0.5 ? (h - 0.5) * 2 : 0));
                const x = margin.left + h * plotWidth;
                const y = margin.top + plotHeight - coral * plotHeight;
                if (h === 0) pCtx.moveTo(x, y);
                else pCtx.lineTo(x, y);
            }
            pCtx.stroke();

            // Lower branch (algae state)
            pCtx.beginPath();
            for (let h = 1; h >= 0; h -= 0.05) {
                const coral = Math.max(0, 0.2 + (h > 0.7 ? (h - 0.7) * 1.5 : 0));
                const x = margin.left + h * plotWidth;
                const y = margin.top + plotHeight - coral * plotHeight;
                if (h === 1) pCtx.moveTo(x, y);
                else pCtx.lineTo(x, y);
            }
            pCtx.stroke();
            pCtx.setLineDash([]);

            // Axes
            pCtx.strokeStyle = '#666';
            pCtx.lineWidth = 1;
            pCtx.beginPath();
            pCtx.moveTo(margin.left, margin.top);
            pCtx.lineTo(margin.left, margin.top + plotHeight);
            pCtx.lineTo(margin.left + plotWidth, margin.top + plotHeight);
            pCtx.stroke();

            // Labels
            pCtx.fillStyle = '#aaa';
            pCtx.font = '10px sans-serif';
            pCtx.textAlign = 'center';
            pCtx.fillText('Herbivory →', margin.left + plotWidth / 2, height - 5);

            pCtx.save();
            pCtx.translate(12, margin.top + plotHeight / 2);
            pCtx.rotate(-Math.PI / 2);
            pCtx.fillText('Coral Cover →', 0, 0);
            pCtx.restore();

            pCtx.fillStyle = '#fff';
            pCtx.font = 'bold 12px sans-serif';
            pCtx.fillText('Phase Space (Hysteresis)', width / 2, 18);
        }

        function drawHerbivore() {
            const width = herbivoreCanvas.width;
            const height = herbivoreCanvas.height;

            hCtx.fillStyle = '#1a1a1a';
            hCtx.fillRect(0, 0, width, height);

            const margin = { top: 30, right: 20, bottom: 50, left: 50 };
            const plotWidth = width - margin.left - margin.right;
            const plotHeight = height - margin.top - margin.bottom;

            const groups = [
                { name: 'Grazers', value: herbivores.grazers, color: '#4CAF50', desc: 'Eat turf' },
                { name: 'Browsers', value: herbivores.browsers, color: '#FF9800', desc: 'Eat macroalgae' },
                { name: 'Generalists', value: herbivores.generalists, color: '#2196F3', desc: 'Both' }
            ];

            const barWidth = plotWidth / groups.length - 20;

            groups.forEach((group, i) => {
                const x = margin.left + i * (barWidth + 20) + 10;
                const barHeight = group.value * plotHeight;
                const y = margin.top + plotHeight - barHeight;

                // Bar
                hCtx.fillStyle = group.color;
                hCtx.fillRect(x, y, barWidth, barHeight);

                // Fishing pressure overlay
                const fishingLoss = params.fishingPressure * barHeight;
                hCtx.fillStyle = 'rgba(255, 0, 0, 0.3)';
                hCtx.fillRect(x, y, barWidth, fishingLoss);

                // Label
                hCtx.fillStyle = '#aaa';
                hCtx.font = '10px sans-serif';
                hCtx.textAlign = 'center';
                hCtx.fillText(group.name, x + barWidth / 2, height - 25);
                hCtx.fillStyle = '#666';
                hCtx.font = '9px sans-serif';
                hCtx.fillText(group.desc, x + barWidth / 2, height - 10);

                // Value
                hCtx.fillStyle = '#fff';
                hCtx.font = '11px sans-serif';
                hCtx.fillText(group.value.toFixed(2), x + barWidth / 2, y - 5);
            });

            // Fishing pressure indicator
            hCtx.fillStyle = '#e74c3c';
            hCtx.font = '10px sans-serif';
            hCtx.textAlign = 'left';
            hCtx.fillText('Fishing: ' + (params.fishingPressure * 100).toFixed(0) + '%', margin.left + 5, margin.top + 15);

            hCtx.fillStyle = '#fff';
            hCtx.font = 'bold 12px sans-serif';
            hCtx.textAlign = 'center';
            hCtx.fillText('Herbivore Functional Groups', width / 2, 18);
        }

        function updateStats() {
            const covers = calculateCovers();
            const totalHerb = (herbivores.grazers + herbivores.browsers + herbivores.generalists) *
                            (1 - params.fishingPressure);

            document.getElementById('coralCover').textContent = (covers.coral * 100).toFixed(1) + '%';
            document.getElementById('macroalgaeCover').textContent = (covers.macroalgae * 100).toFixed(1) + '%';
            document.getElementById('turfCover').textContent = (covers.turf * 100).toFixed(1) + '%';
            document.getElementById('herbivoreBiomass').textContent = totalHerb.toFixed(2);
            document.getElementById('disturbanceCount').textContent = disturbanceCount;
            document.getElementById('yearsSimulated').textContent = Math.floor(tick / 12); // ~12 ticks per year

            // Resilience assessment
            const resilience = covers.coral > 0.3 && totalHerb > 0.5 ? 'High' :
                              covers.coral > 0.2 && totalHerb > 0.3 ? 'Medium' : 'Low';
            document.getElementById('resilience').textContent = resilience;

            // Bleaching risk
            const bleachRisk = params.sst < 1 ? 'Low' : params.sst < 2 ? 'Medium' : 'High';
            document.getElementById('bleachingRisk').textContent = bleachRisk;

            updateStateIndicator();
        }

        function draw() {
            drawReef();
            drawDynamics();
            drawPhase();
            drawHerbivore();
            updateStats();
        }

        function animate() {
            if (!isRunning) return;

            update();
            draw();

            requestAnimationFrame(animate);
        }

        // Event listeners
        document.getElementById('startBtn').addEventListener('click', () => {
            isRunning = true;
            animate();
        });

        document.getElementById('pauseBtn').addEventListener('click', () => {
            isRunning = false;
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            isRunning = false;
            updateParams();
            initGrid();
            draw();
        });

        document.getElementById('bleachingBtn').addEventListener('click', () => {
            triggerBleaching();
            draw();
        });

        document.getElementById('hurricaneBtn').addEventListener('click', () => {
            triggerHurricane();
            draw();
        });

        // Sliders
        const sliders = ['fishingPressure', 'grazerAbundance', 'browserAbundance', 'sst',
                        'acidification', 'coralGrowth', 'algaeGrowth', 'coralRecruitment'];
        sliders.forEach(id => {
            const slider = document.getElementById(id);
            const display = document.getElementById(id + 'Value');

            slider.addEventListener('input', () => {
                let value = parseFloat(slider.value);
                if (id === 'sst') display.textContent = '+' + value.toFixed(1) + '°C';
                else display.textContent = value.toFixed(2);
                updateParams();

                // Update herbivore populations immediately for demonstration
                if (id === 'grazerAbundance') herbivores.grazers = value;
                if (id === 'browserAbundance') herbivores.browsers = value;
            });
        });

        // Initialize
        updateParams();
        initGrid();
        draw();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
