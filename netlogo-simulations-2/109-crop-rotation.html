<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crop Rotation - Agricultural Simulation</title>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600&family=Nunito:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #FEFAE0 0%, #F4F1DE 50%, #EDE8D5 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        header {
            text-align: center;
            margin-bottom: 20px;
        }
        h1 {
            font-family: 'Lora', serif;
            color: #606C38;
            font-size: 2rem;
            margin-bottom: 8px;
        }
        .subtitle {
            color: #8A9A5B;
            font-size: 1rem;
        }
        .back-link {
            position: absolute;
            top: 20px;
            left: 20px;
            text-decoration: none;
            color: #606C38;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color 0.3s;
        }
        .back-link:hover { color: #BC6C25; }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }
        .canvas-container {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        canvas {
            width: 100%;
            border-radius: 8px;
            display: block;
        }
        .controls {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            height: fit-content;
        }
        .control-group {
            margin-bottom: 18px;
        }
        .control-group label {
            display: block;
            color: #606C38;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        .control-group input[type="range"] {
            width: 100%;
            accent-color: #8A9A5B;
        }
        .control-value {
            text-align: right;
            color: #8A9A5B;
            font-size: 0.85rem;
        }
        button {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Nunito', sans-serif;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #8A9A5B;
            color: white;
        }
        .btn-primary:hover { background: #606C38; }
        .btn-secondary {
            background: #DDA15E;
            color: white;
        }
        .btn-secondary:hover { background: #BC6C25; }
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        .stat-box {
            background: linear-gradient(135deg, #FEFAE0, #F4F1DE);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-family: 'Lora', serif;
            color: #606C38;
            font-size: 1.2rem;
            font-weight: 600;
        }
        .stat-label {
            color: #8A9A5B;
            font-size: 0.75rem;
        }
        .info-panel {
            margin-top: 15px;
            padding: 12px;
            background: #F4F1DE;
            border-radius: 8px;
            font-size: 0.8rem;
            color: #606C38;
        }
        .legend {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            margin-top: 10px;
            font-size: 0.75rem;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 3px;
        }
        .scenario-btn {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            font-size: 0.8rem;
        }
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #DDA15E;
            border-radius: 6px;
            font-family: 'Nunito', sans-serif;
            background: white;
            color: #606C38;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back to Gallery</a>

    <div class="container">
        <header>
            <h1>Crop Rotation Simulation</h1>
            <p class="subtitle">Multi-season agricultural modeling with soil nutrient dynamics and pest pressure</p>
        </header>

        <div class="main-content">
            <div class="canvas-container">
                <canvas id="simCanvas"></canvas>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label>Rotation Strategy</label>
                    <select id="rotationStrategy">
                        <option value="monoculture">Monoculture (No Rotation)</option>
                        <option value="two-year">Two-Year Rotation</option>
                        <option value="three-year" selected>Three-Year Rotation</option>
                        <option value="four-year">Four-Year Rotation</option>
                        <option value="cover-crops">With Cover Crops</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Season Duration</label>
                    <input type="range" id="seasonDuration" min="20" max="100" value="60">
                    <div class="control-value"><span id="seasonDurationVal">60</span> ticks</div>
                </div>

                <div class="control-group">
                    <label>Initial Soil Nitrogen</label>
                    <input type="range" id="initialNitrogen" min="20" max="100" value="70">
                    <div class="control-value"><span id="initialNitrogenVal">70</span>%</div>
                </div>

                <div class="control-group">
                    <label>Pest Reproduction Rate</label>
                    <input type="range" id="pestRate" min="0.5" max="3" step="0.1" value="1.5">
                    <div class="control-value"><span id="pestRateVal">1.5</span>x</div>
                </div>

                <div class="control-group">
                    <label>Rainfall Level</label>
                    <input type="range" id="rainfall" min="0.3" max="1.5" step="0.1" value="1">
                    <div class="control-value"><span id="rainfallVal">1.0</span>x</div>
                </div>

                <button class="btn-primary" onclick="startSimulation()">Start Simulation</button>
                <button class="btn-secondary" onclick="resetSimulation()">Reset</button>

                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="totalYield">0</div>
                        <div class="stat-label">Total Yield</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="avgNitrogen">0%</div>
                        <div class="stat-label">Avg Nitrogen</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="pestLevel">0%</div>
                        <div class="stat-label">Pest Pressure</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="yearCount">0</div>
                        <div class="stat-label">Years</div>
                    </div>
                </div>

                <div class="legend">
                    <div class="legend-item"><div class="legend-color" style="background:#FFD700"></div>Corn</div>
                    <div class="legend-item"><div class="legend-color" style="background:#228B22"></div>Soybeans</div>
                    <div class="legend-item"><div class="legend-color" style="background:#DAA520"></div>Wheat</div>
                    <div class="legend-item"><div class="legend-color" style="background:#8FBC8F"></div>Cover Crop</div>
                    <div class="legend-item"><div class="legend-color" style="background:#8B4513"></div>Fallow</div>
                    <div class="legend-item"><div class="legend-color" style="background:#FF6347"></div>Pests</div>
                </div>

                <div class="info-panel">
                    <strong>Model:</strong> DSSAT-inspired crop simulation with nitrogen cycling,
                    pest accumulation, and yield response functions. Legumes (soybeans) fix nitrogen;
                    monoculture increases pest pressure exponentially.
                </div>

                <div class="control-group" style="margin-top:15px">
                    <label>Presets</label>
                    <button class="scenario-btn btn-secondary" onclick="loadPreset('optimal')">Optimal Rotation</button>
                    <button class="scenario-btn btn-secondary" onclick="loadPreset('stressed')">Drought Stress</button>
                    <button class="scenario-btn btn-secondary" onclick="loadPreset('pest-outbreak')">Pest Outbreak</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');

        // High DPI setup
        function setupCanvas() {
            const rect = canvas.parentElement.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            canvas.width = rect.width * dpr;
            canvas.height = (rect.width * 0.7) * dpr;
            canvas.style.height = (rect.width * 0.7) + 'px';
            ctx.scale(dpr, dpr);
            return { width: rect.width, height: rect.width * 0.7 };
        }

        let dims = setupCanvas();
        window.addEventListener('resize', () => {
            dims = setupCanvas();
            draw();
        });

        // Crop definitions
        const crops = {
            corn: {
                name: 'Corn', color: '#FFD700',
                nitrogenDemand: 0.8, nitrogenFix: 0,
                pestVulnerability: { corn: 1.5, default: 0.5 },
                baseYield: 100
            },
            soybeans: {
                name: 'Soybeans', color: '#228B22',
                nitrogenDemand: 0.3, nitrogenFix: 0.4,
                pestVulnerability: { soybeans: 1.5, default: 0.5 },
                baseYield: 60
            },
            wheat: {
                name: 'Wheat', color: '#DAA520',
                nitrogenDemand: 0.5, nitrogenFix: 0,
                pestVulnerability: { wheat: 1.5, default: 0.5 },
                baseYield: 80
            },
            cover: {
                name: 'Cover Crop', color: '#8FBC8F',
                nitrogenDemand: 0.2, nitrogenFix: 0.3,
                pestVulnerability: { default: 0.3 },
                baseYield: 0
            },
            fallow: {
                name: 'Fallow', color: '#8B4513',
                nitrogenDemand: 0, nitrogenFix: 0.1,
                pestVulnerability: { default: 0.1 },
                baseYield: 0
            }
        };

        // Rotation strategies
        const rotations = {
            'monoculture': ['corn'],
            'two-year': ['corn', 'soybeans'],
            'three-year': ['corn', 'soybeans', 'wheat'],
            'four-year': ['corn', 'soybeans', 'wheat', 'fallow'],
            'cover-crops': ['corn', 'cover', 'soybeans', 'cover', 'wheat', 'cover']
        };

        // Grid of fields
        const gridSize = 8;
        let fields = [];
        let pests = [];
        let running = false;
        let tick = 0;
        let year = 0;
        let totalYield = 0;
        let yieldHistory = [];
        let nitrogenHistory = [];
        let pestHistory = [];

        // Simulation parameters
        let params = {
            seasonDuration: 60,
            initialNitrogen: 70,
            pestRate: 1.5,
            rainfall: 1.0,
            rotation: 'three-year'
        };

        // Initialize fields
        function initFields() {
            fields = [];
            const rotation = rotations[params.rotation];
            for (let i = 0; i < gridSize; i++) {
                fields[i] = [];
                for (let j = 0; j < gridSize; j++) {
                    const rotationOffset = (i + j) % rotation.length;
                    fields[i][j] = {
                        nitrogen: params.initialNitrogen,
                        pestPressure: {},
                        currentCrop: rotation[rotationOffset],
                        rotationIndex: rotationOffset,
                        growth: 0,
                        lastYield: 0
                    };
                }
            }
            pests = [];
            tick = 0;
            year = 0;
            totalYield = 0;
            yieldHistory = [];
            nitrogenHistory = [];
            pestHistory = [];
        }

        // Update simulation
        function update() {
            if (!running) return;

            tick++;
            const seasonTick = tick % params.seasonDuration;

            // Start of new season
            if (seasonTick === 0) {
                harvestAndRotate();
                year++;
            }

            // Update each field
            const rotation = rotations[params.rotation];
            let avgNitrogen = 0;
            let avgPest = 0;

            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                    const field = fields[i][j];
                    const crop = crops[field.currentCrop];

                    // Nitrogen dynamics
                    const nitrogenDepletion = crop.nitrogenDemand * 0.01 * params.rainfall;
                    const nitrogenFixation = crop.nitrogenFix * 0.02;
                    field.nitrogen = Math.max(0, Math.min(100,
                        field.nitrogen - nitrogenDepletion + nitrogenFixation + 0.005
                    ));

                    // Pest dynamics
                    if (!field.pestPressure[field.currentCrop]) {
                        field.pestPressure[field.currentCrop] = 0;
                    }

                    const vulnerability = crop.pestVulnerability[field.currentCrop] ||
                                         crop.pestVulnerability.default;
                    const pestGrowth = (params.pestRate * vulnerability * 0.01) - 0.005;
                    field.pestPressure[field.currentCrop] = Math.max(0, Math.min(100,
                        field.pestPressure[field.currentCrop] + pestGrowth
                    ));

                    // Crop growth based on nitrogen and pest pressure
                    if (seasonTick > 0) {
                        const nitrogenFactor = Math.min(1, field.nitrogen / 50);
                        const pestFactor = 1 - (field.pestPressure[field.currentCrop] || 0) / 150;
                        const rainFactor = Math.min(1.2, params.rainfall);
                        field.growth = Math.min(1, field.growth +
                            0.02 * nitrogenFactor * pestFactor * rainFactor);
                    }

                    avgNitrogen += field.nitrogen;
                    const cropPest = field.pestPressure[field.currentCrop] || 0;
                    avgPest += cropPest;
                }
            }

            avgNitrogen /= (gridSize * gridSize);
            avgPest /= (gridSize * gridSize);

            // Track history for charts
            if (seasonTick === params.seasonDuration - 1) {
                nitrogenHistory.push(avgNitrogen);
                pestHistory.push(avgPest);
            }

            // Update pest agents (visual only)
            updatePests();

            // Update stats
            document.getElementById('avgNitrogen').textContent = avgNitrogen.toFixed(0) + '%';
            document.getElementById('pestLevel').textContent = avgPest.toFixed(0) + '%';
            document.getElementById('yearCount').textContent = year;
            document.getElementById('totalYield').textContent = totalYield.toFixed(0);

            draw();
            requestAnimationFrame(update);
        }

        // Harvest and rotate crops
        function harvestAndRotate() {
            const rotation = rotations[params.rotation];
            let seasonYield = 0;

            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                    const field = fields[i][j];
                    const crop = crops[field.currentCrop];

                    // Calculate yield
                    const yieldAmount = crop.baseYield * field.growth;
                    field.lastYield = yieldAmount;
                    seasonYield += yieldAmount;

                    // Rotate to next crop
                    field.rotationIndex = (field.rotationIndex + 1) % rotation.length;
                    const newCrop = rotation[field.rotationIndex];

                    // Pest pressure reduction when changing crops
                    if (newCrop !== field.currentCrop) {
                        for (let cropType in field.pestPressure) {
                            field.pestPressure[cropType] *= 0.3;
                        }
                    }

                    field.currentCrop = newCrop;
                    field.growth = 0;
                }
            }

            totalYield += seasonYield;
            yieldHistory.push(seasonYield);
        }

        // Update pest agents for visualization
        function updatePests() {
            // Remove old pests
            pests = pests.filter(p => p.life > 0);
            pests.forEach(p => p.life--);

            // Add new pests based on field pest pressure
            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                    const field = fields[i][j];
                    const pressure = field.pestPressure[field.currentCrop] || 0;
                    if (Math.random() < pressure / 500) {
                        const cellW = dims.width * 0.55 / gridSize;
                        const cellH = dims.height * 0.7 / gridSize;
                        pests.push({
                            x: 20 + i * cellW + Math.random() * cellW,
                            y: 60 + j * cellH + Math.random() * cellH,
                            life: 60 + Math.random() * 60,
                            vx: (Math.random() - 0.5) * 0.5,
                            vy: (Math.random() - 0.5) * 0.5
                        });
                    }
                }
            }

            // Move pests
            pests.forEach(p => {
                p.x += p.vx;
                p.y += p.vy;
            });
        }

        // Draw simulation
        function draw() {
            ctx.clearRect(0, 0, dims.width, dims.height);

            const gridW = dims.width * 0.55;
            const gridH = dims.height * 0.7;
            const cellW = gridW / gridSize;
            const cellH = gridH / gridSize;
            const startX = 20;
            const startY = 60;

            // Draw fields
            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                    const field = fields[i][j];
                    const crop = crops[field.currentCrop];
                    const x = startX + i * cellW;
                    const y = startY + j * cellH;

                    // Background (soil color based on nitrogen)
                    const nitrogenColor = Math.floor(139 - field.nitrogen * 0.5);
                    ctx.fillStyle = `rgb(${nitrogenColor + 30}, ${nitrogenColor}, ${nitrogenColor - 30})`;
                    ctx.fillRect(x, y, cellW - 2, cellH - 2);

                    // Crop overlay based on growth
                    if (field.growth > 0) {
                        ctx.globalAlpha = field.growth * 0.8;
                        ctx.fillStyle = crop.color;
                        ctx.fillRect(x + 4, y + 4, cellW - 10, cellH - 10);
                        ctx.globalAlpha = 1;
                    }

                    // Crop indicator
                    ctx.fillStyle = crop.color;
                    ctx.beginPath();
                    ctx.arc(x + cellW / 2, y + cellH / 2, 6, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            // Draw pests
            ctx.fillStyle = '#FF6347';
            pests.forEach(p => {
                ctx.globalAlpha = p.life / 120;
                ctx.beginPath();
                ctx.arc(p.x, p.y, 2, 0, Math.PI * 2);
                ctx.fill();
            });
            ctx.globalAlpha = 1;

            // Draw charts on right side
            const chartX = dims.width * 0.6;
            const chartW = dims.width * 0.35;
            const chartH = 80;

            // Yield history chart
            drawChart(chartX, 60, chartW, chartH, yieldHistory, '#228B22', 'Yield per Season');

            // Nitrogen history chart
            drawChart(chartX, 160, chartW, chartH, nitrogenHistory, '#DAA520', 'Avg Nitrogen (%)');

            // Pest history chart
            drawChart(chartX, 260, chartW, chartH, pestHistory, '#FF6347', 'Pest Pressure (%)');

            // Title
            ctx.fillStyle = '#606C38';
            ctx.font = '14px Lora';
            ctx.fillText(`Season ${tick % params.seasonDuration + 1}/${params.seasonDuration} | Year ${year + 1}`, startX, 40);

            // Current rotation indicator
            const rotation = rotations[params.rotation];
            ctx.font = '12px Nunito';
            ctx.fillText('Rotation: ' + rotation.map(c => crops[c].name).join(' → '), startX, dims.height - 20);
        }

        // Draw chart helper
        function drawChart(x, y, w, h, data, color, label) {
            // Background
            ctx.fillStyle = 'rgba(255,255,255,0.7)';
            ctx.fillRect(x, y, w, h);
            ctx.strokeStyle = '#ddd';
            ctx.strokeRect(x, y, w, h);

            // Label
            ctx.fillStyle = '#606C38';
            ctx.font = '11px Nunito';
            ctx.fillText(label, x + 5, y - 5);

            if (data.length < 2) return;

            const maxVal = Math.max(...data, 1);
            const step = w / Math.max(data.length - 1, 1);

            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;

            data.forEach((val, i) => {
                const px = x + i * step;
                const py = y + h - (val / maxVal) * (h - 10) - 5;
                if (i === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            });
            ctx.stroke();
            ctx.lineWidth = 1;
        }

        // Control handlers
        function startSimulation() {
            if (!running) {
                running = true;
                update();
            }
        }

        function resetSimulation() {
            running = false;
            updateParams();
            initFields();
            draw();
        }

        function updateParams() {
            params.seasonDuration = parseInt(document.getElementById('seasonDuration').value);
            params.initialNitrogen = parseInt(document.getElementById('initialNitrogen').value);
            params.pestRate = parseFloat(document.getElementById('pestRate').value);
            params.rainfall = parseFloat(document.getElementById('rainfall').value);
            params.rotation = document.getElementById('rotationStrategy').value;
        }

        function loadPreset(name) {
            if (name === 'optimal') {
                document.getElementById('rotationStrategy').value = 'cover-crops';
                document.getElementById('seasonDuration').value = 60;
                document.getElementById('initialNitrogen').value = 80;
                document.getElementById('pestRate').value = 1.0;
                document.getElementById('rainfall').value = 1.0;
            } else if (name === 'stressed') {
                document.getElementById('rotationStrategy').value = 'three-year';
                document.getElementById('seasonDuration').value = 80;
                document.getElementById('initialNitrogen').value = 50;
                document.getElementById('pestRate').value = 1.5;
                document.getElementById('rainfall').value = 0.4;
            } else if (name === 'pest-outbreak') {
                document.getElementById('rotationStrategy').value = 'monoculture';
                document.getElementById('seasonDuration').value = 50;
                document.getElementById('initialNitrogen').value = 70;
                document.getElementById('pestRate').value = 2.5;
                document.getElementById('rainfall').value = 1.2;
            }
            updateSliderDisplays();
            resetSimulation();
        }

        function updateSliderDisplays() {
            document.getElementById('seasonDurationVal').textContent = document.getElementById('seasonDuration').value;
            document.getElementById('initialNitrogenVal').textContent = document.getElementById('initialNitrogen').value;
            document.getElementById('pestRateVal').textContent = document.getElementById('pestRate').value;
            document.getElementById('rainfallVal').textContent = document.getElementById('rainfall').value;
        }

        // Event listeners for sliders
        document.querySelectorAll('input[type="range"]').forEach(slider => {
            slider.addEventListener('input', updateSliderDisplays);
        });

        document.getElementById('rotationStrategy').addEventListener('change', () => {
            if (!running) {
                updateParams();
                initFields();
                draw();
            }
        });

        // Initialize
        initFields();
        draw();
    </script>
</body>
</html>
