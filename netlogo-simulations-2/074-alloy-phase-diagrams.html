<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binary Alloy Phase Diagrams - NetLogo-Style Simulation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            padding: 20px;
            color: #e0e0e0;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #f39c12, #e74c3c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: #aaa;
            font-size: 1.1em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 320px 1fr 320px;
            gap: 20px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .panel h3 {
            color: #f39c12;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(243, 156, 18, 0.3);
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
            font-size: 0.9em;
        }

        .control-group input[type="range"] {
            width: 100%;
            margin-bottom: 5px;
        }

        .control-group select {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .control-group .value {
            text-align: right;
            font-size: 0.85em;
            color: #f39c12;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            min-width: 80px;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f39c12, #e74c3c);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #c0392b, #e74c3c);
            color: white;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .canvas-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .canvas-wrapper {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
        }

        .canvas-wrapper h4 {
            text-align: center;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            color: #f39c12;
            font-size: 0.95em;
        }

        canvas {
            display: block;
            width: 100%;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-box .value {
            font-size: 1.4em;
            font-weight: bold;
            color: #f39c12;
        }

        .stat-box .label {
            font-size: 0.75em;
            color: #aaa;
            margin-top: 3px;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8em;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }

        .info-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.85em;
            line-height: 1.4;
        }

        .phase-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .phase-bar {
            flex: 1;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
        }

        .phase-segment {
            height: 100%;
            transition: width 0.3s ease;
        }

        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #f39c12;
            text-decoration: none;
            font-size: 1.1em;
            z-index: 1000;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        @media (max-width: 1400px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .canvas-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back to Gallery</a>

    <div class="container">
        <header>
            <h1>Binary Alloy Phase Diagrams</h1>
            <p class="subtitle">Phase Separation, Eutectic Points, and Microstructure Formation</p>
        </header>

        <div class="main-content">
            <div class="panel">
                <h3>Alloy Parameters</h3>

                <div class="control-group">
                    <label>Alloy System</label>
                    <select id="alloySystem">
                        <option value="pbsn">Pb-Sn (Lead-Tin)</option>
                        <option value="cual">Cu-Al (Copper-Aluminum)</option>
                        <option value="fec">Fe-C (Iron-Carbon)</option>
                        <option value="agcu">Ag-Cu (Silver-Copper)</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Composition (wt% B)</label>
                    <input type="range" id="composition" min="0" max="100" value="38">
                    <div class="value"><span id="compositionVal">38</span>%</div>
                </div>

                <div class="control-group">
                    <label>Initial Temperature (°C)</label>
                    <input type="range" id="temperature" min="20" max="400" value="350">
                    <div class="value"><span id="temperatureVal">350</span>°C</div>
                </div>

                <div class="control-group">
                    <label>Cooling Rate (°C/s)</label>
                    <input type="range" id="coolingRate" min="0.1" max="20" step="0.1" value="5">
                    <div class="value"><span id="coolingRateVal">5</span>°C/s</div>
                </div>

                <div class="control-group">
                    <label>Target Temperature (°C)</label>
                    <input type="range" id="targetTemp" min="20" max="300" value="25">
                    <div class="value"><span id="targetTempVal">25</span>°C</div>
                </div>

                <h3>Simulation Control</h3>

                <div class="button-group">
                    <button class="btn-primary" id="startBtn">Start Cooling</button>
                    <button class="btn-secondary" id="pauseBtn">Pause</button>
                </div>

                <div class="button-group">
                    <button class="btn-secondary" id="resetBtn">Reset</button>
                    <button class="btn-danger" id="quenchBtn">Quench</button>
                </div>

                <div class="control-group">
                    <label>Simulation Speed</label>
                    <input type="range" id="simSpeed" min="0.5" max="5" step="0.5" value="1">
                    <div class="value"><span id="simSpeedVal">1</span>x</div>
                </div>

                <div class="info-box">
                    <strong>Lever Rule:</strong><br>
                    The fraction of each phase is calculated using tie lines:
                    W<sub>α</sub> = (C<sub>β</sub> - C<sub>0</sub>) / (C<sub>β</sub> - C<sub>α</sub>)
                </div>
            </div>

            <div class="panel">
                <div class="canvas-container">
                    <div class="canvas-wrapper">
                        <h4>Phase Diagram</h4>
                        <canvas id="phaseDiagramCanvas" width="400" height="350"></canvas>
                    </div>
                    <div class="canvas-wrapper">
                        <h4>Microstructure</h4>
                        <canvas id="microstructureCanvas" width="400" height="350"></canvas>
                    </div>
                    <div class="canvas-wrapper">
                        <h4>Temperature vs Time</h4>
                        <canvas id="temperatureCanvas" width="400" height="250"></canvas>
                    </div>
                    <div class="canvas-wrapper">
                        <h4>Phase Fraction vs Temperature</h4>
                        <canvas id="phaseFractionCanvas" width="400" height="250"></canvas>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h3>Current State</h3>

                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="value" id="currentTemp">350</div>
                        <div class="label">Temperature (°C)</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="currentPhase">L</div>
                        <div class="label">Phase Region</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="liquidFraction">100</div>
                        <div class="label">Liquid (%)</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="solidFraction">0</div>
                        <div class="label">Solid (%)</div>
                    </div>
                </div>

                <h3>Phase Composition</h3>
                <div class="phase-indicator">
                    <span style="color: #3498db;">α</span>
                    <div class="phase-bar">
                        <div class="phase-segment" id="alphaBar" style="background: #3498db; width: 0%"></div>
                        <div class="phase-segment" id="liquidBar" style="background: #f39c12; width: 100%"></div>
                        <div class="phase-segment" id="betaBar" style="background: #e74c3c; width: 0%"></div>
                    </div>
                    <span style="color: #e74c3c;">β</span>
                </div>

                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="value" id="alphaComp">-</div>
                        <div class="label">α Composition</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="betaComp">-</div>
                        <div class="label">β Composition</div>
                    </div>
                </div>

                <h3>Microstructure Analysis</h3>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="value" id="grainSize">-</div>
                        <div class="label">Avg Grain Size (μm)</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="lamellarSpacing">-</div>
                        <div class="label">Lamellar Spacing</div>
                    </div>
                </div>

                <h3>Legend</h3>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f39c12;"></div>
                        <span>Liquid (L)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #3498db;"></div>
                        <span>α Phase</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #e74c3c;"></div>
                        <span>β Phase</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: linear-gradient(90deg, #3498db, #e74c3c);"></div>
                        <span>Eutectic</span>
                    </div>
                </div>

                <div class="info-box" id="phaseInfo">
                    <strong>Phase Info:</strong><br>
                    Above liquidus: Completely liquid alloy
                </div>
            </div>
        </div>
    </div>

    <script>
        // Canvas setup
        const phaseDiagramCanvas = document.getElementById('phaseDiagramCanvas');
        const microstructureCanvas = document.getElementById('microstructureCanvas');
        const temperatureCanvas = document.getElementById('temperatureCanvas');
        const phaseFractionCanvas = document.getElementById('phaseFractionCanvas');

        const pdCtx = phaseDiagramCanvas.getContext('2d');
        const msCtx = microstructureCanvas.getContext('2d');
        const tempCtx = temperatureCanvas.getContext('2d');
        const pfCtx = phaseFractionCanvas.getContext('2d');

        // Alloy system definitions
        const alloySystems = {
            pbsn: {
                name: 'Pb-Sn',
                componentA: 'Pb',
                componentB: 'Sn',
                meltA: 327,      // Melting point of pure Pb
                meltB: 232,      // Melting point of pure Sn
                eutectic: { temp: 183, comp: 61.9 },
                maxSolubilityA: 2.5,   // Max solubility of Sn in Pb at eutectic
                maxSolubilityB: 97.5,  // Max solubility of Pb in Sn at eutectic
                roomSolubilityA: 0.5,
                roomSolubilityB: 99
            },
            cual: {
                name: 'Cu-Al',
                componentA: 'Cu',
                componentB: 'Al',
                meltA: 1085,
                meltB: 660,
                eutectic: { temp: 548, comp: 33 },
                maxSolubilityA: 9.4,
                maxSolubilityB: 95,
                roomSolubilityA: 0.1,
                roomSolubilityB: 98
            },
            fec: {
                name: 'Fe-C',
                componentA: 'Fe',
                componentB: 'C',
                meltA: 1538,
                meltB: 1538,  // Graphite doesn't really melt, simplified
                eutectic: { temp: 1147, comp: 4.3 },
                maxSolubilityA: 2.14,
                maxSolubilityB: 6.67,
                roomSolubilityA: 0.02,
                roomSolubilityB: 6.67
            },
            agcu: {
                name: 'Ag-Cu',
                componentA: 'Ag',
                componentB: 'Cu',
                meltA: 962,
                meltB: 1085,
                eutectic: { temp: 779, comp: 28.1 },
                maxSolubilityA: 8.8,
                maxSolubilityB: 92,
                roomSolubilityA: 0.5,
                roomSolubilityB: 99.5
            }
        };

        // Simulation state
        let currentSystem = alloySystems.pbsn;
        let composition = 38;
        let temperature = 350;
        let targetTemperature = 25;
        let coolingRate = 5;
        let simSpeed = 1;
        let isRunning = false;
        let isPaused = false;
        let temperatureHistory = [];
        let phaseFractionHistory = [];
        let grains = [];
        let time = 0;

        // UI Elements
        const elements = {
            alloySystem: document.getElementById('alloySystem'),
            composition: document.getElementById('composition'),
            compositionVal: document.getElementById('compositionVal'),
            temperature: document.getElementById('temperature'),
            temperatureVal: document.getElementById('temperatureVal'),
            coolingRate: document.getElementById('coolingRate'),
            coolingRateVal: document.getElementById('coolingRateVal'),
            targetTemp: document.getElementById('targetTemp'),
            targetTempVal: document.getElementById('targetTempVal'),
            simSpeed: document.getElementById('simSpeed'),
            simSpeedVal: document.getElementById('simSpeedVal'),
            startBtn: document.getElementById('startBtn'),
            pauseBtn: document.getElementById('pauseBtn'),
            resetBtn: document.getElementById('resetBtn'),
            quenchBtn: document.getElementById('quenchBtn'),
            currentTemp: document.getElementById('currentTemp'),
            currentPhase: document.getElementById('currentPhase'),
            liquidFraction: document.getElementById('liquidFraction'),
            solidFraction: document.getElementById('solidFraction'),
            alphaBar: document.getElementById('alphaBar'),
            liquidBar: document.getElementById('liquidBar'),
            betaBar: document.getElementById('betaBar'),
            alphaComp: document.getElementById('alphaComp'),
            betaComp: document.getElementById('betaComp'),
            grainSize: document.getElementById('grainSize'),
            lamellarSpacing: document.getElementById('lamellarSpacing'),
            phaseInfo: document.getElementById('phaseInfo')
        };

        // Get liquidus temperature for composition
        function getLiquidusTemp(comp) {
            const sys = currentSystem;
            const e = sys.eutectic;

            if (comp <= e.comp) {
                // Left of eutectic - interpolate from A melting point
                return sys.meltA + (e.temp - sys.meltA) * (comp / e.comp);
            } else {
                // Right of eutectic - interpolate from B melting point
                return sys.meltB + (e.temp - sys.meltB) * ((100 - comp) / (100 - e.comp));
            }
        }

        // Get solidus temperature (simplified - constant at eutectic for binary eutectic)
        function getSolidusTemp(comp) {
            const sys = currentSystem;
            const e = sys.eutectic;

            // Solvus lines
            if (comp <= sys.maxSolubilityA) {
                // Pure alpha region
                return sys.meltA - (sys.meltA - 20) * (comp / sys.maxSolubilityA);
            } else if (comp >= sys.maxSolubilityB) {
                // Pure beta region
                return sys.meltB - (sys.meltB - 20) * ((100 - comp) / (100 - sys.maxSolubilityB));
            }

            // In between - eutectic
            return e.temp;
        }

        // Get solvus composition at temperature
        function getSolvusAlpha(temp) {
            const sys = currentSystem;
            const e = sys.eutectic;
            if (temp >= e.temp) return sys.maxSolubilityA;
            const t = (temp - 20) / (e.temp - 20);
            return sys.roomSolubilityA + (sys.maxSolubilityA - sys.roomSolubilityA) * t;
        }

        function getSolvusBeta(temp) {
            const sys = currentSystem;
            const e = sys.eutectic;
            if (temp >= e.temp) return sys.maxSolubilityB;
            const t = (temp - 20) / (e.temp - 20);
            return sys.roomSolubilityB + (sys.maxSolubilityB - sys.roomSolubilityB) * (1 - t);
        }

        // Calculate phase fractions using lever rule
        function calculatePhaseFractions() {
            const sys = currentSystem;
            const e = sys.eutectic;
            const liquidusT = getLiquidusTemp(composition);
            const solidusT = getSolidusTemp(composition);

            let phases = { liquid: 0, alpha: 0, beta: 0, region: '' };

            if (temperature >= liquidusT) {
                // All liquid
                phases.liquid = 1;
                phases.region = 'L';
            } else if (temperature >= e.temp && temperature < liquidusT) {
                // Liquid + one solid phase (mushy zone)
                const liquidComp = composition <= e.comp
                    ? composition + (e.comp - composition) * (liquidusT - temperature) / (liquidusT - e.temp)
                    : composition - (composition - e.comp) * (liquidusT - temperature) / (liquidusT - e.temp);

                if (composition <= e.comp) {
                    // Liquid + alpha
                    const alphaComp = getSolvusAlpha(temperature);
                    phases.liquid = (composition - alphaComp) / (liquidComp - alphaComp);
                    phases.alpha = 1 - phases.liquid;
                    phases.region = 'L + α';
                } else {
                    // Liquid + beta
                    const betaComp = getSolvusBeta(temperature);
                    phases.liquid = (betaComp - composition) / (betaComp - liquidComp);
                    phases.beta = 1 - phases.liquid;
                    phases.region = 'L + β';
                }
            } else if (temperature < e.temp) {
                // Below eutectic - solid phases only
                const alphaComp = getSolvusAlpha(temperature);
                const betaComp = getSolvusBeta(temperature);

                if (composition <= alphaComp) {
                    phases.alpha = 1;
                    phases.region = 'α';
                } else if (composition >= betaComp) {
                    phases.beta = 1;
                    phases.region = 'β';
                } else {
                    // Two-phase region
                    phases.alpha = (betaComp - composition) / (betaComp - alphaComp);
                    phases.beta = 1 - phases.alpha;
                    phases.region = 'α + β';
                }
            }

            // Clamp values
            phases.liquid = Math.max(0, Math.min(1, phases.liquid));
            phases.alpha = Math.max(0, Math.min(1, phases.alpha));
            phases.beta = Math.max(0, Math.min(1, phases.beta));

            return phases;
        }

        // Draw phase diagram
        function drawPhaseDiagram() {
            const width = phaseDiagramCanvas.width;
            const height = phaseDiagramCanvas.height;
            const margin = { top: 30, right: 30, bottom: 40, left: 50 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;

            pdCtx.clearRect(0, 0, width, height);

            // Background
            pdCtx.fillStyle = '#1a1a2e';
            pdCtx.fillRect(0, 0, width, height);

            const sys = currentSystem;
            const maxTemp = Math.max(sys.meltA, sys.meltB) + 50;
            const minTemp = 0;

            function toX(comp) {
                return margin.left + (comp / 100) * chartWidth;
            }

            function toY(temp) {
                return margin.top + (1 - (temp - minTemp) / (maxTemp - minTemp)) * chartHeight;
            }

            // Draw phase regions with colors
            // Liquid region
            pdCtx.fillStyle = 'rgba(243, 156, 18, 0.3)';
            pdCtx.beginPath();
            pdCtx.moveTo(toX(0), toY(maxTemp));
            pdCtx.lineTo(toX(100), toY(maxTemp));
            pdCtx.lineTo(toX(100), toY(sys.meltB));
            for (let c = 100; c >= sys.eutectic.comp; c -= 1) {
                pdCtx.lineTo(toX(c), toY(getLiquidusTemp(c)));
            }
            pdCtx.lineTo(toX(sys.eutectic.comp), toY(sys.eutectic.temp));
            for (let c = sys.eutectic.comp; c >= 0; c -= 1) {
                pdCtx.lineTo(toX(c), toY(getLiquidusTemp(c)));
            }
            pdCtx.lineTo(toX(0), toY(sys.meltA));
            pdCtx.closePath();
            pdCtx.fill();

            // Alpha region
            pdCtx.fillStyle = 'rgba(52, 152, 219, 0.3)';
            pdCtx.beginPath();
            pdCtx.moveTo(toX(0), toY(sys.meltA));
            pdCtx.lineTo(toX(0), toY(minTemp));
            pdCtx.lineTo(toX(sys.roomSolubilityA), toY(minTemp));
            pdCtx.lineTo(toX(sys.maxSolubilityA), toY(sys.eutectic.temp));
            for (let c = sys.maxSolubilityA; c >= 0; c -= 1) {
                pdCtx.lineTo(toX(c), toY(getLiquidusTemp(c)));
            }
            pdCtx.closePath();
            pdCtx.fill();

            // Beta region
            pdCtx.fillStyle = 'rgba(231, 76, 60, 0.3)';
            pdCtx.beginPath();
            pdCtx.moveTo(toX(100), toY(sys.meltB));
            pdCtx.lineTo(toX(100), toY(minTemp));
            pdCtx.lineTo(toX(sys.roomSolubilityB), toY(minTemp));
            pdCtx.lineTo(toX(sys.maxSolubilityB), toY(sys.eutectic.temp));
            for (let c = sys.maxSolubilityB; c <= 100; c += 1) {
                pdCtx.lineTo(toX(c), toY(getLiquidusTemp(c)));
            }
            pdCtx.closePath();
            pdCtx.fill();

            // Draw liquidus line
            pdCtx.strokeStyle = '#f39c12';
            pdCtx.lineWidth = 2;
            pdCtx.beginPath();
            pdCtx.moveTo(toX(0), toY(sys.meltA));
            for (let c = 0; c <= 100; c += 1) {
                pdCtx.lineTo(toX(c), toY(getLiquidusTemp(c)));
            }
            pdCtx.stroke();

            // Draw solidus/eutectic line
            pdCtx.strokeStyle = '#9b59b6';
            pdCtx.lineWidth = 2;
            pdCtx.beginPath();
            pdCtx.moveTo(toX(sys.maxSolubilityA), toY(sys.eutectic.temp));
            pdCtx.lineTo(toX(sys.maxSolubilityB), toY(sys.eutectic.temp));
            pdCtx.stroke();

            // Draw solvus lines
            pdCtx.strokeStyle = '#3498db';
            pdCtx.lineWidth = 2;
            pdCtx.beginPath();
            pdCtx.moveTo(toX(sys.maxSolubilityA), toY(sys.eutectic.temp));
            pdCtx.lineTo(toX(sys.roomSolubilityA), toY(minTemp));
            pdCtx.stroke();

            pdCtx.strokeStyle = '#e74c3c';
            pdCtx.beginPath();
            pdCtx.moveTo(toX(sys.maxSolubilityB), toY(sys.eutectic.temp));
            pdCtx.lineTo(toX(sys.roomSolubilityB), toY(minTemp));
            pdCtx.stroke();

            // Draw axes
            pdCtx.strokeStyle = '#666';
            pdCtx.lineWidth = 1;
            pdCtx.beginPath();
            pdCtx.moveTo(margin.left, margin.top);
            pdCtx.lineTo(margin.left, height - margin.bottom);
            pdCtx.lineTo(width - margin.right, height - margin.bottom);
            pdCtx.stroke();

            // Axis labels
            pdCtx.fillStyle = '#aaa';
            pdCtx.font = '11px sans-serif';
            pdCtx.textAlign = 'center';
            pdCtx.fillText(`wt% ${sys.componentB}`, width / 2, height - 5);

            pdCtx.save();
            pdCtx.translate(12, height / 2);
            pdCtx.rotate(-Math.PI / 2);
            pdCtx.fillText('Temperature (°C)', 0, 0);
            pdCtx.restore();

            // Tick marks
            for (let c = 0; c <= 100; c += 20) {
                pdCtx.fillText(c.toString(), toX(c), height - margin.bottom + 15);
            }

            for (let t = 0; t <= maxTemp; t += 100) {
                pdCtx.textAlign = 'right';
                pdCtx.fillText(t.toString(), margin.left - 5, toY(t) + 4);
            }

            // Current point
            const currentX = toX(composition);
            const currentY = toY(temperature);

            // Tie line if in two-phase region
            const phases = calculatePhaseFractions();
            if (phases.region.includes('+')) {
                pdCtx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                pdCtx.setLineDash([5, 5]);
                pdCtx.beginPath();

                if (phases.region === 'L + α') {
                    const alphaComp = getSolvusAlpha(temperature);
                    pdCtx.moveTo(toX(alphaComp), currentY);
                    pdCtx.lineTo(toX(composition + (100 - composition) * 0.5), currentY);
                } else if (phases.region === 'L + β') {
                    const betaComp = getSolvusBeta(temperature);
                    pdCtx.moveTo(toX(composition - composition * 0.5), currentY);
                    pdCtx.lineTo(toX(betaComp), currentY);
                } else if (phases.region === 'α + β') {
                    const alphaComp = getSolvusAlpha(temperature);
                    const betaComp = getSolvusBeta(temperature);
                    pdCtx.moveTo(toX(alphaComp), currentY);
                    pdCtx.lineTo(toX(betaComp), currentY);
                }
                pdCtx.stroke();
                pdCtx.setLineDash([]);
            }

            // Draw current composition line (vertical)
            pdCtx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            pdCtx.setLineDash([3, 3]);
            pdCtx.beginPath();
            pdCtx.moveTo(currentX, margin.top);
            pdCtx.lineTo(currentX, height - margin.bottom);
            pdCtx.stroke();
            pdCtx.setLineDash([]);

            // Current point marker
            pdCtx.fillStyle = '#fff';
            pdCtx.beginPath();
            pdCtx.arc(currentX, currentY, 6, 0, Math.PI * 2);
            pdCtx.fill();
            pdCtx.strokeStyle = '#f39c12';
            pdCtx.lineWidth = 2;
            pdCtx.stroke();

            // Phase labels
            pdCtx.fillStyle = '#f39c12';
            pdCtx.font = 'bold 14px sans-serif';
            pdCtx.textAlign = 'center';
            pdCtx.fillText('L', toX(50), toY((maxTemp + sys.eutectic.temp) / 2));

            pdCtx.fillStyle = '#3498db';
            pdCtx.fillText('α', toX(sys.maxSolubilityA / 2), toY(sys.eutectic.temp / 2));

            pdCtx.fillStyle = '#e74c3c';
            pdCtx.fillText('β', toX((sys.maxSolubilityB + 100) / 2), toY(sys.eutectic.temp / 2));

            pdCtx.fillStyle = '#9b59b6';
            pdCtx.font = '11px sans-serif';
            pdCtx.fillText('α + β', toX(50), toY(sys.eutectic.temp / 2));

            // Eutectic point marker
            pdCtx.fillStyle = '#9b59b6';
            pdCtx.beginPath();
            pdCtx.arc(toX(sys.eutectic.comp), toY(sys.eutectic.temp), 4, 0, Math.PI * 2);
            pdCtx.fill();
        }

        // Generate microstructure grains
        function generateMicrostructure() {
            const width = microstructureCanvas.width;
            const height = microstructureCanvas.height;
            grains = [];

            const phases = calculatePhaseFractions();
            const numGrains = Math.floor(50 + (20 - coolingRate) * 5); // More grains at slow cooling
            const avgGrainSize = width / Math.sqrt(numGrains);

            // Generate grain centers using Voronoi-like approach
            for (let i = 0; i < numGrains; i++) {
                let phase;
                const rand = Math.random();

                if (phases.liquid > 0) {
                    if (rand < phases.liquid) {
                        phase = 'liquid';
                    } else if (rand < phases.liquid + phases.alpha) {
                        phase = 'alpha';
                    } else {
                        phase = 'beta';
                    }
                } else {
                    // Solid - create eutectic structure in some grains
                    if (composition > currentSystem.maxSolubilityA &&
                        composition < currentSystem.maxSolubilityB) {
                        // Eutectic region - mix of primary and eutectic
                        if (rand < phases.alpha) {
                            phase = Math.random() < 0.3 ? 'eutectic' : 'alpha';
                        } else {
                            phase = Math.random() < 0.3 ? 'eutectic' : 'beta';
                        }
                    } else if (rand < phases.alpha) {
                        phase = 'alpha';
                    } else {
                        phase = 'beta';
                    }
                }

                grains.push({
                    x: Math.random() * width,
                    y: Math.random() * height,
                    phase: phase,
                    size: avgGrainSize * (0.5 + Math.random())
                });
            }
        }

        // Draw microstructure
        function drawMicrostructure() {
            const width = microstructureCanvas.width;
            const height = microstructureCanvas.height;

            msCtx.clearRect(0, 0, width, height);
            msCtx.fillStyle = '#1a1a2e';
            msCtx.fillRect(0, 0, width, height);

            if (grains.length === 0) {
                generateMicrostructure();
            }

            // Draw Voronoi-like cells
            const imageData = msCtx.createImageData(width, height);
            const data = imageData.data;

            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    let minDist = Infinity;
                    let closestGrain = null;

                    for (const grain of grains) {
                        const dx = x - grain.x;
                        const dy = y - grain.y;
                        const dist = dx * dx + dy * dy;
                        if (dist < minDist) {
                            minDist = dist;
                            closestGrain = grain;
                        }
                    }

                    const idx = (y * width + x) * 4;

                    if (closestGrain) {
                        let r, g, b;
                        const edgeFactor = Math.sqrt(minDist) / 20;

                        switch (closestGrain.phase) {
                            case 'liquid':
                                r = 243; g = 156; b = 18;
                                break;
                            case 'alpha':
                                r = 52; g = 152; b = 219;
                                break;
                            case 'beta':
                                r = 231; g = 76; b = 60;
                                break;
                            case 'eutectic':
                                // Lamellar pattern
                                const lamellarWidth = Math.max(2, 10 - coolingRate * 0.5);
                                const pattern = Math.floor((x + y * 0.5) / lamellarWidth) % 2;
                                if (pattern === 0) {
                                    r = 52; g = 152; b = 219;
                                } else {
                                    r = 231; g = 76; b = 60;
                                }
                                break;
                        }

                        // Darken edges
                        const edgeDarken = Math.min(1, edgeFactor * 0.1);
                        data[idx] = Math.floor(r * (1 - edgeDarken * 0.3));
                        data[idx + 1] = Math.floor(g * (1 - edgeDarken * 0.3));
                        data[idx + 2] = Math.floor(b * (1 - edgeDarken * 0.3));
                        data[idx + 3] = 255;
                    }
                }
            }

            msCtx.putImageData(imageData, 0, 0);

            // Draw grain boundaries
            msCtx.strokeStyle = 'rgba(0, 0, 0, 0.5)';
            msCtx.lineWidth = 1;

            for (const grain of grains) {
                msCtx.beginPath();
                msCtx.arc(grain.x, grain.y, 2, 0, Math.PI * 2);
                msCtx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                msCtx.fill();
            }

            // Update grain size display
            const avgSize = Math.round(microstructureCanvas.width / Math.sqrt(grains.length) * 10);
            elements.grainSize.textContent = avgSize;

            const lamellarSpacing = Math.max(2, 10 - coolingRate * 0.5);
            elements.lamellarSpacing.textContent = lamellarSpacing.toFixed(1) + ' μm';
        }

        // Draw temperature history chart
        function drawTemperatureChart() {
            const width = temperatureCanvas.width;
            const height = temperatureCanvas.height;
            const margin = { top: 20, right: 20, bottom: 30, left: 45 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;

            tempCtx.clearRect(0, 0, width, height);
            tempCtx.fillStyle = '#1a1a2e';
            tempCtx.fillRect(0, 0, width, height);

            // Axes
            tempCtx.strokeStyle = '#666';
            tempCtx.lineWidth = 1;
            tempCtx.beginPath();
            tempCtx.moveTo(margin.left, margin.top);
            tempCtx.lineTo(margin.left, height - margin.bottom);
            tempCtx.lineTo(width - margin.right, height - margin.bottom);
            tempCtx.stroke();

            // Labels
            tempCtx.fillStyle = '#aaa';
            tempCtx.font = '10px sans-serif';
            tempCtx.textAlign = 'center';
            tempCtx.fillText('Time (s)', width / 2, height - 5);

            tempCtx.save();
            tempCtx.translate(10, height / 2);
            tempCtx.rotate(-Math.PI / 2);
            tempCtx.fillText('T (°C)', 0, 0);
            tempCtx.restore();

            if (temperatureHistory.length < 2) return;

            const maxT = Math.max(...temperatureHistory.map(p => p.temp)) + 50;
            const minT = Math.min(...temperatureHistory.map(p => p.temp)) - 50;
            const maxTime = Math.max(...temperatureHistory.map(p => p.time));

            // Draw temperature curve
            tempCtx.strokeStyle = '#f39c12';
            tempCtx.lineWidth = 2;
            tempCtx.beginPath();

            temperatureHistory.forEach((point, i) => {
                const x = margin.left + (point.time / maxTime) * chartWidth;
                const y = margin.top + (1 - (point.temp - minT) / (maxT - minT)) * chartHeight;

                if (i === 0) {
                    tempCtx.moveTo(x, y);
                } else {
                    tempCtx.lineTo(x, y);
                }
            });

            tempCtx.stroke();

            // Draw phase transition lines
            const liquidusT = getLiquidusTemp(composition);
            const eutecticT = currentSystem.eutectic.temp;

            if (liquidusT >= minT && liquidusT <= maxT) {
                const y = margin.top + (1 - (liquidusT - minT) / (maxT - minT)) * chartHeight;
                tempCtx.strokeStyle = 'rgba(243, 156, 18, 0.5)';
                tempCtx.setLineDash([5, 5]);
                tempCtx.beginPath();
                tempCtx.moveTo(margin.left, y);
                tempCtx.lineTo(width - margin.right, y);
                tempCtx.stroke();
                tempCtx.fillStyle = '#f39c12';
                tempCtx.textAlign = 'right';
                tempCtx.fillText('Liquidus', width - margin.right - 5, y - 3);
            }

            if (eutecticT >= minT && eutecticT <= maxT) {
                const y = margin.top + (1 - (eutecticT - minT) / (maxT - minT)) * chartHeight;
                tempCtx.strokeStyle = 'rgba(155, 89, 182, 0.5)';
                tempCtx.beginPath();
                tempCtx.moveTo(margin.left, y);
                tempCtx.lineTo(width - margin.right, y);
                tempCtx.stroke();
                tempCtx.fillStyle = '#9b59b6';
                tempCtx.fillText('Eutectic', width - margin.right - 5, y - 3);
            }

            tempCtx.setLineDash([]);
        }

        // Draw phase fraction chart
        function drawPhaseFractionChart() {
            const width = phaseFractionCanvas.width;
            const height = phaseFractionCanvas.height;
            const margin = { top: 20, right: 20, bottom: 30, left: 45 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;

            pfCtx.clearRect(0, 0, width, height);
            pfCtx.fillStyle = '#1a1a2e';
            pfCtx.fillRect(0, 0, width, height);

            // Axes
            pfCtx.strokeStyle = '#666';
            pfCtx.lineWidth = 1;
            pfCtx.beginPath();
            pfCtx.moveTo(margin.left, margin.top);
            pfCtx.lineTo(margin.left, height - margin.bottom);
            pfCtx.lineTo(width - margin.right, height - margin.bottom);
            pfCtx.stroke();

            // Labels
            pfCtx.fillStyle = '#aaa';
            pfCtx.font = '10px sans-serif';
            pfCtx.textAlign = 'center';
            pfCtx.fillText('Temperature (°C)', width / 2, height - 5);

            pfCtx.save();
            pfCtx.translate(10, height / 2);
            pfCtx.rotate(-Math.PI / 2);
            pfCtx.fillText('Fraction', 0, 0);
            pfCtx.restore();

            if (phaseFractionHistory.length < 2) return;

            const temps = phaseFractionHistory.map(p => p.temp);
            const maxT = Math.max(...temps);
            const minT = Math.min(...temps);

            // Sort by temperature (descending)
            const sorted = [...phaseFractionHistory].sort((a, b) => b.temp - a.temp);

            // Draw area charts (stacked)
            // Liquid
            pfCtx.fillStyle = 'rgba(243, 156, 18, 0.6)';
            pfCtx.beginPath();
            pfCtx.moveTo(margin.left, height - margin.bottom);

            sorted.forEach((point, i) => {
                const x = margin.left + (1 - (point.temp - minT) / (maxT - minT)) * chartWidth;
                const y = margin.top + (1 - point.liquid) * chartHeight;
                pfCtx.lineTo(x, y);
            });

            pfCtx.lineTo(width - margin.right, height - margin.bottom);
            pfCtx.closePath();
            pfCtx.fill();

            // Alpha (on top of liquid)
            pfCtx.fillStyle = 'rgba(52, 152, 219, 0.6)';
            pfCtx.beginPath();
            pfCtx.moveTo(margin.left, height - margin.bottom);

            sorted.forEach((point, i) => {
                const x = margin.left + (1 - (point.temp - minT) / (maxT - minT)) * chartWidth;
                const y = margin.top + (1 - point.liquid - point.alpha) * chartHeight;
                pfCtx.lineTo(x, y);
            });

            sorted.slice().reverse().forEach((point, i) => {
                const x = margin.left + (1 - (point.temp - minT) / (maxT - minT)) * chartWidth;
                const y = margin.top + (1 - point.liquid) * chartHeight;
                pfCtx.lineTo(x, y);
            });

            pfCtx.closePath();
            pfCtx.fill();

            // Beta (fills remaining)
            pfCtx.fillStyle = 'rgba(231, 76, 60, 0.6)';
            pfCtx.beginPath();
            pfCtx.moveTo(margin.left, margin.top);

            sorted.forEach((point, i) => {
                const x = margin.left + (1 - (point.temp - minT) / (maxT - minT)) * chartWidth;
                const y = margin.top + (1 - point.liquid - point.alpha) * chartHeight;
                pfCtx.lineTo(x, y);
            });

            pfCtx.lineTo(width - margin.right, margin.top);
            pfCtx.closePath();
            pfCtx.fill();

            // Legend
            pfCtx.font = '9px sans-serif';
            pfCtx.fillStyle = '#f39c12';
            pfCtx.fillText('L', margin.left + 20, margin.top + 15);
            pfCtx.fillStyle = '#3498db';
            pfCtx.fillText('α', margin.left + 40, margin.top + 15);
            pfCtx.fillStyle = '#e74c3c';
            pfCtx.fillText('β', margin.left + 60, margin.top + 15);
        }

        // Update UI displays
        function updateUI() {
            const phases = calculatePhaseFractions();

            elements.currentTemp.textContent = temperature.toFixed(1);
            elements.currentPhase.textContent = phases.region;
            elements.liquidFraction.textContent = (phases.liquid * 100).toFixed(1);
            elements.solidFraction.textContent = ((1 - phases.liquid) * 100).toFixed(1);

            elements.alphaBar.style.width = (phases.alpha * 100) + '%';
            elements.liquidBar.style.width = (phases.liquid * 100) + '%';
            elements.betaBar.style.width = (phases.beta * 100) + '%';

            // Update phase compositions
            if (temperature < getLiquidusTemp(composition) && temperature >= currentSystem.eutectic.temp) {
                elements.alphaComp.textContent = getSolvusAlpha(temperature).toFixed(1) + '%';
                elements.betaComp.textContent = '-';
            } else if (temperature < currentSystem.eutectic.temp) {
                elements.alphaComp.textContent = getSolvusAlpha(temperature).toFixed(1) + '%';
                elements.betaComp.textContent = getSolvusBeta(temperature).toFixed(1) + '%';
            } else {
                elements.alphaComp.textContent = '-';
                elements.betaComp.textContent = '-';
            }

            // Update phase info
            let info = '<strong>Phase Info:</strong><br>';
            if (phases.region === 'L') {
                info += 'Completely liquid alloy. All atoms in disordered state.';
            } else if (phases.region.includes('L')) {
                info += `Mushy zone: ${(phases.liquid * 100).toFixed(1)}% liquid, solid phase nucleating from melt.`;
            } else if (phases.region === 'α + β') {
                info += `Two-phase solid: ${(phases.alpha * 100).toFixed(1)}% α (${currentSystem.componentA}-rich), ${(phases.beta * 100).toFixed(1)}% β (${currentSystem.componentB}-rich).`;
            } else {
                info += `Single-phase solid: ${phases.region} phase with dissolved solute.`;
            }
            elements.phaseInfo.innerHTML = info;
        }

        // Simulation step
        function simulationStep() {
            if (!isRunning || isPaused) return;

            const dt = 0.05 * simSpeed;
            time += dt;

            // Cool down
            if (temperature > targetTemperature) {
                temperature -= coolingRate * dt;
                temperature = Math.max(temperature, targetTemperature);
            }

            // Record history
            const phases = calculatePhaseFractions();
            temperatureHistory.push({ time, temp: temperature });
            phaseFractionHistory.push({
                temp: temperature,
                liquid: phases.liquid,
                alpha: phases.alpha,
                beta: phases.beta
            });

            // Limit history length
            if (temperatureHistory.length > 500) {
                temperatureHistory.shift();
            }
            if (phaseFractionHistory.length > 500) {
                phaseFractionHistory.shift();
            }

            // Regenerate microstructure periodically
            if (Math.floor(time * 10) % 20 === 0) {
                generateMicrostructure();
            }

            // Update displays
            updateUI();
            drawPhaseDiagram();
            drawMicrostructure();
            drawTemperatureChart();
            drawPhaseFractionChart();

            // Check if cooling complete
            if (temperature <= targetTemperature) {
                isRunning = false;
                elements.startBtn.textContent = 'Cooling Complete';
            }

            requestAnimationFrame(simulationStep);
        }

        // Reset simulation
        function reset() {
            isRunning = false;
            isPaused = false;
            time = 0;
            temperature = parseFloat(elements.temperature.value);
            temperatureHistory = [];
            phaseFractionHistory = [];
            grains = [];

            elements.startBtn.textContent = 'Start Cooling';

            updateUI();
            drawPhaseDiagram();
            drawMicrostructure();
            drawTemperatureChart();
            drawPhaseFractionChart();
        }

        // Quench (instant cooling)
        function quench() {
            temperature = targetTemperature;
            coolingRate = 100; // Record as fast cooling for microstructure

            const phases = calculatePhaseFractions();
            temperatureHistory.push({ time, temp: temperature });
            phaseFractionHistory.push({
                temp: temperature,
                liquid: phases.liquid,
                alpha: phases.alpha,
                beta: phases.beta
            });

            generateMicrostructure();

            isRunning = false;
            elements.startBtn.textContent = 'Quenched';

            updateUI();
            drawPhaseDiagram();
            drawMicrostructure();
            drawTemperatureChart();
            drawPhaseFractionChart();

            coolingRate = parseFloat(elements.coolingRate.value);
        }

        // Event listeners
        elements.alloySystem.addEventListener('change', () => {
            currentSystem = alloySystems[elements.alloySystem.value];

            // Adjust temperature sliders for new system
            const maxTemp = Math.max(currentSystem.meltA, currentSystem.meltB);
            elements.temperature.max = maxTemp + 100;
            elements.temperature.value = Math.min(temperature, maxTemp + 50);
            temperature = parseFloat(elements.temperature.value);
            elements.temperatureVal.textContent = temperature;

            elements.targetTemp.max = currentSystem.eutectic.temp;

            reset();
        });

        elements.composition.addEventListener('input', () => {
            composition = parseFloat(elements.composition.value);
            elements.compositionVal.textContent = composition;
            if (!isRunning) {
                updateUI();
                drawPhaseDiagram();
            }
        });

        elements.temperature.addEventListener('input', () => {
            if (!isRunning) {
                temperature = parseFloat(elements.temperature.value);
                elements.temperatureVal.textContent = temperature;
                updateUI();
                drawPhaseDiagram();
                generateMicrostructure();
                drawMicrostructure();
            }
        });

        elements.coolingRate.addEventListener('input', () => {
            coolingRate = parseFloat(elements.coolingRate.value);
            elements.coolingRateVal.textContent = coolingRate;
        });

        elements.targetTemp.addEventListener('input', () => {
            targetTemperature = parseFloat(elements.targetTemp.value);
            elements.targetTempVal.textContent = targetTemperature;
        });

        elements.simSpeed.addEventListener('input', () => {
            simSpeed = parseFloat(elements.simSpeed.value);
            elements.simSpeedVal.textContent = simSpeed;
        });

        elements.startBtn.addEventListener('click', () => {
            if (!isRunning) {
                isRunning = true;
                isPaused = false;
                elements.startBtn.textContent = 'Cooling...';
                simulationStep();
            }
        });

        elements.pauseBtn.addEventListener('click', () => {
            isPaused = !isPaused;
            elements.pauseBtn.textContent = isPaused ? 'Resume' : 'Pause';
            if (!isPaused && isRunning) {
                simulationStep();
            }
        });

        elements.resetBtn.addEventListener('click', reset);
        elements.quenchBtn.addEventListener('click', quench);

        // Initialize
        reset();
    </script>
</body>
</html>
