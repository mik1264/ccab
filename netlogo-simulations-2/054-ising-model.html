<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2D Ising Model - Phase Transition & Critical Temperature</title>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&family=Nunito:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --sage: #8A9A5B;
            --moss: #606C38;
            --earth: #DDA15E;
            --cream: #FEFAE0;
            --terracotta: #BC6C25;
            --dark-moss: #3d4423;
            --spin-up: #D94A4A;
            --spin-down: #4A90D9;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, #F4F1DE 50%, #EDE8D5 100%);
            min-height: 100vh;
            color: var(--dark-moss);
            padding: 20px;
        }

        .organic-back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            text-decoration: none;
            color: var(--moss);
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .organic-back-link:hover {
            background: var(--moss);
            color: white;
            transform: translateX(-5px);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding-top: 60px;
        }

        h1 {
            font-family: 'Lora', serif;
            font-size: 2.5rem;
            color: var(--moss);
            text-align: center;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: var(--terracotta);
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        .simulation-area {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }

        .controls {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            max-height: calc(100vh - 150px);
            overflow-y: auto;
        }

        .control-section {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(96, 108, 56, 0.2);
        }

        .control-section:last-child {
            border-bottom: none;
        }

        .control-section h3 {
            color: var(--moss);
            font-size: 1rem;
            margin-bottom: 12px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            font-weight: 600;
            color: var(--moss);
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .control-group input[type="range"] {
            width: 100%;
            accent-color: var(--moss);
        }

        .control-group .value {
            text-align: right;
            font-size: 0.85rem;
            color: var(--terracotta);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            accent-color: var(--moss);
            width: 18px;
            height: 18px;
        }

        button {
            width: 100%;
            padding: 12px;
            background: var(--moss);
            color: white;
            border: none;
            border-radius: 10px;
            font-family: 'Nunito', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        button:hover {
            background: var(--terracotta);
            transform: translateY(-2px);
        }

        button.secondary {
            background: var(--sage);
        }

        .main-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .dual-canvas {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .canvas-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        canvas {
            width: 100%;
            border-radius: 10px;
        }

        #latticeCanvas {
            background: #1a1a2e;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .stat-box {
            background: linear-gradient(135deg, var(--sage) 0%, var(--moss) 100%);
            color: white;
            padding: 12px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-box.mag {
            background: linear-gradient(135deg, #E85B5B 0%, var(--spin-up) 100%);
        }

        .stat-box.energy {
            background: linear-gradient(135deg, #5BA3E8 0%, var(--spin-down) 100%);
        }

        .stat-box.temp {
            background: linear-gradient(135deg, var(--earth) 0%, var(--terracotta) 100%);
        }

        .stat-box .label {
            font-size: 0.75rem;
            opacity: 0.9;
        }

        .stat-box .value {
            font-size: 1.1rem;
            font-weight: 700;
            font-family: 'Lora', serif;
        }

        .phase-indicator {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .phase-indicator h4 {
            color: var(--moss);
            margin-bottom: 10px;
        }

        .phase-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 1rem;
        }

        .phase-badge.ferromagnetic {
            background: var(--spin-up);
            color: white;
        }

        .phase-badge.paramagnetic {
            background: var(--spin-down);
            color: white;
        }

        .phase-badge.critical {
            background: var(--terracotta);
            color: white;
        }

        .info-panel {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .equation {
            font-family: 'Times New Roman', serif;
            font-size: 1rem;
            text-align: center;
            padding: 8px;
            background: rgba(96, 108, 56, 0.1);
            border-radius: 8px;
            margin: 8px 0;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        @media (max-width: 1100px) {
            .simulation-area {
                grid-template-columns: 1fr;
            }
            .dual-canvas {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <a href="index.html" class="organic-back-link">
        <span>←</span>
        <span>Back to Gallery</span>
    </a>

    <div class="container">
        <h1>2D Ising Model</h1>
        <p class="subtitle">Phase Transition & Spontaneous Magnetization via Metropolis-Hastings</p>

        <div class="simulation-area">
            <div class="controls">
                <div class="control-section">
                    <h3>Lattice Parameters</h3>
                    <div class="control-group">
                        <label>Lattice Size (L × L)</label>
                        <input type="range" id="latticeSize" min="20" max="100" step="10" value="50">
                        <div class="value" id="latticeSizeValue">50 × 50</div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Physical Parameters</h3>
                    <div class="control-group">
                        <label>Temperature (T/T_c)</label>
                        <input type="range" id="temperature" min="0.1" max="3" step="0.05" value="1">
                        <div class="value" id="temperatureValue">1.00 (T_c ≈ 2.27)</div>
                    </div>
                    <div class="control-group">
                        <label>External Field (H)</label>
                        <input type="range" id="field" min="-2" max="2" step="0.1" value="0">
                        <div class="value" id="fieldValue">0.0</div>
                    </div>
                    <div class="control-group">
                        <label>Coupling Constant (J)</label>
                        <input type="range" id="coupling" min="0.5" max="2" step="0.1" value="1">
                        <div class="value" id="couplingValue">1.0</div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Initial State</h3>
                    <div class="checkbox-group">
                        <input type="radio" name="initState" id="initRandom" checked>
                        <label for="initRandom">Random</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="radio" name="initState" id="initAllUp">
                        <label for="initAllUp">All Spins Up</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="radio" name="initState" id="initAllDown">
                        <label for="initAllDown">All Spins Down</label>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Simulation</h3>
                    <div class="control-group">
                        <label>Steps per Frame</label>
                        <input type="range" id="stepsPerFrame" min="100" max="10000" step="100" value="1000">
                        <div class="value" id="stepsPerFrameValue">1000</div>
                    </div>
                </div>

                <button id="runBtn">▶ Run Simulation</button>
                <button id="resetBtn" class="secondary">Reset</button>
                <button id="sweepBtn" class="secondary">Temperature Sweep</button>

                <div class="info-panel">
                    <h3 style="color: var(--moss); margin-bottom: 8px;">Ising Model</h3>
                    <p>Energy per spin:</p>
                    <div class="equation">H = -J Σ s_i s_j - H Σ s_i</div>
                    <p>Metropolis acceptance probability:</p>
                    <div class="equation">P = min(1, e^{-ΔE/T})</div>
                    <p style="margin-top: 8px;">Critical temperature: T_c ≈ 2.269 (in units J/k_B)</p>
                </div>
            </div>

            <div class="main-area">
                <div class="dual-canvas">
                    <div class="canvas-container">
                        <canvas id="latticeCanvas"></canvas>
                        <div class="legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--spin-up);"></div>
                                <span>Spin Up (+1)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--spin-down);"></div>
                                <span>Spin Down (-1)</span>
                            </div>
                        </div>
                    </div>
                    <div class="canvas-container">
                        <canvas id="plotCanvas"></canvas>
                        <div class="legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--spin-up);"></div>
                                <span>|Magnetization|</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--spin-down);"></div>
                                <span>Energy</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-box mag">
                        <div class="label">Magnetization |M|</div>
                        <div class="value" id="statMag">0.00</div>
                    </div>
                    <div class="stat-box energy">
                        <div class="label">Energy per Spin</div>
                        <div class="value" id="statEnergy">0.00</div>
                    </div>
                    <div class="stat-box temp">
                        <div class="label">Temperature T</div>
                        <div class="value" id="statTemp">2.27</div>
                    </div>
                    <div class="stat-box">
                        <div class="label">Monte Carlo Steps</div>
                        <div class="value" id="statSteps">0</div>
                    </div>
                </div>

                <div class="phase-indicator">
                    <h4>Phase State</h4>
                    <div class="phase-badge critical" id="phaseBadge">Critical Region</div>
                    <p id="phaseDesc" style="margin-top: 10px; font-size: 0.9rem;">
                        Near T_c: Fluctuations dominate, critical phenomena observed
                    </p>
                    <div style="margin-top: 10px;">
                        <span>Susceptibility: <strong id="susceptibility">-</strong></span>
                        <span style="margin-left: 20px;">Specific Heat: <strong id="specificHeat">-</strong></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Canvas setup
        const latticeCanvas = document.getElementById('latticeCanvas');
        const latticeCtx = latticeCanvas.getContext('2d');
        const plotCanvas = document.getElementById('plotCanvas');
        const plotCtx = plotCanvas.getContext('2d');

        let canvasSize;

        function setupCanvas(canvas, ctx) {
            const rect = canvas.parentElement.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            const size = Math.min(rect.width - 30, 400);
            canvas.width = size * dpr;
            canvas.height = size * dpr;
            canvas.style.width = size + 'px';
            canvas.style.height = size + 'px';
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.scale(dpr, dpr);
            return size;
        }

        function setupAllCanvases() {
            canvasSize = setupCanvas(latticeCanvas, latticeCtx);
            setupCanvas(plotCanvas, plotCtx);
        }
        setupAllCanvases();
        window.addEventListener('resize', () => { setupAllCanvases(); draw(); });

        // Critical temperature (exact solution)
        const T_c = 2 / Math.log(1 + Math.sqrt(2)); // ≈ 2.269

        // Simulation state
        let lattice = [];
        let L = 50;
        let T = T_c;
        let H = 0;
        let J = 1;
        let mcSteps = 0;
        let stepsPerFrame = 1000;
        let running = false;
        let sweeping = false;
        let animationId = null;

        // History for plots
        let magHistory = [];
        let energyHistory = [];
        let tempHistory = [];
        const maxHistory = 200;

        // Statistics
        let magSquaredSum = 0;
        let energySquaredSum = 0;
        let magSum = 0;
        let energySum = 0;
        let measureCount = 0;

        // Initialize lattice
        function initLattice(initType = 'random') {
            lattice = [];
            for (let i = 0; i < L; i++) {
                lattice[i] = [];
                for (let j = 0; j < L; j++) {
                    if (initType === 'random') {
                        lattice[i][j] = Math.random() < 0.5 ? 1 : -1;
                    } else if (initType === 'up') {
                        lattice[i][j] = 1;
                    } else {
                        lattice[i][j] = -1;
                    }
                }
            }
            mcSteps = 0;
            magHistory = [];
            energyHistory = [];
            tempHistory = [];
            resetStats();
        }

        function resetStats() {
            magSquaredSum = 0;
            energySquaredSum = 0;
            magSum = 0;
            energySum = 0;
            measureCount = 0;
        }

        // Calculate total energy
        function calculateEnergy() {
            let E = 0;
            for (let i = 0; i < L; i++) {
                for (let j = 0; j < L; j++) {
                    const s = lattice[i][j];
                    // Neighbors with periodic boundary conditions
                    const right = lattice[(i + 1) % L][j];
                    const down = lattice[i][(j + 1) % L];
                    E -= J * s * (right + down);
                    E -= H * s;
                }
            }
            return E;
        }

        // Calculate magnetization
        function calculateMagnetization() {
            let M = 0;
            for (let i = 0; i < L; i++) {
                for (let j = 0; j < L; j++) {
                    M += lattice[i][j];
                }
            }
            return M / (L * L);
        }

        // Calculate energy change for flipping spin at (i,j)
        function deltaEnergy(i, j) {
            const s = lattice[i][j];
            const neighbors = lattice[(i + 1) % L][j] +
                              lattice[(i - 1 + L) % L][j] +
                              lattice[i][(j + 1) % L] +
                              lattice[i][(j - 1 + L) % L];
            return 2 * J * s * neighbors + 2 * H * s;
        }

        // Metropolis-Hastings step
        function metropolisStep() {
            for (let n = 0; n < L * L; n++) {
                const i = Math.floor(Math.random() * L);
                const j = Math.floor(Math.random() * L);

                const dE = deltaEnergy(i, j);

                if (dE < 0 || Math.random() < Math.exp(-dE / T)) {
                    lattice[i][j] *= -1;
                }
            }
            mcSteps++;

            // Record measurements
            const m = calculateMagnetization();
            const e = calculateEnergy() / (L * L);

            magSum += Math.abs(m);
            energySum += e;
            magSquaredSum += m * m;
            energySquaredSum += e * e;
            measureCount++;

            // Update history
            magHistory.push(Math.abs(m));
            energyHistory.push(e);
            tempHistory.push(T);

            if (magHistory.length > maxHistory) {
                magHistory.shift();
                energyHistory.shift();
                tempHistory.shift();
            }
        }

        // Calculate susceptibility and specific heat
        function calculateThermodynamics() {
            if (measureCount < 10) return { chi: 0, c: 0 };

            const avgM = magSum / measureCount;
            const avgM2 = magSquaredSum / measureCount;
            const avgE = energySum / measureCount;
            const avgE2 = energySquaredSum / measureCount;

            const chi = L * L * (avgM2 - avgM * avgM) / T; // Susceptibility
            const c = L * L * (avgE2 - avgE * avgE) / (T * T); // Specific heat

            return { chi, c };
        }

        // Update statistics display
        function updateStats() {
            const m = calculateMagnetization();
            const e = calculateEnergy() / (L * L);
            const { chi, c } = calculateThermodynamics();

            document.getElementById('statMag').textContent = Math.abs(m).toFixed(3);
            document.getElementById('statEnergy').textContent = e.toFixed(3);
            document.getElementById('statTemp').textContent = T.toFixed(2);
            document.getElementById('statSteps').textContent = mcSteps.toLocaleString();

            document.getElementById('susceptibility').textContent = chi > 0 ? chi.toFixed(2) : '-';
            document.getElementById('specificHeat').textContent = c > 0 ? c.toFixed(2) : '-';

            // Update phase indicator
            const phaseBadge = document.getElementById('phaseBadge');
            const phaseDesc = document.getElementById('phaseDesc');

            const relT = T / T_c;
            if (relT < 0.9) {
                phaseBadge.className = 'phase-badge ferromagnetic';
                phaseBadge.textContent = 'Ferromagnetic';
                phaseDesc.textContent = 'T < T_c: Ordered phase with spontaneous magnetization';
            } else if (relT > 1.1) {
                phaseBadge.className = 'phase-badge paramagnetic';
                phaseBadge.textContent = 'Paramagnetic';
                phaseDesc.textContent = 'T > T_c: Disordered phase, no net magnetization';
            } else {
                phaseBadge.className = 'phase-badge critical';
                phaseBadge.textContent = 'Critical Region';
                phaseDesc.textContent = 'Near T_c: Large fluctuations, critical phenomena';
            }
        }

        // Draw lattice
        function drawLattice() {
            const cellSize = canvasSize / L;

            latticeCtx.fillStyle = '#1a1a2e';
            latticeCtx.fillRect(0, 0, canvasSize, canvasSize);

            for (let i = 0; i < L; i++) {
                for (let j = 0; j < L; j++) {
                    if (lattice[i][j] === 1) {
                        latticeCtx.fillStyle = '#D94A4A';
                    } else {
                        latticeCtx.fillStyle = '#4A90D9';
                    }
                    latticeCtx.fillRect(i * cellSize, j * cellSize, cellSize, cellSize);
                }
            }

            // Title
            latticeCtx.fillStyle = 'white';
            latticeCtx.font = 'bold 14px Lora';
            latticeCtx.fillText(`${L}×${L} Spin Lattice`, 10, 20);
        }

        // Draw plots
        function drawPlots() {
            const width = canvasSize;
            const height = canvasSize;
            const padding = { top: 35, right: 15, bottom: 35, left: 50 };
            const plotWidth = width - padding.left - padding.right;
            const plotHeight = (height - padding.top - padding.bottom - 20) / 2;

            plotCtx.fillStyle = '#FEFAE0';
            plotCtx.fillRect(0, 0, width, height);

            // Draw magnetization plot
            drawSubPlot(padding.left, padding.top, plotWidth, plotHeight,
                        magHistory, '#D94A4A', '|M|', 0, 1);

            // Draw energy plot
            const minE = -2 * J;
            const maxE = 2 * J;
            drawSubPlot(padding.left, padding.top + plotHeight + 20, plotWidth, plotHeight,
                        energyHistory, '#4A90D9', 'E/N', minE, maxE);

            // Title
            plotCtx.fillStyle = '#606C38';
            plotCtx.font = 'bold 14px Lora';
            plotCtx.textAlign = 'left';
            plotCtx.fillText('Observables vs MC Steps', padding.left, 18);
        }

        function drawSubPlot(x, y, w, h, data, color, label, minVal, maxVal) {
            // Background
            plotCtx.fillStyle = 'rgba(255,255,255,0.5)';
            plotCtx.fillRect(x, y, w, h);

            // Grid
            plotCtx.strokeStyle = '#E0DCC8';
            plotCtx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const yy = y + h * i / 4;
                plotCtx.beginPath();
                plotCtx.moveTo(x, yy);
                plotCtx.lineTo(x + w, yy);
                plotCtx.stroke();
            }

            // Axes
            plotCtx.strokeStyle = '#606C38';
            plotCtx.lineWidth = 1.5;
            plotCtx.beginPath();
            plotCtx.moveTo(x, y);
            plotCtx.lineTo(x, y + h);
            plotCtx.lineTo(x + w, y + h);
            plotCtx.stroke();

            // Y-axis label
            plotCtx.fillStyle = '#3d4423';
            plotCtx.font = '10px Nunito';
            plotCtx.textAlign = 'right';
            plotCtx.fillText(maxVal.toFixed(1), x - 5, y + 10);
            plotCtx.fillText(minVal.toFixed(1), x - 5, y + h);
            plotCtx.fillText(label, x - 5, y + h / 2);

            // Draw data
            if (data.length < 2) return;

            plotCtx.strokeStyle = color;
            plotCtx.lineWidth = 2;
            plotCtx.beginPath();

            for (let i = 0; i < data.length; i++) {
                const px = x + w * i / (maxHistory - 1);
                const normalizedVal = (data[i] - minVal) / (maxVal - minVal);
                const py = y + h * (1 - Math.max(0, Math.min(1, normalizedVal)));

                if (i === 0) plotCtx.moveTo(px, py);
                else plotCtx.lineTo(px, py);
            }
            plotCtx.stroke();
        }

        function draw() {
            drawLattice();
            drawPlots();
        }

        // Animation loop
        function animate() {
            if (!running) return;

            for (let i = 0; i < stepsPerFrame; i++) {
                metropolisStep();
            }
            updateStats();
            draw();

            animationId = requestAnimationFrame(animate);
        }

        // Temperature sweep
        function temperatureSweep() {
            sweeping = true;
            running = false;
            cancelAnimationFrame(animationId);

            const startT = 0.5;
            const endT = 4;
            const steps = 50;
            const equilibrationSteps = 1000;
            const measurementSteps = 500;

            let currentStep = 0;

            function sweepStep() {
                if (currentStep >= steps) {
                    sweeping = false;
                    document.getElementById('sweepBtn').textContent = 'Temperature Sweep';
                    return;
                }

                T = startT + (endT - startT) * currentStep / steps;
                document.getElementById('temperature').value = T / T_c;
                document.getElementById('temperatureValue').textContent =
                    (T / T_c).toFixed(2) + ' (T_c ≈ 2.27)';

                resetStats();

                // Equilibration
                for (let i = 0; i < equilibrationSteps; i++) {
                    metropolisStep();
                }

                // Measurement
                for (let i = 0; i < measurementSteps; i++) {
                    metropolisStep();
                }

                updateStats();
                draw();

                currentStep++;
                requestAnimationFrame(sweepStep);
            }

            document.getElementById('sweepBtn').textContent = 'Sweeping...';
            sweepStep();
        }

        // Event handlers
        document.getElementById('runBtn').addEventListener('click', () => {
            if (running) {
                running = false;
                cancelAnimationFrame(animationId);
                document.getElementById('runBtn').textContent = '▶ Run Simulation';
            } else {
                running = true;
                document.getElementById('runBtn').textContent = '⏸ Pause';
                animate();
            }
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            running = false;
            sweeping = false;
            cancelAnimationFrame(animationId);
            document.getElementById('runBtn').textContent = '▶ Run Simulation';

            let initType = 'random';
            if (document.getElementById('initAllUp').checked) initType = 'up';
            if (document.getElementById('initAllDown').checked) initType = 'down';

            initLattice(initType);
            updateStats();
            draw();
        });

        document.getElementById('sweepBtn').addEventListener('click', () => {
            if (!sweeping) {
                temperatureSweep();
            }
        });

        // Parameter controls
        document.getElementById('latticeSize').addEventListener('input', function() {
            L = parseInt(this.value);
            document.getElementById('latticeSizeValue').textContent = L + ' × ' + L;
        });

        document.getElementById('temperature').addEventListener('input', function() {
            T = parseFloat(this.value) * T_c;
            document.getElementById('temperatureValue').textContent =
                parseFloat(this.value).toFixed(2) + ' (T_c ≈ 2.27)';
            resetStats();
            updateStats();
        });

        document.getElementById('field').addEventListener('input', function() {
            H = parseFloat(this.value);
            document.getElementById('fieldValue').textContent = H.toFixed(1);
            resetStats();
        });

        document.getElementById('coupling').addEventListener('input', function() {
            J = parseFloat(this.value);
            document.getElementById('couplingValue').textContent = J.toFixed(1);
            resetStats();
        });

        document.getElementById('stepsPerFrame').addEventListener('input', function() {
            stepsPerFrame = parseInt(this.value);
            document.getElementById('stepsPerFrameValue').textContent = stepsPerFrame;
        });

        // Initialize
        T = T_c;
        document.getElementById('temperature').value = 1;
        initLattice('random');
        updateStats();
        draw();
    </script>
</body>
</html>
