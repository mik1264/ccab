<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transportation Mode Choice - Commuter Decision Model</title>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&family=Nunito:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --sage: #8A9A5B;
            --moss: #606C38;
            --earth: #DDA15E;
            --cream: #FEFAE0;
            --terracotta: #BC6C25;
            --dark-moss: #3d4423;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, #F4F1DE 50%, #EDE8D5 100%);
            min-height: 100vh;
            color: var(--dark-moss);
            padding: 20px;
        }

        .organic-back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            text-decoration: none;
            color: var(--moss);
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .organic-back-link:hover {
            background: var(--moss);
            color: white;
            transform: translateX(-5px);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding-top: 60px;
        }

        h1 {
            font-family: 'Lora', serif;
            font-size: 2.5rem;
            color: var(--moss);
            text-align: center;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: var(--terracotta);
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        .simulation-area {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 20px;
        }

        .controls {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            max-height: calc(100vh - 150px);
            overflow-y: auto;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            font-weight: 600;
            color: var(--moss);
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .control-group input[type="range"] {
            width: 100%;
            accent-color: var(--moss);
        }

        .control-group .value {
            text-align: right;
            font-size: 0.85rem;
            color: var(--terracotta);
        }

        .section-title {
            font-family: 'Lora', serif;
            color: var(--moss);
            font-size: 1rem;
            margin: 15px 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--sage);
        }

        button {
            width: 100%;
            padding: 12px;
            background: var(--moss);
            color: white;
            border: none;
            border-radius: 10px;
            font-family: 'Nunito', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        button:hover {
            background: var(--terracotta);
            transform: translateY(-2px);
        }

        button.secondary {
            background: var(--sage);
        }

        .canvas-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        canvas {
            width: 100%;
            border-radius: 10px;
            background: white;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .stat-box {
            background: linear-gradient(135deg, var(--sage) 0%, var(--moss) 100%);
            color: white;
            padding: 12px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-box .label {
            font-size: 0.75rem;
            opacity: 0.9;
        }

        .stat-box .value {
            font-size: 1.3rem;
            font-weight: 700;
            font-family: 'Lora', serif;
        }

        .stat-box.car { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
        .stat-box.transit { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }
        .stat-box.bike { background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%); }
        .stat-box.walk { background: linear-gradient(135deg, #f39c12 0%, #d68910 100%); }

        .info-panel {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .info-panel h3 {
            color: var(--moss);
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .mode-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .mode-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .mode-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .chart-box {
            background: rgba(255, 255, 255, 0.6);
            border-radius: 12px;
            padding: 10px;
        }

        .chart-box h4 {
            font-size: 0.85rem;
            color: var(--moss);
            margin-bottom: 8px;
            text-align: center;
        }

        @media (max-width: 1000px) {
            .simulation-area {
                grid-template-columns: 1fr;
            }
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <a href="index.html" class="organic-back-link">
        <span>‚Üê</span>
        <span>Back to Gallery</span>
    </a>

    <div class="container">
        <h1>Transportation Mode Choice</h1>
        <p class="subtitle">Discrete Choice Model with Utility Maximization</p>

        <div class="simulation-area">
            <div class="controls">
                <h3 class="section-title">Population Settings</h3>
                <div class="control-group">
                    <label>Number of Commuters</label>
                    <input type="range" id="numAgents" min="50" max="500" value="200">
                    <div class="value" id="numAgentsValue">200</div>
                </div>

                <div class="control-group">
                    <label>Average Income ($1000s)</label>
                    <input type="range" id="avgIncome" min="20" max="150" value="60">
                    <div class="value" id="avgIncomeValue">$60k</div>
                </div>

                <div class="control-group">
                    <label>Car Ownership Rate (%)</label>
                    <input type="range" id="carOwnership" min="20" max="95" value="70">
                    <div class="value" id="carOwnershipValue">70%</div>
                </div>

                <h3 class="section-title">Travel Costs</h3>
                <div class="control-group">
                    <label>Gas Price ($/gallon)</label>
                    <input type="range" id="gasPrice" min="2" max="8" step="0.25" value="3.5">
                    <div class="value" id="gasPriceValue">$3.50</div>
                </div>

                <div class="control-group">
                    <label>Parking Cost ($/day)</label>
                    <input type="range" id="parkingCost" min="0" max="30" value="10">
                    <div class="value" id="parkingCostValue">$10</div>
                </div>

                <div class="control-group">
                    <label>Transit Fare ($)</label>
                    <input type="range" id="transitFare" min="1" max="8" step="0.5" value="3">
                    <div class="value" id="transitFareValue">$3.00</div>
                </div>

                <h3 class="section-title">Travel Time (minutes)</h3>
                <div class="control-group">
                    <label>Average Car Time</label>
                    <input type="range" id="carTime" min="10" max="60" value="25">
                    <div class="value" id="carTimeValue">25 min</div>
                </div>

                <div class="control-group">
                    <label>Average Transit Time</label>
                    <input type="range" id="transitTime" min="15" max="90" value="45">
                    <div class="value" id="transitTimeValue">45 min</div>
                </div>

                <div class="control-group">
                    <label>Average Bike Time</label>
                    <input type="range" id="bikeTime" min="10" max="60" value="30">
                    <div class="value" id="bikeTimeValue">30 min</div>
                </div>

                <h3 class="section-title">Preferences</h3>
                <div class="control-group">
                    <label>Value of Time ($/hour)</label>
                    <input type="range" id="valueOfTime" min="5" max="50" value="20">
                    <div class="value" id="valueOfTimeValue">$20</div>
                </div>

                <div class="control-group">
                    <label>Habit Strength</label>
                    <input type="range" id="habitStrength" min="0" max="1" step="0.1" value="0.3">
                    <div class="value" id="habitStrengthValue">0.30</div>
                </div>

                <button id="runBtn">‚ñ∂ Run Simulation</button>
                <button id="resetBtn" class="secondary">Reset</button>

                <div class="info-panel">
                    <h3>About Mode Choice</h3>
                    <p>This simulation uses discrete choice theory to model commuter decisions. Each agent maximizes utility based on:</p>
                    <ul style="margin-left: 15px; margin-top: 5px;">
                        <li><strong>Cost:</strong> Travel expenses including gas, parking, fares</li>
                        <li><strong>Time:</strong> Travel time valued at personal rate</li>
                        <li><strong>Convenience:</strong> Comfort, reliability factors</li>
                        <li><strong>Habit:</strong> Tendency to repeat past choices</li>
                    </ul>
                </div>
            </div>

            <div class="canvas-container">
                <canvas id="canvas"></canvas>

                <div class="mode-legend">
                    <div class="mode-item">
                        <div class="mode-icon" style="background: #e74c3c;">üöó</div>
                        <span>Car</span>
                    </div>
                    <div class="mode-item">
                        <div class="mode-icon" style="background: #3498db;">üöå</div>
                        <span>Transit</span>
                    </div>
                    <div class="mode-item">
                        <div class="mode-icon" style="background: #27ae60;">üö≤</div>
                        <span>Bike</span>
                    </div>
                    <div class="mode-item">
                        <div class="mode-icon" style="background: #f39c12;">üö∂</div>
                        <span>Walk</span>
                    </div>
                </div>

                <div class="stats">
                    <div class="stat-box car">
                        <div class="label">Car</div>
                        <div class="value" id="statCar">0%</div>
                    </div>
                    <div class="stat-box transit">
                        <div class="label">Transit</div>
                        <div class="value" id="statTransit">0%</div>
                    </div>
                    <div class="stat-box bike">
                        <div class="label">Bike</div>
                        <div class="value" id="statBike">0%</div>
                    </div>
                    <div class="stat-box walk">
                        <div class="label">Walk</div>
                        <div class="value" id="statWalk">0%</div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-box">
                        <h4>Mode Share Over Time</h4>
                        <canvas id="historyChart"></canvas>
                    </div>
                    <div class="chart-box">
                        <h4>Utility Distribution</h4>
                        <canvas id="utilityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Canvas setup
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const historyCanvas = document.getElementById('historyChart');
        const historyCtx = historyCanvas.getContext('2d');
        const utilityCanvas = document.getElementById('utilityChart');
        const utilityCtx = utilityCanvas.getContext('2d');

        // High DPI support
        function setupCanvas(cvs, ct, height) {
            const rect = cvs.parentElement.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            cvs.width = (rect.width - 20) * dpr;
            cvs.height = height * dpr;
            cvs.style.width = (rect.width - 20) + 'px';
            cvs.style.height = height + 'px';
            ct.scale(dpr, dpr);
        }

        function setupAllCanvases() {
            setupCanvas(canvas, ctx, 400);
            setupCanvas(historyCanvas, historyCtx, 150);
            setupCanvas(utilityCanvas, utilityCtx, 150);
        }
        setupAllCanvases();
        window.addEventListener('resize', () => {
            setupAllCanvases();
            draw();
        });

        // Mode definitions
        const MODES = {
            CAR: { name: 'Car', color: '#e74c3c', icon: 'üöó' },
            TRANSIT: { name: 'Transit', color: '#3498db', icon: 'üöå' },
            BIKE: { name: 'Bike', color: '#27ae60', icon: 'üö≤' },
            WALK: { name: 'Walk', color: '#f39c12', icon: 'üö∂' }
        };

        // Simulation state
        let agents = [];
        let modeHistory = { CAR: [], TRANSIT: [], BIKE: [], WALK: [] };
        let day = 0;
        let running = false;
        let animationId = null;

        // Parameters
        let params = {
            numAgents: 200,
            avgIncome: 60,
            carOwnership: 0.7,
            gasPrice: 3.5,
            parkingCost: 10,
            transitFare: 3,
            carTime: 25,
            transitTime: 45,
            bikeTime: 30,
            valueOfTime: 20,
            habitStrength: 0.3
        };

        // Agent class
        class Commuter {
            constructor(id) {
                this.id = id;
                // Socioeconomic attributes
                this.income = Math.max(15, params.avgIncome + (Math.random() - 0.5) * 60);
                this.hasCar = Math.random() < params.carOwnership;
                this.distance = 2 + Math.random() * 15; // miles
                this.valueOfTime = params.valueOfTime * (0.5 + this.income / 100);

                // Physical attributes
                this.fitness = 0.3 + Math.random() * 0.7; // 0-1, affects bike/walk tolerance
                this.age = 20 + Math.random() * 50;

                // Preferences (random variation)
                this.transitPreference = Math.random() * 0.4 - 0.2; // -0.2 to 0.2
                this.ecoConsciousness = Math.random(); // 0-1

                // Position for visualization
                this.x = Math.random() * 0.8 + 0.1;
                this.y = Math.random() * 0.8 + 0.1;
                this.targetX = this.x;
                this.targetY = this.y;

                // Current mode and habit
                this.currentMode = this.hasCar ? 'CAR' : 'TRANSIT';
                this.modeHistory = [this.currentMode];
                this.habitUtility = { CAR: 0, TRANSIT: 0, BIKE: 0, WALK: 0 };
            }

            calculateUtility(mode) {
                let utility = 0;

                // Calculate costs and times for each mode
                const costs = this.getModeCosts();
                const times = this.getModeTimes();

                // Base utility components
                const cost = costs[mode];
                const time = times[mode];

                // Generalized cost (time valued at personal rate)
                utility -= cost + (time / 60) * this.valueOfTime;

                // Mode-specific constants (alternative specific constants)
                const ASC = {
                    CAR: 2.0,
                    TRANSIT: 0.5 + this.transitPreference,
                    BIKE: -0.5 + this.fitness * 1.5 + this.ecoConsciousness * 0.5,
                    WALK: -1.0 + this.fitness * 1.0 + this.ecoConsciousness * 0.3
                };
                utility += ASC[mode];

                // Income effect (higher income less sensitive to cost)
                const incomeEffect = this.income / 100;
                utility += cost * incomeEffect * 0.1;

                // Distance penalties for active modes
                if (mode === 'BIKE' && this.distance > 8) {
                    utility -= (this.distance - 8) * 0.5;
                }
                if (mode === 'WALK' && this.distance > 2) {
                    utility -= (this.distance - 2) * 2;
                }

                // Weather/comfort bonus for car
                if (mode === 'CAR') {
                    utility += 0.5;
                }

                // Habit effect
                utility += this.habitUtility[mode] * params.habitStrength;

                // Availability constraint
                if (mode === 'CAR' && !this.hasCar) {
                    utility = -Infinity;
                }

                // Physical constraint for long distances
                if (mode === 'WALK' && this.distance > 5) {
                    utility = -Infinity;
                }
                if (mode === 'BIKE' && this.distance > 15) {
                    utility = -Infinity;
                }

                return utility;
            }

            getModeCosts() {
                const mpg = 25; // average fuel efficiency
                const carCost = (this.distance * 2 / mpg) * params.gasPrice + params.parkingCost;

                return {
                    CAR: carCost,
                    TRANSIT: params.transitFare * 2, // round trip
                    BIKE: 0.1 * this.distance, // minor maintenance
                    WALK: 0
                };
            }

            getModeTimes() {
                const carSpeed = this.distance / params.carTime * 60; // effective mph
                const transitWait = 10; // average wait time
                const bikeSpeed = this.distance / params.bikeTime * 60;
                const walkSpeed = 3; // mph

                return {
                    CAR: params.carTime * (1 + Math.random() * 0.3), // variability
                    TRANSIT: params.transitTime + transitWait * (0.5 + Math.random()),
                    BIKE: params.bikeTime * (1 + (1 - this.fitness) * 0.3),
                    WALK: (this.distance / walkSpeed) * 60
                };
            }

            chooseMode() {
                const utilities = {};
                let maxUtility = -Infinity;
                let bestMode = 'TRANSIT';

                for (const mode of Object.keys(MODES)) {
                    utilities[mode] = this.calculateUtility(mode);
                    if (utilities[mode] > maxUtility) {
                        maxUtility = utilities[mode];
                        bestMode = mode;
                    }
                }

                // Add random component (logit error term)
                // Softmax selection with temperature
                const temp = 1.5;
                let expSum = 0;
                const probs = {};

                for (const mode of Object.keys(MODES)) {
                    if (utilities[mode] > -Infinity) {
                        probs[mode] = Math.exp(utilities[mode] / temp);
                        expSum += probs[mode];
                    } else {
                        probs[mode] = 0;
                    }
                }

                // Normalize and select
                let rand = Math.random() * expSum;
                for (const mode of Object.keys(MODES)) {
                    rand -= probs[mode];
                    if (rand <= 0) {
                        bestMode = mode;
                        break;
                    }
                }

                // Update habit
                this.habitUtility[this.currentMode] *= 0.9;
                this.habitUtility[bestMode] += 0.3;

                this.currentMode = bestMode;
                this.modeHistory.push(bestMode);
                if (this.modeHistory.length > 30) {
                    this.modeHistory.shift();
                }

                return utilities;
            }

            update() {
                // Update position for visualization
                const modeZones = {
                    CAR: { x: 0.25, y: 0.25 },
                    TRANSIT: { x: 0.75, y: 0.25 },
                    BIKE: { x: 0.25, y: 0.75 },
                    WALK: { x: 0.75, y: 0.75 }
                };

                const zone = modeZones[this.currentMode];
                this.targetX = zone.x + (Math.random() - 0.5) * 0.35;
                this.targetY = zone.y + (Math.random() - 0.5) * 0.35;

                // Smooth movement
                this.x += (this.targetX - this.x) * 0.1;
                this.y += (this.targetY - this.y) * 0.1;
            }
        }

        // Initialize simulation
        function initSimulation() {
            agents = [];
            for (let i = 0; i < params.numAgents; i++) {
                agents.push(new Commuter(i));
            }
            modeHistory = { CAR: [], TRANSIT: [], BIKE: [], WALK: [] };
            day = 0;
            updateStats();
        }

        // Step simulation
        function step() {
            day++;

            // Each agent makes a mode choice
            for (const agent of agents) {
                agent.chooseMode();
                agent.update();
            }

            // Record mode shares
            const counts = { CAR: 0, TRANSIT: 0, BIKE: 0, WALK: 0 };
            for (const agent of agents) {
                counts[agent.currentMode]++;
            }

            for (const mode of Object.keys(MODES)) {
                modeHistory[mode].push(counts[mode] / agents.length);
                if (modeHistory[mode].length > 100) {
                    modeHistory[mode].shift();
                }
            }

            updateStats();
        }

        // Update statistics display
        function updateStats() {
            const counts = { CAR: 0, TRANSIT: 0, BIKE: 0, WALK: 0 };
            for (const agent of agents) {
                counts[agent.currentMode]++;
            }

            const total = agents.length || 1;
            document.getElementById('statCar').textContent = Math.round(counts.CAR / total * 100) + '%';
            document.getElementById('statTransit').textContent = Math.round(counts.TRANSIT / total * 100) + '%';
            document.getElementById('statBike').textContent = Math.round(counts.BIKE / total * 100) + '%';
            document.getElementById('statWalk').textContent = Math.round(counts.WALK / total * 100) + '%';
        }

        // Draw main visualization
        function draw() {
            const width = canvas.width / (window.devicePixelRatio || 1);
            const height = canvas.height / (window.devicePixelRatio || 1);

            // Clear
            ctx.fillStyle = '#FEFAE0';
            ctx.fillRect(0, 0, width, height);

            // Draw mode zones
            const zones = [
                { mode: 'CAR', x: 0, y: 0, label: 'Car Zone üöó' },
                { mode: 'TRANSIT', x: 0.5, y: 0, label: 'Transit Zone üöå' },
                { mode: 'BIKE', x: 0, y: 0.5, label: 'Bike Zone üö≤' },
                { mode: 'WALK', x: 0.5, y: 0.5, label: 'Walk Zone üö∂' }
            ];

            for (const zone of zones) {
                ctx.fillStyle = MODES[zone.mode].color + '15';
                ctx.fillRect(zone.x * width, zone.y * height, width * 0.5, height * 0.5);

                ctx.strokeStyle = MODES[zone.mode].color + '40';
                ctx.lineWidth = 2;
                ctx.strokeRect(zone.x * width, zone.y * height, width * 0.5, height * 0.5);

                ctx.fillStyle = MODES[zone.mode].color;
                ctx.font = 'bold 14px Nunito';
                ctx.textAlign = 'center';
                ctx.fillText(zone.label, (zone.x + 0.25) * width, zone.y * height + 25);
            }

            // Draw agents
            for (const agent of agents) {
                const x = agent.x * width;
                const y = agent.y * height;

                // Agent circle
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, Math.PI * 2);
                ctx.fillStyle = MODES[agent.currentMode].color;
                ctx.fill();

                // Highlight high-income agents
                if (agent.income > 100) {
                    ctx.strokeStyle = 'gold';
                    ctx.lineWidth = 1.5;
                    ctx.stroke();
                }
            }

            // Draw day counter
            ctx.fillStyle = '#606C38';
            ctx.font = 'bold 16px Lora';
            ctx.textAlign = 'left';
            ctx.fillText(`Day ${day}`, 10, height - 10);

            // Draw mode counts in zones
            const counts = { CAR: 0, TRANSIT: 0, BIKE: 0, WALK: 0 };
            for (const agent of agents) {
                counts[agent.currentMode]++;
            }

            ctx.font = 'bold 24px Lora';
            ctx.textAlign = 'center';
            ctx.fillStyle = MODES.CAR.color;
            ctx.fillText(counts.CAR, width * 0.25, height * 0.25 + 40);
            ctx.fillStyle = MODES.TRANSIT.color;
            ctx.fillText(counts.TRANSIT, width * 0.75, height * 0.25 + 40);
            ctx.fillStyle = MODES.BIKE.color;
            ctx.fillText(counts.BIKE, width * 0.25, height * 0.75 + 40);
            ctx.fillStyle = MODES.WALK.color;
            ctx.fillText(counts.WALK, width * 0.75, height * 0.75 + 40);

            drawHistoryChart();
            drawUtilityChart();
        }

        // Draw history chart
        function drawHistoryChart() {
            const width = historyCanvas.width / (window.devicePixelRatio || 1);
            const height = historyCanvas.height / (window.devicePixelRatio || 1);
            const padding = { top: 10, right: 10, bottom: 25, left: 35 };
            const plotWidth = width - padding.left - padding.right;
            const plotHeight = height - padding.top - padding.bottom;

            historyCtx.fillStyle = '#FEFAE0';
            historyCtx.fillRect(0, 0, width, height);

            // Draw axes
            historyCtx.strokeStyle = '#606C38';
            historyCtx.lineWidth = 1;
            historyCtx.beginPath();
            historyCtx.moveTo(padding.left, padding.top);
            historyCtx.lineTo(padding.left, height - padding.bottom);
            historyCtx.lineTo(width - padding.right, height - padding.bottom);
            historyCtx.stroke();

            // Y-axis labels
            historyCtx.fillStyle = '#3d4423';
            historyCtx.font = '10px Nunito';
            historyCtx.textAlign = 'right';
            historyCtx.fillText('100%', padding.left - 5, padding.top + 5);
            historyCtx.fillText('0%', padding.left - 5, height - padding.bottom);

            // X-axis label
            historyCtx.textAlign = 'center';
            historyCtx.fillText('Days', width / 2, height - 5);

            // Draw stacked area chart
            if (modeHistory.CAR.length > 1) {
                const modes = ['CAR', 'TRANSIT', 'BIKE', 'WALK'];

                for (let m = modes.length - 1; m >= 0; m--) {
                    historyCtx.beginPath();
                    historyCtx.moveTo(padding.left, height - padding.bottom);

                    for (let i = 0; i < modeHistory.CAR.length; i++) {
                        let cumulative = 0;
                        for (let j = 0; j <= m; j++) {
                            cumulative += modeHistory[modes[j]][i];
                        }
                        const x = padding.left + (i / (modeHistory.CAR.length - 1)) * plotWidth;
                        const y = height - padding.bottom - cumulative * plotHeight;
                        historyCtx.lineTo(x, y);
                    }

                    historyCtx.lineTo(padding.left + plotWidth, height - padding.bottom);
                    historyCtx.closePath();
                    historyCtx.fillStyle = MODES[modes[m]].color + '80';
                    historyCtx.fill();
                }
            }
        }

        // Draw utility distribution chart
        function drawUtilityChart() {
            const width = utilityCanvas.width / (window.devicePixelRatio || 1);
            const height = utilityCanvas.height / (window.devicePixelRatio || 1);
            const padding = { top: 10, right: 10, bottom: 25, left: 35 };
            const plotWidth = width - padding.left - padding.right;
            const plotHeight = height - padding.top - padding.bottom;

            utilityCtx.fillStyle = '#FEFAE0';
            utilityCtx.fillRect(0, 0, width, height);

            // Calculate average utilities per mode
            const avgUtilities = { CAR: 0, TRANSIT: 0, BIKE: 0, WALK: 0 };
            const counts = { CAR: 0, TRANSIT: 0, BIKE: 0, WALK: 0 };

            for (const agent of agents) {
                const u = agent.calculateUtility(agent.currentMode);
                if (u > -Infinity) {
                    avgUtilities[agent.currentMode] += u;
                    counts[agent.currentMode]++;
                }
            }

            const modes = ['CAR', 'TRANSIT', 'BIKE', 'WALK'];
            const maxU = 10;
            const minU = -10;

            // Draw bars
            const barWidth = plotWidth / 5;
            modes.forEach((mode, i) => {
                const avgU = counts[mode] > 0 ? avgUtilities[mode] / counts[mode] : 0;
                const normalizedU = (avgU - minU) / (maxU - minU);
                const barHeight = Math.max(0, Math.min(1, normalizedU)) * plotHeight;

                const x = padding.left + (i + 0.5) * barWidth;
                const y = height - padding.bottom - barHeight;

                utilityCtx.fillStyle = MODES[mode].color;
                utilityCtx.fillRect(x, y, barWidth * 0.8, barHeight);

                // Mode label
                utilityCtx.fillStyle = '#3d4423';
                utilityCtx.font = '10px Nunito';
                utilityCtx.textAlign = 'center';
                utilityCtx.fillText(mode.charAt(0), x + barWidth * 0.4, height - padding.bottom + 12);
            });

            // Axes
            utilityCtx.strokeStyle = '#606C38';
            utilityCtx.lineWidth = 1;
            utilityCtx.beginPath();
            utilityCtx.moveTo(padding.left, padding.top);
            utilityCtx.lineTo(padding.left, height - padding.bottom);
            utilityCtx.lineTo(width - padding.right, height - padding.bottom);
            utilityCtx.stroke();

            // Y label
            utilityCtx.fillStyle = '#3d4423';
            utilityCtx.font = '10px Nunito';
            utilityCtx.textAlign = 'right';
            utilityCtx.fillText('High', padding.left - 5, padding.top + 10);
            utilityCtx.fillText('Low', padding.left - 5, height - padding.bottom - 5);
        }

        // Animation loop
        function animate() {
            if (!running) return;

            step();
            draw();

            if (day < 365) {
                animationId = setTimeout(() => requestAnimationFrame(animate), 50);
            } else {
                running = false;
                document.getElementById('runBtn').textContent = '‚ñ∂ Run Simulation';
            }
        }

        // Event handlers
        document.getElementById('runBtn').addEventListener('click', () => {
            if (running) {
                running = false;
                clearTimeout(animationId);
                document.getElementById('runBtn').textContent = '‚ñ∂ Run Simulation';
            } else {
                if (day >= 365) {
                    initSimulation();
                }
                running = true;
                document.getElementById('runBtn').textContent = '‚è∏ Pause';
                animate();
            }
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            running = false;
            clearTimeout(animationId);
            document.getElementById('runBtn').textContent = '‚ñ∂ Run Simulation';
            initSimulation();
            draw();
        });

        // Parameter controls
        const controls = [
            { id: 'numAgents', param: 'numAgents', display: 'numAgentsValue', format: v => v },
            { id: 'avgIncome', param: 'avgIncome', display: 'avgIncomeValue', format: v => '$' + v + 'k' },
            { id: 'carOwnership', param: 'carOwnership', display: 'carOwnershipValue', format: v => v + '%', scale: 0.01 },
            { id: 'gasPrice', param: 'gasPrice', display: 'gasPriceValue', format: v => '$' + v.toFixed(2) },
            { id: 'parkingCost', param: 'parkingCost', display: 'parkingCostValue', format: v => '$' + v },
            { id: 'transitFare', param: 'transitFare', display: 'transitFareValue', format: v => '$' + v.toFixed(2) },
            { id: 'carTime', param: 'carTime', display: 'carTimeValue', format: v => v + ' min' },
            { id: 'transitTime', param: 'transitTime', display: 'transitTimeValue', format: v => v + ' min' },
            { id: 'bikeTime', param: 'bikeTime', display: 'bikeTimeValue', format: v => v + ' min' },
            { id: 'valueOfTime', param: 'valueOfTime', display: 'valueOfTimeValue', format: v => '$' + v },
            { id: 'habitStrength', param: 'habitStrength', display: 'habitStrengthValue', format: v => v.toFixed(2) }
        ];

        controls.forEach(ctrl => {
            const input = document.getElementById(ctrl.id);
            const display = document.getElementById(ctrl.display);

            input.addEventListener('input', () => {
                const val = parseFloat(input.value);
                display.textContent = ctrl.format(val);
                params[ctrl.param] = ctrl.scale ? val * ctrl.scale : val;
            });
        });

        // Initialize
        initSimulation();
        draw();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
