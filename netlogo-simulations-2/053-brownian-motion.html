<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brownian Motion - Mean Squared Displacement & Diffusion</title>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&family=Nunito:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --sage: #8A9A5B;
            --moss: #606C38;
            --earth: #DDA15E;
            --cream: #FEFAE0;
            --terracotta: #BC6C25;
            --dark-moss: #3d4423;
            --particle: #4A90D9;
            --tracer: #D94A4A;
            --fluid: #9B59B6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, #F4F1DE 50%, #EDE8D5 100%);
            min-height: 100vh;
            color: var(--dark-moss);
            padding: 20px;
        }

        .organic-back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            text-decoration: none;
            color: var(--moss);
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .organic-back-link:hover {
            background: var(--moss);
            color: white;
            transform: translateX(-5px);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding-top: 60px;
        }

        h1 {
            font-family: 'Lora', serif;
            font-size: 2.5rem;
            color: var(--moss);
            text-align: center;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: var(--terracotta);
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        .simulation-area {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }

        .controls {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            max-height: calc(100vh - 150px);
            overflow-y: auto;
        }

        .control-section {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(96, 108, 56, 0.2);
        }

        .control-section:last-child {
            border-bottom: none;
        }

        .control-section h3 {
            color: var(--moss);
            font-size: 1rem;
            margin-bottom: 12px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            font-weight: 600;
            color: var(--moss);
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .control-group input[type="range"] {
            width: 100%;
            accent-color: var(--moss);
        }

        .control-group .value {
            text-align: right;
            font-size: 0.85rem;
            color: var(--terracotta);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            accent-color: var(--moss);
            width: 18px;
            height: 18px;
        }

        button {
            width: 100%;
            padding: 12px;
            background: var(--moss);
            color: white;
            border: none;
            border-radius: 10px;
            font-family: 'Nunito', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        button:hover {
            background: var(--terracotta);
            transform: translateY(-2px);
        }

        button.secondary {
            background: var(--sage);
        }

        .main-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .dual-canvas {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .canvas-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        canvas {
            width: 100%;
            border-radius: 10px;
            background: #1a1a2e;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .stat-box {
            background: linear-gradient(135deg, var(--sage) 0%, var(--moss) 100%);
            color: white;
            padding: 12px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-box.msd {
            background: linear-gradient(135deg, #5BA3E8 0%, var(--particle) 100%);
        }

        .stat-box.diffusion {
            background: linear-gradient(135deg, #E85B5B 0%, var(--tracer) 100%);
        }

        .stat-box.einstein {
            background: linear-gradient(135deg, #A76BC4 0%, var(--fluid) 100%);
        }

        .stat-box .label {
            font-size: 0.75rem;
            opacity: 0.9;
        }

        .stat-box .value {
            font-size: 1.1rem;
            font-weight: 700;
            font-family: 'Lora', serif;
        }

        .physics-display {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .physics-display h4 {
            color: var(--moss);
            font-size: 1rem;
            margin-bottom: 10px;
            text-align: center;
        }

        .physics-row {
            display: flex;
            justify-content: space-around;
            text-align: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .physics-item {
            padding: 10px;
        }

        .physics-item .label {
            font-size: 0.8rem;
            color: var(--moss);
        }

        .physics-item .value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--terracotta);
            font-family: 'Lora', serif;
        }

        .info-panel {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .equation {
            font-family: 'Times New Roman', serif;
            font-size: 1rem;
            text-align: center;
            padding: 8px;
            background: rgba(96, 108, 56, 0.1);
            border-radius: 8px;
            margin: 8px 0;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        @media (max-width: 1100px) {
            .simulation-area {
                grid-template-columns: 1fr;
            }
            .dual-canvas {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <a href="index.html" class="organic-back-link">
        <span>←</span>
        <span>Back to Gallery</span>
    </a>

    <div class="container">
        <h1>Brownian Motion</h1>
        <p class="subtitle">Mean Squared Displacement, Diffusion Coefficient & Einstein Relation</p>

        <div class="simulation-area">
            <div class="controls">
                <div class="control-section">
                    <h3>Particle Properties</h3>
                    <div class="control-group">
                        <label>Tracer Particle Radius</label>
                        <input type="range" id="tracerRadius" min="5" max="20" step="1" value="10">
                        <div class="value" id="tracerRadiusValue">10 px</div>
                    </div>
                    <div class="control-group">
                        <label>Number of Fluid Particles</label>
                        <input type="range" id="numParticles" min="50" max="500" step="10" value="200">
                        <div class="value" id="numParticlesValue">200</div>
                    </div>
                    <div class="control-group">
                        <label>Fluid Particle Radius</label>
                        <input type="range" id="fluidRadius" min="2" max="8" step="1" value="3">
                        <div class="value" id="fluidRadiusValue">3 px</div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Physics Parameters</h3>
                    <div class="control-group">
                        <label>Temperature (K)</label>
                        <input type="range" id="temperature" min="100" max="500" step="10" value="300">
                        <div class="value" id="temperatureValue">300 K</div>
                    </div>
                    <div class="control-group">
                        <label>Viscosity (relative)</label>
                        <input type="range" id="viscosity" min="0.5" max="5" step="0.1" value="1">
                        <div class="value" id="viscosityValue">1.0</div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Visualization</h3>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showTrail" checked>
                        <label for="showTrail">Show Tracer Trail</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showCollisions">
                        <label for="showCollisions">Highlight Collisions</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showFluid" checked>
                        <label for="showFluid">Show Fluid Particles</label>
                    </div>
                    <div class="control-group">
                        <label>Trail Length</label>
                        <input type="range" id="trailLength" min="50" max="500" step="10" value="200">
                        <div class="value" id="trailLengthValue">200</div>
                    </div>
                </div>

                <button id="runBtn">▶ Run Simulation</button>
                <button id="resetBtn" class="secondary">Reset</button>

                <div class="info-panel">
                    <h3 style="color: var(--moss); margin-bottom: 8px;">Einstein Relation</h3>
                    <p>The mean squared displacement grows linearly with time:</p>
                    <div class="equation">⟨r²⟩ = 2dDt</div>
                    <p>where d=2 in 2D. The diffusion coefficient:</p>
                    <div class="equation">D = k_BT / (6πηr)</div>
                    <p>relates thermal energy to particle mobility.</p>
                </div>
            </div>

            <div class="main-area">
                <div class="dual-canvas">
                    <div class="canvas-container">
                        <canvas id="motionCanvas"></canvas>
                        <div class="legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--tracer);"></div>
                                <span>Tracer Particle</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: rgba(155, 89, 182, 0.6);"></div>
                                <span>Fluid Molecules</span>
                            </div>
                        </div>
                    </div>
                    <div class="canvas-container">
                        <canvas id="msdCanvas"></canvas>
                        <div class="legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--particle);"></div>
                                <span>MSD Data</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--terracotta);"></div>
                                <span>Linear Fit</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-box msd">
                        <div class="label">Mean Squared Disp.</div>
                        <div class="value" id="statMSD">0.00</div>
                    </div>
                    <div class="stat-box diffusion">
                        <div class="label">Diffusion Coeff. D</div>
                        <div class="value" id="statD">0.00</div>
                    </div>
                    <div class="stat-box einstein">
                        <div class="label">Einstein Pred. D</div>
                        <div class="value" id="statDTheory">0.00</div>
                    </div>
                    <div class="stat-box">
                        <div class="label">Time Steps</div>
                        <div class="value" id="statTime">0</div>
                    </div>
                </div>

                <div class="physics-display">
                    <h4>Physics Analysis</h4>
                    <div class="physics-row">
                        <div class="physics-item">
                            <div class="label">Collisions</div>
                            <div class="value" id="collisionCount">0</div>
                        </div>
                        <div class="physics-item">
                            <div class="label">Distance from Origin</div>
                            <div class="value" id="distOrigin">0.0</div>
                        </div>
                        <div class="physics-item">
                            <div class="label">√(MSD)</div>
                            <div class="value" id="rmsd">0.0</div>
                        </div>
                        <div class="physics-item">
                            <div class="label">R² (fit quality)</div>
                            <div class="value" id="rSquared">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Canvas setup
        const motionCanvas = document.getElementById('motionCanvas');
        const motionCtx = motionCanvas.getContext('2d');
        const msdCanvas = document.getElementById('msdCanvas');
        const msdCtx = msdCanvas.getContext('2d');

        let canvasWidth, canvasHeight;

        function setupCanvas(canvas, ctx) {
            const rect = canvas.parentElement.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            const size = Math.min(rect.width - 30, 400);
            canvas.width = size * dpr;
            canvas.height = size * dpr;
            canvas.style.width = size + 'px';
            canvas.style.height = size + 'px';
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.scale(dpr, dpr);
            return size;
        }

        function setupAllCanvases() {
            canvasWidth = setupCanvas(motionCanvas, motionCtx);
            canvasHeight = canvasWidth;
            setupCanvas(msdCanvas, msdCtx);
        }
        setupAllCanvases();
        window.addEventListener('resize', () => { setupAllCanvases(); initParticles(); draw(); });

        // Simulation state
        let tracer = { x: 0, y: 0, vx: 0, vy: 0, radius: 10 };
        let fluidParticles = [];
        let trail = [];
        let msdHistory = [];
        let timeStep = 0;
        let collisionCount = 0;
        let running = false;
        let animationId = null;
        let origin = { x: 0, y: 0 };

        // Parameters
        let tracerRadius = 10;
        let numParticles = 200;
        let fluidRadius = 3;
        let temperature = 300;
        let viscosity = 1;
        let showTrail = true;
        let showCollisions = false;
        let showFluid = true;
        let trailLength = 200;

        // Physics constants (scaled for visualization)
        const kB = 1.38e-23; // Boltzmann constant (not used directly, scaled)
        const scaleFactor = 0.1;

        // Initialize particles
        function initParticles() {
            const centerX = canvasWidth / 2;
            const centerY = canvasHeight / 2;

            tracer = {
                x: centerX,
                y: centerY,
                vx: 0,
                vy: 0,
                radius: tracerRadius,
                mass: tracerRadius * tracerRadius
            };
            origin = { x: centerX, y: centerY };

            // Initialize fluid particles with Maxwell-Boltzmann velocities
            fluidParticles = [];
            const speed = Math.sqrt(temperature / 300) * 3;

            for (let i = 0; i < numParticles; i++) {
                const angle = Math.random() * Math.PI * 2;
                const r = Math.random() * (canvasWidth / 2 - 20) + 20;
                const x = centerX + r * Math.cos(angle);
                const y = centerY + r * Math.sin(angle);

                const vAngle = Math.random() * Math.PI * 2;
                const vMag = speed * Math.sqrt(-2 * Math.log(Math.random())); // Maxwell-Boltzmann

                fluidParticles.push({
                    x: x,
                    y: y,
                    vx: vMag * Math.cos(vAngle),
                    vy: vMag * Math.sin(vAngle),
                    radius: fluidRadius,
                    mass: fluidRadius * fluidRadius
                });
            }

            trail = [{ x: tracer.x, y: tracer.y }];
            msdHistory = [{ t: 0, msd: 0 }];
            timeStep = 0;
            collisionCount = 0;
        }

        // Calculate theoretical diffusion coefficient (Einstein-Stokes)
        function theoreticalD() {
            // D = kT / (6πηr), scaled for our simulation
            const kT = temperature / 300 * 100; // Scaled thermal energy
            return kT / (6 * Math.PI * viscosity * tracerRadius) * scaleFactor;
        }

        // Calculate mean squared displacement
        function calculateMSD() {
            const dx = tracer.x - origin.x;
            const dy = tracer.y - origin.y;
            return dx * dx + dy * dy;
        }

        // Linear regression for diffusion coefficient
        function calculateDiffusion() {
            if (msdHistory.length < 10) return { D: 0, r2: 0 };

            // Use middle portion of MSD curve (avoid ballistic and noisy ends)
            const start = Math.floor(msdHistory.length * 0.1);
            const end = Math.floor(msdHistory.length * 0.8);
            const data = msdHistory.slice(start, end);

            if (data.length < 5) return { D: 0, r2: 0 };

            // Linear regression: MSD = 4Dt (for 2D)
            let sumT = 0, sumMSD = 0, sumT2 = 0, sumTMSD = 0;
            const n = data.length;

            for (const point of data) {
                sumT += point.t;
                sumMSD += point.msd;
                sumT2 += point.t * point.t;
                sumTMSD += point.t * point.msd;
            }

            const slope = (n * sumTMSD - sumT * sumMSD) / (n * sumT2 - sumT * sumT);
            const D = slope / 4; // MSD = 4Dt in 2D

            // Calculate R²
            const meanMSD = sumMSD / n;
            let ssTot = 0, ssRes = 0;
            const intercept = (sumMSD - slope * sumT) / n;

            for (const point of data) {
                ssTot += Math.pow(point.msd - meanMSD, 2);
                const predicted = slope * point.t + intercept;
                ssRes += Math.pow(point.msd - predicted, 2);
            }

            const r2 = ssTot > 0 ? 1 - ssRes / ssTot : 0;

            return { D: Math.max(0, D), r2: Math.max(0, r2), slope };
        }

        // Elastic collision between two particles
        function collide(p1, p2) {
            const dx = p2.x - p1.x;
            const dy = p2.y - p1.y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            const minDist = p1.radius + p2.radius;

            if (dist < minDist && dist > 0) {
                // Normal vector
                const nx = dx / dist;
                const ny = dy / dist;

                // Relative velocity
                const dvx = p1.vx - p2.vx;
                const dvy = p1.vy - p2.vy;

                // Relative velocity along normal
                const dvn = dvx * nx + dvy * ny;

                // Don't collide if moving apart
                if (dvn > 0) return false;

                // Collision impulse (elastic)
                const m1 = p1.mass;
                const m2 = p2.mass;
                const impulse = 2 * dvn / (m1 + m2);

                // Apply impulse
                p1.vx -= impulse * m2 * nx;
                p1.vy -= impulse * m2 * ny;
                p2.vx += impulse * m1 * nx;
                p2.vy += impulse * m1 * ny;

                // Separate particles
                const overlap = minDist - dist;
                const separationRatio = overlap / 2;
                p1.x -= separationRatio * nx;
                p1.y -= separationRatio * ny;
                p2.x += separationRatio * nx;
                p2.y += separationRatio * ny;

                return true;
            }
            return false;
        }

        // Simulation step
        function step() {
            timeStep++;
            const dt = 1 / viscosity; // Time step scaled by viscosity

            // Update fluid particles
            for (const p of fluidParticles) {
                p.x += p.vx * dt;
                p.y += p.vy * dt;

                // Bounce off walls
                if (p.x < p.radius) { p.x = p.radius; p.vx = -p.vx; }
                if (p.x > canvasWidth - p.radius) { p.x = canvasWidth - p.radius; p.vx = -p.vx; }
                if (p.y < p.radius) { p.y = p.radius; p.vy = -p.vy; }
                if (p.y > canvasHeight - p.radius) { p.y = canvasHeight - p.radius; p.vy = -p.vy; }
            }

            // Tracer moves due to collisions (Brownian motion)
            tracer.x += tracer.vx * dt;
            tracer.y += tracer.vy * dt;

            // Apply viscous drag
            const drag = 0.99;
            tracer.vx *= drag;
            tracer.vy *= drag;

            // Bounce off walls
            if (tracer.x < tracer.radius) { tracer.x = tracer.radius; tracer.vx = -tracer.vx; }
            if (tracer.x > canvasWidth - tracer.radius) { tracer.x = canvasWidth - tracer.radius; tracer.vx = -tracer.vx; }
            if (tracer.y < tracer.radius) { tracer.y = tracer.radius; tracer.vy = -tracer.vy; }
            if (tracer.y > canvasHeight - tracer.radius) { tracer.y = canvasHeight - tracer.radius; tracer.vy = -tracer.vy; }

            // Check collisions between tracer and fluid particles
            for (const p of fluidParticles) {
                if (collide(tracer, p)) {
                    collisionCount++;
                }
            }

            // Check collisions between fluid particles (optional, for realism)
            for (let i = 0; i < fluidParticles.length; i++) {
                for (let j = i + 1; j < fluidParticles.length; j++) {
                    collide(fluidParticles[i], fluidParticles[j]);
                }
            }

            // Record trail
            trail.push({ x: tracer.x, y: tracer.y });
            if (trail.length > trailLength) trail.shift();

            // Record MSD
            const msd = calculateMSD();
            msdHistory.push({ t: timeStep, msd: msd });
            if (msdHistory.length > 1000) msdHistory.shift();

            updateStats();
        }

        // Update statistics display
        function updateStats() {
            const msd = calculateMSD();
            const { D, r2 } = calculateDiffusion();
            const Dtheory = theoreticalD();

            document.getElementById('statMSD').textContent = msd.toFixed(1);
            document.getElementById('statD').textContent = D.toFixed(4);
            document.getElementById('statDTheory').textContent = Dtheory.toFixed(4);
            document.getElementById('statTime').textContent = timeStep;

            document.getElementById('collisionCount').textContent = collisionCount;
            document.getElementById('distOrigin').textContent = Math.sqrt(msd).toFixed(1);
            document.getElementById('rmsd').textContent = Math.sqrt(msd).toFixed(1);
            document.getElementById('rSquared').textContent = r2 > 0 ? r2.toFixed(3) : '-';
        }

        // Draw motion canvas
        function drawMotion() {
            motionCtx.fillStyle = '#1a1a2e';
            motionCtx.fillRect(0, 0, canvasWidth, canvasHeight);

            // Draw origin marker
            motionCtx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
            motionCtx.lineWidth = 1;
            motionCtx.beginPath();
            motionCtx.moveTo(origin.x - 10, origin.y);
            motionCtx.lineTo(origin.x + 10, origin.y);
            motionCtx.moveTo(origin.x, origin.y - 10);
            motionCtx.lineTo(origin.x, origin.y + 10);
            motionCtx.stroke();

            // Draw trail
            if (showTrail && trail.length > 1) {
                motionCtx.beginPath();
                motionCtx.moveTo(trail[0].x, trail[0].y);
                for (let i = 1; i < trail.length; i++) {
                    const alpha = i / trail.length;
                    motionCtx.strokeStyle = `rgba(217, 74, 74, ${alpha * 0.8})`;
                    motionCtx.lineWidth = 1 + alpha;
                    motionCtx.beginPath();
                    motionCtx.moveTo(trail[i-1].x, trail[i-1].y);
                    motionCtx.lineTo(trail[i].x, trail[i].y);
                    motionCtx.stroke();
                }
            }

            // Draw fluid particles
            if (showFluid) {
                motionCtx.fillStyle = 'rgba(155, 89, 182, 0.6)';
                for (const p of fluidParticles) {
                    motionCtx.beginPath();
                    motionCtx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    motionCtx.fill();
                }
            }

            // Draw tracer particle
            motionCtx.fillStyle = '#D94A4A';
            motionCtx.beginPath();
            motionCtx.arc(tracer.x, tracer.y, tracer.radius, 0, Math.PI * 2);
            motionCtx.fill();

            motionCtx.strokeStyle = 'white';
            motionCtx.lineWidth = 2;
            motionCtx.stroke();

            // Title
            motionCtx.fillStyle = 'white';
            motionCtx.font = 'bold 14px Lora';
            motionCtx.fillText('Brownian Motion', 10, 20);
        }

        // Draw MSD canvas
        function drawMSD() {
            const width = canvasWidth;
            const height = canvasHeight;
            const padding = { top: 35, right: 15, bottom: 35, left: 50 };
            const plotWidth = width - padding.left - padding.right;
            const plotHeight = height - padding.top - padding.bottom;

            msdCtx.fillStyle = '#FEFAE0';
            msdCtx.fillRect(0, 0, width, height);

            // Grid
            msdCtx.strokeStyle = '#E0DCC8';
            msdCtx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding.top + (plotHeight * i / 5);
                msdCtx.beginPath();
                msdCtx.moveTo(padding.left, y);
                msdCtx.lineTo(width - padding.right, y);
                msdCtx.stroke();
            }

            // Axes
            msdCtx.strokeStyle = '#606C38';
            msdCtx.lineWidth = 2;
            msdCtx.beginPath();
            msdCtx.moveTo(padding.left, padding.top);
            msdCtx.lineTo(padding.left, height - padding.bottom);
            msdCtx.lineTo(width - padding.right, height - padding.bottom);
            msdCtx.stroke();

            // Labels
            msdCtx.fillStyle = '#3d4423';
            msdCtx.font = '11px Nunito';
            msdCtx.textAlign = 'center';
            msdCtx.fillText('Time', width / 2, height - 8);

            msdCtx.save();
            msdCtx.translate(12, height / 2);
            msdCtx.rotate(-Math.PI / 2);
            msdCtx.fillText('MSD', 0, 0);
            msdCtx.restore();

            if (msdHistory.length < 2) {
                msdCtx.fillStyle = '#606C38';
                msdCtx.font = 'bold 14px Lora';
                msdCtx.textAlign = 'left';
                msdCtx.fillText('Mean Squared Displacement', padding.left, 22);
                return;
            }

            // Calculate ranges
            const maxT = msdHistory[msdHistory.length - 1].t;
            const maxMSD = Math.max(...msdHistory.map(p => p.msd)) * 1.1 || 1;

            // Y-axis ticks
            msdCtx.textAlign = 'right';
            msdCtx.font = '10px Nunito';
            for (let i = 0; i <= 5; i++) {
                const y = padding.top + (plotHeight * i / 5);
                const val = (maxMSD * (5 - i) / 5);
                msdCtx.fillText(val.toFixed(0), padding.left - 5, y + 3);
            }

            // Draw MSD data points
            msdCtx.strokeStyle = '#4A90D9';
            msdCtx.lineWidth = 2;
            msdCtx.beginPath();

            for (let i = 0; i < msdHistory.length; i++) {
                const x = padding.left + plotWidth * msdHistory[i].t / maxT;
                const y = padding.top + plotHeight * (1 - msdHistory[i].msd / maxMSD);

                if (i === 0) msdCtx.moveTo(x, y);
                else msdCtx.lineTo(x, y);
            }
            msdCtx.stroke();

            // Draw linear fit
            const { D, slope } = calculateDiffusion();
            if (D > 0 && slope > 0) {
                msdCtx.strokeStyle = '#BC6C25';
                msdCtx.lineWidth = 2;
                msdCtx.setLineDash([5, 5]);
                msdCtx.beginPath();

                const x1 = padding.left;
                const y1 = padding.top + plotHeight;
                const x2 = padding.left + plotWidth;
                const msd2 = slope * maxT;
                const y2 = padding.top + plotHeight * (1 - Math.min(msd2, maxMSD) / maxMSD);

                msdCtx.moveTo(x1, y1);
                msdCtx.lineTo(x2, y2);
                msdCtx.stroke();
                msdCtx.setLineDash([]);
            }

            // Title
            msdCtx.fillStyle = '#606C38';
            msdCtx.font = 'bold 14px Lora';
            msdCtx.textAlign = 'left';
            msdCtx.fillText('Mean Squared Displacement', padding.left, 22);
        }

        function draw() {
            drawMotion();
            drawMSD();
        }

        // Animation loop
        function animate() {
            if (!running) return;

            for (let i = 0; i < 3; i++) step();
            draw();

            animationId = requestAnimationFrame(animate);
        }

        // Event handlers
        document.getElementById('runBtn').addEventListener('click', () => {
            if (running) {
                running = false;
                cancelAnimationFrame(animationId);
                document.getElementById('runBtn').textContent = '▶ Run Simulation';
            } else {
                running = true;
                document.getElementById('runBtn').textContent = '⏸ Pause';
                animate();
            }
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            running = false;
            cancelAnimationFrame(animationId);
            document.getElementById('runBtn').textContent = '▶ Run Simulation';
            initParticles();
            draw();
        });

        // Parameter controls
        document.getElementById('tracerRadius').addEventListener('input', function() {
            tracerRadius = parseInt(this.value);
            document.getElementById('tracerRadiusValue').textContent = tracerRadius + ' px';
        });

        document.getElementById('numParticles').addEventListener('input', function() {
            numParticles = parseInt(this.value);
            document.getElementById('numParticlesValue').textContent = numParticles;
        });

        document.getElementById('fluidRadius').addEventListener('input', function() {
            fluidRadius = parseInt(this.value);
            document.getElementById('fluidRadiusValue').textContent = fluidRadius + ' px';
        });

        document.getElementById('temperature').addEventListener('input', function() {
            temperature = parseInt(this.value);
            document.getElementById('temperatureValue').textContent = temperature + ' K';
        });

        document.getElementById('viscosity').addEventListener('input', function() {
            viscosity = parseFloat(this.value);
            document.getElementById('viscosityValue').textContent = viscosity.toFixed(1);
        });

        document.getElementById('showTrail').addEventListener('change', function() {
            showTrail = this.checked;
            draw();
        });

        document.getElementById('showCollisions').addEventListener('change', function() {
            showCollisions = this.checked;
        });

        document.getElementById('showFluid').addEventListener('change', function() {
            showFluid = this.checked;
            draw();
        });

        document.getElementById('trailLength').addEventListener('input', function() {
            trailLength = parseInt(this.value);
            document.getElementById('trailLengthValue').textContent = trailLength;
        });

        // Initialize
        initParticles();
        draw();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
