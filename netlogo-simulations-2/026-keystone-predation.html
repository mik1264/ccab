<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keystone Predation - NetLogo Simulation</title>
    <style>
        :root {
            --sage: #8A9A5B;
            --moss: #606C38;
            --earth: #DDA15E;
            --cream: #FEFAE0;
            --terracotta: #BC6C25;
            --dark-moss: #3d4423;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, #f5f5dc 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            color: var(--dark-moss);
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .subtitle {
            color: var(--moss);
            font-size: 1rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 20px;
        }

        .control-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .control-group {
            margin-bottom: 16px;
        }

        .control-group label {
            display: block;
            color: var(--dark-moss);
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.85rem;
        }

        .control-group input[type="range"] {
            width: 100%;
            accent-color: var(--sage);
        }

        .control-group select {
            width: 100%;
            padding: 8px;
            border: 2px solid var(--sage);
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .value-display {
            text-align: right;
            color: var(--moss);
            font-size: 0.8rem;
            margin-top: 3px;
        }

        .buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            min-width: 70px;
            padding: 10px 12px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
        }

        .btn-primary {
            background: var(--sage);
            color: white;
        }

        .btn-primary:hover {
            background: var(--moss);
        }

        .btn-secondary {
            background: var(--earth);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--terracotta);
        }

        .btn-danger {
            background: #d32f2f;
            color: white;
        }

        .btn-danger:hover {
            background: #b71c1c;
        }

        .visualization-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 15px;
        }

        .viz-panel {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .viz-panel h3 {
            color: var(--dark-moss);
            font-size: 0.9rem;
            margin-bottom: 10px;
            text-align: center;
        }

        canvas {
            width: 100%;
            height: 250px;
            border-radius: 8px;
            background: #1a1a2e;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 15px;
        }

        .stat-item {
            background: var(--cream);
            padding: 8px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--terracotta);
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--moss);
        }

        .info-box {
            background: linear-gradient(135deg, var(--cream) 0%, #fff 100%);
            border-left: 4px solid var(--sage);
            padding: 12px;
            margin-top: 15px;
            border-radius: 0 8px 8px 0;
            font-size: 0.8rem;
            color: var(--dark-moss);
        }

        .back-link {
            display: inline-block;
            margin-bottom: 15px;
            color: var(--moss);
            text-decoration: none;
            font-weight: 500;
        }

        .back-link:hover {
            color: var(--terracotta);
        }

        .keystone-status {
            text-align: center;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .keystone-present {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .keystone-absent {
            background: #ffcdd2;
            color: #c62828;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">← Back to Simulations</a>

        <header>
            <h1>Keystone Predation</h1>
            <p class="subtitle">Trophic Cascades, Competitive Exclusion & Alternative Stable States</p>
        </header>

        <div class="main-content">
            <div class="control-panel">
                <div class="keystone-status keystone-present" id="keystoneStatus">
                    ★ Keystone Predator Present
                </div>

                <div class="control-group">
                    <label>Initial Prey Species</label>
                    <input type="range" id="preySpecies" min="3" max="8" value="5">
                    <div class="value-display" id="preySpeciesVal">5 species</div>
                </div>

                <div class="control-group">
                    <label>Keystone Predation Rate</label>
                    <input type="range" id="predationRate" min="5" max="50" value="25">
                    <div class="value-display" id="predationRateVal">25%</div>
                </div>

                <div class="control-group">
                    <label>Dominant Competitor Strength</label>
                    <input type="range" id="competitorStrength" min="20" max="80" value="50">
                    <div class="value-display" id="competitorStrengthVal">50%</div>
                </div>

                <div class="control-group">
                    <label>Resource Regeneration</label>
                    <input type="range" id="resourceRegen" min="10" max="100" value="50">
                    <div class="value-display" id="resourceRegenVal">50</div>
                </div>

                <div class="control-group">
                    <label>Competition Intensity</label>
                    <input type="range" id="competition" min="10" max="100" value="60">
                    <div class="value-display" id="competitionVal">60%</div>
                </div>

                <div class="control-group">
                    <label>Ecosystem Type</label>
                    <select id="ecosystemType">
                        <option value="intertidal">Intertidal (Paine's starfish)</option>
                        <option value="kelp">Kelp Forest (Otter-Urchin)</option>
                        <option value="savanna">Savanna (Lion-Herbivore)</option>
                    </select>
                </div>

                <div class="buttons">
                    <button class="btn-primary" id="startBtn">Start</button>
                    <button class="btn-secondary" id="resetBtn">Reset</button>
                    <button class="btn-danger" id="removeBtn">Remove Keystone</button>
                </div>

                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="speciesDiversity">0</div>
                        <div class="stat-label">Species Diversity</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="dominantPop">0%</div>
                        <div class="stat-label">Dominant %</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="keystonePop">0</div>
                        <div class="stat-label">Keystone Pop</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="ecosystemState">Stable</div>
                        <div class="stat-label">State</div>
                    </div>
                </div>

                <div class="info-box">
                    <strong>Paine's Discovery:</strong> Removing starfish caused mussels to
                    dominate, cutting biodiversity in half. The keystone prevents competitive
                    exclusion by preferentially consuming the dominant competitor.
                </div>
            </div>

            <div class="visualization-area">
                <div class="viz-panel">
                    <h3>Ecosystem Arena</h3>
                    <canvas id="arenaCanvas"></canvas>
                </div>

                <div class="viz-panel">
                    <h3>Species Abundance Over Time</h3>
                    <canvas id="abundanceCanvas"></canvas>
                </div>

                <div class="viz-panel">
                    <h3>Trophic Web</h3>
                    <canvas id="webCanvas"></canvas>
                </div>

                <div class="viz-panel">
                    <h3>Biodiversity Index</h3>
                    <canvas id="diversityCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Canvas setup
        const arenaCanvas = document.getElementById('arenaCanvas');
        const abundanceCanvas = document.getElementById('abundanceCanvas');
        const webCanvas = document.getElementById('webCanvas');
        const diversityCanvas = document.getElementById('diversityCanvas');

        const arenaCtx = arenaCanvas.getContext('2d');
        const abundanceCtx = abundanceCanvas.getContext('2d');
        const webCtx = webCanvas.getContext('2d');
        const diversityCtx = diversityCanvas.getContext('2d');

        function resizeCanvases() {
            [arenaCanvas, abundanceCanvas, webCanvas, diversityCanvas].forEach(canvas => {
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width * window.devicePixelRatio;
                canvas.height = rect.height * window.devicePixelRatio;
                canvas.getContext('2d').scale(window.devicePixelRatio, window.devicePixelRatio);
            });
        }
        resizeCanvases();
        window.addEventListener('resize', resizeCanvases);

        // Simulation state
        let running = false;
        let tick = 0;
        let keystonePresent = true;
        let keystonePredators = [];
        let preyPopulations = [];
        let resources = [];
        let history = [];
        let removalTick = -1;

        // Species colors
        const speciesColors = [
            '#e91e63', // Dominant (pink/mussel)
            '#4CAF50', // Green
            '#2196F3', // Blue
            '#ff9800', // Orange
            '#9c27b0', // Purple
            '#00bcd4', // Cyan
            '#ffeb3b', // Yellow
            '#795548'  // Brown
        ];

        class KeystonePredator {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.energy = 100;
                this.age = 0;
            }

            update(prey, params) {
                const w = arenaCanvas.width / window.devicePixelRatio;
                const h = arenaCanvas.height / window.devicePixelRatio;

                // Hunt preferentially for dominant species
                let target = null;
                let minDist = 80;

                // Sort prey by species population (prefer abundant species)
                const speciesCounts = {};
                prey.forEach(p => {
                    speciesCounts[p.species] = (speciesCounts[p.species] || 0) + 1;
                });

                prey.forEach(p => {
                    const dist = Math.hypot(p.x - this.x, p.y - this.y);
                    // Prefer dominant species (higher count = higher priority)
                    const priority = speciesCounts[p.species] || 1;
                    const adjustedDist = dist / Math.sqrt(priority);

                    if (adjustedDist < minDist) {
                        minDist = adjustedDist;
                        target = p;
                    }
                });

                if (target) {
                    // Move towards target
                    const dx = target.x - this.x;
                    const dy = target.y - this.y;
                    const dist = Math.hypot(dx, dy);

                    if (dist > 5) {
                        this.x += (dx / dist) * 1.5;
                        this.y += (dy / dist) * 1.5;
                    }

                    // Hunt
                    if (dist < 15 && Math.random() < params.predationRate / 100) {
                        target.alive = false;
                        this.energy += 30;
                    }
                } else {
                    // Random movement
                    this.x += (Math.random() - 0.5) * 3;
                    this.y += (Math.random() - 0.5) * 3;
                }

                // Energy decay
                this.energy -= 0.5;
                this.age++;

                // Bounds
                this.x = Math.max(20, Math.min(w - 20, this.x));
                this.y = Math.max(20, Math.min(h - 20, this.y));
            }
        }

        class Prey {
            constructor(x, y, species, competitiveAbility) {
                this.x = x;
                this.y = y;
                this.species = species;
                this.competitiveAbility = competitiveAbility;
                this.energy = 50 + Math.random() * 50;
                this.alive = true;
                this.age = 0;
            }

            update(resources, allPrey, params) {
                if (!this.alive) return;

                const w = arenaCanvas.width / window.devicePixelRatio;
                const h = arenaCanvas.height / window.devicePixelRatio;

                // Movement
                this.x += (Math.random() - 0.5) * 2;
                this.y += (Math.random() - 0.5) * 2;

                // Bounds
                this.x = Math.max(10, Math.min(w - 10, this.x));
                this.y = Math.max(10, Math.min(h - 10, this.y));

                // Foraging
                resources.forEach(r => {
                    const dist = Math.hypot(r.x - this.x, r.y - this.y);
                    if (dist < 20 && r.value > 0) {
                        // Competitive ability affects resource gain
                        const gained = Math.min(r.value, 2 * this.competitiveAbility);
                        r.value -= gained;
                        this.energy += gained;
                    }
                });

                // Competition with nearby individuals
                allPrey.forEach(other => {
                    if (other === this || !other.alive) return;

                    const dist = Math.hypot(other.x - this.x, other.y - this.y);
                    if (dist < 15) {
                        // Competition based on competitive ability
                        const compStrength = params.competition / 100;
                        if (this.competitiveAbility > other.competitiveAbility) {
                            other.energy -= compStrength * 2;
                            this.energy += compStrength;
                        } else if (this.competitiveAbility < other.competitiveAbility) {
                            this.energy -= compStrength * 2;
                        }
                    }
                });

                // Energy decay
                this.energy -= 0.3;
                this.age++;

                if (this.energy <= 0) {
                    this.alive = false;
                }
            }
        }

        function initSimulation() {
            const numSpecies = parseInt(document.getElementById('preySpecies').value);
            const competitorStrength = parseInt(document.getElementById('competitorStrength').value) / 100;

            keystonePresent = true;
            keystonePredators = [];
            preyPopulations = [];
            resources = [];
            history = [];
            tick = 0;
            removalTick = -1;

            updateKeystoneStatus();

            const w = arenaCanvas.width / window.devicePixelRatio;
            const h = arenaCanvas.height / window.devicePixelRatio;

            // Create keystone predators
            for (let i = 0; i < 5; i++) {
                keystonePredators.push(new KeystonePredator(
                    Math.random() * w,
                    Math.random() * h
                ));
            }

            // Create prey species with varying competitive abilities
            for (let s = 0; s < numSpecies; s++) {
                // Species 0 is the dominant competitor
                const competitiveAbility = s === 0 ?
                    0.5 + competitorStrength * 0.5 :
                    0.3 + Math.random() * 0.4;

                const popSize = 15 + Math.floor(Math.random() * 10);

                for (let i = 0; i < popSize; i++) {
                    preyPopulations.push(new Prey(
                        Math.random() * w,
                        Math.random() * h,
                        s,
                        competitiveAbility
                    ));
                }
            }

            // Create resource patches
            for (let i = 0; i < 30; i++) {
                resources.push({
                    x: Math.random() * w,
                    y: Math.random() * h,
                    value: 10 + Math.random() * 20,
                    maxValue: 30
                });
            }
        }

        function getParams() {
            return {
                predationRate: parseInt(document.getElementById('predationRate').value),
                competitorStrength: parseInt(document.getElementById('competitorStrength').value),
                resourceRegen: parseInt(document.getElementById('resourceRegen').value),
                competition: parseInt(document.getElementById('competition').value),
                ecosystemType: document.getElementById('ecosystemType').value
            };
        }

        function updateKeystoneStatus() {
            const status = document.getElementById('keystoneStatus');
            if (keystonePresent) {
                status.className = 'keystone-status keystone-present';
                status.textContent = '★ Keystone Predator Present';
            } else {
                status.className = 'keystone-status keystone-absent';
                status.textContent = '✕ Keystone Removed (Tick ' + removalTick + ')';
            }
        }

        function simulationStep() {
            const params = getParams();
            tick++;

            const w = arenaCanvas.width / window.devicePixelRatio;
            const h = arenaCanvas.height / window.devicePixelRatio;

            // Update keystone predators
            if (keystonePresent) {
                keystonePredators.forEach(p => p.update(preyPopulations.filter(pr => pr.alive), params));

                // Remove dead predators
                keystonePredators = keystonePredators.filter(p => p.energy > 0);

                // Predator reproduction
                if (tick % 100 === 0 && keystonePredators.length > 0 && keystonePredators.length < 10) {
                    const parent = keystonePredators[Math.floor(Math.random() * keystonePredators.length)];
                    if (parent.energy > 80) {
                        keystonePredators.push(new KeystonePredator(
                            parent.x + (Math.random() - 0.5) * 30,
                            parent.y + (Math.random() - 0.5) * 30
                        ));
                        parent.energy -= 30;
                    }
                }
            }

            // Update prey
            const alivePrey = preyPopulations.filter(p => p.alive);
            alivePrey.forEach(p => p.update(resources, alivePrey, params));

            // Remove dead prey
            preyPopulations = preyPopulations.filter(p => p.alive);

            // Prey reproduction
            if (tick % 30 === 0) {
                const numSpecies = parseInt(document.getElementById('preySpecies').value);
                const speciesCounts = {};

                preyPopulations.forEach(p => {
                    speciesCounts[p.species] = (speciesCounts[p.species] || 0) + 1;
                });

                // Each species reproduces based on population and energy
                for (let s = 0; s < numSpecies; s++) {
                    const speciesMembers = preyPopulations.filter(p => p.species === s && p.energy > 60);

                    speciesMembers.forEach(parent => {
                        if (Math.random() < 0.3 && preyPopulations.length < 400) {
                            const child = new Prey(
                                parent.x + (Math.random() - 0.5) * 20,
                                parent.y + (Math.random() - 0.5) * 20,
                                s,
                                parent.competitiveAbility + (Math.random() - 0.5) * 0.05
                            );
                            child.x = Math.max(10, Math.min(w - 10, child.x));
                            child.y = Math.max(10, Math.min(h - 10, child.y));
                            preyPopulations.push(child);
                            parent.energy -= 20;
                        }
                    });
                }
            }

            // Resource regeneration
            resources.forEach(r => {
                if (r.value < r.maxValue) {
                    r.value += params.resourceRegen / 500;
                }
            });

            // Record history
            if (tick % 5 === 0) {
                const numSpecies = parseInt(document.getElementById('preySpecies').value);
                const speciesCounts = new Array(numSpecies).fill(0);

                preyPopulations.forEach(p => {
                    if (p.species < numSpecies) {
                        speciesCounts[p.species]++;
                    }
                });

                // Shannon diversity index
                const total = speciesCounts.reduce((a, b) => a + b, 0) || 1;
                let shannon = 0;
                speciesCounts.forEach(c => {
                    if (c > 0) {
                        const p = c / total;
                        shannon -= p * Math.log(p);
                    }
                });

                // Species richness (count of species with >0 individuals)
                const richness = speciesCounts.filter(c => c > 0).length;

                history.push({
                    speciesCounts: [...speciesCounts],
                    diversity: shannon,
                    richness,
                    keystoneCount: keystonePredators.length,
                    tick
                });
                if (history.length > 300) history.shift();
            }

            updateStats();
        }

        function updateStats() {
            const numSpecies = parseInt(document.getElementById('preySpecies').value);
            const speciesCounts = new Array(numSpecies).fill(0);

            preyPopulations.forEach(p => {
                if (p.species < numSpecies) {
                    speciesCounts[p.species]++;
                }
            });

            const total = speciesCounts.reduce((a, b) => a + b, 0) || 1;
            const richness = speciesCounts.filter(c => c > 0).length;
            const dominantPop = Math.max(...speciesCounts) / total * 100;

            // Shannon diversity
            let shannon = 0;
            speciesCounts.forEach(c => {
                if (c > 0) {
                    const p = c / total;
                    shannon -= p * Math.log(p);
                }
            });

            document.getElementById('speciesDiversity').textContent = richness;
            document.getElementById('dominantPop').textContent = dominantPop.toFixed(0) + '%';
            document.getElementById('keystonePop').textContent = keystonePredators.length;

            // Determine ecosystem state
            let state = 'Diverse';
            if (dominantPop > 70) state = 'Monopoly';
            else if (richness === 1) state = 'Collapsed';
            else if (richness < numSpecies / 2) state = 'Degraded';

            document.getElementById('ecosystemState').textContent = state;
        }

        function draw() {
            drawArena();
            drawAbundance();
            drawTrophicWeb();
            drawDiversity();
        }

        function drawArena() {
            const w = arenaCanvas.width / window.devicePixelRatio;
            const h = arenaCanvas.height / window.devicePixelRatio;

            arenaCtx.fillStyle = '#1a1a2e';
            arenaCtx.fillRect(0, 0, w, h);

            // Draw resources
            resources.forEach(r => {
                const alpha = r.value / r.maxValue;
                arenaCtx.fillStyle = `rgba(139, 195, 74, ${alpha})`;
                arenaCtx.beginPath();
                arenaCtx.arc(r.x, r.y, 4, 0, Math.PI * 2);
                arenaCtx.fill();
            });

            // Draw prey by species
            preyPopulations.forEach(prey => {
                arenaCtx.fillStyle = speciesColors[prey.species % speciesColors.length];
                arenaCtx.beginPath();
                arenaCtx.arc(prey.x, prey.y, 4, 0, Math.PI * 2);
                arenaCtx.fill();
            });

            // Draw keystone predators
            keystonePredators.forEach(p => {
                arenaCtx.fillStyle = '#ffeb3b';
                arenaCtx.beginPath();
                // Star shape
                const spikes = 5;
                const outerRadius = 10;
                const innerRadius = 5;
                for (let i = 0; i < spikes * 2; i++) {
                    const radius = i % 2 === 0 ? outerRadius : innerRadius;
                    const angle = (i * Math.PI / spikes) - Math.PI / 2;
                    const x = p.x + Math.cos(angle) * radius;
                    const y = p.y + Math.sin(angle) * radius;
                    if (i === 0) arenaCtx.moveTo(x, y);
                    else arenaCtx.lineTo(x, y);
                }
                arenaCtx.closePath();
                arenaCtx.fill();
            });

            // Legend
            arenaCtx.font = '10px sans-serif';
            arenaCtx.fillStyle = '#ffeb3b';
            arenaCtx.fillText('★ Keystone Predator', 10, h - 30);
            arenaCtx.fillStyle = speciesColors[0];
            arenaCtx.fillText('● Dominant Species', 10, h - 15);
        }

        function drawAbundance() {
            const w = abundanceCanvas.width / window.devicePixelRatio;
            const h = abundanceCanvas.height / window.devicePixelRatio;

            abundanceCtx.fillStyle = '#1a1a2e';
            abundanceCtx.fillRect(0, 0, w, h);

            if (history.length < 2) return;

            const padding = 40;
            const plotW = w - padding * 2;
            const plotH = h - padding * 2;

            // Axes
            abundanceCtx.strokeStyle = '#666';
            abundanceCtx.beginPath();
            abundanceCtx.moveTo(padding, padding);
            abundanceCtx.lineTo(padding, h - padding);
            abundanceCtx.lineTo(w - padding, h - padding);
            abundanceCtx.stroke();

            // Find max
            let maxPop = 1;
            history.forEach(d => {
                d.speciesCounts.forEach(c => {
                    if (c > maxPop) maxPop = c;
                });
            });

            // Draw removal line if applicable
            if (removalTick > 0) {
                const removalIdx = history.findIndex(d => d.tick >= removalTick);
                if (removalIdx >= 0) {
                    const removalX = padding + (removalIdx / (history.length - 1)) * plotW;
                    abundanceCtx.strokeStyle = '#f44336';
                    abundanceCtx.setLineDash([5, 5]);
                    abundanceCtx.beginPath();
                    abundanceCtx.moveTo(removalX, padding);
                    abundanceCtx.lineTo(removalX, h - padding);
                    abundanceCtx.stroke();
                    abundanceCtx.setLineDash([]);
                    abundanceCtx.fillStyle = '#f44336';
                    abundanceCtx.font = '9px sans-serif';
                    abundanceCtx.fillText('Removal', removalX + 3, padding + 10);
                }
            }

            // Draw species lines
            const numSpecies = history[0].speciesCounts.length;
            for (let s = 0; s < numSpecies; s++) {
                abundanceCtx.strokeStyle = speciesColors[s % speciesColors.length];
                abundanceCtx.lineWidth = s === 0 ? 2.5 : 1.5;
                abundanceCtx.beginPath();

                history.forEach((d, i) => {
                    const x = padding + (i / (history.length - 1)) * plotW;
                    const y = h - padding - (d.speciesCounts[s] / maxPop) * plotH;
                    if (i === 0) abundanceCtx.moveTo(x, y);
                    else abundanceCtx.lineTo(x, y);
                });
                abundanceCtx.stroke();
            }

            // Labels
            abundanceCtx.fillStyle = '#aaa';
            abundanceCtx.font = '10px sans-serif';
            abundanceCtx.fillText('Population', 5, h / 2);
            abundanceCtx.fillText('Time', w / 2 - 10, h - 5);
        }

        function drawTrophicWeb() {
            const w = webCanvas.width / window.devicePixelRatio;
            const h = webCanvas.height / window.devicePixelRatio;

            webCtx.fillStyle = '#1a1a2e';
            webCtx.fillRect(0, 0, w, h);

            const numSpecies = parseInt(document.getElementById('preySpecies').value);
            const speciesCounts = new Array(numSpecies).fill(0);
            preyPopulations.forEach(p => {
                if (p.species < numSpecies) speciesCounts[p.species]++;
            });

            const total = speciesCounts.reduce((a, b) => a + b, 0) || 1;

            // Draw trophic levels
            // Level 1: Resources (bottom)
            // Level 2: Prey species (middle)
            // Level 3: Keystone predator (top)

            const centerX = w / 2;

            // Resources (bottom)
            webCtx.fillStyle = '#8BC34A';
            webCtx.beginPath();
            webCtx.ellipse(centerX, h - 40, 60, 20, 0, 0, Math.PI * 2);
            webCtx.fill();
            webCtx.fillStyle = '#fff';
            webCtx.font = '10px sans-serif';
            webCtx.fillText('Resources', centerX - 25, h - 35);

            // Prey species (middle)
            const speciesY = h / 2 + 20;
            const speciesSpacing = (w - 60) / (numSpecies + 1);

            for (let s = 0; s < numSpecies; s++) {
                const x = 30 + (s + 1) * speciesSpacing;
                const size = 10 + (speciesCounts[s] / total) * 30;

                // Link to resources
                webCtx.strokeStyle = 'rgba(139, 195, 74, 0.3)';
                webCtx.lineWidth = speciesCounts[s] / total * 5;
                webCtx.beginPath();
                webCtx.moveTo(x, speciesY);
                webCtx.lineTo(centerX, h - 50);
                webCtx.stroke();

                // Species node
                webCtx.fillStyle = speciesColors[s % speciesColors.length];
                webCtx.beginPath();
                webCtx.arc(x, speciesY, size, 0, Math.PI * 2);
                webCtx.fill();

                // Label
                webCtx.fillStyle = '#fff';
                webCtx.font = '9px sans-serif';
                webCtx.fillText(`S${s + 1}`, x - 7, speciesY + 4);
            }

            // Keystone predator (top)
            if (keystonePresent && keystonePredators.length > 0) {
                // Links from predator to prey (thicker for dominant species)
                for (let s = 0; s < numSpecies; s++) {
                    const x = 30 + (s + 1) * speciesSpacing;
                    // Predator targets dominant species more
                    const linkStrength = s === 0 ? 0.7 : 0.3;

                    webCtx.strokeStyle = `rgba(255, 235, 59, ${linkStrength})`;
                    webCtx.lineWidth = linkStrength * 3;
                    webCtx.beginPath();
                    webCtx.moveTo(centerX, 50);
                    webCtx.lineTo(x, speciesY - 15);
                    webCtx.stroke();
                }

                // Predator node
                webCtx.fillStyle = '#ffeb3b';
                webCtx.beginPath();
                const predSize = 15 + keystonePredators.length * 2;
                webCtx.arc(centerX, 50, predSize, 0, Math.PI * 2);
                webCtx.fill();

                webCtx.fillStyle = '#000';
                webCtx.font = 'bold 10px sans-serif';
                webCtx.fillText('★', centerX - 5, 54);
            } else {
                webCtx.fillStyle = '#666';
                webCtx.font = '12px sans-serif';
                webCtx.fillText('(Keystone Removed)', centerX - 50, 50);
            }
        }

        function drawDiversity() {
            const w = diversityCanvas.width / window.devicePixelRatio;
            const h = diversityCanvas.height / window.devicePixelRatio;

            diversityCtx.fillStyle = '#1a1a2e';
            diversityCtx.fillRect(0, 0, w, h);

            if (history.length < 2) return;

            const padding = 40;
            const plotW = w - padding * 2;
            const plotH = h - padding * 2;

            // Axes
            diversityCtx.strokeStyle = '#666';
            diversityCtx.beginPath();
            diversityCtx.moveTo(padding, padding);
            diversityCtx.lineTo(padding, h - padding);
            diversityCtx.lineTo(w - padding, h - padding);
            diversityCtx.stroke();

            const maxRichness = parseInt(document.getElementById('preySpecies').value);
            const maxDiversity = Math.log(maxRichness);

            // Draw removal line
            if (removalTick > 0) {
                const removalIdx = history.findIndex(d => d.tick >= removalTick);
                if (removalIdx >= 0) {
                    const removalX = padding + (removalIdx / (history.length - 1)) * plotW;
                    diversityCtx.strokeStyle = '#f44336';
                    diversityCtx.setLineDash([5, 5]);
                    diversityCtx.beginPath();
                    diversityCtx.moveTo(removalX, padding);
                    diversityCtx.lineTo(removalX, h - padding);
                    diversityCtx.stroke();
                    diversityCtx.setLineDash([]);
                }
            }

            // Draw species richness
            diversityCtx.strokeStyle = '#4CAF50';
            diversityCtx.lineWidth = 2;
            diversityCtx.beginPath();
            history.forEach((d, i) => {
                const x = padding + (i / (history.length - 1)) * plotW;
                const y = h - padding - (d.richness / maxRichness) * plotH;
                if (i === 0) diversityCtx.moveTo(x, y);
                else diversityCtx.lineTo(x, y);
            });
            diversityCtx.stroke();

            // Draw Shannon diversity
            diversityCtx.strokeStyle = '#2196F3';
            diversityCtx.beginPath();
            history.forEach((d, i) => {
                const x = padding + (i / (history.length - 1)) * plotW;
                const y = h - padding - (d.diversity / maxDiversity) * plotH;
                if (i === 0) diversityCtx.moveTo(x, y);
                else diversityCtx.lineTo(x, y);
            });
            diversityCtx.stroke();

            // Labels
            diversityCtx.fillStyle = '#aaa';
            diversityCtx.font = '10px sans-serif';
            diversityCtx.fillText('Index', 5, h / 2);
            diversityCtx.fillText('Time', w / 2 - 10, h - 5);

            // Legend
            diversityCtx.fillStyle = '#4CAF50';
            diversityCtx.fillText('● Richness', w - 80, 20);
            diversityCtx.fillStyle = '#2196F3';
            diversityCtx.fillText('● Shannon H', w - 80, 35);
        }

        function removeKeystone() {
            keystonePresent = false;
            keystonePredators = [];
            removalTick = tick;
            updateKeystoneStatus();
        }

        function animate() {
            if (running) {
                simulationStep();
            }
            draw();
            requestAnimationFrame(animate);
        }

        // Event listeners
        document.getElementById('startBtn').addEventListener('click', () => {
            running = !running;
            document.getElementById('startBtn').textContent = running ? 'Pause' : 'Start';
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            running = false;
            document.getElementById('startBtn').textContent = 'Start';
            initSimulation();
        });

        document.getElementById('removeBtn').addEventListener('click', () => {
            if (keystonePresent) {
                removeKeystone();
            }
        });

        // Slider value displays
        const sliders = [
            ['preySpecies', 'preySpeciesVal', v => v + ' species'],
            ['predationRate', 'predationRateVal', v => v + '%'],
            ['competitorStrength', 'competitorStrengthVal', v => v + '%'],
            ['resourceRegen', 'resourceRegenVal', v => v],
            ['competition', 'competitionVal', v => v + '%']
        ];

        sliders.forEach(([id, displayId, formatter]) => {
            const input = document.getElementById(id);
            const display = document.getElementById(displayId);
            input.addEventListener('input', () => {
                display.textContent = formatter(parseInt(input.value));
            });
        });

        // Initialize
        initSimulation();
        animate();
    </script>
</body>
</html>
