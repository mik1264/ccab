<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polymerization Simulation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1520 0%, #2a2040 50%, #1a2530 100%);
            min-height: 100vh;
            color: #e0e0f0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            font-family: 'Lora', serif;
            font-size: 2rem;
            color: #ff9944;
            text-shadow: 0 0 20px rgba(255, 153, 68, 0.5);
            margin-bottom: 5px;
        }

        .subtitle {
            color: #88aaff;
            font-size: 0.95rem;
        }

        .back-link {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #ff9944;
            text-decoration: none;
            font-size: 0.9rem;
            opacity: 0.8;
            transition: opacity 0.3s;
        }

        .back-link:hover {
            opacity: 1;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        .simulation-area {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .canvas-container {
            background: rgba(20, 15, 30, 0.9);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(255, 153, 68, 0.3);
        }

        canvas {
            display: block;
            width: 100%;
            border-radius: 10px;
            background: #0a0810;
        }

        .charts-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .chart-container {
            background: rgba(20, 15, 30, 0.9);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid rgba(136, 170, 255, 0.3);
        }

        .chart-container h4 {
            color: #88aaff;
            font-size: 0.85rem;
            margin-bottom: 8px;
            text-align: center;
        }

        .controls-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .control-group {
            background: rgba(30, 25, 50, 0.9);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255, 153, 68, 0.3);
        }

        .control-group h3 {
            color: #ff9944;
            font-size: 0.85rem;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .control-row {
            margin-bottom: 10px;
        }

        .control-row label {
            display: block;
            font-size: 0.8rem;
            color: #bb99dd;
            margin-bottom: 4px;
        }

        .control-row input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 153, 68, 0.2);
            outline: none;
            -webkit-appearance: none;
        }

        .control-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #ff9944;
            cursor: pointer;
        }

        .control-row select {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            background: rgba(20, 15, 40, 0.9);
            border: 1px solid rgba(255, 153, 68, 0.3);
            color: #e0e0f0;
            font-size: 0.85rem;
        }

        .buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            min-width: 70px;
            padding: 10px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff9944, #cc6622);
            color: #000;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #88aaff, #5577cc);
            color: #000;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6666, #cc3333);
            color: #fff;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 153, 68, 0.4);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .stat-item {
            background: rgba(20, 15, 40, 0.6);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 1rem;
            font-weight: bold;
            color: #ff9944;
        }

        .stat-label {
            font-size: 0.65rem;
            color: #888;
            text-transform: uppercase;
        }

        .gel-indicator {
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .gel-sol {
            background: rgba(68, 136, 255, 0.3);
            color: #88aaff;
            border: 1px solid #4488ff;
        }

        .gel-critical {
            background: rgba(255, 255, 68, 0.3);
            color: #ffff88;
            border: 1px solid #aaaa44;
            animation: flash 0.5s infinite;
        }

        .gel-gel {
            background: rgba(255, 68, 68, 0.3);
            color: #ff8888;
            border: 1px solid #ff4444;
        }

        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .info-box {
            background: rgba(40, 30, 60, 0.6);
            border-radius: 10px;
            padding: 12px;
            font-size: 0.8rem;
            line-height: 1.5;
            border-left: 3px solid #ff9944;
        }

        .info-box h4 {
            color: #ff9944;
            margin-bottom: 8px;
        }

        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .charts-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Simulations</a>

    <div class="container">
        <header>
            <h1>üîó Polymerization Simulation</h1>
            <p class="subtitle">Step-Growth & Chain-Growth ‚Ä¢ Molecular Weight Distribution</p>
        </header>

        <div class="main-content">
            <div class="simulation-area">
                <div class="canvas-container">
                    <canvas id="mainCanvas"></canvas>
                </div>
                <div class="charts-row">
                    <div class="chart-container">
                        <h4>Molecular Weight Distribution</h4>
                        <canvas id="mwdCanvas" height="150"></canvas>
                    </div>
                    <div class="chart-container">
                        <h4>Conversion vs Time</h4>
                        <canvas id="conversionCanvas" height="150"></canvas>
                    </div>
                </div>
            </div>

            <div class="controls-panel">
                <div class="control-group">
                    <div class="gel-indicator gel-sol" id="gelIndicator">
                        SOL STATE
                    </div>
                    <div class="buttons">
                        <button class="btn-primary" id="startBtn">‚ñ∂ Start</button>
                        <button class="btn-danger" id="resetBtn">‚Ü∫ Reset</button>
                    </div>
                </div>

                <div class="control-group">
                    <h3>Polymerization Type</h3>
                    <div class="control-row">
                        <select id="polyType">
                            <option value="step-linear">Step-Growth (Linear A-B)</option>
                            <option value="step-branched">Step-Growth (Branched A‚ÇÉ)</option>
                            <option value="chain">Chain-Growth (Free Radical)</option>
                            <option value="living">Living Polymerization</option>
                        </select>
                    </div>
                </div>

                <div class="control-group">
                    <h3>Reaction Parameters</h3>
                    <div class="control-row">
                        <label>Initial Monomers: <span id="monomersVal">200</span></label>
                        <input type="range" id="monomers" min="50" max="500" value="200" step="10">
                    </div>
                    <div class="control-row">
                        <label>Reaction Rate: <span id="rateVal">0.05</span></label>
                        <input type="range" id="rate" min="0.01" max="0.2" value="0.05" step="0.01">
                    </div>
                    <div class="control-row">
                        <label>Functionality (f): <span id="funcVal">2</span></label>
                        <input type="range" id="functionality" min="2" max="4" value="2">
                    </div>
                    <div class="control-row" id="initiatorRow">
                        <label>Initiator Conc: <span id="initiatorVal">0.01</span></label>
                        <input type="range" id="initiator" min="0.001" max="0.1" value="0.01" step="0.001">
                    </div>
                </div>

                <div class="control-group">
                    <h3>Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="conversion">0%</div>
                            <div class="stat-label">Conversion (p)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="numChains">0</div>
                            <div class="stat-label">Chains</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="mn">1</div>
                            <div class="stat-label">Mn (avg)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="mw">1</div>
                            <div class="stat-label">Mw (weight)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="pdi">1.0</div>
                            <div class="stat-label">PDI (ƒê)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="dpn">1</div>
                            <div class="stat-label">DPn</div>
                        </div>
                    </div>
                </div>

                <div class="control-group info-box">
                    <h4>Polymerization Equations</h4>
                    <p>
                        <b>Step-Growth:</b><br>
                        DPn = 1/(1-p) for linear<br>
                        Gel point: p_c = 1/(f-1) for f > 2
                    </p>
                    <p style="margin-top: 8px;">
                        <b>Chain-Growth:</b><br>
                        DPn = kp[M]/kt[I]^0.5<br>
                        PDI ‚Üí 2 (step), 1.5 (chain)
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Canvas setup
        const mainCanvas = document.getElementById('mainCanvas');
        const mainCtx = mainCanvas.getContext('2d');
        const mwdCanvas = document.getElementById('mwdCanvas');
        const mwdCtx = mwdCanvas.getContext('2d');
        const convCanvas = document.getElementById('conversionCanvas');
        const convCtx = convCanvas.getContext('2d');

        function resizeCanvases() {
            const container = mainCanvas.parentElement;
            const width = container.clientWidth - 30;
            const height = Math.min(width * 0.5, 350);
            mainCanvas.width = width;
            mainCanvas.height = height;

            mwdCanvas.width = mwdCanvas.parentElement.clientWidth - 24;
            convCanvas.width = convCanvas.parentElement.clientWidth - 24;
        }
        resizeCanvases();
        window.addEventListener('resize', resizeCanvases);

        // State
        let running = false;
        let time = 0;

        // Parameters
        let numMonomers = 200;
        let reactionRate = 0.05;
        let functionality = 2;
        let initiatorConc = 0.01;
        let polyType = 'step-linear';

        // Polymer chains
        let chains = [];  // Array of chain lengths
        let monomersRemaining = 0;
        let reactedGroups = 0;
        let totalGroups = 0;

        // History for conversion plot
        let conversionHistory = [];
        const maxHistory = 200;

        // Polymer chain class (for visualization)
        class PolymerChain {
            constructor(length, x, y) {
                this.length = length;
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 2;
                this.vy = (Math.random() - 0.5) * 2;
                this.angle = Math.random() * Math.PI * 2;
                this.isGel = false;
            }

            update(width, height) {
                this.x += this.vx;
                this.y += this.vy;
                this.angle += 0.02;

                // Bouncing
                if (this.x < 20 || this.x > width - 20) this.vx *= -0.8;
                if (this.y < 20 || this.y > height - 20) this.vy *= -0.8;

                this.x = Math.max(20, Math.min(width - 20, this.x));
                this.y = Math.max(20, Math.min(height - 20, this.y));

                // Slow down larger chains
                const damping = 0.99 - this.length * 0.001;
                this.vx *= Math.max(0.9, damping);
                this.vy *= Math.max(0.9, damping);
            }

            draw(ctx) {
                const radius = Math.min(3 + Math.log(this.length + 1) * 2, 15);

                // Draw as connected beads for small chains, blob for large
                if (this.length <= 10 && !this.isGel) {
                    // Draw individual units
                    ctx.fillStyle = this.getColor();
                    for (let i = 0; i < this.length; i++) {
                        const offset = (i - this.length / 2) * 4;
                        const px = this.x + Math.cos(this.angle) * offset;
                        const py = this.y + Math.sin(this.angle) * offset;
                        ctx.beginPath();
                        ctx.arc(px, py, 3, 0, Math.PI * 2);
                        ctx.fill();
                    }
                } else {
                    // Draw as blob
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, radius, 0, Math.PI * 2);

                    if (this.isGel) {
                        ctx.fillStyle = 'rgba(255, 100, 100, 0.6)';
                        ctx.strokeStyle = '#ff4444';
                        ctx.lineWidth = 2;
                        ctx.fill();
                        ctx.stroke();
                    } else {
                        ctx.fillStyle = this.getColor();
                        ctx.fill();
                    }

                    // Length label for large chains
                    if (this.length > 5) {
                        ctx.fillStyle = '#ffffff';
                        ctx.font = '9px sans-serif';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(this.length.toString(), this.x, this.y);
                    }
                }
            }

            getColor() {
                const hue = (this.length * 10) % 360;
                return `hsl(${hue}, 70%, 50%)`;
            }
        }

        let polymerChains = [];  // Visual representation
        let gelFormed = false;

        // Initialize simulation
        function initialize() {
            time = 0;
            chains = [];
            polymerChains = [];
            monomersRemaining = numMonomers;
            reactedGroups = 0;
            conversionHistory = [];
            gelFormed = false;

            // Create initial monomers
            totalGroups = numMonomers * functionality;

            for (let i = 0; i < numMonomers; i++) {
                chains.push(1);
                polymerChains.push(new PolymerChain(
                    1,
                    Math.random() * mainCanvas.width,
                    Math.random() * mainCanvas.height
                ));
            }

            updateGelIndicator();
        }

        // Step-growth polymerization step
        function stepGrowthStep() {
            const p = reactedGroups / totalGroups;

            // Probability of reaction based on remaining groups
            const unreactedFraction = 1 - p;
            if (unreactedFraction <= 0.001) return;

            // Number of reactions this step
            const numReactions = Math.floor(reactionRate * chains.length * unreactedFraction);

            for (let r = 0; r < numReactions && chains.length > 1; r++) {
                // Select two random chains
                const i = Math.floor(Math.random() * chains.length);
                let j = Math.floor(Math.random() * chains.length);
                while (j === i && chains.length > 1) {
                    j = Math.floor(Math.random() * chains.length);
                }

                if (i !== j) {
                    // Combine chains
                    const newLength = chains[i] + chains[j];
                    chains[i] = newLength;
                    chains.splice(j, 1);

                    // Update visual
                    polymerChains[i].length = newLength;
                    polymerChains[i].x = (polymerChains[i].x + polymerChains[j].x) / 2;
                    polymerChains[i].y = (polymerChains[i].y + polymerChains[j].y) / 2;
                    polymerChains.splice(j, 1);

                    reactedGroups += 2;

                    // Check for gel point (branched)
                    if (functionality > 2) {
                        const pc = 1 / (functionality - 1);
                        const currentP = reactedGroups / totalGroups;
                        if (currentP >= pc && !gelFormed) {
                            gelFormed = true;
                            polymerChains[i].isGel = true;
                        }
                    }
                }
            }

            monomersRemaining = chains.filter(c => c === 1).length;
        }

        // Chain-growth (free radical) polymerization step
        function chainGrowthStep() {
            // Initiation: create new growing chains
            const initiationRate = initiatorConc * reactionRate * 10;
            if (Math.random() < initiationRate && monomersRemaining > 0) {
                chains.push(1);
                monomersRemaining--;
                reactedGroups++;
                polymerChains.push(new PolymerChain(
                    1,
                    Math.random() * mainCanvas.width,
                    Math.random() * mainCanvas.height
                ));
            }

            // Propagation: grow existing chains
            for (let i = 0; i < chains.length && monomersRemaining > 0; i++) {
                if (Math.random() < reactionRate * 2) {
                    chains[i]++;
                    monomersRemaining--;
                    reactedGroups++;
                    polymerChains[i].length = chains[i];
                }
            }

            // Termination: combine two chains (coupling)
            if (chains.length > 1 && Math.random() < reactionRate * 0.5) {
                const i = Math.floor(Math.random() * chains.length);
                let j = Math.floor(Math.random() * chains.length);
                while (j === i) j = Math.floor(Math.random() * chains.length);

                if (i !== j) {
                    chains[i] += chains[j];
                    chains.splice(j, 1);
                    polymerChains[i].length = chains[i];
                    polymerChains.splice(j, 1);
                }
            }
        }

        // Living polymerization step (controlled)
        function livingPolyStep() {
            // All chains grow at same rate
            const growthRate = reactionRate * 3;

            for (let i = 0; i < chains.length && monomersRemaining > 0; i++) {
                if (Math.random() < growthRate) {
                    chains[i]++;
                    monomersRemaining--;
                    reactedGroups++;
                    polymerChains[i].length = chains[i];
                }
            }

            // Initialize chains if needed
            const targetChains = Math.floor(numMonomers * initiatorConc);
            while (chains.length < targetChains && chains.length < numMonomers) {
                chains.push(1);
                polymerChains.push(new PolymerChain(
                    1,
                    Math.random() * mainCanvas.width,
                    Math.random() * mainCanvas.height
                ));
            }
        }

        // Update gel indicator
        function updateGelIndicator() {
            const indicator = document.getElementById('gelIndicator');

            if (functionality <= 2) {
                indicator.className = 'gel-indicator gel-sol';
                indicator.textContent = 'LINEAR POLYMER';
            } else {
                const pc = 1 / (functionality - 1);
                const currentP = reactedGroups / totalGroups;

                if (gelFormed) {
                    indicator.className = 'gel-indicator gel-gel';
                    indicator.textContent = 'GEL FORMED!';
                } else if (currentP > pc * 0.8) {
                    indicator.className = 'gel-indicator gel-critical';
                    indicator.textContent = `NEAR GEL POINT (pc=${pc.toFixed(2)})`;
                } else {
                    indicator.className = 'gel-indicator gel-sol';
                    indicator.textContent = `SOL STATE (pc=${pc.toFixed(2)})`;
                }
            }
        }

        // Calculate statistics
        function calculateStats() {
            if (chains.length === 0) return;

            // Number average molecular weight (Mn)
            const totalMass = chains.reduce((sum, len) => sum + len, 0);
            const mn = totalMass / chains.length;

            // Weight average molecular weight (Mw)
            const sumMiNi = chains.reduce((sum, len) => sum + len * len, 0);
            const mw = sumMiNi / totalMass;

            // Polydispersity index
            const pdi = mw / mn;

            // Conversion
            const p = totalGroups > 0 ? reactedGroups / totalGroups : 0;
            const conversion = Math.min(100, p * 100);

            // Degree of polymerization
            const dpn = mn;

            document.getElementById('conversion').textContent = conversion.toFixed(1) + '%';
            document.getElementById('numChains').textContent = chains.length;
            document.getElementById('mn').textContent = mn.toFixed(1);
            document.getElementById('mw').textContent = mw.toFixed(1);
            document.getElementById('pdi').textContent = pdi.toFixed(2);
            document.getElementById('dpn').textContent = dpn.toFixed(1);

            // Update history
            conversionHistory.push(conversion);
            if (conversionHistory.length > maxHistory) {
                conversionHistory.shift();
            }
        }

        // Render main canvas
        function renderMain() {
            const width = mainCanvas.width;
            const height = mainCanvas.height;

            mainCtx.fillStyle = '#0a0810';
            mainCtx.fillRect(0, 0, width, height);

            // Update and draw chains
            for (const chain of polymerChains) {
                chain.update(width, height);
                chain.draw(mainCtx);
            }

            // Info
            mainCtx.fillStyle = '#666666';
            mainCtx.font = '11px sans-serif';
            mainCtx.fillText(`Time: ${time}  Chains: ${chains.length}`, 10, 15);
        }

        // Render MWD histogram
        function renderMWD() {
            const width = mwdCanvas.width;
            const height = mwdCanvas.height;

            mwdCtx.fillStyle = '#0a0810';
            mwdCtx.fillRect(0, 0, width, height);

            if (chains.length === 0) return;

            // Create histogram bins
            const maxLen = Math.max(...chains);
            const numBins = Math.min(30, maxLen);
            const binSize = Math.max(1, Math.ceil(maxLen / numBins));
            const bins = new Array(numBins).fill(0);

            chains.forEach(len => {
                const bin = Math.min(numBins - 1, Math.floor((len - 1) / binSize));
                bins[bin]++;
            });

            const maxCount = Math.max(...bins);

            // Draw bars
            const barWidth = (width - 40) / numBins;
            const barAreaHeight = height - 30;

            for (let i = 0; i < numBins; i++) {
                const barHeight = maxCount > 0 ? (bins[i] / maxCount) * barAreaHeight : 0;
                const x = 30 + i * barWidth;
                const y = height - 20 - barHeight;

                const hue = (i / numBins) * 180 + 180;
                mwdCtx.fillStyle = `hsl(${hue}, 70%, 50%)`;
                mwdCtx.fillRect(x, y, barWidth - 1, barHeight);
            }

            // Axes
            mwdCtx.strokeStyle = '#444444';
            mwdCtx.beginPath();
            mwdCtx.moveTo(30, 10);
            mwdCtx.lineTo(30, height - 20);
            mwdCtx.lineTo(width - 10, height - 20);
            mwdCtx.stroke();

            // Labels
            mwdCtx.fillStyle = '#888888';
            mwdCtx.font = '9px sans-serif';
            mwdCtx.textAlign = 'center';
            mwdCtx.fillText('Chain Length', width / 2, height - 5);
            mwdCtx.save();
            mwdCtx.translate(10, height / 2);
            mwdCtx.rotate(-Math.PI / 2);
            mwdCtx.fillText('Count', 0, 0);
            mwdCtx.restore();
        }

        // Render conversion plot
        function renderConversion() {
            const width = convCanvas.width;
            const height = convCanvas.height;

            convCtx.fillStyle = '#0a0810';
            convCtx.fillRect(0, 0, width, height);

            if (conversionHistory.length < 2) return;

            // Draw line
            const plotWidth = width - 40;
            const plotHeight = height - 30;

            convCtx.strokeStyle = '#ff9944';
            convCtx.lineWidth = 2;
            convCtx.beginPath();

            for (let i = 0; i < conversionHistory.length; i++) {
                const x = 30 + (i / maxHistory) * plotWidth;
                const y = height - 20 - (conversionHistory[i] / 100) * plotHeight;

                if (i === 0) {
                    convCtx.moveTo(x, y);
                } else {
                    convCtx.lineTo(x, y);
                }
            }
            convCtx.stroke();

            // Gel point line (for branched)
            if (functionality > 2) {
                const pc = 1 / (functionality - 1) * 100;
                const yGel = height - 20 - (pc / 100) * plotHeight;

                convCtx.strokeStyle = '#ff4444';
                convCtx.lineWidth = 1;
                convCtx.setLineDash([5, 5]);
                convCtx.beginPath();
                convCtx.moveTo(30, yGel);
                convCtx.lineTo(width - 10, yGel);
                convCtx.stroke();
                convCtx.setLineDash([]);

                convCtx.fillStyle = '#ff4444';
                convCtx.font = '8px sans-serif';
                convCtx.fillText('Gel', width - 25, yGel - 3);
            }

            // Axes
            convCtx.strokeStyle = '#444444';
            convCtx.lineWidth = 1;
            convCtx.beginPath();
            convCtx.moveTo(30, 10);
            convCtx.lineTo(30, height - 20);
            convCtx.lineTo(width - 10, height - 20);
            convCtx.stroke();

            // Labels
            convCtx.fillStyle = '#888888';
            convCtx.font = '9px sans-serif';
            convCtx.textAlign = 'center';
            convCtx.fillText('Time', width / 2, height - 5);
            convCtx.fillText('0%', 20, height - 20);
            convCtx.fillText('100%', 20, 15);
        }

        // Animation loop
        function animate() {
            if (running) {
                time++;

                switch (polyType) {
                    case 'step-linear':
                    case 'step-branched':
                        stepGrowthStep();
                        break;
                    case 'chain':
                        chainGrowthStep();
                        break;
                    case 'living':
                        livingPolyStep();
                        break;
                }

                calculateStats();
                updateGelIndicator();
            }

            renderMain();
            renderMWD();
            renderConversion();
            requestAnimationFrame(animate);
        }

        // Event listeners
        document.getElementById('startBtn').addEventListener('click', () => {
            running = !running;
            document.getElementById('startBtn').textContent = running ? '‚è∏ Pause' : '‚ñ∂ Start';
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            running = false;
            document.getElementById('startBtn').textContent = '‚ñ∂ Start';
            initialize();
        });

        // Parameter controls
        document.getElementById('monomers').addEventListener('input', (e) => {
            numMonomers = parseInt(e.target.value);
            document.getElementById('monomersVal').textContent = numMonomers;
        });

        document.getElementById('rate').addEventListener('input', (e) => {
            reactionRate = parseFloat(e.target.value);
            document.getElementById('rateVal').textContent = reactionRate.toFixed(2);
        });

        document.getElementById('functionality').addEventListener('input', (e) => {
            functionality = parseInt(e.target.value);
            document.getElementById('funcVal').textContent = functionality;
        });

        document.getElementById('initiator').addEventListener('input', (e) => {
            initiatorConc = parseFloat(e.target.value);
            document.getElementById('initiatorVal').textContent = initiatorConc.toFixed(3);
        });

        document.getElementById('polyType').addEventListener('change', (e) => {
            polyType = e.target.value;

            // Show/hide initiator control
            const initiatorRow = document.getElementById('initiatorRow');
            initiatorRow.style.display = (polyType === 'chain' || polyType === 'living') ? 'block' : 'none';

            // Update functionality for branched
            if (polyType === 'step-branched') {
                functionality = 3;
                document.getElementById('functionality').value = 3;
                document.getElementById('funcVal').textContent = 3;
            }

            initialize();
        });

        // Initialize and start
        initialize();
        animate();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
