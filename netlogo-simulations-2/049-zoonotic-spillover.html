<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoonotic Spillover - CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #1a1a2e; color: #e8e6e1; overflow: hidden; }
        #container { display: flex; height: 100vh; }
        #canvas-container { flex: 1; position: relative; }
        canvas { display: block; width: 100%; height: 100%; }
        #controls { width: 300px; background: rgba(0,0,0,0.8); padding: 20px; overflow-y: auto; }
        h1 { font-size: 1.2rem; margin-bottom: 15px; color: #dc2626; }
        .control-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: #aaa; }
        input[type="range"] { width: 100%; }
        button { width: 100%; padding: 10px; margin-bottom: 10px; background: #dc2626; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: #b91c1c; }
        .stats { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; font-size: 0.8rem; margin-bottom: 15px; }
        .back-link { position: fixed; top: 10px; left: 10px; padding: 8px 16px; background: rgba(0,0,0,0.7); color: #dc2626; text-decoration: none; border-radius: 6px; font-size: 14px; z-index: 999; }
        .explain-btn { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); margin-top: 10px; }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; }
        .modal-overlay.active { display: flex; align-items: center; justify-content: center; }
        .modal { background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%); border-radius: 16px; padding: 30px; max-width: 600px; max-height: 80vh; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); position: relative; }
        .modal-close { position: absolute; top: 15px; right: 20px; background: none; border: none; color: #888; font-size: 28px; cursor: pointer; width: auto; }
        .modal h2 { color: #dc2626; margin-bottom: 20px; }
        .modal-body { color: #ccc; line-height: 1.8; }
        .modal-body h3 { color: #fca5a5; margin: 20px 0 10px; }
        .modal-body strong { color: #dc2626; }
        .alert { background: rgba(220,38,38,0.3); border: 1px solid #dc2626; padding: 8px; border-radius: 5px; margin-top: 10px; font-size: 0.75rem; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Gallery</a>
    <div id="container">
        <div id="canvas-container"><canvas id="canvas"></canvas></div>
        <div id="controls">
            <h1>Zoonotic Spillover</h1>
            <div class="control-group">
                <label>Contact Rate (Human-Animal): <span id="contactValue">0.05</span></label>
                <input type="range" id="contact" min="0.01" max="0.2" step="0.01" value="0.05">
            </div>
            <div class="control-group">
                <label>Spillover Probability: <span id="spillValue">0.1</span></label>
                <input type="range" id="spillover" min="0.01" max="0.5" step="0.01" value="0.1">
            </div>
            <div class="control-group">
                <label>Human-Human Adaptation: <span id="adaptValue">0.02</span></label>
                <input type="range" id="adapt" min="0" max="0.1" step="0.01" value="0.02">
            </div>
            <div class="control-group">
                <label>Reservoir Prevalence: <span id="prevValue">30</span>%</label>
                <input type="range" id="prevalence" min="5" max="80" value="30">
            </div>
            <button id="reset">Reset</button>
            <button id="triggerSpillover">Force Spillover Event</button>
            <button id="explainBtn" class="explain-btn">üìö Explain</button>
            <div class="stats">
                <div>Reservoir Infected: <span id="reservoirInf">0</span></div>
                <div>Human Cases: <span id="humanCases">0</span></div>
                <div>Spillover Events: <span id="spillovers">0</span></div>
                <div>Secondary Cases: <span id="secondary">0</span></div>
                <div>Human R‚ÇÄ: <span id="humanR0">0</span></div>
                <div id="alertBox" class="alert" style="display:none">‚ö†Ô∏è Sustained transmission!</div>
            </div>
        </div>
    </div>
    <div id="explainModal" class="modal-overlay">
        <div class="modal">
            <button class="modal-close">&times;</button>
            <h2>ü¶á Zoonotic Spillover</h2>
            <div class="modal-body">
                <p><strong>Zoonotic spillover</strong> occurs when a pathogen jumps from an animal reservoir to humans.</p>
                <h3>Spillover Process</h3>
                <ul>
                    <li><strong>Reservoir:</strong> Wildlife maintain the pathogen (bats, rodents, birds)</li>
                    <li><strong>Interface:</strong> Human-animal contact creates opportunities</li>
                    <li><strong>Spillover:</strong> Pathogen infects first human case</li>
                    <li><strong>Adaptation:</strong> Mutations may enable human-to-human spread</li>
                </ul>
                <h3>Key Factors</h3>
                <ul>
                    <li>Deforestation and habitat encroachment</li>
                    <li>Wildlife trade and wet markets</li>
                    <li>Agricultural intensification</li>
                    <li>Climate change shifting species ranges</li>
                </ul>
                <h3>Pandemic Potential</h3>
                <p>Most spillovers are dead-ends. The danger is when the pathogen adapts for efficient human transmission (R‚ÇÄ > 1).</p>
            </div>
        </div>
    </div>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let params = { contact: 0.05, spillover: 0.1, adapt: 0.02, prevalence: 30 };
        let reservoirAnimals = [], humans = [], spillovers = 0, secondaryCases = 0;
        let humanAdaptation = 0; // Pathogen's ability to spread human-to-human

        function resize() { 
            canvas.width = document.getElementById('canvas-container').clientWidth; 
            canvas.height = document.getElementById('canvas-container').clientHeight; 
        }

        function init() {
            resize();
            spillovers = 0;
            secondaryCases = 0;
            humanAdaptation = 0;
            reservoirAnimals = [];
            humans = [];

            // Forest/reservoir area (left side)
            const forestWidth = (canvas.width - 300) * 0.4;
            // Human settlement (right side)
            const settlementStart = forestWidth + 50;

            // Create reservoir animals (bats/rodents)
            for (let i = 0; i < 80; i++) {
                const infected = Math.random() < params.prevalence / 100;
                reservoirAnimals.push({
                    x: 30 + Math.random() * (forestWidth - 60),
                    y: 50 + Math.random() * (canvas.height - 100),
                    vx: (Math.random() - 0.5) * 3,
                    vy: (Math.random() - 0.5) * 3,
                    infected,
                    type: Math.random() < 0.5 ? 'bat' : 'rodent'
                });
            }

            // Create humans
            for (let i = 0; i < 100; i++) {
                humans.push({
                    x: settlementStart + 30 + Math.random() * (canvas.width - settlementStart - 360),
                    y: 50 + Math.random() * (canvas.height - 100),
                    vx: (Math.random() - 0.5) * 1.5,
                    vy: (Math.random() - 0.5) * 1.5,
                    state: 'S',
                    daysInfected: 0,
                    fromSpillover: false,
                    generationTime: 0
                });
            }

            document.getElementById('alertBox').style.display = 'none';
        }

        function triggerSpillover() {
            const susceptibles = humans.filter(h => h.state === 'S');
            if (susceptibles.length > 0) {
                const target = susceptibles[Math.floor(Math.random() * susceptibles.length)];
                target.state = 'I';
                target.fromSpillover = true;
                spillovers++;
            }
        }

        function update() {
            const forestWidth = (canvas.width - 300) * 0.4;
            const interfaceZone = { start: forestWidth - 30, end: forestWidth + 80 };

            // Move reservoir animals
            for (let a of reservoirAnimals) {
                a.x += a.vx;
                a.y += a.vy;
                // Keep in forest area mostly
                if (a.x < 20 || a.x > forestWidth + 30) a.vx *= -1;
                if (a.y < 40 || a.y > canvas.height - 40) a.vy *= -1;

                // Occasional ventures into interface zone
                if (Math.random() < 0.01) {
                    a.vx = (Math.random() - 0.3) * 3;
                }
            }

            // Move humans
            for (let h of humans) {
                h.x += h.vx;
                h.y += h.vy;
                const settlementStart = forestWidth + 50;
                if (h.x < settlementStart - 30 || h.x > canvas.width - 330) h.vx *= -1;
                if (h.y < 40 || h.y > canvas.height - 40) h.vy *= -1;

                // Some humans venture into interface (farmers, hunters)
                if (Math.random() < params.contact * 0.01) {
                    h.vx = (Math.random() - 0.7) * 2;
                }
            }

            // Spillover events (animal to human)
            for (let h of humans) {
                if (h.state !== 'S') continue;
                
                for (let a of reservoirAnimals) {
                    if (!a.infected) continue;
                    
                    const dx = h.x - a.x;
                    const dy = h.y - a.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    // Must be in interface zone for contact
                    if (dist < 25 && h.x < interfaceZone.end && a.x > interfaceZone.start) {
                        if (Math.random() < params.spillover * 0.01) {
                            h.state = 'I';
                            h.fromSpillover = true;
                            h.daysInfected = 0;
                            spillovers++;
                            break;
                        }
                    }
                }
            }

            // Human-to-human transmission (depends on adaptation level)
            const effectiveR0 = humanAdaptation * 3; // Max R0 of 3 when fully adapted
            const transmissionProb = effectiveR0 * 0.01;

            for (let h of humans) {
                if (h.state !== 'S') continue;

                for (let other of humans) {
                    if (other.state !== 'I') continue;

                    const dx = h.x - other.x;
                    const dy = h.y - other.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist < 20 && Math.random() < transmissionProb) {
                        h.state = 'I';
                        h.daysInfected = 0;
                        h.fromSpillover = false;
                        h.generationTime = other.generationTime + 1;
                        secondaryCases++;
                        break;
                    }
                }
            }

            // Pathogen adaptation during infection
            for (let h of humans) {
                if (h.state === 'I') {
                    h.daysInfected++;

                    // Adaptation mutations during replication
                    if (Math.random() < params.adapt * 0.01) {
                        humanAdaptation = Math.min(1, humanAdaptation + 0.05);
                    }

                    // Recovery
                    if (h.daysInfected > 80 + Math.random() * 40) {
                        h.state = 'R';
                    }
                }
            }

            // Reservoir dynamics - maintain prevalence
            for (let a of reservoirAnimals) {
                if (!a.infected && Math.random() < 0.001) {
                    a.infected = true;
                }
            }

            // Check for sustained transmission
            const infectedHumans = humans.filter(h => h.state === 'I').length;
            const alertBox = document.getElementById('alertBox');
            if (humanAdaptation > 0.5 && infectedHumans > 5) {
                alertBox.style.display = 'block';
                alertBox.textContent = '‚ö†Ô∏è Sustained human transmission! R‚ÇÄ = ' + (humanAdaptation * 3).toFixed(2);
            } else if (humanAdaptation > 0.3) {
                alertBox.style.display = 'block';
                alertBox.textContent = '‚ö° Pathogen adapting to humans...';
            } else {
                alertBox.style.display = 'none';
            }
        }

        function draw() {
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const forestWidth = (canvas.width - 300) * 0.4;
            const interfaceZone = { start: forestWidth - 30, end: forestWidth + 80 };

            // Draw forest (reservoir)
            ctx.fillStyle = 'rgba(34, 197, 94, 0.2)';
            ctx.fillRect(10, 30, forestWidth, canvas.height - 60);
            ctx.strokeStyle = 'rgba(34, 197, 94, 0.5)';
            ctx.strokeRect(10, 30, forestWidth, canvas.height - 60);

            // Draw interface zone
            ctx.fillStyle = 'rgba(251, 191, 36, 0.15)';
            ctx.fillRect(interfaceZone.start, 30, interfaceZone.end - interfaceZone.start, canvas.height - 60);

            // Draw settlement
            ctx.fillStyle = 'rgba(59, 130, 246, 0.1)';
            ctx.fillRect(forestWidth + 50, 30, canvas.width - forestWidth - 350, canvas.height - 60);
            ctx.strokeStyle = 'rgba(59, 130, 246, 0.3)';
            ctx.strokeRect(forestWidth + 50, 30, canvas.width - forestWidth - 350, canvas.height - 60);

            // Labels
            ctx.fillStyle = '#22c55e';
            ctx.font = '12px sans-serif';
            ctx.fillText('Reservoir (Wildlife)', 20, 25);

            ctx.fillStyle = '#fbbf24';
            ctx.fillText('Interface', interfaceZone.start + 5, 25);

            ctx.fillStyle = '#3b82f6';
            ctx.fillText('Human Settlement', forestWidth + 60, 25);

            // Draw reservoir animals
            for (let a of reservoirAnimals) {
                ctx.beginPath();
                if (a.type === 'bat') {
                    // Bat shape
                    ctx.moveTo(a.x, a.y - 3);
                    ctx.lineTo(a.x - 6, a.y + 2);
                    ctx.lineTo(a.x, a.y);
                    ctx.lineTo(a.x + 6, a.y + 2);
                    ctx.closePath();
                } else {
                    // Rodent (small circle)
                    ctx.arc(a.x, a.y, 4, 0, Math.PI * 2);
                }
                ctx.fillStyle = a.infected ? '#ef4444' : '#6b7280';
                ctx.fill();
            }

            // Draw humans
            for (let h of humans) {
                ctx.beginPath();
                ctx.arc(h.x, h.y, 6, 0, Math.PI * 2);

                if (h.state === 'S') {
                    ctx.fillStyle = '#3b82f6';
                } else if (h.state === 'I') {
                    ctx.fillStyle = h.fromSpillover ? '#f97316' : '#ef4444';
                    // Glow for infected
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(h.x, h.y, 12, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(239, 68, 68, 0.2)';
                    ctx.fill();
                    ctx.restore();
                    ctx.beginPath();
                    ctx.arc(h.x, h.y, 6, 0, Math.PI * 2);
                    ctx.fillStyle = h.fromSpillover ? '#f97316' : '#ef4444';
                } else {
                    ctx.fillStyle = '#22c55e';
                }
                ctx.fill();
            }

            // Legend
            ctx.fillStyle = '#fff';
            ctx.font = '10px sans-serif';
            ctx.fillText('üîµ Susceptible | üü† Index (spillover) | üî¥ Secondary | üü¢ Recovered', 20, canvas.height - 15);

            // Adaptation meter
            const meterX = canvas.width - 280;
            const meterY = canvas.height - 100;
            ctx.fillStyle = 'rgba(0,0,0,0.5)';
            ctx.fillRect(meterX - 10, meterY - 20, 200, 60);

            ctx.fillStyle = 'white';
            ctx.font = '11px sans-serif';
            ctx.fillText('Pathogen Human Adaptation', meterX, meterY - 5);

            ctx.fillStyle = '#374151';
            ctx.fillRect(meterX, meterY + 5, 150, 15);

            const adaptColor = humanAdaptation < 0.3 ? '#22c55e' : (humanAdaptation < 0.7 ? '#eab308' : '#ef4444');
            ctx.fillStyle = adaptColor;
            ctx.fillRect(meterX, meterY + 5, 150 * humanAdaptation, 15);

            ctx.fillStyle = 'white';
            ctx.fillText((humanAdaptation * 100).toFixed(0) + '%', meterX + 160, meterY + 17);

            // Stats
            const reservoirInf = reservoirAnimals.filter(a => a.infected).length;
            const humanCases = humans.filter(h => h.state === 'I' || h.state === 'R').length;

            document.getElementById('reservoirInf').textContent = reservoirInf;
            document.getElementById('humanCases').textContent = humanCases;
            document.getElementById('spillovers').textContent = spillovers;
            document.getElementById('secondary').textContent = secondaryCases;
            document.getElementById('humanR0').textContent = (humanAdaptation * 3).toFixed(2);
        }

        function animate() { update(); draw(); requestAnimationFrame(animate); }

        document.getElementById('contact').addEventListener('input', e => { 
            params.contact = parseFloat(e.target.value); 
            document.getElementById('contactValue').textContent = params.contact.toFixed(2); 
        });
        document.getElementById('spillover').addEventListener('input', e => { 
            params.spillover = parseFloat(e.target.value); 
            document.getElementById('spillValue').textContent = params.spillover.toFixed(2); 
        });
        document.getElementById('adapt').addEventListener('input', e => { 
            params.adapt = parseFloat(e.target.value); 
            document.getElementById('adaptValue').textContent = params.adapt.toFixed(2); 
        });
        document.getElementById('prevalence').addEventListener('input', e => { 
            params.prevalence = parseInt(e.target.value); 
            document.getElementById('prevValue').textContent = params.prevalence; 
        });

        document.getElementById('reset').addEventListener('click', init);
        document.getElementById('triggerSpillover').addEventListener('click', triggerSpillover);

        window.addEventListener('resize', resize);

        const modal = document.getElementById('explainModal');
        document.getElementById('explainBtn').addEventListener('click', () => modal.classList.add('active'));
        modal.querySelector('.modal-close').addEventListener('click', () => modal.classList.remove('active'));
        modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('active'); });

        init();
        animate();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
