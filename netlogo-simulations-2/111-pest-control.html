<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrated Pest Management - Agricultural Simulation</title>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600&family=Nunito:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #FEFAE0 0%, #F4F1DE 50%, #EDE8D5 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 20px; }
        h1 { font-family: 'Lora', serif; color: #606C38; font-size: 2rem; margin-bottom: 8px; }
        .subtitle { color: #8A9A5B; font-size: 1rem; }
        .back-link {
            position: absolute; top: 20px; left: 20px;
            text-decoration: none; color: #606C38; font-weight: 600;
            display: flex; align-items: center; gap: 5px; transition: color 0.3s;
        }
        .back-link:hover { color: #BC6C25; }
        .main-content { display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        .canvas-container {
            background: white; border-radius: 12px; padding: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        canvas { width: 100%; border-radius: 8px; display: block; }
        .controls {
            background: white; border-radius: 12px; padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08); height: fit-content;
        }
        .control-group { margin-bottom: 18px; }
        .control-group label {
            display: block; color: #606C38; font-weight: 600;
            margin-bottom: 5px; font-size: 0.9rem;
        }
        .control-group input[type="range"] { width: 100%; accent-color: #8A9A5B; }
        .control-value { text-align: right; color: #8A9A5B; font-size: 0.85rem; }
        button {
            width: 100%; padding: 10px; margin-top: 5px; border: none;
            border-radius: 8px; cursor: pointer; font-family: 'Nunito', sans-serif;
            font-weight: 600; font-size: 0.9rem; transition: all 0.3s;
        }
        .btn-primary { background: #8A9A5B; color: white; }
        .btn-primary:hover { background: #606C38; }
        .btn-secondary { background: #DDA15E; color: white; }
        .btn-secondary:hover { background: #BC6C25; }
        .btn-danger { background: #BC6C25; color: white; }
        .btn-danger:hover { background: #a55a20; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .stat-box {
            background: linear-gradient(135deg, #FEFAE0, #F4F1DE);
            padding: 10px; border-radius: 8px; text-align: center;
        }
        .stat-value { font-family: 'Lora', serif; color: #606C38; font-size: 1.1rem; font-weight: 600; }
        .stat-label { color: #8A9A5B; font-size: 0.75rem; }
        .info-panel {
            margin-top: 15px; padding: 12px; background: #F4F1DE;
            border-radius: 8px; font-size: 0.8rem; color: #606C38;
        }
        select {
            width: 100%; padding: 8px; border: 1px solid #DDA15E;
            border-radius: 6px; font-family: 'Nunito', sans-serif;
            background: white; color: #606C38;
        }
        .legend {
            display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 5px; margin-top: 10px; font-size: 0.75rem;
        }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .legend-color { width: 14px; height: 14px; border-radius: 3px; }
        .threshold-indicator {
            margin-top: 10px; padding: 8px; border-radius: 6px;
            text-align: center; font-weight: 600;
        }
        .below-et { background: #90EE90; color: #228B22; }
        .above-et { background: #FFB6C1; color: #DC143C; }
        .action-buttons { display: flex; gap: 5px; margin-top: 10px; }
        .action-buttons button { flex: 1; font-size: 0.8rem; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Gallery</a>

    <div class="container">
        <header>
            <h1>Integrated Pest Management</h1>
            <p class="subtitle">Biological control, pesticide resistance, and economic thresholds</p>
        </header>

        <div class="main-content">
            <div class="canvas-container">
                <canvas id="simCanvas"></canvas>
            </div>

            <div class="controls">
                <div class="threshold-indicator below-et" id="thresholdIndicator">
                    Below Economic Threshold
                </div>

                <div class="control-group">
                    <label>IPM Strategy</label>
                    <select id="strategy">
                        <option value="none">No Control</option>
                        <option value="chemical">Chemical Only</option>
                        <option value="biological">Biological Only</option>
                        <option value="ipm" selected>Integrated (IPM)</option>
                        <option value="preventive">Preventive Cultural</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Economic Threshold (ET)</label>
                    <input type="range" id="economicThreshold" min="10" max="100" value="40">
                    <div class="control-value"><span id="economicThresholdVal">40</span> pests/plant</div>
                </div>

                <div class="control-group">
                    <label>Initial Resistance (%)</label>
                    <input type="range" id="initialResistance" min="0" max="30" value="5">
                    <div class="control-value"><span id="initialResistanceVal">5</span>%</div>
                </div>

                <div class="control-group">
                    <label>Natural Enemy Release Rate</label>
                    <input type="range" id="enemyRelease" min="0" max="20" value="5">
                    <div class="control-value"><span id="enemyReleaseVal">5</span>/day</div>
                </div>

                <div class="control-group">
                    <label>Pest Growth Rate</label>
                    <input type="range" id="pestGrowth" min="1" max="3" step="0.1" value="1.5">
                    <div class="control-value"><span id="pestGrowthVal">1.5</span>x</div>
                </div>

                <button class="btn-primary" onclick="startSimulation()">Start Season</button>
                <button class="btn-secondary" onclick="resetSimulation()">Reset</button>

                <div class="action-buttons">
                    <button class="btn-danger" onclick="applyPesticide()">Apply Pesticide</button>
                    <button class="btn-secondary" onclick="releaseEnemies()">Release Enemies</button>
                </div>

                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="pestCount">0</div>
                        <div class="stat-label">Pest Population</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="enemyCount">0</div>
                        <div class="stat-label">Natural Enemies</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="resistanceLevel">0%</div>
                        <div class="stat-label">Resistance</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="cropDamage">0%</div>
                        <div class="stat-label">Crop Damage</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="pesticideUse">0</div>
                        <div class="stat-label">Pesticide Apps</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="costTotal">$0</div>
                        <div class="stat-label">Total Cost</div>
                    </div>
                </div>

                <div class="legend">
                    <div class="legend-item"><div class="legend-color" style="background:#228B22"></div>Crop</div>
                    <div class="legend-item"><div class="legend-color" style="background:#8B0000"></div>Pest</div>
                    <div class="legend-item"><div class="legend-color" style="background:#FFD700"></div>Resistant</div>
                    <div class="legend-item"><div class="legend-color" style="background:#4169E1"></div>Enemy</div>
                </div>

                <div class="info-panel">
                    <strong>Model:</strong> IPM pyramid with cultural, biological, and chemical control.
                    Pesticides select for resistance; biocontrol reduces resistance pressure.
                    ET = Economic Injury Level threshold for intervention.
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');

        function setupCanvas() {
            const rect = canvas.parentElement.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            canvas.width = rect.width * dpr;
            canvas.height = (rect.width * 0.65) * dpr;
            canvas.style.height = (rect.width * 0.65) + 'px';
            ctx.scale(dpr, dpr);
            return { width: rect.width, height: rect.width * 0.65 };
        }

        let dims = setupCanvas();
        window.addEventListener('resize', () => { dims = setupCanvas(); draw(); });

        // Simulation state
        let state = {
            day: 0,
            running: false,
            pests: [],
            enemies: [],
            resistance: 5,
            cropDamage: 0,
            pesticideApplications: 0,
            totalCost: 0,
            pestHistory: [],
            enemyHistory: [],
            resistanceHistory: [],
            damageHistory: [],
            lastPesticideDay: -30
        };

        const seasonLength = 150;
        const fieldWidth = 400;
        const fieldHeight = 300;

        // Agent classes
        class Pest {
            constructor(x, y, resistant = false) {
                this.x = x;
                this.y = y;
                this.resistant = resistant;
                this.age = 0;
                this.vx = (Math.random() - 0.5) * 2;
                this.vy = (Math.random() - 0.5) * 2;
            }

            update() {
                this.age++;
                this.x += this.vx;
                this.y += this.vy;

                // Bounce off walls
                if (this.x < 0 || this.x > fieldWidth) this.vx *= -1;
                if (this.y < 0 || this.y > fieldHeight) this.vy *= -1;

                this.x = Math.max(0, Math.min(fieldWidth, this.x));
                this.y = Math.max(0, Math.min(fieldHeight, this.y));

                // Random direction changes
                if (Math.random() < 0.05) {
                    this.vx += (Math.random() - 0.5) * 0.5;
                    this.vy += (Math.random() - 0.5) * 0.5;
                }
            }
        }

        class NaturalEnemy {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.energy = 100;
                this.vx = 0;
                this.vy = 0;
                this.target = null;
            }

            update(pests) {
                this.energy -= 0.2;

                // Find nearest pest
                if (!this.target || this.target.dead) {
                    let minDist = Infinity;
                    for (const pest of pests) {
                        const dx = pest.x - this.x;
                        const dy = pest.y - this.y;
                        const dist = dx * dx + dy * dy;
                        if (dist < minDist) {
                            minDist = dist;
                            this.target = pest;
                        }
                    }
                }

                // Move toward target
                if (this.target) {
                    const dx = this.target.x - this.x;
                    const dy = this.target.y - this.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist > 0) {
                        this.vx = dx / dist * 2;
                        this.vy = dy / dist * 2;
                    }
                } else {
                    // Random movement
                    this.vx += (Math.random() - 0.5) * 0.3;
                    this.vy += (Math.random() - 0.5) * 0.3;
                }

                this.x += this.vx;
                this.y += this.vy;

                this.x = Math.max(0, Math.min(fieldWidth, this.x));
                this.y = Math.max(0, Math.min(fieldHeight, this.y));
            }

            tryEat(pests) {
                for (let i = pests.length - 1; i >= 0; i--) {
                    const pest = pests[i];
                    const dx = pest.x - this.x;
                    const dy = pest.y - this.y;
                    if (dx * dx + dy * dy < 100) {
                        pests.splice(i, 1);
                        this.energy += 30;
                        if (this.target === pest) this.target = null;
                        return true;
                    }
                }
                return false;
            }
        }

        // Initialize simulation
        function initSimulation() {
            const initialResistance = parseInt(document.getElementById('initialResistance').value);
            state = {
                day: 0,
                running: false,
                pests: [],
                enemies: [],
                resistance: initialResistance,
                cropDamage: 0,
                pesticideApplications: 0,
                totalCost: 0,
                pestHistory: [],
                enemyHistory: [],
                resistanceHistory: [],
                damageHistory: [],
                lastPesticideDay: -30
            };

            // Initial pest population
            for (let i = 0; i < 15; i++) {
                const resistant = Math.random() * 100 < initialResistance;
                state.pests.push(new Pest(
                    Math.random() * fieldWidth,
                    Math.random() * fieldHeight,
                    resistant
                ));
            }

            // Initial natural enemies (for IPM and biological)
            const strategy = document.getElementById('strategy').value;
            if (strategy === 'biological' || strategy === 'ipm') {
                for (let i = 0; i < 5; i++) {
                    state.enemies.push(new NaturalEnemy(
                        Math.random() * fieldWidth,
                        Math.random() * fieldHeight
                    ));
                }
            }
        }

        // Update simulation
        function update() {
            if (!state.running || state.day >= seasonLength) {
                state.running = false;
                return;
            }

            state.day++;

            const strategy = document.getElementById('strategy').value;
            const et = parseInt(document.getElementById('economicThreshold').value);
            const pestGrowth = parseFloat(document.getElementById('pestGrowth').value);
            const enemyRelease = parseInt(document.getElementById('enemyRelease').value);

            // Update pests
            state.pests.forEach(pest => pest.update());

            // Pest reproduction
            if (Math.random() < 0.3 * pestGrowth && state.pests.length < 500) {
                const parent = state.pests[Math.floor(Math.random() * state.pests.length)];
                if (parent) {
                    // Inheritance of resistance with some mutation
                    let childResistant = parent.resistant;
                    if (Math.random() < 0.02) childResistant = !childResistant;

                    state.pests.push(new Pest(
                        parent.x + (Math.random() - 0.5) * 20,
                        parent.y + (Math.random() - 0.5) * 20,
                        childResistant
                    ));
                }
            }

            // Update natural enemies
            state.enemies.forEach(enemy => {
                enemy.update(state.pests);
                enemy.tryEat(state.pests);
            });

            // Remove dead enemies
            state.enemies = state.enemies.filter(e => e.energy > 0);

            // Strategy-based actions
            const pestCount = state.pests.length;

            if (strategy === 'biological' || strategy === 'ipm') {
                // Regular enemy releases
                if (state.day % 7 === 0) {
                    for (let i = 0; i < enemyRelease; i++) {
                        state.enemies.push(new NaturalEnemy(
                            Math.random() * fieldWidth,
                            Math.random() * fieldHeight
                        ));
                        state.totalCost += 2; // Cost per enemy
                    }
                }
            }

            if (strategy === 'chemical' && pestCount > et) {
                // Automatic pesticide when above ET
                if (state.day - state.lastPesticideDay >= 14) {
                    applyPesticideInternal();
                }
            }

            if (strategy === 'ipm' && pestCount > et * 1.2) {
                // IPM uses pesticide only as last resort
                if (state.day - state.lastPesticideDay >= 21 && state.enemies.length < pestCount * 0.1) {
                    applyPesticideInternal();
                }
            }

            if (strategy === 'preventive') {
                // Cultural control reduces pest growth
                if (state.pests.length > 0 && Math.random() < 0.1) {
                    state.pests.pop();
                }
                state.totalCost += 0.5; // Ongoing cultural practice cost
            }

            // Calculate crop damage
            state.cropDamage += pestCount * 0.005;
            state.cropDamage = Math.min(100, state.cropDamage);

            // Calculate resistance level
            const resistantCount = state.pests.filter(p => p.resistant).length;
            state.resistance = state.pests.length > 0 ? (resistantCount / state.pests.length) * 100 : state.resistance;

            // Record history
            state.pestHistory.push(pestCount);
            state.enemyHistory.push(state.enemies.length);
            state.resistanceHistory.push(state.resistance);
            state.damageHistory.push(state.cropDamage);

            // Update UI
            updateStats();
            draw();

            setTimeout(update, 60);
        }

        // Apply pesticide
        function applyPesticideInternal() {
            state.pesticideApplications++;
            state.lastPesticideDay = state.day;
            state.totalCost += 50; // Pesticide cost

            // Kill susceptible pests
            state.pests = state.pests.filter(pest => {
                if (pest.resistant) {
                    return Math.random() > 0.3; // Resistant have 70% survival
                }
                return Math.random() > 0.85; // Susceptible have 15% survival
            });

            // Also kills some natural enemies
            state.enemies = state.enemies.filter(() => Math.random() > 0.6);

            // Selection pressure increases resistance in survivors
            state.pests.forEach(pest => {
                if (!pest.resistant && Math.random() < 0.1) {
                    pest.resistant = true;
                }
            });
        }

        function applyPesticide() {
            if (state.running && state.day - state.lastPesticideDay >= 7) {
                applyPesticideInternal();
            }
        }

        function releaseEnemies() {
            if (state.running) {
                const count = parseInt(document.getElementById('enemyRelease').value);
                for (let i = 0; i < count; i++) {
                    state.enemies.push(new NaturalEnemy(
                        Math.random() * fieldWidth,
                        Math.random() * fieldHeight
                    ));
                }
                state.totalCost += count * 2;
            }
        }

        function updateStats() {
            const et = parseInt(document.getElementById('economicThreshold').value);
            const indicator = document.getElementById('thresholdIndicator');

            if (state.pests.length >= et) {
                indicator.className = 'threshold-indicator above-et';
                indicator.textContent = 'ABOVE Economic Threshold!';
            } else {
                indicator.className = 'threshold-indicator below-et';
                indicator.textContent = 'Below Economic Threshold';
            }

            document.getElementById('pestCount').textContent = state.pests.length;
            document.getElementById('enemyCount').textContent = state.enemies.length;
            document.getElementById('resistanceLevel').textContent = state.resistance.toFixed(0) + '%';
            document.getElementById('cropDamage').textContent = state.cropDamage.toFixed(1) + '%';
            document.getElementById('pesticideUse').textContent = state.pesticideApplications;
            document.getElementById('costTotal').textContent = '$' + state.totalCost.toFixed(0);
        }

        // Draw visualization
        function draw() {
            ctx.clearRect(0, 0, dims.width, dims.height);

            const offsetX = 20;
            const offsetY = 50;
            const scale = Math.min((dims.width * 0.55) / fieldWidth, (dims.height - 80) / fieldHeight);

            // Draw field background
            ctx.fillStyle = '#228B22';
            ctx.fillRect(offsetX, offsetY, fieldWidth * scale, fieldHeight * scale);

            // Draw crop grid pattern
            ctx.strokeStyle = '#1e7b1e';
            ctx.lineWidth = 0.5;
            const cropSpacing = 20 * scale;
            for (let x = 0; x <= fieldWidth * scale; x += cropSpacing) {
                ctx.beginPath();
                ctx.moveTo(offsetX + x, offsetY);
                ctx.lineTo(offsetX + x, offsetY + fieldHeight * scale);
                ctx.stroke();
            }
            for (let y = 0; y <= fieldHeight * scale; y += cropSpacing) {
                ctx.beginPath();
                ctx.moveTo(offsetX, offsetY + y);
                ctx.lineTo(offsetX + fieldWidth * scale, offsetY + y);
                ctx.stroke();
            }
            ctx.lineWidth = 1;

            // Damage overlay
            if (state.cropDamage > 0) {
                ctx.fillStyle = `rgba(139, 69, 19, ${state.cropDamage / 200})`;
                ctx.fillRect(offsetX, offsetY, fieldWidth * scale, fieldHeight * scale);
            }

            // Draw pests
            state.pests.forEach(pest => {
                const px = offsetX + pest.x * scale;
                const py = offsetY + pest.y * scale;

                ctx.fillStyle = pest.resistant ? '#FFD700' : '#8B0000';
                ctx.beginPath();
                ctx.arc(px, py, 4, 0, Math.PI * 2);
                ctx.fill();

                // Antennae
                ctx.strokeStyle = pest.resistant ? '#FFD700' : '#8B0000';
                ctx.beginPath();
                ctx.moveTo(px, py - 4);
                ctx.lineTo(px - 3, py - 8);
                ctx.moveTo(px, py - 4);
                ctx.lineTo(px + 3, py - 8);
                ctx.stroke();
            });

            // Draw natural enemies
            state.enemies.forEach(enemy => {
                const px = offsetX + enemy.x * scale;
                const py = offsetY + enemy.y * scale;

                ctx.fillStyle = '#4169E1';
                ctx.beginPath();
                ctx.moveTo(px, py - 6);
                ctx.lineTo(px - 5, py + 4);
                ctx.lineTo(px + 5, py + 4);
                ctx.closePath();
                ctx.fill();

                // Wings
                ctx.strokeStyle = '#4169E1';
                ctx.beginPath();
                ctx.moveTo(px - 5, py);
                ctx.lineTo(px - 10, py - 3);
                ctx.moveTo(px + 5, py);
                ctx.lineTo(px + 10, py - 3);
                ctx.stroke();
            });

            // Draw charts
            const chartX = dims.width * 0.58;
            const chartW = dims.width * 0.38;
            const chartH = 65;

            drawChart(chartX, 50, chartW, chartH, state.pestHistory, '#8B0000', 'Pest Population');
            drawChart(chartX, 135, chartW, chartH, state.enemyHistory, '#4169E1', 'Natural Enemies');
            drawChart(chartX, 220, chartW, chartH, state.resistanceHistory, '#FFD700', 'Resistance (%)');

            // Draw ET line on pest chart
            const et = parseInt(document.getElementById('economicThreshold').value);
            const maxPest = Math.max(...state.pestHistory, et, 50);
            const etY = 50 + chartH - (et / maxPest) * chartH;
            ctx.strokeStyle = '#FF6347';
            ctx.setLineDash([5, 3]);
            ctx.beginPath();
            ctx.moveTo(chartX, etY);
            ctx.lineTo(chartX + chartW, etY);
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.fillStyle = '#FF6347';
            ctx.font = '10px Nunito';
            ctx.fillText('ET', chartX + chartW + 5, etY + 3);

            // Title
            ctx.fillStyle = '#606C38';
            ctx.font = '14px Lora';
            ctx.fillText(`Day ${state.day}/${seasonLength} | Strategy: ${document.getElementById('strategy').options[document.getElementById('strategy').selectedIndex].text}`, 20, 35);
        }

        function drawChart(x, y, w, h, data, color, label) {
            ctx.fillStyle = 'rgba(255,255,255,0.8)';
            ctx.fillRect(x, y, w, h);
            ctx.strokeStyle = '#ddd';
            ctx.strokeRect(x, y, w, h);

            ctx.fillStyle = '#606C38';
            ctx.font = '11px Nunito';
            ctx.fillText(label, x + 5, y - 5);

            if (data.length < 2) return;

            const maxVal = Math.max(...data, 1);
            const step = w / Math.max(data.length - 1, 1);

            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;

            data.forEach((val, i) => {
                const px = x + i * step;
                const py = y + h - (val / maxVal) * h;
                if (i === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            });
            ctx.stroke();
            ctx.lineWidth = 1;
        }

        // Controls
        function startSimulation() {
            if (!state.running) {
                state.running = true;
                update();
            }
        }

        function resetSimulation() {
            initSimulation();
            draw();
            updateStats();
        }

        function updateSliderDisplays() {
            document.getElementById('economicThresholdVal').textContent = document.getElementById('economicThreshold').value;
            document.getElementById('initialResistanceVal').textContent = document.getElementById('initialResistance').value;
            document.getElementById('enemyReleaseVal').textContent = document.getElementById('enemyRelease').value;
            document.getElementById('pestGrowthVal').textContent = document.getElementById('pestGrowth').value;
        }

        document.querySelectorAll('input[type="range"]').forEach(slider => {
            slider.addEventListener('input', updateSliderDisplays);
        });

        // Initialize
        initSimulation();
        draw();
    </script>
</body>
</html>
