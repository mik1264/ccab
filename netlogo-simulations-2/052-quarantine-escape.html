<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quarantine Escape - Compliance Threshold Model</title>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&family=Nunito:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --sage: #8A9A5B;
            --moss: #606C38;
            --earth: #DDA15E;
            --cream: #FEFAE0;
            --terracotta: #BC6C25;
            --dark-moss: #3d4423;
            --susceptible: #4A90D9;
            --infected: #D94A4A;
            --quarantined: #9B59B6;
            --recovered: #4AD97A;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, #F4F1DE 50%, #EDE8D5 100%);
            min-height: 100vh;
            color: var(--dark-moss);
            padding: 20px;
        }

        .organic-back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            text-decoration: none;
            color: var(--moss);
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .organic-back-link:hover {
            background: var(--moss);
            color: white;
            transform: translateX(-5px);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding-top: 60px;
        }

        h1 {
            font-family: 'Lora', serif;
            font-size: 2.5rem;
            color: var(--moss);
            text-align: center;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: var(--terracotta);
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        .simulation-area {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 20px;
        }

        .controls {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            max-height: calc(100vh - 150px);
            overflow-y: auto;
        }

        .control-section {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(96, 108, 56, 0.2);
        }

        .control-section:last-child {
            border-bottom: none;
        }

        .control-section h3 {
            color: var(--moss);
            font-size: 1rem;
            margin-bottom: 12px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            font-weight: 600;
            color: var(--moss);
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .control-group input[type="range"] {
            width: 100%;
            accent-color: var(--moss);
        }

        .control-group .value {
            text-align: right;
            font-size: 0.85rem;
            color: var(--terracotta);
        }

        button {
            width: 100%;
            padding: 12px;
            background: var(--moss);
            color: white;
            border: none;
            border-radius: 10px;
            font-family: 'Nunito', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        button:hover {
            background: var(--terracotta);
            transform: translateY(-2px);
        }

        button.secondary {
            background: var(--sage);
        }

        .main-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .canvas-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        canvas {
            width: 100%;
            border-radius: 10px;
            background: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
        }

        .stat-box {
            background: linear-gradient(135deg, var(--sage) 0%, var(--moss) 100%);
            color: white;
            padding: 12px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-box.susceptible {
            background: linear-gradient(135deg, #5BA3E8 0%, var(--susceptible) 100%);
        }

        .stat-box.infected {
            background: linear-gradient(135deg, #E85B5B 0%, var(--infected) 100%);
        }

        .stat-box.quarantined {
            background: linear-gradient(135deg, #A76BC4 0%, var(--quarantined) 100%);
        }

        .stat-box.recovered {
            background: linear-gradient(135deg, #5BE87A 0%, var(--recovered) 100%);
        }

        .stat-box.re {
            background: linear-gradient(135deg, var(--earth) 0%, var(--terracotta) 100%);
        }

        .stat-box .label {
            font-size: 0.75rem;
            opacity: 0.9;
        }

        .stat-box .value {
            font-size: 1.2rem;
            font-weight: 700;
            font-family: 'Lora', serif;
        }

        .threshold-display {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-top: 15px;
        }

        .threshold-display h4 {
            color: var(--moss);
            font-size: 1rem;
            margin-bottom: 15px;
            text-align: center;
        }

        .threshold-meter {
            height: 40px;
            background: linear-gradient(90deg, #D94A4A 0%, #DDA15E 50%, #4AD97A 100%);
            border-radius: 20px;
            position: relative;
            margin-bottom: 10px;
        }

        .threshold-marker {
            position: absolute;
            width: 4px;
            height: 50px;
            background: var(--dark-moss);
            top: -5px;
            transition: left 0.3s ease;
        }

        .current-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border: 3px solid var(--dark-moss);
            border-radius: 50%;
            top: 10px;
            transform: translateX(-50%);
            transition: left 0.3s ease;
        }

        .threshold-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
        }

        .outcome-indicator {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .outcome-indicator.outbreak {
            background: rgba(217, 74, 74, 0.2);
            color: var(--infected);
        }

        .outcome-indicator.controlled {
            background: rgba(74, 217, 122, 0.2);
            color: var(--recovered);
        }

        .outcome-indicator.borderline {
            background: rgba(221, 161, 94, 0.2);
            color: var(--terracotta);
        }

        .dual-canvas {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .info-panel {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .equation {
            font-family: 'Times New Roman', serif;
            font-size: 1rem;
            text-align: center;
            padding: 8px;
            background: rgba(96, 108, 56, 0.1);
            border-radius: 8px;
            margin: 8px 0;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        @media (max-width: 1100px) {
            .simulation-area {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .dual-canvas {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <a href="index.html" class="organic-back-link">
        <span>←</span>
        <span>Back to Gallery</span>
    </a>

    <div class="container">
        <h1>Quarantine Escape</h1>
        <p class="subtitle">Compliance Thresholds for Outbreak Control</p>

        <div class="simulation-area">
            <div class="controls">
                <div class="control-section">
                    <h3>Disease Parameters</h3>
                    <div class="control-group">
                        <label>Basic R₀</label>
                        <input type="range" id="r0" min="1.5" max="6" step="0.1" value="3">
                        <div class="value" id="r0Value">3.0</div>
                    </div>
                    <div class="control-group">
                        <label>Recovery Rate (γ) per day</label>
                        <input type="range" id="gamma" min="0.05" max="0.3" step="0.01" value="0.1">
                        <div class="value" id="gammaValue">0.10</div>
                    </div>
                    <div class="control-group">
                        <label>Initial Infected (%)</label>
                        <input type="range" id="initInfected" min="0.1" max="5" step="0.1" value="0.5">
                        <div class="value" id="initInfectedValue">0.5%</div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Quarantine Parameters</h3>
                    <div class="control-group">
                        <label>Compliance Rate (%)</label>
                        <input type="range" id="compliance" min="0" max="100" step="1" value="60">
                        <div class="value" id="complianceValue">60%</div>
                    </div>
                    <div class="control-group">
                        <label>Detection Delay (days)</label>
                        <input type="range" id="detectionDelay" min="0" max="10" step="0.5" value="3">
                        <div class="value" id="detectionDelayValue">3.0 days</div>
                    </div>
                    <div class="control-group">
                        <label>Quarantine Duration (days)</label>
                        <input type="range" id="quarantineDuration" min="5" max="21" step="1" value="14">
                        <div class="value" id="quarantineDurationValue">14 days</div>
                    </div>
                    <div class="control-group">
                        <label>Escape Rate (%/day)</label>
                        <input type="range" id="escapeRate" min="0" max="20" step="1" value="5">
                        <div class="value" id="escapeRateValue">5%</div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Contact Tracing</h3>
                    <div class="control-group">
                        <label>Tracing Efficiency (%)</label>
                        <input type="range" id="tracingEff" min="0" max="100" step="5" value="50">
                        <div class="value" id="tracingEffValue">50%</div>
                    </div>
                </div>

                <button id="runBtn">▶ Run Simulation</button>
                <button id="stepBtn" class="secondary">Step (1 day)</button>
                <button id="resetBtn" class="secondary">Reset</button>

                <div class="info-panel">
                    <h3 style="color: var(--moss); margin-bottom: 8px;">Critical Compliance Threshold</h3>
                    <p>Quarantine is effective when:</p>
                    <div class="equation">R_e = R₀ × (1 - q × c × e)</div>
                    <p>Where q = quarantine rate, c = compliance, e = effectiveness.</p>
                    <p style="margin-top: 8px;">To control outbreak: R_e &lt; 1, requiring compliance above critical threshold.</p>
                </div>
            </div>

            <div class="main-area">
                <div class="dual-canvas">
                    <div class="canvas-container">
                        <canvas id="dynamicsCanvas"></canvas>
                        <div class="legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--susceptible);"></div>
                                <span>Susceptible</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--infected);"></div>
                                <span>Infected</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--quarantined);"></div>
                                <span>Quarantined</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--recovered);"></div>
                                <span>Recovered</span>
                            </div>
                        </div>
                    </div>
                    <div class="canvas-container">
                        <canvas id="complianceCanvas"></canvas>
                        <div class="legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--terracotta);"></div>
                                <span>Peak Infected</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--moss);"></div>
                                <span>Final Size</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-box susceptible">
                        <div class="label">Susceptible</div>
                        <div class="value" id="statS">99.5%</div>
                    </div>
                    <div class="stat-box infected">
                        <div class="label">Infected</div>
                        <div class="value" id="statI">0.5%</div>
                    </div>
                    <div class="stat-box quarantined">
                        <div class="label">Quarantined</div>
                        <div class="value" id="statQ">0%</div>
                    </div>
                    <div class="stat-box recovered">
                        <div class="label">Recovered</div>
                        <div class="value" id="statR">0%</div>
                    </div>
                    <div class="stat-box re">
                        <div class="label">Effective R</div>
                        <div class="value" id="statRe">3.00</div>
                    </div>
                </div>

                <div class="threshold-display">
                    <h4>Compliance Threshold Analysis</h4>
                    <div class="threshold-meter">
                        <div class="threshold-marker" id="thresholdMarker" style="left: 67%"></div>
                        <div class="current-marker" id="currentMarker" style="left: 60%"></div>
                    </div>
                    <div class="threshold-labels">
                        <span>0% Compliance</span>
                        <span>Critical: <span id="criticalThreshold">67%</span></span>
                        <span>100% Compliance</span>
                    </div>
                    <div class="outcome-indicator borderline" id="outcomeIndicator">
                        <span id="outcomeText">Borderline Control</span>
                    </div>
                    <div style="text-align: center; margin-top: 10px; font-size: 0.85rem;">
                        <span>Day: <strong id="dayCount">0</strong></span>
                        <span style="margin-left: 20px;">Peak Infected: <strong id="peakInfected">0%</strong></span>
                        <span style="margin-left: 20px;">Final Attack Rate: <strong id="finalSize">0%</strong></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Canvas setup
        const dynCanvas = document.getElementById('dynamicsCanvas');
        const dynCtx = dynCanvas.getContext('2d');
        const compCanvas = document.getElementById('complianceCanvas');
        const compCtx = compCanvas.getContext('2d');

        function setupCanvas(canvas, ctx) {
            const rect = canvas.parentElement.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            canvas.width = (rect.width - 40) * dpr;
            canvas.height = 280 * dpr;
            canvas.style.width = (rect.width - 40) + 'px';
            canvas.style.height = '280px';
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.scale(dpr, dpr);
        }

        function setupAllCanvases() {
            setupCanvas(dynCanvas, dynCtx);
            setupCanvas(compCanvas, compCtx);
        }
        setupAllCanvases();
        window.addEventListener('resize', () => { setupAllCanvases(); draw(); });

        // Simulation state
        let S, I, Q, R;
        let N = 10000;
        let day = 0;
        let history = { S: [], I: [], Q: [], R: [], days: [] };
        let peakI = 0;
        let running = false;
        let animationId = null;

        // Parameters
        let R0 = 3;
        let gamma = 0.1;        // recovery rate
        let initInfectedPct = 0.5;
        let compliance = 0.6;   // quarantine compliance
        let detectionDelay = 3; // days until detection
        let quarantineDuration = 14;
        let escapeRate = 0.05;  // daily escape rate from quarantine
        let tracingEff = 0.5;   // contact tracing efficiency

        // Calculate beta from R0
        function getBeta() {
            return R0 * gamma;
        }

        // Calculate effective reproduction number
        function calculateRe() {
            const qRate = 1 / detectionDelay; // rate of entering quarantine
            const effectiveness = (1 - escapeRate) * compliance;
            const reduction = qRate * effectiveness / (qRate + gamma);
            return R0 * (1 - reduction * tracingEff);
        }

        // Calculate critical compliance threshold
        function calculateCriticalCompliance() {
            const qRate = 1 / detectionDelay;
            const effectiveness = 1 - escapeRate;
            const reduction = qRate * effectiveness * tracingEff / (qRate + gamma);
            // Need R0 * (1 - reduction * c) = 1
            // So c = (R0 - 1) / (R0 * reduction)
            if (reduction <= 0) return 1;
            const critical = (R0 - 1) / (R0 * reduction);
            return Math.min(1, Math.max(0, critical));
        }

        // Initialize simulation
        function init() {
            const initI = Math.floor(N * initInfectedPct / 100);
            I = initI;
            Q = 0;
            R = 0;
            S = N - I;
            day = 0;
            peakI = I;
            history = { S: [S/N], I: [I/N], Q: [Q/N], R: [R/N], days: [0] };
            updateStats();
            updateThresholdDisplay();
        }

        // Simulation step
        function step() {
            day++;

            const beta = getBeta();
            const dt = 1;

            // Detection and quarantine rate
            const detectionRate = 1 / Math.max(0.5, detectionDelay);

            // New infections
            const forceOfInfection = beta * I * S / N;
            const newInfections = Math.floor(forceOfInfection * dt);

            // Quarantine from infected (detected cases)
            const toQuarantine = Math.floor(I * detectionRate * compliance * dt);

            // Escape from quarantine
            const escapes = Math.floor(Q * escapeRate * dt);

            // Recovery
            const recoverFromI = Math.floor(I * gamma * dt);
            const recoverFromQ = Math.floor(Q / quarantineDuration * dt);

            // Contact tracing: quarantine some susceptibles who are contacts
            const contactsQuarantined = Math.floor(newInfections * tracingEff * compliance * 0.3 * dt);

            // Update compartments
            S = Math.max(0, S - newInfections - contactsQuarantined);
            I = Math.max(0, I + newInfections + escapes - toQuarantine - recoverFromI);
            Q = Math.max(0, Q + toQuarantine + contactsQuarantined - escapes - recoverFromQ);
            R = R + recoverFromI + recoverFromQ;

            // Track peak
            peakI = Math.max(peakI, I);

            // Record history
            history.S.push(S / N);
            history.I.push(I / N);
            history.Q.push(Q / N);
            history.R.push(R / N);
            history.days.push(day);

            // Limit history
            const maxHistory = 500;
            if (history.days.length > maxHistory) {
                history.S.shift();
                history.I.shift();
                history.Q.shift();
                history.R.shift();
                history.days.shift();
            }

            updateStats();
        }

        // Update statistics
        function updateStats() {
            document.getElementById('statS').textContent = (S / N * 100).toFixed(1) + '%';
            document.getElementById('statI').textContent = (I / N * 100).toFixed(2) + '%';
            document.getElementById('statQ').textContent = (Q / N * 100).toFixed(2) + '%';
            document.getElementById('statR').textContent = (R / N * 100).toFixed(1) + '%';

            const Re = calculateRe();
            document.getElementById('statRe').textContent = Re.toFixed(2);
            document.getElementById('dayCount').textContent = day;
            document.getElementById('peakInfected').textContent = (peakI / N * 100).toFixed(2) + '%';
            document.getElementById('finalSize').textContent = (R / N * 100).toFixed(1) + '%';

            updateThresholdDisplay();
        }

        // Update threshold display
        function updateThresholdDisplay() {
            const critical = calculateCriticalCompliance();
            const Re = calculateRe();

            document.getElementById('criticalThreshold').textContent = (critical * 100).toFixed(0) + '%';
            document.getElementById('thresholdMarker').style.left = (critical * 100) + '%';
            document.getElementById('currentMarker').style.left = (compliance * 100) + '%';

            const indicator = document.getElementById('outcomeIndicator');
            const outcomeText = document.getElementById('outcomeText');

            if (Re < 0.9) {
                indicator.className = 'outcome-indicator controlled';
                outcomeText.textContent = '✓ Outbreak Controlled (Re < 1)';
            } else if (Re > 1.1) {
                indicator.className = 'outcome-indicator outbreak';
                outcomeText.textContent = '✗ Outbreak Spreading (Re > 1)';
            } else {
                indicator.className = 'outcome-indicator borderline';
                outcomeText.textContent = '~ Borderline Control (Re ≈ 1)';
            }
        }

        // Draw dynamics canvas
        function drawDynamics() {
            const width = dynCanvas.width / (window.devicePixelRatio || 1);
            const height = dynCanvas.height / (window.devicePixelRatio || 1);
            const padding = { top: 35, right: 20, bottom: 40, left: 50 };
            const plotWidth = width - padding.left - padding.right;
            const plotHeight = height - padding.top - padding.bottom;

            dynCtx.fillStyle = '#FEFAE0';
            dynCtx.fillRect(0, 0, width, height);

            // Grid
            dynCtx.strokeStyle = '#E0DCC8';
            dynCtx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding.top + (plotHeight * i / 5);
                dynCtx.beginPath();
                dynCtx.moveTo(padding.left, y);
                dynCtx.lineTo(width - padding.right, y);
                dynCtx.stroke();
            }

            // Axes
            dynCtx.strokeStyle = '#606C38';
            dynCtx.lineWidth = 2;
            dynCtx.beginPath();
            dynCtx.moveTo(padding.left, padding.top);
            dynCtx.lineTo(padding.left, height - padding.bottom);
            dynCtx.lineTo(width - padding.right, height - padding.bottom);
            dynCtx.stroke();

            // Labels
            dynCtx.fillStyle = '#3d4423';
            dynCtx.font = '12px Nunito';
            dynCtx.textAlign = 'center';
            dynCtx.fillText('Days', width / 2, height - 8);

            dynCtx.save();
            dynCtx.translate(12, height / 2);
            dynCtx.rotate(-Math.PI / 2);
            dynCtx.fillText('Population %', 0, 0);
            dynCtx.restore();

            // Y-axis ticks
            dynCtx.textAlign = 'right';
            for (let i = 0; i <= 5; i++) {
                const y = padding.top + (plotHeight * i / 5);
                const val = ((5 - i) * 20).toFixed(0);
                dynCtx.fillText(val + '%', padding.left - 8, y + 4);
            }

            // X-axis ticks
            const maxDay = Math.max(100, day);
            const minDay = history.days[0] || 0;
            dynCtx.textAlign = 'center';
            for (let d = 0; d <= 5; d++) {
                const dayVal = Math.round(minDay + (maxDay - minDay) * d / 5);
                const x = padding.left + plotWidth * d / 5;
                dynCtx.fillText(dayVal.toString(), x, height - padding.bottom + 15);
            }

            // Draw lines
            function drawLine(data, color, lineWidth = 2) {
                if (data.length < 2) return;
                dynCtx.strokeStyle = color;
                dynCtx.lineWidth = lineWidth;
                dynCtx.beginPath();

                for (let i = 0; i < data.length; i++) {
                    const x = padding.left + plotWidth * (history.days[i] - minDay) / (maxDay - minDay);
                    const y = padding.top + plotHeight * (1 - data[i]);
                    if (i === 0) dynCtx.moveTo(x, y);
                    else dynCtx.lineTo(x, y);
                }
                dynCtx.stroke();
            }

            drawLine(history.S, '#4A90D9', 2);
            drawLine(history.R, '#4AD97A', 2);
            drawLine(history.Q, '#9B59B6', 2);
            drawLine(history.I, '#D94A4A', 3);

            // Title
            dynCtx.fillStyle = '#606C38';
            dynCtx.font = 'bold 14px Lora';
            dynCtx.textAlign = 'left';
            dynCtx.fillText('SIQR Epidemic Dynamics', padding.left, 20);
        }

        // Draw compliance analysis canvas
        function drawComplianceAnalysis() {
            const width = compCanvas.width / (window.devicePixelRatio || 1);
            const height = compCanvas.height / (window.devicePixelRatio || 1);
            const padding = { top: 35, right: 20, bottom: 40, left: 50 };
            const plotWidth = width - padding.left - padding.right;
            const plotHeight = height - padding.top - padding.bottom;

            compCtx.fillStyle = '#FEFAE0';
            compCtx.fillRect(0, 0, width, height);

            // Grid
            compCtx.strokeStyle = '#E0DCC8';
            compCtx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding.top + (plotHeight * i / 5);
                compCtx.beginPath();
                compCtx.moveTo(padding.left, y);
                compCtx.lineTo(width - padding.right, y);
                compCtx.stroke();
            }

            // Axes
            compCtx.strokeStyle = '#606C38';
            compCtx.lineWidth = 2;
            compCtx.beginPath();
            compCtx.moveTo(padding.left, padding.top);
            compCtx.lineTo(padding.left, height - padding.bottom);
            compCtx.lineTo(width - padding.right, height - padding.bottom);
            compCtx.stroke();

            // Labels
            compCtx.fillStyle = '#3d4423';
            compCtx.font = '12px Nunito';
            compCtx.textAlign = 'center';
            compCtx.fillText('Compliance Rate (%)', width / 2, height - 8);

            compCtx.save();
            compCtx.translate(12, height / 2);
            compCtx.rotate(-Math.PI / 2);
            compCtx.fillText('Outcome (%)', 0, 0);
            compCtx.restore();

            // Y-axis ticks
            compCtx.textAlign = 'right';
            for (let i = 0; i <= 5; i++) {
                const y = padding.top + (plotHeight * i / 5);
                const val = ((5 - i) * 20).toFixed(0);
                compCtx.fillText(val + '%', padding.left - 8, y + 4);
            }

            // X-axis ticks
            compCtx.textAlign = 'center';
            for (let c = 0; c <= 5; c++) {
                const compVal = c * 20;
                const x = padding.left + plotWidth * c / 5;
                compCtx.fillText(compVal + '%', x, height - padding.bottom + 15);
            }

            // Calculate outcomes for different compliance levels (simplified model)
            const outcomes = [];
            for (let c = 0; c <= 100; c += 2) {
                const testCompliance = c / 100;
                const qRate = 1 / Math.max(0.5, detectionDelay);
                const effectiveness = (1 - escapeRate) * testCompliance;
                const reduction = qRate * effectiveness * tracingEff / (qRate + gamma);
                const Re = R0 * (1 - reduction);

                // Simplified final size calculation
                let finalSize, peakSize;
                if (Re <= 1) {
                    finalSize = initInfectedPct / 100 * Re;
                    peakSize = initInfectedPct / 100;
                } else {
                    // Heuristic: final size increases with Re
                    finalSize = Math.min(0.95, 1 - 1/Re + 0.1 * Math.log(Re));
                    peakSize = finalSize / (2 + Re);
                }

                outcomes.push({ compliance: c, finalSize, peakSize, Re });
            }

            // Draw final size curve
            compCtx.strokeStyle = '#606C38';
            compCtx.lineWidth = 3;
            compCtx.beginPath();
            for (let i = 0; i < outcomes.length; i++) {
                const x = padding.left + plotWidth * outcomes[i].compliance / 100;
                const y = padding.top + plotHeight * (1 - outcomes[i].finalSize);
                if (i === 0) compCtx.moveTo(x, y);
                else compCtx.lineTo(x, y);
            }
            compCtx.stroke();

            // Draw peak infected curve
            compCtx.strokeStyle = '#BC6C25';
            compCtx.lineWidth = 3;
            compCtx.beginPath();
            for (let i = 0; i < outcomes.length; i++) {
                const x = padding.left + plotWidth * outcomes[i].compliance / 100;
                const y = padding.top + plotHeight * (1 - outcomes[i].peakSize);
                if (i === 0) compCtx.moveTo(x, y);
                else compCtx.lineTo(x, y);
            }
            compCtx.stroke();

            // Mark critical threshold
            const critical = calculateCriticalCompliance();
            const critX = padding.left + plotWidth * critical;

            compCtx.setLineDash([5, 5]);
            compCtx.strokeStyle = '#D94A4A';
            compCtx.lineWidth = 2;
            compCtx.beginPath();
            compCtx.moveTo(critX, padding.top);
            compCtx.lineTo(critX, height - padding.bottom);
            compCtx.stroke();
            compCtx.setLineDash([]);

            // Mark current compliance
            const currX = padding.left + plotWidth * compliance;
            compCtx.fillStyle = '#3d4423';
            compCtx.beginPath();
            compCtx.arc(currX, padding.top + plotHeight * 0.5, 6, 0, Math.PI * 2);
            compCtx.fill();

            // Title
            compCtx.fillStyle = '#606C38';
            compCtx.font = 'bold 14px Lora';
            compCtx.textAlign = 'left';
            compCtx.fillText('Compliance Impact Analysis', padding.left, 20);

            // Critical threshold label
            compCtx.font = '10px Nunito';
            compCtx.fillStyle = '#D94A4A';
            compCtx.textAlign = 'center';
            compCtx.fillText('Critical', critX, padding.top - 5);
        }

        function draw() {
            drawDynamics();
            drawComplianceAnalysis();
        }

        // Animation loop
        function animate() {
            if (!running) return;

            for (let i = 0; i < 3; i++) step();
            draw();

            if (day < 365 && I > 0.5) {
                animationId = requestAnimationFrame(animate);
            } else {
                running = false;
                document.getElementById('runBtn').textContent = '▶ Run Simulation';
            }
        }

        // Event handlers
        document.getElementById('runBtn').addEventListener('click', () => {
            if (running) {
                running = false;
                cancelAnimationFrame(animationId);
                document.getElementById('runBtn').textContent = '▶ Run Simulation';
            } else {
                running = true;
                document.getElementById('runBtn').textContent = '⏸ Pause';
                animate();
            }
        });

        document.getElementById('stepBtn').addEventListener('click', () => {
            if (!running) {
                step();
                draw();
            }
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            running = false;
            cancelAnimationFrame(animationId);
            document.getElementById('runBtn').textContent = '▶ Run Simulation';
            init();
            draw();
        });

        // Parameter controls
        document.getElementById('r0').addEventListener('input', function() {
            R0 = parseFloat(this.value);
            document.getElementById('r0Value').textContent = R0.toFixed(1);
            updateThresholdDisplay();
            draw();
        });

        document.getElementById('gamma').addEventListener('input', function() {
            gamma = parseFloat(this.value);
            document.getElementById('gammaValue').textContent = gamma.toFixed(2);
            updateThresholdDisplay();
            draw();
        });

        document.getElementById('initInfected').addEventListener('input', function() {
            initInfectedPct = parseFloat(this.value);
            document.getElementById('initInfectedValue').textContent = initInfectedPct.toFixed(1) + '%';
        });

        document.getElementById('compliance').addEventListener('input', function() {
            compliance = parseInt(this.value) / 100;
            document.getElementById('complianceValue').textContent = (compliance * 100).toFixed(0) + '%';
            updateThresholdDisplay();
            draw();
        });

        document.getElementById('detectionDelay').addEventListener('input', function() {
            detectionDelay = parseFloat(this.value);
            document.getElementById('detectionDelayValue').textContent = detectionDelay.toFixed(1) + ' days';
            updateThresholdDisplay();
            draw();
        });

        document.getElementById('quarantineDuration').addEventListener('input', function() {
            quarantineDuration = parseInt(this.value);
            document.getElementById('quarantineDurationValue').textContent = quarantineDuration + ' days';
        });

        document.getElementById('escapeRate').addEventListener('input', function() {
            escapeRate = parseInt(this.value) / 100;
            document.getElementById('escapeRateValue').textContent = (escapeRate * 100).toFixed(0) + '%';
            updateThresholdDisplay();
            draw();
        });

        document.getElementById('tracingEff').addEventListener('input', function() {
            tracingEff = parseInt(this.value) / 100;
            document.getElementById('tracingEffValue').textContent = (tracingEff * 100).toFixed(0) + '%';
            updateThresholdDisplay();
            draw();
        });

        // Initialize
        init();
        draw();
    </script>
</body>
</html>
