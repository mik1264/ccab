<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forest Management - Timber Harvest Simulation</title>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600&family=Nunito:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #FEFAE0 0%, #F4F1DE 50%, #EDE8D5 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 20px; }
        h1 { font-family: 'Lora', serif; color: #606C38; font-size: 2rem; margin-bottom: 8px; }
        .subtitle { color: #8A9A5B; font-size: 1rem; }
        .back-link {
            position: absolute; top: 20px; left: 20px;
            text-decoration: none; color: #606C38; font-weight: 600;
            display: flex; align-items: center; gap: 5px; transition: color 0.3s;
        }
        .back-link:hover { color: #BC6C25; }
        .main-content { display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        .canvas-container {
            background: white; border-radius: 12px; padding: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        canvas { width: 100%; border-radius: 8px; display: block; }
        .controls {
            background: white; border-radius: 12px; padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08); height: fit-content;
        }
        .control-group { margin-bottom: 18px; }
        .control-group label {
            display: block; color: #606C38; font-weight: 600;
            margin-bottom: 5px; font-size: 0.9rem;
        }
        .control-group input[type="range"] { width: 100%; accent-color: #8A9A5B; }
        .control-value { text-align: right; color: #8A9A5B; font-size: 0.85rem; }
        button {
            width: 100%; padding: 10px; margin-top: 5px; border: none;
            border-radius: 8px; cursor: pointer; font-family: 'Nunito', sans-serif;
            font-weight: 600; font-size: 0.9rem; transition: all 0.3s;
        }
        .btn-primary { background: #8A9A5B; color: white; }
        .btn-primary:hover { background: #606C38; }
        .btn-secondary { background: #DDA15E; color: white; }
        .btn-secondary:hover { background: #BC6C25; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .stat-box {
            background: linear-gradient(135deg, #FEFAE0, #F4F1DE);
            padding: 10px; border-radius: 8px; text-align: center;
        }
        .stat-value { font-family: 'Lora', serif; color: #606C38; font-size: 1.1rem; font-weight: 600; }
        .stat-label { color: #8A9A5B; font-size: 0.75rem; }
        .info-panel {
            margin-top: 15px; padding: 12px; background: #F4F1DE;
            border-radius: 8px; font-size: 0.8rem; color: #606C38;
        }
        select {
            width: 100%; padding: 8px; border: 1px solid #DDA15E;
            border-radius: 6px; font-family: 'Nunito', sans-serif;
            background: white; color: #606C38;
        }
        .scenario-btn { width: 100%; padding: 8px; margin-top: 5px; font-size: 0.8rem; }
        .sustainability-meter {
            margin-top: 10px; padding: 10px; border-radius: 6px;
            text-align: center; font-weight: 600;
        }
        .sustainable { background: #90EE90; color: #228B22; }
        .warning { background: #FFD700; color: #8B4513; }
        .unsustainable { background: #FFB6C1; color: #DC143C; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back to Gallery</a>

    <div class="container">
        <header>
            <h1>Forest Management Simulation</h1>
            <p class="subtitle">Age-class dynamics, rotation length, and sustainable harvest scheduling</p>
        </header>

        <div class="main-content">
            <div class="canvas-container">
                <canvas id="simCanvas"></canvas>
            </div>

            <div class="controls">
                <div class="sustainability-meter sustainable" id="sustainMeter">
                    Sustainable Yield
                </div>

                <div class="control-group">
                    <label>Harvest Strategy</label>
                    <select id="strategy">
                        <option value="rotation" selected>Fixed Rotation</option>
                        <option value="sustained-yield">Sustained Yield</option>
                        <option value="clearcut">Clearcut All Mature</option>
                        <option value="selection">Selection Cutting</option>
                        <option value="no-harvest">No Harvest (Reserve)</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Tree Species</label>
                    <select id="species">
                        <option value="pine">Pine (Fast Growth, 30yr rotation)</option>
                        <option value="oak" selected>Oak (Medium Growth, 60yr rotation)</option>
                        <option value="redwood">Redwood (Slow Growth, 100yr rotation)</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Rotation Length (years)</label>
                    <input type="range" id="rotationLength" min="20" max="120" value="60">
                    <div class="control-value"><span id="rotationLengthVal">60</span> years</div>
                </div>

                <div class="control-group">
                    <label>Harvest Intensity (%)</label>
                    <input type="range" id="harvestIntensity" min="10" max="100" value="80">
                    <div class="control-value"><span id="harvestIntensityVal">80</span>%</div>
                </div>

                <div class="control-group">
                    <label>Regeneration Rate</label>
                    <input type="range" id="regenRate" min="50" max="100" value="85">
                    <div class="control-value"><span id="regenRateVal">85</span>%</div>
                </div>

                <button class="btn-primary" onclick="startSimulation()">Start Simulation</button>
                <button class="btn-secondary" onclick="resetSimulation()">Reset</button>

                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="totalVolume">0</div>
                        <div class="stat-label">Standing Vol (m³)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="annualGrowth">0</div>
                        <div class="stat-label">Growth (m³/yr)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="annualHarvest">0</div>
                        <div class="stat-label">Harvest (m³/yr)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="lev">$0</div>
                        <div class="stat-label">LEV ($/ha)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="totalRevenue">$0</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="carbonStock">0</div>
                        <div class="stat-label">Carbon (tC/ha)</div>
                    </div>
                </div>

                <div class="info-panel">
                    <strong>Faustmann LEV:</strong> NPV of infinite rotations.<br>
                    <strong>MAI:</strong> Mean Annual Increment (optimal rotation).<br>
                    Sustainable = Growth ≥ Harvest
                </div>

                <div class="control-group" style="margin-top:15px">
                    <label>Scenarios</label>
                    <button class="scenario-btn btn-secondary" onclick="loadPreset('sustainable')">Sustainable Forestry</button>
                    <button class="scenario-btn btn-secondary" onclick="loadPreset('intensive')">Intensive Harvest</button>
                    <button class="scenario-btn btn-secondary" onclick="loadPreset('conservation')">Conservation Focus</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');

        function setupCanvas() {
            const rect = canvas.parentElement.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            canvas.width = rect.width * dpr;
            canvas.height = (rect.width * 0.65) * dpr;
            canvas.style.height = (rect.width * 0.65) + 'px';
            ctx.scale(dpr, dpr);
            return { width: rect.width, height: rect.width * 0.65 };
        }

        let dims = setupCanvas();
        window.addEventListener('resize', () => { dims = setupCanvas(); draw(); });

        // Species parameters
        const speciesParams = {
            pine: {
                name: 'Pine', maxAge: 80, peakGrowth: 20,
                maxVolume: 400, growthRate: 1.2,
                pricePerM3: 60, color: '#228B22'
            },
            oak: {
                name: 'Oak', maxAge: 150, peakGrowth: 40,
                maxVolume: 600, growthRate: 0.8,
                pricePerM3: 120, color: '#2E8B57'
            },
            redwood: {
                name: 'Redwood', maxAge: 300, peakGrowth: 70,
                maxVolume: 1200, growthRate: 0.5,
                pricePerM3: 200, color: '#8B4513'
            }
        };

        // Simulation state
        let state = {
            year: 0,
            running: false,
            ageClasses: [], // Array of stands with age and area
            harvestHistory: [],
            growthHistory: [],
            volumeHistory: [],
            totalRevenue: 0,
            trees: [] // Visual representation
        };

        const simulationYears = 150;
        const numStands = 20;

        // Calculate volume for a stand based on age
        function getVolume(age, species) {
            const sp = speciesParams[species];
            // Chapman-Richards growth function
            const maxVol = sp.maxVolume;
            const k = sp.growthRate / sp.peakGrowth;
            return maxVol * Math.pow(1 - Math.exp(-k * age), 3);
        }

        // Calculate annual growth increment
        function getGrowthIncrement(age, species) {
            const sp = speciesParams[species];
            const k = sp.growthRate / sp.peakGrowth;
            const maxVol = sp.maxVolume;
            // Derivative of Chapman-Richards
            const term = 1 - Math.exp(-k * age);
            return maxVol * 3 * k * Math.exp(-k * age) * Math.pow(term, 2);
        }

        // Calculate Mean Annual Increment (MAI)
        function getMAI(age, species) {
            if (age === 0) return 0;
            return getVolume(age, species) / age;
        }

        // Calculate Faustmann Land Expectation Value
        function calculateLEV(rotation, species) {
            const sp = speciesParams[species];
            const volume = getVolume(rotation, species);
            const revenue = volume * sp.pricePerM3;
            const plantingCost = 500;
            const r = 0.03; // 3% discount rate

            // LEV = (R - C) / (e^(r*t) - 1)
            return (revenue - plantingCost) / (Math.exp(r * rotation) - 1);
        }

        // Initialize simulation
        function initSimulation() {
            const species = document.getElementById('species').value;
            const sp = speciesParams[species];

            state = {
                year: 0,
                running: false,
                ageClasses: [],
                harvestHistory: [],
                growthHistory: [],
                volumeHistory: [],
                totalRevenue: 0,
                trees: []
            };

            // Initialize age class distribution (even-aged or mixed)
            for (let i = 0; i < numStands; i++) {
                state.ageClasses.push({
                    age: Math.floor(Math.random() * sp.maxAge * 0.7),
                    area: 100 / numStands // 100 ha total
                });
            }

            // Initialize visual trees
            initTrees();
            updateUI();
        }

        function initTrees() {
            state.trees = [];
            const treeCount = 150;
            for (let i = 0; i < treeCount; i++) {
                state.trees.push({
                    x: 30 + Math.random() * (dims.width * 0.5 - 60),
                    y: 50 + Math.random() * (dims.height - 120),
                    standIndex: Math.floor(Math.random() * numStands),
                    sway: Math.random() * Math.PI * 2
                });
            }
        }

        // Run one year of simulation
        function updateYear() {
            const species = document.getElementById('species').value;
            const strategy = document.getElementById('strategy').value;
            const rotationLength = parseInt(document.getElementById('rotationLength').value);
            const harvestIntensity = parseInt(document.getElementById('harvestIntensity').value) / 100;
            const regenRate = parseInt(document.getElementById('regenRate').value) / 100;
            const sp = speciesParams[species];

            let totalGrowth = 0;
            let totalHarvest = 0;

            // Age all stands and calculate growth
            state.ageClasses.forEach(stand => {
                const growth = getGrowthIncrement(stand.age, species) * stand.area;
                totalGrowth += growth;
            });

            // Harvest based on strategy
            state.ageClasses.forEach((stand, i) => {
                let harvestThis = false;
                let harvestAmount = 0;

                switch (strategy) {
                    case 'rotation':
                        if (stand.age >= rotationLength) {
                            harvestThis = true;
                            harvestAmount = getVolume(stand.age, species) * stand.area * harvestIntensity;
                        }
                        break;

                    case 'sustained-yield':
                        // Harvest oldest stands to match average growth
                        const avgGrowthPerHa = totalGrowth / 100;
                        if (stand.age >= rotationLength && i < numStands / rotationLength) {
                            harvestThis = true;
                            harvestAmount = getVolume(stand.age, species) * stand.area * harvestIntensity;
                        }
                        break;

                    case 'clearcut':
                        if (stand.age >= sp.peakGrowth) {
                            harvestThis = true;
                            harvestAmount = getVolume(stand.age, species) * stand.area;
                        }
                        break;

                    case 'selection':
                        // Continuous light harvest of mature trees
                        if (stand.age > rotationLength * 0.5) {
                            const selectFraction = 0.1;
                            harvestAmount = getVolume(stand.age, species) * stand.area * selectFraction;
                            totalHarvest += harvestAmount;
                            // Don't reset age for selection cutting
                        }
                        break;

                    case 'no-harvest':
                        // No harvesting
                        break;
                }

                if (harvestThis && strategy !== 'selection') {
                    totalHarvest += harvestAmount;
                    state.totalRevenue += harvestAmount * sp.pricePerM3;

                    // Regenerate with some failure rate
                    if (Math.random() < regenRate) {
                        stand.age = 0;
                    } else {
                        stand.age = Math.floor(Math.random() * 5);
                    }
                } else if (strategy !== 'selection') {
                    stand.age++;
                } else {
                    stand.age++;
                }
            });

            // Record history
            state.harvestHistory.push(totalHarvest);
            state.growthHistory.push(totalGrowth);

            // Calculate total standing volume
            let totalVolume = 0;
            state.ageClasses.forEach(stand => {
                totalVolume += getVolume(stand.age, species) * stand.area;
            });
            state.volumeHistory.push(totalVolume);

            state.year++;
        }

        function updateUI() {
            const species = document.getElementById('species').value;
            const rotationLength = parseInt(document.getElementById('rotationLength').value);
            const sp = speciesParams[species];

            let totalVolume = 0;
            let totalGrowth = 0;
            state.ageClasses.forEach(stand => {
                totalVolume += getVolume(stand.age, species) * stand.area;
                totalGrowth += getGrowthIncrement(stand.age, species) * stand.area;
            });

            const avgHarvest = state.harvestHistory.length > 0 ?
                state.harvestHistory.slice(-10).reduce((a, b) => a + b, 0) / Math.min(10, state.harvestHistory.length) : 0;

            const lev = calculateLEV(rotationLength, species);
            const carbonStock = totalVolume * 0.5 * 0.47; // 50% biomass, 47% carbon

            document.getElementById('totalVolume').textContent = Math.round(totalVolume);
            document.getElementById('annualGrowth').textContent = Math.round(totalGrowth);
            document.getElementById('annualHarvest').textContent = Math.round(avgHarvest);
            document.getElementById('lev').textContent = '$' + Math.round(lev);
            document.getElementById('totalRevenue').textContent = '$' + Math.round(state.totalRevenue);
            document.getElementById('carbonStock').textContent = Math.round(carbonStock);

            // Sustainability indicator
            const meter = document.getElementById('sustainMeter');
            if (avgHarvest <= totalGrowth * 1.1) {
                meter.className = 'sustainability-meter sustainable';
                meter.textContent = 'Sustainable Yield';
            } else if (avgHarvest <= totalGrowth * 1.5) {
                meter.className = 'sustainability-meter warning';
                meter.textContent = 'Marginal Sustainability';
            } else {
                meter.className = 'sustainability-meter unsustainable';
                meter.textContent = 'Unsustainable Harvest!';
            }
        }

        // Animation loop
        function update() {
            if (!state.running || state.year >= simulationYears) {
                state.running = false;
                return;
            }

            updateYear();
            updateUI();

            // Animate for visual effect
            let frame = 0;
            const animate = () => {
                if (frame < 15) {
                    // Update tree sway
                    state.trees.forEach(tree => {
                        tree.sway += 0.05;
                    });
                    draw();
                    frame++;
                    requestAnimationFrame(animate);
                } else {
                    setTimeout(update, 150);
                }
            };
            animate();
        }

        // Draw visualization
        function draw() {
            ctx.clearRect(0, 0, dims.width, dims.height);

            const species = document.getElementById('species').value;
            const sp = speciesParams[species];

            // Forest area
            const forestX = 20, forestY = 45;
            const forestW = dims.width * 0.48, forestH = dims.height - 90;

            // Ground
            ctx.fillStyle = '#8B7355';
            ctx.fillRect(forestX, forestY + forestH * 0.9, forestW, forestH * 0.1);

            // Sky gradient
            const skyGrad = ctx.createLinearGradient(forestX, forestY, forestX, forestY + forestH * 0.9);
            skyGrad.addColorStop(0, '#87CEEB');
            skyGrad.addColorStop(1, '#E0F0FF');
            ctx.fillStyle = skyGrad;
            ctx.fillRect(forestX, forestY, forestW, forestH * 0.9);

            // Draw trees
            state.trees.forEach(tree => {
                const stand = state.ageClasses[tree.standIndex];
                if (!stand) return;

                const relAge = stand.age / sp.maxAge;
                const height = 20 + relAge * 80;
                const trunkWidth = 2 + relAge * 6;

                const swayOffset = Math.sin(tree.sway) * 2 * (height / 100);

                // Trunk
                ctx.fillStyle = '#4a3728';
                ctx.fillRect(tree.x - trunkWidth / 2 + swayOffset * 0.3,
                    forestY + forestH * 0.9 - height,
                    trunkWidth, height);

                // Foliage (varies by species and age)
                if (stand.age > 0) {
                    ctx.fillStyle = sp.color;
                    const canopySize = 15 + relAge * 35;

                    if (species === 'pine') {
                        // Triangle for pine
                        ctx.beginPath();
                        ctx.moveTo(tree.x + swayOffset, forestY + forestH * 0.9 - height - canopySize);
                        ctx.lineTo(tree.x - canopySize * 0.6 + swayOffset * 0.5, forestY + forestH * 0.9 - height * 0.4);
                        ctx.lineTo(tree.x + canopySize * 0.6 + swayOffset * 0.5, forestY + forestH * 0.9 - height * 0.4);
                        ctx.closePath();
                        ctx.fill();
                    } else if (species === 'oak') {
                        // Round for oak
                        ctx.beginPath();
                        ctx.ellipse(tree.x + swayOffset, forestY + forestH * 0.9 - height - canopySize * 0.3,
                            canopySize * 0.8, canopySize * 0.6, 0, 0, Math.PI * 2);
                        ctx.fill();
                    } else {
                        // Tall narrow for redwood
                        ctx.beginPath();
                        ctx.ellipse(tree.x + swayOffset, forestY + forestH * 0.9 - height * 0.6,
                            canopySize * 0.4, canopySize, 0, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }
            });

            // Draw charts
            const chartX = dims.width * 0.52;
            const chartW = dims.width * 0.44;
            const chartH = 55;

            // Age class distribution
            drawAgeDistribution(chartX, 45, chartW, chartH);

            // Volume history
            drawChart(chartX, 115, chartW, chartH, state.volumeHistory, '#228B22', 'Standing Volume (m³)');

            // Growth vs Harvest comparison
            drawGrowthHarvestChart(chartX, 185, chartW, chartH);

            // Growth curve
            drawGrowthCurve(chartX, 255, chartW, chartH);

            // Title
            ctx.fillStyle = '#606C38';
            ctx.font = '14px Lora';
            ctx.fillText(`Year ${state.year}/${simulationYears} | Species: ${sp.name}`, forestX, 35);
        }

        function drawAgeDistribution(x, y, w, h) {
            ctx.fillStyle = 'rgba(255,255,255,0.9)';
            ctx.fillRect(x, y, w, h);
            ctx.strokeStyle = '#ddd';
            ctx.strokeRect(x, y, w, h);

            ctx.fillStyle = '#606C38';
            ctx.font = '10px Nunito';
            ctx.fillText('Age Class Distribution', x + 5, y - 3);

            const species = document.getElementById('species').value;
            const sp = speciesParams[species];
            const rotation = parseInt(document.getElementById('rotationLength').value);

            // Create age histogram
            const numBins = 10;
            const binWidth = sp.maxAge / numBins;
            const bins = new Array(numBins).fill(0);

            state.ageClasses.forEach(stand => {
                const binIndex = Math.min(Math.floor(stand.age / binWidth), numBins - 1);
                bins[binIndex] += stand.area;
            });

            const maxBin = Math.max(...bins, 1);
            const barW = (w - 10) / numBins;

            bins.forEach((val, i) => {
                const barH = (val / maxBin) * (h - 15);
                const isRotation = (i + 0.5) * binWidth >= rotation && (i - 0.5) * binWidth <= rotation;

                ctx.fillStyle = isRotation ? '#BC6C25' : '#8A9A5B';
                ctx.fillRect(x + 5 + i * barW, y + h - 5 - barH, barW - 2, barH);
            });

            // Rotation marker
            const rotX = x + 5 + (rotation / sp.maxAge) * (w - 10);
            ctx.strokeStyle = '#BC6C25';
            ctx.setLineDash([3, 3]);
            ctx.beginPath();
            ctx.moveTo(rotX, y);
            ctx.lineTo(rotX, y + h);
            ctx.stroke();
            ctx.setLineDash([]);
        }

        function drawChart(x, y, w, h, data, color, label) {
            ctx.fillStyle = 'rgba(255,255,255,0.9)';
            ctx.fillRect(x, y, w, h);
            ctx.strokeStyle = '#ddd';
            ctx.strokeRect(x, y, w, h);

            ctx.fillStyle = '#606C38';
            ctx.font = '10px Nunito';
            ctx.fillText(label, x + 5, y - 3);

            if (data.length < 2) return;

            const maxVal = Math.max(...data, 1);
            const step = w / Math.max(data.length - 1, 1);

            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            data.forEach((val, i) => {
                const px = x + i * step;
                const py = y + h - 5 - (val / maxVal) * (h - 10);
                if (i === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            });
            ctx.stroke();
            ctx.lineWidth = 1;
        }

        function drawGrowthHarvestChart(x, y, w, h) {
            ctx.fillStyle = 'rgba(255,255,255,0.9)';
            ctx.fillRect(x, y, w, h);
            ctx.strokeStyle = '#ddd';
            ctx.strokeRect(x, y, w, h);

            ctx.fillStyle = '#606C38';
            ctx.font = '10px Nunito';
            ctx.fillText('Growth (green) vs Harvest (orange)', x + 5, y - 3);

            if (state.growthHistory.length < 2) return;

            const maxVal = Math.max(...state.growthHistory, ...state.harvestHistory, 1);
            const step = w / Math.max(state.growthHistory.length - 1, 1);

            // Growth line
            ctx.beginPath();
            ctx.strokeStyle = '#228B22';
            ctx.lineWidth = 1.5;
            state.growthHistory.forEach((val, i) => {
                const px = x + i * step;
                const py = y + h - 5 - (val / maxVal) * (h - 10);
                if (i === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            });
            ctx.stroke();

            // Harvest line
            ctx.beginPath();
            ctx.strokeStyle = '#BC6C25';
            state.harvestHistory.forEach((val, i) => {
                const px = x + i * step;
                const py = y + h - 5 - (val / maxVal) * (h - 10);
                if (i === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            });
            ctx.stroke();
            ctx.lineWidth = 1;
        }

        function drawGrowthCurve(x, y, w, h) {
            ctx.fillStyle = 'rgba(255,255,255,0.9)';
            ctx.fillRect(x, y, w, h);
            ctx.strokeStyle = '#ddd';
            ctx.strokeRect(x, y, w, h);

            ctx.fillStyle = '#606C38';
            ctx.font = '10px Nunito';
            ctx.fillText('Volume & MAI by Age', x + 5, y - 3);

            const species = document.getElementById('species').value;
            const sp = speciesParams[species];
            const rotation = parseInt(document.getElementById('rotationLength').value);

            // Draw volume curve
            ctx.beginPath();
            ctx.strokeStyle = '#228B22';
            ctx.lineWidth = 1.5;
            for (let age = 0; age <= sp.maxAge; age += 2) {
                const vol = getVolume(age, species) / sp.maxVolume;
                const px = x + (age / sp.maxAge) * w;
                const py = y + h - 5 - vol * (h - 10);
                if (age === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            }
            ctx.stroke();

            // Draw MAI curve
            ctx.beginPath();
            ctx.strokeStyle = '#DAA520';
            for (let age = 1; age <= sp.maxAge; age += 2) {
                const mai = getMAI(age, species);
                const maxMAI = getMAI(sp.peakGrowth, species);
                const py = y + h - 5 - (mai / maxMAI) * (h - 10) * 0.5;
                const px = x + (age / sp.maxAge) * w;
                if (age === 1) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            }
            ctx.stroke();
            ctx.lineWidth = 1;

            // Rotation marker
            const rotX = x + (rotation / sp.maxAge) * w;
            ctx.strokeStyle = '#BC6C25';
            ctx.setLineDash([3, 3]);
            ctx.beginPath();
            ctx.moveTo(rotX, y);
            ctx.lineTo(rotX, y + h);
            ctx.stroke();
            ctx.setLineDash([]);
        }

        // Controls
        function startSimulation() {
            if (!state.running) {
                state.running = true;
                update();
            }
        }

        function resetSimulation() {
            initSimulation();
            draw();
        }

        function loadPreset(name) {
            if (name === 'sustainable') {
                document.getElementById('strategy').value = 'sustained-yield';
                document.getElementById('species').value = 'oak';
                document.getElementById('rotationLength').value = 60;
                document.getElementById('harvestIntensity').value = 70;
                document.getElementById('regenRate').value = 90;
            } else if (name === 'intensive') {
                document.getElementById('strategy').value = 'clearcut';
                document.getElementById('species').value = 'pine';
                document.getElementById('rotationLength').value = 25;
                document.getElementById('harvestIntensity').value = 95;
                document.getElementById('regenRate').value = 80;
            } else if (name === 'conservation') {
                document.getElementById('strategy').value = 'selection';
                document.getElementById('species').value = 'redwood';
                document.getElementById('rotationLength').value = 100;
                document.getElementById('harvestIntensity').value = 30;
                document.getElementById('regenRate').value = 95;
            }
            updateSliderDisplays();
            resetSimulation();
        }

        function updateSliderDisplays() {
            document.getElementById('rotationLengthVal').textContent = document.getElementById('rotationLength').value;
            document.getElementById('harvestIntensityVal').textContent = document.getElementById('harvestIntensity').value;
            document.getElementById('regenRateVal').textContent = document.getElementById('regenRate').value;
        }

        document.querySelectorAll('input[type="range"]').forEach(slider => {
            slider.addEventListener('input', updateSliderDisplays);
        });

        document.getElementById('species').addEventListener('change', () => {
            const species = document.getElementById('species').value;
            if (species === 'pine') document.getElementById('rotationLength').value = 30;
            else if (species === 'oak') document.getElementById('rotationLength').value = 60;
            else document.getElementById('rotationLength').value = 100;
            updateSliderDisplays();
        });

        // Initialize
        initSimulation();
        draw();
    </script>
</body>
</html>
