<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nutrient Cycling - Biogeochemical Carbon & Nitrogen Dynamics</title>
    <style>
        :root {
            --sage: #8A9A5B;
            --moss: #606C38;
            --earth: #DDA15E;
            --cream: #FEFAE0;
            --terracotta: #BC6C25;
            --dark-moss: #3d4423;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, #f5f5dc 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        h1 {
            color: var(--dark-moss);
            font-size: 1.8rem;
            margin-bottom: 8px;
        }

        .subtitle {
            color: var(--moss);
            font-size: 1rem;
        }

        .back-link {
            position: absolute;
            top: 20px;
            left: 20px;
            color: var(--moss);
            text-decoration: none;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.3s;
        }

        .back-link:hover {
            color: var(--terracotta);
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }

        .control-panel {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            height: fit-content;
        }

        .control-section {
            margin-bottom: 20px;
        }

        .control-section h3 {
            color: var(--dark-moss);
            font-size: 0.95rem;
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 2px solid var(--sage);
        }

        .control-group {
            margin-bottom: 12px;
        }

        .control-group label {
            display: block;
            color: var(--moss);
            font-size: 0.8rem;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .control-group input[type="range"] {
            width: 100%;
            accent-color: var(--sage);
        }

        .control-group select {
            width: 100%;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--dark-moss);
            background: white;
        }

        .value-display {
            text-align: right;
            font-size: 0.75rem;
            color: var(--terracotta);
            font-weight: 600;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 16px;
        }

        button {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
        }

        .btn-primary {
            background: var(--sage);
            color: white;
        }

        .btn-primary:hover {
            background: var(--moss);
        }

        .btn-secondary {
            background: var(--earth);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--terracotta);
        }

        .btn-full {
            grid-column: span 2;
        }

        .btn-perturbation {
            background: var(--terracotta);
            color: white;
            grid-column: span 2;
            margin-top: 8px;
        }

        .btn-perturbation:hover {
            background: #a55a1f;
        }

        .visualization-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 16px;
        }

        .viz-panel {
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .viz-panel h4 {
            color: var(--dark-moss);
            font-size: 0.85rem;
            margin-bottom: 10px;
            text-align: center;
        }

        .canvas-container {
            position: relative;
            width: 100%;
            height: 280px;
        }

        canvas {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            background: #1a1a1a;
        }

        .stats-panel {
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-top: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .stat-item {
            text-align: center;
            padding: 12px;
            background: var(--cream);
            border-radius: 10px;
        }

        .stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--terracotta);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--moss);
            margin-top: 4px;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #eee;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.7rem;
            color: var(--dark-moss);
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .info-panel {
            grid-column: span 2;
            background: linear-gradient(135deg, var(--sage) 0%, var(--moss) 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin-top: 12px;
        }

        .info-panel h4 {
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .info-panel p {
            font-size: 0.8rem;
            opacity: 0.95;
            line-height: 1.5;
        }

        .pool-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: var(--cream);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .pool-bar {
            flex: 1;
            height: 16px;
            background: #ddd;
            border-radius: 4px;
            overflow: hidden;
        }

        .pool-fill {
            height: 100%;
            transition: width 0.3s;
        }

        .pool-label {
            font-size: 0.75rem;
            color: var(--dark-moss);
            min-width: 70px;
        }

        .pool-value {
            font-size: 0.75rem;
            color: var(--terracotta);
            font-weight: 600;
            min-width: 50px;
            text-align: right;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back to Simulations</a>

    <div class="container">
        <header>
            <h1>Biogeochemical Nutrient Cycling</h1>
            <p class="subtitle">Carbon & Nitrogen Dynamics - Mineralization, Immobilization & Decomposition</p>
        </header>

        <div class="main-content">
            <div class="control-panel">
                <div class="control-section">
                    <h3>Ecosystem Type</h3>
                    <div class="control-group">
                        <label>Biome</label>
                        <select id="biomeType">
                            <option value="forest">Temperate Forest</option>
                            <option value="grassland">Grassland</option>
                            <option value="agricultural">Agricultural</option>
                            <option value="tropical">Tropical Forest</option>
                            <option value="boreal">Boreal Forest</option>
                        </select>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Climate Conditions</h3>
                    <div class="control-group">
                        <label>Temperature (°C)</label>
                        <input type="range" id="temperature" min="0" max="35" step="1" value="15">
                        <div class="value-display" id="temperatureValue">15°C</div>
                    </div>
                    <div class="control-group">
                        <label>Soil Moisture (%)</label>
                        <input type="range" id="soilMoisture" min="10" max="100" step="5" value="50">
                        <div class="value-display" id="soilMoistureValue">50%</div>
                    </div>
                    <div class="control-group">
                        <label>Atmospheric CO₂ (ppm)</label>
                        <input type="range" id="co2Level" min="280" max="800" step="20" value="420">
                        <div class="value-display" id="co2LevelValue">420 ppm</div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Microbial Parameters</h3>
                    <div class="control-group">
                        <label>Microbial C:N Ratio</label>
                        <input type="range" id="microbialCN" min="4" max="12" step="0.5" value="8">
                        <div class="value-display" id="microbialCNValue">8:1</div>
                    </div>
                    <div class="control-group">
                        <label>Carbon Use Efficiency</label>
                        <input type="range" id="cue" min="0.2" max="0.6" step="0.05" value="0.4">
                        <div class="value-display" id="cueValue">0.40</div>
                    </div>
                    <div class="control-group">
                        <label>Decomposition Rate</label>
                        <input type="range" id="decompRate" min="0.01" max="0.2" step="0.01" value="0.05">
                        <div class="value-display" id="decompRateValue">0.05</div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Nitrogen Inputs</h3>
                    <div class="control-group">
                        <label>N Deposition (kg/ha/yr)</label>
                        <input type="range" id="nDeposition" min="0" max="50" step="2" value="10">
                        <div class="value-display" id="nDepositionValue">10</div>
                    </div>
                    <div class="control-group">
                        <label>N Fixation Rate</label>
                        <input type="range" id="nFixation" min="0" max="1" step="0.1" value="0.2">
                        <div class="value-display" id="nFixationValue">0.20</div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Perturbations</h3>
                    <button class="btn-perturbation" id="addFertilizer">Add Fertilizer (50 kg N/ha)</button>
                    <button class="btn-perturbation" id="harvestBiomass">Harvest Biomass (50%)</button>
                    <button class="btn-perturbation" id="fireEvent">Fire Event</button>
                </div>

                <div class="button-group">
                    <button class="btn-primary" id="startBtn">Start</button>
                    <button class="btn-secondary" id="pauseBtn">Pause</button>
                    <button class="btn-secondary btn-full" id="resetBtn">Reset System</button>
                </div>

                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #228B22;"></div>
                        <span>Plant C</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #8B4513;"></div>
                        <span>Litter C</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #654321;"></div>
                        <span>Soil Organic C</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FF6B6B;"></div>
                        <span>Microbial C</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4ECDC4;"></div>
                        <span>NH₄⁺</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #45B7D1;"></div>
                        <span>NO₃⁻</span>
                    </div>
                </div>
            </div>

            <div class="visualization-area">
                <div class="viz-panel">
                    <h4>Carbon & Nitrogen Pool Dynamics</h4>
                    <div class="canvas-container">
                        <canvas id="poolsCanvas"></canvas>
                    </div>
                </div>

                <div class="viz-panel">
                    <h4>Flux Diagram (kg/ha/yr)</h4>
                    <div class="canvas-container">
                        <canvas id="fluxCanvas"></canvas>
                    </div>
                </div>

                <div class="viz-panel">
                    <h4>Mineralization vs Immobilization</h4>
                    <div class="canvas-container">
                        <canvas id="minImmCanvas"></canvas>
                    </div>
                </div>

                <div class="viz-panel">
                    <h4>C:N Ratios & Limitation</h4>
                    <div class="canvas-container">
                        <canvas id="ratioCanvas"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-panel">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="totalC">0</div>
                    <div class="stat-label">Total C (t/ha)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalN">0</div>
                    <div class="stat-label">Total N (kg/ha)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="npp">0</div>
                    <div class="stat-label">NPP (g C/m²/yr)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="soilRespiration">0</div>
                    <div class="stat-label">Soil Resp (g C/m²/yr)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="netMineralization">0</div>
                    <div class="stat-label">Net N Min (kg/ha/yr)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="nLimitation">No</div>
                    <div class="stat-label">N Limited?</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="litterCN">0</div>
                    <div class="stat-label">Litter C:N</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="criticalCN">0</div>
                    <div class="stat-label">Critical C:N</div>
                </div>
            </div>
            <div class="info-panel">
                <h4>Biogeochemical Coupling (MIMICS-CN Model Concepts)</h4>
                <p><strong>Mineralization:</strong> Microbes release excess N as NH₄⁺ when litter C:N is below the critical ratio.
                <strong>Immobilization:</strong> Microbes take up inorganic N when litter C:N exceeds critical ratio (C:N > ~25).
                <strong>Critical C:N = Microbial C:N / Carbon Use Efficiency.</strong> Temperature accelerates decomposition and N mineralization in high-latitude ecosystems.</p>
            </div>
        </div>
    </div>

    <script>
        // Canvas setup
        const poolsCanvas = document.getElementById('poolsCanvas');
        const fluxCanvas = document.getElementById('fluxCanvas');
        const minImmCanvas = document.getElementById('minImmCanvas');
        const ratioCanvas = document.getElementById('ratioCanvas');

        const pCtx = poolsCanvas.getContext('2d');
        const fCtx = fluxCanvas.getContext('2d');
        const mCtx = minImmCanvas.getContext('2d');
        const rCtx = ratioCanvas.getContext('2d');

        function resizeCanvas(canvas) {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }

        [poolsCanvas, fluxCanvas, minImmCanvas, ratioCanvas].forEach(resizeCanvas);
        window.addEventListener('resize', () => {
            [poolsCanvas, fluxCanvas, minImmCanvas, ratioCanvas].forEach(resizeCanvas);
        });

        // Model state - pools in kg/ha (C) or kg/ha (N)
        let pools = {
            plantC: 0,
            plantN: 0,
            litterC: 0,
            litterN: 0,
            soilC: 0,
            soilN: 0,
            microbialC: 0,
            microbialN: 0,
            ammonium: 0,  // NH4+
            nitrate: 0,    // NO3-
            atmosphericN: 0 // Deposition + fixation accumulator
        };

        // Fluxes (kg/ha/yr equivalent per timestep)
        let fluxes = {
            photosynthesis: 0,
            plantRespiration: 0,
            litterfall: 0,
            decomposition: 0,
            microbialRespiration: 0,
            humification: 0,
            mineralization: 0,
            immobilization: 0,
            nitrification: 0,
            denitrification: 0,
            plantNUptake: 0,
            leaching: 0,
            nDeposition: 0,
            nFixation: 0
        };

        let params = {};
        let isRunning = false;
        let tick = 0;
        let history = [];

        // Biome presets
        const BIOME_PRESETS = {
            forest: { plantC: 15000, litterC: 3000, soilC: 10000, microbialC: 500, ammonium: 20, nitrate: 15 },
            grassland: { plantC: 800, litterC: 500, soilC: 8000, microbialC: 400, ammonium: 25, nitrate: 20 },
            agricultural: { plantC: 400, litterC: 200, soilC: 4000, microbialC: 300, ammonium: 40, nitrate: 50 },
            tropical: { plantC: 25000, litterC: 2000, soilC: 8000, microbialC: 600, ammonium: 15, nitrate: 10 },
            boreal: { plantC: 8000, litterC: 5000, soilC: 20000, microbialC: 300, ammonium: 10, nitrate: 5 }
        };

        function initPools() {
            const biome = document.getElementById('biomeType').value;
            const preset = BIOME_PRESETS[biome];

            pools = {
                plantC: preset.plantC,
                plantN: preset.plantC / 50,  // Plant C:N ~ 50
                litterC: preset.litterC,
                litterN: preset.litterC / 40, // Litter C:N ~ 40
                soilC: preset.soilC,
                soilN: preset.soilC / 12,    // SOM C:N ~ 12
                microbialC: preset.microbialC,
                microbialN: preset.microbialC / 8, // Microbial C:N ~ 8
                ammonium: preset.ammonium,
                nitrate: preset.nitrate,
                atmosphericN: 0
            };

            tick = 0;
            history = [];

            // Reset fluxes
            Object.keys(fluxes).forEach(k => fluxes[k] = 0);
        }

        function updateParams() {
            params = {
                temperature: parseFloat(document.getElementById('temperature').value),
                soilMoisture: parseFloat(document.getElementById('soilMoisture').value),
                co2Level: parseFloat(document.getElementById('co2Level').value),
                microbialCN: parseFloat(document.getElementById('microbialCN').value),
                cue: parseFloat(document.getElementById('cue').value),
                decompRate: parseFloat(document.getElementById('decompRate').value),
                nDeposition: parseFloat(document.getElementById('nDeposition').value),
                nFixation: parseFloat(document.getElementById('nFixation').value)
            };
        }

        // Temperature response function (Q10 = 2)
        function tempResponse(temp) {
            return Math.pow(2, (temp - 10) / 10);
        }

        // Moisture response (optimal at 50-70%)
        function moistureResponse(moisture) {
            if (moisture < 20) return 0.1;
            if (moisture < 50) return 0.1 + 0.9 * (moisture - 20) / 30;
            if (moisture <= 70) return 1;
            return 1 - 0.5 * (moisture - 70) / 30;
        }

        // CO2 fertilization effect on photosynthesis
        function co2Effect(co2) {
            // Michaelis-Menten response
            return co2 / (co2 + 200);
        }

        // Critical C:N ratio for mineralization/immobilization
        function criticalCN() {
            return params.microbialCN / params.cue;
        }

        function update() {
            const dt = 0.01; // Time step (years)
            const tempResp = tempResponse(params.temperature);
            const moistResp = moistureResponse(params.soilMoisture);
            const envFactor = tempResp * moistResp;

            // Calculate inorganic N availability
            const inorganicN = pools.ammonium + pools.nitrate;
            const nAvailable = inorganicN > 1;

            // ===== CARBON CYCLE =====

            // Photosynthesis / NPP
            const maxNPP = 1000 * dt; // Max NPP kg C/ha/yr
            const co2Resp = co2Effect(params.co2Level);
            const nLimitation = nAvailable ? 1 : 0.3;
            fluxes.photosynthesis = maxNPP * co2Resp * moistResp * nLimitation;
            pools.plantC += fluxes.photosynthesis;

            // Plant respiration (autotrophic)
            fluxes.plantRespiration = pools.plantC * 0.02 * dt * tempResp;
            pools.plantC -= fluxes.plantRespiration;

            // Litterfall
            fluxes.litterfall = pools.plantC * 0.03 * dt;
            const litterfallN = pools.plantN * 0.03 * dt;
            pools.plantC -= fluxes.litterfall;
            pools.plantN -= litterfallN;
            pools.litterC += fluxes.litterfall;
            pools.litterN += litterfallN;

            // Litter decomposition
            const litterCN = pools.litterC / Math.max(0.1, pools.litterN);
            fluxes.decomposition = pools.litterC * params.decompRate * dt * envFactor;
            const decompN = fluxes.decomposition / litterCN;

            pools.litterC -= fluxes.decomposition;
            pools.litterN -= decompN;

            // Microbial processing of decomposed material
            const assimilatedC = fluxes.decomposition * params.cue;
            fluxes.microbialRespiration = fluxes.decomposition * (1 - params.cue);

            // Mineralization vs Immobilization based on C:N ratio
            const critCN = criticalCN();
            const nRequired = assimilatedC / params.microbialCN;

            if (litterCN < critCN) {
                // Net mineralization - excess N released
                const nExcess = decompN - nRequired;
                fluxes.mineralization = Math.max(0, nExcess);
                fluxes.immobilization = 0;
                pools.ammonium += fluxes.mineralization;
            } else {
                // Net immobilization - N taken from soil
                const nDeficit = nRequired - decompN;
                fluxes.immobilization = Math.min(nDeficit, inorganicN * 0.5);
                fluxes.mineralization = 0;
                pools.ammonium -= fluxes.immobilization * 0.6;
                pools.nitrate -= fluxes.immobilization * 0.4;
            }

            // Update microbial biomass
            pools.microbialC += assimilatedC;
            pools.microbialN += nRequired;

            // Microbial turnover
            const microbialTurnover = pools.microbialC * 0.1 * dt * tempResp;
            const microbialTurnoverN = pools.microbialN * 0.1 * dt * tempResp;
            pools.microbialC -= microbialTurnover;
            pools.microbialN -= microbialTurnoverN;

            // Humification - microbial products become SOM
            fluxes.humification = microbialTurnover * 0.3;
            pools.soilC += fluxes.humification;
            pools.soilN += microbialTurnoverN * 0.3;

            // SOM decomposition (slower)
            const somDecomp = pools.soilC * 0.005 * dt * envFactor;
            const somDecompN = somDecomp / 12; // SOM C:N ~ 12
            pools.soilC -= somDecomp;
            pools.soilN -= somDecompN;
            pools.ammonium += somDecompN;

            // ===== NITROGEN TRANSFORMATIONS =====

            // Nitrification (NH4+ -> NO3-)
            fluxes.nitrification = pools.ammonium * 0.2 * dt * envFactor;
            pools.ammonium -= fluxes.nitrification;
            pools.nitrate += fluxes.nitrification;

            // Denitrification (NO3- -> N2, under low O2/high moisture)
            if (params.soilMoisture > 70) {
                fluxes.denitrification = pools.nitrate * 0.1 * dt * (params.soilMoisture - 70) / 30;
                pools.nitrate -= fluxes.denitrification;
            } else {
                fluxes.denitrification = 0;
            }

            // N deposition
            fluxes.nDeposition = params.nDeposition * dt;
            pools.ammonium += fluxes.nDeposition * 0.5;
            pools.nitrate += fluxes.nDeposition * 0.5;

            // Biological N fixation
            fluxes.nFixation = params.nFixation * 20 * dt * (1 - inorganicN / 100);
            pools.ammonium += fluxes.nFixation;

            // Plant N uptake
            const nDemand = fluxes.photosynthesis / 50; // Plant C:N ~ 50
            fluxes.plantNUptake = Math.min(nDemand, inorganicN * 0.3 * dt);
            pools.ammonium -= fluxes.plantNUptake * 0.4;
            pools.nitrate -= fluxes.plantNUptake * 0.6;
            pools.plantN += fluxes.plantNUptake;

            // Leaching
            if (params.soilMoisture > 60) {
                fluxes.leaching = pools.nitrate * 0.05 * dt * (params.soilMoisture - 60) / 40;
                pools.nitrate -= fluxes.leaching;
            } else {
                fluxes.leaching = 0;
            }

            // Ensure non-negative pools
            Object.keys(pools).forEach(k => {
                pools[k] = Math.max(0, pools[k]);
            });

            tick++;

            // Record history
            if (tick % 5 === 0) {
                history.push({
                    tick,
                    ...pools,
                    mineralization: fluxes.mineralization,
                    immobilization: fluxes.immobilization,
                    litterCN: pools.litterC / Math.max(0.1, pools.litterN),
                    criticalCN: criticalCN()
                });

                if (history.length > 200) history.shift();
            }
        }

        function drawPools() {
            const width = poolsCanvas.width;
            const height = poolsCanvas.height;

            pCtx.fillStyle = '#1a1a1a';
            pCtx.fillRect(0, 0, width, height);

            if (history.length < 2) return;

            const margin = { top: 30, right: 80, bottom: 40, left: 60 };
            const plotWidth = width - margin.left - margin.right;
            const plotHeight = height - margin.top - margin.bottom;

            // Draw carbon pools over time
            const carbonPools = ['plantC', 'litterC', 'soilC', 'microbialC'];
            const colors = { plantC: '#228B22', litterC: '#8B4513', soilC: '#654321', microbialC: '#FF6B6B' };

            // Find max for scaling
            let maxC = 0;
            history.forEach(h => {
                carbonPools.forEach(p => {
                    if (h[p] > maxC) maxC = h[p];
                });
            });

            const xScale = plotWidth / Math.max(1, history.length - 1);
            const yScale = plotHeight / Math.max(1, maxC);

            carbonPools.forEach(pool => {
                pCtx.strokeStyle = colors[pool];
                pCtx.lineWidth = 2;
                pCtx.beginPath();

                history.forEach((h, i) => {
                    const x = margin.left + i * xScale;
                    const y = margin.top + plotHeight - h[pool] * yScale;
                    if (i === 0) pCtx.moveTo(x, y);
                    else pCtx.lineTo(x, y);
                });

                pCtx.stroke();
            });

            // Legend
            pCtx.font = '10px sans-serif';
            const labels = { plantC: 'Plant C', litterC: 'Litter C', soilC: 'Soil C', microbialC: 'Microbial C' };
            carbonPools.forEach((pool, i) => {
                const y = margin.top + 15 + i * 20;
                pCtx.fillStyle = colors[pool];
                pCtx.fillRect(width - 75, y - 8, 12, 12);
                pCtx.fillStyle = '#aaa';
                pCtx.textAlign = 'left';
                pCtx.fillText(labels[pool], width - 60, y + 3);
            });

            // Axes
            pCtx.strokeStyle = '#666';
            pCtx.lineWidth = 1;
            pCtx.beginPath();
            pCtx.moveTo(margin.left, margin.top);
            pCtx.lineTo(margin.left, margin.top + plotHeight);
            pCtx.lineTo(margin.left + plotWidth, margin.top + plotHeight);
            pCtx.stroke();

            // Title
            pCtx.fillStyle = '#fff';
            pCtx.font = 'bold 12px sans-serif';
            pCtx.textAlign = 'center';
            pCtx.fillText('Carbon Pools (kg/ha)', width/2, 18);
        }

        function drawFlux() {
            const width = fluxCanvas.width;
            const height = fluxCanvas.height;

            fCtx.fillStyle = '#1a1a1a';
            fCtx.fillRect(0, 0, width, height);

            // Draw simplified flux diagram
            const cx = width / 2;
            const cy = height / 2;

            // Draw pools as circles
            const poolPositions = {
                atmosphere: { x: cx, y: 40, color: '#87CEEB', label: 'Atmosphere' },
                plant: { x: cx - 100, y: cy - 30, color: '#228B22', label: 'Plants' },
                litter: { x: cx - 50, y: cy + 60, color: '#8B4513', label: 'Litter' },
                soil: { x: cx + 50, y: cy + 60, color: '#654321', label: 'SOM' },
                microbe: { x: cx + 100, y: cy - 30, color: '#FF6B6B', label: 'Microbes' },
                inorganicN: { x: cx, y: height - 40, color: '#4ECDC4', label: 'Inorg. N' }
            };

            // Draw pools
            Object.entries(poolPositions).forEach(([key, pos]) => {
                fCtx.beginPath();
                fCtx.arc(pos.x, pos.y, 25, 0, Math.PI * 2);
                fCtx.fillStyle = pos.color;
                fCtx.fill();
                fCtx.strokeStyle = '#fff';
                fCtx.lineWidth = 2;
                fCtx.stroke();

                fCtx.fillStyle = '#fff';
                fCtx.font = '9px sans-serif';
                fCtx.textAlign = 'center';
                fCtx.fillText(pos.label, pos.x, pos.y + 4);
            });

            // Draw arrows for fluxes
            const arrows = [
                { from: 'atmosphere', to: 'plant', flux: fluxes.photosynthesis, label: 'NPP' },
                { from: 'plant', to: 'litter', flux: fluxes.litterfall, label: 'Litterfall' },
                { from: 'litter', to: 'microbe', flux: fluxes.decomposition, label: 'Decomp' },
                { from: 'microbe', to: 'soil', flux: fluxes.humification, label: 'Humif' },
                { from: 'microbe', to: 'atmosphere', flux: fluxes.microbialRespiration, label: 'Resp' },
                { from: 'inorganicN', to: 'plant', flux: fluxes.plantNUptake, label: 'Uptake' },
                { from: 'litter', to: 'inorganicN', flux: fluxes.mineralization, label: 'Min' }
            ];

            arrows.forEach(arrow => {
                const from = poolPositions[arrow.from];
                const to = poolPositions[arrow.to];

                // Calculate arrow points
                const dx = to.x - from.x;
                const dy = to.y - from.y;
                const len = Math.sqrt(dx*dx + dy*dy);
                const nx = dx / len;
                const ny = dy / len;

                const startX = from.x + nx * 28;
                const startY = from.y + ny * 28;
                const endX = to.x - nx * 28;
                const endY = to.y - ny * 28;

                // Arrow thickness based on flux magnitude
                const thickness = Math.min(4, Math.max(1, arrow.flux * 10));

                fCtx.strokeStyle = 'rgba(255, 255, 100, 0.7)';
                fCtx.lineWidth = thickness;
                fCtx.beginPath();
                fCtx.moveTo(startX, startY);
                fCtx.lineTo(endX, endY);
                fCtx.stroke();

                // Arrowhead
                const headLen = 8;
                const angle = Math.atan2(endY - startY, endX - startX);
                fCtx.beginPath();
                fCtx.moveTo(endX, endY);
                fCtx.lineTo(endX - headLen * Math.cos(angle - Math.PI/6), endY - headLen * Math.sin(angle - Math.PI/6));
                fCtx.lineTo(endX - headLen * Math.cos(angle + Math.PI/6), endY - headLen * Math.sin(angle + Math.PI/6));
                fCtx.closePath();
                fCtx.fillStyle = 'rgba(255, 255, 100, 0.7)';
                fCtx.fill();
            });

            // Title
            fCtx.fillStyle = '#fff';
            fCtx.font = 'bold 11px sans-serif';
            fCtx.textAlign = 'center';
            fCtx.fillText('C-N Flux Network', width/2, 18);
        }

        function drawMinImm() {
            const width = minImmCanvas.width;
            const height = minImmCanvas.height;

            mCtx.fillStyle = '#1a1a1a';
            mCtx.fillRect(0, 0, width, height);

            if (history.length < 2) return;

            const margin = { top: 30, right: 20, bottom: 40, left: 60 };
            const plotWidth = width - margin.left - margin.right;
            const plotHeight = height - margin.top - margin.bottom;

            // Find max for scaling
            let maxFlux = 0.1;
            history.forEach(h => {
                if (h.mineralization > maxFlux) maxFlux = h.mineralization;
                if (h.immobilization > maxFlux) maxFlux = h.immobilization;
            });

            const xScale = plotWidth / Math.max(1, history.length - 1);
            const yScale = (plotHeight / 2) / maxFlux;
            const midY = margin.top + plotHeight / 2;

            // Draw zero line
            mCtx.strokeStyle = '#666';
            mCtx.setLineDash([5, 5]);
            mCtx.beginPath();
            mCtx.moveTo(margin.left, midY);
            mCtx.lineTo(margin.left + plotWidth, midY);
            mCtx.stroke();
            mCtx.setLineDash([]);

            // Draw mineralization (positive, above)
            mCtx.strokeStyle = '#4CAF50';
            mCtx.lineWidth = 2;
            mCtx.beginPath();
            history.forEach((h, i) => {
                const x = margin.left + i * xScale;
                const y = midY - h.mineralization * yScale;
                if (i === 0) mCtx.moveTo(x, y);
                else mCtx.lineTo(x, y);
            });
            mCtx.stroke();

            // Fill mineralization area
            mCtx.fillStyle = 'rgba(76, 175, 80, 0.3)';
            mCtx.beginPath();
            mCtx.moveTo(margin.left, midY);
            history.forEach((h, i) => {
                const x = margin.left + i * xScale;
                const y = midY - h.mineralization * yScale;
                mCtx.lineTo(x, y);
            });
            mCtx.lineTo(margin.left + (history.length - 1) * xScale, midY);
            mCtx.closePath();
            mCtx.fill();

            // Draw immobilization (negative, below)
            mCtx.strokeStyle = '#FF5722';
            mCtx.lineWidth = 2;
            mCtx.beginPath();
            history.forEach((h, i) => {
                const x = margin.left + i * xScale;
                const y = midY + h.immobilization * yScale;
                if (i === 0) mCtx.moveTo(x, y);
                else mCtx.lineTo(x, y);
            });
            mCtx.stroke();

            // Fill immobilization area
            mCtx.fillStyle = 'rgba(255, 87, 34, 0.3)';
            mCtx.beginPath();
            mCtx.moveTo(margin.left, midY);
            history.forEach((h, i) => {
                const x = margin.left + i * xScale;
                const y = midY + h.immobilization * yScale;
                mCtx.lineTo(x, y);
            });
            mCtx.lineTo(margin.left + (history.length - 1) * xScale, midY);
            mCtx.closePath();
            mCtx.fill();

            // Labels
            mCtx.font = '10px sans-serif';
            mCtx.fillStyle = '#4CAF50';
            mCtx.textAlign = 'left';
            mCtx.fillText('Mineralization (+N)', margin.left + 5, margin.top + 15);

            mCtx.fillStyle = '#FF5722';
            mCtx.fillText('Immobilization (-N)', margin.left + 5, height - margin.bottom - 5);

            // Axes
            mCtx.strokeStyle = '#666';
            mCtx.lineWidth = 1;
            mCtx.beginPath();
            mCtx.moveTo(margin.left, margin.top);
            mCtx.lineTo(margin.left, margin.top + plotHeight);
            mCtx.stroke();

            // Title
            mCtx.fillStyle = '#fff';
            mCtx.font = 'bold 12px sans-serif';
            mCtx.textAlign = 'center';
            mCtx.fillText('Net N Mineralization / Immobilization', width/2, 18);
        }

        function drawRatios() {
            const width = ratioCanvas.width;
            const height = ratioCanvas.height;

            rCtx.fillStyle = '#1a1a1a';
            rCtx.fillRect(0, 0, width, height);

            if (history.length < 2) return;

            const margin = { top: 30, right: 20, bottom: 40, left: 60 };
            const plotWidth = width - margin.left - margin.right;
            const plotHeight = height - margin.top - margin.bottom;

            // Find max for scaling
            let maxRatio = 50;
            history.forEach(h => {
                if (h.litterCN > maxRatio) maxRatio = h.litterCN;
            });

            const xScale = plotWidth / Math.max(1, history.length - 1);
            const yScale = plotHeight / maxRatio;

            // Draw critical C:N threshold
            const critY = margin.top + plotHeight - (history.length > 0 ? history[history.length - 1].criticalCN : 20) * yScale;
            rCtx.strokeStyle = 'rgba(255, 100, 100, 0.8)';
            rCtx.setLineDash([5, 5]);
            rCtx.beginPath();
            rCtx.moveTo(margin.left, critY);
            rCtx.lineTo(margin.left + plotWidth, critY);
            rCtx.stroke();
            rCtx.setLineDash([]);

            // Fill areas
            rCtx.fillStyle = 'rgba(255, 87, 34, 0.2)';
            rCtx.fillRect(margin.left, margin.top, plotWidth, critY - margin.top);

            rCtx.fillStyle = 'rgba(76, 175, 80, 0.2)';
            rCtx.fillRect(margin.left, critY, plotWidth, margin.top + plotHeight - critY);

            // Draw litter C:N over time
            rCtx.strokeStyle = '#FFC107';
            rCtx.lineWidth = 3;
            rCtx.beginPath();
            history.forEach((h, i) => {
                const x = margin.left + i * xScale;
                const y = margin.top + plotHeight - h.litterCN * yScale;
                if (i === 0) rCtx.moveTo(x, y);
                else rCtx.lineTo(x, y);
            });
            rCtx.stroke();

            // Labels
            rCtx.font = '10px sans-serif';
            rCtx.fillStyle = '#FF5722';
            rCtx.textAlign = 'left';
            rCtx.fillText('Immobilization Zone (high C:N)', margin.left + 5, margin.top + 15);

            rCtx.fillStyle = '#4CAF50';
            rCtx.fillText('Mineralization Zone (low C:N)', margin.left + 5, height - margin.bottom - 5);

            rCtx.fillStyle = '#FF6B6B';
            rCtx.textAlign = 'right';
            rCtx.fillText('Critical C:N = ' + criticalCN().toFixed(1), width - margin.right - 5, critY - 5);

            // Current litter C:N indicator
            if (history.length > 0) {
                const current = history[history.length - 1];
                rCtx.fillStyle = '#FFC107';
                rCtx.textAlign = 'right';
                rCtx.fillText('Litter C:N = ' + current.litterCN.toFixed(1), width - margin.right - 5, margin.top + 30);
            }

            // Axes
            rCtx.strokeStyle = '#666';
            rCtx.lineWidth = 1;
            rCtx.beginPath();
            rCtx.moveTo(margin.left, margin.top);
            rCtx.lineTo(margin.left, margin.top + plotHeight);
            rCtx.lineTo(margin.left + plotWidth, margin.top + plotHeight);
            rCtx.stroke();

            // Title
            rCtx.fillStyle = '#fff';
            rCtx.font = 'bold 12px sans-serif';
            rCtx.textAlign = 'center';
            rCtx.fillText('C:N Ratio & N Limitation Threshold', width/2, 18);
        }

        function updateStats() {
            const totalC = (pools.plantC + pools.litterC + pools.soilC + pools.microbialC) / 1000;
            const totalN = pools.plantN + pools.litterN + pools.soilN + pools.microbialN + pools.ammonium + pools.nitrate;
            const npp = fluxes.photosynthesis * 100; // Convert to g/m2
            const soilResp = (fluxes.microbialRespiration) * 100;
            const netMin = (fluxes.mineralization - fluxes.immobilization) * 100;
            const litterCN = pools.litterC / Math.max(0.1, pools.litterN);
            const critCN = criticalCN();
            const nLimited = (pools.ammonium + pools.nitrate) < 10;

            document.getElementById('totalC').textContent = totalC.toFixed(1);
            document.getElementById('totalN').textContent = totalN.toFixed(0);
            document.getElementById('npp').textContent = npp.toFixed(0);
            document.getElementById('soilRespiration').textContent = soilResp.toFixed(0);
            document.getElementById('netMineralization').textContent = netMin.toFixed(1);
            document.getElementById('nLimitation').textContent = nLimited ? 'Yes' : 'No';
            document.getElementById('litterCN').textContent = litterCN.toFixed(1);
            document.getElementById('criticalCN').textContent = critCN.toFixed(1);
        }

        function draw() {
            drawPools();
            drawFlux();
            drawMinImm();
            drawRatios();
            updateStats();
        }

        function animate() {
            if (!isRunning) return;

            for (let i = 0; i < 5; i++) {
                update();
            }
            draw();

            requestAnimationFrame(animate);
        }

        // Event listeners
        document.getElementById('startBtn').addEventListener('click', () => {
            isRunning = true;
            animate();
        });

        document.getElementById('pauseBtn').addEventListener('click', () => {
            isRunning = false;
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            isRunning = false;
            updateParams();
            initPools();
            draw();
        });

        document.getElementById('addFertilizer').addEventListener('click', () => {
            pools.ammonium += 30;
            pools.nitrate += 20;
            draw();
        });

        document.getElementById('harvestBiomass').addEventListener('click', () => {
            pools.plantC *= 0.5;
            pools.plantN *= 0.5;
            draw();
        });

        document.getElementById('fireEvent').addEventListener('click', () => {
            // Fire converts biomass to atmosphere, adds N to soil
            pools.litterC *= 0.1;
            pools.ammonium += pools.litterN * 0.3;
            pools.litterN *= 0.1;
            pools.plantC *= 0.3;
            pools.plantN *= 0.3;
            draw();
        });

        // Parameter sliders
        const sliders = ['temperature', 'soilMoisture', 'co2Level', 'microbialCN', 'cue', 'decompRate', 'nDeposition', 'nFixation'];
        sliders.forEach(id => {
            const slider = document.getElementById(id);
            const display = document.getElementById(id + 'Value');

            slider.addEventListener('input', () => {
                let value = parseFloat(slider.value);
                if (id === 'temperature') display.textContent = value + '°C';
                else if (id === 'soilMoisture') display.textContent = value + '%';
                else if (id === 'co2Level') display.textContent = value + ' ppm';
                else if (id === 'microbialCN') display.textContent = value + ':1';
                else if (id === 'nDeposition') display.textContent = value;
                else display.textContent = value.toFixed(2);
                updateParams();
            });
        });

        document.getElementById('biomeType').addEventListener('change', () => {
            updateParams();
            initPools();
            draw();
        });

        // Initialize
        updateParams();
        initPools();
        draw();
    </script>
</body>
</html>
