<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ring Species Speciation - Geographic Barrier Model</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 20px; }
        h1 { color: #00d4aa; font-size: 1.8em; margin-bottom: 5px; }
        .subtitle { color: #888; font-size: 0.95em; }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 20px;
        }
        .simulation-area {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 15px;
        }
        canvas {
            display: block;
            width: 100%;
            border-radius: 8px;
            background: #0a0a1a;
        }
        .controls-panel {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 20px;
        }
        .control-group { margin-bottom: 20px; }
        .control-group h3 {
            color: #00d4aa;
            font-size: 0.95em;
            margin-bottom: 12px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }
        .slider-row { margin-bottom: 12px; }
        .slider-row label {
            display: flex;
            justify-content: space-between;
            font-size: 0.85em;
            margin-bottom: 4px;
        }
        .slider-row label span:last-child {
            color: #00d4aa;
            font-weight: 600;
        }
        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #333;
            outline: none;
            -webkit-appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #00d4aa;
            cursor: pointer;
        }
        .btn-row { display: flex; gap: 10px; flex-wrap: wrap; }
        button {
            flex: 1;
            min-width: 80px;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary { background: #00d4aa; color: #1a1a2e; font-weight: 600; }
        .btn-primary:hover { background: #00f5c4; }
        .btn-secondary { background: #333; color: #e0e0e0; }
        .btn-secondary:hover { background: #444; }
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .stat-box {
            background: rgba(0,212,170,0.1);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        .stat-value { font-size: 1.3em; font-weight: 700; color: #00d4aa; }
        .stat-label { font-size: 0.75em; color: #888; margin-top: 2px; }
        .info-panel {
            margin-top: 15px;
            padding: 12px;
            background: rgba(0,100,80,0.15);
            border-radius: 8px;
            border-left: 3px solid #00d4aa;
        }
        .info-panel h4 { color: #00d4aa; font-size: 0.85em; margin-bottom: 8px; }
        .info-panel p { font-size: 0.8em; color: #aaa; line-height: 1.5; }
        .genetic-bar {
            height: 60px;
            background: #0a0a1a;
            border-radius: 6px;
            margin-top: 10px;
            position: relative;
            overflow: hidden;
        }
        a.back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #00d4aa;
            text-decoration: none;
            font-size: 0.9em;
            z-index: 100;
        }
        a.back-link:hover { text-decoration: underline; }
        @media (max-width: 900px) {
            .main-content { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back to Gallery</a>
    <div class="container">
        <header>
            <h1>Ring Species Speciation</h1>
            <p class="subtitle">Populations expand around a barrier; adjacent ones interbreed, but terminal populations become reproductively isolated</p>
        </header>
        <div class="main-content">
            <div class="simulation-area">
                <canvas id="canvas" width="800" height="650"></canvas>
            </div>
            <div class="controls-panel">
                <div class="control-group">
                    <h3>Simulation Controls</h3>
                    <div class="btn-row">
                        <button id="startBtn" class="btn-primary">Start</button>
                        <button id="resetBtn" class="btn-secondary">Reset</button>
                    </div>
                </div>
                <div class="control-group">
                    <h3>Parameters</h3>
                    <div class="slider-row">
                        <label><span>Populations</span><span id="numPopsVal">12</span></label>
                        <input type="range" id="numPops" min="6" max="20" value="12">
                    </div>
                    <div class="slider-row">
                        <label><span>Gene Flow Rate</span><span id="geneFlowVal">0.12</span></label>
                        <input type="range" id="geneFlow" min="0" max="0.4" step="0.01" value="0.12">
                    </div>
                    <div class="slider-row">
                        <label><span>Mutation Rate</span><span id="mutationVal">0.02</span></label>
                        <input type="range" id="mutation" min="0" max="0.1" step="0.005" value="0.02">
                    </div>
                    <div class="slider-row">
                        <label><span>Genetic Drift</span><span id="driftVal">0.03</span></label>
                        <input type="range" id="drift" min="0" max="0.15" step="0.01" value="0.03">
                    </div>
                    <div class="slider-row">
                        <label><span>Isolation Threshold</span><span id="thresholdVal">0.35</span></label>
                        <input type="range" id="threshold" min="0.1" max="0.6" step="0.05" value="0.35">
                    </div>
                </div>
                <div class="control-group">
                    <h3>Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-value" id="genStat">0</div>
                            <div class="stat-label">Generation</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="terminiDist">0.00</div>
                            <div class="stat-label">Termini Distance</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="avgDist">0.00</div>
                            <div class="stat-label">Avg Adjacent</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="isolatedStat">No</div>
                            <div class="stat-label">Speciation?</div>
                        </div>
                    </div>
                </div>
                <div class="control-group">
                    <h3>Genetic Distance Around Ring</h3>
                    <canvas id="barCanvas" width="280" height="60" class="genetic-bar"></canvas>
                </div>
                <div class="info-panel">
                    <h4>About Ring Species</h4>
                    <p>Classic examples include Ensatina salamanders around California's Central Valley and Larus gulls around the Arctic. Adjacent populations interbreed, but when the ring closes, the terminal populations have diverged enough to be reproductively isolated—demonstrating speciation in action.</p>
                </div>
            </div>
        </div>
    </div>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const barCanvas = document.getElementById('barCanvas');
        const barCtx = barCanvas.getContext('2d');

        let populations = [];
        let generation = 0;
        let running = false;
        let animId = null;

        // Parameters
        let numPops = 12;
        let geneFlowRate = 0.12;
        let mutationRate = 0.02;
        let driftStrength = 0.03;
        let isolationThreshold = 0.35;

        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const barrierRadius = 100;
        const ringRadius = 200;
        const numLoci = 20;

        class Population {
            constructor(index, angle, total) {
                this.index = index;
                this.angle = angle;
                this.x = centerX + Math.cos(angle) * ringRadius;
                this.y = centerY + Math.sin(angle) * ringRadius;
                // Initialize genome with gradient based on position
                this.genome = [];
                for (let i = 0; i < numLoci; i++) {
                    const base = index / total;
                    this.genome.push(Math.max(0, Math.min(1, base + (Math.random() - 0.5) * 0.15)));
                }
            }

            getGeneticDistance(other) {
                let sum = 0;
                for (let i = 0; i < numLoci; i++) {
                    sum += Math.pow(this.genome[i] - other.genome[i], 2);
                }
                return Math.sqrt(sum / numLoci);
            }

            getHue() {
                const avg = this.genome.slice(0, 5).reduce((a, b) => a + b, 0) / 5;
                return avg * 300; // purple to red spectrum
            }
        }

        function init() {
            populations = [];
            generation = 0;
            // Create ring with gap at top (termini)
            const startAngle = Math.PI * 0.55;
            const spanAngle = Math.PI * 1.9;
            for (let i = 0; i < numPops; i++) {
                const angle = startAngle + (i / (numPops - 1)) * spanAngle;
                populations.push(new Population(i, angle, numPops));
            }
            updateStats();
            draw();
            drawBar();
        }

        function step() {
            generation++;
            const newGenomes = populations.map(p => p.genome.slice());

            for (let i = 0; i < populations.length; i++) {
                // Gene flow from neighbors
                if (i > 0) {
                    const neighbor = populations[i - 1].genome;
                    for (let j = 0; j < numLoci; j++) {
                        newGenomes[i][j] += geneFlowRate * (neighbor[j] - newGenomes[i][j]);
                    }
                }
                if (i < populations.length - 1) {
                    const neighbor = populations[i + 1].genome;
                    for (let j = 0; j < numLoci; j++) {
                        newGenomes[i][j] += geneFlowRate * (neighbor[j] - newGenomes[i][j]);
                    }
                }
                // Drift and mutation
                for (let j = 0; j < numLoci; j++) {
                    newGenomes[i][j] += (Math.random() - 0.5) * driftStrength;
                    if (Math.random() < mutationRate) {
                        newGenomes[i][j] += (Math.random() - 0.5) * 0.2;
                    }
                    newGenomes[i][j] = Math.max(0, Math.min(1, newGenomes[i][j]));
                }
            }

            populations.forEach((p, i) => { p.genome = newGenomes[i]; });
            updateStats();
            draw();
            drawBar();
        }

        function getTerminiDistance() {
            if (populations.length < 2) return 0;
            return populations[0].getGeneticDistance(populations[populations.length - 1]);
        }

        function getAvgAdjacentDistance() {
            if (populations.length < 2) return 0;
            let total = 0;
            for (let i = 0; i < populations.length - 1; i++) {
                total += populations[i].getGeneticDistance(populations[i + 1]);
            }
            return total / (populations.length - 1);
        }

        function updateStats() {
            document.getElementById('genStat').textContent = generation;
            const td = getTerminiDistance();
            document.getElementById('terminiDist').textContent = td.toFixed(3);
            document.getElementById('avgDist').textContent = getAvgAdjacentDistance().toFixed(3);
            const isolated = td > isolationThreshold;
            const el = document.getElementById('isolatedStat');
            el.textContent = isolated ? 'YES!' : 'No';
            el.style.color = isolated ? '#ff6b6b' : '#00d4aa';
        }

        function draw() {
            ctx.fillStyle = '#0a0a1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Barrier
            ctx.beginPath();
            ctx.arc(centerX, centerY, barrierRadius, 0, Math.PI * 2);
            const grad = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, barrierRadius);
            grad.addColorStop(0, '#4a4a5a');
            grad.addColorStop(1, '#2a2a3a');
            ctx.fillStyle = grad;
            ctx.fill();
            ctx.fillStyle = '#666';
            ctx.font = '13px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Geographic', centerX, centerY - 8);
            ctx.fillText('Barrier', centerX, centerY + 10);

            // Ring path
            ctx.beginPath();
            ctx.arc(centerX, centerY, ringRadius, 0, Math.PI * 2);
            ctx.strokeStyle = 'rgba(255,255,255,0.08)';
            ctx.lineWidth = 35;
            ctx.stroke();

            // Gene flow lines between adjacent
            for (let i = 0; i < populations.length - 1; i++) {
                const p1 = populations[i], p2 = populations[i + 1];
                const dist = p1.getGeneticDistance(p2);
                ctx.beginPath();
                ctx.moveTo(p1.x, p1.y);
                ctx.lineTo(p2.x, p2.y);
                ctx.strokeStyle = `rgba(100,255,200,${Math.max(0.1, 0.6 - dist * 2)})`;
                ctx.lineWidth = 3;
                ctx.stroke();
            }

            // Termini connection
            if (populations.length >= 2) {
                const first = populations[0], last = populations[populations.length - 1];
                const td = first.getGeneticDistance(last);
                const isolated = td > isolationThreshold;
                ctx.beginPath();
                ctx.setLineDash([8, 4]);
                ctx.moveTo(first.x, first.y);
                ctx.lineTo(last.x, last.y);
                ctx.strokeStyle = isolated ? 'rgba(255,80,80,0.6)' : 'rgba(100,255,150,0.3)';
                ctx.lineWidth = 4;
                ctx.stroke();
                ctx.setLineDash([]);
                if (isolated) {
                    const mx = (first.x + last.x) / 2, my = (first.y + last.y) / 2;
                    ctx.beginPath();
                    ctx.arc(mx, my, 18, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(255,80,80,0.25)';
                    ctx.fill();
                    ctx.fillStyle = '#ff6b6b';
                    ctx.font = 'bold 16px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('X', mx, my);
                }
            }

            // Populations
            populations.forEach((p, i) => {
                const hue = p.getHue();
                const size = 22;
                ctx.beginPath();
                ctx.arc(p.x, p.y, size, 0, Math.PI * 2);
                const pg = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, size);
                pg.addColorStop(0, `hsla(${hue},70%,60%,1)`);
                pg.addColorStop(1, `hsla(${hue},70%,40%,0.8)`);
                ctx.fillStyle = pg;
                ctx.fill();
                ctx.strokeStyle = `hsla(${hue},80%,70%,0.7)`;
                ctx.lineWidth = 2;
                ctx.stroke();
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 11px sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(i + 1, p.x, p.y);
            });

            // Termini labels
            if (populations.length >= 2) {
                ctx.font = '10px sans-serif';
                ctx.fillStyle = '#00d4aa';
                ctx.textAlign = 'center';
                ctx.fillText('Terminus A', populations[0].x, populations[0].y + 35);
                ctx.fillText('Terminus B', populations[populations.length - 1].x, populations[populations.length - 1].y + 35);
            }

            // Generation label
            ctx.fillStyle = '#00d4aa';
            ctx.font = 'bold 14px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText(`Generation: ${generation}`, 20, 30);
        }

        function drawBar() {
            barCtx.fillStyle = '#0a0a1a';
            barCtx.fillRect(0, 0, barCanvas.width, barCanvas.height);
            if (populations.length < 2) return;

            const distances = [];
            for (let i = 0; i < populations.length - 1; i++) {
                distances.push(populations[i].getGeneticDistance(populations[i + 1]));
            }
            distances.push(getTerminiDistance());

            const maxD = Math.max(...distances, isolationThreshold, 0.5);
            const barW = (barCanvas.width - 20) / distances.length - 2;
            const h = barCanvas.height - 20;

            // Threshold line
            const thY = barCanvas.height - 10 - (isolationThreshold / maxD) * h;
            barCtx.strokeStyle = 'rgba(255,100,100,0.5)';
            barCtx.setLineDash([3, 3]);
            barCtx.beginPath();
            barCtx.moveTo(10, thY);
            barCtx.lineTo(barCanvas.width - 10, thY);
            barCtx.stroke();
            barCtx.setLineDash([]);

            distances.forEach((d, i) => {
                const bh = (d / maxD) * h;
                const x = 10 + i * (barW + 2);
                const y = barCanvas.height - 10 - bh;
                const isTermini = i === distances.length - 1;
                barCtx.fillStyle = isTermini ? (d > isolationThreshold ? '#ff6b6b' : '#ffaa00') : '#00d4aa';
                barCtx.fillRect(x, y, barW, bh);
            });
        }

        function loop() {
            if (!running) return;
            step();
            animId = setTimeout(loop, 80);
        }

        document.getElementById('startBtn').addEventListener('click', function() {
            running = !running;
            this.textContent = running ? 'Pause' : 'Start';
            if (running) loop();
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            running = false;
            document.getElementById('startBtn').textContent = 'Start';
            clearTimeout(animId);
            init();
        });

        document.getElementById('numPops').addEventListener('input', function() {
            numPops = +this.value;
            document.getElementById('numPopsVal').textContent = numPops;
        });
        document.getElementById('geneFlow').addEventListener('input', function() {
            geneFlowRate = +this.value;
            document.getElementById('geneFlowVal').textContent = geneFlowRate.toFixed(2);
        });
        document.getElementById('mutation').addEventListener('input', function() {
            mutationRate = +this.value;
            document.getElementById('mutationVal').textContent = mutationRate.toFixed(3);
        });
        document.getElementById('drift').addEventListener('input', function() {
            driftStrength = +this.value;
            document.getElementById('driftVal').textContent = driftStrength.toFixed(2);
        });
        document.getElementById('threshold').addEventListener('input', function() {
            isolationThreshold = +this.value;
            document.getElementById('thresholdVal').textContent = isolationThreshold.toFixed(2);
            updateStats();
            drawBar();
        });

        init();
    </script>
</body>
</html>
