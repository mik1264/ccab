<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Grid - Power Distribution Simulation</title>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600&family=Nunito:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Nunito', sans-serif; background: linear-gradient(135deg, #FEFAE0 0%, #F4F1DE 50%, #EDE8D5 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 20px; }
        h1 { font-family: 'Lora', serif; color: #606C38; font-size: 2rem; margin-bottom: 8px; }
        .subtitle { color: #8A9A5B; font-size: 1rem; }
        .back-link { position: absolute; top: 20px; left: 20px; text-decoration: none; color: #606C38; font-weight: 600; }
        .main-content { display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        .canvas-container { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        canvas { width: 100%; border-radius: 8px; display: block; }
        .controls { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); height: fit-content; }
        .control-group { margin-bottom: 18px; }
        .control-group label { display: block; color: #606C38; font-weight: 600; margin-bottom: 5px; font-size: 0.9rem; }
        .control-group input[type="range"] { width: 100%; accent-color: #8A9A5B; }
        .control-value { text-align: right; color: #8A9A5B; font-size: 0.85rem; }
        button { width: 100%; padding: 10px; margin-top: 5px; border: none; border-radius: 8px; cursor: pointer; font-family: 'Nunito', sans-serif; font-weight: 600; font-size: 0.9rem; transition: all 0.3s; }
        .btn-primary { background: #8A9A5B; color: white; }
        .btn-primary:hover { background: #606C38; }
        .btn-secondary { background: #DDA15E; color: white; }
        .btn-secondary:hover { background: #BC6C25; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .stat-box { background: linear-gradient(135deg, #FEFAE0, #F4F1DE); padding: 10px; border-radius: 8px; text-align: center; }
        .stat-value { font-family: 'Lora', serif; color: #606C38; font-size: 1.1rem; font-weight: 600; }
        .stat-label { color: #8A9A5B; font-size: 0.75rem; }
        .info-panel { margin-top: 15px; padding: 12px; background: #F4F1DE; border-radius: 8px; font-size: 0.8rem; color: #606C38; }
        select { width: 100%; padding: 8px; border: 1px solid #DDA15E; border-radius: 6px; font-family: 'Nunito', sans-serif; background: white; color: #606C38; }
        .grid-status { padding: 10px; border-radius: 8px; text-align: center; font-weight: 600; margin-bottom: 15px; }
        .balanced { background: #90EE90; color: #228B22; }
        .importing { background: #87CEEB; color: #1565C0; }
        .stressed { background: #FFB6C1; color: #DC143C; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Gallery</a>
    <div class="container">
        <header>
            <h1>Smart Grid Simulation</h1>
            <p class="subtitle">Distributed generation, demand response, and storage integration</p>
        </header>
        <div class="main-content">
            <div class="canvas-container">
                <canvas id="simCanvas"></canvas>
            </div>
            <div class="controls">
                <div class="grid-status balanced" id="gridStatus">Grid Status: Balanced</div>
                <div class="control-group">
                    <label>Renewable Penetration (%)</label>
                    <input type="range" id="renewables" min="10" max="80" value="40">
                    <div class="control-value"><span id="renewablesVal">40</span>%</div>
                </div>
                <div class="control-group">
                    <label>Battery Storage (MWh)</label>
                    <input type="range" id="storage" min="0" max="100" value="30">
                    <div class="control-value"><span id="storageVal">30</span></div>
                </div>
                <div class="control-group">
                    <label>Demand Response (%)</label>
                    <input type="range" id="demandResponse" min="0" max="30" value="15">
                    <div class="control-value"><span id="demandResponseVal">15</span>%</div>
                </div>
                <div class="control-group">
                    <label>Base Load (MW)</label>
                    <input type="range" id="baseLoad" min="50" max="200" value="100">
                    <div class="control-value"><span id="baseLoadVal">100</span></div>
                </div>
                <button class="btn-primary" onclick="startSimulation()">Simulate 24 Hours</button>
                <button class="btn-secondary" onclick="resetSimulation()">Reset</button>
                <div class="stats-grid">
                    <div class="stat-box"><div class="stat-value" id="currentDemand">0</div><div class="stat-label">Demand (MW)</div></div>
                    <div class="stat-box"><div class="stat-value" id="currentSupply">0</div><div class="stat-label">Supply (MW)</div></div>
                    <div class="stat-box"><div class="stat-value" id="batteryLevel">0%</div><div class="stat-label">Battery SOC</div></div>
                    <div class="stat-box"><div class="stat-value" id="curtailment">0</div><div class="stat-label">Curtailed (MWh)</div></div>
                    <div class="stat-box"><div class="stat-value" id="gridImport">0</div><div class="stat-label">Grid Import (MWh)</div></div>
                    <div class="stat-box"><div class="stat-value" id="co2Saved">0</div><div class="stat-label">CO‚ÇÇ Saved (t)</div></div>
                </div>
                <div class="info-panel">
                    <strong>Smart Grid:</strong> Balances variable renewables with storage, demand response, and grid exchange to maintain stability.
                </div>
            </div>
        </div>
    </div>
    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        function setupCanvas() {
            const rect = canvas.parentElement.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            canvas.width = rect.width * dpr;
            canvas.height = (rect.width * 0.6) * dpr;
            canvas.style.height = (rect.width * 0.6) + 'px';
            ctx.scale(dpr, dpr);
            return { width: rect.width, height: rect.width * 0.6 };
        }
        let dims = setupCanvas();
        window.addEventListener('resize', () => { dims = setupCanvas(); draw(); });

        let state = { hour: 0, running: false, batterySOC: 50, demandHistory: [], supplyHistory: [], solarHistory: [], windHistory: [], batteryHistory: [], gridHistory: [], curtailed: 0, imported: 0 };

        // Daily patterns
        function getDemand(hour, baseLoad) {
            const pattern = [0.6, 0.55, 0.5, 0.5, 0.55, 0.65, 0.8, 0.95, 1.0, 0.9, 0.85, 0.85, 0.9, 0.85, 0.8, 0.85, 0.95, 1.1, 1.0, 0.9, 0.8, 0.75, 0.7, 0.65];
            return baseLoad * pattern[hour] * (0.9 + Math.random() * 0.2);
        }

        function getSolarOutput(hour, maxCapacity) {
            if (hour < 6 || hour > 19) return 0;
            const sunFactor = Math.sin((hour - 6) / 13 * Math.PI);
            const cloudFactor = 0.7 + Math.random() * 0.3;
            return maxCapacity * sunFactor * cloudFactor;
        }

        function getWindOutput(hour, maxCapacity) {
            const baseWind = 0.3 + 0.2 * Math.sin(hour / 4);
            const variability = 0.6 + Math.random() * 0.4;
            return maxCapacity * baseWind * variability;
        }

        function update() {
            if (!state.running || state.hour >= 24) {
                state.running = false;
                return;
            }

            const renewablePct = parseInt(document.getElementById('renewables').value) / 100;
            const storageCapacity = parseInt(document.getElementById('storage').value);
            const demandResponsePct = parseInt(document.getElementById('demandResponse').value) / 100;
            const baseLoad = parseInt(document.getElementById('baseLoad').value);

            const solarCapacity = baseLoad * renewablePct * 0.6;
            const windCapacity = baseLoad * renewablePct * 0.4;

            const demand = getDemand(state.hour, baseLoad);
            const solar = getSolarOutput(state.hour, solarCapacity);
            const wind = getWindOutput(state.hour, windCapacity);
            const renewable = solar + wind;

            let supply = renewable;
            let batteryFlow = 0;
            let gridFlow = 0;
            let curtailed = 0;

            const gap = demand - renewable;

            if (gap > 0) {
                // Need more power
                // First use battery
                const batteryAvailable = (state.batterySOC / 100) * storageCapacity;
                const fromBattery = Math.min(gap, batteryAvailable, storageCapacity * 0.5);
                batteryFlow = -fromBattery;
                state.batterySOC -= (fromBattery / storageCapacity) * 100;
                supply += fromBattery;

                // Then demand response
                const shiftable = demand * demandResponsePct;
                const shifted = Math.min(gap - fromBattery, shiftable);
                supply += shifted;

                // Finally grid import
                const remaining = demand - supply;
                if (remaining > 0) {
                    gridFlow = remaining;
                    supply += remaining;
                    state.imported += remaining;
                }
            } else {
                // Excess renewable
                const excess = -gap;
                const batteryRoom = (100 - state.batterySOC) / 100 * storageCapacity;
                const toBattery = Math.min(excess, batteryRoom, storageCapacity * 0.5);
                batteryFlow = toBattery;
                state.batterySOC += (toBattery / storageCapacity) * 100;

                const stillExcess = excess - toBattery;
                if (stillExcess > 0) {
                    curtailed = stillExcess;
                    state.curtailed += curtailed;
                }
            }

            state.demandHistory.push(demand);
            state.supplyHistory.push(supply);
            state.solarHistory.push(solar);
            state.windHistory.push(wind);
            state.batteryHistory.push(state.batterySOC);
            state.gridHistory.push(gridFlow);

            // Update UI
            document.getElementById('currentDemand').textContent = demand.toFixed(0);
            document.getElementById('currentSupply').textContent = supply.toFixed(0);
            document.getElementById('batteryLevel').textContent = state.batterySOC.toFixed(0) + '%';
            document.getElementById('curtailment').textContent = state.curtailed.toFixed(0);
            document.getElementById('gridImport').textContent = state.imported.toFixed(0);
            document.getElementById('co2Saved').textContent = ((renewable * 24 / 1000) * 0.4).toFixed(1);

            const status = document.getElementById('gridStatus');
            if (gridFlow > demand * 0.1) {
                status.className = 'grid-status stressed';
                status.textContent = 'Grid Status: High Import';
            } else if (gridFlow > 0) {
                status.className = 'grid-status importing';
                status.textContent = 'Grid Status: Importing';
            } else {
                status.className = 'grid-status balanced';
                status.textContent = 'Grid Status: Balanced';
            }

            state.hour++;
            draw();
            setTimeout(update, 200);
        }

        function draw() {
            ctx.clearRect(0, 0, dims.width, dims.height);

            // Network diagram on left
            const netX = 30, netY = 50, netW = dims.width * 0.4, netH = dims.height - 80;
            drawNetworkDiagram(netX, netY, netW, netH);

            // Charts on right
            const chartX = dims.width * 0.48, chartW = dims.width * 0.48, chartH = 70;
            drawChart(chartX, 40, chartW, chartH, [state.demandHistory, state.supplyHistory], ['#BC6C25', '#228B22'], 'Demand vs Supply (MW)');
            drawStackedChart(chartX, 130, chartW, chartH, [state.solarHistory, state.windHistory], ['#FFD700', '#4682B4'], 'Renewable Generation');
            drawChart(chartX, 220, chartW, chartH, [state.batteryHistory], ['#9C27B0'], 'Battery SOC (%)');

            // Title
            ctx.fillStyle = '#606C38';
            ctx.font = '14px Lora';
            ctx.fillText(`Smart Grid | Hour ${state.hour}:00`, 30, 30);
        }

        function drawNetworkDiagram(x, y, w, h) {
            // Central hub
            const hubX = x + w / 2, hubY = y + h / 2;

            // Connections
            ctx.strokeStyle = '#8A9A5B';
            ctx.lineWidth = 2;

            // Solar (top left)
            const solarX = x + w * 0.2, solarY = y + h * 0.2;
            ctx.beginPath();
            ctx.moveTo(solarX, solarY);
            ctx.lineTo(hubX, hubY);
            ctx.stroke();
            ctx.fillStyle = '#FFD700';
            ctx.beginPath();
            ctx.arc(solarX, solarY, 20, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#333';
            ctx.font = '10px Nunito';
            ctx.fillText('‚òÄÔ∏è Solar', solarX - 15, solarY + 35);

            // Wind (top right)
            const windX = x + w * 0.8, windY = y + h * 0.2;
            ctx.beginPath();
            ctx.moveTo(windX, windY);
            ctx.lineTo(hubX, hubY);
            ctx.stroke();
            ctx.fillStyle = '#4682B4';
            ctx.beginPath();
            ctx.arc(windX, windY, 20, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#333';
            ctx.fillText('üí® Wind', windX - 15, windY + 35);

            // Battery (left)
            const battX = x + w * 0.15, battY = y + h * 0.6;
            ctx.beginPath();
            ctx.moveTo(battX, battY);
            ctx.lineTo(hubX, hubY);
            ctx.stroke();
            ctx.fillStyle = '#9C27B0';
            ctx.fillRect(battX - 15, battY - 10, 30, 20);
            ctx.fillStyle = '#E1BEE7';
            ctx.fillRect(battX - 12, battY - 7, state.batterySOC / 100 * 24, 14);
            ctx.fillStyle = '#333';
            ctx.fillText('üîã Storage', battX - 20, battY + 30);

            // Grid (bottom)
            const gridX = x + w / 2, gridY = y + h * 0.9;
            ctx.beginPath();
            ctx.moveTo(gridX, gridY);
            ctx.lineTo(hubX, hubY);
            ctx.stroke();
            ctx.fillStyle = '#666';
            ctx.fillRect(gridX - 20, gridY - 10, 40, 20);
            ctx.fillStyle = '#333';
            ctx.fillText('‚ö° Grid', gridX - 12, gridY + 30);

            // Loads (right)
            const loadX = x + w * 0.85, loadY = y + h * 0.6;
            ctx.beginPath();
            ctx.moveTo(loadX, loadY);
            ctx.lineTo(hubX, hubY);
            ctx.stroke();
            ctx.fillStyle = '#BC6C25';
            for (let i = 0; i < 3; i++) {
                ctx.fillRect(loadX - 10 + i * 8, loadY - 15, 6, 20);
            }
            ctx.fillStyle = '#333';
            ctx.fillText('üè† Loads', loadX - 15, loadY + 30);

            // Hub
            ctx.fillStyle = '#228B22';
            ctx.beginPath();
            ctx.arc(hubX, hubY, 25, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = 'white';
            ctx.font = '12px Nunito';
            ctx.fillText('HUB', hubX - 15, hubY + 5);

            ctx.lineWidth = 1;
        }

        function drawChart(x, y, w, h, datasets, colors, label) {
            ctx.fillStyle = 'rgba(255,255,255,0.9)';
            ctx.fillRect(x, y, w, h);
            ctx.strokeRect(x, y, w, h);
            ctx.fillStyle = '#606C38';
            ctx.font = '10px Nunito';
            ctx.fillText(label, x + 5, y - 3);

            if (datasets[0].length < 2) return;
            const allData = datasets.flat();
            const maxVal = Math.max(...allData, 1);
            const step = w / 23;

            datasets.forEach((data, di) => {
                ctx.beginPath();
                ctx.strokeStyle = colors[di];
                ctx.lineWidth = 2;
                data.forEach((val, i) => {
                    const px = x + i * step;
                    const py = y + h - 5 - (val / maxVal) * (h - 10);
                    if (i === 0) ctx.moveTo(px, py);
                    else ctx.lineTo(px, py);
                });
                ctx.stroke();
            });
            ctx.lineWidth = 1;
        }

        function drawStackedChart(x, y, w, h, datasets, colors, label) {
            ctx.fillStyle = 'rgba(255,255,255,0.9)';
            ctx.fillRect(x, y, w, h);
            ctx.strokeRect(x, y, w, h);
            ctx.fillStyle = '#606C38';
            ctx.font = '10px Nunito';
            ctx.fillText(label, x + 5, y - 3);

            if (datasets[0].length < 2) return;
            const sums = datasets[0].map((_, i) => datasets.reduce((s, d) => s + (d[i] || 0), 0));
            const maxVal = Math.max(...sums, 1);
            const step = w / 23;

            datasets.forEach((data, di) => {
                const prevData = di === 0 ? data.map(() => 0) : datasets.slice(0, di).reduce((acc, d) => acc.map((v, i) => v + (d[i] || 0)), data.map(() => 0));

                ctx.fillStyle = colors[di] + '80';
                ctx.beginPath();
                ctx.moveTo(x, y + h - 5);
                data.forEach((val, i) => {
                    const px = x + i * step;
                    const py = y + h - 5 - ((prevData[i] + val) / maxVal) * (h - 10);
                    ctx.lineTo(px, py);
                });
                ctx.lineTo(x + (data.length - 1) * step, y + h - 5);
                ctx.closePath();
                ctx.fill();
            });
        }

        function startSimulation() {
            state = { hour: 0, running: true, batterySOC: 50, demandHistory: [], supplyHistory: [], solarHistory: [], windHistory: [], batteryHistory: [], gridHistory: [], curtailed: 0, imported: 0 };
            update();
        }

        function resetSimulation() {
            state = { hour: 0, running: false, batterySOC: 50, demandHistory: [], supplyHistory: [], solarHistory: [], windHistory: [], batteryHistory: [], gridHistory: [], curtailed: 0, imported: 0 };
            draw();
        }

        function updateSliderDisplays() {
            document.getElementById('renewablesVal').textContent = document.getElementById('renewables').value;
            document.getElementById('storageVal').textContent = document.getElementById('storage').value;
            document.getElementById('demandResponseVal').textContent = document.getElementById('demandResponse').value;
            document.getElementById('baseLoadVal').textContent = document.getElementById('baseLoad').value;
        }

        document.querySelectorAll('input[type="range"]').forEach(s => s.addEventListener('input', updateSliderDisplays));
        draw();
    </script>
</body>
</html>
