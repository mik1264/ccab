<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morphing Prime Spiral</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0a0a0f; overflow: hidden; font-family: system-ui; }
        canvas { display: block; }
        .back-link {
            position: fixed; top: 20px; left: 20px; z-index: 100;
            color: #8A9A5B; text-decoration: none;
            background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 25px;
            font-size: 14px; transition: all 0.3s;
        }
        .back-link:hover { background: rgba(138,154,91,0.3); }
        .info {
            position: fixed; bottom: 20px; left: 20px; z-index: 100;
            background: rgba(0,0,0,0.85); padding: 20px; border-radius: 15px;
            color: white; font-size: 14px;
        }
        .info h3 { color: #DDA15E; margin-bottom: 10px; }
        .controls {
            position: fixed; top: 20px; right: 20px; z-index: 100;
            background: rgba(0,0,0,0.85); padding: 20px; border-radius: 15px;
        }
        .controls h3 { color: #DDA15E; margin-bottom: 15px; }
        .controls label { color: white; display: block; margin: 10px 0; font-size: 14px; }
        .controls input { width: 150px; }
        .controls button {
            background: #8A9A5B; border: none; color: white;
            padding: 8px 16px; border-radius: 5px; cursor: pointer;
            margin: 5px 5px 5px 0;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Gallery</a>
    <div class="controls">
        <h3>Spiral Morphing</h3>
        <label>Spiral Type:
            <select id="spiralType">
                <option value="ulam">Ulam (Square)</option>
                <option value="archimedean">Archimedean</option>
                <option value="fermat">Fermat</option>
                <option value="logarithmic">Logarithmic</option>
            </select>
        </label>
        <label>Morph Speed: <input type="range" id="morphSpeed" min="0" max="100" value="30"></label>
        <label>
            <input type="checkbox" id="autoMorph" checked> Auto-morph between types
        </label>
    </div>
    <div class="info">
        <h3>Morphing Spiral</h3>
        <p>Watch primes transform between different spiral arrangements. Each reveals different patterns!</p>
    </div>
    <canvas id="canvas"></canvas>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        const maxN = 5000;
        let time = 0;
        let morphProgress = 0;
        let currentType = 0;
        let targetType = 1;
        let morphSpeed = 0.003;
        let autoMorph = true;

        // Sieve
        const primes = [];
        const isPrimeArr = new Array(maxN + 1).fill(true);
        isPrimeArr[0] = isPrimeArr[1] = false;
        for (let i = 2; i * i <= maxN; i++) {
            if (isPrimeArr[i]) {
                for (let j = i * i; j <= maxN; j += i) {
                    isPrimeArr[j] = false;
                }
            }
        }
        for (let i = 2; i <= maxN; i++) {
            if (isPrimeArr[i]) primes.push(i);
        }

        // Different spiral coordinate functions
        function getUlamCoord(n, scale) {
            if (n === 1) return { x: 0, y: 0 };
            let layer = Math.ceil((Math.sqrt(n) - 1) / 2);
            let leg = Math.floor((n - (2 * layer - 1) ** 2) / (2 * layer));
            let element = (n - (2 * layer - 1) ** 2) % (2 * layer);
            let x, y;
            switch (leg) {
                case 0: x = layer; y = -layer + 1 + element; break;
                case 1: x = layer - 1 - element; y = layer; break;
                case 2: x = -layer; y = layer - 1 - element; break;
                case 3: x = -layer + 1 + element; y = -layer; break;
            }
            return { x: x * scale, y: y * scale };
        }

        function getArchimedeanCoord(n, scale) {
            const a = 0;
            const b = 0.5;
            const theta = Math.sqrt(n) * 0.5;
            const r = (a + b * theta) * scale;
            return { x: r * Math.cos(theta), y: r * Math.sin(theta) };
        }

        function getFermatCoord(n, scale) {
            const theta = n * 2.39996; // Golden angle
            const r = Math.sqrt(n) * scale * 0.5;
            return { x: r * Math.cos(theta), y: r * Math.sin(theta) };
        }

        function getLogarithmicCoord(n, scale) {
            const a = 1;
            const b = 0.15;
            const theta = Math.log(n + 1) * 3;
            const r = a * Math.exp(b * theta) * scale * 0.3;
            return { x: r * Math.cos(theta), y: r * Math.sin(theta) };
        }

        const spiralFunctions = [getUlamCoord, getArchimedeanCoord, getFermatCoord, getLogarithmicCoord];
        const spiralNames = ['ulam', 'archimedean', 'fermat', 'logarithmic'];

        function lerp(a, b, t) {
            return a + (b - a) * t;
        }

        function easeInOutCubic(t) {
            return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        function draw() {
            time += 0.016;

            // Handle morphing
            if (autoMorph) {
                morphProgress += morphSpeed;
                if (morphProgress >= 1) {
                    morphProgress = 0;
                    currentType = targetType;
                    targetType = (targetType + 1) % 4;
                }
            }

            const offsetX = canvas.width / 2;
            const offsetY = canvas.height / 2;
            const scale = Math.min(canvas.width, canvas.height) / 200;

            // Fade
            ctx.fillStyle = 'rgba(10, 10, 15, 0.15)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const easedProgress = easeInOutCubic(morphProgress);

            // Draw primes
            for (const p of primes) {
                const c1 = spiralFunctions[currentType](p, scale);
                const c2 = spiralFunctions[targetType](p, scale);

                const x = lerp(c1.x, c2.x, easedProgress);
                const y = lerp(c1.y, c2.y, easedProgress);

                const px = offsetX + x;
                const py = offsetY + y;

                if (px < -10 || px > canvas.width + 10 ||
                    py < -10 || py > canvas.height + 10) continue;

                const hue = (time * 20 + p * 0.1) % 360;
                const size = 2 + Math.log(p) * 0.2;

                // Glow
                ctx.fillStyle = `hsla(${hue}, 80%, 60%, 0.6)`;
                ctx.beginPath();
                ctx.arc(px, py, size * 1.5, 0, Math.PI * 2);
                ctx.fill();

                // Core
                ctx.fillStyle = `hsl(${hue}, 90%, 70%)`;
                ctx.beginPath();
                ctx.arc(px, py, size, 0, Math.PI * 2);
                ctx.fill();
            }

            // Center
            ctx.fillStyle = '#BC6C25';
            ctx.beginPath();
            ctx.arc(offsetX, offsetY, 6, 0, Math.PI * 2);
            ctx.fill();

            requestAnimationFrame(draw);
        }

        document.getElementById('spiralType').addEventListener('change', (e) => {
            const idx = spiralNames.indexOf(e.target.value);
            if (idx !== -1) {
                currentType = idx;
                targetType = (idx + 1) % 4;
                morphProgress = 0;
            }
        });

        document.getElementById('morphSpeed').addEventListener('input', (e) => {
            morphSpeed = e.target.value * 0.0001;
        });

        document.getElementById('autoMorph').addEventListener('change', (e) => {
            autoMorph = e.target.checked;
        });

        window.addEventListener('resize', resize);
        resize();
        draw();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
