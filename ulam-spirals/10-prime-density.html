<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prime Density Heatmap</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0a0a0f; overflow: hidden; font-family: system-ui; }
        canvas { display: block; }
        .back-link {
            position: fixed; top: 20px; left: 20px; z-index: 100;
            color: #8A9A5B; text-decoration: none;
            background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 25px;
            font-size: 14px; transition: all 0.3s;
        }
        .back-link:hover { background: rgba(138,154,91,0.3); }
        .legend {
            position: fixed; bottom: 20px; right: 20px; z-index: 100;
            background: rgba(0,0,0,0.85); padding: 20px; border-radius: 15px;
            color: white; font-size: 14px;
        }
        .legend h3 { color: #DDA15E; margin-bottom: 12px; }
        .gradient-bar {
            width: 200px; height: 20px; border-radius: 5px;
            background: linear-gradient(to right, #000033, #0066ff, #00ffff, #ffff00, #ff0000);
        }
        .gradient-labels { display: flex; justify-content: space-between; font-size: 11px; margin-top: 5px; }
        .controls {
            position: fixed; top: 20px; right: 20px; z-index: 100;
            background: rgba(0,0,0,0.8); padding: 15px 20px; border-radius: 10px;
        }
        .controls label { color: white; display: block; margin: 8px 0; font-size: 14px; }
        .controls input { width: 120px; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Gallery</a>
    <div class="controls">
        <label>Region Size: <span id="regionVal">5</span>
            <input type="range" id="regionSize" min="3" max="15" step="2" value="5">
        </label>
        <label>
            <input type="checkbox" id="showPrimes" checked> Overlay Primes
        </label>
    </div>
    <div class="legend">
        <h3>Prime Density</h3>
        <div class="gradient-bar"></div>
        <div class="gradient-labels">
            <span>0%</span>
            <span>25%</span>
            <span>50%</span>
        </div>
        <p style="margin-top:10px;font-size:12px;opacity:0.7">Density in local region</p>
    </div>
    <canvas id="canvas"></canvas>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        const gridSize = 201;
        const maxN = gridSize * gridSize;
        let cellSize;
        let regionSize = 5;
        let showPrimes = true;

        // Sieve
        const isPrimeArr = new Array(maxN + 1).fill(true);
        isPrimeArr[0] = isPrimeArr[1] = false;
        for (let i = 2; i * i <= maxN; i++) {
            if (isPrimeArr[i]) {
                for (let j = i * i; j <= maxN; j += i) {
                    isPrimeArr[j] = false;
                }
            }
        }

        // Build coordinate map
        const coordMap = new Map();
        function getSpiralCoord(n) {
            if (n === 1) return { x: 0, y: 0 };
            let layer = Math.ceil((Math.sqrt(n) - 1) / 2);
            let leg = Math.floor((n - (2 * layer - 1) ** 2) / (2 * layer));
            let element = (n - (2 * layer - 1) ** 2) % (2 * layer);
            let x, y;
            switch (leg) {
                case 0: x = layer; y = -layer + 1 + element; break;
                case 1: x = layer - 1 - element; y = layer; break;
                case 2: x = -layer; y = layer - 1 - element; break;
                case 3: x = -layer + 1 + element; y = -layer; break;
            }
            return { x, y };
        }

        // Pre-compute coordinates and prime status on grid
        const gridData = {};
        for (let n = 1; n <= maxN; n++) {
            const { x, y } = getSpiralCoord(n);
            const key = `${x},${y}`;
            gridData[key] = { n, isPrime: isPrimeArr[n] };
        }

        function getDensity(cx, cy, radius) {
            let primeCount = 0;
            let total = 0;
            for (let dx = -radius; dx <= radius; dx++) {
                for (let dy = -radius; dy <= radius; dy++) {
                    const key = `${cx + dx},${cy + dy}`;
                    if (gridData[key]) {
                        total++;
                        if (gridData[key].isPrime) primeCount++;
                    }
                }
            }
            return total > 0 ? primeCount / total : 0;
        }

        function densityToColor(d) {
            // 0 to ~0.5 mapped to color gradient
            const t = Math.min(d * 2, 1);
            if (t < 0.25) {
                const s = t / 0.25;
                return `rgb(${Math.floor(s * 100)}, ${Math.floor(s * 100)}, ${Math.floor(51 + s * 204)})`;
            } else if (t < 0.5) {
                const s = (t - 0.25) / 0.25;
                return `rgb(0, ${Math.floor(102 + s * 153)}, ${Math.floor(255 - s * 255)})`;
            } else if (t < 0.75) {
                const s = (t - 0.5) / 0.25;
                return `rgb(${Math.floor(s * 255)}, 255, 0)`;
            } else {
                const s = (t - 0.75) / 0.25;
                return `rgb(255, ${Math.floor(255 - s * 255)}, 0)`;
            }
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            cellSize = Math.min(canvas.width, canvas.height) / gridSize;
            draw();
        }

        function draw() {
            const offsetX = canvas.width / 2;
            const offsetY = canvas.height / 2;
            const halfGrid = Math.floor(gridSize / 2);
            const radius = Math.floor(regionSize / 2);

            ctx.fillStyle = '#0a0a0f';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw density heatmap
            for (let gx = -halfGrid; gx <= halfGrid; gx++) {
                for (let gy = -halfGrid; gy <= halfGrid; gy++) {
                    const px = offsetX + gx * cellSize;
                    const py = offsetY + gy * cellSize;

                    if (px < -cellSize || px > canvas.width + cellSize ||
                        py < -cellSize || py > canvas.height + cellSize) continue;

                    const density = getDensity(gx, gy, radius);
                    ctx.fillStyle = densityToColor(density);
                    ctx.fillRect(px - cellSize/2, py - cellSize/2, cellSize, cellSize);
                }
            }

            // Overlay primes as dots
            if (showPrimes && cellSize > 2) {
                for (let n = 2; n <= maxN; n++) {
                    if (!isPrimeArr[n]) continue;
                    const { x, y } = getSpiralCoord(n);
                    const px = offsetX + x * cellSize;
                    const py = offsetY + y * cellSize;

                    if (px < -cellSize || px > canvas.width + cellSize ||
                        py < -cellSize || py > canvas.height + cellSize) continue;

                    ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                    ctx.beginPath();
                    ctx.arc(px, py, Math.max(1, cellSize * 0.2), 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            // Center
            ctx.fillStyle = '#BC6C25';
            ctx.beginPath();
            ctx.arc(offsetX, offsetY, cellSize * 0.5, 0, Math.PI * 2);
            ctx.fill();
        }

        document.getElementById('regionSize').addEventListener('input', (e) => {
            regionSize = parseInt(e.target.value);
            document.getElementById('regionVal').textContent = regionSize;
            draw();
        });

        document.getElementById('showPrimes').addEventListener('change', (e) => {
            showPrimes = e.target.checked;
            draw();
        });

        window.addEventListener('resize', resize);
        resize();
    </script>
</body>
</html>
