<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lorenz Attractor - CCAB</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Space+Mono:wght@400;700&family=Nunito:wght@400;600&display=swap" rel="stylesheet">
    <style>
        *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
        :root{
            --panel-bg:rgba(10,14,30,0.75);
            --panel-border:rgba(100,120,255,0.15);
            --accent:#667eea;
            --accent-warm:#fbbf24;
            --text:#e0e0ff;
            --text-dim:#8888aa;
            --font-display:'Orbitron',sans-serif;
            --font-mono:'Space Mono',monospace;
            --font-body:'Nunito',sans-serif;
        }
        body{background:#000;color:var(--text);font-family:var(--font-body);overflow:hidden;width:100vw;height:100vh}
        #canvas-container{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0}

        .organic-back-link{
            position:fixed;top:16px;left:16px;z-index:10000;display:inline-flex;align-items:center;gap:0.4rem;
            color:#e0e0ff;text-decoration:none;font-family:var(--font-body);font-weight:600;font-size:0.85rem;
            padding:0.4rem 0.9rem;background:var(--panel-bg);border-radius:20px;border:1px solid var(--panel-border);
            backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);transition:all 0.3s ease;
        }
        .organic-back-link:hover{background:rgba(102,126,234,0.3);transform:translateX(-3px);border-color:var(--accent)}

        #control-panel{
            position:fixed;top:16px;right:16px;width:320px;max-height:calc(100vh - 32px);overflow-y:auto;
            z-index:1000;background:var(--panel-bg);border:1px solid var(--panel-border);border-radius:16px;
            backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);padding:20px;
            transition:transform 0.4s cubic-bezier(0.4,0,0.2,1),opacity 0.3s;
        }
        #control-panel.hidden{transform:translateX(340px);opacity:0;pointer-events:none}
        #control-panel::-webkit-scrollbar{width:4px}
        #control-panel::-webkit-scrollbar-track{background:transparent}
        #control-panel::-webkit-scrollbar-thumb{background:rgba(102,126,234,0.3);border-radius:2px}

        .panel-title{
            font-family:var(--font-display);font-size:1.1rem;margin-bottom:4px;
            background:linear-gradient(135deg,var(--accent),var(--accent-warm));
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
        }
        .panel-subtitle{font-size:0.7rem;color:var(--text-dim);margin-bottom:16px;letter-spacing:0.5px}
        .section-header{
            font-family:var(--font-display);font-size:0.65rem;color:var(--accent);text-transform:uppercase;
            letter-spacing:1.5px;margin:16px 0 8px;padding-bottom:4px;border-bottom:1px solid rgba(102,126,234,0.15);
        }
        .control-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
        .control-row label{font-size:0.78rem;color:var(--text-dim);flex-shrink:0;min-width:90px}
        .control-row .value-display{font-family:var(--font-mono);font-size:0.72rem;color:var(--accent);min-width:52px;text-align:right}

        input[type="range"]{
            -webkit-appearance:none;appearance:none;flex:1;height:4px;margin:0 8px;
            background:rgba(102,126,234,0.2);border-radius:2px;outline:none;
        }
        input[type="range"]::-webkit-slider-thumb{
            -webkit-appearance:none;appearance:none;width:14px;height:14px;border-radius:50%;
            background:var(--accent);cursor:pointer;box-shadow:0 0 8px rgba(102,126,234,0.5);
        }
        input[type="range"]::-moz-range-thumb{width:14px;height:14px;border-radius:50%;background:var(--accent);cursor:pointer;border:none}

        .preset-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px}
        .preset-btn{
            padding:6px 8px;font-size:0.7rem;font-family:var(--font-body);font-weight:600;
            background:rgba(102,126,234,0.1);border:1px solid rgba(102,126,234,0.25);border-radius:8px;
            color:var(--text);cursor:pointer;transition:all 0.2s;text-align:center;
        }
        .preset-btn:hover{background:rgba(102,126,234,0.25);border-color:var(--accent);transform:translateY(-1px)}
        .preset-btn.active{background:linear-gradient(135deg,rgba(102,126,234,0.4),rgba(251,191,36,0.2));border-color:var(--accent)}

        .action-btn{
            padding:6px 12px;font-size:0.72rem;font-family:var(--font-body);font-weight:600;
            background:linear-gradient(135deg,var(--accent),#7c4dff);border:none;border-radius:8px;
            color:white;cursor:pointer;transition:all 0.2s;
        }
        .action-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(102,126,234,0.4)}

        .toggle-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
        .toggle-row label{font-size:0.75rem;color:var(--text-dim)}
        .toggle-switch{position:relative;width:36px;height:20px;cursor:pointer}
        .toggle-switch input{display:none}
        .toggle-slider{position:absolute;inset:0;background:rgba(255,255,255,0.1);border-radius:10px;transition:0.3s}
        .toggle-slider::before{
            content:'';position:absolute;width:16px;height:16px;left:2px;top:2px;
            background:#888;border-radius:50%;transition:0.3s;
        }
        .toggle-switch input:checked+.toggle-slider{background:rgba(102,126,234,0.4)}
        .toggle-switch input:checked+.toggle-slider::before{transform:translateX(16px);background:var(--accent)}

        #stats-overlay{
            position:fixed;bottom:16px;left:16px;z-index:1000;background:var(--panel-bg);
            border:1px solid var(--panel-border);border-radius:12px;backdrop-filter:blur(16px);
            -webkit-backdrop-filter:blur(16px);padding:14px 18px;font-family:var(--font-mono);
            font-size:0.7rem;line-height:1.6;min-width:200px;
        }
        #stats-overlay .stat-line{display:flex;justify-content:space-between;gap:12px}
        #stats-overlay .stat-label{color:var(--text-dim)}
        #stats-overlay .stat-value{color:var(--accent)}
        #stats-overlay .stat-value.warm{color:var(--accent-warm)}
        #stats-overlay .lyapunov-line .stat-value{color:#ff6b6b}

        #keyboard-help{
            position:fixed;bottom:16px;right:16px;z-index:1000;background:var(--panel-bg);
            border:1px solid var(--panel-border);border-radius:12px;backdrop-filter:blur(16px);
            -webkit-backdrop-filter:blur(16px);padding:10px 14px;font-size:0.65rem;color:var(--text-dim);
        }
        .key-hint{display:inline-flex;align-items:center;gap:4px;margin:2px 0}
        kbd{
            background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:3px;
            padding:1px 5px;font-family:var(--font-mono);font-size:0.65rem;color:var(--text);
        }

        #title-overlay{position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:900;text-align:center;pointer-events:none}
        #title-overlay h1{
            font-family:var(--font-display);font-size:1.2rem;
            background:linear-gradient(135deg,var(--accent) 0%,var(--accent-warm) 50%,var(--accent) 100%);
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:2px;
        }
        #title-overlay .sub{font-size:0.65rem;color:var(--text-dim);margin-top:2px;letter-spacing:1px}

        #fps-display{
            position:fixed;top:60px;left:16px;z-index:1000;font-family:var(--font-mono);font-size:0.65rem;
            color:var(--text-dim);background:var(--panel-bg);border:1px solid var(--panel-border);border-radius:8px;
            backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);padding:4px 10px;
        }

        .projection-overlay{position:fixed;bottom:16px;z-index:900;opacity:0.5;transition:opacity 0.3s;pointer-events:none}
        .projection-overlay:hover{opacity:0.8}
        .projection-overlay canvas{border:1px solid rgba(102,126,234,0.2);border-radius:8px;background:rgba(0,0,0,0.3)}
        .projection-overlay .proj-label{font-family:var(--font-mono);font-size:0.55rem;color:var(--text-dim);text-align:center;margin-top:2px}
        #proj-xy{left:240px}
        #proj-xz{left:380px}
        #proj-yz{left:520px}
        .projection-overlay.hidden{display:none}

        @media(max-width:768px){
            #control-panel{width:280px;right:8px;top:8px;padding:14px;max-height:calc(100vh - 16px)}
            #stats-overlay{left:8px;bottom:8px}
            #keyboard-help{display:none}
            .projection-overlay{display:none}
        }
    </style>
</head>
<body>

<div id="canvas-container"></div>

<a href="../index.html" class="organic-back-link">
    <span>&#8592;</span>
    <span>Gallery</span>
</a>

<div id="title-overlay">
    <h1>LORENZ ATTRACTOR</h1>
    <div class="sub">Deterministic Chaos &middot; Strange Attractors &middot; Butterfly Effect</div>
</div>

<div id="fps-display">-- FPS</div>

<div id="stats-overlay">
    <div class="stat-line"><span class="stat-label">Position X</span><span class="stat-value" id="s-x">0.00</span></div>
    <div class="stat-line"><span class="stat-label">Position Y</span><span class="stat-value" id="s-y">0.00</span></div>
    <div class="stat-line"><span class="stat-label">Position Z</span><span class="stat-value" id="s-z">0.00</span></div>
    <div class="stat-line"><span class="stat-label">Velocity</span><span class="stat-value warm" id="s-vel">0.00</span></div>
    <div class="stat-line lyapunov-line"><span class="stat-label">Lyapunov Exp</span><span class="stat-value" id="s-lyap">0.000</span></div>
    <div class="stat-line"><span class="stat-label">Step Count</span><span class="stat-value" id="s-steps">0</span></div>
</div>

<div id="proj-xy" class="projection-overlay hidden">
    <canvas id="canvas-xy" width="120" height="120"></canvas>
    <div class="proj-label">XY</div>
</div>
<div id="proj-xz" class="projection-overlay hidden">
    <canvas id="canvas-xz" width="120" height="120"></canvas>
    <div class="proj-label">XZ</div>
</div>
<div id="proj-yz" class="projection-overlay hidden">
    <canvas id="canvas-yz" width="120" height="120"></canvas>
    <div class="proj-label">YZ</div>
</div>

<div id="keyboard-help">
    <div class="key-hint"><kbd>H</kbd> Toggle panel</div>
    <div class="key-hint"><kbd>P</kbd> Projections</div>
    <div class="key-hint"><kbd>Space</kbd> Pause</div>
    <div class="key-hint"><kbd>R</kbd> Reset</div>
    <div class="key-hint"><kbd>1-4</kbd> Presets</div>
</div>

<div id="control-panel">
    <div class="panel-title">Lorenz System</div>
    <div class="panel-subtitle">dx/dt = sigma(y-x) &middot; dy/dt = x(rho-z)-y &middot; dz/dt = xy - beta*z</div>

    <div class="section-header">Presets</div>
    <div class="preset-grid">
        <button class="preset-btn active" id="preset-lorenz" onclick="applyPreset('lorenz')">Classic Lorenz</button>
        <button class="preset-btn" id="preset-chen" onclick="applyPreset('chen')">Chen System</button>
        <button class="preset-btn" id="preset-rossler" onclick="applyPreset('rossler')">Rossler</button>
        <button class="preset-btn" id="preset-sprott" onclick="applyPreset('sprott')">Sprott</button>
    </div>

    <div class="section-header">Parameters</div>
    <div class="control-row"><label>sigma</label><input type="range" id="sl-sigma" min="0" max="30" step="0.1" value="10"><span class="value-display" id="vd-sigma">10.0</span></div>
    <div class="control-row"><label>rho</label><input type="range" id="sl-rho" min="0" max="60" step="0.1" value="28"><span class="value-display" id="vd-rho">28.0</span></div>
    <div class="control-row"><label>beta</label><input type="range" id="sl-beta" min="0" max="10" step="0.01" value="2.67"><span class="value-display" id="vd-beta">2.67</span></div>

    <div class="section-header">Initial Conditions</div>
    <div class="control-row"><label>Perturbation</label><input type="range" id="sl-perturb" min="0.0001" max="1" step="0.0001" value="0.01"><span class="value-display" id="vd-perturb">0.010</span></div>

    <div class="section-header">Visualization</div>
    <div class="control-row"><label>Trail Length</label><input type="range" id="sl-trail" min="500" max="20000" step="500" value="8000"><span class="value-display" id="vd-trail">8000</span></div>
    <div class="control-row"><label>Speed</label><input type="range" id="sl-speed" min="1" max="20" step="1" value="6"><span class="value-display" id="vd-speed">6</span></div>
    <div class="control-row"><label>Bloom</label><input type="range" id="sl-bloom" min="0" max="3" step="0.1" value="1.2"><span class="value-display" id="vd-bloom">1.2</span></div>
    <div class="control-row"><label>Line Width</label><input type="range" id="sl-tubeRadius" min="0.02" max="0.4" step="0.01" value="0.12"><span class="value-display" id="vd-tubeRadius">0.12</span></div>

    <div class="section-header">Display</div>
    <div class="toggle-row"><label>Fixed Points</label><label class="toggle-switch"><input type="checkbox" id="tog-fixed" checked><span class="toggle-slider"></span></label></div>
    <div class="toggle-row"><label>Phase Projections</label><label class="toggle-switch"><input type="checkbox" id="tog-proj"><span class="toggle-slider"></span></label></div>
    <div class="toggle-row"><label>Stars</label><label class="toggle-switch"><input type="checkbox" id="tog-stars" checked><span class="toggle-slider"></span></label></div>
    <div class="toggle-row"><label>Auto-Rotate</label><label class="toggle-switch"><input type="checkbox" id="tog-autorotate"><span class="toggle-slider"></span></label></div>

    <div class="section-header">Actions</div>
    <div style="display:flex;gap:6px;flex-wrap:wrap;">
        <button class="action-btn" onclick="togglePause()">Pause / Resume</button>
        <button class="action-btn" onclick="resetSimulation()">Reset</button>
    </div>
</div>

<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.160.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://unpkg.com/three@0.160.0/examples/js/shaders/CopyShader.js"></script>
<script src="https://unpkg.com/three@0.160.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
<script src="https://unpkg.com/three@0.160.0/examples/js/postprocessing/EffectComposer.js"></script>
<script src="https://unpkg.com/three@0.160.0/examples/js/postprocessing/RenderPass.js"></script>
<script src="https://unpkg.com/three@0.160.0/examples/js/postprocessing/ShaderPass.js"></script>
<script src="https://unpkg.com/three@0.160.0/examples/js/postprocessing/UnrealBloomPass.js"></script>

<script>
(function() {
    'use strict';

    /* ===== CONFIG ===== */
    var CONFIG = {
        sigma: 10.0, rho: 28.0, beta: 8.0 / 3.0,
        dt: 0.005, stepsPerFrame: 6, maxTrailPoints: 8000,
        numTrajectories: 4, perturbation: 0.01,
        tubeRadius: 0.12, tubeSegments: 4,
        bloomStrength: 1.2, bloomRadius: 0.5, bloomThreshold: 0.1,
        paused: false, showFixedPoints: true, showProjections: false,
        showStars: true, autoRotate: false, systemType: 'lorenz'
    };

    var TRAJ_COLORS = [
        new THREE.Color(0x00ccff), new THREE.Color(0xff3366),
        new THREE.Color(0x33ff88), new THREE.Color(0xffaa00),
        new THREE.Color(0xcc44ff)
    ];

    /* ===== DYNAMICAL SYSTEMS ===== */
    var SYSTEMS = {
        lorenz: {
            sigma: 10, rho: 28, beta: 8 / 3,
            deriv: function(x, y, z, s, r, b) {
                return { dx: s * (y - x), dy: x * (r - z) - y, dz: x * y - b * z };
            },
            center: new THREE.Vector3(0, 0, 25), scale: 1.0
        },
        chen: {
            sigma: 35, rho: 28, beta: 3,
            deriv: function(x, y, z, a, c, b) {
                return { dx: a * (y - x), dy: (c - a) * x - x * z + c * y, dz: x * y - b * z };
            },
            center: new THREE.Vector3(0, 0, 30), scale: 0.7
        },
        rossler: {
            sigma: 0.2, rho: 5.7, beta: 0.2,
            deriv: function(x, y, z, a, c, b) {
                return { dx: -(y + z), dy: x + a * y, dz: b + z * (x - c) };
            },
            center: new THREE.Vector3(0, 0, 5), scale: 2.0
        },
        sprott: {
            sigma: 2.07, rho: 1.79, beta: 0.0,
            deriv: function(x, y, z, a, b) {
                return { dx: y + a * x * y + x * z, dy: 1 - b * x * x + y * z, dz: x - x * x - y * y };
            },
            center: new THREE.Vector3(0, 0, 0), scale: 6.0
        }
    };

    /* ===== THREE.JS GLOBALS ===== */
    var scene, camera, renderer, composer, controls, bloomPass;
    var clock = new THREE.Clock();
    var trajMeshes = [], trajData = [], fpSpheres = [], starsObj = null;
    var ctxXY, ctxXZ, ctxYZ;

    /* ===== LYAPUNOV ===== */
    var lyapSum = 0, lyapN = 0, lyapRef = null, lyapD = 1e-8;

    /* ===== COUNTERS ===== */
    var totalSteps = 0, fpsFr = 0, fpsT = 0;
    var fpsEl;

    /* ===== SCENE INIT ===== */
    function initScene() {
        fpsEl = document.getElementById('fps-display');
        var container = document.getElementById('canvas-container');

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ReinhardToneMapping;
        renderer.toneMappingExposure = 1.5;
        container.appendChild(renderer.domElement);

        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x020408);
        scene.fog = new THREE.FogExp2(0x020408, 0.0015);

        camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 2000);
        camera.position.set(45, 35, 60);

        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.08;
        controls.minDistance = 10;
        controls.maxDistance = 300;
        controls.target.set(0, 0, 25);
        controls.update();

        /* Post-processing: bloom */
        var renderPass = new THREE.RenderPass(scene, camera);
        bloomPass = new THREE.UnrealBloomPass(
            new THREE.Vector2(window.innerWidth, window.innerHeight),
            CONFIG.bloomStrength, CONFIG.bloomRadius, CONFIG.bloomThreshold
        );
        composer = new THREE.EffectComposer(renderer);
        composer.addPass(renderPass);
        composer.addPass(bloomPass);

        /* Lighting */
        scene.add(new THREE.AmbientLight(0x111122, 0.5));
        var ptLight = new THREE.PointLight(0x667eea, 0.3, 60);
        ptLight.position.set(0, 0, 0);
        scene.add(ptLight);

        createStars();
        updateFixedPoints();
        createAxes();
        initTrajectories();

        ctxXY = document.getElementById('canvas-xy').getContext('2d');
        ctxXZ = document.getElementById('canvas-xz').getContext('2d');
        ctxYZ = document.getElementById('canvas-yz').getContext('2d');
        clearProjections();

        window.addEventListener('resize', onResize);
    }

    /* ===== STARS ===== */
    function createStars() {
        var geom = new THREE.BufferGeometry();
        var count = 3000;
        var pos = new Float32Array(count * 3);
        for (var i = 0; i < count; i++) {
            var theta = Math.random() * Math.PI * 2;
            var phi = Math.acos(2 * Math.random() - 1);
            var r = 400 + Math.random() * 600;
            pos[i * 3]     = r * Math.sin(phi) * Math.cos(theta);
            pos[i * 3 + 1] = r * Math.sin(phi) * Math.sin(theta);
            pos[i * 3 + 2] = r * Math.cos(phi);
        }
        geom.setAttribute('position', new THREE.BufferAttribute(pos, 3));
        var mat = new THREE.PointsMaterial({
            color: 0xffffff, size: 1, sizeAttenuation: true,
            transparent: true, opacity: 0.7,
            blending: THREE.AdditiveBlending, depthWrite: false
        });
        starsObj = new THREE.Points(geom, mat);
        scene.add(starsObj);
    }

    /* ===== FIXED POINTS (EQUILIBRIA) ===== */
    function updateFixedPoints() {
        fpSpheres.forEach(function(s) { scene.remove(s); });
        fpSpheres = [];
        if (!CONFIG.showFixedPoints) return;

        var sys = SYSTEMS[CONFIG.systemType];
        var sig = CONFIG.sigma, rh = CONFIG.rho, bt = CONFIG.beta;
        var pts = [];

        if (CONFIG.systemType === 'lorenz') {
            pts.push(new THREE.Vector3(0, 0, 0));
            if (rh > 1) {
                var sq = Math.sqrt(bt * (rh - 1));
                pts.push(new THREE.Vector3(sq, sq, rh - 1));
                pts.push(new THREE.Vector3(-sq, -sq, rh - 1));
            }
        } else if (CONFIG.systemType === 'chen') {
            pts.push(new THREE.Vector3(0, 0, 0));
            var disc = 2 * rh - sig;
            if (disc > 0) {
                var sq2 = Math.sqrt(bt * disc);
                pts.push(new THREE.Vector3(sq2, sq2, disc));
                pts.push(new THREE.Vector3(-sq2, -sq2, disc));
            }
        } else if (CONFIG.systemType === 'rossler') {
            var dc = rh * rh - 4 * sig * bt;
            if (dc >= 0) {
                var z1 = (rh - Math.sqrt(dc)) / (2 * sig);
                var z2 = (rh + Math.sqrt(dc)) / (2 * sig);
                pts.push(new THREE.Vector3(-sig * z1, z1, z1));
                pts.push(new THREE.Vector3(-sig * z2, z2, z2));
            }
        } else {
            pts.push(new THREE.Vector3(0, 0, 0));
        }

        var sc = sys.scale || 1;
        var glowCols = [0x667eea, 0xff6b6b, 0x4ecdc4];

        pts.forEach(function(p, idx) {
            var col = glowCols[idx % glowCols.length];
            /* Inner sphere */
            var m1 = new THREE.Mesh(
                new THREE.SphereGeometry(0.5, 16, 16),
                new THREE.MeshBasicMaterial({ color: col, transparent: true, opacity: 0.9 })
            );
            m1.position.copy(p).multiplyScalar(sc);
            scene.add(m1);
            fpSpheres.push(m1);

            /* Outer glow */
            var m2 = new THREE.Mesh(
                new THREE.SphereGeometry(1.2, 16, 16),
                new THREE.MeshBasicMaterial({
                    color: col, transparent: true, opacity: 0.15,
                    blending: THREE.AdditiveBlending, depthWrite: false
                })
            );
            m2.position.copy(p).multiplyScalar(sc);
            scene.add(m2);
            fpSpheres.push(m2);
        });
    }

    /* ===== AXES ===== */
    function createAxes() {
        var mat = new THREE.LineBasicMaterial({ color: 0x333355, transparent: true, opacity: 0.3 });
        var L = 50;
        var pairs = [
            [new THREE.Vector3(-L, 0, 0), new THREE.Vector3(L, 0, 0)],
            [new THREE.Vector3(0, -L, 0), new THREE.Vector3(0, L, 0)],
            [new THREE.Vector3(0, 0, -5), new THREE.Vector3(0, 0, L * 1.5)]
        ];
        pairs.forEach(function(pr) {
            scene.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints(pr), mat));
        });
    }

    /* ===== TRAJECTORIES ===== */
    function initTrajectories() {
        clearTrajectories();
        var bx, by, bz;
        if (CONFIG.systemType === 'rossler') { bx = 1; by = 1; bz = 1; }
        else if (CONFIG.systemType === 'sprott') { bx = 0.1; by = 0.1; bz = 0.1; }
        else { bx = 0.1; by = 0; bz = 0; }

        for (var i = 0; i < CONFIG.numTrajectories; i++) {
            var off = (i - (CONFIG.numTrajectories - 1) / 2) * CONFIG.perturbation;
            trajData.push({
                x: bx + off, y: by + off * 0.7, z: bz + off * 0.3,
                points: [], color: TRAJ_COLORS[i % TRAJ_COLORS.length]
            });
        }

        lyapSum = 0; lyapN = 0;
        lyapRef = { x: trajData[0].x + lyapD, y: trajData[0].y, z: trajData[0].z };
        totalSteps = 0;
    }

    function clearTrajectories() {
        trajMeshes.forEach(function(m) {
            scene.remove(m);
            if (m.geometry) m.geometry.dispose();
            if (m.material) m.material.dispose();
        });
        trajMeshes = [];
        trajData = [];
    }

    /* ===== RK4 INTEGRATION ===== */
    function sysD(x, y, z) {
        return SYSTEMS[CONFIG.systemType].deriv(x, y, z, CONFIG.sigma, CONFIG.rho, CONFIG.beta);
    }

    function rk4(x, y, z, dt) {
        var k1 = sysD(x, y, z);
        var k2 = sysD(x + dt * 0.5 * k1.dx, y + dt * 0.5 * k1.dy, z + dt * 0.5 * k1.dz);
        var k3 = sysD(x + dt * 0.5 * k2.dx, y + dt * 0.5 * k2.dy, z + dt * 0.5 * k2.dz);
        var k4 = sysD(x + dt * k3.dx, y + dt * k3.dy, z + dt * k3.dz);
        return {
            x: x + (dt / 6) * (k1.dx + 2 * k2.dx + 2 * k3.dx + k4.dx),
            y: y + (dt / 6) * (k1.dy + 2 * k2.dy + 2 * k3.dy + k4.dy),
            z: z + (dt / 6) * (k1.dz + 2 * k2.dz + 2 * k3.dz + k4.dz)
        };
    }

    /* ===== LYAPUNOV EXPONENT ===== */
    function updateLyapunov(ms) {
        if (!lyapRef) return;
        var n = rk4(lyapRef.x, lyapRef.y, lyapRef.z, CONFIG.dt);
        lyapRef = n;
        var dx = n.x - ms.x, dy = n.y - ms.y, dz = n.z - ms.z;
        var dist = Math.sqrt(dx * dx + dy * dy + dz * dz);
        if (dist > 1e-15 && dist < 1e10) {
            lyapSum += Math.log(dist / lyapD);
            lyapN++;
            var s = lyapD / dist;
            lyapRef = { x: ms.x + dx * s, y: ms.y + dy * s, z: ms.z + dz * s };
        }
    }

    function getLyapunov() {
        return lyapN < 10 ? 0 : lyapSum / (lyapN * CONFIG.dt);
    }

    /* ===== TUBE MESH BUILDER ===== */
    function buildTubeMesh(points, color, radius) {
        if (points.length < 2) return null;
        var sys = SYSTEMS[CONFIG.systemType];
        var sc = sys.scale || 1;

        var step = points.length > 8000 ? 3 : points.length > 4000 ? 2 : 1;
        var curvePoints = [];
        for (var i = 0; i < points.length; i += step) {
            var p = points[i];
            curvePoints.push(new THREE.Vector3(p.x * sc, p.y * sc, p.z * sc));
        }
        if (curvePoints.length < 2) return null;

        var curve = new THREE.CatmullRomCurve3(curvePoints, false);
        var segments = Math.min(curvePoints.length * 2, 3000);
        var geom = new THREE.TubeGeometry(curve, segments, radius, CONFIG.tubeSegments, false);

        /* Vertex colors by z-height */
        var posAttr = geom.attributes.position;
        var colArr = new Float32Array(posAttr.count * 3);
        var hsl = {};
        color.getHSL(hsl);

        for (var j = 0; j < posAttr.count; j++) {
            var nz = Math.max(0, Math.min(1, (posAttr.getZ(j) / sc) / 55));
            var tc = new THREE.Color();
            tc.setHSL(hsl.h, 0.85 + nz * 0.15, 0.35 + nz * 0.35);
            colArr[j * 3] = tc.r;
            colArr[j * 3 + 1] = tc.g;
            colArr[j * 3 + 2] = tc.b;
        }
        geom.setAttribute('color', new THREE.BufferAttribute(colArr, 3));

        var mat = new THREE.MeshBasicMaterial({
            vertexColors: true, transparent: true, opacity: 0.85,
            blending: THREE.AdditiveBlending, depthWrite: false
        });
        return new THREE.Mesh(geom, mat);
    }

    /* ===== SIMULATION ===== */
    var rebuildCtr = 0;
    var REBUILD_INTERVAL = 3;

    function simulationStep() {
        if (CONFIG.paused) return;

        for (var s = 0; s < CONFIG.stepsPerFrame; s++) {
            for (var t = 0; t < trajData.length; t++) {
                var tr = trajData[t];
                var next = rk4(tr.x, tr.y, tr.z, CONFIG.dt);

                if (!isFinite(next.x) || !isFinite(next.y) || !isFinite(next.z)) {
                    tr.x = 0.1 + t * 0.01; tr.y = 0; tr.z = 0;
                    tr.points = [];
                    continue;
                }

                tr.x = next.x; tr.y = next.y; tr.z = next.z;
                tr.points.push({ x: tr.x, y: tr.y, z: tr.z });
                if (tr.points.length > CONFIG.maxTrailPoints) tr.points.shift();
            }

            if (trajData.length > 0) {
                var main = trajData[0];
                updateLyapunov({ x: main.x, y: main.y, z: main.z });
            }
            totalSteps++;
        }

        rebuildCtr++;
        if (rebuildCtr >= REBUILD_INTERVAL) {
            rebuildCtr = 0;
            rebuildMeshes();
        }
    }

    function rebuildMeshes() {
        trajMeshes.forEach(function(m) {
            scene.remove(m);
            if (m.geometry) m.geometry.dispose();
            if (m.material) m.material.dispose();
        });
        trajMeshes = [];

        for (var t = 0; t < trajData.length; t++) {
            var tr = trajData[t];
            if (tr.points.length < 4) continue;
            var mesh = buildTubeMesh(tr.points, tr.color, CONFIG.tubeRadius);
            if (mesh) {
                scene.add(mesh);
                trajMeshes.push(mesh);
            }
        }
    }

    /* ===== PROJECTIONS ===== */
    function clearProjections() {
        [ctxXY, ctxXZ, ctxYZ].forEach(function(ctx) {
            if (ctx) { ctx.fillStyle = 'rgba(2,4,8,1)'; ctx.fillRect(0, 0, 120, 120); }
        });
    }

    function drawProjections() {
        if (!CONFIG.showProjections) return;
        clearProjections();

        for (var t = 0; t < trajData.length; t++) {
            var tr = trajData[t], pts = tr.points;
            if (pts.length < 2) continue;

            var col = tr.color;
            var cr = Math.round(col.r * 255);
            var cg = Math.round(col.g * 255);
            var cb = Math.round(col.b * 255);
            var ps = CONFIG.systemType === 'rossler' ? 3 : CONFIG.systemType === 'sprott' ? 15 : 2;
            var step = Math.max(1, Math.floor(pts.length / 600));

            for (var i = 0; i < pts.length; i += step) {
                var p = pts[i];
                var alpha = (i / pts.length) * 0.6 + 0.2;
                var cs = 'rgba(' + cr + ',' + cg + ',' + cb + ',' + alpha.toFixed(2) + ')';
                var px, py;

                /* XY */
                px = 60 + p.x * ps; py = 60 - p.y * ps;
                if (px >= 0 && px < 120 && py >= 0 && py < 120) {
                    ctxXY.fillStyle = cs; ctxXY.fillRect(px, py, 1.5, 1.5);
                }

                /* XZ */
                px = 60 + p.x * ps;
                py = (CONFIG.systemType === 'lorenz' || CONFIG.systemType === 'chen')
                    ? 110 - (p.z - 10) * ps * 0.6 : 120 - p.z * ps * 0.7;
                if (px >= 0 && px < 120 && py >= 0 && py < 120) {
                    ctxXZ.fillStyle = cs; ctxXZ.fillRect(px, py, 1.5, 1.5);
                }

                /* YZ */
                px = 60 + p.y * ps;
                py = (CONFIG.systemType === 'lorenz' || CONFIG.systemType === 'chen')
                    ? 110 - (p.z - 10) * ps * 0.6 : 120 - p.z * ps * 0.7;
                if (px >= 0 && px < 120 && py >= 0 && py < 120) {
                    ctxYZ.fillStyle = cs; ctxYZ.fillRect(px, py, 1.5, 1.5);
                }
            }
        }
    }

    /* ===== STATS ===== */
    function updateStats() {
        if (!trajData.length) return;
        var m = trajData[0];
        document.getElementById('s-x').textContent = m.x.toFixed(2);
        document.getElementById('s-y').textContent = m.y.toFixed(2);
        document.getElementById('s-z').textContent = m.z.toFixed(2);

        var d = sysD(m.x, m.y, m.z);
        var vel = Math.sqrt(d.dx * d.dx + d.dy * d.dy + d.dz * d.dz);
        document.getElementById('s-vel').textContent = vel.toFixed(2);
        document.getElementById('s-lyap').textContent = getLyapunov().toFixed(3);
        document.getElementById('s-steps').textContent = totalSteps.toLocaleString();
    }

    /* ===== ANIMATION LOOP ===== */
    function animate() {
        requestAnimationFrame(animate);

        /* FPS counter */
        fpsFr++;
        var now = performance.now();
        if (now - fpsT >= 500) {
            fpsEl.textContent = Math.round(fpsFr / ((now - fpsT) / 1000)) + ' FPS';
            fpsFr = 0; fpsT = now;
        }

        simulationStep();

        if (totalSteps % 12 === 0) updateStats();
        if (totalSteps % 30 === 0) drawProjections();

        /* Pulse fixed point glow spheres */
        if (CONFIG.showFixedPoints) {
            var elapsed = clock.getElapsedTime();
            for (var i = 0; i < fpSpheres.length; i++) {
                if (i % 2 === 1) {
                    fpSpheres[i].scale.setScalar(1 + 0.3 * Math.sin(elapsed * 2 + i));
                }
            }
        }

        /* Slowly rotate stars */
        if (starsObj && CONFIG.showStars) {
            starsObj.rotation.y += 0.00003;
            starsObj.rotation.x += 0.00001;
        }

        controls.autoRotate = CONFIG.autoRotate;
        controls.autoRotateSpeed = 1.5;
        controls.update();

        bloomPass.strength = CONFIG.bloomStrength;
        composer.render();
    }

    /* ===== RESIZE ===== */
    function onResize() {
        var w = window.innerWidth, h = window.innerHeight;
        camera.aspect = w / h;
        camera.updateProjectionMatrix();
        renderer.setSize(w, h);
        composer.setSize(w, h);
        bloomPass.resolution.set(w, h);
    }

    /* ===== SLIDER BINDING HELPER ===== */
    function bindSlider(id, configKey, displayId, formatter, onChange) {
        var el = document.getElementById(id);
        if (!el) return;
        el.addEventListener('input', function() {
            var val = parseFloat(el.value);
            CONFIG[configKey] = val;
            if (displayId) {
                document.getElementById(displayId).textContent = formatter ? formatter(val) : val;
            }
            if (onChange) onChange(val);
        });
    }

    /* ===== CONTROLS INIT ===== */
    function initControls() {
        bindSlider('sl-sigma', 'sigma', 'vd-sigma', function(v) { return v.toFixed(1); }, function() { updateFixedPoints(); });
        bindSlider('sl-rho', 'rho', 'vd-rho', function(v) { return v.toFixed(1); }, function() { updateFixedPoints(); });
        bindSlider('sl-beta', 'beta', 'vd-beta', function(v) { return v.toFixed(2); }, function() { updateFixedPoints(); });
        bindSlider('sl-perturb', 'perturbation', 'vd-perturb', function(v) { return v.toFixed(4); });
        bindSlider('sl-trail', 'maxTrailPoints', 'vd-trail', function(v) { return Math.round(v); });
        bindSlider('sl-speed', 'stepsPerFrame', 'vd-speed', function(v) { return Math.round(v); });
        bindSlider('sl-bloom', 'bloomStrength', 'vd-bloom', function(v) { return v.toFixed(1); });
        bindSlider('sl-tubeRadius', 'tubeRadius', 'vd-tubeRadius', function(v) { return v.toFixed(2); });

        document.getElementById('tog-fixed').addEventListener('change', function() {
            CONFIG.showFixedPoints = this.checked;
            updateFixedPoints();
        });
        document.getElementById('tog-proj').addEventListener('change', function() {
            CONFIG.showProjections = this.checked;
            var cls = this.checked ? '' : ' hidden';
            document.getElementById('proj-xy').className = 'projection-overlay' + cls;
            document.getElementById('proj-xz').className = 'projection-overlay' + cls;
            document.getElementById('proj-yz').className = 'projection-overlay' + cls;
            if (this.checked) drawProjections();
        });
        document.getElementById('tog-stars').addEventListener('change', function() {
            CONFIG.showStars = this.checked;
            if (starsObj) starsObj.visible = this.checked;
        });
        document.getElementById('tog-autorotate').addEventListener('change', function() {
            CONFIG.autoRotate = this.checked;
        });

        /* Keyboard shortcuts */
        window.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT') return;
            switch (e.key.toLowerCase()) {
                case 'h': document.getElementById('control-panel').classList.toggle('hidden'); break;
                case 'p':
                    var tp = document.getElementById('tog-proj');
                    tp.checked = !tp.checked;
                    tp.dispatchEvent(new Event('change'));
                    break;
                case ' ': e.preventDefault(); togglePause(); break;
                case 'r': resetSimulation(); break;
                case '1': applyPreset('lorenz'); break;
                case '2': applyPreset('chen'); break;
                case '3': applyPreset('rossler'); break;
                case '4': applyPreset('sprott'); break;
            }
        });
    }

    /* ===== GLOBAL FUNCTIONS ===== */
    window.togglePause = function() {
        CONFIG.paused = !CONFIG.paused;
    };

    window.resetSimulation = function() {
        clearTrajectories();
        initTrajectories();
        rebuildCtr = 100;
        updateFixedPoints();
        clearProjections();
    };

    window.applyPreset = function(name) {
        var sys = SYSTEMS[name];
        if (!sys) return;

        CONFIG.systemType = name;
        CONFIG.sigma = sys.sigma;
        CONFIG.rho = sys.rho;
        CONFIG.beta = sys.beta;

        document.getElementById('sl-sigma').value = CONFIG.sigma;
        document.getElementById('vd-sigma').textContent = CONFIG.sigma.toFixed(1);
        document.getElementById('sl-rho').value = CONFIG.rho;
        document.getElementById('vd-rho').textContent = CONFIG.rho.toFixed(1);
        document.getElementById('sl-beta').value = CONFIG.beta.toFixed(2);
        document.getElementById('vd-beta').textContent = CONFIG.beta.toFixed(2);

        if (name === 'rossler') {
            document.getElementById('sl-sigma').max = 5;
            document.getElementById('sl-rho').max = 20;
            document.getElementById('sl-beta').max = 2;
        } else if (name === 'sprott') {
            document.getElementById('sl-sigma').max = 10;
            document.getElementById('sl-rho').max = 10;
            document.getElementById('sl-beta').max = 5;
        } else {
            document.getElementById('sl-sigma').max = 30;
            document.getElementById('sl-rho').max = 60;
            document.getElementById('sl-beta').max = 10;
        }

        controls.target.copy(sys.center.clone().multiplyScalar(sys.scale || 1));

        document.querySelectorAll('.preset-btn').forEach(function(b) {
            b.classList.remove('active');
        });
        var btn = document.getElementById('preset-' + name);
        if (btn) btn.classList.add('active');

        resetSimulation();
    };

    /* ===== BOOTSTRAP ===== */
    function init() {
        initScene();
        initControls();
        fpsT = performance.now();
        animate();
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
</script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
