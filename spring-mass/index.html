<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring-Mass Simulation - CCAB</title>
    <link rel="stylesheet" href="../assets/css/navigation.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Spectral:ital,wght@0,400;0,600;1,400&family=Space+Mono:wght@400;700&display=swap');

        :root {
            /* CCAB Color Scheme */
            --bg-primary: #0a0e1a;
            --bg-secondary: #111827;
            --text-primary: #e0e0ff;
            --text-secondary: #a0a0c0;
            --text-accent: #fbbf24;
            --theme-color: #667eea;

            /* Spacing */
            --spacing-xs: 0.5rem;
            --spacing-sm: 1rem;
            --spacing-md: 1.5rem;
            --spacing-lg: 2rem;
            --spacing-xl: 3rem;
            --spacing-2xl: 4rem;

            /* Typography */
            --font-display: 'Orbitron', sans-serif;
            --font-heading: 'Spectral', serif;
            --font-mono: 'Space Mono', monospace;
            --font-body: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;

            /* Layout */
            --max-width: 1600px;
            --header-height: 64px;

            /* Transitions */
            --transition-base: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background: linear-gradient(135deg, var(--bg-primary) 0%, #0f172a 50%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            padding: 20px;
            padding-top: calc(var(--header-height) + 20px);
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        h1 {
            font-family: var(--font-display);
            text-align: center;
            margin-bottom: 10px;
            font-size: clamp(2rem, 5vw, 3rem);
            background: linear-gradient(135deg, var(--theme-color) 0%, var(--text-accent) 50%, var(--theme-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tab {
            padding: 12px 24px;
            background: rgba(224, 224, 255, 0.1);
            border: 2px solid rgba(224, 224, 255, 0.2);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
            color: var(--text-primary);
        }

        .tab:hover {
            background: rgba(224, 224, 255, 0.2);
            transform: translateY(-2px);
        }

        .tab.active {
            background: linear-gradient(135deg, var(--theme-color) 0%, var(--text-accent) 100%);
            border-color: var(--theme-color);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .view {
            display: none;
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .view.active {
            display: block;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            justify-content: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        input[type="range"] {
            width: 150px;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        button {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--theme-color) 0%, var(--text-accent) 100%);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        canvas {
            display: block;
            margin: 20px auto;
            background: #000;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-width: 100%;
            cursor: crosshair;
        }

        .info-box {
            background: rgba(102, 126, 234, 0.1);
            border-left: 4px solid var(--theme-color);
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .info-box h3 {
            margin-bottom: 10px;
            color: var(--theme-color);
        }

        .info-box ul {
            margin-left: 20px;
            line-height: 1.8;
        }

        .stats-panel {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--theme-color);
            font-family: var(--font-mono);
        }

        .stat-label {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }

            .tabs {
                font-size: 0.9em;
            }

            .tab {
                padding: 8px 16px;
            }

            .control-group label {
                font-size: 0.8em;
            }
        }
    
        /* Organic Nature Back Link */
        .organic-back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 10000;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: #BC6C25;
            text-decoration: none;
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 600;
            padding: 0.5rem 1rem;
            background: rgba(254, 250, 224, 0.95);
            border-radius: 20px;
            border: 2px solid rgba(138, 154, 91, 0.3);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(96, 108, 56, 0.15);
        }
        .organic-back-link:hover {
            background: rgba(254, 250, 224, 1);
            transform: translateX(-5px);
            border-color: #DDA15E;
            box-shadow: 0 6px 20px rgba(96, 108, 56, 0.25);
        }

    </style>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>

    <a href="../index.html" class="organic-back-link">← Back to Gallery</a>

    <!-- Navigation Header -->
    <nav class="ccab-nav">
        <div class="nav-container">
            <a href="../index.html" class="nav-home">
                <span class="nav-logo">CCAB</span>
                <span class="nav-tagline">Claude Code and Algorithmic Beauty</span>
            </a>
            <div class="nav-breadcrumb"></div>
        </div>
    </nav>

    <div class="container">
        <h1>Spring-Mass Simulation</h1>
        <p class="subtitle">Interactive Physics: Harmonic Motion, Wave Propagation, and Soft Bodies</p>

        <div class="tabs">
            <div class="tab active" data-view="single">Single Spring</div>
            <div class="tab" data-view="chain">Chain</div>
            <div class="tab" data-view="cloth">Cloth</div>
            <div class="tab" data-view="softbody">Soft Body</div>
        </div>

        <!-- Single Spring View -->
        <div class="view active" id="single">
            <div class="info-box">
                <h3>Simple Harmonic Motion</h3>
                <p>A mass attached to a spring oscillates with simple harmonic motion according to Hooke's Law:</p>
                <p style="text-align: center; margin: 10px 0; font-family: var(--font-mono);">F = -k × (length - restLength) - damping × velocity</p>
                <p>Click and drag the mass to change its position. Adjust spring constant (k), damping, and gravity to see how they affect the motion.</p>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label>Spring Constant (k): <span id="singleKVal">0.5</span></label>
                    <input type="range" id="singleK" min="0.1" max="2" step="0.1" value="0.5">
                </div>
                <div class="control-group">
                    <label>Damping: <span id="singleDampingVal">0.98</span></label>
                    <input type="range" id="singleDamping" min="0.9" max="0.999" step="0.001" value="0.98">
                </div>
                <div class="control-group">
                    <label>Mass: <span id="singleMassVal">5</span></label>
                    <input type="range" id="singleMass" min="1" max="20" value="5">
                </div>
                <div class="control-group">
                    <label>Gravity: <span id="singleGravityVal">0.5</span></label>
                    <input type="range" id="singleGravity" min="0" max="2" step="0.1" value="0.5">
                </div>
                <button onclick="resetSingle()">Reset</button>
            </div>

            <canvas id="singleCanvas" width="800" height="600"></canvas>

            <div class="stats-panel">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="singleExtension">0.0</div>
                        <div class="stat-label">Extension (px)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="singleVelocity">0.0</div>
                        <div class="stat-label">Velocity</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="singleEnergy">0</div>
                        <div class="stat-label">Energy</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chain View -->
        <div class="view" id="chain">
            <div class="info-box">
                <h3>Wave Propagation in Spring Chain</h3>
                <p>Multiple masses connected by springs demonstrate wave behavior. Disturbances propagate through the chain as longitudinal or transverse waves.</p>
                <ul>
                    <li><strong>Drag masses</strong> to create waves</li>
                    <li><strong>Pin/unpin</strong> masses by clicking them</li>
                    <li><strong>Observe</strong> how springs transfer energy through the system</li>
                </ul>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label>Spring Constant (k): <span id="chainKVal">0.3</span></label>
                    <input type="range" id="chainK" min="0.1" max="1" step="0.05" value="0.3">
                </div>
                <div class="control-group">
                    <label>Damping: <span id="chainDampingVal">0.99</span></label>
                    <input type="range" id="chainDamping" min="0.9" max="0.999" step="0.001" value="0.99">
                </div>
                <div class="control-group">
                    <label>Gravity: <span id="chainGravityVal">0.2</span></label>
                    <input type="range" id="chainGravity" min="0" max="1" step="0.1" value="0.2">
                </div>
                <div class="control-group">
                    <label>Masses: <span id="chainCountVal">12</span></label>
                    <input type="range" id="chainCount" min="5" max="20" value="12">
                </div>
                <button onclick="resetChain()">Reset</button>
            </div>

            <canvas id="chainCanvas" width="800" height="600"></canvas>
        </div>

        <!-- Cloth View -->
        <div class="view" id="cloth">
            <div class="info-box">
                <h3>2D Cloth Simulation</h3>
                <p>A grid of masses connected by structural, shear, and bend springs creates realistic cloth behavior.</p>
                <ul>
                    <li><strong>Drag</strong> to interact with the cloth</li>
                    <li><strong>Click nodes</strong> to pin/unpin them</li>
                    <li><strong>Enable wind</strong> for dynamic movement</li>
                    <li>Top row is pinned by default</li>
                </ul>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label>Spring Constant (k): <span id="clothKVal">0.5</span></label>
                    <input type="range" id="clothK" min="0.1" max="1" step="0.05" value="0.5">
                </div>
                <div class="control-group">
                    <label>Damping: <span id="clothDampingVal">0.99</span></label>
                    <input type="range" id="clothDamping" min="0.9" max="0.999" step="0.001" value="0.99">
                </div>
                <div class="control-group">
                    <label>Gravity: <span id="clothGravityVal">0.5</span></label>
                    <input type="range" id="clothGravity" min="0" max="2" step="0.1" value="0.5">
                </div>
                <div class="control-group">
                    <label>Grid Size: <span id="clothSizeVal">15</span></label>
                    <input type="range" id="clothSize" min="10" max="25" value="15">
                </div>
                <div class="control-group">
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="clothWind">
                        Wind
                    </label>
                </div>
                <button onclick="resetCloth()">Reset</button>
            </div>

            <canvas id="clothCanvas" width="800" height="600"></canvas>
        </div>

        <!-- Soft Body View -->
        <div class="view" id="softbody">
            <div class="info-box">
                <h3>Pressure-Based Soft Body</h3>
                <p>A circular arrangement of springs with internal pressure creates a deformable soft body that maintains volume.</p>
                <ul>
                    <li><strong>Drag</strong> to squish and deform the body</li>
                    <li><strong>Pressure</strong> forces the body to maintain its shape</li>
                    <li><strong>Springs</strong> connect neighboring points</li>
                    <li>Watch it bounce and wobble realistically</li>
                </ul>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label>Spring Constant (k): <span id="softKVal">0.4</span></label>
                    <input type="range" id="softK" min="0.1" max="1" step="0.05" value="0.4">
                </div>
                <div class="control-group">
                    <label>Damping: <span id="softDampingVal">0.98</span></label>
                    <input type="range" id="softDamping" min="0.9" max="0.999" step="0.001" value="0.98">
                </div>
                <div class="control-group">
                    <label>Gravity: <span id="softGravityVal">0.5</span></label>
                    <input type="range" id="softGravity" min="0" max="2" step="0.1" value="0.5">
                </div>
                <div class="control-group">
                    <label>Pressure: <span id="softPressureVal">500</span></label>
                    <input type="range" id="softPressure" min="0" max="2000" step="50" value="500">
                </div>
                <div class="control-group">
                    <label>Points: <span id="softPointsVal">20</span></label>
                    <input type="range" id="softPoints" min="10" max="40" value="20">
                </div>
                <button onclick="resetSoftBody()">Reset</button>
            </div>

            <canvas id="softCanvas" width="800" height="600"></canvas>
        </div>
    </div>

    <script>
        // Point class for Verlet integration
        class Point {
            constructor(x, y, pinned = false) {
                this.x = x;
                this.y = y;
                this.oldX = x;
                this.oldY = y;
                this.pinned = pinned;
                this.vx = 0;
                this.vy = 0;
            }

            update(damping = 0.99) {
                if (this.pinned) return;

                const vx = (this.x - this.oldX) * damping;
                const vy = (this.y - this.oldY) * damping;

                this.oldX = this.x;
                this.oldY = this.y;

                this.x += vx;
                this.y += vy;
            }

            applyForce(fx, fy) {
                if (this.pinned) return;
                this.x += fx;
                this.y += fy;
            }

            constrain(minX, maxX, minY, maxY) {
                if (this.pinned) return;
                if (this.x < minX) { this.x = minX; this.oldX = this.x; }
                if (this.x > maxX) { this.x = maxX; this.oldX = this.x; }
                if (this.y < minY) { this.y = minY; this.oldY = this.y; }
                if (this.y > maxY) { this.y = maxY; this.oldY = this.y; }
            }
        }

        // Spring class
        class Spring {
            constructor(p1, p2, k = 0.5, restLength = null) {
                this.p1 = p1;
                this.p2 = p2;
                this.k = k;
                this.restLength = restLength || this.getLength();
            }

            getLength() {
                const dx = this.p2.x - this.p1.x;
                const dy = this.p2.y - this.p1.y;
                return Math.sqrt(dx * dx + dy * dy);
            }

            apply() {
                const dx = this.p2.x - this.p1.x;
                const dy = this.p2.y - this.p1.y;
                const dist = Math.sqrt(dx * dx + dy * dy);

                if (dist === 0) return;

                const force = (dist - this.restLength) * this.k;
                const fx = (dx / dist) * force;
                const fy = (dy / dist) * force;

                this.p1.applyForce(fx, fy);
                this.p2.applyForce(-fx, -fy);
            }
        }

        // Global state
        let currentView = 'single';
        let draggedPoint = null;
        let mouseX = 0;
        let mouseY = 0;

        // Tab system
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.view).classList.add('active');
                currentView = tab.dataset.view;
            });
        });

        // ===== SINGLE SPRING =====
        let singlePoint;
        let singleSpring;
        let singleAnchor;
        let singleCanvas, singleCtx;

        function initSingle() {
            singleCanvas = document.getElementById('singleCanvas');
            singleCtx = singleCanvas.getContext('2d');

            // Control listeners
            document.getElementById('singleK').addEventListener('input', (e) => {
                document.getElementById('singleKVal').textContent = e.target.value;
                if (singleSpring) singleSpring.k = parseFloat(e.target.value);
            });
            document.getElementById('singleDamping').addEventListener('input', (e) => {
                document.getElementById('singleDampingVal').textContent = e.target.value;
            });
            document.getElementById('singleMass').addEventListener('input', (e) => {
                document.getElementById('singleMassVal').textContent = e.target.value;
            });
            document.getElementById('singleGravity').addEventListener('input', (e) => {
                document.getElementById('singleGravityVal').textContent = e.target.value;
            });

            // Mouse events
            singleCanvas.addEventListener('mousedown', handleSingleMouseDown);
            singleCanvas.addEventListener('mousemove', handleSingleMouseMove);
            singleCanvas.addEventListener('mouseup', handleSingleMouseUp);

            resetSingle();
        }

        function resetSingle() {
            singleAnchor = { x: 400, y: 100 };
            singlePoint = new Point(400, 300);
            singleSpring = new Spring(singleAnchor, singlePoint, parseFloat(document.getElementById('singleK').value), 200);
        }

        function handleSingleMouseDown(e) {
            if (currentView !== 'single') return;
            const rect = singleCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const dist = Math.sqrt((x - singlePoint.x) ** 2 + (y - singlePoint.y) ** 2);
            if (dist < 20) {
                draggedPoint = singlePoint;
            }
        }

        function handleSingleMouseMove(e) {
            if (currentView !== 'single') return;
            const rect = singleCanvas.getBoundingClientRect();
            mouseX = e.clientX - rect.left;
            mouseY = e.clientY - rect.top;
            if (draggedPoint) {
                draggedPoint.x = mouseX;
                draggedPoint.y = mouseY;
                draggedPoint.oldX = mouseX;
                draggedPoint.oldY = mouseY;
            }
        }

        function handleSingleMouseUp() {
            draggedPoint = null;
        }

        function updateSingle() {
            const damping = parseFloat(document.getElementById('singleDamping').value);
            const gravity = parseFloat(document.getElementById('singleGravity').value);

            singlePoint.applyForce(0, gravity);
            singleSpring.apply();
            singlePoint.update(damping);
            singlePoint.constrain(10, singleCanvas.width - 10, 10, singleCanvas.height - 10);
        }

        function drawSingle() {
            singleCtx.fillStyle = '#000';
            singleCtx.fillRect(0, 0, singleCanvas.width, singleCanvas.height);

            // Draw spring
            const dx = singlePoint.x - singleAnchor.x;
            const dy = singlePoint.y - singleAnchor.y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            const extension = dist - singleSpring.restLength;

            const springColor = extension > 0 ? '#ff6b6b' : '#4ecdc4';
            singleCtx.strokeStyle = springColor;
            singleCtx.lineWidth = 3;
            singleCtx.setLineDash([5, 5]);
            singleCtx.beginPath();
            singleCtx.moveTo(singleAnchor.x, singleAnchor.y);
            singleCtx.lineTo(singlePoint.x, singlePoint.y);
            singleCtx.stroke();
            singleCtx.setLineDash([]);

            // Draw anchor
            singleCtx.fillStyle = '#fbbf24';
            singleCtx.beginPath();
            singleCtx.arc(singleAnchor.x, singleAnchor.y, 10, 0, Math.PI * 2);
            singleCtx.fill();

            // Draw mass
            const mass = parseFloat(document.getElementById('singleMass').value);
            singleCtx.fillStyle = '#667eea';
            singleCtx.beginPath();
            singleCtx.arc(singlePoint.x, singlePoint.y, mass * 2, 0, Math.PI * 2);
            singleCtx.fill();

            // Update stats
            const velocity = Math.sqrt((singlePoint.x - singlePoint.oldX) ** 2 + (singlePoint.y - singlePoint.oldY) ** 2);
            const energy = 0.5 * mass * velocity * velocity + 0.5 * singleSpring.k * extension * extension;

            document.getElementById('singleExtension').textContent = extension.toFixed(1);
            document.getElementById('singleVelocity').textContent = velocity.toFixed(2);
            document.getElementById('singleEnergy').textContent = energy.toFixed(0);
        }

        // ===== CHAIN =====
        let chainPoints = [];
        let chainSprings = [];
        let chainCanvas, chainCtx;

        function initChain() {
            chainCanvas = document.getElementById('chainCanvas');
            chainCtx = chainCanvas.getContext('2d');

            // Control listeners
            document.getElementById('chainK').addEventListener('input', (e) => {
                document.getElementById('chainKVal').textContent = e.target.value;
                chainSprings.forEach(s => s.k = parseFloat(e.target.value));
            });
            document.getElementById('chainDamping').addEventListener('input', (e) => {
                document.getElementById('chainDampingVal').textContent = e.target.value;
            });
            document.getElementById('chainGravity').addEventListener('input', (e) => {
                document.getElementById('chainGravityVal').textContent = e.target.value;
            });
            document.getElementById('chainCount').addEventListener('input', (e) => {
                document.getElementById('chainCountVal').textContent = e.target.value;
            });

            // Mouse events
            chainCanvas.addEventListener('mousedown', handleChainMouseDown);
            chainCanvas.addEventListener('mousemove', handleChainMouseMove);
            chainCanvas.addEventListener('mouseup', handleChainMouseUp);

            resetChain();
        }

        function resetChain() {
            chainPoints = [];
            chainSprings = [];

            const count = parseInt(document.getElementById('chainCount').value);
            const spacing = 50;
            const startX = (chainCanvas.width - (count - 1) * spacing) / 2;
            const y = 200;

            // Create points
            for (let i = 0; i < count; i++) {
                const pinned = i === 0;
                chainPoints.push(new Point(startX + i * spacing, y, pinned));
            }

            // Create springs
            const k = parseFloat(document.getElementById('chainK').value);
            for (let i = 0; i < count - 1; i++) {
                chainSprings.push(new Spring(chainPoints[i], chainPoints[i + 1], k, spacing));
            }
        }

        function handleChainMouseDown(e) {
            if (currentView !== 'chain') return;
            const rect = chainCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            for (let point of chainPoints) {
                const dist = Math.sqrt((x - point.x) ** 2 + (y - point.y) ** 2);
                if (dist < 15) {
                    if (e.shiftKey) {
                        point.pinned = !point.pinned;
                    } else {
                        draggedPoint = point;
                    }
                    break;
                }
            }
        }

        function handleChainMouseMove(e) {
            if (currentView !== 'chain') return;
            const rect = chainCanvas.getBoundingClientRect();
            mouseX = e.clientX - rect.left;
            mouseY = e.clientY - rect.top;
            if (draggedPoint && !draggedPoint.pinned) {
                draggedPoint.x = mouseX;
                draggedPoint.y = mouseY;
                draggedPoint.oldX = mouseX;
                draggedPoint.oldY = mouseY;
            }
        }

        function handleChainMouseUp() {
            draggedPoint = null;
        }

        function updateChain() {
            const damping = parseFloat(document.getElementById('chainDamping').value);
            const gravity = parseFloat(document.getElementById('chainGravity').value);

            chainPoints.forEach(p => p.applyForce(0, gravity));
            chainSprings.forEach(s => s.apply());
            chainPoints.forEach(p => p.update(damping));
            chainPoints.forEach(p => p.constrain(10, chainCanvas.width - 10, 10, chainCanvas.height - 10));
        }

        function drawChain() {
            chainCtx.fillStyle = '#000';
            chainCtx.fillRect(0, 0, chainCanvas.width, chainCanvas.height);

            // Draw springs
            chainSprings.forEach(spring => {
                const length = spring.getLength();
                const extension = length - spring.restLength;
                const color = extension > 0 ? `rgba(255, 107, 107, ${Math.min(1, Math.abs(extension) / 50)})` :
                                             `rgba(78, 205, 196, ${Math.min(1, Math.abs(extension) / 50)})`;

                chainCtx.strokeStyle = color;
                chainCtx.lineWidth = 3;
                chainCtx.beginPath();
                chainCtx.moveTo(spring.p1.x, spring.p1.y);
                chainCtx.lineTo(spring.p2.x, spring.p2.y);
                chainCtx.stroke();
            });

            // Draw points
            chainPoints.forEach(point => {
                chainCtx.fillStyle = point.pinned ? '#fbbf24' : '#667eea';
                chainCtx.beginPath();
                chainCtx.arc(point.x, point.y, point.pinned ? 10 : 8, 0, Math.PI * 2);
                chainCtx.fill();

                if (point.pinned) {
                    chainCtx.strokeStyle = '#fbbf24';
                    chainCtx.lineWidth = 2;
                    chainCtx.beginPath();
                    chainCtx.arc(point.x, point.y, 12, 0, Math.PI * 2);
                    chainCtx.stroke();
                }
            });
        }

        // ===== CLOTH =====
        let clothPoints = [];
        let clothSprings = [];
        let clothCanvas, clothCtx;

        function initCloth() {
            clothCanvas = document.getElementById('clothCanvas');
            clothCtx = clothCanvas.getContext('2d');

            // Control listeners
            document.getElementById('clothK').addEventListener('input', (e) => {
                document.getElementById('clothKVal').textContent = e.target.value;
                clothSprings.forEach(s => s.k = parseFloat(e.target.value));
            });
            document.getElementById('clothDamping').addEventListener('input', (e) => {
                document.getElementById('clothDampingVal').textContent = e.target.value;
            });
            document.getElementById('clothGravity').addEventListener('input', (e) => {
                document.getElementById('clothGravityVal').textContent = e.target.value;
            });
            document.getElementById('clothSize').addEventListener('input', (e) => {
                document.getElementById('clothSizeVal').textContent = e.target.value;
            });

            // Mouse events
            clothCanvas.addEventListener('mousedown', handleClothMouseDown);
            clothCanvas.addEventListener('mousemove', handleClothMouseMove);
            clothCanvas.addEventListener('mouseup', handleClothMouseUp);

            resetCloth();
        }

        function resetCloth() {
            clothPoints = [];
            clothSprings = [];

            const gridSize = parseInt(document.getElementById('clothSize').value);
            const spacing = 30;
            const startX = (clothCanvas.width - (gridSize - 1) * spacing) / 2;
            const startY = 50;

            // Create grid of points
            for (let y = 0; y < gridSize; y++) {
                clothPoints[y] = [];
                for (let x = 0; x < gridSize; x++) {
                    const pinned = y === 0;
                    clothPoints[y][x] = new Point(startX + x * spacing, startY + y * spacing, pinned);
                }
            }

            const k = parseFloat(document.getElementById('clothK').value);

            // Structural springs (horizontal and vertical)
            for (let y = 0; y < gridSize; y++) {
                for (let x = 0; x < gridSize; x++) {
                    if (x < gridSize - 1) {
                        clothSprings.push(new Spring(clothPoints[y][x], clothPoints[y][x + 1], k, spacing));
                    }
                    if (y < gridSize - 1) {
                        clothSprings.push(new Spring(clothPoints[y][x], clothPoints[y + 1][x], k, spacing));
                    }
                }
            }

            // Shear springs (diagonal)
            for (let y = 0; y < gridSize - 1; y++) {
                for (let x = 0; x < gridSize - 1; x++) {
                    const diagDist = spacing * Math.sqrt(2);
                    clothSprings.push(new Spring(clothPoints[y][x], clothPoints[y + 1][x + 1], k * 0.5, diagDist));
                    clothSprings.push(new Spring(clothPoints[y][x + 1], clothPoints[y + 1][x], k * 0.5, diagDist));
                }
            }

            // Bend springs (skip one)
            for (let y = 0; y < gridSize; y++) {
                for (let x = 0; x < gridSize - 2; x++) {
                    clothSprings.push(new Spring(clothPoints[y][x], clothPoints[y][x + 2], k * 0.3, spacing * 2));
                }
            }
            for (let x = 0; x < gridSize; x++) {
                for (let y = 0; y < gridSize - 2; y++) {
                    clothSprings.push(new Spring(clothPoints[y][x], clothPoints[y + 2][x], k * 0.3, spacing * 2));
                }
            }
        }

        function handleClothMouseDown(e) {
            if (currentView !== 'cloth') return;
            const rect = clothCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            for (let row of clothPoints) {
                for (let point of row) {
                    const dist = Math.sqrt((x - point.x) ** 2 + (y - point.y) ** 2);
                    if (dist < 15) {
                        if (e.shiftKey) {
                            point.pinned = !point.pinned;
                        } else {
                            draggedPoint = point;
                        }
                        return;
                    }
                }
            }
        }

        function handleClothMouseMove(e) {
            if (currentView !== 'cloth') return;
            const rect = clothCanvas.getBoundingClientRect();
            mouseX = e.clientX - rect.left;
            mouseY = e.clientY - rect.top;
            if (draggedPoint && !draggedPoint.pinned) {
                draggedPoint.x = mouseX;
                draggedPoint.y = mouseY;
                draggedPoint.oldX = mouseX;
                draggedPoint.oldY = mouseY;
            }
        }

        function handleClothMouseUp() {
            draggedPoint = null;
        }

        function updateCloth() {
            const damping = parseFloat(document.getElementById('clothDamping').value);
            const gravity = parseFloat(document.getElementById('clothGravity').value);
            const wind = document.getElementById('clothWind').checked;

            clothPoints.forEach(row => {
                row.forEach(p => {
                    p.applyForce(0, gravity);
                    if (wind) {
                        const windForce = Math.sin(Date.now() * 0.001 + p.y * 0.01) * 0.5;
                        p.applyForce(windForce, 0);
                    }
                });
            });

            for (let i = 0; i < 3; i++) {
                clothSprings.forEach(s => s.apply());
            }

            clothPoints.forEach(row => {
                row.forEach(p => {
                    p.update(damping);
                    p.constrain(10, clothCanvas.width - 10, 10, clothCanvas.height - 10);
                });
            });
        }

        function drawCloth() {
            clothCtx.fillStyle = '#000';
            clothCtx.fillRect(0, 0, clothCanvas.width, clothCanvas.height);

            // Draw springs as lines
            clothCtx.strokeStyle = 'rgba(102, 126, 234, 0.3)';
            clothCtx.lineWidth = 1;
            clothSprings.forEach(spring => {
                clothCtx.beginPath();
                clothCtx.moveTo(spring.p1.x, spring.p1.y);
                clothCtx.lineTo(spring.p2.x, spring.p2.y);
                clothCtx.stroke();
            });

            // Draw points
            clothPoints.forEach(row => {
                row.forEach(point => {
                    clothCtx.fillStyle = point.pinned ? '#fbbf24' : '#667eea';
                    clothCtx.beginPath();
                    clothCtx.arc(point.x, point.y, point.pinned ? 6 : 4, 0, Math.PI * 2);
                    clothCtx.fill();
                });
            });
        }

        // ===== SOFT BODY =====
        let softPoints = [];
        let softSprings = [];
        let softCanvas, softCtx;

        function initSoftBody() {
            softCanvas = document.getElementById('softCanvas');
            softCtx = softCanvas.getContext('2d');

            // Control listeners
            document.getElementById('softK').addEventListener('input', (e) => {
                document.getElementById('softKVal').textContent = e.target.value;
                softSprings.forEach(s => s.k = parseFloat(e.target.value));
            });
            document.getElementById('softDamping').addEventListener('input', (e) => {
                document.getElementById('softDampingVal').textContent = e.target.value;
            });
            document.getElementById('softGravity').addEventListener('input', (e) => {
                document.getElementById('softGravityVal').textContent = e.target.value;
            });
            document.getElementById('softPressure').addEventListener('input', (e) => {
                document.getElementById('softPressureVal').textContent = e.target.value;
            });
            document.getElementById('softPoints').addEventListener('input', (e) => {
                document.getElementById('softPointsVal').textContent = e.target.value;
            });

            // Mouse events
            softCanvas.addEventListener('mousedown', handleSoftMouseDown);
            softCanvas.addEventListener('mousemove', handleSoftMouseMove);
            softCanvas.addEventListener('mouseup', handleSoftMouseUp);

            resetSoftBody();
        }

        function resetSoftBody() {
            softPoints = [];
            softSprings = [];

            const pointCount = parseInt(document.getElementById('softPoints').value);
            const radius = 100;
            const centerX = softCanvas.width / 2;
            const centerY = softCanvas.height / 2;

            // Create circular arrangement
            for (let i = 0; i < pointCount; i++) {
                const angle = (i / pointCount) * Math.PI * 2;
                const x = centerX + Math.cos(angle) * radius;
                const y = centerY + Math.sin(angle) * radius;
                softPoints.push(new Point(x, y));
            }

            const k = parseFloat(document.getElementById('softK').value);

            // Create springs between adjacent points
            for (let i = 0; i < pointCount; i++) {
                const next = (i + 1) % pointCount;
                softSprings.push(new Spring(softPoints[i], softPoints[next], k));
            }
        }

        function handleSoftMouseDown(e) {
            if (currentView !== 'softbody') return;
            const rect = softCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            for (let point of softPoints) {
                const dist = Math.sqrt((x - point.x) ** 2 + (y - point.y) ** 2);
                if (dist < 15) {
                    draggedPoint = point;
                    break;
                }
            }
        }

        function handleSoftMouseMove(e) {
            if (currentView !== 'softbody') return;
            const rect = softCanvas.getBoundingClientRect();
            mouseX = e.clientX - rect.left;
            mouseY = e.clientY - rect.top;
            if (draggedPoint) {
                draggedPoint.x = mouseX;
                draggedPoint.y = mouseY;
                draggedPoint.oldX = mouseX;
                draggedPoint.oldY = mouseY;
            }
        }

        function handleSoftMouseUp() {
            draggedPoint = null;
        }

        function updateSoftBody() {
            const damping = parseFloat(document.getElementById('softDamping').value);
            const gravity = parseFloat(document.getElementById('softGravity').value);
            const pressure = parseFloat(document.getElementById('softPressure').value);

            // Apply gravity
            softPoints.forEach(p => p.applyForce(0, gravity));

            // Apply spring forces
            softSprings.forEach(s => s.apply());

            // Apply pressure (push points outward from center)
            if (pressure > 0) {
                const centerX = softPoints.reduce((sum, p) => sum + p.x, 0) / softPoints.length;
                const centerY = softPoints.reduce((sum, p) => sum + p.y, 0) / softPoints.length;

                softPoints.forEach(p => {
                    const dx = p.x - centerX;
                    const dy = p.y - centerY;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist > 0) {
                        const force = pressure * 0.001;
                        p.applyForce((dx / dist) * force, (dy / dist) * force);
                    }
                });
            }

            // Update and constrain
            softPoints.forEach(p => {
                p.update(damping);
                p.constrain(20, softCanvas.width - 20, 20, softCanvas.height - 20);
            });
        }

        function drawSoftBody() {
            softCtx.fillStyle = '#000';
            softCtx.fillRect(0, 0, softCanvas.width, softCanvas.height);

            // Draw filled shape
            softCtx.fillStyle = 'rgba(102, 126, 234, 0.3)';
            softCtx.beginPath();
            softCtx.moveTo(softPoints[0].x, softPoints[0].y);
            for (let i = 1; i < softPoints.length; i++) {
                softCtx.lineTo(softPoints[i].x, softPoints[i].y);
            }
            softCtx.closePath();
            softCtx.fill();

            // Draw springs
            softCtx.strokeStyle = '#667eea';
            softCtx.lineWidth = 2;
            softSprings.forEach(spring => {
                softCtx.beginPath();
                softCtx.moveTo(spring.p1.x, spring.p1.y);
                softCtx.lineTo(spring.p2.x, spring.p2.y);
                softCtx.stroke();
            });

            // Draw points
            softPoints.forEach(point => {
                softCtx.fillStyle = '#fbbf24';
                softCtx.beginPath();
                softCtx.arc(point.x, point.y, 6, 0, Math.PI * 2);
                softCtx.fill();
            });
        }

        // Animation loop
        function animate() {
            if (currentView === 'single') {
                updateSingle();
                drawSingle();
            } else if (currentView === 'chain') {
                updateChain();
                drawChain();
            } else if (currentView === 'cloth') {
                updateCloth();
                drawCloth();
            } else if (currentView === 'softbody') {
                updateSoftBody();
                drawSoftBody();
            }
            requestAnimationFrame(animate);
        }

        // Initialize
        window.addEventListener('load', () => {
            initSingle();
            initChain();
            initCloth();
            initSoftBody();
            animate();
        });
    </script>
    <script src="../assets/js/navigation.js"></script>
</body>
</html>
