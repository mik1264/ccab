<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Visual Synthesizer Keyboard</title>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; font-family: Arial; }
        canvas { display: block; }
        .controls { position: absolute; top: 20px; left: 20px; color: white; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; }
        .keyboard { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; }
        .key { width: 50px; height: 200px; background: white; border: 2px solid #000; cursor: pointer; display: flex; align-items: flex-end; justify-content: center; padding: 10px; font-weight: bold; color: #000; }
        .key.black { width: 35px; height: 120px; background: #000; color: white; margin: 0 -17.5px; z-index: 1; }
        .key:active, .key.active { background: #4CAF50; }
        button { background: #4CAF50; color: white; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; border-radius: 5px; }
        select { padding: 5px; margin: 5px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="controls">
        <h2>Visual Synthesizer Keyboard</h2>
        <div>
            <label>Wave: <select id="waveType">
                <option value="sine">Sine</option>
                <option value="square">Square</option>
                <option value="sawtooth">Sawtooth</option>
                <option value="triangle">Triangle</option>
            </select></label>
        </div>
        <button id="startBtn">Start Audio</button>
    </div>
    <div class="keyboard" id="keyboard"></div>
    <canvas id="canvas"></canvas>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script>
        const canvas = document.getElementById('canvas'); const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;

        let synth, analyser, dataArray;
        const notes = ['C4', 'C#4', 'D4', 'D#4', 'E4', 'F4', 'F#4', 'G4', 'G#4', 'A4', 'A#4', 'B4', 'C5'];
        const keyLabels = ['A', 'W', 'S', 'E', 'D', 'F', 'T', 'G', 'Y', 'H', 'U', 'J', 'K'];

        document.getElementById('startBtn').addEventListener('click', async () => {
            await Tone.start();
            synth = new Tone.PolySynth(Tone.Synth).toDestination();
            analyser = new Tone.Analyser('waveform', 2048);
            synth.connect(analyser);
            dataArray = new Uint8Array(analyser.size);
            document.getElementById('startBtn').textContent = 'Audio Started';
            animate();
        });

        document.getElementById('waveType').addEventListener('change', e => {
            if (synth) synth.set({ oscillator: { type: e.target.value } });
        });

        // Create keyboard
        const keyboard = document.getElementById('keyboard');
        notes.forEach((note, i) => {
            const key = document.createElement('div');
            key.className = note.includes('#') ? 'key black' : 'key';
            key.textContent = keyLabels[i];
            key.dataset.note = note;
            key.addEventListener('mousedown', () => playNote(note, key));
            key.addEventListener('mouseup', () => stopNote(note, key));
            key.addEventListener('mouseleave', () => stopNote(note, key));
            keyboard.appendChild(key);
        });

        const keyMap = {};
        keyLabels.forEach((k, i) => keyMap[k.toLowerCase()] = notes[i]);

        document.addEventListener('keydown', e => {
            const note = keyMap[e.key];
            if (note && synth) {
                const key = document.querySelector(`[data-note="${note}"]`);
                playNote(note, key);
            }
        });

        document.addEventListener('keyup', e => {
            const note = keyMap[e.key];
            if (note) {
                const key = document.querySelector(`[data-note="${note}"]`);
                stopNote(note, key);
            }
        });

        function playNote(note, keyElem) {
            if (synth && !keyElem.classList.contains('active')) {
                synth.triggerAttack(note);
                keyElem.classList.add('active');
            }
        }

        function stopNote(note, keyElem) {
            if (synth) {
                synth.triggerRelease(note);
                keyElem.classList.remove('active');
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            if (!analyser) return;

            const values = analyser.getValue();

            ctx.fillStyle = 'rgba(26,26,26,0.2)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw waveform
            ctx.strokeStyle = '#4CAF50';
            ctx.lineWidth = 3;
            ctx.shadowBlur = 10;
            ctx.shadowColor = '#4CAF50';
            ctx.beginPath();

            const sliceWidth = canvas.width / values.length;
            let x = 0;

            for (let i = 0; i < values.length; i++) {
                const v = (values[i] + 1) / 2; // Normalize -1 to 1 -> 0 to 1
                const y = v * canvas.height * 0.6 + canvas.height * 0.2;

                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);

                x += sliceWidth;
            }

            ctx.stroke();
            ctx.shadowBlur = 0;
        }
    </script>
    <script src="../../assets/js/enhance.js" defer></script>
</body>
</html>
