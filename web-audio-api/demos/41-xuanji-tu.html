<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Xuanji Tu - Music of the Turning Sphere</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Serif SC', 'Songti SC', 'SimSun', serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a2e 50%, #16213e 100%);
            color: #e8e6e1;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            min-height: 100vh;
        }

        header {
            text-align: center;
            margin-bottom: 1rem;
        }

        h1 {
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            background: linear-gradient(135deg, #fbbf24, #f59e0b, #d97706);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.25rem;
        }

        .subtitle {
            color: #9ca3af;
            font-size: 0.9rem;
        }

        .back-link {
            position: fixed;
            top: 10px;
            left: 10px;
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.7);
            color: #fbbf24;
            text-decoration: none;
            border-radius: 6px;
            font-size: 14px;
            z-index: 999;
            transition: all 0.3s ease;
            font-family: sans-serif;
        }

        .back-link:hover {
            background: rgba(251, 191, 36, 0.2);
            transform: translateX(-4px);
        }

        .main-content {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
            max-width: 1400px;
        }

        /* Grid Container */
        .grid-container {
            position: relative;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid rgba(251, 191, 36, 0.2);
        }

        #xuanji-grid {
            display: grid;
            grid-template-columns: repeat(29, 1fr);
            gap: 1px;
            font-size: clamp(8px, 1.2vw, 14px);
            line-height: 1;
        }

        .cell {
            width: clamp(12px, 1.8vw, 22px);
            height: clamp(12px, 1.8vw, 22px);
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(30, 30, 50, 0.6);
            border-radius: 2px;
            transition: all 0.15s ease;
            cursor: pointer;
            position: relative;
        }

        .cell:hover {
            background: rgba(251, 191, 36, 0.3);
            transform: scale(1.1);
            z-index: 10;
        }

        .cell.active {
            background: rgba(251, 191, 36, 0.8);
            color: #0a0a1a;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.6);
            transform: scale(1.15);
            z-index: 20;
        }

        .cell.trail {
            background: rgba(251, 191, 36, 0.3);
        }

        .cell.center {
            background: rgba(220, 38, 38, 0.4);
            color: #fbbf24;
        }

        .cell.border-cell {
            background: rgba(59, 130, 246, 0.2);
        }

        /* Region colors based on traditional five-color version */
        .cell.region-red { background: rgba(220, 38, 38, 0.25); }
        .cell.region-yellow { background: rgba(234, 179, 8, 0.25); }
        .cell.region-blue { background: rgba(59, 130, 246, 0.25); }
        .cell.region-black { background: rgba(30, 30, 30, 0.4); }
        .cell.region-white { background: rgba(200, 200, 200, 0.15); }

        /* Rotating arm overlay */
        #arm-canvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        /* Controls Panel */
        .controls {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 12px;
            padding: 1.25rem;
            border: 1px solid rgba(251, 191, 36, 0.2);
            min-width: 280px;
            max-width: 320px;
            font-family: 'Nunito', sans-serif;
        }

        .control-section {
            margin-bottom: 1.25rem;
        }

        .control-section:last-child {
            margin-bottom: 0;
        }

        .control-label {
            display: block;
            font-size: 0.75rem;
            color: #9ca3af;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        button {
            background: linear-gradient(135deg, #374151, #1f2937);
            color: #e8e6e1;
            border: 1px solid rgba(251, 191, 36, 0.3);
            padding: 0.6rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        button:hover {
            background: linear-gradient(135deg, #4b5563, #374151);
            border-color: rgba(251, 191, 36, 0.6);
        }

        button.active {
            background: linear-gradient(135deg, #fbbf24, #d97706);
            color: #0a0a1a;
            border-color: #fbbf24;
        }

        button.play-btn {
            flex: 1;
            padding: 0.75rem;
            font-size: 1rem;
        }

        button.play-btn.playing {
            background: linear-gradient(135deg, #10b981, #059669);
            border-color: #10b981;
        }

        select, input[type="range"] {
            width: 100%;
            background: #1f2937;
            color: #e8e6e1;
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 6px;
            padding: 0.5rem;
            font-size: 0.85rem;
        }

        input[type="range"] {
            -webkit-appearance: none;
            height: 6px;
            padding: 0;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #fbbf24;
            border-radius: 50%;
            cursor: pointer;
        }

        .slider-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .slider-value {
            min-width: 40px;
            text-align: right;
            font-size: 0.85rem;
            color: #fbbf24;
        }

        /* Info Panel */
        .info-panel {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.8rem;
            line-height: 1.6;
        }

        .current-char {
            font-size: 2.5rem;
            text-align: center;
            color: #fbbf24;
            margin: 0.5rem 0;
        }

        .coord-display {
            text-align: center;
            color: #9ca3af;
            font-family: monospace;
        }

        /* Reading display */
        .reading-display {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            padding: 0.75rem;
            margin-top: 0.75rem;
            max-height: 80px;
            overflow-y: auto;
            font-size: 1rem;
            line-height: 1.8;
            color: #fbbf24;
            text-align: center;
            word-break: break-all;
        }

        /* Scale visualization */
        .scale-display {
            display: flex;
            gap: 4px;
            margin-top: 0.5rem;
            justify-content: center;
        }

        .scale-note {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(59, 130, 246, 0.3);
            border-radius: 4px;
            font-size: 0.7rem;
            font-family: monospace;
        }

        .scale-note.root {
            background: rgba(251, 191, 36, 0.5);
        }

        /* Legend */
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            font-size: 0.7rem;
            margin-top: 0.75rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        @media (max-width: 900px) {
            .main-content {
                flex-direction: column;
                align-items: center;
            }

            .controls {
                width: 100%;
                max-width: 500px;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&family=Nunito:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
    <a href="../index.html" class="back-link">← Back to Gallery</a>

    <div class="container">
        <header>
            <h1>璇璣圖 Xuanji Tu</h1>
            <p class="subtitle">Music of the Turning Sphere - Su Hui's Palindrome Poem Sonification</p>
        </header>

        <div class="main-content">
            <div class="grid-container">
                <div id="xuanji-grid"></div>
                <canvas id="arm-canvas"></canvas>
            </div>

            <div class="controls">
                <div class="control-section">
                    <span class="control-label">Transport</span>
                    <div class="btn-group">
                        <button id="startBtn" class="play-btn">Start Audio</button>
                        <button id="playBtn" class="play-btn">Play</button>
                        <button id="stopBtn" class="play-btn">Stop</button>
                    </div>
                </div>

                <div class="control-section">
                    <span class="control-label">Traversal Mode</span>
                    <div class="btn-group">
                        <button class="mode-btn active" data-mode="cartesian">Cartesian</button>
                        <button class="mode-btn" data-mode="rotating">Rotating</button>
                        <button class="mode-btn" data-mode="spiral">Spiral</button>
                        <button class="mode-btn" data-mode="circle">Circle</button>
                    </div>
                </div>

                <div class="control-section">
                    <span class="control-label">Tempo (BPM)</span>
                    <div class="slider-row">
                        <input type="range" id="tempo" min="30" max="240" value="90">
                        <span class="slider-value" id="tempoValue">90</span>
                    </div>
                </div>

                <div class="control-section">
                    <span class="control-label">Musical Scale</span>
                    <select id="scale">
                        <option value="pentatonic">Pentatonic (五聲)</option>
                        <option value="major">Major</option>
                        <option value="minor">Minor</option>
                        <option value="dorian">Dorian</option>
                        <option value="phrygian">Phrygian</option>
                        <option value="lydian">Lydian</option>
                        <option value="mixolydian">Mixolydian</option>
                        <option value="chromatic">Chromatic</option>
                    </select>
                    <div class="scale-display" id="scaleDisplay"></div>
                </div>

                <div class="control-section">
                    <span class="control-label">Root Note</span>
                    <select id="rootNote">
                        <option value="C">C</option>
                        <option value="D">D</option>
                        <option value="E">E</option>
                        <option value="F">F</option>
                        <option value="G" selected>G (宮)</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                    </select>
                </div>

                <div class="control-section">
                    <span class="control-label">Gate Density</span>
                    <div class="slider-row">
                        <input type="range" id="density" min="10" max="100" value="70">
                        <span class="slider-value" id="densityValue">70%</span>
                    </div>
                </div>

                <div class="control-section">
                    <span class="control-label">Center Drone (心)</span>
                    <div class="btn-group">
                        <button id="droneBtn">Drone Off</button>
                    </div>
                </div>

                <div class="info-panel">
                    <div class="current-char" id="currentChar">心</div>
                    <div class="coord-display" id="coordDisplay">Position: (14, 14) - Center</div>
                    <div class="reading-display" id="readingDisplay"></div>
                </div>

                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(251, 191, 36, 0.8);"></div>
                        <span>Active</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(220, 38, 38, 0.4);"></div>
                        <span>Center</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(59, 130, 246, 0.2);"></div>
                        <span>Border</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script>
        // ============================================
        // XUANJI TU GRID DATA (29x29 = 841 characters)
        // ============================================
        // This is Su Hui's famous palindromic poem grid
        // Traditional version - can be read in thousands of ways

        const GRID_SIZE = 29;
        const CENTER = 14; // 0-indexed center position

        // The full 29x29 Xuanji Tu grid
        // Each row is 29 characters
        const xuanjiText = [
            "仁智懷德聖虞唐豈貞久良士所怨感傷悲哀摧肝心肺思我念君",
            "智理積基照愛存休光終顯惟凱雲隆集感征思北往聖軫念親君",
            "懷想追荒意違君在時崇盛真淑麗容飾風華榮曜流星難相憐藩",
            "德美昭察微道勢形嗟歎傷憐哀顯君榮飾高耀雍離螢流永悲屏",
            "聖凡壹勤周志精通聯章翠髓高峻美茂當盛熙榮我有華光城翰",
            "虞皇思所往昔昭忠貞烈峭峻嵯岩臨深淵顯令言新詩知蘭英苑",
            "唐堯懷遠陽華愛凋翠鍾隱遐敖峨殊昭盛隆感貞心明堅獨閑膺",
            "豈歎永情觀欲豫遊嵩章藻懿感常承當傳重榮親忠能復始浮林",
            "貞盛所遂興終欣衛盛寧終始承感容身當保曜明懷貞志情初真",
            "久感惟傷離別人還涉盛長始終思家欣歡悲戚寧榮懷抱何時松",
            "良感長始傷戚情嵐隱高遙遠思歡想感傷離令文章桂華英盛竹",
            "士凱懷真時辭在傷詠歎桑思志悲詠傷歸憂新思咸終始何所柏",
            "所雲貞淑元傳頹逝始辭怨西音悲離和情遠士文著美我傷懷梧",
            "怨隆麗麗忠時榮盛日月光在閨房深傷恩愛之長貞知深思哀寒",
            "感集容華顯文光明景曜心傷恩惟深殷情懷離桂容詩恨苦思華",
            "傷征飾榮顯當珍潛嬋殊過奇靈逸英懿妍悲紛芬女神願欲凄庭",
            "悲思風螢君承德美麗人妍過鏡仙姿如蒙思詠永頌難求苦傷霜",
            "哀北華流榮保淑雍曜螢姿靈翠華方作媛淑思隱歷終纏綿織露",
            "摧往榮離我明穆耀熙榮華蘭英秀發芬皎漫辭始妙作長終精鹿",
            "肝聖曜永有懷清盛流容珍英秋春曜漫芳條風嗟歎思寢歡戚霧",
            "心軫流悲華貞賢光映儀瓊光休照姿麗絕女殊咨歎思傷歡懷苔",
            "肺念星屏光志精如日月星辰恆辭懷歸思歸君心靡常可思親草",
            "思我難城翰情通運明光輝照情志復念感往來孤戀有時當雙菜",
            "我念相翰苑初達節英華清穎輕惠淑貞嬋娟懷傷恩哀意思獨茵",
            "念君憐藩膺真盛詩精鍾顯榮峻峭幽岩路阻歎何傷歲月感時萱",
            "君親藩屏林松竹柏梧寒華庭霜露鹿霧苔草菜茵萱歲興衰何昭",
            "親人在遐塵河津靈飛神天明要道終焉歲何怨歎傷興歲飛何離",
            "無邪在氣津涯風雲凌華道理神元始終皇何久長歲道辛久情明",
            "終始怨傷哀思慕感悲歎心所懷知情深久志寧何山河無怨思君",
        ];

        // Parse grid into 2D array
        const grid = xuanjiText.map(row => [...row]);

        // Musical scales (intervals from root)
        const SCALES = {
            pentatonic: [0, 2, 4, 7, 9],  // Traditional Chinese pentatonic
            major: [0, 2, 4, 5, 7, 9, 11],
            minor: [0, 2, 3, 5, 7, 8, 10],
            dorian: [0, 2, 3, 5, 7, 9, 10],
            phrygian: [0, 1, 3, 5, 7, 8, 10],
            lydian: [0, 2, 4, 6, 7, 9, 11],
            mixolydian: [0, 2, 4, 5, 7, 9, 10],
            chromatic: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11]
        };

        const NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

        // State
        let audioStarted = false;
        let isPlaying = false;
        let currentMode = 'cartesian';
        let currentX = 0;
        let currentY = 0;
        let angle = 0;
        let spiralIndex = 0;
        let circleIndex = 0;
        let trail = [];
        let reading = [];
        let droneOn = false;

        // Audio components
        let synth, droneSynth, sequence;

        // Pre-calculate spiral path
        const spiralPath = generateSpiralPath();
        const circlePath = generateCirclePath();

        function generateSpiralPath() {
            const path = [];
            let x = CENTER, y = CENTER;
            let dx = 1, dy = 0;
            let steps = 1, stepCount = 0, turnCount = 0;

            path.push({x, y});

            while (path.length < GRID_SIZE * GRID_SIZE) {
                x += dx;
                y += dy;

                if (x >= 0 && x < GRID_SIZE && y >= 0 && y < GRID_SIZE) {
                    path.push({x, y});
                }

                stepCount++;
                if (stepCount === steps) {
                    stepCount = 0;
                    turnCount++;
                    // Turn right: (dx,dy) -> (dy,-dx)
                    [dx, dy] = [-dy, dx];
                    if (turnCount % 2 === 0) steps++;
                }
            }
            return path;
        }

        function generateCirclePath() {
            const path = [];
            // Top edge (left to right)
            for (let x = 0; x < GRID_SIZE; x++) path.push({x, y: 0});
            // Right edge (top to bottom)
            for (let y = 1; y < GRID_SIZE; y++) path.push({x: GRID_SIZE-1, y});
            // Bottom edge (right to left)
            for (let x = GRID_SIZE-2; x >= 0; x--) path.push({x, y: GRID_SIZE-1});
            // Left edge (bottom to top)
            for (let y = GRID_SIZE-2; y > 0; y--) path.push({x: 0, y});
            return path;
        }

        // Build the grid UI
        const gridEl = document.getElementById('xuanji-grid');
        const cells = [];

        for (let y = 0; y < GRID_SIZE; y++) {
            cells[y] = [];
            for (let x = 0; x < GRID_SIZE; x++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.textContent = grid[y][x];
                cell.dataset.x = x;
                cell.dataset.y = y;

                // Mark special cells
                if (x === CENTER && y === CENTER) {
                    cell.classList.add('center');
                }
                if (x === 0 || x === GRID_SIZE-1 || y === 0 || y === GRID_SIZE-1) {
                    cell.classList.add('border-cell');
                }

                // Assign region colors based on distance from center
                const dist = Math.max(Math.abs(x - CENTER), Math.abs(y - CENTER));
                if (dist <= 3) cell.classList.add('region-red');
                else if (dist <= 7) cell.classList.add('region-yellow');
                else if (dist <= 11) cell.classList.add('region-blue');
                else cell.classList.add('region-white');

                cell.addEventListener('click', () => {
                    if (audioStarted) playNoteAt(x, y);
                });

                gridEl.appendChild(cell);
                cells[y][x] = cell;
            }
        }

        // Setup arm canvas for rotating mode
        const armCanvas = document.getElementById('arm-canvas');
        const armCtx = armCanvas.getContext('2d');

        function resizeArmCanvas() {
            const rect = gridEl.getBoundingClientRect();
            armCanvas.width = rect.width;
            armCanvas.height = rect.height;
            armCanvas.style.width = rect.width + 'px';
            armCanvas.style.height = rect.height + 'px';
        }

        // Initialize audio
        document.getElementById('startBtn').addEventListener('click', async () => {
            if (audioStarted) return;

            await Tone.start();

            // Main melodic synth
            synth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: 'triangle' },
                envelope: {
                    attack: 0.02,
                    decay: 0.3,
                    sustain: 0.2,
                    release: 0.8
                }
            }).toDestination();
            synth.volume.value = -6;

            // Drone synth for center
            droneSynth = new Tone.Synth({
                oscillator: { type: 'sine' },
                envelope: {
                    attack: 2,
                    decay: 0,
                    sustain: 1,
                    release: 2
                }
            }).toDestination();
            droneSynth.volume.value = -18;

            audioStarted = true;
            document.getElementById('startBtn').textContent = 'Audio Ready';
            document.getElementById('startBtn').classList.add('active');

            resizeArmCanvas();
            updateScaleDisplay();
        });

        // Play/Stop controls
        document.getElementById('playBtn').addEventListener('click', () => {
            if (!audioStarted || isPlaying) return;
            startSequence();
        });

        document.getElementById('stopBtn').addEventListener('click', () => {
            if (!isPlaying) return;
            stopSequence();
        });

        // Mode selection
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentMode = btn.dataset.mode;
                resetTraversal();
            });
        });

        // Tempo control
        document.getElementById('tempo').addEventListener('input', (e) => {
            const bpm = e.target.value;
            document.getElementById('tempoValue').textContent = bpm;
            Tone.Transport.bpm.value = bpm;
        });

        // Scale and root note
        document.getElementById('scale').addEventListener('change', updateScaleDisplay);
        document.getElementById('rootNote').addEventListener('change', updateScaleDisplay);

        // Density control
        document.getElementById('density').addEventListener('input', (e) => {
            document.getElementById('densityValue').textContent = e.target.value + '%';
        });

        // Drone toggle
        document.getElementById('droneBtn').addEventListener('click', () => {
            if (!audioStarted) return;

            droneOn = !droneOn;
            const btn = document.getElementById('droneBtn');

            if (droneOn) {
                const rootNote = document.getElementById('rootNote').value;
                droneSynth.triggerAttack(rootNote + '2');
                btn.textContent = 'Drone On';
                btn.classList.add('active');
            } else {
                droneSynth.triggerRelease();
                btn.textContent = 'Drone Off';
                btn.classList.remove('active');
            }
        });

        function updateScaleDisplay() {
            const scaleName = document.getElementById('scale').value;
            const rootNote = document.getElementById('rootNote').value;
            const rootIndex = NOTE_NAMES.indexOf(rootNote);
            const scale = SCALES[scaleName];

            const display = document.getElementById('scaleDisplay');
            display.innerHTML = '';

            scale.forEach((interval, i) => {
                const noteIndex = (rootIndex + interval) % 12;
                const div = document.createElement('div');
                div.className = 'scale-note' + (i === 0 ? ' root' : '');
                div.textContent = NOTE_NAMES[noteIndex];
                display.appendChild(div);
            });
        }

        function getNote(x, y) {
            const scaleName = document.getElementById('scale').value;
            const rootNote = document.getElementById('rootNote').value;
            const scale = SCALES[scaleName];
            const rootIndex = NOTE_NAMES.indexOf(rootNote);

            // Map x to scale degree
            const scaleDegree = x % scale.length;
            const interval = scale[scaleDegree];
            const noteIndex = (rootIndex + interval) % 12;

            // Map y to octave (invert so top is higher)
            const octave = 3 + Math.floor((GRID_SIZE - 1 - y) / (GRID_SIZE / 4));

            return NOTE_NAMES[noteIndex] + Math.min(Math.max(octave, 2), 6);
        }

        function playNoteAt(x, y) {
            const density = parseInt(document.getElementById('density').value);
            if (Math.random() * 100 > density) return;

            const note = getNote(x, y);
            synth.triggerAttackRelease(note, '8n');

            // Update display
            document.getElementById('currentChar').textContent = grid[y][x];
            document.getElementById('coordDisplay').textContent = `Position: (${x}, ${y})`;

            // Update reading
            reading.push(grid[y][x]);
            if (reading.length > 30) reading.shift();
            document.getElementById('readingDisplay').textContent = reading.join('');

            // Visual feedback
            updateCellHighlight(x, y);
        }

        function updateCellHighlight(x, y) {
            // Clear previous active
            document.querySelectorAll('.cell.active').forEach(c => c.classList.remove('active'));

            // Clear old trail
            trail = trail.filter(t => t.age < 10);
            document.querySelectorAll('.cell.trail').forEach(c => c.classList.remove('trail'));

            // Add to trail
            trail.push({x, y, age: 0});
            trail.forEach(t => {
                t.age++;
                if (cells[t.y] && cells[t.y][t.x]) {
                    cells[t.y][t.x].classList.add('trail');
                }
            });

            // Set active
            if (cells[y] && cells[y][x]) {
                cells[y][x].classList.add('active');
            }
        }

        function resetTraversal() {
            currentX = 0;
            currentY = 0;
            angle = 0;
            spiralIndex = 0;
            circleIndex = 0;
            trail = [];
            reading = [];
            document.getElementById('readingDisplay').textContent = '';
        }

        function getNextPosition() {
            switch (currentMode) {
                case 'cartesian':
                    // X advances every tick, Y advances when X wraps
                    currentX++;
                    if (currentX >= GRID_SIZE) {
                        currentX = 0;
                        currentY = (currentY + 1) % GRID_SIZE;
                    }
                    return {x: currentX, y: currentY};

                case 'rotating':
                    // Rotating arm from center
                    angle += 0.15;
                    const radius = Math.min(CENTER, (angle / (2 * Math.PI)) % CENTER + 1);
                    const x = Math.round(CENTER + Math.cos(angle) * radius);
                    const y = Math.round(CENTER + Math.sin(angle) * radius);
                    return {
                        x: Math.max(0, Math.min(GRID_SIZE-1, x)),
                        y: Math.max(0, Math.min(GRID_SIZE-1, y))
                    };

                case 'spiral':
                    spiralIndex = (spiralIndex + 1) % spiralPath.length;
                    return spiralPath[spiralIndex];

                case 'circle':
                    circleIndex = (circleIndex + 1) % circlePath.length;
                    return circlePath[circleIndex];

                default:
                    return {x: currentX, y: currentY};
            }
        }

        function drawRotatingArm() {
            if (currentMode !== 'rotating' || !isPlaying) {
                armCtx.clearRect(0, 0, armCanvas.width, armCanvas.height);
                return;
            }

            armCtx.clearRect(0, 0, armCanvas.width, armCanvas.height);

            const cellSize = armCanvas.width / GRID_SIZE;
            const centerX = CENTER * cellSize + cellSize / 2;
            const centerY = CENTER * cellSize + cellSize / 2;
            const radius = CENTER * cellSize;

            armCtx.strokeStyle = 'rgba(251, 191, 36, 0.6)';
            armCtx.lineWidth = 2;
            armCtx.beginPath();
            armCtx.moveTo(centerX, centerY);
            armCtx.lineTo(
                centerX + Math.cos(angle) * radius,
                centerY + Math.sin(angle) * radius
            );
            armCtx.stroke();

            // Draw center point
            armCtx.fillStyle = 'rgba(220, 38, 38, 0.8)';
            armCtx.beginPath();
            armCtx.arc(centerX, centerY, 4, 0, Math.PI * 2);
            armCtx.fill();
        }

        function startSequence() {
            isPlaying = true;
            document.getElementById('playBtn').classList.add('playing');
            document.getElementById('playBtn').textContent = 'Playing';

            const bpm = parseInt(document.getElementById('tempo').value);
            Tone.Transport.bpm.value = bpm;

            // Create sequence
            sequence = new Tone.Loop((time) => {
                const pos = getNextPosition();

                Tone.Draw.schedule(() => {
                    playNoteAt(pos.x, pos.y);
                    drawRotatingArm();
                }, time);

            }, '8n');

            sequence.start(0);
            Tone.Transport.start();
        }

        function stopSequence() {
            isPlaying = false;
            document.getElementById('playBtn').classList.remove('playing');
            document.getElementById('playBtn').textContent = 'Play';

            if (sequence) {
                sequence.stop();
                sequence.dispose();
            }
            Tone.Transport.stop();

            armCtx.clearRect(0, 0, armCanvas.width, armCanvas.height);
        }

        // Handle resize
        window.addEventListener('resize', () => {
            if (audioStarted) {
                setTimeout(resizeArmCanvas, 100);
            }
        });

        // Initial setup
        updateScaleDisplay();
    </script>
</body>
</html>
