<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>璇璣圖 Xuanji Tu - Music of the Turning Sphere</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Serif SC', 'Songti SC', 'SimSun', serif;
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #0f0f1a 100%);
            color: #e8e6e1;
            min-height: 100vh;
            overflow: hidden;
        }

        .back-link {
            position: fixed;
            top: 15px;
            left: 15px;
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.6);
            color: #d4af37;
            text-decoration: none;
            border-radius: 6px;
            font-size: 14px;
            z-index: 1000;
            transition: all 0.3s ease;
            font-family: sans-serif;
        }

        .back-link:hover {
            background: rgba(212, 175, 55, 0.2);
            transform: translateX(-4px);
        }

        #canvas {
            display: block;
            position: fixed;
            top: 0;
            left: 0;
        }

        .controls {
            position: fixed;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            z-index: 1000;
            min-width: 220px;
            font-family: 'Nunito', sans-serif;
        }

        .controls h2 {
            font-family: 'Noto Serif SC', serif;
            color: #d4af37;
            font-size: 1.2rem;
            margin-bottom: 15px;
            text-align: center;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            font-size: 0.85rem;
            color: #aaa;
            margin-bottom: 5px;
        }

        select, input[type="range"] {
            width: 100%;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 6px;
            color: #e8e6e1;
            font-size: 0.9rem;
        }

        select option {
            background: #1a1a2e;
        }

        button {
            width: 100%;
            padding: 12px;
            margin-top: 5px;
            background: linear-gradient(135deg, #8b4513 0%, #d4af37 100%);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        button:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 20px rgba(212, 175, 55, 0.4);
        }

        button.active {
            background: linear-gradient(135deg, #2e8b57 0%, #4caf50 100%);
        }

        .info {
            position: fixed;
            bottom: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.6);
            padding: 12px 18px;
            border-radius: 8px;
            font-size: 0.8rem;
            color: #888;
            max-width: 300px;
            z-index: 1000;
        }

        .info .title {
            color: #d4af37;
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .current-char {
            position: fixed;
            bottom: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.75);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            z-index: 1000;
            text-align: center;
        }

        .current-char .char {
            font-size: 4rem;
            color: #d4af37;
            line-height: 1;
        }

        .current-char .position {
            font-size: 0.8rem;
            color: #888;
            margin-top: 8px;
        }

        .range-value {
            text-align: right;
            font-size: 0.8rem;
            color: #d4af37;
            margin-top: 3px;
        }

        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 2000;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(212, 175, 55, 0.2);
            border-top-color: #d4af37;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .legend {
            position: fixed;
            bottom: 100px;
            right: 15px;
            background: rgba(0, 0, 0, 0.6);
            padding: 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            z-index: 1000;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Nunito:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
    <a href="../index.html" class="back-link">← Back to Gallery</a>

    <canvas id="canvas"></canvas>

    <div id="loading">
        <div class="spinner"></div>
        <p>Loading Xuanji Tu...</p>
    </div>

    <div class="controls">
        <h2>璇璣圖 Controls</h2>

        <div class="control-group">
            <label>Traversal Mode</label>
            <select id="mode">
                <option value="radar">Radar Sweep (Rotating Arm)</option>
                <option value="cartesian">Cartesian (X/Y Clocks)</option>
                <option value="spiral">Spiral (Inward)</option>
                <option value="circle">Circle (Border Ring)</option>
            </select>
        </div>

        <div class="control-group">
            <label>Scale</label>
            <select id="scale">
                <option value="pentatonic">Chinese Pentatonic (宮商角徵羽)</option>
                <option value="chromatic">Chromatic</option>
                <option value="major">Major</option>
                <option value="minor">Minor Harmonic</option>
            </select>
        </div>

        <div class="control-group">
            <label>Tempo (BPM)</label>
            <input type="range" id="tempo" min="30" max="200" value="80">
            <div class="range-value"><span id="tempoValue">80</span> BPM</div>
        </div>

        <div class="control-group">
            <label>Gate Density</label>
            <input type="range" id="density" min="10" max="100" value="60">
            <div class="range-value"><span id="densityValue">60</span>%</div>
        </div>

        <button id="startBtn">Start Audio</button>
        <button id="playBtn">Play</button>
        <button id="stopBtn">Stop</button>
    </div>

    <div class="info">
        <div class="title">璇璣圖 - Picture of the Turning Sphere</div>
        <p>Su Hui's 29×29 palindrome poem (4th century). Can be read in thousands of directions. Click grid cells to toggle gates.</p>
    </div>

    <div class="current-char">
        <div class="char" id="currentChar">心</div>
        <div class="position" id="currentPos">(14, 14)</div>
    </div>

    <div class="legend">
        <div class="legend-item"><div class="legend-color" style="background: #c41e3a;"></div> Red Region</div>
        <div class="legend-item"><div class="legend-color" style="background: #4169e1;"></div> Blue Region</div>
        <div class="legend-item"><div class="legend-color" style="background: #ffd700;"></div> Yellow Region</div>
        <div class="legend-item"><div class="legend-color" style="background: #228b22;"></div> Green Region</div>
        <div class="legend-item"><div class="legend-color" style="background: #9932cc;"></div> Purple Region</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script>
        // ========================================
        // XUANJI TU DATA - 29x29 Character Grid
        // ========================================
        // This is a simplified representation based on the traditional poem
        // Characters are arranged to allow multi-directional reading
        const XUANJI_CHARACTERS = [
            "仁智懷德聖虞唐真君黃戀傷情岑哀歎長城秦苦艱難山河殊離别妻思",
            "智心一連理思感憂欽精恩愛流深悲離怨傷感懷所歎蒙殊悴盛妻始賢",
            "懷一寒感紛歡春離平難故蒙堂恩窮嗟讒隔閑經殊曜難望思妻悲終明",
            "德理感歎榮華心平明芳城戀傷岑窮怨感明窮傷難思望始情賢始終仁",
            "聖思紛榮情遠顯思神鳳初經堂難岑嗟訕窮感離歎殊懷始悲賢明仁智",
            "虞感歡華遠明願章輝麗麟祥恩窮窮讒隔感懷傷明歎望悲終仁智懷德",
            "唐春離心顯願神思盡作真意流窮嗟訕經感離窮傷殊悲賢明仁智懷德",
            "真離平思輝章盡憂鬱閑和深怨岑窮隔感懷傷難離殊思終明仁智懷德",
            "君難明神麗意作鬱精勞邁榮感窮嗟感傷明經歎望悲賢始仁智懷德聖",
            "黃故芳鳳麟祥真閑勞遺基芳傷難窮隔感離窮難殊悲終明仁智懷德聖",
            "戀蒙城初經意和邁基德雍軫傷岑嗟感傷懷經明歎望賢始仁智懷德聖",
            "傷堂戀祥堂流深榮芳雍熙華嗟窮訕感離窮傷難殊悲終明仁智懷德聖",
            "情恩傷難窮怨感傷軫華圖璇心窮隔經傷明難歎望賢始仁智懷德聖虞",
            "岑窮岑窮嗟窮感窮傷傷嗟璇心圖華軫感傷經隔窮怨窮難傷恩情岑哀",
            "哀嗟窮嗟訕訕感感窮窮心璇圖華傷感感訕嗟窮感感窮嗟窮難傷情哀",
            "歎讒隔窮隔隔經傷感傷嗟璇心圖華軫感經隔隔窮讒歎窮恩傷岑情深",
            "長隔感訕感感傷明難歎望賢始仁智懷德聖虞唐真君黃戀傷恩堂蒙故",
            "城經感訕感離窮傷難殊悲終明仁智懷德聖虞唐真君黃戀傷窮恩流意",
            "秦感傷隔傷傷明經歎望賢始仁智懷德聖虞唐真君黃戀深怨難祥經初",
            "苦離窮嗟離感離窮傷難殊悲終明仁智懷德聖虞唐真君黃流感傷芳麗",
            "艱歎傷訕傷傷懷經明歎望賢始仁智懷德聖虞唐真君黃深感傷榮鳳神",
            "難殊傷隔傷離窮傷難殊悲終明仁智懷德聖虞唐真君意怨傷芳邁和閑",
            "山思經感經傷明懷歎殊悲賢始仁智懷德聖虞唐真君作感岑傷勞鬱憂",
            "河望歎訕歎懷傷離窮明望終明仁智懷德聖虞唐真盡傷難窮精鬱盡章",
            "殊殊傷隔傷離經傷明殊賢始仁智懷德聖虞唐神思傷嗟窮輝思神願顯",
            "離歎明經傷感傷懷難歎悲終明仁智懷德聖虞願章輝意深離心春感遠",
            "别懷感感明傷離離殊望賢始仁智懷德聖顯願輝麗真流戀華歡紛思感",
            "妻始殊傷殊歎明傷悲悲終明仁智懷德聖明遠麗鳳和芳心榮歎感理智",
            "思賢悲悲悲悲賢終終始明仁智懷德聖虞唐真君黃戀傷情岑哀歎長一"
        ];

        // Color regions based on traditional 5-color version (simplified mapping)
        // 0=red, 1=blue, 2=yellow, 3=green, 4=purple
        function getColorRegion(x, y) {
            const cx = 14, cy = 14;
            const dx = x - cx, dy = y - cy;
            const dist = Math.sqrt(dx * dx + dy * dy);

            // Center is special (心)
            if (x === 14 && y === 14) return 5; // Gold

            // Diagonal quadrant determination
            if (dist <= 4) return 2; // Yellow - inner
            if (dist <= 8) {
                if (dy > dx && dy > -dx) return 0; // Red - top
                if (dy < dx && dy < -dx) return 1; // Blue - bottom
                if (dx > 0) return 3; // Green - right
                return 4; // Purple - left
            }
            // Outer ring - alternating
            const angle = Math.atan2(dy, dx);
            return Math.floor((angle + Math.PI) / (Math.PI / 2.5)) % 5;
        }

        const REGION_COLORS = {
            0: '#c41e3a', // Red
            1: '#4169e1', // Blue
            2: '#ffd700', // Yellow
            3: '#228b22', // Green
            4: '#9932cc', // Purple
            5: '#d4af37'  // Gold (center)
        };

        // ========================================
        // MUSICAL SCALES
        // ========================================
        const SCALES = {
            pentatonic: [0, 2, 4, 7, 9], // C D E G A (宮商角徵羽)
            chromatic: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11],
            major: [0, 2, 4, 5, 7, 9, 11],
            minor: [0, 2, 3, 5, 7, 8, 11]
        };

        const BASE_NOTE = 48; // C3

        // ========================================
        // STATE
        // ========================================
        let audioStarted = false;
        let isPlaying = false;
        let synths = {};
        let droneSynth = null;
        let currentX = 0;
        let currentY = 0;
        let radarAngle = 0;
        let spiralT = 0;
        let circleT = 0;
        let gateGrid = [];
        let trail = [];

        // Initialize gate grid (all on by default)
        for (let y = 0; y < 29; y++) {
            gateGrid[y] = [];
            for (let x = 0; x < 29; x++) {
                gateGrid[y][x] = true;
            }
        }

        // ========================================
        // CANVAS SETUP
        // ========================================
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let cellSize, gridOffsetX, gridOffsetY;

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            // Calculate cell size to fit grid
            const maxSize = Math.min(canvas.width * 0.65, canvas.height * 0.85);
            cellSize = Math.floor(maxSize / 29);
            gridOffsetX = (canvas.width - cellSize * 29) / 2 - 80;
            gridOffsetY = (canvas.height - cellSize * 29) / 2;
        }

        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // ========================================
        // AUDIO SETUP
        // ========================================
        async function initAudio() {
            await Tone.start();

            // Create synths for each color region
            const synthTypes = [
                { type: 'FMSynth', options: { harmonicity: 3, modulationIndex: 10 }},
                { type: 'AMSynth', options: { harmonicity: 2 }},
                { type: 'Synth', options: { oscillator: { type: 'triangle' }}},
                { type: 'Synth', options: { oscillator: { type: 'sawtooth' }}},
                { type: 'MembraneSynth', options: {}},
                { type: 'Synth', options: { oscillator: { type: 'sine' }}} // Center
            ];

            synthTypes.forEach((config, i) => {
                const SynthClass = Tone[config.type];
                synths[i] = new SynthClass(config.options).toDestination();
                synths[i].volume.value = -12;
            });

            // Drone for center (心)
            droneSynth = new Tone.Synth({
                oscillator: { type: 'sine' },
                envelope: { attack: 2, decay: 0, sustain: 1, release: 2 }
            }).toDestination();
            droneSynth.volume.value = -20;

            document.getElementById('startBtn').textContent = 'Audio Ready';
            document.getElementById('startBtn').classList.add('active');
            audioStarted = true;
        }

        function midiToNote(midi) {
            const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const octave = Math.floor(midi / 12) - 1;
            const note = notes[midi % 12];
            return note + octave;
        }

        function positionToMidi(x, y, scaleName) {
            const scale = SCALES[scaleName];
            const scaleLen = scale.length;

            // Map x to scale degree, y to octave offset
            const degree = x % scaleLen;
            const octaveOffset = Math.floor(y / 7) - 2;

            return BASE_NOTE + scale[degree] + (octaveOffset * 12);
        }

        function triggerNote(x, y) {
            if (!audioStarted || !isPlaying) return;

            const density = parseInt(document.getElementById('density').value);
            if (Math.random() * 100 > density) return;
            if (!gateGrid[y][x]) return;

            const region = getColorRegion(x, y);
            const scaleName = document.getElementById('scale').value;
            const midi = positionToMidi(x, y, scaleName);
            const note = midiToNote(midi);

            if (synths[region]) {
                synths[region].triggerAttackRelease(note, '16n', Tone.now());
            }

            // Update UI
            const char = XUANJI_CHARACTERS[y]?.[x] || '?';
            document.getElementById('currentChar').textContent = char;
            document.getElementById('currentPos').textContent = `(${x}, ${y})`;

            // Add to trail
            trail.push({ x, y, life: 1, region });
            if (trail.length > 50) trail.shift();
        }

        // ========================================
        // TRAVERSAL MODES
        // ========================================
        function stepCartesian() {
            triggerNote(currentX, currentY);
            currentX++;
            if (currentX >= 29) {
                currentX = 0;
                currentY++;
                if (currentY >= 29) currentY = 0;
            }
        }

        function stepRadar() {
            // Radar sweep from center
            const cx = 14, cy = 14;
            radarAngle += 0.05;

            // Trigger notes along the ray
            for (let r = 0; r <= 14; r++) {
                const x = Math.round(cx + Math.cos(radarAngle) * r);
                const y = Math.round(cy + Math.sin(radarAngle) * r);
                if (x >= 0 && x < 29 && y >= 0 && y < 29) {
                    if (r % 3 === 0) { // Sample every 3rd cell on the ray
                        triggerNote(x, y);
                    }
                    currentX = x;
                    currentY = y;
                }
            }
        }

        function stepSpiral() {
            // Inward spiral from corner
            const maxRadius = 14 * Math.sqrt(2);
            spiralT += 0.1;
            const r = maxRadius * (1 - (spiralT % (Math.PI * 10)) / (Math.PI * 10));
            const angle = spiralT * 3;

            const cx = 14, cy = 14;
            const x = Math.round(cx + Math.cos(angle) * r);
            const y = Math.round(cy + Math.sin(angle) * r);

            if (x >= 0 && x < 29 && y >= 0 && y < 29) {
                currentX = x;
                currentY = y;
                triggerNote(x, y);
            }
        }

        function stepCircle() {
            // Border ring only
            circleT += 0.05;
            const perimeter = 28 * 4;
            const pos = Math.floor((circleT % (Math.PI * 2)) / (Math.PI * 2) * perimeter);

            let x, y;
            if (pos < 28) { // Top edge
                x = pos; y = 0;
            } else if (pos < 56) { // Right edge
                x = 28; y = pos - 28;
            } else if (pos < 84) { // Bottom edge
                x = 84 - pos; y = 28;
            } else { // Left edge
                x = 0; y = 112 - pos;
            }

            currentX = x;
            currentY = y;
            triggerNote(x, y);
        }

        // ========================================
        // RENDERING
        // ========================================
        function draw() {
            ctx.fillStyle = 'rgba(15, 15, 26, 0.15)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw grid
            for (let y = 0; y < 29; y++) {
                for (let x = 0; x < 29; x++) {
                    const px = gridOffsetX + x * cellSize;
                    const py = gridOffsetY + y * cellSize;
                    const region = getColorRegion(x, y);
                    const char = XUANJI_CHARACTERS[y]?.[x] || '?';

                    // Cell background
                    const isGated = gateGrid[y][x];
                    const baseAlpha = isGated ? 0.3 : 0.1;
                    ctx.fillStyle = REGION_COLORS[region] + Math.floor(baseAlpha * 255).toString(16).padStart(2, '0');
                    ctx.fillRect(px, py, cellSize - 1, cellSize - 1);

                    // Character
                    ctx.fillStyle = isGated ? '#e8e6e1' : '#555';
                    ctx.font = `${Math.floor(cellSize * 0.6)}px 'Noto Serif SC', serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(char, px + cellSize / 2, py + cellSize / 2);
                }
            }

            // Draw trail
            trail.forEach((t, i) => {
                const px = gridOffsetX + t.x * cellSize + cellSize / 2;
                const py = gridOffsetY + t.y * cellSize + cellSize / 2;

                ctx.beginPath();
                ctx.arc(px, py, cellSize * 0.3 * t.life, 0, Math.PI * 2);
                ctx.fillStyle = REGION_COLORS[t.region] + Math.floor(t.life * 200).toString(16).padStart(2, '0');
                ctx.fill();

                t.life -= 0.02;
            });
            trail = trail.filter(t => t.life > 0);

            // Draw current position cursor
            const cursorX = gridOffsetX + currentX * cellSize + cellSize / 2;
            const cursorY = gridOffsetY + currentY * cellSize + cellSize / 2;

            ctx.beginPath();
            ctx.arc(cursorX, cursorY, cellSize * 0.4, 0, Math.PI * 2);
            ctx.strokeStyle = '#d4af37';
            ctx.lineWidth = 3;
            ctx.stroke();

            // Draw radar arm if in radar mode
            if (document.getElementById('mode').value === 'radar') {
                const cx = gridOffsetX + 14 * cellSize + cellSize / 2;
                const cy = gridOffsetY + 14 * cellSize + cellSize / 2;
                const rayLen = 14 * cellSize;

                ctx.beginPath();
                ctx.moveTo(cx, cy);
                ctx.lineTo(cx + Math.cos(radarAngle) * rayLen, cy + Math.sin(radarAngle) * rayLen);
                ctx.strokeStyle = 'rgba(212, 175, 55, 0.6)';
                ctx.lineWidth = 2;
                ctx.stroke();
            }

            requestAnimationFrame(draw);
        }

        // ========================================
        // TIMING / SEQUENCING
        // ========================================
        let lastStepTime = 0;

        function schedulerLoop() {
            if (!isPlaying) {
                requestAnimationFrame(schedulerLoop);
                return;
            }

            const tempo = parseInt(document.getElementById('tempo').value);
            const stepInterval = 60000 / tempo / 4; // 16th notes
            const now = performance.now();

            if (now - lastStepTime >= stepInterval) {
                const mode = document.getElementById('mode').value;

                switch (mode) {
                    case 'cartesian': stepCartesian(); break;
                    case 'radar': stepRadar(); break;
                    case 'spiral': stepSpiral(); break;
                    case 'circle': stepCircle(); break;
                }

                lastStepTime = now;
            }

            requestAnimationFrame(schedulerLoop);
        }

        // ========================================
        // EVENT HANDLERS
        // ========================================
        document.getElementById('startBtn').addEventListener('click', initAudio);

        document.getElementById('playBtn').addEventListener('click', () => {
            if (!audioStarted) {
                alert('Please start audio first');
                return;
            }
            isPlaying = true;
            document.getElementById('playBtn').classList.add('active');

            // Start drone on center note
            const scaleName = document.getElementById('scale').value;
            const centerMidi = positionToMidi(14, 14, scaleName);
            droneSynth.triggerAttack(midiToNote(centerMidi));
        });

        document.getElementById('stopBtn').addEventListener('click', () => {
            isPlaying = false;
            document.getElementById('playBtn').classList.remove('active');
            droneSynth?.triggerRelease();

            // Reset positions
            currentX = 0;
            currentY = 0;
            radarAngle = 0;
            spiralT = 0;
            circleT = 0;
        });

        document.getElementById('tempo').addEventListener('input', (e) => {
            document.getElementById('tempoValue').textContent = e.target.value;
        });

        document.getElementById('density').addEventListener('input', (e) => {
            document.getElementById('densityValue').textContent = e.target.value;
        });

        // Click to toggle gate
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mx = e.clientX - rect.left;
            const my = e.clientY - rect.top;

            const gx = Math.floor((mx - gridOffsetX) / cellSize);
            const gy = Math.floor((my - gridOffsetY) / cellSize);

            if (gx >= 0 && gx < 29 && gy >= 0 && gy < 29) {
                gateGrid[gy][gx] = !gateGrid[gy][gx];
            }
        });

        // ========================================
        // INITIALIZATION
        // ========================================
        document.getElementById('loading').style.display = 'none';
        draw();
        schedulerLoop();
    </script>
</body>
</html>
