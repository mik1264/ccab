<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Step Sequencer Visualizer</title>
    <style>
        body { margin: 0; overflow: hidden; background: #0a0a0a; font-family: Arial; }
        canvas { display: block; }
        .controls { position: absolute; top: 20px; left: 20px; color: white; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; z-index: 10; }
        button { background: #2196F3; color: white; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; border-radius: 5px; }
        button.active { background: #4CAF50; }
        .sequencer { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); }
        .seq-row { display: flex; margin: 5px 0; }
        .seq-step { width: 40px; height: 40px; background: #333; border: 2px solid #666; cursor: pointer; margin: 2px; border-radius: 5px; }
        .seq-step.active { background: #2196F3; }
        .seq-step.playing { box-shadow: 0 0 20px #4CAF50; border-color: #4CAF50; }
        .note-label { color: white; width: 50px; line-height: 40px; }
    </style>
</head>
<body>
    <div class="controls">
        <h2>Step Sequencer Visualizer</h2>
        <button id="startBtn">Start Audio</button>
        <button id="playBtn">Play</button>
        <button id="stopBtn">Stop</button>
        <div style="margin-top: 10px;">BPM: <input type="range" id="bpm" min="60" max="180" value="120"> <span id="bpmValue">120</span></div>
    </div>
    <div class="sequencer" id="sequencer"></div>
    <canvas id="canvas"></canvas>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script>
        const canvas = document.getElementById('canvas'); const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;

        let synth, analyser, sequence;
        const steps = 16;
        const notes = ['C4', 'D4', 'E4', 'G4'];
        const grid = {};

        notes.forEach(note => { grid[note] = new Array(steps).fill(false); });

        const sequencer = document.getElementById('sequencer');
        notes.forEach(note => {
            const row = document.createElement('div');
            row.className = 'seq-row';

            const label = document.createElement('div');
            label.className = 'note-label';
            label.textContent = note;
            row.appendChild(label);

            for (let i = 0; i < steps; i++) {
                const step = document.createElement('div');
                step.className = 'seq-step';
                step.dataset.note = note;
                step.dataset.step = i;
                step.addEventListener('click', () => {
                    grid[note][i] = !grid[note][i];
                    step.classList.toggle('active');
                });
                row.appendChild(step);
            }
            sequencer.appendChild(row);
        });

        let currentStep = 0;
        const particles = [];

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y; this.vx = (Math.random() - 0.5) * 5;
                this.vy = (Math.random() - 0.5) * 5; this.life = 1;
                this.color = color; this.size = Math.random() * 5 + 2;
            }
            update() { this.x += this.vx; this.y += this.vy; this.life -= 0.02; }
            draw() {
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            }
        }

        document.getElementById('startBtn').addEventListener('click', async () => {
            await Tone.start();
            synth = new Tone.PolySynth(Tone.Synth).toDestination();
            analyser = new Tone.Analyser('fft', 256);
            synth.connect(analyser);

            sequence = new Tone.Sequence((time, step) => {
                currentStep = step;
                notes.forEach((note, i) => {
                    if (grid[note][step]) {
                        synth.triggerAttackRelease(note, '16n', time);
                        const y = canvas.height * 0.2 + i * 100;
                        const x = (step / steps) * canvas.width;
                        for (let j = 0; j < 10; j++) {
                            particles.push(new Particle(x, y, `hsl(${i * 90}, 100%, 50%)`));
                        }
                    }
                });

                // Update UI
                document.querySelectorAll('.seq-step.playing').forEach(el => el.classList.remove('playing'));
                document.querySelectorAll(`[data-step="${step}"]`).forEach(el => el.classList.add('playing'));
            }, [...Array(steps).keys()], '16n');

            document.getElementById('startBtn').textContent = 'Audio Started';
            animate();
        });

        document.getElementById('playBtn').addEventListener('click', () => {
            if (sequence) {
                Tone.Transport.start();
                sequence.start(0);
            }
        });

        document.getElementById('stopBtn').addEventListener('click', () => {
            if (sequence) {
                Tone.Transport.stop();
                sequence.stop();
            }
        });

        document.getElementById('bpm').addEventListener('input', e => {
            Tone.Transport.bpm.value = e.target.value;
            document.getElementById('bpmValue').textContent = e.target.value;
        });

        function animate() {
            requestAnimationFrame(animate);

            ctx.fillStyle = 'rgba(10,10,10,0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (analyser) {
                const values = analyser.getValue();
                const barWidth = canvas.width / values.length;

                for (let i = 0; i < values.length; i++) {
                    const height = (values[i] + 140) * 2;
                    ctx.fillStyle = `hsl(${i / values.length * 360}, 100%, 50%)`;
                    ctx.fillRect(i * barWidth, canvas.height - height, barWidth - 1, height);
                }
            }

            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].update();
                particles[i].draw();
                if (particles[i].life <= 0) particles.splice(i, 1);
            }
        }
    </script>
    <script src="../../assets/js/enhance.js" defer></script>
</body>
</html>
