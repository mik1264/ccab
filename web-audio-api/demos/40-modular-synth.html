<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Modular Synth Patcher</title>
    <style>
        body { margin: 0; overflow: hidden; background: #0a0a0a; font-family: Arial; }
        canvas { display: block; }
        .controls { position: absolute; top: 20px; left: 20px; color: white; background: rgba(0,0,0,0.9); padding: 15px; border-radius: 10px; max-width: 350px; }
        button { background: #9C27B0; color: white; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; border-radius: 5px; width: 100%; }
        .module { background: #222; padding: 10px; margin: 10px 0; border-radius: 5px; border: 2px solid #9C27B0; }
        .module h3 { margin: 0 0 10px 0; font-size: 14px; color: #9C27B0; }
        .param { margin: 5px 0; }
        .param label { font-size: 12px; }
        input[type="range"] { width: 100%; }
        select { width: 100%; padding: 5px; background: #333; color: white; border: 1px solid #9C27B0; border-radius: 3px; }
        .keyboard { display: flex; flex-wrap: wrap; margin-top: 10px; }
        .key-btn { width: 45px; height: 30px; margin: 2px; background: #555; font-size: 11px; }
        .key-btn:active { background: #9C27B0; }
    </style>
</head>
<body>
    <div class="controls">
        <h2 style="margin: 0 0 10px 0;">Modular Synth Patcher</h2>
        <button id="startBtn">Start Audio</button>

        <div class="module">
            <h3>OSCILLATOR</h3>
            <div class="param">
                <label>Type:</label>
                <select id="oscType">
                    <option value="sine">Sine</option>
                    <option value="square">Square</option>
                    <option value="sawtooth">Sawtooth</option>
                    <option value="triangle">Triangle</option>
                </select>
            </div>
        </div>

        <div class="module">
            <h3>FILTER</h3>
            <div class="param">
                <label>Frequency: <span id="filterFreqVal">1000</span> Hz</label>
                <input type="range" id="filterFreq" min="20" max="5000" value="1000">
            </div>
            <div class="param">
                <label>Resonance: <span id="filterResVal">1</span></label>
                <input type="range" id="filterRes" min="0.1" max="30" value="1" step="0.1">
            </div>
        </div>

        <div class="module">
            <h3>ENVELOPE</h3>
            <div class="param">
                <label>Attack: <span id="envAttackVal">0.01</span></label>
                <input type="range" id="envAttack" min="0.001" max="1" value="0.01" step="0.001">
            </div>
            <div class="param">
                <label>Release: <span id="envReleaseVal">0.5</span></label>
                <input type="range" id="envRelease" min="0.01" max="2" value="0.5" step="0.01">
            </div>
        </div>

        <div class="module">
            <h3>EFFECTS</h3>
            <div class="param">
                <label>Reverb: <span id="reverbVal">0.5</span></label>
                <input type="range" id="reverb" min="0" max="1" value="0.5" step="0.01">
            </div>
        </div>

        <div class="keyboard">
            <button class="key-btn" data-note="C3">C3</button>
            <button class="key-btn" data-note="D3">D3</button>
            <button class="key-btn" data-note="E3">E3</button>
            <button class="key-btn" data-note="G3">G3</button>
            <button class="key-btn" data-note="A3">A3</button>
            <button class="key-btn" data-note="C4">C4</button>
            <button class="key-btn" data-note="E4">E4</button>
            <button class="key-btn" data-note="G4">G4</button>
        </div>
    </div>
    <canvas id="canvas"></canvas>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script>
        const canvas = document.getElementById('canvas'); const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;

        let synth, filter, reverb, analyser;

        document.getElementById('startBtn').addEventListener('click', async () => {
            await Tone.start();

            synth = new Tone.Synth({
                oscillator: { type: 'sine' },
                envelope: { attack: 0.01, decay: 0.1, sustain: 0.5, release: 0.5 }
            });

            filter = new Tone.Filter({ frequency: 1000, type: 'lowpass', rolloff: -24 });
            reverb = new Tone.Reverb({ decay: 1.5, wet: 0.5 });
            analyser = new Tone.Analyser('waveform', 2048);

            synth.connect(filter);
            filter.connect(reverb);
            reverb.connect(analyser);
            reverb.toDestination();

            document.getElementById('startBtn').textContent = 'Audio Started';
            animate();
        });

        document.getElementById('oscType').addEventListener('change', e => {
            if (synth) synth.oscillator.type = e.target.value;
        });

        document.getElementById('filterFreq').addEventListener('input', e => {
            if (filter) filter.frequency.value = parseFloat(e.target.value);
            document.getElementById('filterFreqVal').textContent = e.target.value;
        });

        document.getElementById('filterRes').addEventListener('input', e => {
            if (filter) filter.Q.value = parseFloat(e.target.value);
            document.getElementById('filterResVal').textContent = e.target.value;
        });

        document.getElementById('envAttack').addEventListener('input', e => {
            if (synth) synth.envelope.attack = parseFloat(e.target.value);
            document.getElementById('envAttackVal').textContent = e.target.value;
        });

        document.getElementById('envRelease').addEventListener('input', e => {
            if (synth) synth.envelope.release = parseFloat(e.target.value);
            document.getElementById('envReleaseVal').textContent = e.target.value;
        });

        document.getElementById('reverb').addEventListener('input', e => {
            if (reverb) reverb.wet.value = parseFloat(e.target.value);
            document.getElementById('reverbVal').textContent = e.target.value;
        });

        document.querySelectorAll('.key-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (synth) synth.triggerAttackRelease(btn.dataset.note, '8n');
            });
        });

        const nodePositions = [
            { x: 200, y: 150, label: 'OSC', color: '#FF6B6B' },
            { x: 400, y: 150, label: 'FILTER', color: '#4ECDC4' },
            { x: 600, y: 150, label: 'REVERB', color: '#95E1D3' },
            { x: 800, y: 150, label: 'OUT', color: '#F38181' }
        ];

        function animate() {
            requestAnimationFrame(animate);
            if (!analyser) return;

            const values = analyser.getValue();

            ctx.fillStyle = 'rgba(10,10,10,0.2)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw waveform
            ctx.strokeStyle = '#9C27B0';
            ctx.lineWidth = 2;
            ctx.shadowBlur = 10;
            ctx.shadowColor = '#9C27B0';
            ctx.beginPath();

            const sliceWidth = canvas.width / values.length;
            let x = 0;

            for (let i = 0; i < values.length; i++) {
                const v = (values[i] + 1) / 2;
                const y = v * canvas.height * 0.6 + canvas.height * 0.5;

                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);

                x += sliceWidth;
            }

            ctx.stroke();
            ctx.shadowBlur = 0;

            // Draw modular connections
            for (let i = 0; i < nodePositions.length - 1; i++) {
                const current = nodePositions[i];
                const next = nodePositions[i + 1];

                ctx.strokeStyle = current.color;
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(current.x, current.y);
                ctx.lineTo(next.x, next.y);
                ctx.stroke();
            }

            // Draw nodes
            nodePositions.forEach(node => {
                ctx.fillStyle = node.color;
                ctx.shadowBlur = 15;
                ctx.shadowColor = node.color;
                ctx.beginPath();
                ctx.arc(node.x, node.y, 30, 0, Math.PI * 2);
                ctx.fill();

                ctx.shadowBlur = 0;
                ctx.fillStyle = '#000';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(node.label, node.x, node.y);
            });
        }
    </script>
    <script src="../../assets/js/enhance.js" defer></script>
</body>
</html>
