<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spectrum Shader - Audio-Visual Hybrid</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #000;
            color: #fff;
            font-family: 'Segoe UI', system-ui, sans-serif;
            overflow: hidden;
        }
        #canvas { display: block; width: 100vw; height: 100vh; }
        .controls {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.85);
            padding: 20px;
            border-radius: 12px;
            z-index: 100;
            min-width: 280px;
        }
        h1 { font-size: 1.3em; margin-bottom: 5px; color: #00e5ff; }
        .subtitle { font-size: 0.85em; color: #888; margin-bottom: 15px; }
        .button-row { display: flex; gap: 10px; margin-bottom: 15px; }
        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            background: #00e5ff;
            color: #000;
            cursor: pointer;
            font-weight: 600;
        }
        button:hover { background: #00b8d4; }
        button:disabled { background: #444; cursor: not-allowed; }
        .shader-modes { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 15px; }
        .mode-btn {
            padding: 6px 12px;
            background: #222;
            border: 1px solid #444;
            border-radius: 6px;
            color: #888;
            font-size: 0.8em;
            cursor: pointer;
        }
        .mode-btn:hover, .mode-btn.active {
            background: #00e5ff;
            border-color: #00e5ff;
            color: #000;
        }
        .slider-group { margin-bottom: 12px; }
        .slider-group label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 0.85em;
            color: #aaa;
        }
        .slider-group input[type="range"] {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: #333;
            border-radius: 3px;
        }
        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #00e5ff;
            border-radius: 50%;
            cursor: pointer;
        }
        .back-link {
            position: fixed;
            top: 20px;
            right: 20px;
            color: #00e5ff;
            text-decoration: none;
            z-index: 100;
        }
        .info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
            max-width: 350px;
            font-size: 0.85em;
            color: #aaa;
            line-height: 1.5;
        }
        .info h3 { color: #00e5ff; margin-bottom: 8px; }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>

    <div class="controls">
        <h1>Spectrum Shader</h1>
        <p class="subtitle">Audio → GLSL Shader Uniforms</p>

        <div class="button-row">
            <button id="startBtn">Start Audio</button>
        </div>

        <div class="shader-modes">
            <span class="mode-btn active" data-mode="plasma">Plasma</span>
            <span class="mode-btn" data-mode="waves">Waves</span>
            <span class="mode-btn" data-mode="tunnel">Tunnel</span>
            <span class="mode-btn" data-mode="fractal">Fractal</span>
        </div>

        <div class="slider-group">
            <label>Audio Reactivity <span id="reactVal">1.0</span></label>
            <input type="range" id="reactivity" min="0" max="2" step="0.1" value="1">
        </div>

        <div class="slider-group">
            <label>Speed <span id="speedVal">1.0</span></label>
            <input type="range" id="speed" min="0.2" max="3" step="0.2" value="1">
        </div>

        <div class="slider-group">
            <label>Complexity <span id="complexVal">1.0</span></label>
            <input type="range" id="complexity" min="0.5" max="2" step="0.1" value="1">
        </div>
    </div>

    <a href="../index.html" class="back-link">← Back to Gallery</a>

    <div class="info">
        <h3>Shader Art</h3>
        <p>Audio frequency data drives WebGL shader uniforms.
        Bass, mid, and treble frequencies control different
        visual parameters in real-time procedural graphics.</p>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const gl = canvas.getContext('webgl');

        let audioContext, analyser, dataArray, source;
        let audioStarted = false;

        let shaderMode = 'plasma';
        let reactivity = 1;
        let speed = 1;
        let complexity = 1;

        // Vertex shader (simple fullscreen quad)
        const vertexShaderSource = `
            attribute vec2 a_position;
            void main() {
                gl_Position = vec4(a_position, 0.0, 1.0);
            }
        `;

        // Fragment shaders for different modes
        const fragmentShaders = {
            plasma: `
                precision mediump float;
                uniform vec2 u_resolution;
                uniform float u_time;
                uniform float u_bass;
                uniform float u_mid;
                uniform float u_high;
                uniform float u_reactivity;
                uniform float u_complexity;

                void main() {
                    vec2 uv = gl_FragCoord.xy / u_resolution;
                    vec2 p = (uv - 0.5) * 2.0;

                    float scale = u_complexity * (1.0 + u_bass * u_reactivity * 0.5);
                    float t = u_time * 0.5;

                    float v = 0.0;
                    v += sin((p.x * scale + t) * 3.0);
                    v += sin((p.y * scale + t) * 2.0);
                    v += sin((p.x * scale + p.y * scale + t) * 2.5);
                    v += sin(sqrt(p.x * p.x + p.y * p.y) * scale * 4.0 - t);

                    v = v * 0.5 + 0.5;

                    float r = sin(v * 3.14159 + u_bass * u_reactivity) * 0.5 + 0.5;
                    float g = sin(v * 3.14159 + 2.0 + u_mid * u_reactivity) * 0.5 + 0.5;
                    float b = sin(v * 3.14159 + 4.0 + u_high * u_reactivity) * 0.5 + 0.5;

                    gl_FragColor = vec4(r, g, b, 1.0);
                }
            `,
            waves: `
                precision mediump float;
                uniform vec2 u_resolution;
                uniform float u_time;
                uniform float u_bass;
                uniform float u_mid;
                uniform float u_high;
                uniform float u_reactivity;
                uniform float u_complexity;

                void main() {
                    vec2 uv = gl_FragCoord.xy / u_resolution;
                    vec2 p = uv * 2.0 - 1.0;
                    p.x *= u_resolution.x / u_resolution.y;

                    float t = u_time;
                    float waves = 0.0;

                    for (float i = 1.0; i < 6.0; i++) {
                        float freq = i * u_complexity;
                        float amp = 0.3 / i * (1.0 + u_bass * u_reactivity);
                        waves += sin(p.x * freq + t * i * 0.5) * amp;
                        waves += sin(p.y * freq * 1.3 + t * i * 0.3) * amp * 0.7;
                    }

                    float dist = abs(p.y - waves * (0.5 + u_mid * u_reactivity));
                    float glow = 0.02 / dist;

                    vec3 color = vec3(0.0);
                    color += vec3(0.0, 0.8, 1.0) * glow * (1.0 + u_high);
                    color += vec3(1.0, 0.0, 0.5) * glow * 0.5 * u_bass;

                    gl_FragColor = vec4(color, 1.0);
                }
            `,
            tunnel: `
                precision mediump float;
                uniform vec2 u_resolution;
                uniform float u_time;
                uniform float u_bass;
                uniform float u_mid;
                uniform float u_high;
                uniform float u_reactivity;
                uniform float u_complexity;

                void main() {
                    vec2 uv = gl_FragCoord.xy / u_resolution;
                    vec2 p = uv * 2.0 - 1.0;
                    p.x *= u_resolution.x / u_resolution.y;

                    float angle = atan(p.y, p.x);
                    float radius = length(p);

                    float t = u_time;
                    float twist = angle + t * 0.5 + u_bass * u_reactivity;
                    float depth = 1.0 / (radius + 0.1) * (1.0 + u_mid * u_reactivity * 0.5);

                    float pattern = sin(twist * 6.0 * u_complexity + depth * 2.0 - t * 2.0);
                    pattern += sin(twist * 12.0 * u_complexity - depth * 4.0 + t);
                    pattern = pattern * 0.5 + 0.5;

                    vec3 color = vec3(0.0);
                    color.r = pattern * (0.5 + u_bass * 0.5);
                    color.g = pattern * (0.3 + u_mid * 0.7);
                    color.b = pattern * (0.8 + u_high * 0.2);

                    // Vignette
                    color *= 1.0 - radius * 0.5;

                    gl_FragColor = vec4(color, 1.0);
                }
            `,
            fractal: `
                precision mediump float;
                uniform vec2 u_resolution;
                uniform float u_time;
                uniform float u_bass;
                uniform float u_mid;
                uniform float u_high;
                uniform float u_reactivity;
                uniform float u_complexity;

                void main() {
                    vec2 uv = gl_FragCoord.xy / u_resolution;
                    vec2 c = (uv - 0.5) * 3.0;
                    c.x *= u_resolution.x / u_resolution.y;

                    // Zoom with bass
                    c *= 1.0 - u_bass * u_reactivity * 0.3;

                    // Rotate with time
                    float t = u_time * 0.2;
                    float cs = cos(t);
                    float sn = sin(t);
                    c = vec2(c.x * cs - c.y * sn, c.x * sn + c.y * cs);

                    // Julia set
                    vec2 z = c;
                    vec2 julia = vec2(-0.7 + u_mid * 0.1 * u_reactivity, 0.27 + u_high * 0.1 * u_reactivity);

                    float iterations = 0.0;
                    float maxIter = 50.0 * u_complexity;

                    for (float i = 0.0; i < 100.0; i++) {
                        if (i >= maxIter) break;
                        z = vec2(z.x * z.x - z.y * z.y, 2.0 * z.x * z.y) + julia;
                        if (length(z) > 2.0) break;
                        iterations = i;
                    }

                    float v = iterations / maxIter;

                    vec3 color;
                    color.r = 0.5 + 0.5 * sin(v * 10.0 + u_time + u_bass * 3.0);
                    color.g = 0.5 + 0.5 * sin(v * 10.0 + u_time * 1.3 + 2.0);
                    color.b = 0.5 + 0.5 * sin(v * 10.0 + u_time * 1.7 + 4.0);

                    if (iterations >= maxIter - 1.0) {
                        color = vec3(0.0);
                    }

                    gl_FragColor = vec4(color, 1.0);
                }
            `
        };

        let program;
        let positionBuffer;

        function createShader(type, source) {
            const shader = gl.createShader(type);
            gl.shaderSource(shader, source);
            gl.compileShader(shader);
            if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                console.error(gl.getShaderInfoLog(shader));
                gl.deleteShader(shader);
                return null;
            }
            return shader;
        }

        function createProgram(fragSource) {
            const vertexShader = createShader(gl.VERTEX_SHADER, vertexShaderSource);
            const fragmentShader = createShader(gl.FRAGMENT_SHADER, fragSource);

            const prog = gl.createProgram();
            gl.attachShader(prog, vertexShader);
            gl.attachShader(prog, fragmentShader);
            gl.linkProgram(prog);

            if (!gl.getProgramParameter(prog, gl.LINK_STATUS)) {
                console.error(gl.getProgramInfoLog(prog));
                return null;
            }
            return prog;
        }

        function initWebGL() {
            program = createProgram(fragmentShaders[shaderMode]);
            gl.useProgram(program);

            // Create fullscreen quad
            positionBuffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([
                -1, -1, 1, -1, -1, 1,
                -1, 1, 1, -1, 1, 1
            ]), gl.STATIC_DRAW);

            const positionLocation = gl.getAttribLocation(program, 'a_position');
            gl.enableVertexAttribArray(positionLocation);
            gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            gl.viewport(0, 0, canvas.width, canvas.height);
        }

        document.getElementById('startBtn').addEventListener('click', async function() {
            if (audioStarted) return;

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                dataArray = new Uint8Array(analyser.frequencyBinCount);

                source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);

                audioStarted = true;
                this.textContent = 'Audio Active';
                this.disabled = true;
            } catch (err) {
                console.error('Audio error:', err);
                this.textContent = 'Audio Failed';
            }
        });

        // Mode buttons
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                shaderMode = btn.dataset.mode;
                initWebGL();
            });
        });

        // UI controls
        document.getElementById('reactivity').addEventListener('input', (e) => {
            reactivity = parseFloat(e.target.value);
            document.getElementById('reactVal').textContent = reactivity.toFixed(1);
        });

        document.getElementById('speed').addEventListener('input', (e) => {
            speed = parseFloat(e.target.value);
            document.getElementById('speedVal').textContent = speed.toFixed(1);
        });

        document.getElementById('complexity').addEventListener('input', (e) => {
            complexity = parseFloat(e.target.value);
            document.getElementById('complexVal').textContent = complexity.toFixed(1);
        });

        window.addEventListener('resize', resize);

        let time = 0;

        function draw() {
            // Get audio data
            let bass = 0, mid = 0, high = 0;
            if (audioStarted && analyser) {
                analyser.getByteFrequencyData(dataArray);

                const len = dataArray.length;
                for (let i = 0; i < len / 3; i++) bass += dataArray[i];
                for (let i = len / 3; i < 2 * len / 3; i++) mid += dataArray[i];
                for (let i = 2 * len / 3; i < len; i++) high += dataArray[i];

                bass = bass / (len / 3) / 255;
                mid = mid / (len / 3) / 255;
                high = high / (len / 3) / 255;
            }

            time += 0.016 * speed;

            // Set uniforms
            gl.uniform2f(gl.getUniformLocation(program, 'u_resolution'), canvas.width, canvas.height);
            gl.uniform1f(gl.getUniformLocation(program, 'u_time'), time);
            gl.uniform1f(gl.getUniformLocation(program, 'u_bass'), bass);
            gl.uniform1f(gl.getUniformLocation(program, 'u_mid'), mid);
            gl.uniform1f(gl.getUniformLocation(program, 'u_high'), high);
            gl.uniform1f(gl.getUniformLocation(program, 'u_reactivity'), reactivity);
            gl.uniform1f(gl.getUniformLocation(program, 'u_complexity'), complexity);

            gl.drawArrays(gl.TRIANGLES, 0, 6);

            requestAnimationFrame(draw);
        }

        resize();
        initWebGL();
        draw();
    </script>
    <script src="../../assets/js/enhance.js" defer></script>
</body>
</html>
