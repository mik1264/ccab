<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Boids - Audio-Visual Hybrid</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0a0a1a;
            color: #fff;
            font-family: 'Segoe UI', system-ui, sans-serif;
            overflow: hidden;
        }
        #canvas { display: block; width: 100vw; height: 100vh; }
        .controls {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.85);
            padding: 20px;
            border-radius: 12px;
            z-index: 100;
            min-width: 280px;
        }
        h1 { font-size: 1.3em; margin-bottom: 5px; color: #ffab40; }
        .subtitle { font-size: 0.85em; color: #888; margin-bottom: 15px; }
        .button-row { display: flex; gap: 10px; margin-bottom: 15px; }
        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            background: #ffab40;
            color: #000;
            cursor: pointer;
            font-weight: 600;
        }
        button:hover { background: #ff9100; }
        button:disabled { background: #444; cursor: not-allowed; }
        .slider-group { margin-bottom: 12px; }
        .slider-group label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 0.85em;
            color: #aaa;
        }
        .slider-group input[type="range"] {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: #333;
            border-radius: 3px;
        }
        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #ffab40;
            border-radius: 50%;
            cursor: pointer;
        }
        .stats {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #333;
            font-size: 0.85em;
            color: #888;
        }
        .back-link {
            position: fixed;
            top: 20px;
            right: 20px;
            color: #ffab40;
            text-decoration: none;
            z-index: 100;
        }
        .info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
            max-width: 350px;
            font-size: 0.85em;
            color: #aaa;
            line-height: 1.5;
        }
        .info h3 { color: #ffab40; margin-bottom: 8px; }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>

    <div class="controls">
        <h1>Audio Boids</h1>
        <p class="subtitle">Sound-Reactive Flocking</p>

        <div class="button-row">
            <button id="startBtn">Start Audio</button>
        </div>

        <div class="slider-group">
            <label>Boid Count <span id="countVal">200</span></label>
            <input type="range" id="count" min="50" max="500" step="50" value="200">
        </div>

        <div class="slider-group">
            <label>Audio Influence <span id="influenceVal">1.0</span></label>
            <input type="range" id="influence" min="0" max="2" step="0.1" value="1">
        </div>

        <div class="slider-group">
            <label>Max Speed <span id="speedVal">4</span></label>
            <input type="range" id="speed" min="2" max="8" step="0.5" value="4">
        </div>

        <div class="slider-group">
            <label>Trail Length <span id="trailVal">5</span></label>
            <input type="range" id="trail" min="0" max="20" step="1" value="5">
        </div>

        <div class="stats">
            <div>Bass: <span id="bassLevel">0</span>%</div>
            <div>Mid: <span id="midLevel">0</span>%</div>
            <div>High: <span id="highLevel">0</span>%</div>
        </div>
    </div>

    <a href="../index.html" class="back-link">‚Üê Back to Gallery</a>

    <div class="info">
        <h3>Music-Reactive Flock</h3>
        <p>Boid flocking behavior modulated by audio.
        Bass increases cohesion, mid controls alignment,
        and high frequencies boost separation and speed.</p>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let width, height;
        let audioContext, analyser, dataArray, source;
        let audioStarted = false;

        let boidCount = 200;
        let audioInfluence = 1;
        let maxSpeed = 4;
        let trailLength = 5;

        let boids = [];

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            width = canvas.width;
            height = canvas.height;
        }

        class Boid {
            constructor() {
                this.x = Math.random() * width;
                this.y = Math.random() * height;
                this.vx = (Math.random() - 0.5) * 4;
                this.vy = (Math.random() - 0.5) * 4;
                this.hue = Math.random() * 60 + 20; // Yellow-orange range
                this.trail = [];
            }

            update(bass, mid, high) {
                // Store trail
                this.trail.push({ x: this.x, y: this.y });
                if (this.trail.length > trailLength) {
                    this.trail.shift();
                }

                // Flocking behavior
                let avgX = 0, avgY = 0, avgVX = 0, avgVY = 0;
                let sepX = 0, sepY = 0;
                let neighbors = 0, closeNeighbors = 0;

                const perceptionRadius = 50 + bass * audioInfluence * 50;
                const separationRadius = 25 + high * audioInfluence * 20;

                for (const other of boids) {
                    if (other === this) continue;

                    const dx = other.x - this.x;
                    const dy = other.y - this.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist < perceptionRadius) {
                        avgX += other.x;
                        avgY += other.y;
                        avgVX += other.vx;
                        avgVY += other.vy;
                        neighbors++;

                        if (dist < separationRadius) {
                            sepX -= dx / (dist + 0.1);
                            sepY -= dy / (dist + 0.1);
                            closeNeighbors++;
                        }
                    }
                }

                if (neighbors > 0) {
                    avgX /= neighbors;
                    avgY /= neighbors;
                    avgVX /= neighbors;
                    avgVY /= neighbors;

                    // Cohesion - stronger with bass
                    const cohesionStrength = 0.01 * (1 + bass * audioInfluence);
                    this.vx += (avgX - this.x) * cohesionStrength;
                    this.vy += (avgY - this.y) * cohesionStrength;

                    // Alignment - stronger with mid
                    const alignmentStrength = 0.05 * (1 + mid * audioInfluence);
                    this.vx += (avgVX - this.vx) * alignmentStrength;
                    this.vy += (avgVY - this.vy) * alignmentStrength;
                }

                if (closeNeighbors > 0) {
                    // Separation - stronger with high
                    const separationStrength = 0.05 * (1 + high * audioInfluence * 2);
                    this.vx += sepX * separationStrength;
                    this.vy += sepY * separationStrength;
                }

                // Speed boost with high frequencies
                const currentMaxSpeed = maxSpeed * (1 + high * audioInfluence * 0.5);
                const speed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
                if (speed > currentMaxSpeed) {
                    this.vx = (this.vx / speed) * currentMaxSpeed;
                    this.vy = (this.vy / speed) * currentMaxSpeed;
                }

                // Update position
                this.x += this.vx;
                this.y += this.vy;

                // Wrap around
                if (this.x < 0) this.x += width;
                if (this.x > width) this.x -= width;
                if (this.y < 0) this.y += height;
                if (this.y > height) this.y -= height;

                // Update color based on audio
                this.hue = 30 + bass * 30 + mid * 20;
            }

            draw(overall) {
                // Draw trail
                for (let i = 0; i < this.trail.length; i++) {
                    const t = this.trail[i];
                    const alpha = (i / this.trail.length) * 0.4;
                    ctx.fillStyle = `hsla(${this.hue}, 80%, 50%, ${alpha})`;
                    ctx.beginPath();
                    ctx.arc(t.x, t.y, 2, 0, Math.PI * 2);
                    ctx.fill();
                }

                // Draw boid
                const angle = Math.atan2(this.vy, this.vx);
                const size = 5 + overall * 3;

                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(angle);

                ctx.fillStyle = `hsl(${this.hue}, 80%, 60%)`;
                ctx.beginPath();
                ctx.moveTo(size, 0);
                ctx.lineTo(-size * 0.7, -size * 0.5);
                ctx.lineTo(-size * 0.4, 0);
                ctx.lineTo(-size * 0.7, size * 0.5);
                ctx.closePath();
                ctx.fill();

                // Glow effect
                ctx.fillStyle = `hsla(${this.hue}, 100%, 70%, 0.3)`;
                ctx.beginPath();
                ctx.arc(0, 0, size * 1.5, 0, Math.PI * 2);
                ctx.fill();

                ctx.restore();
            }
        }

        function initBoids() {
            boids = [];
            for (let i = 0; i < boidCount; i++) {
                boids.push(new Boid());
            }
        }

        document.getElementById('startBtn').addEventListener('click', async function() {
            if (audioStarted) return;

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                dataArray = new Uint8Array(analyser.frequencyBinCount);

                source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);

                audioStarted = true;
                this.textContent = 'Audio Active';
                this.disabled = true;
            } catch (err) {
                console.error('Audio error:', err);
                this.textContent = 'Audio Failed';
            }
        });

        // UI
        document.getElementById('count').addEventListener('input', (e) => {
            boidCount = parseInt(e.target.value);
            document.getElementById('countVal').textContent = boidCount;
            initBoids();
        });

        document.getElementById('influence').addEventListener('input', (e) => {
            audioInfluence = parseFloat(e.target.value);
            document.getElementById('influenceVal').textContent = audioInfluence.toFixed(1);
        });

        document.getElementById('speed').addEventListener('input', (e) => {
            maxSpeed = parseFloat(e.target.value);
            document.getElementById('speedVal').textContent = maxSpeed;
        });

        document.getElementById('trail').addEventListener('input', (e) => {
            trailLength = parseInt(e.target.value);
            document.getElementById('trailVal').textContent = trailLength;
        });

        window.addEventListener('resize', resize);

        function draw() {
            // Fade effect
            ctx.fillStyle = 'rgba(10, 10, 26, 0.2)';
            ctx.fillRect(0, 0, width, height);

            // Get audio data
            let bass = 0, mid = 0, high = 0;
            if (audioStarted && analyser) {
                analyser.getByteFrequencyData(dataArray);

                const len = dataArray.length;
                for (let i = 0; i < len / 3; i++) bass += dataArray[i];
                for (let i = len / 3; i < 2 * len / 3; i++) mid += dataArray[i];
                for (let i = 2 * len / 3; i < len; i++) high += dataArray[i];

                bass = bass / (len / 3) / 255;
                mid = mid / (len / 3) / 255;
                high = high / (len / 3) / 255;
            }

            const overall = (bass + mid + high) / 3;

            // Update and draw boids
            for (const boid of boids) {
                boid.update(bass, mid, high);
                boid.draw(overall);
            }

            // Update stats
            document.getElementById('bassLevel').textContent = Math.round(bass * 100);
            document.getElementById('midLevel').textContent = Math.round(mid * 100);
            document.getElementById('highLevel').textContent = Math.round(high * 100);

            requestAnimationFrame(draw);
        }

        resize();
        initBoids();
        draw();
    </script>
    <script src="../../assets/js/enhance.js" defer></script>
</body>
</html>
