<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Kick Drum Detector</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; display: flex; align-items: center; justify-content: center; height: 100vh; }
        canvas { display: block; }
        .controls { position: absolute; top: 20px; left: 20px; color: white; background: rgba(0,0,0,0.7); padding: 15px; border-radius: 10px; }
        button { background: #FF5722; color: white; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; border-radius: 5px; }
        .beat-indicator { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 200px; border-radius: 50%; background: rgba(255,0,0,0.1); transition: all 0.1s; }
        .beat-indicator.active { background: rgba(255,0,0,0.8); box-shadow: 0 0 100px rgba(255,0,0,0.8); }
    </style>
</head>
<body>
    <div class="controls">
        <h2>Kick Drum Detector</h2>
        <input type="file" id="audioFile" accept="audio/*"><br>
        <button id="playBtn">Play</button><button id="pauseBtn">Pause</button>
        <div id="bpmDisplay" style="margin-top: 10px;">BPM: --</div>
    </div>
    <div class="beat-indicator" id="beatIndicator"></div>
    <canvas id="canvas"></canvas>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let audioContext, analyser, dataArray, bufferLength, source, audio;
        let beatThreshold = 1.3;
        let beatCutOff = 0;
        let beatTime = 0;
        const beatIndicator = document.getElementById('beatIndicator');
        const bpmDisplay = document.getElementById('bpmDisplay');
        let beatTimes = [];

        document.getElementById('audioFile').addEventListener('change', e => {
            if (e.target.files[0]) initAudio(URL.createObjectURL(e.target.files[0]));
        });
        document.getElementById('playBtn').addEventListener('click', () => {
            if (audio) { audio.play(); if (!audioContext) setupAudioContext(); visualize(); }
        });
        document.getElementById('pauseBtn').addEventListener('click', () => { if (audio) audio.pause(); });

        function initAudio(url) {
            if (audio) audio.pause();
            audio = new Audio(url); audio.loop = true;
            if (!audioContext) setupAudioContext();
            else {
                if (source) source.disconnect();
                source = audioContext.createMediaElementSource(audio);
                source.connect(analyser); analyser.connect(audioContext.destination);
            }
        }

        function setupAudioContext() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 512;
            bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);
            if (audio) {
                source = audioContext.createMediaElementSource(audio);
                source.connect(analyser); analyser.connect(audioContext.destination);
            }
        }

        function detectBeat() {
            // Analyze low frequencies (bass/kick)
            let sum = 0;
            for (let i = 0; i < 10; i++) {
                sum += dataArray[i];
            }
            const average = sum / 10;

            if (average > beatThreshold && average > beatCutOff) {
                beatCutOff = average * 1.1;
                beatTime = 0;
                beatIndicator.classList.add('active');

                // Track BPM
                const now = Date.now();
                beatTimes.push(now);
                beatTimes = beatTimes.filter(t => now - t < 5000); // Keep last 5 seconds
                if (beatTimes.length > 2) {
                    const intervals = [];
                    for (let i = 1; i < beatTimes.length; i++) {
                        intervals.push(beatTimes[i] - beatTimes[i-1]);
                    }
                    const avgInterval = intervals.reduce((a,b) => a+b) / intervals.length;
                    const bpm = Math.round(60000 / avgInterval);
                    bpmDisplay.textContent = `BPM: ${bpm}`;
                }

                return true;
            } else {
                beatTime++;
                if (beatTime > 5) {
                    beatIndicator.classList.remove('active');
                }
                beatCutOff *= 0.95;
                beatCutOff = Math.max(beatCutOff, 1);
                return false;
            }
        }

        function visualize() {
            requestAnimationFrame(visualize);
            analyser.getByteFrequencyData(dataArray);

            ctx.fillStyle = 'rgba(0,0,0,0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const isBeat = detectBeat();

            // Visualize bass frequencies
            const barWidth = canvas.width / 50;
            for (let i = 0; i < 50; i++) {
                const value = dataArray[i];
                const barHeight = (value / 255) * canvas.height * 0.8;

                ctx.fillStyle = isBeat && i < 10 ? '#FF0000' : `hsl(${i * 7}, 100%, 50%)`;
                ctx.fillRect(i * barWidth, canvas.height - barHeight, barWidth - 2, barHeight);
            }
        }

        window.addEventListener('load', () => {
            setupAudioContext();
            const osc = audioContext.createOscillator(), gain = audioContext.createGain();
            osc.connect(gain); gain.connect(analyser); analyser.connect(audioContext.destination);
            osc.frequency.value = 60; gain.gain.value = 0.1; osc.start();
            visualize();
        });
    </script>
    <script src="../../assets/js/enhance.js" defer></script>
</body>
</html>
