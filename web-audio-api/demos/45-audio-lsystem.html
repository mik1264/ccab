<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio L-System - Audio-Visual Hybrid</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(to bottom, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            font-family: 'Segoe UI', system-ui, sans-serif;
            overflow: hidden;
        }
        #canvas { display: block; width: 100vw; height: 100vh; }
        .controls {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.85);
            padding: 20px;
            border-radius: 12px;
            z-index: 100;
            min-width: 280px;
        }
        h1 { font-size: 1.3em; margin-bottom: 5px; color: #66bb6a; }
        .subtitle { font-size: 0.85em; color: #888; margin-bottom: 15px; }
        .button-row { display: flex; gap: 10px; margin-bottom: 15px; }
        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            background: #66bb6a;
            color: #000;
            cursor: pointer;
            font-weight: 600;
        }
        button:hover { background: #4caf50; }
        button:disabled { background: #444; cursor: not-allowed; }
        .slider-group { margin-bottom: 12px; }
        .slider-group label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 0.85em;
            color: #aaa;
        }
        .slider-group input[type="range"] {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: #333;
            border-radius: 3px;
        }
        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #66bb6a;
            border-radius: 50%;
            cursor: pointer;
        }
        .stats {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #333;
            font-size: 0.85em;
            color: #888;
        }
        .back-link {
            position: fixed;
            top: 20px;
            right: 20px;
            color: #66bb6a;
            text-decoration: none;
            z-index: 100;
        }
        .info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
            max-width: 350px;
            font-size: 0.85em;
            color: #aaa;
            line-height: 1.5;
        }
        .info h3 { color: #66bb6a; margin-bottom: 8px; }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>

    <div class="controls">
        <h1>Audio L-System</h1>
        <p class="subtitle">Sound-Driven Plant Growth</p>

        <div class="button-row">
            <button id="startBtn">Start Audio</button>
            <button id="resetBtn">New Tree</button>
        </div>

        <div class="slider-group">
            <label>Growth Rate <span id="growthVal">1.0</span></label>
            <input type="range" id="growth" min="0.2" max="3" step="0.2" value="1">
        </div>

        <div class="slider-group">
            <label>Branch Angle <span id="angleVal">25</span>°</label>
            <input type="range" id="angle" min="10" max="45" step="5" value="25">
        </div>

        <div class="slider-group">
            <label>Length Decay <span id="decayVal">0.7</span></label>
            <input type="range" id="decay" min="0.5" max="0.9" step="0.05" value="0.7">
        </div>

        <div class="slider-group">
            <label>Sway Amount <span id="swayVal">1.0</span></label>
            <input type="range" id="sway" min="0" max="2" step="0.2" value="1">
        </div>

        <div class="stats">
            <div>Branches: <span id="branchCount">0</span></div>
            <div>Leaves: <span id="leafCount">0</span></div>
            <div>Growth: <span id="growthProgress">0</span>%</div>
        </div>
    </div>

    <a href="../index.html" class="back-link">← Back to Gallery</a>

    <div class="info">
        <h3>Sonic Flora</h3>
        <p>L-system tree that grows in response to audio.
        Low frequencies drive growth rate, mid frequencies
        control branching, high frequencies sway the leaves.</p>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let width, height;
        let audioContext, analyser, dataArray, source;
        let audioStarted = false;

        let growthRate = 1;
        let branchAngle = 25;
        let lengthDecay = 0.7;
        let swayAmount = 1;

        let tree = null;
        let time = 0;

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            width = canvas.width;
            height = canvas.height;
            if (!tree) resetTree();
        }

        class Branch {
            constructor(parent, angle, length, depth) {
                this.parent = parent;
                this.angle = angle;
                this.length = length;
                this.depth = depth;
                this.growth = 0;
                this.children = [];
                this.hasLeaves = depth >= 4;
                this.leafSize = 0;
                this.swayOffset = Math.random() * Math.PI * 2;
            }

            getStart() {
                if (!this.parent) {
                    return { x: width / 2, y: height - 50 };
                }
                return this.parent.getEnd();
            }

            getEnd() {
                const start = this.getStart();
                const actualLength = this.length * Math.min(1, this.growth);
                return {
                    x: start.x + Math.sin(this.angle) * actualLength,
                    y: start.y - Math.cos(this.angle) * actualLength
                };
            }

            grow(delta, bass, mid) {
                if (this.growth < 1) {
                    this.growth += delta * (0.5 + bass * 2);
                    this.growth = Math.min(1, this.growth);
                } else if (this.hasLeaves && this.leafSize < 1) {
                    this.leafSize += delta * (0.3 + mid);
                    this.leafSize = Math.min(1, this.leafSize);
                }

                // Spawn children at 50% growth
                if (this.growth >= 0.5 && this.children.length === 0 && this.depth < 7) {
                    const newLength = this.length * lengthDecay;
                    const angleVar = (branchAngle + (Math.random() - 0.5) * 10) * Math.PI / 180;

                    // Main branches based on mid frequencies
                    if (Math.random() < 0.4 + mid * 0.4) {
                        this.children.push(new Branch(this, this.angle - angleVar, newLength, this.depth + 1));
                    }
                    if (Math.random() < 0.4 + mid * 0.4) {
                        this.children.push(new Branch(this, this.angle + angleVar, newLength, this.depth + 1));
                    }
                    // Sometimes straight branch
                    if (Math.random() < 0.3) {
                        this.children.push(new Branch(this, this.angle + (Math.random() - 0.5) * 0.2, newLength * 0.9, this.depth + 1));
                    }
                }

                for (const child of this.children) {
                    child.grow(delta, bass, mid);
                }
            }

            draw(high, time) {
                const start = this.getStart();
                const end = this.getEnd();

                if (this.growth <= 0) return;

                // Sway based on high frequencies
                const sway = Math.sin(time * 2 + this.swayOffset + this.depth * 0.5) * high * swayAmount * 2;
                const swayedEnd = {
                    x: end.x + sway * this.depth,
                    y: end.y
                };

                // Draw branch
                const thickness = Math.max(1, (8 - this.depth) * 1.5);
                const gradient = ctx.createLinearGradient(start.x, start.y, swayedEnd.x, swayedEnd.y);
                gradient.addColorStop(0, `hsl(25, 40%, ${20 + this.depth * 3}%)`);
                gradient.addColorStop(1, `hsl(25, 35%, ${25 + this.depth * 4}%)`);

                ctx.strokeStyle = gradient;
                ctx.lineWidth = thickness;
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(start.x, start.y);
                ctx.lineTo(swayedEnd.x, swayedEnd.y);
                ctx.stroke();

                // Draw leaves
                if (this.hasLeaves && this.leafSize > 0) {
                    const leafHue = 100 + high * 30;
                    ctx.fillStyle = `hsla(${leafHue}, 60%, 40%, ${0.7 + high * 0.3})`;

                    const leafRadius = 8 * this.leafSize;
                    for (let i = 0; i < 3; i++) {
                        const leafAngle = this.angle + (i - 1) * 0.5 + sway * 0.1;
                        const lx = swayedEnd.x + Math.cos(leafAngle) * leafRadius;
                        const ly = swayedEnd.y + Math.sin(leafAngle) * leafRadius * 0.6;

                        ctx.beginPath();
                        ctx.ellipse(lx, ly, leafRadius, leafRadius * 0.5, leafAngle, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }

                // Draw children with updated end position
                for (const child of this.children) {
                    // Update child's parent end position for sway
                    child.draw(high, time);
                }
            }

            count() {
                let branches = 1;
                let leaves = this.hasLeaves && this.leafSize > 0 ? 3 : 0;
                for (const child of this.children) {
                    const c = child.count();
                    branches += c.branches;
                    leaves += c.leaves;
                }
                return { branches, leaves };
            }

            maxGrowth() {
                let total = this.growth;
                let count = 1;
                for (const child of this.children) {
                    const c = child.maxGrowth();
                    total += c.total;
                    count += c.count;
                }
                return { total, count };
            }
        }

        function resetTree() {
            const initialLength = height * 0.15;
            tree = new Branch(null, 0, initialLength, 0);
            tree.growth = 1; // Trunk starts grown
        }

        document.getElementById('startBtn').addEventListener('click', async function() {
            if (audioStarted) return;

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                dataArray = new Uint8Array(analyser.frequencyBinCount);

                source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);

                audioStarted = true;
                this.textContent = 'Audio Active';
                this.disabled = true;
            } catch (err) {
                console.error('Audio error:', err);
                this.textContent = 'Audio Failed';
            }
        });

        document.getElementById('resetBtn').addEventListener('click', resetTree);

        // UI
        document.getElementById('growth').addEventListener('input', (e) => {
            growthRate = parseFloat(e.target.value);
            document.getElementById('growthVal').textContent = growthRate.toFixed(1);
        });

        document.getElementById('angle').addEventListener('input', (e) => {
            branchAngle = parseInt(e.target.value);
            document.getElementById('angleVal').textContent = branchAngle;
        });

        document.getElementById('decay').addEventListener('input', (e) => {
            lengthDecay = parseFloat(e.target.value);
            document.getElementById('decayVal').textContent = lengthDecay.toFixed(2);
        });

        document.getElementById('sway').addEventListener('input', (e) => {
            swayAmount = parseFloat(e.target.value);
            document.getElementById('swayVal').textContent = swayAmount.toFixed(1);
        });

        window.addEventListener('resize', resize);

        function draw() {
            // Sky gradient
            const skyGradient = ctx.createLinearGradient(0, 0, 0, height);
            skyGradient.addColorStop(0, '#1a1a2e');
            skyGradient.addColorStop(0.5, '#16213e');
            skyGradient.addColorStop(1, '#0f3460');
            ctx.fillStyle = skyGradient;
            ctx.fillRect(0, 0, width, height);

            // Stars
            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            for (let i = 0; i < 50; i++) {
                const x = (i * 137.508) % width;
                const y = (i * 73.3) % (height * 0.5);
                ctx.beginPath();
                ctx.arc(x, y, 1, 0, Math.PI * 2);
                ctx.fill();
            }

            // Ground
            ctx.fillStyle = '#1a3f1a';
            ctx.fillRect(0, height - 50, width, 50);

            // Get audio data
            let bass = 0, mid = 0, high = 0;
            if (audioStarted && analyser) {
                analyser.getByteFrequencyData(dataArray);

                const len = dataArray.length;
                for (let i = 0; i < len / 3; i++) bass += dataArray[i];
                for (let i = len / 3; i < 2 * len / 3; i++) mid += dataArray[i];
                for (let i = 2 * len / 3; i < len; i++) high += dataArray[i];

                bass = bass / (len / 3) / 255;
                mid = mid / (len / 3) / 255;
                high = high / (len / 3) / 255;
            }

            time += 0.016;

            // Grow tree
            if (tree) {
                tree.grow(0.016 * growthRate, bass, mid);
                tree.draw(high, time);

                // Update stats
                const counts = tree.count();
                const growth = tree.maxGrowth();
                document.getElementById('branchCount').textContent = counts.branches;
                document.getElementById('leafCount').textContent = counts.leaves;
                document.getElementById('growthProgress').textContent = Math.round(growth.total / growth.count * 100);
            }

            requestAnimationFrame(draw);
        }

        resize();
        draw();
    </script>
</body>
</html>
