<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FM Synthesis Explorer</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: Arial; }
        canvas { display: block; }
        .controls { position: absolute; top: 20px; left: 20px; color: white; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; max-width: 300px; }
        button { background: #E91E63; color: white; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; border-radius: 5px; width: 100%; }
        .slider-group { margin: 10px 0; }
        .slider-group label { display: block; margin-bottom: 5px; }
        input[type="range"] { width: 100%; }
        .note-btn { display: inline-block; width: 60px; margin: 2px; background: #555; }
        .note-btn:active { background: #E91E63; }
    </style>
</head>
<body>
    <div class="controls">
        <h2>FM Synthesis Explorer</h2>
        <button id="startBtn">Start Audio</button>
        <div class="slider-group">
            <label>Modulation Index: <span id="modIndexVal">10</span></label>
            <input type="range" id="modIndex" min="0" max="50" value="10" step="0.1">
        </div>
        <div class="slider-group">
            <label>Harmonicity: <span id="harmVal">2</span></label>
            <input type="range" id="harmonicity" min="0.1" max="10" value="2" step="0.1">
        </div>
        <div class="slider-group">
            <label>Envelope Attack: <span id="attackVal">0.01</span></label>
            <input type="range" id="attack" min="0.001" max="1" value="0.01" step="0.001">
        </div>
        <div class="slider-group">
            <label>Envelope Release: <span id="releaseVal">0.5</span></label>
            <input type="range" id="release" min="0.01" max="2" value="0.5" step="0.01">
        </div>
        <div style="margin-top: 15px;">
            <button class="note-btn" data-note="C4">C4</button>
            <button class="note-btn" data-note="E4">E4</button>
            <button class="note-btn" data-note="G4">G4</button>
            <button class="note-btn" data-note="C5">C5</button>
        </div>
    </div>
    <canvas id="canvas"></canvas>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script>
        const canvas = document.getElementById('canvas'); const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;

        let fmSynth, analyser;
        let waveHistory = [];

        document.getElementById('startBtn').addEventListener('click', async () => {
            await Tone.start();

            fmSynth = new Tone.FMSynth({
                harmonicity: 2,
                modulationIndex: 10,
                envelope: { attack: 0.01, decay: 0.1, sustain: 0.5, release: 0.5 },
                modulation: { type: 'sine' },
                modulationEnvelope: { attack: 0.01, decay: 0.1, sustain: 0.5, release: 0.5 }
            }).toDestination();

            analyser = new Tone.Analyser('waveform', 2048);
            fmSynth.connect(analyser);

            document.getElementById('startBtn').textContent = 'Audio Started';
            animate();
        });

        document.getElementById('modIndex').addEventListener('input', e => {
            if (fmSynth) fmSynth.modulationIndex.value = parseFloat(e.target.value);
            document.getElementById('modIndexVal').textContent = e.target.value;
        });

        document.getElementById('harmonicity').addEventListener('input', e => {
            if (fmSynth) fmSynth.harmonicity.value = parseFloat(e.target.value);
            document.getElementById('harmVal').textContent = e.target.value;
        });

        document.getElementById('attack').addEventListener('input', e => {
            if (fmSynth) fmSynth.envelope.attack = parseFloat(e.target.value);
            document.getElementById('attackVal').textContent = e.target.value;
        });

        document.getElementById('release').addEventListener('input', e => {
            if (fmSynth) fmSynth.envelope.release = parseFloat(e.target.value);
            document.getElementById('releaseVal').textContent = e.target.value;
        });

        document.querySelectorAll('.note-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (fmSynth) {
                    fmSynth.triggerAttackRelease(btn.dataset.note, '8n');
                }
            });
        });

        function animate() {
            requestAnimationFrame(animate);
            if (!analyser) return;

            const values = analyser.getValue();

            ctx.fillStyle = 'rgba(0,0,0,0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Current waveform
            ctx.strokeStyle = '#E91E63';
            ctx.lineWidth = 2;
            ctx.shadowBlur = 10;
            ctx.shadowColor = '#E91E63';
            ctx.beginPath();

            const sliceWidth = canvas.width / values.length;
            let x = 0;

            for (let i = 0; i < values.length; i++) {
                const v = (values[i] + 1) / 2;
                const y = v * canvas.height;

                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);

                x += sliceWidth;
            }

            ctx.stroke();

            // Circular visualization
            const cx = canvas.width * 0.75, cy = canvas.height / 2;
            const radius = 150;

            ctx.strokeStyle = '#FF4081';
            ctx.lineWidth = 3;
            ctx.beginPath();

            for (let i = 0; i < values.length; i += 4) {
                const angle = (i / values.length) * Math.PI * 2;
                const r = radius + values[i] * 50;
                const px = cx + Math.cos(angle) * r;
                const py = cy + Math.sin(angle) * r;

                if (i === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            }

            ctx.closePath();
            ctx.stroke();
            ctx.shadowBlur = 0;
        }
    </script>
    <script src="../../assets/js/enhance.js" defer></script>
</body>
</html>
