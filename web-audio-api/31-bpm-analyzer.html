<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BPM Analyzer</title>
    <style>
        body { margin: 0; overflow: hidden; background: #0a0a0a; font-family: monospace; }
        canvas { display: block; }
        .controls { position: absolute; top: 20px; left: 20px; color: white; background: rgba(0,0,0,0.7); padding: 15px; border-radius: 10px; }
        button { background: #FFC107; color: black; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; border-radius: 5px; }
        .bpm-display { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 120px; color: #FFC107; text-shadow: 0 0 20px #FFC107; }
        .beat-graph { position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); width: 80%; height: 100px; border: 2px solid #FFC107; }
    </style>
</head>
<body>
    <div class="controls">
        <h2>BPM Analyzer</h2>
        <input type="file" id="audioFile" accept="audio/*"><br>
        <button id="playBtn">Play</button><button id="pauseBtn">Pause</button>
    </div>
    <div class="bpm-display" id="bpmDisplay">-- BPM</div>
    <canvas class="beat-graph" id="graph"></canvas>
    <canvas id="canvas"></canvas>
    <script>
        const canvas = document.getElementById('canvas'); const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        const graph = document.getElementById('graph'); const gctx = graph.getContext('2d');
        graph.width = window.innerWidth * 0.8; graph.height = 100;

        let audioContext, analyser, dataArray, bufferLength, source, audio;
        let beatTimes = [];
        let beatHistory = new Array(200).fill(0);

        document.getElementById('audioFile').addEventListener('change', e => {
            if (e.target.files[0]) initAudio(URL.createObjectURL(e.target.files[0]));
        });
        document.getElementById('playBtn').addEventListener('click', () => {
            if (audio) { audio.play(); if (!audioContext) setupAudioContext(); visualize(); }
        });
        document.getElementById('pauseBtn').addEventListener('click', () => { if (audio) audio.pause(); });

        function initAudio(url) {
            if (audio) audio.pause();
            audio = new Audio(url); audio.loop = true;
            if (!audioContext) setupAudioContext();
            else {
                if (source) source.disconnect();
                source = audioContext.createMediaElementSource(audio);
                source.connect(analyser); analyser.connect(audioContext.destination);
            }
        }

        function setupAudioContext() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser(); analyser.fftSize = 2048;
            bufferLength = analyser.frequencyBinCount; dataArray = new Uint8Array(bufferLength);
            if (audio) {
                source = audioContext.createMediaElementSource(audio);
                source.connect(analyser); analyser.connect(audioContext.destination);
            }
        }

        let threshold = 200, lastBeat = 0;
        function detectBeat() {
            let bass = 0;
            for (let i = 0; i < 10; i++) bass += dataArray[i];
            bass /= 10;

            if (bass > threshold && Date.now() - lastBeat > 200) {
                lastBeat = Date.now();
                beatTimes.push(lastBeat);
                beatTimes = beatTimes.filter(t => lastBeat - t < 10000);

                if (beatTimes.length > 3) {
                    const intervals = [];
                    for (let i = 1; i < beatTimes.length; i++) {
                        intervals.push(beatTimes[i] - beatTimes[i-1]);
                    }
                    const avgInterval = intervals.reduce((a,b) => a+b) / intervals.length;
                    const bpm = Math.round(60000 / avgInterval);
                    document.getElementById('bpmDisplay').textContent = `${bpm} BPM`;
                }
                return true;
            }
            return false;
        }

        function visualize() {
            requestAnimationFrame(visualize);
            analyser.getByteFrequencyData(dataArray);

            ctx.fillStyle = 'rgba(10,10,10,0.2)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const isBeat = detectBeat();
            beatHistory.shift(); beatHistory.push(isBeat ? 1 : 0);

            // Draw waveform
            const barWidth = canvas.width / bufferLength * 2;
            for (let i = 0; i < bufferLength; i++) {
                const height = (dataArray[i] / 255) * canvas.height * 0.5;
                ctx.fillStyle = i < 10 && isBeat ? '#FFC107' : '#333';
                ctx.fillRect(i * barWidth, canvas.height - height, barWidth - 1, height);
            }

            // Draw beat graph
            gctx.fillStyle = '#000'; gctx.fillRect(0, 0, graph.width, graph.height);
            gctx.strokeStyle = '#FFC107'; gctx.lineWidth = 2;
            gctx.beginPath();
            for (let i = 0; i < beatHistory.length; i++) {
                const x = (i / beatHistory.length) * graph.width;
                const y = graph.height - beatHistory[i] * graph.height;
                if (i === 0) gctx.moveTo(x, y);
                else gctx.lineTo(x, y);
            }
            gctx.stroke();
        }

        window.addEventListener('load', () => {
            setupAudioContext();
            const osc = audioContext.createOscillator(), gain = audioContext.createGain();
            osc.connect(gain); gain.connect(analyser); analyser.connect(audioContext.destination);
            osc.frequency.value = 60; gain.gain.value = 0.1; osc.start();
            visualize();
        });
    </script>
</body>
</html>
