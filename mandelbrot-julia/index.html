<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mandelbrot/Julia Set Explorer - CCAB</title>
    <link rel="stylesheet" href="../assets/css/navigation.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Spectral:ital,wght@0,400;0,600;1,400&family=Space+Mono:wght@400;700&display=swap');

        :root {
            /* Color scheme matching main index */
            --bg-primary: #0a0e1a;
            --bg-secondary: #111827;
            --text-primary: #e0e0ff;
            --text-secondary: #a0a0c0;
            --text-accent: #fbbf24;
            --theme-color: #667eea;

            /* Spacing */
            --spacing-xs: 0.5rem;
            --spacing-sm: 1rem;
            --spacing-md: 1.5rem;
            --spacing-lg: 2rem;
            --spacing-xl: 3rem;
            --spacing-2xl: 4rem;

            /* Typography */
            --font-display: 'Orbitron', sans-serif;
            --font-heading: 'Spectral', serif;
            --font-mono: 'Space Mono', monospace;
            --font-body: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;

            /* Layout */
            --max-width: 1600px;
            --header-height: 64px;

            /* Transitions */
            --transition-base: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background: linear-gradient(135deg, var(--bg-primary) 0%, #0f172a 50%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            padding: 20px;
            padding-top: calc(var(--header-height) + 20px);
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        h1 {
            font-family: var(--font-display);
            text-align: center;
            margin-bottom: 10px;
            font-size: clamp(2rem, 5vw, 3rem);
            background: linear-gradient(135deg, var(--theme-color) 0%, var(--text-accent) 50%, var(--theme-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tab {
            padding: 12px 24px;
            background: rgba(224, 224, 255, 0.1);
            border: 2px solid rgba(224, 224, 255, 0.2);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
            color: var(--text-primary);
        }

        .tab:hover {
            background: rgba(224, 224, 255, 0.2);
            transform: translateY(-2px);
        }

        .tab.active {
            background: linear-gradient(135deg, var(--theme-color) 0%, var(--text-accent) 100%);
            border-color: var(--theme-color);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .view {
            display: none;
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .view.active {
            display: block;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            justify-content: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        input[type="range"] {
            width: 150px;
        }

        select {
            width: 150px;
            padding: 8px;
            background: rgba(224, 224, 255, 0.1);
            border: 1px solid rgba(224, 224, 255, 0.2);
            border-radius: 5px;
            color: var(--text-primary);
            font-size: 1em;
            cursor: pointer;
        }

        select option {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        button {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--theme-color) 0%, var(--text-accent) 100%);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background: rgba(224, 224, 255, 0.1);
            border: 1px solid rgba(224, 224, 255, 0.2);
        }

        .canvas-wrapper {
            position: relative;
            display: inline-block;
            margin: 20px auto;
            display: flex;
            justify-content: center;
        }

        canvas {
            display: block;
            background: #000;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            cursor: crosshair;
            max-width: 100%;
        }

        canvas.rendering {
            cursor: wait;
        }

        .stats-panel {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--theme-color);
            font-family: var(--font-mono);
        }

        .stat-label {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .info-box {
            background: rgba(102, 126, 234, 0.1);
            border-left: 4px solid var(--theme-color);
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .info-box h3 {
            margin-bottom: 10px;
            color: var(--theme-color);
        }

        .info-box ul {
            margin-left: 20px;
            line-height: 1.8;
        }

        .preset-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin: 15px 0;
        }

        .preset-btn {
            padding: 8px 16px;
            background: rgba(224, 224, 255, 0.1);
            border: 1px solid rgba(224, 224, 255, 0.2);
            border-radius: 5px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .preset-btn:hover {
            background: rgba(224, 224, 255, 0.2);
        }

        .preset-btn.featured {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            border-color: #ff6b6b;
        }

        .julia-hint {
            text-align: center;
            color: var(--text-accent);
            font-style: italic;
            margin: 10px 0;
            font-size: 0.95em;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.8);
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }

            .tabs {
                font-size: 0.9em;
            }

            .tab {
                padding: 8px 16px;
            }

            input[type="range"], select {
                width: 120px;
            }
        }
    
        /* Organic Nature Back Link */
        .organic-back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 10000;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: #BC6C25;
            text-decoration: none;
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 600;
            padding: 0.5rem 1rem;
            background: rgba(254, 250, 224, 0.95);
            border-radius: 20px;
            border: 2px solid rgba(138, 154, 91, 0.3);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(96, 108, 56, 0.15);
        }
        .organic-back-link:hover {
            background: rgba(254, 250, 224, 1);
            transform: translateX(-5px);
            border-color: #DDA15E;
            box-shadow: 0 6px 20px rgba(96, 108, 56, 0.25);
        }

    </style>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>

    <!-- Navigation Header -->
    <nav class="ccab-nav">
        <div class="nav-container">
            <div class="nav-breadcrumb"></div>
        </div>
    </nav>

    <div class="container">
        <h1>Mandelbrot/Julia Set Explorer</h1>
        <p class="subtitle">Journey into the Infinite Beauty of Complex Dynamics</p>

        <div class="tabs">
            <div class="tab active" data-view="mandelbrot">Mandelbrot Set</div>
            <div class="tab" data-view="julia">Julia Sets</div>
            <div class="tab" data-view="orbit-trap">Orbit Traps</div>
        </div>

        <!-- Mandelbrot View -->
        <div class="view active" id="mandelbrot">
            <div class="info-box">
                <h3>The Mandelbrot Set</h3>
                <p>The Mandelbrot set is the set of complex numbers c for which the iterative function z = z² + c does not diverge when starting from z = 0. Discovered by Benoit Mandelbrot in 1980, it reveals infinite complexity at every scale.</p>
                <ul>
                    <li><strong>Zoom:</strong> Use mouse wheel or pinch to zoom in/out</li>
                    <li><strong>Pan:</strong> Click and drag to move around</li>
                    <li><strong>Self-Similarity:</strong> Zoom in anywhere to discover infinite detail</li>
                    <li><strong>Fractal Dimension:</strong> The boundary has dimension ~2, between a line and a plane</li>
                    <li><strong>Connected Set:</strong> Despite appearances, the Mandelbrot set is a single connected shape</li>
                </ul>
            </div>

            <div class="preset-buttons">
                <button class="preset-btn featured" onclick="resetMandelbrotView()">Reset View</button>
                <button class="preset-btn" onclick="zoomToLocation(-0.7, 0, 1.5)">Main Body</button>
                <button class="preset-btn" onclick="zoomToLocation(-0.75, 0.1, 0.05)">Spiral</button>
                <button class="preset-btn" onclick="zoomToLocation(-0.16, 1.0405, 0.012)">Seahorse Valley</button>
                <button class="preset-btn" onclick="zoomToLocation(0.285, 0.01, 0.03)">Mini-Mandelbrot</button>
                <button class="preset-btn" onclick="zoomToLocation(-0.743643, 0.131825, 0.000014)">Deep Zoom</button>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label for="mandelbrotIterations">Max Iterations: <span id="mandelbrotIterVal">256</span></label>
                    <input type="range" id="mandelbrotIterations" min="50" max="2000" value="256" step="50">
                </div>
                <div class="control-group">
                    <label for="mandelbrotPalette">Color Palette:</label>
                    <select id="mandelbrotPalette">
                        <option value="rainbow">Rainbow</option>
                        <option value="fire">Fire</option>
                        <option value="ocean">Ocean</option>
                        <option value="grayscale">Grayscale</option>
                        <option value="psychedelic">Psychedelic</option>
                        <option value="ice">Ice</option>
                        <option value="sunset">Sunset</option>
                    </select>
                </div>
                <button onclick="saveMandelbrotImage()">Save Image</button>
                <button class="secondary" onclick="renderMandelbrot()">Re-render</button>
            </div>

            <div class="canvas-wrapper">
                <canvas id="mandelbrotCanvas" width="800" height="600"></canvas>
            </div>

            <div class="stats-panel">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="mandelbrotZoom">1.0x</div>
                        <div class="stat-label">Zoom Level</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="mandelbrotCenterX">0.0</div>
                        <div class="stat-label">Center X</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="mandelbrotCenterY">0.0</div>
                        <div class="stat-label">Center Y</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="mandelbrotIter">256</div>
                        <div class="stat-label">Iterations</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Julia Set View -->
        <div class="view" id="julia">
            <div class="info-box">
                <h3>Julia Sets</h3>
                <p>Julia sets are closely related to the Mandelbrot set. For each point c in the complex plane, there's a unique Julia set. Points in the Mandelbrot set have connected Julia sets, while points outside have disconnected "Fatou dust" Julia sets.</p>
                <ul>
                    <li><strong>Parameter c:</strong> Each c value creates a different Julia set</li>
                    <li><strong>Algorithm:</strong> z = z² + c, starting with z = (pixel position)</li>
                    <li><strong>Animation:</strong> Watch the Julia set morph as c changes</li>
                    <li><strong>Connection:</strong> Points in the Mandelbrot set produce connected Julia sets</li>
                </ul>
            </div>

            <p class="julia-hint">Click the "Set from Mandelbrot" button, then click on the Mandelbrot tab and click any point to set c!</p>

            <div class="preset-buttons">
                <button class="preset-btn featured" onclick="setJuliaC(-0.7, 0.27015)">Dendrite</button>
                <button class="preset-btn featured" onclick="setJuliaC(-0.4, 0.6)">Spiral</button>
                <button class="preset-btn" onclick="setJuliaC(0.285, 0.01)">Mini-Mandelbrot</button>
                <button class="preset-btn" onclick="setJuliaC(-0.8, 0.156)">Lightning</button>
                <button class="preset-btn" onclick="setJuliaC(-0.70176, -0.3842)">Dragon</button>
                <button class="preset-btn" onclick="setJuliaC(0.3, 0.5)">Dust</button>
                <button class="preset-btn" onclick="toggleJuliaAnimation()">
                    <span id="animToggleText">Start Animation</span>
                </button>
                <button class="preset-btn secondary" onclick="juliaPickerMode()">
                    <span id="pickerToggleText">Set from Mandelbrot</span>
                </button>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label for="juliaCReal">c Real: <span id="juliaCRealVal">-0.7</span></label>
                    <input type="range" id="juliaCReal" min="-1.5" max="1.5" value="-0.7" step="0.001">
                </div>
                <div class="control-group">
                    <label for="juliaCImag">c Imaginary: <span id="juliaCImagVal">0.27015</span></label>
                    <input type="range" id="juliaCImag" min="-1.5" max="1.5" value="0.27015" step="0.001">
                </div>
                <div class="control-group">
                    <label for="juliaIterations">Max Iterations: <span id="juliaIterVal">256</span></label>
                    <input type="range" id="juliaIterations" min="50" max="2000" value="256" step="50">
                </div>
                <div class="control-group">
                    <label for="juliaPalette">Color Palette:</label>
                    <select id="juliaPalette">
                        <option value="rainbow">Rainbow</option>
                        <option value="fire">Fire</option>
                        <option value="ocean">Ocean</option>
                        <option value="grayscale">Grayscale</option>
                        <option value="psychedelic">Psychedelic</option>
                        <option value="ice">Ice</option>
                        <option value="sunset">Sunset</option>
                    </select>
                </div>
                <button onclick="saveJuliaImage()">Save Image</button>
            </div>

            <div class="canvas-wrapper">
                <canvas id="juliaCanvas" width="800" height="600"></canvas>
            </div>

            <div class="stats-panel">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="juliaCReal2">-0.70</div>
                        <div class="stat-label">c Real</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="juliaCImag2">0.27015</div>
                        <div class="stat-label">c Imaginary</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="juliaIter">256</div>
                        <div class="stat-label">Iterations</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="juliaType">Connected</div>
                        <div class="stat-label">Set Type</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Orbit Trap View -->
        <div class="view" id="orbit-trap">
            <div class="info-box">
                <h3>Orbit Trap Rendering</h3>
                <p>Instead of coloring based on escape iteration, orbit traps color pixels based on how close the orbit comes to specific shapes (like circles or lines). This creates unique and artistic visualizations of the same mathematical structures.</p>
                <ul>
                    <li><strong>Circle Trap:</strong> Colors based on distance to origin during iteration</li>
                    <li><strong>Cross Trap:</strong> Colors based on proximity to x or y axes</li>
                    <li><strong>Line Trap:</strong> Measures distance to a diagonal line</li>
                    <li><strong>Point Trap:</strong> Distance to a specific point in the complex plane</li>
                </ul>
            </div>

            <div class="preset-buttons">
                <button class="preset-btn featured" onclick="setTrapMode('circle')">Circle Trap</button>
                <button class="preset-btn featured" onclick="setTrapMode('cross')">Cross Trap</button>
                <button class="preset-btn" onclick="setTrapMode('line')">Line Trap</button>
                <button class="preset-btn" onclick="setTrapMode('point')">Point Trap</button>
                <button class="preset-btn" onclick="setTrapMode('square')">Square Trap</button>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label for="trapIterations">Max Iterations: <span id="trapIterVal">256</span></label>
                    <input type="range" id="trapIterations" min="50" max="2000" value="256" step="50">
                </div>
                <div class="control-group">
                    <label for="trapRadius">Trap Size: <span id="trapRadiusVal">0.5</span></label>
                    <input type="range" id="trapRadius" min="0.1" max="2.0" value="0.5" step="0.1">
                </div>
                <div class="control-group">
                    <label for="trapPalette">Color Palette:</label>
                    <select id="trapPalette">
                        <option value="rainbow">Rainbow</option>
                        <option value="fire">Fire</option>
                        <option value="ocean">Ocean</option>
                        <option value="grayscale">Grayscale</option>
                        <option value="psychedelic">Psychedelic</option>
                        <option value="ice">Ice</option>
                        <option value="sunset">Sunset</option>
                    </select>
                </div>
                <button onclick="resetTrapView()">Reset View</button>
                <button onclick="saveTrapImage()">Save Image</button>
            </div>

            <div class="canvas-wrapper">
                <canvas id="trapCanvas" width="800" height="600"></canvas>
            </div>

            <div class="stats-panel">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="trapMode">Circle</div>
                        <div class="stat-label">Trap Type</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="trapSize">0.5</div>
                        <div class="stat-label">Trap Size</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="trapIter">256</div>
                        <div class="stat-label">Iterations</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="trapZoom">1.0x</div>
                        <div class="stat-label">Zoom Level</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== MANDELBROT SET ====================
        const mandelbrotCanvas = document.getElementById('mandelbrotCanvas');
        const mandelbrotCtx = mandelbrotCanvas.getContext('2d');

        let mandelbrotState = {
            centerX: -0.5,
            centerY: 0,
            zoom: 1,
            maxIter: 256,
            palette: 'rainbow',
            isDragging: false,
            dragStartX: 0,
            dragStartY: 0,
            dragStartCenterX: 0,
            dragStartCenterY: 0
        };

        function resetMandelbrotView() {
            mandelbrotState.centerX = -0.5;
            mandelbrotState.centerY = 0;
            mandelbrotState.zoom = 1;
            renderMandelbrot();
        }

        function zoomToLocation(x, y, range) {
            mandelbrotState.centerX = x;
            mandelbrotState.centerY = y;
            mandelbrotState.zoom = 3.5 / range;
            renderMandelbrot();
        }

        function renderMandelbrot(lowRes = false) {
            const width = mandelbrotCanvas.width;
            const height = mandelbrotCanvas.height;
            const imageData = mandelbrotCtx.createImageData(width, height);
            const data = imageData.data;

            const range = 3.5 / mandelbrotState.zoom;
            const xMin = mandelbrotState.centerX - range / 2;
            const yMin = mandelbrotState.centerY - range * height / width / 2;
            const xMax = mandelbrotState.centerX + range / 2;
            const yMax = mandelbrotState.centerY + range * height / width / 2;

            const step = lowRes ? 4 : 1;

            for (let py = 0; py < height; py += step) {
                for (let px = 0; px < width; px += step) {
                    const x0 = xMin + (px / width) * (xMax - xMin);
                    const y0 = yMin + (py / height) * (yMax - yMin);

                    let x = 0, y = 0, iter = 0;
                    while (x * x + y * y <= 4 && iter < mandelbrotState.maxIter) {
                        const xTemp = x * x - y * y + x0;
                        y = 2 * x * y + y0;
                        x = xTemp;
                        iter++;
                    }

                    // Smooth coloring
                    let color;
                    if (iter === mandelbrotState.maxIter) {
                        color = { r: 0, g: 0, b: 0 };
                    } else {
                        const smoothIter = iter + 1 - Math.log2(Math.log2(x * x + y * y));
                        color = getColor(smoothIter, mandelbrotState.maxIter, mandelbrotState.palette);
                    }

                    // Fill pixels
                    for (let dy = 0; dy < step && py + dy < height; dy++) {
                        for (let dx = 0; dx < step && px + dx < width; dx++) {
                            const i = ((py + dy) * width + (px + dx)) * 4;
                            data[i] = color.r;
                            data[i + 1] = color.g;
                            data[i + 2] = color.b;
                            data[i + 3] = 255;
                        }
                    }
                }
            }

            mandelbrotCtx.putImageData(imageData, 0, 0);
            updateMandelbrotStats();
        }

        function updateMandelbrotStats() {
            document.getElementById('mandelbrotZoom').textContent = mandelbrotState.zoom.toFixed(1) + 'x';
            document.getElementById('mandelbrotCenterX').textContent = mandelbrotState.centerX.toFixed(6);
            document.getElementById('mandelbrotCenterY').textContent = mandelbrotState.centerY.toFixed(6);
            document.getElementById('mandelbrotIter').textContent = mandelbrotState.maxIter;
        }

        // Mouse controls for Mandelbrot
        mandelbrotCanvas.addEventListener('mousedown', (e) => {
            if (juliaPickerActive) {
                const rect = mandelbrotCanvas.getBoundingClientRect();
                const px = e.clientX - rect.left;
                const py = e.clientY - rect.top;

                const range = 3.5 / mandelbrotState.zoom;
                const xMin = mandelbrotState.centerX - range / 2;
                const yMin = mandelbrotState.centerY - range * mandelbrotCanvas.height / mandelbrotCanvas.width / 2;
                const xMax = mandelbrotState.centerX + range / 2;
                const yMax = mandelbrotState.centerY + range * mandelbrotCanvas.height / mandelbrotCanvas.width / 2;

                const cReal = xMin + (px / mandelbrotCanvas.width) * (xMax - xMin);
                const cImag = yMin + (py / mandelbrotCanvas.height) * (yMax - yMin);

                setJuliaC(cReal, cImag);
                juliaPickerActive = false;
                document.getElementById('pickerToggleText').textContent = 'Set from Mandelbrot';
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.querySelector('[data-view="julia"]').classList.add('active');
                document.getElementById('julia').classList.add('active');
                return;
            }

            mandelbrotState.isDragging = true;
            mandelbrotState.dragStartX = e.clientX;
            mandelbrotState.dragStartY = e.clientY;
            mandelbrotState.dragStartCenterX = mandelbrotState.centerX;
            mandelbrotState.dragStartCenterY = mandelbrotState.centerY;
            mandelbrotCanvas.style.cursor = 'grabbing';
        });

        mandelbrotCanvas.addEventListener('mousemove', (e) => {
            if (!mandelbrotState.isDragging) return;

            const dx = e.clientX - mandelbrotState.dragStartX;
            const dy = e.clientY - mandelbrotState.dragStartY;

            const range = 3.5 / mandelbrotState.zoom;
            const scaleX = range / mandelbrotCanvas.width;
            const scaleY = range * mandelbrotCanvas.height / mandelbrotCanvas.width / mandelbrotCanvas.height;

            mandelbrotState.centerX = mandelbrotState.dragStartCenterX - dx * scaleX;
            mandelbrotState.centerY = mandelbrotState.dragStartCenterY - dy * scaleY;

            renderMandelbrot(true);
        });

        mandelbrotCanvas.addEventListener('mouseup', () => {
            if (mandelbrotState.isDragging) {
                mandelbrotState.isDragging = false;
                mandelbrotCanvas.style.cursor = 'crosshair';
                renderMandelbrot();
            }
        });

        mandelbrotCanvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const zoomFactor = e.deltaY < 0 ? 1.2 : 0.8;
            mandelbrotState.zoom *= zoomFactor;
            renderMandelbrot();
        });

        document.getElementById('mandelbrotIterations').addEventListener('input', (e) => {
            mandelbrotState.maxIter = parseInt(e.target.value);
            document.getElementById('mandelbrotIterVal').textContent = mandelbrotState.maxIter;
            renderMandelbrot();
        });

        document.getElementById('mandelbrotPalette').addEventListener('change', (e) => {
            mandelbrotState.palette = e.target.value;
            renderMandelbrot();
        });

        function saveMandelbrotImage() {
            const link = document.createElement('a');
            link.download = `mandelbrot_z${mandelbrotState.zoom.toFixed(0)}.png`;
            link.href = mandelbrotCanvas.toDataURL();
            link.click();
        }

        // ==================== JULIA SET ====================
        const juliaCanvas = document.getElementById('juliaCanvas');
        const juliaCtx = juliaCanvas.getContext('2d');

        let juliaState = {
            cReal: -0.7,
            cImag: 0.27015,
            maxIter: 256,
            palette: 'rainbow',
            animating: false,
            animAngle: 0
        };

        let juliaPickerActive = false;

        function juliaPickerMode() {
            juliaPickerActive = !juliaPickerActive;
            if (juliaPickerActive) {
                document.getElementById('pickerToggleText').textContent = 'Cancel (Click Mandelbrot)';
                // Switch to Mandelbrot tab
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.querySelector('[data-view="mandelbrot"]').classList.add('active');
                document.getElementById('mandelbrot').classList.add('active');
            } else {
                document.getElementById('pickerToggleText').textContent = 'Set from Mandelbrot';
            }
        }

        function setJuliaC(real, imag) {
            juliaState.cReal = real;
            juliaState.cImag = imag;
            document.getElementById('juliaCReal').value = real;
            document.getElementById('juliaCImag').value = imag;
            document.getElementById('juliaCRealVal').textContent = real.toFixed(5);
            document.getElementById('juliaCImagVal').textContent = imag.toFixed(5);
            renderJulia();
        }

        function toggleJuliaAnimation() {
            juliaState.animating = !juliaState.animating;
            document.getElementById('animToggleText').textContent = juliaState.animating ? 'Stop Animation' : 'Start Animation';
            if (juliaState.animating) {
                animateJulia();
            }
        }

        function animateJulia() {
            if (!juliaState.animating) return;

            juliaState.animAngle += 0.01;
            const radius = 0.7885;
            juliaState.cReal = radius * Math.cos(juliaState.animAngle);
            juliaState.cImag = radius * Math.sin(juliaState.animAngle);

            document.getElementById('juliaCReal').value = juliaState.cReal;
            document.getElementById('juliaCImag').value = juliaState.cImag;
            document.getElementById('juliaCRealVal').textContent = juliaState.cReal.toFixed(5);
            document.getElementById('juliaCImagVal').textContent = juliaState.cImag.toFixed(5);

            renderJulia();
            requestAnimationFrame(animateJulia);
        }

        function renderJulia() {
            const width = juliaCanvas.width;
            const height = juliaCanvas.height;
            const imageData = juliaCtx.createImageData(width, height);
            const data = imageData.data;

            const range = 3.0;
            const xMin = -range / 2;
            const yMin = -range * height / width / 2;
            const xMax = range / 2;
            const yMax = range * height / width / 2;

            for (let py = 0; py < height; py++) {
                for (let px = 0; px < width; px++) {
                    let x = xMin + (px / width) * (xMax - xMin);
                    let y = yMin + (py / height) * (yMax - yMin);

                    let iter = 0;
                    while (x * x + y * y <= 4 && iter < juliaState.maxIter) {
                        const xTemp = x * x - y * y + juliaState.cReal;
                        y = 2 * x * y + juliaState.cImag;
                        x = xTemp;
                        iter++;
                    }

                    let color;
                    if (iter === juliaState.maxIter) {
                        color = { r: 0, g: 0, b: 0 };
                    } else {
                        const smoothIter = iter + 1 - Math.log2(Math.log2(x * x + y * y));
                        color = getColor(smoothIter, juliaState.maxIter, juliaState.palette);
                    }

                    const i = (py * width + px) * 4;
                    data[i] = color.r;
                    data[i + 1] = color.g;
                    data[i + 2] = color.b;
                    data[i + 3] = 255;
                }
            }

            juliaCtx.putImageData(imageData, 0, 0);
            updateJuliaStats();
        }

        function updateJuliaStats() {
            document.getElementById('juliaCReal2').textContent = juliaState.cReal.toFixed(5);
            document.getElementById('juliaCImag2').textContent = juliaState.cImag.toFixed(5);
            document.getElementById('juliaIter').textContent = juliaState.maxIter;

            // Determine if Julia set is likely connected (crude approximation)
            const dist = Math.sqrt(juliaState.cReal * juliaState.cReal + juliaState.cImag * juliaState.cImag);
            document.getElementById('juliaType').textContent = dist < 0.25 ? 'Connected' : 'Dust';
        }

        document.getElementById('juliaCReal').addEventListener('input', (e) => {
            juliaState.cReal = parseFloat(e.target.value);
            document.getElementById('juliaCRealVal').textContent = juliaState.cReal.toFixed(5);
            renderJulia();
        });

        document.getElementById('juliaCImag').addEventListener('input', (e) => {
            juliaState.cImag = parseFloat(e.target.value);
            document.getElementById('juliaCImagVal').textContent = juliaState.cImag.toFixed(5);
            renderJulia();
        });

        document.getElementById('juliaIterations').addEventListener('input', (e) => {
            juliaState.maxIter = parseInt(e.target.value);
            document.getElementById('juliaIterVal').textContent = juliaState.maxIter;
            renderJulia();
        });

        document.getElementById('juliaPalette').addEventListener('change', (e) => {
            juliaState.palette = e.target.value;
            renderJulia();
        });

        function saveJuliaImage() {
            const link = document.createElement('a');
            link.download = `julia_c${juliaState.cReal.toFixed(3)}_${juliaState.cImag.toFixed(3)}.png`;
            link.href = juliaCanvas.toDataURL();
            link.click();
        }

        // ==================== ORBIT TRAP ====================
        const trapCanvas = document.getElementById('trapCanvas');
        const trapCtx = trapCanvas.getContext('2d');

        let trapState = {
            centerX: -0.5,
            centerY: 0,
            zoom: 1,
            maxIter: 256,
            palette: 'rainbow',
            mode: 'circle',
            trapRadius: 0.5,
            isDragging: false,
            dragStartX: 0,
            dragStartY: 0,
            dragStartCenterX: 0,
            dragStartCenterY: 0
        };

        function setTrapMode(mode) {
            trapState.mode = mode;
            renderTrap();
        }

        function resetTrapView() {
            trapState.centerX = -0.5;
            trapState.centerY = 0;
            trapState.zoom = 1;
            renderTrap();
        }

        function renderTrap() {
            const width = trapCanvas.width;
            const height = trapCanvas.height;
            const imageData = trapCtx.createImageData(width, height);
            const data = imageData.data;

            const range = 3.5 / trapState.zoom;
            const xMin = trapState.centerX - range / 2;
            const yMin = trapState.centerY - range * height / width / 2;
            const xMax = trapState.centerX + range / 2;
            const yMax = trapState.centerY + range * height / width / 2;

            for (let py = 0; py < height; py++) {
                for (let px = 0; px < width; px++) {
                    const x0 = xMin + (px / width) * (xMax - xMin);
                    const y0 = yMin + (py / height) * (yMax - yMin);

                    let x = 0, y = 0, iter = 0;
                    let minDist = Infinity;

                    while (x * x + y * y <= 4 && iter < trapState.maxIter) {
                        const xTemp = x * x - y * y + x0;
                        y = 2 * x * y + y0;
                        x = xTemp;
                        iter++;

                        // Calculate distance to trap
                        let dist;
                        switch (trapState.mode) {
                            case 'circle':
                                dist = Math.abs(Math.sqrt(x * x + y * y) - trapState.trapRadius);
                                break;
                            case 'cross':
                                dist = Math.min(Math.abs(x), Math.abs(y));
                                break;
                            case 'line':
                                dist = Math.abs(x - y) / Math.sqrt(2);
                                break;
                            case 'point':
                                dist = Math.sqrt((x - trapState.trapRadius) * (x - trapState.trapRadius) + y * y);
                                break;
                            case 'square':
                                dist = Math.max(Math.abs(x), Math.abs(y)) - trapState.trapRadius;
                                dist = Math.abs(dist);
                                break;
                        }

                        minDist = Math.min(minDist, dist);
                    }

                    let color;
                    if (iter === trapState.maxIter) {
                        color = { r: 0, g: 0, b: 0 };
                    } else {
                        const value = Math.min(minDist * 50, trapState.maxIter);
                        color = getColor(value, trapState.maxIter, trapState.palette);
                    }

                    const i = (py * width + px) * 4;
                    data[i] = color.r;
                    data[i + 1] = color.g;
                    data[i + 2] = color.b;
                    data[i + 3] = 255;
                }
            }

            trapCtx.putImageData(imageData, 0, 0);
            updateTrapStats();
        }

        function updateTrapStats() {
            document.getElementById('trapMode').textContent = trapState.mode.charAt(0).toUpperCase() + trapState.mode.slice(1);
            document.getElementById('trapSize').textContent = trapState.trapRadius.toFixed(1);
            document.getElementById('trapIter').textContent = trapState.maxIter;
            document.getElementById('trapZoom').textContent = trapState.zoom.toFixed(1) + 'x';
        }

        // Mouse controls for Trap
        trapCanvas.addEventListener('mousedown', (e) => {
            trapState.isDragging = true;
            trapState.dragStartX = e.clientX;
            trapState.dragStartY = e.clientY;
            trapState.dragStartCenterX = trapState.centerX;
            trapState.dragStartCenterY = trapState.centerY;
            trapCanvas.style.cursor = 'grabbing';
        });

        trapCanvas.addEventListener('mousemove', (e) => {
            if (!trapState.isDragging) return;

            const dx = e.clientX - trapState.dragStartX;
            const dy = e.clientY - trapState.dragStartY;

            const range = 3.5 / trapState.zoom;
            const scaleX = range / trapCanvas.width;
            const scaleY = range * trapCanvas.height / trapCanvas.width / trapCanvas.height;

            trapState.centerX = trapState.dragStartCenterX - dx * scaleX;
            trapState.centerY = trapState.dragStartCenterY - dy * scaleY;

            renderTrap();
        });

        trapCanvas.addEventListener('mouseup', () => {
            if (trapState.isDragging) {
                trapState.isDragging = false;
                trapCanvas.style.cursor = 'crosshair';
            }
        });

        trapCanvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const zoomFactor = e.deltaY < 0 ? 1.2 : 0.8;
            trapState.zoom *= zoomFactor;
            renderTrap();
        });

        document.getElementById('trapIterations').addEventListener('input', (e) => {
            trapState.maxIter = parseInt(e.target.value);
            document.getElementById('trapIterVal').textContent = trapState.maxIter;
            renderTrap();
        });

        document.getElementById('trapRadius').addEventListener('input', (e) => {
            trapState.trapRadius = parseFloat(e.target.value);
            document.getElementById('trapRadiusVal').textContent = trapState.trapRadius.toFixed(1);
            renderTrap();
        });

        document.getElementById('trapPalette').addEventListener('change', (e) => {
            trapState.palette = e.target.value;
            renderTrap();
        });

        function saveTrapImage() {
            const link = document.createElement('a');
            link.download = `orbit_trap_${trapState.mode}.png`;
            link.href = trapCanvas.toDataURL();
            link.click();
        }

        // ==================== COLOR PALETTES ====================
        function getColor(iter, maxIter, palette) {
            const t = iter / maxIter;

            switch (palette) {
                case 'rainbow':
                    return {
                        r: Math.floor(Math.sin(0.016 * iter + 0) * 127 + 128),
                        g: Math.floor(Math.sin(0.016 * iter + 2) * 127 + 128),
                        b: Math.floor(Math.sin(0.016 * iter + 4) * 127 + 128)
                    };

                case 'fire':
                    if (t < 0.33) {
                        const t2 = t / 0.33;
                        return { r: Math.floor(t2 * 255), g: 0, b: 0 };
                    } else if (t < 0.66) {
                        const t2 = (t - 0.33) / 0.33;
                        return { r: 255, g: Math.floor(t2 * 255), b: 0 };
                    } else {
                        const t2 = (t - 0.66) / 0.34;
                        return { r: 255, g: 255, b: Math.floor(t2 * 255) };
                    }

                case 'ocean':
                    return {
                        r: Math.floor(t * 100),
                        g: Math.floor(t * 150 + 100),
                        b: Math.floor(t * 255)
                    };

                case 'grayscale':
                    const gray = Math.floor(t * 255);
                    return { r: gray, g: gray, b: gray };

                case 'psychedelic':
                    return {
                        r: Math.floor(Math.abs(Math.sin(iter * 0.1)) * 255),
                        g: Math.floor(Math.abs(Math.sin(iter * 0.2)) * 255),
                        b: Math.floor(Math.abs(Math.sin(iter * 0.3)) * 255)
                    };

                case 'ice':
                    return {
                        r: Math.floor(t * 200 + 55),
                        g: Math.floor(t * 255),
                        b: 255
                    };

                case 'sunset':
                    if (t < 0.5) {
                        const t2 = t / 0.5;
                        return { r: Math.floor(255 * (1 - t2 * 0.3)), g: Math.floor(100 * t2), b: Math.floor(150 * t2) };
                    } else {
                        const t2 = (t - 0.5) / 0.5;
                        return { r: Math.floor(180 + 75 * t2), g: Math.floor(100 + 155 * t2), b: Math.floor(150 + 105 * t2) };
                    }

                default:
                    return { r: 255, g: 255, b: 255 };
            }
        }

        // ==================== TAB SYSTEM ====================
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    // Stop Julia animation
                    juliaState.animating = false;
                    document.getElementById('animToggleText').textContent = 'Start Animation';

                    // Switch tabs
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.view).classList.add('active');
                });
            });
        }

        // ==================== INITIALIZATION ====================
        window.addEventListener('load', () => {
            setupTabs();
            renderMandelbrot();
            renderJulia();
            renderTrap();
        });
    </script>
    <script src="../assets/js/navigation.js"></script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
