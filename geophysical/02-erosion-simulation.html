<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hydraulic Erosion Simulation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0a0e1a;
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        #canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }

        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #8A9A5B;
            text-decoration: none;
            font-size: 18px;
            font-weight: 600;
            z-index: 100;
            background: rgba(10, 14, 26, 0.8);
            padding: 10px 20px;
            border-radius: 8px;
            border: 2px solid #8A9A5B;
            transition: all 0.3s;
        }

        .back-link:hover {
            background: #8A9A5B;
            color: #0a0e1a;
            transform: translateX(-5px);
        }

        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(10, 14, 26, 0.9);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #606C38;
            z-index: 100;
            max-width: 300px;
        }

        .controls h3 {
            color: #DDA15E;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            color: #8A9A5B;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .control-group input[type="range"] {
            width: 100%;
            cursor: pointer;
        }

        .control-group .value {
            color: #DDA15E;
            font-weight: bold;
            font-size: 14px;
        }

        button {
            background: #606C38;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            margin-top: 10px;
            transition: background 0.3s;
        }

        button:hover {
            background: #8A9A5B;
        }

        .info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(10, 14, 26, 0.9);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #BC6C25;
            max-width: 400px;
            z-index: 100;
        }

        .info h3 {
            color: #DDA15E;
            margin-bottom: 10px;
        }

        .info p {
            line-height: 1.6;
            font-size: 14px;
            color: #e0e0e0;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Geophysical</a>

    <canvas id="canvas"></canvas>

    <div class="controls">
        <h3>Erosion Controls</h3>

        <div class="control-group">
            <label>Rainfall: <span class="value" id="rainValue">50</span></label>
            <input type="range" id="rainfall" min="0" max="100" step="5" value="50">
        </div>

        <div class="control-group">
            <label>Erosion Rate: <span class="value" id="erosionValue">0.5</span></label>
            <input type="range" id="erosion" min="0" max="2" step="0.1" value="0.5">
        </div>

        <div class="control-group">
            <label>Sediment Capacity: <span class="value" id="sedimentValue">5</span></label>
            <input type="range" id="sediment" min="1" max="10" step="1" value="5">
        </div>

        <button id="resetBtn">Generate New Terrain</button>
        <button id="pauseBtn">Pause</button>
    </div>

    <div class="info">
        <h3>Hydraulic Erosion</h3>
        <p>Water droplets flow downhill, carrying sediment and carving valleys. Each droplet erodes material based on speed and deposits sediment when slowing down, creating realistic terrain features.</p>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let width, height;
        const gridSize = 200;
        let heightMap = [];
        let waterMap = [];

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        resize();
        window.addEventListener('resize', resize);

        // Generate initial terrain
        function generateTerrain() {
            heightMap = [];
            waterMap = [];

            for (let y = 0; y < gridSize; y++) {
                heightMap[y] = [];
                waterMap[y] = [];
                for (let x = 0; x < gridSize; x++) {
                    // Multi-octave noise approximation
                    let h = 0;
                    h += Math.sin(x * 0.05) * Math.cos(y * 0.05) * 20;
                    h += Math.sin(x * 0.1 + 10) * Math.cos(y * 0.1 + 10) * 10;
                    h += Math.sin(x * 0.2 + 20) * Math.cos(y * 0.2 + 20) * 5;
                    h += Math.random() * 3;

                    // Add some peaks
                    const dx1 = x - gridSize * 0.3;
                    const dy1 = y - gridSize * 0.3;
                    const dist1 = Math.sqrt(dx1 * dx1 + dy1 * dy1);
                    h += Math.max(0, 30 - dist1 * 0.3);

                    const dx2 = x - gridSize * 0.7;
                    const dy2 = y - gridSize * 0.7;
                    const dist2 = Math.sqrt(dx2 * dx2 + dy2 * dy2);
                    h += Math.max(0, 25 - dist2 * 0.4);

                    heightMap[y][x] = Math.max(0, h);
                    waterMap[y][x] = 0;
                }
            }
        }

        // Water droplet simulation
        class Droplet {
            constructor() {
                this.x = Math.random() * gridSize;
                this.y = Math.random() * gridSize;
                this.vx = 0;
                this.vy = 0;
                this.water = 1;
                this.sediment = 0;
                this.speed = 0;
                this.life = 50;
            }

            update(erosionRate, sedimentCapacity) {
                if (this.life <= 0 || this.water <= 0) return false;

                const x = Math.floor(this.x);
                const y = Math.floor(this.y);

                if (x < 1 || x >= gridSize - 1 || y < 1 || y >= gridSize - 1) {
                    return false;
                }

                // Calculate gradient
                const gx = (heightMap[y][x + 1] - heightMap[y][x - 1]) * 0.5;
                const gy = (heightMap[y + 1][x] - heightMap[y - 1][x]) * 0.5;

                // Update velocity
                this.vx = this.vx * 0.9 - gx * 0.1;
                this.vy = this.vy * 0.9 - gy * 0.1;

                // Calculate speed
                this.speed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);

                // Update position
                this.x += this.vx;
                this.y += this.vy;

                // Erosion and deposition
                const capacity = Math.max(0, this.speed * sedimentCapacity);

                if (capacity > this.sediment) {
                    // Erode
                    const toErode = Math.min((capacity - this.sediment) * erosionRate, 1);
                    this.sediment += toErode;
                    heightMap[y][x] -= toErode * 0.1;
                } else {
                    // Deposit
                    const toDeposit = (this.sediment - capacity) * 0.5;
                    this.sediment -= toDeposit;
                    heightMap[y][x] += toDeposit * 0.1;
                }

                // Add water to map
                waterMap[y][x] += this.water * 0.1;

                // Evaporation
                this.water *= 0.98;
                this.life--;

                return true;
            }
        }

        // Simulation parameters
        let droplets = [];
        let rainfall = 50;
        let erosionRate = 0.5;
        let sedimentCapacity = 5;
        let paused = false;

        // Rendering
        function drawTerrain() {
            const cellW = width / gridSize;
            const cellH = height / gridSize;

            // Draw heightmap
            for (let y = 0; y < gridSize; y++) {
                for (let x = 0; x < gridSize; x++) {
                    const h = heightMap[y][x];
                    const water = waterMap[y][x];

                    // Terrain color based on height
                    let r, g, b;
                    if (h < 10) {
                        // Low - green valleys
                        r = 40 + h * 2;
                        g = 80 + h * 3;
                        b = 40 + h * 1;
                    } else if (h < 25) {
                        // Mid - brown hills
                        r = 100 + (h - 10) * 2;
                        g = 80 + (h - 10) * 1.5;
                        b = 50 + (h - 10) * 1;
                    } else {
                        // High - gray mountains
                        r = 130 + (h - 25) * 2;
                        g = 130 + (h - 25) * 2;
                        b = 130 + (h - 25) * 2;
                    }

                    // Add water tint
                    if (water > 0) {
                        const waterAmount = Math.min(water * 20, 1);
                        r = r * (1 - waterAmount) + 50 * waterAmount;
                        g = g * (1 - waterAmount) + 120 * waterAmount;
                        b = b * (1 - waterAmount) + 200 * waterAmount;
                    }

                    ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;
                    ctx.fillRect(x * cellW, y * cellH, cellW + 1, cellH + 1);

                    // Fade water
                    waterMap[y][x] *= 0.95;
                }
            }
        }

        // Animation loop
        function animate() {
            if (!paused) {
                // Add new droplets
                for (let i = 0; i < rainfall; i++) {
                    droplets.push(new Droplet());
                }

                // Update droplets
                droplets = droplets.filter(d => d.update(erosionRate, sedimentCapacity));

                // Keep droplet count reasonable
                if (droplets.length > 1000) {
                    droplets = droplets.slice(-1000);
                }
            }

            drawTerrain();

            requestAnimationFrame(animate);
        }

        // Controls
        document.getElementById('rainfall').addEventListener('input', (e) => {
            rainfall = parseInt(e.target.value);
            document.getElementById('rainValue').textContent = rainfall;
        });

        document.getElementById('erosion').addEventListener('input', (e) => {
            erosionRate = parseFloat(e.target.value);
            document.getElementById('erosionValue').textContent = erosionRate.toFixed(1);
        });

        document.getElementById('sediment').addEventListener('input', (e) => {
            sedimentCapacity = parseInt(e.target.value);
            document.getElementById('sedimentValue').textContent = sedimentCapacity;
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            generateTerrain();
            droplets = [];
        });

        document.getElementById('pauseBtn').addEventListener('click', (e) => {
            paused = !paused;
            e.target.textContent = paused ? 'Resume' : 'Pause';
        });

        // Expose functions for enhance.js keyboard shortcuts
        window.reset = generateTerrain;

        // Initialize
        generateTerrain();
        animate();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
