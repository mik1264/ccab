<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kelvin-Helmholtz Instability</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; overflow: hidden; font-family: sans-serif; }
canvas { display: block; }
.title-overlay {
    position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
    color: #fbbf24; font-size: 20px; font-weight: bold; z-index: 999;
    text-shadow: 0 0 10px rgba(0,0,0,0.8); pointer-events: none;
}
.controls {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
    display: flex; gap: 20px; align-items: center; z-index: 999;
    background: rgba(0,0,0,0.7); padding: 12px 20px; border-radius: 10px;
    flex-wrap: wrap; justify-content: center;
}
.controls label { color: #ccc; font-size: 13px; }
.controls input[type=range] { width: 100px; cursor: pointer; }
.controls span { color: #fbbf24; font-size: 13px; min-width: 30px; }
.controls button {
    padding: 6px 14px; background: #fbbf24; color: #0a0e1a; border: none;
    border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: bold;
}
.info {
    position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
    color: rgba(255,255,255,0.5); font-size: 12px; z-index: 999;
    pointer-events: none;
}
</style>
</head>
<body>
<a href="../index.html" style="position:fixed;top:10px;left:10px;padding:8px 16px;background:rgba(0,0,0,0.7);color:#fbbf24;text-decoration:none;border-radius:6px;font-size:14px;z-index:999;font-family:sans-serif;">‚Üê Back to Gallery</a>
<div class="title-overlay">Kelvin-Helmholtz Instability</div>
<div class="info">Two fluid layers moving at different speeds create billowing wave patterns</div>
<div class="controls">
    <label>Shear Speed</label>
    <input type="range" id="shearSlider" min="2" max="15" value="8" step="1">
    <span id="shearVal">8</span>
    <label>Viscosity</label>
    <input type="range" id="viscSlider" min="1" max="20" value="5" step="1">
    <span id="viscVal">5</span>
    <button id="resetBtn">Reset</button>
</div>
<canvas id="canvas"></canvas>
<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const SCALE = 2;
let W, H, NX, NY;
let density, vx, vy, tmpDensity;

function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
    NX = Math.floor(W / SCALE);
    NY = Math.floor(H / SCALE);
    init();
}

function init() {
    const N = NX * NY;
    density = new Float32Array(N);
    vx = new Float32Array(N);
    vy = new Float32Array(N);
    tmpDensity = new Float32Array(N);

    const shear = parseInt(document.getElementById('shearSlider').value) * 0.01;
    const midY = NY / 2;
    const thickness = NY * 0.05;

    for (let y = 0; y < NY; y++) {
        for (let x = 0; x < NX; x++) {
            const n = y * NX + x;
            // Two shear layers
            const dy1 = (y - NY * 0.35) / thickness;
            const dy2 = (y - NY * 0.65) / thickness;

            // Smooth transition using tanh
            const t1 = 0.5 * (1 + Math.tanh(dy1));
            const t2 = 0.5 * (1 + Math.tanh(-dy2));
            density[n] = t1 * t2;

            // Horizontal velocity with shear
            vx[n] = density[n] > 0.5 ? shear : -shear;

            // Small perturbation
            const perturbation = 0.002 * shear * Math.sin(2 * Math.PI * x / NX * 4 + Math.random() * 0.3);
            vy[n] = perturbation * (Math.abs(dy1) < 3 || Math.abs(dy2) < 3 ? 1 : 0);
        }
    }
}

function step() {
    const visc = parseInt(document.getElementById('viscSlider').value) * 0.02;
    const dt = 0.8;

    // Update velocities with viscous diffusion
    for (let y = 1; y < NY - 1; y++) {
        for (let x = 1; x < NX - 1; x++) {
            const n = y * NX + x;
            // Viscous diffusion
            vx[n] += visc * (vx[n-1] + vx[n+1] + vx[n-NX] + vx[n+NX] - 4 * vx[n]);
            vy[n] += visc * (vy[n-1] + vy[n+1] + vy[n-NX] + vy[n+NX] - 4 * vy[n]);

            // Slight damping
            vx[n] *= 0.9999;
            vy[n] *= 0.9999;
        }
    }

    // Semi-Lagrangian advection
    for (let y = 0; y < NY; y++) {
        for (let x = 0; x < NX; x++) {
            const n = y * NX + x;
            // Trace back
            let srcX = x - vx[n] * dt;
            let srcY = y - vy[n] * dt;

            // Periodic in X
            srcX = ((srcX % NX) + NX) % NX;
            srcY = Math.max(0, Math.min(NY - 1.001, srcY));

            const x0 = Math.floor(srcX);
            const y0 = Math.floor(srcY);
            const fx = srcX - x0;
            const fy = srcY - y0;
            const x1 = (x0 + 1) % NX;
            const y1 = Math.min(y0 + 1, NY - 1);

            tmpDensity[n] =
                (1 - fx) * (1 - fy) * density[y0 * NX + x0] +
                fx * (1 - fy) * density[y0 * NX + x1] +
                (1 - fx) * fy * density[y1 * NX + x0] +
                fx * fy * density[y1 * NX + x1];
        }
    }

    const tmp = density;
    density = tmpDensity;
    tmpDensity = tmp;
}

let imageData;
function render() {
    if (!imageData || imageData.width !== NX || imageData.height !== NY) {
        imageData = ctx.createImageData(NX, NY);
    }
    const data = imageData.data;

    for (let y = 0; y < NY; y++) {
        for (let x = 0; x < NX; x++) {
            const n = y * NX + x;
            const p = n * 4;
            const d = Math.max(0, Math.min(1, density[n]));
            const speed = Math.sqrt(vx[n] * vx[n] + vy[n] * vy[n]);
            const s = Math.min(1, speed * 15);

            // Top layer: deep purple/magenta, Bottom layer: teal/cyan
            const r = d * 200 + (1 - d) * 20 + s * 55;
            const g = d * 50 + (1 - d) * 180 + s * 40;
            const b = d * 180 + (1 - d) * 220 + s * 35;

            data[p] = Math.min(255, r);
            data[p+1] = Math.min(255, g);
            data[p+2] = Math.min(255, b);
            data[p+3] = 255;
        }
    }

    const off = document.createElement('canvas');
    off.width = NX; off.height = NY;
    off.getContext('2d').putImageData(imageData, 0, 0);
    ctx.imageSmoothingEnabled = true;
    ctx.drawImage(off, 0, 0, W, H);
}

document.getElementById('shearSlider').addEventListener('input', function() {
    document.getElementById('shearVal').textContent = this.value;
});
document.getElementById('viscSlider').addEventListener('input', function() {
    document.getElementById('viscVal').textContent = this.value;
});
document.getElementById('resetBtn').addEventListener('click', init);

function animate() {
    for (let i = 0; i < 5; i++) step();
    render();
    requestAnimationFrame(animate);
}

window.addEventListener('resize', resize);
resize();
animate();
</script>
</body>
</html>
