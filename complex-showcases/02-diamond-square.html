<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terrain - Diamond Square Algorithm</title>
    <style>
        body { margin: 0; overflow: hidden; background: #111; display: flex; justify-content: center; align-items: center; height: 100vh; }
        canvas { border: 2px solid #333; }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 800;
        canvas.height = 600;

        function diamondSquare(size) {
            const map = Array(size).fill(0).map(() => Array(size).fill(0));
            let roughness = 1.0;

            map[0][0] = Math.random();
            map[0][size - 1] = Math.random();
            map[size - 1][0] = Math.random();
            map[size - 1][size - 1] = Math.random();

            let chunkSize = size - 1;

            while (chunkSize > 1) {
                const half = chunkSize / 2;

                // Diamond step
                for (let y = 0; y < size - 1; y += chunkSize) {
                    for (let x = 0; x < size - 1; x += chunkSize) {
                        const avg = (map[y][x] + map[y][x + chunkSize] + map[y + chunkSize][x] + map[y + chunkSize][x + chunkSize]) / 4;
                        map[y + half][x + half] = avg + (Math.random() - 0.5) * roughness;
                    }
                }

                // Square step
                for (let y = 0; y < size; y += half) {
                    for (let x = (y + half) % chunkSize; x < size; x += chunkSize) {
                        let sum = 0, count = 0;
                        if (y >= half) { sum += map[y - half][x]; count++; }
                        if (y + half < size) { sum += map[y + half][x]; count++; }
                        if (x >= half) { sum += map[y][x - half]; count++; }
                        if (x + half < size) { sum += map[y][x + half]; count++; }
                        map[y][x] = sum / count + (Math.random() - 0.5) * roughness;
                    }
                }

                chunkSize /= 2;
                roughness *= 0.5;
            }

            return map;
        }

        const SIZE = 257;
        let heightMap = diamondSquare(SIZE);
        let time = 0;

        function render() {
            time += 0.01;
            const imageData = ctx.createImageData(canvas.width, canvas.height);
            const data = imageData.data;

            for (let y = 0; y < canvas.height; y++) {
                for (let x = 0; x < canvas.width; x++) {
                    const mx = Math.floor(x / canvas.width * SIZE);
                    const my = Math.floor(y / canvas.height * SIZE);
                    const height = heightMap[my][mx];

                    // Apply lighting
                    const nx = mx + 1 < SIZE ? mx + 1 : mx;
                    const ny = my + 1 < SIZE ? my + 1 : my;
                    const dx = heightMap[my][nx] - height;
                    const dy = heightMap[ny][mx] - height;
                    const light = Math.max(0.3, 1 - (dx + dy) * 2);

                    let r, g, b;
                    if (height < 0.3) {
                        r = 30 * light; g = 60 * light; b = 120 * light;
                    } else if (height < 0.35) {
                        r = 194 * light; g = 178 * light; b = 128 * light;
                    } else if (height < 0.6) {
                        r = 34 * light; g = 139 * light; b = 34 * light;
                    } else if (height < 0.75) {
                        r = 139 * light; g = 90 * light; b = 43 * light;
                    } else {
                        r = 255 * light; g = 250 * light; b = 250 * light;
                    }

                    const idx = (y * canvas.width + x) * 4;
                    data[idx] = r;
                    data[idx + 1] = g;
                    data[idx + 2] = b;
                    data[idx + 3] = 255;
                }
            }

            ctx.putImageData(imageData, 0, 0);

            // Add some animated clouds
            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            for (let i = 0; i < 10; i++) {
                const x = ((time * 50 + i * 100) % (canvas.width + 200)) - 100;
                const y = 50 + i * 40;
                ctx.beginPath();
                ctx.ellipse(x, y, 60, 30, 0, 0, Math.PI * 2);
                ctx.fill();
            }

            requestAnimationFrame(render);
        }

        render();

        canvas.addEventListener('click', () => {
            heightMap = diamondSquare(SIZE);
        });
    </script>
</body>
</html>
