<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plague Spread | Historical Simulations</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e2e8f0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        .back-link {
            display: inline-block;
            color: #ef4444;
            text-decoration: none;
            margin-bottom: 20px;
            padding: 8px 16px;
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 20px;
            transition: all 0.3s;
        }

        .back-link:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: #94a3b8;
            font-size: 1.1rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 30px;
        }

        .simulation-area {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        #canvas {
            width: 100%;
            height: 500px;
            background: #0a0a14;
            border-radius: 15px;
        }

        .legend {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: #94a3b8;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-dot.healthy { background: #22c55e; }
        .legend-dot.infected { background: #ef4444; }
        .legend-dot.dead { background: #374151; }
        .legend-dot.recovered { background: #3b82f6; }

        .controls {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .year-display {
            text-align: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .year-value {
            font-size: 2rem;
            color: #ef4444;
            font-weight: bold;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            color: #ef4444;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .control-group input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: rgba(239, 68, 68, 0.2);
            -webkit-appearance: none;
        }

        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #ef4444;
            cursor: pointer;
        }

        .control-value {
            text-align: right;
            color: #94a3b8;
            font-size: 0.85rem;
            margin-top: 5px;
        }

        .btn {
            width: 100%;
            padding: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        .stats-panel {
            background: rgba(239, 68, 68, 0.1);
            border-radius: 15px;
            padding: 15px;
            margin-top: 20px;
        }

        .stats-panel h3 {
            color: #ef4444;
            margin-bottom: 12px;
            font-size: 0.95rem;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }

        .stat-label {
            color: #94a3b8;
        }

        .stat-value {
            font-weight: 600;
        }

        .stat-value.healthy { color: #22c55e; }
        .stat-value.infected { color: #ef4444; }
        .stat-value.dead { color: #6b7280; }
        .stat-value.recovered { color: #3b82f6; }

        .origin-select {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }

        .origin-btn {
            padding: 8px 12px;
            font-size: 0.8rem;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.3s;
        }

        .origin-btn:hover, .origin-btn.active {
            background: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="index.html" class="back-link">← Back to Historical Simulations</a>
            <h1>Plague Spread</h1>
            <p class="subtitle">Simulate the Black Death across medieval Europe</p>
        </header>

        <div class="main-content">
            <div class="simulation-area">
                <canvas id="canvas"></canvas>
                <div class="legend">
                    <div class="legend-item"><div class="legend-dot healthy"></div> Healthy</div>
                    <div class="legend-item"><div class="legend-dot infected"></div> Infected</div>
                    <div class="legend-item"><div class="legend-dot recovered"></div> Recovered</div>
                    <div class="legend-item"><div class="legend-dot dead"></div> Dead</div>
                </div>
            </div>

            <div class="controls">
                <div class="year-display">
                    <div class="year-value" id="year">1347</div>
                    <div style="color: #94a3b8; font-size: 0.85rem;">Year</div>
                </div>

                <div class="control-group">
                    <label>Origin City</label>
                    <div class="origin-select" id="originSelect"></div>
                </div>

                <div class="control-group">
                    <label>Transmission Rate</label>
                    <input type="range" id="transmission" min="1" max="10" value="6">
                    <div class="control-value"><span id="transmissionValue">6</span>0%</div>
                </div>

                <div class="control-group">
                    <label>Mortality Rate</label>
                    <input type="range" id="mortality" min="1" max="10" value="5">
                    <div class="control-value"><span id="mortalityValue">5</span>0%</div>
                </div>

                <div class="control-group">
                    <label>Trade Route Activity</label>
                    <input type="range" id="trade" min="1" max="10" value="5">
                    <div class="control-value"><span id="tradeValue">5</span></div>
                </div>

                <button class="btn btn-primary" id="startBtn">▶ Start Outbreak</button>
                <button class="btn btn-primary" id="resetBtn">↺ Reset</button>

                <div class="stats-panel">
                    <h3>Europe Statistics</h3>
                    <div class="stat-row">
                        <span class="stat-label">Healthy</span>
                        <span class="stat-value healthy" id="healthyCount">100%</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Infected</span>
                        <span class="stat-value infected" id="infectedCount">0%</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Recovered</span>
                        <span class="stat-value recovered" id="recoveredCount">0%</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Dead</span>
                        <span class="stat-value dead" id="deadCount">0%</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Cities Affected</span>
                        <span class="stat-value infected" id="citiesAffected">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let width, height;
        let running = false;
        let year = 1347;
        let month = 0;
        let selectedOrigin = 'Constantinople';

        // Medieval European cities with approximate positions
        const cities = [
            { name: 'Constantinople', x: 0.85, y: 0.65, pop: 100000 },
            { name: 'Venice', x: 0.52, y: 0.52, pop: 80000 },
            { name: 'Genoa', x: 0.45, y: 0.55, pop: 60000 },
            { name: 'Florence', x: 0.48, y: 0.58, pop: 70000 },
            { name: 'Rome', x: 0.52, y: 0.65, pop: 50000 },
            { name: 'Paris', x: 0.35, y: 0.38, pop: 100000 },
            { name: 'London', x: 0.32, y: 0.28, pop: 80000 },
            { name: 'Barcelona', x: 0.28, y: 0.62, pop: 40000 },
            { name: 'Marseille', x: 0.38, y: 0.55, pop: 35000 },
            { name: 'Vienna', x: 0.58, y: 0.42, pop: 30000 },
            { name: 'Cologne', x: 0.42, y: 0.35, pop: 35000 },
            { name: 'Prague', x: 0.55, y: 0.38, pop: 40000 },
            { name: 'Krakow', x: 0.62, y: 0.38, pop: 25000 },
            { name: 'Naples', x: 0.55, y: 0.7, pop: 45000 },
            { name: 'Milan', x: 0.45, y: 0.48, pop: 60000 },
            { name: 'Lisbon', x: 0.12, y: 0.62, pop: 35000 },
            { name: 'Seville', x: 0.15, y: 0.72, pop: 30000 },
            { name: 'Bruges', x: 0.35, y: 0.3, pop: 45000 },
            { name: 'Hamburg', x: 0.48, y: 0.25, pop: 25000 },
            { name: 'Cairo', x: 0.88, y: 0.85, pop: 150000 }
        ];

        // Trade routes (city pairs)
        const tradeRoutes = [
            ['Constantinople', 'Venice'], ['Constantinople', 'Genoa'],
            ['Venice', 'Genoa'], ['Venice', 'Florence'], ['Venice', 'Vienna'],
            ['Genoa', 'Barcelona'], ['Genoa', 'Marseille'],
            ['Florence', 'Rome'], ['Rome', 'Naples'],
            ['Paris', 'London'], ['Paris', 'Bruges'], ['Paris', 'Marseille'],
            ['London', 'Bruges'], ['Bruges', 'Cologne'], ['Cologne', 'Hamburg'],
            ['Vienna', 'Prague'], ['Prague', 'Krakow'],
            ['Barcelona', 'Marseille'], ['Lisbon', 'Seville'],
            ['Milan', 'Venice'], ['Milan', 'Genoa'],
            ['Constantinople', 'Cairo']
        ];

        function resize() {
            width = canvas.offsetWidth * 2;
            height = canvas.offsetHeight * 2;
            canvas.width = width;
            canvas.height = height;

            // Update city positions
            cities.forEach(city => {
                city.screenX = city.x * width;
                city.screenY = city.y * height;
            });
        }

        function init() {
            year = 1347;
            month = 0;
            running = false;

            cities.forEach(city => {
                city.healthy = city.pop;
                city.infected = 0;
                city.recovered = 0;
                city.dead = 0;
                city.daysInfected = 0;
            });

            // Start infection at selected origin
            const origin = cities.find(c => c.name === selectedOrigin);
            if (origin) {
                const initialInfected = Math.floor(origin.pop * 0.01);
                origin.healthy -= initialInfected;
                origin.infected = initialInfected;
            }

            updateStats();
        }

        function createOriginButtons() {
            const container = document.getElementById('originSelect');
            container.innerHTML = ['Constantinople', 'Venice', 'Genoa', 'Cairo'].map(name =>
                `<button class="origin-btn ${name === selectedOrigin ? 'active' : ''}" data-city="${name}">${name}</button>`
            ).join('');

            container.addEventListener('click', (e) => {
                if (e.target.classList.contains('origin-btn')) {
                    selectedOrigin = e.target.dataset.city;
                    container.querySelectorAll('.origin-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    if (!running) init();
                }
            });
        }

        function update() {
            const transmission = parseInt(document.getElementById('transmission').value) / 10;
            const mortality = parseInt(document.getElementById('mortality').value) / 10;
            const tradeActivity = parseInt(document.getElementById('trade').value) / 10;

            // Update each city
            cities.forEach(city => {
                if (city.infected > 0) {
                    city.daysInfected++;

                    // Infection spreads within city
                    const newInfections = Math.floor(city.healthy * transmission * (city.infected / city.pop) * 0.3);
                    city.healthy -= newInfections;
                    city.infected += newInfections;

                    // Deaths and recovery (after ~30 days)
                    if (city.daysInfected > 3) {
                        const deaths = Math.floor(city.infected * mortality * 0.1);
                        const recoveries = Math.floor(city.infected * (1 - mortality) * 0.1);
                        city.infected -= deaths + recoveries;
                        city.dead += deaths;
                        city.recovered += recoveries;
                    }

                    city.infected = Math.max(0, city.infected);
                    city.healthy = Math.max(0, city.healthy);
                }
            });

            // Spread through trade routes
            tradeRoutes.forEach(([city1Name, city2Name]) => {
                const city1 = cities.find(c => c.name === city1Name);
                const city2 = cities.find(c => c.name === city2Name);

                if (city1 && city2 && Math.random() < tradeActivity * 0.1) {
                    if (city1.infected > 0 && city2.healthy > 0 && city2.infected === 0) {
                        const spread = Math.floor(city2.healthy * 0.001 * transmission);
                        city2.healthy -= spread;
                        city2.infected += spread;
                    }
                    if (city2.infected > 0 && city1.healthy > 0 && city1.infected === 0) {
                        const spread = Math.floor(city1.healthy * 0.001 * transmission);
                        city1.healthy -= spread;
                        city1.infected += spread;
                    }
                }
            });

            // Advance time
            month++;
            if (month >= 12) {
                month = 0;
                year++;
            }

            document.getElementById('year').textContent = year;
            updateStats();

            // Check if plague is over
            const totalInfected = cities.reduce((sum, c) => sum + c.infected, 0);
            if (totalInfected === 0 && year > 1347) {
                running = false;
                document.getElementById('startBtn').textContent = '▶ Start Outbreak';
            }
        }

        function updateStats() {
            let totalHealthy = 0, totalInfected = 0, totalDead = 0, totalRecovered = 0;
            let citiesAffected = 0;

            cities.forEach(city => {
                totalHealthy += city.healthy;
                totalInfected += city.infected;
                totalDead += city.dead;
                totalRecovered += city.recovered;
                if (city.infected > 0 || city.dead > 0) citiesAffected++;
            });

            const total = totalHealthy + totalInfected + totalDead + totalRecovered;

            document.getElementById('healthyCount').textContent = ((totalHealthy / total) * 100).toFixed(1) + '%';
            document.getElementById('infectedCount').textContent = ((totalInfected / total) * 100).toFixed(1) + '%';
            document.getElementById('recoveredCount').textContent = ((totalRecovered / total) * 100).toFixed(1) + '%';
            document.getElementById('deadCount').textContent = ((totalDead / total) * 100).toFixed(1) + '%';
            document.getElementById('citiesAffected').textContent = citiesAffected + '/' + cities.length;
        }

        function draw() {
            ctx.fillStyle = '#0a0a14';
            ctx.fillRect(0, 0, width, height);

            // Draw simplified Europe outline
            ctx.strokeStyle = 'rgba(148, 163, 184, 0.2)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0.1 * width, 0.3 * height);
            ctx.lineTo(0.35 * width, 0.15 * height);
            ctx.lineTo(0.6 * width, 0.2 * height);
            ctx.lineTo(0.85 * width, 0.35 * height);
            ctx.lineTo(0.9 * width, 0.6 * height);
            ctx.lineTo(0.75 * width, 0.75 * height);
            ctx.lineTo(0.55 * width, 0.8 * height);
            ctx.lineTo(0.4 * width, 0.7 * height);
            ctx.lineTo(0.15 * width, 0.75 * height);
            ctx.lineTo(0.05 * width, 0.55 * height);
            ctx.closePath();
            ctx.stroke();

            // Draw trade routes
            ctx.strokeStyle = 'rgba(148, 163, 184, 0.15)';
            ctx.lineWidth = 1;
            tradeRoutes.forEach(([city1Name, city2Name]) => {
                const city1 = cities.find(c => c.name === city1Name);
                const city2 = cities.find(c => c.name === city2Name);
                if (city1 && city2) {
                    ctx.beginPath();
                    ctx.moveTo(city1.screenX, city1.screenY);
                    ctx.lineTo(city2.screenX, city2.screenY);
                    ctx.stroke();
                }
            });

            // Draw cities
            cities.forEach(city => {
                const total = city.healthy + city.infected + city.dead + city.recovered;
                const size = Math.sqrt(total / 1000) * 10 + 8;

                // City glow based on status
                let glowColor;
                if (city.infected > 0) {
                    glowColor = `rgba(239, 68, 68, ${Math.min(0.8, city.infected / total)})`;
                } else if (city.dead > total * 0.1) {
                    glowColor = 'rgba(55, 65, 81, 0.5)';
                } else if (city.recovered > 0) {
                    glowColor = 'rgba(59, 130, 246, 0.3)';
                } else {
                    glowColor = 'rgba(34, 197, 94, 0.3)';
                }

                const gradient = ctx.createRadialGradient(city.screenX, city.screenY, 0, city.screenX, city.screenY, size * 2);
                gradient.addColorStop(0, glowColor);
                gradient.addColorStop(1, 'transparent');
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(city.screenX, city.screenY, size * 2, 0, Math.PI * 2);
                ctx.fill();

                // City dot
                if (city.infected > 0) {
                    ctx.fillStyle = '#ef4444';
                } else if (city.dead > total * 0.5) {
                    ctx.fillStyle = '#374151';
                } else if (city.recovered > 0) {
                    ctx.fillStyle = '#3b82f6';
                } else {
                    ctx.fillStyle = '#22c55e';
                }
                ctx.beginPath();
                ctx.arc(city.screenX, city.screenY, size, 0, Math.PI * 2);
                ctx.fill();

                // City name
                ctx.fillStyle = '#e2e8f0';
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(city.name, city.screenX, city.screenY - size - 8);
            });
        }

        function animate() {
            if (running) {
                update();
            }
            draw();
            requestAnimationFrame(animate);
        }

        document.getElementById('startBtn').addEventListener('click', () => {
            if (!running) {
                init();
            }
            running = !running;
            document.getElementById('startBtn').textContent = running ? '⏸ Pause' : '▶ Start Outbreak';
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            running = false;
            document.getElementById('startBtn').textContent = '▶ Start Outbreak';
            init();
        });

        ['transmission', 'mortality', 'trade'].forEach(id => {
            document.getElementById(id).addEventListener('input', (e) => {
                document.getElementById(id + 'Value').textContent = e.target.value;
            });
        });

        window.addEventListener('resize', resize);
        resize();
        createOriginButtons();
        init();
        animate();
    </script>
</body>
</html>
