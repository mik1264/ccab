<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Living Edda - The Kenning Exhibition</title>
    <meta name="description" content="A growing collection of visitor-created kennings. Contribute your own modern kennings to the Living Edda.">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>&#x2618;</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400;1,600&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="kenning-images-data.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <style>
        :root {
            --bg-deep: #1a1a2e;
            --bg-mid: #16213e;
            --bg-surface: #1f2641;
            --gold: #e6c069;
            --gold-dim: #b8944d;
            --parchment: #d4c5a9;
            --parchment-dim: #9e9279;
            --ink: #0d0d1a;
            --glow: rgba(230, 192, 105, 0.15);
            --accent: #3a7d44;
            --accent-glow: rgba(58, 125, 68, 0.12);
            --font-display: 'EB Garamond', 'Georgia', serif;
            --font-body: 'Inter', 'Helvetica Neue', sans-serif;
            --nav-width: 260px;
            --transition-room: 0.6s cubic-bezier(0.22, 1, 0.36, 1);
        }

        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: var(--font-body);
            background: var(--bg-deep);
            color: var(--parchment);
            line-height: 1.7;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Persistent Navigation */
        .exhibition-nav {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--nav-width);
            height: 100vh;
            background: linear-gradient(180deg, var(--ink) 0%, var(--bg-deep) 100%);
            border-right: 1px solid rgba(230, 192, 105, 0.08);
            padding: 30px 0;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1);
        }

        .exhibition-nav .nav-title {
            font-family: var(--font-display);
            font-size: 1.1rem;
            color: var(--gold);
            text-align: center;
            padding: 0 20px 25px;
            border-bottom: 1px solid rgba(230, 192, 105, 0.1);
            letter-spacing: 0.05em;
        }

        .exhibition-nav .nav-rooms {
            flex: 1;
            padding: 15px 0;
            overflow-y: auto;
        }

        .exhibition-nav .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: var(--parchment-dim);
            text-decoration: none;
            font-family: var(--font-body);
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .exhibition-nav .nav-link:hover {
            color: var(--gold);
            background: rgba(230, 192, 105, 0.05);
            border-left-color: var(--gold-dim);
        }

        .exhibition-nav .nav-link.active {
            color: var(--gold);
            background: rgba(230, 192, 105, 0.08);
            border-left-color: var(--accent);
        }

        .exhibition-nav .nav-icon {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        .exhibition-nav .nav-footer {
            padding: 15px 0;
            border-top: 1px solid rgba(230, 192, 105, 0.1);
        }

        .exhibition-nav .nav-back {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: var(--parchment-dim);
            text-decoration: none;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .exhibition-nav .nav-back:hover {
            color: var(--gold);
        }

        /* Mobile header */
        .mobile-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: var(--ink);
            border-bottom: 1px solid rgba(230, 192, 105, 0.1);
            align-items: center;
            padding: 0 16px;
            z-index: 999;
        }

        .hamburger {
            width: 40px;
            height: 40px;
            background: none;
            border: none;
            color: var(--gold);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .mobile-title {
            font-family: var(--font-display);
            color: var(--gold);
            font-size: 1rem;
            margin-left: 12px;
        }

        .nav-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 998;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .nav-overlay.visible {
            opacity: 1;
            pointer-events: all;
        }

        /* Room transition */
        .room-transition {
            position: fixed;
            inset: 0;
            background: var(--ink);
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }

        .room-transition.active {
            opacity: 1;
            pointer-events: all;
        }

        /* p5 backdrop */
        #p5-backdrop {
            position: fixed;
            top: 0;
            left: var(--nav-width);
            right: 0;
            bottom: 0;
            z-index: 0;
            opacity: 0.35;
            pointer-events: none;
        }

        #p5-backdrop canvas {
            display: block;
            width: 100% !important;
            height: 100% !important;
        }

        /* Main content */
        .exhibition-main {
            margin-left: var(--nav-width);
            min-height: 100vh;
            position: relative;
        }

        .room-content {
            position: relative;
            z-index: 1;
            max-width: 1100px;
            margin: 0 auto;
            padding: 60px 40px 80px;
        }

        /* Room header */
        .room-header {
            text-align: center;
            margin-bottom: 50px;
        }

        .room-header h1 {
            font-family: var(--font-display);
            font-size: 2.4rem;
            font-weight: 600;
            color: var(--gold);
            margin-bottom: 10px;
            letter-spacing: 0.02em;
        }

        .room-header .room-subtitle {
            font-family: var(--font-display);
            font-size: 1.1rem;
            font-style: italic;
            color: var(--parchment-dim);
        }

        /* Stats bar */
        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
        }

        .stat-item .stat-num {
            font-family: var(--font-display);
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-item .stat-lbl {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--parchment-dim);
            margin-top: 2px;
        }

        /* Contribution form */
        .contribute-section {
            background: var(--bg-surface);
            border: 1px solid rgba(58, 125, 68, 0.2);
            border-radius: 16px;
            padding: 35px;
            margin-bottom: 40px;
        }

        .contribute-section h2 {
            font-family: var(--font-display);
            font-size: 1.6rem;
            font-weight: 600;
            color: var(--gold);
            margin-bottom: 25px;
            text-align: center;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--parchment-dim);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 8px;
        }

        .form-group label .required {
            color: var(--accent);
        }

        .form-group input,
        .form-group textarea {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(230, 192, 105, 0.15);
            border-radius: 8px;
            padding: 12px 16px;
            font-family: var(--font-body);
            font-size: 1rem;
            color: var(--parchment);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(58, 125, 68, 0.15);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(212, 197, 169, 0.35);
        }

        .form-group input.kenning-input {
            font-family: var(--font-display);
            font-size: 1.2rem;
            font-style: italic;
            color: var(--gold);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 70px;
        }

        .submit-btn {
            display: block;
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--accent), #2d6636);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-family: var(--font-display);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.02em;
            margin-top: 10px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(58, 125, 68, 0.35);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .form-error {
            color: #e05555;
            font-size: 0.85rem;
            margin-top: 6px;
            display: none;
        }

        .form-error.visible {
            display: block;
        }

        .form-success {
            text-align: center;
            padding: 20px;
            background: rgba(58, 125, 68, 0.12);
            border-radius: 10px;
            margin-top: 15px;
            display: none;
            animation: fadeSlideIn 0.4s ease;
        }

        .form-success.visible {
            display: block;
        }

        .form-success .check {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        @keyframes fadeSlideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Controls bar */
        .controls-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .sort-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .sort-btn {
            padding: 8px 18px;
            background: transparent;
            border: 1px solid rgba(230, 192, 105, 0.2);
            border-radius: 20px;
            color: var(--parchment-dim);
            font-family: var(--font-body);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sort-btn:hover {
            border-color: var(--gold-dim);
            color: var(--gold);
        }

        .sort-btn.active {
            background: rgba(230, 192, 105, 0.12);
            border-color: var(--gold);
            color: var(--gold);
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(230, 192, 105, 0.15);
            border-radius: 20px;
            padding: 8px 16px 8px 36px;
            font-family: var(--font-body);
            font-size: 0.85rem;
            color: var(--parchment);
            width: 220px;
            transition: border-color 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .search-box input::placeholder {
            color: rgba(212, 197, 169, 0.35);
        }

        .search-box::before {
            content: '\2315';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--parchment-dim);
            font-size: 1rem;
        }

        /* Export button */
        .export-btn {
            padding: 8px 18px;
            background: transparent;
            border: 1px solid rgba(230, 192, 105, 0.2);
            border-radius: 20px;
            color: var(--parchment-dim);
            font-family: var(--font-body);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            border-color: var(--gold-dim);
            color: var(--gold);
        }

        /* Community wall - masonry grid */
        .community-wall {
            column-count: 3;
            column-gap: 20px;
        }

        /* Rune stone cards */
        .rune-card {
            break-inside: avoid;
            background: var(--bg-surface);
            border: 1px solid rgba(230, 192, 105, 0.08);
            border-radius: 12px;
            padding: 22px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            position: relative;
        }

        .rune-card:hover {
            border-color: rgba(58, 125, 68, 0.3);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
        }

        .rune-card .forge-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 1rem;
            color: #d4601a;
            title: "Forged in the Kenning Forge";
        }

        .rune-card .kenning-text {
            font-family: var(--font-display);
            font-size: 1.3rem;
            font-style: italic;
            color: var(--gold);
            letter-spacing: 0.02em;
            margin-bottom: 6px;
        }

        .rune-card .meaning-text {
            font-family: var(--font-body);
            font-size: 0.85rem;
            color: var(--parchment-dim);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 10px;
        }

        .rune-card .explanation-text {
            font-size: 0.9rem;
            color: var(--parchment);
            line-height: 1.6;
            margin-bottom: 12px;
            font-style: italic;
            opacity: 0.85;
        }

        .rune-card .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 10px;
            border-top: 1px solid rgba(230, 192, 105, 0.06);
        }

        .rune-card .contributor {
            font-size: 0.8rem;
            color: var(--parchment-dim);
        }

        .rune-card .contributor .name {
            color: var(--accent);
            font-weight: 500;
        }

        .rune-card .timestamp {
            font-size: 0.75rem;
            color: rgba(158, 146, 121, 0.6);
        }

        .rune-card .heart-area {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .heart-btn {
            background: none;
            border: none;
            color: var(--parchment-dim);
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 4px;
            line-height: 1;
        }

        .heart-btn:hover {
            color: #e05555;
            transform: scale(1.2);
        }

        .heart-btn.hearted {
            color: #e05555;
        }

        .heart-count {
            font-size: 0.8rem;
            color: var(--parchment-dim);
            min-width: 12px;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--parchment-dim);
        }

        .empty-state .empty-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Audio toggle */
        .audio-toggle {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--bg-surface);
            border: 1px solid rgba(230, 192, 105, 0.15);
            color: var(--gold);
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .audio-toggle:hover {
            background: rgba(230, 192, 105, 0.15);
            transform: scale(1.1);
        }

        .audio-toggle.muted {
            color: var(--parchment-dim);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-deep); }
        ::-webkit-scrollbar-thumb { background: var(--gold-dim); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gold); }

        /* Focus styles */
        *:focus-visible {
            outline: 2px solid var(--gold);
            outline-offset: 2px;
        }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
            #p5-backdrop { display: none; }
            .room-transition { display: none; }
        }

        /* --- Illustrated Kennings Section --- */
        .illustrated-section {
            margin-bottom: 40px;
        }

        .illustrated-section h2 {
            font-family: var(--font-display);
            font-size: 1.6rem;
            font-weight: 600;
            color: var(--gold);
            margin-bottom: 8px;
            text-align: center;
        }

        .illustrated-section .section-subtitle {
            font-size: 0.85rem;
            color: var(--parchment-dim);
            text-align: center;
            margin-bottom: 22px;
        }

        .illustrated-section .section-subtitle a {
            color: var(--accent);
            text-decoration: none;
        }

        .illustrated-section .section-subtitle a:hover {
            text-decoration: underline;
        }

        .illustrated-masonry {
            column-count: 3;
            column-gap: 16px;
        }

        .illustrated-item {
            break-inside: avoid;
            margin-bottom: 16px;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(58, 125, 68, 0.15);
            background: var(--bg-surface);
            cursor: pointer;
            transition: transform 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .illustrated-item:hover {
            transform: translateY(-3px);
            border-color: var(--accent);
            box-shadow: 0 6px 24px rgba(58, 125, 68, 0.2);
        }

        .illustrated-item img {
            display: block;
            width: 100%;
            height: auto;
        }

        .illustrated-item .illust-caption {
            padding: 10px 12px;
            font-family: var(--font-display);
            font-style: italic;
            font-size: 0.9rem;
            color: var(--gold);
            text-align: center;
            line-height: 1.3;
        }

        .illustrated-item .illust-artist {
            padding: 0 12px 10px;
            font-size: 0.7rem;
            color: var(--parchment-dim);
            text-align: center;
        }

        /* --- Form Inspiration Image --- */
        .form-inspiration {
            margin-top: 20px;
            text-align: center;
        }

        .form-inspiration-img {
            display: inline-block;
            max-width: 220px;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(58, 125, 68, 0.2);
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .form-inspiration-img:hover {
            transform: scale(1.03);
        }

        .form-inspiration-img img {
            display: block;
            width: 100%;
            height: auto;
        }

        .form-inspiration-img .img-credit {
            padding: 6px 10px;
            font-size: 0.7rem;
            color: var(--parchment-dim);
            background: rgba(13, 13, 26, 0.5);
            text-align: center;
        }

        .form-inspiration-label {
            font-family: var(--font-display);
            font-style: italic;
            font-size: 0.85rem;
            color: var(--parchment-dim);
            margin-bottom: 8px;
        }

        /* --- Lightbox Modal --- */
        .kenning-lightbox {
            position: fixed;
            inset: 0;
            z-index: 10000;
            background: rgba(0, 0, 0, 0.92);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            cursor: pointer;
        }

        .kenning-lightbox.visible {
            display: flex;
            animation: fadeSlideIn 0.3s ease;
        }

        .kenning-lightbox img {
            max-width: 90vw;
            max-height: 80vh;
            border-radius: 10px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
        }

        .kenning-lightbox .lightbox-caption {
            margin-top: 16px;
            font-family: var(--font-display);
            font-style: italic;
            font-size: 1.2rem;
            color: var(--gold);
            text-align: center;
        }

        .kenning-lightbox .lightbox-credit {
            margin-top: 6px;
            font-size: 0.85rem;
            color: var(--parchment-dim);
        }

        .kenning-lightbox .lightbox-credit a {
            color: var(--accent);
            text-decoration: none;
        }

        .kenning-lightbox .lightbox-credit a:hover {
            text-decoration: underline;
        }

        .kenning-lightbox .lightbox-close {
            position: absolute;
            top: 20px;
            right: 24px;
            background: none;
            border: none;
            color: var(--parchment);
            font-size: 2rem;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .kenning-lightbox .lightbox-close:hover {
            opacity: 1;
        }

        /* --- Companion Artwork (after submission) --- */
        .companion-artwork {
            margin-top: 12px;
            display: none;
            text-align: center;
        }

        .companion-artwork.visible {
            display: block;
            animation: fadeSlideIn 0.4s ease;
        }

        .companion-artwork .companion-label {
            font-family: var(--font-display);
            font-style: italic;
            font-size: 0.9rem;
            color: var(--parchment-dim);
            margin-bottom: 8px;
        }

        /* Tablet */
        @media (max-width: 1023px) {
            :root { --nav-width: 60px; }
            .exhibition-nav .nav-label { display: none; }
            .exhibition-nav .nav-title { font-size: 0; padding: 15px 0; }
            .exhibition-nav .nav-title::after {
                content: 'KE';
                font-size: 0.9rem;
                display: block;
            }
            .exhibition-nav .nav-link { justify-content: center; padding: 14px 0; }
            .exhibition-nav .nav-icon { font-size: 1.4rem; }
            .exhibition-nav .nav-footer .nav-back { justify-content: center; }
            .community-wall { column-count: 2; }
            .illustrated-masonry { column-count: 2; }
        }

        /* Mobile */
        @media (max-width: 767px) {
            :root { --nav-width: 0px; }
            .exhibition-nav {
                transform: translateX(-100%);
                width: 280px;
            }
            .exhibition-nav.open {
                transform: translateX(0);
            }
            .exhibition-nav .nav-title { font-size: 1.1rem; padding: 0 20px 25px; }
            .exhibition-nav .nav-title::after { display: none; }
            .exhibition-nav .nav-label { display: inline; }
            .exhibition-nav .nav-link { justify-content: flex-start; padding: 12px 20px; }
            .mobile-header { display: flex; }
            .exhibition-main { margin-left: 0; padding-top: 56px; }
            .room-content { padding: 30px 20px 80px; }
            .room-header h1 { font-size: 1.8rem; }
            .form-grid { grid-template-columns: 1fr; }
            .community-wall { column-count: 1; }
            .illustrated-masonry { column-count: 1; }
            .controls-bar { flex-direction: column; align-items: stretch; }
            .sort-controls { justify-content: center; }
            .search-box input { width: 100%; }
        }
    </style>
</head>
<body>

<nav class="exhibition-nav" id="exhibition-nav" role="navigation" aria-label="Exhibition rooms">
    <div class="nav-title">The Kenning Exhibition</div>
    <div class="nav-rooms">
        <a href="index.html" class="nav-link" data-room="hall">
            <span class="nav-icon">&#x2302;</span>
            <span class="nav-label">Exhibition Hall</span>
        </a>
        <a href="beowulf.html" class="nav-link" data-room="beowulf">
            <span class="nav-icon">&#x2694;</span>
            <span class="nav-label">Beowulf Room</span>
        </a>
        <a href="prose-edda.html" class="nav-link" data-room="edda">
            <span class="nav-icon">&#x2744;</span>
            <span class="nav-label">Prose Edda</span>
        </a>
        <a href="skaldskaparmal.html" class="nav-link" data-room="skald">
            <span class="nav-icon">&#x270D;</span>
            <span class="nav-label">Skaldskaparmal</span>
        </a>
        <a href="kenning-forge.html" class="nav-link" data-room="forge">
            <span class="nav-icon">&#x2692;</span>
            <span class="nav-label">Kenning Forge</span>
        </a>
        <a href="living-edda.html" class="nav-link active" data-room="living">
            <span class="nav-icon">&#x2618;</span>
            <span class="nav-label">Living Edda</span>
        </a>
        <a href="runic-gallery.html" class="nav-link" data-room="runic">
            <span class="nav-icon">&#x25CA;</span>
            <span class="nav-label">Runic Gallery</span>
        </a>
    </div>
    <div class="nav-footer">
        <a href="../index.html" class="nav-back">
            <span class="nav-icon">&#x2190;</span>
            <span class="nav-label">Back to CCAB</span>
        </a>
    </div>
</nav>

<header class="mobile-header" id="mobile-header">
    <button class="hamburger" id="hamburger" aria-label="Open navigation">&#x2630;</button>
    <span class="mobile-title">The Kenning Exhibition</span>
</header>

<div class="nav-overlay" id="nav-overlay"></div>
<div class="room-transition" id="room-transition"></div>
<div id="p5-backdrop"></div>

<button class="audio-toggle muted" id="audio-toggle" aria-label="Toggle ambient sound" title="Toggle ambient sound">&#x266B;</button>

<main class="exhibition-main">
    <div class="room-content">

        <header class="room-header">
            <h1>The Living Edda</h1>
            <p class="room-subtitle">"A growing collection of visitor kennings"</p>
        </header>

        <div class="stats-bar" id="stats-bar">
            <div class="stat-item">
                <div class="stat-num" id="stat-total">0</div>
                <div class="stat-lbl">Total Kennings</div>
            </div>
            <div class="stat-item">
                <div class="stat-num" id="stat-contributors">0</div>
                <div class="stat-lbl">Contributors</div>
            </div>
            <div class="stat-item">
                <div class="stat-num" id="stat-popular">--</div>
                <div class="stat-lbl">Most Hearted</div>
            </div>
        </div>

        <!-- Illustrated Kennings -->
        <section class="illustrated-section" aria-label="Illustrated kennings">
            <h2>Illustrated Kennings</h2>
            <p class="section-subtitle">Art from the <a href="https://kenning.storyleaf.ai" target="_blank" rel="noopener">StoryLeaf Kenning Collection</a></p>
            <div class="illustrated-masonry" id="illustrated-masonry"></div>
        </section>

        <section class="contribute-section" aria-label="Contribute a kenning">
            <h2>Contribute Your Kenning</h2>
            <form id="contribute-form" autocomplete="off">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="input-kenning">Kenning <span class="required">*</span></label>
                        <input type="text" id="input-kenning" class="kenning-input" placeholder='e.g., "pixel-loom"' maxlength="80" required>
                    </div>
                    <div class="form-group">
                        <label for="input-meaning">Meaning <span class="required">*</span></label>
                        <input type="text" id="input-meaning" placeholder='e.g., "computer"' maxlength="80" required>
                    </div>
                    <div class="form-group full-width">
                        <label for="input-explanation">Poetic note (optional)</label>
                        <textarea id="input-explanation" placeholder="Why does this kenning work? What connection are you drawing?" maxlength="300"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="input-name">Your name (optional)</label>
                        <input type="text" id="input-name" placeholder="Anonymous Skald" maxlength="50">
                    </div>
                </div>
                <div class="form-error" id="form-error"></div>
                <button type="submit" class="submit-btn">Add to the Living Edda</button>
                <div class="form-success" id="form-success">
                    <div class="check">&#x2714;</div>
                    <div>Your kenning has been inscribed into the Living Edda!</div>
                </div>
                <div class="companion-artwork" id="companion-artwork"></div>
            </form>
            <div class="form-inspiration" id="form-inspiration"></div>
        </section>

        <!-- Lightbox Modal -->
        <div class="kenning-lightbox" id="kenning-lightbox" role="dialog" aria-label="Image lightbox">
            <button class="lightbox-close" aria-label="Close lightbox">&times;</button>
            <img src="" alt="" id="lightbox-img">
            <div class="lightbox-caption" id="lightbox-caption"></div>
            <div class="lightbox-credit" id="lightbox-credit"></div>
        </div>

        <section aria-label="Community kennings">
            <div class="controls-bar">
                <div class="sort-controls">
                    <button class="sort-btn active" data-sort="newest">Newest</button>
                    <button class="sort-btn" data-sort="hearts">Most Hearts</button>
                    <button class="sort-btn" data-sort="random">Random</button>
                </div>
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="Search kennings..." aria-label="Search kennings">
                </div>
                <button class="export-btn" id="export-btn" title="Download your collection as text">&#x2913; Export</button>
            </div>
            <div class="community-wall" id="community-wall"></div>
        </section>

    </div>
</main>

<script>
(function() {
    'use strict';

    // ========== STORAGE KEYS ==========
    const KEYS = {
        community: 'exhibition-community',
        forged: 'exhibition-forged',
        hearts: 'exhibition-hearts',
        audio: 'exhibition-audio'
    };

    // ========== SEED DATA ==========
    const SEED_KENNINGS = [
        { id: 'seed-01', kenning: 'pixel-loom', meaning: 'computer', explanation: 'A machine that weaves light into patterns on screen', contributor: 'The Exhibition', timestamp: 1700000000000, forged: false },
        { id: 'seed-02', kenning: 'cloud-brain', meaning: 'AI', explanation: 'Intelligence born from the formless digital ether', contributor: 'The Exhibition', timestamp: 1700000100000, forged: false },
        { id: 'seed-03', kenning: 'thumb-scroll', meaning: 'smartphone', explanation: 'The device we navigate with a single thumb', contributor: 'The Exhibition', timestamp: 1700000200000, forged: false },
        { id: 'seed-04', kenning: 'wire-mead', meaning: 'coffee', explanation: 'The dark drink that fuels the modern mead-hall of the office', contributor: 'The Exhibition', timestamp: 1700000300000, forged: false },
        { id: 'seed-05', kenning: 'dawn-alarm', meaning: 'rooster / alarm clock', explanation: 'That which cries out at first light to rouse the sleeping', contributor: 'The Exhibition', timestamp: 1700000400000, forged: false },
        { id: 'seed-06', kenning: 'star-map', meaning: 'GPS', explanation: 'Navigation by the stars, now held in hand', contributor: 'The Exhibition', timestamp: 1700000500000, forged: false },
        { id: 'seed-07', kenning: 'glass-eye', meaning: 'camera', explanation: 'An unblinking eye of glass that preserves moments', contributor: 'The Exhibition', timestamp: 1700000600000, forged: false },
        { id: 'seed-08', kenning: 'storm-bottle', meaning: 'thermos', explanation: 'A vessel that traps weather -- hot or cold -- inside', contributor: 'The Exhibition', timestamp: 1700000700000, forged: false },
        { id: 'seed-09', kenning: 'dream-box', meaning: 'television', explanation: 'The box through which other worlds pour forth like dreams', contributor: 'The Exhibition', timestamp: 1700000800000, forged: false },
        { id: 'seed-10', kenning: 'iron-horse', meaning: 'car / train', explanation: 'The metal steed that replaced the living one', contributor: 'The Exhibition', timestamp: 1700000900000, forged: false },
        { id: 'seed-11', kenning: 'lightning-letter', meaning: 'email', explanation: 'A message carried by lightning rather than hand', contributor: 'The Exhibition', timestamp: 1700001000000, forged: false },
        { id: 'seed-12', kenning: 'frost-chest', meaning: 'refrigerator', explanation: 'A chest enchanted with perpetual winter', contributor: 'The Exhibition', timestamp: 1700001100000, forged: false },
        { id: 'seed-13', kenning: 'shadow-catcher', meaning: 'photographer', explanation: 'One who catches fleeting shadows of light and holds them still', contributor: 'The Exhibition', timestamp: 1700001200000, forged: false },
        { id: 'seed-14', kenning: 'word-web', meaning: 'internet', explanation: 'A web spun from words connecting all the world', contributor: 'The Exhibition', timestamp: 1700001300000, forged: false },
        { id: 'seed-15', kenning: 'moon-path', meaning: 'night shift', explanation: 'The path walked under moonlight while others sleep', contributor: 'The Exhibition', timestamp: 1700001400000, forged: false },
        { id: 'seed-16', kenning: 'ember-stick', meaning: 'cigarette', explanation: 'A small stick glowing with its own slow fire', contributor: 'The Exhibition', timestamp: 1700001500000, forged: false },
        { id: 'seed-17', kenning: 'rain-shield', meaning: 'umbrella', explanation: 'A portable shield against the sky-water', contributor: 'The Exhibition', timestamp: 1700001600000, forged: false },
        { id: 'seed-18', kenning: 'thought-loom', meaning: 'brain', explanation: 'The loom where thoughts are woven into meaning', contributor: 'The Exhibition', timestamp: 1700001700000, forged: false },
        { id: 'seed-19', kenning: 'time-thief', meaning: 'procrastination', explanation: 'The invisible thief that steals hours unnoticed', contributor: 'The Exhibition', timestamp: 1700001800000, forged: false },
        { id: 'seed-20', kenning: 'echo-hall', meaning: 'concert venue', explanation: 'A hall built for echoes, where sound fills every corner', contributor: 'The Exhibition', timestamp: 1700001900000, forged: false }
    ];

    // ========== STATE ==========
    let allKennings = [];
    let currentSort = 'newest';
    let searchTerm = '';
    let heartedThisSession = new Set();

    // ========== DATA LAYER ==========
    function loadData() {
        // Load community kennings
        let community = [];
        try {
            const raw = localStorage.getItem(KEYS.community);
            if (raw) community = JSON.parse(raw);
        } catch (e) { /* ignore parse errors */ }

        // Load forged kennings
        let forged = [];
        try {
            const raw = localStorage.getItem(KEYS.forged);
            if (raw) {
                const parsed = JSON.parse(raw);
                forged = parsed.map(f => ({
                    id: f.id || ('forged-' + (f.kenning || '').replace(/\s/g, '-') + '-' + (f.timestamp || Date.now())),
                    kenning: f.kenning || f.text || '',
                    meaning: f.meaning || f.subject || '',
                    explanation: f.explanation || '',
                    contributor: f.contributor || 'The Forge',
                    timestamp: f.timestamp || Date.now(),
                    forged: true
                }));
            }
        } catch (e) { /* ignore */ }

        // Combine: seeds + forged + community
        allKennings = [...SEED_KENNINGS, ...forged, ...community];
    }

    function saveCommunity() {
        const community = allKennings.filter(k => !k.id.startsWith('seed-') && !k.forged);
        try {
            localStorage.setItem(KEYS.community, JSON.stringify(community));
        } catch (e) { /* storage full */ }
    }

    function loadHearts() {
        try {
            const raw = localStorage.getItem(KEYS.hearts);
            return raw ? JSON.parse(raw) : {};
        } catch (e) {
            return {};
        }
    }

    function saveHearts(hearts) {
        try {
            localStorage.setItem(KEYS.hearts, JSON.stringify(hearts));
        } catch (e) { /* ignore */ }
    }

    function getHeartCount(id) {
        const hearts = loadHearts();
        return hearts[id] || 0;
    }

    function toggleHeart(id) {
        const hearts = loadHearts();
        if (heartedThisSession.has(id)) {
            hearts[id] = Math.max(0, (hearts[id] || 0) - 1);
            heartedThisSession.delete(id);
        } else {
            hearts[id] = (hearts[id] || 0) + 1;
            heartedThisSession.add(id);
        }
        saveHearts(hearts);
        return hearts[id];
    }

    // ========== RENDERING ==========
    function getFilteredSorted() {
        let list = [...allKennings];

        // Filter by search
        if (searchTerm) {
            const term = searchTerm.toLowerCase();
            list = list.filter(k =>
                k.kenning.toLowerCase().includes(term) ||
                k.meaning.toLowerCase().includes(term) ||
                (k.contributor || '').toLowerCase().includes(term) ||
                (k.explanation || '').toLowerCase().includes(term)
            );
        }

        // Sort
        const hearts = loadHearts();
        switch (currentSort) {
            case 'newest':
                list.sort((a, b) => b.timestamp - a.timestamp);
                break;
            case 'hearts':
                list.sort((a, b) => (hearts[b.id] || 0) - (hearts[a.id] || 0));
                break;
            case 'random':
                for (let i = list.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [list[i], list[j]] = [list[j], list[i]];
                }
                break;
        }

        return list;
    }

    function formatDate(ts) {
        const d = new Date(ts);
        const now = new Date();
        const diff = now - d;
        if (diff < 60000) return 'just now';
        if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
        if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
        if (diff < 604800000) return Math.floor(diff / 86400000) + 'd ago';
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: d.getFullYear() !== now.getFullYear() ? 'numeric' : undefined });
    }

    function escapeHTML(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function renderWall() {
        const wall = document.getElementById('community-wall');
        const list = getFilteredSorted();
        const hearts = loadHearts();

        if (list.length === 0) {
            wall.innerHTML = '<div class="empty-state"><div class="empty-icon">&#x2618;</div><p>No kennings found. Be the first to contribute!</p></div>';
            return;
        }

        wall.innerHTML = list.map(k => {
            const heartCount = hearts[k.id] || 0;
            const isHearted = heartedThisSession.has(k.id);
            const isForged = k.forged;
            return `<article class="rune-card" data-id="${escapeHTML(k.id)}">
                ${isForged ? '<span class="forge-badge" title="Forged in the Kenning Forge">&#x2692;</span>' : ''}
                <div class="kenning-text">${escapeHTML(k.kenning)}</div>
                <div class="meaning-text">= ${escapeHTML(k.meaning)}</div>
                ${k.explanation ? '<div class="explanation-text">' + escapeHTML(k.explanation) + '</div>' : ''}
                <div class="card-footer">
                    <div>
                        <div class="contributor">-- <span class="name">${escapeHTML(k.contributor || 'Anonymous Skald')}</span></div>
                        <div class="timestamp">${formatDate(k.timestamp)}</div>
                    </div>
                    <div class="heart-area">
                        <button class="heart-btn${isHearted ? ' hearted' : ''}" data-id="${escapeHTML(k.id)}" aria-label="Heart this kenning" title="Heart">&#x2665;</button>
                        <span class="heart-count">${heartCount}</span>
                    </div>
                </div>
            </article>`;
        }).join('');

        // Heart button listeners
        wall.querySelectorAll('.heart-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.dataset.id;
                const count = toggleHeart(id);
                this.classList.toggle('hearted');
                this.closest('.heart-area').querySelector('.heart-count').textContent = count;
                updateStats();
            });
        });
    }

    function updateStats() {
        const hearts = loadHearts();
        document.getElementById('stat-total').textContent = allKennings.length;

        const contributors = new Set(allKennings.map(k => k.contributor || 'Anonymous Skald'));
        document.getElementById('stat-contributors').textContent = contributors.size;

        // Find most popular
        let maxId = null;
        let maxCount = 0;
        for (const [id, count] of Object.entries(hearts)) {
            if (count > maxCount) {
                maxCount = count;
                maxId = id;
            }
        }
        if (maxId && maxCount > 0) {
            const popular = allKennings.find(k => k.id === maxId);
            document.getElementById('stat-popular').textContent = popular ? popular.kenning : '--';
        } else {
            document.getElementById('stat-popular').textContent = '--';
        }
    }

    // ========== FORM HANDLING ==========
    function initForm() {
        const form = document.getElementById('contribute-form');
        const errorEl = document.getElementById('form-error');
        const successEl = document.getElementById('form-success');

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            errorEl.classList.remove('visible');
            successEl.classList.remove('visible');

            const kenning = document.getElementById('input-kenning').value.trim();
            const meaning = document.getElementById('input-meaning').value.trim();
            const explanation = document.getElementById('input-explanation').value.trim();
            const name = document.getElementById('input-name').value.trim() || 'Anonymous Skald';

            if (!kenning || !meaning) {
                errorEl.textContent = 'Both kenning and meaning are required.';
                errorEl.classList.add('visible');
                return;
            }

            // Check for duplicates
            const dup = allKennings.find(k => k.kenning.toLowerCase() === kenning.toLowerCase());
            if (dup) {
                errorEl.textContent = 'This kenning already exists in the Living Edda.';
                errorEl.classList.add('visible');
                return;
            }

            const newKenning = {
                id: 'community-' + Date.now() + '-' + Math.random().toString(36).slice(2, 8),
                kenning: kenning,
                meaning: meaning,
                explanation: explanation,
                contributor: name,
                timestamp: Date.now(),
                forged: false
            };

            allKennings.push(newKenning);
            saveCommunity();

            // Reset form
            form.reset();
            successEl.classList.add('visible');
            setTimeout(function() { successEl.classList.remove('visible'); }, 3000);

            // Show companion artwork
            showCompanionArtwork();

            // Re-render
            renderWall();
            updateStats();
        });
    }

    // ========== CONTROLS ==========
    function initControls() {
        // Sort buttons
        document.querySelectorAll('.sort-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentSort = this.dataset.sort;
                renderWall();
            });
        });

        // Search
        let searchTimeout;
        document.getElementById('search-input').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchTerm = this.value.trim();
                renderWall();
            }, 250);
        });

        // Export
        document.getElementById('export-btn').addEventListener('click', exportKennings);
    }

    function exportKennings() {
        const hearts = loadHearts();
        let text = 'THE LIVING EDDA\n';
        text += 'A collection of modern kennings\n';
        text += '================================\n\n';

        allKennings.forEach(k => {
            text += '"' + k.kenning + '" = ' + k.meaning + '\n';
            if (k.explanation) text += '  ' + k.explanation + '\n';
            text += '  -- ' + (k.contributor || 'Anonymous Skald');
            const hc = hearts[k.id] || 0;
            if (hc > 0) text += ' (' + hc + ' hearts)';
            text += '\n\n';
        });

        text += '================================\n';
        text += 'Exported from The Kenning Exhibition\n';
        text += new Date().toISOString().split('T')[0] + '\n';

        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'living-edda-kennings.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // ========== NAVIGATION ==========
    function initNav() {
        const nav = document.getElementById('exhibition-nav');
        const hamburger = document.getElementById('hamburger');
        const overlay = document.getElementById('nav-overlay');
        const transition = document.getElementById('room-transition');
        const navLinks = document.querySelectorAll('.nav-link');

        if (hamburger) {
            hamburger.addEventListener('click', function() {
                nav.classList.toggle('open');
                overlay.classList.toggle('visible');
            });
        }

        if (overlay) {
            overlay.addEventListener('click', function() {
                nav.classList.remove('open');
                overlay.classList.remove('visible');
            });
        }

        navLinks.forEach(function(link) {
            link.addEventListener('click', function(e) {
                if (link.classList.contains('active')) {
                    e.preventDefault();
                    return;
                }
                e.preventDefault();
                transition.classList.add('active');
                setTimeout(function() {
                    window.location.href = link.href;
                }, 400);
            });
        });

        window.addEventListener('load', function() {
            transition.classList.add('active');
            requestAnimationFrame(function() {
                requestAnimationFrame(function() {
                    transition.classList.remove('active');
                });
            });
        });
    }

    // ========== WEB AUDIO ==========
    class RoomAmbience {
        constructor() {
            this.ctx = null;
            this.isPlaying = false;
        }

        init() {
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            this.master = this.ctx.createGain();
            this.master.gain.value = 0;
            this.master.connect(this.ctx.destination);

            // Lowpass filter
            this.filter = this.ctx.createBiquadFilter();
            this.filter.type = 'lowpass';
            this.filter.frequency.value = 600;
            this.filter.Q.value = 1;
            this.filter.connect(this.master);

            // Drone 1 - F3 175 Hz triangle
            this.osc1 = this.ctx.createOscillator();
            this.osc1.type = 'triangle';
            this.osc1.frequency.value = 175;
            this.gain1 = this.ctx.createGain();
            this.gain1.gain.value = 0.3;
            this.osc1.connect(this.gain1);
            this.gain1.connect(this.filter);
            this.osc1.start();

            // Drone 2 - perfect fifth sine
            this.osc2 = this.ctx.createOscillator();
            this.osc2.type = 'sine';
            this.osc2.frequency.value = 175 * 1.5;
            this.gain2 = this.ctx.createGain();
            this.gain2.gain.value = 0.15;
            this.osc2.connect(this.gain2);
            this.gain2.connect(this.filter);
            this.osc2.start();

            // LFO for organic movement
            this.lfo = this.ctx.createOscillator();
            this.lfo.type = 'sine';
            this.lfo.frequency.value = 0.05;
            this.lfoGain = this.ctx.createGain();
            this.lfoGain.gain.value = 180;
            this.lfo.connect(this.lfoGain);
            this.lfoGain.connect(this.filter.frequency);
            this.lfo.start();
        }

        fadeIn(duration) {
            duration = duration || 3;
            if (!this.ctx) this.init();
            if (this.ctx.state === 'suspended') this.ctx.resume();
            this.master.gain.cancelScheduledValues(this.ctx.currentTime);
            this.master.gain.setValueAtTime(this.master.gain.value, this.ctx.currentTime);
            this.master.gain.linearRampToValueAtTime(0.12, this.ctx.currentTime + duration);
            this.isPlaying = true;
        }

        fadeOut(duration) {
            duration = duration || 2;
            if (!this.ctx) return;
            this.master.gain.cancelScheduledValues(this.ctx.currentTime);
            this.master.gain.setValueAtTime(this.master.gain.value, this.ctx.currentTime);
            this.master.gain.linearRampToValueAtTime(0, this.ctx.currentTime + duration);
            this.isPlaying = false;
        }

        toggle() {
            this.isPlaying ? this.fadeOut() : this.fadeIn();
        }
    }

    function initAudio() {
        const ambience = new RoomAmbience();
        const toggleBtn = document.getElementById('audio-toggle');
        let audioOn = false;

        try {
            audioOn = localStorage.getItem(KEYS.audio) === 'true';
        } catch (e) { /* ignore */ }

        if (audioOn) {
            toggleBtn.classList.remove('muted');
        }

        toggleBtn.addEventListener('click', function() {
            ambience.toggle();
            audioOn = !audioOn;
            toggleBtn.classList.toggle('muted', !audioOn);
            try { localStorage.setItem(KEYS.audio, audioOn); } catch (e) { /* ignore */ }
        });

        // If audio was on, start on first interaction
        if (audioOn) {
            var startAudio = function() {
                ambience.fadeIn();
                toggleBtn.classList.remove('muted');
                document.removeEventListener('click', startAudio);
                document.removeEventListener('keydown', startAudio);
            };
            document.addEventListener('click', startAudio, { once: true });
            document.addEventListener('keydown', startAudio, { once: true });
        }
    }

    // ========== P5.JS BACKDROP - Growing Vines / Yggdrasil ==========
    function initBackdrop() {
        var vineSketch = function(p) {
            var vines = [];
            var maxVines = 12;
            var w, h;

            function Vine(startX, startY, angle, speed) {
                this.points = [{ x: startX, y: startY }];
                this.angle = angle;
                this.speed = speed || 0.8;
                this.thickness = p.random(1.5, 4);
                this.growing = true;
                this.maxLen = p.random(80, 300);
                this.branches = [];
                this.color = p.color(
                    58 + p.random(-10, 10),
                    125 + p.random(-20, 20),
                    68 + p.random(-10, 10),
                    p.random(60, 120)
                );
                this.leafChance = 0.004;
                this.leaves = [];
            }

            Vine.prototype.grow = function() {
                if (!this.growing) return;
                var last = this.points[this.points.length - 1];
                this.angle += p.random(-0.15, 0.15);
                var nx = last.x + Math.cos(this.angle) * this.speed;
                var ny = last.y + Math.sin(this.angle) * this.speed;
                this.points.push({ x: nx, y: ny });

                if (this.points.length >= this.maxLen) {
                    this.growing = false;
                }

                // Occasional leaf
                if (Math.random() < this.leafChance && this.points.length > 10) {
                    this.leaves.push({
                        x: nx, y: ny,
                        size: p.random(3, 8),
                        angle: this.angle + p.random(-0.5, 0.5)
                    });
                }

                // Branch
                if (this.points.length > 20 && Math.random() < 0.003 && this.branches.length < 3) {
                    var branchAngle = this.angle + p.random(-1, 1);
                    var branch = new Vine(nx, ny, branchAngle, this.speed * 0.7);
                    branch.thickness = this.thickness * 0.6;
                    branch.maxLen = this.maxLen * 0.5;
                    this.branches.push(branch);
                }
            };

            Vine.prototype.draw = function() {
                if (this.points.length < 2) return;
                p.noFill();
                p.stroke(this.color);

                for (var i = 1; i < this.points.length; i++) {
                    var t = 1 - (i / this.points.length);
                    p.strokeWeight(this.thickness * t);
                    p.line(this.points[i - 1].x, this.points[i - 1].y, this.points[i].x, this.points[i].y);
                }

                // Draw leaves
                p.noStroke();
                for (var j = 0; j < this.leaves.length; j++) {
                    var lf = this.leaves[j];
                    p.push();
                    p.translate(lf.x, lf.y);
                    p.rotate(lf.angle);
                    p.fill(58, 145, 68, 80);
                    p.ellipse(0, 0, lf.size * 2, lf.size);
                    // Golden leaf accent
                    if (Math.random() < 0.3) {
                        p.fill(230, 192, 105, 50);
                        p.ellipse(0, 0, lf.size * 1.2, lf.size * 0.6);
                    }
                    p.pop();
                }

                // Draw branches
                for (var b = 0; b < this.branches.length; b++) {
                    this.branches[b].draw();
                }
            };

            Vine.prototype.update = function() {
                this.grow();
                for (var b = 0; b < this.branches.length; b++) {
                    this.branches[b].update();
                }
            };

            function spawnVine() {
                var edge = Math.floor(p.random(4));
                var sx, sy, angle;
                if (edge === 0) { sx = 0; sy = p.random(h); angle = p.random(-0.5, 0.5); }
                else if (edge === 1) { sx = w; sy = p.random(h); angle = p.PI + p.random(-0.5, 0.5); }
                else if (edge === 2) { sx = p.random(w); sy = h; angle = -p.HALF_PI + p.random(-0.5, 0.5); }
                else { sx = p.random(w); sy = 0; angle = p.HALF_PI + p.random(-0.5, 0.5); }
                return new Vine(sx, sy, angle);
            }

            p.setup = function() {
                var container = document.getElementById('p5-backdrop');
                w = container.offsetWidth;
                h = container.offsetHeight;
                var cnv = p.createCanvas(w, h);
                cnv.parent('p5-backdrop');
                p.frameRate(30);
                p.background(26, 26, 46, 255);

                // Scale vine count to number of kennings (more kennings = more vines)
                var kenningCount = allKennings.length;
                var vineCount = Math.min(maxVines, Math.max(4, Math.floor(kenningCount / 5)));
                for (var i = 0; i < vineCount; i++) {
                    vines.push(spawnVine());
                }
            };

            p.draw = function() {
                p.background(26, 26, 46, 8);

                for (var i = 0; i < vines.length; i++) {
                    vines[i].update();
                    vines[i].draw();
                }

                // Spawn new vines periodically
                if (p.frameCount % 180 === 0 && vines.length < maxVines + Math.floor(allKennings.length / 10)) {
                    vines.push(spawnVine());
                }

                // Remove old fully-grown vines slowly
                if (vines.length > maxVines + 5 && p.frameCount % 300 === 0) {
                    var oldest = vines.find(function(v) { return !v.growing; });
                    if (oldest) {
                        var idx = vines.indexOf(oldest);
                        vines.splice(idx, 1);
                    }
                }
            };

            p.windowResized = function() {
                var container = document.getElementById('p5-backdrop');
                w = container.offsetWidth;
                h = container.offsetHeight;
                p.resizeCanvas(w, h);
            };
        };

        new p5(vineSketch);
    }

    // ========== IMAGE INTEGRATION (StoryLeaf Kenning Collection) ==========
    var STORYLEAF_BASE = 'https://kenning.storyleaf.ai/img/';

    function getRandomImages(count) {
        if (typeof kenningImagesData === 'undefined') return [];
        var shuffled = kenningImagesData.slice().sort(function() { return Math.random() - 0.5; });
        return shuffled.slice(0, count);
    }

    function getRandomImage() {
        var imgs = getRandomImages(1);
        return imgs.length > 0 ? imgs[0] : null;
    }

    function openLightbox(filename, caption, artist) {
        var lb = document.getElementById('kenning-lightbox');
        var img = document.getElementById('lightbox-img');
        var cap = document.getElementById('lightbox-caption');
        var cred = document.getElementById('lightbox-credit');
        img.src = STORYLEAF_BASE + encodeURIComponent(filename);
        img.alt = caption;
        cap.textContent = caption;
        cred.innerHTML = 'Art by ' + escapeHTML(artist) + ' &mdash; <a href="https://kenning.storyleaf.ai" target="_blank" rel="noopener">StoryLeaf Kenning Collection</a>';
        lb.classList.add('visible');
    }

    function initLightbox() {
        var lb = document.getElementById('kenning-lightbox');
        if (!lb) return;
        lb.addEventListener('click', function(e) {
            if (e.target === lb || e.target.classList.contains('lightbox-close')) {
                lb.classList.remove('visible');
            }
        });
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && lb.classList.contains('visible')) {
                lb.classList.remove('visible');
            }
        });
    }

    function buildClickableImage(img, wrapperClass) {
        var div = document.createElement('div');
        div.className = wrapperClass;
        div.setAttribute('data-filename', img.filename);
        div.setAttribute('data-caption', img.caption);
        div.setAttribute('data-artist', img.artist);
        div.addEventListener('click', function() {
            openLightbox(img.filename, img.caption, img.artist);
        });

        var imgEl = document.createElement('img');
        imgEl.src = STORYLEAF_BASE + encodeURIComponent(img.filename);
        imgEl.alt = img.caption;
        imgEl.loading = 'lazy';
        div.appendChild(imgEl);

        return div;
    }

    function populateIllustratedKennings() {
        var container = document.getElementById('illustrated-masonry');
        if (!container || typeof kenningImagesData === 'undefined') return;
        var images = getRandomImages(12);
        container.innerHTML = '';
        images.forEach(function(img) {
            var item = buildClickableImage(img, 'illustrated-item');

            var caption = document.createElement('div');
            caption.className = 'illust-caption';
            caption.textContent = img.caption;
            item.appendChild(caption);

            var artist = document.createElement('div');
            artist.className = 'illust-artist';
            artist.textContent = img.artist;
            item.appendChild(artist);

            container.appendChild(item);
        });
    }

    function populateFormInspiration() {
        var container = document.getElementById('form-inspiration');
        if (!container || typeof kenningImagesData === 'undefined') return;
        var img = getRandomImage();
        if (!img) return;

        container.innerHTML = '';
        var label = document.createElement('div');
        label.className = 'form-inspiration-label';
        label.textContent = 'Seek inspiration...';
        container.appendChild(label);

        var item = buildClickableImage(img, 'form-inspiration-img');

        var credit = document.createElement('div');
        credit.className = 'img-credit';
        credit.textContent = '"' + img.caption + '" \u2014 ' + img.artist;
        item.appendChild(credit);

        container.appendChild(item);
    }

    function showCompanionArtwork() {
        var container = document.getElementById('companion-artwork');
        if (!container || typeof kenningImagesData === 'undefined') return;
        var img = getRandomImage();
        if (!img) return;

        container.innerHTML = '';
        var label = document.createElement('div');
        label.className = 'companion-label';
        label.textContent = 'A companion artwork for your new kenning:';
        container.appendChild(label);

        var item = buildClickableImage(img, 'form-inspiration-img');

        var credit = document.createElement('div');
        credit.className = 'img-credit';
        credit.textContent = '"' + img.caption + '" \u2014 ' + img.artist;
        item.appendChild(credit);

        container.appendChild(item);
        container.classList.add('visible');
    }

    function initImages() {
        initLightbox();
        populateIllustratedKennings();
        populateFormInspiration();
    }

    // ========== INIT ==========
    function init() {
        loadData();
        renderWall();
        updateStats();
        initForm();
        initControls();
        initNav();
        initAudio();
        initBackdrop();
        initImages();
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    // Expose reset for enhance.js
    window.reset = function() {
        loadData();
        currentSort = 'newest';
        searchTerm = '';
        document.getElementById('search-input').value = '';
        document.querySelectorAll('.sort-btn').forEach(function(b) { b.classList.remove('active'); });
        document.querySelector('.sort-btn[data-sort="newest"]').classList.add('active');
        renderWall();
        updateStats();
    };
})();
</script>
<script src="../assets/js/enhance.js" defer></script>
</body>
</html>
