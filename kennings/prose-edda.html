<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prose Edda Room | The Kenning Exhibition</title>
    <meta name="description" content="Explore kennings from Snorri Sturluson's Gylfaginning -- mythological metaphors from the Prose Edda, organized by the Nine Worlds of Norse cosmology.">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>&#x2744;</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400;1,600&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <style>
        :root {
            --bg-deep: #1a1a2e;
            --bg-mid: #16213e;
            --bg-surface: #1f2641;
            --gold: #e6c069;
            --gold-dim: #b8944d;
            --parchment: #d4c5a9;
            --parchment-dim: #9e9279;
            --ink: #0d0d1a;
            --glow: rgba(230, 192, 105, 0.15);
            --accent: #4a8fa8;
            --accent-glow: rgba(74, 143, 168, 0.12);
            --font-display: 'EB Garamond', 'Georgia', serif;
            --font-body: 'Inter', 'Helvetica Neue', sans-serif;
            --nav-width: 260px;
            --transition-room: 0.6s cubic-bezier(0.22, 1, 0.36, 1);
        }

        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: var(--font-body);
            background: var(--bg-deep);
            color: var(--parchment);
            line-height: 1.7;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Navigation */
        .exhibition-nav {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--nav-width);
            height: 100vh;
            background: linear-gradient(180deg, var(--ink) 0%, var(--bg-deep) 100%);
            border-right: 1px solid rgba(230, 192, 105, 0.08);
            padding: 30px 0;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1);
        }

        .exhibition-nav .nav-title {
            font-family: var(--font-display);
            font-size: 1.1rem;
            color: var(--gold);
            text-align: center;
            padding: 0 20px 25px;
            border-bottom: 1px solid rgba(230, 192, 105, 0.1);
            letter-spacing: 0.05em;
        }

        .exhibition-nav .nav-rooms {
            flex: 1;
            padding: 15px 0;
            overflow-y: auto;
        }

        .exhibition-nav .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: var(--parchment-dim);
            text-decoration: none;
            font-family: var(--font-body);
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .exhibition-nav .nav-link:hover {
            color: var(--gold);
            background: rgba(230, 192, 105, 0.05);
            border-left-color: var(--gold-dim);
        }

        .exhibition-nav .nav-link.active {
            color: var(--gold);
            background: rgba(230, 192, 105, 0.08);
            border-left-color: var(--accent);
        }

        .exhibition-nav .nav-icon {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        .exhibition-nav .nav-footer {
            padding: 15px 0;
            border-top: 1px solid rgba(230, 192, 105, 0.1);
        }

        .exhibition-nav .nav-back {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: var(--parchment-dim);
            text-decoration: none;
            font-family: var(--font-body);
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .exhibition-nav .nav-back:hover {
            color: var(--gold);
        }

        /* Mobile header */
        .mobile-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: var(--ink);
            border-bottom: 1px solid rgba(230, 192, 105, 0.1);
            align-items: center;
            padding: 0 16px;
            z-index: 999;
        }

        .hamburger {
            width: 40px;
            height: 40px;
            background: none;
            border: none;
            color: var(--gold);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .mobile-title {
            font-family: var(--font-display);
            color: var(--gold);
            font-size: 1rem;
            margin-left: 12px;
        }

        .nav-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 998;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .nav-overlay.visible {
            opacity: 1;
            pointer-events: all;
        }

        /* Room transition */
        .room-transition {
            position: fixed;
            inset: 0;
            background: var(--ink);
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }

        .room-transition.active {
            opacity: 1;
            pointer-events: all;
        }

        /* p5 backdrop */
        #p5-backdrop {
            position: fixed;
            top: 0;
            left: var(--nav-width);
            right: 0;
            bottom: 0;
            z-index: 0;
            opacity: 0.35;
            pointer-events: none;
        }

        #p5-backdrop canvas {
            display: block;
            width: 100% !important;
            height: 100% !important;
        }

        /* Main content */
        .exhibition-main {
            margin-left: var(--nav-width);
            min-height: 100vh;
            position: relative;
        }

        .room-content {
            position: relative;
            z-index: 1;
            padding: 60px 50px 80px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Room header */
        .room-header {
            margin-bottom: 50px;
        }

        .room-header h1 {
            font-family: var(--font-display);
            font-size: 2.4rem;
            font-weight: 600;
            color: var(--gold);
            margin-bottom: 8px;
        }

        .room-header .room-subtitle {
            font-family: var(--font-display);
            font-size: 1.15rem;
            font-style: italic;
            color: var(--parchment-dim);
            margin-bottom: 20px;
        }

        .room-header .room-desc {
            font-size: 0.95rem;
            color: var(--parchment);
            max-width: 700px;
            line-height: 1.8;
        }

        /* Filter sections */
        .filter-section {
            margin-bottom: 35px;
        }

        .filter-label {
            font-family: var(--font-body);
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--parchment-dim);
            margin-bottom: 12px;
        }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filter-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: rgba(74, 143, 168, 0.08);
            border: 1px solid rgba(74, 143, 168, 0.2);
            border-radius: 20px;
            color: var(--parchment);
            font-family: var(--font-body);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            background: rgba(74, 143, 168, 0.15);
            border-color: var(--accent);
        }

        .filter-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
        }

        .filter-btn .count-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            padding: 0 5px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .filter-btn.active .count-badge {
            background: rgba(255, 255, 255, 0.25);
        }

        /* Kenning card grid */
        .kenning-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 18px;
            margin-top: 30px;
        }

        /* Kenning cards */
        .kenning-card {
            background: rgba(31, 38, 65, 0.85);
            border: 1px solid rgba(74, 143, 168, 0.15);
            border-radius: 12px;
            padding: 22px 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .kenning-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .kenning-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent);
            box-shadow: 0 8px 30px rgba(74, 143, 168, 0.12);
        }

        .kenning-card:hover::before {
            opacity: 1;
        }

        .kenning-card .card-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-family: var(--font-body);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--accent);
            margin-bottom: 10px;
        }

        .kenning-card .card-badge .rune {
            font-size: 0.9rem;
        }

        .kenning-card .card-norse {
            font-family: var(--font-display);
            font-size: 1.3rem;
            font-style: italic;
            color: var(--gold);
            margin-bottom: 6px;
            letter-spacing: 0.02em;
        }

        .kenning-card .card-literal {
            font-family: var(--font-body);
            font-size: 0.9rem;
            color: var(--parchment);
            margin-bottom: 4px;
        }

        .kenning-card .card-meaning {
            font-family: var(--font-body);
            font-size: 0.85rem;
            color: var(--parchment-dim);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 4px;
        }

        .kenning-card .card-source {
            font-family: var(--font-body);
            font-size: 0.75rem;
            color: var(--parchment-dim);
            opacity: 0.7;
        }

        .kenning-card .card-expand {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(74, 143, 168, 0.15);
            font-size: 0.85rem;
            color: var(--parchment);
            line-height: 1.7;
            display: none;
        }

        .kenning-card .card-expand .logic-label {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--accent);
            margin-bottom: 4px;
        }

        .kenning-card.expanded .card-expand {
            display: block;
            animation: expandIn 0.3s ease;
        }

        @keyframes expandIn {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .kenning-card .expand-hint {
            font-size: 0.75rem;
            color: var(--parchment-dim);
            opacity: 0.5;
            margin-top: 8px;
            transition: opacity 0.3s ease;
        }

        .kenning-card:hover .expand-hint {
            opacity: 1;
        }

        .kenning-card.expanded .expand-hint {
            display: none;
        }

        /* Section dividers */
        .category-divider {
            margin: 50px 0 30px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .category-divider h2 {
            font-family: var(--font-display);
            font-size: 1.6rem;
            font-weight: 600;
            color: var(--gold);
            white-space: nowrap;
        }

        .category-divider .divider-line {
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, rgba(230, 192, 105, 0.3), transparent);
        }

        /* Count display */
        .results-count {
            font-size: 0.85rem;
            color: var(--parchment-dim);
            margin-bottom: 20px;
        }

        .results-count strong {
            color: var(--gold);
        }

        /* Audio toggle */
        .audio-toggle {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--bg-surface);
            border: 1px solid rgba(230, 192, 105, 0.15);
            color: var(--gold);
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .audio-toggle:hover {
            background: rgba(230, 192, 105, 0.15);
            transform: scale(1.1);
        }

        .audio-toggle.muted {
            color: var(--parchment-dim);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-deep);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gold-dim);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gold);
        }

        /* Hero image */
        .room-hero {
            position: relative;
            width: 100%;
            max-height: 380px;
            overflow: hidden;
            border-radius: 14px;
            margin-bottom: 40px;
            cursor: pointer;
        }

        .room-hero img {
            width: 100%;
            height: 380px;
            object-fit: cover;
            display: block;
            transition: transform 0.6s ease;
        }

        .room-hero:hover img {
            transform: scale(1.03);
        }

        .room-hero .hero-caption {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 40px 28px 18px;
            background: linear-gradient(transparent, rgba(13, 13, 26, 0.85));
            font-family: var(--font-display);
            font-size: 1.05rem;
            font-style: italic;
            color: var(--gold);
        }

        .room-hero .hero-credit {
            position: absolute;
            top: 12px;
            right: 14px;
            font-size: 0.65rem;
            color: rgba(212, 197, 169, 0.5);
            background: rgba(13, 13, 26, 0.5);
            padding: 3px 8px;
            border-radius: 4px;
        }

        /* Section atmospheric images */
        .section-image {
            grid-column: 1 / -1;
            position: relative;
            width: 100%;
            max-height: 220px;
            overflow: hidden;
            border-radius: 12px;
            margin: 10px 0;
            cursor: pointer;
        }

        .section-image img {
            width: 100%;
            height: 220px;
            object-fit: cover;
            display: block;
            transition: transform 0.5s ease, filter 0.5s ease;
            filter: brightness(0.8) saturate(1.1);
        }

        .section-image:hover img {
            transform: scale(1.04);
            filter: brightness(0.9) saturate(1.2);
        }

        .section-image .img-caption {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 30px 20px 12px;
            background: linear-gradient(transparent, rgba(13, 13, 26, 0.8));
            font-family: var(--font-display);
            font-size: 0.9rem;
            font-style: italic;
            color: var(--parchment);
        }

        .section-image .img-credit {
            position: absolute;
            top: 8px;
            right: 10px;
            font-size: 0.6rem;
            color: rgba(212, 197, 169, 0.4);
            background: rgba(13, 13, 26, 0.45);
            padding: 2px 6px;
            border-radius: 3px;
        }

        /* Lightbox modal */
        .lightbox-overlay {
            position: fixed;
            inset: 0;
            background: rgba(13, 13, 26, 0.94);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.35s ease;
            cursor: zoom-out;
        }

        .lightbox-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .lightbox-overlay img {
            max-width: 90vw;
            max-height: 88vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 12px 60px rgba(0, 0, 0, 0.6);
            transform: scale(0.92);
            transition: transform 0.35s cubic-bezier(0.22, 1, 0.36, 1);
        }

        .lightbox-overlay.active img {
            transform: scale(1);
        }

        .lightbox-caption {
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            font-family: var(--font-display);
            font-size: 1.1rem;
            font-style: italic;
            color: var(--gold);
            text-align: center;
            max-width: 600px;
        }

        .lightbox-credit {
            display: block;
            font-family: var(--font-body);
            font-size: 0.7rem;
            font-style: normal;
            color: var(--parchment-dim);
            margin-top: 6px;
        }

        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 24px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 50%;
            color: var(--parchment);
            font-size: 1.3rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }

        .lightbox-close:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Focus styles */
        *:focus-visible {
            outline: 2px solid var(--gold);
            outline-offset: 2px;
        }

        /* Responsive: Tablet */
        @media (max-width: 1023px) {
            :root {
                --nav-width: 60px;
            }

            .exhibition-nav .nav-label { display: none; }
            .exhibition-nav .nav-title { font-size: 0; padding: 15px 0; }
            .exhibition-nav .nav-title::after {
                content: 'KE';
                font-size: 0.9rem;
                display: block;
            }
            .exhibition-nav .nav-link { justify-content: center; padding: 14px 0; }
            .exhibition-nav .nav-icon { font-size: 1.4rem; }
            .exhibition-nav .nav-footer .nav-back { justify-content: center; }

            .room-content {
                padding: 40px 30px 60px;
            }
        }

        /* Responsive: Mobile */
        @media (max-width: 767px) {
            :root {
                --nav-width: 0px;
            }

            .exhibition-nav {
                transform: translateX(-100%);
                width: 280px;
            }

            .exhibition-nav.open {
                transform: translateX(0);
            }

            .mobile-header {
                display: flex;
            }

            .exhibition-main {
                margin-left: 0;
                padding-top: 56px;
            }

            .room-content {
                padding: 30px 18px 60px;
            }

            .room-header h1 {
                font-size: 1.8rem;
            }

            .kenning-grid {
                grid-template-columns: 1fr;
            }

            .filter-btn {
                font-size: 0.8rem;
                padding: 6px 12px;
            }

            .audio-toggle {
                bottom: 16px;
                right: 16px;
            }

            .room-hero, .room-hero img {
                max-height: 240px;
                height: 240px;
            }

            .section-image, .section-image img {
                max-height: 160px;
                height: 160px;
            }
        }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }

            #p5-backdrop { display: none; }
            .room-transition { display: none; }
        }
    </style>
</head>
<body>

<!-- Navigation -->
<nav class="exhibition-nav" id="exhibition-nav" role="navigation" aria-label="Exhibition rooms">
    <div class="nav-title">The Kenning Exhibition</div>
    <div class="nav-rooms">
        <a href="index.html" class="nav-link" data-room="hall">
            <span class="nav-icon">&#x2302;</span>
            <span class="nav-label">Exhibition Hall</span>
        </a>
        <a href="beowulf.html" class="nav-link" data-room="beowulf">
            <span class="nav-icon">&#x2694;</span>
            <span class="nav-label">Beowulf Room</span>
        </a>
        <a href="prose-edda.html" class="nav-link active" data-room="edda">
            <span class="nav-icon">&#x2744;</span>
            <span class="nav-label">Prose Edda</span>
        </a>
        <a href="skaldskaparmal.html" class="nav-link" data-room="skald">
            <span class="nav-icon">&#x270D;</span>
            <span class="nav-label">Skaldskaparmal</span>
        </a>
        <a href="kenning-forge.html" class="nav-link" data-room="forge">
            <span class="nav-icon">&#x2692;</span>
            <span class="nav-label">Kenning Forge</span>
        </a>
        <a href="living-edda.html" class="nav-link" data-room="living">
            <span class="nav-icon">&#x2618;</span>
            <span class="nav-label">Living Edda</span>
        </a>
        <a href="runic-gallery.html" class="nav-link" data-room="runic">
            <span class="nav-icon">&#x25CA;</span>
            <span class="nav-label">Runic Gallery</span>
        </a>
    </div>
    <div class="nav-footer">
        <a href="../index.html" class="nav-back">
            <span class="nav-icon">&#x2190;</span>
            <span class="nav-label">Back to CCAB</span>
        </a>
    </div>
</nav>

<!-- Mobile header -->
<header class="mobile-header" id="mobile-header">
    <button class="hamburger" id="hamburger" aria-label="Open navigation">&#x2630;</button>
    <span class="mobile-title">The Kenning Exhibition</span>
</header>

<!-- Mobile overlay -->
<div class="nav-overlay" id="nav-overlay"></div>

<!-- Room transition -->
<div class="room-transition" id="room-transition"></div>

<!-- p5 backdrop -->
<div id="p5-backdrop"></div>

<!-- Audio toggle -->
<button class="audio-toggle muted" id="audio-toggle" aria-label="Toggle ambient audio" title="Toggle ambient audio">
    <span id="audio-icon">&#x1F507;</span>
</button>

<!-- Main content -->
<main class="exhibition-main">
    <div class="room-content">

        <!-- Room header -->
        <section class="room-header" aria-label="Room introduction">
            <h1>The Prose Edda Room</h1>
            <p class="room-subtitle">"Snorri Sturluson's mythological kennings from Gylfaginning"</p>
            <p class="room-desc">
                In the Gylfaginning, King Gylfi travels to Asgard disguised as Gangleri, where three cosmic
                figures -- High, Just-as-High, and Third -- reveal the mythology of the Norse cosmos.
                The kennings that emerge from this dialogue are woven into the fabric of creation itself,
                from the roots of Yggdrasil to the fires of Ragnarok.
            </p>
        </section>

        <!-- Hero image -->
        <div class="room-hero" onclick="openLightbox(this)">
            <img src="https://kenning.storyleaf.ai/img/kenning-0131.png" alt="The Mountain is Sacred-place -- a luminous peak ascending into cosmic mist, evoking Yggdrasil and the nine worlds of Norse cosmology" loading="lazy" data-caption="The Mountain is Sacred-place">
            <div class="hero-caption">"The Mountain is Sacred-place" -- Yggdrasil rises where all worlds converge</div>
            <div class="hero-credit">storyleaf.ai</div>
        </div>

        <!-- Nine Worlds filter -->
        <section class="filter-section" aria-label="Filter by Nine Worlds">
            <div class="filter-label">The Nine Worlds</div>
            <div class="filter-row" id="world-filters"></div>
        </section>

        <!-- Deity filter -->
        <section class="filter-section" aria-label="Filter by deity">
            <div class="filter-label">By Deity &amp; Element</div>
            <div class="filter-row" id="deity-filters"></div>
        </section>

        <!-- Results count -->
        <div class="results-count" id="results-count"></div>

        <!-- Kenning cards -->
        <div class="kenning-grid" id="kenning-grid" role="list" aria-label="Kenning cards"></div>

    </div>
</main>

<!-- Lightbox modal -->
<div class="lightbox-overlay" id="lightbox-overlay" onclick="closeLightbox()">
    <button class="lightbox-close" onclick="event.stopPropagation(); closeLightbox()" aria-label="Close lightbox">&times;</button>
    <img id="lightbox-img" src="" alt="" onclick="event.stopPropagation()">
    <div class="lightbox-caption" id="lightbox-caption" onclick="event.stopPropagation()"></div>
</div>

<script>
// ============================================================
// KENNING DATA -- All Gylfaginning kennings from research-data
// ============================================================
const kennings = [
    // Cosmic Structures
    { norse: "Yggdrasill", literal: "Odin's steed / gallows", meaning: "The World-Tree", source: "Gylfaginning Ch. 15-17", logic: "The ash tree from which Odin hung is his 'horse' (gallows = horse of the hanged)", category: "cosmic", deity: "odin", world: "asgard", rune: "\u16A6" },
    { norse: "askr Yggdrasils", literal: "Ash of Yggdrasil", meaning: "The World-Tree", source: "Gylfaginning Ch. 15", logic: "The great ash that holds the nine worlds", category: "cosmic", deity: "cosmic", world: "asgard", rune: "\u16C7" },
    { norse: "Bifr\u00F6st", literal: "Trembling road", meaning: "The rainbow bridge", source: "Gylfaginning Ch. 13", logic: "The bridge that shimmers and trembles between worlds", category: "cosmic", deity: "cosmic", world: "asgard", rune: "\u16B1" },
    { norse: "Ginnungagap", literal: "Yawning void", meaning: "The primordial void", source: "Gylfaginning Ch. 4-5", logic: "The great gap before creation -- the nothingness from which all emerged", category: "cosmic", deity: "cosmic", world: "niflheim", rune: "\u16B7" },
    { norse: "Hvergelmir", literal: "Roaring kettle", meaning: "Primordial spring", source: "Gylfaginning Ch. 4", logic: "The bubbling spring in Niflheim from which rivers of ice flow", category: "cosmic", deity: "cosmic", world: "niflheim", rune: "\u16BA" },
    { norse: "Ur\u00F0arbrunnr", literal: "Well of fate", meaning: "Well of destiny", source: "Gylfaginning Ch. 15", logic: "The well tended by the Norns where the gods hold council", category: "cosmic", deity: "cosmic", world: "asgard", rune: "\u16C8" },
    { norse: "M\u00EDmisbrunnr", literal: "Mimir's well", meaning: "Well of wisdom", source: "Gylfaginning Ch. 15", logic: "The well where Odin sacrificed his eye for a drink of wisdom", category: "cosmic", deity: "odin", world: "jotunheim", rune: "\u16D7" },

    // Odin kennings
    { norse: "Alf\u00F6\u00F0r", literal: "Allfather", meaning: "Odin", source: "Gylfaginning Ch. 3, 9, 20", logic: "Father of all gods and men", category: "odin", deity: "odin", world: "asgard", rune: "\u16A8" },
    { norse: "Valf\u00F6\u00F0r", literal: "Father of the Slain", meaning: "Odin", source: "Gylfaginning Ch. 20", logic: "He who chooses the battle-dead for Valhalla", category: "odin", deity: "odin", world: "asgard", rune: "\u16A8" },
    { norse: "Herjaf\u00F6\u00F0r", literal: "Father of Hosts", meaning: "Odin", source: "Gylfaginning Ch. 20", logic: "Father and leader of the warrior-hosts", category: "odin", deity: "odin", world: "asgard", rune: "\u16A8" },
    { norse: "Sigf\u00F6\u00F0r", literal: "Father of Victory", meaning: "Odin", source: "Gylfaginning Ch. 20", logic: "The one who grants triumph in battle", category: "odin", deity: "odin", world: "asgard", rune: "\u16A8" },
    { norse: "Hangagu\u00F0", literal: "Hanged God", meaning: "Odin", source: "Gylfaginning Ch. 20", logic: "He who hung on Yggdrasil for nine nights to gain the runes", category: "odin", deity: "odin", world: "asgard", rune: "\u16A8" },
    { norse: "Hrafnagu\u00F0", literal: "Raven God", meaning: "Odin", source: "Gylfaginning Ch. 38", logic: "Lord of Huginn and Muninn, who bring him news of all the worlds", category: "odin", deity: "odin", world: "asgard", rune: "\u16A8" },
    { norse: "Sigrunnr", literal: "Victory-rune", meaning: "Odin", source: "Gylfaginning (various)", logic: "Master of runic victory-magic", category: "odin", deity: "odin", world: "asgard", rune: "\u16A8" },
    { norse: "Ygg", literal: "The Terrible One", meaning: "Odin", source: "Gylfaginning (name-list)", logic: "He who inspires awe and dread in all who behold him", category: "odin", deity: "odin", world: "asgard", rune: "\u16A8" },
    { norse: "Gr\u00EDmnir", literal: "The Masked One", meaning: "Odin", source: "Gylfaginning (name-list)", logic: "He who travels the worlds in disguise, testing mortals", category: "odin", deity: "odin", world: "midgard", rune: "\u16A8" },
    { norse: "Blindr", literal: "The Blind One", meaning: "Odin (ironic)", source: "Gylfaginning", logic: "Ironic kenning for the one-eyed god who sacrificed sight for wisdom", category: "odin", deity: "odin", world: "asgard", rune: "\u16A8" },

    // Odin's Companions and Possessions
    { norse: "Huginn ok Muninn", literal: "Thought and Memory", meaning: "Odin's ravens", source: "Gylfaginning Ch. 38", logic: "Ravens embody the twin powers of the mind", category: "odin", deity: "odin", world: "asgard", rune: "\u16A8" },
    { norse: "Sleipnir", literal: "The Slipper / Glider", meaning: "Odin's eight-legged horse", source: "Gylfaginning Ch. 42", logic: "The horse that glides between worlds, born of Loki", category: "odin", deity: "odin", world: "asgard", rune: "\u16B1" },
    { norse: "Gungnir", literal: "The Swaying One", meaning: "Odin's spear", source: "Gylfaginning Ch. 51", logic: "The spear that sways and trembles when thrown, never missing its mark", category: "odin", deity: "odin", world: "asgard", rune: "\u16C7" },
    { norse: "Draupnir", literal: "The Dripper", meaning: "Odin's ring", source: "Gylfaginning Ch. 49", logic: "The ring from which eight new rings drip every ninth night", category: "odin", deity: "odin", world: "asgard", rune: "\u16A0" },
    { norse: "Hli\u00F0skj\u00E1lf", literal: "Gate-shelf", meaning: "Odin's high seat", source: "Gylfaginning Ch. 17", logic: "The throne from which all nine worlds are seen", category: "odin", deity: "odin", world: "asgard", rune: "\u16BA" },
    { norse: "Geri ok Freki", literal: "Greedy and Ravenous", meaning: "Odin's wolves", source: "Gylfaginning Ch. 38", logic: "Wolves that embody battle-hunger, fed all of Odin's food", category: "odin", deity: "odin", world: "asgard", rune: "\u16A2" },
    { norse: "Valh\u00F6ll", literal: "Hall of the Slain", meaning: "Valhalla", source: "Gylfaginning Ch. 36-40", logic: "The great hall where chosen warriors feast until Ragnarok", category: "odin", deity: "odin", world: "asgard", rune: "\u16A0" },
    { norse: "Einherjar", literal: "Lone fighters", meaning: "Valhalla's warriors", source: "Gylfaginning Ch. 40-41", logic: "Warriors who fight alone -- chosen from the best of the slain", category: "odin", deity: "odin", world: "asgard", rune: "\u16CF" },

    // Thor kennings
    { norse: "\u00C1sa-\u00DE\u00F3rr", literal: "Thor of the Aesir", meaning: "Thor", source: "Gylfaginning Ch. 21", logic: "Thor distinguished among the gods as champion of Asgard", category: "thor", deity: "thor", world: "asgard", rune: "\u16A6" },
    { norse: "\u00D6ku-\u00DE\u00F3rr", literal: "Driving-Thor / Chariot-Thor", meaning: "Thor", source: "Gylfaginning Ch. 21", logic: "Thor who drives his goat-chariot across the sky, causing thunder", category: "thor", deity: "thor", world: "midgard", rune: "\u16A6" },
    { norse: "Einri\u00F0i", literal: "Lone rider", meaning: "Thor", source: "Gylfaginning Ch. 21", logic: "Thor who rides alone into battle against the giants", category: "thor", deity: "thor", world: "jotunheim", rune: "\u16A6" },
    { norse: "Mi\u00F0gar\u00F0sormr-bani", literal: "Midgard-Serpent's bane", meaning: "Thor (at Ragnarok)", source: "Gylfaginning Ch. 51", logic: "Thor's destined role as serpent-slayer at the end of the world", category: "thor", deity: "thor", world: "midgard", rune: "\u16A6" },
    { norse: "Hl\u00F3rri\u00F0i", literal: "(ancient name)", meaning: "Thor", source: "Gylfaginning (various)", logic: "An ancient name of unclear etymology, used in sacred context", category: "thor", deity: "thor", world: "asgard", rune: "\u16A6" },
    { norse: "Vingnis vinr", literal: "Vingnir's friend", meaning: "Thor", source: "Gylfaginning Ch. 21", logic: "Thor as foster-child of the giant Vingnir", category: "thor", deity: "thor", world: "jotunheim", rune: "\u16A6" },
    { norse: "Mj\u00F6lnir", literal: "The crusher / grinder", meaning: "Thor's hammer", source: "Gylfaginning Ch. 42", logic: "The weapon that crushes giants, forged by dwarves, always returns", category: "thor", deity: "thor", world: "asgard", rune: "\u16A6" },

    // Fenrir and the Binding
    { norse: "Fenris\u00FAlfr", literal: "Fenris-wolf", meaning: "The great wolf", source: "Gylfaginning Ch. 25, 34", logic: "The monstrous wolf, son of Loki, destined to devour Odin", category: "fenrir", deity: "fenrir", world: "asgard", rune: "\u16A2" },
    { norse: "Hr\u00F3\u00F0vitnir", literal: "Fame-wolf", meaning: "Fenrir", source: "Gylfaginning Ch. 25", logic: "The wolf whose terrible fame precedes him across the worlds", category: "fenrir", deity: "fenrir", world: "asgard", rune: "\u16A2" },
    { norse: "V\u00E1nargandr", literal: "Monster of hope / expectation", meaning: "Fenrir", source: "Gylfaginning Ch. 51", logic: "The monster awaited at Ragnarok -- the doom all expect", category: "fenrir", deity: "fenrir", world: "asgard", rune: "\u16A2" },
    { norse: "Gleipnir", literal: "Open one / entangler", meaning: "Fenrir's fetter", source: "Gylfaginning Ch. 34", logic: "The impossible fetter made from the sound of a cat's footfall, the beard of a woman, the roots of a mountain", category: "fenrir", deity: "fenrir", world: "svartalfheim", rune: "\u16A2" },

    // Ragnarok kennings
    { norse: "Ragnar\u00F6k", literal: "Fate of the gods", meaning: "The apocalypse", source: "Gylfaginning Ch. 51-53", logic: "The doom destined for the gods -- when all bonds break", category: "ragnarok", deity: "cosmic", world: "midgard", rune: "\u16DE" },
    { norse: "Ragnar\u00F6kkr", literal: "Twilight of the gods", meaning: "The apocalypse (variant)", source: "Gylfaginning Ch. 51", logic: "The dimming of the gods' power as the world descends into darkness", category: "ragnarok", deity: "cosmic", world: "midgard", rune: "\u16DE" },
    { norse: "Fimbulvetr", literal: "Great winter", meaning: "The three-year winter", source: "Gylfaginning Ch. 51", logic: "The terrible winter heralding the end -- three winters with no summer between", category: "ragnarok", deity: "cosmic", world: "midgard", rune: "\u16BA" },
    { norse: "Naglfar", literal: "Nail-ship", meaning: "Ship of the dead", source: "Gylfaginning Ch. 51", logic: "The ship built from dead men's fingernails, carrying the hosts of the dead", category: "ragnarok", deity: "cosmic", world: "helheim", rune: "\u16BE" },
    { norse: "Muspellssynir", literal: "Sons of Muspell", meaning: "Fire giants", source: "Gylfaginning Ch. 51", logic: "The destructive forces from the realm of fire who ride forth at Ragnarok", category: "ragnarok", deity: "cosmic", world: "muspelheim", rune: "\u16CA" },
    { norse: "Surtalogi", literal: "Surt's flame", meaning: "World-fire", source: "Gylfaginning Ch. 51", logic: "The fire that Surt the giant brings to consume the entire world", category: "ragnarok", deity: "cosmic", world: "muspelheim", rune: "\u16CA" },

    // Other Gylfaginning kennings
    { norse: "Au\u00F0humla", literal: "Wealth of hornless cows", meaning: "The primordial cow", source: "Gylfaginning Ch. 6", logic: "The cow that nourished the first being Ymir with rivers of milk", category: "cosmic", deity: "cosmic", world: "niflheim", rune: "\u16A2" },
    { norse: "J\u00F6rmungandr", literal: "Great beast", meaning: "The Midgard Serpent", source: "Gylfaginning Ch. 34", logic: "The serpent so vast it encircles the entire world, biting its own tail", category: "creatures", deity: "cosmic", world: "midgard", rune: "\u16C7" },
    { norse: "N\u00ED\u00F0h\u00F6ggr", literal: "Malice-striker", meaning: "The dragon at Yggdrasil's root", source: "Gylfaginning Ch. 16", logic: "The dragon that gnaws eternally at the world's foundation", category: "creatures", deity: "cosmic", world: "niflheim", rune: "\u16BE" },
    { norse: "Hel", literal: "The hidden one", meaning: "Realm / goddess of the dead", source: "Gylfaginning Ch. 34", logic: "The hidden place and goddess who conceals the dead from the living", category: "creatures", deity: "cosmic", world: "helheim", rune: "\u16BA" },
    { norse: "Ski\u00F0bla\u00F0nir", literal: "Assembled from thin planks", meaning: "Freyr's ship", source: "Gylfaginning Ch. 43", logic: "The miraculous ship that always has fair wind and can be folded like cloth", category: "possessions", deity: "freyr", world: "asgard", rune: "\u16B1" },
    { norse: "Gullinbursti", literal: "Golden-bristled", meaning: "Freyr's boar", source: "Gylfaginning Ch. 43", logic: "The boar with bristles of gold that lights up the darkest night", category: "possessions", deity: "freyr", world: "asgard", rune: "\u16A0" },
    { norse: "Br\u00EDsingamen", literal: "Flame-necklace", meaning: "Freyja's necklace", source: "Gylfaginning Ch. 35", logic: "The necklace blazing with beauty, forged by four dwarves", category: "possessions", deity: "freyja", world: "asgard", rune: "\u16A0" },
    { norse: "Ratat\u00F6skr", literal: "Drill-tooth", meaning: "The squirrel on Yggdrasil", source: "Gylfaginning Ch. 16", logic: "The squirrel that carries insults between the eagle at the crown and the dragon at the root", category: "creatures", deity: "cosmic", world: "asgard", rune: "\u16C7" }
];

// ============================================================
// WORLD & DEITY CONFIGURATION
// ============================================================
const worlds = [
    { id: "all", label: "All Worlds", rune: "\u16DE" },
    { id: "asgard", label: "Asgard", rune: "\u16A8" },
    { id: "midgard", label: "Midgard", rune: "\u16D7" },
    { id: "jotunheim", label: "J\u00F6tunheim", rune: "\u16A6" },
    { id: "niflheim", label: "Niflheim", rune: "\u16C1" },
    { id: "muspelheim", label: "Muspelheim", rune: "\u16CA" },
    { id: "helheim", label: "Helheim", rune: "\u16BA" },
    { id: "svartalfheim", label: "Svartalfheim", rune: "\u16B7" }
];

const deities = [
    { id: "all", label: "All", rune: "\u16DE" },
    { id: "odin", label: "Odin", rune: "\u16A8" },
    { id: "thor", label: "Thor", rune: "\u16A6" },
    { id: "fenrir", label: "Fenrir", rune: "\u16A2" },
    { id: "cosmic", label: "Cosmic", rune: "\u16C7" },
    { id: "freyr", label: "Freyr", rune: "\u16A0" },
    { id: "freyja", label: "Freyja", rune: "\u16A0" }
];

// ============================================================
// STATE
// ============================================================
let activeWorld = "all";
let activeDeity = "all";

// ============================================================
// RENDERING
// ============================================================
function countByField(field, value) {
    if (value === "all") return kennings.length;
    return kennings.filter(k => k[field] === value).length;
}

function buildFilters() {
    const worldContainer = document.getElementById('world-filters');
    const deityContainer = document.getElementById('deity-filters');

    worlds.forEach(w => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn' + (w.id === activeWorld ? ' active' : '');
        btn.dataset.world = w.id;
        const c = countByField('world', w.id);
        btn.innerHTML = `<span class="rune">${w.rune}</span> ${w.label} <span class="count-badge">${c}</span>`;
        btn.setAttribute('aria-pressed', w.id === activeWorld);
        btn.addEventListener('click', () => {
            activeWorld = w.id;
            updateFilters();
            renderCards();
        });
        worldContainer.appendChild(btn);
    });

    deities.forEach(d => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn' + (d.id === activeDeity ? ' active' : '');
        btn.dataset.deity = d.id;
        const c = countByField('deity', d.id);
        btn.innerHTML = `<span class="rune">${d.rune}</span> ${d.label} <span class="count-badge">${c}</span>`;
        btn.setAttribute('aria-pressed', d.id === activeDeity);
        btn.addEventListener('click', () => {
            activeDeity = d.id;
            updateFilters();
            renderCards();
        });
        deityContainer.appendChild(btn);
    });
}

function updateFilters() {
    document.querySelectorAll('#world-filters .filter-btn').forEach(btn => {
        const isActive = btn.dataset.world === activeWorld;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-pressed', isActive);
    });
    document.querySelectorAll('#deity-filters .filter-btn').forEach(btn => {
        const isActive = btn.dataset.deity === activeDeity;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-pressed', isActive);
    });
}

function getFilteredKennings() {
    return kennings.filter(k => {
        if (activeWorld !== "all" && k.world !== activeWorld) return false;
        if (activeDeity !== "all" && k.deity !== activeDeity) return false;
        return true;
    });
}

const categoryLabels = {
    cosmic: "Cosmic Structures",
    odin: "Odin -- The Allfather",
    thor: "Thor -- The Thunderer",
    fenrir: "Fenrir & The Binding",
    ragnarok: "Ragnarok -- The Doom",
    creatures: "Creatures & Beings",
    possessions: "Divine Possessions"
};

const categoryOrder = ["cosmic", "odin", "thor", "fenrir", "ragnarok", "creatures", "possessions"];

function renderCards() {
    const grid = document.getElementById('kenning-grid');
    const countEl = document.getElementById('results-count');
    const filtered = getFilteredKennings();

    countEl.innerHTML = `Showing <strong>${filtered.length}</strong> of <strong>${kennings.length}</strong> kennings`;

    // Group by category
    const grouped = {};
    filtered.forEach(k => {
        if (!grouped[k.category]) grouped[k.category] = [];
        grouped[k.category].push(k);
    });

    let html = '';
    categoryOrder.forEach(cat => {
        if (!grouped[cat]) return;
        html += `<div class="category-divider" style="grid-column: 1 / -1;">
            <h2>${categoryLabels[cat] || cat}</h2>
            <div class="divider-line"></div>
        </div>`;

        html += buildSectionImageHTML(cat);

        grouped[cat].forEach(k => {
            html += `<article class="kenning-card" role="listitem" tabindex="0" onclick="toggleCard(this)" onkeydown="if(event.key==='Enter')toggleCard(this)">
                <div class="card-badge"><span class="rune">${k.rune}</span> ${(k.deity || '').toUpperCase()}</div>
                <div class="card-norse">"${k.norse}"</div>
                <div class="card-literal">${k.literal}</div>
                <div class="card-meaning">= ${k.meaning}</div>
                <div class="card-source">${k.source}</div>
                <div class="card-expand">
                    <div class="logic-label">Mythological Context</div>
                    <p>${k.logic}</p>
                </div>
                <div class="expand-hint">Click to expand</div>
            </article>`;
        });
    });

    grid.innerHTML = html;
}

function toggleCard(el) {
    el.classList.toggle('expanded');
}

// ============================================================
// SECTION IMAGES -- atmospheric images between categories
// ============================================================
const sectionImages = {
    cosmic: [
        { file: "kenning-0124.png", caption: "The Mountain is Eagle-kingdom", alt: "A towering peak crowned with cosmic light, the eagle's domain above the clouds" },
        { file: "kenning-0122.png", caption: "The Moon is Astronaut-destination", alt: "The moon hanging in the void, a celestial destination beyond the bridge Bifrost" },
        { file: "kenning-0127.png", caption: "The Mountain is Perspective-giver", alt: "A vast mountain vista revealing the scale of the Norse cosmos" }
    ],
    odin: [
        { file: "kenning-0197.png", caption: "The Moon is Eclipse-Dancer", alt: "The moon caught in eclipse, dancing between shadow and light" },
        { file: "kenning-0198.png", caption: "The Moon is Ocean-Puller", alt: "The moon exerting its pull over vast dark waters, the tides of fate" },
        { file: "kenning-0199.png", caption: "The Moon is Poet-Muse", alt: "Moonlight illuminating the night, muse of skalds and poets" }
    ],
    thor: [
        { file: "kenning-0069.png", caption: "Lightning is Storm-herald", alt: "A bolt of lightning splitting the sky, heralding Thor's wrath" },
        { file: "kenning-0147.png", caption: "The Wind is Change-announcer", alt: "Wind sweeping across a stormy landscape, announcing transformation" }
    ],
    fenrir: [
        { file: "kenning-0170.png", caption: "Chaos is Possibility-Storm", alt: "A swirling tempest of chaotic energy, where destruction breeds possibility" }
    ],
    ragnarok: [
        { file: "kenning-0145.png", caption: "The Sun is Clock-starter", alt: "The sun beginning its arc across the sky, marking the start of all reckoning" },
        { file: "kenning-0150.png", caption: "The Wind is Invisible-force", alt: "An unseen force bending the world, the breath of Ragnarok" },
        { file: "kenning-0146.png", caption: "The Sun is Vampire-bane", alt: "The sun blazing its last defiance against the encroaching darkness" }
    ],
    creatures: [
        { file: "kenning-0126.png", caption: "The Mountain is Metaphor-giant", alt: "A colossal mountain form evoking the primordial giants of Norse myth" },
        { file: "kenning-0163.png", caption: "The Sun is Dawn-Forger", alt: "Dawn breaking across the horizon, forging light from the void" }
    ],
    possessions: [
        { file: "kenning-0008.png", caption: "Gold is Freyja's Tears", alt: "Gleaming drops of gold falling like tears, the sorrow and beauty of Freyja" },
        { file: "kenning-0009.png", caption: "Gold is Freyja's Tears", alt: "Golden light cascading in luminous streams, embodying divine grief" },
        { file: "kenning-0010.png", caption: "Gold is Freyja's Tears", alt: "Radiant golden tears cascading from the goddess of love and beauty" },
        { file: "kenning-0203.png", caption: "The Sun is Horizon-Jewel", alt: "The sun resting on the edge of the world like a jewel in Freyja's crown" }
    ]
};

const IMG_BASE = "https://kenning.storyleaf.ai/img/";

function buildSectionImageHTML(cat) {
    const images = sectionImages[cat];
    if (!images || images.length === 0) return '';
    // Pick one image (rotate based on a simple hash of the category)
    const idx = cat.length % images.length;
    const img = images[idx];
    return `<div class="section-image" onclick="openLightbox(this)" style="grid-column: 1 / -1;">
        <img src="${IMG_BASE}${img.file}" alt="${img.alt}" loading="lazy" data-caption="${img.caption}">
        <div class="img-caption">"${img.caption}"</div>
        <div class="img-credit">storyleaf.ai</div>
    </div>`;
}

// ============================================================
// LIGHTBOX
// ============================================================
function openLightbox(el) {
    const img = el.querySelector('img');
    if (!img) return;
    const overlay = document.getElementById('lightbox-overlay');
    const lbImg = document.getElementById('lightbox-img');
    const lbCaption = document.getElementById('lightbox-caption');

    lbImg.src = img.src;
    lbImg.alt = img.alt;

    const caption = img.dataset.caption || el.querySelector('.hero-caption, .img-caption')?.textContent || '';
    lbCaption.innerHTML = caption + '<span class="lightbox-credit">Artwork by storyleaf.ai</span>';

    overlay.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeLightbox() {
    const overlay = document.getElementById('lightbox-overlay');
    overlay.classList.remove('active');
    document.body.style.overflow = '';
}

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeLightbox();
});

// ============================================================
// NAVIGATION (shared)
// ============================================================
(function() {
    const nav = document.getElementById('exhibition-nav');
    const hamburger = document.getElementById('hamburger');
    const overlay = document.getElementById('nav-overlay');
    const transition = document.getElementById('room-transition');
    const navLinks = document.querySelectorAll('.nav-link');

    if (hamburger) {
        hamburger.addEventListener('click', () => {
            nav.classList.toggle('open');
            overlay.classList.toggle('visible');
        });
    }

    if (overlay) {
        overlay.addEventListener('click', () => {
            nav.classList.remove('open');
            overlay.classList.remove('visible');
        });
    }

    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            if (link.classList.contains('active')) {
                e.preventDefault();
                return;
            }
            e.preventDefault();
            transition.classList.add('active');
            setTimeout(() => {
                window.location.href = link.href;
            }, 400);
        });
    });

    window.addEventListener('load', () => {
        transition.classList.add('active');
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                transition.classList.remove('active');
            });
        });
    });
})();

// ============================================================
// AUDIO -- E3 165Hz, sine + triangle, ethereal/icy
// ============================================================
class RoomAmbience {
    constructor() {
        this.ctx = null;
        this.isPlaying = false;
    }

    init() {
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        this.master = this.ctx.createGain();
        this.master.gain.value = 0;
        this.master.connect(this.ctx.destination);

        this.filter = this.ctx.createBiquadFilter();
        this.filter.type = 'lowpass';
        this.filter.frequency.value = 2200;
        this.filter.Q.value = 1;
        this.filter.connect(this.master);

        // Drone 1 -- sine at E3 (165 Hz)
        this.osc1 = this.ctx.createOscillator();
        this.osc1.type = 'sine';
        this.osc1.frequency.value = 165;
        this.gain1 = this.ctx.createGain();
        this.gain1.gain.value = 0.3;
        this.osc1.connect(this.gain1);
        this.gain1.connect(this.filter);
        this.osc1.start();

        // Drone 2 -- triangle at E4 (330 Hz, octave)
        this.osc2 = this.ctx.createOscillator();
        this.osc2.type = 'triangle';
        this.osc2.frequency.value = 330;
        this.gain2 = this.ctx.createGain();
        this.gain2.gain.value = 0.12;
        this.osc2.connect(this.gain2);
        this.gain2.connect(this.filter);
        this.osc2.start();

        // Shimmer -- sine at B4 (494 Hz, major seventh)
        this.osc3 = this.ctx.createOscillator();
        this.osc3.type = 'sine';
        this.osc3.frequency.value = 494;
        this.gain3 = this.ctx.createGain();
        this.gain3.gain.value = 0.04;
        this.osc3.connect(this.gain3);
        this.gain3.connect(this.filter);
        this.osc3.start();

        // Slow LFO on filter cutoff
        this.lfo = this.ctx.createOscillator();
        this.lfo.type = 'sine';
        this.lfo.frequency.value = 0.04;
        this.lfoGain = this.ctx.createGain();
        this.lfoGain.gain.value = 600;
        this.lfo.connect(this.lfoGain);
        this.lfoGain.connect(this.filter.frequency);
        this.lfo.start();
    }

    fadeIn(duration) {
        duration = duration || 3;
        if (!this.ctx) this.init();
        if (this.ctx.state === 'suspended') this.ctx.resume();
        this.master.gain.cancelScheduledValues(this.ctx.currentTime);
        this.master.gain.setValueAtTime(this.master.gain.value, this.ctx.currentTime);
        this.master.gain.linearRampToValueAtTime(0.12, this.ctx.currentTime + duration);
        this.isPlaying = true;
    }

    fadeOut(duration) {
        duration = duration || 2;
        if (!this.ctx) return;
        this.master.gain.cancelScheduledValues(this.ctx.currentTime);
        this.master.gain.setValueAtTime(this.master.gain.value, this.ctx.currentTime);
        this.master.gain.linearRampToValueAtTime(0, this.ctx.currentTime + duration);
        this.isPlaying = false;
    }

    toggle() {
        this.isPlaying ? this.fadeOut() : this.fadeIn();
    }
}

const ambience = new RoomAmbience();
const audioToggle = document.getElementById('audio-toggle');
const audioIcon = document.getElementById('audio-icon');

// Restore preference
const audioPreference = localStorage.getItem('exhibition-audio');

audioToggle.addEventListener('click', () => {
    ambience.toggle();
    audioToggle.classList.toggle('muted', !ambience.isPlaying);
    audioIcon.textContent = ambience.isPlaying ? '\u{1F50A}' : '\u{1F507}';
    localStorage.setItem('exhibition-audio', ambience.isPlaying ? 'on' : 'off');
});

// Do NOT auto-play -- audio is off by default

// ============================================================
// P5.JS -- Yggdrasil Fractal Tree (L-System)
// ============================================================
const roomSketch = (p) => {
    let rules = [];
    let sentence = 'F';
    let angle;
    let len;
    let generation = 0;
    let maxGeneration = 5;
    let growTimer = 0;
    let growInterval = 360; // frames between growth cycles (~12s at 30fps)
    let branchAlpha = [];
    let shedding = false;

    function generateSentence(s) {
        let next = '';
        for (let i = 0; i < s.length; i++) {
            let c = s.charAt(i);
            let found = false;
            for (let j = 0; j < rules.length; j++) {
                if (c === rules[j].a) {
                    next += rules[j].b;
                    found = true;
                    break;
                }
            }
            if (!found) next += c;
        }
        return next;
    }

    p.setup = () => {
        const container = document.getElementById('p5-backdrop');
        const cnv = p.createCanvas(container.offsetWidth, container.offsetHeight);
        cnv.parent('p5-backdrop');
        p.frameRate(30);
        p.colorMode(p.HSB, 360, 100, 100, 100);

        rules.push({ a: 'F', b: 'FF+[+F-F-F]-[-F+F+F]' });
        angle = p.radians(22.5);

        // Pre-generate to a starting state
        for (let i = 0; i < 3; i++) {
            sentence = generateSentence(sentence);
            generation++;
        }

        len = p.height * 0.12;
    };

    p.draw = () => {
        p.clear();
        growTimer++;

        // Grow or shed on a timer
        if (growTimer >= growInterval) {
            growTimer = 0;
            if (generation >= maxGeneration) {
                // Reset -- shed and regrow
                shedding = true;
                setTimeout(() => {
                    sentence = 'F';
                    generation = 0;
                    for (let i = 0; i < 3; i++) {
                        sentence = generateSentence(sentence);
                        generation++;
                    }
                    shedding = false;
                }, 2000);
            } else {
                sentence = generateSentence(sentence);
                generation++;
            }
        }

        // Draw the tree
        p.push();
        p.translate(p.width * 0.5, p.height);

        let currentLen = len / p.pow(1.5, generation - 3);
        let branchIndex = 0;
        let time = p.frameCount * 0.01;

        // Subtle sway
        let swayBase = p.sin(time * 0.5) * 0.02;

        for (let i = 0; i < sentence.length; i++) {
            let c = sentence.charAt(i);

            // Frost-blue color with slight variation
            let hue = 195 + p.sin(branchIndex * 0.1 + time) * 10;
            let sat = 40 + p.sin(branchIndex * 0.3) * 15;
            let bri = 60 + p.sin(branchIndex * 0.2 + time * 2) * 15;
            let alpha = shedding ? p.max(0, 50 - growTimer * 2) : 70;

            if (c === 'F') {
                p.strokeWeight(p.max(0.5, 2.5 - generation * 0.3));
                p.stroke(hue, sat, bri, alpha);
                p.line(0, 0, 0, -currentLen);
                p.translate(0, -currentLen);
                branchIndex++;
            } else if (c === '+') {
                p.rotate(angle + swayBase + p.sin(time + branchIndex * 0.5) * 0.03);
            } else if (c === '-') {
                p.rotate(-angle + swayBase + p.cos(time + branchIndex * 0.5) * 0.03);
            } else if (c === '[') {
                p.push();
            } else if (c === ']') {
                p.pop();
            }
        }
        p.pop();

        // Draw some falling frost particles during shedding
        if (shedding) {
            for (let i = 0; i < 8; i++) {
                let px = p.random(p.width);
                let py = p.random(p.height);
                p.noStroke();
                p.fill(195, 30, 80, p.random(10, 30));
                p.circle(px, py, p.random(1, 3));
            }
        }
    };

    p.windowResized = () => {
        const container = document.getElementById('p5-backdrop');
        if (container) {
            p.resizeCanvas(container.offsetWidth, container.offsetHeight);
        }
    };
};

new p5(roomSketch);

// ============================================================
// INIT
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
    buildFilters();
    renderCards();

    // Track visit
    try {
        const visited = JSON.parse(localStorage.getItem('exhibition-visited') || '[]');
        if (!visited.includes('edda')) {
            visited.push('edda');
            localStorage.setItem('exhibition-visited', JSON.stringify(visited));
        }
    } catch(e) {}
});

// Expose reset for enhance.js
window.reset = function() {
    activeWorld = "all";
    activeDeity = "all";
    updateFilters();
    renderCards();
    document.querySelectorAll('.kenning-card.expanded').forEach(c => c.classList.remove('expanded'));
};
</script>
<script src="../assets/js/enhance.js" defer></script>
</body>
</html>
