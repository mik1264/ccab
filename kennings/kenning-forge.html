<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Kenning Forge - Craft New Kennings from Ancient Patterns</title>
    <meta name="description" content="An interactive smithy where visitors forge new kennings using authentic Norse poetic patterns, word banks, and algorithmic generation.">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>&#x2692;</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400;1,600&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="kenning-images-data.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <style>
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-deep: #1a1a2e;
            --bg-mid: #16213e;
            --bg-surface: #1f2641;
            --gold: #e6c069;
            --gold-dim: #b8944d;
            --parchment: #d4c5a9;
            --parchment-dim: #9e9279;
            --ink: #0d0d1a;
            --glow: rgba(230, 192, 105, 0.15);
            --accent: #d4601a;
            --accent-glow: rgba(212, 96, 26, 0.12);
            --font-display: 'EB Garamond', 'Georgia', serif;
            --font-body: 'Inter', 'Helvetica Neue', sans-serif;
            --nav-width: 260px;
            --transition-room: 0.6s cubic-bezier(0.22, 1, 0.36, 1);
        }

        html {
            scroll-behavior: smooth;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: var(--font-body);
            background: var(--bg-deep);
            color: var(--parchment);
            line-height: 1.7;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- Navigation --- */
        .exhibition-nav {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--nav-width);
            height: 100vh;
            background: linear-gradient(180deg, var(--ink) 0%, var(--bg-deep) 100%);
            border-right: 1px solid rgba(230, 192, 105, 0.08);
            padding: 30px 0;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1);
        }

        .exhibition-nav .nav-title {
            font-family: var(--font-display);
            font-size: 1.1rem;
            color: var(--gold);
            text-align: center;
            padding: 0 20px 25px;
            border-bottom: 1px solid rgba(230, 192, 105, 0.1);
            letter-spacing: 0.05em;
        }

        .exhibition-nav .nav-rooms {
            flex: 1;
            padding: 15px 0;
            overflow-y: auto;
        }

        .exhibition-nav .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: var(--parchment-dim);
            text-decoration: none;
            font-family: var(--font-body);
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .exhibition-nav .nav-link:hover {
            color: var(--gold);
            background: rgba(230, 192, 105, 0.05);
            border-left-color: var(--gold-dim);
        }

        .exhibition-nav .nav-link.active {
            color: var(--gold);
            background: rgba(230, 192, 105, 0.08);
            border-left-color: var(--accent);
        }

        .exhibition-nav .nav-icon {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        .exhibition-nav .nav-footer {
            padding: 15px 0;
            border-top: 1px solid rgba(230, 192, 105, 0.1);
        }

        .exhibition-nav .nav-back {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: var(--parchment-dim);
            text-decoration: none;
            font-family: var(--font-body);
            font-size: 0.85rem;
            font-weight: 400;
            transition: all 0.3s ease;
        }

        .exhibition-nav .nav-back:hover {
            color: var(--gold);
        }

        /* --- Mobile Header --- */
        .mobile-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: var(--ink);
            border-bottom: 1px solid rgba(230, 192, 105, 0.1);
            align-items: center;
            padding: 0 16px;
            z-index: 999;
        }

        .hamburger {
            width: 40px;
            height: 40px;
            background: none;
            border: none;
            color: var(--gold);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .mobile-title {
            font-family: var(--font-display);
            color: var(--gold);
            font-size: 1rem;
            margin-left: 12px;
        }

        .nav-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 998;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .nav-overlay.visible {
            opacity: 1;
            pointer-events: all;
        }

        /* --- Main Content --- */
        .exhibition-main {
            margin-left: var(--nav-width);
            min-height: 100vh;
            position: relative;
        }

        /* --- p5 Backdrop --- */
        #p5-backdrop {
            position: fixed;
            top: 0;
            left: var(--nav-width);
            right: 0;
            bottom: 0;
            z-index: 0;
            opacity: 0.35;
            pointer-events: none;
        }

        #p5-backdrop canvas {
            display: block;
            width: 100% !important;
            height: 100% !important;
        }

        /* --- Room Transition --- */
        .room-transition {
            position: fixed;
            inset: 0;
            background: var(--ink);
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }

        .room-transition.active {
            opacity: 1;
            pointer-events: all;
        }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-deep); }
        ::-webkit-scrollbar-thumb { background: var(--gold-dim); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gold); }

        /* --- Room Content --- */
        .room-content {
            position: relative;
            z-index: 1;
            padding: 60px 50px 80px;
            max-width: 1100px;
            margin: 0 auto;
        }

        .room-header {
            text-align: center;
            margin-bottom: 50px;
        }

        .room-header h1 {
            font-family: var(--font-display);
            font-size: 2.4rem;
            font-weight: 600;
            color: var(--gold);
            letter-spacing: 0.06em;
            margin-bottom: 10px;
        }

        .room-header .subtitle {
            font-family: var(--font-display);
            font-style: italic;
            font-size: 1.15rem;
            color: var(--parchment-dim);
        }

        /* --- Section Tabs --- */
        .section-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 40px;
            border-bottom: 1px solid rgba(230, 192, 105, 0.1);
            overflow-x: auto;
        }

        .section-tab {
            padding: 12px 22px;
            background: none;
            border: none;
            color: var(--parchment-dim);
            font-family: var(--font-body);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .section-tab:hover {
            color: var(--gold);
        }

        .section-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        /* --- Panels --- */
        .forge-section {
            display: none;
        }

        .forge-section.active {
            display: block;
        }

        .forge-panel {
            background: rgba(31, 38, 65, 0.85);
            border: 1px solid rgba(212, 96, 26, 0.15);
            border-radius: 12px;
            padding: 36px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .forge-panel h2 {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--gold);
            margin-bottom: 20px;
        }

        .forge-panel h3 {
            font-family: var(--font-display);
            font-size: 1.15rem;
            font-weight: 500;
            color: var(--parchment);
            margin-bottom: 12px;
        }

        .step-label {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 14px;
        }

        .step-num {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--accent);
            color: #fff;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .step-text {
            font-family: var(--font-body);
            font-size: 0.95rem;
            color: var(--parchment);
            font-weight: 500;
        }

        /* --- Select / Inputs --- */
        .forge-select {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-deep);
            border: 1px solid rgba(230, 192, 105, 0.15);
            border-radius: 8px;
            color: var(--parchment);
            font-family: var(--font-body);
            font-size: 0.95rem;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23d4c5a9' fill='none' stroke-width='1.5'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            margin-bottom: 20px;
            transition: border-color 0.3s ease;
        }

        .forge-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .forge-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-deep);
            border: 1px solid rgba(230, 192, 105, 0.15);
            border-radius: 8px;
            color: var(--parchment);
            font-family: var(--font-body);
            font-size: 0.95rem;
            margin-bottom: 14px;
            transition: border-color 0.3s ease;
        }

        .forge-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .forge-input::placeholder {
            color: var(--parchment-dim);
        }

        /* --- Pattern Radio Buttons --- */
        .pattern-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 24px;
        }

        .pattern-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-deep);
            border: 1px solid rgba(230, 192, 105, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pattern-option:hover {
            border-color: var(--accent);
            background: rgba(212, 96, 26, 0.06);
        }

        .pattern-option.selected {
            border-color: var(--accent);
            background: rgba(212, 96, 26, 0.1);
        }

        .pattern-option input[type="radio"] {
            display: none;
        }

        .pattern-radio {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid var(--parchment-dim);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: border-color 0.3s ease;
        }

        .pattern-option.selected .pattern-radio {
            border-color: var(--accent);
        }

        .pattern-radio::after {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .pattern-option.selected .pattern-radio::after {
            opacity: 1;
        }

        .pattern-label {
            font-size: 0.95rem;
            color: var(--parchment);
        }

        .pattern-example {
            font-family: var(--font-display);
            font-style: italic;
            color: var(--gold-dim);
            font-size: 0.9rem;
            margin-left: auto;
        }

        /* --- Forge Button --- */
        .forge-btn {
            display: block;
            width: 100%;
            padding: 16px 30px;
            background: linear-gradient(135deg, var(--accent), #b85218);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-family: var(--font-display);
            font-size: 1.2rem;
            font-weight: 600;
            letter-spacing: 0.08em;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .forge-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(212, 96, 26, 0.35);
        }

        .forge-btn:active {
            transform: translateY(0);
        }

        .forge-btn-secondary {
            display: inline-block;
            padding: 10px 22px;
            background: rgba(212, 96, 26, 0.15);
            border: 1px solid var(--accent);
            border-radius: 8px;
            color: var(--accent);
            font-family: var(--font-body);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .forge-btn-secondary:hover {
            background: rgba(212, 96, 26, 0.25);
        }

        .forge-btn-small {
            padding: 8px 16px;
            background: rgba(230, 192, 105, 0.1);
            border: 1px solid rgba(230, 192, 105, 0.2);
            border-radius: 6px;
            color: var(--gold);
            font-family: var(--font-body);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .forge-btn-small:hover {
            background: rgba(230, 192, 105, 0.2);
        }

        /* --- Results --- */
        .results-area {
            display: none;
            margin-top: 30px;
        }

        .results-area.visible {
            display: block;
            animation: fadeUp 0.5s ease;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-card {
            background: rgba(212, 96, 26, 0.08);
            border: 1px solid rgba(212, 96, 26, 0.2);
            border-radius: 10px;
            padding: 24px;
            margin-bottom: 16px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .result-card:hover {
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(212, 96, 26, 0.1);
        }

        .result-kenning {
            font-family: var(--font-display);
            font-style: italic;
            font-size: 2rem;
            font-weight: 600;
            color: var(--gold);
            letter-spacing: 0.02em;
            margin-bottom: 6px;
        }

        .result-meaning {
            font-family: var(--font-body);
            font-size: 0.85rem;
            color: var(--parchment-dim);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 8px;
        }

        .result-pattern {
            font-family: var(--font-body);
            font-size: 0.8rem;
            color: var(--parchment-dim);
            opacity: 0.7;
        }

        .result-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 14px;
        }

        /* --- Quiz Section --- */
        .quiz-prompt {
            text-align: center;
            margin-bottom: 28px;
        }

        .quiz-kenning {
            font-family: var(--font-display);
            font-style: italic;
            font-size: 2.6rem;
            font-weight: 700;
            color: var(--gold);
            margin-bottom: 8px;
        }

        .quiz-hint {
            font-size: 0.85rem;
            color: var(--parchment-dim);
        }

        .quiz-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .quiz-option {
            padding: 16px;
            background: var(--bg-deep);
            border: 1px solid rgba(230, 192, 105, 0.12);
            border-radius: 10px;
            color: var(--parchment);
            font-family: var(--font-body);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .quiz-option:hover {
            border-color: var(--gold-dim);
            background: rgba(230, 192, 105, 0.06);
        }

        .quiz-option.correct {
            border-color: #3a7d44;
            background: rgba(58, 125, 68, 0.2);
            color: #7ddf8a;
        }

        .quiz-option.wrong {
            border-color: #8b2500;
            background: rgba(139, 37, 0, 0.2);
            color: #ff7b6b;
        }

        .quiz-option.disabled {
            pointer-events: none;
            opacity: 0.5;
        }

        .quiz-score {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 24px;
            margin-bottom: 20px;
        }

        .score-item {
            text-align: center;
        }

        .score-value {
            font-family: var(--font-display);
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--gold);
        }

        .score-label {
            font-size: 0.75rem;
            color: var(--parchment-dim);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .quiz-feedback {
            text-align: center;
            padding: 16px;
            border-radius: 8px;
            font-size: 0.95rem;
            margin-bottom: 16px;
            display: none;
        }

        .quiz-feedback.visible {
            display: block;
            animation: fadeUp 0.3s ease;
        }

        .quiz-feedback.success {
            background: rgba(58, 125, 68, 0.12);
            color: #7ddf8a;
            border: 1px solid rgba(58, 125, 68, 0.25);
        }

        .quiz-feedback.fail {
            background: rgba(139, 37, 0, 0.12);
            color: #ff7b6b;
            border: 1px solid rgba(139, 37, 0, 0.25);
        }

        /* --- Free-form Creator --- */
        .freeform-preview {
            text-align: center;
            padding: 30px 20px;
            background: rgba(212, 96, 26, 0.06);
            border: 1px dashed rgba(212, 96, 26, 0.2);
            border-radius: 10px;
            margin: 20px 0;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .freeform-preview .preview-kenning {
            font-family: var(--font-display);
            font-style: italic;
            font-size: 2.2rem;
            font-weight: 600;
            color: var(--gold);
            letter-spacing: 0.02em;
        }

        .freeform-preview .preview-empty {
            font-size: 0.9rem;
            color: var(--parchment-dim);
            font-style: italic;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 12px;
            align-items: end;
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--parchment-dim);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 6px;
        }

        .input-separator {
            font-family: var(--font-display);
            font-size: 1.5rem;
            color: var(--gold-dim);
            padding-bottom: 20px;
        }

        /* --- Recent Forgings Strip --- */
        .recent-forgings {
            margin-top: 40px;
        }

        .recent-forgings h3 {
            font-family: var(--font-display);
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--gold);
            margin-bottom: 16px;
        }

        .forgings-strip {
            display: flex;
            gap: 14px;
            overflow-x: auto;
            padding-bottom: 12px;
            scroll-snap-type: x mandatory;
        }

        .forgings-strip::-webkit-scrollbar {
            height: 4px;
        }

        .forgings-strip::-webkit-scrollbar-thumb {
            background: var(--gold-dim);
            border-radius: 2px;
        }

        .forging-chip {
            flex-shrink: 0;
            padding: 14px 20px;
            background: rgba(31, 38, 65, 0.7);
            border: 1px solid rgba(230, 192, 105, 0.1);
            border-radius: 10px;
            text-align: center;
            scroll-snap-align: start;
            min-width: 160px;
        }

        .forging-chip .chip-kenning {
            font-family: var(--font-display);
            font-style: italic;
            font-size: 1.1rem;
            color: var(--gold);
            margin-bottom: 4px;
        }

        .forging-chip .chip-meaning {
            font-size: 0.75rem;
            color: var(--parchment-dim);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .empty-forgings {
            font-size: 0.9rem;
            color: var(--parchment-dim);
            font-style: italic;
            padding: 20px;
            text-align: center;
            border: 1px dashed rgba(230, 192, 105, 0.1);
            border-radius: 10px;
        }

        /* --- Audio Toggle --- */
        .audio-toggle {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--bg-surface);
            border: 1px solid rgba(230, 192, 105, 0.15);
            color: var(--gold);
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .audio-toggle:hover {
            background: rgba(230, 192, 105, 0.15);
            transform: scale(1.1);
        }

        .audio-toggle.muted {
            color: var(--parchment-dim);
        }

        /* --- Responsive --- */
        @media (max-width: 1023px) {
            :root {
                --nav-width: 60px;
            }
            .exhibition-nav .nav-label { display: none; }
            .exhibition-nav .nav-title { font-size: 0; padding: 15px 0; }
            .exhibition-nav .nav-title::after {
                content: 'KE';
                font-size: 0.9rem;
                display: block;
            }
            .exhibition-nav .nav-link { justify-content: center; padding: 14px 0; }
            .exhibition-nav .nav-icon { font-size: 1.4rem; }
            .exhibition-nav .nav-footer .nav-back { justify-content: center; padding: 14px 0; }

            .room-content {
                padding: 40px 30px 60px;
            }

            .quiz-options {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 767px) {
            :root {
                --nav-width: 0px;
            }

            .exhibition-nav {
                transform: translateX(-100%);
                width: 280px;
            }

            .exhibition-nav .nav-label { display: inline; }
            .exhibition-nav .nav-title { font-size: 1.1rem; }
            .exhibition-nav .nav-link { justify-content: flex-start; padding: 12px 20px; }
            .exhibition-nav .nav-footer .nav-back { justify-content: flex-start; padding: 12px 20px; }

            .exhibition-nav.open {
                transform: translateX(0);
            }

            .mobile-header {
                display: flex;
            }

            .exhibition-main {
                margin-left: 0;
                padding-top: 56px;
            }

            .room-content {
                padding: 30px 18px 60px;
            }

            .room-header h1 {
                font-size: 1.8rem;
            }

            .forge-panel {
                padding: 22px;
            }

            .input-row {
                grid-template-columns: 1fr;
            }

            .input-separator {
                text-align: center;
                padding: 0;
            }

            .result-kenning {
                font-size: 1.5rem;
            }

            .quiz-kenning {
                font-size: 1.8rem;
            }

            .quiz-options {
                grid-template-columns: 1fr;
            }
        }

        /* --- Focus states --- */
        :focus-visible {
            outline: 2px solid var(--gold);
            outline-offset: 2px;
        }

        /* --- Reduced Motion --- */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
            #p5-backdrop { display: none; }
            .room-transition { display: none; }
        }

        /* --- Forged Image --- */
        .forge-inspiration-img {
            margin: 16px auto 0;
            max-width: 280px;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(212, 96, 26, 0.2);
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .forge-inspiration-img:hover {
            transform: scale(1.03);
            box-shadow: 0 6px 24px rgba(212, 96, 26, 0.25);
        }

        .forge-inspiration-img img {
            display: block;
            width: 100%;
            height: auto;
            border-radius: 10px 10px 0 0;
        }

        .forge-inspiration-img .img-credit {
            padding: 8px 12px;
            font-size: 0.75rem;
            color: var(--parchment-dim);
            background: rgba(13, 13, 26, 0.6);
            text-align: center;
        }

        .forge-inspiration-img .img-credit a {
            color: var(--accent);
            text-decoration: none;
        }

        .forge-inspiration-img .img-credit a:hover {
            text-decoration: underline;
        }

        /* --- Quiz Image --- */
        .quiz-image-container {
            margin: 0 auto 20px;
            max-width: 240px;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(230, 192, 105, 0.12);
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .quiz-image-container:hover {
            transform: scale(1.03);
        }

        .quiz-image-container img {
            display: block;
            width: 100%;
            height: auto;
        }

        .quiz-image-container .img-credit {
            padding: 6px 10px;
            font-size: 0.7rem;
            color: var(--parchment-dim);
            background: rgba(13, 13, 26, 0.5);
            text-align: center;
        }

        /* --- Kenning Art Gallery Strip --- */
        .kenning-art-gallery {
            margin-top: 50px;
            padding-top: 30px;
            border-top: 1px solid rgba(230, 192, 105, 0.08);
        }

        .kenning-art-gallery h3 {
            font-family: var(--font-display);
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--gold);
            margin-bottom: 6px;
        }

        .kenning-art-gallery .gallery-subtitle {
            font-size: 0.85rem;
            color: var(--parchment-dim);
            margin-bottom: 18px;
        }

        .kenning-art-gallery .gallery-subtitle a {
            color: var(--accent);
            text-decoration: none;
        }

        .kenning-art-gallery .gallery-subtitle a:hover {
            text-decoration: underline;
        }

        .art-gallery-strip {
            display: flex;
            gap: 14px;
            overflow-x: auto;
            padding-bottom: 12px;
            scroll-snap-type: x mandatory;
        }

        .art-gallery-strip::-webkit-scrollbar {
            height: 4px;
        }

        .art-gallery-strip::-webkit-scrollbar-thumb {
            background: var(--gold-dim);
            border-radius: 2px;
        }

        .art-gallery-item {
            flex-shrink: 0;
            width: 160px;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(212, 96, 26, 0.12);
            scroll-snap-align: start;
            cursor: pointer;
            transition: transform 0.3s ease, border-color 0.3s ease;
            background: rgba(31, 38, 65, 0.5);
        }

        .art-gallery-item:hover {
            transform: translateY(-3px);
            border-color: var(--accent);
        }

        .art-gallery-item img {
            display: block;
            width: 100%;
            height: 140px;
            object-fit: cover;
        }

        .art-gallery-item .art-caption {
            padding: 8px 10px;
            font-family: var(--font-display);
            font-style: italic;
            font-size: 0.8rem;
            color: var(--gold-dim);
            text-align: center;
            line-height: 1.3;
        }

        .art-gallery-item .art-artist {
            padding: 0 10px 8px;
            font-size: 0.65rem;
            color: var(--parchment-dim);
            text-align: center;
        }

        /* --- Lightbox Modal --- */
        .kenning-lightbox {
            position: fixed;
            inset: 0;
            z-index: 10000;
            background: rgba(0, 0, 0, 0.92);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            cursor: pointer;
        }

        .kenning-lightbox.visible {
            display: flex;
            animation: fadeUp 0.3s ease;
        }

        .kenning-lightbox img {
            max-width: 90vw;
            max-height: 80vh;
            border-radius: 10px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
        }

        .kenning-lightbox .lightbox-caption {
            margin-top: 16px;
            font-family: var(--font-display);
            font-style: italic;
            font-size: 1.2rem;
            color: var(--gold);
            text-align: center;
        }

        .kenning-lightbox .lightbox-credit {
            margin-top: 6px;
            font-size: 0.85rem;
            color: var(--parchment-dim);
        }

        .kenning-lightbox .lightbox-credit a {
            color: var(--accent);
            text-decoration: none;
        }

        .kenning-lightbox .lightbox-credit a:hover {
            text-decoration: underline;
        }

        .kenning-lightbox .lightbox-close {
            position: absolute;
            top: 20px;
            right: 24px;
            background: none;
            border: none;
            color: var(--parchment);
            font-size: 2rem;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .kenning-lightbox .lightbox-close:hover {
            opacity: 1;
        }
    </style>
</head>
<body>

<!-- Navigation -->
<nav class="exhibition-nav" id="exhibition-nav" role="navigation" aria-label="Exhibition rooms">
    <div class="nav-title">The Kenning Exhibition</div>
    <div class="nav-rooms">
        <a href="index.html" class="nav-link" data-room="hall">
            <span class="nav-icon">&#x2302;</span>
            <span class="nav-label">Exhibition Hall</span>
        </a>
        <a href="beowulf.html" class="nav-link" data-room="beowulf">
            <span class="nav-icon">&#x2694;</span>
            <span class="nav-label">Beowulf Room</span>
        </a>
        <a href="prose-edda.html" class="nav-link" data-room="edda">
            <span class="nav-icon">&#x2744;</span>
            <span class="nav-label">Prose Edda</span>
        </a>
        <a href="skaldskaparmal.html" class="nav-link" data-room="skald">
            <span class="nav-icon">&#x270D;</span>
            <span class="nav-label">Skaldskaparmal</span>
        </a>
        <a href="kenning-forge.html" class="nav-link active" data-room="forge">
            <span class="nav-icon">&#x2692;</span>
            <span class="nav-label">Kenning Forge</span>
        </a>
        <a href="living-edda.html" class="nav-link" data-room="living">
            <span class="nav-icon">&#x2618;</span>
            <span class="nav-label">Living Edda</span>
        </a>
        <a href="runic-gallery.html" class="nav-link" data-room="runic">
            <span class="nav-icon">&#x25CA;</span>
            <span class="nav-label">Runic Gallery</span>
        </a>
    </div>
    <div class="nav-footer">
        <a href="../index.html" class="nav-back">
            <span class="nav-icon">&#x2190;</span>
            <span class="nav-label">Back to CCAB</span>
        </a>
    </div>
</nav>

<!-- Mobile header -->
<header class="mobile-header" id="mobile-header">
    <button class="hamburger" id="hamburger" aria-label="Open navigation">&#x2630;</button>
    <span class="mobile-title">The Kenning Exhibition</span>
</header>

<!-- Mobile overlay -->
<div class="nav-overlay" id="nav-overlay"></div>

<!-- Room transition -->
<div class="room-transition" id="room-transition"></div>

<!-- p5 backdrop -->
<div id="p5-backdrop" aria-hidden="true"></div>

<!-- Main content -->
<main class="exhibition-main" role="main">
    <div class="room-content">
        <header class="room-header">
            <h1>The Kenning Forge</h1>
            <p class="subtitle">"Craft new kennings from ancient patterns"</p>
        </header>

        <!-- Section tabs -->
        <div class="section-tabs" role="tablist" aria-label="Forge sections">
            <button class="section-tab active" role="tab" aria-selected="true" data-section="generator" aria-controls="section-generator">Pattern Generator</button>
            <button class="section-tab" role="tab" aria-selected="false" data-section="quiz" aria-controls="section-quiz">Reverse Kenning Game</button>
            <button class="section-tab" role="tab" aria-selected="false" data-section="freeform" aria-controls="section-freeform">Free-form Creator</button>
        </div>

        <!-- SECTION 1: Pattern Generator -->
        <section class="forge-section active" id="section-generator" role="tabpanel" aria-labelledby="tab-generator">
            <div class="forge-panel">
                <h2>Forge a Kenning</h2>

                <div class="step-label">
                    <span class="step-num">1</span>
                    <span class="step-text">Choose your subject (the referent)</span>
                </div>
                <select class="forge-select" id="referent-select" aria-label="Select a referent category">
                    <option value="">-- Select a subject --</option>
                    <option value="sea">The Sea</option>
                    <option value="gold">Gold / Treasure</option>
                    <option value="battle">Battle / War</option>
                    <option value="warrior">Warrior / Hero</option>
                    <option value="sword">Sword / Weapon</option>
                    <option value="blood">Blood</option>
                    <option value="ship">Ship</option>
                    <option value="woman">Woman</option>
                    <option value="poetry">Poetry</option>
                    <option value="body">The Body</option>
                    <option value="earth">The Earth</option>
                    <option value="sky">The Sky</option>
                    <option value="sun">The Sun</option>
                    <option value="fire">Fire</option>
                    <option value="wind">Wind</option>
                </select>

                <div class="step-label">
                    <span class="step-num">2</span>
                    <span class="step-text">Choose your pattern</span>
                </div>
                <div class="pattern-options" id="pattern-options" role="radiogroup" aria-label="Kenning pattern">
                    <label class="pattern-option selected" tabindex="0">
                        <input type="radio" name="pattern" value="compound" checked>
                        <span class="pattern-radio"></span>
                        <span class="pattern-label">Compound: noun-noun</span>
                        <span class="pattern-example">"whale-road"</span>
                    </label>
                    <label class="pattern-option" tabindex="0">
                        <input type="radio" name="pattern" value="genitive">
                        <span class="pattern-radio"></span>
                        <span class="pattern-label">Genitive: noun's noun</span>
                        <span class="pattern-example">"Sif's hair"</span>
                    </label>
                    <label class="pattern-option" tabindex="0">
                        <input type="radio" name="pattern" value="adjective">
                        <span class="pattern-radio"></span>
                        <span class="pattern-label">Adjective: adj-noun</span>
                        <span class="pattern-example">"bright-wound"</span>
                    </label>
                </div>

                <div class="step-label">
                    <span class="step-num">3</span>
                    <span class="step-text">Strike the anvil</span>
                </div>
                <button class="forge-btn" id="forge-btn" aria-label="Generate kennings">Forge Kenning</button>
            </div>

            <!-- Results -->
            <div class="results-area" id="results-area" aria-live="polite">
                <div class="forge-panel">
                    <h2>Your Forged Kennings</h2>
                    <div id="results-container"></div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="forge-btn-secondary" id="forge-again-btn">Forge Again</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION 2: Reverse Kenning Game -->
        <section class="forge-section" id="section-quiz" role="tabpanel" aria-labelledby="tab-quiz">
            <div class="forge-panel">
                <h2>Reverse Kenning Game</h2>
                <p style="color: var(--parchment-dim); font-size: 0.9rem; margin-bottom: 24px;">
                    A real kenning from the Norse corpus appears below. What does it mean?
                </p>

                <div class="quiz-score" id="quiz-score">
                    <div class="score-item">
                        <div class="score-value" id="score-correct">0</div>
                        <div class="score-label">Correct</div>
                    </div>
                    <div class="score-item">
                        <div class="score-value" id="score-total">0</div>
                        <div class="score-label">Attempted</div>
                    </div>
                    <div class="score-item">
                        <div class="score-value" id="score-streak">0</div>
                        <div class="score-label">Streak</div>
                    </div>
                </div>

                <div class="quiz-prompt" id="quiz-prompt">
                    <div class="quiz-kenning" id="quiz-kenning"></div>
                    <div class="quiz-hint" id="quiz-hint"></div>
                </div>

                <div class="quiz-feedback" id="quiz-feedback"></div>

                <div class="quiz-options" id="quiz-options"></div>

                <div style="text-align: center;">
                    <button class="forge-btn-secondary" id="next-quiz-btn" style="display: none;">Next Kenning</button>
                </div>
            </div>
        </section>

        <!-- SECTION 3: Free-form Creator -->
        <section class="forge-section" id="section-freeform" role="tabpanel" aria-labelledby="tab-freeform">
            <div class="forge-panel">
                <h2>Free-form Creator</h2>
                <p style="color: var(--parchment-dim); font-size: 0.9rem; margin-bottom: 24px;">
                    Combine any two words to forge your own kenning. Enter a determinant (the qualifier) and a base-word (the generic noun) to create a poetic compound.
                </p>

                <div class="input-row">
                    <div class="input-group">
                        <label for="ff-determinant">Determinant</label>
                        <input class="forge-input" id="ff-determinant" type="text" placeholder="e.g. whale, bone, Sif's" maxlength="40" autocomplete="off">
                    </div>
                    <div class="input-separator">+</div>
                    <div class="input-group">
                        <label for="ff-baseword">Base-word</label>
                        <input class="forge-input" id="ff-baseword" type="text" placeholder="e.g. road, house, hair" maxlength="40" autocomplete="off">
                    </div>
                </div>

                <div class="input-group" style="margin-bottom: 0;">
                    <label for="ff-meaning">Meaning (what it refers to)</label>
                    <input class="forge-input" id="ff-meaning" type="text" placeholder="e.g. the sea, the body, gold" maxlength="60" autocomplete="off">
                </div>

                <div class="freeform-preview" id="freeform-preview">
                    <span class="preview-empty">Your kenning will appear here...</span>
                </div>

                <div style="text-align: center;">
                    <button class="forge-btn-secondary" id="save-freeform-btn" disabled>Save to Living Edda</button>
                </div>
            </div>
        </section>

        <!-- Recent Forgings -->
        <div class="recent-forgings">
            <h3>Recent Forgings</h3>
            <div id="forgings-strip-container"></div>
        </div>

        <!-- Kenning Art Gallery Strip -->
        <div class="kenning-art-gallery">
            <h3>Kenning Art from StoryLeaf</h3>
            <p class="gallery-subtitle">Illustrations from the <a href="https://kenning.storyleaf.ai" target="_blank" rel="noopener">StoryLeaf Kenning Collection</a></p>
            <div class="art-gallery-strip" id="art-gallery-strip"></div>
        </div>
    </div>
</main>

<!-- Lightbox Modal -->
<div class="kenning-lightbox" id="kenning-lightbox" role="dialog" aria-label="Image lightbox">
    <button class="lightbox-close" aria-label="Close lightbox">&times;</button>
    <img src="" alt="" id="lightbox-img">
    <div class="lightbox-caption" id="lightbox-caption"></div>
    <div class="lightbox-credit" id="lightbox-credit"></div>
</div>

<!-- Audio toggle -->
<button class="audio-toggle muted" id="audio-toggle" aria-label="Toggle ambient sound">
    <span id="audio-icon">&#x1F507;</span>
</button>

<script src="../assets/js/enhance.js" defer></script>
<script>
// ============================================================
// WORD BANKS (from research-data.md Section VI)
// ============================================================
const WORD_BANKS = {
    baseWords: {
        liquid: ['road', 'way', 'path', 'street', 'bath', 'blood', 'sea', 'flood', 'wave', 'surf', 'stream', 'drink', 'mead', 'dew', 'sweat', 'tears', 'rain', 'shower'],
        light: ['fire', 'flame', 'torch', 'candle', 'gleam', 'flash', 'light', 'sun', 'moon', 'star', 'beacon'],
        solid: ['house', 'hall', 'chamber', 'bed', 'lair', 'land', 'ground', 'floor', 'field', 'plain', 'heath', 'reef', 'stone', 'rock'],
        living: ['horse', 'steed', 'deer', 'bear', 'wolf', 'hound', 'eagle', 'raven', 'swan', 'whale', 'fish', 'serpent', 'dragon', 'tree', 'ash', 'oak', 'birch', 'elm'],
        weather: ['storm', 'tempest', 'weather', 'wind', 'hail', 'rain', 'shower', 'squall', 'gust'],
        objects: ['ship', 'ski', 'sled', 'plow', 'churn', 'mill', 'loom', 'hoard', 'ring', 'necklace', 'crown']
    },
    determinants: {
        body: ['bone', 'breast', 'skull', 'flesh', 'blood', 'hair', 'eye', 'hand', 'arm', 'head'],
        seaWater: ['whale', 'seal', 'gannet', 'swan', 'fish', 'wave', 'billow', 'surf', 'kelp', 'sand', 'ice', 'reef'],
        war: ['sword', 'spear', 'shield', 'helm', 'mail', 'arrow', 'axe', 'bow', 'battle', 'slaughter', 'wound'],
        mythological: ['Odin', 'Thor', 'Freyja', 'Sif', 'Aegir', 'Ran', 'Ymir', 'Bragi', 'Fafnir', 'Fenrir', 'Kvasir', 'Frodi', 'Mimir', 'Loki', 'Tyr', 'Baldr'],
        nature: ['oak', 'ash', 'yew', 'birch', 'mountain', 'stone', 'ice', 'fire', 'wind', 'thunder', 'lightning'],
        social: ['ring', 'gold', 'mead', 'ale', 'hall', 'hearth', 'throne', 'loom', 'plow', 'ship']
    },
    adjectives: ['bright', 'dark', 'cold', 'fierce', 'ancient', 'gleaming', 'grim', 'swift', 'mighty', 'silent', 'bitter', 'deep', 'roaring', 'crimson', 'golden', 'iron', 'grey', 'wild', 'hollow', 'frothing']
};

// Referent -> which base-word categories and determinant categories to draw from
const REFERENT_CONFIG = {
    sea:     { bases: ['liquid', 'solid'],     dets: ['seaWater', 'mythological'],    detSpecific: ['whale', 'swan', 'gannet', 'fish', 'seal', 'Ymir', 'Ran', 'Aegir'], label: 'the sea' },
    gold:    { bases: ['light', 'liquid'],      dets: ['mythological', 'body'],        detSpecific: ['Aegir', 'Freyja', 'Sif', 'Fafnir', 'Frodi', 'hand', 'eye'], label: 'gold' },
    battle:  { bases: ['weather', 'liquid'],    dets: ['war', 'mythological'],         detSpecific: ['sword', 'spear', 'Odin', 'shield', 'helm', 'arrow'], label: 'battle' },
    warrior: { bases: ['living'],               dets: ['war', 'mythological', 'nature'], detSpecific: ['helmet', 'sword', 'shield', 'raven', 'eagle', 'Odin', 'battle', 'oak', 'ash'], label: 'warrior' },
    sword:   { bases: ['light', 'living'],      dets: ['war', 'body'],                 detSpecific: ['shield', 'helm', 'battle', 'wound', 'blood'], label: 'sword' },
    blood:   { bases: ['liquid'],               dets: ['war', 'body'],                 detSpecific: ['sword', 'wound', 'battle', 'spear', 'raven'], label: 'blood' },
    ship:    { bases: ['living', 'objects'],     dets: ['seaWater', 'mythological'],    detSpecific: ['sea', 'wave', 'mast', 'rope', 'prow'], label: 'ship' },
    woman:   { bases: ['living'],               dets: ['social', 'mythological'],      detSpecific: ['linen', 'silk', 'ring', 'gold', 'ale', 'mead', 'Freyja', 'Sif'], label: 'woman' },
    poetry:  { bases: ['liquid', 'objects'],     dets: ['mythological'],                detSpecific: ['Kvasir', 'Odin', 'Bragi', 'Aegir'], label: 'poetry' },
    body:    { bases: ['solid'],                dets: ['body'],                        detSpecific: ['bone', 'flesh', 'soul', 'breast', 'blood'], label: 'the body' },
    earth:   { bases: ['solid', 'living'],       dets: ['mythological', 'body'],        detSpecific: ['Ymir', 'Thor', 'Odin', 'beast', 'flesh'], label: 'the earth' },
    sky:     { bases: ['solid'],                dets: ['mythological', 'nature'],      detSpecific: ['Ymir', 'sun', 'wind', 'star', 'skull'], label: 'the sky' },
    sun:     { bases: ['light'],                dets: ['nature'],                      detSpecific: ['heaven', 'air', 'world', 'sky'], label: 'the sun' },
    fire:    { bases: ['light', 'weather'],      dets: ['nature', 'social'],            detSpecific: ['wind', 'wood', 'house', 'hearth'], label: 'fire' },
    wind:    { bases: ['living', 'weather'],     dets: ['nature', 'mythological'],      detSpecific: ['sea', 'fire', 'wood', 'sail', 'mountain'], label: 'wind' }
};

// ============================================================
// QUIZ DATABASE (real kennings from the corpus)
// ============================================================
const QUIZ_KENNINGS = [
    { kenning: 'whale-road', meaning: 'the sea', wrong: ['a mountain path', 'a river', 'a ship'] },
    { kenning: 'bone-house', meaning: 'the body', wrong: ['a grave', 'a hall', 'a shield'] },
    { kenning: 'battle-light', meaning: 'a sword', wrong: ['fire', 'the sun', 'lightning'] },
    { kenning: 'heaven-candle', meaning: 'the sun', wrong: ['a star', 'the moon', 'a torch'] },
    { kenning: 'word-hoard', meaning: 'vocabulary / speech', wrong: ['a book', 'a poem', 'a rune'] },
    { kenning: 'ring-giver', meaning: 'a king or lord', wrong: ['a merchant', 'a blacksmith', 'a bride'] },
    { kenning: 'swan-road', meaning: 'the sea', wrong: ['the sky', 'a river', 'a lake'] },
    { kenning: "Sif's hair", meaning: 'gold', wrong: ['wheat', 'the sun', 'a woman'] },
    { kenning: 'raven-feeder', meaning: 'a warrior', wrong: ['a farmer', 'a priest', 'a hunter'] },
    { kenning: 'horse of the sea', meaning: 'a ship', wrong: ['a whale', 'a wave', 'a seahorse'] },
    { kenning: "blood of Ymir", meaning: 'the sea', wrong: ['lava', 'wine', 'gold'] },
    { kenning: 'storm of swords', meaning: 'battle', wrong: ['a blizzard', 'a forge', 'thunder'] },
    { kenning: "skull of Ymir", meaning: 'the sky', wrong: ['a helmet', 'the earth', 'a mountain'] },
    { kenning: 'peace-weaver', meaning: 'a queen / noblewoman', wrong: ['a poet', 'a priest', 'a loom'] },
    { kenning: 'breast-hoard', meaning: 'heart / mind', wrong: ['armor', 'gold', 'a secret'] },
    { kenning: "Freyja's tears", meaning: 'gold', wrong: ['rain', 'amber', 'silver'] },
    { kenning: "blood of Kvasir", meaning: 'poetry / mead', wrong: ['wine', 'sacrifice', 'gold'] },
    { kenning: "fire of Aegir", meaning: 'gold', wrong: ['the sea', 'a volcano', 'lightning'] },
    { kenning: 'serpent of shields', meaning: 'a sword', wrong: ['a dragon', 'an arrow', 'a spear'] },
    { kenning: 'sea of wounds', meaning: 'blood', wrong: ['a battlefield', 'tears', 'the ocean'] },
    { kenning: 'slaughter-bed', meaning: 'deathbed / battlefield', wrong: ['a grave', 'a funeral pyre', 'a shield'] },
    { kenning: 'sword-sleep', meaning: 'death', wrong: ['rest', 'a sheathed blade', 'night'] },
    { kenning: "Frodi's flour", meaning: 'gold', wrong: ['bread', 'the earth', 'salt'] },
    { kenning: 'birch of linen', meaning: 'a woman', wrong: ['a tree', 'a sail', 'a banner'] },
    { kenning: 'fire of heaven', meaning: 'the sun', wrong: ['lightning', 'a star', 'gold'] },
    { kenning: "bane of wood", meaning: 'fire (or wind)', wrong: ['an axe', 'ice', 'a beetle'] },
    { kenning: 'gannet\'s bath', meaning: 'the sea', wrong: ['a lake', 'a pond', 'rain'] },
    { kenning: 'flesh of Ymir', meaning: 'the earth', wrong: ['stone', 'the sea', 'gold'] },
    { kenning: 'wave-floater', meaning: 'a ship', wrong: ['a whale', 'driftwood', 'a duck'] },
    { kenning: 'hound of the wood', meaning: 'wind', wrong: ['a wolf', 'a fox', 'fire'] }
];

// ============================================================
// UTILITY FUNCTIONS
// ============================================================
function pick(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
}

function pickN(arr, n) {
    const shuffled = [...arr].sort(() => Math.random() - 0.5);
    return shuffled.slice(0, n);
}

function shuffle(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
}

function capitalize(s) {
    return s.charAt(0).toUpperCase() + s.slice(1);
}

// ============================================================
// KENNING GENERATOR
// ============================================================
function generateKenning(referent, pattern) {
    const config = REFERENT_CONFIG[referent];
    if (!config) return null;

    // Pick a determinant (prefer specific ones for authenticity)
    let det;
    if (Math.random() < 0.7 && config.detSpecific.length > 0) {
        det = pick(config.detSpecific);
    } else {
        const detCat = pick(config.dets);
        det = pick(WORD_BANKS.determinants[detCat]);
    }

    // Pick a base-word
    const baseCat = pick(config.bases);
    const base = pick(WORD_BANKS.baseWords[baseCat]);

    // Avoid tautology (determinant same as base)
    if (det.toLowerCase() === base.toLowerCase()) {
        return generateKenning(referent, pattern);
    }

    let kenningText, patternLabel;

    switch (pattern) {
        case 'compound':
            kenningText = det.toLowerCase() + '-' + base;
            patternLabel = 'Compound (noun-noun)';
            break;
        case 'genitive':
            if (/[sx]$/i.test(det)) {
                kenningText = det + "' " + base;
            } else {
                kenningText = det + "'s " + base;
            }
            patternLabel = "Genitive (noun's noun)";
            break;
        case 'adjective':
            const adj = pick(WORD_BANKS.adjectives);
            kenningText = adj + '-' + base;
            patternLabel = 'Adjective (adj-noun)';
            break;
        default:
            kenningText = det.toLowerCase() + '-' + base;
            patternLabel = 'Compound (noun-noun)';
    }

    return {
        kenning: kenningText,
        meaning: config.label,
        pattern: patternLabel,
        referent: referent
    };
}

function generateMultiple(referent, pattern, count) {
    const results = [];
    const seen = new Set();
    let attempts = 0;
    while (results.length < count && attempts < 50) {
        const k = generateKenning(referent, pattern);
        if (k && !seen.has(k.kenning)) {
            seen.add(k.kenning);
            results.push(k);
        }
        attempts++;
    }
    return results;
}

// ============================================================
// LOCAL STORAGE
// ============================================================
function getForged() {
    try {
        return JSON.parse(localStorage.getItem('exhibition-forged')) || [];
    } catch { return []; }
}

function saveForged(entry) {
    const forged = getForged();
    forged.unshift({
        kenning: entry.kenning,
        meaning: entry.meaning,
        pattern: entry.pattern || 'free-form',
        timestamp: Date.now()
    });
    // Keep only last 50
    if (forged.length > 50) forged.length = 50;
    localStorage.setItem('exhibition-forged', JSON.stringify(forged));
    renderRecentForgings();
}

// ============================================================
// UI LOGIC
// ============================================================
(function() {
    // --- Tab switching ---
    const tabs = document.querySelectorAll('.section-tab');
    const sections = document.querySelectorAll('.forge-section');

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => { t.classList.remove('active'); t.setAttribute('aria-selected', 'false'); });
            sections.forEach(s => s.classList.remove('active'));
            tab.classList.add('active');
            tab.setAttribute('aria-selected', 'true');
            const sectionId = 'section-' + tab.dataset.section;
            document.getElementById(sectionId).classList.add('active');
        });
    });

    // --- Pattern radio selection ---
    const patternOptions = document.querySelectorAll('.pattern-option');
    patternOptions.forEach(opt => {
        opt.addEventListener('click', () => {
            patternOptions.forEach(o => o.classList.remove('selected'));
            opt.classList.add('selected');
            opt.querySelector('input').checked = true;
        });
        opt.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                opt.click();
            }
        });
    });

    // --- Forge button ---
    const forgeBtn = document.getElementById('forge-btn');
    const forgeAgainBtn = document.getElementById('forge-again-btn');
    const resultsArea = document.getElementById('results-area');
    const resultsContainer = document.getElementById('results-container');

    function doForge() {
        const referent = document.getElementById('referent-select').value;
        if (!referent) {
            document.getElementById('referent-select').focus();
            return;
        }
        const pattern = document.querySelector('input[name="pattern"]:checked').value;
        const kennings = generateMultiple(referent, pattern, 3);

        resultsContainer.innerHTML = '';
        kennings.forEach(k => {
            const card = document.createElement('div');
            card.className = 'result-card';
            card.innerHTML =
                '<div class="result-kenning">' + escapeHtml(k.kenning) + '</div>' +
                '<div class="result-meaning">= ' + escapeHtml(k.meaning) + '</div>' +
                '<div class="result-pattern">' + escapeHtml(k.pattern) + '</div>' +
                '<div class="result-actions">' +
                    '<button class="forge-btn-small save-result" aria-label="Save ' + escapeHtml(k.kenning) + ' to Living Edda">Save to Living Edda</button>' +
                '</div>';
            card.querySelector('.save-result').addEventListener('click', () => {
                saveForged(k);
                card.querySelector('.save-result').textContent = 'Saved!';
                card.querySelector('.save-result').disabled = true;
            });
            resultsContainer.appendChild(card);
        });

        // Add a random inspiration image
        const inspImg = getRandomImage();
        if (inspImg) {
            const imgEl = buildImageElement(inspImg);
            if (imgEl) resultsContainer.appendChild(imgEl);
        }

        resultsArea.classList.add('visible');
        resultsArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    forgeBtn.addEventListener('click', doForge);
    forgeAgainBtn.addEventListener('click', doForge);

    // --- Quiz Logic ---
    let quizCorrect = 0;
    let quizTotal = 0;
    let quizStreak = 0;
    let quizUsed = [];

    function loadQuiz() {
        // Pick a kenning not recently used
        let pool = QUIZ_KENNINGS.filter((_, i) => !quizUsed.includes(i));
        if (pool.length === 0) {
            quizUsed = [];
            pool = QUIZ_KENNINGS;
        }
        const idx = QUIZ_KENNINGS.indexOf(pick(pool));
        quizUsed.push(idx);
        if (quizUsed.length > 15) quizUsed.shift();

        const q = QUIZ_KENNINGS[idx];
        document.getElementById('quiz-kenning').textContent = q.kenning;
        document.getElementById('quiz-hint').textContent = 'What does this kenning refer to?';

        // Show a random thematic image alongside the quiz question
        let quizImgContainer = document.getElementById('quiz-image');
        if (!quizImgContainer) {
            quizImgContainer = document.createElement('div');
            quizImgContainer.id = 'quiz-image';
            document.getElementById('quiz-prompt').appendChild(quizImgContainer);
        }
        quizImgContainer.innerHTML = '';
        const quizImg = getRandomImage();
        if (quizImg) {
            const quizImgEl = buildImageElement(quizImg, 'quiz-image-container');
            if (quizImgEl) quizImgContainer.appendChild(quizImgEl);
        }

        const feedback = document.getElementById('quiz-feedback');
        feedback.className = 'quiz-feedback';
        feedback.textContent = '';

        document.getElementById('next-quiz-btn').style.display = 'none';

        // Build options
        const options = shuffle([q.meaning, ...pickN(q.wrong, 3)]);
        const container = document.getElementById('quiz-options');
        container.innerHTML = '';
        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'quiz-option';
            btn.textContent = capitalize(opt);
            btn.addEventListener('click', () => handleQuizAnswer(btn, opt, q));
            container.appendChild(btn);
        });
    }

    function handleQuizAnswer(btn, chosen, q) {
        const allBtns = document.querySelectorAll('.quiz-option');
        allBtns.forEach(b => b.classList.add('disabled'));

        quizTotal++;
        const feedback = document.getElementById('quiz-feedback');

        if (chosen === q.meaning) {
            btn.classList.add('correct');
            quizCorrect++;
            quizStreak++;
            feedback.className = 'quiz-feedback visible success';
            feedback.textContent = 'Correct! "' + q.kenning + '" means ' + q.meaning + '.';
        } else {
            btn.classList.add('wrong');
            quizStreak = 0;
            // Highlight correct
            allBtns.forEach(b => {
                if (b.textContent.toLowerCase() === capitalize(q.meaning).toLowerCase()) {
                    b.classList.add('correct');
                }
            });
            feedback.className = 'quiz-feedback visible fail';
            feedback.textContent = 'Not quite. "' + q.kenning + '" means ' + q.meaning + '.';
        }

        document.getElementById('score-correct').textContent = quizCorrect;
        document.getElementById('score-total').textContent = quizTotal;
        document.getElementById('score-streak').textContent = quizStreak;
        document.getElementById('next-quiz-btn').style.display = 'inline-block';
    }

    document.getElementById('next-quiz-btn').addEventListener('click', loadQuiz);

    // Load first quiz when tab is shown
    const quizTab = document.querySelector('[data-section="quiz"]');
    quizTab.addEventListener('click', () => {
        if (document.getElementById('quiz-kenning').textContent === '') {
            loadQuiz();
        }
    });

    // --- Free-form Creator ---
    const ffDet = document.getElementById('ff-determinant');
    const ffBase = document.getElementById('ff-baseword');
    const ffMeaning = document.getElementById('ff-meaning');
    const ffPreview = document.getElementById('freeform-preview');
    const ffSaveBtn = document.getElementById('save-freeform-btn');

    function updateFreeformPreview() {
        const d = ffDet.value.trim();
        const b = ffBase.value.trim();
        const m = ffMeaning.value.trim();

        if (d && b) {
            let combined;
            if (d.endsWith("'s") || d.endsWith("'")) {
                combined = d + ' ' + b;
            } else {
                combined = d + '-' + b;
            }
            ffPreview.innerHTML = '<span class="preview-kenning">' + escapeHtml(combined) + '</span>';
            if (m) {
                ffPreview.innerHTML += '<div class="result-meaning" style="margin-top:6px;">= ' + escapeHtml(m) + '</div>';
            }
            ffSaveBtn.disabled = !m;
        } else {
            ffPreview.innerHTML = '<span class="preview-empty">Your kenning will appear here...</span>';
            ffSaveBtn.disabled = true;
        }
    }

    ffDet.addEventListener('input', updateFreeformPreview);
    ffBase.addEventListener('input', updateFreeformPreview);
    ffMeaning.addEventListener('input', updateFreeformPreview);

    ffSaveBtn.addEventListener('click', () => {
        const d = ffDet.value.trim();
        const b = ffBase.value.trim();
        const m = ffMeaning.value.trim();
        if (!d || !b || !m) return;

        let combined;
        if (d.endsWith("'s") || d.endsWith("'")) {
            combined = d + ' ' + b;
        } else {
            combined = d + '-' + b;
        }

        saveForged({ kenning: combined, meaning: m, pattern: 'free-form' });
        ffDet.value = '';
        ffBase.value = '';
        ffMeaning.value = '';
        updateFreeformPreview();
        ffSaveBtn.textContent = 'Saved!';
        setTimeout(() => { ffSaveBtn.textContent = 'Save to Living Edda'; }, 1500);
    });

    // --- Recent Forgings ---
    window.renderRecentForgings = function() {
        const container = document.getElementById('forgings-strip-container');
        const forged = getForged();
        if (forged.length === 0) {
            container.innerHTML = '<div class="empty-forgings">No kennings forged yet. Create one above!</div>';
            return;
        }
        let html = '<div class="forgings-strip">';
        forged.slice(0, 20).forEach(f => {
            html += '<div class="forging-chip">' +
                '<div class="chip-kenning">' + escapeHtml(f.kenning) + '</div>' +
                '<div class="chip-meaning">= ' + escapeHtml(f.meaning) + '</div>' +
            '</div>';
        });
        html += '</div>';
        container.innerHTML = html;
    };

    renderRecentForgings();

    // --- Navigation logic ---
    const nav = document.getElementById('exhibition-nav');
    const hamburger = document.getElementById('hamburger');
    const overlay = document.getElementById('nav-overlay');
    const transition = document.getElementById('room-transition');
    const navLinks = document.querySelectorAll('.nav-link');

    if (hamburger) {
        hamburger.addEventListener('click', () => {
            nav.classList.toggle('open');
            overlay.classList.toggle('visible');
        });
    }

    if (overlay) {
        overlay.addEventListener('click', () => {
            nav.classList.remove('open');
            overlay.classList.remove('visible');
        });
    }

    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            if (link.classList.contains('active')) {
                e.preventDefault();
                return;
            }
            e.preventDefault();
            transition.classList.add('active');
            setTimeout(() => {
                window.location.href = link.href;
            }, 400);
        });
    });

    window.addEventListener('load', () => {
        transition.classList.add('active');
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                transition.classList.remove('active');
            });
        });
    });
})();

// ============================================================
// p5.js BACKDROP: Forge Sparks
// ============================================================
const forgeSketch = (p) => {
    const particles = [];
    const MAX_PARTICLES = 200;

    p.setup = () => {
        const container = document.getElementById('p5-backdrop');
        const cnv = p.createCanvas(container.offsetWidth, container.offsetHeight);
        cnv.parent('p5-backdrop');
        p.frameRate(30);
        p.noStroke();
    };

    p.draw = () => {
        p.background(26, 26, 46, 30);

        // Emit sparks from bottom center
        if (p.frameCount % 2 === 0 && particles.length < MAX_PARTICLES) {
            const cx = p.width * 0.5;
            const cy = p.height;
            for (let i = 0; i < 3; i++) {
                particles.push({
                    x: cx + p.random(-60, 60),
                    y: cy,
                    vx: p.random(-2, 2),
                    vy: p.random(-7, -3),
                    life: 1.0,
                    decay: p.random(0.005, 0.02),
                    size: p.random(2, 5),
                    hue: p.random(15, 40) // orange to yellow range
                });
            }
        }

        // Update and draw
        for (let i = particles.length - 1; i >= 0; i--) {
            const pt = particles[i];
            pt.x += pt.vx;
            pt.vy += 0.05; // gravity
            pt.y += pt.vy;
            pt.vx *= 0.99;
            pt.life -= pt.decay;

            if (pt.life <= 0) {
                particles.splice(i, 1);
                continue;
            }

            const alpha = pt.life * 255;
            // Orange to white gradient based on life
            if (pt.life > 0.7) {
                p.fill(255, 240, 220, alpha);
            } else if (pt.life > 0.4) {
                p.fill(212 + pt.hue, 96, 26, alpha);
            } else {
                p.fill(180, 60, 10, alpha * 0.6);
            }
            p.ellipse(pt.x, pt.y, pt.size * pt.life, pt.size * pt.life);
        }
    };

    p.windowResized = () => {
        const container = document.getElementById('p5-backdrop');
        if (container) {
            p.resizeCanvas(container.offsetWidth, container.offsetHeight);
        }
    };
};

new p5(forgeSketch);

// ============================================================
// WEB AUDIO: Forge Ambience (C2 65Hz, square filtered + sine)
// ============================================================
class ForgeAmbience {
    constructor() {
        this.ctx = null;
        this.isPlaying = false;
    }

    init() {
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        this.master = this.ctx.createGain();
        this.master.gain.value = 0;
        this.master.connect(this.ctx.destination);

        // Lowpass filter for industrial texture
        this.filter = this.ctx.createBiquadFilter();
        this.filter.type = 'lowpass';
        this.filter.frequency.value = 200;
        this.filter.Q.value = 2;
        this.filter.connect(this.master);

        // Drone 1: square wave at C2 (65 Hz), heavily filtered
        this.osc1 = this.ctx.createOscillator();
        this.osc1.type = 'square';
        this.osc1.frequency.value = 65;
        this.gain1 = this.ctx.createGain();
        this.gain1.gain.value = 0.25;
        this.osc1.connect(this.gain1);
        this.gain1.connect(this.filter);
        this.osc1.start();

        // Drone 2: sine at perfect fifth above (97.5 Hz)
        this.osc2 = this.ctx.createOscillator();
        this.osc2.type = 'sine';
        this.osc2.frequency.value = 97.5;
        this.gain2 = this.ctx.createGain();
        this.gain2.gain.value = 0.12;
        this.osc2.connect(this.gain2);
        this.gain2.connect(this.filter);
        this.osc2.start();

        // Slow LFO for filter sweep
        this.lfo = this.ctx.createOscillator();
        this.lfo.type = 'sine';
        this.lfo.frequency.value = 0.08;
        this.lfoGain = this.ctx.createGain();
        this.lfoGain.gain.value = 80;
        this.lfo.connect(this.lfoGain);
        this.lfoGain.connect(this.filter.frequency);
        this.lfo.start();
    }

    fadeIn(duration) {
        duration = duration || 3;
        if (!this.ctx) this.init();
        if (this.ctx.state === 'suspended') this.ctx.resume();
        this.master.gain.cancelScheduledValues(this.ctx.currentTime);
        this.master.gain.setValueAtTime(this.master.gain.value, this.ctx.currentTime);
        this.master.gain.linearRampToValueAtTime(0.12, this.ctx.currentTime + duration);
        this.isPlaying = true;
    }

    fadeOut(duration) {
        duration = duration || 2;
        if (!this.ctx) return;
        this.master.gain.cancelScheduledValues(this.ctx.currentTime);
        this.master.gain.setValueAtTime(this.master.gain.value, this.ctx.currentTime);
        this.master.gain.linearRampToValueAtTime(0, this.ctx.currentTime + duration);
        this.isPlaying = false;
    }

    toggle() {
        this.isPlaying ? this.fadeOut() : this.fadeIn();
    }
}

const forgeAudio = new ForgeAmbience();

(function() {
    const audioBtn = document.getElementById('audio-toggle');
    const audioIcon = document.getElementById('audio-icon');

    // Restore preference
    const pref = localStorage.getItem('exhibition-audio');

    audioBtn.addEventListener('click', () => {
        forgeAudio.toggle();
        if (forgeAudio.isPlaying) {
            audioBtn.classList.remove('muted');
            audioIcon.innerHTML = '&#x1F50A;';
            localStorage.setItem('exhibition-audio', 'on');
        } else {
            audioBtn.classList.add('muted');
            audioIcon.innerHTML = '&#x1F507;';
            localStorage.setItem('exhibition-audio', 'off');
        }
    });
})();

// ============================================================
// IMAGE INTEGRATION (StoryLeaf Kenning Collection)
// ============================================================
const STORYLEAF_BASE = 'https://kenning.storyleaf.ai/img/';

function getRandomImages(count) {
    if (typeof kenningImagesData === 'undefined') return [];
    const shuffled = [...kenningImagesData].sort(() => Math.random() - 0.5);
    return shuffled.slice(0, count);
}

function getRandomImage() {
    const imgs = getRandomImages(1);
    return imgs.length > 0 ? imgs[0] : null;
}

function buildImageElement(imgData, extraClass) {
    if (!imgData) return null;
    const cls = extraClass || 'forge-inspiration-img';
    const wrapper = document.createElement('div');
    wrapper.className = cls;
    wrapper.setAttribute('data-filename', imgData.filename);
    wrapper.setAttribute('data-caption', imgData.caption);
    wrapper.setAttribute('data-artist', imgData.artist);
    wrapper.addEventListener('click', function() {
        openLightbox(imgData.filename, imgData.caption, imgData.artist);
    });

    const img = document.createElement('img');
    img.src = STORYLEAF_BASE + encodeURIComponent(imgData.filename);
    img.alt = imgData.caption;
    img.loading = 'lazy';
    wrapper.appendChild(img);

    const credit = document.createElement('div');
    credit.className = 'img-credit';
    credit.textContent = '"' + imgData.caption + '" \u2014 ' + imgData.artist;
    wrapper.appendChild(credit);

    return wrapper;
}

// Lightbox
function openLightbox(filename, caption, artist) {
    const lb = document.getElementById('kenning-lightbox');
    const img = document.getElementById('lightbox-img');
    const cap = document.getElementById('lightbox-caption');
    const cred = document.getElementById('lightbox-credit');
    img.src = STORYLEAF_BASE + encodeURIComponent(filename);
    img.alt = caption;
    cap.textContent = caption;
    cred.innerHTML = 'Art by ' + escapeHtml(artist) + ' -- <a href="https://kenning.storyleaf.ai" target="_blank" rel="noopener">StoryLeaf Kenning Collection</a>';
    lb.classList.add('visible');
}

(function() {
    const lb = document.getElementById('kenning-lightbox');
    lb.addEventListener('click', function(e) {
        if (e.target === lb || e.target.classList.contains('lightbox-close')) {
            lb.classList.remove('visible');
        }
    });
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && lb.classList.contains('visible')) {
            lb.classList.remove('visible');
        }
    });
})();

// Populate gallery strip
function populateArtGallery() {
    const strip = document.getElementById('art-gallery-strip');
    if (!strip || typeof kenningImagesData === 'undefined') return;
    strip.innerHTML = '';
    const images = getRandomImages(10);
    images.forEach(function(imgData) {
        const item = document.createElement('div');
        item.className = 'art-gallery-item';
        item.addEventListener('click', function() {
            openLightbox(imgData.filename, imgData.caption, imgData.artist);
        });

        const img = document.createElement('img');
        img.src = STORYLEAF_BASE + encodeURIComponent(imgData.filename);
        img.alt = imgData.caption;
        img.loading = 'lazy';
        item.appendChild(img);

        const caption = document.createElement('div');
        caption.className = 'art-caption';
        caption.textContent = imgData.caption;
        item.appendChild(caption);

        const artist = document.createElement('div');
        artist.className = 'art-artist';
        artist.textContent = imgData.artist;
        item.appendChild(artist);

        strip.appendChild(item);
    });
}

populateArtGallery();

// HTML escape (global for image functions)
function escapeHtml(s) {
    const div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
}

// Expose reset for enhance.js
window.reset = function() {
    document.getElementById('referent-select').value = '';
    document.getElementById('results-area').classList.remove('visible');
    document.querySelectorAll('.pattern-option').forEach((o, i) => {
        o.classList.toggle('selected', i === 0);
        o.querySelector('input').checked = (i === 0);
    });
};
</script>
</body>
</html>
