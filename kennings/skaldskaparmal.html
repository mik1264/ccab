<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skaldskaparmal - The Language of Poetry | The Kenning Exhibition</title>
    <meta name="description" content="Explore Snorri Sturluson's systematic catalog of kennings from the Skaldskaparmal, organized by referent categories: Gold, Sea, Battle, Swords, Blood, Ships, and more.">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>&#x270D;</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400;1,600&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <style>
        /* === SHARED CSS === */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-deep: #1a1a2e;
            --bg-mid: #16213e;
            --bg-surface: #1f2641;
            --gold: #e6c069;
            --gold-dim: #b8944d;
            --parchment: #d4c5a9;
            --parchment-dim: #9e9279;
            --ink: #0d0d1a;
            --glow: rgba(230, 192, 105, 0.15);
            --accent: #c77d2e;
            --accent-glow: rgba(199, 125, 46, 0.12);
            --font-display: 'EB Garamond', 'Georgia', serif;
            --font-body: 'Inter', 'Helvetica Neue', sans-serif;
            --nav-width: 260px;
            --transition-room: 0.6s cubic-bezier(0.22, 1, 0.36, 1);
        }

        html {
            scroll-behavior: smooth;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: var(--font-body);
            background: var(--bg-deep);
            color: var(--parchment);
            line-height: 1.7;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* === NAVIGATION === */
        .exhibition-nav {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--nav-width);
            height: 100vh;
            background: linear-gradient(180deg, var(--ink) 0%, var(--bg-deep) 100%);
            border-right: 1px solid rgba(230, 192, 105, 0.08);
            padding: 30px 0;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1);
        }

        .exhibition-nav .nav-title {
            font-family: var(--font-display);
            font-size: 1.1rem;
            color: var(--gold);
            text-align: center;
            padding: 0 20px 25px;
            border-bottom: 1px solid rgba(230, 192, 105, 0.1);
            letter-spacing: 0.05em;
        }

        .exhibition-nav .nav-rooms {
            flex: 1;
            padding: 15px 0;
            overflow-y: auto;
        }

        .exhibition-nav .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: var(--parchment-dim);
            text-decoration: none;
            font-family: var(--font-body);
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .exhibition-nav .nav-link:hover {
            color: var(--gold);
            background: rgba(230, 192, 105, 0.05);
            border-left-color: var(--gold-dim);
        }

        .exhibition-nav .nav-link.active {
            color: var(--gold);
            background: rgba(230, 192, 105, 0.08);
            border-left-color: var(--accent);
        }

        .exhibition-nav .nav-icon {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        .exhibition-nav .nav-footer {
            padding: 15px 0;
            border-top: 1px solid rgba(230, 192, 105, 0.1);
        }

        .exhibition-nav .nav-back {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: var(--parchment-dim);
            text-decoration: none;
            font-family: var(--font-body);
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .exhibition-nav .nav-back:hover {
            color: var(--gold);
        }

        /* === MOBILE HEADER === */
        .mobile-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: var(--ink);
            border-bottom: 1px solid rgba(230, 192, 105, 0.1);
            align-items: center;
            padding: 0 16px;
            z-index: 999;
        }

        .hamburger {
            width: 40px;
            height: 40px;
            background: none;
            border: none;
            color: var(--gold);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .mobile-title {
            font-family: var(--font-display);
            color: var(--gold);
            font-size: 1rem;
            margin-left: 12px;
        }

        .nav-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 998;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .nav-overlay.visible {
            opacity: 1;
            pointer-events: all;
        }

        /* === P5 BACKDROP === */
        #p5-backdrop {
            position: fixed;
            top: 0;
            left: var(--nav-width);
            right: 0;
            bottom: 0;
            z-index: 0;
            opacity: 0.35;
            pointer-events: none;
        }

        #p5-backdrop canvas {
            display: block;
            width: 100% !important;
            height: 100% !important;
        }

        /* === MAIN CONTENT === */
        .exhibition-main {
            margin-left: var(--nav-width);
            min-height: 100vh;
            position: relative;
        }

        .room-content {
            position: relative;
            z-index: 1;
            max-width: 1100px;
            margin: 0 auto;
            padding: 60px 40px 100px;
        }

        /* === ROOM TRANSITION === */
        .room-transition {
            position: fixed;
            inset: 0;
            background: var(--ink);
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }

        .room-transition.active {
            opacity: 1;
            pointer-events: all;
        }

        /* === AUDIO TOGGLE === */
        .audio-toggle {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--bg-surface);
            border: 1px solid rgba(230, 192, 105, 0.15);
            color: var(--gold);
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .audio-toggle:hover {
            background: rgba(230, 192, 105, 0.15);
            transform: scale(1.1);
        }

        .audio-toggle.muted {
            color: var(--parchment-dim);
        }

        /* === SCROLLBAR === */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-deep); }
        ::-webkit-scrollbar-thumb { background: var(--gold-dim); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gold); }

        /* === REDUCED MOTION === */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
            #p5-backdrop { display: none; }
            .room-transition { display: none; }
        }

        /* === ROOM HEADER === */
        .room-header {
            text-align: center;
            margin-bottom: 50px;
            padding-bottom: 40px;
            border-bottom: 1px solid rgba(199, 125, 46, 0.2);
        }

        .room-header h1 {
            font-family: var(--font-display);
            font-size: 2.4rem;
            font-weight: 600;
            color: var(--gold);
            margin-bottom: 12px;
            letter-spacing: 0.03em;
        }

        .room-header .room-subtitle {
            font-family: var(--font-display);
            font-size: 1.15rem;
            font-style: italic;
            color: var(--parchment-dim);
            max-width: 600px;
            margin: 0 auto;
        }

        .room-header .room-source {
            display: inline-block;
            margin-top: 15px;
            padding: 4px 16px;
            background: var(--accent-glow);
            border: 1px solid rgba(199, 125, 46, 0.25);
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--accent);
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        /* === KENNING STRUCTURE DIAGRAM === */
        .structure-diagram {
            background: rgba(199, 125, 46, 0.06);
            border: 1px solid rgba(199, 125, 46, 0.18);
            border-radius: 12px;
            padding: 30px 35px;
            margin-bottom: 40px;
            position: relative;
            overflow: hidden;
        }

        .structure-diagram::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
        }

        .structure-diagram h2 {
            font-family: var(--font-display);
            font-size: 1.3rem;
            color: var(--gold);
            margin-bottom: 20px;
            text-align: center;
            letter-spacing: 0.05em;
        }

        .diagram-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .diagram-box {
            text-align: center;
            padding: 10px 20px;
            border-radius: 8px;
        }

        .diagram-box.base {
            background: rgba(230, 192, 105, 0.1);
            border: 1px solid rgba(230, 192, 105, 0.25);
        }

        .diagram-box.det {
            background: rgba(199, 125, 46, 0.1);
            border: 1px solid rgba(199, 125, 46, 0.25);
        }

        .diagram-box.result {
            background: rgba(199, 125, 46, 0.15);
            border: 1px solid rgba(199, 125, 46, 0.35);
        }

        .diagram-box .box-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--parchment-dim);
            margin-bottom: 4px;
        }

        .diagram-box .box-value {
            font-family: var(--font-display);
            font-size: 1.2rem;
            font-style: italic;
            color: var(--gold);
        }

        .diagram-box .box-gloss {
            font-size: 0.8rem;
            color: var(--parchment-dim);
            margin-top: 2px;
        }

        .diagram-plus {
            font-size: 1.4rem;
            color: var(--accent);
            font-weight: 300;
        }

        .diagram-equals {
            font-size: 1.4rem;
            color: var(--gold);
            font-weight: 300;
        }

        .diagram-caption {
            text-align: center;
            font-size: 0.85rem;
            color: var(--parchment-dim);
            margin-top: 12px;
            font-style: italic;
        }

        /* === SEARCH & FILTERS === */
        .controls-panel {
            margin-bottom: 35px;
        }

        .search-bar {
            display: flex;
            gap: 0;
            margin-bottom: 18px;
        }

        .search-bar input {
            flex: 1;
            padding: 12px 18px;
            background: var(--bg-surface);
            border: 1px solid rgba(230, 192, 105, 0.15);
            border-right: none;
            border-radius: 8px 0 0 8px;
            color: var(--parchment);
            font-family: var(--font-body);
            font-size: 0.95rem;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .search-bar input::placeholder {
            color: var(--parchment-dim);
        }

        .search-bar input:focus {
            border-color: var(--accent);
        }

        .search-bar .search-count {
            display: flex;
            align-items: center;
            padding: 0 16px;
            background: var(--bg-surface);
            border: 1px solid rgba(230, 192, 105, 0.15);
            border-left: none;
            border-radius: 0 8px 8px 0;
            color: var(--parchment-dim);
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .tag-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag-btn {
            padding: 6px 14px;
            border: 1px solid rgba(199, 125, 46, 0.25);
            border-radius: 20px;
            background: transparent;
            color: var(--parchment-dim);
            font-family: var(--font-body);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.03em;
        }

        .tag-btn:hover {
            color: var(--gold);
            border-color: var(--gold-dim);
            background: rgba(230, 192, 105, 0.05);
        }

        .tag-btn.active {
            color: var(--ink);
            background: var(--accent);
            border-color: var(--accent);
        }

        .tag-btn .tag-count {
            display: inline-block;
            margin-left: 4px;
            font-size: 0.7rem;
            opacity: 0.7;
        }

        /* === CHAPTER SECTIONS === */
        .chapter {
            margin-bottom: 35px;
            border: 1px solid rgba(199, 125, 46, 0.12);
            border-radius: 12px;
            overflow: hidden;
            background: rgba(31, 38, 65, 0.5);
            backdrop-filter: blur(4px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .chapter.hidden {
            display: none;
        }

        .chapter-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 24px;
            cursor: pointer;
            user-select: none;
            background: rgba(199, 125, 46, 0.06);
            border-bottom: 1px solid rgba(199, 125, 46, 0.1);
            transition: background 0.3s ease;
        }

        .chapter-header:hover {
            background: rgba(199, 125, 46, 0.1);
        }

        .chapter-title {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--gold);
        }

        .chapter-title::first-letter {
            font-size: 2.2rem;
            color: var(--accent);
            font-weight: 700;
            float: left;
            line-height: 1;
            margin-right: 4px;
            margin-top: 2px;
        }

        .chapter-count {
            font-size: 0.75rem;
            color: var(--parchment-dim);
            background: rgba(199, 125, 46, 0.12);
            padding: 3px 10px;
            border-radius: 12px;
            letter-spacing: 0.05em;
        }

        .chapter-toggle {
            font-size: 1rem;
            color: var(--parchment-dim);
            transition: transform 0.3s ease;
            margin-left: 12px;
        }

        .chapter.collapsed .chapter-toggle {
            transform: rotate(-90deg);
        }

        .chapter.collapsed .chapter-body {
            display: none;
        }

        .chapter-body {
            padding: 12px 16px;
        }

        /* === MANUSCRIPT BORDER DECORATION === */
        .chapter::after {
            content: '';
            display: block;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(199, 125, 46, 0.2), transparent);
        }

        /* === KENNING CARDS === */
        .kenning-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding: 8px 0;
        }

        .kenning-card {
            padding: 16px 20px;
            background: rgba(13, 13, 26, 0.3);
            border: 1px solid rgba(199, 125, 46, 0.08);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .kenning-card:hover {
            border-color: rgba(199, 125, 46, 0.25);
            background: rgba(199, 125, 46, 0.05);
        }

        .kenning-card.hidden {
            display: none;
        }

        .kenning-text {
            font-family: var(--font-display);
            font-style: italic;
            color: var(--gold);
            font-size: 1.15rem;
            letter-spacing: 0.02em;
            margin-bottom: 4px;
        }

        .kenning-english {
            font-family: var(--font-display);
            font-size: 0.95rem;
            color: var(--parchment);
            margin-bottom: 6px;
        }

        .kenning-meaning {
            font-family: var(--font-body);
            font-size: 0.78rem;
            color: var(--parchment-dim);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .kenning-logic {
            font-size: 0.8rem;
            color: var(--parchment-dim);
            margin-top: 6px;
            line-height: 1.5;
            font-style: italic;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .kenning-card:hover .kenning-logic {
            opacity: 1;
            max-height: 80px;
            margin-top: 8px;
        }

        .kenning-myth {
            display: inline-block;
            margin-top: 5px;
            font-size: 0.7rem;
            color: var(--accent);
            letter-spacing: 0.04em;
        }

        /* === GOD-KENNING TABLES === */
        .god-section {
            margin-bottom: 35px;
        }

        .god-section-header {
            padding: 18px 24px;
            cursor: pointer;
            user-select: none;
            background: rgba(199, 125, 46, 0.06);
            border: 1px solid rgba(199, 125, 46, 0.12);
            border-radius: 12px 12px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.3s ease;
        }

        .god-section-header:hover {
            background: rgba(199, 125, 46, 0.1);
        }

        .god-section.collapsed .god-section-header {
            border-radius: 12px;
        }

        .god-section.collapsed .god-body {
            display: none;
        }

        .god-section-title {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--gold);
        }

        .god-section-title::first-letter {
            font-size: 2.2rem;
            color: var(--accent);
            font-weight: 700;
            float: left;
            line-height: 1;
            margin-right: 4px;
            margin-top: 2px;
        }

        .god-body {
            border: 1px solid rgba(199, 125, 46, 0.12);
            border-top: none;
            border-radius: 0 0 12px 12px;
            background: rgba(31, 38, 65, 0.5);
            overflow: hidden;
        }

        .god-table {
            width: 100%;
            border-collapse: collapse;
        }

        .god-table th {
            text-align: left;
            padding: 10px 16px;
            font-family: var(--font-body);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--parchment-dim);
            background: rgba(199, 125, 46, 0.06);
            border-bottom: 1px solid rgba(199, 125, 46, 0.1);
        }

        .god-table td {
            padding: 10px 16px;
            border-bottom: 1px solid rgba(199, 125, 46, 0.06);
            font-size: 0.9rem;
        }

        .god-table tr:last-child td {
            border-bottom: none;
        }

        .god-table tr:hover td {
            background: rgba(199, 125, 46, 0.04);
        }

        .god-table .td-kenning {
            font-family: var(--font-display);
            font-style: italic;
            color: var(--gold);
            font-size: 1rem;
        }

        .god-table .td-english {
            color: var(--parchment);
        }

        .god-table .td-logic {
            color: var(--parchment-dim);
            font-size: 0.82rem;
            font-style: italic;
        }

        /* === SECTION DIVIDER === */
        .section-divider {
            text-align: center;
            margin: 50px 0 40px;
            position: relative;
        }

        .section-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(199, 125, 46, 0.3), transparent);
        }

        .section-divider h2 {
            font-family: var(--font-display);
            font-size: 1.6rem;
            font-weight: 600;
            color: var(--gold);
            display: inline-block;
            padding: 0 24px;
            background: var(--bg-deep);
            position: relative;
        }

        .section-divider .divider-sub {
            display: block;
            font-size: 0.85rem;
            font-weight: 400;
            font-style: italic;
            color: var(--parchment-dim);
            margin-top: 4px;
        }

        /* === SECTION BANNER IMAGES === */
        .chapter-banner {
            display: flex;
            gap: 12px;
            padding: 16px 16px 8px;
            overflow-x: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--gold-dim) transparent;
        }

        .chapter-banner::-webkit-scrollbar { height: 4px; }
        .chapter-banner::-webkit-scrollbar-thumb { background: var(--gold-dim); border-radius: 2px; }

        .chapter-banner-img {
            flex: 0 0 auto;
            width: 220px;
            height: 160px;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            border: 1px solid rgba(199, 125, 46, 0.2);
            transition: border-color 0.3s ease, transform 0.3s ease;
        }

        .chapter-banner-img:hover {
            border-color: var(--gold);
            transform: translateY(-2px);
        }

        .chapter-banner-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            filter: sepia(0.15) saturate(0.9);
            transition: filter 0.3s ease;
        }

        .chapter-banner-img:hover img {
            filter: sepia(0) saturate(1);
        }

        .chapter-banner-img .img-caption {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px 10px 6px;
            background: linear-gradient(transparent, rgba(13, 13, 26, 0.85));
            font-family: var(--font-display);
            font-size: 0.75rem;
            font-style: italic;
            color: var(--parchment);
            line-height: 1.3;
        }

        /* Single banner: center it */
        .chapter-banner.single {
            justify-content: center;
        }

        .chapter-banner.single .chapter-banner-img {
            width: 280px;
            height: 200px;
        }

        /* === LIGHTBOX MODAL === */
        .lightbox-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.92);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            cursor: zoom-out;
        }

        .lightbox-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .lightbox-content {
            max-width: 90vw;
            max-height: 85vh;
            position: relative;
        }

        .lightbox-content img {
            max-width: 90vw;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 8px;
            border: 1px solid rgba(230, 192, 105, 0.2);
            display: block;
        }

        .lightbox-caption {
            text-align: center;
            margin-top: 12px;
            font-family: var(--font-display);
            font-size: 1rem;
            font-style: italic;
            color: var(--parchment);
        }

        .lightbox-credit {
            text-align: center;
            margin-top: 4px;
            font-size: 0.75rem;
            color: var(--parchment-dim);
            letter-spacing: 0.05em;
        }

        .lightbox-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: none;
            border: none;
            color: var(--parchment);
            font-size: 1.8rem;
            cursor: pointer;
            padding: 4px 8px;
            transition: color 0.3s ease;
        }

        .lightbox-close:hover {
            color: var(--gold);
        }

        @media (max-width: 767px) {
            .chapter-banner-img {
                width: 180px;
                height: 130px;
            }
            .chapter-banner.single .chapter-banner-img {
                width: 220px;
                height: 160px;
            }
        }

        /* === NO RESULTS === */
        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: var(--parchment-dim);
            font-style: italic;
            display: none;
        }

        .no-results.visible {
            display: block;
        }

        /* === FOCUS VISIBLE === */
        :focus-visible {
            outline: 2px solid var(--gold);
            outline-offset: 2px;
        }

        /* === TABLET === */
        @media (max-width: 1023px) {
            :root {
                --nav-width: 60px;
            }
            .exhibition-nav .nav-label { display: none; }
            .exhibition-nav .nav-title { font-size: 0; padding: 15px 0; }
            .exhibition-nav .nav-title::after {
                content: 'KE';
                font-size: 0.9rem;
                display: block;
            }
            .exhibition-nav .nav-link { justify-content: center; padding: 14px 0; }
            .exhibition-nav .nav-icon { font-size: 1.4rem; }
            .exhibition-nav .nav-footer .nav-label { display: none; }
            .exhibition-nav .nav-back { justify-content: center; padding: 14px 0; }
            .room-content { padding: 40px 24px 80px; }
            .kenning-row { grid-template-columns: 1fr; }
        }

        /* === MOBILE === */
        @media (max-width: 767px) {
            :root {
                --nav-width: 0px;
            }
            .exhibition-nav {
                transform: translateX(-100%);
                width: 280px;
            }
            .exhibition-nav.open {
                transform: translateX(0);
            }
            .exhibition-nav .nav-label { display: inline; }
            .exhibition-nav .nav-title { font-size: 1.1rem; padding: 0 20px 25px; }
            .exhibition-nav .nav-title::after { display: none; }
            .exhibition-nav .nav-link { justify-content: flex-start; padding: 12px 20px; }
            .exhibition-nav .nav-back { justify-content: flex-start; padding: 12px 20px; }
            .exhibition-nav .nav-footer .nav-label { display: inline; }
            .mobile-header { display: flex; }
            .exhibition-main { margin-left: 0; padding-top: 56px; }
            .room-content { padding: 30px 16px 80px; }
            .room-header h1 { font-size: 1.8rem; }
            .diagram-row { gap: 8px; }
            .diagram-box { padding: 8px 14px; }
            .diagram-box .box-value { font-size: 1rem; }
            .kenning-row { grid-template-columns: 1fr; }
            .chapter-title { font-size: 1.2rem; }
            .chapter-title::first-letter { font-size: 1.7rem; }
            .god-section-title { font-size: 1.2rem; }
            .god-section-title::first-letter { font-size: 1.7rem; }
            .god-table th, .god-table td { padding: 8px 10px; font-size: 0.82rem; }
            .god-table .td-logic { display: none; }
        }
    </style>
</head>
<body>

<!-- Navigation -->
<nav class="exhibition-nav" id="exhibition-nav" role="navigation" aria-label="Exhibition rooms">
    <div class="nav-title">The Kenning Exhibition</div>
    <div class="nav-rooms">
        <a href="index.html" class="nav-link" data-room="hall">
            <span class="nav-icon">&#x2302;</span>
            <span class="nav-label">Exhibition Hall</span>
        </a>
        <a href="beowulf.html" class="nav-link" data-room="beowulf">
            <span class="nav-icon">&#x2694;</span>
            <span class="nav-label">Beowulf Room</span>
        </a>
        <a href="prose-edda.html" class="nav-link" data-room="edda">
            <span class="nav-icon">&#x2744;</span>
            <span class="nav-label">Prose Edda</span>
        </a>
        <a href="skaldskaparmal.html" class="nav-link active" data-room="skald">
            <span class="nav-icon">&#x270D;</span>
            <span class="nav-label">Sk&#225;ldskaparm&#225;l</span>
        </a>
        <a href="kenning-forge.html" class="nav-link" data-room="forge">
            <span class="nav-icon">&#x2692;</span>
            <span class="nav-label">Kenning Forge</span>
        </a>
        <a href="living-edda.html" class="nav-link" data-room="living">
            <span class="nav-icon">&#x2618;</span>
            <span class="nav-label">Living Edda</span>
        </a>
        <a href="runic-gallery.html" class="nav-link" data-room="runic">
            <span class="nav-icon">&#x25CA;</span>
            <span class="nav-label">Runic Gallery</span>
        </a>
    </div>
    <div class="nav-footer">
        <a href="../index.html" class="nav-back">
            <span class="nav-icon">&#x2190;</span>
            <span class="nav-label">Back to CCAB</span>
        </a>
    </div>
</nav>

<!-- Mobile header -->
<header class="mobile-header" id="mobile-header">
    <button class="hamburger" id="hamburger" aria-label="Open navigation">&#x2630;</button>
    <span class="mobile-title">Sk&#225;ldskaparm&#225;l</span>
</header>

<!-- Mobile overlay -->
<div class="nav-overlay" id="nav-overlay"></div>

<!-- Room transition -->
<div class="room-transition" id="room-transition"></div>

<!-- p5.js backdrop -->
<div id="p5-backdrop" aria-hidden="true"></div>

<!-- Audio toggle -->
<button class="audio-toggle muted" id="audio-toggle" aria-label="Toggle ambient sound" title="Toggle ambient sound">
    &#x266B;
</button>

<!-- Main content -->
<main class="exhibition-main">
    <div class="room-content">

        <!-- Room Header -->
        <header class="room-header">
            <h1>The Sk&#225;ldskaparm&#225;l Room</h1>
            <p class="room-subtitle">"How shall one periphrase?" -- Snorri Sturluson's systematic catalog of the language of poetry itself</p>
            <span class="room-source">Prose Edda, c. 1220 CE</span>
        </header>

        <!-- Kenning Structure Diagram -->
        <section class="structure-diagram" aria-label="Kenning structure explanation">
            <h2>How a Kenning Works</h2>
            <div class="diagram-row">
                <div class="diagram-box base">
                    <div class="box-label">Base-word</div>
                    <div class="box-value">"road"</div>
                    <div class="box-gloss">resembles the referent</div>
                </div>
                <span class="diagram-plus">+</span>
                <div class="diagram-box det">
                    <div class="box-label">Determinant</div>
                    <div class="box-value">"whale"</div>
                    <div class="box-gloss">specifies which kind</div>
                </div>
                <span class="diagram-equals">=</span>
                <div class="diagram-box result">
                    <div class="box-label">Kenning</div>
                    <div class="box-value">"whale-road"</div>
                    <div class="box-gloss">= the sea</div>
                </div>
            </div>
            <p class="diagram-caption">The Sk&#225;ldskaparm&#225;l asks "How shall one periphrase X?" for each subject, then catalogs the traditional kennings used by skalds.</p>
        </section>

        <!-- Search and Filters -->
        <section class="controls-panel" aria-label="Search and filter kennings">
            <div class="search-bar">
                <input type="text" id="search-input" placeholder="Search kennings, meanings, or mythology..." aria-label="Search kennings">
                <div class="search-count" id="search-count"></div>
            </div>
            <div class="tag-filters" id="tag-filters" role="group" aria-label="Filter by subject">
                <!-- Populated by JS -->
            </div>
        </section>

        <!-- No results message -->
        <div class="no-results" id="no-results">No kennings match your search. Try a different term or clear your filters.</div>

        <!-- Kenning Categories (Chapters) -->
        <div id="chapters-container">
            <!-- Populated by JS -->
        </div>

        <!-- God-Kenning Tables -->
        <div class="section-divider" id="god-divider">
            <h2>Kennings for the Gods<span class="divider-sub">Names and epithets of the major Aesir</span></h2>
        </div>

        <div id="gods-container">
            <!-- Populated by JS -->
        </div>

    </div>
</main>

<!-- Lightbox Modal -->
<div class="lightbox-overlay" id="lightbox-overlay">
    <div class="lightbox-content">
        <button class="lightbox-close" aria-label="Close lightbox">&times;</button>
        <img id="lightbox-img" src="" alt="">
        <div class="lightbox-caption" id="lightbox-caption"></div>
        <div class="lightbox-credit">Illuminations by Storyleaf AI</div>
    </div>
</div>

<script src="../assets/js/enhance.js" defer></script>
<script>
// ==========================================
// KENNING DATA -- Skaldskaparmal
// ==========================================
const CATEGORIES = [
    {
        id: 'gold', name: 'Gold', subtitle: 'Gull',
        kennings: [
            { on: 'h\u00e1r Sifjar', en: 'hair of Sif', meaning: 'gold', myth: 'Loki cut Sif\'s hair; dwarves replaced it with gold', logic: 'Gold as divine replacement hair' },
            { on: 't\u00e1r Freyju', en: 'tears of Freyja', meaning: 'gold', myth: 'Freyja weeps tears of gold for her husband', logic: 'Gold as divine grief' },
            { on: 'augu Freyju', en: 'eyes of Freyja', meaning: 'gold (drops)', myth: 'Freyja\'s tear-drops', logic: 'Gold as drops from divine eyes' },
            { on: 'eldr \u00c6gis', en: 'fire of Aegir', meaning: 'gold', myth: 'Gold lit Aegir\'s hall instead of firelight', logic: 'Gold as undersea illumination' },
            { on: 'eldr allra vatna', en: 'fire of all waters', meaning: 'gold', myth: 'Extension of Aegir\'s fire', logic: 'Gold glittering beneath any water' },
            { on: 'eldr handar', en: 'fire of the hand', meaning: 'gold (arm-rings)', logic: 'Gold worn on the arm gleams like fire' },
            { on: 'barr Glasis', en: 'needles of Glasir', meaning: 'gold', myth: 'Glasir\'s grove before Valhalla has golden leaves', logic: 'Gold as foliage of the sacred grove' },
            { on: 'Fr\u00f3\u00f0a meldr', en: 'Frodi\'s flour', meaning: 'gold', myth: 'Giantesses Fenja and Menja ground gold for King Frodi', logic: 'Gold as the product of the cosmic mill' },
            { on: 'fr\u00e6 Fyrisvalla', en: 'seed of Fyris-Plains', meaning: 'gold', myth: 'King Hrolf scattered gold on the plains', logic: 'Gold as seed sown on the battlefield' },
            { on: 'munntal j\u00f6tna', en: 'mouth-tale of giants', meaning: 'gold', myth: 'Thjazi\'s gold divided by mouth-fulls', logic: 'Gold measured by the giants\' speech' },
            { on: 'dropi Draupnis', en: 'drop of Draupnir', meaning: 'gold', myth: 'Draupnir drips eight new rings every ninth night', logic: 'Gold as divine self-replication' },
            { on: 'regn Draupnis', en: 'rain of Draupnir', meaning: 'gold', myth: 'Same myth', logic: 'Gold as rainfall from the cosmic ring' },
            { on: 'b\u00f6lr F\u00e1fnis', en: 'lair of Fafnir', meaning: 'gold', myth: 'Fafnir lay upon his hoard', logic: 'Gold as a dragon\'s resting place' },
            { on: 'm\u00e1l Gnitahei\u00f0ar', en: 'metal of Gnita Heath', meaning: 'gold', myth: 'Fafnir\'s hoard on Gnita Heath', logic: 'Gold tied to a specific legendary landscape' },
            { on: 'byr\u00f0r Grana', en: 'burden of Grani', meaning: 'gold', myth: 'Sigurd\'s horse Grani carried Fafnir\'s gold', logic: 'Gold as the hero\'s horse-load' },
            { on: 'arfr Niflunganna', en: 'heritage of the Niflungs', meaning: 'gold', myth: 'The cursed Nibelung treasure', logic: 'Gold as inherited doom' },
            { on: 'otrgj\u00f6ld', en: 'otter\'s ransom', meaning: 'gold', myth: 'The gods paid Fafnir\'s gold for killing Otter', logic: 'Gold as payment for blood-guilt' },
            { on: 'nau\u00f0hgjald \u00c1sanna', en: 'forced payment of the Aesir', meaning: 'gold', myth: 'Same myth', logic: 'Gold extorted by necessity' },
            { on: 'snyrtir Sifjar', en: 'snood of Fulla', meaning: 'gold (headband)', myth: 'Fulla wore a golden band', logic: 'Gold as divine headwear' },
            { on: 'str\u00e6ti randa', en: 'reef of the hand', meaning: 'gold (ring)', logic: 'Gold rings worn on fingers' }
        ]
    },
    {
        id: 'poetry', name: 'Poetry & Mead', subtitle: 'Sk\u00e1ldskap',
        kennings: [
            { on: 'dreyri Kvasis', en: 'blood of Kvasir', meaning: 'poetry/mead', myth: 'Kvasir was slain; his blood became mead of poetry', logic: 'Poetry as the lifeblood of wisdom' },
            { on: 'drekka dverganna', en: 'dwarves\' drink', meaning: 'poetry/mead', myth: 'Dwarves Fjalar and Galar brewed the mead', logic: 'Poetry as intoxicating craft' },
            { on: 'skip dverganna', en: 'ship of the dwarves', meaning: 'poetry', myth: 'The vessels (Odrerir, Bodn, Son) held the mead', logic: 'Poetry carried in sacred vessels' },
            { on: 'sj\u00e1r dverganna', en: 'sea of the dwarves', meaning: 'poetry', myth: 'The liquid filling the dwarves\' vats', logic: 'Poetry as a sea of meaning' },
            { on: 'Suttungamj\u00f6\u00f0', en: 'Suttungr\'s mead', meaning: 'poetry', myth: 'The giant Suttungr stored the mead', logic: 'Poetry hoarded by ignorant power' },
            { on: 'feng ok fundr \u00d3\u00f0ins', en: 'booty and find of Odin', meaning: 'poetry', myth: 'Odin stole the mead from Suttungr', logic: 'Poetry as Odin\'s hard-won prize' },
            { on: 'gj\u00f6f \u00c1sanna', en: 'gift of the Aesir', meaning: 'poetry', myth: 'The gods bestowed the mead', logic: 'Poetry as divine bestowal' },
            { on: 'l\u00f6gr \u00d3\u00f0hreris', en: 'liquid of Odrerir', meaning: 'poetry', myth: 'Odrerir = "frenzy-stirrer," one of the mead-vessels', logic: 'Poetry stirring ecstatic frenzy' },
            { on: 'aldaf\u00f6\u00f0r ketill\u00f6gr', en: 'Allfather\'s kettle-liquor', meaning: 'poetry', myth: 'Odin brewed/stole the mead', logic: 'Poetry simmered in the divine cauldron' },
            { on: 'sonar-brim', en: 'song-surf', meaning: 'poetry', logic: 'Poetry as waves of song crashing' }
        ]
    },
    {
        id: 'sea', name: 'The Sea', subtitle: 'Sj\u00e1r',
        kennings: [
            { on: 'bl\u00f3\u00f0 Ymis', en: 'blood of Ymir', meaning: 'the sea', myth: 'The sea was made from the primordial giant\'s blood', logic: 'The ocean as lifeblood of creation' },
            { on: 'heimsoekir go\u00f0anna', en: 'visitor of the gods', meaning: 'the sea (Aegir)', myth: 'Aegir visited the gods\' feast', logic: 'The sea personified as divine guest' },
            { on: 'ver Ranar', en: 'husband of Ran', meaning: 'the sea (Aegir)', myth: 'Aegir and Ran are married sea-deities', logic: 'The sea gendered as Ran\'s spouse' },
            { on: 'fa\u00f0ir \u00c6gisd\u00f6tra', en: 'father of Aegir\'s daughters', meaning: 'the sea', myth: 'Aegir fathered the nine wave-maidens', logic: 'The sea as father of its own waves' },
            { on: 'land Ranar', en: 'land of Ran', meaning: 'the sea', logic: 'The sea as Ran\'s territorial kingdom' },
            { on: 'land skipa', en: 'land of ships', meaning: 'the sea', logic: 'The sea as the territory ships inhabit' },
            { on: 'land fiska', en: 'land of fishes', meaning: 'the sea', logic: 'The sea as home to its creatures' },
            { on: 'land \u00edsa', en: 'land of ice', meaning: 'the sea (northern)', logic: 'The frozen sea as a land of ice' },
            { on: 'vegr s\u00e6konunga', en: 'way of sea-kings', meaning: 'the sea', logic: 'The sea as the highway of raiders' },
            { on: 'umgj\u00f6r\u00f0 eyjanna', en: 'encircler of islands', meaning: 'the sea', logic: 'The sea as the belt binding islands' },
            { on: 'h\u00fas sanda', en: 'house of sands', meaning: 'the sea', logic: 'The sea as a hall with sandy floor' },
            { on: 'h\u00fas tangs', en: 'house of kelp', meaning: 'the sea', logic: 'The sea as a building filled with seaweed' },
            { on: 'kvern Aml\u00f3\u00f0a', en: 'Amlodi\'s churn', meaning: 'the sea', myth: 'The maelstrom / whirlpool', logic: 'The sea as a churning mill' }
        ]
    },
    {
        id: 'battle', name: 'Battle', subtitle: 'Orusta',
        kennings: [
            { on: 'stormr sver\u00f0a', en: 'storm of swords', meaning: 'battle', logic: 'Battle as a tempest of blades' },
            { on: 'gny malmanna', en: 'clash of metal-men', meaning: 'battle', logic: 'Battle as the noise of armed warriors' },
            { on: 've\u00f0r \u00d3\u00f0ins', en: 'weather of Odin', meaning: 'battle', myth: 'Odin is god of war', logic: 'Battle as the storm Odin sends' },
            { on: 'gj\u00f6\u00f0 valkyrjanna', en: 'squall of the Valkyries', meaning: 'battle', myth: 'Valkyries choose the slain', logic: 'Battle as a supernatural gust' },
            { on: 'regn Hlakkar', en: 'rain of Hlokk (a Valkyrie)', meaning: 'battle', logic: 'Battle as rain controlled by war-spirits' },
            { on: 'leikr hjorva', en: 'play of swords', meaning: 'battle', logic: 'Battle as a deadly game' },
            { on: 'sendingr \u00d3\u00f0ins', en: 'sending of Odin', meaning: 'battle', myth: 'Odin dispatches war', logic: 'Battle as Odin\'s message' },
            { on: 'samkoma v\u00e1pna', en: 'meeting of weapons', meaning: 'battle', logic: 'Battle as a gathering place for arms' }
        ]
    },
    {
        id: 'swords', name: 'Swords & Weapons', subtitle: 'Sver\u00f0',
        kennings: [
            { on: '\u00edss rau\u00f0ra randa', en: 'icicle of red shields', meaning: 'sword', logic: 'A sword as a cold shard among bloodied shields' },
            { on: 'logi hjalmanna', en: 'flame of helmets', meaning: 'sword', logic: 'The blade that flashes fire across helms' },
            { on: 'eldr hjalma', en: 'fire of helmets', meaning: 'sword', logic: 'A sword as fire that consumes helms' },
            { on: 'skur benja', en: 'shower of wounds', meaning: 'arrows/weapons', logic: 'Weapons that rain down wounds' },
            { on: 'na\u00f0r randa', en: 'serpent of shields', meaning: 'sword', logic: 'A blade that winds/strikes through shields' },
            { on: 'linnr lo\u00f0ar', en: 'snake of the scabbard', meaning: 'sword', logic: 'A blade coiled in its sheath like a serpent' },
            { on: 'fiskr vallar', en: 'fish of the battlefield', meaning: 'sword', logic: 'A blade that swims through the field of combat' }
        ]
    },
    {
        id: 'blood', name: 'Blood', subtitle: 'Bl\u00f3\u00f0',
        kennings: [
            { on: 'sveiti sver\u00f0a', en: 'sweat of swords', meaning: 'blood', logic: 'Blood as the perspiration blades produce' },
            { on: 'sj\u00e1r benja', en: 'sea of wounds', meaning: 'blood', logic: 'Blood pooling like a sea from wounds' },
            { on: 'bylgja vallar', en: 'wave of the battlefield', meaning: 'blood', logic: 'Blood washing across the battlefield' },
            { on: 'dropi Gungnis', en: 'drop of Gungnir', meaning: 'blood', myth: 'Odin\'s spear draws blood', logic: 'Blood as offering to Odin\'s weapon' }
        ]
    },
    {
        id: 'ships', name: 'Ships', subtitle: 'Skip',
        kennings: [
            { on: 'hestr sjavar', en: 'horse of the sea', meaning: 'ship', logic: 'A ship galloping across the waves' },
            { on: 'Sleipnir s\u00e6var', en: 'Sleipnir of the sea', meaning: 'ship', myth: 'Sleipnir is the supreme horse', logic: 'The finest ship as Odin\'s horse of the ocean' },
            { on: 'skogsvin byljanna', en: 'forest-beast of the billows', meaning: 'ship', logic: 'A vessel made from forest timber riding waves' },
            { on: 'hj\u00f6rtr mastsins', en: 'deer of the mast', meaning: 'ship', logic: 'A ship with antler-like rigging' },
            { on: 'bj\u00f6rn sn\u00f6ru\u00f0s', en: 'bear of twisted cables', meaning: 'ship', logic: 'A powerful ship tethered by ropes' },
            { on: 'f\u00f6gr boga', en: 'bird of the bow (prow)', meaning: 'ship', logic: 'A ship with a bird-like prow' },
            { on: 'ski\u00f0 Atalls', en: 'ski of Atall (a sea-king)', meaning: 'ship', logic: 'A ship gliding like a ski across the sea' }
        ]
    },
    {
        id: 'warriors', name: 'Warriors & Men', subtitle: 'Menn',
        kennings: [
            { on: 'hrafngrennir', en: 'raven-feeder', meaning: 'warrior', logic: 'A warrior who feeds ravens with corpses' },
            { on: 'nj\u00f6r\u00f0r sver\u00f0a', en: 'Njord of swords', meaning: 'warrior', logic: 'A warrior as divine in swordsmanship' },
            { on: 'vi\u00f0r hjalmanna', en: 'tree of helmets', meaning: 'warrior', logic: 'A warrior standing tall under his helm' },
            { on: 'askr Yggs', en: 'ash-tree of Odin', meaning: 'warrior', myth: 'Odin + tree metaphor', logic: 'A warrior as Odin\'s tall, upright tree' },
            { on: 'rey\u00f0hr bor\u00f0veggja', en: 'reddener of ship-planks', meaning: 'warrior/viking', logic: 'One who reddens ship-sides with blood' },
            { on: 'grennir arnar', en: 'feeder of the eagle', meaning: 'warrior', logic: 'A warrior who provides for carrion birds' },
            { on: 'sker\u00f0ir bauganna', en: 'diminisher of rings', meaning: 'generous lord', logic: 'A lord who gives away his treasure-rings' }
        ]
    },
    {
        id: 'women', name: 'Women', subtitle: 'Konur',
        kennings: [
            { on: 'd\u00eds hringa', en: 'goddess of rings', meaning: 'woman (adorned)', logic: 'A woman glorified by her jewelry' },
            { on: 'grund faldanna', en: 'ground of headdresses', meaning: 'woman', logic: 'A woman as the terrain upon which ornaments rest' },
            { on: 'birki lina', en: 'birch of linen', meaning: 'woman', logic: 'A woman as a graceful tree clothed in linen' },
            { on: 'vi\u00f0r drykku', en: 'tree of drink', meaning: 'woman (hostess)', logic: 'A woman as the upright figure offering mead' },
            { on: 'Gefn gulls', en: 'Gefn (Freyja) of gold', meaning: 'woman', logic: 'A woman as a gold-goddess' },
            { on: 'Hl\u00edn lina', en: 'Hlin (Frigg) of linen', meaning: 'woman', logic: 'A woman as a goddess clothed in linen' },
            { on: 'S\u00edf silks', en: 'Sif of silk', meaning: 'woman', logic: 'A woman as a golden-haired goddess of silk' }
        ]
    },
    {
        id: 'earth', name: 'Earth', subtitle: 'J\u00f6r\u00f0',
        kennings: [
            { on: 'hold Ymis', en: 'flesh of Ymir', meaning: 'the earth', myth: 'Earth was made from the giant\'s flesh', logic: 'The land as cosmic bodily substance' },
            { on: 'm\u00f3\u00f0ir \u00de\u00f3rs', en: 'mother of Thor', meaning: 'the earth (Jord)', myth: 'The goddess Jord bore Thor', logic: 'The earth as divine mother' },
            { on: 'd\u00f3ttir \u00d3nars', en: 'daughter of Onarr', meaning: 'the earth', logic: 'Earth descended from primordial night' },
            { on: 'br\u00fa\u00f0r \u00d3\u00f0ins', en: 'bride of Odin', meaning: 'the earth', myth: 'Odin wed Jord', logic: 'The earth as divine consort' },
            { on: 'golf sto\u00f0anna', en: 'floor of the storm-hall', meaning: 'the earth', logic: 'Earth as the floor of the world-building' },
            { on: 'sj\u00e1r d\u00fdra', en: 'sea of beasts', meaning: 'the earth', logic: 'The earth as an ocean of creatures' }
        ]
    },
    {
        id: 'sky', name: 'Sky & Heaven', subtitle: 'Himinn',
        kennings: [
            { on: 'haus Ymis', en: 'skull of Ymir', meaning: 'the sky', myth: 'The sky was made from Ymir\'s skull', logic: 'The heavens as a cosmic cranium' },
            { on: 'byr\u00f0i dverganna', en: 'burden of the dwarves', meaning: 'the sky', myth: 'Four dwarves hold up the sky', logic: 'The sky carried on dwarven shoulders' },
            { on: 'hjalmr vindanna', en: 'helm of winds', meaning: 'the sky', logic: 'The sky as a dwelling for storms' },
            { on: 'land solar', en: 'land of the sun', meaning: 'the sky', logic: 'The sky as the sun\'s territory' },
            { on: 'land tungla', en: 'land of the stars', meaning: 'the sky', logic: 'The sky as homeland of celestial lights' }
        ]
    },
    {
        id: 'sun', name: 'The Sun', subtitle: 'S\u00f3l',
        kennings: [
            { on: 'd\u00f3ttir Mundilf\u00f6ra', en: 'daughter of Mundilfari', meaning: 'the sun', logic: 'Solar identity through parentage' },
            { on: 'systir M\u00e1na', en: 'sister of the Moon', meaning: 'the sun', logic: 'Celestial kinship' },
            { on: 'eldr himins', en: 'fire of heaven', meaning: 'the sun', logic: 'The sun as the sky\'s burning flame' },
            { on: 'eldr loptsins', en: 'fire of the air', meaning: 'the sun', logic: 'The sun as atmospheric fire' },
            { on: 'logi heims', en: 'flame of the world', meaning: 'the sun', logic: 'The sun as universal illumination' }
        ]
    },
    {
        id: 'wind', name: 'Wind', subtitle: 'Vindr',
        kennings: [
            { on: 'sonr Fornj\u00f3ts', en: 'son of Fornjot', meaning: 'wind', myth: 'Fornjot was father of wind, sea, fire', logic: 'Wind as offspring of the primordial giant' },
            { on: 'br\u00f3\u00f0hr sjavar', en: 'brother of the sea', meaning: 'wind', logic: 'Elemental kinship' },
            { on: 'br\u00f3\u00f0hr elds', en: 'brother of fire', meaning: 'wind', logic: 'Elemental kinship' },
            { on: 'bani vi\u00f0har', en: 'bane of the wood', meaning: 'wind', logic: 'Wind as the forest\'s destroyer' },
            { on: 'hundr vi\u00f0har', en: 'hound of the wood', meaning: 'wind', logic: 'Wind as a beast prowling the forest' },
            { on: '\u00falfr vi\u00f0har', en: 'wolf of the wood', meaning: 'wind', logic: 'Wind as a predator among trees' },
            { on: 'bani segls', en: 'bane of the sail', meaning: 'wind (storm)', logic: 'Wind as the sailor\'s enemy' }
        ]
    },
    {
        id: 'fire', name: 'Fire', subtitle: 'Eldr',
        kennings: [
            { on: 'br\u00f3\u00f0hr vinds', en: 'brother of wind', meaning: 'fire', logic: 'Elemental kinship' },
            { on: 'bani vi\u00f0har', en: 'ruin of wood', meaning: 'fire', logic: 'Fire as the destroyer of forests' },
            { on: 'bani h\u00fasa', en: 'ruin of houses', meaning: 'fire', logic: 'Fire as the enemy of shelter' },
            { on: 's\u00f3l h\u00fasanna', en: 'sun of houses', meaning: 'fire (hearth)', logic: 'Fire as domestic illumination' },
            { on: 'bani Halfs', en: 'bane of Half', meaning: 'fire', myth: 'King Half died in a fire', logic: 'Fire named for a specific victim' }
        ]
    }
];

const GOD_KENNINGS = [
    {
        id: 'odin', name: 'Odin', count: 19,
        kennings: [
            { on: 'Alf\u00f6\u00f0r', en: 'Allfather', logic: 'Father of gods and men' },
            { on: 'Hangagu\u00f0', en: 'Hanged God', logic: 'Self-sacrifice on Yggdrasil' },
            { on: 'Hrafn\u00e1ss', en: 'Raven-God', logic: 'Lord of Huginn and Muninn' },
            { on: 'Gauta-T\u00fdr', en: 'God of the Geats', logic: 'War-god of the Gothic peoples' },
            { on: 'H\u00e1r', en: 'the High One', logic: 'Supreme among gods' },
            { on: 'Eineygja', en: 'the One-Eyed', logic: 'Sacrificed an eye for wisdom' },
            { on: 'Friggjar fa\u00f0mbyggvi', en: 'dweller in Frigg\'s bosom', logic: 'Frigg\'s husband / lover' },
            { on: 'M\u00edms vinr', en: 'friend of Mimir', logic: 'Counseled by the wise head' },
            { on: '\u00falfs bagi', en: 'wolf\'s adversary', logic: 'Opponent of Fenrir' },
            { on: 'Valgautr', en: 'God of the Slain', logic: 'Chooser of fallen warriors' },
            { on: 'Hert\u00fdr', en: 'Host-God / Army-God', logic: 'Leader of warrior-hosts' },
            { on: 'Galga-farmr', en: 'gallows\' burden', logic: 'The one who hung from the gallows' },
            { on: 'Geir-T\u00fdr', en: 'Spear-God', logic: 'Lord of Gungnir' },
            { on: 'Farmat\u00fdr', en: 'Cargo-God', logic: 'God of trade and travel' },
            { on: 'Sigt\u00fdr', en: 'Victory-God', logic: 'Granter of triumph' },
            { on: 'Foldardrottin', en: 'Lord of the Earth', logic: 'Sovereign of the world' },
            { on: 'Gagnr\u00e1\u00f0r', en: 'Advantage-Counselor', logic: 'Wise and strategic counselor' },
            { on: 'Svipal', en: 'the Changeable', logic: 'Master of disguise' },
            { on: 'B\u00f6lverkr', en: 'Evil-Worker', logic: 'Worker of terrible deeds (for the mead)' }
        ]
    },
    {
        id: 'thor', name: 'Thor', count: 12,
        kennings: [
            { on: 'sonr \u00d3\u00f0ins ok Jar\u00f0ar', en: 'son of Odin and Jord', logic: 'Born of sky-god and earth' },
            { on: 'fa\u00f0ir Magna ok M\u00f3\u00f0a ok \u00der\u00fa\u00f0ar', en: 'father of Magni, Modi, and Thrud', logic: 'Father of Strength, Courage, and Power' },
            { on: 'ver Sifjar', en: 'husband of Sif', logic: 'Consort of the golden-haired goddess' },
            { on: 'stj\u00fapfa\u00f0ir Ulla', en: 'stepfather of Ullr', logic: 'Father to the hunting god' },
            { on: 'valdandi Mj\u00f6lnis', en: 'wielder of Mjolnir', logic: 'Master of the thunder-hammer' },
            { on: 'verjandi \u00c1sgar\u00f0s ok Mi\u00f0gar\u00f0s', en: 'defender of Asgard and Midgard', logic: 'Protector of gods and men' },
            { on: 'dolgr Mi\u00f0gar\u00f0sorms', en: 'foe of the Midgard Serpent', logic: 'Destined serpent-slayer' },
            { on: 'vegandi Hrungnis', en: 'slayer of Hrungnir', logic: 'Victor over the stone giant' },
            { on: 'krossj\u00e1ndi bergb\u00faa-\u00e6ttar', en: 'crusher of the giant-kin', logic: 'Destroyer of the mountain-race' },
            { on: 'rei\u00f0-T\u00fdr', en: 'chariot-god', logic: 'Driver of the thunder-chariot' },
            { on: 'Einri\u00f0i', en: 'lone-rider', logic: 'Thor who rides alone to battle' },
            { on: 'Ving\u00fe\u00f3r', en: 'battle-Thor', logic: 'Thor in his war-aspect' }
        ]
    },
    {
        id: 'loki', name: 'Loki', count: 12,
        kennings: [
            { on: 'sonr Farbautis', en: 'son of Farbauti', logic: 'Born of the "cruel striker"' },
            { on: 'sonr Laufeyjar', en: 'son of Laufey/Nal', logic: 'Born of the leaf-island goddess' },
            { on: 'br\u00f3\u00f0hr Byleists ok Helblinda', en: 'brother of Byleistr and Helblindi', logic: 'Sibling of storm-spirits' },
            { on: 'fa\u00f0ir Fenris\u00falfs', en: 'father of the Fenris-Wolf', logic: 'Parent of the world-devourer' },
            { on: 'fa\u00f0ir Mi\u00f0gar\u00f0sorms', en: 'father of the Midgard Serpent', logic: 'Parent of the sea-encircler' },
            { on: 'fa\u00f0ir Heljar', en: 'father of Hel', logic: 'Parent of the death-goddess' },
            { on: 'r\u00e1\u00f0bani Baldrs', en: 'contriver of Baldr\'s death', logic: 'Plotter of divine murder' },
            { on: '\u00fejoofr risanna', en: 'thief of the giants', logic: 'Cunning stealer from giantkind' },
            { on: '\u00fejoofr Brisingamens', en: 'thief of the Brisinga-men', logic: 'Stealer of Freyja\'s necklace' },
            { on: 'r\u00e6gjandi go\u00f0anna', en: 'slanderer of the gods', logic: 'Accuser at the gods\' feast' },
            { on: 'barattu-dolgr Heimdalls', en: 'battle-foe of Heimdall', logic: 'Eternal enemy of the watchman' },
            { on: 'bundinn \u00e1ss', en: 'the bound god', logic: 'Chained until Ragnarok' }
        ]
    },
    {
        id: 'heimdall', name: 'Heimdallr', count: 7,
        kennings: [
            { on: 'sonr n\u00edju moe\u00f0ranna', en: 'son of nine mothers', logic: 'Born of nine wave-maidens' },
            { on: 'v\u00f6r\u00f0r go\u00f0anna', en: 'watchman of the gods', logic: 'Guardian of Bifrost' },
            { on: 'hv\u00edti \u00e1ss', en: 'the white god', logic: 'Shining, radiant deity' },
            { on: 'dolgr Loka', en: 'foe of Loki', logic: 'Enemy of the trickster' },
            { on: 'leitandi Brisingamens', en: 'seeker of the Brisinga-men', logic: 'Retrieved Freyja\'s necklace' },
            { on: 'eigandi Gulltopp', en: 'possessor of Gulltoppr', logic: 'Rider of the golden-maned horse' },
            { on: 'Vindler', en: '(an ancient name)', logic: 'Etymology uncertain' }
        ]
    },
    {
        id: 'others', name: 'Other Gods', count: 14,
        kennings: [
            { on: 'sonr Njar\u00f0har', en: 'son of Njord', logic: 'Freyr: Born of the sea-god' },
            { on: 'br\u00f3\u00f0hr Freyju', en: 'brother of Freyja', logic: 'Freyr: Twin of the love-goddess' },
            { on: 'bagi Belja', en: 'adversary of Beli', logic: 'Freyr: Slayer of the giant Beli' },
            { on: 'eigandi Ski\u00f0bladnis', en: 'possessor of Skidbladnir', logic: 'Freyr: Owner of the magical ship' },
            { on: 'Vanad\u00eds', en: 'goddess of the Vanir', logic: 'Freyja: Lady of the Vanir gods' },
            { on: 'Mard\u00f6ll', en: 'sea-bright', logic: 'Freyja: She who shines upon the sea' },
            { on: 'einhendr \u00e1ss', en: 'one-handed god', logic: 'Tyr: Lost his hand to Fenrir' },
            { on: 'v\u00edgt\u00fdr', en: 'battle-god', logic: 'Tyr: God of courage in war' },
            { on: 'ver Nonnu', en: 'husband of Nanna', logic: 'Baldr: Spouse of the grief-goddess' },
            { on: 'felagi Heljar', en: 'companion of Hel', logic: 'Baldr: Dweller in the death-realm' },
            { on: 'ver Idunnar', en: 'husband of Idunn', logic: 'Bragi: Spouse of the apple-keeper' },
            { on: 'au\u00f0go\u00f0r Vana', en: 'wealth-god of the Vanir', logic: 'Njord: Bestower of riches from the sea' },
            { on: 'hinn \u00fe\u00f6gli \u00e1ss', en: 'the silent god', logic: 'Vidar: The god who speaks not' },
            { on: 'bani Fenris\u00falfs', en: 'slayer of the Fenris-Wolf', logic: 'Vidar: Avenger who tears the wolf\'s jaw' }
        ]
    }
];

// ==========================================
// SECTION BANNER IMAGES
// ==========================================
const IMG_BASE = 'https://kenning.storyleaf.ai/img/';
const SECTION_IMAGES = {
    gold: [
        { file: 'kenning-0008.png', caption: 'Gold is Freyja\'s Tears' },
        { file: 'kenning-0009.png', caption: 'The Fire of Aegir\'s Hall' },
        { file: 'kenning-0010.png', caption: 'Frodi\'s Flour from the Cosmic Mill' }
    ],
    sea: [
        { file: 'kenning-0028.png', caption: 'The Blood of Ymir' },
        { file: 'kenning-0138.png', caption: 'The Land of Ships' },
        { file: 'kenning-0201.png', caption: 'Ran\'s Kingdom Beneath the Waves' },
        { file: 'kenning-0311.png', caption: 'Amlodi\'s Churn -- the Maelstrom' }
    ],
    battle: [
        { file: 'kenning-0069.png', caption: 'The Storm of Swords' },
        { file: 'kenning-0244.png', caption: 'The Weather of Odin' }
    ],
    swords: [
        { file: 'kenning-0069.png', caption: 'The Icicle of Red Shields' },
        { file: 'kenning-0244.png', caption: 'The Serpent of Shields' }
    ],
    fire: [
        { file: 'kenning-0161.png', caption: 'Smoke is Fire-Ghost' }
    ],
    wind: [
        { file: 'kenning-0148.png', caption: 'The Wind is Dune-Sculptor' },
        { file: 'kenning-0149.png', caption: 'The Wolf of the Wood' },
        { file: 'kenning-0150.png', caption: 'The Bane of the Sail' }
    ],
    sun: [
        { file: 'kenning-0163.png', caption: 'Daughter of Mundilfari' },
        { file: 'kenning-0203.png', caption: 'The Fire of Heaven' },
        { file: 'kenning-0314.png', caption: 'The Flame of the World' }
    ],
    earth: [
        { file: 'kenning-0131.png', caption: 'The Flesh of Ymir' },
        { file: 'kenning-0132.png', caption: 'The Mother of Thor' },
        { file: 'kenning-0133.png', caption: 'The Bride of Odin' }
    ],
    poetry: [
        { file: 'kenning-0199.png', caption: 'The Moon is Poet-Muse' }
    ],
    sky: [
        { file: 'kenning-0197.png', caption: 'The Skull of Ymir' },
        { file: 'kenning-0198.png', caption: 'The Burden of the Dwarves' },
        { file: 'kenning-0305.png', caption: 'The Land of Stars' }
    ]
};

// ==========================================
// BUILD UI
// ==========================================
(function() {
    const chaptersContainer = document.getElementById('chapters-container');
    const godsContainer = document.getElementById('gods-container');
    const tagFiltersEl = document.getElementById('tag-filters');
    const searchInput = document.getElementById('search-input');
    const searchCountEl = document.getElementById('search-count');
    const noResultsEl = document.getElementById('no-results');
    const godDivider = document.getElementById('god-divider');

    let activeTag = null;
    let searchTerm = '';

    // Count totals
    const totalKennings = CATEGORIES.reduce((s, c) => s + c.kennings.length, 0) +
                          GOD_KENNINGS.reduce((s, g) => s + g.kennings.length, 0);

    // Build tag filter buttons
    const allBtn = document.createElement('button');
    allBtn.className = 'tag-btn active';
    allBtn.textContent = 'All';
    allBtn.dataset.tag = '';
    const allCount = document.createElement('span');
    allCount.className = 'tag-count';
    allCount.textContent = totalKennings;
    allBtn.appendChild(allCount);
    tagFiltersEl.appendChild(allBtn);

    CATEGORIES.forEach(cat => {
        const btn = document.createElement('button');
        btn.className = 'tag-btn';
        btn.dataset.tag = cat.id;
        btn.textContent = cat.name + ' ';
        const cnt = document.createElement('span');
        cnt.className = 'tag-count';
        cnt.textContent = cat.kennings.length;
        btn.appendChild(cnt);
        tagFiltersEl.appendChild(btn);
    });

    // Add a "Gods" tag
    const godsBtn = document.createElement('button');
    godsBtn.className = 'tag-btn';
    godsBtn.dataset.tag = 'gods';
    godsBtn.textContent = 'Gods ';
    const godsCount = document.createElement('span');
    godsCount.className = 'tag-count';
    godsCount.textContent = GOD_KENNINGS.reduce((s, g) => s + g.kennings.length, 0);
    godsBtn.appendChild(godsCount);
    tagFiltersEl.appendChild(godsBtn);

    // Build chapter sections
    CATEGORIES.forEach(cat => {
        const chapter = document.createElement('section');
        chapter.className = 'chapter';
        chapter.dataset.category = cat.id;
        chapter.setAttribute('aria-label', 'Kennings for ' + cat.name);

        const header = document.createElement('div');
        header.className = 'chapter-header';
        header.setAttribute('role', 'button');
        header.setAttribute('tabindex', '0');
        header.setAttribute('aria-expanded', 'true');
        header.innerHTML = `
            <div style="display:flex;align-items:center;gap:12px;">
                <span class="chapter-title">${cat.name}</span>
                <span class="chapter-count">${cat.subtitle} &middot; ${cat.kennings.length} kennings</span>
            </div>
            <span class="chapter-toggle">&#x25BC;</span>
        `;

        header.addEventListener('click', () => {
            chapter.classList.toggle('collapsed');
            header.setAttribute('aria-expanded', !chapter.classList.contains('collapsed'));
        });
        header.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); header.click(); }
        });

        const body = document.createElement('div');
        body.className = 'chapter-body';

        // Insert banner images if available for this category
        const sectionImgs = SECTION_IMAGES[cat.id];
        if (sectionImgs && sectionImgs.length > 0) {
            const banner = document.createElement('div');
            banner.className = 'chapter-banner' + (sectionImgs.length === 1 ? ' single' : '');
            sectionImgs.forEach(img => {
                const wrap = document.createElement('div');
                wrap.className = 'chapter-banner-img';
                wrap.innerHTML = `<img src="${IMG_BASE}${img.file}" alt="${img.caption}" loading="lazy"><div class="img-caption">${img.caption}</div>`;
                wrap.addEventListener('click', () => openLightbox(IMG_BASE + img.file, img.caption));
                banner.appendChild(wrap);
            });
            body.appendChild(banner);
        }

        const row = document.createElement('div');
        row.className = 'kenning-row';

        cat.kennings.forEach(k => {
            const card = document.createElement('article');
            card.className = 'kenning-card';
            card.dataset.search = (k.on + ' ' + k.en + ' ' + k.meaning + ' ' + (k.myth || '') + ' ' + k.logic).toLowerCase();
            let html = `<div class="kenning-text">${k.on}</div>
                <div class="kenning-english">${k.en}</div>
                <div class="kenning-meaning">= ${k.meaning}</div>`;
            if (k.logic) html += `<div class="kenning-logic">${k.logic}</div>`;
            if (k.myth) html += `<span class="kenning-myth">${k.myth}</span>`;
            card.innerHTML = html;
            row.appendChild(card);
        });

        body.appendChild(row);
        chapter.appendChild(header);
        chapter.appendChild(body);
        chaptersContainer.appendChild(chapter);
    });

    // Build god-kenning tables
    GOD_KENNINGS.forEach(god => {
        const section = document.createElement('section');
        section.className = 'god-section';
        section.dataset.category = 'gods';
        section.setAttribute('aria-label', 'Kennings for ' + god.name);

        const header = document.createElement('div');
        header.className = 'god-section-header';
        header.setAttribute('role', 'button');
        header.setAttribute('tabindex', '0');
        header.setAttribute('aria-expanded', 'true');
        header.innerHTML = `
            <div style="display:flex;align-items:center;gap:12px;">
                <span class="god-section-title">${god.name}</span>
                <span class="chapter-count">${god.kennings.length} kennings</span>
            </div>
            <span class="chapter-toggle">&#x25BC;</span>
        `;

        header.addEventListener('click', () => {
            section.classList.toggle('collapsed');
            header.setAttribute('aria-expanded', !section.classList.contains('collapsed'));
        });
        header.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); header.click(); }
        });

        const body = document.createElement('div');
        body.className = 'god-body';

        const table = document.createElement('table');
        table.className = 'god-table';
        let tableHTML = '<thead><tr><th>Old Norse</th><th>English</th><th>Poetic Logic</th></tr></thead><tbody>';
        god.kennings.forEach(k => {
            const searchStr = (k.on + ' ' + k.en + ' ' + k.logic).toLowerCase();
            tableHTML += `<tr data-search="${searchStr.replace(/"/g, '&quot;')}">
                <td class="td-kenning">${k.on}</td>
                <td class="td-english">${k.en}</td>
                <td class="td-logic">${k.logic}</td>
            </tr>`;
        });
        tableHTML += '</tbody>';
        table.innerHTML = tableHTML;

        body.appendChild(table);
        section.appendChild(header);
        section.appendChild(body);
        godsContainer.appendChild(section);
    });

    // Initial count
    searchCountEl.textContent = totalKennings + ' kennings';

    // Tag filter logic
    tagFiltersEl.addEventListener('click', (e) => {
        const btn = e.target.closest('.tag-btn');
        if (!btn) return;
        tagFiltersEl.querySelectorAll('.tag-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        activeTag = btn.dataset.tag || null;
        applyFilters();
    });

    // Search logic
    searchInput.addEventListener('input', () => {
        searchTerm = searchInput.value.trim().toLowerCase();
        applyFilters();
    });

    function applyFilters() {
        let visibleCount = 0;

        // Filter chapters
        document.querySelectorAll('.chapter').forEach(ch => {
            const catId = ch.dataset.category;
            const tagMatch = !activeTag || activeTag === catId;
            const isGodsFilter = activeTag === 'gods';

            if (isGodsFilter) {
                ch.classList.add('hidden');
                return;
            }

            if (!tagMatch) {
                ch.classList.add('hidden');
                return;
            }

            let chapterVisible = false;
            ch.querySelectorAll('.kenning-card').forEach(card => {
                const searchMatch = !searchTerm || card.dataset.search.includes(searchTerm);
                if (searchMatch) {
                    card.classList.remove('hidden');
                    chapterVisible = true;
                    visibleCount++;
                } else {
                    card.classList.add('hidden');
                }
            });

            ch.classList.toggle('hidden', !chapterVisible);
        });

        // Filter god sections
        const showGods = !activeTag || activeTag === 'gods';
        godDivider.style.display = showGods ? '' : 'none';

        document.querySelectorAll('.god-section').forEach(gs => {
            if (!showGods) {
                gs.style.display = 'none';
                return;
            }
            gs.style.display = '';
            let sectionVisible = false;
            gs.querySelectorAll('tbody tr').forEach(row => {
                const s = row.dataset.search || '';
                const match = !searchTerm || s.includes(searchTerm);
                row.style.display = match ? '' : 'none';
                if (match) { sectionVisible = true; visibleCount++; }
            });
            gs.style.display = sectionVisible ? '' : 'none';
        });

        searchCountEl.textContent = visibleCount + ' kenning' + (visibleCount !== 1 ? 's' : '');
        noResultsEl.classList.toggle('visible', visibleCount === 0);
    }

    // ==========================================
    // NAVIGATION
    // ==========================================
    const nav = document.getElementById('exhibition-nav');
    const hamburger = document.getElementById('hamburger');
    const overlay = document.getElementById('nav-overlay');
    const transition = document.getElementById('room-transition');
    const navLinks = document.querySelectorAll('.nav-link');

    if (hamburger) {
        hamburger.addEventListener('click', () => {
            nav.classList.toggle('open');
            overlay.classList.toggle('visible');
        });
    }

    if (overlay) {
        overlay.addEventListener('click', () => {
            nav.classList.remove('open');
            overlay.classList.remove('visible');
        });
    }

    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            if (link.classList.contains('active')) { e.preventDefault(); return; }
            e.preventDefault();
            transition.classList.add('active');
            setTimeout(() => { window.location.href = link.href; }, 400);
        });
    });

    window.addEventListener('load', () => {
        transition.classList.add('active');
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                transition.classList.remove('active');
            });
        });
    });

    // ==========================================
    // AUDIO -- G2 98Hz, sine + sine third, warm/scholarly
    // ==========================================
    const audioToggle = document.getElementById('audio-toggle');
    let audioCtx = null;
    let audioPlaying = false;
    let masterGain = null;

    function initAudio() {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        masterGain = audioCtx.createGain();
        masterGain.gain.value = 0;
        masterGain.connect(audioCtx.destination);

        const filter = audioCtx.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.value = 600;
        filter.Q.value = 1;
        filter.connect(masterGain);

        // Fundamental: G2 = 98 Hz (sine)
        const osc1 = audioCtx.createOscillator();
        osc1.type = 'sine';
        osc1.frequency.value = 98;
        const g1 = audioCtx.createGain();
        g1.gain.value = 0.3;
        osc1.connect(g1);
        g1.connect(filter);
        osc1.start();

        // Third: ~123.5 Hz (major third, sine)
        const osc2 = audioCtx.createOscillator();
        osc2.type = 'sine';
        osc2.frequency.value = 98 * 1.26; // major third ratio
        const g2 = audioCtx.createGain();
        g2.gain.value = 0.15;
        osc2.connect(g2);
        g2.connect(filter);
        osc2.start();

        // Slow LFO
        const lfo = audioCtx.createOscillator();
        lfo.type = 'sine';
        lfo.frequency.value = 0.05;
        const lfoGain = audioCtx.createGain();
        lfoGain.gain.value = 180;
        lfo.connect(lfoGain);
        lfoGain.connect(filter.frequency);
        lfo.start();
    }

    function fadeInAudio() {
        if (!audioCtx) initAudio();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        masterGain.gain.cancelScheduledValues(audioCtx.currentTime);
        masterGain.gain.setValueAtTime(masterGain.gain.value, audioCtx.currentTime);
        masterGain.gain.linearRampToValueAtTime(0.12, audioCtx.currentTime + 3);
        audioPlaying = true;
    }

    function fadeOutAudio() {
        if (!audioCtx) return;
        masterGain.gain.cancelScheduledValues(audioCtx.currentTime);
        masterGain.gain.setValueAtTime(masterGain.gain.value, audioCtx.currentTime);
        masterGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 2);
        audioPlaying = false;
    }

    // Audio OFF by default, check localStorage
    const savedAudio = localStorage.getItem('exhibition-audio');

    audioToggle.addEventListener('click', () => {
        if (audioPlaying) {
            fadeOutAudio();
            audioToggle.classList.add('muted');
            localStorage.setItem('exhibition-audio', 'false');
        } else {
            fadeInAudio();
            audioToggle.classList.remove('muted');
            localStorage.setItem('exhibition-audio', 'true');
        }
    });

    // Restore audio preference only if explicitly turned on
    if (savedAudio === 'true') {
        // Wait for user gesture
        const resumeAudio = () => {
            fadeInAudio();
            audioToggle.classList.remove('muted');
            document.removeEventListener('click', resumeAudio);
            document.removeEventListener('keydown', resumeAudio);
        };
        document.addEventListener('click', resumeAudio, { once: true });
        document.addEventListener('keydown', resumeAudio, { once: true });
    }

    // ==========================================
    // P5.JS BACKDROP -- Mead Flow (amber particle streams)
    // ==========================================
    const meadSketch = (p) => {
        const particles = [];
        const maxParticles = 150;
        const streams = [];
        const numStreams = 5;

        p.setup = () => {
            const container = document.getElementById('p5-backdrop');
            if (!container) return;
            const cnv = p.createCanvas(container.offsetWidth, container.offsetHeight);
            cnv.parent('p5-backdrop');
            p.frameRate(30);
            p.noStroke();

            // Create stream paths (bezier-like curves)
            for (let i = 0; i < numStreams; i++) {
                streams.push({
                    x1: p.random(p.width * 0.1, p.width * 0.4),
                    y1: p.random(-50, -10),
                    cx1: p.random(p.width * 0.2, p.width * 0.8),
                    cy1: p.random(p.height * 0.2, p.height * 0.5),
                    cx2: p.random(p.width * 0.2, p.width * 0.8),
                    cy2: p.random(p.height * 0.5, p.height * 0.8),
                    x2: p.random(p.width * 0.3, p.width * 0.9),
                    y2: p.height + 50,
                    speed: p.random(0.002, 0.005),
                    phase: p.random(0, 1)
                });
            }
        };

        function bezierPoint(a, b, c, d, t) {
            const t1 = 1 - t;
            return t1 * t1 * t1 * a + 3 * t1 * t1 * t * b + 3 * t1 * t * t * c + t * t * t * d;
        }

        p.draw = () => {
            p.background(26, 26, 46, 25);

            // Spawn particles on streams
            if (particles.length < maxParticles && p.frameCount % 2 === 0) {
                const si = p.floor(p.random(numStreams));
                const s = streams[si];
                particles.push({
                    stream: si,
                    t: 0,
                    size: p.random(2, 5),
                    alpha: p.random(80, 180),
                    hueShift: p.random(-10, 10),
                    offsetX: p.random(-15, 15),
                    offsetY: p.random(-8, 8)
                });
            }

            // Update and draw particles
            for (let i = particles.length - 1; i >= 0; i--) {
                const pt = particles[i];
                const s = streams[pt.stream];
                pt.t += s.speed + p.sin(p.frameCount * 0.02 + pt.stream) * 0.001;

                if (pt.t > 1) {
                    particles.splice(i, 1);
                    continue;
                }

                const x = bezierPoint(s.x1, s.cx1, s.cx2, s.x2, pt.t) + pt.offsetX + p.sin(p.frameCount * 0.03 + pt.stream * 2) * 8;
                const y = bezierPoint(s.y1, s.cy1, s.cy2, s.y2, pt.t) + pt.offsetY;

                // Amber color with variation
                const r = 199 + pt.hueShift;
                const g = 125 + pt.hueShift * 0.5;
                const b = 46;
                const fadeIn = pt.t < 0.1 ? pt.t * 10 : 1;
                const fadeOut = pt.t > 0.85 ? (1 - pt.t) / 0.15 : 1;
                const a = pt.alpha * fadeIn * fadeOut;

                p.fill(r, g, b, a);
                p.ellipse(x, y, pt.size);

                // Glow
                p.fill(r, g, b, a * 0.2);
                p.ellipse(x, y, pt.size * 3);
            }

            // Slowly shift stream control points for organic movement
            streams.forEach(s => {
                s.cx1 += p.sin(p.frameCount * 0.008 + s.phase) * 0.3;
                s.cx2 += p.cos(p.frameCount * 0.006 + s.phase * 2) * 0.3;
            });
        };

        p.windowResized = () => {
            const container = document.getElementById('p5-backdrop');
            if (container) p.resizeCanvas(container.offsetWidth, container.offsetHeight);
        };
    };

    new p5(meadSketch);

    // Track visited rooms
    try {
        const visited = JSON.parse(localStorage.getItem('exhibition-visited') || '[]');
        if (!visited.includes('skald')) {
            visited.push('skald');
            localStorage.setItem('exhibition-visited', JSON.stringify(visited));
        }
    } catch (e) {}

    // ==========================================
    // LIGHTBOX
    // ==========================================
    const lightboxOverlay = document.getElementById('lightbox-overlay');
    const lightboxImg = document.getElementById('lightbox-img');
    const lightboxCaption = document.getElementById('lightbox-caption');
    const lightboxClose = lightboxOverlay.querySelector('.lightbox-close');

    function openLightbox(src, caption) {
        lightboxImg.src = src;
        lightboxImg.alt = caption;
        lightboxCaption.textContent = caption;
        lightboxOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
        lightboxOverlay.classList.remove('active');
        document.body.style.overflow = '';
    }

    lightboxOverlay.addEventListener('click', (e) => {
        if (e.target === lightboxOverlay) closeLightbox();
    });
    lightboxClose.addEventListener('click', closeLightbox);
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && lightboxOverlay.classList.contains('active')) closeLightbox();
    });

    // Make openLightbox accessible to banner click handlers
    window.openLightbox = openLightbox;

    // Expose reset for enhance.js
    window.reset = () => {
        searchInput.value = '';
        searchTerm = '';
        activeTag = null;
        tagFiltersEl.querySelectorAll('.tag-btn').forEach(b => b.classList.remove('active'));
        tagFiltersEl.querySelector('[data-tag=""]').classList.add('active');
        document.querySelectorAll('.chapter').forEach(ch => ch.classList.remove('collapsed'));
        document.querySelectorAll('.god-section').forEach(gs => gs.classList.remove('collapsed'));
        applyFilters();
    };
})();
</script>
</body>
</html>
