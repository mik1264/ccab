<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viewstamped Replication Timeline</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #0f0f1a 100%);
            color: #e0e0e0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #c9a227;
            text-decoration: none;
            font-size: 14px;
            opacity: 0.8;
            transition: opacity 0.3s;
            z-index: 100;
        }

        .back-link:hover {
            opacity: 1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 60px 20px 20px;
        }

        h1 {
            text-align: center;
            font-size: 2rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #c9a227, #e0c068);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
            font-size: 0.95rem;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 280px;
            gap: 20px;
        }

        .visualization-area {
            background: rgba(20, 20, 35, 0.8);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(201, 162, 39, 0.2);
        }

        .controls-panel {
            background: rgba(20, 20, 35, 0.8);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(201, 162, 39, 0.2);
            height: fit-content;
            backdrop-filter: blur(10px);
        }

        .section-title {
            font-size: 0.85rem;
            color: #c9a227;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #c9a227, #b8941f);
            color: #0a0a0f;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(201, 162, 39, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #219a52);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .replica-status {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .replica-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .replica-name {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #27ae60;
        }

        .status-dot.failed {
            background: #e74c3c;
        }

        .status-dot.recovering {
            background: #f39c12;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .replica-role {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 4px;
            background: rgba(201, 162, 39, 0.2);
            color: #c9a227;
        }

        .replica-role.primary {
            background: rgba(39, 174, 96, 0.2);
            color: #27ae60;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #c9a227;
        }

        .stat-label {
            font-size: 0.7rem;
            color: #888;
            text-transform: uppercase;
        }

        canvas {
            width: 100%;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: #aaa;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }

        .log-panel {
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .log-entry {
            font-family: 'Consolas', monospace;
            font-size: 0.8rem;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-time {
            color: #666;
            margin-right: 10px;
        }

        .log-prepare { color: #3498db; }
        .log-commit { color: #27ae60; }
        .log-viewchange { color: #f39c12; }
        .log-recovery { color: #9b59b6; }
        .log-fail { color: #e74c3c; }

        .info-box {
            background: rgba(201, 162, 39, 0.1);
            border: 1px solid rgba(201, 162, 39, 0.3);
            border-radius: 8px;
            padding: 12px;
            font-size: 0.8rem;
            color: #ccc;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        @media (max-width: 900px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <a href="../index.html" class="back-link">‚Üê Back to Gallery</a>

    <div class="container">
        <h1>Viewstamped Replication Timeline</h1>
        <p class="subtitle">Visualize view changes, log replication, and recovery in the VR protocol</p>

        <div class="main-layout">
            <div class="visualization-area">
                <canvas id="canvas"></canvas>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #3498db;"></div>
                        <span>Prepare</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #27ae60;"></div>
                        <span>PrepareOK</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f39c12;"></div>
                        <span>View Change</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #9b59b6;"></div>
                        <span>Recovery</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #e74c3c;"></div>
                        <span>Failure</span>
                    </div>
                </div>

                <div class="log-panel" id="logPanel">
                    <div class="section-title">Event Log</div>
                </div>
            </div>

            <div class="controls-panel">
                <div class="info-box">
                    <strong>Viewstamped Replication (VR)</strong><br>
                    A consensus protocol where replicas are stamped with view numbers.
                    The primary handles requests; backups monitor and initiate view changes on failure.
                    f+1 of 2f+1 replicas must agree.
                </div>

                <div class="section-title">Actions</div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="sendRequest()">Send Client Request</button>
                    <button class="btn btn-danger" onclick="failPrimary()">Fail Primary</button>
                    <button class="btn btn-danger" onclick="failRandom()">Fail Random Replica</button>
                    <button class="btn btn-success" onclick="recoverReplica()">Recover Replica</button>
                </div>

                <div class="section-title">Simulation</div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="toggleAutoRequests()">Auto Requests: <span id="autoStatus">OFF</span></button>
                    <button class="btn btn-secondary" onclick="resetSimulation()">Reset</button>
                </div>

                <div class="section-title">Replica Status</div>
                <div class="replica-status" id="replicaStatus">
                </div>

                <div class="section-title">System State</div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="viewNumber">0</div>
                        <div class="stat-label">View</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="opNumber">0</div>
                        <div class="stat-label">Op Number</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="commitNumber">0</div>
                        <div class="stat-label">Committed</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="activeReplicas">5</div>
                        <div class="stat-label">Active</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // High DPI support
        function resizeCanvas() {
            const rect = canvas.parentElement.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            canvas.width = rect.width * dpr;
            canvas.height = 500 * dpr;
            canvas.style.height = '500px';
            ctx.scale(dpr, dpr);
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Simulation state
        const NUM_REPLICAS = 5;
        const QUORUM = 3; // f+1 where f=2

        let state = {
            viewNumber: 0,
            opNumber: 0,
            commitNumber: 0,
            primaryIdx: 0,
            replicas: [],
            messages: [],
            logs: [],
            time: 0,
            autoRequests: false
        };

        // Initialize replicas
        function initReplicas() {
            state.replicas = [];
            for (let i = 0; i < NUM_REPLICAS; i++) {
                state.replicas.push({
                    id: i,
                    name: `R${i + 1}`,
                    status: 'active', // active, failed, recovering
                    log: [],
                    commitNumber: 0,
                    viewNumber: 0,
                    isPrimary: i === 0
                });
            }
        }

        // Message types
        class Message {
            constructor(type, from, to, data) {
                this.type = type;
                this.from = from;
                this.to = to;
                this.data = data;
                this.startTime = state.time;
                this.duration = 30 + Math.random() * 20;
                this.progress = 0;
            }
        }

        // Add log entry
        function addLog(type, message) {
            const time = new Date().toLocaleTimeString();
            state.logs.unshift({ type, message, time });
            if (state.logs.length > 50) state.logs.pop();
            updateLogPanel();
        }

        function updateLogPanel() {
            const panel = document.getElementById('logPanel');
            panel.innerHTML = '<div class="section-title">Event Log</div>' +
                state.logs.slice(0, 15).map(log =>
                    `<div class="log-entry"><span class="log-time">${log.time}</span><span class="log-${log.type}">${log.message}</span></div>`
                ).join('');
        }

        // Send client request
        function sendRequest() {
            const primary = state.replicas.find(r => r.isPrimary && r.status === 'active');
            if (!primary) {
                addLog('fail', 'No active primary! View change needed.');
                initiateViewChange();
                return;
            }

            state.opNumber++;
            const op = { opNumber: state.opNumber, viewNumber: state.viewNumber, data: `Op-${state.opNumber}` };

            // Primary adds to log
            primary.log.push(op);
            addLog('prepare', `Primary ${primary.name} received request: ${op.data}`);

            // Send PREPARE to all backups
            state.replicas.forEach(replica => {
                if (replica.id !== primary.id && replica.status === 'active') {
                    state.messages.push(new Message('prepare', primary.id, replica.id, op));
                }
            });

            updateStats();
        }

        // Process received messages
        function processMessages() {
            const toRemove = [];

            state.messages.forEach((msg, idx) => {
                msg.progress += 1 / msg.duration;

                if (msg.progress >= 1) {
                    toRemove.push(idx);
                    const target = state.replicas[msg.to];

                    if (target.status !== 'active') return;

                    switch (msg.type) {
                        case 'prepare':
                            // Backup receives PREPARE
                            target.log.push(msg.data);
                            target.viewNumber = msg.data.viewNumber;
                            addLog('prepare', `${target.name} received PREPARE for ${msg.data.data}`);

                            // Send PREPARE-OK back to primary
                            const primary = state.replicas.find(r => r.isPrimary);
                            if (primary && primary.status === 'active') {
                                state.messages.push(new Message('prepareOK', target.id, primary.id, msg.data));
                            }
                            break;

                        case 'prepareOK':
                            // Primary receives PREPARE-OK
                            const op = msg.data;
                            if (!op.acks) op.acks = 1; // Include primary
                            op.acks++;

                            if (op.acks >= QUORUM && !op.committed) {
                                op.committed = true;
                                state.commitNumber = op.opNumber;
                                target.commitNumber = op.opNumber;
                                addLog('commit', `${target.name} committed ${op.data} (view ${state.viewNumber}, acks: ${op.acks})`);
                            }
                            break;

                        case 'startViewChange':
                            // Replica receives view change request
                            addLog('viewchange', `${target.name} acknowledges view change to view ${msg.data.newView}`);
                            break;

                        case 'doViewChange':
                            // New primary receives DO-VIEW-CHANGE
                            if (target.isPrimary) {
                                addLog('viewchange', `New primary ${target.name} received state from ${state.replicas[msg.from].name}`);
                            }
                            break;

                        case 'recovery':
                            // Recovery messages
                            if (msg.data.phase === 'request') {
                                state.messages.push(new Message('recovery', target.id, msg.from, {
                                    phase: 'response',
                                    log: [...target.log],
                                    viewNumber: target.viewNumber
                                }));
                            } else if (msg.data.phase === 'response') {
                                target.log = [...msg.data.log];
                                target.viewNumber = msg.data.viewNumber;
                                target.status = 'active';
                                addLog('recovery', `${target.name} recovered with ${msg.data.log.length} log entries`);
                            }
                            break;
                    }
                }
            });

            // Remove completed messages
            for (let i = toRemove.length - 1; i >= 0; i--) {
                state.messages.splice(toRemove[i], 1);
            }
        }

        // Fail the primary
        function failPrimary() {
            const primary = state.replicas.find(r => r.isPrimary && r.status === 'active');
            if (primary) {
                primary.status = 'failed';
                addLog('fail', `Primary ${primary.name} has FAILED!`);
                updateReplicaStatus();

                // Trigger view change after a short delay
                setTimeout(() => initiateViewChange(), 500);
            }
        }

        // Fail a random non-primary replica
        function failRandom() {
            const candidates = state.replicas.filter(r => !r.isPrimary && r.status === 'active');
            if (candidates.length > 0) {
                const victim = candidates[Math.floor(Math.random() * candidates.length)];
                victim.status = 'failed';
                addLog('fail', `Replica ${victim.name} has FAILED!`);
                updateReplicaStatus();
            }
        }

        // Initiate view change
        function initiateViewChange() {
            const activeReplicas = state.replicas.filter(r => r.status === 'active');
            if (activeReplicas.length < QUORUM) {
                addLog('fail', 'Not enough replicas for view change! System unavailable.');
                return;
            }

            state.viewNumber++;
            addLog('viewchange', `Initiating view change to view ${state.viewNumber}`);

            // Deterministic primary selection: next active replica in order
            const oldPrimary = state.replicas.find(r => r.isPrimary);
            if (oldPrimary) oldPrimary.isPrimary = false;

            // Find next active replica to be primary
            let found = false;
            for (let i = 0; i < NUM_REPLICAS && !found; i++) {
                const nextIdx = (state.primaryIdx + 1 + i) % NUM_REPLICAS;
                if (state.replicas[nextIdx].status === 'active') {
                    state.replicas[nextIdx].isPrimary = true;
                    state.primaryIdx = nextIdx;
                    found = true;
                    addLog('viewchange', `${state.replicas[nextIdx].name} is new primary for view ${state.viewNumber}`);
                }
            }

            // Send view change messages
            activeReplicas.forEach(replica => {
                if (!replica.isPrimary) {
                    const primary = state.replicas.find(r => r.isPrimary);
                    state.messages.push(new Message('startViewChange', replica.id, primary.id, { newView: state.viewNumber }));
                }
            });

            updateReplicaStatus();
            updateStats();
        }

        // Recover a failed replica
        function recoverReplica() {
            const failed = state.replicas.find(r => r.status === 'failed');
            if (failed) {
                failed.status = 'recovering';
                addLog('recovery', `${failed.name} starting recovery...`);

                // Request state from active replicas
                const activeReplicas = state.replicas.filter(r => r.status === 'active');
                if (activeReplicas.length >= QUORUM) {
                    // Request from first active replica
                    state.messages.push(new Message('recovery', failed.id, activeReplicas[0].id, { phase: 'request' }));
                } else {
                    addLog('fail', 'Not enough active replicas for recovery');
                    failed.status = 'failed';
                }

                updateReplicaStatus();
            } else {
                addLog('recovery', 'No failed replicas to recover');
            }
        }

        // Update replica status display
        function updateReplicaStatus() {
            const container = document.getElementById('replicaStatus');
            container.innerHTML = state.replicas.map(r => `
                <div class="replica-item">
                    <div class="replica-name">
                        <div class="status-dot ${r.status === 'failed' ? 'failed' : r.status === 'recovering' ? 'recovering' : ''}"></div>
                        <span>${r.name}</span>
                    </div>
                    <span class="replica-role ${r.isPrimary ? 'primary' : ''}">${r.isPrimary ? 'PRIMARY' : 'Backup'}</span>
                </div>
            `).join('');
        }

        // Update stats display
        function updateStats() {
            document.getElementById('viewNumber').textContent = state.viewNumber;
            document.getElementById('opNumber').textContent = state.opNumber;
            document.getElementById('commitNumber').textContent = state.commitNumber;
            document.getElementById('activeReplicas').textContent = state.replicas.filter(r => r.status === 'active').length;
        }

        // Toggle auto requests
        let autoInterval = null;
        function toggleAutoRequests() {
            state.autoRequests = !state.autoRequests;
            document.getElementById('autoStatus').textContent = state.autoRequests ? 'ON' : 'OFF';

            if (state.autoRequests) {
                autoInterval = setInterval(() => {
                    if (state.replicas.some(r => r.isPrimary && r.status === 'active')) {
                        sendRequest();
                    }
                }, 1500);
            } else {
                clearInterval(autoInterval);
            }
        }

        // Reset simulation
        function resetSimulation() {
            if (autoInterval) clearInterval(autoInterval);
            state.autoRequests = false;
            document.getElementById('autoStatus').textContent = 'OFF';

            state = {
                viewNumber: 0,
                opNumber: 0,
                commitNumber: 0,
                primaryIdx: 0,
                replicas: [],
                messages: [],
                logs: [],
                time: 0,
                autoRequests: false
            };

            initReplicas();
            updateReplicaStatus();
            updateStats();
            addLog('commit', 'Simulation reset');
        }

        // Draw visualization
        function draw() {
            const width = canvas.width / (window.devicePixelRatio || 1);
            const height = canvas.height / (window.devicePixelRatio || 1);

            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.fillRect(0, 0, width, height);

            const padding = 60;
            const replicaSpacing = (height - 2 * padding) / (NUM_REPLICAS - 1);
            const timelineWidth = width - 2 * padding;

            // Draw timelines for each replica
            state.replicas.forEach((replica, idx) => {
                const y = padding + idx * replicaSpacing;

                // Replica label
                ctx.font = 'bold 14px Segoe UI';
                ctx.fillStyle = replica.status === 'failed' ? '#e74c3c' :
                               replica.status === 'recovering' ? '#f39c12' :
                               replica.isPrimary ? '#27ae60' : '#888';
                ctx.textAlign = 'right';
                ctx.fillText(replica.name + (replica.isPrimary ? ' (P)' : ''), padding - 15, y + 5);

                // Timeline line
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.strokeStyle = replica.status === 'failed' ? 'rgba(231, 76, 60, 0.3)' : 'rgba(255, 255, 255, 0.2)';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Draw log entries on timeline
                const logWidth = Math.min(30, timelineWidth / Math.max(replica.log.length, 1));
                replica.log.forEach((entry, logIdx) => {
                    const x = padding + 20 + logIdx * logWidth;
                    if (x < width - padding) {
                        ctx.beginPath();
                        ctx.arc(x, y, 6, 0, Math.PI * 2);
                        ctx.fillStyle = entry.opNumber <= state.commitNumber ? '#27ae60' : '#3498db';
                        ctx.fill();
                    }
                });
            });

            // Draw messages in flight
            state.messages.forEach(msg => {
                const fromY = padding + msg.from * replicaSpacing;
                const toY = padding + msg.to * replicaSpacing;
                const x = padding + 50 + msg.progress * (timelineWidth - 100);
                const currentY = fromY + (toY - fromY) * msg.progress;

                // Message line
                ctx.beginPath();
                ctx.moveTo(padding + 50, fromY);
                ctx.lineTo(x, currentY);
                ctx.strokeStyle = msg.type === 'prepare' ? '#3498db' :
                                 msg.type === 'prepareOK' ? '#27ae60' :
                                 msg.type === 'startViewChange' || msg.type === 'doViewChange' ? '#f39c12' :
                                 '#9b59b6';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 3]);
                ctx.stroke();
                ctx.setLineDash([]);

                // Message dot
                ctx.beginPath();
                ctx.arc(x, currentY, 5, 0, Math.PI * 2);
                ctx.fillStyle = ctx.strokeStyle;
                ctx.fill();
            });

            // View number indicator
            ctx.font = 'bold 16px Segoe UI';
            ctx.fillStyle = '#c9a227';
            ctx.textAlign = 'center';
            ctx.fillText(`View ${state.viewNumber}`, width / 2, 30);

            // Committed marker
            if (state.commitNumber > 0) {
                ctx.font = '12px Segoe UI';
                ctx.fillStyle = '#27ae60';
                ctx.textAlign = 'right';
                ctx.fillText(`Committed: ${state.commitNumber}`, width - padding, 30);
            }
        }

        // Animation loop
        function animate() {
            state.time++;
            processMessages();
            draw();
            requestAnimationFrame(animate);
        }

        // Expose functions for enhance.js keyboard shortcuts
        window.reset = resetSimulation;

        // Initialize
        initReplicas();
        updateReplicaStatus();
        updateStats();
        addLog('commit', 'Viewstamped Replication simulator initialized');
        addLog('commit', `Configuration: ${NUM_REPLICAS} replicas, quorum = ${QUORUM}`);
        animate();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
