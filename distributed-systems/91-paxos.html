<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paxos Consensus Visualizer</title>
    <style>
        body { margin: 0; background: #fff; font-family: sans-serif; overflow: hidden; }
        canvas { display: block; }
        .controls { position: absolute; top: 20px; left: 20px; backdrop-filter: blur(10px); background: rgba(0,0,0,0.5); padding: 10px; border-radius: 8px; }
        button { padding: 10px; font-size: 16px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="controls">
        <button onclick="propose()">Propose Value</button>
        <button onclick="reset()">Reset</button>
    </div>
    <canvas id="canvas"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        // Paxos Roles
        const proposers = [{x: 100, y: 100, name: "P1"}, {x: 100, y: 300, name: "P2"}];
        const acceptors = [{x: 400, y: 100, name: "A1"}, {x: 400, y: 200, name: "A2"}, {x: 400, y: 300, name: "A3"}];
        const learners = [{x: 700, y: 200, name: "L1"}];

        let messages = []; // {from, to, type, val, t}

        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
        }
        window.addEventListener('resize', resize);
        resize();

        function drawNode(n, color) {
            ctx.beginPath();
            ctx.arc(n.x, n.y, 20, 0, Math.PI*2);
            ctx.fillStyle = color;
            ctx.fill();
            ctx.strokeStyle = '#333';
            ctx.stroke();
            ctx.fillStyle = '#000';
            ctx.fillText(n.name, n.x - 8, n.y + 5);
            if(n.val) ctx.fillText(n.val, n.x, n.y - 30);
        }

        function draw() {
            ctx.clearRect(0, 0, width, height);

            // Draw Links (mesh)
            ctx.strokeStyle = '#eee';
            proposers.forEach(p => acceptors.forEach(a => { ctx.beginPath(); ctx.moveTo(p.x, p.y); ctx.lineTo(a.x, a.y); ctx.stroke(); }));
            acceptors.forEach(a => learners.forEach(l => { ctx.beginPath(); ctx.moveTo(a.x, a.y); ctx.lineTo(l.x, l.y); ctx.stroke(); }));

            // Nodes
            proposers.forEach(n => drawNode(n, '#93c5fd'));
            acceptors.forEach(n => drawNode(n, '#86efac'));
            learners.forEach(n => drawNode(n, '#fca5a5'));

            // Messages
            messages.forEach((m, i) => {
                m.t += 0.02;
                if(m.t >= 1) {
                    // Arrived
                    handleMessage(m);
                    messages.splice(i, 1);
                    return;
                }
                
                const x = m.from.x + (m.to.x - m.from.x) * m.t;
                const y = m.from.y + (m.to.y - m.from.y) * m.t;
                
                ctx.beginPath();
                ctx.arc(x, y, 5, 0, Math.PI*2);
                ctx.fillStyle = m.type === 'PREPARE' ? 'blue' : m.type === 'PROMISE' ? 'green' : 'red';
                ctx.fill();
            });

            requestAnimationFrame(draw);
        }

        function propose() {
            const p = proposers[0];
            const val = Math.floor(Math.random() * 100);
            p.val = val;
            
            // Phase 1a: Prepare
            acceptors.forEach(a => {
                messages.push({from: p, to: a, type: 'PREPARE', n: 1, t: 0});
            });
        }

        function handleMessage(m) {
            // Simplified Paxos Logic
            if(m.type === 'PREPARE') {
                // Phase 1b: Promise
                messages.push({from: m.to, to: m.from, type: 'PROMISE', n: m.n, t: 0});
            } else if (m.type === 'PROMISE') {
                // Phase 2a: Accept Request
                if(!m.to.promises) m.to.promises = 0;
                m.to.promises++;
                if(m.to.promises >= 2) { // Quorum
                     acceptors.forEach(a => {
                        messages.push({from: m.to, to: a, type: 'ACCEPT', val: m.to.val, t: 0});
                    });
                    m.to.promises = 0; // Reset
                }
            } else if (m.type === 'ACCEPT') {
                // Phase 2b: Accepted
                m.to.val = m.val;
                // Notify Learner
                learners.forEach(l => {
                    messages.push({from: m.to, to: l, type: 'LEARN', val: m.val, t: 0});
                });
            } else if (m.type === 'LEARN') {
                m.to.val = m.val;
            }
        }

        function reset() {
            messages = [];
            [...proposers, ...acceptors, ...learners].forEach(n => n.val = null);
        }

        // Expose functions for enhance.js keyboard shortcuts
        window.reset = function() { [...proposers, ...acceptors, ...learners].forEach(n => n.val = null); draw(); };

        draw();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
