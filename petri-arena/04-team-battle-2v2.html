<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>04. Team Battle (2v2) - Petri Arena</title>
    <style>
        body { margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh;
               background: linear-gradient(135deg, #0a0e27 0%, #1a0b2e 100%); font-family: sans-serif; color: white; }
        canvas { border: 2px solid #00f5ff; box-shadow: 0 0 20px rgba(0, 245, 255, 0.5); }
        h1 { text-align: center; font-size: 2rem; margin-bottom: 10px; }
        .container { text-align: center; }
        .stats { margin-top: 10px; display: flex; justify-content: center; gap: 15px; font-size: 0.85rem; flex-wrap: wrap; }
        .stat { padding: 6px 12px; background: rgba(0, 245, 255, 0.1); border-radius: 5px; }
        .team1 { color: #00f5ff; } .team2 { color: #ff5500; }
        .controls { margin-top: 15px; }
        button { padding: 8px 16px; background: rgba(0, 245, 255, 0.2); border: 1px solid rgba(0, 245, 255, 0.5);
                 color: white; border-radius: 5px; cursor: pointer; margin: 0 5px; }
        .info { margin-top: 15px; font-size: 0.85rem; opacity: 0.8; max-width: 600px; margin-left: auto; margin-right: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>⚔️ Team Battle (2v2)</h1>
        <canvas id="canvas" width="512" height="512"></canvas>
        <div class="stats">
            <div class="stat team1">Team 1: A1 <span id="a1">0</span>% + A2 <span id="a2">0</span>% = <span id="t1">0</span>%</div>
            <div class="stat team2">Team 2: A3 <span id="a3">0</span>% + A4 <span id="a4">0</span>% = <span id="t2">0</span>%</div>
            <div class="stat">Step: <span id="step">0</span></div>
        </div>
        <div class="controls">
            <button onclick="paused=!paused">Pause/Resume</button>
            <button onclick="init();render()">Reset</button>
            <button onclick="location.href='index.html'">Gallery</button>
        </div>
        <div class="info">Two teams of two agents each. Team 1 (left side) has cooperation bias, Team 2 (right side) also cooperates. Watch team dynamics emerge!</div>
    </div>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const gridSize = 128, cellSize = 4, numAgents = 4, tau = 0.5;
        let state = {}, step = 0, paused = false;
        const colors = [[30,30,40], [0,245,255], [100,200,255], [255,85,0], [255,136,0]];
        const teams = [0,1,1,2,2]; // agent 0=bg, 1-2=team1, 3-4=team2

        function initArrays() {
            ['attack','defense','hidden','aliveness'].forEach(k => {
                state[k] = Array(numAgents+1).fill(0).map(()=>Array(gridSize).fill(0).map(()=>Array(gridSize).fill(0)));
            });
        }

        function init() {
            initArrays(); step = 0;
            for(let y=0; y<gridSize; y++) for(let x=0; x<gridSize; x++) {
                state.attack[0][y][x] = (Math.random()-0.5)*0.2;
                state.defense[0][y][x] = (Math.random()-0.5)*0.2;
                state.aliveness[0][y][x] = 0.2;
            }
            const positions = [[0.2,0.3],[0.2,0.7],[0.8,0.3],[0.8,0.7]];
            for(let a=1; a<=numAgents; a++) {
                const [fx,fy] = positions[a-1];
                const cx = gridSize*fx, cy = gridSize*fy, r = 12;
                for(let y=0; y<gridSize; y++) for(let x=0; x<gridSize; x++) {
                    const d = Math.sqrt((x-cx)**2+(y-cy)**2);
                    if(d < r) {
                        state.attack[a][y][x] = Math.random()*0.5+0.5;
                        state.defense[a][y][x] = Math.random()*0.5+0.5;
                        state.hidden[a][y][x] = Math.random()*0.5;
                        state.aliveness[a][y][x] = 1.0;
                    }
                }
            }
        }

        function update() {
            const ns = {};
            ['attack','defense','hidden','aliveness'].forEach(k => {
                ns[k] = state[k].map(a=>a.map(r=>[...r]));
            });
            for(let y=1; y<gridSize-1; y++) for(let x=1; x<gridSize-1; x++) {
                const deltas = [];
                for(let a=0; a<=numAgents; a++) {
                    let s=[0,0,0], c=0;
                    for(let dy=-1; dy<=1; dy++) for(let dx=-1; dx<=1; dx++) {
                        s[0]+=state.attack[a][y+dy][x+dx];
                        s[1]+=state.defense[a][y+dy][x+dx];
                        s[2]+=state.hidden[a][y+dy][x+dx];
                        c++;
                    }
                    deltas.push({a:(s[0]/c-state.attack[a][y][x])*0.15, d:(s[1]/c-state.defense[a][y][x])*0.15,
                                 h:(s[2]/c-state.hidden[a][y][x])*0.1+(Math.random()-0.5)*0.05});
                }
                const str = [];
                for(let i=0; i<=numAgents; i++) {
                    let s=0;
                    for(let j=0; j<=numAgents; j++) {
                        if(i!==j) {
                            const bonus = (i>0 && j>0 && teams[i]===teams[j]) ? 0.3 : 0; // team cooperation bonus
                            s+=state.attack[i][y][x]*state.defense[j][y][x]*(1+bonus);
                        }
                    }
                    str.push(s+state.aliveness[i][y][x]);
                }
                const m=Math.max(...str), e=str.map(s=>Math.exp((s-m)/tau)), es=e.reduce((a,b)=>a+b), w=e.map(v=>v/es);
                for(let a=0; a<=numAgents; a++) {
                    ns.attack[a][y][x] = Math.max(-1, Math.min(1, state.attack[a][y][x]+deltas[a].a*w[a]));
                    ns.defense[a][y][x] = Math.max(-1, Math.min(1, state.defense[a][y][x]+deltas[a].d*w[a]));
                    ns.hidden[a][y][x] = Math.max(-1, Math.min(1, state.hidden[a][y][x]+deltas[a].h*w[a]));
                    ns.aliveness[a][y][x] = w[a];
                }
            }
            state = ns; step++;
        }

        function render() {
            const img = ctx.createImageData(gridSize, gridSize);
            for(let y=0; y<gridSize; y++) for(let x=0; x<gridSize; x++) {
                let ma=0, w=0;
                for(let a=0; a<=numAgents; a++) if(state.aliveness[a][y][x]>ma) { ma=state.aliveness[a][y][x]; w=a; }
                const i=(y*gridSize+x)*4, c=colors[w];
                img.data[i]=c[0]*ma; img.data[i+1]=c[1]*ma; img.data[i+2]=c[2]*ma; img.data[i+3]=255;
            }
            ctx.putImageData(img,0,0); ctx.imageSmoothingEnabled=false;
            ctx.drawImage(canvas,0,0,gridSize,gridSize,0,0,512,512);
            let t=Array(numAgents+1).fill(0);
            for(let y=0; y<gridSize; y++) for(let x=0; x<gridSize; x++) {
                let ma=0, w=0;
                for(let a=0; a<=numAgents; a++) if(state.aliveness[a][y][x]>ma) { ma=state.aliveness[a][y][x]; w=a; }
                t[w]++;
            }
            const tot=gridSize*gridSize;
            for(let i=1; i<=numAgents; i++) document.getElementById(`a${i}`).textContent=((t[i]/tot)*100).toFixed(1);
            document.getElementById('t1').textContent=(((t[1]+t[2])/tot)*100).toFixed(1);
            document.getElementById('t2').textContent=(((t[3]+t[4])/tot)*100).toFixed(1);
            document.getElementById('step').textContent=step;
        }

        function animate() { if(!paused) { update(); render(); } requestAnimationFrame(animate); }
        init(); animate();
    </script>
</body>
</html>
