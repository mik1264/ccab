<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XOR Filter vs Bloom Filter - CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8e8e8;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            text-align: center;
            padding: 20px;
            margin-bottom: 20px;
        }
        h1 {
            font-size: 2rem;
            background: linear-gradient(90deg, #c9a227, #f4d03f);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        .subtitle { color: #888; font-size: 1rem; }
        .back-link {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #c9a227;
            text-decoration: none;
            font-weight: 500;
            transition: transform 0.3s;
        }
        .back-link:hover { transform: translateX(-5px); }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .filter-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
        }
        .filter-panel h2 {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        .filter-panel.bloom h2 { color: #3498db; }
        .filter-panel.xor h2 { color: #2ecc71; }
        .controls-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .controls-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            flex: 1;
        }
        .controls-panel h3 {
            color: #c9a227;
            font-size: 1rem;
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(201, 162, 39, 0.3);
            padding-bottom: 5px;
        }
        .input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        input[type="text"], input[type="number"] {
            flex: 1;
            padding: 10px;
            border: 1px solid rgba(201, 162, 39, 0.3);
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.3);
            color: #e8e8e8;
            font-size: 1rem;
            font-family: 'Courier New', monospace;
        }
        button {
            padding: 10px 15px;
            background: rgba(201, 162, 39, 0.2);
            border: 1px solid rgba(201, 162, 39, 0.5);
            border-radius: 6px;
            color: #c9a227;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
        }
        button:hover {
            background: rgba(201, 162, 39, 0.3);
            border-color: #c9a227;
        }
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .action-buttons button {
            flex: 1;
            min-width: 80px;
        }
        .bit-array {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            margin: 15px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            max-height: 150px;
            overflow-y: auto;
        }
        .bit {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            font-size: 7px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .bit.off { background: rgba(100, 100, 100, 0.3); }
        .bit.on { background: rgba(52, 152, 219, 0.8); }
        .bit.highlight { background: rgba(243, 156, 18, 0.8); }
        .fingerprint-array {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            margin: 15px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            max-height: 150px;
            overflow-y: auto;
        }
        .fingerprint {
            padding: 3px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 9px;
        }
        .fingerprint.empty { background: rgba(100, 100, 100, 0.3); color: #666; }
        .fingerprint.filled { background: rgba(46, 204, 113, 0.6); color: #fff; }
        .fingerprint.highlight { background: rgba(243, 156, 18, 0.8); color: #fff; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .stat-box {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .stat-value.bloom { color: #3498db; }
        .stat-value.xor { color: #2ecc71; }
        .stat-label {
            font-size: 0.7rem;
            color: #888;
        }
        .comparison-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
        }
        .comparison-panel h3 {
            color: #c9a227;
            font-size: 1rem;
            margin-bottom: 15px;
            text-align: center;
        }
        .comparison-bar {
            margin: 10px 0;
        }
        .comparison-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            margin-bottom: 5px;
        }
        .bar-container {
            display: flex;
            height: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            overflow: hidden;
        }
        .bar-bloom {
            background: linear-gradient(90deg, #3498db, #2980b9);
            transition: width 0.3s;
        }
        .bar-xor {
            background: linear-gradient(90deg, #2ecc71, #27ae60);
            transition: width 0.3s;
        }
        .log-container {
            max-height: 100px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            margin-top: 10px;
        }
        .log-entry {
            padding: 2px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .log-entry.insert { color: #2ecc71; }
        .log-entry.query { color: #3498db; }
        .log-entry.fp { color: #e74c3c; }
        .log-entry.info { color: #f39c12; }
        @media (max-width: 900px) {
            .main-content { grid-template-columns: 1fr; }
            .controls-row { flex-direction: column; }
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back to Gallery</a>

    <div class="container">
        <header>
            <h1>XOR Filter vs Bloom Filter</h1>
            <p class="subtitle">Probabilistic Set Membership with Different Trade-offs</p>
        </header>

        <div class="controls-row">
            <div class="controls-panel">
                <h3>Add Elements</h3>
                <div class="input-group">
                    <input type="text" id="element-input" placeholder="Enter element...">
                    <button onclick="addElement()">Add</button>
                </div>
                <div class="action-buttons">
                    <button onclick="addRandom(10)">+10 Random</button>
                    <button onclick="addRandom(50)">+50 Random</button>
                    <button onclick="clearFilters()">Clear All</button>
                </div>
            </div>

            <div class="controls-panel">
                <h3>Query (Test Membership)</h3>
                <div class="input-group">
                    <input type="text" id="query-input" placeholder="Query element...">
                    <button onclick="queryElement()">Query</button>
                </div>
                <div class="action-buttons">
                    <button onclick="testFalsePositives(100)">Test 100 Non-members</button>
                    <button onclick="testFalsePositives(1000)">Test 1000</button>
                </div>
            </div>

            <div class="controls-panel">
                <h3>Configuration</h3>
                <div class="input-group">
                    <label style="min-width:80px">Bloom bits:</label>
                    <input type="number" id="bloom-size" value="256" min="64" max="1024">
                </div>
                <div class="input-group">
                    <label style="min-width:80px">XOR slots:</label>
                    <input type="number" id="xor-size" value="128" min="32" max="512">
                </div>
                <button onclick="rebuildFilters()" style="width:100%">Rebuild Filters</button>
            </div>
        </div>

        <div class="main-content">
            <div class="filter-panel bloom">
                <h2>Bloom Filter</h2>
                <p style="font-size:0.85rem; color:#888; text-align:center; margin-bottom:10px;">
                    k hash functions set k bits | Space: ~10 bits/element
                </p>
                <div class="bit-array" id="bloom-array"></div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value bloom" id="bloom-elements">0</div>
                        <div class="stat-label">Elements</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value bloom" id="bloom-fill">0%</div>
                        <div class="stat-label">Fill Rate</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value bloom" id="bloom-fp">0%</div>
                        <div class="stat-label">FP Rate (Est.)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value bloom" id="bloom-hashes">7</div>
                        <div class="stat-label">Hash Functions</div>
                    </div>
                </div>
                <div class="log-container" id="bloom-log"></div>
            </div>

            <div class="filter-panel xor">
                <h2>XOR Filter</h2>
                <p style="font-size:0.85rem; color:#888; text-align:center; margin-bottom:10px;">
                    3 lookups XOR'd with fingerprint | Space: ~9 bits/element
                </p>
                <div class="fingerprint-array" id="xor-array"></div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value xor" id="xor-elements">0</div>
                        <div class="stat-label">Elements</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value xor" id="xor-fill">0%</div>
                        <div class="stat-label">Fill Rate</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value xor" id="xor-fp">0.39%</div>
                        <div class="stat-label">FP Rate (Theory)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value xor" id="xor-lookups">3</div>
                        <div class="stat-label">Lookups/Query</div>
                    </div>
                </div>
                <div class="log-container" id="xor-log"></div>
            </div>
        </div>

        <div class="comparison-panel">
            <h3>Performance Comparison</h3>
            <div class="comparison-bar">
                <div class="comparison-label">
                    <span>Memory Usage</span>
                    <span>Bloom: <span id="bloom-mem">0</span> bits | XOR: <span id="xor-mem">0</span> bits</span>
                </div>
                <div class="bar-container">
                    <div class="bar-bloom" id="mem-bar-bloom" style="width:50%"></div>
                    <div class="bar-xor" id="mem-bar-xor" style="width:50%"></div>
                </div>
            </div>
            <div class="comparison-bar">
                <div class="comparison-label">
                    <span>False Positives Found</span>
                    <span>Bloom: <span id="bloom-fp-count">0</span> | XOR: <span id="xor-fp-count">0</span></span>
                </div>
                <div class="bar-container">
                    <div class="bar-bloom" id="fp-bar-bloom" style="width:50%"></div>
                    <div class="bar-xor" id="fp-bar-xor" style="width:50%"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Simple hash functions
        function hash1(str, max) {
            let h = 5381;
            for (let i = 0; i < str.length; i++) {
                h = ((h << 5) + h) ^ str.charCodeAt(i);
            }
            return Math.abs(h) % max;
        }

        function hash2(str, max) {
            let h = 0;
            for (let i = 0; i < str.length; i++) {
                h = str.charCodeAt(i) + ((h << 6) + (h << 16) - h);
            }
            return Math.abs(h) % max;
        }

        function hash3(str, max) {
            let h = 2166136261;
            for (let i = 0; i < str.length; i++) {
                h ^= str.charCodeAt(i);
                h = Math.imul(h, 16777619);
            }
            return Math.abs(h) % max;
        }

        function fingerprint(str) {
            let h = 0;
            for (let i = 0; i < str.length; i++) {
                h = ((h << 5) - h + str.charCodeAt(i)) | 0;
            }
            return Math.abs(h) % 256; // 8-bit fingerprint
        }

        // Bloom Filter
        class BloomFilter {
            constructor(size, numHashes = 7) {
                this.size = size;
                this.numHashes = numHashes;
                this.bits = new Array(size).fill(0);
                this.elements = new Set();
            }

            _getHashes(item) {
                const h1 = hash1(item, this.size);
                const h2 = hash2(item, this.size);
                const hashes = [];
                for (let i = 0; i < this.numHashes; i++) {
                    hashes.push((h1 + i * h2) % this.size);
                }
                return hashes;
            }

            add(item) {
                const hashes = this._getHashes(item);
                hashes.forEach(h => this.bits[h] = 1);
                this.elements.add(item);
                return hashes;
            }

            query(item) {
                const hashes = this._getHashes(item);
                const found = hashes.every(h => this.bits[h] === 1);
                return { found, hashes };
            }

            fillRate() {
                return this.bits.filter(b => b === 1).length / this.size;
            }

            estimatedFPRate() {
                const p = this.fillRate();
                return Math.pow(p, this.numHashes);
            }
        }

        // XOR Filter (simplified simulation)
        class XORFilter {
            constructor(size) {
                this.size = size;
                this.slots = new Array(size).fill(null);
                this.elements = new Set();
            }

            _getPositions(item) {
                const segSize = Math.floor(this.size / 3);
                return [
                    hash1(item, segSize),
                    segSize + hash2(item, segSize),
                    2 * segSize + hash3(item, segSize)
                ];
            }

            // Simplified XOR filter construction
            rebuild() {
                this.slots = new Array(this.size).fill(null);
                const items = Array.from(this.elements);

                // Simple greedy assignment (real XOR filters use peeling)
                items.forEach(item => {
                    const fp = fingerprint(item);
                    const [h0, h1, h2] = this._getPositions(item);

                    // XOR assignment (simplified)
                    if (this.slots[h0] === null) this.slots[h0] = 0;
                    if (this.slots[h1] === null) this.slots[h1] = 0;
                    if (this.slots[h2] === null) this.slots[h2] = 0;

                    // Set fingerprint via XOR relationship
                    const current = (this.slots[h0] || 0) ^ (this.slots[h1] || 0) ^ (this.slots[h2] || 0);
                    const needed = fp ^ current;
                    this.slots[h2] = (this.slots[h2] || 0) ^ needed;
                });
            }

            add(item) {
                this.elements.add(item);
                this.rebuild();
                return this._getPositions(item);
            }

            query(item) {
                const [h0, h1, h2] = this._getPositions(item);
                const fp = fingerprint(item);

                const v0 = this.slots[h0] || 0;
                const v1 = this.slots[h1] || 0;
                const v2 = this.slots[h2] || 0;

                const found = (v0 ^ v1 ^ v2) === fp;
                return { found, positions: [h0, h1, h2], fingerprint: fp };
            }

            fillRate() {
                return this.slots.filter(s => s !== null && s !== 0).length / this.size;
            }
        }

        let bloomFilter, xorFilter;
        let bloomHighlight = [], xorHighlight = [];
        let fpCountBloom = 0, fpCountXor = 0;

        function initFilters() {
            const bloomSize = parseInt(document.getElementById('bloom-size').value);
            const xorSize = parseInt(document.getElementById('xor-size').value);

            bloomFilter = new BloomFilter(bloomSize, 7);
            xorFilter = new XORFilter(xorSize);

            fpCountBloom = 0;
            fpCountXor = 0;

            renderFilters();
            updateStats();
        }

        function rebuildFilters() {
            const elements = Array.from(bloomFilter.elements);
            initFilters();
            elements.forEach(el => {
                bloomFilter.add(el);
                xorFilter.add(el);
            });
            renderFilters();
            updateStats();
            logBloom('info', 'Filters rebuilt');
            logXor('info', 'Filters rebuilt');
        }

        function addElement() {
            const input = document.getElementById('element-input');
            const element = input.value.trim();
            if (!element) return;

            bloomHighlight = bloomFilter.add(element);
            xorHighlight = xorFilter.add(element);

            input.value = '';
            renderFilters();
            updateStats();

            logBloom('insert', `Added "${element}" → bits [${bloomHighlight.join(', ')}]`);
            logXor('insert', `Added "${element}" → slots [${xorHighlight.join(', ')}]`);
        }

        function addRandom(count) {
            for (let i = 0; i < count; i++) {
                const element = 'item_' + Math.random().toString(36).substring(7);
                bloomFilter.add(element);
                xorFilter.add(element);
            }
            bloomHighlight = [];
            xorHighlight = [];
            renderFilters();
            updateStats();
            logBloom('insert', `Added ${count} random elements`);
            logXor('insert', `Added ${count} random elements`);
        }

        function queryElement() {
            const input = document.getElementById('query-input');
            const element = input.value.trim();
            if (!element) return;

            const bloomResult = bloomFilter.query(element);
            const xorResult = xorFilter.query(element);

            bloomHighlight = bloomResult.hashes;
            xorHighlight = xorResult.positions;

            const isActualMember = bloomFilter.elements.has(element);

            renderFilters();

            if (bloomResult.found) {
                if (isActualMember) {
                    logBloom('query', `"${element}": TRUE POSITIVE`);
                } else {
                    logBloom('fp', `"${element}": FALSE POSITIVE!`);
                    fpCountBloom++;
                }
            } else {
                logBloom('query', `"${element}": NOT FOUND`);
            }

            if (xorResult.found) {
                if (isActualMember) {
                    logXor('query', `"${element}": TRUE POSITIVE (fp=${xorResult.fingerprint})`);
                } else {
                    logXor('fp', `"${element}": FALSE POSITIVE!`);
                    fpCountXor++;
                }
            } else {
                logXor('query', `"${element}": NOT FOUND`);
            }

            updateStats();
            input.value = '';
        }

        function testFalsePositives(count) {
            let bloomFP = 0, xorFP = 0;

            for (let i = 0; i < count; i++) {
                const testItem = 'nonexistent_' + Math.random().toString(36).substring(7) + '_' + i;

                if (bloomFilter.query(testItem).found) bloomFP++;
                if (xorFilter.query(testItem).found) xorFP++;
            }

            fpCountBloom += bloomFP;
            fpCountXor += xorFP;

            bloomHighlight = [];
            xorHighlight = [];
            renderFilters();

            logBloom('fp', `Tested ${count}: ${bloomFP} false positives (${(bloomFP/count*100).toFixed(2)}%)`);
            logXor('fp', `Tested ${count}: ${xorFP} false positives (${(xorFP/count*100).toFixed(2)}%)`);

            updateStats();
        }

        function clearFilters() {
            initFilters();
            document.getElementById('bloom-log').innerHTML = '';
            document.getElementById('xor-log').innerHTML = '';
            logBloom('info', 'Filters cleared');
            logXor('info', 'Filters cleared');
        }

        function renderFilters() {
            // Render Bloom filter
            const bloomArray = document.getElementById('bloom-array');
            bloomArray.innerHTML = bloomFilter.bits.map((bit, i) => {
                const isHighlight = bloomHighlight.includes(i);
                const cls = isHighlight ? 'highlight' : (bit ? 'on' : 'off');
                return `<div class="bit ${cls}"></div>`;
            }).join('');

            // Render XOR filter
            const xorArray = document.getElementById('xor-array');
            xorArray.innerHTML = xorFilter.slots.map((slot, i) => {
                const isHighlight = xorHighlight.includes(i);
                const cls = isHighlight ? 'highlight' : (slot !== null && slot !== 0 ? 'filled' : 'empty');
                const val = slot !== null ? slot.toString(16).padStart(2, '0') : '--';
                return `<div class="fingerprint ${cls}">${val}</div>`;
            }).join('');
        }

        function updateStats() {
            const bloomCount = bloomFilter.elements.size;
            const xorCount = xorFilter.elements.size;

            document.getElementById('bloom-elements').textContent = bloomCount;
            document.getElementById('xor-elements').textContent = xorCount;

            document.getElementById('bloom-fill').textContent =
                (bloomFilter.fillRate() * 100).toFixed(1) + '%';
            document.getElementById('xor-fill').textContent =
                (xorFilter.fillRate() * 100).toFixed(1) + '%';

            document.getElementById('bloom-fp').textContent =
                (bloomFilter.estimatedFPRate() * 100).toFixed(2) + '%';

            // Memory comparison
            const bloomMem = bloomFilter.size;
            const xorMem = xorFilter.size * 8; // 8 bits per fingerprint

            document.getElementById('bloom-mem').textContent = bloomMem;
            document.getElementById('xor-mem').textContent = xorMem;

            const totalMem = bloomMem + xorMem;
            document.getElementById('mem-bar-bloom').style.width =
                (bloomMem / totalMem * 100) + '%';
            document.getElementById('mem-bar-xor').style.width =
                (xorMem / totalMem * 100) + '%';

            // FP comparison
            document.getElementById('bloom-fp-count').textContent = fpCountBloom;
            document.getElementById('xor-fp-count').textContent = fpCountXor;

            const totalFP = Math.max(fpCountBloom + fpCountXor, 1);
            document.getElementById('fp-bar-bloom').style.width =
                (fpCountBloom / totalFP * 100) + '%';
            document.getElementById('fp-bar-xor').style.width =
                (fpCountXor / totalFP * 100) + '%';
        }

        function logBloom(type, message) {
            const log = document.getElementById('bloom-log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = message;
            log.insertBefore(entry, log.firstChild);
            while (log.children.length > 30) log.removeChild(log.lastChild);
        }

        function logXor(type, message) {
            const log = document.getElementById('xor-log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = message;
            log.insertBefore(entry, log.firstChild);
            while (log.children.length > 30) log.removeChild(log.lastChild);
        }

        // Initialize
        initFilters();
        addRandom(20);
    </script>
</body>
</html>
