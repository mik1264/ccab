<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HyperLogLog Estimator - CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8e8e8;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { text-align: center; padding: 20px; margin-bottom: 20px; }
        h1 {
            font-size: 2.2rem;
            background: linear-gradient(90deg, #f39c12, #e67e22);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subtitle { color: #888; }
        .back-link { position: absolute; top: 20px; left: 20px; color: #f39c12; text-decoration: none; }
        .main-content { display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
        .canvas-container { background: rgba(255,255,255,0.05); border-radius: 16px; padding: 20px; }
        canvas { display: block; margin: 0 auto; background: #0a0a1a; border-radius: 8px; }
        .controls { display: flex; flex-direction: column; gap: 15px; }
        .panel { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 15px; }
        .panel h3 { color: #f39c12; font-size: 1rem; margin-bottom: 10px; border-bottom: 1px solid rgba(243,156,18,0.3); padding-bottom: 5px; }
        button {
            padding: 10px 15px; background: rgba(243,156,18,0.2);
            border: 1px solid rgba(243,156,18,0.5); border-radius: 6px;
            color: #f39c12; cursor: pointer; width: 100%; margin-bottom: 8px;
        }
        button:hover { background: rgba(243,156,18,0.3); }
        .control-group { margin-bottom: 12px; }
        .control-group label { display: block; color: #f39c12; font-size: 0.85rem; margin-bottom: 5px; }
        input[type="range"] {
            width: 100%; height: 6px; -webkit-appearance: none;
            background: rgba(243,156,18,0.2); border-radius: 3px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 16px; height: 16px;
            background: #f39c12; border-radius: 50%; cursor: pointer;
        }
        input[type="text"] {
            width: 100%; padding: 10px; background: rgba(0,0,0,0.3);
            border: 1px solid rgba(243,156,18,0.3); border-radius: 6px;
            color: #e8e8e8; font-size: 0.9rem;
        }
        .stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .stat { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; text-align: center; }
        .stat-value { font-size: 1rem; color: #f39c12; font-weight: bold; }
        .stat-label { font-size: 0.7rem; color: #888; }
        .big-stat { grid-column: span 2; }
        .big-stat .stat-value { font-size: 1.5rem; }
        .info-text { font-size: 0.85rem; color: #aaa; line-height: 1.6; }
        .register-display {
            display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px;
            max-height: 200px; overflow-y: auto; padding: 10px;
            background: rgba(0,0,0,0.3); border-radius: 6px;
        }
        .register {
            background: rgba(243,156,18,0.2); padding: 4px; border-radius: 4px;
            text-align: center; font-size: 0.7rem; font-family: monospace;
        }
        .register-label { color: #888; font-size: 0.6rem; }
        .register-value { color: #f39c12; font-weight: bold; }
        .error-bar { margin-top: 10px; }
        .error-fill { height: 10px; background: linear-gradient(90deg, #2ecc71, #f39c12, #e74c3c); border-radius: 5px; position: relative; }
        .error-marker { position: absolute; width: 3px; height: 20px; background: white; top: -5px; border-radius: 2px; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back to Gallery</a>
    <div class="container">
        <header>
            <h1>HyperLogLog Estimator</h1>
            <p class="subtitle">Probabilistic cardinality estimation with O(log log n) space</p>
        </header>
        <div class="main-content">
            <div class="canvas-container">
                <canvas id="canvas" width="900" height="550"></canvas>
            </div>
            <div class="controls">
                <div class="panel">
                    <h3>Add Items</h3>
                    <input type="text" id="item-input" placeholder="Type and press Enter...">
                    <button onclick="addRandomItems(100)" style="margin-top: 10px;">Add 100 Random Items</button>
                    <button onclick="addRandomItems(1000)">Add 1,000 Random Items</button>
                    <button onclick="addRandomItems(10000)">Add 10,000 Random Items</button>
                </div>
                <div class="panel">
                    <h3>Parameters</h3>
                    <div class="control-group">
                        <label>Register Bits (p): <span id="bits-val">6</span> → <span id="registers-val">64</span> registers</label>
                        <input type="range" id="bits" min="4" max="10" value="6" onchange="reset()">
                    </div>
                    <p class="info-text">
                        More registers = lower error but more memory.
                        Standard error ≈ 1.04/√m
                    </p>
                </div>
                <div class="panel">
                    <h3>Statistics</h3>
                    <div class="stats">
                        <div class="stat big-stat">
                            <div class="stat-value" id="estimate">0</div>
                            <div class="stat-label">HLL Estimate</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="exact-count">0</div>
                            <div class="stat-label">Exact Count</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="error">0%</div>
                            <div class="stat-label">Error</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="memory">64B</div>
                            <div class="stat-label">Memory Used</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="expected-error">13%</div>
                            <div class="stat-label">Expected Error</div>
                        </div>
                    </div>
                    <div class="error-bar">
                        <div class="error-fill">
                            <div class="error-marker" id="error-marker" style="left: 50%;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: #888; margin-top: 5px;">
                            <span>0%</span>
                            <span>Error</span>
                            <span>20%</span>
                        </div>
                    </div>
                </div>
                <div class="panel">
                    <h3>Registers (max leading zeros)</h3>
                    <div class="register-display" id="registers"></div>
                </div>
                <div class="panel">
                    <h3>Actions</h3>
                    <button onclick="reset()">Reset</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let p = 6; // bits for register index
        let m = 1 << p; // number of registers
        let registers = new Uint8Array(m);
        let exactSet = new Set();
        let history = []; // { added, estimate, exact }

        function simpleHash(str) {
            // Simple 32-bit hash for demonstration
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & 0xFFFFFFFF;
            }
            // Make it positive and mix bits more
            hash = Math.abs(hash);
            hash ^= hash >>> 16;
            hash *= 0x85ebca6b;
            hash ^= hash >>> 13;
            hash *= 0xc2b2ae35;
            hash ^= hash >>> 16;
            return hash >>> 0;
        }

        function countLeadingZeros(value, startBit) {
            // Count leading zeros in the remaining bits after register index
            let count = 1;
            const mask = 1 << (31 - startBit);
            let shifted = value;
            for (let i = startBit; i < 32; i++) {
                if ((shifted & (1 << (31 - i))) !== 0) break;
                count++;
            }
            return Math.min(count, 32 - startBit);
        }

        function add(item) {
            const str = String(item);
            exactSet.add(str);

            const hash = simpleHash(str);
            const registerIndex = hash >>> (32 - p); // First p bits
            const remaining = hash & ((1 << (32 - p)) - 1); // Remaining bits
            const rho = countLeadingZeros(hash << p, 0) + 1;

            registers[registerIndex] = Math.max(registers[registerIndex], rho);

            updateDisplay();
        }

        function estimate() {
            // HyperLogLog estimation formula
            const alpha = getAlpha(m);
            let sum = 0;
            let zeros = 0;

            for (let i = 0; i < m; i++) {
                sum += Math.pow(2, -registers[i]);
                if (registers[i] === 0) zeros++;
            }

            let E = alpha * m * m / sum;

            // Small range correction (linear counting)
            if (E <= 2.5 * m && zeros > 0) {
                E = m * Math.log(m / zeros);
            }

            // Large range correction (for 32-bit hash)
            const pow32 = Math.pow(2, 32);
            if (E > pow32 / 30) {
                E = -pow32 * Math.log(1 - E / pow32);
            }

            return Math.round(E);
        }

        function getAlpha(m) {
            if (m === 16) return 0.673;
            if (m === 32) return 0.697;
            if (m === 64) return 0.709;
            return 0.7213 / (1 + 1.079 / m);
        }

        function addRandomItems(count) {
            for (let i = 0; i < count; i++) {
                const item = 'item_' + Math.random().toString(36).substr(2, 9);
                add(item);
            }
            // Record history point
            history.push({
                added: exactSet.size,
                estimate: estimate(),
                exact: exactSet.size
            });
            draw();
        }

        function reset() {
            p = parseInt(document.getElementById('bits').value);
            m = 1 << p;
            registers = new Uint8Array(m);
            exactSet = new Set();
            history = [];
            document.getElementById('bits-val').textContent = p;
            document.getElementById('registers-val').textContent = m;
            updateDisplay();
            draw();
        }

        function updateDisplay() {
            const est = estimate();
            const exact = exactSet.size;
            const error = exact > 0 ? Math.abs(est - exact) / exact * 100 : 0;
            const expectedError = 104 / Math.sqrt(m);

            document.getElementById('estimate').textContent = est.toLocaleString();
            document.getElementById('exact-count').textContent = exact.toLocaleString();
            document.getElementById('error').textContent = error.toFixed(1) + '%';
            document.getElementById('memory').textContent = (m * 6 / 8).toFixed(0) + 'B'; // 6 bits per register
            document.getElementById('expected-error').textContent = expectedError.toFixed(1) + '%';

            // Error marker
            const markerPos = Math.min(100, error / 20 * 100);
            document.getElementById('error-marker').style.left = markerPos + '%';

            // Update register display
            const regDisplay = document.getElementById('registers');
            regDisplay.innerHTML = '';
            for (let i = 0; i < m; i++) {
                const div = document.createElement('div');
                div.className = 'register';
                const intensity = registers[i] / 32;
                div.style.background = `rgba(243, 156, 18, ${0.1 + intensity * 0.5})`;
                div.innerHTML = `<div class="register-label">${i}</div><div class="register-value">${registers[i]}</div>`;
                regDisplay.appendChild(div);
            }
        }

        document.getElementById('item-input').addEventListener('keypress', e => {
            if (e.key === 'Enter') {
                const value = e.target.value.trim();
                if (value) {
                    add(value);
                    history.push({
                        added: exactSet.size,
                        estimate: estimate(),
                        exact: exactSet.size
                    });
                    draw();
                    e.target.value = '';
                }
            }
        });

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const padding = 60;
            const chartWidth = canvas.width - 2 * padding;
            const chartHeight = canvas.height - 2 * padding;

            // Draw grid
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 10; i++) {
                const x = padding + (i / 10) * chartWidth;
                const y = padding + (i / 10) * chartHeight;
                ctx.beginPath();
                ctx.moveTo(x, padding);
                ctx.lineTo(x, padding + chartHeight);
                ctx.moveTo(padding, y);
                ctx.lineTo(padding + chartWidth, y);
                ctx.stroke();
            }

            // Draw axes
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, padding + chartHeight);
            ctx.lineTo(padding + chartWidth, padding + chartHeight);
            ctx.stroke();

            // Labels
            ctx.fillStyle = '#888';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Items Added', padding + chartWidth / 2, canvas.height - 15);
            ctx.save();
            ctx.translate(15, padding + chartHeight / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Estimated Cardinality', 0, 0);
            ctx.restore();

            if (history.length < 2) {
                ctx.fillStyle = '#666';
                ctx.font = '18px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('Add items to see estimation accuracy over time', canvas.width / 2, canvas.height / 2);
                return;
            }

            const maxItems = Math.max(...history.map(h => h.added));
            const maxEst = Math.max(...history.map(h => Math.max(h.estimate, h.exact))) * 1.1;

            // Draw perfect line (y = x)
            ctx.strokeStyle = 'rgba(46, 204, 113, 0.5)';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            const maxLine = Math.min(maxItems, maxEst);
            ctx.moveTo(padding, padding + chartHeight);
            ctx.lineTo(padding + (maxLine / maxItems) * chartWidth, padding + chartHeight - (maxLine / maxEst) * chartHeight);
            ctx.stroke();
            ctx.setLineDash([]);

            // Draw estimate line
            ctx.strokeStyle = '#f39c12';
            ctx.lineWidth = 3;
            ctx.beginPath();
            for (let i = 0; i < history.length; i++) {
                const h = history[i];
                const x = padding + (h.added / maxItems) * chartWidth;
                const y = padding + chartHeight - (h.estimate / maxEst) * chartHeight;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            // Draw exact count line
            ctx.strokeStyle = '#3498db';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let i = 0; i < history.length; i++) {
                const h = history[i];
                const x = padding + (h.added / maxItems) * chartWidth;
                const y = padding + chartHeight - (h.exact / maxEst) * chartHeight;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            // Draw error bounds
            const expectedError = 1.04 / Math.sqrt(m);
            ctx.fillStyle = 'rgba(46, 204, 113, 0.1)';
            ctx.beginPath();
            for (let i = 0; i < history.length; i++) {
                const h = history[i];
                const x = padding + (h.added / maxItems) * chartWidth;
                const yHigh = padding + chartHeight - (h.exact * (1 + expectedError) / maxEst) * chartHeight;
                if (i === 0) ctx.moveTo(x, yHigh);
                else ctx.lineTo(x, yHigh);
            }
            for (let i = history.length - 1; i >= 0; i--) {
                const h = history[i];
                const x = padding + (h.added / maxItems) * chartWidth;
                const yLow = padding + chartHeight - (h.exact * (1 - expectedError) / maxEst) * chartHeight;
                ctx.lineTo(x, yLow);
            }
            ctx.closePath();
            ctx.fill();

            // Legend
            ctx.font = '12px sans-serif';
            const legendY = padding + 20;
            ctx.fillStyle = '#f39c12';
            ctx.fillRect(padding + 20, legendY, 20, 3);
            ctx.fillText('HLL Estimate', padding + 50, legendY + 5);

            ctx.fillStyle = '#3498db';
            ctx.fillRect(padding + 150, legendY, 20, 3);
            ctx.fillText('Exact Count', padding + 180, legendY + 5);

            ctx.fillStyle = 'rgba(46, 204, 113, 0.5)';
            ctx.fillRect(padding + 280, legendY, 20, 3);
            ctx.fillText('Perfect (y=x)', padding + 310, legendY + 5);

            // Y-axis labels
            ctx.fillStyle = '#888';
            ctx.textAlign = 'right';
            for (let i = 0; i <= 5; i++) {
                const val = Math.round(maxEst * i / 5);
                const y = padding + chartHeight - (i / 5) * chartHeight;
                ctx.fillText(val.toLocaleString(), padding - 10, y + 4);
            }

            // X-axis labels
            ctx.textAlign = 'center';
            for (let i = 0; i <= 5; i++) {
                const val = Math.round(maxItems * i / 5);
                const x = padding + (i / 5) * chartWidth;
                ctx.fillText(val.toLocaleString(), x, padding + chartHeight + 20);
            }
        }

        reset();
    </script>
</body>
</html>
