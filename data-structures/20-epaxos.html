<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPaxos Fast/Slow Paths Visualizer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 25px; }
        h1 {
            font-size: 2rem;
            background: linear-gradient(135deg, #f093fb, #f5576c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        .subtitle { color: #8899a6; font-size: 1rem; }
        .back-link {
            position: fixed; top: 20px; left: 20px;
            color: #f5576c; text-decoration: none;
            font-size: 0.9rem; opacity: 0.8; z-index: 100;
        }
        .back-link:hover { opacity: 1; }
        .controls {
            background: rgba(255,255,255,0.05);
            border-radius: 12px; padding: 15px; margin-bottom: 20px;
            display: flex; flex-wrap: wrap; gap: 15px; align-items: center;
        }
        .control-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 0.85rem; color: #8899a6; }
        select {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px; padding: 8px 12px;
            color: #fff; font-size: 0.9rem;
        }
        button {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            border: none; border-radius: 6px; padding: 10px 20px;
            color: white; font-weight: 600; cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4);
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { background: rgba(255,255,255,0.1); }
        .main-content { display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
        @media (max-width: 1000px) { .main-content { grid-template-columns: 1fr; } }
        .visualization {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px; padding: 20px;
        }
        .replicas-row {
            display: flex; justify-content: space-around;
            margin-bottom: 20px; padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .replica {
            text-align: center; min-width: 120px;
        }
        .replica-node {
            width: 50px; height: 50px; border-radius: 50%;
            background: linear-gradient(135deg, #4ecdc4, #44a3aa);
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; margin: 0 auto 8px;
            transition: all 0.3s;
        }
        .replica-node.active {
            box-shadow: 0 0 20px rgba(240, 147, 251, 0.6);
            background: linear-gradient(135deg, #f093fb, #f5576c);
        }
        .replica-label { font-size: 0.85rem; color: #8899a6; }
        .replica-commands {
            font-size: 0.75rem; margin-top: 5px;
            max-height: 100px; overflow-y: auto;
        }
        .cmd-badge {
            display: inline-block; padding: 2px 6px;
            background: rgba(78, 205, 196, 0.2);
            border-radius: 4px; margin: 2px;
            font-family: monospace;
        }
        .cmd-badge.fast { background: rgba(0, 255, 136, 0.3); }
        .cmd-badge.slow { background: rgba(255, 107, 107, 0.3); }
        .dependency-graph {
            min-height: 300px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            position: relative;
        }
        .dependency-graph canvas {
            width: 100%;
            height: 100%;
        }
        .path-indicator {
            position: absolute; top: 10px; left: 10px;
            padding: 8px 15px; border-radius: 20px;
            font-weight: 600; font-size: 0.9rem;
        }
        .path-indicator.fast {
            background: rgba(0, 255, 136, 0.3);
            color: #00ff88;
            border: 1px solid #00ff88;
        }
        .path-indicator.slow {
            background: rgba(255, 107, 107, 0.3);
            color: #ff6b6b;
            border: 1px solid #ff6b6b;
        }
        .sidebar { display: flex; flex-direction: column; gap: 15px; }
        .panel {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px; padding: 15px;
        }
        .panel h3 { font-size: 1rem; color: #f093fb; margin-bottom: 12px; }
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat {
            background: rgba(0,0,0,0.2);
            border-radius: 8px; padding: 12px;
            text-align: center;
        }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: #fff; }
        .stat-label { font-size: 0.75rem; color: #8899a6; margin-top: 4px; }
        .stat.fast .stat-value { color: #00ff88; }
        .stat.slow .stat-value { color: #ff6b6b; }
        .protocol-info {
            font-size: 0.85rem; line-height: 1.6; color: #8899a6;
        }
        .event-log {
            max-height: 200px; overflow-y: auto;
            font-family: monospace; font-size: 0.8rem;
        }
        .event { padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .event.fast { color: #00ff88; }
        .event.slow { color: #ff6b6b; }
        .event.commit { color: #f093fb; }
        .event.exec { color: #4ecdc4; }
        .legend { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; }
        .legend-dot { width: 12px; height: 12px; border-radius: 50%; }
        .command-list {
            display: flex; flex-wrap: wrap; gap: 8px;
            margin-top: 15px;
        }
        .cmd-node {
            width: 40px; height: 40px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 0.85rem;
            transition: all 0.3s;
        }
        .cmd-node.pending { background: rgba(255,255,255,0.1); border: 2px dashed #8899a6; }
        .cmd-node.preaccepted { background: rgba(255, 217, 61, 0.3); border: 2px solid #ffd93d; }
        .cmd-node.accepted { background: rgba(240, 147, 251, 0.3); border: 2px solid #f093fb; }
        .cmd-node.committed { background: rgba(0, 255, 136, 0.3); border: 2px solid #00ff88; }
        .cmd-node.executed { background: rgba(78, 205, 196, 0.3); border: 2px solid #4ecdc4; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back to Gallery</a>
    <div class="container">
        <header>
            <h1>EPaxos Fast/Slow Paths</h1>
            <p class="subtitle">Leaderless consensus with dependency graphs and conflict resolution</p>
        </header>

        <div class="controls">
            <div class="control-group">
                <label>Command Type</label>
                <select id="cmdType">
                    <option value="read">Read (no conflict)</option>
                    <option value="write">Write (may conflict)</option>
                </select>
            </div>
            <div class="control-group">
                <label>Key</label>
                <select id="cmdKey">
                    <option value="A">Key A</option>
                    <option value="B">Key B</option>
                    <option value="C">Key C</option>
                </select>
            </div>
            <div class="control-group">
                <label>Proposer</label>
                <select id="proposer">
                    <option value="0">Replica R0</option>
                    <option value="1">Replica R1</option>
                    <option value="2">Replica R2</option>
                    <option value="3">Replica R3</option>
                    <option value="4">Replica R4</option>
                </select>
            </div>
            <button id="submitBtn">Submit Command</button>
            <button id="concurrentBtn" class="btn-secondary">Concurrent Commands</button>
            <button id="executeBtn" class="btn-secondary">Execute All</button>
            <button id="resetBtn" class="btn-secondary">Reset</button>
        </div>

        <div class="main-content">
            <div class="visualization">
                <div class="replicas-row" id="replicasRow"></div>
                <div class="dependency-graph" id="depGraph">
                    <canvas id="graphCanvas"></canvas>
                    <div class="path-indicator" id="pathIndicator" style="display:none;"></div>
                </div>
                <div class="command-list" id="commandList"></div>
                <div class="legend">
                    <div class="legend-item"><div class="legend-dot" style="background:#8899a6;"></div>Pending</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#ffd93d;"></div>Pre-accepted</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#f093fb;"></div>Accepted</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#00ff88;"></div>Committed</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#4ecdc4;"></div>Executed</div>
                </div>
            </div>

            <div class="sidebar">
                <div class="panel">
                    <h3>Statistics</h3>
                    <div class="stats">
                        <div class="stat fast">
                            <div class="stat-value" id="fastCount">0</div>
                            <div class="stat-label">Fast Path</div>
                        </div>
                        <div class="stat slow">
                            <div class="stat-value" id="slowCount">0</div>
                            <div class="stat-label">Slow Path</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="totalCmds">0</div>
                            <div class="stat-label">Total Commands</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="execCount">0</div>
                            <div class="stat-label">Executed</div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h3>EPaxos Protocol</h3>
                    <div class="protocol-info">
                        <strong>Fast Path (1 RTT):</strong><br>
                        - No conflicts detected<br>
                        - Super-majority (F + ⌈(F+1)/2⌉) agrees on deps<br>
                        - Direct commit<br><br>
                        <strong>Slow Path (2 RTT):</strong><br>
                        - Conflict detected<br>
                        - Merge dependency chains<br>
                        - Use Paxos Accept phase<br>
                        - F+1 quorum commits
                    </div>
                </div>

                <div class="panel">
                    <h3>Event Log</h3>
                    <div class="event-log" id="eventLog"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class EPaxos {
            constructor() {
                this.numReplicas = 5;
                this.f = 2;
                this.fastQuorum = this.f + Math.ceil((this.f + 1) / 2);
                this.slowQuorum = this.f + 1;
                this.replicas = [];
                this.commands = [];
                this.cmdId = 0;
                this.fastCount = 0;
                this.slowCount = 0;
                this.execCount = 0;
                
                for (let i = 0; i < this.numReplicas; i++) {
                    this.replicas.push({
                        id: i,
                        instances: {},
                        deps: {}
                    });
                }
                this.render();
            }

            async submitCommand(proposer, type, key) {
                const cmdId = ++this.cmdId;
                const cmd = {
                    id: cmdId,
                    proposer: proposer,
                    type: type,
                    key: key,
                    status: 'pending',
                    deps: [],
                    seq: cmdId,
                    path: null
                };
                this.commands.push(cmd);
                this.render();

                this.logEvent('R' + proposer + ' proposes C' + cmdId + ' (' + type + ' ' + key + ')', 'normal');
                await this.sleep(300);

                await this.preAccept(cmd);
            }

            async preAccept(cmd) {
                cmd.status = 'preaccepted';
                this.render();

                const conflicting = this.commands.filter(c => 
                    c.id !== cmd.id && 
                    c.key === cmd.key && 
                    (c.type === 'write' || cmd.type === 'write') &&
                    c.status !== 'pending'
                );

                cmd.deps = conflicting.map(c => c.id);

                this.logEvent('PreAccept C' + cmd.id + ', deps: [' + cmd.deps.join(',') + ']', 'normal');
                await this.sleep(400);

                const responses = [];
                for (let i = 0; i < this.numReplicas; i++) {
                    if (i !== cmd.proposer) {
                        const replicaDeps = this.getReplicaDeps(i, cmd);
                        responses.push({
                            replica: i,
                            deps: replicaDeps,
                            agrees: this.arraysEqual(replicaDeps, cmd.deps)
                        });
                    }
                }

                const agreeing = responses.filter(r => r.agrees).length + 1;
                
                if (agreeing >= this.fastQuorum) {
                    await this.fastCommit(cmd);
                } else {
                    await this.slowPath(cmd, responses);
                }
            }

            getReplicaDeps(replicaId, cmd) {
                const seen = this.commands.filter(c => 
                    c.id !== cmd.id && 
                    c.key === cmd.key && 
                    (c.type === 'write' || cmd.type === 'write') &&
                    c.status !== 'pending'
                );
                if (Math.random() < 0.3 && seen.length > 0) {
                    const shuffled = [...seen].sort(() => Math.random() - 0.5);
                    return shuffled.slice(0, Math.max(1, shuffled.length - 1)).map(c => c.id);
                }
                return seen.map(c => c.id);
            }

            arraysEqual(a, b) {
                if (a.length !== b.length) return false;
                const sortedA = [...a].sort();
                const sortedB = [...b].sort();
                return sortedA.every((v, i) => v === sortedB[i]);
            }

            async fastCommit(cmd) {
                cmd.path = 'fast';
                cmd.status = 'committed';
                this.fastCount++;
                this.logEvent('FAST PATH: C' + cmd.id + ' committed (1 RTT)', 'fast');
                this.showPathIndicator('fast');
                this.render();
            }

            async slowPath(cmd, responses) {
                cmd.path = 'slow';
                cmd.status = 'accepted';
                this.logEvent('Conflict detected for C' + cmd.id + ', taking slow path', 'slow');
                this.render();
                await this.sleep(400);

                const allDeps = new Set(cmd.deps);
                responses.forEach(r => r.deps.forEach(d => allDeps.add(d)));
                cmd.deps = Array.from(allDeps);

                this.logEvent('Merged deps for C' + cmd.id + ': [' + cmd.deps.join(',') + ']', 'slow');
                await this.sleep(400);

                cmd.status = 'committed';
                this.slowCount++;
                this.logEvent('SLOW PATH: C' + cmd.id + ' committed (2 RTT)', 'slow');
                this.showPathIndicator('slow');
                this.render();
            }

            async submitConcurrent() {
                const keys = ['A', 'B', 'C'];
                const key = keys[Math.floor(Math.random() * keys.length)];
                
                const promises = [];
                for (let i = 0; i < 3; i++) {
                    const proposer = i % this.numReplicas;
                    promises.push(this.submitCommand(proposer, 'write', key));
                }
                await Promise.all(promises);
            }

            async executeAll() {
                const committed = this.commands.filter(c => c.status === 'committed');
                if (committed.length === 0) {
                    this.logEvent('No committed commands to execute', 'normal');
                    return;
                }

                const sorted = this.topologicalSort(committed);
                
                for (const cmd of sorted) {
                    cmd.status = 'executed';
                    this.execCount++;
                    this.logEvent('Executed C' + cmd.id + ' (' + cmd.type + ' ' + cmd.key + ')', 'exec');
                    this.render();
                    await this.sleep(300);
                }
            }

            topologicalSort(commands) {
                const cmdMap = new Map(commands.map(c => [c.id, c]));
                const visited = new Set();
                const result = [];

                const visit = (cmd) => {
                    if (visited.has(cmd.id)) return;
                    visited.add(cmd.id);
                    
                    for (const depId of cmd.deps) {
                        const dep = cmdMap.get(depId);
                        if (dep && !visited.has(depId)) {
                            visit(dep);
                        }
                    }
                    result.push(cmd);
                };

                for (const cmd of commands) {
                    visit(cmd);
                }

                return result;
            }

            showPathIndicator(type) {
                const indicator = document.getElementById('pathIndicator');
                indicator.className = 'path-indicator ' + type;
                indicator.textContent = type === 'fast' ? 'Fast Path (1 RTT)' : 'Slow Path (2 RTT)';
                indicator.style.display = 'block';
                setTimeout(() => indicator.style.display = 'none', 2000);
            }

            logEvent(msg, type) {
                const log = document.getElementById('eventLog');
                const entry = document.createElement('div');
                entry.className = 'event ' + type;
                entry.textContent = msg;
                log.insertBefore(entry, log.firstChild);
                while (log.children.length > 30) log.removeChild(log.lastChild);
            }

            render() {
                this.renderReplicas();
                this.renderCommands();
                this.renderGraph();
                this.renderStats();
            }

            renderReplicas() {
                const row = document.getElementById('replicasRow');
                row.innerHTML = this.replicas.map((r, i) => {
                    const cmds = this.commands.filter(c => c.proposer === i);
                    return '<div class="replica">' +
                        '<div class="replica-node">R' + i + '</div>' +
                        '<div class="replica-label">Replica ' + i + '</div>' +
                        '<div class="replica-commands">' +
                            cmds.map(c => '<span class="cmd-badge ' + (c.path || '') + '">C' + c.id + '</span>').join('') +
                        '</div>' +
                    '</div>';
                }).join('');
            }

            renderCommands() {
                const list = document.getElementById('commandList');
                list.innerHTML = this.commands.map(cmd => 
                    '<div class="cmd-node ' + cmd.status + '" title="C' + cmd.id + ': ' + cmd.type + ' ' + cmd.key + '">' +
                        'C' + cmd.id +
                    '</div>'
                ).join('');
            }

            renderGraph() {
                const canvas = document.getElementById('graphCanvas');
                const container = document.getElementById('depGraph');
                canvas.width = container.clientWidth;
                canvas.height = 300;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                const committed = this.commands.filter(c => c.status !== 'pending');
                if (committed.length === 0) return;

                const positions = {};
                const cols = Math.ceil(Math.sqrt(committed.length));
                const cellW = canvas.width / (cols + 1);
                const cellH = canvas.height / (Math.ceil(committed.length / cols) + 1);

                committed.forEach((cmd, i) => {
                    const col = i % cols;
                    const row = Math.floor(i / cols);
                    positions[cmd.id] = {
                        x: cellW * (col + 1),
                        y: cellH * (row + 1)
                    };
                });

                ctx.strokeStyle = 'rgba(240, 147, 251, 0.5)';
                ctx.lineWidth = 2;
                for (const cmd of committed) {
                    const from = positions[cmd.id];
                    for (const depId of cmd.deps) {
                        const to = positions[depId];
                        if (to) {
                            ctx.beginPath();
                            ctx.moveTo(from.x, from.y);
                            ctx.lineTo(to.x, to.y);
                            ctx.stroke();
                            
                            const angle = Math.atan2(from.y - to.y, from.x - to.x);
                            const arrowLen = 10;
                            ctx.beginPath();
                            ctx.moveTo(to.x + 20 * Math.cos(angle), to.y + 20 * Math.sin(angle));
                            ctx.lineTo(
                                to.x + 20 * Math.cos(angle) + arrowLen * Math.cos(angle - Math.PI/6),
                                to.y + 20 * Math.sin(angle) + arrowLen * Math.sin(angle - Math.PI/6)
                            );
                            ctx.moveTo(to.x + 20 * Math.cos(angle), to.y + 20 * Math.sin(angle));
                            ctx.lineTo(
                                to.x + 20 * Math.cos(angle) + arrowLen * Math.cos(angle + Math.PI/6),
                                to.y + 20 * Math.sin(angle) + arrowLen * Math.sin(angle + Math.PI/6)
                            );
                            ctx.stroke();
                        }
                    }
                }

                for (const cmd of committed) {
                    const pos = positions[cmd.id];
                    const colors = {
                        preaccepted: '#ffd93d',
                        accepted: '#f093fb',
                        committed: '#00ff88',
                        executed: '#4ecdc4'
                    };
                    
                    ctx.beginPath();
                    ctx.arc(pos.x, pos.y, 20, 0, Math.PI * 2);
                    ctx.fillStyle = colors[cmd.status] || '#8899a6';
                    ctx.fill();
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    ctx.fillStyle = '#000';
                    ctx.font = 'bold 12px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('C' + cmd.id, pos.x, pos.y);

                    ctx.fillStyle = '#fff';
                    ctx.font = '10px sans-serif';
                    ctx.fillText(cmd.key, pos.x, pos.y + 30);
                }
            }

            renderStats() {
                document.getElementById('fastCount').textContent = this.fastCount;
                document.getElementById('slowCount').textContent = this.slowCount;
                document.getElementById('totalCmds').textContent = this.commands.length;
                document.getElementById('execCount').textContent = this.execCount;
            }

            reset() {
                this.commands = [];
                this.cmdId = 0;
                this.fastCount = 0;
                this.slowCount = 0;
                this.execCount = 0;
                document.getElementById('eventLog').innerHTML = '';
                this.render();
            }

            sleep(ms) {
                return new Promise(r => setTimeout(r, ms));
            }
        }

        const epaxos = new EPaxos();

        document.getElementById('submitBtn').addEventListener('click', () => {
            const proposer = parseInt(document.getElementById('proposer').value);
            const type = document.getElementById('cmdType').value;
            const key = document.getElementById('cmdKey').value;
            epaxos.submitCommand(proposer, type, key);
        });

        document.getElementById('concurrentBtn').addEventListener('click', () => {
            epaxos.submitConcurrent();
        });

        document.getElementById('executeBtn').addEventListener('click', () => {
            epaxos.executeAll();
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            epaxos.reset();
        });

        window.addEventListener('resize', () => epaxos.render());
    </script>
</body>
</html>
