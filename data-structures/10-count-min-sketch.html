<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Count-Min Sketch - CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8e8e8;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { text-align: center; padding: 20px; margin-bottom: 20px; }
        h1 {
            font-size: 2.2rem;
            background: linear-gradient(90deg, #e74c3c, #f39c12);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subtitle { color: #888; }
        .back-link { position: absolute; top: 20px; left: 20px; color: #e74c3c; text-decoration: none; }
        .main-content { display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
        .canvas-container { background: rgba(255,255,255,0.05); border-radius: 16px; padding: 20px; }
        canvas { display: block; margin: 0 auto; background: #0a0a1a; border-radius: 8px; }
        .controls { display: flex; flex-direction: column; gap: 15px; }
        .panel { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 15px; }
        .panel h3 { color: #e74c3c; font-size: 1rem; margin-bottom: 10px; border-bottom: 1px solid rgba(231,76,60,0.3); padding-bottom: 5px; }
        button {
            padding: 10px 15px; background: rgba(231,76,60,0.2);
            border: 1px solid rgba(231,76,60,0.5); border-radius: 6px;
            color: #e74c3c; cursor: pointer; width: 100%; margin-bottom: 8px;
        }
        button:hover { background: rgba(231,76,60,0.3); }
        .control-group { margin-bottom: 12px; }
        .control-group label { display: block; color: #e74c3c; font-size: 0.85rem; margin-bottom: 5px; }
        input[type="range"] {
            width: 100%; height: 6px; -webkit-appearance: none;
            background: rgba(231,76,60,0.2); border-radius: 3px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 16px; height: 16px;
            background: #e74c3c; border-radius: 50%; cursor: pointer;
        }
        input[type="text"] {
            width: 100%; padding: 10px; background: rgba(0,0,0,0.3);
            border: 1px solid rgba(231,76,60,0.3); border-radius: 6px;
            color: #e8e8e8; font-size: 0.9rem;
        }
        .stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .stat { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; text-align: center; }
        .stat-value { font-size: 1rem; color: #e74c3c; font-weight: bold; }
        .stat-label { font-size: 0.7rem; color: #888; }
        .info-text { font-size: 0.85rem; color: #aaa; line-height: 1.6; }
        .query-result {
            background: rgba(0,0,0,0.3); border-radius: 6px; padding: 15px; margin-top: 10px;
        }
        .query-result h4 { color: #f39c12; margin-bottom: 10px; font-size: 0.9rem; }
        .result-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .result-label { color: #888; }
        .result-value { color: #fff; font-weight: bold; }
        .heavy-hitters { max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 6px; padding: 10px; }
        .hitter-item { display: flex; justify-content: space-between; padding: 4px 0; font-size: 0.85rem; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back to Gallery</a>
    <div class="container">
        <header>
            <h1>Count-Min Sketch</h1>
            <p class="subtitle">Probabilistic frequency estimation for data streams</p>
        </header>
        <div class="main-content">
            <div class="canvas-container">
                <canvas id="canvas" width="900" height="550"></canvas>
            </div>
            <div class="controls">
                <div class="panel">
                    <h3>Add Items</h3>
                    <input type="text" id="item-input" placeholder="Type item and press Enter...">
                    <button onclick="addRandomStream(100)" style="margin-top: 10px;">Add 100 Random Items</button>
                    <button onclick="addZipfStream(500)">Add 500 Zipf-Distributed</button>
                </div>
                <div class="panel">
                    <h3>Parameters</h3>
                    <div class="control-group">
                        <label>Width (w): <span id="width-val">20</span></label>
                        <input type="range" id="width" min="10" max="50" value="20" onchange="reset()">
                    </div>
                    <div class="control-group">
                        <label>Depth (d): <span id="depth-val">4</span> hash functions</label>
                        <input type="range" id="depth" min="2" max="8" value="4" onchange="reset()">
                    </div>
                    <p class="info-text">
                        Error probability: 1/e^d = <span id="error-prob">0.018</span><br>
                        Error margin: 2N/w = <span id="error-margin">-</span>
                    </p>
                </div>
                <div class="panel">
                    <h3>Query</h3>
                    <input type="text" id="query-input" placeholder="Query item frequency...">
                    <div class="query-result" id="query-result" style="display: none;">
                        <h4>Query Result</h4>
                        <div class="result-row">
                            <span class="result-label">Item:</span>
                            <span class="result-value" id="q-item">-</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Estimated:</span>
                            <span class="result-value" id="q-estimate">-</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Exact:</span>
                            <span class="result-value" id="q-exact">-</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Overcount:</span>
                            <span class="result-value" id="q-error">-</span>
                        </div>
                    </div>
                </div>
                <div class="panel">
                    <h3>Statistics</h3>
                    <div class="stats">
                        <div class="stat">
                            <div class="stat-value" id="total-items">0</div>
                            <div class="stat-label">Total Items</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="unique-items">0</div>
                            <div class="stat-label">Unique Items</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="memory">80B</div>
                            <div class="stat-label">Sketch Memory</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="exact-memory">0B</div>
                            <div class="stat-label">Exact Memory</div>
                        </div>
                    </div>
                </div>
                <div class="panel">
                    <h3>Heavy Hitters (Top 5)</h3>
                    <div class="heavy-hitters" id="heavy-hitters"></div>
                </div>
                <div class="panel">
                    <h3>Actions</h3>
                    <button onclick="reset()">Reset</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let width = 20;
        let depth = 4;
        let sketch = [];
        let exactCounts = new Map();
        let totalItems = 0;
        let lastQuery = null;
        let lastQueryRow = [];

        // Simple hash functions using different primes
        const primes = [31, 37, 41, 43, 47, 53, 59, 61];

        function hash(str, seed) {
            let h = seed;
            for (let i = 0; i < str.length; i++) {
                h = (h * primes[seed % primes.length] + str.charCodeAt(i)) >>> 0;
            }
            return h % width;
        }

        function reset() {
            width = parseInt(document.getElementById('width').value);
            depth = parseInt(document.getElementById('depth').value);

            sketch = [];
            for (let d = 0; d < depth; d++) {
                sketch.push(new Uint32Array(width));
            }

            exactCounts = new Map();
            totalItems = 0;
            lastQuery = null;
            lastQueryRow = [];

            document.getElementById('width-val').textContent = width;
            document.getElementById('depth-val').textContent = depth;
            document.getElementById('error-prob').textContent = (1 / Math.pow(Math.E, depth)).toFixed(4);

            updateStats();
            draw();
        }

        function add(item) {
            const str = String(item);
            totalItems++;

            exactCounts.set(str, (exactCounts.get(str) || 0) + 1);

            for (let d = 0; d < depth; d++) {
                const idx = hash(str, d);
                sketch[d][idx]++;
            }

            updateStats();
        }

        function query(item) {
            const str = String(item);
            let minCount = Infinity;
            lastQueryRow = [];

            for (let d = 0; d < depth; d++) {
                const idx = hash(str, d);
                lastQueryRow.push(idx);
                minCount = Math.min(minCount, sketch[d][idx]);
            }

            lastQuery = str;
            return minCount;
        }

        function addRandomStream(n) {
            const items = ['apple', 'banana', 'orange', 'grape', 'melon', 'kiwi', 'mango', 'peach'];
            for (let i = 0; i < n; i++) {
                const item = items[Math.floor(Math.random() * items.length)];
                add(item);
            }
            draw();
        }

        function addZipfStream(n) {
            // Zipf distribution - power law
            const items = [];
            for (let i = 1; i <= 20; i++) {
                items.push('item' + i);
            }

            for (let i = 0; i < n; i++) {
                // Zipf: probability proportional to 1/rank
                let sum = 0;
                const rand = Math.random();
                for (let k = 0; k < items.length; k++) {
                    sum += 1 / (k + 1) / 3.6; // H_20 ≈ 3.6
                    if (rand < sum) {
                        add(items[k]);
                        break;
                    }
                }
            }
            draw();
        }

        document.getElementById('item-input').addEventListener('keypress', e => {
            if (e.key === 'Enter') {
                const value = e.target.value.trim();
                if (value) {
                    add(value);
                    draw();
                    e.target.value = '';
                }
            }
        });

        document.getElementById('query-input').addEventListener('keypress', e => {
            if (e.key === 'Enter') {
                const value = e.target.value.trim();
                if (value) {
                    const estimate = query(value);
                    const exact = exactCounts.get(value) || 0;

                    document.getElementById('query-result').style.display = 'block';
                    document.getElementById('q-item').textContent = value;
                    document.getElementById('q-estimate').textContent = estimate;
                    document.getElementById('q-exact').textContent = exact;
                    document.getElementById('q-error').textContent = '+' + (estimate - exact);
                    document.getElementById('q-error').style.color = estimate === exact ? '#2ecc71' : '#f39c12';

                    draw();
                }
            }
        });

        function updateStats() {
            document.getElementById('total-items').textContent = totalItems.toLocaleString();
            document.getElementById('unique-items').textContent = exactCounts.size.toLocaleString();
            document.getElementById('memory').textContent = (width * depth * 4) + 'B';
            document.getElementById('exact-memory').textContent = (exactCounts.size * 20) + 'B'; // Rough estimate

            const errorMargin = totalItems > 0 ? (2 * totalItems / width).toFixed(1) : '-';
            document.getElementById('error-margin').textContent = errorMargin;

            // Update heavy hitters
            const sorted = [...exactCounts.entries()].sort((a, b) => b[1] - a[1]).slice(0, 5);
            const hhDiv = document.getElementById('heavy-hitters');
            hhDiv.innerHTML = '';
            for (const [item, count] of sorted) {
                const estimate = query(item);
                lastQuery = null; // Don't highlight
                const div = document.createElement('div');
                div.className = 'hitter-item';
                div.innerHTML = `<span style="color: #e74c3c;">${item}</span><span>Exact: ${count}, Est: ${estimate}</span>`;
                hhDiv.appendChild(div);
            }
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const padding = 60;
            const cellWidth = (canvas.width - 2 * padding) / width;
            const cellHeight = Math.min(60, (canvas.height - 2 * padding - 100) / depth);
            const startY = padding;

            // Find max count for color scaling
            let maxCount = 1;
            for (let d = 0; d < depth; d++) {
                for (let w = 0; w < width; w++) {
                    maxCount = Math.max(maxCount, sketch[d][w]);
                }
            }

            // Draw sketch matrix
            for (let d = 0; d < depth; d++) {
                // Hash function label
                ctx.fillStyle = '#888';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(`h${d}`, padding - 10, startY + d * (cellHeight + 10) + cellHeight / 2 + 4);

                for (let w = 0; w < width; w++) {
                    const x = padding + w * cellWidth;
                    const y = startY + d * (cellHeight + 10);
                    const count = sketch[d][w];

                    // Cell color based on count
                    const intensity = Math.log(count + 1) / Math.log(maxCount + 1);
                    const isHighlighted = lastQuery && lastQueryRow[d] === w;

                    if (isHighlighted) {
                        ctx.fillStyle = `rgba(46, 204, 113, ${0.3 + intensity * 0.7})`;
                        ctx.strokeStyle = '#2ecc71';
                        ctx.lineWidth = 2;
                    } else {
                        ctx.fillStyle = `rgba(231, 76, 60, ${0.1 + intensity * 0.5})`;
                        ctx.strokeStyle = 'rgba(231, 76, 60, 0.3)';
                        ctx.lineWidth = 1;
                    }

                    ctx.fillRect(x, y, cellWidth - 2, cellHeight);
                    ctx.strokeRect(x, y, cellWidth - 2, cellHeight);

                    // Count value
                    if (count > 0 && cellWidth > 15) {
                        ctx.fillStyle = '#fff';
                        ctx.font = `${Math.min(12, cellWidth / 2)}px sans-serif`;
                        ctx.textAlign = 'center';
                        ctx.fillText(count, x + (cellWidth - 2) / 2, y + cellHeight / 2 + 4);
                    }
                }
            }

            // Column indices
            ctx.fillStyle = '#666';
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'center';
            for (let w = 0; w < width; w += Math.ceil(width / 20)) {
                const x = padding + w * cellWidth + (cellWidth - 2) / 2;
                ctx.fillText(w, x, startY + depth * (cellHeight + 10) + 15);
            }

            // Draw comparison chart below
            const chartY = startY + depth * (cellHeight + 10) + 50;
            const chartHeight = canvas.height - chartY - 40;

            if (exactCounts.size > 0) {
                const sorted = [...exactCounts.entries()].sort((a, b) => b[1] - a[1]).slice(0, 15);
                const barWidth = (canvas.width - 2 * padding) / sorted.length - 5;
                const maxExact = sorted[0][1];

                ctx.fillStyle = '#888';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('Exact vs Estimated Counts (Top Items)', canvas.width / 2, chartY - 10);

                for (let i = 0; i < sorted.length; i++) {
                    const [item, exact] = sorted[i];
                    const estimate = query(item);
                    lastQuery = null;

                    const x = padding + i * (barWidth + 5);
                    const exactHeight = (exact / maxExact) * chartHeight;
                    const estHeight = (estimate / maxExact) * chartHeight;

                    // Exact bar
                    ctx.fillStyle = 'rgba(52, 152, 219, 0.7)';
                    ctx.fillRect(x, chartY + chartHeight - exactHeight, barWidth / 2 - 1, exactHeight);

                    // Estimate bar
                    ctx.fillStyle = 'rgba(231, 76, 60, 0.7)';
                    ctx.fillRect(x + barWidth / 2, chartY + chartHeight - estHeight, barWidth / 2 - 1, estHeight);

                    // Label
                    ctx.fillStyle = '#888';
                    ctx.font = '9px sans-serif';
                    ctx.save();
                    ctx.translate(x + barWidth / 2, chartY + chartHeight + 5);
                    ctx.rotate(Math.PI / 4);
                    ctx.textAlign = 'left';
                    ctx.fillText(item.slice(0, 8), 0, 0);
                    ctx.restore();
                }

                // Legend
                ctx.font = '11px sans-serif';
                ctx.textAlign = 'left';
                ctx.fillStyle = 'rgba(52, 152, 219, 0.7)';
                ctx.fillRect(canvas.width - 150, chartY, 15, 15);
                ctx.fillStyle = '#888';
                ctx.fillText('Exact', canvas.width - 130, chartY + 12);

                ctx.fillStyle = 'rgba(231, 76, 60, 0.7)';
                ctx.fillRect(canvas.width - 150, chartY + 20, 15, 15);
                ctx.fillStyle = '#888';
                ctx.fillText('Estimate', canvas.width - 130, chartY + 32);
            }
        }

        reset();
    </script>
</body>
</html>
