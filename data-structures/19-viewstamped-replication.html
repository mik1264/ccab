<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viewstamped Replication Timeline</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 25px; }
        h1 {
            font-size: 2rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        .subtitle { color: #8899a6; font-size: 1rem; }
        .back-link {
            position: fixed; top: 20px; left: 20px;
            color: #764ba2; text-decoration: none;
            font-size: 0.9rem; opacity: 0.8; z-index: 100;
        }
        .back-link:hover { opacity: 1; }
        .controls {
            background: rgba(255,255,255,0.05);
            border-radius: 12px; padding: 15px; margin-bottom: 20px;
            display: flex; flex-wrap: wrap; gap: 15px; align-items: center;
        }
        button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none; border-radius: 6px; padding: 10px 20px;
            color: white; font-weight: 600; cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4);
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-danger { background: linear-gradient(135deg, #ff6b6b, #ee5a5a); }
        .btn-secondary { background: rgba(255,255,255,0.1); }
        .main-content { display: grid; grid-template-columns: 1fr 320px; gap: 20px; }
        @media (max-width: 1000px) { .main-content { grid-template-columns: 1fr; } }
        .visualization {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px; padding: 20px; min-height: 500px;
        }
        .timeline-container { position: relative; }
        .replicas { display: flex; justify-content: space-around; margin-bottom: 30px; }
        .replica {
            width: 100px; text-align: center; position: relative;
        }
        .replica-node {
            width: 60px; height: 60px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.2rem; margin: 0 auto 8px;
            transition: all 0.3s; position: relative;
        }
        .replica-node.primary {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
            color: #000;
        }
        .replica-node.backup {
            background: linear-gradient(135deg, #4ecdc4, #44a3aa);
            color: #000;
        }
        .replica-node.failed {
            background: linear-gradient(135deg, #ff6b6b, #cc5555);
            opacity: 0.5;
        }
        .replica-node.recovering {
            background: linear-gradient(135deg, #ffd93d, #ccaa00);
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .replica-label { font-size: 0.85rem; color: #8899a6; }
        .replica-status { font-size: 0.75rem; color: #667eea; margin-top: 4px; }
        .view-badge {
            position: absolute; top: -8px; right: -8px;
            background: #764ba2; color: white; font-size: 0.7rem;
            padding: 2px 6px; border-radius: 10px;
        }
        .log-container {
            display: flex; justify-content: space-around;
            gap: 10px; margin-top: 20px;
        }
        .replica-log {
            flex: 1; background: rgba(0,0,0,0.2);
            border-radius: 8px; padding: 10px; min-height: 120px;
        }
        .log-title { font-size: 0.8rem; color: #8899a6; margin-bottom: 8px; }
        .log-entries { display: flex; flex-direction: column; gap: 4px; }
        .log-entry {
            background: rgba(102, 126, 234, 0.2);
            border-radius: 4px; padding: 4px 8px;
            font-family: monospace; font-size: 0.75rem;
            display: flex; justify-content: space-between;
        }
        .log-entry.committed { background: rgba(0, 255, 136, 0.2); }
        .log-entry.pending { background: rgba(255, 217, 61, 0.2); }
        .messages-area {
            position: relative; height: 100px;
            margin: 20px 0; overflow: hidden;
        }
        .message {
            position: absolute;
            padding: 4px 8px; border-radius: 4px;
            font-size: 0.7rem; font-weight: 500;
            animation: flyMessage 1s ease-out forwards;
            white-space: nowrap;
        }
        .message.prepare { background: #667eea; color: white; }
        .message.prepare-ok { background: #00cc6a; color: white; }
        .message.commit { background: #764ba2; color: white; }
        .message.start-view-change { background: #ffd93d; color: #000; }
        .message.do-view-change { background: #ff6b6b; color: white; }
        .message.start-view { background: #00ff88; color: #000; }
        .message.recovery { background: #4ecdc4; color: #000; }
        @keyframes flyMessage {
            0% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; }
        }
        .sidebar { display: flex; flex-direction: column; gap: 15px; }
        .panel {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px; padding: 15px;
        }
        .panel h3 { font-size: 1rem; color: #667eea; margin-bottom: 12px; }
        .state-info { font-size: 0.85rem; line-height: 1.6; }
        .state-row { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .state-label { color: #8899a6; }
        .state-value { color: #fff; font-family: monospace; }
        .phase-indicator {
            background: rgba(102, 126, 234, 0.2);
            border-radius: 8px; padding: 12px; margin-bottom: 15px;
        }
        .phase-name { font-weight: 600; color: #667eea; margin-bottom: 4px; }
        .phase-desc { font-size: 0.85rem; color: #8899a6; }
        .event-log {
            max-height: 200px; overflow-y: auto;
            font-family: monospace; font-size: 0.8rem;
        }
        .event { padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .event.normal { color: #00ff88; }
        .event.view-change { color: #ffd93d; }
        .event.recovery { color: #4ecdc4; }
        .event.failure { color: #ff6b6b; }
        .legend { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .legend-item { display: flex; align-items: center; gap: 5px; font-size: 0.8rem; }
        .legend-color { width: 12px; height: 12px; border-radius: 3px; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Gallery</a>
    <div class="container">
        <header>
            <h1>Viewstamped Replication Timeline</h1>
            <p class="subtitle">Visualize views, primary changes, log replication, and recovery</p>
        </header>

        <div class="controls">
            <button id="sendRequestBtn">Send Client Request</button>
            <button id="failPrimaryBtn" class="btn-danger">Fail Primary</button>
            <button id="recoverBtn" class="btn-secondary">Recover Failed Node</button>
            <button id="autoRunBtn" class="btn-secondary">Auto Demo</button>
            <button id="resetBtn" class="btn-secondary">Reset</button>
            <span style="margin-left: auto; color: #8899a6; font-size: 0.85rem;">
                f=1, 2f+1=3 replicas
            </span>
        </div>

        <div class="main-content">
            <div class="visualization">
                <div class="timeline-container">
                    <div class="replicas" id="replicas"></div>
                    <div class="messages-area" id="messagesArea"></div>
                    <div class="log-container" id="logContainer"></div>
                </div>
                <div class="legend">
                    <div class="legend-item"><div class="legend-color" style="background: #667eea;"></div>PREPARE</div>
                    <div class="legend-item"><div class="legend-color" style="background: #00cc6a;"></div>PREPARE-OK</div>
                    <div class="legend-item"><div class="legend-color" style="background: #764ba2;"></div>COMMIT</div>
                    <div class="legend-item"><div class="legend-color" style="background: #ffd93d;"></div>START-VIEW-CHANGE</div>
                    <div class="legend-item"><div class="legend-color" style="background: #ff6b6b;"></div>DO-VIEW-CHANGE</div>
                    <div class="legend-item"><div class="legend-color" style="background: #00ff88;"></div>START-VIEW</div>
                </div>
            </div>

            <div class="sidebar">
                <div class="panel">
                    <h3>Current Phase</h3>
                    <div class="phase-indicator">
                        <div class="phase-name" id="phaseName">Normal Operation</div>
                        <div class="phase-desc" id="phaseDesc">Primary processing client requests</div>
                    </div>
                    <div class="state-info">
                        <div class="state-row">
                            <span class="state-label">View Number:</span>
                            <span class="state-value" id="viewNumber">0</span>
                        </div>
                        <div class="state-row">
                            <span class="state-label">Primary:</span>
                            <span class="state-value" id="currentPrimary">R0</span>
                        </div>
                        <div class="state-row">
                            <span class="state-label">Op Number:</span>
                            <span class="state-value" id="opNumber">0</span>
                        </div>
                        <div class="state-row">
                            <span class="state-label">Commit Number:</span>
                            <span class="state-value" id="commitNumber">0</span>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h3>Protocol Description</h3>
                    <div class="state-info" id="protocolDesc">
                        <strong>Normal Operation:</strong><br>
                        1. Client sends request to primary<br>
                        2. Primary broadcasts PREPARE<br>
                        3. Backups send PREPARE-OK<br>
                        4. Primary commits & sends COMMIT
                    </div>
                </div>

                <div class="panel">
                    <h3>Event Log</h3>
                    <div class="event-log" id="eventLog"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class ViewstampedReplication {
            constructor() {
                this.numReplicas = 3;
                this.f = 1;
                this.replicas = [];
                this.viewNumber = 0;
                this.opNumber = 0;
                this.commitNumber = 0;
                this.primaryIndex = 0;
                this.phase = 'normal';
                this.messageId = 0;
                this.autoRunning = false;
                this.init();
            }

            init() {
                for (let i = 0; i < this.numReplicas; i++) {
                    this.replicas.push({
                        id: i,
                        status: 'normal',
                        viewNumber: 0,
                        opNumber: 0,
                        commitNumber: 0,
                        log: []
                    });
                }
                this.render();
            }

            getPrimary() {
                return this.viewNumber % this.numReplicas;
            }

            async sendRequest() {
                if (this.phase !== 'normal') {
                    this.logEvent('Cannot send request during ' + this.phase, 'failure');
                    return;
                }

                const primary = this.replicas[this.getPrimary()];
                if (primary.status !== 'normal') {
                    this.logEvent('Primary is not available!', 'failure');
                    await this.startViewChange();
                    return;
                }

                this.opNumber++;
                const op = { n: this.opNumber, v: this.viewNumber, cmd: 'op' + this.opNumber };

                this.logEvent('Client request: ' + op.cmd, 'normal');
                
                primary.log.push({ ...op, status: 'pending' });
                primary.opNumber = this.opNumber;
                this.render();

                await this.sleep(300);

                const backups = this.replicas.filter((r, i) => i !== this.getPrimary() && r.status === 'normal');
                for (const backup of backups) {
                    this.sendMessage(this.getPrimary(), backup.id, 'PREPARE', 'prepare');
                }
                await this.sleep(500);

                for (const backup of backups) {
                    backup.log.push({ ...op, status: 'pending' });
                    backup.opNumber = this.opNumber;
                    this.sendMessage(backup.id, this.getPrimary(), 'PREPARE-OK', 'prepare-ok');
                }
                this.render();
                await this.sleep(500);

                this.commitNumber = this.opNumber;
                primary.commitNumber = this.commitNumber;
                const logEntry = primary.log.find(e => e.n === this.opNumber);
                if (logEntry) logEntry.status = 'committed';

                for (const backup of backups) {
                    this.sendMessage(this.getPrimary(), backup.id, 'COMMIT', 'commit');
                    backup.commitNumber = this.commitNumber;
                    const bEntry = backup.log.find(e => e.n === this.opNumber);
                    if (bEntry) bEntry.status = 'committed';
                }

                this.logEvent('Operation ' + op.cmd + ' committed', 'normal');
                this.render();
            }

            async failPrimary() {
                const primaryIdx = this.getPrimary();
                this.replicas[primaryIdx].status = 'failed';
                this.logEvent('Primary R' + primaryIdx + ' failed!', 'failure');
                this.render();
                await this.sleep(500);
                await this.startViewChange();
            }

            async startViewChange() {
                this.phase = 'view-change';
                this.setPhaseUI('View Change', 'Electing new primary...');
                this.logEvent('Starting view change', 'view-change');

                const normalReplicas = this.replicas.filter(r => r.status === 'normal');
                
                for (const r of normalReplicas) {
                    for (const other of normalReplicas) {
                        if (r.id !== other.id) {
                            this.sendMessage(r.id, other.id, 'SVC', 'start-view-change');
                        }
                    }
                }
                await this.sleep(600);

                this.viewNumber++;
                const newPrimaryIdx = this.viewNumber % this.numReplicas;
                
                while (this.replicas[newPrimaryIdx].status === 'failed') {
                    this.viewNumber++;
                }

                const newPrimary = this.replicas[this.viewNumber % this.numReplicas];

                for (const r of normalReplicas) {
                    if (r.id !== newPrimary.id) {
                        this.sendMessage(r.id, newPrimary.id, 'DVC', 'do-view-change');
                    }
                }
                await this.sleep(600);

                for (const r of normalReplicas) {
                    r.viewNumber = this.viewNumber;
                }

                for (const r of normalReplicas) {
                    if (r.id !== newPrimary.id) {
                        this.sendMessage(newPrimary.id, r.id, 'SV', 'start-view');
                    }
                }
                await this.sleep(500);

                this.phase = 'normal';
                this.setPhaseUI('Normal Operation', 'New primary: R' + newPrimary.id);
                this.logEvent('View ' + this.viewNumber + ' started, new primary: R' + newPrimary.id, 'view-change');
                this.render();
            }

            async recoverNode() {
                const failedReplica = this.replicas.find(r => r.status === 'failed');
                if (!failedReplica) {
                    this.logEvent('No failed replicas to recover', 'normal');
                    return;
                }

                this.phase = 'recovery';
                failedReplica.status = 'recovering';
                this.setPhaseUI('Recovery', 'R' + failedReplica.id + ' recovering...');
                this.logEvent('R' + failedReplica.id + ' starting recovery', 'recovery');
                this.render();

                await this.sleep(500);

                const normalReplicas = this.replicas.filter(r => r.status === 'normal');
                for (const r of normalReplicas) {
                    this.sendMessage(failedReplica.id, r.id, 'RECOVERY', 'recovery');
                }
                await this.sleep(600);

                const primary = this.replicas[this.getPrimary()];
                failedReplica.viewNumber = this.viewNumber;
                failedReplica.opNumber = primary.opNumber;
                failedReplica.commitNumber = primary.commitNumber;
                failedReplica.log = [...primary.log];

                this.sendMessage(primary.id, failedReplica.id, 'RECOVERY-RESP', 'recovery');
                await this.sleep(500);

                failedReplica.status = 'normal';
                this.phase = 'normal';
                this.setPhaseUI('Normal Operation', 'R' + failedReplica.id + ' recovered');
                this.logEvent('R' + failedReplica.id + ' recovered successfully', 'recovery');
                this.render();
            }

            sendMessage(fromId, toId, label, type) {
                const messagesArea = document.getElementById('messagesArea');
                const replicas = document.getElementById('replicas');
                const fromEl = replicas.children[fromId];
                const toEl = replicas.children[toId];
                
                if (!fromEl || !toEl) return;

                const fromRect = fromEl.getBoundingClientRect();
                const toRect = toEl.getBoundingClientRect();
                const areaRect = messagesArea.getBoundingClientRect();

                const startX = fromRect.left + fromRect.width/2 - areaRect.left;
                const endX = toRect.left + toRect.width/2 - areaRect.left;

                const msg = document.createElement('div');
                msg.className = 'message ' + type;
                msg.textContent = label;
                msg.style.left = startX + 'px';
                msg.style.top = '40px';
                msg.style.transform = 'translateX(-50%)';

                const dx = endX - startX;
                msg.style.animation = 'none';
                msg.offsetHeight;
                msg.style.transition = 'left 0.5s ease-out, opacity 0.5s ease-out';
                
                messagesArea.appendChild(msg);
                
                setTimeout(() => {
                    msg.style.left = endX + 'px';
                }, 50);

                setTimeout(() => {
                    msg.style.opacity = '0';
                }, 700);

                setTimeout(() => {
                    msg.remove();
                }, 1000);
            }

            setPhaseUI(name, desc) {
                document.getElementById('phaseName').textContent = name;
                document.getElementById('phaseDesc').textContent = desc;

                const descEl = document.getElementById('protocolDesc');
                if (name.includes('View Change')) {
                    descEl.innerHTML = '<strong>View Change Protocol:</strong><br>' +
                        '1. Replicas detect primary failure<br>' +
                        '2. Send START-VIEW-CHANGE<br>' +
                        '3. Send DO-VIEW-CHANGE to new primary<br>' +
                        '4. New primary sends START-VIEW';
                } else if (name.includes('Recovery')) {
                    descEl.innerHTML = '<strong>Recovery Protocol:</strong><br>' +
                        '1. Recovering replica sends RECOVERY<br>' +
                        '2. Replicas respond with state<br>' +
                        '3. Replica gets log from primary<br>' +
                        '4. Replica rejoins the group';
                } else {
                    descEl.innerHTML = '<strong>Normal Operation:</strong><br>' +
                        '1. Client sends request to primary<br>' +
                        '2. Primary broadcasts PREPARE<br>' +
                        '3. Backups send PREPARE-OK<br>' +
                        '4. Primary commits & sends COMMIT';
                }
            }

            logEvent(msg, type) {
                const log = document.getElementById('eventLog');
                const entry = document.createElement('div');
                entry.className = 'event ' + type;
                entry.textContent = '[' + new Date().toLocaleTimeString() + '] ' + msg;
                log.insertBefore(entry, log.firstChild);
                while (log.children.length > 30) log.removeChild(log.lastChild);
            }

            render() {
                const replicasEl = document.getElementById('replicas');
                const primaryIdx = this.getPrimary();
                
                replicasEl.innerHTML = this.replicas.map((r, i) => {
                    const isPrimary = i === primaryIdx && r.status === 'normal';
                    const statusClass = r.status === 'failed' ? 'failed' : 
                                       r.status === 'recovering' ? 'recovering' :
                                       isPrimary ? 'primary' : 'backup';
                    const statusLabel = r.status === 'failed' ? 'Failed' :
                                       r.status === 'recovering' ? 'Recovering' :
                                       isPrimary ? 'Primary' : 'Backup';
                    return '<div class="replica">' +
                        '<div class="replica-node ' + statusClass + '">' +
                            'R' + i +
                            '<span class="view-badge">v' + r.viewNumber + '</span>' +
                        '</div>' +
                        '<div class="replica-label">' + statusLabel + '</div>' +
                        '<div class="replica-status">op:' + r.opNumber + ' c:' + r.commitNumber + '</div>' +
                    '</div>';
                }).join('');

                const logContainer = document.getElementById('logContainer');
                logContainer.innerHTML = this.replicas.map((r, i) => {
                    return '<div class="replica-log">' +
                        '<div class="log-title">R' + i + ' Log</div>' +
                        '<div class="log-entries">' +
                            r.log.slice(-5).map(e => 
                                '<div class="log-entry ' + e.status + '">' +
                                    '<span>' + e.cmd + '</span>' +
                                    '<span>v' + e.v + ':n' + e.n + '</span>' +
                                '</div>'
                            ).join('') +
                        '</div>' +
                    '</div>';
                }).join('');

                document.getElementById('viewNumber').textContent = this.viewNumber;
                document.getElementById('currentPrimary').textContent = 'R' + this.getPrimary();
                document.getElementById('opNumber').textContent = this.opNumber;
                document.getElementById('commitNumber').textContent = this.commitNumber;
            }

            async autoDemo() {
                if (this.autoRunning) {
                    this.autoRunning = false;
                    return;
                }
                this.autoRunning = true;
                document.getElementById('autoRunBtn').textContent = 'Stop Demo';

                for (let i = 0; i < 3 && this.autoRunning; i++) {
                    await this.sendRequest();
                    await this.sleep(800);
                }

                if (this.autoRunning) {
                    await this.failPrimary();
                    await this.sleep(1000);
                }

                for (let i = 0; i < 2 && this.autoRunning; i++) {
                    await this.sendRequest();
                    await this.sleep(800);
                }

                if (this.autoRunning) {
                    await this.recoverNode();
                    await this.sleep(1000);
                }

                for (let i = 0; i < 2 && this.autoRunning; i++) {
                    await this.sendRequest();
                    await this.sleep(800);
                }

                this.autoRunning = false;
                document.getElementById('autoRunBtn').textContent = 'Auto Demo';
            }

            reset() {
                this.autoRunning = false;
                this.viewNumber = 0;
                this.opNumber = 0;
                this.commitNumber = 0;
                this.phase = 'normal';
                this.replicas = [];
                this.init();
                document.getElementById('eventLog').innerHTML = '';
                document.getElementById('autoRunBtn').textContent = 'Auto Demo';
                this.setPhaseUI('Normal Operation', 'Primary processing client requests');
            }

            sleep(ms) {
                return new Promise(r => setTimeout(r, ms));
            }
        }

        const vr = new ViewstampedReplication();

        document.getElementById('sendRequestBtn').addEventListener('click', () => vr.sendRequest());
        document.getElementById('failPrimaryBtn').addEventListener('click', () => vr.failPrimary());
        document.getElementById('recoverBtn').addEventListener('click', () => vr.recoverNode());
        document.getElementById('autoRunBtn').addEventListener('click', () => vr.autoDemo());
        document.getElementById('resetBtn').addEventListener('click', () => vr.reset());
    </script>
</body>
</html>
