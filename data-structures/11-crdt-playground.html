<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRDT Playground - CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8e8e8;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { text-align: center; padding: 20px; margin-bottom: 20px; }
        h1 {
            font-size: 2.2rem;
            background: linear-gradient(90deg, #1abc9c, #3498db);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subtitle { color: #888; }
        .back-link { position: absolute; top: 20px; left: 20px; color: #1abc9c; text-decoration: none; }

        .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .replica-panel {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 20px;
        }
        .replica-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding-bottom: 10px;
            border-bottom: 2px solid rgba(26,188,156,0.3);
        }
        .replica-title { font-size: 1.2rem; color: #1abc9c; font-weight: bold; }
        .sync-btn {
            padding: 8px 15px; background: rgba(26,188,156,0.2);
            border: 1px solid rgba(26,188,156,0.5); border-radius: 6px;
            color: #1abc9c; cursor: pointer;
        }
        .sync-btn:hover { background: rgba(26,188,156,0.3); }

        .crdt-section { margin-bottom: 20px; }
        .crdt-section h4 { color: #3498db; margin-bottom: 10px; font-size: 0.95rem; }

        .counter-display { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; }
        .counter-value {
            font-size: 2rem; font-weight: bold; color: #fff;
            background: rgba(0,0,0,0.3); padding: 10px 20px; border-radius: 8px;
            min-width: 80px; text-align: center;
        }
        .counter-btns { display: flex; gap: 8px; }
        .counter-btns button {
            padding: 10px 20px; background: rgba(26,188,156,0.2);
            border: 1px solid rgba(26,188,156,0.5); border-radius: 6px;
            color: #1abc9c; cursor: pointer; font-size: 1.2rem;
        }
        .counter-btns button:hover { background: rgba(26,188,156,0.3); }

        .set-display {
            background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px;
            min-height: 60px; display: flex; flex-wrap: wrap; gap: 8px;
        }
        .set-item {
            background: rgba(52,152,219,0.3); padding: 5px 12px;
            border-radius: 15px; font-size: 0.9rem; display: flex;
            align-items: center; gap: 8px;
        }
        .set-item.tombstone { background: rgba(231,76,60,0.3); text-decoration: line-through; }
        .set-item button {
            background: none; border: none; color: #e74c3c;
            cursor: pointer; font-size: 0.8rem; padding: 0 3px;
        }
        .set-input { display: flex; gap: 8px; margin-top: 10px; }
        .set-input input {
            flex: 1; padding: 8px; background: rgba(0,0,0,0.3);
            border: 1px solid rgba(26,188,156,0.3); border-radius: 6px;
            color: #e8e8e8;
        }
        .set-input button {
            padding: 8px 15px; background: rgba(26,188,156,0.2);
            border: 1px solid rgba(26,188,156,0.5); border-radius: 6px;
            color: #1abc9c; cursor: pointer;
        }

        .register-display {
            background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px;
            font-size: 1.1rem;
        }
        .register-meta { font-size: 0.75rem; color: #888; margin-top: 5px; }
        .register-input { margin-top: 10px; }
        .register-input input {
            width: 100%; padding: 8px; background: rgba(0,0,0,0.3);
            border: 1px solid rgba(26,188,156,0.3); border-radius: 6px;
            color: #e8e8e8;
        }

        .controls-panel {
            grid-column: span 2;
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .merge-btn {
            padding: 12px 30px; background: linear-gradient(135deg, #1abc9c, #3498db);
            border: none; border-radius: 8px;
            color: white; cursor: pointer; font-size: 1rem; font-weight: bold;
        }
        .merge-btn:hover { opacity: 0.9; }
        .info-text { font-size: 0.85rem; color: #aaa; max-width: 500px; line-height: 1.5; }
        .history-log {
            grid-column: span 2;
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 20px;
        }
        .history-log h3 { color: #1abc9c; margin-bottom: 10px; }
        .log-entries {
            max-height: 150px; overflow-y: auto;
            background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px;
            font-family: monospace; font-size: 0.8rem;
        }
        .log-entry { padding: 3px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .log-entry.replica-a { color: #1abc9c; }
        .log-entry.replica-b { color: #3498db; }
        .log-entry.merge { color: #f39c12; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back to Gallery</a>
    <div class="container">
        <header>
            <h1>CRDT Playground</h1>
            <p class="subtitle">Conflict-free Replicated Data Types: G-Counter, OR-Set, LWW-Register</p>
        </header>
        <div class="main-content">
            <div class="replica-panel" id="replica-a">
                <div class="replica-header">
                    <span class="replica-title">Replica A</span>
                    <span style="color: #888; font-size: 0.85rem;">Node ID: A</span>
                </div>

                <div class="crdt-section">
                    <h4>G-Counter (Grow-only Counter)</h4>
                    <div class="counter-display">
                        <div class="counter-value" id="counter-a">0</div>
                        <div class="counter-btns">
                            <button onclick="incrementCounter('a')">+1</button>
                            <button onclick="incrementCounter('a', 5)">+5</button>
                        </div>
                    </div>
                </div>

                <div class="crdt-section">
                    <h4>OR-Set (Observed-Remove Set)</h4>
                    <div class="set-display" id="set-a"></div>
                    <div class="set-input">
                        <input type="text" id="set-input-a" placeholder="Add item...">
                        <button onclick="addToSet('a')">Add</button>
                    </div>
                </div>

                <div class="crdt-section">
                    <h4>LWW-Register (Last-Writer-Wins)</h4>
                    <div class="register-display">
                        <span id="register-a">""</span>
                        <div class="register-meta" id="register-meta-a">No value set</div>
                    </div>
                    <div class="register-input">
                        <input type="text" id="register-input-a" placeholder="Set value..." onchange="setRegister('a')">
                    </div>
                </div>
            </div>

            <div class="replica-panel" id="replica-b">
                <div class="replica-header">
                    <span class="replica-title">Replica B</span>
                    <span style="color: #888; font-size: 0.85rem;">Node ID: B</span>
                </div>

                <div class="crdt-section">
                    <h4>G-Counter (Grow-only Counter)</h4>
                    <div class="counter-display">
                        <div class="counter-value" id="counter-b">0</div>
                        <div class="counter-btns">
                            <button onclick="incrementCounter('b')">+1</button>
                            <button onclick="incrementCounter('b', 5)">+5</button>
                        </div>
                    </div>
                </div>

                <div class="crdt-section">
                    <h4>OR-Set (Observed-Remove Set)</h4>
                    <div class="set-display" id="set-b"></div>
                    <div class="set-input">
                        <input type="text" id="set-input-b" placeholder="Add item...">
                        <button onclick="addToSet('b')">Add</button>
                    </div>
                </div>

                <div class="crdt-section">
                    <h4>LWW-Register (Last-Writer-Wins)</h4>
                    <div class="register-display">
                        <span id="register-b">""</span>
                        <div class="register-meta" id="register-meta-b">No value set</div>
                    </div>
                    <div class="register-input">
                        <input type="text" id="register-input-b" placeholder="Set value..." onchange="setRegister('b')">
                    </div>
                </div>
            </div>

            <div class="controls-panel">
                <div class="info-text">
                    CRDTs automatically resolve conflicts during merge. G-Counter uses max of each node's count.
                    OR-Set tracks unique tags per add, removes only observed tags. LWW-Register keeps value with latest timestamp.
                </div>
                <button class="merge-btn" onclick="syncReplicas()">⟷ Sync Replicas</button>
            </div>

            <div class="history-log">
                <h3>Operation Log</h3>
                <div class="log-entries" id="log"></div>
            </div>
        </div>
    </div>
    <script>
        // G-Counter state: map of node -> count
        let gCounterA = { a: 0, b: 0 };
        let gCounterB = { a: 0, b: 0 };

        // OR-Set state: map of element -> Set of unique tags
        // Each tag is { node, timestamp }
        let orSetA = new Map(); // element -> [{node, ts, removed}]
        let orSetB = new Map();
        let tagCounter = 0;

        // LWW-Register state: { value, timestamp, node }
        let registerA = { value: "", timestamp: 0, node: null };
        let registerB = { value: "", timestamp: 0, node: null };

        function log(message, type) {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.insertBefore(entry, logDiv.firstChild);
        }

        // G-Counter
        function incrementCounter(replica, amount = 1) {
            const counter = replica === 'a' ? gCounterA : gCounterB;
            counter[replica] += amount;
            log(`Replica ${replica.toUpperCase()}: increment counter by ${amount}`, 'replica-' + replica);
            updateCounterDisplay();
        }

        function getCounterValue(counter) {
            return Object.values(counter).reduce((a, b) => a + b, 0);
        }

        function updateCounterDisplay() {
            document.getElementById('counter-a').textContent = getCounterValue(gCounterA);
            document.getElementById('counter-b').textContent = getCounterValue(gCounterB);
        }

        // OR-Set
        function addToSet(replica) {
            const input = document.getElementById('set-input-' + replica);
            const value = input.value.trim();
            if (!value) return;

            const set = replica === 'a' ? orSetA : orSetB;
            const tag = { node: replica, ts: ++tagCounter, removed: false };

            if (!set.has(value)) {
                set.set(value, []);
            }
            set.get(value).push(tag);

            log(`Replica ${replica.toUpperCase()}: add "${value}" to set`, 'replica-' + replica);
            input.value = '';
            updateSetDisplay();
        }

        function removeFromSet(replica, value) {
            const set = replica === 'a' ? orSetA : orSetB;
            if (set.has(value)) {
                // Mark all current tags as removed
                const tags = set.get(value);
                tags.forEach(tag => tag.removed = true);
                log(`Replica ${replica.toUpperCase()}: remove "${value}" from set`, 'replica-' + replica);
                updateSetDisplay();
            }
        }

        function getSetElements(set) {
            const elements = [];
            for (const [value, tags] of set) {
                const activeTags = tags.filter(t => !t.removed);
                if (activeTags.length > 0) {
                    elements.push({ value, active: true, tagCount: activeTags.length });
                } else if (tags.length > 0) {
                    elements.push({ value, active: false, tagCount: 0 });
                }
            }
            return elements.filter(e => e.active);
        }

        function updateSetDisplay() {
            ['a', 'b'].forEach(replica => {
                const set = replica === 'a' ? orSetA : orSetB;
                const display = document.getElementById('set-' + replica);
                display.innerHTML = '';

                for (const { value, tagCount } of getSetElements(set)) {
                    const item = document.createElement('div');
                    item.className = 'set-item';
                    item.innerHTML = `${value} <span style="opacity:0.5">(${tagCount})</span>
                        <button onclick="removeFromSet('${replica}', '${value}')">×</button>`;
                    display.appendChild(item);
                }
            });
        }

        // LWW-Register
        function setRegister(replica) {
            const input = document.getElementById('register-input-' + replica);
            const value = input.value;
            const timestamp = Date.now();

            const register = replica === 'a' ? registerA : registerB;
            register.value = value;
            register.timestamp = timestamp;
            register.node = replica;

            log(`Replica ${replica.toUpperCase()}: set register to "${value}"`, 'replica-' + replica);
            updateRegisterDisplay();
        }

        function updateRegisterDisplay() {
            ['a', 'b'].forEach(replica => {
                const register = replica === 'a' ? registerA : registerB;
                document.getElementById('register-' + replica).textContent =
                    register.value ? `"${register.value}"` : '""';
                document.getElementById('register-meta-' + replica).textContent =
                    register.node ? `Set by ${register.node.toUpperCase()} at ${new Date(register.timestamp).toLocaleTimeString()}` : 'No value set';
            });
        }

        // Sync/Merge
        function syncReplicas() {
            log('Syncing replicas...', 'merge');

            // Merge G-Counters (take max of each node's count)
            for (const node of ['a', 'b']) {
                const maxVal = Math.max(gCounterA[node], gCounterB[node]);
                gCounterA[node] = maxVal;
                gCounterB[node] = maxVal;
            }
            log('G-Counter merged: max of each node count', 'merge');

            // Merge OR-Sets (union of all tags)
            const allElements = new Set([...orSetA.keys(), ...orSetB.keys()]);
            for (const element of allElements) {
                const tagsA = orSetA.get(element) || [];
                const tagsB = orSetB.get(element) || [];

                // Merge tags by unique (node, ts) pairs
                const mergedTags = new Map();
                for (const tag of [...tagsA, ...tagsB]) {
                    const key = `${tag.node}-${tag.ts}`;
                    if (mergedTags.has(key)) {
                        // Take removed = true if either is removed
                        mergedTags.get(key).removed = mergedTags.get(key).removed || tag.removed;
                    } else {
                        mergedTags.set(key, { ...tag });
                    }
                }

                const merged = [...mergedTags.values()];
                orSetA.set(element, merged.map(t => ({ ...t })));
                orSetB.set(element, merged.map(t => ({ ...t })));
            }
            log('OR-Set merged: union of all unique tags', 'merge');

            // Merge LWW-Registers (keep latest timestamp)
            if (registerA.timestamp > registerB.timestamp) {
                registerB = { ...registerA };
                log('LWW-Register: kept A\'s value (newer)', 'merge');
            } else if (registerB.timestamp > registerA.timestamp) {
                registerA = { ...registerB };
                log('LWW-Register: kept B\'s value (newer)', 'merge');
            } else {
                log('LWW-Register: same timestamp, no change', 'merge');
            }

            updateCounterDisplay();
            updateSetDisplay();
            updateRegisterDisplay();

            log('Sync complete!', 'merge');
        }

        // Enter key handlers
        document.getElementById('set-input-a').addEventListener('keypress', e => {
            if (e.key === 'Enter') addToSet('a');
        });
        document.getElementById('set-input-b').addEventListener('keypress', e => {
            if (e.key === 'Enter') addToSet('b');
        });

        // Initialize displays
        updateCounterDisplay();
        updateSetDisplay();
        updateRegisterDisplay();
        log('CRDT Playground initialized. Make changes on each replica, then sync!', 'merge');
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
