<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCAB Utilities Test</title>
    <link rel="stylesheet" href="../assets/css/edu-panel.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #1a1a2e;
            color: #eee;
            font-family: -apple-system, sans-serif;
            padding: 20px;
        }
        h1 { margin-bottom: 20px; color: #8A9A5B; }
        h2 { margin: 20px 0 10px; color: #fbbf24; font-size: 1.2em; }
        .test-section {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .pass { color: #10b981; }
        .fail { color: #ef4444; }
        .test-result { margin: 5px 0; font-family: monospace; }
        canvas {
            border: 1px solid #333;
            display: block;
            margin: 10px 0;
        }
        #log {
            background: #000;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>CCAB Utilities Test Suite</h1>

    <div id="results"></div>

    <h2>Canvas Test</h2>
    <canvas id="testCanvas" width="400" height="200"></canvas>

    <h2>Educational Panel Test</h2>
    <div id="edu-container"></div>

    <h2>Console Log</h2>
    <div id="log"></div>

    <script src="../assets/js/demo-utils.js"></script>
    <script src="../assets/js/edu-panel.js"></script>
    <script>
        const results = document.getElementById('results');
        const logEl = document.getElementById('log');
        let passed = 0;
        let failed = 0;

        function log(msg) {
            logEl.innerHTML += msg + '<br>';
            console.log(msg);
        }

        function test(name, fn) {
            const section = document.createElement('div');
            section.className = 'test-result';
            try {
                const result = fn();
                if (result === true || result === undefined) {
                    section.innerHTML = `<span class="pass">✓</span> ${name}`;
                    passed++;
                } else {
                    section.innerHTML = `<span class="fail">✗</span> ${name}: ${result}`;
                    failed++;
                }
            } catch (e) {
                section.innerHTML = `<span class="fail">✗</span> ${name}: ${e.message}`;
                failed++;
                log(`ERROR in ${name}: ${e.message}`);
            }
            results.appendChild(section);
        }

        // ============================================
        // Test Vector2D
        // ============================================
        log('Testing Vector2D...');

        test('Vector2D constructor', () => {
            const v = new Vector2D(3, 4);
            return v.x === 3 && v.y === 4;
        });

        test('Vector2D.add()', () => {
            const v1 = new Vector2D(1, 2);
            const v2 = new Vector2D(3, 4);
            const result = v1.add(v2);
            return result.x === 4 && result.y === 6;
        });

        test('Vector2D.sub()', () => {
            const v1 = new Vector2D(5, 5);
            const v2 = new Vector2D(2, 3);
            const result = v1.sub(v2);
            return result.x === 3 && result.y === 2;
        });

        test('Vector2D.mult()', () => {
            const v = new Vector2D(2, 3);
            const result = v.mult(2);
            return result.x === 4 && result.y === 6;
        });

        test('Vector2D.mag()', () => {
            const v = new Vector2D(3, 4);
            return v.mag() === 5;
        });

        test('Vector2D.normalize()', () => {
            const v = new Vector2D(3, 4);
            const n = v.normalize();
            return Math.abs(n.mag() - 1) < 0.0001;
        });

        test('Vector2D.dist()', () => {
            const v1 = new Vector2D(0, 0);
            const v2 = new Vector2D(3, 4);
            return v1.dist(v2) === 5;
        });

        test('Vector2D.random()', () => {
            const v = Vector2D.random();
            return Math.abs(v.mag() - 1) < 0.0001;
        });

        // ============================================
        // Test GridManager
        // ============================================
        log('Testing GridManager...');

        test('GridManager constructor', () => {
            const grid = new GridManager(10, 10, 5);
            return grid.cols === 10 && grid.rows === 10 && grid.cellSize === 5;
        });

        test('GridManager.set() and get()', () => {
            const grid = new GridManager(10, 10);
            grid.set(5, 5, 1);
            return grid.get(5, 5) === 1 && grid.get(0, 0) === 0;
        });

        test('GridManager.get() out of bounds', () => {
            const grid = new GridManager(10, 10);
            return grid.get(-1, 0) === 0 && grid.get(100, 100) === 0;
        });

        test('GridManager.fill()', () => {
            const grid = new GridManager(5, 5);
            grid.fill(1);
            return grid.get(2, 2) === 1;
        });

        test('GridManager.clear()', () => {
            const grid = new GridManager(5, 5);
            grid.fill(1);
            grid.clear();
            return grid.get(2, 2) === 0;
        });

        test('GridManager.countNeighbors()', () => {
            const grid = new GridManager(5, 5);
            grid.set(1, 1, 1);
            grid.set(1, 2, 1);
            grid.set(2, 1, 1);
            return grid.countNeighbors(2, 2) === 3;
        });

        test('GridManager.clone()', () => {
            const grid = new GridManager(5, 5);
            grid.set(2, 2, 1);
            const clone = grid.clone();
            return clone.get(2, 2) === 1 && clone !== grid;
        });

        // ============================================
        // Test Math Utilities
        // ============================================
        log('Testing Math utilities...');

        test('clamp()', () => {
            return clamp(5, 0, 10) === 5 && clamp(-5, 0, 10) === 0 && clamp(15, 0, 10) === 10;
        });

        test('lerp()', () => {
            return lerp(0, 10, 0.5) === 5 && lerp(0, 10, 0) === 0 && lerp(0, 10, 1) === 10;
        });

        test('map()', () => {
            return map(5, 0, 10, 0, 100) === 50;
        });

        test('random()', () => {
            const r = random(0, 10);
            return r >= 0 && r <= 10;
        });

        test('randomInt()', () => {
            const r = randomInt(0, 10);
            return r >= 0 && r <= 10 && Number.isInteger(r);
        });

        test('degToRad()', () => {
            return Math.abs(degToRad(180) - Math.PI) < 0.0001;
        });

        test('radToDeg()', () => {
            return Math.abs(radToDeg(Math.PI) - 180) < 0.0001;
        });

        // ============================================
        // Test Color Utilities
        // ============================================
        log('Testing Color utilities...');

        test('hslToRgb()', () => {
            const red = hslToRgb(0, 100, 50);
            return red.r === 255 && red.g === 0 && red.b === 0;
        });

        test('rgb()', () => {
            return rgb(255, 0, 0) === 'rgb(255, 0, 0)';
        });

        test('rgb() with alpha', () => {
            return rgb(255, 0, 0, 0.5) === 'rgba(255, 0, 0, 0.5)';
        });

        // ============================================
        // Test Easing
        // ============================================
        log('Testing Easing functions...');

        test('Easing.linear', () => {
            return Easing.linear(0.5) === 0.5;
        });

        test('Easing.easeInQuad', () => {
            return Easing.easeInQuad(0) === 0 && Easing.easeInQuad(1) === 1;
        });

        test('Easing.easeOutCubic', () => {
            const val = Easing.easeOutCubic(0.5);
            return val > 0.5 && val < 1;
        });

        // ============================================
        // Test Noise
        // ============================================
        log('Testing Noise functions...');

        test('Noise.perlin2D()', () => {
            const val = Noise.perlin2D(0.5, 0.5);
            return typeof val === 'number' && val >= -1 && val <= 1;
        });

        test('Noise.fbm()', () => {
            const val = Noise.fbm(0.5, 0.5, 4);
            return typeof val === 'number';
        });

        test('Noise.seed()', () => {
            Noise.seed(12345);
            const v1 = Noise.perlin2D(0.1, 0.1);
            Noise.seed(12345);
            const v2 = Noise.perlin2D(0.1, 0.1);
            return v1 === v2;
        });

        // ============================================
        // Test WebGL Support Detection
        // ============================================
        log('Testing WebGL detection...');

        test('checkWebGLSupport()', () => {
            const result = checkWebGLSupport();
            return typeof result === 'boolean';
        });

        test('checkWebGL2Support()', () => {
            const result = checkWebGL2Support();
            return typeof result === 'boolean';
        });

        // ============================================
        // Test CanvasManager
        // ============================================
        log('Testing CanvasManager...');

        test('CanvasManager constructor', () => {
            const cm = new CanvasManager('testCanvas');
            return cm.ctx !== null && cm.width > 0;
        });

        test('CanvasManager.clear()', () => {
            const cm = new CanvasManager('testCanvas');
            cm.clear('#ff0000');
            return true; // Visual test
        });

        // ============================================
        // Test FPSCounter
        // ============================================
        log('Testing FPSCounter...');

        test('FPSCounter constructor', () => {
            const fps = new FPSCounter({ position: 'bottom-left' });
            fps.start();
            fps.update();
            fps.hide();
            fps.destroy();
            return true;
        });

        // ============================================
        // Test ErrorManager
        // ============================================
        log('Testing ErrorManager...');

        test('ErrorManager constructor', () => {
            const em = new ErrorManager();
            em.show('Test error', 'Details');
            em.hide();
            em.destroy();
            return true;
        });

        // ============================================
        // Test LoadingManager
        // ============================================
        log('Testing LoadingManager...');

        test('LoadingManager constructor', () => {
            const lm = new LoadingManager('Testing...');
            lm.show();
            lm.updateMessage('Updated');
            lm.hide();
            lm.destroy();
            return true;
        });

        // ============================================
        // Test StatsDisplay
        // ============================================
        log('Testing StatsDisplay...');

        test('StatsDisplay constructor', () => {
            const stats = new StatsDisplay(['Test', 'Value'], { position: 'bottom-right' });
            stats.update('Test', 42);
            stats.updateAll({ 'Test': 100, 'Value': 200 });
            stats.hide();
            stats.destroy();
            return true;
        });

        // ============================================
        // Test AnimationLoop
        // ============================================
        log('Testing AnimationLoop...');

        test('AnimationLoop', () => {
            let called = false;
            const loop = new AnimationLoop((dt) => {
                called = true;
                loop.stop();
            });
            loop.start();
            return true; // Async, just verify no errors
        });

        // ============================================
        // Test ExportManager
        // ============================================
        log('Testing ExportManager...');

        test('ExportManager.screenshot exists', () => {
            return typeof ExportManager.screenshot === 'function';
        });

        test('ExportManager.exportJSON exists', () => {
            return typeof ExportManager.exportJSON === 'function';
        });

        test('ExportManager.exportCSV exists', () => {
            return typeof ExportManager.exportCSV === 'function';
        });

        // ============================================
        // Test TouchHandler
        // ============================================
        log('Testing TouchHandler...');

        test('TouchHandler constructor', () => {
            const th = new TouchHandler('testCanvas', {
                onStart: () => {},
                onMove: () => {},
                onEnd: () => {}
            });
            return th.element !== null;
        });

        // ============================================
        // Test ControlsManager
        // ============================================
        log('Testing ControlsManager...');

        test('ControlsManager constructor (no container)', () => {
            const cm = new ControlsManager({
                params: { speed: 1 },
                callbacks: {}
            });
            return cm.params.speed === 1;
        });

        // ============================================
        // Test EduPanel (from edu-panel.js)
        // ============================================
        log('Testing EduPanel...');

        test('EduContentBuilder', () => {
            const builder = new EduContentBuilder({
                title: 'Test',
                theory: { intro: 'Test intro' }
            });
            const html = builder.generateHTML();
            return html.includes('Test') && html.includes('Test intro');
        });

        test('createEduPanel exists', () => {
            return typeof createEduPanel === 'function';
        });

        test('initEduPanels exists', () => {
            return typeof initEduPanels === 'function';
        });

        // ============================================
        // Summary
        // ============================================
        const summary = document.createElement('div');
        summary.className = 'test-section';
        summary.innerHTML = `
            <h2>Summary</h2>
            <p class="pass">Passed: ${passed}</p>
            <p class="fail">Failed: ${failed}</p>
            <p>Total: ${passed + failed}</p>
        `;
        results.insertBefore(summary, results.firstChild);

        log(`\n=== SUMMARY ===`);
        log(`Passed: ${passed}`);
        log(`Failed: ${failed}`);
        log(`Total: ${passed + failed}`);

        // Draw something on canvas to verify it works
        const cm = new CanvasManager('testCanvas');
        cm.clear('#1a1a2e');
        cm.ctx.fillStyle = '#8A9A5B';
        cm.ctx.font = '16px sans-serif';
        cm.ctx.fillText('Canvas working!', 20, 30);

        // Draw grid test
        const grid = new GridManager(20, 10, 15);
        grid.randomize(0.3);
        cm.ctx.save();
        cm.ctx.translate(20, 50);
        grid.draw(cm.ctx, () => '#fbbf24');
        cm.ctx.restore();
    </script>
</body>
</html>
