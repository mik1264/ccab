<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Agent Lifespan vs Wealth Correlation</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #2b5876 0%, #4e4376 100%);
            color: #fff; padding: 20px;
        }
        .container { display: flex; gap: 20px; height: 97vh; }
        .main { flex: 3; display: flex; flex-direction: column; gap: 15px; }
        .sidebar { flex: 1; max-width: 300px; }
        .panel { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 15px; }
        h1 { font-size: 17px; margin-bottom: 10px; color: #64b5f6; }
        canvas { display: block; background: #000; border-radius: 5px; width: 100%; }
        button { padding: 10px; background: #64b5f6; color: #000; border: none; border-radius: 5px; cursor: pointer; margin: 5px 0; font-weight: bold; }
        .stat { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 13px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="main">
            <div class="panel"><h1>Lifespan vs Wealth Scatter Plot</h1><canvas id="scatterCanvas"></canvas></div>
            <div class="panel"><h1>Survival Time by Wealth Class</h1><canvas id="barCanvas"></canvas></div>
        </div>
        <div class="sidebar">
            <div class="panel"><button id="resetBtn">Reset</button><button id="pauseBtn">Pause</button></div>
            <div class="panel"><h1>Stats</h1><div id="stats"></div></div>
            <div class="panel" style="font-size: 12px; line-height: 1.4;">
                Wealthy agents survive longer. High fitness = more food, longer life.
                Poor agents die young from starvation.
            </div>
        </div>
    </div>
    <script>
        const scatterCanvas = document.getElementById('scatterCanvas');
        const barCanvas = document.getElementById('barCanvas');
        const [scatterCtx, barCtx] = [scatterCanvas, barCanvas].map(c => c.getContext('2d'));

        scatterCanvas.width = scatterCanvas.parentElement.clientWidth - 30;
        scatterCanvas.height = 320;
        barCanvas.width = barCanvas.parentElement.clientWidth - 30;
        barCanvas.height = 220;

        const GRID = 45, AGENTS = 200, MAX_GRAIN = 50;
        let paused = false, tick = 0;
        let grain = [], maxCap = [], agents = [], deadAgents = [];

        function init() {
            grain = []; maxCap = [];
            for (let y = 0; y < GRID; y++) {
                grain[y] = []; maxCap[y] = [];
                for (let x = 0; x < GRID; x++) {
                    const d = Math.sqrt((x-22)**2 + (y-22)**2);
                    const cap = Math.floor(MAX_GRAIN * Math.exp(-d*d/180));
                    maxCap[y][x] = cap; grain[y][x] = cap;
                }
            }
            agents = [];
            for (let i = 0; i < AGENTS; i++) {
                agents.push({
                    x: Math.random()*GRID|0, y: Math.random()*GRID|0,
                    wealth: 30, vision: 1 + Math.random()*6|0,
                    metabolism: 1 + Math.random()*4, age: 0, maxAge: 80,
                    avgWealth: 30
                });
            }
            tick = 0; deadAgents = [];
        }

        function update() {
            if (paused) return;
            for (let y = 0; y < GRID; y++) {
                for (let x = 0; x < GRID; x++) {
                    if (grain[y][x] < maxCap[y][x]) grain[y][x]++;
                }
            }
            agents.forEach(a => {
                let [bx,by,bg] = [a.x, a.y, grain[a.y][a.x]];
                for (let dx = -a.vision; dx <= a.vision; dx++) {
                    for (let dy = -a.vision; dy <= a.vision; dy++) {
                        const nx = (a.x+dx+GRID)%GRID, ny = (a.y+dy+GRID)%GRID;
                        if (grain[ny][nx] > bg) { bg = grain[ny][nx]; bx = nx; by = ny; }
                    }
                }
                a.x = bx; a.y = by;
                a.wealth += grain[a.y][a.x];
                grain[a.y][a.x] = 0;
                a.wealth -= a.metabolism;
                a.age++;
                a.avgWealth = (a.avgWealth * (a.age - 1) + a.wealth) / a.age;
            });
            for (let i = agents.length-1; i >= 0; i--) {
                if (agents[i].wealth <= 0 || agents[i].age >= agents[i].maxAge) {
                    deadAgents.push({
                        lifespan: agents[i].age,
                        avgWealth: agents[i].avgWealth,
                        vision: agents[i].vision,
                        metabolism: agents[i].metabolism
                    });
                    if (deadAgents.length > 500) deadAgents.shift();

                    agents[i] = {
                        x: Math.random()*GRID|0, y: Math.random()*GRID|0,
                        wealth: 30, vision: 1 + Math.random()*6|0,
                        metabolism: 1 + Math.random()*4, age: 0, maxAge: 80,
                        avgWealth: 30
                    };
                }
            }
            tick++;
        }

        function draw() {
            // Scatter plot
            scatterCtx.fillStyle = '#000';
            scatterCtx.fillRect(0, 0, scatterCanvas.width, scatterCanvas.height);

            if (deadAgents.length > 0) {
                const pad = 50, w = scatterCanvas.width - 2*pad, h = scatterCanvas.height - 2*pad;
                const maxWealth = Math.max(...deadAgents.map(d => d.avgWealth), 100);
                const maxLifespan = Math.max(...deadAgents.map(d => d.lifespan), 80);

                deadAgents.forEach(d => {
                    const x = pad + (d.avgWealth / maxWealth) * w;
                    const y = scatterCanvas.height - pad - (d.lifespan / maxLifespan) * h;
                    const fitness = d.vision / d.metabolism;
                    const color = fitness > 2.5 ? '#2196f3' : fitness < 1.5 ? '#f44336' : '#4caf50';

                    scatterCtx.fillStyle = color;
                    scatterCtx.globalAlpha = 0.5;
                    scatterCtx.beginPath();
                    scatterCtx.arc(x, y, 3, 0, Math.PI*2);
                    scatterCtx.fill();
                    scatterCtx.globalAlpha = 1;
                });

                // Trend line
                const avgX = deadAgents.reduce((s, d) => s + d.avgWealth, 0) / deadAgents.length;
                const avgY = deadAgents.reduce((s, d) => s + d.lifespan, 0) / deadAgents.length;
                let num = 0, den = 0;
                deadAgents.forEach(d => {
                    num += (d.avgWealth - avgX) * (d.lifespan - avgY);
                    den += (d.avgWealth - avgX) ** 2;
                });
                const slope = num / den;
                const intercept = avgY - slope * avgX;

                scatterCtx.strokeStyle = '#ffeb3b';
                scatterCtx.lineWidth = 2;
                scatterCtx.beginPath();
                scatterCtx.moveTo(pad, scatterCanvas.height - pad - (intercept / maxLifespan) * h);
                scatterCtx.lineTo(pad + w, scatterCanvas.height - pad - ((slope * maxWealth + intercept) / maxLifespan) * h);
                scatterCtx.stroke();

                // Axes
                scatterCtx.strokeStyle = '#fff';
                scatterCtx.strokeRect(pad, pad, w, h);
                scatterCtx.fillStyle = '#fff';
                scatterCtx.font = '12px sans-serif';
                scatterCtx.fillText('Average Wealth', scatterCanvas.width/2-40, scatterCanvas.height-10);
                scatterCtx.save();
                scatterCtx.translate(15, scatterCanvas.height/2);
                scatterCtx.rotate(-Math.PI/2);
                scatterCtx.fillText('Lifespan', -20, 0);
                scatterCtx.restore();

                // Correlation
                const corrNum = deadAgents.reduce((s, d) => s + (d.avgWealth - avgX) * (d.lifespan - avgY), 0);
                const corrDen = Math.sqrt(
                    deadAgents.reduce((s, d) => s + (d.avgWealth - avgX)**2, 0) *
                    deadAgents.reduce((s, d) => s + (d.lifespan - avgY)**2, 0)
                );
                const correlation = corrNum / corrDen;

                scatterCtx.fillText(`Correlation: ${correlation.toFixed(3)}`, pad, 20);
            }

            // Bar chart - lifespan by wealth class
            barCtx.fillStyle = '#000';
            barCtx.fillRect(0, 0, barCanvas.width, barCanvas.height);

            if (deadAgents.length > 10) {
                const poor = deadAgents.filter(d => d.avgWealth < 30);
                const middle = deadAgents.filter(d => d.avgWealth >= 30 && d.avgWealth < 100);
                const rich = deadAgents.filter(d => d.avgWealth >= 100);

                const avgLifespans = [
                    poor.length > 0 ? poor.reduce((s,d) => s+d.lifespan, 0) / poor.length : 0,
                    middle.length > 0 ? middle.reduce((s,d) => s+d.lifespan, 0) / middle.length : 0,
                    rich.length > 0 ? rich.reduce((s,d) => s+d.lifespan, 0) / rich.length : 0
                ];

                const maxLifespan = Math.max(...avgLifespans, 50);
                const pad = 40, w = barCanvas.width - 2*pad, h = barCanvas.height - 2*pad;
                const barWidth = w / 4;

                const colors = ['#f44336', '#4caf50', '#2196f3'];
                const labels = ['Poor\n(<30)', 'Middle\n(30-100)', 'Rich\n(>100)'];

                avgLifespans.forEach((lifespan, i) => {
                    const bh = (lifespan / maxLifespan) * h;
                    const x = pad + (i + 0.5) * barWidth;
                    const y = barCanvas.height - pad - bh;

                    barCtx.fillStyle = colors[i];
                    barCtx.fillRect(x - barWidth/3, y, barWidth*0.7, bh);

                    barCtx.fillStyle = '#fff';
                    barCtx.font = '12px sans-serif';
                    barCtx.textAlign = 'center';
                    barCtx.fillText(lifespan.toFixed(1), x, y - 5);
                    barCtx.fillText(labels[i], x, barCanvas.height - pad + 25);
                });

                barCtx.strokeStyle = '#fff';
                barCtx.strokeRect(pad, pad, w, h);
                barCtx.fillStyle = '#fff';
                barCtx.font = '12px sans-serif';
                barCtx.fillText('Average Lifespan by Wealth Class', pad, 20);
            }

            // Stats
            const avgAge = agents.reduce((s,a) => s+a.age, 0) / agents.length;
            const avgWealth = agents.reduce((s,a) => s+a.wealth, 0) / agents.length;

            document.getElementById('stats').innerHTML = `
                <div class="stat"><span>Tick:</span><span>${tick}</span></div>
                <div class="stat"><span>Deaths Tracked:</span><span>${deadAgents.length}</span></div>
                <div class="stat"><span>Avg Live Age:</span><span>${avgAge.toFixed(1)}</span></div>
                <div class="stat"><span>Avg Wealth:</span><span>${avgWealth.toFixed(1)}</span></div>
            `;
        }

        function animate() { update(); draw(); requestAnimationFrame(animate); }

        document.getElementById('resetBtn').onclick = init;
        document.getElementById('pauseBtn').onclick = () => {
            paused = !paused;
            document.getElementById('pauseBtn').textContent = paused ? 'Resume' : 'Pause';
        };

        init();
        animate();
    </script>
</body>
</html>
