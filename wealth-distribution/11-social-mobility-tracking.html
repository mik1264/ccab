<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Social Mobility Tracking</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #ad5389 0%, #3c1053 100%);
            color: #fff; padding: 20px;
        }
        .container { display: flex; gap: 20px; height: 97vh; }
        .main { flex: 3; display: flex; flex-direction: column; gap: 15px; }
        .sidebar { flex: 1; max-width: 320px; }
        .panel { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 15px; }
        h1 { font-size: 18px; margin-bottom: 10px; }
        canvas { display: block; background: #000; border-radius: 5px; width: 100%; }
        button { padding: 10px; background: #ff6b9d; color: #fff; border: none; border-radius: 5px; cursor: pointer; margin: 5px 0; font-weight: bold; }
        .stat { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 13px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="main">
            <div class="panel"><h1>Wealth Class Transitions</h1><canvas id="transitionCanvas"></canvas></div>
            <div style="display: flex; gap: 15px;">
                <div class="panel" style="flex: 1;"><h1>Current State</h1><canvas id="simCanvas"></canvas></div>
                <div class="panel" style="flex: 1;"><h1>Class Distribution</h1><canvas id="pieCanvas"></canvas></div>
            </div>
        </div>
        <div class="sidebar">
            <div class="panel">
                <button id="resetBtn">Reset</button>
                <button id="pauseBtn">Pause</button>
            </div>
            <div class="panel"><h1>Mobility Stats</h1><div id="stats"></div></div>
            <div class="panel" style="font-size: 12px; line-height: 1.4;">
                Track individual agents' wealth class over time.
                Poor(&lt;30), Middle(30-100), Rich(&gt;100).
                Sankey diagram shows class transitions.
            </div>
        </div>
    </div>
    <script>
        const transCanvas = document.getElementById('transitionCanvas');
        const simCanvas = document.getElementById('simCanvas');
        const pieCanvas = document.getElementById('pieCanvas');
        const [transCtx, simCtx, pieCtx] = [transCanvas, simCanvas, pieCanvas].map(c => c.getContext('2d'));

        transCanvas.width = transCanvas.parentElement.clientWidth - 30;
        transCanvas.height = 250;
        const size = 300;
        simCanvas.width = pieCanvas.width = size;
        simCanvas.height = pieCanvas.height = size;

        const GRID = 45, CELL = size/GRID, AGENTS = 150, MAX_GRAIN = 50;
        let paused = false, tick = 0;
        let grain = [], maxCap = [], agents = [], classHistory = [];

        function init() {
            grain = []; maxCap = [];
            for (let y = 0; y < GRID; y++) {
                grain[y] = []; maxCap[y] = [];
                for (let x = 0; x < GRID; x++) {
                    const d = Math.sqrt((x-22)**2 + (y-22)**2);
                    const cap = Math.floor(MAX_GRAIN * Math.exp(-d*d/180));
                    maxCap[y][x] = cap; grain[y][x] = cap;
                }
            }
            agents = [];
            for (let i = 0; i < AGENTS; i++) {
                agents.push({
                    x: Math.random()*GRID|0, y: Math.random()*GRID|0,
                    wealth: 30, vision: 1 + Math.random()*6|0,
                    metabolism: 1 + Math.random()*4, age: 0, maxAge: 80,
                    id: i, classHist: ['middle']
                });
            }
            tick = 0; classHistory = [];
        }

        function getClass(wealth) {
            if (wealth < 30) return 'poor';
            if (wealth < 100) return 'middle';
            return 'rich';
        }

        function update() {
            if (paused) return;
            for (let y = 0; y < GRID; y++) {
                for (let x = 0; x < GRID; x++) {
                    if (grain[y][x] < maxCap[y][x]) grain[y][x]++;
                }
            }
            agents.forEach(a => {
                let [bx,by,bg] = [a.x, a.y, grain[a.y][a.x]];
                for (let dx = -a.vision; dx <= a.vision; dx++) {
                    for (let dy = -a.vision; dy <= a.vision; dy++) {
                        const nx = (a.x+dx+GRID)%GRID, ny = (a.y+dy+GRID)%GRID;
                        if (grain[ny][nx] > bg) { bg = grain[ny][nx]; bx = nx; by = ny; }
                    }
                }
                a.x = bx; a.y = by;
                a.wealth += grain[a.y][a.x];
                grain[a.y][a.x] = 0;
                a.wealth -= a.metabolism;
                a.age++;

                const newClass = getClass(a.wealth);
                if (tick % 10 === 0) {
                    a.classHist.push(newClass);
                    if (a.classHist.length > 50) a.classHist.shift();
                }
            });
            for (let i = agents.length-1; i >= 0; i--) {
                if (agents[i].wealth <= 0 || agents[i].age >= agents[i].maxAge) {
                    agents[i] = {
                        x: Math.random()*GRID|0, y: Math.random()*GRID|0,
                        wealth: 30, vision: 1 + Math.random()*6|0,
                        metabolism: 1 + Math.random()*4, age: 0, maxAge: 80,
                        id: agents[i].id, classHist: ['middle']
                    };
                }
            }
            tick++;
        }

        function draw() {
            // Sim canvas
            simCtx.clearRect(0, 0, size, size);
            for (let y = 0; y < GRID; y++) {
                for (let x = 0; x < GRID; x++) {
                    const i = grain[y][x] / MAX_GRAIN;
                    simCtx.fillStyle = `rgba(0, ${Math.floor(i*120)}, 0, 0.6)`;
                    simCtx.fillRect(x*CELL, y*CELL, CELL, CELL);
                }
            }
            agents.forEach(a => {
                const color = getClass(a.wealth) === 'poor' ? '#f44336' :
                             getClass(a.wealth) === 'middle' ? '#4caf50' : '#2196f3';
                simCtx.fillStyle = color;
                simCtx.beginPath();
                simCtx.arc(a.x*CELL+CELL/2, a.y*CELL+CELL/2, CELL*0.35, 0, Math.PI*2);
                simCtx.fill();
            });

            // Class distribution pie
            pieCtx.fillStyle = '#000';
            pieCtx.fillRect(0, 0, size, size);

            const poor = agents.filter(a => getClass(a.wealth) === 'poor').length;
            const middle = agents.filter(a => getClass(a.wealth) === 'middle').length;
            const rich = agents.filter(a => getClass(a.wealth) === 'rich').length;

            const cx = size/2, cy = size/2, r = Math.min(size/2.5, 120);
            const angles = [
                poor / AGENTS * Math.PI * 2,
                middle / AGENTS * Math.PI * 2,
                rich / AGENTS * Math.PI * 2
            ];
            const colors = ['#f44336', '#4caf50', '#2196f3'];
            const labels = ['Poor', 'Middle', 'Rich'];
            const counts = [poor, middle, rich];

            let startAngle = -Math.PI/2;
            angles.forEach((angle, i) => {
                pieCtx.fillStyle = colors[i];
                pieCtx.beginPath();
                pieCtx.moveTo(cx, cy);
                pieCtx.arc(cx, cy, r, startAngle, startAngle + angle);
                pieCtx.closePath();
                pieCtx.fill();

                const midAngle = startAngle + angle/2;
                const tx = cx + Math.cos(midAngle) * (r + 30);
                const ty = cy + Math.sin(midAngle) * (r + 30);
                pieCtx.fillStyle = '#fff';
                pieCtx.font = '12px sans-serif';
                pieCtx.textAlign = 'center';
                pieCtx.fillText(`${labels[i]}: ${counts[i]}`, tx, ty);

                startAngle += angle;
            });

            // Transition flow diagram
            transCtx.fillStyle = '#000';
            transCtx.fillRect(0, 0, transCanvas.width, transCanvas.height);

            // Count transitions
            let transitions = {
                'poor->poor': 0, 'poor->middle': 0, 'poor->rich': 0,
                'middle->poor': 0, 'middle->middle': 0, 'middle->rich': 0,
                'rich->poor': 0, 'rich->middle': 0, 'rich->rich': 0
            };

            agents.forEach(a => {
                if (a.classHist.length > 1) {
                    for (let i = 1; i < a.classHist.length; i++) {
                        const key = `${a.classHist[i-1]}->${a.classHist[i]}`;
                        transitions[key]++;
                    }
                }
            });

            const maxTrans = Math.max(...Object.values(transitions), 1);
            const classes = ['poor', 'middle', 'rich'];
            const y = [50, 125, 200];
            const x1 = 80, x2 = transCanvas.width - 80;

            // Draw flows
            classes.forEach((from, i) => {
                classes.forEach((to, j) => {
                    const count = transitions[`${from}->${to}`];
                    if (count > 0) {
                        const width = (count / maxTrans) * 30;
                        transCtx.strokeStyle = `rgba(${colors[j].slice(1,3)}, ${colors[j].slice(3,5)}, ${colors[j].slice(5,7)}, 0.5)`;
                        transCtx.lineWidth = width;
                        transCtx.beginPath();
                        transCtx.moveTo(x1, y[i]);
                        transCtx.lineTo(x2, y[j]);
                        transCtx.stroke();
                    }
                });
            });

            // Draw nodes
            classes.forEach((cls, i) => {
                transCtx.fillStyle = colors[i];
                transCtx.beginPath();
                transCtx.arc(x1, y[i], 20, 0, Math.PI*2);
                transCtx.fill();
                transCtx.beginPath();
                transCtx.arc(x2, y[i], 20, 0, Math.PI*2);
                transCtx.fill();

                transCtx.fillStyle = '#fff';
                transCtx.font = '11px sans-serif';
                transCtx.textAlign = 'right';
                transCtx.fillText(labels[i], x1 - 30, y[i] + 4);
            });

            transCtx.fillStyle = '#fff';
            transCtx.font = '12px sans-serif';
            transCtx.fillText('Class Transitions (flow thickness = frequency)', 10, 20);
            transCtx.fillText('Previous', x1, 30);
            transCtx.fillText('Current', x2, 30);

            // Calculate mobility metrics
            const stayPoor = transitions['poor->poor'];
            const escapePoor = transitions['poor->middle'] + transitions['poor->rich'];
            const mobilityRate = escapePoor / (stayPoor + escapePoor + 1);

            document.getElementById('stats').innerHTML = `
                <div class="stat"><span>Tick:</span><span>${tick}</span></div>
                <div class="stat"><span>Poor:</span><span style="color:#f44336">${poor}</span></div>
                <div class="stat"><span>Middle:</span><span style="color:#4caf50">${middle}</span></div>
                <div class="stat"><span>Rich:</span><span style="color:#2196f3">${rich}</span></div>
                <div class="stat"><span>Upward Mobility:</span><span>${(mobilityRate*100).toFixed(1)}%</span></div>
                <div class="stat"><span>Poor→Middle:</span><span>${transitions['poor->middle']}</span></div>
                <div class="stat"><span>Middle→Rich:</span><span>${transitions['middle->rich']}</span></div>
                <div class="stat"><span>Rich→Poor:</span><span>${transitions['rich->poor']}</span></div>
            `;
        }

        function animate() { update(); draw(); requestAnimationFrame(animate); }

        document.getElementById('resetBtn').onclick = init;
        document.getElementById('pauseBtn').onclick = () => {
            paused = !paused;
            document.getElementById('pauseBtn').textContent = paused ? 'Resume' : 'Pause';
        };

        init();
        animate();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
