<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Population Dynamics & Wealth</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #8e2de2 0%, #4a00e0 100%);
            color: #fff; padding: 20px;
        }
        .container { display: flex; gap: 20px; height: 97vh; }
        .main { flex: 3; display: flex; flex-direction: column; gap: 15px; }
        .panel { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 15px; }
        .sidebar { flex: 1; max-width: 300px; }
        h1 { font-size: 17px; margin-bottom: 10px; }
        canvas { display: block; background: #000; border-radius: 5px; width: 100%; }
        button { padding: 10px; background: #fff; color: #8e2de2; border: none; border-radius: 5px; cursor: pointer; margin: 5px 0; font-weight: bold; }
        .stat { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="main">
            <div class="panel"><h1>Population & Wealth Dynamics</h1><canvas id="mainCanvas"></canvas></div>
            <div class="panel"><h1>Population Time Series</h1><canvas id="popCanvas"></canvas></div>
            <div class="panel"><h1>Death Rate by Wealth Class</h1><canvas id="deathCanvas"></canvas></div>
        </div>
        <div class="sidebar">
            <div class="panel"><button id="resetBtn">Reset</button><button id="pauseBtn">Pause</button></div>
            <div class="panel"><h1>Stats</h1><div id="stats"></div></div>
            <div class="panel" style="font-size: 11px; line-height: 1.3;">
                Population maintained constant by immediate replacement.
                Poor agents die faster, rich agents survive longer.
                Wealth stratifies survival rates.
            </div>
        </div>
    </div>
    <script>
        const mainCanvas = document.getElementById('mainCanvas');
        const popCanvas = document.getElementById('popCanvas');
        const deathCanvas = document.getElementById('deathCanvas');
        const [mainCtx, popCtx, deathCtx] = [mainCanvas, popCanvas, deathCanvas].map(c => c.getContext('2d'));

        mainCanvas.width = mainCanvas.parentElement.clientWidth - 30;
        mainCanvas.height = 280;
        popCanvas.width = popCanvas.parentElement.clientWidth - 30;
        popCanvas.height = 180;
        deathCanvas.width = deathCanvas.parentElement.clientWidth - 30;
        deathCanvas.height = 180;

        const GRID = 50, AGENTS = 200, MAX_GRAIN = 50;
        let paused = false, tick = 0;
        let grain = [], maxCap = [], agents = [];
        let popHistory = [], deathsByClass = {poor: [], middle: [], rich: []};

        function init() {
            grain = []; maxCap = [];
            for (let y = 0; y < GRID; y++) {
                grain[y] = []; maxCap[y] = [];
                for (let x = 0; x < GRID; x++) {
                    const d = Math.sqrt((x-25)**2 + (y-25)**2);
                    const cap = Math.floor(MAX_GRAIN * Math.exp(-d*d/200));
                    maxCap[y][x] = cap; grain[y][x] = cap;
                }
            }
            agents = [];
            for (let i = 0; i < AGENTS; i++) {
                agents.push({
                    x: Math.random()*GRID|0, y: Math.random()*GRID|0,
                    wealth: 30, vision: 1 + Math.random()*6|0,
                    metabolism: 1 + Math.random()*4, age: 0, maxAge: 80
                });
            }
            tick = 0; popHistory = [];
            deathsByClass = {poor: [], middle: [], rich: []};
        }

        function getClass(wealth) {
            if (wealth < 25) return 'poor';
            if (wealth < 90) return 'middle';
            return 'rich';
        }

        function update() {
            if (paused) return;
            for (let y = 0; y < GRID; y++) {
                for (let x = 0; x < GRID; x++) {
                    if (grain[y][x] < maxCap[y][x]) grain[y][x]++;
                }
            }
            agents.forEach(a => {
                let [bx,by,bg] = [a.x, a.y, grain[a.y][a.x]];
                for (let dx = -a.vision; dx <= a.vision; dx++) {
                    for (let dy = -a.vision; dy <= a.vision; dy++) {
                        const nx = (a.x+dx+GRID)%GRID, ny = (a.y+dy+GRID)%GRID;
                        if (grain[ny][nx] > bg) { bg = grain[ny][nx]; bx = nx; by = ny; }
                    }
                }
                a.x = bx; a.y = by;
                a.wealth += grain[a.y][a.x];
                grain[a.y][a.x] = 0;
                a.wealth -= a.metabolism;
                a.age++;
            });

            let deaths = {poor: 0, middle: 0, rich: 0};
            for (let i = agents.length-1; i >= 0; i--) {
                if (agents[i].wealth <= 0 || agents[i].age >= agents[i].maxAge) {
                    deaths[getClass(agents[i].wealth)]++;
                    agents[i] = {
                        x: Math.random()*GRID|0, y: Math.random()*GRID|0,
                        wealth: 30, vision: 1 + Math.random()*6|0,
                        metabolism: 1 + Math.random()*4, age: 0, maxAge: 80
                    };
                }
            }

            const counts = {
                poor: agents.filter(a => getClass(a.wealth) === 'poor').length,
                middle: agents.filter(a => getClass(a.wealth) === 'middle').length,
                rich: agents.filter(a => getClass(a.wealth) === 'rich').length
            };

            popHistory.push(counts);
            if (popHistory.length > 300) popHistory.shift();

            deathsByClass.poor.push(deaths.poor);
            deathsByClass.middle.push(deaths.middle);
            deathsByClass.rich.push(deaths.rich);
            if (deathsByClass.poor.length > 300) {
                deathsByClass.poor.shift();
                deathsByClass.middle.shift();
                deathsByClass.rich.shift();
            }

            tick++;
        }

        function draw() {
            const cellSize = mainCanvas.width / GRID;
            mainCtx.clearRect(0, 0, mainCanvas.width, mainCanvas.height);

            for (let y = 0; y < GRID; y++) {
                for (let x = 0; x < GRID; x++) {
                    const i = grain[y][x] / MAX_GRAIN;
                    mainCtx.fillStyle = `rgba(0, ${Math.floor(i*120)}, 0, 0.6)`;
                    mainCtx.fillRect(x*cellSize, y*cellSize, cellSize, cellSize);
                }
            }
            agents.forEach(a => {
                const color = getClass(a.wealth) === 'poor' ? '#f44336' :
                             getClass(a.wealth) === 'middle' ? '#4caf50' : '#2196f3';
                mainCtx.fillStyle = color;
                mainCtx.beginPath();
                mainCtx.arc(a.x*cellSize+cellSize/2, a.y*cellSize+cellSize/2, cellSize*0.4, 0, Math.PI*2);
                mainCtx.fill();
            });

            // Population time series
            popCtx.fillStyle = '#000';
            popCtx.fillRect(0, 0, popCanvas.width, popCanvas.height);

            if (popHistory.length > 1) {
                const pad = 40, w = popCanvas.width - 2*pad, h = popCanvas.height - 2*pad;

                // Stacked area chart
                popCtx.fillStyle = 'rgba(33, 150, 243, 0.6)';
                popCtx.beginPath();
                popCtx.moveTo(pad, popCanvas.height - pad);
                popHistory.forEach((p, i) => {
                    const x = pad + (i/popHistory.length)*w;
                    const y = popCanvas.height - pad - (p.rich/AGENTS)*h;
                    popCtx.lineTo(x, y);
                });
                popCtx.lineTo(pad + w, popCanvas.height - pad);
                popCtx.fill();

                popCtx.fillStyle = 'rgba(76, 175, 80, 0.6)';
                popCtx.beginPath();
                popCtx.moveTo(pad, popCanvas.height - pad);
                popHistory.forEach((p, i) => {
                    const x = pad + (i/popHistory.length)*w;
                    const y = popCanvas.height - pad - ((p.rich+p.middle)/AGENTS)*h;
                    popCtx.lineTo(x, y);
                });
                popCtx.lineTo(pad + w, popCanvas.height - pad);
                popCtx.fill();

                popCtx.strokeStyle = '#fff';
                popCtx.strokeRect(pad, pad, w, h);
                popCtx.fillStyle = '#fff';
                popCtx.font = '12px sans-serif';
                popCtx.fillText('Population by Class', pad, 20);

                // Legend
                popCtx.fillStyle = '#f44336';
                popCtx.fillRect(pad, popCanvas.height-pad+12, 12, 10);
                popCtx.fillStyle = '#fff';
                popCtx.fillText('Poor', pad+16, popCanvas.height-pad+21);

                popCtx.fillStyle = '#4caf50';
                popCtx.fillRect(pad+60, popCanvas.height-pad+12, 12, 10);
                popCtx.fillStyle = '#fff';
                popCtx.fillText('Middle', pad+76, popCanvas.height-pad+21);

                popCtx.fillStyle = '#2196f3';
                popCtx.fillRect(pad+130, popCanvas.height-pad+12, 12, 10);
                popCtx.fillStyle = '#fff';
                popCtx.fillText('Rich', pad+146, popCanvas.height-pad+21);
            }

            // Death rates
            deathCtx.fillStyle = '#000';
            deathCtx.fillRect(0, 0, deathCanvas.width, deathCanvas.height);

            if (deathsByClass.poor.length > 10) {
                const pad = 40, w = deathCanvas.width - 2*pad, h = deathCanvas.height - 2*pad;
                const maxDeaths = Math.max(
                    Math.max(...deathsByClass.poor),
                    Math.max(...deathsByClass.middle),
                    Math.max(...deathsByClass.rich),
                    1
                );

                deathCtx.strokeStyle = '#f44336';
                deathCtx.lineWidth = 2;
                deathCtx.beginPath();
                deathsByClass.poor.forEach((d, i) => {
                    const x = pad + (i/deathsByClass.poor.length)*w;
                    const y = deathCanvas.height - pad - (d/maxDeaths)*h;
                    i===0 ? deathCtx.moveTo(x,y) : deathCtx.lineTo(x,y);
                });
                deathCtx.stroke();

                deathCtx.strokeStyle = '#4caf50';
                deathCtx.beginPath();
                deathsByClass.middle.forEach((d, i) => {
                    const x = pad + (i/deathsByClass.middle.length)*w;
                    const y = deathCanvas.height - pad - (d/maxDeaths)*h;
                    i===0 ? deathCtx.moveTo(x,y) : deathCtx.lineTo(x,y);
                });
                deathCtx.stroke();

                deathCtx.strokeStyle = '#2196f3';
                deathCtx.beginPath();
                deathsByClass.rich.forEach((d, i) => {
                    const x = pad + (i/deathsByClass.rich.length)*w;
                    const y = deathCanvas.height - pad - (d/maxDeaths)*h;
                    i===0 ? deathCtx.moveTo(x,y) : deathCtx.lineTo(x,y);
                });
                deathCtx.stroke();

                deathCtx.strokeStyle = '#fff';
                deathCtx.strokeRect(pad, pad, w, h);
                deathCtx.fillStyle = '#fff';
                deathCtx.font = '12px sans-serif';
                deathCtx.fillText('Deaths per Tick by Class', pad, 20);
            }

            const poor = agents.filter(a => getClass(a.wealth) === 'poor').length;
            const middle = agents.filter(a => getClass(a.wealth) === 'middle').length;
            const rich = agents.filter(a => getClass(a.wealth) === 'rich').length;

            document.getElementById('stats').innerHTML = `
                <div class="stat"><span>Tick:</span><span>${tick}</span></div>
                <div class="stat"><span>Total Pop:</span><span>${agents.length}</span></div>
                <div class="stat"><span>Poor:</span><span style="color:#f44336">${poor}</span></div>
                <div class="stat"><span>Middle:</span><span style="color:#4caf50">${middle}</span></div>
                <div class="stat"><span>Rich:</span><span style="color:#2196f3">${rich}</span></div>
            `;
        }

        function animate() { update(); draw(); requestAnimationFrame(animate); }

        document.getElementById('resetBtn').onclick = init;
        document.getElementById('pauseBtn').onclick = () => {
            paused = !paused;
            document.getElementById('pauseBtn').textContent = paused ? 'Resume' : 'Pause';
        };

        init();
        animate();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
