<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Wealth Histogram - Pareto Distribution</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #232526 0%, #414345 100%);
            color: #fff; padding: 20px;
        }
        .container { display: flex; gap: 20px; height: 97vh; }
        .main { flex: 3; display: flex; flex-direction: column; gap: 15px; }
        .sidebar { flex: 1; max-width: 320px; }
        .panel { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 15px; }
        h1 { font-size: 18px; margin-bottom: 10px; color: #26c6da; }
        canvas { display: block; background: #000; border-radius: 5px; width: 100%; }
        button { padding: 10px; background: #26c6da; color: #000; border: none; border-radius: 5px; cursor: pointer; margin: 5px 0; font-weight: bold; }
        .stat { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 13px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="main">
            <div class="panel"><h1>Wealth Distribution Histogram</h1><canvas id="histCanvas"></canvas></div>
            <div style="display: flex; gap: 15px;">
                <div class="panel" style="flex: 1;"><h1>Log Scale View</h1><canvas id="logCanvas"></canvas></div>
                <div class="panel" style="flex: 1;"><h1>Cumulative Distribution</h1><canvas id="cdfCanvas"></canvas></div>
            </div>
        </div>
        <div class="sidebar">
            <div class="panel">
                <button id="resetBtn">Reset</button>
                <button id="pauseBtn">Pause</button>
            </div>
            <div class="panel"><h1>Stats</h1><div id="stats"></div></div>
            <div class="panel" style="font-size: 12px; line-height: 1.4;">
                <strong>Pareto's Law:</strong> "80-20 rule" - small percentage owns large share.
                Histogram shows long tail. Log scale reveals power-law structure.
            </div>
        </div>
    </div>
    <script>
        const histCanvas = document.getElementById('histCanvas');
        const logCanvas = document.getElementById('logCanvas');
        const cdfCanvas = document.getElementById('cdfCanvas');
        const [histCtx, logCtx, cdfCtx] = [histCanvas, logCanvas, cdfCanvas].map(c => c.getContext('2d'));

        histCanvas.width = histCanvas.parentElement.clientWidth - 30;
        histCanvas.height = 280;
        logCanvas.width = cdfCanvas.width = logCanvas.parentElement.clientWidth - 30;
        logCanvas.height = cdfCanvas.height = 220;

        const GRID = 45, AGENTS = 300, MAX_GRAIN = 50;
        let paused = false, tick = 0;
        let grain = [], maxCap = [], agents = [];

        function init() {
            grain = []; maxCap = [];
            for (let y = 0; y < GRID; y++) {
                grain[y] = []; maxCap[y] = [];
                for (let x = 0; x < GRID; x++) {
                    const d = Math.sqrt((x-22)**2 + (y-22)**2);
                    const cap = Math.floor(MAX_GRAIN * Math.exp(-d*d/200));
                    maxCap[y][x] = cap; grain[y][x] = cap;
                }
            }
            agents = [];
            for (let i = 0; i < AGENTS; i++) {
                agents.push({
                    x: Math.random()*GRID|0, y: Math.random()*GRID|0,
                    wealth: 30, vision: 1 + Math.random()*6|0,
                    metabolism: 1 + Math.random()*4, age: 0, maxAge: 85
                });
            }
            tick = 0;
        }

        function update() {
            if (paused) return;
            for (let y = 0; y < GRID; y++) {
                for (let x = 0; x < GRID; x++) {
                    if (grain[y][x] < maxCap[y][x]) grain[y][x]++;
                }
            }
            agents.forEach(a => {
                let [bx,by,bg] = [a.x, a.y, grain[a.y][a.x]];
                for (let dx = -a.vision; dx <= a.vision; dx++) {
                    for (let dy = -a.vision; dy <= a.vision; dy++) {
                        const nx = (a.x+dx+GRID)%GRID, ny = (a.y+dy+GRID)%GRID;
                        if (grain[ny][nx] > bg) { bg = grain[ny][nx]; bx = nx; by = ny; }
                    }
                }
                a.x = bx; a.y = by;
                a.wealth += grain[a.y][a.x];
                grain[a.y][a.x] = 0;
                a.wealth -= a.metabolism;
                a.age++;
            });
            for (let i = agents.length-1; i >= 0; i--) {
                if (agents[i].wealth <= 0 || agents[i].age >= agents[i].maxAge) {
                    agents[i] = {
                        x: Math.random()*GRID|0, y: Math.random()*GRID|0,
                        wealth: 30, vision: 1 + Math.random()*6|0,
                        metabolism: 1 + Math.random()*4, age: 0, maxAge: 85
                    };
                }
            }
            tick++;
        }

        function draw() {
            const sorted = [...agents].sort((a,b) => a.wealth - b.wealth);
            const maxWealth = sorted[AGENTS-1].wealth;
            const bins = 30;
            const binSize = maxWealth / bins;
            const counts = new Array(bins).fill(0);

            sorted.forEach(a => {
                const bin = Math.min(Math.floor(a.wealth / binSize), bins-1);
                counts[bin]++;
            });

            // Linear histogram
            histCtx.fillStyle = '#000';
            histCtx.fillRect(0, 0, histCanvas.width, histCanvas.height);

            const maxCount = Math.max(...counts);
            const pad = 50, w = histCanvas.width - 2*pad, h = histCanvas.height - 2*pad;
            const barWidth = w / bins;

            counts.forEach((count, i) => {
                const bh = (count / maxCount) * h;
                const x = pad + i * barWidth;
                const y = histCanvas.height - pad - bh;

                const gradient = histCtx.createLinearGradient(x, y, x, histCanvas.height - pad);
                gradient.addColorStop(0, '#26c6da');
                gradient.addColorStop(1, '#00acc1');
                histCtx.fillStyle = gradient;
                histCtx.fillRect(x, y, barWidth - 2, bh);
            });

            histCtx.strokeStyle = '#fff';
            histCtx.strokeRect(pad, pad, w, h);
            histCtx.fillStyle = '#fff';
            histCtx.font = '12px sans-serif';
            histCtx.fillText('Wealth â†’', histCanvas.width/2, histCanvas.height - 10);
            histCtx.fillText('Count', 10, histCanvas.height/2);

            // Log scale
            logCtx.fillStyle = '#000';
            logCtx.fillRect(0, 0, logCanvas.width, logCanvas.height);

            const logCounts = counts.map(c => Math.log(c + 1));
            const maxLog = Math.max(...logCounts);
            const lw = logCanvas.width - 2*pad, lh = logCanvas.height - 2*pad;
            const lBarWidth = lw / bins;

            logCounts.forEach((logCount, i) => {
                const bh = (logCount / maxLog) * lh;
                const x = pad + i * lBarWidth;
                const y = logCanvas.height - pad - bh;
                logCtx.fillStyle = '#ff6f00';
                logCtx.fillRect(x, y, lBarWidth - 2, bh);
            });

            logCtx.strokeStyle = '#fff';
            logCtx.strokeRect(pad, pad, lw, lh);
            logCtx.fillStyle = '#fff';
            logCtx.font = '11px sans-serif';
            logCtx.fillText('Wealth (log count)', logCanvas.width/2 - 40, logCanvas.height - 5);

            // CDF
            cdfCtx.fillStyle = '#000';
            cdfCtx.fillRect(0, 0, cdfCanvas.width, cdfCanvas.height);

            cdfCtx.strokeStyle = '#7cb342';
            cdfCtx.lineWidth = 2;
            cdfCtx.beginPath();

            let cumulative = 0;
            sorted.forEach((a, i) => {
                cumulative++;
                const x = pad + (a.wealth / maxWealth) * (cdfCanvas.width - 2*pad);
                const y = cdfCanvas.height - pad - (cumulative / AGENTS) * (cdfCanvas.height - 2*pad);
                i === 0 ? cdfCtx.moveTo(x, y) : cdfCtx.lineTo(x, y);
            });
            cdfCtx.stroke();

            cdfCtx.strokeStyle = '#fff';
            cdfCtx.strokeRect(pad, pad, cdfCanvas.width - 2*pad, cdfCanvas.height - 2*pad);
            cdfCtx.fillStyle = '#fff';
            cdfCtx.font = '11px sans-serif';
            cdfCtx.fillText('Cumulative Distribution Function', pad, 20);

            // Stats
            const totalWealth = sorted.reduce((s,a) => s+a.wealth, 0);
            const avgWealth = totalWealth / AGENTS;
            const median = sorted[Math.floor(AGENTS/2)].wealth;
            const mode = counts.indexOf(Math.max(...counts)) * binSize;
            const stdDev = Math.sqrt(sorted.reduce((s,a) => s + (a.wealth - avgWealth)**2, 0) / AGENTS);

            const top10 = sorted.slice(-Math.floor(AGENTS*0.1)).reduce((s,a) => s+a.wealth, 0);
            const bottom50 = sorted.slice(0, Math.floor(AGENTS*0.5)).reduce((s,a) => s+a.wealth, 0);

            document.getElementById('stats').innerHTML = `
                <div class="stat"><span>Tick:</span><span>${tick}</span></div>
                <div class="stat"><span>Mean:</span><span>${avgWealth.toFixed(1)}</span></div>
                <div class="stat"><span>Median:</span><span>${median.toFixed(1)}</span></div>
                <div class="stat"><span>Mode:</span><span>${mode.toFixed(1)}</span></div>
                <div class="stat"><span>Std Dev:</span><span>${stdDev.toFixed(1)}</span></div>
                <div class="stat"><span>Max:</span><span>${maxWealth.toFixed(1)}</span></div>
                <div class="stat"><span>Min:</span><span>${sorted[0].wealth.toFixed(1)}</span></div>
                <div class="stat"><span>Top 10%:</span><span>${(top10/totalWealth*100).toFixed(1)}%</span></div>
                <div class="stat"><span>Bottom 50%:</span><span>${(bottom50/totalWealth*100).toFixed(1)}%</span></div>
            `;
        }

        function animate() { update(); draw(); requestAnimationFrame(animate); }

        document.getElementById('resetBtn').onclick = init;
        document.getElementById('pauseBtn').onclick = () => {
            paused = !paused;
            document.getElementById('pauseBtn').textContent = paused ? 'Resume' : 'Pause';
        };

        init();
        animate();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
