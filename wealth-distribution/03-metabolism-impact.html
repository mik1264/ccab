<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metabolism Impact - Wealth Distribution</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #134e5e 0%, #71b280 100%);
            color: #fff;
            padding: 20px;
        }
        .container { display: flex; gap: 20px; height: 97vh; }
        .main { flex: 2; display: flex; flex-direction: column; gap: 15px; }
        .row { display: flex; gap: 15px; flex: 1; }
        .panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            flex: 1;
        }
        .sidebar { flex: 1; display: flex; flex-direction: column; gap: 15px; max-width: 350px; }
        h1 { font-size: 18px; margin-bottom: 10px; color: #4fc3f7; }
        canvas { display: block; background: #000; border-radius: 5px; width: 100%; }
        button {
            padding: 10px 20px; font-size: 14px; background: #4fc3f7;
            color: #000; border: none; border-radius: 5px; cursor: pointer;
            font-weight: bold; margin-bottom: 8px;
        }
        button:hover { background: #29b6f6; }
        .stat {
            display: flex; justify-content: space-between; padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); font-size: 13px;
        }
        .stat-label { color: #90caf9; }
        .stat-value { font-weight: bold; }
        .description { font-size: 12px; line-height: 1.4; color: #b3d9ff; }
    </style>
</head>
<body>
    <div class="container">
        <div class="main">
            <div class="row">
                <div class="panel">
                    <h1>Low Metabolism (1.0/tick) - Efficient</h1>
                    <canvas id="lowMetabCanvas"></canvas>
                    <div id="lowStats" style="margin-top:10px; font-size:12px;"></div>
                </div>
                <div class="panel">
                    <h1>High Metabolism (5.0/tick) - Inefficient</h1>
                    <canvas id="highMetabCanvas"></canvas>
                    <div id="highStats" style="margin-top:10px; font-size:12px;"></div>
                </div>
            </div>
            <div class="row">
                <div class="panel">
                    <h1>Survival Time Comparison</h1>
                    <canvas id="survivalCanvas"></canvas>
                </div>
            </div>
        </div>
        <div class="sidebar">
            <div class="panel">
                <button id="resetBtn">Reset</button>
                <button id="pauseBtn">Pause</button>
            </div>
            <div class="panel">
                <h1>Stats</h1>
                <div id="compStats"></div>
            </div>
            <div class="panel">
                <p class="description">
                    Identical vision (3 cells), but different energy costs.
                    Low metabolism agents survive longer on same food, accumulating wealth.
                    High metabolism agents burn through resources quickly, struggling to break even.
                    Metabolism = structural disadvantage in resource competition.
                </p>
            </div>
        </div>
    </div>
    <script>
        const lowCanvas = document.getElementById('lowMetabCanvas');
        const highCanvas = document.getElementById('highMetabCanvas');
        const survCanvas = document.getElementById('survivalCanvas');
        const [lowCtx, highCtx, survCtx] = [lowCanvas, highCanvas, survCanvas].map(c => c.getContext('2d'));

        const size = 320;
        [lowCanvas, highCanvas].forEach(c => { c.width = c.height = size; });
        survCanvas.width = survCanvas.parentElement.clientWidth - 30;
        survCanvas.height = 180;

        const GRID = 40, CELL = size/GRID, AGENTS = 80, MAX_GRAIN = 40, VISION = 3;
        let paused = false, tick = 0;

        class Env {
            constructor(metabolism) {
                this.metabolism = metabolism;
                this.grain = []; this.maxCap = [];
                this.agents = [];
                this.deathHistory = [];
                this.initGrain();
                this.initAgents();
            }
            initGrain() {
                for (let y = 0; y < GRID; y++) {
                    this.grain[y] = []; this.maxCap[y] = [];
                    for (let x = 0; x < GRID; x++) {
                        const d = Math.sqrt((x-20)**2 + (y-20)**2);
                        const cap = Math.floor(MAX_GRAIN * Math.exp(-d*d/250));
                        this.maxCap[y][x] = cap;
                        this.grain[y][x] = cap;
                    }
                }
            }
            initAgents() {
                for (let i = 0; i < AGENTS; i++) {
                    this.agents.push({
                        x: Math.random()*GRID|0, y: Math.random()*GRID|0,
                        wealth: 30, age: 0, maxAge: 100
                    });
                }
            }
            update() {
                // Grow
                for (let y = 0; y < GRID; y++) {
                    for (let x = 0; x < GRID; x++) {
                        if (this.grain[y][x] < this.maxCap[y][x]) this.grain[y][x]++;
                    }
                }
                // Agents
                this.agents.forEach(a => {
                    let [bx, by, bg] = [a.x, a.y, this.grain[a.y][a.x]];
                    for (let dx = -VISION; dx <= VISION; dx++) {
                        for (let dy = -VISION; dy <= VISION; dy++) {
                            const nx = (a.x+dx+GRID)%GRID, ny = (a.y+dy+GRID)%GRID;
                            if (this.grain[ny][nx] > bg) {
                                bg = this.grain[ny][nx]; bx = nx; by = ny;
                            }
                        }
                    }
                    a.x = bx; a.y = by;
                    a.wealth += this.grain[a.y][a.x];
                    this.grain[a.y][a.x] = 0;
                    a.wealth -= this.metabolism;
                    a.age++;
                });
                // Replace dead
                let deaths = 0;
                for (let i = this.agents.length-1; i >= 0; i--) {
                    if (this.agents[i].wealth <= 0 || this.agents[i].age >= this.agents[i].maxAge) {
                        deaths++;
                        this.agents[i] = {
                            x: Math.random()*GRID|0, y: Math.random()*GRID|0,
                            wealth: 30, age: 0, maxAge: 100
                        };
                    }
                }
                this.deathHistory.push(deaths);
                if (this.deathHistory.length > 300) this.deathHistory.shift();
            }
            draw(ctx) {
                for (let y = 0; y < GRID; y++) {
                    for (let x = 0; x < GRID; x++) {
                        const i = this.grain[y][x] / MAX_GRAIN;
                        ctx.fillStyle = `rgba(0, ${Math.floor(i*150)}, 0, 0.7)`;
                        ctx.fillRect(x*CELL, y*CELL, CELL, CELL);
                    }
                }
                this.agents.forEach(a => {
                    ctx.fillStyle = a.wealth<20 ? '#f44336' : a.wealth<70 ? '#ffeb3b' : '#4caf50';
                    ctx.beginPath();
                    ctx.arc(a.x*CELL+CELL/2, a.y*CELL+CELL/2, CELL*0.35, 0, Math.PI*2);
                    ctx.fill();
                });
            }
            stats() {
                const total = this.agents.reduce((s,a) => s+a.wealth, 0);
                const avg = total / this.agents.length;
                const max = Math.max(...this.agents.map(a => a.wealth));
                const poor = this.agents.filter(a => a.wealth < 20).length;
                const avgAge = this.agents.reduce((s,a) => s+a.age, 0) / this.agents.length;
                return { avg, max, poor, avgAge };
            }
        }

        let lowEnv = new Env(1.0);
        let highEnv = new Env(5.0);

        function update() {
            if (!paused) { lowEnv.update(); highEnv.update(); tick++; }
        }

        function draw() {
            lowCtx.clearRect(0,0,size,size); highCtx.clearRect(0,0,size,size);
            lowEnv.draw(lowCtx); highEnv.draw(highCtx);

            const ls = lowEnv.stats(), hs = highEnv.stats();
            document.getElementById('lowStats').innerHTML =
                `Avg: ${ls.avg.toFixed(1)} | Max: ${ls.max.toFixed(0)} | Poor: ${ls.poor} | Avg Age: ${ls.avgAge.toFixed(1)}`;
            document.getElementById('highStats').innerHTML =
                `Avg: ${hs.avg.toFixed(1)} | Max: ${hs.max.toFixed(0)} | Poor: ${hs.poor} | Avg Age: ${hs.avgAge.toFixed(1)}`;

            // Survival chart
            survCtx.fillStyle = '#000';
            survCtx.fillRect(0,0,survCanvas.width,survCanvas.height);

            const maxDeaths = Math.max(...lowEnv.deathHistory, ...highEnv.deathHistory, 1);

            survCtx.strokeStyle = '#4caf50'; survCtx.lineWidth = 2;
            survCtx.beginPath();
            lowEnv.deathHistory.forEach((d,i) => {
                const x = (i/300)*survCanvas.width;
                const y = survCanvas.height - (d/maxDeaths)*survCanvas.height*0.9;
                i===0 ? survCtx.moveTo(x,y) : survCtx.lineTo(x,y);
            });
            survCtx.stroke();

            survCtx.strokeStyle = '#f44336';
            survCtx.beginPath();
            highEnv.deathHistory.forEach((d,i) => {
                const x = (i/300)*survCanvas.width;
                const y = survCanvas.height - (d/maxDeaths)*survCanvas.height*0.9;
                i===0 ? survCtx.moveTo(x,y) : survCtx.lineTo(x,y);
            });
            survCtx.stroke();

            survCtx.fillStyle = '#fff'; survCtx.font = '12px sans-serif';
            survCtx.fillText('Deaths Per Tick', 10, 20);
            survCtx.fillStyle = '#4caf50'; survCtx.fillRect(10,30,12,12);
            survCtx.fillStyle = '#fff'; survCtx.fillText('Low Metab', 25,41);
            survCtx.fillStyle = '#f44336'; survCtx.fillRect(10,50,12,12);
            survCtx.fillStyle = '#fff'; survCtx.fillText('High Metab', 25,61);

            document.getElementById('compStats').innerHTML = `
                <div class="stat"><span class="stat-label">Tick:</span><span class="stat-value">${tick}</span></div>
                <div class="stat"><span class="stat-label">Wealth Ratio:</span><span class="stat-value">${(ls.avg/hs.avg).toFixed(2)}x</span></div>
                <div class="stat"><span class="stat-label">Low Avg:</span><span class="stat-value">${ls.avg.toFixed(1)}</span></div>
                <div class="stat"><span class="stat-label">High Avg:</span><span class="stat-value">${hs.avg.toFixed(1)}</span></div>
                <div class="stat"><span class="stat-label">Low Age:</span><span class="stat-value">${ls.avgAge.toFixed(1)}</span></div>
                <div class="stat"><span class="stat-label">High Age:</span><span class="stat-value">${hs.avgAge.toFixed(1)}</span></div>
            `;
        }

        function animate() { update(); draw(); requestAnimationFrame(animate); }

        document.getElementById('resetBtn').onclick = () => {
            lowEnv = new Env(1.0); highEnv = new Env(5.0); tick = 0;
        };
        document.getElementById('pauseBtn').onclick = () => {
            paused = !paused;
            document.getElementById('pauseBtn').textContent = paused ? 'Resume' : 'Pause';
        };

        animate();
    </script>
</body>
</html>
