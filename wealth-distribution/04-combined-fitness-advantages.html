<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Combined Fitness Advantages - Compounding Inequality</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: #fff; padding: 20px;
        }
        .container { display: flex; gap: 20px; height: 97vh; }
        .main { flex: 3; }
        .sidebar { flex: 1; display: flex; flex-direction: column; gap: 15px; max-width: 350px; }
        .panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
        }
        h1 { font-size: 20px; margin-bottom: 10px; color: #3498db; }
        h2 { font-size: 16px; margin-bottom: 10px; color: #e74c3c; }
        canvas { display: block; background: #000; border-radius: 5px; width: 100%; }
        button {
            padding: 10px; font-size: 14px; background: #3498db;
            color: #fff; border: none; border-radius: 5px; cursor: pointer;
            margin-bottom: 8px; font-weight: bold;
        }
        button:hover { background: #2980b9; }
        .stat {
            display: flex; justify-content: space-between; padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); font-size: 13px;
        }
        .stat-label { color: #bdc3c7; }
        .stat-value { font-weight: bold; color: #ecf0f1; }
        .agent-type {
            padding: 10px; margin: 5px 0; border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
        }
        .agent-type h3 { font-size: 14px; margin-bottom: 5px; }
        .agent-type p { font-size: 12px; line-height: 1.4; }
        .advantage { color: #2ecc71; font-weight: bold; }
        .disadvantage { color: #e74c3c; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="main">
            <div class="panel">
                <h1>Combined Fitness: Vision √ó Metabolism</h1>
                <canvas id="mainCanvas"></canvas>
                <div style="margin-top: 15px; display: flex; gap: 15px;">
                    <canvas id="scatter" style="flex: 1; height: 250px;"></canvas>
                    <canvas id="histogram" style="flex: 1; height: 250px;"></canvas>
                </div>
            </div>
        </div>
        <div class="sidebar">
            <div class="panel">
                <button id="resetBtn">Reset</button>
                <button id="pauseBtn">Pause</button>
            </div>
            <div class="panel">
                <h2>Population Stats</h2>
                <div id="stats"></div>
            </div>
            <div class="panel">
                <h2>Agent Types</h2>
                <div class="agent-type" style="background: rgba(33, 150, 243, 0.3);">
                    <h3>üèÜ Elite (Blue)</h3>
                    <p><span class="advantage">High vision + Low metabolism</span>
                    <br>Find rich patches, burn slowly. Dominate!</p>
                </div>
                <div class="agent-type" style="background: rgba(76, 175, 80, 0.3);">
                    <h3>‚öñÔ∏è Mixed (Green)</h3>
                    <p>Average traits. Survive but don't thrive.</p>
                </div>
                <div class="agent-type" style="background: rgba(244, 67, 54, 0.3);">
                    <h3>üíÄ Struggling (Red)</h3>
                    <p><span class="disadvantage">Low vision + High metabolism</span>
                    <br>Can't find food, burn fast. Die young.</p>
                </div>
            </div>
        </div>
    </div>
    <script>
        const canvas = document.getElementById('mainCanvas');
        const scatterCanvas = document.getElementById('scatter');
        const histCanvas = document.getElementById('histogram');
        const ctx = canvas.getContext('2d');
        const scatterCtx = scatterCanvas.getContext('2d');
        const histCtx = histCanvas.getContext('2d');

        canvas.width = canvas.parentElement.clientWidth - 30;
        canvas.height = canvas.width * 0.65;
        scatterCanvas.width = scatterCanvas.parentElement.clientWidth / 2 - 10;
        scatterCanvas.height = 250;
        histCanvas.width = histCanvas.parentElement.clientWidth / 2 - 10;
        histCanvas.height = 250;

        const GRID = 50, CELL = canvas.width/GRID, AGENTS = 200, MAX_GRAIN = 50;
        let paused = false, tick = 0;

        let grain = [], maxCap = [], agents = [];

        function init() {
            // Grain with two peaks
            grain = []; maxCap = [];
            for (let y = 0; y < GRID; y++) {
                grain[y] = []; maxCap[y] = [];
                for (let x = 0; x < GRID; x++) {
                    const d1 = Math.sqrt((x-15)**2 + (y-15)**2);
                    const d2 = Math.sqrt((x-35)**2 + (y-35)**2);
                    const cap = Math.floor(MAX_GRAIN * (Math.exp(-d1*d1/180) + Math.exp(-d2*d2/180)));
                    maxCap[y][x] = cap;
                    grain[y][x] = cap;
                }
            }

            // Agents with heterogeneous traits
            agents = [];
            for (let i = 0; i < AGENTS; i++) {
                agents.push({
                    x: Math.random()*GRID|0,
                    y: Math.random()*GRID|0,
                    wealth: 30 + Math.random()*20,
                    vision: 1 + Math.random()*6|0, // 1-6
                    metabolism: 1 + Math.random()*4, // 1-5
                    age: 0,
                    maxAge: 70 + Math.random()*50|0
                });
            }
            tick = 0;
        }

        function update() {
            if (paused) return;

            // Grow grain
            for (let y = 0; y < GRID; y++) {
                for (let x = 0; x < GRID; x++) {
                    if (grain[y][x] < maxCap[y][x]) grain[y][x]++;
                }
            }

            // Agent behavior
            agents.forEach(a => {
                // Look
                let [bx,by,bg] = [a.x, a.y, grain[a.y][a.x]];
                for (let dx = -a.vision; dx <= a.vision; dx++) {
                    for (let dy = -a.vision; dy <= a.vision; dy++) {
                        const nx = (a.x+dx+GRID)%GRID, ny = (a.y+dy+GRID)%GRID;
                        if (grain[ny][nx] > bg) { bg = grain[ny][nx]; bx = nx; by = ny; }
                    }
                }
                a.x = bx; a.y = by;
                // Harvest & consume
                a.wealth += grain[a.y][a.x];
                grain[a.y][a.x] = 0;
                a.wealth -= a.metabolism;
                a.age++;
            });

            // Replace dead
            for (let i = agents.length-1; i >= 0; i--) {
                if (agents[i].wealth <= 0 || agents[i].age >= agents[i].maxAge) {
                    agents[i] = {
                        x: Math.random()*GRID|0, y: Math.random()*GRID|0,
                        wealth: 30 + Math.random()*20,
                        vision: 1 + Math.random()*6|0,
                        metabolism: 1 + Math.random()*4,
                        age: 0, maxAge: 70 + Math.random()*50|0
                    };
                }
            }
            tick++;
        }

        function getColor(a) {
            // Fitness = vision / metabolism
            const fitness = a.vision / a.metabolism;
            if (fitness > 3) return '#2196f3'; // Elite
            if (fitness < 1) return '#f44336'; // Struggling
            return '#4caf50'; // Mixed
        }

        function draw() {
            // Main canvas - grain + agents
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let y = 0; y < GRID; y++) {
                for (let x = 0; x < GRID; x++) {
                    const i = grain[y][x] / MAX_GRAIN;
                    ctx.fillStyle = `rgba(0, ${Math.floor(i*150)}, 0, 0.7)`;
                    ctx.fillRect(x*CELL, y*CELL, CELL, CELL);
                }
            }
            agents.forEach(a => {
                ctx.fillStyle = getColor(a);
                ctx.globalAlpha = 0.9;
                ctx.beginPath();
                ctx.arc(a.x*CELL+CELL/2, a.y*CELL+CELL/2, CELL*0.4, 0, Math.PI*2);
                ctx.fill();
                ctx.globalAlpha = 1;
            });

            // Scatter plot - vision vs metabolism, colored by wealth
            scatterCtx.fillStyle = '#000';
            scatterCtx.fillRect(0, 0, scatterCanvas.width, scatterCanvas.height);

            const pad = 40, w = scatterCanvas.width-2*pad, h = scatterCanvas.height-2*pad;

            agents.forEach(a => {
                const x = pad + (a.vision/7)*w;
                const y = scatterCanvas.height - pad - (a.metabolism/5)*h;
                const size = Math.min(a.wealth/10, 8);
                scatterCtx.fillStyle = getColor(a);
                scatterCtx.beginPath();
                scatterCtx.arc(x, y, size, 0, Math.PI*2);
                scatterCtx.fill();
            });

            scatterCtx.strokeStyle = '#666';
            scatterCtx.strokeRect(pad, pad, w, h);
            scatterCtx.fillStyle = '#fff';
            scatterCtx.font = '11px sans-serif';
            scatterCtx.fillText('Vision', scatterCanvas.width/2-15, scatterCanvas.height-5);
            scatterCtx.save();
            scatterCtx.translate(10, scatterCanvas.height/2);
            scatterCtx.rotate(-Math.PI/2);
            scatterCtx.fillText('Metabolism', -30, 0);
            scatterCtx.restore();
            scatterCtx.fillText('Fitness Scatter', pad, 20);

            // Wealth histogram
            histCtx.fillStyle = '#000';
            histCtx.fillRect(0, 0, histCanvas.width, histCanvas.height);

            const sorted = [...agents].sort((a,b) => a.wealth - b.wealth);
            const maxWealth = sorted[sorted.length-1].wealth;
            const bins = 20;
            const binSize = maxWealth / bins;
            const counts = new Array(bins).fill(0);

            sorted.forEach(a => {
                const bin = Math.min(Math.floor(a.wealth / binSize), bins-1);
                counts[bin]++;
            });

            const maxCount = Math.max(...counts);
            const barWidth = (histCanvas.width - 2*pad) / bins;

            counts.forEach((count, i) => {
                const bh = (count / maxCount) * (histCanvas.height - 2*pad);
                const avgFitness = agents
                    .filter(a => Math.floor(a.wealth/binSize) === i)
                    .reduce((sum,a) => sum + a.vision/a.metabolism, 0) / (count || 1);

                histCtx.fillStyle = avgFitness > 2.5 ? '#2196f3' : avgFitness < 1.5 ? '#f44336' : '#4caf50';
                histCtx.fillRect(
                    pad + i*barWidth,
                    histCanvas.height - pad - bh,
                    barWidth - 2,
                    bh
                );
            });

            histCtx.strokeStyle = '#666';
            histCtx.strokeRect(pad, pad, histCanvas.width-2*pad, histCanvas.height-2*pad);
            histCtx.fillStyle = '#fff';
            histCtx.font = '11px sans-serif';
            histCtx.fillText('Wealth Distribution', pad, 20);
            histCtx.fillText('Wealth', histCanvas.width/2-15, histCanvas.height-5);

            // Stats
            const totalWealth = agents.reduce((s,a) => s+a.wealth, 0);
            const avgWealth = totalWealth / agents.length;
            const elite = agents.filter(a => getColor(a) === '#2196f3').length;
            const struggling = agents.filter(a => getColor(a) === '#f44336').length;
            const avgFitness = agents.reduce((s,a) => s + a.vision/a.metabolism, 0) / agents.length;

            const eliteWealth = agents.filter(a => getColor(a) === '#2196f3')
                .reduce((s,a) => s+a.wealth, 0);
            const strugglingWealth = agents.filter(a => getColor(a) === '#f44336')
                .reduce((s,a) => s+a.wealth, 0);

            document.getElementById('stats').innerHTML = `
                <div class="stat"><span class="stat-label">Tick:</span><span class="stat-value">${tick}</span></div>
                <div class="stat"><span class="stat-label">Avg Wealth:</span><span class="stat-value">${avgWealth.toFixed(1)}</span></div>
                <div class="stat"><span class="stat-label">Avg Fitness:</span><span class="stat-value">${avgFitness.toFixed(2)}</span></div>
                <div class="stat"><span class="stat-label">Elite Count:</span><span class="stat-value" style="color:#2196f3">${elite}</span></div>
                <div class="stat"><span class="stat-label">Elite Wealth:</span><span class="stat-value">${elite>0?(eliteWealth/elite).toFixed(1):'0'}</span></div>
                <div class="stat"><span class="stat-label">Struggling:</span><span class="stat-value" style="color:#f44336">${struggling}</span></div>
                <div class="stat"><span class="stat-label">Struggling W:</span><span class="stat-value">${struggling>0?(strugglingWealth/struggling).toFixed(1):'0'}</span></div>
                <div class="stat"><span class="stat-label">Wealth Ratio:</span><span class="stat-value">${elite>0&&struggling>0?((eliteWealth/elite)/(strugglingWealth/struggling)).toFixed(1)+'x':'N/A'}</span></div>
            `;
        }

        function animate() {
            update();
            draw();
            requestAnimationFrame(animate);
        }

        document.getElementById('resetBtn').onclick = init;
        document.getElementById('pauseBtn').onclick = () => {
            paused = !paused;
            document.getElementById('pauseBtn').textContent = paused ? 'Resume' : 'Pause';
        };

        init();
        animate();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
