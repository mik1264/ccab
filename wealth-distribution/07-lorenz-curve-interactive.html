<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Interactive Lorenz Curve Analysis</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: #fff; padding: 20px;
        }
        .container { display: flex; gap: 20px; height: 97vh; }
        .main { flex: 3; }
        .sidebar { flex: 1; max-width: 350px; display: flex; flex-direction: column; gap: 15px; }
        .panel { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 15px; }
        h1 { font-size: 18px; margin-bottom: 10px; color: #9c27b0; }
        canvas { display: block; background: #000; border-radius: 5px; width: 100%; }
        button { padding: 10px; background: #9c27b0; color: #fff; border: none; border-radius: 5px; cursor: pointer; margin: 5px 0; font-weight: bold; }
        .stat { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 13px; }
        .highlight { color: #9c27b0; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="main">
            <div class="panel">
                <h1>Lorenz Curve - Measuring Inequality</h1>
                <canvas id="lorenzCanvas"></canvas>
                <canvas id="simCanvas" style="margin-top: 15px;"></canvas>
            </div>
        </div>
        <div class="sidebar">
            <div class="panel">
                <button id="resetBtn">Reset</button>
                <button id="pauseBtn">Pause</button>
            </div>
            <div class="panel"><h1>Inequality Metrics</h1><div id="stats"></div></div>
            <div class="panel" style="font-size: 12px; line-height: 1.4;">
                <strong>Lorenz Curve:</strong> Plots cumulative wealth % vs population %.
                Perfect equality = diagonal line. Actual distribution bows below.
                <strong>Gini coefficient</strong> = area between curves / total area below diagonal.
                0 = perfect equality, 1 = one person has everything.
            </div>
        </div>
    </div>
    <script>
        const lorenzCanvas = document.getElementById('lorenzCanvas');
        const simCanvas = document.getElementById('simCanvas');
        const lorenzCtx = lorenzCanvas.getContext('2d');
        const simCtx = simCanvas.getContext('2d');

        lorenzCanvas.width = lorenzCanvas.parentElement.clientWidth - 30;
        lorenzCanvas.height = lorenzCanvas.width * 0.75;
        simCanvas.width = simCanvas.parentElement.clientWidth - 30;
        simCanvas.height = 280;

        const GRID = 50, AGENTS = 250, MAX_GRAIN = 50;
        let paused = false, tick = 0;
        let grain = [], maxCap = [], agents = [];

        function init() {
            grain = []; maxCap = [];
            for (let y = 0; y < GRID; y++) {
                grain[y] = []; maxCap[y] = [];
                for (let x = 0; x < GRID; x++) {
                    const d1 = Math.sqrt((x-15)**2 + (y-15)**2);
                    const d2 = Math.sqrt((x-35)**2 + (y-35)**2);
                    const cap = Math.floor(MAX_GRAIN * (Math.exp(-d1*d1/180) + Math.exp(-d2*d2/180)));
                    maxCap[y][x] = cap; grain[y][x] = cap;
                }
            }
            agents = [];
            for (let i = 0; i < AGENTS; i++) {
                agents.push({
                    x: Math.random()*GRID|0, y: Math.random()*GRID|0,
                    wealth: 30, vision: 1 + Math.random()*6|0,
                    metabolism: 1 + Math.random()*4, age: 0, maxAge: 85
                });
            }
            tick = 0;
        }

        function update() {
            if (paused) return;
            for (let y = 0; y < GRID; y++) {
                for (let x = 0; x < GRID; x++) {
                    if (grain[y][x] < maxCap[y][x]) grain[y][x]++;
                }
            }
            agents.forEach(a => {
                let [bx,by,bg] = [a.x, a.y, grain[a.y][a.x]];
                for (let dx = -a.vision; dx <= a.vision; dx++) {
                    for (let dy = -a.vision; dy <= a.vision; dy++) {
                        const nx = (a.x+dx+GRID)%GRID, ny = (a.y+dy+GRID)%GRID;
                        if (grain[ny][nx] > bg) { bg = grain[ny][nx]; bx = nx; by = ny; }
                    }
                }
                a.x = bx; a.y = by;
                a.wealth += grain[a.y][a.x];
                grain[a.y][a.x] = 0;
                a.wealth -= a.metabolism;
                a.age++;
            });
            for (let i = agents.length-1; i >= 0; i--) {
                if (agents[i].wealth <= 0 || agents[i].age >= agents[i].maxAge) {
                    agents[i] = {
                        x: Math.random()*GRID|0, y: Math.random()*GRID|0,
                        wealth: 30, vision: 1 + Math.random()*6|0,
                        metabolism: 1 + Math.random()*4, age: 0, maxAge: 85
                    };
                }
            }
            tick++;
        }

        function drawLorenz() {
            lorenzCtx.fillStyle = '#000';
            lorenzCtx.fillRect(0, 0, lorenzCanvas.width, lorenzCanvas.height);

            const sorted = [...agents].sort((a,b) => a.wealth - b.wealth);
            const totalWealth = sorted.reduce((s,a) => s+a.wealth, 0);

            const pad = 60, w = lorenzCanvas.width - 2*pad, h = lorenzCanvas.height - 2*pad;

            // Equality line
            lorenzCtx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            lorenzCtx.lineWidth = 2;
            lorenzCtx.setLineDash([5, 5]);
            lorenzCtx.beginPath();
            lorenzCtx.moveTo(pad, lorenzCanvas.height - pad);
            lorenzCtx.lineTo(pad + w, pad);
            lorenzCtx.stroke();
            lorenzCtx.setLineDash([]);

            // Lorenz curve
            lorenzCtx.strokeStyle = '#9c27b0';
            lorenzCtx.lineWidth = 3;
            lorenzCtx.beginPath();
            lorenzCtx.moveTo(pad, lorenzCanvas.height - pad);

            let cumWealth = 0, giniArea = 0;
            sorted.forEach((a, i) => {
                cumWealth += a.wealth;
                const x = pad + (i / sorted.length) * w;
                const y = lorenzCanvas.height - pad - (cumWealth / totalWealth) * h;
                lorenzCtx.lineTo(x, y);
                if (i > 0) giniArea += (cumWealth / totalWealth) / sorted.length;
            });
            lorenzCtx.stroke();

            // Fill Gini area
            lorenzCtx.fillStyle = 'rgba(156, 39, 176, 0.2)';
            lorenzCtx.beginPath();
            lorenzCtx.moveTo(pad, lorenzCanvas.height - pad);
            lorenzCtx.lineTo(pad + w, pad);
            cumWealth = 0;
            for (let i = sorted.length - 1; i >= 0; i--) {
                cumWealth += sorted[i].wealth;
                const x = pad + ((sorted.length - i - 1) / sorted.length) * w;
                const y = lorenzCanvas.height - pad - ((totalWealth - cumWealth) / totalWealth) * h;
                lorenzCtx.lineTo(x, y);
            }
            lorenzCtx.closePath();
            lorenzCtx.fill();

            const gini = 1 - 2 * giniArea;

            // Axes and labels
            lorenzCtx.strokeStyle = '#fff';
            lorenzCtx.lineWidth = 2;
            lorenzCtx.strokeRect(pad, pad, w, h);

            lorenzCtx.fillStyle = '#fff';
            lorenzCtx.font = '14px sans-serif';
            lorenzCtx.fillText('Lorenz Curve', pad, pad - 10);
            lorenzCtx.fillText(`Gini Coefficient: ${gini.toFixed(3)}`, lorenzCanvas.width - 200, pad - 10);

            lorenzCtx.font = '12px sans-serif';
            lorenzCtx.fillText('Cumulative Population %', lorenzCanvas.width/2 - 60, lorenzCanvas.height - 10);
            lorenzCtx.save();
            lorenzCtx.translate(15, lorenzCanvas.height/2);
            lorenzCtx.rotate(-Math.PI/2);
            lorenzCtx.fillText('Cumulative Wealth %', -60, 0);
            lorenzCtx.restore();

            // Grid lines
            lorenzCtx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            lorenzCtx.lineWidth = 1;
            for (let i = 0.2; i < 1; i += 0.2) {
                lorenzCtx.beginPath();
                lorenzCtx.moveTo(pad, lorenzCanvas.height - pad - i*h);
                lorenzCtx.lineTo(pad + w, lorenzCanvas.height - pad - i*h);
                lorenzCtx.stroke();
                lorenzCtx.fillStyle = '#999';
                lorenzCtx.fillText(`${(i*100).toFixed(0)}%`, pad - 35, lorenzCanvas.height - pad - i*h + 4);

                lorenzCtx.beginPath();
                lorenzCtx.moveTo(pad + i*w, lorenzCanvas.height - pad);
                lorenzCtx.lineTo(pad + i*w, pad);
                lorenzCtx.stroke();
                lorenzCtx.fillText(`${(i*100).toFixed(0)}%`, pad + i*w - 10, lorenzCanvas.height - pad + 20);
            }

            return {gini, sorted, totalWealth};
        }

        function drawSim() {
            const cellSize = simCanvas.width / GRID;
            simCtx.clearRect(0, 0, simCanvas.width, simCanvas.height);

            for (let y = 0; y < GRID; y++) {
                for (let x = 0; x < GRID; x++) {
                    const i = grain[y][x] / MAX_GRAIN;
                    simCtx.fillStyle = `rgba(0, ${Math.floor(i*120)}, 0, 0.6)`;
                    simCtx.fillRect(x*cellSize, y*cellSize, cellSize, cellSize);
                }
            }
            agents.forEach(a => {
                const color = a.wealth<25 ? '#f44336' : a.wealth<100 ? '#ffeb3b' : '#9c27b0';
                simCtx.fillStyle = color;
                simCtx.beginPath();
                simCtx.arc(a.x*cellSize+cellSize/2, a.y*cellSize+cellSize/2, cellSize*0.35, 0, Math.PI*2);
                simCtx.fill();
            });
        }

        function draw() {
            const {gini, sorted, totalWealth} = drawLorenz();
            drawSim();

            const top20 = sorted.slice(-Math.floor(AGENTS*0.2)).reduce((s,a) => s+a.wealth, 0);
            const bottom50 = sorted.slice(0, Math.floor(AGENTS*0.5)).reduce((s,a) => s+a.wealth, 0);

            document.getElementById('stats').innerHTML = `
                <div class="stat"><span>Tick:</span><span>${tick}</span></div>
                <div class="stat"><span>Gini Coefficient:</span><span class="highlight">${gini.toFixed(3)}</span></div>
                <div class="stat"><span>Top 20% Own:</span><span>${(top20/totalWealth*100).toFixed(1)}%</span></div>
                <div class="stat"><span>Bottom 50% Own:</span><span>${(bottom50/totalWealth*100).toFixed(1)}%</span></div>
                <div class="stat"><span>Richest Agent:</span><span>${sorted[AGENTS-1].wealth.toFixed(1)}</span></div>
                <div class="stat"><span>Poorest Agent:</span><span>${sorted[0].wealth.toFixed(1)}</span></div>
                <div class="stat"><span>Median Wealth:</span><span>${sorted[Math.floor(AGENTS/2)].wealth.toFixed(1)}</span></div>
                <div class="stat"><span>Wealth Ratio:</span><span>${(sorted[AGENTS-1].wealth / sorted[0].wealth).toFixed(1)}x</span></div>
            `;
        }

        function animate() { update(); draw(); requestAnimationFrame(animate); }

        document.getElementById('resetBtn').onclick = init;
        document.getElementById('pauseBtn').onclick = () => {
            paused = !paused;
            document.getElementById('pauseBtn').textContent = paused ? 'Resume' : 'Pause';
        };

        init();
        animate();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
