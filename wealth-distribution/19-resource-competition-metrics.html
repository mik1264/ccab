<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Resource Competition Metrics</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667db6 0%, #0082c8 50%, #0082c8 100%, #667db6 100%);
            color: #fff; padding: 20px;
        }
        .container { display: flex; gap: 20px; height: 97vh; }
        .main { flex: 3; display: flex; flex-direction: column; gap: 15px; }
        .panel { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 15px; }
        .sidebar { flex: 1; max-width: 300px; }
        h1 { font-size: 17px; margin-bottom: 10px; }
        canvas { display: block; background: #000; border-radius: 5px; width: 100%; }
        button { padding: 10px; background: #fff; color: #0082c8; border: none; border-radius: 5px; cursor: pointer; margin: 5px 0; font-weight: bold; }
        .stat { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="main">
            <div class="panel"><h1>Resource Competition Map</h1><canvas id="mainCanvas"></canvas></div>
            <div class="panel"><h1>Patch Utilization</h1><canvas id="patchCanvas"></canvas></div>
            <div class="panel"><h1>Competition Intensity</h1><canvas id="compCanvas"></canvas></div>
        </div>
        <div class="sidebar">
            <div class="panel"><button id="resetBtn">Reset</button><button id="pauseBtn">Pause</button></div>
            <div class="panel"><h1>Stats</h1><div id="stats"></div></div>
            <div class="panel" style="font-size: 11px; line-height: 1.3;">
                Measure resource competition intensity.
                High-value patches attract more agents, creating hotspots.
                Monopolization by elite agents visible.
            </div>
        </div>
    </div>
    <script>
        const mainCanvas = document.getElementById('mainCanvas');
        const patchCanvas = document.getElementById('patchCanvas');
        const compCanvas = document.getElementById('compCanvas');
        const [mainCtx, patchCtx, compCtx] = [mainCanvas, patchCanvas, compCanvas].map(c => c.getContext('2d'));

        mainCanvas.width = mainCanvas.parentElement.clientWidth - 30;
        mainCanvas.height = 300;
        patchCanvas.width = patchCanvas.parentElement.clientWidth - 30;
        patchCanvas.height = 180;
        compCanvas.width = compCanvas.parentElement.clientWidth - 30;
        compCanvas.height = 180;

        const GRID = 50, AGENTS = 220, MAX_GRAIN = 50;
        let paused = false, tick = 0;
        let grain = [], maxCap = [], agents = [];
        let visitCounts = [], harvestData = [];

        function init() {
            grain = []; maxCap = []; visitCounts = [];
            for (let y = 0; y < GRID; y++) {
                grain[y] = []; maxCap[y] = []; visitCounts[y] = [];
                for (let x = 0; x < GRID; x++) {
                    const d1 = Math.sqrt((x-15)**2 + (y-15)**2);
                    const d2 = Math.sqrt((x-35)**2 + (y-35)**2);
                    const cap = Math.floor(MAX_GRAIN * (Math.exp(-d1*d1/180) + Math.exp(-d2*d2/180)));
                    maxCap[y][x] = cap; grain[y][x] = cap;
                    visitCounts[y][x] = 0;
                }
            }
            agents = [];
            for (let i = 0; i < AGENTS; i++) {
                agents.push({
                    x: Math.random()*GRID|0, y: Math.random()*GRID|0,
                    wealth: 30, vision: 1 + Math.random()*6|0,
                    metabolism: 1 + Math.random()*4, age: 0, maxAge: 80,
                    lastHarvest: 0
                });
            }
            tick = 0; harvestData = [];
        }

        function update() {
            if (paused) return;
            for (let y = 0; y < GRID; y++) {
                for (let x = 0; x < GRID; x++) {
                    if (grain[y][x] < maxCap[y][x]) grain[y][x]++;
                }
            }

            let totalHarvest = 0;
            agents.forEach(a => {
                let [bx,by,bg] = [a.x, a.y, grain[a.y][a.x]];
                for (let dx = -a.vision; dx <= a.vision; dx++) {
                    for (let dy = -a.vision; dy <= a.vision; dy++) {
                        const nx = (a.x+dx+GRID)%GRID, ny = (a.y+dy+GRID)%GRID;
                        if (grain[ny][nx] > bg) { bg = grain[ny][nx]; bx = nx; by = ny; }
                    }
                }
                a.x = bx; a.y = by;
                visitCounts[a.y][a.x]++;

                const harvested = grain[a.y][a.x];
                a.wealth += harvested;
                a.lastHarvest = harvested;
                totalHarvest += harvested;
                grain[a.y][a.x] = 0;
                a.wealth -= a.metabolism;
                a.age++;
            });

            harvestData.push(totalHarvest);
            if (harvestData.length > 300) harvestData.shift();

            for (let i = agents.length-1; i >= 0; i--) {
                if (agents[i].wealth <= 0 || agents[i].age >= agents[i].maxAge) {
                    agents[i] = {
                        x: Math.random()*GRID|0, y: Math.random()*GRID|0,
                        wealth: 30, vision: 1 + Math.random()*6|0,
                        metabolism: 1 + Math.random()*4, age: 0, maxAge: 80,
                        lastHarvest: 0
                    };
                }
            }
            tick++;

            // Decay visit counts
            if (tick % 10 === 0) {
                for (let y = 0; y < GRID; y++) {
                    for (let x = 0; x < GRID; x++) {
                        visitCounts[y][x] *= 0.95;
                    }
                }
            }
        }

        function draw() {
            const cellSize = mainCanvas.width / GRID;
            mainCtx.clearRect(0, 0, mainCanvas.width, mainCanvas.height);

            // Draw competition heatmap
            const maxVisits = Math.max(...visitCounts.flat(), 1);
            for (let y = 0; y < GRID; y++) {
                for (let x = 0; x < GRID; x++) {
                    const grainIntensity = grain[y][x] / MAX_GRAIN;
                    const visitIntensity = visitCounts[y][x] / maxVisits;

                    const r = Math.floor(visitIntensity * 255);
                    const g = Math.floor(grainIntensity * 150);
                    const b = 0;

                    mainCtx.fillStyle = `rgba(${r}, ${g}, ${b}, 0.7)`;
                    mainCtx.fillRect(x*cellSize, y*cellSize, cellSize, cellSize);
                }
            }

            agents.forEach(a => {
                const color = a.wealth<25 ? '#f44336' : a.wealth<90 ? '#4caf50' : '#2196f3';
                mainCtx.fillStyle = color;
                mainCtx.beginPath();
                mainCtx.arc(a.x*cellSize+cellSize/2, a.y*cellSize+cellSize/2, cellSize*0.4, 0, Math.PI*2);
                mainCtx.fill();
            });

            mainCtx.fillStyle = '#fff';
            mainCtx.font = '12px sans-serif';
            mainCtx.fillText('Red = High Competition, Green = Available Resources', 10, 20);

            // Patch utilization
            patchCtx.fillStyle = '#000';
            patchCtx.fillRect(0, 0, patchCanvas.width, patchCanvas.height);

            const patches = [];
            for (let y = 0; y < GRID; y++) {
                for (let x = 0; x < GRID; x++) {
                    patches.push({
                        capacity: maxCap[y][x],
                        visits: visitCounts[y][x],
                        current: grain[y][x]
                    });
                }
            }

            patches.sort((a,b) => b.capacity - a.capacity);
            const top20 = patches.slice(0, 500);

            const pad = 40, w = patchCanvas.width - 2*pad, h = patchCanvas.height - 2*pad;
            const maxCap = Math.max(...top20.map(p => p.capacity), 1);
            const maxVisit = Math.max(...top20.map(p => p.visits), 1);

            top20.forEach((p, i) => {
                const x = pad + (p.capacity / maxCap) * w;
                const y = patchCanvas.height - pad - (p.visits / maxVisit) * h;

                patchCtx.fillStyle = `rgba(100, 181, 246, 0.5)`;
                patchCtx.beginPath();
                patchCtx.arc(x, y, 3, 0, Math.PI*2);
                patchCtx.fill();
            });

            patchCtx.strokeStyle = '#fff';
            patchCtx.strokeRect(pad, pad, w, h);
            patchCtx.fillStyle = '#fff';
            patchCtx.font = '12px sans-serif';
            patchCtx.fillText('Patch Capacity vs Competition', pad, 20);
            patchCtx.fillText('Capacity', patchCanvas.width/2-20, patchCanvas.height-5);
            patchCtx.save();
            patchCtx.translate(10, patchCanvas.height/2);
            patchCtx.rotate(-Math.PI/2);
            patchCtx.fillText('Visits', -15, 0);
            patchCtx.restore();

            // Total harvest over time
            compCtx.fillStyle = '#000';
            compCtx.fillRect(0, 0, compCanvas.width, compCanvas.height);

            if (harvestData.length > 1) {
                const pad = 40, w = compCanvas.width - 2*pad, h = compCanvas.height - 2*pad;
                const maxHarvest = Math.max(...harvestData, 1);

                compCtx.strokeStyle = '#4caf50';
                compCtx.lineWidth = 2;
                compCtx.beginPath();
                harvestData.forEach((harvest, i) => {
                    const x = pad + (i/harvestData.length)*w;
                    const y = compCanvas.height - pad - (harvest/maxHarvest)*h;
                    i===0 ? compCtx.moveTo(x,y) : compCtx.lineTo(x,y);
                });
                compCtx.stroke();

                compCtx.strokeStyle = '#fff';
                compCtx.strokeRect(pad, pad, w, h);
                compCtx.fillStyle = '#fff';
                compCtx.font = '12px sans-serif';
                compCtx.fillText('Total Harvest per Tick', pad, 20);
            }

            const totalVisits = visitCounts.flat().reduce((s,v) => s+v, 0);
            const avgHarvest = harvestData.length > 0 ?
                harvestData.reduce((s,h) => s+h, 0) / harvestData.length : 0;
            const efficiencyRate = (avgHarvest / (AGENTS * 2.5) * 100).toFixed(1);

            document.getElementById('stats').innerHTML = `
                <div class="stat"><span>Tick:</span><span>${tick}</span></div>
                <div class="stat"><span>Total Visits:</span><span>${totalVisits.toFixed(0)}</span></div>
                <div class="stat"><span>Avg Harvest:</span><span>${avgHarvest.toFixed(1)}</span></div>
                <div class="stat"><span>Efficiency:</span><span>${efficiencyRate}%</span></div>
                <div class="stat"><span>Active Patches:</span><span>${visitCounts.flat().filter(v => v>0).length}</span></div>
            `;
        }

        function animate() { update(); draw(); requestAnimationFrame(animate); }

        document.getElementById('resetBtn').onclick = init;
        document.getElementById('pauseBtn').onclick = () => {
            paused = !paused;
            document.getElementById('pauseBtn').textContent = paused ? 'Resume' : 'Pause';
        };

        init();
        animate();
    </script>
</body>
</html>
