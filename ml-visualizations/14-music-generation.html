<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Generation - ML Visualizations - CCAB</title>
    <style>
        body { margin: 0; padding: 20px; background: #0f0f1a; color: #e8e6e1; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .back-link { display: inline-block; padding: 8px 16px; background: rgba(124, 58, 237, 0.2); color: #a78bfa; text-decoration: none; border-radius: 6px; margin-bottom: 20px; }
        .back-link:hover { background: rgba(124, 58, 237, 0.4); }
        h1 { color: #a78bfa; margin-bottom: 10px; }
        .subtitle { color: #888; margin-bottom: 20px; }
        .container { display: flex; gap: 30px; flex-wrap: wrap; }
        .panel { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 20px; min-width: 300px; }
        canvas { border-radius: 8px; background: #1a1a2e; }
        button { background: #7C3AED; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin: 5px; }
        button:hover { background: #6D28D9; }
        button:disabled { background: #4a4a5a; cursor: not-allowed; }
        select { background: #1a1a2e; color: #e8e6e1; padding: 10px; border-radius: 6px; border: 1px solid #7C3AED; margin: 5px; }
        .slider-group { margin: 15px 0; }
        .slider-group label { display: block; margin-bottom: 5px; color: #a78bfa; }
        input[type="range"] { width: 100%; accent-color: #7C3AED; }
        .value { float: right; color: #888; }
        .piano-roll { display: grid; grid-template-columns: 40px 1fr; gap: 2px; margin-top: 15px; }
        .note-label { display: flex; align-items: center; justify-content: flex-end; padding-right: 5px; font-size: 10px; color: #888; height: 16px; }
        .note-row { display: flex; gap: 1px; height: 16px; }
        .note-cell { width: 20px; background: rgba(255,255,255,0.05); border-radius: 2px; transition: background 0.1s; }
        .note-cell.active { background: #7C3AED; }
        .note-cell.playing { background: #10B981; box-shadow: 0 0 10px #10B981; }
        .note-cell:hover { background: rgba(124, 58, 237, 0.5); }
        .current-step { font-size: 24px; color: #10B981; text-align: center; margin: 10px 0; }
        .status { font-size: 14px; color: #888; margin-top: 10px; }
        .note { font-size: 12px; color: #888; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px; margin-top: 15px; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to ML Gallery</a>
    <h1>Music Generation</h1>
    <p class="subtitle">Generate and play melodies using AI-inspired patterns (simulated Magenta.js)</p>

    <div class="container">
        <div class="panel">
            <h3>Controls</h3>

            <select id="model">
                <option value="melody">Melody RNN</option>
                <option value="drums">Drums RNN</option>
                <option value="chord">Chord Progression</option>
                <option value="arpeggio">Arpeggiator</option>
            </select>

            <select id="scale">
                <option value="major">C Major</option>
                <option value="minor">A Minor</option>
                <option value="pentatonic">Pentatonic</option>
                <option value="blues">Blues</option>
                <option value="chromatic">Chromatic</option>
            </select>

            <div class="slider-group">
                <label>Temperature (Randomness) <span class="value" id="tempVal">0.8</span></label>
                <input type="range" id="temperature" min="0.1" max="2" step="0.1" value="0.8" oninput="updateTemp()">
            </div>

            <div class="slider-group">
                <label>Tempo (BPM) <span class="value" id="bpmVal">120</span></label>
                <input type="range" id="tempo" min="60" max="200" step="5" value="120" oninput="updateTempo()">
            </div>

            <div class="slider-group">
                <label>Steps <span class="value" id="stepsVal">16</span></label>
                <input type="range" id="steps" min="8" max="32" step="4" value="16" oninput="updateSteps()">
            </div>

            <div style="margin-top: 20px;">
                <button onclick="generate()">üé≤ Generate</button>
                <button onclick="togglePlay()" id="playBtn">‚ñ∂Ô∏è Play</button>
                <button onclick="clearPattern()">üóëÔ∏è Clear</button>
            </div>

            <div class="current-step">Step: <span id="stepDisplay">-</span></div>
            <div class="status" id="status">Click Generate to create a new pattern</div>

            <div class="note">
                This demo simulates neural music generation using probabilistic patterns.
                Real Magenta.js uses trained RNN/Transformer models.
            </div>
        </div>

        <div class="panel" style="flex: 1;">
            <h3>Piano Roll</h3>
            <div id="pianoRoll" class="piano-roll"></div>

            <h3 style="margin-top: 20px;">Waveform</h3>
            <canvas id="waveform" width="500" height="100"></canvas>
        </div>
    </div>

    <script>
        let audioContext;
        let pattern = [];
        let isPlaying = false;
        let currentStep = 0;
        let intervalId = null;
        let temperature = 0.8;
        let tempo = 120;
        let numSteps = 16;

        const NOTES = ['C5', 'B4', 'A4', 'G4', 'F4', 'E4', 'D4', 'C4'];
        const FREQS = {
            'C5': 523.25, 'B4': 493.88, 'A4': 440.00, 'G4': 392.00,
            'F4': 349.23, 'E4': 329.63, 'D4': 293.66, 'C4': 261.63,
            'C3': 130.81, 'D3': 146.83, 'E3': 164.81, 'G3': 196.00
        };

        const SCALES = {
            major: [0, 2, 4, 5, 7, 9, 11],
            minor: [0, 2, 3, 5, 7, 8, 10],
            pentatonic: [0, 2, 4, 7, 9],
            blues: [0, 3, 5, 6, 7, 10],
            chromatic: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11]
        };

        const DRUM_SOUNDS = {
            kick: { freq: 60, decay: 0.3 },
            snare: { freq: 200, decay: 0.15, noise: true },
            hihat: { freq: 8000, decay: 0.05, noise: true }
        };

        function init() {
            createPianoRoll();
            generate();
        }

        function createPianoRoll() {
            const container = document.getElementById('pianoRoll');
            container.innerHTML = '';

            for (let i = 0; i < NOTES.length; i++) {
                const label = document.createElement('div');
                label.className = 'note-label';
                label.textContent = NOTES[i];
                container.appendChild(label);

                const row = document.createElement('div');
                row.className = 'note-row';

                for (let j = 0; j < numSteps; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'note-cell';
                    cell.dataset.note = i;
                    cell.dataset.step = j;
                    cell.onclick = () => toggleNote(i, j, cell);
                    row.appendChild(cell);
                }

                container.appendChild(row);
            }
        }

        function toggleNote(note, step, cell) {
            if (!pattern[step]) pattern[step] = [];

            const idx = pattern[step].indexOf(note);
            if (idx >= 0) {
                pattern[step].splice(idx, 1);
                cell.classList.remove('active');
            } else {
                pattern[step].push(note);
                cell.classList.add('active');
            }
        }

        function updateTemp() {
            temperature = parseFloat(document.getElementById('temperature').value);
            document.getElementById('tempVal').textContent = temperature.toFixed(1);
        }

        function updateTempo() {
            tempo = parseInt(document.getElementById('tempo').value);
            document.getElementById('bpmVal').textContent = tempo;

            if (isPlaying) {
                clearInterval(intervalId);
                intervalId = setInterval(step, 60000 / tempo / 4);
            }
        }

        function updateSteps() {
            numSteps = parseInt(document.getElementById('steps').value);
            document.getElementById('stepsVal').textContent = numSteps;
            pattern = [];
            createPianoRoll();
        }

        function generate() {
            const model = document.getElementById('model').value;
            const scale = document.getElementById('scale').value;

            pattern = [];

            for (let i = 0; i < numSteps; i++) {
                pattern[i] = [];

                switch (model) {
                    case 'melody':
                        generateMelodyStep(i, scale);
                        break;
                    case 'drums':
                        generateDrumStep(i);
                        break;
                    case 'chord':
                        generateChordStep(i, scale);
                        break;
                    case 'arpeggio':
                        generateArpeggioStep(i, scale);
                        break;
                }
            }

            updatePianoRoll();
            document.getElementById('status').textContent = `Generated ${model} pattern with ${temperature.toFixed(1)} temperature`;
        }

        function generateMelodyStep(step, scale) {
            // Probability of note based on temperature
            if (Math.random() < 0.3 + temperature * 0.4) {
                const scaleNotes = SCALES[scale];
                const noteIdx = Math.floor(Math.pow(Math.random(), 1 / temperature) * NOTES.length);
                pattern[step].push(noteIdx);
            }
        }

        function generateDrumStep(step) {
            // Kick on beats 1 and 3
            if (step % 4 === 0 && Math.random() < 0.9 - temperature * 0.3) {
                pattern[step].push(7); // Low note = kick
            }
            // Snare on beats 2 and 4
            if (step % 4 === 2 && Math.random() < 0.85) {
                pattern[step].push(4); // Mid note = snare
            }
            // Hi-hat with temperature variation
            if (Math.random() < 0.5 + temperature * 0.3) {
                pattern[step].push(0); // High note = hihat
            }
        }

        function generateChordStep(step, scale) {
            if (step % 4 === 0) {
                // Generate a chord
                const root = Math.floor(Math.random() * 3) + 4; // Lower notes
                pattern[step].push(root);
                if (root + 2 < NOTES.length) pattern[step].push(root + 2);
                if (root + 4 < NOTES.length) pattern[step].push(root + 4);
            }
        }

        function generateArpeggioStep(step, scale) {
            const scaleNotes = SCALES[scale];
            const arpeggioPattern = [0, 2, 4, 2]; // Up and down
            const noteOffset = arpeggioPattern[step % 4];
            const baseNote = Math.floor(step / 4) % 2 === 0 ? 5 : 3;
            pattern[step].push(baseNote + noteOffset % (NOTES.length - baseNote));
        }

        function updatePianoRoll() {
            document.querySelectorAll('.note-cell').forEach(cell => {
                const note = parseInt(cell.dataset.note);
                const step = parseInt(cell.dataset.step);
                cell.classList.toggle('active', pattern[step] && pattern[step].includes(note));
            });
        }

        function togglePlay() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            if (isPlaying) {
                stopPlay();
            } else {
                startPlay();
            }
        }

        function startPlay() {
            isPlaying = true;
            currentStep = 0;
            document.getElementById('playBtn').textContent = '‚è∏Ô∏è Pause';
            intervalId = setInterval(step, 60000 / tempo / 4);
        }

        function stopPlay() {
            isPlaying = false;
            clearInterval(intervalId);
            document.getElementById('playBtn').textContent = '‚ñ∂Ô∏è Play';
            document.getElementById('stepDisplay').textContent = '-';

            document.querySelectorAll('.note-cell.playing').forEach(cell => {
                cell.classList.remove('playing');
            });
        }

        function step() {
            // Clear previous playing indicators
            document.querySelectorAll('.note-cell.playing').forEach(cell => {
                cell.classList.remove('playing');
            });

            document.getElementById('stepDisplay').textContent = currentStep + 1;

            // Play notes at current step
            if (pattern[currentStep]) {
                pattern[currentStep].forEach(noteIdx => {
                    playNote(NOTES[noteIdx]);

                    // Visual feedback
                    const cell = document.querySelector(`.note-cell[data-note="${noteIdx}"][data-step="${currentStep}"]`);
                    if (cell) cell.classList.add('playing');
                });
            }

            drawWaveform();

            currentStep = (currentStep + 1) % numSteps;
        }

        function playNote(note) {
            if (!audioContext) return;

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(FREQS[note] || 440, audioContext.currentTime);

            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        function drawWaveform() {
            const canvas = document.getElementById('waveform');
            const ctx = canvas.getContext('2d');

            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw simple waveform visualization
            ctx.strokeStyle = '#7C3AED';
            ctx.lineWidth = 2;
            ctx.beginPath();

            const stepWidth = canvas.width / numSteps;

            for (let i = 0; i < numSteps; i++) {
                const x = i * stepWidth + stepWidth / 2;
                const amplitude = pattern[i] ? pattern[i].length * 15 : 5;

                if (i === currentStep) {
                    ctx.strokeStyle = '#10B981';
                    ctx.lineWidth = 3;
                } else {
                    ctx.strokeStyle = '#7C3AED';
                    ctx.lineWidth = 2;
                }

                ctx.beginPath();
                ctx.moveTo(x, canvas.height / 2 - amplitude);
                ctx.lineTo(x, canvas.height / 2 + amplitude);
                ctx.stroke();
            }

            // Draw playhead
            const playheadX = currentStep * stepWidth + stepWidth / 2;
            ctx.strokeStyle = '#10B981';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(playheadX, 0);
            ctx.lineTo(playheadX, canvas.height);
            ctx.stroke();
        }

        function clearPattern() {
            pattern = [];
            for (let i = 0; i < numSteps; i++) pattern[i] = [];
            updatePianoRoll();
            document.getElementById('status').textContent = 'Pattern cleared';
        }

        init();
    </script>
</body>
</html>
