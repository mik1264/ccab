<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Object Detection - ML Visualizations - CCAB</title>
    <style>
        body { margin: 0; padding: 20px; background: #0f0f1a; color: #e8e6e1; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .back-link { display: inline-block; padding: 8px 16px; background: rgba(124, 58, 237, 0.2); color: #a78bfa; text-decoration: none; border-radius: 6px; margin-bottom: 20px; }
        .back-link:hover { background: rgba(124, 58, 237, 0.4); }
        h1 { color: #a78bfa; margin-bottom: 10px; }
        .subtitle { color: #888; margin-bottom: 20px; }
        .container { position: relative; display: inline-block; }
        #video { border-radius: 8px; transform: scaleX(-1); }
        #canvas { position: absolute; top: 0; left: 0; border-radius: 8px; transform: scaleX(-1); }
        button { background: #7C3AED; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 15px; margin-right: 10px; }
        button:hover { background: #6D28D9; }
        #loading { text-align: center; padding: 50px; }
        .spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-top-color: #7C3AED; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .stats { margin-top: 15px; font-size: 14px; color: #888; }
        .legend { margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px; }
        .legend-item { padding: 5px 10px; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to ML Gallery</a>
    <h1>Object Detection</h1>
    <p class="subtitle">Real-time object detection using COCO-SSD (80 object classes)</p>

    <div id="loading">
        <div class="spinner"></div>
        <p>Loading COCO-SSD model (~6MB)...</p>
    </div>

    <div id="main" style="display: none;">
        <div class="container">
            <video id="video" width="640" height="480" autoplay playsinline></video>
            <canvas id="canvas" width="640" height="480"></canvas>
        </div>

        <div>
            <button onclick="startCamera()">Start Camera</button>
        </div>

        <div class="stats">
            <p>FPS: <span id="fps">0</span> | Objects detected: <span id="objects">0</span></p>
        </div>

        <div class="legend" id="legend"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>
    <script>
        let model;
        let video, canvas, ctx;
        let running = false;
        let lastTime = 0;

        // Color palette for different object classes
        const COLORS = [
            '#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#8B5CF6',
            '#EC4899', '#06B6D4', '#84CC16', '#F97316', '#6366F1'
        ];

        const classColors = {};

        async function init() {
            model = await cocoSsd.load();

            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');

            document.getElementById('loading').style.display = 'none';
            document.getElementById('main').style.display = 'block';
        }

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: 640, height: 480 }
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    running = true;
                    detectObjects();
                };
            } catch (err) {
                alert('Camera access denied. Error: ' + err.message);
            }
        }

        function getColorForClass(className) {
            if (!classColors[className]) {
                classColors[className] = COLORS[Object.keys(classColors).length % COLORS.length];
                updateLegend();
            }
            return classColors[className];
        }

        function updateLegend() {
            const legend = document.getElementById('legend');
            legend.innerHTML = '';
            for (let [className, color] of Object.entries(classColors)) {
                legend.innerHTML += `<span class="legend-item" style="background: ${color}20; border: 1px solid ${color}; color: ${color}">${className}</span>`;
            }
        }

        async function detectObjects() {
            if (!running) return;

            const predictions = await model.detect(video);

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById('objects').textContent = predictions.length;

            for (let pred of predictions) {
                const [x, y, width, height] = pred.bbox;
                const color = getColorForClass(pred.class);
                const confidence = (pred.score * 100).toFixed(1);

                // Draw bounding box
                ctx.strokeStyle = color;
                ctx.lineWidth = 3;
                ctx.strokeRect(x, y, width, height);

                // Draw label background
                const label = `${pred.class} ${confidence}%`;
                ctx.font = 'bold 14px sans-serif';
                const textWidth = ctx.measureText(label).width;

                ctx.fillStyle = color;
                ctx.fillRect(x, y - 24, textWidth + 10, 24);

                // Draw label text
                ctx.fillStyle = 'white';
                ctx.fillText(label, x + 5, y - 7);

                // Draw corner accents
                const cornerSize = 15;
                ctx.strokeStyle = color;
                ctx.lineWidth = 4;

                // Top-left
                ctx.beginPath();
                ctx.moveTo(x, y + cornerSize);
                ctx.lineTo(x, y);
                ctx.lineTo(x + cornerSize, y);
                ctx.stroke();

                // Top-right
                ctx.beginPath();
                ctx.moveTo(x + width - cornerSize, y);
                ctx.lineTo(x + width, y);
                ctx.lineTo(x + width, y + cornerSize);
                ctx.stroke();

                // Bottom-left
                ctx.beginPath();
                ctx.moveTo(x, y + height - cornerSize);
                ctx.lineTo(x, y + height);
                ctx.lineTo(x + cornerSize, y + height);
                ctx.stroke();

                // Bottom-right
                ctx.beginPath();
                ctx.moveTo(x + width - cornerSize, y + height);
                ctx.lineTo(x + width, y + height);
                ctx.lineTo(x + width, y + height - cornerSize);
                ctx.stroke();
            }

            // Calculate FPS
            const now = performance.now();
            const fps = 1000 / (now - lastTime);
            lastTime = now;
            document.getElementById('fps').textContent = Math.round(fps);

            requestAnimationFrame(detectObjects);
        }

        init();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
