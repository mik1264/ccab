<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jackknife Bias/Variance Tool - ML Visualizations</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 320px;
            height: 100vh;
            gap: 0;
        }
        .canvas-area {
            position: relative;
            background: #0d1117;
        }
        #mainCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        .controls {
            background: rgba(22, 33, 62, 0.95);
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid #333;
        }
        h1 {
            font-size: 1.3rem;
            margin-bottom: 8px;
            color: #c9a227;
        }
        .subtitle {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 20px;
            line-height: 1.4;
        }
        .section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }
        .section:last-child { border-bottom: none; }
        .section-title {
            font-size: 0.9rem;
            color: #c9a227;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        label {
            display: block;
            font-size: 0.85rem;
            color: #aaa;
            margin-bottom: 5px;
        }
        input[type="range"] {
            width: 100%;
            margin-bottom: 15px;
            accent-color: #c9a227;
        }
        select, button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            background: #1a1a2e;
            border: 1px solid #444;
            color: #e0e0e0;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
        }
        select:hover, button:hover {
            border-color: #c9a227;
        }
        button.primary {
            background: #c9a227;
            color: #1a1a2e;
            font-weight: 600;
        }
        .stats {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            background: #0d1117;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
        }
        .stats div {
            margin-bottom: 4px;
        }
        .stats .highlight {
            color: #c9a227;
        }
        .stats .compare {
            color: #4CAF50;
        }
        .stats .header {
            color: #888;
            font-size: 0.75rem;
            margin-top: 8px;
            margin-bottom: 4px;
            border-top: 1px solid #333;
            padding-top: 8px;
        }
        .back-link {
            display: inline-block;
            color: #c9a227;
            text-decoration: none;
            font-size: 0.85rem;
            margin-bottom: 15px;
        }
        .back-link:hover { text-decoration: underline; }
        .info-box {
            background: rgba(201, 162, 39, 0.1);
            border: 1px solid rgba(201, 162, 39, 0.3);
            border-radius: 6px;
            padding: 10px;
            font-size: 0.8rem;
            line-height: 1.5;
            margin-bottom: 15px;
        }
        .legend {
            font-size: 0.8rem;
            margin-top: 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            margin-right: 8px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="canvas-area">
            <canvas id="mainCanvas"></canvas>
        </div>
        <div class="controls">
            <a href="index.html" class="back-link">← Back to ML Visualizations</a>
            <h1>Jackknife Resampling</h1>
            <p class="subtitle">Estimate bias and standard error via leave-one-out resampling</p>

            <div class="info-box">
                Click on the left panel to add data points. The jackknife creates n subsamples by leaving out each observation one at a time.
            </div>

            <div class="section">
                <div class="section-title">Statistic</div>
                <select id="statistic">
                    <option value="mean">Mean</option>
                    <option value="variance">Variance</option>
                    <option value="median">Median</option>
                    <option value="trimmedMean">Trimmed Mean (10%)</option>
                    <option value="correlation">Correlation (x,y)</option>
                </select>
            </div>

            <div class="section">
                <div class="section-title">Sample Data</div>
                <label>Sample Size: <span id="sampleSizeVal">15</span></label>
                <input type="range" id="sampleSize" min="5" max="50" value="15">
                <label>Distribution</label>
                <select id="distribution">
                    <option value="normal">Normal</option>
                    <option value="uniform">Uniform</option>
                    <option value="skewed">Right-skewed</option>
                    <option value="bimodal">Bimodal</option>
                </select>
                <button class="primary" onclick="generateSample()">Generate Sample</button>
                <button onclick="clearData()">Clear All</button>
            </div>

            <div class="section">
                <div class="section-title">Animation</div>
                <label>Speed</label>
                <select id="animSpeed">
                    <option value="500">Slow</option>
                    <option value="200" selected>Medium</option>
                    <option value="50">Fast</option>
                    <option value="0">Instant</option>
                </select>
                <button onclick="animateJackknife()">Animate Jackknife</button>
                <button onclick="stopAnimation()">Stop</button>
            </div>

            <div class="section">
                <div class="section-title">Results</div>
                <div class="stats">
                    <div>n = <span id="nVal">0</span></div>
                    <div class="header">Full Sample</div>
                    <div>θ̂ = <span id="fullEstimate" class="highlight">-</span></div>
                    <div class="header">Jackknife Estimates</div>
                    <div>θ̂_jack = <span id="jackMean" class="highlight">-</span></div>
                    <div>SE_jack = <span id="jackSE" class="highlight">-</span></div>
                    <div>Bias = <span id="jackBias" class="highlight">-</span></div>
                    <div class="header">Comparison (if available)</div>
                    <div>SE_analytic = <span id="analyticSE" class="compare">-</span></div>
                    <div>Bias (true) = <span id="trueBias" class="compare">-</span></div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Legend</div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #2196F3;"></div>
                        <span>Data points</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #e74c3c;"></div>
                        <span>Left-out point</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #c9a227;"></div>
                        <span>Full sample statistic</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4CAF50;"></div>
                        <span>Jackknife estimates</span>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Formulas</div>
                <div class="info-box" style="font-family: 'Courier New', monospace; font-size: 0.75rem;">
                    θ̂_jack = (1/n) Σ θ̂_(i)<br><br>
                    SE_jack = √[((n-1)/n) Σ(θ̂_(i) - θ̂_jack)²]<br><br>
                    Bias = (n-1)(θ̂_jack - θ̂)
                </div>
            </div>
        </div>
    </div>

    <script>
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');

    // State
    let data = [];
    let jackEstimates = [];
    let currentLeftOut = -1;
    let animationId = null;

    function resize() {
        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width * window.devicePixelRatio;
        canvas.height = rect.height * window.devicePixelRatio;
        canvas.style.width = rect.width + 'px';
        canvas.style.height = rect.height + 'px';
        ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
        draw();
    }

    // Update UI displays
    document.getElementById('sampleSize').addEventListener('input', (e) => {
        document.getElementById('sampleSizeVal').textContent = e.target.value;
    });

    // Generate random sample
    function generateSample() {
        const n = parseInt(document.getElementById('sampleSize').value);
        const dist = document.getElementById('distribution').value;

        data = [];
        for (let i = 0; i < n; i++) {
            let x, y;
            if (dist === 'normal') {
                x = randn() * 15 + 50;
                y = randn() * 15 + 50;
            } else if (dist === 'uniform') {
                x = Math.random() * 80 + 10;
                y = Math.random() * 80 + 10;
            } else if (dist === 'skewed') {
                // Exponential-ish
                x = -Math.log(Math.random()) * 15 + 10;
                y = -Math.log(Math.random()) * 15 + 10;
            } else { // bimodal
                if (Math.random() < 0.5) {
                    x = randn() * 8 + 30;
                    y = randn() * 8 + 30;
                } else {
                    x = randn() * 8 + 70;
                    y = randn() * 8 + 70;
                }
            }
            data.push({ x: Math.max(5, Math.min(95, x)), y: Math.max(5, Math.min(95, y)) });
        }

        computeJackknife();
        draw();
    }

    function randn() {
        let u = 0, v = 0;
        while (u === 0) u = Math.random();
        while (v === 0) v = Math.random();
        return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
    }

    function clearData() {
        data = [];
        jackEstimates = [];
        currentLeftOut = -1;
        stopAnimation();
        updateStats();
        draw();
    }

    // Compute statistics
    function computeStatistic(points, stat) {
        if (points.length === 0) return NaN;

        const values = points.map(p => p.x);
        const yValues = points.map(p => p.y);

        switch (stat) {
            case 'mean':
                return values.reduce((a, b) => a + b, 0) / values.length;

            case 'variance':
                const mean = values.reduce((a, b) => a + b, 0) / values.length;
                return values.reduce((sum, x) => sum + (x - mean) ** 2, 0) / (values.length - 1);

            case 'median':
                const sorted = [...values].sort((a, b) => a - b);
                const mid = Math.floor(sorted.length / 2);
                return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;

            case 'trimmedMean':
                const sortedTrim = [...values].sort((a, b) => a - b);
                const trim = Math.floor(values.length * 0.1);
                const trimmed = sortedTrim.slice(trim, sortedTrim.length - trim);
                return trimmed.reduce((a, b) => a + b, 0) / trimmed.length;

            case 'correlation':
                const meanX = values.reduce((a, b) => a + b, 0) / values.length;
                const meanY = yValues.reduce((a, b) => a + b, 0) / yValues.length;
                let num = 0, denX = 0, denY = 0;
                for (let i = 0; i < values.length; i++) {
                    const dx = values[i] - meanX;
                    const dy = yValues[i] - meanY;
                    num += dx * dy;
                    denX += dx * dx;
                    denY += dy * dy;
                }
                return num / Math.sqrt(denX * denY);

            default:
                return values.reduce((a, b) => a + b, 0) / values.length;
        }
    }

    // Compute jackknife estimates
    function computeJackknife() {
        if (data.length < 3) {
            jackEstimates = [];
            updateStats();
            return;
        }

        const stat = document.getElementById('statistic').value;

        // Leave-one-out resampling
        jackEstimates = [];
        for (let i = 0; i < data.length; i++) {
            const subset = data.filter((_, idx) => idx !== i);
            jackEstimates.push(computeStatistic(subset, stat));
        }

        updateStats();
    }

    function updateStats() {
        const stat = document.getElementById('statistic').value;
        const n = data.length;

        document.getElementById('nVal').textContent = n;

        if (n < 3) {
            document.getElementById('fullEstimate').textContent = '-';
            document.getElementById('jackMean').textContent = '-';
            document.getElementById('jackSE').textContent = '-';
            document.getElementById('jackBias').textContent = '-';
            document.getElementById('analyticSE').textContent = '-';
            document.getElementById('trueBias').textContent = '-';
            return;
        }

        // Full sample estimate
        const fullEst = computeStatistic(data, stat);
        document.getElementById('fullEstimate').textContent = fullEst.toFixed(4);

        // Jackknife mean
        const jackMean = jackEstimates.reduce((a, b) => a + b, 0) / n;
        document.getElementById('jackMean').textContent = jackMean.toFixed(4);

        // Jackknife SE: sqrt((n-1)/n * sum((theta_i - jackMean)^2))
        const variance = jackEstimates.reduce((sum, est) => sum + (est - jackMean) ** 2, 0);
        const jackSE = Math.sqrt((n - 1) / n * variance);
        document.getElementById('jackSE').textContent = jackSE.toFixed(4);

        // Jackknife bias estimate: (n-1)(jackMean - fullEst)
        const jackBias = (n - 1) * (jackMean - fullEst);
        document.getElementById('jackBias').textContent = jackBias.toFixed(4);

        // Analytic comparison (for mean)
        if (stat === 'mean') {
            const values = data.map(p => p.x);
            const sampleVar = values.reduce((sum, x) => sum + (x - fullEst) ** 2, 0) / (n - 1);
            const analyticSE = Math.sqrt(sampleVar / n);
            document.getElementById('analyticSE').textContent = analyticSE.toFixed(4);
            document.getElementById('trueBias').textContent = '0 (mean is unbiased)';
        } else if (stat === 'variance') {
            // Variance estimator is unbiased
            document.getElementById('analyticSE').textContent = 'Complex formula';
            document.getElementById('trueBias').textContent = '0 (sample var is unbiased)';
        } else {
            document.getElementById('analyticSE').textContent = 'N/A';
            document.getElementById('trueBias').textContent = 'N/A';
        }
    }

    // Animation
    async function animateJackknife() {
        if (data.length < 3) return;

        stopAnimation();
        const speed = parseInt(document.getElementById('animSpeed').value);

        for (let i = 0; i < data.length; i++) {
            currentLeftOut = i;
            draw();

            if (speed > 0) {
                await new Promise(resolve => {
                    animationId = setTimeout(resolve, speed);
                });
            }
        }

        currentLeftOut = -1;
        draw();
    }

    function stopAnimation() {
        if (animationId) {
            clearTimeout(animationId);
            animationId = null;
        }
        currentLeftOut = -1;
        draw();
    }

    // Click to add points
    canvas.addEventListener('click', (e) => {
        const rect = canvas.getBoundingClientRect();
        const canvasW = rect.width;
        const canvasH = rect.height;

        // Only add in the data area (left part)
        const plotW = canvasW * 0.5 - 40;
        const plotX = 60;
        const plotY = 60;
        const plotH = canvasH - 120;

        const clickX = e.clientX - rect.left;
        const clickY = e.clientY - rect.top;

        if (clickX >= plotX && clickX <= plotX + plotW &&
            clickY >= plotY && clickY <= plotY + plotH) {
            const x = ((clickX - plotX) / plotW) * 100;
            const y = (1 - (clickY - plotY) / plotH) * 100;
            data.push({ x, y });
            computeJackknife();
            draw();
        }
    });

    function draw() {
        const rect = canvas.getBoundingClientRect();
        const w = rect.width;
        const h = rect.height;

        ctx.clearRect(0, 0, w, h);

        // Layout: data scatter on left, jackknife distribution on right
        const plotW = w * 0.45 - 40;
        const plotH = h - 120;
        const plotY = 60;

        // Left plot: Data scatter
        const leftX = 60;
        drawDataPlot(leftX, plotY, plotW, plotH);

        // Right plot: Jackknife estimates distribution
        const rightX = w * 0.5 + 20;
        drawJackknifeDistribution(rightX, plotY, plotW, plotH);

        // Title
        ctx.fillStyle = '#c9a227';
        ctx.font = 'bold 16px Segoe UI';
        ctx.textAlign = 'left';
        ctx.fillText('Jackknife Resampling: Leave-One-Out Bias & Variance Estimation', leftX, 30);
    }

    function drawDataPlot(x, y, w, h) {
        // Background
        ctx.fillStyle = '#1a1a2e';
        ctx.fillRect(x, y, w, h);

        // Grid
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 0.5;
        for (let i = 0; i <= 5; i++) {
            const gx = x + (i / 5) * w;
            const gy = y + (i / 5) * h;
            ctx.beginPath();
            ctx.moveTo(gx, y);
            ctx.lineTo(gx, y + h);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, gy);
            ctx.lineTo(x + w, gy);
            ctx.stroke();
        }

        // Title
        ctx.fillStyle = '#888';
        ctx.font = '12px Segoe UI';
        ctx.textAlign = 'center';
        ctx.fillText('Data (click to add points)', x + w / 2, y + h + 25);

        // Draw data points
        for (let i = 0; i < data.length; i++) {
            const px = x + (data[i].x / 100) * w;
            const py = y + h - (data[i].y / 100) * h;

            if (i === currentLeftOut) {
                // Highlight left-out point
                ctx.fillStyle = '#e74c3c';
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(px, py, 10, 0, Math.PI * 2);
                ctx.fill();
                ctx.stroke();

                // Label
                ctx.fillStyle = '#e74c3c';
                ctx.font = 'bold 11px Segoe UI';
                ctx.textAlign = 'left';
                ctx.fillText('Left out', px + 15, py + 4);
            } else {
                ctx.fillStyle = '#2196F3';
                ctx.beginPath();
                ctx.arc(px, py, 6, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // Show current jackknife estimate if animating
        if (currentLeftOut >= 0 && currentLeftOut < jackEstimates.length) {
            const stat = document.getElementById('statistic').value;
            ctx.fillStyle = '#4CAF50';
            ctx.font = 'bold 12px Segoe UI';
            ctx.textAlign = 'left';
            ctx.fillText(`θ̂_(${currentLeftOut + 1}) = ${jackEstimates[currentLeftOut].toFixed(3)}`, x + 10, y + 20);
        }
    }

    function drawJackknifeDistribution(x, y, w, h) {
        // Background
        ctx.fillStyle = '#1a1a2e';
        ctx.fillRect(x, y, w, h);

        if (jackEstimates.length === 0) {
            ctx.fillStyle = '#555';
            ctx.font = '14px Segoe UI';
            ctx.textAlign = 'center';
            ctx.fillText('Add at least 3 data points', x + w / 2, y + h / 2);
            return;
        }

        const stat = document.getElementById('statistic').value;
        const fullEst = computeStatistic(data, stat);
        const jackMean = jackEstimates.reduce((a, b) => a + b, 0) / jackEstimates.length;

        // Find range for x-axis
        const allVals = [...jackEstimates, fullEst];
        let minVal = Math.min(...allVals);
        let maxVal = Math.max(...allVals);
        const range = maxVal - minVal;
        minVal -= range * 0.2;
        maxVal += range * 0.2;

        // Draw histogram of jackknife estimates
        const numBins = Math.min(20, Math.max(5, Math.floor(jackEstimates.length / 2)));
        const binWidth = (maxVal - minVal) / numBins;
        const bins = Array(numBins).fill(0);

        for (const est of jackEstimates) {
            const binIdx = Math.min(numBins - 1, Math.floor((est - minVal) / binWidth));
            if (binIdx >= 0) bins[binIdx]++;
        }

        const maxBin = Math.max(...bins);
        const barW = w / numBins;
        const barArea = h * 0.6;

        // Draw bars
        for (let i = 0; i < numBins; i++) {
            const barH = maxBin > 0 ? (bins[i] / maxBin) * barArea : 0;
            const bx = x + i * barW;
            const by = y + h - 40 - barH;

            ctx.fillStyle = i === Math.floor((jackEstimates[currentLeftOut] - minVal) / binWidth) && currentLeftOut >= 0
                ? '#4CAF50'
                : 'rgba(76, 175, 80, 0.5)';
            ctx.fillRect(bx + 1, by, barW - 2, barH);
            ctx.strokeStyle = '#4CAF50';
            ctx.lineWidth = 1;
            ctx.strokeRect(bx + 1, by, barW - 2, barH);
        }

        // Draw full sample estimate line
        const fullX = x + ((fullEst - minVal) / (maxVal - minVal)) * w;
        ctx.strokeStyle = '#c9a227';
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 5]);
        ctx.beginPath();
        ctx.moveTo(fullX, y + 40);
        ctx.lineTo(fullX, y + h - 40);
        ctx.stroke();
        ctx.setLineDash([]);

        // Label
        ctx.fillStyle = '#c9a227';
        ctx.font = '11px Segoe UI';
        ctx.textAlign = 'center';
        ctx.fillText('θ̂', fullX, y + 30);

        // Draw jackknife mean line
        const jackX = x + ((jackMean - minVal) / (maxVal - minVal)) * w;
        ctx.strokeStyle = '#4CAF50';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(jackX, y + 40);
        ctx.lineTo(jackX, y + h - 40);
        ctx.stroke();

        ctx.fillStyle = '#4CAF50';
        ctx.fillText('θ̂_jack', jackX, y + 20);

        // Draw individual jackknife estimates as dots
        const dotY = y + h - 20;
        for (let i = 0; i < jackEstimates.length; i++) {
            const dx = x + ((jackEstimates[i] - minVal) / (maxVal - minVal)) * w;
            ctx.fillStyle = i === currentLeftOut ? '#e74c3c' : 'rgba(76, 175, 80, 0.7)';
            ctx.beginPath();
            ctx.arc(dx, dotY, i === currentLeftOut ? 6 : 4, 0, Math.PI * 2);
            ctx.fill();
        }

        // X-axis labels
        ctx.fillStyle = '#666';
        ctx.font = '10px Segoe UI';
        ctx.textAlign = 'center';
        ctx.fillText(minVal.toFixed(2), x, y + h);
        ctx.fillText(maxVal.toFixed(2), x + w, y + h);

        // Title
        ctx.fillStyle = '#888';
        ctx.font = '12px Segoe UI';
        ctx.fillText('Jackknife Estimates Distribution', x + w / 2, y + h + 25);
    }

    // Initialize
    window.addEventListener('resize', resize);
    document.getElementById('statistic').addEventListener('change', () => {
        computeJackknife();
        draw();
    });
    resize();
    generateSample();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
