<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pose Detection - ML Visualizations - CCAB</title>
    <style>
        body { margin: 0; padding: 20px; background: #0f0f1a; color: #e8e6e1; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .back-link { display: inline-block; padding: 8px 16px; background: rgba(124, 58, 237, 0.2); color: #a78bfa; text-decoration: none; border-radius: 6px; margin-bottom: 20px; }
        .back-link:hover { background: rgba(124, 58, 237, 0.4); }
        h1 { color: #a78bfa; margin-bottom: 10px; }
        .subtitle { color: #888; margin-bottom: 20px; }
        .container { position: relative; display: inline-block; }
        #video { border-radius: 8px; transform: scaleX(-1); }
        #canvas { position: absolute; top: 0; left: 0; border-radius: 8px; transform: scaleX(-1); }
        button { background: #7C3AED; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 15px; margin-right: 10px; }
        button:hover { background: #6D28D9; }
        #loading { text-align: center; padding: 50px; }
        .spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-top-color: #7C3AED; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .stats { margin-top: 15px; font-size: 14px; color: #888; }
        .warning { background: rgba(251, 191, 36, 0.2); border: 1px solid #F59E0B; border-radius: 8px; padding: 15px; margin-bottom: 20px; color: #FCD34D; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to ML Gallery</a>
    <h1>Pose Detection</h1>
    <p class="subtitle">Real-time body pose estimation with skeleton overlay</p>

    <div id="loading">
        <div class="spinner"></div>
        <p>Loading MoveNet model...</p>
    </div>

    <div id="main" style="display: none;">
        <div class="warning">
            This demo requires camera access. Stand back so your full body is visible.
        </div>

        <div class="container">
            <video id="video" width="640" height="480" autoplay playsinline></video>
            <canvas id="canvas" width="640" height="480"></canvas>
        </div>

        <div>
            <button onclick="startCamera()">Start Camera</button>
            <button onclick="toggleSkeleton()">Toggle Skeleton</button>
        </div>

        <div class="stats">
            <p>FPS: <span id="fps">0</span> | Keypoints detected: <span id="keypoints">0</span></p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@2.1.0/dist/pose-detection.min.js"></script>
    <script>
        let detector;
        let video, canvas, ctx;
        let running = false;
        let showSkeleton = true;
        let lastTime = 0;

        const KEYPOINT_NAMES = [
            'nose', 'left_eye', 'right_eye', 'left_ear', 'right_ear',
            'left_shoulder', 'right_shoulder', 'left_elbow', 'right_elbow',
            'left_wrist', 'right_wrist', 'left_hip', 'right_hip',
            'left_knee', 'right_knee', 'left_ankle', 'right_ankle'
        ];

        const SKELETON = [
            [5, 6], [5, 7], [7, 9], [6, 8], [8, 10],
            [5, 11], [6, 12], [11, 12], [11, 13], [13, 15],
            [12, 14], [14, 16]
        ];

        async function init() {
            const model = poseDetection.SupportedModels.MoveNet;
            detector = await poseDetection.createDetector(model, {
                modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING
            });

            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');

            document.getElementById('loading').style.display = 'none';
            document.getElementById('main').style.display = 'block';
        }

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480 }
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    running = true;
                    detectPose();
                };
            } catch (err) {
                alert('Camera access denied. Error: ' + err.message);
            }
        }

        function toggleSkeleton() {
            showSkeleton = !showSkeleton;
        }

        async function detectPose() {
            if (!running) return;

            const poses = await detector.estimatePoses(video);

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (poses.length > 0 && showSkeleton) {
                const pose = poses[0];
                const keypoints = pose.keypoints;

                document.getElementById('keypoints').textContent =
                    keypoints.filter(k => k.score > 0.3).length;

                // Draw skeleton
                ctx.strokeStyle = '#7C3AED';
                ctx.lineWidth = 3;
                for (let [i, j] of SKELETON) {
                    const kp1 = keypoints[i];
                    const kp2 = keypoints[j];
                    if (kp1.score > 0.3 && kp2.score > 0.3) {
                        ctx.beginPath();
                        ctx.moveTo(kp1.x, kp1.y);
                        ctx.lineTo(kp2.x, kp2.y);
                        ctx.stroke();
                    }
                }

                // Draw keypoints
                for (let kp of keypoints) {
                    if (kp.score > 0.3) {
                        ctx.beginPath();
                        ctx.arc(kp.x, kp.y, 6, 0, Math.PI * 2);
                        ctx.fillStyle = '#10B981';
                        ctx.fill();
                        ctx.strokeStyle = 'white';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    }
                }
            }

            // Calculate FPS
            const now = performance.now();
            const fps = 1000 / (now - lastTime);
            lastTime = now;
            document.getElementById('fps').textContent = Math.round(fps);

            requestAnimationFrame(detectPose);
        }

        init();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
