<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Herd Immunity Threshold</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
canvas { display: block; }
#title-overlay { position: fixed; top: 18px; left: 50%; transform: translateX(-50%); color: #fbbf24; font-size: 22px; font-weight: 700; text-shadow: 0 2px 10px rgba(0,0,0,0.7); z-index: 10; pointer-events: none; }
#controls { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); padding: 18px 28px; border-radius: 14px; color: #e0e0e0; z-index: 10; display: flex; gap: 24px; align-items: center; border: 1px solid rgba(251,191,36,0.3); font-size: 13px; }
#controls button { padding: 8px 18px; background: #fbbf24; color: #0a0e1a; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 13px; }
#controls button:hover { background: #f59e0b; }
#controls input[type=range] { width: 200px; accent-color: #fbbf24; }
.val { color: #fbbf24; font-weight: 700; font-size: 15px; }
#legend { position: fixed; top: 60px; right: 20px; background: rgba(0,0,0,0.85); padding: 14px 18px; border-radius: 10px; color: #e0e0e0; font-size: 13px; z-index: 10; border: 1px solid rgba(251,191,36,0.2); }
.legend-item { display: flex; align-items: center; gap: 8px; margin: 5px 0; }
.legend-dot { width: 12px; height: 12px; border-radius: 50%; }
#stats { position: fixed; top: 60px; left: 20px; background: rgba(0,0,0,0.85); padding: 14px 18px; border-radius: 10px; color: #e0e0e0; font-size: 13px; z-index: 10; border: 1px solid rgba(251,191,36,0.2); min-width: 180px; }
#threshold-info { position: fixed; top: 220px; left: 20px; background: rgba(0,0,0,0.85); padding: 14px 18px; border-radius: 10px; color: #e0e0e0; font-size: 12px; z-index: 10; border: 1px solid rgba(251,191,36,0.2); max-width: 190px; line-height: 1.5; }
#threshold-info .highlight { color: #fbbf24; font-weight: 700; }
</style>
</head>
<body>
<a href="../index.html" style="position:fixed;top:10px;left:10px;padding:8px 16px;background:rgba(0,0,0,0.7);color:#fbbf24;text-decoration:none;border-radius:6px;font-size:14px;z-index:999;font-family:sans-serif;">&#8592; Back to Gallery</a>
<div id="title-overlay">Herd Immunity Threshold</div>
<div id="legend">
    <div class="legend-item"><div class="legend-dot" style="background:#4a9eff;"></div> Susceptible</div>
    <div class="legend-item"><div class="legend-dot" style="background:#fbbf24;"></div> Vaccinated</div>
    <div class="legend-item"><div class="legend-dot" style="background:#ff4a4a;"></div> Infected</div>
    <div class="legend-item"><div class="legend-dot" style="background:#4aff88;"></div> Recovered</div>
</div>
<div id="stats">
    <div>Vaccination: <span id="vacPct" class="val">50%</span></div>
    <div>R0 = <span id="r0val" class="val">3.0</span></div>
    <div>Threshold: <span id="threshVal" class="val">67%</span></div>
    <div style="margin-top:8px;">Infected: <span id="infCount" style="color:#ff4a4a;">0</span></div>
    <div>Total infected: <span id="totalInf" style="color:#ff4a4a;">0</span></div>
    <div style="margin-top:6px;font-weight:700;" id="statusMsg" style="color:#fbbf24;"></div>
</div>
<div id="threshold-info">
    <div>Herd immunity threshold:</div>
    <div class="highlight">HIT = 1 - 1/R0</div>
    <div style="margin-top:8px;">When vaccination % exceeds the threshold, epidemics cannot sustain spread through the population.</div>
</div>
<div id="controls">
    <label>Vaccination % <input type="range" id="vacRate" min="0" max="100" step="1" value="50"><span class="val" id="vacRateVal">50%</span></label>
    <label>R0 <input type="range" id="r0slider" min="1" max="8" step="0.5" value="3"><span class="val" id="r0sliderVal">3.0</span></label>
    <button id="infectBtn">Introduce Infection</button>
    <button id="resetBtn">Reset</button>
</div>
<canvas id="canvas"></canvas>
<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let W, H;

const COLS = 40;
const ROWS = 25;
const S = 0, V = 1, I = 2, R = 3;
const COLORS = ['#4a9eff', '#fbbf24', '#ff4a4a', '#4aff88'];
const GLOW = ['', '', '#ff4a4a', ''];

let grid = [], cellW, cellH, totalInfected = 0, simRunning = false;

function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
    cellW = (W - 80) / COLS;
    cellH = (H - 180) / ROWS;
}

function init() {
    grid = [];
    totalInfected = 0;
    simRunning = false;
    const vacRate = parseInt(document.getElementById('vacRate').value) / 100;
    for (let r = 0; r < ROWS; r++) {
        grid[r] = [];
        for (let c = 0; c < COLS; c++) {
            grid[r][c] = {
                state: Math.random() < vacRate ? V : S,
                infectedTime: 0,
                justInfected: false
            };
        }
    }
    updateStats();
}

function infectCenter() {
    const cr = Math.floor(ROWS / 2);
    const cc = Math.floor(COLS / 2);
    if (grid[cr][cc].state === S || grid[cr][cc].state === V) {
        grid[cr][cc].state = I;
        grid[cr][cc].infectedTime = 0;
        totalInfected = 1;
    }
    simRunning = true;
}

function getNeighbors(r, c) {
    const n = [];
    for (let dr = -1; dr <= 1; dr++) {
        for (let dc = -1; dc <= 1; dc++) {
            if (dr === 0 && dc === 0) continue;
            const nr = r + dr, nc = c + dc;
            if (nr >= 0 && nr < ROWS && nc >= 0 && nc < COLS) n.push([nr, nc]);
        }
    }
    return n;
}

function update() {
    if (!simRunning) return;
    const r0 = parseFloat(document.getElementById('r0slider').value);
    const spreadProb = r0 / 8 * 0.3;
    const recoveryTime = 15;
    let anyInfected = false;

    // Mark phase
    for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
            grid[r][c].justInfected = false;
        }
    }

    for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
            const cell = grid[r][c];
            if (cell.state === I) {
                anyInfected = true;
                cell.infectedTime++;
                if (cell.infectedTime > recoveryTime) {
                    cell.state = R;
                    continue;
                }
                // Spread
                const neighbors = getNeighbors(r, c);
                for (let [nr, nc] of neighbors) {
                    if (grid[nr][nc].state === S && !grid[nr][nc].justInfected) {
                        if (Math.random() < spreadProb) {
                            grid[nr][nc].justInfected = true;
                        }
                    }
                }
            }
        }
    }

    // Apply infections
    for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
            if (grid[r][c].justInfected) {
                grid[r][c].state = I;
                grid[r][c].infectedTime = 0;
                totalInfected++;
            }
        }
    }

    if (!anyInfected && totalInfected > 0) simRunning = false;
    updateStats();
}

function updateStats() {
    const vacRate = parseInt(document.getElementById('vacRate').value);
    const r0 = parseFloat(document.getElementById('r0slider').value);
    const threshold = Math.max(0, (1 - 1 / r0) * 100);
    let infCount = 0;
    for (let r = 0; r < ROWS; r++)
        for (let c = 0; c < COLS; c++)
            if (grid[r][c].state === I) infCount++;

    document.getElementById('vacPct').textContent = vacRate + '%';
    document.getElementById('r0val').textContent = r0.toFixed(1);
    document.getElementById('threshVal').textContent = threshold.toFixed(0) + '%';
    document.getElementById('infCount').textContent = infCount;
    document.getElementById('totalInf').textContent = totalInfected;

    const msg = document.getElementById('statusMsg');
    if (vacRate >= threshold && totalInfected > 0) {
        msg.textContent = 'HERD IMMUNITY ACHIEVED';
        msg.style.color = '#4aff88';
    } else if (vacRate < threshold && totalInfected > 0) {
        msg.textContent = 'BELOW THRESHOLD - OUTBREAK';
        msg.style.color = '#ff4a4a';
    } else {
        msg.textContent = '';
    }
}

function draw() {
    ctx.fillStyle = '#0a0e1a';
    ctx.fillRect(0, 0, W, H);

    const ox = 40, oy = 80;

    for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
            const cell = grid[r][c];
            const x = ox + c * cellW;
            const y = oy + r * cellH;
            const pad = 2;

            ctx.fillStyle = COLORS[cell.state];
            if (cell.state === I) {
                ctx.shadowBlur = 12;
                ctx.shadowColor = '#ff4a4a';
                // Pulse effect
                const pulse = 1 + Math.sin(cell.infectedTime * 0.3) * 0.15;
                const pw = cellW * pulse, ph = cellH * pulse;
                ctx.beginPath();
                ctx.roundRect(x + pad - (pw - cellW) / 2, y + pad - (ph - cellH) / 2, pw - pad * 2, ph - pad * 2, 4);
                ctx.fill();
            } else {
                ctx.shadowBlur = 0;
                ctx.beginPath();
                ctx.roundRect(x + pad, y + pad, cellW - pad * 2, cellH - pad * 2, 4);
                ctx.fill();
            }
            ctx.shadowBlur = 0;

            // Border
            ctx.strokeStyle = 'rgba(255,255,255,0.05)';
            ctx.lineWidth = 0.5;
            ctx.beginPath();
            ctx.roundRect(x + pad, y + pad, cellW - pad * 2, cellH - pad * 2, 4);
            ctx.stroke();
        }
    }

    // Draw threshold line indicator
    const vacRate = parseInt(document.getElementById('vacRate').value);
    const r0 = parseFloat(document.getElementById('r0slider').value);
    const threshold = Math.max(0, (1 - 1 / r0) * 100);

    // Bar at bottom showing vac vs threshold
    const barY = oy + ROWS * cellH + 20;
    const barW = COLS * cellW;
    const barH = 20;
    ctx.fillStyle = 'rgba(255,255,255,0.1)';
    ctx.fillRect(ox, barY, barW, barH);

    // Vaccination fill
    ctx.fillStyle = '#fbbf2466';
    ctx.fillRect(ox, barY, barW * (vacRate / 100), barH);

    // Threshold marker
    const threshX = ox + barW * (threshold / 100);
    ctx.strokeStyle = '#ff4a4a';
    ctx.lineWidth = 2;
    ctx.setLineDash([4, 4]);
    ctx.beginPath();
    ctx.moveTo(threshX, barY - 5);
    ctx.lineTo(threshX, barY + barH + 5);
    ctx.stroke();
    ctx.setLineDash([]);

    ctx.fillStyle = '#ff4a4a';
    ctx.font = '11px sans-serif';
    ctx.fillText('Threshold ' + threshold.toFixed(0) + '%', threshX + 5, barY - 5);

    ctx.fillStyle = '#fbbf24';
    ctx.fillText('Vaccinated ' + vacRate + '%', ox + barW * (vacRate / 100) - 40, barY + barH + 16);
}

let tickCount = 0;
function animate() {
    tickCount++;
    if (tickCount % 5 === 0) update();
    draw();
    requestAnimationFrame(animate);
}

document.getElementById('vacRate').oninput = function() {
    document.getElementById('vacRateVal').textContent = this.value + '%';
    init();
};
document.getElementById('r0slider').oninput = function() {
    document.getElementById('r0sliderVal').textContent = parseFloat(this.value).toFixed(1);
    updateStats();
};
document.getElementById('infectBtn').onclick = infectCenter;
document.getElementById('resetBtn').onclick = init;
window.addEventListener('resize', () => { resize(); init(); });

resize();
init();
animate();
</script>
</body>
</html>
