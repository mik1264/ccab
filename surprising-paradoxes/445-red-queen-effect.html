<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Red Queen Effect - Surprising Paradoxes - CCAB</title>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&family=Nunito:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --sage: #8A9A5B;
            --moss: #606C38;
            --earth: #DDA15E;
            --cream: #FEFAE0;
            --terracotta: #BC6C25;
            --dark-moss: #3d4423;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #FEFAE0 0%, #F4F1DE 50%, #EDE8D5 100%);
            min-height: 100vh;
            color: var(--dark-moss);
            line-height: 1.7;
        }
        .organic-shape {
            position: fixed;
            border-radius: 60% 40% 50% 50% / 50% 60% 40% 50%;
            opacity: 0.12;
            z-index: 0;
            animation: morph 30s ease-in-out infinite;
        }
        .shape-1 {
            width: 600px;
            height: 600px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            top: -200px;
            right: -150px;
        }
        .shape-2 {
            width: 500px;
            height: 500px;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            bottom: -150px;
            left: -150px;
            animation-delay: -15s;
        }
        @keyframes morph {
            0%, 100% { border-radius: 60% 40% 50% 50% / 50% 60% 40% 50%; }
            25% { border-radius: 50% 60% 40% 50% / 40% 50% 60% 50%; }
            50% { border-radius: 40% 50% 60% 50% / 50% 40% 50% 60%; }
            75% { border-radius: 50% 40% 50% 60% / 60% 50% 40% 50%; }
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px 80px;
            position: relative;
            z-index: 1;
        }
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--moss);
            text-decoration: none;
            font-weight: 500;
            margin-bottom: 30px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.6);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            transition: all 0.3s ease;
        }
        .back-link:hover {
            background: rgba(255,255,255,0.9);
            transform: translateX(-5px);
        }
        h1 {
            font-family: 'Lora', serif;
            font-size: 2.8rem;
            font-weight: 600;
            color: var(--moss);
            margin-bottom: 20px;
            line-height: 1.2;
        }
        .subtitle {
            font-size: 1.3rem;
            color: var(--terracotta);
            margin-bottom: 40px;
            font-weight: 500;
        }
        .badge {
            display: inline-block;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 25px;
        }
        .card {
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(15px);
            border-radius: 24px;
            padding: 35px;
            margin-bottom: 35px;
            border: 1px solid rgba(138,154,91,0.2);
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        }
        .card h2 {
            font-family: 'Lora', serif;
            font-size: 1.6rem;
            color: var(--moss);
            margin-bottom: 20px;
        }
        .card p {
            color: #555;
            margin-bottom: 18px;
        }
        .card p:last-child { margin-bottom: 0; }
        .highlight {
            background: linear-gradient(120deg, rgba(231,76,60,0.2) 0%, rgba(231,76,60,0.1) 100%);
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
            color: #c0392b;
        }

        /* Simulation container */
        .sim-container {
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 35px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.2);
        }
        .sim-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .sim-title {
            color: #fff;
            font-family: 'Lora', serif;
            font-size: 1.3rem;
        }
        .controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-family: 'Nunito', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(231,76,60,0.4);
        }
        .btn-secondary {
            background: rgba(255,255,255,0.15);
        }
        .btn-secondary:hover {
            background: rgba(255,255,255,0.25);
            box-shadow: 0 8px 25px rgba(255,255,255,0.1);
        }
        #simCanvas {
            display: block;
            width: 100%;
            border-radius: 12px;
            background: #0f0f23;
        }

        /* Stats */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        .stat-box {
            background: rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 15px 10px;
            text-align: center;
        }
        .stat-label {
            color: rgba(255,255,255,0.6);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }
        .stat-box.host .stat-value { color: #3498db; }
        .stat-box.parasite .stat-value { color: #e74c3c; }
        .stat-box.fitness .stat-value { color: #2ecc71; }
        .stat-box.gen .stat-value { color: #f1c40f; }

        /* Generation counter */
        .gen-display {
            text-align: center;
            margin-top: 15px;
            color: rgba(255,255,255,0.7);
            font-size: 0.9rem;
        }
        .gen-display span {
            color: #f1c40f;
            font-weight: 700;
            font-size: 1.2rem;
        }

        /* Legend */
        .legend {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgba(255,255,255,0.8);
            font-size: 0.85rem;
        }
        .legend-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
        }

        /* Quote */
        .quote {
            border-left: 4px solid #e74c3c;
            padding-left: 25px;
            margin: 25px 0;
            font-style: italic;
            color: #666;
        }
        .quote-author {
            font-style: normal;
            font-weight: 600;
            color: var(--moss);
            margin-top: 10px;
        }

        /* Insight box */
        .insight-box {
            background: linear-gradient(135deg, rgba(231,76,60,0.1) 0%, rgba(192,57,43,0.05) 100%);
            border: 2px solid #e74c3c;
            border-radius: 16px;
            padding: 25px;
            margin: 25px 0;
        }
        .insight-box h3 {
            color: #c0392b;
            font-family: 'Lora', serif;
            margin-bottom: 12px;
        }

        /* Examples grid */
        .examples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .example-card {
            background: rgba(0,0,0,0.03);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        .example-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        .example-title {
            font-weight: 600;
            color: var(--moss);
            margin-bottom: 8px;
        }
        .example-text {
            font-size: 0.9rem;
            color: #666;
        }

        /* Snail study */
        .study-box {
            background: linear-gradient(135deg, rgba(46,204,113,0.1) 0%, rgba(39,174,96,0.05) 100%);
            border: 2px solid #27ae60;
            border-radius: 16px;
            padding: 25px;
            margin: 25px 0;
        }
        .study-box h3 {
            color: #27ae60;
            font-family: 'Lora', serif;
            margin-bottom: 12px;
        }

        .footer {
            text-align: center;
            padding-top: 30px;
            color: #888;
            font-size: 0.85rem;
        }
        .footer a { color: var(--moss); }

        @media (max-width: 600px) {
            h1 { font-size: 2rem; }
            .card { padding: 25px; }
            .stats-row { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="organic-shape shape-1"></div>
    <div class="organic-shape shape-2"></div>

    <main class="container">
        <a href="index.html" class="back-link">← Back to Paradoxes</a>

        <span class="badge">Evolutionary Biology</span>
        <h1>The Red Queen Effect</h1>
        <p class="subtitle">"Now, here, you see, it takes all the running you can do, to keep in the same place." — The Red Queen, Through the Looking Glass</p>

        <!-- Simulation -->
        <div class="sim-container">
            <div class="sim-header">
                <h2 class="sim-title">Host-Parasite Arms Race</h2>
                <div class="controls">
                    <button class="btn" id="runBtn">Start Evolution</button>
                    <button class="btn btn-secondary" id="resetBtn">Reset</button>
                </div>
            </div>

            <canvas id="simCanvas" width="800" height="400"></canvas>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-dot" style="background: #3498db;"></div>
                    <span>Host Genotypes</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #e74c3c;"></div>
                    <span>Parasite Genotypes</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #2ecc71;"></div>
                    <span>Host Fitness</span>
                </div>
            </div>

            <div class="stats-row">
                <div class="stat-box host">
                    <div class="stat-label">Host Diversity</div>
                    <div class="stat-value" id="hostDiv">5</div>
                </div>
                <div class="stat-box parasite">
                    <div class="stat-label">Parasite Diversity</div>
                    <div class="stat-value" id="parasiteDiv">5</div>
                </div>
                <div class="stat-box fitness">
                    <div class="stat-label">Avg Host Fitness</div>
                    <div class="stat-value" id="avgFitness">50%</div>
                </div>
                <div class="stat-box gen">
                    <div class="stat-label">Generation</div>
                    <div class="stat-value" id="genCount">0</div>
                </div>
            </div>

            <div class="gen-display">
                Despite constant evolution, average fitness remains around <span>50%</span> — running to stay in place
            </div>
        </div>

        <!-- The Effect -->
        <div class="card">
            <h2>Running Just to Stay Still</h2>
            <p>In 1973, evolutionary biologist <strong>Leigh Van Valen</strong> proposed a startling hypothesis: species must <span class="highlight">constantly evolve just to maintain their fitness</span> relative to the species they interact with.</p>
            <p>Named after Lewis Carroll's Red Queen from <em>Through the Looking Glass</em>, the effect explains why:</p>
            <ul style="margin-left: 25px; color: #555;">
                <li>Predators evolve faster legs, prey evolve faster legs, and neither gains lasting advantage</li>
                <li>Bacteria evolve antibiotic resistance, we develop new antibiotics, and the race continues</li>
                <li>The probability of extinction remains constant over millions of years</li>
            </ul>
            <p>Van Valen's Law: <strong>extinction probability doesn't decrease with age</strong>. A species that has survived 10 million years is just as likely to go extinct as one that's 1 million years old—because the evolutionary "arms race" never stops.</p>
        </div>

        <!-- Van Valen's Law -->
        <div class="card">
            <h2>Van Valen's Law of Constant Extinction</h2>
            <p>Analyzing fossil data across many taxa, Van Valen discovered that extinction follows an exponential pattern with a <strong>constant rate</strong>—not a decreasing one as you'd expect if species became better adapted over time.</p>

            <div class="insight-box">
                <h3>The Paradox</h3>
                <p>If natural selection makes species better adapted, why doesn't survival probability improve over time? Because the environment isn't static—it's filled with other evolving species. Your competitors, predators, and parasites are all improving too. <strong>Staying the same means falling behind.</strong></p>
            </div>

            <div class="quote">
                "The effective environment for any species is always deteriorating because its competitors, predators, and parasites are always evolving."
                <div class="quote-author">— Leigh Van Valen, 1973</div>
            </div>
        </div>

        <!-- Sexual Reproduction -->
        <div class="card">
            <h2>Why Sex Exists: The Red Queen's Answer</h2>
            <p>Sexual reproduction is costly—you only pass on 50% of your genes. Asexual reproduction seems more efficient. So why does sex dominate complex life?</p>
            <p>The Red Queen hypothesis provides an elegant answer: <span class="highlight">parasites adapt to common genotypes</span>. If you reproduce asexually, creating clones of yourself, parasites will evolve to exploit your exact genetic signature. Your descendants become sitting ducks.</p>
            <p>Sexual reproduction shuffles the genetic deck every generation, creating offspring with novel combinations that parasites haven't yet adapted to. The cost of sex is the price of staying one step ahead.</p>

            <div class="study-box">
                <h3>The Snail Evidence</h3>
                <p>Researchers studied New Zealand mud snails (<em>Potamopyrgus antipodarum</em>), which can reproduce both sexually and asexually. Over years of observation:</p>
                <ul style="margin-left: 20px; color: #555; margin-top: 10px;">
                    <li>Common clonal types became increasingly infected by parasites</li>
                    <li>Once-abundant clones <strong>disappeared entirely</strong></li>
                    <li>Sexual populations remained stable—their genetic diversity kept them ahead of parasites</li>
                </ul>
            </div>
        </div>

        <!-- Examples -->
        <div class="card">
            <h2>Arms Races Everywhere</h2>

            <div class="examples-grid">
                <div class="example-card">
                    <div class="example-icon">&#129440;</div>
                    <div class="example-title">Antibiotics vs Bacteria</div>
                    <div class="example-text">We develop new antibiotics; bacteria evolve resistance. MRSA, superbugs—the race never ends.</div>
                </div>
                <div class="example-card">
                    <div class="example-icon">&#128034;</div>
                    <div class="example-title">Cheetahs & Gazelles</div>
                    <div class="example-text">Cheetahs evolve speed; gazelles evolve speed. Both run faster, but neither gains lasting advantage.</div>
                </div>
                <div class="example-card">
                    <div class="example-icon">&#127793;</div>
                    <div class="example-title">Plants & Herbivores</div>
                    <div class="example-text">Plants evolve toxins; insects evolve detoxification enzymes. The chemical warfare continues.</div>
                </div>
                <div class="example-card">
                    <div class="example-icon">&#128187;</div>
                    <div class="example-title">Security & Hackers</div>
                    <div class="example-text">We patch vulnerabilities; hackers find new exploits. Cybersecurity is a technological Red Queen race.</div>
                </div>
                <div class="example-card">
                    <div class="example-icon">&#127942;</div>
                    <div class="example-title">Sports Performance</div>
                    <div class="example-text">Training methods improve; all athletes improve. Records fall, but relative rankings stay similar.</div>
                </div>
                <div class="example-card">
                    <div class="example-icon">&#128200;</div>
                    <div class="example-title">Business Competition</div>
                    <div class="example-text">Companies innovate to gain advantage; competitors copy. Market share remains contested.</div>
                </div>
            </div>
        </div>

        <!-- Implications -->
        <div class="card">
            <h2>What the Red Queen Teaches Us</h2>

            <p><strong>1. Stasis is Decay</strong><br>
            In any competitive system, standing still means falling behind. The environment changes because your competitors are changing it.</p>

            <p><strong>2. Diversity is Survival</strong><br>
            Genetic diversity, strategy diversity, portfolio diversity—variation provides insurance against opponents who adapt to your current approach.</p>

            <p><strong>3. The Race Has No Finish Line</strong><br>
            There's no "winning" state where you can stop evolving. Fitness is relative, and your competitors define the goalposts.</p>

            <p><strong>4. Absolute Progress, Relative Stagnation</strong><br>
            Both cheetahs and gazelles have become faster over millions of years (absolute improvement). But neither has gained lasting advantage over the other (relative stagnation). This explains why fitness seems to stay constant despite constant evolution.</p>

            <div class="insight-box">
                <h3>The Counter-Hypothesis: The Court Jester</h3>
                <p>Some scientists argue that <strong>abiotic factors</strong> (climate, geology, asteroids) drive more evolution than biotic arms races. The "Court Jester" hypothesis suggests that random environmental changes, not competition, cause most extinctions. The truth likely involves both forces operating at different scales.</p>
            </div>
        </div>

        <div class="footer">
            <p>Sources: <a href="https://en.wikipedia.org/wiki/Red_Queen_hypothesis" target="_blank">Wikipedia</a>,
            <a href="https://royalsocietypublishing.org/doi/10.1098/rspb.2014.1382" target="_blank">Royal Society</a>,
            <a href="https://santafe.edu/research/results/papers/206-revisiting-van-valens-red-queen-hypothesis" target="_blank">Santa Fe Institute</a></p>
            <p style="margin-top: 10px;">Part of <a href="../index.html">CCAB</a> &middot; Surprising Paradoxes Collection</p>
        </div>
    </main>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');

        // High DPI
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);
        canvas.style.width = rect.width + 'px';
        canvas.style.height = rect.height + 'px';

        const W = rect.width;
        const H = rect.height;

        // Simulation state
        let generation = 0;
        let isRunning = false;
        let animFrame;

        // Host and parasite populations
        let hosts = [];
        let parasites = [];
        let fitnessHistory = [];
        let hostDiversityHistory = [];
        let parasiteDiversityHistory = [];

        // Initialize populations
        function initPopulation() {
            hosts = [];
            parasites = [];

            // Create diverse initial populations
            for (let i = 0; i < 100; i++) {
                hosts.push({
                    genotype: Math.floor(Math.random() * 10), // 0-9 genotype
                    fitness: 0.5
                });
            }

            for (let i = 0; i < 50; i++) {
                parasites.push({
                    genotype: Math.floor(Math.random() * 10),
                    target: Math.floor(Math.random() * 10) // Which host genotype they target
                });
            }

            generation = 0;
            fitnessHistory = [0.5];
            hostDiversityHistory = [countUnique(hosts.map(h => h.genotype))];
            parasiteDiversityHistory = [countUnique(parasites.map(p => p.genotype))];

            updateStats();
            draw();
        }

        function countUnique(arr) {
            return new Set(arr).size;
        }

        // Evolution step
        function evolve() {
            // Calculate infection rates for each host genotype
            const hostGenotypeCounts = {};
            hosts.forEach(h => {
                hostGenotypeCounts[h.genotype] = (hostGenotypeCounts[h.genotype] || 0) + 1;
            });

            // Parasites target common genotypes
            const parasiteTargets = {};
            parasites.forEach(p => {
                parasiteTargets[p.target] = (parasiteTargets[p.target] || 0) + 1;
            });

            // Update host fitness based on parasite pressure
            hosts.forEach(host => {
                const frequency = hostGenotypeCounts[host.genotype] / hosts.length;
                const parasitePressure = (parasiteTargets[host.genotype] || 0) / parasites.length;

                // Common hosts get targeted more
                host.fitness = 0.8 - frequency * 0.5 - parasitePressure * 0.3 + Math.random() * 0.2;
                host.fitness = Math.max(0.1, Math.min(0.9, host.fitness));
            });

            // Reproduction with selection
            const newHosts = [];
            for (let i = 0; i < 100; i++) {
                // Tournament selection
                const candidates = [
                    hosts[Math.floor(Math.random() * hosts.length)],
                    hosts[Math.floor(Math.random() * hosts.length)]
                ];
                const parent = candidates[0].fitness > candidates[1].fitness ? candidates[0] : candidates[1];

                // Reproduce with mutation
                let childGenotype = parent.genotype;
                if (Math.random() < 0.1) {
                    childGenotype = (childGenotype + (Math.random() < 0.5 ? 1 : -1) + 10) % 10;
                }

                newHosts.push({
                    genotype: childGenotype,
                    fitness: 0.5
                });
            }
            hosts = newHosts;

            // Parasites evolve to target common host genotypes
            const newParasites = [];
            const sortedGenotypes = Object.entries(hostGenotypeCounts)
                .sort((a, b) => b[1] - a[1])
                .map(e => parseInt(e[0]));

            for (let i = 0; i < 50; i++) {
                // Parasites that target common hosts reproduce more
                const candidates = [
                    parasites[Math.floor(Math.random() * parasites.length)],
                    parasites[Math.floor(Math.random() * parasites.length)]
                ];
                const targetFreq0 = hostGenotypeCounts[candidates[0].target] || 0;
                const targetFreq1 = hostGenotypeCounts[candidates[1].target] || 0;
                const parent = targetFreq0 > targetFreq1 ? candidates[0] : candidates[1];

                let childTarget = parent.target;
                if (Math.random() < 0.15) {
                    // Mutate to target a different genotype
                    childTarget = sortedGenotypes[Math.floor(Math.random() * Math.min(3, sortedGenotypes.length))];
                }

                newParasites.push({
                    genotype: (parent.genotype + (Math.random() < 0.1 ? 1 : 0)) % 10,
                    target: childTarget
                });
            }
            parasites = newParasites;

            // Record history
            const avgFitness = hosts.reduce((sum, h) => sum + h.fitness, 0) / hosts.length;
            fitnessHistory.push(avgFitness);
            if (fitnessHistory.length > 200) fitnessHistory.shift();

            hostDiversityHistory.push(countUnique(hosts.map(h => h.genotype)));
            parasiteDiversityHistory.push(countUnique(parasites.map(p => p.genotype)));
            if (hostDiversityHistory.length > 200) {
                hostDiversityHistory.shift();
                parasiteDiversityHistory.shift();
            }

            generation++;
        }

        // Draw
        function draw() {
            ctx.fillStyle = '#0f0f23';
            ctx.fillRect(0, 0, W, H);

            // Grid
            ctx.strokeStyle = 'rgba(255,255,255,0.05)';
            ctx.lineWidth = 1;
            for (let x = 0; x < W; x += 50) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, H);
                ctx.stroke();
            }
            for (let y = 0; y < H; y += 50) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(W, y);
                ctx.stroke();
            }

            const padding = 50;
            const graphW = W - padding * 2;
            const graphH = H - padding * 2;

            // Draw fitness history line (green)
            if (fitnessHistory.length > 1) {
                ctx.strokeStyle = '#2ecc71';
                ctx.lineWidth = 2;
                ctx.beginPath();
                fitnessHistory.forEach((f, i) => {
                    const x = padding + (i / (fitnessHistory.length - 1)) * graphW;
                    const y = H - padding - f * graphH;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();

                // 50% line
                ctx.strokeStyle = 'rgba(46,204,113,0.3)';
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(padding, H - padding - 0.5 * graphH);
                ctx.lineTo(W - padding, H - padding - 0.5 * graphH);
                ctx.stroke();
                ctx.setLineDash([]);

                ctx.fillStyle = 'rgba(46,204,113,0.5)';
                ctx.font = '11px Nunito';
                ctx.fillText('50% fitness equilibrium', padding + 5, H - padding - 0.5 * graphH - 5);
            }

            // Draw host diversity (blue)
            if (hostDiversityHistory.length > 1) {
                ctx.strokeStyle = '#3498db';
                ctx.lineWidth = 2;
                ctx.beginPath();
                hostDiversityHistory.forEach((d, i) => {
                    const x = padding + (i / (hostDiversityHistory.length - 1)) * graphW;
                    const y = H - padding - (d / 10) * graphH * 0.8;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();
            }

            // Draw parasite diversity (red)
            if (parasiteDiversityHistory.length > 1) {
                ctx.strokeStyle = '#e74c3c';
                ctx.lineWidth = 2;
                ctx.beginPath();
                parasiteDiversityHistory.forEach((d, i) => {
                    const x = padding + (i / (parasiteDiversityHistory.length - 1)) * graphW;
                    const y = H - padding - (d / 10) * graphH * 0.8;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();
            }

            // Draw host/parasite populations as circles
            const popX = W - 120;
            const popY = 80;

            // Host genotype distribution
            const hostCounts = {};
            hosts.forEach(h => {
                hostCounts[h.genotype] = (hostCounts[h.genotype] || 0) + 1;
            });

            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            ctx.font = '10px Nunito';
            ctx.fillText('Host Genotypes', popX - 40, popY - 50);

            Object.entries(hostCounts).forEach(([genotype, count], i) => {
                const angle = (parseInt(genotype) / 10) * Math.PI * 2;
                const radius = 30;
                const x = popX + Math.cos(angle) * radius;
                const y = popY + Math.sin(angle) * radius;
                const size = 3 + count / 10;

                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2);
                ctx.fillStyle = `hsl(${parseInt(genotype) * 36}, 70%, 50%)`;
                ctx.fill();
            });

            // Parasite targets
            const parasiteCounts = {};
            parasites.forEach(p => {
                parasiteCounts[p.target] = (parasiteCounts[p.target] || 0) + 1;
            });

            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            ctx.fillText('Parasite Targets', popX - 40, popY + 60);

            Object.entries(parasiteCounts).forEach(([target, count]) => {
                const angle = (parseInt(target) / 10) * Math.PI * 2;
                const radius = 30;
                const x = popX + Math.cos(angle) * radius;
                const y = popY + 110 + Math.sin(angle) * radius;
                const size = 3 + count / 5;

                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2);
                ctx.fillStyle = '#e74c3c';
                ctx.fill();

                // Draw targeting line
                const hostX = popX + Math.cos(angle) * 30;
                const hostY = popY + Math.sin(angle) * 30;
                ctx.strokeStyle = 'rgba(231,76,60,0.2)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.lineTo(hostX, hostY);
                ctx.stroke();
            });

            // Axes
            ctx.strokeStyle = 'rgba(255,255,255,0.3)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, H - padding);
            ctx.lineTo(W - padding - 180, H - padding);
            ctx.stroke();

            // Labels
            ctx.fillStyle = 'rgba(255,255,255,0.6)';
            ctx.font = '12px Nunito';
            ctx.textAlign = 'center';
            ctx.fillText('Generations', (W - 180) / 2, H - 15);
        }

        // Update stats display
        function updateStats() {
            document.getElementById('hostDiv').textContent = countUnique(hosts.map(h => h.genotype));
            document.getElementById('parasiteDiv').textContent = countUnique(parasites.map(p => p.genotype));

            const avgFitness = hosts.reduce((sum, h) => sum + h.fitness, 0) / hosts.length;
            document.getElementById('avgFitness').textContent = Math.round(avgFitness * 100) + '%';
            document.getElementById('genCount').textContent = generation;
        }

        // Animation loop
        function animate() {
            if (isRunning) {
                evolve();
                updateStats();
                draw();
                animFrame = setTimeout(() => requestAnimationFrame(animate), 80);
            }
        }

        // Event handlers
        document.getElementById('runBtn').addEventListener('click', function() {
            if (isRunning) {
                isRunning = false;
                this.textContent = 'Resume';
            } else {
                isRunning = true;
                this.textContent = 'Pause';
                animate();
            }
        });

        document.getElementById('resetBtn').addEventListener('click', function() {
            isRunning = false;
            document.getElementById('runBtn').textContent = 'Start Evolution';
            initPopulation();
        });

        // Initialize
        initPopulation();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
