<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Ponzo Illusion - When Perspective Lies</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5em;
            color: #e94560;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.2em;
            color: #a0a0a0;
            font-style: italic;
        }

        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #e94560;
            text-decoration: none;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 100;
            background: rgba(26, 26, 46, 0.9);
            padding: 8px 15px;
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        .back-link:hover {
            background: rgba(233, 69, 96, 0.2);
            transform: translateX(-3px);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel h2 {
            color: #e94560;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .canvas-container {
            text-align: center;
            margin-bottom: 20px;
        }

        canvas {
            background: #0a0a15;
            border-radius: 10px;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            color: #a0a0a0;
            font-size: 0.9em;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #e94560;
            cursor: pointer;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, #e94560, #0f3460);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(233, 69, 96, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .reveal-text {
            margin-top: 15px;
            padding: 15px;
            background: rgba(233, 69, 96, 0.2);
            border-radius: 10px;
            border: 1px solid #e94560;
            font-weight: bold;
            display: none;
        }

        .reveal-text.visible {
            display: block;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .explanation {
            line-height: 1.8;
        }

        .explanation p {
            margin-bottom: 15px;
        }

        .highlight {
            color: #e94560;
            font-weight: bold;
        }

        .moon-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 600px) {
            .moon-section {
                grid-template-columns: 1fr;
            }
        }

        .moon-card {
            background: rgba(255, 255, 255, 0.08);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .moon-card h3 {
            color: #e94560;
            margin-bottom: 10px;
        }

        .history-box {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #e94560;
        }

        .history-box h3 {
            color: #e94560;
            margin-bottom: 10px;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .comparison-card {
            background: rgba(255, 255, 255, 0.08);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .comparison-card canvas {
            width: 100%;
            height: 100px;
        }

        .game-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            width: 100%;
            text-align: center;
            margin-bottom: 20px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.08);
            padding: 15px;
            border-radius: 10px;
        }

        .stat-value {
            font-size: 2em;
            color: #e94560;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.85em;
            color: #a0a0a0;
        }

        .real-world-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .example-card {
            background: rgba(255, 255, 255, 0.08);
            padding: 20px;
            border-radius: 10px;
        }

        .example-card h3 {
            color: #4ecdc4;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">
        <span>←</span> Back to Paradoxes
    </a>

    <div class="container">
        <header>
            <h1>The Ponzo Illusion</h1>
            <p class="subtitle">Converging lines trick your brain about size</p>
        </header>

        <div class="main-content">
            <!-- Classic Railroad Demo -->
            <div class="panel">
                <h2>Classic Railroad Tracks</h2>
                <div class="canvas-container">
                    <canvas id="railroadCanvas" width="450" height="350"></canvas>
                </div>
                <p style="text-align: center; color: #a0a0a0; margin-bottom: 15px;">
                    Which yellow bar is LONGER?
                </p>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="guessTop()">Top Bar</button>
                    <button class="btn btn-secondary" onclick="guessBottom()">Bottom Bar</button>
                    <button class="btn btn-primary" onclick="revealRailroad()">Reveal Truth</button>
                </div>
                <div id="railroadReveal" class="reveal-text"></div>
            </div>

            <!-- Interactive Size Matcher -->
            <div class="panel">
                <h2>Match the Bars</h2>
                <div class="canvas-container">
                    <canvas id="matchCanvas" width="450" height="350"></canvas>
                </div>
                <div class="controls">
                    <div class="control-group">
                        <label>Adjust bottom bar to match top bar: <span id="matchValue">100%</span></label>
                        <input type="range" id="matchSlider" min="60" max="140" value="100" oninput="updateMatch()">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="checkMatch()">Check My Perception</button>
                        <button class="btn btn-secondary" onclick="resetMatch()">Reset</button>
                    </div>
                </div>
                <div id="matchResult" class="reveal-text"></div>
            </div>

            <!-- Convergence Angle -->
            <div class="panel">
                <h2>Vary the Perspective</h2>
                <div class="canvas-container">
                    <canvas id="angleCanvas" width="450" height="350"></canvas>
                </div>
                <div class="controls">
                    <div class="control-group">
                        <label>Convergence Angle: <span id="convergeValue">15°</span></label>
                        <input type="range" id="convergeSlider" min="0" max="30" value="15" oninput="updateAngle()">
                    </div>
                    <div class="control-group">
                        <label>Bar Separation: <span id="separationValue">60%</span></label>
                        <input type="range" id="separationSlider" min="20" max="80" value="60" oninput="updateAngle()">
                    </div>
                </div>
                <p style="margin-top: 15px; color: #a0a0a0; font-size: 0.9em;">
                    At 0° (parallel lines) the illusion DISAPPEARS! The steeper the convergence, the stronger the effect.
                </p>
            </div>

            <!-- Without Context -->
            <div class="panel">
                <h2>Context is Everything</h2>
                <div class="canvas-container">
                    <canvas id="contextCanvas" width="450" height="350"></canvas>
                </div>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="setContext('full')">Full Context</button>
                    <button class="btn btn-secondary" onclick="setContext('lines')">Lines Only</button>
                    <button class="btn btn-secondary" onclick="setContext('bars')">Bars Only</button>
                    <button class="btn btn-secondary" onclick="setContext('none')">Remove All</button>
                </div>
                <p style="margin-top: 15px; color: #a0a0a0; font-size: 0.9em; text-align: center;">
                    Remove the converging lines—the illusion vanishes! Both bars are identical.
                </p>
            </div>

            <!-- Perception Game -->
            <div class="panel full-width">
                <h2>Size Judgment Game</h2>
                <div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
                    <canvas id="gameCanvas" width="800" height="300"></canvas>
                    <div class="game-stats">
                        <div class="stat-box">
                            <div class="stat-value" id="trialNum">0</div>
                            <div class="stat-label">Trial</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="correctCount">0</div>
                            <div class="stat-label">Correct</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="accuracy">0%</div>
                            <div class="stat-label">Accuracy</div>
                        </div>
                    </div>
                    <p id="gameInstruction" style="color: #a0a0a0;">Which bar is ACTUALLY longer? The perspective will try to fool you!</p>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
                        <button class="btn btn-primary" id="startBtn" onclick="startGame()">Start Game</button>
                        <button class="btn btn-secondary" id="topBtn" onclick="gameAnswer('top')" style="display:none;">Top is Longer</button>
                        <button class="btn btn-secondary" id="sameBtn" onclick="gameAnswer('same')" style="display:none;">They're Equal</button>
                        <button class="btn btn-secondary" id="bottomBtn" onclick="gameAnswer('bottom')" style="display:none;">Bottom is Longer</button>
                    </div>
                </div>
            </div>

            <!-- Moon Illusion Connection -->
            <div class="panel full-width">
                <h2>The Moon Illusion Connection</h2>
                <p style="margin-bottom: 15px;">
                    The Ponzo illusion may explain one of nature's most puzzling phenomena:
                    <span class="highlight">why does the Moon look HUGE on the horizon but small overhead?</span>
                </p>
                <div class="moon-section">
                    <div class="moon-card">
                        <canvas id="moonHorizonCanvas" width="300" height="200"></canvas>
                        <h3>Horizon Moon</h3>
                        <p style="color: #a0a0a0; font-size: 0.9em;">
                            Trees, buildings, and horizon lines provide "converging" depth cues—like railroad tracks!
                        </p>
                    </div>
                    <div class="moon-card">
                        <canvas id="moonZenithCanvas" width="300" height="200"></canvas>
                        <h3>Overhead Moon</h3>
                        <p style="color: #a0a0a0; font-size: 0.9em;">
                            No depth cues in empty sky—your brain sees the moon's TRUE angular size.
                        </p>
                    </div>
                </div>
                <p style="margin-top: 20px; color: #a0a0a0;">
                    The Moon's angular size is ALWAYS ~0.5°! Take a photo at horizon vs zenith—they're identical.
                    But your brain "enlarges" the horizon Moon because depth cues suggest it's "far away" (and far things that look big must be HUGE).
                </p>
            </div>

            <!-- Real World Examples -->
            <div class="panel full-width">
                <h2>Real-World Ponzo Effects</h2>
                <div class="real-world-grid">
                    <div class="example-card">
                        <h3>Road Markings</h3>
                        <p>Distant lane markings on highways appear narrower due to perspective—traffic engineers must account for this when designing signage visible from far away.</p>
                    </div>
                    <div class="example-card">
                        <h3>Architecture</h3>
                        <p>Ancient Greek architects tilted columns slightly outward and made them thicker at the top to counteract perspective shrinkage—making temples look "perfect."</p>
                    </div>
                    <div class="example-card">
                        <h3>Photography</h3>
                        <p>Telephoto lenses "compress" perspective, making distant objects look larger relative to foreground—the opposite of what wide-angle lenses do.</p>
                    </div>
                    <div class="example-card">
                        <h3>Aviation</h3>
                        <p>Pilots train to overcome the Ponzo illusion when landing—runway perspective can make altitude seem wrong, causing dangerous misjudgments.</p>
                    </div>
                </div>
            </div>

            <!-- Explanation -->
            <div class="panel full-width explanation">
                <h2>The Science of Misperceived Size</h2>
                <p>
                    The <span class="highlight">Ponzo Illusion</span>, discovered by Italian psychologist
                    <span class="highlight">Mario Ponzo in 1911</span>, demonstrates how our brain uses
                    linear perspective as a depth cue—and then "corrects" the size of objects based on
                    their perceived distance.
                </p>
                <p>
                    <strong>The "Size Constancy" Mechanism:</strong> Your brain automatically adjusts
                    perceived size based on estimated distance. An object twice as far away projects
                    a retinal image half the size—but you don't see it as "smaller," you see it as
                    "same size, but farther." This is usually helpful!
                </p>
                <p>
                    <strong>But When Fooled...</strong> Converging lines signal "depth" to your visual
                    system. The top bar, sitting where the lines converge (the "far" point), triggers
                    size constancy scaling—your brain thinks: "If it's far away AND it has this retinal
                    size, it must be HUGE!" The bottom bar, at the "near" point, doesn't get this boost.
                </p>
                <p>
                    <strong>Proof It's Automatic:</strong> Even knowing both bars are identical, you
                    CANNOT see them as equal. The illusion is processed before conscious awareness—
                    in the primary visual cortex (V1), which applies learned perspective rules
                    involuntarily.
                </p>

                <div class="history-box">
                    <h3>Historical Note</h3>
                    <p>
                        Mario Ponzo was a pioneer of Gestalt psychology in Italy. He published the
                        illusion in 1911, but it gained fame through later research showing it affects
                        not just adults but infants as young as 7 months—suggesting the perspective
                        mechanism is either innate or learned VERY early. The Ponzo effect is now a
                        standard tool for studying visual development and cross-cultural perception.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== RAILROAD TRACKS ==========
        const railroadCanvas = document.getElementById('railroadCanvas');
        const railroadCtx = railroadCanvas.getContext('2d');

        function drawRailroad(showMeasures = false) {
            railroadCtx.fillStyle = '#0a0a15';
            railroadCtx.fillRect(0, 0, railroadCanvas.width, railroadCanvas.height);

            const centerX = railroadCanvas.width / 2;
            const topY = 60;
            const bottomY = 300;
            const convergeFactor = 0.6; // How much lines converge at top

            // Draw railroad ties (crossbeams)
            railroadCtx.strokeStyle = '#5a4a3a';
            railroadCtx.lineWidth = 4;
            for (let i = 0; i < 12; i++) {
                const y = bottomY - i * 22;
                const progress = i / 11;
                const width = 180 * (1 - progress * convergeFactor);
                railroadCtx.beginPath();
                railroadCtx.moveTo(centerX - width/2, y);
                railroadCtx.lineTo(centerX + width/2, y);
                railroadCtx.stroke();
            }

            // Draw converging rails
            railroadCtx.strokeStyle = '#888';
            railroadCtx.lineWidth = 3;

            const bottomWidth = 160;
            const topWidth = bottomWidth * (1 - convergeFactor);

            // Left rail
            railroadCtx.beginPath();
            railroadCtx.moveTo(centerX - bottomWidth/2, bottomY);
            railroadCtx.lineTo(centerX - topWidth/2, topY);
            railroadCtx.stroke();

            // Right rail
            railroadCtx.beginPath();
            railroadCtx.moveTo(centerX + bottomWidth/2, bottomY);
            railroadCtx.lineTo(centerX + topWidth/2, topY);
            railroadCtx.stroke();

            // Draw the two yellow bars (SAME SIZE)
            const barLength = 80;
            const barHeight = 12;
            const topBarY = 100;
            const bottomBarY = 260;

            railroadCtx.fillStyle = '#f1c40f';

            // Top bar
            railroadCtx.fillRect(centerX - barLength/2, topBarY - barHeight/2, barLength, barHeight);

            // Bottom bar
            railroadCtx.fillRect(centerX - barLength/2, bottomBarY - barHeight/2, barLength, barHeight);

            if (showMeasures) {
                // Draw measurement lines
                railroadCtx.strokeStyle = '#e94560';
                railroadCtx.lineWidth = 2;
                railroadCtx.setLineDash([5, 5]);

                // Measurement brackets
                const measureY1 = topBarY + 25;
                const measureY2 = bottomBarY + 25;

                railroadCtx.beginPath();
                railroadCtx.moveTo(centerX - barLength/2, measureY1);
                railroadCtx.lineTo(centerX + barLength/2, measureY1);
                railroadCtx.moveTo(centerX - barLength/2, measureY2);
                railroadCtx.lineTo(centerX + barLength/2, measureY2);
                railroadCtx.stroke();

                railroadCtx.setLineDash([]);

                // Labels
                railroadCtx.fillStyle = '#e94560';
                railroadCtx.font = 'bold 14px Georgia';
                railroadCtx.textAlign = 'center';
                railroadCtx.fillText(`${barLength}px`, centerX, measureY1 + 20);
                railroadCtx.fillText(`${barLength}px`, centerX, measureY2 + 20);
                railroadCtx.fillText('IDENTICAL!', centerX, 180);
            }
        }

        function guessTop() {
            document.getElementById('railroadReveal').innerHTML =
                'You said TOP is longer. That\'s what most people see—let\'s check!';
            document.getElementById('railroadReveal').classList.add('visible');
        }

        function guessBottom() {
            document.getElementById('railroadReveal').innerHTML =
                'Interesting! You said BOTTOM is longer. Let\'s reveal the truth!';
            document.getElementById('railroadReveal').classList.add('visible');
        }

        function revealRailroad() {
            drawRailroad(true);
            document.getElementById('railroadReveal').innerHTML =
                '<strong>THEY\'RE IDENTICAL!</strong> Both bars are exactly 80 pixels wide. ' +
                'The converging lines create a false sense of depth, making the "distant" top bar appear 15-30% larger. ' +
                'Your brain\'s size constancy mechanism was fooled!';
            document.getElementById('railroadReveal').classList.add('visible');

            setTimeout(() => drawRailroad(false), 5000);
        }

        // ========== SIZE MATCHER ==========
        const matchCanvas = document.getElementById('matchCanvas');
        const matchCtx = matchCanvas.getContext('2d');
        let matchRatio = 100;

        function drawMatch() {
            matchCtx.fillStyle = '#0a0a15';
            matchCtx.fillRect(0, 0, matchCanvas.width, matchCanvas.height);

            const centerX = matchCanvas.width / 2;
            const topY = 60;
            const bottomY = 300;
            const convergeFactor = 0.6;

            // Draw converging lines
            matchCtx.strokeStyle = '#666';
            matchCtx.lineWidth = 3;

            const bottomWidth = 160;
            const topWidth = bottomWidth * (1 - convergeFactor);

            matchCtx.beginPath();
            matchCtx.moveTo(centerX - bottomWidth/2, bottomY);
            matchCtx.lineTo(centerX - topWidth/2, topY);
            matchCtx.stroke();

            matchCtx.beginPath();
            matchCtx.moveTo(centerX + bottomWidth/2, bottomY);
            matchCtx.lineTo(centerX + topWidth/2, topY);
            matchCtx.stroke();

            // Draw bars
            const topBarLength = 80;
            const bottomBarLength = 80 * (matchRatio / 100);
            const barHeight = 12;
            const topBarY = 100;
            const bottomBarY = 260;

            matchCtx.fillStyle = '#f1c40f';
            matchCtx.fillRect(centerX - topBarLength/2, topBarY - barHeight/2, topBarLength, barHeight);
            matchCtx.fillRect(centerX - bottomBarLength/2, bottomBarY - barHeight/2, bottomBarLength, barHeight);

            // Labels
            matchCtx.fillStyle = '#a0a0a0';
            matchCtx.font = '14px Georgia';
            matchCtx.textAlign = 'center';
            matchCtx.fillText('REFERENCE (fixed)', centerX, topBarY + 30);
            matchCtx.fillText('ADJUSTABLE', centerX, bottomBarY + 30);
        }

        function updateMatch() {
            matchRatio = parseInt(document.getElementById('matchSlider').value);
            document.getElementById('matchValue').textContent = matchRatio + '%';
            drawMatch();
        }

        function checkMatch() {
            const error = matchRatio - 100;
            let message = '';

            if (Math.abs(error) <= 3) {
                message = '<strong>PERFECT!</strong> You matched them accurately. Either you measured carefully or have exceptional calibration!';
            } else if (error < 0) {
                message = `<strong>Ponzo effect confirmed!</strong> You made the bottom bar ${Math.abs(error)}% SMALLER—because the top bar looked bigger than it is. Typical error: 15-25%!`;
            } else {
                message = `<strong>Unusual!</strong> You made the bottom bar ${error}% LARGER. Most people do the opposite—you may have over-compensated!`;
            }

            document.getElementById('matchResult').innerHTML = message;
            document.getElementById('matchResult').classList.add('visible');
        }

        function resetMatch() {
            document.getElementById('matchSlider').value = 100;
            matchRatio = 100;
            document.getElementById('matchValue').textContent = '100%';
            document.getElementById('matchResult').classList.remove('visible');
            drawMatch();
        }

        // ========== ANGLE EXPERIMENT ==========
        const angleCanvas = document.getElementById('angleCanvas');
        const angleCtx = angleCanvas.getContext('2d');

        function drawAngle() {
            angleCtx.fillStyle = '#0a0a15';
            angleCtx.fillRect(0, 0, angleCanvas.width, angleCanvas.height);

            const centerX = angleCanvas.width / 2;
            const topY = 60;
            const bottomY = 300;

            const angle = parseInt(document.getElementById('convergeSlider').value);
            const separation = parseInt(document.getElementById('separationSlider').value) / 100;

            // Calculate convergence from angle
            const convergeFactor = angle / 50; // 0-0.6 range

            // Draw converging lines
            angleCtx.strokeStyle = '#666';
            angleCtx.lineWidth = 3;

            const bottomWidth = 200;
            const topWidth = bottomWidth * (1 - convergeFactor);

            angleCtx.beginPath();
            angleCtx.moveTo(centerX - bottomWidth/2, bottomY);
            angleCtx.lineTo(centerX - topWidth/2, topY);
            angleCtx.stroke();

            angleCtx.beginPath();
            angleCtx.moveTo(centerX + bottomWidth/2, bottomY);
            angleCtx.lineTo(centerX + topWidth/2, topY);
            angleCtx.stroke();

            // Draw bars based on separation
            const barLength = 70;
            const barHeight = 10;
            const midY = (topY + bottomY) / 2;
            const spread = (bottomY - topY) * separation / 2;

            const topBarY = midY - spread;
            const bottomBarY = midY + spread;

            angleCtx.fillStyle = '#f1c40f';
            angleCtx.fillRect(centerX - barLength/2, topBarY - barHeight/2, barLength, barHeight);
            angleCtx.fillRect(centerX - barLength/2, bottomBarY - barHeight/2, barLength, barHeight);

            // Show angle label
            angleCtx.fillStyle = '#4ecdc4';
            angleCtx.font = '12px Georgia';
            angleCtx.textAlign = 'left';
            angleCtx.fillText(`${angle}° convergence`, 20, 30);
        }

        function updateAngle() {
            document.getElementById('convergeValue').textContent = document.getElementById('convergeSlider').value + '°';
            document.getElementById('separationValue').textContent = document.getElementById('separationSlider').value + '%';
            drawAngle();
        }

        // ========== CONTEXT DEMO ==========
        const contextCanvas = document.getElementById('contextCanvas');
        const contextCtx = contextCanvas.getContext('2d');
        let contextMode = 'full';

        function drawContext() {
            contextCtx.fillStyle = '#0a0a15';
            contextCtx.fillRect(0, 0, contextCanvas.width, contextCanvas.height);

            const centerX = contextCanvas.width / 2;
            const topY = 60;
            const bottomY = 300;
            const convergeFactor = 0.6;

            const bottomWidth = 160;
            const topWidth = bottomWidth * (1 - convergeFactor);

            // Draw converging lines
            if (contextMode === 'full' || contextMode === 'lines') {
                contextCtx.strokeStyle = '#666';
                contextCtx.lineWidth = 3;

                contextCtx.beginPath();
                contextCtx.moveTo(centerX - bottomWidth/2, bottomY);
                contextCtx.lineTo(centerX - topWidth/2, topY);
                contextCtx.stroke();

                contextCtx.beginPath();
                contextCtx.moveTo(centerX + bottomWidth/2, bottomY);
                contextCtx.lineTo(centerX + topWidth/2, topY);
                contextCtx.stroke();

                // Add some cross ties for context
                if (contextMode === 'full') {
                    contextCtx.strokeStyle = '#444';
                    contextCtx.lineWidth = 2;
                    for (let i = 0; i < 8; i++) {
                        const y = bottomY - i * 30;
                        const progress = i / 7;
                        const width = 140 * (1 - progress * convergeFactor);
                        contextCtx.beginPath();
                        contextCtx.moveTo(centerX - width/2, y);
                        contextCtx.lineTo(centerX + width/2, y);
                        contextCtx.stroke();
                    }
                }
            }

            // Draw bars
            if (contextMode !== 'lines') {
                const barLength = 70;
                const barHeight = 10;
                const topBarY = 100;
                const bottomBarY = 250;

                contextCtx.fillStyle = '#f1c40f';
                contextCtx.fillRect(centerX - barLength/2, topBarY - barHeight/2, barLength, barHeight);
                contextCtx.fillRect(centerX - barLength/2, bottomBarY - barHeight/2, barLength, barHeight);
            }

            // Label current mode
            contextCtx.fillStyle = '#4ecdc4';
            contextCtx.font = '14px Georgia';
            contextCtx.textAlign = 'center';
            const modeLabel = {
                'full': 'Full Context',
                'lines': 'Lines Only (no bars)',
                'bars': 'Bars Only (no lines)',
                'none': 'Nothing'
            };
            contextCtx.fillText(modeLabel[contextMode], centerX, 330);
        }

        function setContext(mode) {
            contextMode = mode;
            drawContext();
        }

        // ========== PERCEPTION GAME ==========
        const gameCanvas = document.getElementById('gameCanvas');
        const gameCtx = gameCanvas.getContext('2d');
        let gameState = {
            active: false,
            trial: 0,
            correct: 0,
            topLength: 0,
            bottomLength: 0,
            correctAnswer: ''
        };

        function drawGameTrial() {
            gameCtx.fillStyle = '#0a0a15';
            gameCtx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);

            const centerX = gameCanvas.width / 2;
            const topY = 50;
            const bottomY = 250;
            const convergeFactor = 0.6;

            // Draw converging lines
            gameCtx.strokeStyle = '#666';
            gameCtx.lineWidth = 3;

            const bottomWidth = 300;
            const topWidth = bottomWidth * (1 - convergeFactor);

            gameCtx.beginPath();
            gameCtx.moveTo(centerX - bottomWidth/2, bottomY);
            gameCtx.lineTo(centerX - topWidth/2, topY);
            gameCtx.stroke();

            gameCtx.beginPath();
            gameCtx.moveTo(centerX + bottomWidth/2, bottomY);
            gameCtx.lineTo(centerX + topWidth/2, topY);
            gameCtx.stroke();

            // Random bar lengths
            const baseLength = 80;
            const variation = (Math.random() - 0.5) * 30; // -15 to +15 pixels difference

            // Randomly assign which is longer
            const topLonger = Math.random() < 0.5;
            gameState.topLength = baseLength + (topLonger ? Math.abs(variation) : -Math.abs(variation));
            gameState.bottomLength = baseLength + (topLonger ? -Math.abs(variation) : Math.abs(variation));

            // Sometimes make them equal
            if (Math.random() < 0.2) {
                gameState.topLength = baseLength;
                gameState.bottomLength = baseLength;
            }

            // Determine correct answer
            const diff = gameState.topLength - gameState.bottomLength;
            if (Math.abs(diff) < 3) {
                gameState.correctAnswer = 'same';
            } else if (diff > 0) {
                gameState.correctAnswer = 'top';
            } else {
                gameState.correctAnswer = 'bottom';
            }

            // Draw bars
            const barHeight = 14;
            const topBarY = 80;
            const bottomBarY = 220;

            gameCtx.fillStyle = '#f1c40f';
            gameCtx.fillRect(centerX - gameState.topLength/2, topBarY - barHeight/2, gameState.topLength, barHeight);
            gameCtx.fillRect(centerX - gameState.bottomLength/2, bottomBarY - barHeight/2, gameState.bottomLength, barHeight);
        }

        function startGame() {
            gameState = {
                active: true,
                trial: 0,
                correct: 0,
                topLength: 0,
                bottomLength: 0,
                correctAnswer: ''
            };

            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('topBtn').style.display = 'inline-block';
            document.getElementById('sameBtn').style.display = 'inline-block';
            document.getElementById('bottomBtn').style.display = 'inline-block';
            document.getElementById('gameInstruction').textContent = 'Which bar is ACTUALLY longer (not which APPEARS longer)?';

            nextGameTrial();
        }

        function nextGameTrial() {
            gameState.trial++;
            updateGameStats();
            drawGameTrial();
        }

        function gameAnswer(answer) {
            const isCorrect = answer === gameState.correctAnswer;

            if (isCorrect) {
                gameState.correct++;
            }

            // Show feedback
            gameCtx.fillStyle = isCorrect ? 'rgba(78, 205, 196, 0.3)' : 'rgba(233, 69, 96, 0.3)';
            gameCtx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);

            gameCtx.fillStyle = isCorrect ? '#4ecdc4' : '#e94560';
            gameCtx.font = 'bold 20px Georgia';
            gameCtx.textAlign = 'center';

            const feedback = isCorrect ? 'CORRECT!' :
                `WRONG! Top=${Math.round(gameState.topLength)}px, Bottom=${Math.round(gameState.bottomLength)}px`;
            gameCtx.fillText(feedback, 400, 35);

            if (gameState.trial < 10) {
                setTimeout(nextGameTrial, 1500);
            } else {
                endGame();
            }

            updateGameStats();
        }

        function updateGameStats() {
            document.getElementById('trialNum').textContent = gameState.trial;
            document.getElementById('correctCount').textContent = gameState.correct;
            document.getElementById('accuracy').textContent = gameState.trial > 0
                ? Math.round(gameState.correct / gameState.trial * 100) + '%'
                : '0%';
        }

        function endGame() {
            gameState.active = false;

            document.getElementById('topBtn').style.display = 'none';
            document.getElementById('sameBtn').style.display = 'none';
            document.getElementById('bottomBtn').style.display = 'none';
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('startBtn').textContent = 'Play Again';

            const accuracy = Math.round(gameState.correct / 10 * 100);
            let message = '';

            if (accuracy >= 80) {
                message = `Excellent! ${accuracy}% accuracy—you've learned to resist the Ponzo illusion!`;
            } else if (accuracy >= 50) {
                message = `${accuracy}% accuracy. The perspective kept tricking you. Your brain's size constancy is strong!`;
            } else {
                message = `${accuracy}% accuracy. The Ponzo illusion is powerful! Even knowing the trick, your brain can't help being fooled.`;
            }

            document.getElementById('gameInstruction').textContent = message;
        }

        // ========== MOON ILLUSION ==========
        const moonHorizonCanvas = document.getElementById('moonHorizonCanvas');
        const moonHorizonCtx = moonHorizonCanvas.getContext('2d');
        const moonZenithCanvas = document.getElementById('moonZenithCanvas');
        const moonZenithCtx = moonZenithCanvas.getContext('2d');

        function drawMoonDemos() {
            // Horizon moon
            moonHorizonCtx.fillStyle = '#0a0a15';
            moonHorizonCtx.fillRect(0, 0, 300, 200);

            // Ground/horizon
            moonHorizonCtx.fillStyle = '#2a2a2a';
            moonHorizonCtx.fillRect(0, 150, 300, 50);

            // Trees (perspective)
            const trees = [
                {x: 30, h: 60, w: 15},
                {x: 80, h: 45, w: 12},
                {x: 130, h: 35, w: 10},
                {x: 180, h: 28, w: 8},
                {x: 220, h: 22, w: 6},
                {x: 260, h: 18, w: 5}
            ];

            trees.forEach(tree => {
                moonHorizonCtx.fillStyle = '#1a3a1a';
                moonHorizonCtx.beginPath();
                moonHorizonCtx.moveTo(tree.x, 150);
                moonHorizonCtx.lineTo(tree.x + tree.w/2, 150 - tree.h);
                moonHorizonCtx.lineTo(tree.x + tree.w, 150);
                moonHorizonCtx.fill();
            });

            // Moon at horizon
            moonHorizonCtx.fillStyle = '#f4e4c1';
            moonHorizonCtx.beginPath();
            moonHorizonCtx.arc(150, 120, 25, 0, Math.PI * 2);
            moonHorizonCtx.fill();

            // Zenith moon
            moonZenithCtx.fillStyle = '#0a0a15';
            moonZenithCtx.fillRect(0, 0, 300, 200);

            // Stars
            moonZenithCtx.fillStyle = '#ffffff';
            for (let i = 0; i < 30; i++) {
                const x = Math.random() * 300;
                const y = Math.random() * 200;
                const size = Math.random() * 1.5 + 0.5;
                moonZenithCtx.beginPath();
                moonZenithCtx.arc(x, y, size, 0, Math.PI * 2);
                moonZenithCtx.fill();
            }

            // Moon overhead (SAME SIZE as horizon moon!)
            moonZenithCtx.fillStyle = '#f4e4c1';
            moonZenithCtx.beginPath();
            moonZenithCtx.arc(150, 100, 25, 0, Math.PI * 2); // Same 25px radius!
            moonZenithCtx.fill();
        }

        // Initialize all canvases
        drawRailroad();
        drawMatch();
        drawAngle();
        drawContext();
        drawMoonDemos();

        // Initialize game canvas
        gameCtx.fillStyle = '#0a0a15';
        gameCtx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);
        gameCtx.fillStyle = '#a0a0a0';
        gameCtx.font = '18px Georgia';
        gameCtx.textAlign = 'center';
        gameCtx.fillText('Click "Start Game" to test your perception!', 400, 150);
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
