<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Klein Paradox - Surprising Paradoxes</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #0a0a12 0%, #1a1a2e 50%, #0f0f1a 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        .back-link {
            display: inline-block;
            color: #f4a261;
            text-decoration: none;
            margin-bottom: 20px;
            font-size: 0.95rem;
            transition: color 0.3s;
        }

        .back-link:hover { color: #e9c46a; }

        h1 {
            font-size: 2.5rem;
            color: #e9c46a;
            margin-bottom: 15px;
            text-shadow: 0 0 40px rgba(233, 196, 106, 0.3);
        }

        .subtitle {
            font-size: 1.2rem;
            color: #8ecae6;
            font-style: italic;
        }

        .visualization-container {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 40px;
            border: 1px solid rgba(233, 196, 106, 0.2);
        }

        .mode-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .mode-btn {
            padding: 10px 18px;
            border: 1px solid rgba(233, 196, 106, 0.5);
            background: rgba(233, 196, 106, 0.1);
            color: #e9c46a;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
        }

        .mode-btn:hover {
            background: rgba(233, 196, 106, 0.2);
        }

        .mode-btn.active {
            background: rgba(233, 196, 106, 0.3);
            border-color: #e9c46a;
        }

        .canvas-wrapper {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        canvas {
            border-radius: 10px;
            background: #000;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-box .label {
            font-size: 0.8rem;
            color: #8ecae6;
            margin-bottom: 5px;
        }

        .stat-box .value {
            font-size: 1.3rem;
            color: #e9c46a;
            font-weight: bold;
        }

        .stat-box .value.paradox {
            color: #ff6b6b;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .control-group {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            color: #e9c46a;
            font-size: 0.9rem;
        }

        .control-group input[type="range"] {
            width: 100%;
            margin-bottom: 5px;
        }

        .control-group .value {
            text-align: right;
            font-size: 0.8rem;
            color: #8ecae6;
        }

        .btn-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .btn {
            padding: 10px 20px;
            border: 1px solid rgba(142, 202, 230, 0.5);
            background: rgba(142, 202, 230, 0.1);
            color: #8ecae6;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .btn:hover {
            background: rgba(142, 202, 230, 0.25);
        }

        .essay {
            line-height: 1.9;
            font-size: 1.1rem;
        }

        .essay h2 {
            color: #e9c46a;
            margin: 40px 0 20px;
            font-size: 1.6rem;
            border-bottom: 1px solid rgba(233, 196, 106, 0.3);
            padding-bottom: 10px;
        }

        .essay h3 {
            color: #f4a261;
            margin: 30px 0 15px;
            font-size: 1.3rem;
        }

        .essay p {
            margin-bottom: 20px;
            text-align: justify;
        }

        .equation {
            background: rgba(142, 202, 230, 0.1);
            padding: 20px;
            margin: 25px 0;
            border-radius: 10px;
            text-align: center;
            font-family: 'Courier New', monospace;
            color: #8ecae6;
            font-size: 1.1rem;
            overflow-x: auto;
        }

        .highlight-box {
            background: linear-gradient(135deg, rgba(233, 196, 106, 0.1), rgba(244, 162, 97, 0.1));
            border-left: 4px solid #e9c46a;
            padding: 20px;
            margin: 25px 0;
            border-radius: 0 10px 10px 0;
        }

        .highlight-box strong {
            color: #e9c46a;
        }

        .warning-box {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.15), rgba(255, 107, 107, 0.05));
            border-left: 4px solid #ff6b6b;
            padding: 20px;
            margin: 25px 0;
            border-radius: 0 10px 10px 0;
        }

        .warning-box strong {
            color: #ff6b6b;
        }

        .sources {
            background: rgba(0, 0, 0, 0.3);
            padding: 25px;
            border-radius: 10px;
            margin-top: 40px;
        }

        .sources h3 {
            color: #e9c46a;
            margin-bottom: 15px;
        }

        .sources ul {
            list-style: none;
        }

        .sources li {
            margin-bottom: 10px;
        }

        .sources a {
            color: #8ecae6;
            text-decoration: none;
        }

        .sources a:hover {
            text-decoration: underline;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 15px;
            font-size: 0.85rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 10px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="index.html" class="back-link">← Back to Surprising Paradoxes</a>
            <h1>The Klein Paradox</h1>
            <p class="subtitle">When reflection exceeds 100% and electrons create their own anti-matter</p>
        </header>

        <div class="visualization-container">
            <div class="mode-buttons">
                <button class="mode-btn active" onclick="setMode('nonrel')">Non-Relativistic</button>
                <button class="mode-btn" onclick="setMode('weak')">Weak Barrier (V < 2mc²)</button>
                <button class="mode-btn" onclick="setMode('klein')">Klein Zone (V > 2mc²)</button>
                <button class="mode-btn" onclick="setMode('graphene')">Graphene Tunneling</button>
            </div>

            <div class="canvas-wrapper">
                <canvas id="canvas" width="800" height="450"></canvas>
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #4CAF50;"></div>
                    <span>Incident electron</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #2196F3;"></div>
                    <span>Reflected wave</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff6b6b;"></div>
                    <span>Transmitted / Positron</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: rgba(233,196,106,0.3);"></div>
                    <span>Potential barrier</span>
                </div>
            </div>

            <div class="stats-row">
                <div class="stat-box">
                    <div class="label">Reflection Coeff. |R|²</div>
                    <div class="value" id="reflectionCoeff">0%</div>
                </div>
                <div class="stat-box">
                    <div class="label">Transmission Coeff. |T|²</div>
                    <div class="value" id="transmissionCoeff">0%</div>
                </div>
                <div class="stat-box">
                    <div class="label">R + T</div>
                    <div class="value" id="totalProb">100%</div>
                </div>
                <div class="stat-box">
                    <div class="label">Pair Creation</div>
                    <div class="value" id="pairCreation">No</div>
                </div>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label>Barrier Height (V₀)</label>
                    <input type="range" id="barrierHeight" min="0" max="5" step="0.1" value="0.5">
                    <div class="value"><span id="barrierValue">0.5</span> mc²</div>
                </div>

                <div class="control-group">
                    <label>Electron Energy (E)</label>
                    <input type="range" id="electronEnergy" min="0.1" max="2" step="0.05" value="0.8">
                    <div class="value"><span id="energyValue">0.8</span> mc²</div>
                </div>

                <div class="control-group">
                    <label>Animation Speed</label>
                    <input type="range" id="animSpeed" min="0.2" max="2" step="0.1" value="1">
                    <div class="value"><span id="speedValue">1.0</span>x</div>
                </div>
            </div>

            <div class="btn-row">
                <button class="btn" onclick="resetWave()">Reset Wave</button>
                <button class="btn" onclick="togglePause()">Pause</button>
            </div>
        </div>

        <article class="essay">
            <h2>More Reflection Than Incidence?</h2>

            <p>
                In 1929, Swedish physicist Oskar Klein applied the Dirac equation—the relativistic
                equation for electrons—to a simple problem: electron scattering from a step potential.
                What he found shocked the physics community: for sufficiently strong barriers,
                the <strong>reflection coefficient exceeded 100%</strong>.
            </p>

            <p>
                More electrons seemed to be reflected than were sent in! This appeared to violate
                the most fundamental principle in quantum mechanics: conservation of probability.
                How could such an absurdity arise from the mathematics that correctly described
                electrons in atoms?
            </p>

            <div class="warning-box">
                <strong>The Paradox:</strong> For a potential step V₀ > E + mc², the Dirac equation
                gives |R|² > 1, meaning more than 100% of incident electrons are reflected.
                This "extra current" seems to come from nowhere, violating probability conservation.
            </div>

            <h2>The Klein Zone: V₀ > 2mc²</h2>

            <p>
                The magic threshold is twice the electron rest mass energy: <strong>V₀ > 2mc² ≈ 1.022 MeV</strong>.
                Below this, scattering behaves strangely but doesn't violate conservation laws.
                Above it, we enter the "Klein zone" where the paradox manifests.
            </p>

            <p>
                In nonrelativistic quantum mechanics, increasing barrier height always increases
                reflection and decreases transmission, approaching 100% reflection for infinite barriers.
                But in the Klein zone, the opposite happens: <strong>transmission approaches 100%
                as the barrier approaches infinity!</strong>
            </p>

            <div class="equation">
                Non-relativistic: R → 1, T → 0 as V₀ → ∞<br><br>
                Klein zone: R → 0, T → 1 as V₀ → ∞<br>
                (Barrier becomes transparent!)
            </div>

            <h2>Resolution: The Dirac Sea and Pair Creation</h2>

            <p>
                The resolution came from Dirac himself and involves one of the most profound ideas
                in physics: the <strong>Dirac sea</strong>. Dirac proposed that the vacuum isn't
                empty but filled with an infinite sea of negative-energy electrons. The Pauli
                exclusion principle prevents normal electrons from falling into these states.
            </p>

            <p>
                When V₀ > 2mc², something remarkable happens: the potential lifts negative-energy
                states inside the barrier above the vacuum level outside. These states can now be
                "seen" by the incident electron—and electrons from the Dirac sea can tunnel out.
            </p>

            <h3>The Physical Picture</h3>

            <p>
                The "extra" reflected current isn't really reflection at all—it's <strong>positron
                creation</strong>. When an electron approaches the supercritical barrier:
            </p>

            <p>
                1. The strong potential creates an electron-positron pair at the barrier<br>
                2. The new electron travels backward (appearing as reflection)<br>
                3. The positron travels forward into the barrier (appearing as transmission)<br>
                4. The original electron is absorbed in the pair creation process
            </p>

            <p>
                Total charge and probability are conserved—but only if we count both particles
                and antiparticles. The Klein paradox isn't a paradox at all; it's a dramatic
                demonstration that strong potentials can create matter from nothing.
            </p>

            <div class="highlight-box">
                <strong>Historical Impact:</strong> The Klein paradox, and its resolution,
                anticipated the discovery of the positron in 1932. Dirac's "holes" in the
                negative energy sea were identified with Anderson's positrons, and quantum
                field theory was born.
            </div>

            <h2>Klein Tunneling in Graphene</h2>

            <p>
                While ordinary Klein paradox requires extreme energies (over 1 MeV), something
                remarkable was discovered in 2006: electrons in graphene behave as if they were
                massless Dirac fermions. They exhibit <strong>Klein tunneling at everyday energies</strong>.
            </p>

            <p>
                In graphene's honeycomb lattice, electrons near the Fermi level obey a 2D Dirac
                equation with zero mass. This means any potential barrier—even a small one—can
                exhibit 100% transmission at normal incidence. Electrons in graphene pass through
                barriers like they don't exist.
            </p>

            <p>
                This has profound implications for graphene electronics: you cannot create
                conventional transistors by putting potential barriers in the way. The electrons
                just tunnel through. New approaches using magnetic barriers or bilayer graphene
                are needed to control current flow.
            </p>

            <h2>The Mathematics</h2>

            <p>
                The Dirac equation for a step potential V(x) = V₀Θ(x) gives reflection and
                transmission coefficients:
            </p>

            <div class="equation">
                R = |(p - p')/(p + p')|²<br><br>
                where p = √(E² - m²c⁴)/c (outside)<br>
                p' = √((E - V₀)² - m²c⁴)/c (inside)
            </div>

            <p>
                When V₀ > E + mc², the quantity (E - V₀)² - m²c⁴ becomes positive again,
                giving a <em>real</em> momentum p' inside the barrier. But this momentum
                corresponds to negative-energy states—holes in the Dirac sea—which are positrons
                moving in the opposite direction.
            </p>

            <h2>Supercritical Atoms: Z > 137</h2>

            <p>
                The Klein paradox also predicts that sufficiently heavy atomic nuclei should
                spontaneously create positrons. If Z > 137 (actually about 173 with realistic
                calculations), the electric field near the nucleus is strong enough to destabilize
                the vacuum.
            </p>

            <p>
                Such superheavy elements don't exist naturally, but collisions between uranium
                nuclei (Z = 92) can briefly create a combined nuclear charge exceeding the
                critical value. Experiments have searched for spontaneous positron emission,
                though conclusive detection remains elusive.
            </p>

            <div class="highlight-box">
                <strong>The Deep Insight:</strong> The Klein paradox teaches us that the vacuum
                is not empty—it's a seething sea of virtual particle-antiparticle pairs. Strong
                fields can make these pairs real. What seems like a paradox in single-particle
                quantum mechanics is actually a window into the multiparticle nature of quantum
                field theory.
            </div>

            <div class="sources">
                <h3>Sources & Further Reading</h3>
                <ul>
                    <li><a href="https://en.wikipedia.org/wiki/Klein_paradox">Klein paradox - Wikipedia</a></li>
                    <li><a href="https://www.nature.com/articles/s41598-020-76065-7">Klein paradox for bosons, wave packets and negative tunnelling times - Nature</a></li>
                    <li><a href="https://arxiv.org/pdf/0907.5588">Resolution of the Klein Paradox - arXiv</a></li>
                    <li><a href="https://pubs.aip.org/aapt/ajp/article-abstract/67/11/966/1055223">Motion of a wave packet in the Klein paradox - AIP</a></li>
                    <li><a href="https://www.osti.gov/biblio/21608483">Resolution of the Klein Paradox within Relativistic Quantum Mechanics - OSTI</a></li>
                </ul>
            </div>
        </article>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // High DPI
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);
        canvas.style.width = rect.width + 'px';
        canvas.style.height = rect.height + 'px';

        const width = rect.width;
        const height = rect.height;

        // Parameters
        let barrierHeight = 0.5;  // In mc²
        let electronEnergy = 0.8; // In mc²
        let animSpeed = 1;
        let currentMode = 'nonrel';
        let paused = false;
        let time = 0;

        // Wave packet data
        let wavePhase = 0;
        let packets = [];
        let positrons = [];

        // Barrier position
        const barrierX = width * 0.55;

        // Controls
        const barrierSlider = document.getElementById('barrierHeight');
        const energySlider = document.getElementById('electronEnergy');
        const speedSlider = document.getElementById('animSpeed');

        barrierSlider.addEventListener('input', (e) => {
            barrierHeight = parseFloat(e.target.value);
            document.getElementById('barrierValue').textContent = barrierHeight.toFixed(1);
            updateCoefficients();
        });

        energySlider.addEventListener('input', (e) => {
            electronEnergy = parseFloat(e.target.value);
            document.getElementById('energyValue').textContent = electronEnergy.toFixed(2);
            updateCoefficients();
        });

        speedSlider.addEventListener('input', (e) => {
            animSpeed = parseFloat(e.target.value);
            document.getElementById('speedValue').textContent = animSpeed.toFixed(1);
        });

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Adjust parameters for each mode
            switch(mode) {
                case 'nonrel':
                    barrierSlider.value = 0.5;
                    barrierHeight = 0.5;
                    break;
                case 'weak':
                    barrierSlider.value = 1.5;
                    barrierHeight = 1.5;
                    break;
                case 'klein':
                    barrierSlider.value = 3.0;
                    barrierHeight = 3.0;
                    break;
                case 'graphene':
                    barrierSlider.value = 2.0;
                    barrierHeight = 2.0;
                    break;
            }

            document.getElementById('barrierValue').textContent = barrierHeight.toFixed(1);
            updateCoefficients();
            resetWave();
        }

        function resetWave() {
            packets = [{
                x: 100,
                direction: 1,
                type: 'incident',
                amplitude: 1
            }];
            positrons = [];
            wavePhase = 0;
        }

        function togglePause() {
            paused = !paused;
        }

        function calculateCoefficients() {
            // Simplified physics for visualization
            const E = electronEnergy;
            const V = barrierHeight;

            let R, T;

            if (currentMode === 'nonrel') {
                // Non-relativistic: R increases with barrier
                const kappa = Math.sqrt(Math.max(0, V - E));
                R = Math.min(0.99, kappa / (1 + kappa));
                T = 1 - R;
            } else if (currentMode === 'graphene') {
                // Graphene: Perfect transmission at normal incidence
                R = 0.05;
                T = 0.95;
            } else if (V > 2) {
                // Klein zone: Paradoxical behavior
                const excess = (V - 2) / V;
                R = 1 + excess * 0.5; // R > 1!
                T = 0.3 + excess * 0.3;
            } else {
                // Weak barrier: Normal QM
                R = Math.min(0.7, V / 3);
                T = 1 - R;
            }

            return { R, T };
        }

        function updateCoefficients() {
            const { R, T } = calculateCoefficients();

            const reflEl = document.getElementById('reflectionCoeff');
            const transEl = document.getElementById('transmissionCoeff');
            const totalEl = document.getElementById('totalProb');
            const pairEl = document.getElementById('pairCreation');

            reflEl.textContent = (R * 100).toFixed(1) + '%';
            transEl.textContent = (T * 100).toFixed(1) + '%';
            totalEl.textContent = ((R + T) * 100).toFixed(1) + '%';

            // Highlight paradox
            if (R > 1) {
                reflEl.classList.add('paradox');
                totalEl.classList.add('paradox');
                pairEl.textContent = 'Yes!';
                pairEl.classList.add('paradox');
            } else {
                reflEl.classList.remove('paradox');
                totalEl.classList.remove('paradox');
                pairEl.textContent = 'No';
                pairEl.classList.remove('paradox');
            }
        }

        function drawPotential() {
            // Draw potential step
            ctx.fillStyle = 'rgba(233, 196, 106, 0.15)';
            ctx.fillRect(barrierX, 0, width - barrierX, height);

            // Barrier edge
            ctx.beginPath();
            ctx.moveTo(barrierX, 0);
            ctx.lineTo(barrierX, height);
            ctx.strokeStyle = '#e9c46a';
            ctx.lineWidth = 3;
            ctx.stroke();

            // Draw energy levels
            const mc2Y = height * 0.5;
            const scaleY = height * 0.15;

            // Draw V₀ level inside barrier
            const v0Y = mc2Y - barrierHeight * scaleY;
            ctx.beginPath();
            ctx.moveTo(barrierX + 10, v0Y);
            ctx.lineTo(width - 20, v0Y);
            ctx.strokeStyle = 'rgba(233, 196, 106, 0.6)';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.stroke();
            ctx.setLineDash([]);

            ctx.font = '12px Georgia';
            ctx.fillStyle = '#e9c46a';
            ctx.textAlign = 'left';
            ctx.fillText(`V₀ = ${barrierHeight.toFixed(1)}mc²`, width - 100, v0Y - 5);

            // Draw electron energy level
            const eY = mc2Y - electronEnergy * scaleY;
            ctx.beginPath();
            ctx.moveTo(20, eY);
            ctx.lineTo(barrierX - 10, eY);
            ctx.strokeStyle = 'rgba(76, 175, 80, 0.6)';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.stroke();
            ctx.setLineDash([]);

            ctx.fillStyle = '#4CAF50';
            ctx.fillText(`E = ${electronEnergy.toFixed(2)}mc²`, 30, eY - 5);

            // Draw reference line at mc²
            ctx.beginPath();
            ctx.moveTo(20, mc2Y);
            ctx.lineTo(width - 20, mc2Y);
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.lineWidth = 1;
            ctx.stroke();

            ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.textAlign = 'center';
            ctx.fillText('mc² (rest energy)', width / 2, mc2Y + 15);

            // Klein zone indicator
            if (barrierHeight > 2) {
                ctx.fillStyle = 'rgba(255, 107, 107, 0.3)';
                ctx.font = '14px Georgia';
                ctx.textAlign = 'center';
                ctx.fillText('KLEIN ZONE', barrierX + (width - barrierX) / 2, 30);
                ctx.fillText('V₀ > 2mc²', barrierX + (width - barrierX) / 2, 48);
            }
        }

        function drawWaveFunction(x, amplitude, k, phase, color, reflected = false) {
            ctx.beginPath();
            const centerY = height * 0.65;
            const waveHeight = 40 * amplitude;

            for (let dx = -60; dx < 60; dx++) {
                const px = x + dx;
                if (px < 20 || px > width - 20) continue;
                if (!reflected && px > barrierX - 5) continue;
                if (reflected && px > barrierX - 5) continue;

                // Gaussian envelope
                const envelope = Math.exp(-dx * dx / 800);
                const wave = Math.sin(k * dx + phase) * envelope;
                const y = centerY - wave * waveHeight;

                if (dx === -60) ctx.moveTo(px, y);
                else ctx.lineTo(px, y);
            }

            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.stroke();
        }

        function drawTransmittedWave(x, amplitude, phase, isPositron = false) {
            ctx.beginPath();
            const centerY = height * 0.65;
            const waveHeight = 40 * amplitude;

            for (let dx = -60; dx < 60; dx++) {
                const px = x + dx;
                if (px < barrierX + 5 || px > width - 20) continue;

                const envelope = Math.exp(-dx * dx / 800);
                const wave = Math.sin(0.15 * dx + phase) * envelope;
                const y = centerY - wave * waveHeight;

                if (dx === -60 || (x + dx - 1 < barrierX + 5)) ctx.moveTo(px, y);
                else ctx.lineTo(px, y);
            }

            ctx.strokeStyle = isPositron ? '#ff6b6b' : '#ff6b6b';
            ctx.lineWidth = 3;
            ctx.stroke();

            // Positron label
            if (isPositron && x > barrierX + 30) {
                ctx.fillStyle = '#ff6b6b';
                ctx.font = '11px Georgia';
                ctx.textAlign = 'center';
                ctx.fillText('e⁺', x, height * 0.65 - 55);
            }
        }

        function animate() {
            ctx.fillStyle = '#0a0a12';
            ctx.fillRect(0, 0, width, height);

            if (!paused) {
                time += 0.016 * animSpeed;
                wavePhase += 0.08 * animSpeed;
            }

            drawPotential();

            const { R, T } = calculateCoefficients();

            // Update and draw packets
            packets.forEach((packet, idx) => {
                if (!paused) {
                    packet.x += packet.direction * 2 * animSpeed;
                }

                // Incident wave
                if (packet.type === 'incident') {
                    drawWaveFunction(packet.x, 1, 0.15, wavePhase, '#4CAF50');

                    // When hitting barrier
                    if (packet.x >= barrierX - 40) {
                        // Create reflected wave
                        if (!packets.find(p => p.type === 'reflected')) {
                            packets.push({
                                x: barrierX - 40,
                                direction: -1,
                                type: 'reflected',
                                amplitude: Math.sqrt(R)
                            });
                        }

                        // Create transmitted wave or positron
                        if (!packets.find(p => p.type === 'transmitted')) {
                            packets.push({
                                x: barrierX + 40,
                                direction: 1,
                                type: 'transmitted',
                                amplitude: Math.sqrt(Math.min(T, 1)),
                                isPositron: R > 1
                            });
                        }

                        // In Klein zone, create extra particles
                        if (R > 1 && positrons.length === 0) {
                            positrons.push({
                                x: barrierX + 20,
                                y: height * 0.65
                            });
                        }
                    }
                }

                // Reflected wave
                if (packet.type === 'reflected') {
                    const reflColor = R > 1 ? '#ff6b6b' : '#2196F3';
                    drawWaveFunction(packet.x, packet.amplitude, -0.15, -wavePhase, reflColor, true);

                    if (R > 1) {
                        ctx.fillStyle = '#ff6b6b';
                        ctx.font = '11px Georgia';
                        ctx.textAlign = 'center';
                        ctx.fillText('Extra e⁻ (from pair creation)', packet.x, height * 0.65 - 55);
                    }
                }

                // Transmitted wave
                if (packet.type === 'transmitted') {
                    drawTransmittedWave(packet.x, packet.amplitude, wavePhase, packet.isPositron);
                }
            });

            // Draw pair creation effect
            if (R > 1 && packets.find(p => p.type === 'reflected')) {
                // Burst effect at barrier
                const burstRadius = 20 + Math.sin(time * 5) * 5;
                const gradient = ctx.createRadialGradient(barrierX, height * 0.65, 0, barrierX, height * 0.65, burstRadius);
                gradient.addColorStop(0, 'rgba(255, 255, 255, 0.4)');
                gradient.addColorStop(0.5, 'rgba(255, 107, 107, 0.2)');
                gradient.addColorStop(1, 'rgba(255, 107, 107, 0)');
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(barrierX, height * 0.65, burstRadius, 0, Math.PI * 2);
                ctx.fill();

                ctx.font = '12px Georgia';
                ctx.fillStyle = '#fff';
                ctx.textAlign = 'center';
                ctx.fillText('Pair creation!', barrierX, height * 0.65 + 60);
            }

            // Reset when waves leave
            if (packets.length > 0) {
                const allLeft = packets.every(p =>
                    (p.direction < 0 && p.x < -50) ||
                    (p.direction > 0 && p.x > width + 50)
                );
                if (allLeft) {
                    setTimeout(resetWave, 500);
                }
            }

            // Mode label
            ctx.font = '14px Georgia';
            ctx.fillStyle = '#8ecae6';
            ctx.textAlign = 'left';
            let modeLabel = '';
            switch (currentMode) {
                case 'nonrel': modeLabel = 'Non-Relativistic QM'; break;
                case 'weak': modeLabel = 'Relativistic (Sub-critical)'; break;
                case 'klein': modeLabel = 'Klein Zone (Supercritical)'; break;
                case 'graphene': modeLabel = 'Graphene Klein Tunneling'; break;
            }
            ctx.fillText(modeLabel, 20, 30);

            if (currentMode === 'graphene') {
                ctx.fillStyle = '#aaa';
                ctx.fillText('Massless Dirac fermions', 20, 48);
                ctx.fillText('Perfect transmission!', 20, 66);
            }

            requestAnimationFrame(animate);
        }

        // Initialize
        resetWave();
        updateCoefficients();
        animate();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
