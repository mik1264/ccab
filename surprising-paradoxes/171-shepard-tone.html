<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Shepard Tone - Endless Staircase of Sound | Surprising Paradoxes</title>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&family=Nunito:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --sage: #8A9A5B;
            --moss: #606C38;
            --earth: #DDA15E;
            --cream: #FEFAE0;
            --terracotta: #BC6C25;
            --dark-moss: #3d4423;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, #F4F1DE 50%, #EDE8D5 100%);
            min-height: 100vh;
            color: var(--dark-moss);
            line-height: 1.6;
        }

        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            text-decoration: none;
            color: var(--moss);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 100;
            background: rgba(254, 250, 224, 0.9);
            padding: 10px 16px;
            border-radius: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .back-link:hover {
            background: var(--moss);
            color: var(--cream);
            transform: translateX(-3px);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 80px 20px 40px;
        }

        h1 {
            font-family: 'Lora', serif;
            font-size: 2.8rem;
            color: var(--moss);
            text-align: center;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: var(--terracotta);
            font-size: 1.2rem;
            margin-bottom: 30px;
        }

        .paradox-box {
            background: linear-gradient(135deg, var(--terracotta), var(--earth));
            color: white;
            padding: 25px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            font-size: 1.15rem;
            box-shadow: 0 4px 15px rgba(188, 108, 37, 0.3);
        }

        .experiment-container {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .experiment-title {
            font-family: 'Lora', serif;
            font-size: 1.5rem;
            color: var(--moss);
            margin-bottom: 20px;
            text-align: center;
        }

        .visualizer-container {
            position: relative;
            width: 100%;
            height: 300px;
            background: linear-gradient(180deg, #1a1a2e, #16213e);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .staircase {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .octave-layer {
            position: absolute;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.1s, transform 0.1s;
        }

        .octave-bar {
            height: 8px;
            background: linear-gradient(90deg, transparent, var(--earth), transparent);
            border-radius: 4px;
            transition: width 0.1s;
        }

        .octave-label {
            position: absolute;
            right: 15px;
            color: rgba(255,255,255,0.6);
            font-size: 0.8rem;
            font-weight: 600;
        }

        .freq-label {
            position: absolute;
            left: 15px;
            color: rgba(255,255,255,0.4);
            font-size: 0.7rem;
        }

        .direction-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            color: rgba(255,255,255,0.15);
            pointer-events: none;
        }

        .barber-pole {
            position: absolute;
            right: 20px;
            top: 20px;
            bottom: 20px;
            width: 30px;
            background: repeating-linear-gradient(
                45deg,
                #ff4444,
                #ff4444 10px,
                white 10px,
                white 20px,
                #4444ff 20px,
                #4444ff 30px,
                white 30px,
                white 40px
            );
            border-radius: 15px;
            opacity: 0.3;
            background-size: 40px 40px;
        }

        .barber-pole.animating {
            animation: barberScroll 1s linear infinite;
        }

        .barber-pole.descending {
            animation-direction: reverse;
        }

        @keyframes barberScroll {
            0% { background-position: 0 0; }
            100% { background-position: 0 40px; }
        }

        .mode-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .mode-tab {
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 600;
            border: 2px solid var(--sage);
            background: transparent;
            color: var(--moss);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Nunito', sans-serif;
        }

        .mode-tab:hover, .mode-tab.active {
            background: var(--sage);
            color: white;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 14px 35px;
            font-size: 1.1rem;
            font-weight: 600;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Nunito', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--moss), var(--sage));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(96, 108, 56, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--terracotta), var(--earth));
            color: white;
        }

        .btn.playing {
            background: linear-gradient(135deg, #c0392b, #e74c3c);
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
            padding: 15px 20px;
            background: rgba(254, 250, 224, 0.8);
            border-radius: 10px;
        }

        .speed-control label {
            font-weight: 600;
            color: var(--moss);
        }

        .speed-slider {
            width: 200px;
            height: 8px;
            -webkit-appearance: none;
            background: var(--sage);
            border-radius: 4px;
            outline: none;
        }

        .speed-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--terracotta);
            cursor: pointer;
        }

        .speed-value {
            font-weight: 600;
            color: var(--terracotta);
            min-width: 50px;
        }

        .pitch-display {
            text-align: center;
            padding: 15px;
            background: rgba(26, 26, 46, 0.1);
            border-radius: 10px;
            margin-top: 15px;
        }

        .pitch-label {
            font-size: 0.9rem;
            color: var(--moss);
        }

        .pitch-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--terracotta);
        }

        .content-section {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .content-section h2 {
            font-family: 'Lora', serif;
            font-size: 1.6rem;
            color: var(--moss);
            margin-bottom: 20px;
        }

        .how-it-works {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .step-card {
            background: rgba(254, 250, 224, 0.9);
            border-radius: 15px;
            padding: 20px;
            border-left: 4px solid var(--sage);
        }

        .step-number {
            width: 35px;
            height: 35px;
            background: var(--moss);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .step-card h4 {
            color: var(--moss);
            margin-bottom: 8px;
        }

        .spectrum-diagram {
            background: #1a1a2e;
            border-radius: 15px;
            padding: 30px;
            margin: 25px 0;
            position: relative;
            height: 200px;
        }

        .spectrum-wave {
            position: absolute;
            bottom: 30px;
            left: 30px;
            right: 30px;
            height: 140px;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
        }

        .wave-bar {
            width: 40px;
            background: linear-gradient(180deg, var(--earth), var(--terracotta));
            border-radius: 5px 5px 0 0;
            position: relative;
        }

        .wave-bar::after {
            content: attr(data-freq);
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255,255,255,0.6);
            font-size: 0.7rem;
            white-space: nowrap;
        }

        .envelope-curve {
            position: absolute;
            top: 20px;
            left: 30px;
            right: 30px;
            height: 160px;
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 0 80px 80px 0 / 0 80px 80px 0;
            border-left: none;
            border-bottom: none;
        }

        .envelope-label {
            position: absolute;
            top: 10px;
            right: 40px;
            color: rgba(255,255,255,0.5);
            font-size: 0.8rem;
        }

        .uses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .use-card {
            background: rgba(254, 250, 224, 0.8);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: transform 0.3s;
        }

        .use-card:hover {
            transform: translateY(-3px);
        }

        .use-card .icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .use-card h4 {
            color: var(--moss);
            font-size: 0.95rem;
            margin-bottom: 5px;
        }

        .use-card p {
            font-size: 0.85rem;
            color: var(--dark-moss);
        }

        .history-section {
            background: linear-gradient(135deg, rgba(138, 154, 91, 0.1), rgba(96, 108, 56, 0.1));
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
        }

        .history-section h2 {
            font-family: 'Lora', serif;
            font-size: 1.6rem;
            color: var(--moss);
            margin-bottom: 20px;
        }

        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(180deg, var(--sage), var(--moss));
            border-radius: 2px;
        }

        .timeline-item {
            position: relative;
            padding-bottom: 25px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -34px;
            top: 5px;
            width: 12px;
            height: 12px;
            background: var(--earth);
            border-radius: 50%;
            border: 3px solid var(--cream);
        }

        .timeline-year {
            font-weight: 700;
            color: var(--terracotta);
            font-size: 1.1rem;
        }

        .quote-box {
            background: rgba(254, 250, 224, 0.9);
            border-left: 4px solid var(--earth);
            padding: 20px 25px;
            margin: 25px 0;
            border-radius: 0 15px 15px 0;
            font-style: italic;
        }

        .quote-box cite {
            display: block;
            margin-top: 10px;
            font-style: normal;
            font-weight: 600;
            color: var(--terracotta);
        }

        .tritone-section {
            background: linear-gradient(135deg, var(--moss), var(--dark-moss));
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
        }

        .tritone-section h3 {
            margin-bottom: 15px;
            font-family: 'Lora', serif;
        }

        .tritone-demo {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .tritone-btn {
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: 600;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tritone-btn:hover {
            background: white;
            color: var(--moss);
        }

        .perception-poll {
            text-align: center;
            margin-top: 15px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .perception-result {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--earth);
            margin-top: 10px;
        }

        .audio-warning {
            background: rgba(188, 108, 37, 0.2);
            border: 2px solid var(--terracotta);
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .audio-warning .icon {
            font-size: 1.5rem;
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 2rem;
            }

            .visualizer-container {
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Paradoxes</a>

    <div class="container">
        <h1>The Shepard Tone</h1>
        <p class="subtitle">The Endless Staircase of Sound</p>

        <div class="paradox-box">
            <strong>The Paradox:</strong> A sound that seems to rise (or fall) in pitch forever,
            yet never actually gets higher or lower. Like climbing an infinite staircase,
            each note feels higher than the last‚Äîbut you never reach the top.
        </div>

        <div class="experiment-container">
            <h3 class="experiment-title">Experience the Illusion</h3>

            <div class="audio-warning">
                <span class="icon">üîä</span>
                <span>Use headphones for the best experience. Start at a comfortable volume.</span>
            </div>

            <div class="mode-tabs">
                <button class="mode-tab active" data-mode="ascending">
                    ‚Üë Ascending
                </button>
                <button class="mode-tab" data-mode="descending">
                    ‚Üì Descending
                </button>
                <button class="mode-tab" data-mode="glissando">
                    ‚àø Glissando
                </button>
            </div>

            <div class="visualizer-container">
                <div class="staircase" id="staircase">
                    <!-- Octave layers added by JS -->
                </div>
                <div class="direction-indicator" id="directionIndicator">‚Üë</div>
                <div class="barber-pole" id="barberPole"></div>
            </div>

            <div class="controls">
                <button class="btn btn-primary" id="btnPlay">‚ñ∂ Play</button>
                <button class="btn btn-secondary" id="btnStep">Step Once</button>
            </div>

            <div class="speed-control">
                <label>Speed:</label>
                <input type="range" class="speed-slider" id="speedSlider" min="0.5" max="3" step="0.1" value="1.5">
                <span class="speed-value" id="speedValue">1.5s</span>
            </div>

            <div class="pitch-display">
                <div class="pitch-label">Perceived pitch direction:</div>
                <div class="pitch-value" id="pitchValue">‚Äî</div>
            </div>
        </div>

        <div class="content-section">
            <h2>How It Works</h2>
            <p>The Shepard tone exploits how our brain processes pitch by stacking multiple sine waves an octave apart,
            each with carefully controlled volume levels.</p>

            <div class="how-it-works">
                <div class="step-card">
                    <div class="step-number">1</div>
                    <h4>Octave Stacking</h4>
                    <p>Multiple sine waves play simultaneously, each exactly one octave apart (√ó2 frequency).
                    For example: 55 Hz, 110 Hz, 220 Hz, 440 Hz, 880 Hz, 1760 Hz.</p>
                </div>
                <div class="step-card">
                    <div class="step-number">2</div>
                    <h4>Amplitude Envelope</h4>
                    <p>Middle frequencies are loudest. Lower and higher frequencies fade out using a
                    bell-shaped (Gaussian) curve. This masks the "wraparound."</p>
                </div>
                <div class="step-card">
                    <div class="step-number">3</div>
                    <h4>Cyclic Shift</h4>
                    <p>As tones ascend, the highest fades out while a new low tone fades in.
                    The cycle repeats seamlessly‚Äîyour brain perceives endless rising.</p>
                </div>
            </div>

            <div class="spectrum-diagram">
                <div class="envelope-label">Amplitude envelope</div>
                <div class="envelope-curve"></div>
                <div class="spectrum-wave" id="spectrumWave">
                    <!-- Bars added by JS -->
                </div>
            </div>
        </div>

        <div class="tritone-section">
            <h3>The Tritone Paradox</h3>
            <p>Even stranger: play two Shepard tones exactly 6 semitones apart (a tritone).
            Some people hear it as <em>ascending</em>, others as <em>descending</em>!
            Your perception depends on your native language and listening experience.</p>

            <div class="tritone-demo">
                <button class="tritone-btn" id="btnTritone1">Play C ‚Üí F#</button>
                <button class="tritone-btn" id="btnTritone2">Play F# ‚Üí C</button>
            </div>

            <div class="perception-poll">
                <p>Did you hear it as rising or falling?</p>
                <div class="perception-result" id="perceptionResult">
                    Studies show: English speakers often perceive differently than Vietnamese speakers!
                </div>
            </div>
        </div>

        <div class="history-section">
            <h2>History & Discovery</h2>
            <div class="timeline">
                <div class="timeline-item">
                    <span class="timeline-year">1964</span>
                    <div class="timeline-content">
                        <strong>Roger Shepard</strong> (Stanford psychologist) creates the discrete
                        Shepard scale‚Äîthe first demonstration of endlessly ascending/descending pitch.
                        Published in the Journal of the Acoustical Society of America.
                    </div>
                </div>
                <div class="timeline-item">
                    <span class="timeline-year">1969</span>
                    <div class="timeline-content">
                        <strong>Jean-Claude Risset</strong> develops the Shepard-Risset glissando‚Äîa
                        continuous version with smooth pitch glides instead of discrete steps.
                    </div>
                </div>
                <div class="timeline-item">
                    <span class="timeline-year">1986</span>
                    <div class="timeline-content">
                        <strong>Diana Deutsch</strong> discovers the <em>tritone paradox</em>‚Äîshowing
                        that perception of Shepard tones varies by individual and linguistic background.
                    </div>
                </div>
                <div class="timeline-item">
                    <span class="timeline-year">1996</span>
                    <div class="timeline-content">
                        <strong>Super Mario 64</strong> uses a Shepard scale for the "Endless Stairs"
                        sequence‚Äîperfectly matching the spatial loop where Mario climbs forever.
                    </div>
                </div>
                <div class="timeline-item">
                    <span class="timeline-year">2017</span>
                    <div class="timeline-content">
                        <strong>Christopher Nolan's Dunkirk</strong> uses Shepard tones throughout the
                        score (composed by Hans Zimmer) to create relentless tension. Nolan even
                        structured the film's three timelines to mirror the illusion.
                    </div>
                </div>
            </div>
        </div>

        <div class="content-section">
            <h2>Famous Uses</h2>
            <div class="uses-grid">
                <div class="use-card">
                    <div class="icon">üé¨</div>
                    <h4>Dunkirk (2017)</h4>
                    <p>Hans Zimmer's score creates unrelenting tension</p>
                </div>
                <div class="use-card">
                    <div class="icon">ü¶á</div>
                    <h4>The Dark Knight</h4>
                    <p>Batpod sound design uses rising Shepard tones</p>
                </div>
                <div class="use-card">
                    <div class="icon">üéÆ</div>
                    <h4>Super Mario 64</h4>
                    <p>Endless Stairs sequence matches infinite staircase</p>
                </div>
                <div class="use-card">
                    <div class="icon">üåÄ</div>
                    <h4>Inception</h4>
                    <p>"Dream is Collapsing" builds with endless descent</p>
                </div>
                <div class="use-card">
                    <div class="icon">üéπ</div>
                    <h4>Pink Floyd</h4>
                    <p>"Echoes" features a Shepard-like rising tone</p>
                </div>
                <div class="use-card">
                    <div class="icon">üîä</div>
                    <h4>Sound Design</h4>
                    <p>Risers and downers in trailers and transitions</p>
                </div>
            </div>
        </div>

        <div class="content-section">
            <h2>Why Our Brains Are Fooled</h2>
            <p>The Shepard tone exploits a fundamental ambiguity in how we perceive pitch:</p>

            <div class="quote-box">
                "Although the stimulus consists of short, continuously repeated patterns,
                the listener perceives a single pattern that progresses endlessly in pitch.
                The auditory effect is therefore paradoxical."
                <cite>‚Äî Roger Shepard, 1964</cite>
            </div>

            <p style="margin-top: 15px;">Our auditory system has two separate mechanisms for pitch perception:</p>
            <ul style="margin: 15px 0 0 20px;">
                <li><strong>Pitch height:</strong> How high or low a note sounds (the rising sensation)</li>
                <li><strong>Pitch chroma:</strong> Which note it is (C, D, E...) regardless of octave</li>
            </ul>
            <p style="margin-top: 15px;">The Shepard tone keeps the <em>chroma</em> cycling while giving the
            illusion of continuously changing <em>height</em>. It's the audio equivalent of the
            barber pole optical illusion or M.C. Escher's impossible staircases.</p>
        </div>
    </div>

    <script>
        // Audio context
        let audioContext = null;
        let oscillators = [];
        let gainNodes = [];
        let masterGain = null;
        let isPlaying = false;
        let currentStep = 0;
        let playInterval = null;
        let mode = 'ascending';

        // Configuration
        const NUM_OCTAVES = 8;
        const BASE_FREQ = 27.5; // A0
        const SEMITONES_PER_OCTAVE = 12;

        // DOM elements
        const btnPlay = document.getElementById('btnPlay');
        const btnStep = document.getElementById('btnStep');
        const speedSlider = document.getElementById('speedSlider');
        const speedValue = document.getElementById('speedValue');
        const pitchValue = document.getElementById('pitchValue');
        const staircase = document.getElementById('staircase');
        const directionIndicator = document.getElementById('directionIndicator');
        const barberPole = document.getElementById('barberPole');
        const spectrumWave = document.getElementById('spectrumWave');

        // Mode tabs
        document.querySelectorAll('.mode-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                mode = tab.dataset.mode;
                directionIndicator.textContent = mode === 'ascending' ? '‚Üë' : mode === 'descending' ? '‚Üì' : '‚àø';
                barberPole.classList.toggle('descending', mode === 'descending');
                if (isPlaying) {
                    stopAudio();
                    startAudio();
                }
            });
        });

        // Initialize audio
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                masterGain = audioContext.createGain();
                masterGain.gain.value = 0.3;
                masterGain.connect(audioContext.destination);
            }
        }

        // Calculate Gaussian envelope for amplitude
        function getAmplitude(octaveIndex, totalOctaves) {
            const center = totalOctaves / 2;
            const sigma = totalOctaves / 3;
            const x = octaveIndex - center;
            return Math.exp(-(x * x) / (2 * sigma * sigma));
        }

        // Create Shepard tone for a given step
        function createShepardTone(step) {
            // Clear existing oscillators
            oscillators.forEach(osc => {
                try { osc.stop(); } catch(e) {}
            });
            oscillators = [];
            gainNodes = [];

            // Step determines base semitone (0-11)
            const baseSemitone = step % SEMITONES_PER_OCTAVE;

            for (let i = 0; i < NUM_OCTAVES; i++) {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();

                // Calculate frequency for this octave
                const semitone = baseSemitone + (i * SEMITONES_PER_OCTAVE);
                const freq = BASE_FREQ * Math.pow(2, semitone / 12);

                // Skip if outside audible range
                if (freq < 20 || freq > 10000) continue;

                osc.type = 'sine';
                osc.frequency.value = freq;

                // Apply Gaussian envelope
                const amp = getAmplitude(i + (baseSemitone / SEMITONES_PER_OCTAVE), NUM_OCTAVES);
                gain.gain.value = amp * 0.15;

                osc.connect(gain);
                gain.connect(masterGain);
                osc.start();

                oscillators.push(osc);
                gainNodes.push({ gain, amp, octave: i, freq });
            }

            updateVisualizer();
        }

        // Create glissando (continuous)
        function createGlissando(direction) {
            oscillators.forEach(osc => {
                try { osc.stop(); } catch(e) {}
            });
            oscillators = [];
            gainNodes = [];

            for (let i = 0; i < NUM_OCTAVES; i++) {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();

                const baseFreq = BASE_FREQ * Math.pow(2, i);
                osc.type = 'sine';
                osc.frequency.value = baseFreq;

                const amp = getAmplitude(i, NUM_OCTAVES);
                gain.gain.value = amp * 0.12;

                osc.connect(gain);
                gain.connect(masterGain);
                osc.start();

                oscillators.push(osc);
                gainNodes.push({ gain, amp, octave: i, freq: baseFreq, osc });
            }

            // Animate glissando
            const duration = parseFloat(speedSlider.value);
            const startTime = audioContext.currentTime;

            function updateGlissando() {
                if (!isPlaying) return;

                const elapsed = audioContext.currentTime - startTime;
                const progress = (elapsed % duration) / duration;

                gainNodes.forEach((node, i) => {
                    const baseFreq = BASE_FREQ * Math.pow(2, i);
                    let freqMultiplier;

                    if (direction > 0) {
                        freqMultiplier = Math.pow(2, progress);
                    } else {
                        freqMultiplier = Math.pow(2, 1 - progress);
                    }

                    node.osc.frequency.value = baseFreq * freqMultiplier;

                    // Update amplitude based on virtual position
                    const virtualOctave = i + progress * (direction > 0 ? 1 : -1);
                    const amp = getAmplitude(virtualOctave, NUM_OCTAVES);
                    node.gain.gain.value = amp * 0.12;
                });

                updateVisualizer();
                requestAnimationFrame(updateGlissando);
            }

            updateGlissando();
        }

        // Update visual staircase
        function buildStaircase() {
            staircase.innerHTML = '';
            for (let i = 0; i < NUM_OCTAVES; i++) {
                const layer = document.createElement('div');
                layer.className = 'octave-layer';
                layer.style.top = `${10 + (i * 35)}px`;
                layer.innerHTML = `
                    <span class="freq-label" data-octave="${i}"></span>
                    <div class="octave-bar" style="width: 0%"></div>
                    <span class="octave-label">Oct ${i + 1}</span>
                `;
                staircase.appendChild(layer);
            }
        }

        function updateVisualizer() {
            const layers = staircase.querySelectorAll('.octave-layer');

            gainNodes.forEach((node, idx) => {
                if (layers[node.octave]) {
                    const bar = layers[node.octave].querySelector('.octave-bar');
                    const label = layers[node.octave].querySelector('.freq-label');
                    const width = node.amp * 80;
                    bar.style.width = `${width}%`;
                    bar.style.opacity = 0.3 + node.amp * 0.7;
                    label.textContent = `${Math.round(node.freq)} Hz`;
                }
            });
        }

        // Build spectrum diagram
        function buildSpectrum() {
            spectrumWave.innerHTML = '';
            const freqs = [55, 110, 220, 440, 880, 1760];
            const heights = [20, 60, 100, 100, 60, 20];

            freqs.forEach((freq, i) => {
                const bar = document.createElement('div');
                bar.className = 'wave-bar';
                bar.style.height = `${heights[i]}px`;
                bar.setAttribute('data-freq', `${freq} Hz`);
                spectrumWave.appendChild(bar);
            });
        }

        function startAudio() {
            initAudio();
            isPlaying = true;
            btnPlay.textContent = '‚èπ Stop';
            btnPlay.classList.add('playing');
            barberPole.classList.add('animating');

            if (mode === 'glissando') {
                createGlissando(1);
                pitchValue.textContent = 'Continuously rising...';
            } else {
                const direction = mode === 'ascending' ? 1 : -1;
                const speed = parseFloat(speedSlider.value) * 1000;

                createShepardTone(currentStep);
                pitchValue.textContent = mode === 'ascending' ? '‚Üë Rising...' : '‚Üì Falling...';

                playInterval = setInterval(() => {
                    currentStep += direction;
                    if (currentStep < 0) currentStep = 11;
                    if (currentStep > 11) currentStep = 0;
                    createShepardTone(currentStep);
                }, speed);
            }
        }

        function stopAudio() {
            isPlaying = false;
            btnPlay.textContent = '‚ñ∂ Play';
            btnPlay.classList.remove('playing');
            barberPole.classList.remove('animating');
            pitchValue.textContent = '‚Äî';

            clearInterval(playInterval);
            oscillators.forEach(osc => {
                try { osc.stop(); } catch(e) {}
            });
            oscillators = [];
            gainNodes = [];
        }

        function stepOnce() {
            initAudio();
            const direction = mode === 'descending' ? -1 : 1;
            currentStep += direction;
            if (currentStep < 0) currentStep = 11;
            if (currentStep > 11) currentStep = 0;

            // Stop previous
            oscillators.forEach(osc => {
                try { osc.stop(); } catch(e) {}
            });

            createShepardTone(currentStep);
            pitchValue.textContent = `Step ${currentStep + 1} of 12`;

            // Auto-stop after brief play
            setTimeout(() => {
                oscillators.forEach(osc => {
                    try { osc.stop(); } catch(e) {}
                });
            }, 800);
        }

        // Tritone paradox demos
        function playTritone(startNote) {
            initAudio();

            // Play first note
            createShepardTone(startNote);

            setTimeout(() => {
                // Play tritone (6 semitones away)
                createShepardTone((startNote + 6) % 12);

                setTimeout(() => {
                    oscillators.forEach(osc => {
                        try { osc.stop(); } catch(e) {}
                    });
                }, 800);
            }, 800);
        }

        document.getElementById('btnTritone1').addEventListener('click', () => playTritone(0)); // C to F#
        document.getElementById('btnTritone2').addEventListener('click', () => playTritone(6)); // F# to C

        // Event listeners
        btnPlay.addEventListener('click', () => {
            if (isPlaying) {
                stopAudio();
            } else {
                startAudio();
            }
        });

        btnStep.addEventListener('click', stepOnce);

        speedSlider.addEventListener('input', () => {
            speedValue.textContent = `${speedSlider.value}s`;
            if (isPlaying && mode !== 'glissando') {
                stopAudio();
                startAudio();
            }
        });

        // Initialize
        buildStaircase();
        buildSpectrum();
    </script>
</body>
</html>
