<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galton Board - Order from Chaos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0a1a0a 0%, #1a2a1a 50%, #0a1a1a 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        .back-link {
            display: inline-flex;
            align-items: center;
            color: #22c55e;
            text-decoration: none;
            margin-bottom: 15px;
            font-size: 0.95em;
        }
        .back-link:hover {
            color: #4ade80;
            text-decoration: underline;
        }
        h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
            color: #fff;
            text-shadow: 0 0 30px rgba(34, 197, 94, 0.5);
        }
        .subtitle {
            color: #4ade80;
            margin-bottom: 20px;
            font-size: 1.05em;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 20px;
        }
        .canvas-container {
            background: rgba(0,0,0,0.4);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        canvas {
            border-radius: 8px;
            background: #0a0a0a;
        }
        .info-text {
            margin-top: 10px;
            font-size: 0.8em;
            color: #22c55e;
        }
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .panel {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .panel h3 {
            font-size: 0.9em;
            color: #22c55e;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .btn {
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
        }
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #e0e0e0;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .btn-secondary:hover {
            background: rgba(255,255,255,0.2);
        }
        .param-group {
            margin-bottom: 12px;
        }
        .param-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .param-name {
            color: #4ade80;
            font-size: 0.85em;
        }
        .param-value {
            color: #86efac;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.9em;
        }
        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255,255,255,0.1);
            -webkit-appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #22c55e;
            cursor: pointer;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .stat-label {
            color: #4ade80;
            font-size: 0.8em;
        }
        .stat-value {
            color: #86efac;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.8em;
        }
        .formula-box {
            background: rgba(0,0,0,0.3);
            padding: 12px;
            border-radius: 6px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.85em;
            line-height: 1.8;
            color: #86efac;
            text-align: center;
        }
        .galton-quote {
            background: linear-gradient(135deg, rgba(34,197,94,0.2), rgba(22,163,74,0.1));
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-style: italic;
            font-size: 0.8em;
            color: #4ade80;
        }
        .exp-section {
            margin-top: 20px;
        }
        .exp-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }
        .exp-card {
            background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(22,163,74,0.05));
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(34,197,94,0.2);
        }
        .exp-card h4 {
            color: #22c55e;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        .exp-card p {
            font-size: 0.85em;
            line-height: 1.6;
            color: #4ade80;
        }
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">← Back to Paradoxes</a>
        <h1>The Galton Board</h1>
        <p class="subtitle">Where Random Chaos Creates Perfect Order</p>

        <div class="main-content">
            <div class="canvas-container">
                <canvas id="mainCanvas" width="600" height="650"></canvas>
                <p class="info-text">Each ball makes random left/right choices at each peg → bell curve emerges!</p>
            </div>

            <div class="sidebar">
                <div class="panel">
                    <h3>Controls</h3>
                    <div class="controls">
                        <button class="btn btn-primary" id="dropBtn">Drop Ball</button>
                        <button class="btn btn-secondary" id="floodBtn">Flood (100)</button>
                        <button class="btn btn-secondary" id="resetBtn">Reset</button>
                    </div>
                </div>

                <div class="panel">
                    <h3>Parameters</h3>
                    <div class="param-group">
                        <div class="param-label">
                            <span class="param-name">Rows of pegs</span>
                            <span class="param-value" id="rowsValue">12</span>
                        </div>
                        <input type="range" id="rowsSlider" min="6" max="18" value="12">
                    </div>
                    <div class="param-group">
                        <div class="param-label">
                            <span class="param-name">Left bias (%)</span>
                            <span class="param-value" id="biasValue">50</span>
                        </div>
                        <input type="range" id="biasSlider" min="20" max="80" value="50">
                    </div>
                    <div class="param-group">
                        <div class="param-label">
                            <span class="param-name">Speed</span>
                            <span class="param-value" id="speedValue">1.0x</span>
                        </div>
                        <input type="range" id="speedSlider" min="0.5" max="3" step="0.1" value="1">
                    </div>
                </div>

                <div class="panel">
                    <h3>Statistics</h3>
                    <div class="stat-row">
                        <span class="stat-label">Total balls</span>
                        <span id="totalBalls" class="stat-value">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Mean bin</span>
                        <span id="meanBin" class="stat-value">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Std deviation</span>
                        <span id="stdDev" class="stat-value">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Theoretical σ</span>
                        <span id="theoryStd" class="stat-value">-</span>
                    </div>
                </div>

                <div class="panel">
                    <h3>The Math</h3>
                    <div class="formula-box">
                        P(k) = C(n,k) · p<sup>k</sup> · (1-p)<sup>n-k</sup><br>
                        <span style="font-size: 0.8em; color: #4ade80;">Binomial → Normal as n → ∞</span>
                    </div>
                    <p style="font-size: 0.7em; color: #94a3b8; margin-top: 8px;">
                        Each ball makes n independent 50/50 choices.
                        This is exactly the Central Limit Theorem!
                    </p>
                </div>

                <div class="panel">
                    <div class="galton-quote">
                        "I know of scarcely anything so apt to impress the imagination as the wonderful form of cosmic order expressed by the Law of Frequency of Error."
                        <div style="margin-top: 5px; font-size: 0.8em; color: #86efac;">— Francis Galton, 1889</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="exp-section">
            <div class="exp-cards">
                <div class="exp-card">
                    <h4>Francis Galton (1874)</h4>
                    <p>Polymath Francis Galton invented the "quincunx" (Latin for "five-twelfths") to demonstrate probability visually. He first showed it at the Royal Institution on February 27, 1874. Galton was Darwin's half-cousin and pioneered statistics, fingerprints, and (controversially) eugenics.</p>
                </div>
                <div class="exp-card">
                    <h4>Central Limit Theorem</h4>
                    <p>The board demonstrates why the normal distribution is everywhere! Add up many independent random variables → you get a bell curve. Stock prices, heights, IQ scores, measurement errors—all follow this law. It's one of the most important theorems in statistics!</p>
                </div>
                <div class="exp-card">
                    <h4>Pascal's Triangle Connection</h4>
                    <p>The number of paths to each bin matches Pascal's triangle! The kth bin has C(n,k) paths leading to it. This connects combinatorics, probability, and the binomial distribution in one beautiful visual device.</p>
                </div>
                <div class="exp-card">
                    <h4>Regression to the Mean</h4>
                    <p>Galton discovered "regression" using this device! Extreme values (edge bins) are rare—most outcomes cluster around the middle. Tall parents have shorter children on average; this isn't genes failing, it's statistics at work. The mean is a powerful attractor.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');

        // Parameters
        let numRows = 12;
        let bias = 0.5;  // 0.5 = fair
        let speed = 1.0;

        // Board geometry
        const pegRadius = 4;
        const ballRadius = 5;
        const pegSpacingX = 30;
        const pegSpacingY = 35;

        // State
        let balls = [];
        let bins = [];
        let pegs = [];

        function initBoard() {
            pegs = [];
            bins = new Array(numRows + 1).fill(0);

            const startX = canvas.width / 2;
            const startY = 80;

            // Create pegs in triangular pattern
            for (let row = 0; row < numRows; row++) {
                const pegY = startY + row * pegSpacingY;
                const numPegs = row + 1;
                const rowWidth = numPegs * pegSpacingX;
                const rowStartX = startX - rowWidth / 2 + pegSpacingX / 2;

                for (let col = 0; col < numPegs; col++) {
                    pegs.push({
                        x: rowStartX + col * pegSpacingX,
                        y: pegY,
                        row: row
                    });
                }
            }
        }

        function dropBall() {
            const startX = canvas.width / 2;
            const startY = 30;

            balls.push({
                x: startX + (Math.random() - 0.5) * 10,
                y: startY,
                vx: 0,
                vy: 0,
                row: -1,
                bin: numRows / 2,  // Track which bin it will end in
                settled: false,
                color: `hsl(${120 + Math.random() * 40}, 70%, 60%)`
            });
        }

        function updateBalls() {
            const gravity = 0.3 * speed;
            const friction = 0.92;
            const bounce = 0.3;

            for (let ball of balls) {
                if (ball.settled) continue;

                // Apply gravity
                ball.vy += gravity;

                // Update position
                ball.x += ball.vx * speed;
                ball.y += ball.vy * speed;

                // Check collisions with pegs
                for (let peg of pegs) {
                    const dx = ball.x - peg.x;
                    const dy = ball.y - peg.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    const minDist = pegRadius + ballRadius;

                    if (dist < minDist && peg.row > ball.row) {
                        // Collision! Bounce and make random choice
                        ball.row = peg.row;

                        // Random left/right with bias
                        const goLeft = Math.random() < bias;
                        if (goLeft) {
                            ball.bin -= 0.5;
                        } else {
                            ball.bin += 0.5;
                        }

                        // Bounce
                        const nx = dx / dist;
                        const ny = dy / dist;

                        // Push out of collision
                        ball.x = peg.x + nx * minDist;
                        ball.y = peg.y + ny * minDist;

                        // Add sideways velocity
                        ball.vx = goLeft ? -2 * speed : 2 * speed;
                        ball.vy = Math.abs(ball.vy) * bounce;

                        break;
                    }
                }

                // Apply friction
                ball.vx *= friction;

                // Check if ball reached bottom
                const bottomY = 80 + (numRows - 1) * pegSpacingY + 50;
                if (ball.y > bottomY) {
                    // Determine final bin
                    const finalBin = Math.round(ball.bin);
                    const clampedBin = Math.max(0, Math.min(numRows, finalBin));

                    // Calculate bin position
                    const binWidth = pegSpacingX;
                    const binsStartX = canvas.width / 2 - (numRows + 1) * binWidth / 2;
                    const binX = binsStartX + clampedBin * binWidth + binWidth / 2;

                    // Settle ball
                    ball.x = binX + (Math.random() - 0.5) * 10;
                    ball.y = canvas.height - 30 - bins[clampedBin] * (ballRadius * 2 + 2);
                    ball.settled = true;

                    bins[clampedBin]++;
                }

                // Wall bounds
                if (ball.x < ballRadius) {
                    ball.x = ballRadius;
                    ball.vx *= -bounce;
                }
                if (ball.x > canvas.width - ballRadius) {
                    ball.x = canvas.width - ballRadius;
                    ball.vx *= -bounce;
                }
            }
        }

        function draw() {
            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw bin dividers
            const binWidth = pegSpacingX;
            const binsStartX = canvas.width / 2 - (numRows + 1) * binWidth / 2;
            const binBottom = canvas.height - 20;
            const binTop = 80 + (numRows - 1) * pegSpacingY + 60;

            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            for (let i = 0; i <= numRows + 1; i++) {
                const x = binsStartX + i * binWidth;
                ctx.beginPath();
                ctx.moveTo(x, binTop);
                ctx.lineTo(x, binBottom);
                ctx.stroke();
            }

            // Draw bin bottom
            ctx.beginPath();
            ctx.moveTo(binsStartX, binBottom);
            ctx.lineTo(binsStartX + (numRows + 1) * binWidth, binBottom);
            ctx.stroke();

            // Draw theoretical bell curve
            const totalBalls = bins.reduce((a, b) => a + b, 0);
            if (totalBalls > 10) {
                ctx.strokeStyle = 'rgba(34, 197, 94, 0.4)';
                ctx.lineWidth = 2;
                ctx.beginPath();

                for (let i = 0; i <= numRows; i++) {
                    // Binomial probability
                    const p = bias;
                    const n = numRows;
                    const k = i;

                    // C(n,k) * p^k * (1-p)^(n-k)
                    let prob = 1;
                    for (let j = 0; j < k; j++) {
                        prob *= (n - j) / (j + 1) * p / (1 - p);
                    }
                    prob *= Math.pow(1 - p, n);

                    const expectedHeight = prob * totalBalls * (ballRadius * 2 + 2);
                    const binCenterX = binsStartX + (i + 0.5) * binWidth;
                    const curveY = binBottom - expectedHeight;

                    if (i === 0) ctx.moveTo(binCenterX, curveY);
                    else ctx.lineTo(binCenterX, curveY);
                }
                ctx.stroke();
            }

            // Draw pegs
            ctx.fillStyle = '#555';
            for (let peg of pegs) {
                ctx.beginPath();
                ctx.arc(peg.x, peg.y, pegRadius, 0, Math.PI * 2);
                ctx.fill();
            }

            // Draw balls
            for (let ball of balls) {
                ctx.fillStyle = ball.color;
                ctx.beginPath();
                ctx.arc(ball.x, ball.y, ballRadius, 0, Math.PI * 2);
                ctx.fill();
            }

            // Draw drop point indicator
            ctx.fillStyle = '#22c55e';
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2 - 10, 15);
            ctx.lineTo(canvas.width / 2 + 10, 15);
            ctx.lineTo(canvas.width / 2, 25);
            ctx.closePath();
            ctx.fill();

            updateStats();
        }

        function updateStats() {
            const totalBalls = bins.reduce((a, b) => a + b, 0);
            document.getElementById('totalBalls').textContent = totalBalls;

            if (totalBalls > 0) {
                // Calculate mean
                let sum = 0;
                for (let i = 0; i <= numRows; i++) {
                    sum += i * bins[i];
                }
                const mean = sum / totalBalls;

                // Calculate std dev
                let variance = 0;
                for (let i = 0; i <= numRows; i++) {
                    variance += bins[i] * Math.pow(i - mean, 2);
                }
                variance /= totalBalls;
                const stdDev = Math.sqrt(variance);

                // Theoretical std dev for binomial
                const theoryStd = Math.sqrt(numRows * bias * (1 - bias));

                document.getElementById('meanBin').textContent = mean.toFixed(2);
                document.getElementById('stdDev').textContent = stdDev.toFixed(2);
                document.getElementById('theoryStd').textContent = theoryStd.toFixed(2);
            } else {
                document.getElementById('meanBin').textContent = '-';
                document.getElementById('stdDev').textContent = '-';
                document.getElementById('theoryStd').textContent = '-';
            }
        }

        function animate() {
            updateBalls();
            draw();
            requestAnimationFrame(animate);
        }

        function reset() {
            balls = [];
            bins = new Array(numRows + 1).fill(0);
            initBoard();
        }

        // Event handlers
        document.getElementById('dropBtn').addEventListener('click', dropBall);

        document.getElementById('floodBtn').addEventListener('click', () => {
            for (let i = 0; i < 100; i++) {
                setTimeout(() => dropBall(), i * 30);
            }
        });

        document.getElementById('resetBtn').addEventListener('click', reset);

        document.getElementById('rowsSlider').addEventListener('input', (e) => {
            numRows = parseInt(e.target.value);
            document.getElementById('rowsValue').textContent = numRows;
            reset();
        });

        document.getElementById('biasSlider').addEventListener('input', (e) => {
            bias = parseInt(e.target.value) / 100;
            document.getElementById('biasValue').textContent = Math.round(bias * 100);
        });

        document.getElementById('speedSlider').addEventListener('input', (e) => {
            speed = parseFloat(e.target.value);
            document.getElementById('speedValue').textContent = speed.toFixed(1) + 'x';
        });

        // Initialize
        initBoard();
        animate();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
