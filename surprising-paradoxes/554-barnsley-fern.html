<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Barnsley Fern - Surprising Paradoxes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0a150a 0%, #1a2f1a 50%, #0a1a0a 100%);
            color: #e6f1e6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #4ade80;
            text-decoration: none;
            font-size: 14px;
            z-index: 100;
            padding: 8px 16px;
            background: rgba(74, 222, 128, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
        }

        .back-link:hover {
            background: rgba(74, 222, 128, 0.2);
        }

        header {
            text-align: center;
            padding: 60px 20px 20px;
        }

        h1 {
            font-size: clamp(1.8rem, 5vw, 2.8rem);
            background: linear-gradient(135deg, #4ade80, #22c55e, #16a34a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
        }

        .tagline {
            font-size: 1.4rem;
            color: #4ade80;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1rem;
            color: #8892b0;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .main-container {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 20px;
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }

        @media (max-width: 1000px) {
            .main-container {
                grid-template-columns: 1fr;
            }
        }

        .canvas-panel {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(74, 222, 128, 0.2);
            border-radius: 20px;
            padding: 20px;
        }

        #fernCanvas {
            width: 100%;
            height: 550px;
            background: #050a05;
            border-radius: 12px;
        }

        .stats-bar {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            padding: 12px;
            background: rgba(74, 222, 128, 0.1);
            border-radius: 10px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #4ade80;
            font-family: monospace;
        }

        .stat-label {
            font-size: 0.7rem;
            color: #8892b0;
            text-transform: uppercase;
        }

        .controls-panel {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(74, 222, 128, 0.2);
            border-radius: 20px;
            padding: 25px;
        }

        .control-section {
            margin-bottom: 20px;
        }

        .control-section h3 {
            color: #4ade80;
            font-size: 0.85rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .preset-btns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .preset-btn {
            padding: 10px 8px;
            background: rgba(74, 222, 128, 0.1);
            border: 1px solid rgba(74, 222, 128, 0.3);
            border-radius: 8px;
            color: #4ade80;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.75rem;
        }

        .preset-btn:hover, .preset-btn.active {
            background: rgba(74, 222, 128, 0.3);
        }

        .slider-group {
            margin: 8px 0;
        }

        .slider-group label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 0.8rem;
            color: #a8b2d1;
        }

        .slider-group input[type="range"] {
            width: 100%;
            height: 4px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }

        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            background: linear-gradient(135deg, #4ade80, #22c55e);
            border-radius: 50%;
            cursor: pointer;
        }

        .transform-info {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 12px;
            margin: 10px 0;
            font-size: 0.75rem;
        }

        .transform-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-family: monospace;
        }

        .transform-row:last-child {
            border-bottom: none;
        }

        .t-name {
            color: #4ade80;
        }

        .t-prob {
            color: #fbbf24;
        }

        button {
            width: 100%;
            padding: 12px;
            font-size: 0.9rem;
            background: linear-gradient(135deg, #4ade80, #22c55e);
            border: none;
            border-radius: 10px;
            color: #0a150a;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px 0;
        }

        button:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(74, 222, 128, 0.3);
        }

        button.secondary {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
        }

        .explanation {
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.05), rgba(251, 191, 36, 0.05));
            border-radius: 20px;
            padding: 30px;
            margin: 30px auto;
            max-width: 1360px;
        }

        .explanation h2 {
            color: #4ade80;
            margin-bottom: 20px;
        }

        .exp-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .exp-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #22c55e;
        }

        .exp-card h3 {
            color: #22c55e;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .exp-card p {
            color: #a8b2d1;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .formula-box {
            background: rgba(74, 222, 128, 0.1);
            border: 1px solid rgba(74, 222, 128, 0.3);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
        }

        .formula-box h4 {
            color: #4ade80;
            margin-bottom: 15px;
        }

        .formula {
            font-family: 'Times New Roman', serif;
            font-size: 1.2rem;
            color: #e6f1e6;
            margin: 10px 0;
        }

        .compression-box {
            background: rgba(251, 191, 36, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border: 1px solid rgba(251, 191, 36, 0.3);
            text-align: center;
        }

        .compression-box h3 {
            color: #fbbf24;
            margin-bottom: 15px;
        }

        .big-number {
            font-size: 3rem;
            font-weight: bold;
            color: #fbbf24;
        }

        .compression-box p {
            color: #a8b2d1;
            margin-top: 10px;
        }

        footer {
            text-align: center;
            padding: 40px 20px;
            color: #495670;
            font-size: 0.85rem;
        }

        footer a {
            color: #4ade80;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Paradoxes</a>

    <header>
        <h1>The Barnsley Fern</h1>
        <div class="tagline">üåø Infinite Nature from 4 Simple Rules üåø</div>
        <p class="subtitle">
            Just 28 numbers define an entire fern‚Äîevery frond, every leaflet. Michael Barnsley
            showed that nature's complexity can emerge from astonishingly simple mathematics.
            Roll the dice, apply a transform, repeat. A fern grows from chaos.
        </p>
    </header>

    <div class="main-container">
        <div class="canvas-panel">
            <canvas id="fernCanvas"></canvas>
            <div class="stats-bar">
                <div class="stat">
                    <div class="stat-value" id="pointCount">0</div>
                    <div class="stat-label">Points</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="f1Count">0%</div>
                    <div class="stat-label">Stem (f‚ÇÅ)</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="f2Count">0%</div>
                    <div class="stat-label">Body (f‚ÇÇ)</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="f3Count">0%</div>
                    <div class="stat-label">Left (f‚ÇÉ)</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="f4Count">0%</div>
                    <div class="stat-label">Right (f‚ÇÑ)</div>
                </div>
            </div>
        </div>

        <div class="controls-panel">
            <div class="control-section">
                <h3>Fern Presets</h3>
                <div class="preset-btns">
                    <button class="preset-btn active" onclick="setPreset('barnsley')">Barnsley Fern</button>
                    <button class="preset-btn" onclick="setPreset('thelypteridaceae')">Thelypterid</button>
                    <button class="preset-btn" onclick="setPreset('culcita')">Culcita</button>
                    <button class="preset-btn" onclick="setPreset('fishbone')">Fishbone</button>
                    <button class="preset-btn" onclick="setPreset('cyclosorus')">Cyclosorus</button>
                    <button class="preset-btn" onclick="setPreset('tree')">Tree</button>
                </div>
            </div>

            <div class="control-section">
                <h3>Transform Probabilities</h3>
                <div class="transform-info">
                    <div class="transform-row">
                        <span class="t-name">f‚ÇÅ Stem</span>
                        <span class="t-prob" id="p1Display">1%</span>
                    </div>
                    <div class="transform-row">
                        <span class="t-name">f‚ÇÇ Body</span>
                        <span class="t-prob" id="p2Display">85%</span>
                    </div>
                    <div class="transform-row">
                        <span class="t-name">f‚ÇÉ Left leaf</span>
                        <span class="t-prob" id="p3Display">7%</span>
                    </div>
                    <div class="transform-row">
                        <span class="t-name">f‚ÇÑ Right leaf</span>
                        <span class="t-prob" id="p4Display">7%</span>
                    </div>
                </div>
            </div>

            <div class="control-section">
                <h3>Speed</h3>
                <div class="slider-group">
                    <label>
                        <span>Points per frame:</span>
                        <span id="speedValue">200</span>
                    </label>
                    <input type="range" id="speedSlider" min="10" max="1000" value="200">
                </div>
            </div>

            <div class="control-section">
                <h3>Color</h3>
                <div class="slider-group">
                    <label>
                        <span>Hue:</span>
                        <span id="hueValue">120¬∞</span>
                    </label>
                    <input type="range" id="hueSlider" min="0" max="360" value="120">
                </div>
            </div>

            <button onclick="resetFern()">
                ‚Ü∫ Regrow Fern
            </button>
            <button onclick="togglePause()" class="secondary" id="pauseBtn">
                ‚è∏ Pause
            </button>
        </div>
    </div>

    <div class="explanation">
        <h2>Nature from Numbers</h2>

        <div class="compression-box">
            <h3>üóúÔ∏è Ultimate Data Compression</h3>
            <div class="big-number">28</div>
            <p>
                Just 28 numbers (coefficients for 4 affine transformations) encode an entire fern.
                This is millions-to-one compression‚Äîthe foundation of fractal image compression!
            </p>
        </div>

        <div class="formula-box">
            <h4>The Affine Transformation</h4>
            <div class="formula">
                x' = a¬∑x + b¬∑y + e<br>
                y' = c¬∑x + d¬∑y + f
            </div>
            <p style="color: #8892b0; margin-top: 10px;">
                Each transform has 6 coefficients (a, b, c, d, e, f) plus a probability weight
            </p>
        </div>

        <div class="exp-grid">
            <div class="exp-card">
                <h3>The Chaos Game</h3>
                <p>Start anywhere. Roll weighted dice to pick a transform. Apply it.
                   Plot the point. Repeat. After thousands of iterations, the fern
                   magically appears‚Äîattracted to this fractal shape.</p>
            </div>
            <div class="exp-card">
                <h3>Four Transforms</h3>
                <p><strong>f‚ÇÅ (1%):</strong> Creates the stem‚Äîmaps everything to a line.<br>
                   <strong>f‚ÇÇ (85%):</strong> Shrinks and lifts‚Äîcreates the main body.<br>
                   <strong>f‚ÇÉ (7%):</strong> Rotates left‚Äîmakes left leaflets.<br>
                   <strong>f‚ÇÑ (7%):</strong> Rotates right‚Äîmakes right leaflets.</p>
            </div>
            <div class="exp-card">
                <h3>Self-Similarity</h3>
                <p>Each small leaflet is a tiny copy of the whole fern. Zoom in
                   anywhere and you see the same structure repeating. This is the
                   essence of fractals‚Äîinfinity in finite space.</p>
            </div>
            <div class="exp-card">
                <h3>Why Nature Uses This</h3>
                <p>Real ferns grow using recursive genetic instructions‚Äî"grow a frond,
                   then grow smaller fronds on it." Evolution discovered IFS-like
                   algorithms billions of years before mathematicians!</p>
            </div>
        </div>
    </div>

    <footer>
        <p>Part of <a href="index.html">Surprising Paradoxes</a> |
           Michael Barnsley, "Fractals Everywhere" (1988)</p>
    </footer>

    <script>
        const canvas = document.getElementById('fernCanvas');
        const ctx = canvas.getContext('2d');

        // Preset transformations
        const presets = {
            barnsley: {
                name: 'Barnsley Fern',
                transforms: [
                    { a: 0, b: 0, c: 0, d: 0.16, e: 0, f: 0, p: 0.01 },
                    { a: 0.85, b: 0.04, c: -0.04, d: 0.85, e: 0, f: 1.6, p: 0.85 },
                    { a: 0.2, b: -0.26, c: 0.23, d: 0.22, e: 0, f: 1.6, p: 0.07 },
                    { a: -0.15, b: 0.28, c: 0.26, d: 0.24, e: 0, f: 0.44, p: 0.07 }
                ]
            },
            thelypteridaceae: {
                name: 'Thelypteridaceae',
                transforms: [
                    { a: 0, b: 0, c: 0, d: 0.25, e: 0, f: -0.4, p: 0.02 },
                    { a: 0.95, b: 0.005, c: -0.005, d: 0.93, e: -0.002, f: 0.5, p: 0.84 },
                    { a: 0.035, b: -0.2, c: 0.16, d: 0.04, e: -0.09, f: 0.02, p: 0.07 },
                    { a: -0.04, b: 0.2, c: 0.16, d: 0.04, e: 0.083, f: 0.12, p: 0.07 }
                ]
            },
            culcita: {
                name: 'Culcita',
                transforms: [
                    { a: 0, b: 0, c: 0, d: 0.25, e: 0, f: -0.14, p: 0.02 },
                    { a: 0.85, b: 0.02, c: -0.02, d: 0.83, e: 0, f: 1, p: 0.84 },
                    { a: 0.09, b: -0.28, c: 0.3, d: 0.11, e: 0, f: 0.6, p: 0.07 },
                    { a: -0.09, b: 0.28, c: 0.3, d: 0.09, e: 0, f: 0.7, p: 0.07 }
                ]
            },
            fishbone: {
                name: 'Fishbone',
                transforms: [
                    { a: 0, b: 0, c: 0, d: 0.25, e: 0, f: -0.4, p: 0.02 },
                    { a: 0.95, b: 0.002, c: -0.002, d: 0.93, e: -0.002, f: 0.5, p: 0.84 },
                    { a: 0.035, b: -0.11, c: 0.27, d: 0.01, e: -0.05, f: 0.005, p: 0.07 },
                    { a: -0.04, b: 0.11, c: 0.27, d: 0.01, e: 0.047, f: 0.06, p: 0.07 }
                ]
            },
            cyclosorus: {
                name: 'Cyclosorus',
                transforms: [
                    { a: 0, b: 0, c: 0, d: 0.25, e: 0, f: -0.4, p: 0.02 },
                    { a: 0.95, b: 0.005, c: -0.005, d: 0.93, e: -0.002, f: 0.5, p: 0.84 },
                    { a: 0.035, b: -0.2, c: 0.16, d: 0.04, e: -0.09, f: 0.02, p: 0.07 },
                    { a: -0.04, b: 0.2, c: 0.16, d: 0.04, e: 0.083, f: 0.12, p: 0.07 }
                ]
            },
            tree: {
                name: 'Tree',
                transforms: [
                    { a: 0, b: 0, c: 0, d: 0.5, e: 0, f: 0, p: 0.05 },
                    { a: 0.42, b: -0.42, c: 0.42, d: 0.42, e: 0, f: 0.2, p: 0.40 },
                    { a: 0.42, b: 0.42, c: -0.42, d: 0.42, e: 0, f: 0.2, p: 0.40 },
                    { a: 0.1, b: 0, c: 0, d: 0.1, e: 0, f: 0.2, p: 0.15 }
                ]
            }
        };

        let currentPreset = 'barnsley';
        let transforms = [...presets.barnsley.transforms];
        let speed = 200;
        let hue = 120;
        let isPaused = false;
        let animationId;

        let x = 0, y = 0;
        let pointCount = 0;
        let fCounts = [0, 0, 0, 0];

        function resizeCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * 2;
            canvas.height = rect.height * 2;
            ctx.scale(2, 2);
        }

        function applyTransform(x, y, t) {
            return {
                x: t.a * x + t.b * y + t.e,
                y: t.c * x + t.d * y + t.f
            };
        }

        function pickTransform() {
            const r = Math.random();
            let cumulative = 0;

            for (let i = 0; i < transforms.length; i++) {
                cumulative += transforms[i].p;
                if (r < cumulative) return i;
            }
            return transforms.length - 1;
        }

        function projectToCanvas(x, y, width, height) {
            // Fern is typically in range x: [-2.2, 2.7], y: [0, 10]
            const scale = height / 11;
            const px = width / 2 + x * scale;
            const py = height - (y + 0.5) * scale;
            return { x: px, y: py };
        }

        function draw() {
            if (isPaused) {
                animationId = requestAnimationFrame(draw);
                return;
            }

            const rect = canvas.getBoundingClientRect();
            const width = rect.width;
            const height = rect.height;

            for (let i = 0; i < speed; i++) {
                const tIdx = pickTransform();
                fCounts[tIdx]++;

                const result = applyTransform(x, y, transforms[tIdx]);
                x = result.x;
                y = result.y;

                const p = projectToCanvas(x, y, width, height);

                // Color varies with y position
                const lightness = 30 + (y / 10) * 40;
                ctx.fillStyle = `hsl(${hue}, 70%, ${lightness}%)`;
                ctx.fillRect(p.x, p.y, 1, 1);

                pointCount++;
            }

            // Update stats
            document.getElementById('pointCount').textContent = pointCount.toLocaleString();
            const total = fCounts.reduce((a, b) => a + b, 0);
            if (total > 0) {
                document.getElementById('f1Count').textContent = (fCounts[0] / total * 100).toFixed(1) + '%';
                document.getElementById('f2Count').textContent = (fCounts[1] / total * 100).toFixed(1) + '%';
                document.getElementById('f3Count').textContent = (fCounts[2] / total * 100).toFixed(1) + '%';
                document.getElementById('f4Count').textContent = (fCounts[3] / total * 100).toFixed(1) + '%';
            }

            animationId = requestAnimationFrame(draw);
        }

        function resetFern() {
            resizeCanvas();
            const rect = canvas.getBoundingClientRect();

            ctx.fillStyle = '#050a05';
            ctx.fillRect(0, 0, rect.width, rect.height);

            x = 0;
            y = 0;
            pointCount = 0;
            fCounts = [0, 0, 0, 0];
        }

        function setPreset(name) {
            currentPreset = name;
            transforms = [...presets[name].transforms];

            document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            updateProbabilityDisplay();
            resetFern();
        }

        function updateProbabilityDisplay() {
            document.getElementById('p1Display').textContent = (transforms[0].p * 100).toFixed(0) + '%';
            document.getElementById('p2Display').textContent = (transforms[1].p * 100).toFixed(0) + '%';
            document.getElementById('p3Display').textContent = (transforms[2].p * 100).toFixed(0) + '%';
            document.getElementById('p4Display').textContent = (transforms[3].p * 100).toFixed(0) + '%';
        }

        function togglePause() {
            isPaused = !isPaused;
            document.getElementById('pauseBtn').textContent = isPaused ? '‚ñ∂ Resume' : '‚è∏ Pause';
        }

        // Event listeners
        document.getElementById('speedSlider').addEventListener('input', (e) => {
            speed = parseInt(e.target.value);
            document.getElementById('speedValue').textContent = speed;
        });

        document.getElementById('hueSlider').addEventListener('input', (e) => {
            hue = parseInt(e.target.value);
            document.getElementById('hueValue').textContent = hue + '¬∞';
        });

        window.addEventListener('resize', resetFern);

        // Initialize
        resizeCanvas();
        updateProbabilityDisplay();
        resetFern();
        draw();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
