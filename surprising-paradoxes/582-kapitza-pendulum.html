<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kapitza Pendulum: Vibration Creates Stability | Surprising Paradoxes</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0a0805 0%, #1a1510 50%, #0a0808 100%);
            color: #e0e0e0;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #ffaa44;
            text-decoration: none;
            font-size: 1rem;
            z-index: 100;
            padding: 8px 16px;
            background: rgba(0,0,0,0.5);
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        .back-link:hover {
            background: rgba(200, 150, 50, 0.2);
            transform: translateX(-3px);
        }
        header {
            text-align: center;
            padding: 80px 20px 30px;
        }
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #ff8833, #ffaa44, #ffcc88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .subtitle {
            color: #aa8855;
            font-size: 1.2rem;
            max-width: 700px;
            margin: 0 auto;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .demo-section {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 30px;
            margin-bottom: 40px;
        }
        @media (max-width: 900px) {
            .demo-section {
                grid-template-columns: 1fr;
            }
        }
        .canvas-container {
            background: linear-gradient(145deg, #0a0805, #151210);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(200,150,50,0.15);
        }
        canvas {
            display: block;
            width: 100%;
            border-radius: 10px;
        }
        .controls {
            background: linear-gradient(145deg, #0d0a08, #181410);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(200,150,50,0.15);
        }
        .status-display {
            text-align: center;
            padding: 15px;
            background: rgba(200, 150, 50, 0.15);
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .status-display .status {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .status-display .stable { color: #44dd88; }
        .status-display .unstable { color: #ff6644; }
        .status-display .sub {
            font-size: 0.85rem;
            color: #aa8855;
            margin-top: 5px;
        }
        .info-panel {
            background: rgba(200, 150, 50, 0.1);
            border: 1px solid rgba(255, 180, 80, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .info-panel h3 {
            color: #ffaa44;
            font-size: 0.95rem;
            margin-bottom: 12px;
            border-bottom: 1px solid rgba(255, 180, 80, 0.2);
            padding-bottom: 8px;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }
        .info-label { color: #aa8855; }
        .info-value {
            color: #fff;
            font-family: 'Consolas', monospace;
        }
        .control-group {
            margin-bottom: 20px;
        }
        .control-group label {
            display: block;
            margin-bottom: 8px;
            color: #ffaa44;
            font-size: 0.9rem;
        }
        .control-group input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #181410;
            outline: none;
            -webkit-appearance: none;
        }
        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffaa44, #cc7722);
            cursor: pointer;
        }
        .value-display {
            text-align: right;
            font-size: 0.85rem;
            color: #aaa;
            margin-top: 5px;
        }
        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #cc7722, #aa5511);
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }
        button:hover {
            background: linear-gradient(135deg, #ee9944, #cc7722);
            transform: translateY(-2px);
        }
        button.active {
            background: linear-gradient(135deg, #ffaa44, #dd8833);
            box-shadow: 0 0 15px rgba(255, 170, 68, 0.4);
        }
        .mode-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }
        .mode-buttons button {
            padding: 10px;
            font-size: 0.9rem;
        }
        .mode-buttons button.inverted { background: linear-gradient(135deg, #44aa66, #228844); }
        .mode-buttons button.inverted:hover { background: linear-gradient(135deg, #66cc88, #44aa66); }
        .mode-buttons button.inverted.active { background: linear-gradient(135deg, #66dd88, #44bb66); }
        .mode-buttons button.normal { background: linear-gradient(135deg, #6666aa, #444488); }
        .mode-buttons button.normal:hover { background: linear-gradient(135deg, #8888cc, #6666aa); }
        .mode-buttons button.normal.active { background: linear-gradient(135deg, #8888dd, #6666bb); }
        .essay {
            background: linear-gradient(145deg, #0a0805, #151210);
            border-radius: 15px;
            padding: 40px;
            line-height: 1.8;
            box-shadow: 0 10px 40px rgba(200,150,50,0.15);
        }
        .essay h2 {
            color: #ffaa44;
            margin: 30px 0 15px;
            font-size: 1.5rem;
        }
        .essay h2:first-child { margin-top: 0; }
        .essay p {
            margin-bottom: 15px;
            color: #c8c0b0;
        }
        .essay strong { color: #ffcc88; }
        .essay em { color: #88ccff; font-style: italic; }
        .highlight-box {
            background: rgba(200, 150, 50, 0.1);
            border-left: 4px solid #ffaa44;
            padding: 20px;
            margin: 25px 0;
            border-radius: 0 10px 10px 0;
        }
        .highlight-box.paradox {
            background: rgba(255, 180, 80, 0.08);
            border-left-color: #ffcc66;
        }
        .formula {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin: 20px 0;
            font-family: 'Times New Roman', serif;
            font-size: 1.3rem;
            color: #ffcc88;
        }
        .sources {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #2a2520;
        }
        .sources h3 {
            color: #aa8855;
            margin-bottom: 15px;
        }
        .sources ul {
            list-style: none;
        }
        .sources li {
            margin-bottom: 10px;
        }
        .sources a {
            color: #886644;
            text-decoration: none;
        }
        .sources a:hover {
            color: #ffaa44;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back to Paradoxes</a>

    <header>
        <h1>Kapitza Pendulum</h1>
        <p class="subtitle">An inverted pendulum becomes stable when you shake it—vibration defeats gravity</p>
    </header>

    <div class="container">
        <div class="demo-section">
            <div class="canvas-container">
                <canvas id="canvas"></canvas>
            </div>
            <div class="controls">
                <div class="status-display">
                    <div class="status" id="statusText">STABLE</div>
                    <div class="sub" id="statusSub">Vibration creates effective restoring force</div>
                </div>

                <div class="mode-buttons">
                    <button id="invertedBtn" class="inverted active">⬆️ Inverted</button>
                    <button id="normalBtn" class="normal">⬇️ Normal</button>
                </div>

                <div class="info-panel">
                    <h3>System State</h3>
                    <div class="info-row">
                        <span class="info-label">Angle from vertical</span>
                        <span class="info-value" id="angleValue">0.0°</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Angular velocity</span>
                        <span class="info-value" id="velocityValue">0.0 rad/s</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Pivot oscillation</span>
                        <span class="info-value" id="pivotValue">±2.0 cm</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Vibration Frequency (Hz)</label>
                    <input type="range" id="frequency" min="1" max="50" value="30" step="1">
                    <div class="value-display" id="freqDisplay">30 Hz</div>
                </div>

                <div class="control-group">
                    <label>Vibration Amplitude (cm)</label>
                    <input type="range" id="amplitude" min="0" max="5" value="2" step="0.1">
                    <div class="value-display" id="ampDisplay">2.0 cm</div>
                </div>

                <div class="control-group">
                    <label>Damping</label>
                    <input type="range" id="damping" min="0" max="0.5" value="0.1" step="0.01">
                    <div class="value-display" id="dampDisplay">0.10</div>
                </div>

                <button id="perturbBtn">Add Perturbation</button>
                <button id="resetBtn">Reset Pendulum</button>
            </div>
        </div>

        <div class="essay">
            <h2>The Paradox: Disorder Creates Order</h2>
            <p>
                Try balancing a pencil on your fingertip. It falls over instantly—the inverted
                position is unstable. Any tiny deviation from vertical grows exponentially until
                the pencil topples. This is basic physics: an inverted pendulum is <em>always</em>
                unstable... right?
            </p>

            <div class="highlight-box paradox">
                <strong>The Kapitza Paradox:</strong> Rapidly vibrate the pivot point up and down,
                and something magical happens: the inverted pendulum <em>becomes stable</em>. It
                stands upright, resisting perturbations as if an invisible hand were holding it.
                Adding "noise" creates order. Chaos begets stability.
            </div>

            <h2>Discovery and Explanation</h2>
            <p>
                In 1908, British physicist Andrew Stephenson noticed this counterintuitive behavior
                but couldn't fully explain it. The complete theoretical treatment came from Soviet
                Nobel laureate <strong>Pyotr Kapitza</strong> in 1951, who showed that high-frequency
                vibrations create an "effective potential" that stabilizes the inverted position.
            </p>
            <p>
                Kapitza's insight was to separate the motion into "fast" and "slow" variables.
                The fast oscillations of the pivot don't directly stabilize the pendulum—instead,
                they create an <em>averaged effect</em> that acts like a restoring force pushing
                the pendulum back toward vertical.
            </p>

            <div class="formula">
                U<sub>eff</sub>(θ) = −mgl cos(θ) + (ma²ω²/4l) sin²(θ)
            </div>
            <p style="text-align: center; color: #887766; font-size: 0.9rem;">
                Effective potential: gravity (first term) vs vibration-induced restoring (second term)
            </p>

            <h2>How It Works</h2>
            <p>
                When the pendulum tilts slightly from vertical, the pivot's vibration creates
                asymmetric forces. During the upward phase of vibration, the pivot accelerates
                upward faster than the bob can follow. During the downward phase, the pivot
                decelerates. These accelerations, averaged over many cycles, produce a net
                force pointing toward the vertical.
            </p>
            <p>
                For stability, the vibration must satisfy certain conditions:
            </p>
            <ul style="margin-left: 25px; margin-bottom: 15px; color: #c8c0b0;">
                <li>The frequency ω must be much larger than the natural pendulum frequency ω₀ = √(g/l)</li>
                <li>The dimensionless parameter (aω)²/(2gl) must exceed 1</li>
                <li>If amplitude is too small or frequency too low, the pendulum falls</li>
            </ul>

            <div class="highlight-box">
                <strong>The Double Surprise:</strong> Not only does the inverted position become
                stable, but the normal hanging position can become <em>unstable</em> under the
                right conditions! When vibration parameters are chosen appropriately, the bottom
                equilibrium experiences parametric resonance and begins swinging wildly.
            </div>

            <h2>Effective Potential Landscape</h2>
            <p>
                Without vibration, the potential energy has a maximum at the top (inverted) and
                minimum at the bottom (hanging). The inverted position is unstable because any
                perturbation rolls the system downhill.
            </p>
            <p>
                With sufficient vibration, the effective potential develops a <strong>local minimum</strong>
                at the inverted position. The pendulum sits in a "potential well" created purely
                by oscillation. Perturbations cause it to oscillate within this well rather than
                falling over.
            </p>

            <h2>Applications and Extensions</h2>
            <p>
                <strong>Particle traps:</strong> The Paul trap for charged particles uses
                oscillating electric fields to create stable confinement—the same principle
                as the Kapitza pendulum. Wolfgang Paul shared the 1989 Nobel Prize for this work.
            </p>
            <p>
                <strong>Plasma physics:</strong> Magnetic mirrors use oscillating fields to
                confine hot plasmas, a key technology for fusion research.
            </p>
            <p>
                <strong>Quantum systems:</strong> Ultracold atoms in optical lattices can be
                dynamically stabilized using time-varying potentials, enabling exotic quantum
                phases.
            </p>
            <p>
                <strong>Engineering:</strong> Understanding parametric stabilization helps design
                systems that exploit—rather than suffer from—vibrations.
            </p>

            <h2>Vibrational Mechanics</h2>
            <p>
                Kapitza's work spawned an entire field: <strong>vibrational mechanics</strong>,
                the study of how fast oscillations can fundamentally change a system's effective
                dynamics. The principle appears everywhere from washing machines to the inner ear,
                from earthquake-resistant buildings to laser cooling of atoms.
            </p>

            <div class="sources">
                <h3>Sources & Further Reading</h3>
                <ul>
                    <li><a href="https://en.wikipedia.org/wiki/Kapitza's_pendulum">Wikipedia: Kapitza's Pendulum</a></li>
                    <li><a href="http://butikov.faculty.ifmo.ru/InvPendulumCNS.pdf">Butikov: A Physically Transparent Treatment (PDF)</a></li>
                    <li><a href="https://cmp.phys.ufl.edu/files/Kapitza-pendulum.html">UFL: Computational Methods - Kapitza Pendulum</a></li>
                    <li><a href="https://www.researchgate.net/publication/230954780_An_improved_criterion_for_Kapitza's_pendulum_stability">ResearchGate: Improved Stability Criterion</a></li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // High DPI setup
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.width * 0.8 * dpr;
        canvas.style.height = rect.width * 0.8 + 'px';
        ctx.scale(dpr, dpr);

        const width = rect.width;
        const height = rect.width * 0.8;

        // Physics parameters
        const g = 9.81; // m/s²
        const L = 0.3; // pendulum length (m)
        const dt = 0.001; // time step (s)
        const stepsPerFrame = 5;

        // State
        let theta = 0.1; // angle from vertical (rad)
        let omega = 0; // angular velocity (rad/s)
        let time = 0;

        // Control parameters
        let vibFreq = 30; // Hz
        let vibAmp = 0.02; // m
        let damping = 0.1;
        let inverted = true; // true = bob above pivot

        // Pivot position for display
        let pivotY = height * 0.5;
        const pivotX = width / 2;

        // Controls
        const freqSlider = document.getElementById('frequency');
        const ampSlider = document.getElementById('amplitude');
        const dampSlider = document.getElementById('damping');
        const invertedBtn = document.getElementById('invertedBtn');
        const normalBtn = document.getElementById('normalBtn');
        const perturbBtn = document.getElementById('perturbBtn');
        const resetBtn = document.getElementById('resetBtn');

        freqSlider.addEventListener('input', e => {
            vibFreq = parseFloat(e.target.value);
            document.getElementById('freqDisplay').textContent = vibFreq + ' Hz';
        });

        ampSlider.addEventListener('input', e => {
            vibAmp = parseFloat(e.target.value) / 100;
            document.getElementById('ampDisplay').textContent = (vibAmp * 100).toFixed(1) + ' cm';
        });

        dampSlider.addEventListener('input', e => {
            damping = parseFloat(e.target.value);
            document.getElementById('dampDisplay').textContent = damping.toFixed(2);
        });

        invertedBtn.addEventListener('click', () => {
            inverted = true;
            invertedBtn.classList.add('active');
            normalBtn.classList.remove('active');
            resetPendulum();
        });

        normalBtn.addEventListener('click', () => {
            inverted = false;
            normalBtn.classList.add('active');
            invertedBtn.classList.remove('active');
            resetPendulum();
        });

        perturbBtn.addEventListener('click', () => {
            theta += (Math.random() - 0.5) * 0.3;
            omega += (Math.random() - 0.5) * 2;
        });

        resetBtn.addEventListener('click', resetPendulum);

        function resetPendulum() {
            theta = 0.05 * (Math.random() - 0.5);
            omega = 0;
        }

        function physics() {
            const vibOmega = vibFreq * 2 * Math.PI; // rad/s

            for (let i = 0; i < stepsPerFrame; i++) {
                // Pivot acceleration (second derivative of pivot position)
                const pivotAcc = -vibAmp * vibOmega * vibOmega * Math.sin(vibOmega * time);

                // Equation of motion for pendulum with vibrating pivot
                // θ'' = -(g/L + a/L) * sin(θ) - damping * θ'
                // where a is the pivot acceleration

                const gravitySign = inverted ? 1 : -1;
                const angularAcc = gravitySign * (g / L) * Math.sin(theta)
                                 + (pivotAcc / L) * Math.sin(theta)
                                 - damping * omega;

                // Symplectic Euler integration
                omega += angularAcc * dt;
                theta += omega * dt;

                time += dt;

                // Wrap angle
                while (theta > Math.PI) theta -= 2 * Math.PI;
                while (theta < -Math.PI) theta += 2 * Math.PI;
            }
        }

        function updateDisplay() {
            document.getElementById('angleValue').textContent = (theta * 180 / Math.PI).toFixed(1) + '°';
            document.getElementById('velocityValue').textContent = omega.toFixed(2) + ' rad/s';
            document.getElementById('pivotValue').textContent = '±' + (vibAmp * 100).toFixed(1) + ' cm';

            // Check stability
            const isStable = Math.abs(theta) < 0.5 && Math.abs(omega) < 3;
            const statusEl = document.getElementById('statusText');
            const subEl = document.getElementById('statusSub');

            if (inverted) {
                if (isStable && vibFreq > 10 && vibAmp > 0.01) {
                    statusEl.textContent = 'STABLE';
                    statusEl.className = 'status stable';
                    subEl.textContent = 'Vibration creates effective restoring force';
                } else if (vibAmp < 0.005 || vibFreq < 5) {
                    statusEl.textContent = 'FALLING';
                    statusEl.className = 'status unstable';
                    subEl.textContent = 'Insufficient vibration for stability';
                } else {
                    statusEl.textContent = 'OSCILLATING';
                    statusEl.className = 'status';
                    subEl.textContent = 'Pendulum in effective potential well';
                }
            } else {
                if (Math.abs(theta) < 0.1 && Math.abs(omega) < 0.5) {
                    statusEl.textContent = 'EQUILIBRIUM';
                    statusEl.className = 'status stable';
                    subEl.textContent = 'Normal stable position';
                } else {
                    statusEl.textContent = 'SWINGING';
                    statusEl.className = 'status';
                    subEl.textContent = 'Parametric oscillation possible';
                }
            }
        }

        function draw() {
            ctx.fillStyle = '#0a0805';
            ctx.fillRect(0, 0, width, height);

            // Calculate pivot position (vibrating)
            const vibOmega = vibFreq * 2 * Math.PI;
            const pivotOffset = vibAmp * Math.sin(vibOmega * time) * 500; // scaled for display
            const currentPivotY = height * 0.5 + pivotOffset;

            // Draw pivot support structure
            ctx.strokeStyle = '#444';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(pivotX - 60, height * 0.5 - 80);
            ctx.lineTo(pivotX - 60, height * 0.5 + 80);
            ctx.moveTo(pivotX + 60, height * 0.5 - 80);
            ctx.lineTo(pivotX + 60, height * 0.5 + 80);
            ctx.stroke();

            // Vibration mechanism
            ctx.strokeStyle = '#666';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(pivotX - 60, currentPivotY);
            ctx.lineTo(pivotX + 60, currentPivotY);
            ctx.stroke();

            // Springs/mechanism
            ctx.strokeStyle = '#888';
            ctx.lineWidth = 1;
            for (let side = -1; side <= 1; side += 2) {
                const sx = pivotX + side * 60;
                ctx.beginPath();
                for (let i = 0; i < 10; i++) {
                    const y1 = height * 0.5 - 80 + i * (currentPivotY - (height * 0.5 - 80)) / 10;
                    const y2 = height * 0.5 - 80 + (i + 0.5) * (currentPivotY - (height * 0.5 - 80)) / 10;
                    ctx.moveTo(sx - 5, y1);
                    ctx.lineTo(sx + 5, y2);
                }
                ctx.stroke();
            }

            // Pendulum length for display
            const displayL = 150;

            // Calculate bob position
            let bobX, bobY;
            if (inverted) {
                // Bob above pivot
                bobX = pivotX + displayL * Math.sin(theta);
                bobY = currentPivotY - displayL * Math.cos(theta);
            } else {
                // Bob below pivot
                bobX = pivotX + displayL * Math.sin(theta);
                bobY = currentPivotY + displayL * Math.cos(theta);
            }

            // Draw rod
            ctx.strokeStyle = '#aa8866';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(pivotX, currentPivotY);
            ctx.lineTo(bobX, bobY);
            ctx.stroke();

            // Draw pivot point
            ctx.fillStyle = '#cc9966';
            ctx.beginPath();
            ctx.arc(pivotX, currentPivotY, 8, 0, Math.PI * 2);
            ctx.fill();

            // Draw bob
            const bobGrad = ctx.createRadialGradient(bobX - 5, bobY - 5, 0, bobX, bobY, 20);
            bobGrad.addColorStop(0, '#ffcc88');
            bobGrad.addColorStop(0.5, '#cc8844');
            bobGrad.addColorStop(1, '#885522');
            ctx.fillStyle = bobGrad;
            ctx.beginPath();
            ctx.arc(bobX, bobY, 20, 0, Math.PI * 2);
            ctx.fill();

            // Draw trail
            const trailLength = 50;
            ctx.strokeStyle = 'rgba(255, 170, 100, 0.3)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let i = 0; i < trailLength; i++) {
                const t = time - i * dt * stepsPerFrame * 2;
                const pivotYi = height * 0.5 + vibAmp * Math.sin(vibOmega * t) * 500;
                const thetaEst = theta - omega * i * dt * stepsPerFrame * 2;

                let bx, by;
                if (inverted) {
                    bx = pivotX + displayL * Math.sin(thetaEst);
                    by = pivotYi - displayL * Math.cos(thetaEst);
                } else {
                    bx = pivotX + displayL * Math.sin(thetaEst);
                    by = pivotYi + displayL * Math.cos(thetaEst);
                }

                if (i === 0) ctx.moveTo(bx, by);
                else ctx.lineTo(bx, by);
            }
            ctx.stroke();

            // Draw effective potential graph (small inset)
            drawPotentialGraph();

            // Labels
            ctx.fillStyle = '#aa8855';
            ctx.font = '14px Segoe UI';
            ctx.textAlign = 'center';

            if (inverted) {
                ctx.fillText('Inverted Position', pivotX, 25);
                ctx.fillText('(Classically unstable → Kapitza stable)', pivotX, 42);
            } else {
                ctx.fillText('Normal Position', pivotX, 25);
                ctx.fillText('(Classically stable)', pivotX, 42);
            }

            ctx.fillStyle = '#666';
            ctx.font = '12px Segoe UI';
            ctx.fillText('Vibrating pivot', pivotX, height - 20);
        }

        function drawPotentialGraph() {
            const graphX = 30;
            const graphY = height - 130;
            const graphW = 120;
            const graphH = 80;

            // Background
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(graphX, graphY, graphW, graphH);

            ctx.strokeStyle = '#555';
            ctx.lineWidth = 1;
            ctx.strokeRect(graphX, graphY, graphW, graphH);

            // Calculate stability parameter
            const vibOmega = vibFreq * 2 * Math.PI;
            const kapitzaParam = (vibAmp * vibOmega) * (vibAmp * vibOmega) / (2 * g * L);

            // Draw effective potential
            ctx.strokeStyle = '#ffaa44';
            ctx.lineWidth = 2;
            ctx.beginPath();

            for (let i = 0; i <= graphW; i++) {
                const angle = (i / graphW - 0.5) * Math.PI;

                // U_eff = -cos(θ) + k*sin²(θ) for inverted
                let potential;
                if (inverted) {
                    potential = -Math.cos(angle) + kapitzaParam * Math.sin(angle) * Math.sin(angle);
                } else {
                    potential = Math.cos(angle);
                }

                // Scale and offset for display
                const y = graphY + graphH / 2 - potential * 30;

                if (i === 0) ctx.moveTo(graphX + i, y);
                else ctx.lineTo(graphX + i, y);
            }
            ctx.stroke();

            // Current position marker
            const currentX = graphX + (theta / Math.PI + 0.5) * graphW;
            ctx.fillStyle = '#ff6644';
            ctx.beginPath();
            ctx.arc(currentX, graphY + graphH / 2, 4, 0, Math.PI * 2);
            ctx.fill();

            // Label
            ctx.fillStyle = '#888';
            ctx.font = '10px Segoe UI';
            ctx.textAlign = 'center';
            ctx.fillText('U_eff(θ)', graphX + graphW / 2, graphY - 5);
        }

        function animate() {
            physics();
            draw();
            updateDisplay();
            requestAnimationFrame(animate);
        }

        // Handle resize
        window.addEventListener('resize', () => {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.width * 0.8 * dpr;
            canvas.style.height = rect.width * 0.8 + 'px';
            ctx.scale(dpr, dpr);
        });

        resetPendulum();
        animate();
    </script>
</body>
</html>
