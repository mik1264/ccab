<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Flash-Lag Effect | Surprising Paradoxes</title>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&family=Nunito:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --sage: #8A9A5B;
            --moss: #606C38;
            --earth: #DDA15E;
            --cream: #FEFAE0;
            --terracotta: #BC6C25;
            --dark-moss: #3d4423;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, #F4F1DE 50%, #EDE8D5 100%);
            min-height: 100vh;
            color: var(--dark-moss);
            line-height: 1.7;
        }

        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            text-decoration: none;
            color: var(--moss);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 100;
            background: rgba(255,255,255,0.8);
            padding: 8px 16px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .back-link:hover {
            background: var(--moss);
            color: white;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 80px 20px 40px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            font-family: 'Lora', serif;
            font-size: 2.5rem;
            color: var(--moss);
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2rem;
            color: var(--terracotta);
            font-style: italic;
        }

        .card {
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        }

        h2 {
            font-family: 'Lora', serif;
            color: var(--moss);
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        h3 {
            font-family: 'Lora', serif;
            color: var(--terracotta);
            margin: 25px 0 15px;
            font-size: 1.2rem;
        }

        p {
            margin-bottom: 15px;
        }

        .experiment-phase {
            display: none;
        }

        .experiment-phase.active {
            display: block;
        }

        .progress-dots {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 25px;
        }

        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ddd;
            transition: all 0.3s ease;
        }

        .progress-dot.active {
            background: var(--moss);
            transform: scale(1.2);
        }

        .progress-dot.completed {
            background: var(--sage);
        }

        /* Demo Canvas */
        .demo-container {
            background: #1a1a2e;
            border-radius: 15px;
            padding: 20px;
            margin: 25px 0;
            text-align: center;
        }

        #demo-canvas {
            display: block;
            margin: 0 auto;
            border-radius: 10px;
        }

        .demo-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .control-group {
            background: rgba(255,255,255,0.1);
            padding: 15px 20px;
            border-radius: 10px;
            text-align: center;
        }

        .control-label {
            color: rgba(255,255,255,0.7);
            font-size: 0.85rem;
            margin-bottom: 8px;
        }

        .control-value {
            color: white;
            font-weight: 700;
            font-size: 1.2rem;
        }

        input[type="range"] {
            width: 150px;
            margin-top: 8px;
        }

        .phase-btn {
            padding: 15px 40px;
            font-size: 1.1rem;
            font-family: 'Nunito', sans-serif;
            font-weight: 600;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            margin: 10px;
        }

        .phase-btn.primary {
            background: var(--moss);
            color: white;
        }

        .phase-btn.primary:hover:not(:disabled) {
            background: var(--dark-moss);
            transform: scale(1.05);
        }

        .phase-btn.secondary {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .phase-btn.secondary:hover {
            background: rgba(255,255,255,0.3);
        }

        .phase-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Trial Interface */
        .trial-display {
            text-align: center;
            padding: 20px;
        }

        .trial-counter {
            font-size: 1.2rem;
            color: white;
            margin-bottom: 15px;
        }

        .trial-question {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .trial-question p {
            color: white;
            margin-bottom: 15px;
        }

        .response-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .response-btn {
            padding: 15px 35px;
            font-size: 1rem;
            font-family: 'Nunito', sans-serif;
            font-weight: 600;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .response-btn:hover {
            background: white;
            color: #1a1a2e;
        }

        .response-btn.ahead {
            border-color: #4CAF50;
        }

        .response-btn.ahead:hover {
            background: #4CAF50;
            color: white;
        }

        .response-btn.aligned {
            border-color: #2196F3;
        }

        .response-btn.aligned:hover {
            background: #2196F3;
            color: white;
        }

        .response-btn.behind {
            border-color: #f44336;
        }

        .response-btn.behind:hover {
            background: #f44336;
            color: white;
        }

        /* Results */
        .result-box {
            text-align: center;
            padding: 25px;
            background: linear-gradient(135deg, rgba(138,154,91,0.15), rgba(138,154,91,0.05));
            border-radius: 20px;
            margin: 25px 0;
        }

        .result-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--moss);
            margin-bottom: 10px;
        }

        .result-stat {
            font-size: 3rem;
            font-weight: 700;
            font-family: 'Lora', serif;
            color: var(--terracotta);
        }

        .result-stat small {
            font-size: 1.2rem;
            color: var(--moss);
        }

        .theories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .theory-card {
            background: linear-gradient(135deg, var(--cream), white);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .theory-card:hover {
            border-color: var(--sage);
            transform: translateY(-3px);
        }

        .theory-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .theory-title {
            font-weight: 700;
            color: var(--moss);
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .theory-author {
            font-size: 0.85rem;
            color: var(--terracotta);
            margin-bottom: 10px;
        }

        .theory-desc {
            font-size: 0.9rem;
            color: #666;
        }

        .timeline-diagram {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            overflow-x: auto;
        }

        .timeline-row {
            display: flex;
            align-items: center;
            margin: 15px 0;
            gap: 10px;
        }

        .timeline-label {
            min-width: 100px;
            font-weight: 600;
            color: var(--moss);
            font-size: 0.9rem;
        }

        .timeline-bar {
            flex: 1;
            height: 30px;
            background: #eee;
            border-radius: 5px;
            position: relative;
            overflow: hidden;
        }

        .timeline-marker {
            position: absolute;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
        }

        .timeline-marker.flash {
            background: #f44336;
            width: 60px;
        }

        .timeline-marker.moving {
            background: #4CAF50;
            width: 80px;
        }

        .timeline-marker.perception {
            background: #2196F3;
        }

        .quote-box {
            background: linear-gradient(135deg, rgba(138,154,91,0.15), rgba(138,154,91,0.05));
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            position: relative;
        }

        .quote-box::before {
            content: '"';
            font-size: 4rem;
            color: var(--sage);
            opacity: 0.3;
            position: absolute;
            top: 10px;
            left: 20px;
            font-family: Georgia, serif;
        }

        .quote-text {
            font-style: italic;
            font-size: 1.1rem;
            padding-left: 40px;
            color: var(--dark-moss);
        }

        .quote-author {
            text-align: right;
            margin-top: 15px;
            color: var(--moss);
            font-weight: 600;
        }

        .insight-box {
            background: linear-gradient(135deg, rgba(221,161,94,0.2), rgba(221,161,94,0.05));
            border-left: 4px solid var(--earth);
            padding: 20px;
            border-radius: 0 15px 15px 0;
            margin: 25px 0;
        }

        .insight-box strong {
            color: var(--terracotta);
        }

        .examples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 25px 0;
        }

        .example-card {
            background: linear-gradient(135deg, var(--cream), white);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .example-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .example-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .example-title {
            font-weight: 700;
            color: var(--moss);
            margin-bottom: 8px;
        }

        .example-desc {
            font-size: 0.9rem;
            color: #666;
        }

        .restart-btn {
            display: block;
            margin: 30px auto 0;
            padding: 15px 40px;
            font-size: 1.1rem;
            font-family: 'Nunito', sans-serif;
            font-weight: 600;
            background: var(--terracotta);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .restart-btn:hover {
            background: #a55a1f;
            transform: scale(1.05);
        }

        .ms-explanation {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            margin: 25px 0;
            flex-wrap: wrap;
        }

        .ms-box {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 15px;
            min-width: 150px;
        }

        .ms-value {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: 'Lora', serif;
            color: var(--moss);
        }

        .ms-label {
            font-size: 0.9rem;
            color: #666;
        }

        @media (max-width: 600px) {
            h1 { font-size: 1.8rem; }
            .theories-grid { grid-template-columns: 1fr; }
            .response-buttons { flex-direction: column; }
            .ms-explanation { flex-direction: column; }
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Paradoxes</a>

    <div class="container">
        <header>
            <h1>The Flash-Lag Effect</h1>
            <p class="subtitle">When Moving Objects Jump Ahead of Reality</p>
        </header>

        <!-- Phase 1: Introduction -->
        <div id="phase1" class="experiment-phase active">
            <div class="card">
                <div class="progress-dots">
                    <div class="progress-dot active"></div>
                    <div class="progress-dot"></div>
                    <div class="progress-dot"></div>
                    <div class="progress-dot"></div>
                </div>

                <h2>A Strange Timing Illusion</h2>
                <p>Watch the demonstration below. A green dot moves in a circle. When it passes the red marker, a flash occurs.</p>
                <p><strong>The flash and the dot are at the exact same position.</strong> But do they look aligned?</p>

                <div class="demo-container">
                    <canvas id="demo-canvas" width="400" height="300"></canvas>
                    <div class="demo-controls">
                        <div class="control-group">
                            <div class="control-label">Speed</div>
                            <div class="control-value" id="speedValue">Medium</div>
                            <input type="range" id="speedSlider" min="1" max="5" value="3">
                        </div>
                    </div>
                </div>

                <p>Most people perceive the <strong>moving dot as ahead</strong> of the flash‚Äîeven though they occur at exactly the same position.</p>

                <p>This is the <strong>Flash-Lag Effect</strong>, first systematically studied by Romi Nijhawan in 1994. It reveals something profound about how our brains construct reality from delayed sensory information.</p>

                <button class="phase-btn primary" onclick="startTrials()">Test Your Perception</button>
            </div>
        </div>

        <!-- Phase 2: Trials -->
        <div id="phase2" class="experiment-phase">
            <div class="card">
                <div class="progress-dots">
                    <div class="progress-dot completed"></div>
                    <div class="progress-dot active"></div>
                    <div class="progress-dot"></div>
                    <div class="progress-dot"></div>
                </div>

                <h2>Perception Test</h2>

                <div class="demo-container">
                    <canvas id="trial-canvas" width="500" height="250"></canvas>

                    <div class="trial-display">
                        <div class="trial-counter">Trial <span id="trialNum">1</span> of 8</div>

                        <div class="trial-question" id="trialQuestion" style="display: none;">
                            <p>Where was the moving dot when the flash occurred?</p>
                            <div class="response-buttons">
                                <button class="response-btn ahead" onclick="recordResponse('ahead')">Ahead of flash</button>
                                <button class="response-btn aligned" onclick="recordResponse('aligned')">Aligned with flash</button>
                                <button class="response-btn behind" onclick="recordResponse('behind')">Behind flash</button>
                            </div>
                        </div>

                        <p id="trialInstruction" style="color: white;">Watch carefully...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Phase 3: Results -->
        <div id="phase3" class="experiment-phase">
            <div class="card">
                <div class="progress-dots">
                    <div class="progress-dot completed"></div>
                    <div class="progress-dot completed"></div>
                    <div class="progress-dot active"></div>
                    <div class="progress-dot"></div>
                </div>

                <h2>Your Results</h2>

                <div class="result-box">
                    <div class="result-title">You perceived the dot as AHEAD</div>
                    <div class="result-stat"><span id="aheadPercent">0</span>%</div>
                    <p>of the time (when it was actually aligned)</p>
                </div>

                <div class="insight-box" id="resultInsight">
                    <!-- Filled by JavaScript -->
                </div>

                <h3>What's Actually Happening</h3>

                <div class="ms-explanation">
                    <div class="ms-box">
                        <div class="ms-value">80</div>
                        <div class="ms-label">milliseconds</div>
                    </div>
                    <p style="max-width: 300px;">The brain processes events in an ~80ms window <em>after</em> they occur. Moving objects get "projected forward" to compensate for neural delays.</p>
                </div>

                <p>At typical speeds, this creates a perceived displacement of <strong>about 4-8 degrees</strong> of visual angle‚Äîenough to be clearly noticeable.</p>

                <button class="phase-btn primary" onclick="showPhase(4)">Explore the Science</button>
            </div>
        </div>

        <!-- Phase 4: The Science -->
        <div id="phase4" class="experiment-phase">
            <div class="card">
                <div class="progress-dots">
                    <div class="progress-dot completed"></div>
                    <div class="progress-dot completed"></div>
                    <div class="progress-dot completed"></div>
                    <div class="progress-dot active"></div>
                </div>

                <h2>Three Competing Theories</h2>
                <p>Scientists have debated the cause of the flash-lag effect for over 25 years:</p>

                <div class="theories-grid">
                    <div class="theory-card">
                        <div class="theory-icon">üéØ</div>
                        <div class="theory-title">Motion Extrapolation</div>
                        <div class="theory-author">Nijhawan, 1994</div>
                        <div class="theory-desc">The brain continuously <em>predicts</em> where moving objects will be, compensating for neural delays. It literally shows you the future.</div>
                    </div>

                    <div class="theory-card">
                        <div class="theory-icon">‚è™</div>
                        <div class="theory-title">Postdiction</div>
                        <div class="theory-author">Eagleman & Sejnowski, 2000</div>
                        <div class="theory-desc">Your perception is constructed <em>after</em> events occur. The brain averages positions over ~80ms following the flash, biasing toward where the object went.</div>
                    </div>

                    <div class="theory-card">
                        <div class="theory-icon">‚ö°</div>
                        <div class="theory-title">Differential Latency</div>
                        <div class="theory-author">Purushothaman et al., 1998</div>
                        <div class="theory-desc">Moving objects are processed <em>faster</em> than stationary flashes. By the time you perceive the flash, the moving object has already been updated.</div>
                    </div>
                </div>

                <div class="insight-box">
                    <strong>The current consensus:</strong> All three mechanisms likely contribute. Motion extrapolation happens predictively, differential latency affects processing speed, and postdiction integrates information after events occur.
                </div>
            </div>

            <div class="card">
                <h2>The Timing Problem</h2>

                <p>Visual information takes time to reach your brain. Light hits your retina, signals travel through the optic nerve, and multiple brain regions process the scene. This takes roughly <strong>50-100 milliseconds</strong>.</p>

                <p>If you perceived everything with this delay, catching a ball or dodging obstacles would be impossible. The world would always be "behind" reality.</p>

                <div class="timeline-diagram">
                    <p style="font-weight: 600; margin-bottom: 15px; color: var(--moss);">What's happening in your brain:</p>

                    <div class="timeline-row">
                        <div class="timeline-label">Physical Reality</div>
                        <div class="timeline-bar">
                            <div class="timeline-marker flash" style="left: 40%;">Flash</div>
                            <div class="timeline-marker moving" style="left: 40%; background: #4CAF50;">Dot</div>
                        </div>
                    </div>

                    <div class="timeline-row">
                        <div class="timeline-label">Your Perception</div>
                        <div class="timeline-bar">
                            <div class="timeline-marker flash" style="left: 40%;">Flash</div>
                            <div class="timeline-marker moving" style="left: 52%; background: #4CAF50;">Dot</div>
                        </div>
                    </div>
                </div>

                <p>The brain solves this by <strong>extrapolating motion forward</strong>‚Äîessentially predicting where moving objects will be by the time you consciously perceive them.</p>

                <div class="quote-box">
                    <p class="quote-text">Because of the delays inherent in neural transmission, the brain needs time to process incoming visual information. If these delays were not somehow compensated, we would consistently mislocalize moving objects behind their physical positions.</p>
                    <p class="quote-author">‚Äî Nijhawan, Nature (1994)</p>
                </div>
            </div>

            <div class="card">
                <h2>Why It Matters</h2>

                <div class="examples-grid">
                    <div class="example-card">
                        <div class="example-icon">‚öæ</div>
                        <div class="example-title">Sports</div>
                        <div class="example-desc">Batters must swing where the ball <em>will be</em>. The flash-lag effect helps explain anticipatory timing in sports.</div>
                    </div>

                    <div class="example-card">
                        <div class="example-icon">üöó</div>
                        <div class="example-title">Driving</div>
                        <div class="example-desc">Judging gaps in traffic requires predicting where cars will be‚Äîa process affected by this same mechanism.</div>
                    </div>

                    <div class="example-card">
                        <div class="example-icon">üéÆ</div>
                        <div class="example-title">Gaming</div>
                        <div class="example-desc">Game developers account for perception delays. Input lag feels worse because it conflicts with motion prediction.</div>
                    </div>

                    <div class="example-card">
                        <div class="example-icon">‚úàÔ∏è</div>
                        <div class="example-title">Aviation</div>
                        <div class="example-desc">Pilots judging closing distances with other aircraft or runways rely on motion extrapolation.</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Related Illusions</h2>

                <p>The flash-lag effect is part of a family of motion perception illusions:</p>

                <div class="examples-grid">
                    <div class="example-card">
                        <div class="example-icon">üåÄ</div>
                        <div class="example-title">Fr√∂hlich Effect</div>
                        <div class="example-desc">A moving object first appears slightly ahead of where it actually entered your visual field.</div>
                    </div>

                    <div class="example-card">
                        <div class="example-icon">üîô</div>
                        <div class="example-title">Representational Momentum</div>
                        <div class="example-desc">When a moving object disappears, you remember its final position as further along its trajectory.</div>
                    </div>

                    <div class="example-card">
                        <div class="example-icon">üé¨</div>
                        <div class="example-title">Motion Blur</div>
                        <div class="example-desc">Fast-moving objects appear smeared‚Äîthe brain integrates positions over time.</div>
                    </div>
                </div>

                <div class="quote-box">
                    <p class="quote-text">Visual awareness is neither predictive nor online but is postdictive, so that the percept attributed to the time of the flash is a function of events that happen in the approximately 80 milliseconds after the flash.</p>
                    <p class="quote-author">‚Äî Eagleman & Sejnowski, Science (2000)</p>
                </div>

                <div class="insight-box">
                    <strong>The deeper insight:</strong> You don't perceive reality in real-time. Your brain constructs a "best guess" of the present moment using information from the past and predictions about the future. The flash-lag effect reveals this construction process.
                </div>

                <button class="restart-btn" onclick="resetExperiment()">Experience It Again</button>
            </div>
        </div>
    </div>

    <script>
        // Demo Animation
        const demoCanvas = document.getElementById('demo-canvas');
        const demoCtx = demoCanvas.getContext('2d');
        let demoAngle = 0;
        let demoSpeed = 0.03;
        let flashActive = false;
        let flashTimer = 0;
        const flashPosition = Math.PI / 2; // Top of circle

        // Speed slider
        document.getElementById('speedSlider').addEventListener('input', (e) => {
            const speeds = ['Very Slow', 'Slow', 'Medium', 'Fast', 'Very Fast'];
            const speedValues = [0.015, 0.02, 0.03, 0.04, 0.05];
            document.getElementById('speedValue').textContent = speeds[e.target.value - 1];
            demoSpeed = speedValues[e.target.value - 1];
        });

        function drawDemo() {
            const centerX = demoCanvas.width / 2;
            const centerY = demoCanvas.height / 2;
            const radius = 100;

            // Clear
            demoCtx.fillStyle = '#1a1a2e';
            demoCtx.fillRect(0, 0, demoCanvas.width, demoCanvas.height);

            // Draw circle path
            demoCtx.strokeStyle = '#3a3a5e';
            demoCtx.lineWidth = 2;
            demoCtx.beginPath();
            demoCtx.arc(centerX, centerY, radius, 0, Math.PI * 2);
            demoCtx.stroke();

            // Draw marker at flash position
            const markerX = centerX + Math.cos(flashPosition) * radius;
            const markerY = centerY - Math.sin(flashPosition) * radius;

            demoCtx.fillStyle = '#666';
            demoCtx.beginPath();
            demoCtx.arc(markerX, markerY, 8, 0, Math.PI * 2);
            demoCtx.fill();

            // Flash when dot passes marker
            const normalizedAngle = ((demoAngle % (Math.PI * 2)) + Math.PI * 2) % (Math.PI * 2);
            const targetAngle = (Math.PI * 2 - flashPosition + Math.PI / 2) % (Math.PI * 2);

            if (Math.abs(normalizedAngle - targetAngle) < demoSpeed * 2 && flashTimer <= 0) {
                flashActive = true;
                flashTimer = 10;
            }

            if (flashActive) {
                // Flash effect
                demoCtx.fillStyle = '#ff4444';
                demoCtx.beginPath();
                demoCtx.arc(markerX, markerY, 20, 0, Math.PI * 2);
                demoCtx.fill();

                demoCtx.fillStyle = '#ffaaaa';
                demoCtx.beginPath();
                demoCtx.arc(markerX, markerY, 12, 0, Math.PI * 2);
                demoCtx.fill();

                flashTimer--;
                if (flashTimer <= 0) flashActive = false;
            }

            // Draw moving dot
            const dotX = centerX + Math.cos(demoAngle) * radius;
            const dotY = centerY - Math.sin(demoAngle) * radius;

            demoCtx.fillStyle = '#44ff44';
            demoCtx.beginPath();
            demoCtx.arc(dotX, dotY, 12, 0, Math.PI * 2);
            demoCtx.fill();

            // Update angle
            demoAngle += demoSpeed;

            requestAnimationFrame(drawDemo);
        }

        drawDemo();

        // Trial System
        const trialCanvas = document.getElementById('trial-canvas');
        const trialCtx = trialCanvas.getContext('2d');
        let trialNum = 0;
        let responses = [];
        let trialRunning = false;
        let trialDotX = 0;
        let trialFlashX = 0;
        let trialFlashed = false;
        let trialPhase = 'waiting'; // waiting, running, question

        function startTrials() {
            showPhase(2);
            trialNum = 0;
            responses = [];
            setTimeout(runTrial, 500);
        }

        function runTrial() {
            trialNum++;
            document.getElementById('trialNum').textContent = trialNum;
            document.getElementById('trialQuestion').style.display = 'none';
            document.getElementById('trialInstruction').textContent = 'Watch carefully...';
            document.getElementById('trialInstruction').style.display = 'block';

            trialDotX = -30;
            trialFlashX = trialCanvas.width / 2;
            trialFlashed = false;
            trialPhase = 'running';

            animateTrial();
        }

        function animateTrial() {
            if (trialPhase !== 'running') return;

            // Clear
            trialCtx.fillStyle = '#1a1a2e';
            trialCtx.fillRect(0, 0, trialCanvas.width, trialCanvas.height);

            // Draw track
            trialCtx.strokeStyle = '#3a3a5e';
            trialCtx.lineWidth = 2;
            trialCtx.beginPath();
            trialCtx.moveTo(0, trialCanvas.height / 2);
            trialCtx.lineTo(trialCanvas.width, trialCanvas.height / 2);
            trialCtx.stroke();

            // Flash marker
            trialCtx.fillStyle = '#666';
            trialCtx.beginPath();
            trialCtx.arc(trialFlashX, trialCanvas.height / 2, 5, 0, Math.PI * 2);
            trialCtx.fill();

            // Check for flash
            if (!trialFlashed && Math.abs(trialDotX - trialFlashX) < 8) {
                trialFlashed = true;

                // Draw flash
                trialCtx.fillStyle = '#ff4444';
                trialCtx.beginPath();
                trialCtx.arc(trialFlashX, trialCanvas.height / 2, 25, 0, Math.PI * 2);
                trialCtx.fill();
            }

            // Draw moving dot
            trialCtx.fillStyle = '#44ff44';
            trialCtx.beginPath();
            trialCtx.arc(trialDotX, trialCanvas.height / 2, 15, 0, Math.PI * 2);
            trialCtx.fill();

            // Move dot
            trialDotX += 6;

            if (trialDotX > trialCanvas.width + 30) {
                trialPhase = 'question';
                showTrialQuestion();
            } else {
                requestAnimationFrame(animateTrial);
            }
        }

        function showTrialQuestion() {
            document.getElementById('trialInstruction').style.display = 'none';
            document.getElementById('trialQuestion').style.display = 'block';
        }

        function recordResponse(response) {
            responses.push(response);

            if (trialNum < 8) {
                setTimeout(runTrial, 500);
            } else {
                showResults();
            }
        }

        function showResults() {
            showPhase(3);

            const aheadCount = responses.filter(r => r === 'ahead').length;
            const aheadPercent = Math.round((aheadCount / responses.length) * 100);

            document.getElementById('aheadPercent').textContent = aheadPercent;

            const insight = document.getElementById('resultInsight');
            if (aheadPercent >= 75) {
                insight.innerHTML = '<strong>Classic flash-lag effect!</strong> You consistently perceived the dot ahead of its actual position. Your brain is extrapolating motion to compensate for neural processing delays.';
            } else if (aheadPercent >= 50) {
                insight.innerHTML = '<strong>You experienced the effect!</strong> Most of the time you perceived the dot ahead, showing your brain\'s motion prediction at work.';
            } else if (aheadPercent >= 25) {
                insight.innerHTML = 'Interesting! You perceived the positions as aligned more often than average. You may have naturally strong timing perception, or were able to consciously correct for the illusion.';
            } else {
                insight.innerHTML = 'Unusual result! You often perceived the dot as behind or aligned. Individual differences in neural processing can affect the magnitude of this illusion.';
            }
        }

        function showPhase(num) {
            document.querySelectorAll('.experiment-phase').forEach(p => p.classList.remove('active'));
            document.getElementById('phase' + num).classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetExperiment() {
            trialNum = 0;
            responses = [];
            trialPhase = 'waiting';
            showPhase(1);
        }
    </script>
</body>
</html>
