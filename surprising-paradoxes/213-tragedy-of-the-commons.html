<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Tragedy of the Commons - When Rationality Destroys Shared Resources</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5em;
            color: #e94560;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.2em;
            color: #a0a0a0;
            font-style: italic;
        }

        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #e94560;
            text-decoration: none;
            font-size: 1.1em;
            z-index: 1000;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .panel {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .panel h2 {
            color: #e94560;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        /* Commons Visualization */
        .commons-container {
            position: relative;
            margin: 20px 0;
        }

        #commonsCanvas {
            width: 100%;
            border-radius: 15px;
            background: linear-gradient(180deg, #87CEEB 0%, #90EE90 30%, #228B22 100%);
        }

        /* Resource Bar */
        .resource-bar-container {
            margin: 20px 0;
        }

        .resource-bar {
            height: 30px;
            background: #333;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .resource-fill {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c 0%, #f39c12 30%, #2ecc71 70%, #27ae60 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .resource-label {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.9em;
            color: #a0a0a0;
        }

        /* Farmers */
        .farmers-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .farmer-card {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .farmer-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .farmer-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .farmer-cattle {
            font-size: 0.9em;
            color: #f1c40f;
        }

        .farmer-profit {
            font-size: 0.85em;
            color: #2ecc71;
        }

        .farmer-card.bankrupt {
            opacity: 0.5;
            border: 2px solid #e74c3c;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        button {
            background: linear-gradient(145deg, #e94560, #c73550);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1em;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(233,69,96,0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        button.secondary {
            background: linear-gradient(145deg, #3498db, #2980b9);
        }

        button.success {
            background: linear-gradient(145deg, #2ecc71, #27ae60);
        }

        /* Strategy Selector */
        .strategy-section {
            margin: 20px 0;
        }

        .strategy-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .strategy-btn {
            padding: 10px 20px;
            border: 2px solid #555;
            background: transparent;
            color: #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .strategy-btn:hover {
            border-color: #e94560;
        }

        .strategy-btn.active {
            background: #e94560;
            border-color: #e94560;
        }

        /* Stats */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .stat-box {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #f1c40f;
        }

        .stat-label {
            font-size: 0.9em;
            color: #a0a0a0;
        }

        /* Timeline Chart */
        .chart-container {
            margin: 20px 0;
        }

        #chartCanvas {
            width: 100%;
            height: 200px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
        }

        /* Explanation */
        .explanation {
            line-height: 1.8;
        }

        .explanation h3 {
            color: #e94560;
            margin: 20px 0 10px 0;
        }

        .quote {
            border-left: 4px solid #e94560;
            padding-left: 20px;
            margin: 20px 0;
            font-style: italic;
            color: #b0b0b0;
        }

        .math-box {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
        }

        .highlight {
            color: #f1c40f;
            font-weight: bold;
        }

        ul {
            margin-left: 30px;
            line-height: 2;
        }

        /* Slider */
        .slider-container {
            margin: 15px 0;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #333;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #e94560;
            cursor: pointer;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .stats-row {
                grid-template-columns: 1fr;
            }
        }

        .outcome-message {
            text-align: center;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            font-size: 1.2em;
            display: none;
        }

        .outcome-message.tragedy {
            background: rgba(231, 76, 60, 0.2);
            border: 2px solid #e74c3c;
            color: #e74c3c;
        }

        .outcome-message.sustainable {
            background: rgba(46, 204, 113, 0.2);
            border: 2px solid #2ecc71;
            color: #2ecc71;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Paradoxes</a>

    <div class="container">
        <header>
            <h1>The Tragedy of the Commons</h1>
            <p class="subtitle">When every farmer's rational choice destroys them all</p>
        </header>

        <div class="main-grid">
            <div class="panel">
                <h2>The Shared Pasture</h2>
                <p>Four farmers share a common grazing field. Each can add cattle to maximize their profit. But the grass is finite...</p>

                <div class="commons-container">
                    <canvas id="commonsCanvas" width="700" height="300"></canvas>
                </div>

                <div class="resource-bar-container">
                    <div class="resource-bar">
                        <div class="resource-fill" id="resourceFill" style="width: 100%;">
                            100%
                        </div>
                    </div>
                    <div class="resource-label">
                        <span>Depleted</span>
                        <span>Grass Remaining</span>
                        <span>Abundant</span>
                    </div>
                </div>

                <div class="farmers-grid" id="farmersGrid">
                    <!-- Generated by JS -->
                </div>

                <div class="outcome-message" id="outcomeMessage"></div>

                <div class="controls">
                    <button id="stepBtn">Next Season</button>
                    <button id="runBtn" class="secondary">Run Simulation</button>
                    <button id="resetBtn" class="secondary">Reset</button>
                </div>

                <div class="stats-row">
                    <div class="stat-box">
                        <div class="stat-value" id="yearDisplay">Year 1</div>
                        <div class="stat-label">Current Season</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="totalCattle">8</div>
                        <div class="stat-label">Total Cattle</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="sustainability">Sustainable</div>
                        <div class="stat-label">Status</div>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="chartCanvas" width="700" height="200"></canvas>
                </div>
            </div>

            <div class="panel">
                <h2>Farmer Strategy</h2>
                <p>How should each farmer decide how many cattle to graze?</p>

                <div class="strategy-section">
                    <div class="strategy-options">
                        <button class="strategy-btn active" data-strategy="greedy">Greedy</button>
                        <button class="strategy-btn" data-strategy="sustainable">Sustainable</button>
                        <button class="strategy-btn" data-strategy="mixed">Mixed</button>
                        <button class="strategy-btn" data-strategy="tragedy">Classic Tragedy</button>
                    </div>
                </div>

                <div class="slider-container">
                    <div class="slider-label">
                        <span>Greed Level</span>
                        <span id="greedValue">50%</span>
                    </div>
                    <input type="range" id="greedSlider" min="0" max="100" value="50">
                </div>

                <div class="slider-container">
                    <div class="slider-label">
                        <span>Grass Regrowth Rate</span>
                        <span id="regrowthValue">10%</span>
                    </div>
                    <input type="range" id="regrowthSlider" min="1" max="30" value="10">
                </div>

                <h3 style="color: #e94560; margin-top: 25px;">The Dilemma</h3>
                <div class="math-box">
                    <strong>Adding 1 cow:</strong><br><br>
                    Farmer's gain: <span class="highlight">+1 cow's worth</span><br>
                    Farmer's cost: <span style="color: #e74c3c;">1/4 of overgrazing damage</span><br><br>
                    Net gain: <span class="highlight">POSITIVE</span> for individual<br>
                    Net effect: <span style="color: #e74c3c;">NEGATIVE</span> for commons
                </div>

                <p style="margin-top: 15px; color: #a0a0a0;">Each farmer captures 100% of the benefit but only 25% of the cost. Rational self-interest leads to collective ruin.</p>

                <h3 style="color: #e94560; margin-top: 25px;">Solutions</h3>
                <ul style="font-size: 0.95em;">
                    <li><strong>Privatization</strong> - Divide the commons</li>
                    <li><strong>Regulation</strong> - Government quotas</li>
                    <li><strong>Community norms</strong> - Ostrom's work</li>
                    <li><strong>Taxation</strong> - Pigouvian taxes</li>
                </ul>
            </div>
        </div>

        <div class="panel explanation">
            <h2>The Paradox Explained</h2>

            <div class="quote">
                "Therein is the tragedy. Each man is locked into a system that compels him to increase his herd without limit‚Äîin a world that is limited. Ruin is the destination toward which all men rush, each pursuing his own best interest."
                <br><br>‚Äî Garrett Hardin, <em>Science</em>, 1968
            </div>

            <h3>The Setup</h3>
            <p>Imagine a pasture open to all. Each herdsman will try to keep as many cattle as possible on the commons. As a rational being, each herdsman seeks to maximize his gain:</p>

            <div class="math-box">
                <strong>The Herdsman's Calculation:</strong><br><br>
                Utility of adding one animal:<br>
                ‚Ä¢ Direct benefit: <span class="highlight">+1</span> (goes entirely to the herdsman)<br>
                ‚Ä¢ Overgrazing cost: <span style="color: #e74c3c;">-1</span> (shared among ALL herdsmen)<br><br>

                If there are N herdsmen, each bears only <span class="highlight">1/N</span> of the damage.<br>
                As N grows, adding cattle becomes increasingly "rational."
            </div>

            <h3>Why It's a Paradox</h3>
            <p>The paradox is that <span class="highlight">each individual's rational decision leads to collective irrationality</span>. Every farmer knows overgrazing is bad. Every farmer can calculate the sustainable limit. Yet the incentive structure compels them toward destruction.</p>

            <h3>Real-World Examples</h3>
            <ul>
                <li><strong>Overfishing</strong> ‚Äî Each boat catches more fish, until there are no fish left</li>
                <li><strong>Climate change</strong> ‚Äî Each country emits CO‚ÇÇ, shared atmosphere bears the cost</li>
                <li><strong>Traffic congestion</strong> ‚Äî Each driver takes the fastest route, making it slow for everyone</li>
                <li><strong>Antibiotic resistance</strong> ‚Äî Each doctor prescribes antibiotics, creating superbugs</li>
                <li><strong>Groundwater depletion</strong> ‚Äî Each farmer pumps more, depleting the aquifer</li>
                <li><strong>Ad blocking</strong> ‚Äî Each user blocks ads, threatening free content</li>
            </ul>

            <h3>Elinor Ostrom's Alternative</h3>
            <p>Economist Elinor Ostrom won the 2009 Nobel Prize for showing that communities CAN manage commons without privatization or government control. Her 8 design principles include:</p>
            <ul>
                <li>Clearly defined boundaries</li>
                <li>Rules matched to local conditions</li>
                <li>Collective choice arrangements</li>
                <li>Monitoring by community members</li>
                <li>Graduated sanctions for violators</li>
                <li>Conflict resolution mechanisms</li>
            </ul>

            <h3>The Mathematics</h3>
            <div class="math-box">
                Let G = total grass, C = total cattle, r = regrowth rate<br><br>

                <strong>Sustainable equilibrium:</strong> C ‚â§ G √ó r<br>
                (Cattle consume no more than regrows)<br><br>

                <strong>Tragedy condition:</strong> Each farmer's marginal benefit > marginal cost<br>
                When: 1 > (overgrazing cost) / N<br>
                This is ALWAYS true when N ‚â• 2!<br><br>

                <strong>Nash Equilibrium:</strong> All defect (overgraze)<br>
                <strong>Pareto Optimum:</strong> All cooperate (sustainable)<br>
                <span style="color: #e74c3c;">These are NOT the same!</span>
            </div>

            <h3>Connection to Game Theory</h3>
            <p>The Tragedy of the Commons is a multi-player version of the <span class="highlight">Prisoner's Dilemma</span>. In both:</p>
            <ul>
                <li>Individual rationality conflicts with collective welfare</li>
                <li>Defection dominates cooperation</li>
                <li>The Nash equilibrium is Pareto-inferior</li>
                <li>Repeated play can enable cooperation (but not always)</li>
            </ul>

            <p style="margin-top: 20px;">The tragedy reminds us that markets don't always produce optimal outcomes. When property rights are unclear and externalities exist, the invisible hand can lead us off a cliff.</p>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            maxGrass: 1000,
            sustainableCapacity: 12,  // Max cattle for sustainability
            cattleConsumption: 10,    // Grass per cow per season
            regrowthRate: 0.10,       // 10% regrowth per season
            maxYears: 50
        };

        // State
        let state = {
            grass: CONFIG.maxGrass,
            year: 1,
            farmers: [
                { name: 'Alice', cattle: 2, profit: 0, alive: true, color: '#e74c3c' },
                { name: 'Bob', cattle: 2, profit: 0, alive: true, color: '#3498db' },
                { name: 'Carol', cattle: 2, profit: 0, alive: true, color: '#2ecc71' },
                { name: 'Dave', cattle: 2, profit: 0, alive: true, color: '#f1c40f' }
            ],
            history: { grass: [1000], cattle: [8] },
            strategy: 'greedy',
            running: false,
            gameOver: false
        };

        // DOM elements
        const commonsCanvas = document.getElementById('commonsCanvas');
        const commonsCtx = commonsCanvas.getContext('2d');
        const chartCanvas = document.getElementById('chartCanvas');
        const chartCtx = chartCanvas.getContext('2d');
        const resourceFill = document.getElementById('resourceFill');
        const farmersGrid = document.getElementById('farmersGrid');
        const yearDisplay = document.getElementById('yearDisplay');
        const totalCattleDisplay = document.getElementById('totalCattle');
        const sustainabilityDisplay = document.getElementById('sustainability');
        const outcomeMessage = document.getElementById('outcomeMessage');
        const greedSlider = document.getElementById('greedSlider');
        const greedValue = document.getElementById('greedValue');
        const regrowthSlider = document.getElementById('regrowthSlider');
        const regrowthValue = document.getElementById('regrowthValue');

        // Initialize
        renderFarmers();
        drawCommons();
        drawChart();
        setupEventListeners();

        function setupEventListeners() {
            document.getElementById('stepBtn').addEventListener('click', simulateStep);
            document.getElementById('runBtn').addEventListener('click', toggleRun);
            document.getElementById('resetBtn').addEventListener('click', reset);

            document.querySelectorAll('.strategy-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.strategy-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.strategy = btn.dataset.strategy;
                });
            });

            greedSlider.addEventListener('input', () => {
                greedValue.textContent = greedSlider.value + '%';
            });

            regrowthSlider.addEventListener('input', () => {
                regrowthValue.textContent = regrowthSlider.value + '%';
                CONFIG.regrowthRate = parseInt(regrowthSlider.value) / 100;
            });
        }

        function simulateStep() {
            if (state.gameOver) return;

            // Each farmer decides to add cattle based on strategy
            state.farmers.forEach(farmer => {
                if (!farmer.alive) return;

                let addCattle = 0;
                const greed = parseInt(greedSlider.value) / 100;

                switch (state.strategy) {
                    case 'greedy':
                        // Always add 1 cattle if possible
                        addCattle = 1;
                        break;
                    case 'sustainable':
                        // Only add if below sustainable limit
                        const totalCattle = state.farmers.reduce((sum, f) => sum + (f.alive ? f.cattle : 0), 0);
                        if (totalCattle < CONFIG.sustainableCapacity) {
                            addCattle = Math.random() < 0.5 ? 1 : 0;
                        }
                        break;
                    case 'mixed':
                        // Probabilistic based on greed slider
                        addCattle = Math.random() < greed ? 1 : 0;
                        break;
                    case 'tragedy':
                        // Classic tragedy: always maximize
                        addCattle = Math.floor(Math.random() * 3); // 0-2 new cattle
                        break;
                }

                farmer.cattle += addCattle;
            });

            // Calculate consumption
            const totalCattle = state.farmers.reduce((sum, f) => sum + (f.alive ? f.cattle : 0), 0);
            const consumption = totalCattle * CONFIG.cattleConsumption;

            // Deduct grass
            state.grass = Math.max(0, state.grass - consumption);

            // Grass regrows (but only up to max)
            const regrowth = state.grass * CONFIG.regrowthRate;
            state.grass = Math.min(CONFIG.maxGrass, state.grass + regrowth);

            // Calculate profits (proportional to grass availability)
            const grassRatio = state.grass / CONFIG.maxGrass;
            state.farmers.forEach(farmer => {
                if (farmer.alive) {
                    // Profit per cow depends on grass availability
                    const profitPerCow = grassRatio * 10;
                    farmer.profit += farmer.cattle * profitPerCow;

                    // Starvation: lose cattle if grass too low
                    if (grassRatio < 0.1) {
                        const lost = Math.ceil(farmer.cattle * 0.5);
                        farmer.cattle = Math.max(0, farmer.cattle - lost);
                    }

                    // Bankruptcy
                    if (farmer.cattle === 0) {
                        farmer.alive = false;
                    }
                }
            });

            // Record history
            state.history.grass.push(state.grass);
            state.history.cattle.push(totalCattle);

            state.year++;

            // Check for game over
            const aliveFarmers = state.farmers.filter(f => f.alive).length;
            if (state.grass < 10 || aliveFarmers === 0 || state.year > CONFIG.maxYears) {
                state.gameOver = true;
                showOutcome();
            }

            // Update display
            renderFarmers();
            drawCommons();
            drawChart();
            updateStats();
        }

        function showOutcome() {
            outcomeMessage.style.display = 'block';
            const grassPct = (state.grass / CONFIG.maxGrass * 100).toFixed(0);
            const aliveFarmers = state.farmers.filter(f => f.alive).length;

            if (state.grass < 50 || aliveFarmers < 2) {
                outcomeMessage.className = 'outcome-message tragedy';
                outcomeMessage.innerHTML = `<strong>TRAGEDY!</strong><br>
                    The commons has been destroyed. Only ${aliveFarmers} farmer(s) survived.<br>
                    Grass remaining: ${grassPct}%`;
            } else {
                outcomeMessage.className = 'outcome-message sustainable';
                outcomeMessage.innerHTML = `<strong>SUSTAINABLE!</strong><br>
                    The community maintained the commons for ${state.year} years.<br>
                    Grass remaining: ${grassPct}%`;
            }
        }

        function toggleRun() {
            state.running = !state.running;
            document.getElementById('runBtn').textContent = state.running ? 'Pause' : 'Run Simulation';

            if (state.running) {
                runSimulation();
            }
        }

        function runSimulation() {
            if (!state.running || state.gameOver) {
                state.running = false;
                document.getElementById('runBtn').textContent = 'Run Simulation';
                return;
            }

            simulateStep();
            setTimeout(runSimulation, 200);
        }

        function reset() {
            state = {
                grass: CONFIG.maxGrass,
                year: 1,
                farmers: [
                    { name: 'Alice', cattle: 2, profit: 0, alive: true, color: '#e74c3c' },
                    { name: 'Bob', cattle: 2, profit: 0, alive: true, color: '#3498db' },
                    { name: 'Carol', cattle: 2, profit: 0, alive: true, color: '#2ecc71' },
                    { name: 'Dave', cattle: 2, profit: 0, alive: true, color: '#f1c40f' }
                ],
                history: { grass: [1000], cattle: [8] },
                strategy: state.strategy,
                running: false,
                gameOver: false
            };

            outcomeMessage.style.display = 'none';
            renderFarmers();
            drawCommons();
            drawChart();
            updateStats();
        }

        function renderFarmers() {
            farmersGrid.innerHTML = state.farmers.map(farmer => `
                <div class="farmer-card ${farmer.alive ? '' : 'bankrupt'}">
                    <div class="farmer-icon" style="color: ${farmer.color};">üë®‚Äçüåæ</div>
                    <div class="farmer-name" style="color: ${farmer.color};">${farmer.name}</div>
                    <div class="farmer-cattle">üêÑ ${farmer.cattle} cattle</div>
                    <div class="farmer-profit">üí∞ $${farmer.profit.toFixed(0)}</div>
                    ${!farmer.alive ? '<div style="color: #e74c3c; font-size: 0.8em;">BANKRUPT</div>' : ''}
                </div>
            `).join('');
        }

        function drawCommons() {
            const w = commonsCanvas.width;
            const h = commonsCanvas.height;
            commonsCtx.clearRect(0, 0, w, h);

            // Background gradient based on grass level
            const grassRatio = state.grass / CONFIG.maxGrass;
            const greenIntensity = Math.floor(100 + 155 * grassRatio);
            const brownIntensity = Math.floor(100 * (1 - grassRatio));

            const gradient = commonsCtx.createLinearGradient(0, 0, 0, h);
            gradient.addColorStop(0, '#87CEEB');
            gradient.addColorStop(0.3, `rgb(${brownIntensity + 50}, ${greenIntensity}, ${50 + brownIntensity})`);
            gradient.addColorStop(1, `rgb(${brownIntensity + 30}, ${Math.floor(greenIntensity * 0.6)}, ${30})`);
            commonsCtx.fillStyle = gradient;
            commonsCtx.fillRect(0, 0, w, h);

            // Draw grass blades (fewer as grass depletes)
            const grassBlades = Math.floor(200 * grassRatio);
            commonsCtx.strokeStyle = '#228B22';
            commonsCtx.lineWidth = 2;
            for (let i = 0; i < grassBlades; i++) {
                const x = Math.random() * w;
                const y = h * 0.3 + Math.random() * h * 0.7;
                const bladeHeight = 10 + Math.random() * 20;
                commonsCtx.beginPath();
                commonsCtx.moveTo(x, y);
                commonsCtx.quadraticCurveTo(x + 5, y - bladeHeight/2, x + 3, y - bladeHeight);
                commonsCtx.stroke();
            }

            // Draw cattle for each farmer
            state.farmers.forEach((farmer, idx) => {
                if (!farmer.alive) return;

                const baseX = 50 + (idx % 2) * (w/2);
                const baseY = 100 + Math.floor(idx / 2) * 120;

                for (let c = 0; c < Math.min(farmer.cattle, 10); c++) {
                    const cx = baseX + (c % 5) * 60;
                    const cy = baseY + Math.floor(c / 5) * 40;
                    drawCow(cx, cy, farmer.color);
                }

                // Show +N if more than 10
                if (farmer.cattle > 10) {
                    commonsCtx.fillStyle = farmer.color;
                    commonsCtx.font = 'bold 16px Georgia';
                    commonsCtx.fillText(`+${farmer.cattle - 10}`, baseX + 280, baseY + 20);
                }
            });

            // Update resource bar
            const pct = (grassRatio * 100).toFixed(0);
            resourceFill.style.width = pct + '%';
            resourceFill.textContent = pct + '%';

            // Color coding
            if (grassRatio > 0.6) {
                resourceFill.style.background = 'linear-gradient(90deg, #27ae60, #2ecc71)';
            } else if (grassRatio > 0.3) {
                resourceFill.style.background = 'linear-gradient(90deg, #f39c12, #f1c40f)';
            } else {
                resourceFill.style.background = 'linear-gradient(90deg, #c0392b, #e74c3c)';
            }
        }

        function drawCow(x, y, color) {
            commonsCtx.save();
            commonsCtx.translate(x, y);

            // Body
            commonsCtx.fillStyle = color;
            commonsCtx.beginPath();
            commonsCtx.ellipse(0, 0, 20, 12, 0, 0, Math.PI * 2);
            commonsCtx.fill();

            // Head
            commonsCtx.beginPath();
            commonsCtx.arc(22, -5, 10, 0, Math.PI * 2);
            commonsCtx.fill();

            // Spots
            commonsCtx.fillStyle = 'rgba(255,255,255,0.5)';
            commonsCtx.beginPath();
            commonsCtx.arc(-5, 0, 5, 0, Math.PI * 2);
            commonsCtx.fill();

            // Legs
            commonsCtx.fillStyle = color;
            commonsCtx.fillRect(-12, 8, 4, 10);
            commonsCtx.fillRect(8, 8, 4, 10);

            commonsCtx.restore();
        }

        function drawChart() {
            const w = chartCanvas.width;
            const h = chartCanvas.height;
            chartCtx.clearRect(0, 0, w, h);

            // Background
            chartCtx.fillStyle = 'rgba(0,0,0,0.2)';
            chartCtx.fillRect(0, 0, w, h);

            const data = state.history.grass;
            const cattleData = state.history.cattle;
            if (data.length < 2) return;

            const padding = 40;
            const graphW = w - padding * 2;
            const graphH = h - padding * 2;

            // Axes
            chartCtx.strokeStyle = '#555';
            chartCtx.lineWidth = 1;
            chartCtx.beginPath();
            chartCtx.moveTo(padding, padding);
            chartCtx.lineTo(padding, h - padding);
            chartCtx.lineTo(w - padding, h - padding);
            chartCtx.stroke();

            // Labels
            chartCtx.fillStyle = '#888';
            chartCtx.font = '12px Georgia';
            chartCtx.fillText('Grass', 10, padding + 10);
            chartCtx.fillText('Year', w/2, h - 5);

            // Draw grass line
            chartCtx.strokeStyle = '#2ecc71';
            chartCtx.lineWidth = 2;
            chartCtx.beginPath();
            data.forEach((val, i) => {
                const x = padding + (i / Math.max(data.length - 1, 1)) * graphW;
                const y = h - padding - (val / CONFIG.maxGrass) * graphH;
                if (i === 0) chartCtx.moveTo(x, y);
                else chartCtx.lineTo(x, y);
            });
            chartCtx.stroke();

            // Draw cattle line (scaled)
            const maxCattle = Math.max(...cattleData, 20);
            chartCtx.strokeStyle = '#f1c40f';
            chartCtx.setLineDash([5, 5]);
            chartCtx.beginPath();
            cattleData.forEach((val, i) => {
                const x = padding + (i / Math.max(cattleData.length - 1, 1)) * graphW;
                const y = h - padding - (val / maxCattle) * graphH;
                if (i === 0) chartCtx.moveTo(x, y);
                else chartCtx.lineTo(x, y);
            });
            chartCtx.stroke();
            chartCtx.setLineDash([]);

            // Legend
            chartCtx.fillStyle = '#2ecc71';
            chartCtx.fillRect(w - 120, 15, 15, 10);
            chartCtx.fillStyle = '#888';
            chartCtx.fillText('Grass', w - 100, 23);

            chartCtx.fillStyle = '#f1c40f';
            chartCtx.fillRect(w - 120, 30, 15, 10);
            chartCtx.fillStyle = '#888';
            chartCtx.fillText('Cattle', w - 100, 38);

            // Sustainable line
            chartCtx.strokeStyle = 'rgba(46, 204, 113, 0.3)';
            chartCtx.setLineDash([10, 5]);
            chartCtx.beginPath();
            const sustainY = h - padding - 0.5 * graphH;
            chartCtx.moveTo(padding, sustainY);
            chartCtx.lineTo(w - padding, sustainY);
            chartCtx.stroke();
            chartCtx.setLineDash([]);
        }

        function updateStats() {
            yearDisplay.textContent = `Year ${state.year}`;
            const totalCattle = state.farmers.reduce((sum, f) => sum + (f.alive ? f.cattle : 0), 0);
            totalCattleDisplay.textContent = totalCattle;

            const grassRatio = state.grass / CONFIG.maxGrass;
            if (grassRatio > 0.6) {
                sustainabilityDisplay.textContent = 'Sustainable';
                sustainabilityDisplay.style.color = '#2ecc71';
            } else if (grassRatio > 0.3) {
                sustainabilityDisplay.textContent = 'At Risk';
                sustainabilityDisplay.style.color = '#f39c12';
            } else {
                sustainabilityDisplay.textContent = 'Critical!';
                sustainabilityDisplay.style.color = '#e74c3c';
            }
        }
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
