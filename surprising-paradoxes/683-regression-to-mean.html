<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>683 - Regression to the Mean | Surprising Paradoxes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #e8e8e8;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #f39c12, #e74c3c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2rem;
            color: #a0a0a0;
            max-width: 800px;
            margin: 0 auto;
        }

        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #f39c12;
            text-decoration: none;
            font-size: 1rem;
            opacity: 0.8;
            transition: opacity 0.3s;
            z-index: 100;
        }

        .back-link:hover {
            opacity: 1;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
        }

        @media (max-width: 1100px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .visualization-area {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 10px;
            color: #e8e8e8;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95rem;
        }

        .tab:hover {
            background: rgba(255,255,255,0.2);
        }

        .tab.active {
            background: linear-gradient(135deg, #f39c12, #e74c3c);
            color: white;
        }

        canvas {
            width: 100%;
            border-radius: 10px;
            background: rgba(0,0,0,0.3);
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #f39c12, #e74c3c);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(243, 156, 18, 0.3);
        }

        .slider-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider-group label {
            font-size: 0.9rem;
            color: #a0a0a0;
        }

        input[type="range"] {
            width: 120px;
            accent-color: #f39c12;
        }

        .info-panel {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 25px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-box {
            background: rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #f39c12;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #a0a0a0;
            margin-top: 5px;
        }

        .explanation {
            background: rgba(243, 156, 18, 0.1);
            border-left: 4px solid #f39c12;
            padding: 15px;
            border-radius: 0 10px 10px 0;
            margin-bottom: 20px;
        }

        .explanation h3 {
            color: #f39c12;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .explanation p {
            font-size: 0.95rem;
            line-height: 1.6;
            color: #c0c0c0;
        }

        .history-section {
            margin-top: 20px;
        }

        .history-section h3 {
            color: #f39c12;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .history-item {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .history-item .name {
            font-weight: 600;
            color: #e8e8e8;
        }

        .history-item .detail {
            font-size: 0.85rem;
            color: #a0a0a0;
            margin-top: 5px;
        }

        .jinx-indicator {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .jinx-indicator.declined {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        .jinx-indicator.improved {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .quote {
            font-style: italic;
            color: #a0a0a0;
            border-left: 3px solid #f39c12;
            padding-left: 15px;
            margin: 20px 0;
        }

        .scatter-legend {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back to Paradoxes</a>

    <div class="container">
        <header>
            <h1>Regression to the Mean</h1>
            <p class="subtitle">Why the "Sports Illustrated Jinx" isn't a jinx, why praise seems to backfire, and why your second test score might disappoint you</p>
        </header>

        <div class="main-content">
            <div class="visualization-area">
                <div class="tabs">
                    <button class="tab active" data-tab="galton">Galton's Heights</button>
                    <button class="tab" data-tab="sports">SI Cover Jinx</button>
                    <button class="tab" data-tab="test">Test Scores</button>
                    <button class="tab" data-tab="pilot">Pilot Training</button>
                </div>

                <canvas id="canvas" width="900" height="550"></canvas>

                <div class="controls">
                    <button id="runBtn">Run Simulation</button>
                    <button id="resetBtn">Reset</button>
                    <div class="slider-group">
                        <label>Speed:</label>
                        <input type="range" id="speedSlider" min="1" max="10" value="5">
                    </div>
                    <div class="slider-group">
                        <label>Sample Size:</label>
                        <input type="range" id="sampleSlider" min="50" max="500" value="200">
                        <span id="sampleValue">200</span>
                    </div>
                </div>

                <div class="scatter-legend" id="legend">
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #3498db;"></div>
                        <span>Data Points</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #e74c3c;"></div>
                        <span>Regression Line</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #2ecc71;"></div>
                        <span>y = x (No Regression)</span>
                    </div>
                </div>
            </div>

            <div class="info-panel">
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="correlation">0.00</div>
                        <div class="stat-label">Correlation (r)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="regression">0.00</div>
                        <div class="stat-label">Regression Slope</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="extremeCount">0</div>
                        <div class="stat-label">Extreme Cases</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="regressed">0%</div>
                        <div class="stat-label">Regressed to Mean</div>
                    </div>
                </div>

                <div class="explanation" id="explanationBox">
                    <h3>Francis Galton's Discovery (1886)</h3>
                    <p>Studying hereditary height, Galton found that tall parents tend to have children who are still tall—but not AS tall. Short parents have children taller than themselves. Everyone "regresses" toward the average.</p>
                </div>

                <div class="quote">
                    "Extreme performance tends to be followed by more average performance—not because of any causal effect, but because extreme scores contain more luck."
                </div>

                <div class="history-section" id="historySection">
                    <h3>Recent Observations</h3>
                    <div id="historyList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let currentTab = 'galton';
        let data = [];
        let animationId = null;
        let isRunning = false;
        let history = [];

        const tabs = document.querySelectorAll('.tab');
        const runBtn = document.getElementById('runBtn');
        const resetBtn = document.getElementById('resetBtn');
        const speedSlider = document.getElementById('speedSlider');
        const sampleSlider = document.getElementById('sampleSlider');
        const sampleValue = document.getElementById('sampleValue');

        const explanations = {
            galton: {
                title: "Francis Galton's Discovery (1886)",
                text: "Studying hereditary height, Galton found that tall parents tend to have children who are still tall—but not AS tall. Short parents have children taller than themselves. Everyone \"regresses\" toward the average."
            },
            sports: {
                title: "The Sports Illustrated Cover Jinx",
                text: "Athletes featured on the SI cover often perform worse afterward. Not magic—they made the cover because of exceptional (lucky) performance. Regression is inevitable. About 37% show notable decline."
            },
            test: {
                title: "The Sophomore Slump",
                text: "Students who score extremely well on a test often score lower on retakes. Students who score poorly often improve. It's not about studying—it's about luck evening out."
            },
            pilot: {
                title: "Kahneman's Pilot Training Insight",
                text: "Israeli flight instructors noticed praise after good landings led to worse performance, while criticism after bad landings led to improvement. But it was just regression! This fooled experts into preferring criticism."
            }
        };

        // Tab switching
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentTab = tab.dataset.tab;
                updateExplanation();
                reset();
            });
        });

        sampleSlider.addEventListener('input', () => {
            sampleValue.textContent = sampleSlider.value;
        });

        runBtn.addEventListener('click', () => {
            if (isRunning) {
                pause();
            } else {
                run();
            }
        });

        resetBtn.addEventListener('click', reset);

        function updateExplanation() {
            const exp = explanations[currentTab];
            document.getElementById('explanationBox').innerHTML = `
                <h3>${exp.title}</h3>
                <p>${exp.text}</p>
            `;
        }

        function generateData() {
            const n = parseInt(sampleSlider.value);
            data = [];

            // True ability + luck model
            // Observed score = true ability + random error
            for (let i = 0; i < n; i++) {
                const trueAbility = gaussianRandom(0, 1);
                const luck1 = gaussianRandom(0, 0.7);
                const luck2 = gaussianRandom(0, 0.7);

                let x, y, label;

                switch(currentTab) {
                    case 'galton':
                        // Parent height vs child height
                        // Child inherits ~50% of parent's deviation from mean
                        const parentHeight = 67 + trueAbility * 4; // mean 67", SD 4"
                        const childDeviation = trueAbility * 0.6 + gaussianRandom(0, 0.5);
                        const childHeight = 67 + childDeviation * 4;
                        x = parentHeight;
                        y = childHeight;
                        label = `Parent: ${parentHeight.toFixed(1)}", Child: ${childHeight.toFixed(1)}"`;
                        break;

                    case 'sports':
                        // Performance before cover vs after
                        const beforeCover = trueAbility + luck1;
                        const afterCover = trueAbility + luck2;
                        // Only show athletes who made the cover (high performance)
                        if (beforeCover > 1.0) {
                            x = 50 + beforeCover * 15; // batting average-ish scale
                            y = 50 + afterCover * 15;
                            label = `.${Math.round(x * 10)} before → .${Math.round(y * 10)} after`;
                        } else {
                            i--; // retry
                            continue;
                        }
                        break;

                    case 'test':
                        // Test 1 vs Test 2 scores
                        const test1 = 70 + trueAbility * 15 + luck1 * 10;
                        const test2 = 70 + trueAbility * 15 + luck2 * 10;
                        x = Math.max(0, Math.min(100, test1));
                        y = Math.max(0, Math.min(100, test2));
                        label = `Test 1: ${Math.round(x)}, Test 2: ${Math.round(y)}`;
                        break;

                    case 'pilot':
                        // Landing quality: observed vs next attempt
                        const landing1 = trueAbility + luck1;
                        const landing2 = trueAbility + luck2;
                        x = 50 + landing1 * 20;
                        y = 50 + landing2 * 20;
                        label = `Landing 1: ${Math.round(x)}, Landing 2: ${Math.round(y)}`;
                        break;
                }

                data.push({ x, y, label, shown: false });
            }
        }

        function gaussianRandom(mean = 0, std = 1) {
            const u1 = Math.random();
            const u2 = Math.random();
            const z = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
            return mean + z * std;
        }

        function getAxisLabels() {
            switch(currentTab) {
                case 'galton':
                    return { x: "Parent Height (inches)", y: "Child Height (inches)" };
                case 'sports':
                    return { x: "Performance Before Cover", y: "Performance After Cover" };
                case 'test':
                    return { x: "Test 1 Score", y: "Test 2 Score" };
                case 'pilot':
                    return { x: "Landing 1 Quality", y: "Landing 2 Quality" };
            }
        }

        function getDataRange() {
            switch(currentTab) {
                case 'galton':
                    return { minX: 55, maxX: 80, minY: 55, maxY: 80 };
                case 'sports':
                    return { minX: 60, maxX: 100, minY: 40, maxY: 100 };
                case 'test':
                    return { minX: 20, maxX: 100, minY: 20, maxY: 100 };
                case 'pilot':
                    return { minX: 0, maxX: 100, minY: 0, maxY: 100 };
            }
        }

        function draw() {
            ctx.fillStyle = 'rgba(20, 30, 48, 1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const padding = 60;
            const plotWidth = canvas.width - padding * 2;
            const plotHeight = canvas.height - padding * 2;

            const range = getDataRange();
            const labels = getAxisLabels();

            // Grid
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const x = padding + (plotWidth * i / 5);
                const y = padding + (plotHeight * i / 5);
                ctx.beginPath();
                ctx.moveTo(x, padding);
                ctx.lineTo(x, canvas.height - padding);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();
            }

            // Axes
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.stroke();

            // Axis labels
            ctx.fillStyle = '#a0a0a0';
            ctx.font = '14px Segoe UI';
            ctx.textAlign = 'center';
            ctx.fillText(labels.x, canvas.width / 2, canvas.height - 15);

            ctx.save();
            ctx.translate(20, canvas.height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText(labels.y, 0, 0);
            ctx.restore();

            // Axis values
            ctx.font = '12px Segoe UI';
            for (let i = 0; i <= 5; i++) {
                const xVal = range.minX + (range.maxX - range.minX) * i / 5;
                const yVal = range.minY + (range.maxY - range.minY) * i / 5;
                const x = padding + (plotWidth * i / 5);
                const y = canvas.height - padding - (plotHeight * i / 5);

                ctx.fillText(xVal.toFixed(0), x, canvas.height - padding + 20);
                ctx.textAlign = 'right';
                ctx.fillText(yVal.toFixed(0), padding - 10, y + 4);
                ctx.textAlign = 'center';
            }

            // y = x line (no regression)
            ctx.strokeStyle = '#2ecc71';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            const x1 = padding;
            const x2 = canvas.width - padding;
            const y1 = canvas.height - padding - ((range.minX - range.minY) / (range.maxY - range.minY)) * plotHeight;
            const y2 = canvas.height - padding - ((range.maxX - range.minY) / (range.maxY - range.minY)) * plotHeight;
            ctx.moveTo(x1, Math.max(padding, Math.min(canvas.height - padding, y1)));
            ctx.lineTo(x2, Math.max(padding, Math.min(canvas.height - padding, y2)));
            ctx.stroke();
            ctx.setLineDash([]);

            // Data points
            const shownData = data.filter(d => d.shown);

            shownData.forEach(point => {
                const px = padding + ((point.x - range.minX) / (range.maxX - range.minX)) * plotWidth;
                const py = canvas.height - padding - ((point.y - range.minY) / (range.maxY - range.minY)) * plotHeight;

                ctx.beginPath();
                ctx.arc(px, py, 5, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(52, 152, 219, 0.7)';
                ctx.fill();
                ctx.strokeStyle = 'rgba(52, 152, 219, 1)';
                ctx.lineWidth = 1;
                ctx.stroke();
            });

            // Regression line (if enough data)
            if (shownData.length > 10) {
                const stats = calculateRegression(shownData);

                ctx.strokeStyle = '#e74c3c';
                ctx.lineWidth = 3;
                ctx.beginPath();

                const regY1 = stats.intercept + stats.slope * range.minX;
                const regY2 = stats.intercept + stats.slope * range.maxX;

                const rx1 = padding;
                const rx2 = canvas.width - padding;
                const ry1 = canvas.height - padding - ((regY1 - range.minY) / (range.maxY - range.minY)) * plotHeight;
                const ry2 = canvas.height - padding - ((regY2 - range.minY) / (range.maxY - range.minY)) * plotHeight;

                ctx.moveTo(rx1, Math.max(padding, Math.min(canvas.height - padding, ry1)));
                ctx.lineTo(rx2, Math.max(padding, Math.min(canvas.height - padding, ry2)));
                ctx.stroke();

                // Update stats display
                document.getElementById('correlation').textContent = stats.correlation.toFixed(2);
                document.getElementById('regression').textContent = stats.slope.toFixed(2);

                // Count extreme cases and regression
                let extremeCount = 0;
                let regressedCount = 0;

                shownData.forEach(d => {
                    const meanX = stats.meanX;
                    const meanY = stats.meanY;

                    // Extreme if > 1.5 SD from mean on x
                    if (Math.abs(d.x - meanX) > 1.5 * stats.sdX) {
                        extremeCount++;
                        // Regressed if y is closer to mean than x was
                        if (Math.abs(d.y - meanY) < Math.abs(d.x - meanX)) {
                            regressedCount++;
                        }
                    }
                });

                document.getElementById('extremeCount').textContent = extremeCount;
                document.getElementById('regressed').textContent = extremeCount > 0
                    ? Math.round(regressedCount / extremeCount * 100) + '%'
                    : '0%';
            }
        }

        function calculateRegression(points) {
            const n = points.length;
            let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0, sumY2 = 0;

            points.forEach(p => {
                sumX += p.x;
                sumY += p.y;
                sumXY += p.x * p.y;
                sumX2 += p.x * p.x;
                sumY2 += p.y * p.y;
            });

            const meanX = sumX / n;
            const meanY = sumY / n;

            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = meanY - slope * meanX;

            // Correlation
            const num = n * sumXY - sumX * sumY;
            const den = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
            const correlation = num / den;

            // Standard deviations
            let varX = 0, varY = 0;
            points.forEach(p => {
                varX += (p.x - meanX) ** 2;
                varY += (p.y - meanY) ** 2;
            });
            const sdX = Math.sqrt(varX / n);
            const sdY = Math.sqrt(varY / n);

            return { slope, intercept, correlation, meanX, meanY, sdX, sdY };
        }

        let pointIndex = 0;

        function run() {
            if (data.length === 0) {
                generateData();
                pointIndex = 0;
            }

            isRunning = true;
            runBtn.textContent = 'Pause';
            animate();
        }

        function animate() {
            if (!isRunning) return;

            const speed = parseInt(speedSlider.value);
            const pointsPerFrame = Math.ceil(speed / 2);

            for (let i = 0; i < pointsPerFrame && pointIndex < data.length; i++) {
                data[pointIndex].shown = true;

                // Add to history for sports tab
                if (currentTab === 'sports' && history.length < 5) {
                    const d = data[pointIndex];
                    const declined = d.y < d.x;
                    history.unshift({
                        name: `Athlete ${pointIndex + 1}`,
                        before: d.x.toFixed(1),
                        after: d.y.toFixed(1),
                        declined
                    });
                    if (history.length > 5) history.pop();
                    updateHistory();
                }

                pointIndex++;
            }

            draw();

            if (pointIndex < data.length) {
                animationId = requestAnimationFrame(animate);
            } else {
                isRunning = false;
                runBtn.textContent = 'Run Simulation';
            }
        }

        function pause() {
            isRunning = false;
            runBtn.textContent = 'Resume';
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        }

        function reset() {
            pause();
            data = [];
            pointIndex = 0;
            history = [];
            document.getElementById('correlation').textContent = '0.00';
            document.getElementById('regression').textContent = '0.00';
            document.getElementById('extremeCount').textContent = '0';
            document.getElementById('regressed').textContent = '0%';
            runBtn.textContent = 'Run Simulation';
            updateHistory();
            draw();
        }

        function updateHistory() {
            const container = document.getElementById('historyList');
            if (currentTab !== 'sports') {
                container.innerHTML = '<div class="history-item"><span class="detail">Run simulation to see examples</span></div>';
                return;
            }

            if (history.length === 0) {
                container.innerHTML = '<div class="history-item"><span class="detail">Run simulation to track cover athletes</span></div>';
                return;
            }

            container.innerHTML = history.map(h => `
                <div class="history-item">
                    <span class="name">${h.name}</span>
                    <span class="jinx-indicator ${h.declined ? 'declined' : 'improved'}">
                        ${h.declined ? '↓ Declined' : '↑ Improved'}
                    </span>
                    <div class="detail">${h.before} → ${h.after}</div>
                </div>
            `).join('');
        }

        // Initialize
        updateExplanation();
        updateHistory();
        draw();
    </script>
</body>
</html>
