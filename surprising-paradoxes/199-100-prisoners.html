<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The 100 Prisoners Problem - From 0% to 31% Success</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #1a1a1a 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.2em;
            background: linear-gradient(135deg, #ffd700, #ff6b35, #f7931e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.3em;
            color: #aaa;
            font-style: italic;
        }

        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #ffd700;
            text-decoration: none;
            font-size: 1.1em;
            z-index: 100;
            transition: color 0.3s;
        }

        .back-link:hover {
            color: #ff6b35;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        @media (max-width: 1000px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: rgba(30, 30, 50, 0.9);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .panel h2 {
            color: #ffd700;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        .panel h3 {
            color: #ff6b35;
            margin: 15px 0 10px 0;
            font-size: 1.1em;
        }

        .drawer-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 4px;
            margin: 20px 0;
        }

        .drawer {
            aspect-ratio: 1;
            background: linear-gradient(145deg, #3a3a4a, #2a2a3a);
            border: 2px solid #444;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            color: #888;
        }

        .drawer:hover {
            border-color: #ffd700;
            transform: scale(1.1);
            z-index: 5;
        }

        .drawer.open {
            background: linear-gradient(145deg, #4a5a3a, #3a4a2a);
            border-color: #7cb342;
        }

        .drawer.found {
            background: linear-gradient(145deg, #ffd700, #f7931e);
            border-color: #fff;
            color: #000;
            animation: pulse 0.5s ease-out;
        }

        .drawer.failed {
            background: linear-gradient(145deg, #c62828, #8b0000);
            border-color: #ff5252;
        }

        .drawer.in-cycle {
            border-color: #00bcd4;
            box-shadow: 0 0 10px rgba(0, 188, 212, 0.5);
        }

        .drawer .slip {
            position: absolute;
            font-size: 0.6em;
            color: #aaa;
            bottom: 2px;
        }

        .drawer.open .slip {
            color: #7cb342;
            font-weight: bold;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        button {
            padding: 12px 25px;
            font-size: 1em;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ffd700, #f7931e);
            color: #000;
        }

        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ff6b35, #c62828);
            color: white;
        }

        .btn-secondary:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(255, 107, 53, 0.4);
        }

        .btn-cycle {
            background: linear-gradient(135deg, #00bcd4, #0097a7);
            color: white;
        }

        .btn-cycle:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0, 188, 212, 0.4);
        }

        .strategy-toggle {
            display: flex;
            gap: 5px;
            background: rgba(0,0,0,0.3);
            border-radius: 25px;
            padding: 5px;
            margin: 15px auto;
            width: fit-content;
        }

        .strategy-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            background: transparent;
            color: #888;
        }

        .strategy-btn.active {
            background: linear-gradient(135deg, #ffd700, #f7931e);
            color: #000;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 15px 0;
        }

        .stat-box {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-box .value {
            font-size: 1.8em;
            font-weight: bold;
            color: #ffd700;
        }

        .stat-box .label {
            font-size: 0.8em;
            color: #888;
            margin-top: 5px;
        }

        .comparison {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
        }

        .comparison-item {
            text-align: center;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            min-width: 150px;
        }

        .comparison-item.random {
            border: 2px solid #c62828;
        }

        .comparison-item.cycle {
            border: 2px solid #7cb342;
        }

        .comparison-item .rate {
            font-size: 2.5em;
            font-weight: bold;
        }

        .comparison-item.random .rate {
            color: #c62828;
        }

        .comparison-item.cycle .rate {
            color: #7cb342;
        }

        .comparison-item .strategy-name {
            color: #888;
            margin-top: 5px;
        }

        .explanation {
            line-height: 1.8;
            color: #ccc;
        }

        .explanation p {
            margin-bottom: 15px;
        }

        .highlight {
            background: rgba(255, 215, 0, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            color: #ffd700;
        }

        .paradox-box {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 107, 53, 0.1));
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .paradox-box h3 {
            color: #ff6b35;
            margin-bottom: 10px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .prisoner-info {
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .prisoner-info .number {
            font-size: 2em;
            color: #ffd700;
            font-weight: bold;
        }

        .prisoner-info .status {
            margin-top: 5px;
            font-size: 1.1em;
        }

        .prisoner-info .status.success {
            color: #7cb342;
        }

        .prisoner-info .status.fail {
            color: #c62828;
        }

        .progress-bar {
            height: 30px;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #7cb342, #aed581);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #000;
        }

        .cycle-viz {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            min-height: 150px;
            position: relative;
        }

        .cycle-display {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }

        .cycle-node {
            width: 40px;
            height: 40px;
            background: linear-gradient(145deg, #00bcd4, #0097a7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 0.9em;
        }

        .cycle-arrow {
            color: #00bcd4;
            font-size: 1.5em;
        }

        .cycle-node.current {
            background: linear-gradient(145deg, #ffd700, #f7931e);
            color: #000;
            transform: scale(1.2);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .cycle-node.target {
            background: linear-gradient(145deg, #7cb342, #558b2f);
        }

        .monte-carlo {
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }

        .monte-carlo-bar {
            display: flex;
            height: 40px;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .mc-success {
            background: linear-gradient(90deg, #7cb342, #aed581);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #000;
            transition: width 0.5s;
        }

        .mc-fail {
            background: linear-gradient(90deg, #c62828, #e53935);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            transition: width 0.5s;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }

        .slider-container label {
            min-width: 100px;
            color: #aaa;
        }

        .slider-container input[type="range"] {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(90deg, #ffd700, #ff6b35);
            -webkit-appearance: none;
        }

        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
        }

        .slider-container .value {
            min-width: 50px;
            text-align: center;
            font-weight: bold;
            color: #ffd700;
        }

        .math-box {
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Times New Roman', serif;
            font-size: 1.1em;
            text-align: center;
        }

        .math-box .formula {
            color: #ffd700;
            font-style: italic;
        }

        .insight-card {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #ffd700;
        }

        .insight-card h4 {
            color: #ffd700;
            margin-bottom: 8px;
        }

        .insight-card p {
            color: #aaa;
            font-size: 0.95em;
        }

        .cycle-length-viz {
            display: flex;
            height: 200px;
            align-items: flex-end;
            gap: 2px;
            margin: 15px 0;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }

        .cycle-bar {
            flex: 1;
            background: linear-gradient(180deg, #00bcd4, #006064);
            border-radius: 3px 3px 0 0;
            transition: height 0.3s;
            position: relative;
        }

        .cycle-bar.danger {
            background: linear-gradient(180deg, #c62828, #8b0000);
        }

        .threshold-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: #ffd700;
            bottom: 50%;
        }

        .threshold-label {
            position: absolute;
            right: 5px;
            bottom: calc(50% + 5px);
            font-size: 0.8em;
            color: #ffd700;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back to Paradoxes</a>

    <div class="container">
        <header>
            <h1>The 100 Prisoners Problem</h1>
            <p class="subtitle">How a clever strategy turns 0% into 31% success</p>
        </header>

        <div class="main-grid">
            <!-- Main Simulation -->
            <div class="panel">
                <h2>The Challenge</h2>

                <div class="strategy-toggle">
                    <button class="strategy-btn active" data-strategy="cycle">Cycle Strategy</button>
                    <button class="strategy-btn" data-strategy="random">Random Strategy</button>
                </div>

                <div class="prisoner-info">
                    <div>Prisoner</div>
                    <div class="number" id="currentPrisoner">1</div>
                    <div class="status" id="prisonerStatus">Looking for slip #1</div>
                </div>

                <div class="drawer-grid" id="drawerGrid"></div>

                <div class="cycle-viz" id="cycleViz">
                    <div style="text-align: center; color: #888; margin-bottom: 10px;">Current Cycle</div>
                    <div class="cycle-display" id="cycleDisplay"></div>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%;">0/100</div>
                </div>

                <div class="controls">
                    <button class="btn-primary" id="stepBtn">Step</button>
                    <button class="btn-cycle" id="runPrisonerBtn">Run Prisoner</button>
                    <button class="btn-primary" id="runAllBtn">Run All 100</button>
                    <button class="btn-secondary" id="resetBtn">Reset</button>
                </div>

                <div class="stat-grid">
                    <div class="stat-box">
                        <div class="value" id="drawersOpened">0</div>
                        <div class="label">Drawers Opened</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="prisonersSuccess">0</div>
                        <div class="label">Found Their Slip</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="maxCycle">0</div>
                        <div class="label">Longest Cycle</div>
                    </div>
                </div>
            </div>

            <!-- The Paradox -->
            <div class="panel">
                <h2>The Paradox</h2>

                <div class="comparison">
                    <div class="comparison-item random">
                        <div class="rate">≈0%</div>
                        <div class="strategy-name">Random Strategy</div>
                        <div style="font-size: 0.8em; color: #888; margin-top: 5px;">(0.5)^100</div>
                    </div>
                    <div class="comparison-item cycle">
                        <div class="rate">31%</div>
                        <div class="strategy-name">Cycle Strategy</div>
                        <div style="font-size: 0.8em; color: #888; margin-top: 5px;">1 - ln(2)</div>
                    </div>
                </div>

                <div class="paradox-box">
                    <h3>The Setup</h3>
                    <ul style="margin-left: 20px; color: #ccc;">
                        <li>100 prisoners, numbered 1-100</li>
                        <li>100 drawers, each containing a random slip (1-100)</li>
                        <li>Each prisoner may open at most <span class="highlight">50 drawers</span></li>
                        <li>Must find the slip with their own number</li>
                        <li><strong>ALL</strong> must succeed for freedom</li>
                        <li>Can strategize before, but NO communication during</li>
                    </ul>
                </div>

                <h3>Random Strategy</h3>
                <div class="explanation">
                    <p>Each prisoner randomly opens 50 drawers. Probability of success = 50/100 = <span class="highlight">50%</span></p>
                    <p>For ALL 100 to succeed: (1/2)^100 ≈ <span class="highlight">10^-30</span></p>
                    <p>That's a 1 in 1,000,000,000,000,000,000,000,000,000,000 chance!</p>
                </div>

                <h3>Cycle Strategy</h3>
                <div class="explanation">
                    <p>Each prisoner starts at the drawer matching their number, then follows the chain of slips until they find themselves.</p>
                    <p>This works because the permutation forms <span class="highlight">cycles</span>. If all cycles are ≤ 50, everyone succeeds!</p>
                </div>
            </div>

            <!-- Monte Carlo -->
            <div class="panel">
                <h2>Monte Carlo Simulation</h2>

                <div class="slider-container">
                    <label>Trials:</label>
                    <input type="range" id="trialsSlider" min="100" max="10000" step="100" value="1000">
                    <span class="value" id="trialsValue">1000</span>
                </div>

                <div class="controls">
                    <button class="btn-primary" id="runMonteCarloBtn">Run Simulation</button>
                </div>

                <div class="monte-carlo" id="monteCarlo">
                    <div style="text-align: center; margin-bottom: 10px;">
                        <span style="color: #7cb342;">■</span> Success &nbsp;&nbsp;
                        <span style="color: #c62828;">■</span> Failure
                    </div>
                    <div class="monte-carlo-bar">
                        <div class="mc-success" id="mcSuccess" style="width: 31%;">31%</div>
                        <div class="mc-fail" id="mcFail" style="width: 69%;">69%</div>
                    </div>
                    <div style="text-align: center; color: #888;">
                        <span id="mcTrials">0</span> trials completed
                    </div>
                </div>

                <div class="math-box">
                    <div>Theoretical probability:</div>
                    <div class="formula">P(success) = 1 - H_100 + H_50 ≈ 1 - ln(2) ≈ 0.3118</div>
                    <div style="font-size: 0.8em; color: #888; margin-top: 10px;">
                        where H_n is the n-th harmonic number
                    </div>
                </div>
            </div>

            <!-- Cycle Visualization -->
            <div class="panel">
                <h2>Why Cycles Matter</h2>

                <div class="cycle-length-viz" id="cycleLengthViz">
                    <div class="threshold-line"></div>
                    <div class="threshold-label">Max 50</div>
                </div>
                <div style="text-align: center; color: #888; font-size: 0.9em;">
                    Cycle lengths in current permutation (red = too long)
                </div>

                <div class="paradox-box">
                    <h3>The Key Insight</h3>
                    <p>With random strategy, prisoners fail <strong>independently</strong>—bad for everyone.</p>
                    <p>With cycle strategy, they fail <strong>together</strong>—either the longest cycle is ≤50 (all succeed) or >50 (those in it fail).</p>
                    <p>Correlated fate is better than independent fate!</p>
                </div>

                <h3>Cycle Following Demo</h3>
                <p style="color: #888; margin-bottom: 10px;">Watch how prisoner 1 follows the chain:</p>
                <div class="cycle-viz">
                    <div class="cycle-display" id="demoDisplay">
                        <div class="cycle-node current">1</div>
                        <div class="cycle-arrow">→</div>
                        <div class="cycle-node">?</div>
                    </div>
                </div>
            </div>

            <!-- Deep Insights -->
            <div class="panel full-width">
                <h2>Deep Insights</h2>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                    <div class="insight-card">
                        <h4>Correlated vs Independent</h4>
                        <p>The brilliance is converting independent events into correlated ones. With random strategy, each prisoner's success is independent. With cycles, they share fate—and shared fate with some chance beats independent doom.</p>
                    </div>
                    <div class="insight-card">
                        <h4>Cycle Probability</h4>
                        <p>A random permutation has a cycle of length k with probability 1/k. The chance the longest cycle exceeds n/2 is approximately ln(2) ≈ 69%. So 31% have all cycles ≤ 50.</p>
                    </div>
                    <div class="insight-card">
                        <h4>Optimal Strategy</h4>
                        <p>The cycle-following strategy is provably optimal! No other strategy can achieve higher than ~31% success probability. The proof uses information theory.</p>
                    </div>
                    <div class="insight-card">
                        <h4>Real-World Applications</h4>
                        <p>This problem appears in distributed computing, parallel algorithms, and cryptography. The cycle-finding approach is used in Pollard's rho algorithm for integer factorization.</p>
                    </div>
                    <div class="insight-card">
                        <h4>Harmonic Numbers</h4>
                        <p>The exact probability involves harmonic numbers: P = 1 - (H_100 - H_50) where H_n = 1 + 1/2 + 1/3 + ... + 1/n. As n→∞, this approaches 1 - ln(2).</p>
                    </div>
                    <div class="insight-card">
                        <h4>Published 2003</h4>
                        <p>This problem was published by Peter Bro Miltersen and Anna Gál. The elegant solution was found by Sven Skyum. It quickly became a classic in combinatorics and probability.</p>
                    </div>
                </div>

                <div class="paradox-box" style="margin-top: 25px;">
                    <h3>The Beautiful Truth</h3>
                    <p>Sometimes the best strategy isn't to maximize individual success, but to <strong>correlate your fates</strong>. When you must ALL succeed, it's better to have a 31% chance of total success than a 50% individual chance that multiplies to nothing.</p>
                    <p style="margin-top: 10px; color: #ffd700;"><em>"In the face of collective doom, unite your fates."</em></p>
                </div>
            </div>
        </div>

        <p style="text-align: center; color: #666; margin-top: 30px; font-size: 0.9em;">
            Published by <a href="https://en.wikipedia.org/wiki/100_prisoners_problem" style="color: #ffd700;">Gál & Miltersen (2003)</a>. Solution by Sven Skyum.
        </p>
    </div>

    <script>
        // State
        let drawers = [];
        let currentPrisoner = 1;
        let currentDrawer = 0;
        let drawersOpened = 0;
        let prisonersSuccess = 0;
        let prisonerDrawersOpened = 0;
        let strategy = 'cycle';
        let cycles = [];
        let currentCycle = [];
        let isRunning = false;

        // Initialize
        function initDrawers() {
            drawers = Array.from({length: 100}, (_, i) => i + 1);
            // Fisher-Yates shuffle
            for (let i = drawers.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [drawers[i], drawers[j]] = [drawers[j], drawers[i]];
            }
            computeCycles();
        }

        function computeCycles() {
            cycles = [];
            const visited = new Set();

            for (let i = 0; i < 100; i++) {
                if (visited.has(i)) continue;

                const cycle = [];
                let current = i;
                while (!visited.has(current)) {
                    visited.add(current);
                    cycle.push(current + 1);
                    current = drawers[current] - 1;
                }
                cycles.push(cycle);
            }

            cycles.sort((a, b) => b.length - a.length);
            updateCycleLengthViz();
        }

        function renderDrawers() {
            const grid = document.getElementById('drawerGrid');
            grid.innerHTML = '';

            for (let i = 0; i < 100; i++) {
                const drawer = document.createElement('div');
                drawer.className = 'drawer';
                drawer.dataset.index = i;
                drawer.innerHTML = `${i + 1}<span class="slip">${drawers[i]}</span>`;

                // Check if in current cycle
                if (currentCycle.includes(i + 1)) {
                    drawer.classList.add('in-cycle');
                }

                drawer.addEventListener('click', () => openDrawer(i));
                grid.appendChild(drawer);
            }
        }

        function openDrawer(index) {
            const drawerEl = document.querySelectorAll('.drawer')[index];
            drawerEl.classList.add('open');

            drawersOpened++;
            prisonerDrawersOpened++;
            document.getElementById('drawersOpened').textContent = drawersOpened;

            // Check if found
            if (drawers[index] === currentPrisoner) {
                drawerEl.classList.add('found');
                prisonersSuccess++;
                document.getElementById('prisonersSuccess').textContent = prisonersSuccess;
                document.getElementById('prisonerStatus').textContent = 'Found their slip!';
                document.getElementById('prisonerStatus').className = 'status success';
                return true;
            }

            // Check if failed (50 drawers)
            if (prisonerDrawersOpened >= 50) {
                drawerEl.classList.add('failed');
                document.getElementById('prisonerStatus').textContent = 'FAILED - 50 drawers opened!';
                document.getElementById('prisonerStatus').className = 'status fail';
                return false;
            }

            return null; // Continue
        }

        function step() {
            if (currentPrisoner > 100) return;

            let drawerToOpen;

            if (strategy === 'cycle') {
                if (prisonerDrawersOpened === 0) {
                    drawerToOpen = currentPrisoner - 1;
                    currentCycle = [currentPrisoner];
                } else {
                    // Follow the chain
                    const lastOpened = currentCycle[currentCycle.length - 1];
                    const drawerIndex = lastOpened - 1;
                    drawerToOpen = drawers[drawerIndex] - 1;
                    currentCycle.push(drawers[drawerIndex]);
                }
                updateCycleDisplay();
            } else {
                // Random: pick a random unopened drawer
                const unopened = [];
                document.querySelectorAll('.drawer').forEach((d, i) => {
                    if (!d.classList.contains('open')) unopened.push(i);
                });
                drawerToOpen = unopened[Math.floor(Math.random() * unopened.length)];
            }

            const result = openDrawer(drawerToOpen);

            if (result !== null) {
                // Prisoner done
                setTimeout(nextPrisoner, 500);
            }
        }

        function runPrisoner() {
            if (isRunning || currentPrisoner > 100) return;
            isRunning = true;

            const interval = setInterval(() => {
                const statusEl = document.getElementById('prisonerStatus');
                if (statusEl.textContent.includes('Found') || statusEl.textContent.includes('FAILED')) {
                    clearInterval(interval);
                    isRunning = false;
                    setTimeout(nextPrisoner, 300);
                } else {
                    step();
                }
            }, 100);
        }

        function runAll() {
            if (isRunning) return;
            isRunning = true;

            const runNext = () => {
                if (currentPrisoner > 100) {
                    isRunning = false;
                    checkFinalResult();
                    return;
                }

                // Run current prisoner quickly
                while (true) {
                    let drawerToOpen;
                    if (strategy === 'cycle') {
                        if (prisonerDrawersOpened === 0) {
                            drawerToOpen = currentPrisoner - 1;
                            currentCycle = [currentPrisoner];
                        } else {
                            const lastOpened = currentCycle[currentCycle.length - 1];
                            drawerToOpen = drawers[lastOpened - 1] - 1;
                            currentCycle.push(drawers[drawerToOpen]);
                        }
                    } else {
                        const unopened = [];
                        document.querySelectorAll('.drawer').forEach((d, i) => {
                            if (!d.classList.contains('open')) unopened.push(i);
                        });
                        drawerToOpen = unopened[Math.floor(Math.random() * unopened.length)];
                    }

                    const result = openDrawer(drawerToOpen);
                    if (result !== null) break;
                }

                nextPrisoner();
                setTimeout(runNext, 10);
            };

            runNext();
        }

        function nextPrisoner() {
            // Reset drawers visually
            document.querySelectorAll('.drawer').forEach(d => {
                d.classList.remove('open', 'found', 'failed', 'in-cycle');
            });

            currentPrisoner++;
            prisonerDrawersOpened = 0;
            currentCycle = [];

            if (currentPrisoner <= 100) {
                document.getElementById('currentPrisoner').textContent = currentPrisoner;
                document.getElementById('prisonerStatus').textContent = `Looking for slip #${currentPrisoner}`;
                document.getElementById('prisonerStatus').className = 'status';
            }

            // Update progress
            const pct = ((currentPrisoner - 1) / 100 * 100).toFixed(0);
            document.getElementById('progressFill').style.width = pct + '%';
            document.getElementById('progressFill').textContent = `${currentPrisoner - 1}/100`;

            updateCycleDisplay();
        }

        function checkFinalResult() {
            const maxCycleLen = cycles[0]?.length || 0;
            document.getElementById('maxCycle').textContent = maxCycleLen;

            if (prisonersSuccess === 100) {
                document.getElementById('prisonerStatus').textContent = 'ALL 100 PRISONERS FREED!';
                document.getElementById('prisonerStatus').className = 'status success';
            } else {
                document.getElementById('prisonerStatus').textContent = `FAILED - Only ${prisonersSuccess} found their slip`;
                document.getElementById('prisonerStatus').className = 'status fail';
            }
        }

        function reset() {
            currentPrisoner = 1;
            currentDrawer = 0;
            drawersOpened = 0;
            prisonersSuccess = 0;
            prisonerDrawersOpened = 0;
            currentCycle = [];
            isRunning = false;

            initDrawers();
            renderDrawers();

            document.getElementById('currentPrisoner').textContent = '1';
            document.getElementById('prisonerStatus').textContent = 'Looking for slip #1';
            document.getElementById('prisonerStatus').className = 'status';
            document.getElementById('drawersOpened').textContent = '0';
            document.getElementById('prisonersSuccess').textContent = '0';
            document.getElementById('maxCycle').textContent = cycles[0]?.length || '0';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressFill').textContent = '0/100';

            updateCycleDisplay();
        }

        function updateCycleDisplay() {
            const display = document.getElementById('cycleDisplay');
            display.innerHTML = '';

            if (currentCycle.length === 0) {
                display.innerHTML = '<span style="color: #888;">Start by clicking Step or Run</span>';
                return;
            }

            currentCycle.forEach((num, i) => {
                const node = document.createElement('div');
                node.className = 'cycle-node';
                if (i === currentCycle.length - 1) node.classList.add('current');
                if (num === currentPrisoner && i > 0) node.classList.add('target');
                node.textContent = num;
                display.appendChild(node);

                if (i < currentCycle.length - 1) {
                    const arrow = document.createElement('div');
                    arrow.className = 'cycle-arrow';
                    arrow.textContent = '→';
                    display.appendChild(arrow);
                }
            });
        }

        function updateCycleLengthViz() {
            const viz = document.getElementById('cycleLengthViz');
            viz.innerHTML = '<div class="threshold-line"></div><div class="threshold-label">Max 50</div>';

            cycles.forEach(cycle => {
                const bar = document.createElement('div');
                bar.className = 'cycle-bar';
                if (cycle.length > 50) bar.classList.add('danger');
                bar.style.height = (cycle.length / 100 * 100) + '%';
                bar.title = `Cycle length: ${cycle.length}`;
                viz.appendChild(bar);
            });
        }

        // Monte Carlo
        function runMonteCarlo() {
            const trials = parseInt(document.getElementById('trialsSlider').value);
            let successes = 0;

            for (let t = 0; t < trials; t++) {
                // Generate random permutation
                const perm = Array.from({length: 100}, (_, i) => i + 1);
                for (let i = perm.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [perm[i], perm[j]] = [perm[j], perm[i]];
                }

                // Check all cycles ≤ 50
                const visited = new Set();
                let allSuccess = true;

                for (let i = 0; i < 100 && allSuccess; i++) {
                    if (visited.has(i)) continue;
                    let cycleLen = 0;
                    let current = i;
                    while (!visited.has(current)) {
                        visited.add(current);
                        cycleLen++;
                        current = perm[current] - 1;
                    }
                    if (cycleLen > 50) allSuccess = false;
                }

                if (allSuccess) successes++;
            }

            const rate = (successes / trials * 100).toFixed(1);
            document.getElementById('mcSuccess').style.width = rate + '%';
            document.getElementById('mcSuccess').textContent = rate + '%';
            document.getElementById('mcFail').style.width = (100 - rate) + '%';
            document.getElementById('mcFail').textContent = (100 - rate).toFixed(1) + '%';
            document.getElementById('mcTrials').textContent = trials;
        }

        // Event listeners
        document.getElementById('stepBtn').addEventListener('click', step);
        document.getElementById('runPrisonerBtn').addEventListener('click', runPrisoner);
        document.getElementById('runAllBtn').addEventListener('click', runAll);
        document.getElementById('resetBtn').addEventListener('click', reset);
        document.getElementById('runMonteCarloBtn').addEventListener('click', runMonteCarlo);

        document.querySelectorAll('.strategy-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.strategy-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                strategy = btn.dataset.strategy;
                reset();
            });
        });

        document.getElementById('trialsSlider').addEventListener('input', (e) => {
            document.getElementById('trialsValue').textContent = e.target.value;
        });

        // Initialize
        initDrawers();
        renderDrawers();
        document.getElementById('maxCycle').textContent = cycles[0]?.length || '0';
        updateCycleDisplay();
    </script>
</body>
</html>
