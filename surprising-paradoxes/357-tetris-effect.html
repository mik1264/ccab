<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Tetris Effect | Surprising Paradoxes</title>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&family=Nunito:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --sage: #8A9A5B;
            --moss: #606C38;
            --earth: #DDA15E;
            --cream: #FEFAE0;
            --terracotta: #BC6C25;
            --dark-moss: #3d4423;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, #F4F1DE 50%, #EDE8D5 100%);
            min-height: 100vh;
            color: var(--dark-moss);
            line-height: 1.7;
        }

        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            text-decoration: none;
            color: var(--moss);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 100;
            background: rgba(255,255,255,0.8);
            padding: 8px 16px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .back-link:hover {
            background: var(--moss);
            color: white;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 80px 20px 40px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            font-family: 'Lora', serif;
            font-size: 2.5rem;
            color: var(--moss);
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2rem;
            color: var(--terracotta);
            font-style: italic;
        }

        .card {
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        }

        h2 {
            font-family: 'Lora', serif;
            color: var(--moss);
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        h3 {
            font-family: 'Lora', serif;
            color: var(--terracotta);
            margin: 25px 0 15px;
            font-size: 1.2rem;
        }

        p {
            margin-bottom: 15px;
        }

        .experiment-phase {
            display: none;
        }

        .experiment-phase.active {
            display: block;
        }

        .progress-dots {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 25px;
        }

        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ddd;
            transition: all 0.3s ease;
        }

        .progress-dot.active {
            background: var(--moss);
            transform: scale(1.2);
        }

        .progress-dot.completed {
            background: var(--sage);
        }

        /* Mini Tetris Game */
        .game-container {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
            margin: 25px 0;
        }

        .game-board {
            background: #1a1a2e;
            border: 3px solid #16213e;
            border-radius: 10px;
            padding: 5px;
        }

        #tetris-canvas {
            display: block;
        }

        .game-info {
            text-align: center;
            min-width: 150px;
        }

        .score-display {
            background: linear-gradient(135deg, var(--moss), var(--dark-moss));
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            margin-bottom: 15px;
        }

        .score-label {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .score-value {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'Lora', serif;
        }

        .next-piece {
            background: #1a1a2e;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
        }

        .next-label {
            color: white;
            font-size: 0.85rem;
            margin-bottom: 10px;
        }

        #next-canvas {
            display: block;
            margin: 0 auto;
        }

        .game-controls {
            font-size: 0.85rem;
            color: #666;
            margin-top: 15px;
        }

        .game-controls span {
            display: block;
            margin: 5px 0;
        }

        .timer-display {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--terracotta);
            margin: 15px 0;
        }

        .phase-btn {
            padding: 15px 40px;
            font-size: 1.1rem;
            font-family: 'Nunito', sans-serif;
            font-weight: 600;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 20px auto 0;
        }

        .phase-btn.primary {
            background: var(--moss);
            color: white;
        }

        .phase-btn.primary:hover:not(:disabled) {
            background: var(--dark-moss);
            transform: scale(1.05);
        }

        .phase-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Perception Test */
        .perception-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 25px 0;
        }

        .perception-image {
            background: linear-gradient(135deg, #eee, #ddd);
            border-radius: 15px;
            aspect-ratio: 4/3;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .perception-image:hover {
            transform: scale(1.02);
            border-color: var(--sage);
        }

        .perception-image.selected {
            border-color: var(--moss);
            box-shadow: 0 0 20px rgba(138,154,91,0.4);
        }

        .perception-image canvas {
            width: 100%;
            height: 100%;
        }

        .hidden-shapes {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
        }

        .perception-image.revealed .hidden-shapes {
            opacity: 1;
        }

        .result-box {
            text-align: center;
            padding: 25px;
            background: linear-gradient(135deg, rgba(138,154,91,0.15), rgba(138,154,91,0.05));
            border-radius: 20px;
            margin: 25px 0;
        }

        .result-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--moss);
            margin-bottom: 10px;
        }

        .result-stat {
            font-size: 3rem;
            font-weight: 700;
            font-family: 'Lora', serif;
            color: var(--terracotta);
        }

        .quote-box {
            background: linear-gradient(135deg, rgba(138,154,91,0.15), rgba(138,154,91,0.05));
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            position: relative;
        }

        .quote-box::before {
            content: '"';
            font-size: 4rem;
            color: var(--sage);
            opacity: 0.3;
            position: absolute;
            top: 10px;
            left: 20px;
            font-family: Georgia, serif;
        }

        .quote-text {
            font-style: italic;
            font-size: 1.1rem;
            padding-left: 40px;
            color: var(--dark-moss);
        }

        .quote-author {
            text-align: right;
            margin-top: 15px;
            color: var(--moss);
            font-weight: 600;
        }

        .insight-box {
            background: linear-gradient(135deg, rgba(221,161,94,0.2), rgba(221,161,94,0.05));
            border-left: 4px solid var(--earth);
            padding: 20px;
            border-radius: 0 15px 15px 0;
            margin: 25px 0;
        }

        .insight-box strong {
            color: var(--terracotta);
        }

        .examples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 25px 0;
        }

        .example-card {
            background: linear-gradient(135deg, var(--cream), white);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .example-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .example-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .example-title {
            font-weight: 700;
            color: var(--moss);
            margin-bottom: 8px;
        }

        .example-desc {
            font-size: 0.9rem;
            color: #666;
        }

        .timeline {
            position: relative;
            padding-left: 30px;
            margin: 25px 0;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(to bottom, var(--sage), var(--moss));
            border-radius: 2px;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 25px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -26px;
            top: 5px;
            width: 14px;
            height: 14px;
            background: var(--moss);
            border-radius: 50%;
            border: 3px solid white;
        }

        .timeline-year {
            font-weight: 700;
            color: var(--terracotta);
            font-size: 1.1rem;
        }

        .restart-btn {
            display: block;
            margin: 30px auto 0;
            padding: 15px 40px;
            font-size: 1.1rem;
            font-family: 'Nunito', sans-serif;
            font-weight: 600;
            background: var(--terracotta);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .restart-btn:hover {
            background: #a55a1f;
            transform: scale(1.05);
        }

        .falling-blocks {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 1s ease;
        }

        .falling-blocks.visible {
            opacity: 1;
        }

        .falling-block {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 5px;
            animation: fall linear forwards;
        }

        @keyframes fall {
            from {
                transform: translateY(-50px) rotate(0deg);
                opacity: 0.8;
            }
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        @media (max-width: 600px) {
            h1 { font-size: 1.8rem; }
            .perception-grid { grid-template-columns: 1fr; }
            .game-container { flex-direction: column; align-items: center; }
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Paradoxes</a>

    <div class="falling-blocks" id="fallingBlocks"></div>

    <div class="container">
        <header>
            <h1>The Tetris Effect</h1>
            <p class="subtitle">When Games Invade Your Mind</p>
        </header>

        <!-- Phase 1: Introduction -->
        <div id="phase1" class="experiment-phase active">
            <div class="card">
                <div class="progress-dots">
                    <div class="progress-dot active"></div>
                    <div class="progress-dot"></div>
                    <div class="progress-dot"></div>
                    <div class="progress-dot"></div>
                </div>

                <h2>Have You Ever...</h2>
                <p>...played a video game for hours, then closed your eyes and <em>still saw the game</em>?</p>
                <p>...looked at a bookshelf and suddenly imagined how Tetris blocks would fit between the books?</p>
                <p>...dreamed about falling shapes, matching colors, or endless levels?</p>

                <div class="quote-box">
                    <p class="quote-text">People who have played Tetris for prolonged amounts can find themselves thinking about ways different shapes in the real world can fit together, seeing colored images of pieces falling into place at the edges of their visual fields.</p>
                    <p class="quote-author">‚Äî Wikipedia, "Tetris Effect"</p>
                </div>

                <p>This is the <strong>Tetris Effect</strong>‚Äîa phenomenon where prolonged focus on a repetitive activity causes it to invade your thoughts, dreams, and perceptions.</p>

                <p>In 2000, Harvard researchers made a remarkable discovery: even <em>amnesiacs who couldn't remember playing the game</em> still dreamed about falling blocks.</p>

                <button class="phase-btn primary" onclick="startGame()">Experience It Yourself</button>
            </div>
        </div>

        <!-- Phase 2: Play the Game -->
        <div id="phase2" class="experiment-phase">
            <div class="card">
                <div class="progress-dots">
                    <div class="progress-dot completed"></div>
                    <div class="progress-dot active"></div>
                    <div class="progress-dot"></div>
                    <div class="progress-dot"></div>
                </div>

                <h2>Play for 60 Seconds</h2>
                <p>Focus intently on the falling blocks. Try to clear as many lines as you can!</p>

                <div class="game-container">
                    <div class="game-board">
                        <canvas id="tetris-canvas" width="200" height="400"></canvas>
                    </div>
                    <div class="game-info">
                        <div class="score-display">
                            <div class="score-label">SCORE</div>
                            <div class="score-value" id="score">0</div>
                        </div>
                        <div class="score-display">
                            <div class="score-label">LINES</div>
                            <div class="score-value" id="lines">0</div>
                        </div>
                        <div class="next-piece">
                            <div class="next-label">NEXT</div>
                            <canvas id="next-canvas" width="80" height="80"></canvas>
                        </div>
                        <div class="timer-display">
                            Time: <span id="timer">60</span>s
                        </div>
                        <div class="game-controls">
                            <span>‚Üê ‚Üí Move</span>
                            <span>‚Üë Rotate</span>
                            <span>‚Üì Soft Drop</span>
                            <span>Space: Hard Drop</span>
                        </div>
                    </div>
                </div>

                <button class="phase-btn primary" id="skipBtn" onclick="endGame()" style="background: #999;">Skip (or wait for timer)</button>
            </div>
        </div>

        <!-- Phase 3: Perception Test -->
        <div id="phase3" class="experiment-phase">
            <div class="card">
                <div class="progress-dots">
                    <div class="progress-dot completed"></div>
                    <div class="progress-dot completed"></div>
                    <div class="progress-dot active"></div>
                    <div class="progress-dot"></div>
                </div>

                <h2>Quick! Look at These Images</h2>
                <p>Do you notice anything familiar? Click on any images where you see Tetris-like shapes:</p>

                <div class="perception-grid" id="perceptionGrid">
                    <!-- Generated by JavaScript -->
                </div>

                <p id="perceptionHint" style="text-align: center; color: var(--terracotta); font-style: italic;">
                    Take your time... do any shapes jump out at you?
                </p>

                <button class="phase-btn primary" id="revealBtn" onclick="revealResults()">See What's Really There</button>
            </div>
        </div>

        <!-- Phase 4: The Science -->
        <div id="phase4" class="experiment-phase">
            <div class="card">
                <div class="progress-dots">
                    <div class="progress-dot completed"></div>
                    <div class="progress-dot completed"></div>
                    <div class="progress-dot completed"></div>
                    <div class="progress-dot active"></div>
                </div>

                <h2>Your Results</h2>

                <div class="result-box">
                    <div class="result-title">You Selected</div>
                    <div class="result-stat" id="selectedCount">0</div>
                    <p>images as containing Tetris shapes</p>
                    <p id="resultMessage" style="margin-top: 15px;"></p>
                </div>

                <div class="insight-box">
                    <strong>The truth:</strong> After just 60 seconds of play, your brain is already primed to see Tetris patterns. The more you play, the stronger the effect becomes‚Äîeventually appearing in dreams and edge-of-vision imagery.
                </div>
            </div>

            <div class="card">
                <h2>The Harvard Dream Study (2000)</h2>

                <p>Robert Stickgold and colleagues at Harvard Medical School conducted a groundbreaking experiment:</p>

                <div class="examples-grid">
                    <div class="example-card">
                        <div class="example-icon">üÜï</div>
                        <div class="example-title">12 Novices</div>
                        <div class="example-desc">Never played Tetris before</div>
                    </div>
                    <div class="example-card">
                        <div class="example-icon">üéÆ</div>
                        <div class="example-title">10 Experts</div>
                        <div class="example-desc">50-500 hours of play</div>
                    </div>
                    <div class="example-card">
                        <div class="example-icon">üß†</div>
                        <div class="example-title">5 Amnesiacs</div>
                        <div class="example-desc">No short-term memory</div>
                    </div>
                </div>

                <p>After three days of playing Tetris, participants reported their experiences at sleep onset (hypnagogic state):</p>

                <div class="result-box">
                    <div class="result-stat">63%</div>
                    <p>reported seeing Tetris imagery while falling asleep‚Äî<br>falling blocks, rotating pieces, rows disappearing</p>
                </div>

                <div class="insight-box">
                    <strong>The shocking finding:</strong> Three of the five amnesiacs also reported Tetris dreams‚Äîdespite having <em>no memory of ever playing the game</em>. One amnesiac said: "I was thinking about little squares coming down... they were trying to fit in." She couldn't remember the game, but her brain had encoded it anyway.
                </div>

                <p>This revealed that the Tetris Effect involves <strong>procedural memory</strong> (how to do things), which is stored differently from <strong>declarative memory</strong> (facts and events). The game had been encoded at a level below conscious awareness.</p>
            </div>

            <div class="card">
                <h2>Game Transfer Phenomena</h2>

                <p>The Tetris Effect is part of a broader phenomenon studied by researcher Angelica Ortiz de Gortari:</p>

                <div class="result-box">
                    <div class="result-stat">97%</div>
                    <p>of gamers report experiencing some form of<br>Game Transfer Phenomena</p>
                </div>

                <p>These involuntary experiences include:</p>

                <div class="examples-grid">
                    <div class="example-card">
                        <div class="example-icon">üëÅÔ∏è</div>
                        <div class="example-title">Visual</div>
                        <div class="example-desc">Seeing game elements in real objects, walls, or peripheral vision</div>
                    </div>
                    <div class="example-card">
                        <div class="example-icon">üëÇ</div>
                        <div class="example-title">Auditory</div>
                        <div class="example-desc">Hearing game music, sound effects, or character voices</div>
                    </div>
                    <div class="example-card">
                        <div class="example-icon">üñêÔ∏è</div>
                        <div class="example-title">Motor</div>
                        <div class="example-desc">Involuntary finger movements, urge to press buttons</div>
                    </div>
                    <div class="example-card">
                        <div class="example-icon">üí≠</div>
                        <div class="example-title">Cognitive</div>
                        <div class="example-desc">Thinking in game logic, seeing "quests" in daily tasks</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Real-World Examples</h2>

                <div class="examples-grid">
                    <div class="example-card">
                        <div class="example-icon">üß±</div>
                        <div class="example-title">Tetris Players</div>
                        <div class="example-desc">See how boxes, buildings, and bookshelves could "fit together"</div>
                    </div>
                    <div class="example-card">
                        <div class="example-icon">üíé</div>
                        <div class="example-title">Candy Crush</div>
                        <div class="example-desc">See matching patterns in floor tiles, store shelves, colored objects</div>
                    </div>
                    <div class="example-card">
                        <div class="example-icon">üöó</div>
                        <div class="example-title">Driving Games</div>
                        <div class="example-desc">Racing thoughts while passenger in real car, urge to "drift"</div>
                    </div>
                    <div class="example-card">
                        <div class="example-icon">‚öîÔ∏è</div>
                        <div class="example-title">RPG Players</div>
                        <div class="example-desc">See "health bars" above people, imagine NPC dialogue options</div>
                    </div>
                    <div class="example-card">
                        <div class="example-icon">üé∏</div>
                        <div class="example-title">Guitar Hero</div>
                        <div class="example-desc">See colored notes falling down while listening to music</div>
                    </div>
                    <div class="example-card">
                        <div class="example-icon">üè†</div>
                        <div class="example-title">Minecraft</div>
                        <div class="example-desc">See blocky textures in real surfaces, want to "mine" things</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Therapeutic Application: Tetris for Trauma</h2>

                <p>Remarkably, the Tetris Effect has been harnessed for mental health treatment:</p>

                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-year">2009</div>
                        <p><strong>Emily Holmes</strong> (Oxford) discovered that playing Tetris within 6 hours of trauma reduces flashback formation by occupying the brain's visuospatial resources.</p>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-year">2017</div>
                        <p>Car accident victims who played Tetris in the ER had <strong>62% fewer intrusive memories</strong> in the following week.</p>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-year">2019</div>
                        <p>A "cognitive vaccine" protocol showed Tetris players had just <strong>1 flashback per week</strong> at 5-week follow-up, vs. 5 per week in controls.</p>
                    </div>
                </div>

                <div class="quote-box">
                    <p class="quote-text">Flashbacks are sensory-perceptual, visuospatial mental images. Visuospatial cognitive tasks‚Äîlike Tetris‚Äîselectively compete for the resources required to generate these images.</p>
                    <p class="quote-author">‚Äî Holmes et al., PLOS ONE (2009)</p>
                </div>

                <p>The very mechanism that makes Tetris "invade" your mind can be used to <em>block</em> traumatic imagery from consolidating.</p>
            </div>

            <div class="card">
                <h2>Why Does This Happen?</h2>

                <h3>1. Pattern Recognition Priming</h3>
                <p>Repeated exposure sensitizes your brain to notice similar patterns. After hours of fitting blocks together, your visual cortex is primed to detect those shapes everywhere.</p>

                <h3>2. Memory Consolidation</h3>
                <p>During sleep, your brain replays and consolidates procedural memories. Tetris imagery appearing at sleep onset reflects this process in action.</p>

                <h3>3. Hypnagogic State</h3>
                <p>The transition from waking to sleeping (hypnagogia) is when the most vivid game transfer experiences occur. The prefrontal cortex‚Äîwhich normally filters out irrelevant thoughts‚Äîbecomes less active.</p>

                <h3>4. Overlearning</h3>
                <p>With enough practice, game patterns become automatic. Your brain continues processing them even when you're not playing, much like how a song gets "stuck in your head."</p>

                <div class="insight-box">
                    <strong>The takeaway:</strong> What you repeatedly focus on literally rewires your perception. The Tetris Effect shows that our brains don't just passively observe reality‚Äîthey actively construct it based on recent experience.
                </div>

                <button class="restart-btn" onclick="triggerFallingBlocks(); setTimeout(resetExperiment, 3000);">Experience the Effect Again</button>
            </div>
        </div>
    </div>

    <script>
        // Tetris Game State
        const COLS = 10;
        const ROWS = 20;
        const BLOCK_SIZE = 20;
        const COLORS = ['#00f0f0', '#f0f000', '#a000f0', '#00f000', '#f00000', '#0000f0', '#f0a000'];
        const SHAPES = [
            [[1,1,1,1]],                         // I
            [[1,1],[1,1]],                       // O
            [[0,1,0],[1,1,1]],                   // T
            [[1,1,0],[0,1,1]],                   // S
            [[0,1,1],[1,1,0]],                   // Z
            [[1,0,0],[1,1,1]],                   // J
            [[0,0,1],[1,1,1]]                    // L
        ];

        let canvas, ctx, nextCanvas, nextCtx;
        let board = [];
        let currentPiece = null;
        let nextPiece = null;
        let score = 0;
        let linesCleared = 0;
        let gameInterval = null;
        let timerInterval = null;
        let timeLeft = 60;
        let gameRunning = false;
        let selectedImages = [];

        function initGame() {
            canvas = document.getElementById('tetris-canvas');
            ctx = canvas.getContext('2d');
            nextCanvas = document.getElementById('next-canvas');
            nextCtx = nextCanvas.getContext('2d');

            board = Array(ROWS).fill().map(() => Array(COLS).fill(0));
            score = 0;
            linesCleared = 0;
            timeLeft = 60;

            document.getElementById('score').textContent = score;
            document.getElementById('lines').textContent = linesCleared;
            document.getElementById('timer').textContent = timeLeft;

            spawnPiece();
            drawBoard();
            drawNextPiece();
        }

        function spawnPiece() {
            if (nextPiece === null) {
                nextPiece = createPiece();
            }
            currentPiece = nextPiece;
            nextPiece = createPiece();
            currentPiece.x = Math.floor(COLS / 2) - Math.floor(currentPiece.shape[0].length / 2);
            currentPiece.y = 0;

            if (collision()) {
                endGame();
            }
        }

        function createPiece() {
            const idx = Math.floor(Math.random() * SHAPES.length);
            return {
                shape: SHAPES[idx].map(row => [...row]),
                color: COLORS[idx],
                x: 0,
                y: 0
            };
        }

        function drawBoard() {
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw placed blocks
            for (let y = 0; y < ROWS; y++) {
                for (let x = 0; x < COLS; x++) {
                    if (board[y][x]) {
                        drawBlock(ctx, x, y, board[y][x]);
                    }
                }
            }

            // Draw current piece
            if (currentPiece) {
                for (let y = 0; y < currentPiece.shape.length; y++) {
                    for (let x = 0; x < currentPiece.shape[y].length; x++) {
                        if (currentPiece.shape[y][x]) {
                            drawBlock(ctx, currentPiece.x + x, currentPiece.y + y, currentPiece.color);
                        }
                    }
                }
            }

            // Draw grid
            ctx.strokeStyle = '#2a2a4e';
            ctx.lineWidth = 0.5;
            for (let x = 0; x <= COLS; x++) {
                ctx.beginPath();
                ctx.moveTo(x * BLOCK_SIZE, 0);
                ctx.lineTo(x * BLOCK_SIZE, canvas.height);
                ctx.stroke();
            }
            for (let y = 0; y <= ROWS; y++) {
                ctx.beginPath();
                ctx.moveTo(0, y * BLOCK_SIZE);
                ctx.lineTo(canvas.width, y * BLOCK_SIZE);
                ctx.stroke();
            }
        }

        function drawBlock(context, x, y, color) {
            const px = x * BLOCK_SIZE;
            const py = y * BLOCK_SIZE;

            context.fillStyle = color;
            context.fillRect(px + 1, py + 1, BLOCK_SIZE - 2, BLOCK_SIZE - 2);

            // Highlight
            context.fillStyle = 'rgba(255,255,255,0.3)';
            context.fillRect(px + 1, py + 1, BLOCK_SIZE - 2, 3);
            context.fillRect(px + 1, py + 1, 3, BLOCK_SIZE - 2);

            // Shadow
            context.fillStyle = 'rgba(0,0,0,0.3)';
            context.fillRect(px + BLOCK_SIZE - 4, py + 1, 3, BLOCK_SIZE - 2);
            context.fillRect(px + 1, py + BLOCK_SIZE - 4, BLOCK_SIZE - 2, 3);
        }

        function drawNextPiece() {
            nextCtx.fillStyle = '#1a1a2e';
            nextCtx.fillRect(0, 0, nextCanvas.width, nextCanvas.height);

            if (nextPiece) {
                const offsetX = (4 - nextPiece.shape[0].length) / 2;
                const offsetY = (4 - nextPiece.shape.length) / 2;

                for (let y = 0; y < nextPiece.shape.length; y++) {
                    for (let x = 0; x < nextPiece.shape[y].length; x++) {
                        if (nextPiece.shape[y][x]) {
                            const px = (offsetX + x) * BLOCK_SIZE;
                            const py = (offsetY + y) * BLOCK_SIZE;
                            nextCtx.fillStyle = nextPiece.color;
                            nextCtx.fillRect(px + 1, py + 1, BLOCK_SIZE - 2, BLOCK_SIZE - 2);
                        }
                    }
                }
            }
        }

        function collision() {
            for (let y = 0; y < currentPiece.shape.length; y++) {
                for (let x = 0; x < currentPiece.shape[y].length; x++) {
                    if (currentPiece.shape[y][x]) {
                        const newX = currentPiece.x + x;
                        const newY = currentPiece.y + y;
                        if (newX < 0 || newX >= COLS || newY >= ROWS) return true;
                        if (newY >= 0 && board[newY][newX]) return true;
                    }
                }
            }
            return false;
        }

        function merge() {
            for (let y = 0; y < currentPiece.shape.length; y++) {
                for (let x = 0; x < currentPiece.shape[y].length; x++) {
                    if (currentPiece.shape[y][x]) {
                        board[currentPiece.y + y][currentPiece.x + x] = currentPiece.color;
                    }
                }
            }
        }

        function clearLines() {
            let cleared = 0;
            for (let y = ROWS - 1; y >= 0; y--) {
                if (board[y].every(cell => cell !== 0)) {
                    board.splice(y, 1);
                    board.unshift(Array(COLS).fill(0));
                    cleared++;
                    y++;
                }
            }
            if (cleared > 0) {
                linesCleared += cleared;
                score += [0, 100, 300, 500, 800][cleared];
                document.getElementById('score').textContent = score;
                document.getElementById('lines').textContent = linesCleared;
            }
        }

        function rotate() {
            const rotated = currentPiece.shape[0].map((_, i) =>
                currentPiece.shape.map(row => row[i]).reverse()
            );
            const oldShape = currentPiece.shape;
            currentPiece.shape = rotated;
            if (collision()) {
                currentPiece.shape = oldShape;
            }
        }

        function move(dir) {
            currentPiece.x += dir;
            if (collision()) {
                currentPiece.x -= dir;
            }
        }

        function drop() {
            currentPiece.y++;
            if (collision()) {
                currentPiece.y--;
                merge();
                clearLines();
                spawnPiece();
            }
            drawBoard();
        }

        function hardDrop() {
            while (!collision()) {
                currentPiece.y++;
            }
            currentPiece.y--;
            merge();
            clearLines();
            spawnPiece();
            drawBoard();
        }

        function gameLoop() {
            drop();
            drawNextPiece();
        }

        function startGame() {
            showPhase(2);
            initGame();
            gameRunning = true;

            gameInterval = setInterval(gameLoop, 500);

            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').textContent = timeLeft;
                if (timeLeft <= 0) {
                    endGame();
                }
            }, 1000);

            document.addEventListener('keydown', handleKey);
        }

        function handleKey(e) {
            if (!gameRunning) return;

            switch(e.key) {
                case 'ArrowLeft':
                    move(-1);
                    drawBoard();
                    break;
                case 'ArrowRight':
                    move(1);
                    drawBoard();
                    break;
                case 'ArrowUp':
                    rotate();
                    drawBoard();
                    break;
                case 'ArrowDown':
                    drop();
                    break;
                case ' ':
                    hardDrop();
                    e.preventDefault();
                    break;
            }
        }

        function endGame() {
            gameRunning = false;
            clearInterval(gameInterval);
            clearInterval(timerInterval);
            document.removeEventListener('keydown', handleKey);

            // Trigger falling blocks effect
            triggerFallingBlocks();

            setTimeout(() => {
                showPhase(3);
                setupPerceptionTest();
            }, 2000);
        }

        function triggerFallingBlocks() {
            const container = document.getElementById('fallingBlocks');
            container.innerHTML = '';
            container.classList.add('visible');

            for (let i = 0; i < 30; i++) {
                const block = document.createElement('div');
                block.className = 'falling-block';
                block.style.left = Math.random() * 100 + '%';
                block.style.background = COLORS[Math.floor(Math.random() * COLORS.length)];
                block.style.animationDuration = (2 + Math.random() * 3) + 's';
                block.style.animationDelay = Math.random() * 2 + 's';
                container.appendChild(block);
            }

            setTimeout(() => {
                container.classList.remove('visible');
            }, 5000);
        }

        function setupPerceptionTest() {
            const grid = document.getElementById('perceptionGrid');
            grid.innerHTML = '';
            selectedImages = [];

            // Create 4 abstract images
            for (let i = 0; i < 4; i++) {
                const div = document.createElement('div');
                div.className = 'perception-image';
                div.onclick = () => toggleImage(i, div);

                const canvas = document.createElement('canvas');
                canvas.width = 300;
                canvas.height = 225;
                const ctx = canvas.getContext('2d');

                // Draw abstract pattern with hidden tetromino-like shapes
                drawAbstractPattern(ctx, canvas.width, canvas.height, i);

                div.appendChild(canvas);
                grid.appendChild(div);
            }
        }

        function drawAbstractPattern(ctx, w, h, variant) {
            // Background gradient
            const gradient = ctx.createLinearGradient(0, 0, w, h);
            gradient.addColorStop(0, `hsl(${variant * 60 + 180}, 20%, 85%)`);
            gradient.addColorStop(1, `hsl(${variant * 60 + 200}, 25%, 75%)`);
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, w, h);

            // Random rectangles (some vaguely tetromino-shaped)
            for (let i = 0; i < 40; i++) {
                const x = Math.random() * w;
                const y = Math.random() * h;
                const size = 10 + Math.random() * 30;

                ctx.fillStyle = `hsla(${Math.random() * 360}, 40%, 60%, 0.5)`;

                // Sometimes draw tetromino-like clusters
                if (Math.random() > 0.7) {
                    // L-shape
                    ctx.fillRect(x, y, size, size);
                    ctx.fillRect(x, y + size, size, size);
                    ctx.fillRect(x + size, y + size, size, size);
                } else if (Math.random() > 0.5) {
                    // Line
                    ctx.fillRect(x, y, size, size * 3);
                } else {
                    ctx.fillRect(x, y, size, size);
                }
            }

            // Some circles to break up the pattern
            for (let i = 0; i < 10; i++) {
                ctx.beginPath();
                ctx.arc(Math.random() * w, Math.random() * h, 5 + Math.random() * 15, 0, Math.PI * 2);
                ctx.fillStyle = `hsla(${Math.random() * 360}, 30%, 70%, 0.4)`;
                ctx.fill();
            }
        }

        function toggleImage(idx, el) {
            el.classList.toggle('selected');
            if (el.classList.contains('selected')) {
                selectedImages.push(idx);
            } else {
                selectedImages = selectedImages.filter(i => i !== idx);
            }
        }

        function revealResults() {
            showPhase(4);

            document.getElementById('selectedCount').textContent = selectedImages.length;

            const msg = document.getElementById('resultMessage');
            if (selectedImages.length === 0) {
                msg.innerHTML = "Interesting! You didn't see any Tetris shapes‚Äîbut after more play time, they would likely appear. The effect builds with exposure.";
            } else if (selectedImages.length <= 2) {
                msg.innerHTML = "You're already starting to see block-like patterns! With more play, these shapes would become even more prominent.";
            } else {
                msg.innerHTML = "<strong>Classic Tetris Effect!</strong> Your brain is actively seeking out those familiar shapes. After hours of play, you might even dream about them.";
            }
        }

        function showPhase(num) {
            document.querySelectorAll('.experiment-phase').forEach(p => p.classList.remove('active'));
            document.getElementById('phase' + num).classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetExperiment() {
            showPhase(1);
        }
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
