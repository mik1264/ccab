<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Dzhanibekov Effect - Intermediate Axis Theorem</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3e 50%, #0f2040 100%);
            color: #e8e8e8;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 2.4rem;
            background: linear-gradient(135deg, #ff6b6b, #feca57, #48dbfb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #aaa;
            font-size: 1rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 20px;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .viz-section {
            background: rgba(255,255,255,0.03);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        #canvas-container {
            position: relative;
            width: 100%;
            height: 500px;
            border-radius: 10px;
            overflow: hidden;
            background: #000;
        }

        #three-canvas {
            width: 100%;
            height: 100%;
        }

        .axis-indicator {
            position: absolute;
            bottom: 15px;
            left: 15px;
            background: rgba(0,0,0,0.7);
            padding: 12px;
            border-radius: 8px;
            font-size: 0.8rem;
        }

        .axis-indicator div {
            margin: 4px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .axis-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .axis-x { background: #ff6b6b; }
        .axis-y { background: #48dbfb; }
        .axis-z { background: #feca57; }

        .stability-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .stable { background: rgba(46, 204, 113, 0.3); color: #2ecc71; }
        .unstable { background: rgba(231, 76, 60, 0.3); color: #e74c3c; }

        .stats-bar {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0,0,0,0.7);
            padding: 12px;
            border-radius: 8px;
            font-size: 0.8rem;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin: 4px 0;
        }

        .stat-label { color: #888; }
        .stat-value { color: #48dbfb; font-weight: bold; }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .control-group {
            background: rgba(0,0,0,0.3);
            padding: 12px;
            border-radius: 8px;
        }

        .control-group label {
            display: block;
            font-size: 0.8rem;
            color: #aaa;
            margin-bottom: 8px;
        }

        .btn-group {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
            background: rgba(255,255,255,0.1);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-1px);
        }

        .btn.active {
            background: linear-gradient(135deg, #48dbfb, #0abde3);
            border-color: #48dbfb;
        }

        .btn.unstable-btn.active {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border-color: #e74c3c;
        }

        .btn-primary {
            background: linear-gradient(135deg, #48dbfb, #0abde3);
        }

        input[type="range"] {
            width: 100%;
            margin-top: 5px;
        }

        .slider-value {
            text-align: right;
            font-size: 0.75rem;
            color: #48dbfb;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .info-card {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 18px;
            border-left: 4px solid #feca57;
        }

        .info-card h3 {
            color: #feca57;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .info-card p {
            color: #bbb;
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .info-card p:last-child {
            margin-bottom: 0;
        }

        .formula-box {
            background: rgba(0,0,0,0.4);
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: 'Times New Roman', serif;
            color: #48dbfb;
            font-size: 0.95rem;
            text-align: center;
        }

        .back-link {
            position: fixed;
            top: 15px;
            left: 15px;
            color: #feca57;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            opacity: 0.8;
            transition: opacity 0.3s;
            z-index: 100;
            background: rgba(0,0,0,0.5);
            padding: 8px 12px;
            border-radius: 20px;
        }

        .back-link:hover {
            opacity: 1;
        }

        .highlight { color: #2ecc71; font-weight: bold; }
        .highlight-red { color: #e74c3c; font-weight: bold; }
        .highlight-blue { color: #48dbfb; font-weight: bold; }
        .highlight-yellow { color: #feca57; font-weight: bold; }

        .history-card {
            border-left-color: #ff6b6b;
        }

        .history-card h3 {
            color: #ff6b6b;
        }

        .physics-card {
            border-left-color: #48dbfb;
        }

        .physics-card h3 {
            color: #48dbfb;
        }

        .flip-counter {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(231, 76, 60, 0.8);
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .angular-momentum-viz {
            background: rgba(0,0,0,0.3);
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .momentum-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
        }

        .momentum-label {
            width: 30px;
            font-weight: bold;
        }

        .momentum-bar-container {
            flex: 1;
            height: 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            overflow: hidden;
        }

        .momentum-bar {
            height: 100%;
            border-radius: 6px;
            transition: width 0.1s;
        }

        .omega-x .momentum-bar { background: #ff6b6b; }
        .omega-y .momentum-bar { background: #48dbfb; }
        .omega-z .momentum-bar { background: #feca57; }

        .momentum-value {
            width: 60px;
            text-align: right;
            font-size: 0.8rem;
            color: #888;
        }

        .explorer-1-note {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.85rem;
        }

        .explorer-1-note strong {
            color: #ff6b6b;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back to Paradoxes</a>

    <div class="container">
        <header>
            <h1>The Dzhanibekov Effect</h1>
            <p class="subtitle">Also known as the Tennis Racket Theorem or Intermediate Axis Theorem</p>
        </header>

        <div class="main-content">
            <div class="viz-section">
                <div id="canvas-container">
                    <canvas id="three-canvas"></canvas>

                    <div class="flip-counter">
                        Flips: <span id="flip-count">0</span>
                    </div>

                    <div class="axis-indicator">
                        <div><span class="axis-dot axis-x"></span> X-axis (I₁ smallest) <span class="stability-badge stable">STABLE</span></div>
                        <div><span class="axis-dot axis-y"></span> Y-axis (I₂ intermediate) <span class="stability-badge unstable">UNSTABLE</span></div>
                        <div><span class="axis-dot axis-z"></span> Z-axis (I₃ largest) <span class="stability-badge stable">STABLE</span></div>
                    </div>

                    <div class="stats-bar">
                        <div class="stat-row">
                            <span class="stat-label">Energy:</span>
                            <span class="stat-value" id="energy-display">0.00</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">|L|:</span>
                            <span class="stat-value" id="momentum-display">0.00</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Time:</span>
                            <span class="stat-value" id="time-display">0.0s</span>
                        </div>
                    </div>
                </div>

                <div class="angular-momentum-viz">
                    <div style="font-size: 0.85rem; color: #aaa; margin-bottom: 8px;">Angular Velocity Components</div>
                    <div class="momentum-row omega-x">
                        <span class="momentum-label" style="color: #ff6b6b;">ω₁</span>
                        <div class="momentum-bar-container">
                            <div class="momentum-bar" id="omega-x-bar" style="width: 0%"></div>
                        </div>
                        <span class="momentum-value" id="omega-x-val">0.00</span>
                    </div>
                    <div class="momentum-row omega-y">
                        <span class="momentum-label" style="color: #48dbfb;">ω₂</span>
                        <div class="momentum-bar-container">
                            <div class="momentum-bar" id="omega-y-bar" style="width: 0%"></div>
                        </div>
                        <span class="momentum-value" id="omega-y-val">0.00</span>
                    </div>
                    <div class="momentum-row omega-z">
                        <span class="momentum-label" style="color: #feca57;">ω₃</span>
                        <div class="momentum-bar-container">
                            <div class="momentum-bar" id="omega-z-bar" style="width: 0%"></div>
                        </div>
                        <span class="momentum-value" id="omega-z-val">0.00</span>
                    </div>
                </div>

                <div class="controls">
                    <div class="control-group">
                        <label>Rotation Axis</label>
                        <div class="btn-group">
                            <button class="btn" id="btn-x">X (Stable)</button>
                            <button class="btn unstable-btn active" id="btn-y">Y (Unstable)</button>
                            <button class="btn" id="btn-z">Z (Stable)</button>
                        </div>
                    </div>

                    <div class="control-group">
                        <label>Object Shape</label>
                        <div class="btn-group">
                            <button class="btn active" id="btn-thandle">T-Handle</button>
                            <button class="btn" id="btn-book">Book</button>
                            <button class="btn" id="btn-phone">Phone</button>
                        </div>
                    </div>

                    <div class="control-group">
                        <label>Perturbation Size</label>
                        <input type="range" id="perturbation" min="0" max="20" value="5">
                        <div class="slider-value"><span id="pert-value">5</span>%</div>
                    </div>

                    <div class="control-group">
                        <label>Rotation Speed</label>
                        <input type="range" id="speed" min="1" max="20" value="8">
                        <div class="slider-value"><span id="speed-value">8</span> rad/s</div>
                    </div>

                    <div class="control-group">
                        <label>Simulation</label>
                        <div class="btn-group">
                            <button class="btn btn-primary" id="btn-reset">Reset</button>
                            <button class="btn" id="btn-pause">Pause</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <div class="info-card">
                    <h3>The Paradox</h3>
                    <p>Toss a book, phone, or T-handle into the air with a spin. Rotation around two axes stays stable, but around the <span class="highlight-red">intermediate axis</span>, the object mysteriously <span class="highlight-red">flips back and forth</span>—even with no external forces!</p>
                    <p>This counterintuitive behavior occurs because small perturbations around the intermediate axis <span class="highlight-red">grow exponentially</span>, while perturbations around the other axes stay bounded.</p>
                </div>

                <div class="info-card history-card">
                    <h3>Discovery in Space</h3>
                    <p>In <span class="highlight">1985</span>, Soviet cosmonaut <span class="highlight">Vladimir Dzhanibekov</span> noticed a wing nut spinning in microgravity would periodically flip its orientation—seemingly defying intuition.</p>
                    <p>The effect was actually known since <span class="highlight-yellow">1834</span>, described by mathematician Louis Poinsot, but Dzhanibekov's space footage made it famous.</p>
                    <div class="explorer-1-note">
                        <strong>Explorer 1 (1958):</strong> America's first satellite was designed to spin around its long axis but unexpectedly started tumbling due to this effect combined with energy dissipation.
                    </div>
                </div>

                <div class="info-card physics-card">
                    <h3>The Mathematics</h3>
                    <p>For a torque-free rigid body, <span class="highlight-blue">Euler's equations</span> govern rotation:</p>
                    <div class="formula-box">
                        I₁ω̇₁ = (I₂ − I₃)ω₂ω₃<br>
                        I₂ω̇₂ = (I₃ − I₁)ω₃ω₁<br>
                        I₃ω̇₃ = (I₁ − I₂)ω₁ω₂
                    </div>
                    <p>With <span class="highlight-blue">I₁ < I₂ < I₃</span>, linearization around the intermediate axis shows eigenvalues with <span class="highlight-red">positive real parts</span>—exponential instability!</p>
                    <p>Both <span class="highlight">rotational energy</span> and <span class="highlight">angular momentum magnitude</span> are conserved, yet the rotation axis precesses chaotically in the body frame.</p>
                </div>

                <div class="info-card">
                    <h3>Try It Yourself</h3>
                    <p><span class="highlight-yellow">1.</span> Find a book or phone<br>
                    <span class="highlight-yellow">2.</span> Toss it with spin around the intermediate axis (like flipping pages)<br>
                    <span class="highlight-yellow">3.</span> Watch it tumble chaotically!<br><br>
                    Compare to spinning around the spine (stable) or flat face (stable).</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Physics simulation of the Dzhanibekov Effect

        let scene, camera, renderer, object;
        let quaternion = new THREE.Quaternion();
        let omega = { x: 0, y: 8, z: 0 }; // Angular velocity in body frame
        let I = { x: 1, y: 3, z: 5 }; // Moments of inertia (I1 < I2 < I3)

        let paused = false;
        let time = 0;
        let flipCount = 0;
        let lastFlipState = 1;
        let currentAxis = 'y';
        let currentShape = 'thandle';

        // Initialize Three.js
        function init() {
            const container = document.getElementById('canvas-container');
            const canvas = document.getElementById('three-canvas');

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050510);

            camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(8, 6, 8);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

            // Lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 10, 7);
            scene.add(directionalLight);

            const pointLight = new THREE.PointLight(0x48dbfb, 0.5, 100);
            pointLight.position.set(-5, 5, -5);
            scene.add(pointLight);

            // Add axis helper
            const axisHelper = new THREE.AxesHelper(4);
            scene.add(axisHelper);

            // Add grid
            const gridHelper = new THREE.GridHelper(10, 10, 0x333355, 0x222244);
            scene.add(gridHelper);

            createObject('thandle');
            resetSimulation();

            window.addEventListener('resize', onWindowResize);
            animate();
        }

        function createObject(type) {
            if (object) {
                scene.remove(object);
            }

            const group = new THREE.Group();

            if (type === 'thandle') {
                // T-handle shape
                const handleGeometry = new THREE.CylinderGeometry(0.15, 0.15, 3, 16);
                const handleMaterial = new THREE.MeshPhongMaterial({
                    color: 0x48dbfb,
                    shininess: 80
                });
                const handle = new THREE.Mesh(handleGeometry, handleMaterial);
                handle.rotation.z = Math.PI / 2;
                group.add(handle);

                const crossbarGeometry = new THREE.CylinderGeometry(0.2, 0.2, 2, 16);
                const crossbarMaterial = new THREE.MeshPhongMaterial({
                    color: 0xfeca57,
                    shininess: 80
                });
                const crossbar = new THREE.Mesh(crossbarGeometry, crossbarMaterial);
                crossbar.position.x = 1.5;
                group.add(crossbar);

                // Add a wing nut at the end for visual interest
                const nutGeometry = new THREE.TorusGeometry(0.3, 0.1, 8, 16);
                const nutMaterial = new THREE.MeshPhongMaterial({ color: 0xff6b6b });
                const nut = new THREE.Mesh(nutGeometry, nutMaterial);
                nut.position.x = -1.5;
                nut.rotation.y = Math.PI / 2;
                group.add(nut);

                I = { x: 1, y: 2.5, z: 4 };

            } else if (type === 'book') {
                // Book shape
                const bookGeometry = new THREE.BoxGeometry(2.5, 0.3, 1.8);
                const bookMaterial = new THREE.MeshPhongMaterial({
                    color: 0x48dbfb,
                    shininess: 50
                });
                const book = new THREE.Mesh(bookGeometry, bookMaterial);
                group.add(book);

                // Spine
                const spineGeometry = new THREE.BoxGeometry(0.1, 0.35, 1.8);
                const spineMaterial = new THREE.MeshPhongMaterial({ color: 0xfeca57 });
                const spine = new THREE.Mesh(spineGeometry, spineMaterial);
                spine.position.x = -1.3;
                group.add(spine);

                // Pages edge
                const edgeGeometry = new THREE.BoxGeometry(2.3, 0.25, 0.05);
                const edgeMaterial = new THREE.MeshPhongMaterial({ color: 0xeeeeee });
                const edge = new THREE.Mesh(edgeGeometry, edgeMaterial);
                edge.position.z = 0.9;
                edge.position.x = 0.1;
                group.add(edge);

                I = { x: 1, y: 3, z: 3.5 };

            } else if (type === 'phone') {
                // Phone/tablet shape
                const phoneGeometry = new THREE.BoxGeometry(0.8, 0.08, 1.6);
                const phoneMaterial = new THREE.MeshPhongMaterial({
                    color: 0x333344,
                    shininess: 100
                });
                const phone = new THREE.Mesh(phoneGeometry, phoneMaterial);
                group.add(phone);

                // Screen
                const screenGeometry = new THREE.BoxGeometry(0.7, 0.01, 1.4);
                const screenMaterial = new THREE.MeshPhongMaterial({
                    color: 0x48dbfb,
                    emissive: 0x48dbfb,
                    emissiveIntensity: 0.3
                });
                const screen = new THREE.Mesh(screenGeometry, screenMaterial);
                screen.position.y = 0.05;
                group.add(screen);

                I = { x: 1, y: 2, z: 2.5 };
            }

            object = group;
            scene.add(object);
            currentShape = type;
        }

        function resetSimulation() {
            time = 0;
            flipCount = 0;
            lastFlipState = 1;

            // Reset quaternion to identity
            quaternion.set(0, 0, 0, 1);

            const speed = parseFloat(document.getElementById('speed').value);
            const perturbation = parseFloat(document.getElementById('perturbation').value) / 100;

            // Set initial angular velocity based on selected axis
            if (currentAxis === 'x') {
                omega = {
                    x: speed,
                    y: speed * perturbation * (Math.random() - 0.5),
                    z: speed * perturbation * (Math.random() - 0.5)
                };
            } else if (currentAxis === 'y') {
                omega = {
                    x: speed * perturbation * (Math.random() - 0.5),
                    y: speed,
                    z: speed * perturbation * (Math.random() - 0.5)
                };
            } else {
                omega = {
                    x: speed * perturbation * (Math.random() - 0.5),
                    y: speed * perturbation * (Math.random() - 0.5),
                    z: speed
                };
            }

            updateDisplay();
        }

        function eulerStep(dt) {
            // Euler's equations for torque-free rotation:
            // I1 * dω1/dt = (I2 - I3) * ω2 * ω3
            // I2 * dω2/dt = (I3 - I1) * ω3 * ω1
            // I3 * dω3/dt = (I1 - I2) * ω1 * ω2

            const domega = {
                x: ((I.y - I.z) * omega.y * omega.z) / I.x,
                y: ((I.z - I.x) * omega.z * omega.x) / I.y,
                z: ((I.x - I.y) * omega.x * omega.y) / I.z
            };

            // RK4 integration for better accuracy
            const k1 = { ...domega };

            const omega2 = {
                x: omega.x + k1.x * dt/2,
                y: omega.y + k1.y * dt/2,
                z: omega.z + k1.z * dt/2
            };
            const k2 = {
                x: ((I.y - I.z) * omega2.y * omega2.z) / I.x,
                y: ((I.z - I.x) * omega2.z * omega2.x) / I.y,
                z: ((I.x - I.y) * omega2.x * omega2.y) / I.z
            };

            const omega3 = {
                x: omega.x + k2.x * dt/2,
                y: omega.y + k2.y * dt/2,
                z: omega.z + k2.z * dt/2
            };
            const k3 = {
                x: ((I.y - I.z) * omega3.y * omega3.z) / I.x,
                y: ((I.z - I.x) * omega3.z * omega3.x) / I.y,
                z: ((I.x - I.y) * omega3.x * omega3.y) / I.z
            };

            const omega4 = {
                x: omega.x + k3.x * dt,
                y: omega.y + k3.y * dt,
                z: omega.z + k3.z * dt
            };
            const k4 = {
                x: ((I.y - I.z) * omega4.y * omega4.z) / I.x,
                y: ((I.z - I.x) * omega4.z * omega4.x) / I.y,
                z: ((I.x - I.y) * omega4.x * omega4.y) / I.z
            };

            omega.x += (k1.x + 2*k2.x + 2*k3.x + k4.x) * dt / 6;
            omega.y += (k1.y + 2*k2.y + 2*k3.y + k4.y) * dt / 6;
            omega.z += (k1.z + 2*k2.z + 2*k3.z + k4.z) * dt / 6;

            // Update quaternion based on angular velocity
            // dq/dt = 0.5 * omega * q (quaternion multiplication)
            const omegaMag = Math.sqrt(omega.x*omega.x + omega.y*omega.y + omega.z*omega.z);
            if (omegaMag > 0.0001) {
                const halfAngle = omegaMag * dt / 2;
                const s = Math.sin(halfAngle) / omegaMag;
                const deltaQ = new THREE.Quaternion(
                    omega.x * s,
                    omega.y * s,
                    omega.z * s,
                    Math.cos(halfAngle)
                );
                quaternion.premultiply(deltaQ);
                quaternion.normalize();
            }
        }

        function detectFlip() {
            // Get the local Y axis in world coordinates
            const yAxis = new THREE.Vector3(0, 1, 0);
            yAxis.applyQuaternion(quaternion);

            // Check if the Y axis has flipped (dot product with world Y)
            const currentState = Math.sign(yAxis.y);

            if (currentState !== 0 && currentState !== lastFlipState) {
                flipCount++;
                lastFlipState = currentState;
                document.getElementById('flip-count').textContent = flipCount;
            }
        }

        function updateDisplay() {
            // Calculate conserved quantities
            const energy = 0.5 * (I.x * omega.x * omega.x + I.y * omega.y * omega.y + I.z * omega.z * omega.z);
            const Lx = I.x * omega.x;
            const Ly = I.y * omega.y;
            const Lz = I.z * omega.z;
            const L = Math.sqrt(Lx*Lx + Ly*Ly + Lz*Lz);

            document.getElementById('energy-display').textContent = energy.toFixed(2);
            document.getElementById('momentum-display').textContent = L.toFixed(2);
            document.getElementById('time-display').textContent = time.toFixed(1) + 's';

            // Update angular velocity bars
            const maxOmega = 15;
            const absOmegaX = Math.abs(omega.x);
            const absOmegaY = Math.abs(omega.y);
            const absOmegaZ = Math.abs(omega.z);

            document.getElementById('omega-x-bar').style.width = Math.min(absOmegaX / maxOmega * 100, 100) + '%';
            document.getElementById('omega-y-bar').style.width = Math.min(absOmegaY / maxOmega * 100, 100) + '%';
            document.getElementById('omega-z-bar').style.width = Math.min(absOmegaZ / maxOmega * 100, 100) + '%';

            document.getElementById('omega-x-val').textContent = omega.x.toFixed(2);
            document.getElementById('omega-y-val').textContent = omega.y.toFixed(2);
            document.getElementById('omega-z-val').textContent = omega.z.toFixed(2);
        }

        function animate() {
            requestAnimationFrame(animate);

            if (!paused) {
                const dt = 0.016; // Fixed timestep for consistency
                const substeps = 4;

                for (let i = 0; i < substeps; i++) {
                    eulerStep(dt / substeps);
                }

                time += dt;
                detectFlip();
                updateDisplay();
            }

            if (object) {
                object.quaternion.copy(quaternion);
            }

            renderer.render(scene, camera);
        }

        function onWindowResize() {
            const container = document.getElementById('canvas-container');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        // Event listeners
        document.getElementById('btn-x').addEventListener('click', function() {
            currentAxis = 'x';
            document.querySelectorAll('.btn-group .btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            resetSimulation();
        });

        document.getElementById('btn-y').addEventListener('click', function() {
            currentAxis = 'y';
            document.querySelectorAll('.btn-group .btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            resetSimulation();
        });

        document.getElementById('btn-z').addEventListener('click', function() {
            currentAxis = 'z';
            document.querySelectorAll('.btn-group .btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            resetSimulation();
        });

        document.getElementById('btn-thandle').addEventListener('click', function() {
            document.querySelectorAll('.control-group:nth-child(2) .btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            createObject('thandle');
            resetSimulation();
        });

        document.getElementById('btn-book').addEventListener('click', function() {
            document.querySelectorAll('.control-group:nth-child(2) .btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            createObject('book');
            resetSimulation();
        });

        document.getElementById('btn-phone').addEventListener('click', function() {
            document.querySelectorAll('.control-group:nth-child(2) .btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            createObject('phone');
            resetSimulation();
        });

        document.getElementById('btn-reset').addEventListener('click', resetSimulation);

        document.getElementById('btn-pause').addEventListener('click', function() {
            paused = !paused;
            this.textContent = paused ? 'Resume' : 'Pause';
            this.classList.toggle('active', paused);
        });

        document.getElementById('perturbation').addEventListener('input', function() {
            document.getElementById('pert-value').textContent = this.value;
        });

        document.getElementById('speed').addEventListener('input', function() {
            document.getElementById('speed-value').textContent = this.value;
        });

        // Initialize
        init();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
