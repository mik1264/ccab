<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shear Thickening Fluids - Walk on Water | Surprising Paradoxes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
            color: #e8e8e8;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #81c784;
            text-decoration: none;
            font-size: 14px;
            z-index: 1000;
            padding: 8px 16px;
            background: rgba(26, 26, 26, 0.9);
            border-radius: 20px;
            border: 1px solid rgba(129, 199, 132, 0.3);
            transition: all 0.3s ease;
        }

        .back-link:hover {
            background: rgba(129, 199, 132, 0.2);
            border-color: #81c784;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 80px 20px 40px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, #81c784, #aed581, #c5e1a5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #a5d6a7;
            font-size: 1.2em;
            font-style: italic;
        }

        .paradox-box {
            background: linear-gradient(135deg, rgba(129, 199, 132, 0.15), rgba(174, 213, 129, 0.1));
            border: 2px solid rgba(129, 199, 132, 0.4);
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
            text-align: center;
        }

        .paradox-box h3 {
            color: #aed581;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        .paradox-box p {
            font-size: 1.15em;
            line-height: 1.7;
            color: #c8e6c9;
        }

        .simulation-area {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 30px;
            margin: 40px 0;
        }

        @media (max-width: 1000px) {
            .simulation-area {
                grid-template-columns: 1fr;
            }
        }

        .canvas-container {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(129, 199, 132, 0.2);
        }

        canvas {
            display: block;
            width: 100%;
            border-radius: 10px;
            cursor: pointer;
        }

        .instruction {
            text-align: center;
            color: #a5d6a7;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .controls {
            background: rgba(26, 26, 26, 0.8);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(129, 199, 132, 0.2);
        }

        .controls h3 {
            color: #81c784;
            margin-bottom: 20px;
            font-size: 1.2em;
            border-bottom: 1px solid rgba(129, 199, 132, 0.3);
            padding-bottom: 10px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            color: #a5d6a7;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .control-group input[type="range"] {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            background: linear-gradient(90deg, #2e7d32, #43a047, #66bb6a);
            border-radius: 4px;
            outline: none;
        }

        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #aed581;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(174, 213, 129, 0.5);
        }

        .mode-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .mode-btn {
            padding: 12px 8px;
            font-size: 0.85em;
            border: 1px solid rgba(129, 199, 132, 0.5);
            background: rgba(26, 26, 26, 0.8);
            color: #e8e8e8;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, rgba(129, 199, 132, 0.3), rgba(174, 213, 129, 0.2));
            border-color: #aed581;
        }

        .mode-btn:hover {
            background: rgba(129, 199, 132, 0.2);
        }

        .viscosity-display {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            text-align: center;
        }

        .viscosity-label {
            color: #81c784;
            font-size: 0.85em;
            margin-bottom: 5px;
        }

        .viscosity-value {
            font-size: 2em;
            font-weight: bold;
            transition: color 0.3s ease;
        }

        .viscosity-value.liquid {
            color: #64b5f6;
        }

        .viscosity-value.thickening {
            color: #ffb74d;
        }

        .viscosity-value.solid {
            color: #ef5350;
        }

        .stats-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(129, 199, 132, 0.1);
            font-size: 0.9em;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #81c784;
        }

        .stat-value {
            color: #aed581;
            font-weight: bold;
        }

        .essay {
            background: rgba(26, 26, 26, 0.6);
            border-radius: 15px;
            padding: 40px;
            margin-top: 40px;
            line-height: 1.9;
        }

        .essay h2 {
            color: #81c784;
            margin: 30px 0 20px;
            font-size: 1.5em;
        }

        .essay h2:first-child {
            margin-top: 0;
        }

        .essay p {
            margin-bottom: 20px;
            color: #c8e6c9;
            text-align: justify;
        }

        .essay strong {
            color: #aed581;
        }

        .essay em {
            color: #a5d6a7;
            font-style: italic;
        }

        .highlight-stat {
            display: inline-block;
            background: linear-gradient(135deg, rgba(174, 213, 129, 0.2), rgba(129, 199, 132, 0.2));
            padding: 2px 10px;
            border-radius: 4px;
            color: #c5e1a5;
            font-weight: bold;
        }

        .comparison-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 30px 0;
        }

        @media (max-width: 768px) {
            .comparison-cards {
                grid-template-columns: 1fr;
            }
        }

        .comparison-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(129, 199, 132, 0.2);
        }

        .comparison-card h4 {
            color: #81c784;
            margin-bottom: 10px;
        }

        .comparison-card p {
            font-size: 0.9em;
            color: #9e9e9e;
            margin: 0;
        }

        .comparison-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        footer {
            text-align: center;
            padding: 40px 20px;
            color: #4caf50;
            font-size: 0.9em;
        }

        footer a {
            color: #81c784;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Paradoxes</a>

    <div class="container">
        <header>
            <h1>ü•£ Shear Thickening Fluids</h1>
            <p class="subtitle">Punch It and It Turns to Stone</p>
        </header>

        <div class="paradox-box">
            <h3>üíß‚û°Ô∏èü™® The Oobleck Paradox</h3>
            <p>
                Mix cornstarch and water. Stir it slowly‚Äîit flows like a liquid. Now <strong>punch it</strong>‚Äî
                it instantly becomes solid, hard enough to hurt your hand. You can <strong>walk across a pool</strong>
                of this mixture if you run, but the moment you stop moving, you sink. The faster you hit it,
                the harder it gets. This isn't magic‚Äîit's <em>impact-activated solidification</em>.
            </p>
        </div>

        <div class="simulation-area">
            <div class="canvas-container">
                <canvas id="oobleckCanvas"></canvas>
                <p class="instruction">üëÜ Click/tap to poke ‚Ä¢ Hold and drag to stir slowly ‚Ä¢ Click fast to punch!</p>
            </div>

            <div class="controls">
                <h3>üß™ Mixture Controls</h3>

                <div class="control-group">
                    <label>Starch Concentration: <span id="concValue">60</span>%</label>
                    <input type="range" id="concSlider" min="40" max="70" value="60">
                </div>

                <div class="control-group">
                    <label>Particle Friction: <span id="frictionValue">0.8</span></label>
                    <input type="range" id="frictionSlider" min="0.3" max="1.0" step="0.1" value="0.8">
                </div>

                <div class="control-group">
                    <label>Interaction Mode</label>
                    <div class="mode-buttons">
                        <button class="mode-btn active" data-mode="poke">üëÜ Poke</button>
                        <button class="mode-btn" data-mode="punch">üëä Punch</button>
                        <button class="mode-btn" data-mode="stir">ü•Ñ Stir</button>
                        <button class="mode-btn" data-mode="walk">üö∂ Walk</button>
                    </div>
                </div>

                <div class="viscosity-display">
                    <div class="viscosity-label">Current Viscosity</div>
                    <div class="viscosity-value liquid" id="viscosityValue">~10 Pa¬∑s</div>
                </div>

                <div class="stats-panel">
                    <div class="stat-row">
                        <span class="stat-label">Shear Rate</span>
                        <span class="stat-value" id="shearRate">0 s‚Åª¬π</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Impact Force</span>
                        <span class="stat-value" id="impactForce">0 N</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Particle State</span>
                        <span class="stat-value" id="particleState">Suspended</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Fluid Behavior</span>
                        <span class="stat-value" id="fluidBehavior">Newtonian</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="essay">
            <h2>The Dr. Seuss Fluid</h2>
            <p>
                In 1949, Dr. Seuss published <em>Bartholomew and the Oobleck</em>, a story about a
                sticky green substance falling from the sky. Today, "oobleck" refers to one of the
                most counterintuitive materials you can make in your kitchen: a mixture of
                <strong>cornstarch and water</strong> (roughly 2 parts starch to 1 part water).
                This humble mixture defies our intuitions about how liquids behave. Pour it, and
                it flows. Punch it, and it's like hitting concrete. The harder you try to move
                through it, the more it resists.
            </p>

            <h2>Newtonian vs. Non-Newtonian</h2>
            <p>
                Most fluids we encounter are <strong>Newtonian</strong>‚Äînamed after Isaac Newton,
                who described how "normal" fluids behave. Water, oil, honey: their viscosity
                (resistance to flow) stays constant regardless of how fast you stir them. Honey
                is thick, water is thin, but neither changes its fundamental nature based on how
                you interact with it. <em>Non-Newtonian fluids</em> break this rule. Their viscosity
                depends on the <strong>shear rate</strong>‚Äîhow fast you're trying to deform them.
                Oobleck is <em>shear-thickening</em>: increase the shear rate, and viscosity
                skyrockets by <span class="highlight-stat">100x or more</span>.
            </p>

            <div class="comparison-cards">
                <div class="comparison-card">
                    <div class="comparison-icon">üçØ</div>
                    <h4>Newtonian (Honey)</h4>
                    <p>Viscosity stays constant. Stir fast or slow‚Äîsame resistance. Just thick liquid.</p>
                </div>
                <div class="comparison-card">
                    <div class="comparison-icon">üé®</div>
                    <h4>Shear-Thinning (Paint)</h4>
                    <p>Gets thinner when stirred. Flows easily when brushed, stays put when still.</p>
                </div>
                <div class="comparison-card">
                    <div class="comparison-icon">ü•£</div>
                    <h4>Shear-Thickening (Oobleck)</h4>
                    <p>Gets thicker under force. Liquid at rest, solid under impact. Defies intuition!</p>
                </div>
            </div>

            <h2>The Mechanism: Friction and Jamming</h2>
            <p>
                For decades, scientists debated why oobleck behaves so strangely. The answer,
                confirmed by researchers at Cornell and the University of Chicago, comes down to
                <strong>friction between particles</strong>. At low starch concentrations, water
                lubricates the cornstarch particles, allowing them to slide past each other freely.
                But at high concentrations (~60%), when you apply sudden force, the particles
                <em>jam together</em>. Their rough surfaces interlock, forming rigid chains held
                by friction. The mixture essentially "grows its own solid" at the point of impact.
            </p>

            <h2>Impact-Activated Solidification</h2>
            <p>
                When you drive a rod into oobleck, something remarkable happens. A <strong>solidification
                front</strong> propagates ahead of the impacting object‚Äîlike a snow plow pushing
                a denser region of snow. This front transforms the liquid suspension into a temporarily
                jammed state. University of Chicago researchers found that impact generates stresses
                <span class="highlight-stat">100 times greater</span> than those from simple stirring.
                The faster the impact, the faster and larger the solidification front grows. This
                is why you can run across a pool of oobleck but sink if you stand still‚Äîeach footstep
                creates a temporary solid platform, but only while force is being applied.
            </p>

            <h2>Walking on Oobleck</h2>
            <p>
                Videos of people running across pools of oobleck look like miracles‚Äîhumans apparently
                walking on water. The physics is precise: each footstep must apply enough force,
                quickly enough, to trigger the shear-thickening response. The moment you slow down
                or stop, the particles unjam, the friction forces dissipate, and you sink into
                liquid. It's a race between your next step and the relaxation time of the fluid.
                Stand still for even a second, and you're knee-deep in goo.
            </p>

            <h2>Real-World Applications</h2>
            <p>
                Beyond kitchen experiments, shear-thickening fluids have serious applications.
                <strong>Body armor</strong> made with STF-impregnated Kevlar is more flexible than
                traditional armor but hardens instantly upon bullet impact. <strong>Speed bumps</strong>
                filled with shear-thickening fluid are soft for slow-moving vehicles but rigid for
                speeders. <strong>Protective gear</strong> for athletes and workers uses the same
                principle‚Äîflexible during normal movement, rigid during impacts. The same counterintuitive
                physics that lets you punch a bowl of goo is being engineered to save lives.
            </p>
        </div>

        <footer>
            <p>
                Sources:
                <a href="https://www.scientificamerican.com/article/friction-makes-cornstarch-and-water-into-bizarre-oobleck/">Scientific American</a> |
                <a href="https://news.cornell.edu/stories/2015/11/secret-oobleck-revealed-last">Cornell Chronicle</a> |
                <a href="https://news.uchicago.edu/story/messy-experiment-cleans-physics-mystery-cornstarch">UChicago News</a>
            </p>
        </footer>
    </div>

    <script>
        const canvas = document.getElementById('oobleckCanvas');
        const ctx = canvas.getContext('2d');
        const dpr = window.devicePixelRatio || 1;

        let concentration = 60;
        let particleFriction = 0.8;
        let interactionMode = 'poke';
        let time = 0;

        // Particles
        let particles = [];
        const PARTICLE_COUNT = 800;

        // Interaction state
        let mousePos = null;
        let lastMousePos = null;
        let mouseVelocity = 0;
        let isMouseDown = false;
        let currentViscosity = 10;
        let shearRate = 0;
        let impactForce = 0;

        // Walking simulation
        let walker = null;

        function resizeCanvas() {
            const rect = canvas.parentElement.getBoundingClientRect();
            const size = rect.width - 40;
            canvas.width = size * dpr;
            canvas.height = size * 0.7 * dpr;
            canvas.style.width = size + 'px';
            canvas.style.height = size * 0.7 + 'px';
            ctx.scale(dpr, dpr);
            initParticles();
        }

        resizeCanvas();
        window.addEventListener('resize', () => {
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            resizeCanvas();
        });

        class Particle {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.baseX = x;
                this.baseY = y;
                this.vx = 0;
                this.vy = 0;
                this.size = 3 + Math.random() * 4;
                this.jammed = false;
                this.jamStrength = 0;
            }

            update(w, h) {
                // Return to base position (suspension equilibrium)
                const returnForce = 0.02;
                this.vx += (this.baseX - this.x) * returnForce;
                this.vy += (this.baseY - this.y) * returnForce;

                // Random Brownian motion when not jammed
                if (!this.jammed) {
                    this.vx += (Math.random() - 0.5) * 0.5;
                    this.vy += (Math.random() - 0.5) * 0.5;
                }

                // Damping
                const damping = this.jammed ? 0.7 : 0.95;
                this.vx *= damping;
                this.vy *= damping;

                // Update position
                if (!this.jammed || this.jamStrength < 0.5) {
                    this.x += this.vx;
                    this.y += this.vy;
                }

                // Boundaries
                if (this.x < this.size) { this.x = this.size; this.vx *= -0.5; }
                if (this.x > w - this.size) { this.x = w - this.size; this.vx *= -0.5; }
                if (this.y < this.size) { this.y = this.size; this.vy *= -0.5; }
                if (this.y > h - this.size) { this.y = h - this.size; this.vy *= -0.5; }

                // Decay jam state
                this.jamStrength *= 0.95;
                if (this.jamStrength < 0.1) this.jammed = false;
            }

            draw(ctx) {
                const baseColor = this.jammed ?
                    `rgba(255, ${180 - this.jamStrength * 100}, ${100 - this.jamStrength * 50}, 0.9)` :
                    `rgba(245, 245, 220, 0.7)`;

                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = baseColor;
                ctx.fill();

                // Friction chains when jammed
                if (this.jammed && this.jamStrength > 0.3) {
                    ctx.strokeStyle = `rgba(139, 119, 101, ${this.jamStrength * 0.5})`;
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size + 2, 0, Math.PI * 2);
                    ctx.stroke();
                }
            }
        }

        function initParticles() {
            const w = canvas.width / dpr;
            const h = canvas.height / dpr;
            particles = [];

            for (let i = 0; i < PARTICLE_COUNT; i++) {
                const x = Math.random() * w;
                const y = Math.random() * h;
                particles.push(new Particle(x, y));
            }
        }

        function applyForce(x, y, force, radius) {
            const w = canvas.width / dpr;
            const h = canvas.height / dpr;

            // Calculate shear rate and viscosity response
            shearRate = force * 10;
            const thickeningThreshold = (100 - concentration) * 2;

            // Non-Newtonian response: viscosity increases with shear rate above threshold
            if (shearRate > thickeningThreshold) {
                const excess = shearRate - thickeningThreshold;
                currentViscosity = 10 + excess * particleFriction * 50;
                impactForce = force * currentViscosity * 0.1;
            } else {
                currentViscosity = 10;
                impactForce = force * 0.5;
            }

            // Apply force to particles
            particles.forEach(p => {
                const dx = p.x - x;
                const dy = p.y - y;
                const dist = Math.sqrt(dx * dx + dy * dy);

                if (dist < radius) {
                    const influence = 1 - dist / radius;

                    // Check if should jam
                    if (force > thickeningThreshold && concentration > 50) {
                        // Jam particles under high shear
                        p.jammed = true;
                        p.jamStrength = Math.min(1, influence * force * 0.05 * particleFriction);

                        // Solidification front - particles barely move when jammed
                        p.vx *= (1 - p.jamStrength);
                        p.vy *= (1 - p.jamStrength);
                    } else {
                        // Normal liquid displacement
                        const pushForce = influence * force * 0.3 / Math.max(1, currentViscosity * 0.1);
                        p.vx += (dx / dist) * pushForce;
                        p.vy += (dy / dist) * pushForce;
                    }
                }
            });
        }

        function drawFluid(w, h) {
            // Base fluid color
            const fluidColor = `rgba(230, 225, 200, 0.4)`;
            ctx.fillStyle = fluidColor;
            ctx.fillRect(0, 0, w, h);

            // Surface ripples
            ctx.strokeStyle = 'rgba(200, 195, 170, 0.3)';
            ctx.lineWidth = 1;
            for (let i = 0; i < 5; i++) {
                const y = h * 0.1 + Math.sin(time * 0.02 + i) * 5;
                ctx.beginPath();
                ctx.moveTo(0, y + i * 10);
                for (let x = 0; x < w; x += 20) {
                    ctx.lineTo(x, y + i * 10 + Math.sin(x * 0.05 + time * 0.03) * 3);
                }
                ctx.stroke();
            }
        }

        function drawWalker(w, h) {
            if (!walker) return;

            // Draw footprints with solidification zones
            ctx.fillStyle = walker.sinking ?
                'rgba(139, 119, 101, 0.6)' :
                'rgba(100, 200, 100, 0.4)';

            ctx.beginPath();
            ctx.ellipse(walker.x, walker.y, 20, 30, 0, 0, Math.PI * 2);
            ctx.fill();

            // Solidification ring when stepping
            if (!walker.sinking) {
                ctx.strokeStyle = 'rgba(200, 150, 100, 0.5)';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(walker.x, walker.y, 40 + Math.sin(time * 0.2) * 5, 0, Math.PI * 2);
                ctx.stroke();
            }

            // Status text
            ctx.fillStyle = walker.sinking ? '#ef5350' : '#81c784';
            ctx.font = 'bold 14px Georgia';
            ctx.textAlign = 'center';
            ctx.fillText(walker.sinking ? '‚¨áÔ∏è SINKING!' : '‚úì SOLID', walker.x, walker.y - 50);
        }

        function updateStats() {
            // Viscosity display
            const viscEl = document.getElementById('viscosityValue');
            if (currentViscosity < 50) {
                viscEl.textContent = '~' + Math.round(currentViscosity) + ' Pa¬∑s';
                viscEl.className = 'viscosity-value liquid';
            } else if (currentViscosity < 500) {
                viscEl.textContent = '~' + Math.round(currentViscosity) + ' Pa¬∑s';
                viscEl.className = 'viscosity-value thickening';
            } else {
                viscEl.textContent = '>' + Math.round(currentViscosity) + ' Pa¬∑s';
                viscEl.className = 'viscosity-value solid';
            }

            document.getElementById('shearRate').textContent = Math.round(shearRate) + ' s‚Åª¬π';
            document.getElementById('impactForce').textContent = impactForce.toFixed(1) + ' N';

            const jammedCount = particles.filter(p => p.jammed).length;
            document.getElementById('particleState').textContent =
                jammedCount > 100 ? 'Jammed!' : jammedCount > 20 ? 'Partial Jam' : 'Suspended';

            document.getElementById('fluidBehavior').textContent =
                currentViscosity > 100 ? 'Solid-like' :
                currentViscosity > 30 ? 'Thickening' : 'Liquid';

            // Decay values
            shearRate *= 0.9;
            impactForce *= 0.9;
            if (shearRate < 1) currentViscosity = 10 + (currentViscosity - 10) * 0.95;
        }

        function draw() {
            const w = canvas.width / dpr;
            const h = canvas.height / dpr;

            // Clear
            ctx.fillStyle = '#8b7355';
            ctx.fillRect(0, 0, w, h);

            // Draw container
            ctx.fillStyle = '#5d4e37';
            ctx.fillRect(0, 0, w, 10);
            ctx.fillRect(0, h - 10, w, 10);
            ctx.fillRect(0, 0, 10, h);
            ctx.fillRect(w - 10, 0, 10, h);

            // Draw fluid
            drawFluid(w, h);

            // Update and draw particles
            particles.forEach(p => {
                p.update(w, h);
                p.draw(ctx);
            });

            // Draw walker if in walk mode
            if (interactionMode === 'walk') {
                drawWalker(w, h);
            }

            // Mouse interaction visualization
            if (mousePos && isMouseDown) {
                const radius = interactionMode === 'punch' ? 60 : 30;
                ctx.beginPath();
                ctx.arc(mousePos.x, mousePos.y, radius, 0, Math.PI * 2);
                ctx.strokeStyle = currentViscosity > 100 ?
                    'rgba(255, 100, 100, 0.8)' :
                    'rgba(100, 200, 255, 0.5)';
                ctx.lineWidth = 2;
                ctx.stroke();
            }

            updateStats();
            time++;
            requestAnimationFrame(draw);
        }

        // Mouse/touch handlers
        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = (canvas.width / dpr) / rect.width;
            const scaleY = (canvas.height / dpr) / rect.height;

            if (e.touches) {
                return {
                    x: (e.touches[0].clientX - rect.left) * scaleX,
                    y: (e.touches[0].clientY - rect.top) * scaleY
                };
            }
            return {
                x: (e.clientX - rect.left) * scaleX,
                y: (e.clientY - rect.top) * scaleY
            };
        }

        function handleInteraction() {
            if (!mousePos || !isMouseDown) return;

            // Calculate velocity
            if (lastMousePos) {
                const dx = mousePos.x - lastMousePos.x;
                const dy = mousePos.y - lastMousePos.y;
                mouseVelocity = Math.sqrt(dx * dx + dy * dy);
            }

            let force, radius;

            switch (interactionMode) {
                case 'poke':
                    force = 5 + mouseVelocity * 2;
                    radius = 40;
                    break;
                case 'punch':
                    force = 50 + mouseVelocity * 5;
                    radius = 80;
                    break;
                case 'stir':
                    force = 2 + mouseVelocity * 0.5;
                    radius = 50;
                    break;
                case 'walk':
                    // Walking simulation
                    if (!walker) {
                        walker = { x: mousePos.x, y: mousePos.y, sinking: false, standTime: 0 };
                    }
                    walker.x = mousePos.x;
                    walker.y = mousePos.y;

                    if (mouseVelocity < 2) {
                        walker.standTime++;
                        if (walker.standTime > 30) walker.sinking = true;
                    } else {
                        walker.standTime = 0;
                        walker.sinking = false;
                    }

                    force = walker.sinking ? 3 : 40;
                    radius = 60;
                    break;
            }

            applyForce(mousePos.x, mousePos.y, force, radius);
            lastMousePos = { ...mousePos };
        }

        canvas.addEventListener('mousedown', (e) => {
            isMouseDown = true;
            mousePos = getMousePos(e);
            lastMousePos = mousePos;
            if (interactionMode === 'walk') {
                walker = { x: mousePos.x, y: mousePos.y, sinking: false, standTime: 0 };
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            mousePos = getMousePos(e);
            if (isMouseDown) handleInteraction();
        });

        canvas.addEventListener('mouseup', () => {
            isMouseDown = false;
            lastMousePos = null;
            if (interactionMode === 'walk') walker = null;
        });

        canvas.addEventListener('mouseleave', () => {
            isMouseDown = false;
            lastMousePos = null;
            if (interactionMode === 'walk') walker = null;
        });

        // Touch support
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            isMouseDown = true;
            mousePos = getMousePos(e);
            lastMousePos = mousePos;
        });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            mousePos = getMousePos(e);
            if (isMouseDown) handleInteraction();
        });

        canvas.addEventListener('touchend', () => {
            isMouseDown = false;
            lastMousePos = null;
            if (interactionMode === 'walk') walker = null;
        });

        // Control listeners
        document.getElementById('concSlider').addEventListener('input', (e) => {
            concentration = parseInt(e.target.value);
            document.getElementById('concValue').textContent = concentration;
        });

        document.getElementById('frictionSlider').addEventListener('input', (e) => {
            particleFriction = parseFloat(e.target.value);
            document.getElementById('frictionValue').textContent = particleFriction;
        });

        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                interactionMode = btn.dataset.mode;
                walker = null;
            });
        });

        // Initialize
        initParticles();
        draw();
    </script>
</body>
</html>
