<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSA Crypto Visualizer - CCAB</title>
    <link rel="stylesheet" href="../assets/css/gallery-standard.css">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body {
            background: #fdf6e3;
            color: #586e75;
            font-family: 'Cambria', serif;
            padding: 2rem;
        }
        .container { max-width: 900px; margin: 0 auto; }
        
        .step-container {
            background: #eee8d5;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 4px;
            border-left: 5px solid #b58900;
        }
        
        h2 { margin-top: 0; color: #b58900; }
        
        .math-block {
            background: #fdf6e3;
            padding: 15px;
            border: 1px solid #d3cbb7;
            margin: 10px 0;
            font-size: 1.2rem;
            text-align: center;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        
        input { padding: 5px; width: 60px; text-align: center; font-size: 1.1rem; }
        button { padding: 8px 16px; cursor: pointer; background: #268bd2; color: white; border: none; font-size: 1rem; }
        
        .highlight { color: #dc322f; font-weight: bold; }
        
        .viz-circle {
            width: 300px;
            height: 300px;
            border-radius: 50%;
            border: 2px solid #93a1a1;
            margin: 20px auto;
            position: relative;
        }
        
        .point {
            width: 8px; height: 8px; background: #586e75; border-radius: 50%;
            position: absolute; transform: translate(-50%, -50%);
        }
        .point.active { background: #dc322f; width: 12px; height: 12px; }
        
    </style>
</head>
<body>

<div class="container">
    <a href="../index.html" class="gallery-back">‚Üê Back to Gallery</a>
    <h1>Public Key Cryptography (RSA)</h1>
    <p>Step-by-step visualization of Key Generation, Encryption, and Decryption using small prime numbers.</p>

    <!-- Step 1: Key Gen -->
    <div class="step-container">
        <h2>1. Key Generation</h2>
        <p>Choose two distinct prime numbers \( p \) and \( q \).</p>
        <div class="controls">
            <label>p = <input type="number" id="p-in" value="11"></label>
            <label>q = <input type="number" id="q-in" value="13"></label>
            <button onclick="generateKeys()">Generate Keys</button>
        </div>
        <div id="keygen-output" style="display:none">
            <div class="math-block">
                \( n = p \times q = \) <span id="n-val" class="highlight">143</span><br>
                \( \phi(n) = (p-1)(q-1) = \) <span id="phi-val">120</span>
            </div>
            <p>Choose \( e \) such that \( 1 < e < \phi(n) \) and \( \gcd(e, \phi(n)) = 1 \).</p>
            <div class="controls">
                <label>e = <input type="number" id="e-in" value="7"></label>
                <button onclick="checkE()">Set Public Key (n, e)</button>
            </div>
            <p id="e-status"></p>
            
            <div id="d-calc" style="display:none">
                <p>Calculate \( d \) (Private Key) such that \( d \cdot e \equiv 1 \pmod{\phi(n)} \).</p>
                <div class="math-block">
                    \( d = \) <span id="d-val" class="highlight">103</span>
                </div>
                <p><strong>Public Key:</strong> (<span class="n-display">143</span>, <span class="e-display">7</span>)<br>
                <strong>Private Key:</strong> (<span class="n-display">143</span>, <span class="d-display">103</span>)</p>
            </div>
        </div>
    </div>

    <!-- Step 2: Encryption -->
    <div class="step-container" id="encrypt-step" style="display:none">
        <h2>2. Encryption</h2>
        <p>Enter a message \( m \) (number less than \( n \)).</p>
        <div class="controls">
            <label>m = <input type="number" id="m-in" value="9"></label>
            <button onclick="encrypt()">Encrypt</button>
        </div>
        <div class="math-block" id="enc-res" style="display:none">
            \( c = m^e \pmod n \)<br>
            \( c = 9^7 \pmod{143} = \) <span id="c-val" class="highlight">48</span>
        </div>
        <div id="pow-viz"></div>
    </div>

    <!-- Step 3: Decryption -->
    <div class="step-container" id="decrypt-step" style="display:none">
        <h2>3. Decryption</h2>
        <p>Using private key \( d \) to recover message.</p>
        <button onclick="decrypt()">Decrypt</button>
        <div class="math-block" id="dec-res" style="display:none">
            \( m = c^d \pmod n \)<br>
            \( m = 48^{103} \pmod{143} = \) <span id="m-rec-val" class="highlight">9</span>
        </div>
    </div>

</div>

<script>
    // Variables
    let p, q, n, phi, e, d;

    // Utils
    function gcd(a, b) {
        while (b) { [a, b] = [b, a % b]; }
        return a;
    }

    function modInverse(a, m) {
        // Extended Euclidean Algorithm
        let m0 = m, y = 0, x = 1;
        if (m === 1) return 0;
        while (a > 1) {
            let q = Math.floor(a / m);
            let t = m;
            m = a % m; a = t;
            t = y;
            y = x - q * y;
            x = t;
        }
        if (x < 0) x += m0;
        return x;
    }

    // Modular Exponentiation: (base^exp) % mod
    function power(base, exp, mod) {
        let res = 1n;
        let b = BigInt(base);
        let e = BigInt(exp);
        let m = BigInt(mod);
        
        while (e > 0n) {
            if (e % 2n === 1n) res = (res * b) % m;
            b = (b * b) % m;
            e /= 2n;
        }
        return Number(res);
    }

    function generateKeys() {
        p = parseInt(document.getElementById('p-in').value);
        q = parseInt(document.getElementById('q-in').value);
        
        if (!isPrime(p) || !isPrime(q)) {
            alert("p and q must be prime numbers!");
            return;
        }
        if (p === q) {
            alert("p and q must be distinct!");
            return;
        }

        n = p * q;
        phi = (p - 1) * (q - 1);

        document.getElementById('n-val').innerText = n;
        document.getElementById('phi-val').innerText = phi;
        document.getElementById('keygen-output').style.display = 'block';
        
        document.querySelectorAll('.n-display').forEach(el => el.innerText = n);
    }
    
    function isPrime(num) {
        for(let i = 2, s = Math.sqrt(num); i <= s; i++)
            if(num % i === 0) return false;
        return num > 1;
    }

    function checkE() {
        e = parseInt(document.getElementById('e-in').value);
        if (e <= 1 || e >= phi) {
            document.getElementById('e-status').innerText = `Invalid e. Must be 1 < e < ${phi}`;
            return;
        }
        if (gcd(e, phi) !== 1) {
            document.getElementById('e-status').innerText = `Invalid e. gcd(${e}, ${phi}) is not 1.`;
            return;
        }
        
        document.getElementById('e-status').innerText = "e is valid!";
        
        // Calc D
        d = modInverse(e, phi);
        document.getElementById('d-val').innerText = d;
        document.querySelectorAll('.e-display').forEach(el => el.innerText = e);
        document.querySelectorAll('.d-display').forEach(el => el.innerText = d);
        
        document.getElementById('d-calc').style.display = 'block';
        document.getElementById('encrypt-step').style.display = 'block';
    }

    function encrypt() {
        const m = parseInt(document.getElementById('m-in').value);
        if (m >= n) {
            alert(`Message m must be less than n (${n})`);
            return;
        }
        
        const c = power(m, e, n);
        document.getElementById('c-val').innerText = c;
        document.getElementById('enc-res').style.display = 'block';
        document.getElementById('decrypt-step').style.display = 'block';
    }

    function decrypt() {
        const c = parseInt(document.getElementById('c-val').innerText);
        const m = power(c, d, n);
        document.getElementById('m-rec-val').innerText = m;
        document.getElementById('dec-res').style.display = 'block';
    }

</script>
</body>
</html>