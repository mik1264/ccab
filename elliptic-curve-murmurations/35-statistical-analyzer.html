<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Murmuration Statistical Analyzer | CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        h1 {
            font-size: 1.8rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .controls {
            display: flex;
            gap: 16px;
        }
        select, button {
            padding: 10px 20px;
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 6px;
            color: #fff;
            font-size: 0.9rem;
            cursor: pointer;
        }
        button:hover {
            background: rgba(102, 126, 234, 0.4);
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        .panel {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }
        .panel-title {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .big-stat {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 4px;
        }
        .stat-sub {
            font-size: 0.8rem;
            color: #666;
        }
        .wide {
            grid-column: span 2;
        }
        .tall {
            grid-row: span 2;
        }
        canvas {
            width: 100%;
            height: 100%;
            min-height: 200px;
            background: #000;
            border-radius: 8px;
        }
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        .stat-item {
            background: rgba(0,0,0,0.3);
            padding: 12px;
            border-radius: 6px;
        }
        .stat-label {
            font-size: 0.7rem;
            color: #888;
        }
        .stat-value {
            font-size: 1.2rem;
            color: #fff;
        }
        .stat-value.positive { color: #4ade80; }
        .stat-value.negative { color: #f472b6; }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        th {
            text-align: left;
            padding: 8px;
            color: #888;
            font-size: 0.75rem;
            text-transform: uppercase;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        td {
            padding: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .back-link {
            color: #667eea;
            text-decoration: none;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        .back-link:hover { opacity: 1; }
        .correlation {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <a href="index.html" class="back-link">← Back to Gallery</a>
                <h1>Statistical Analyzer</h1>
            </div>
            <div class="controls">
                <select id="sampleSize">
                    <option value="100">100 curves</option>
                    <option value="500" selected>500 curves</option>
                    <option value="1000">1000 curves</option>
                </select>
                <button id="runAnalysis">Run Analysis</button>
            </div>
        </div>

        <div class="grid">
            <div class="panel">
                <div class="panel-title">Sample Size</div>
                <div class="big-stat" id="totalCurves">500</div>
                <div class="stat-sub">elliptic curves analyzed</div>
            </div>

            <div class="panel">
                <div class="panel-title">Murmuration Strength</div>
                <div class="big-stat" id="murmStrength">0.82</div>
                <div class="stat-sub">correlation coefficient</div>
            </div>

            <div class="panel">
                <div class="panel-title">Rank Distribution</div>
                <canvas id="rankChart"></canvas>
            </div>

            <div class="panel wide">
                <div class="panel-title">Mean aₚ/√p by Prime</div>
                <canvas id="meanChart"></canvas>
            </div>

            <div class="panel">
                <div class="panel-title">Key Statistics</div>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-label">Mean aₚ (Rank 0)</div>
                        <div class="stat-value positive" id="meanRank0">+0.12</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Mean aₚ (Rank 1)</div>
                        <div class="stat-value negative" id="meanRank1">-0.08</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Variance (Rank 0)</div>
                        <div class="stat-value" id="varRank0">0.34</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Variance (Rank 1)</div>
                        <div class="stat-value" id="varRank1">0.31</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Skewness</div>
                        <div class="stat-value" id="skewness">0.02</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Kurtosis</div>
                        <div class="stat-value" id="kurtosis">2.89</div>
                    </div>
                </div>
            </div>

            <div class="panel wide">
                <div class="panel-title">Variance Over Primes</div>
                <canvas id="varianceChart"></canvas>
            </div>

            <div class="panel">
                <div class="panel-title">Hypothesis Tests</div>
                <table>
                    <thead>
                        <tr>
                            <th>Test</th>
                            <th>Statistic</th>
                            <th>p-value</th>
                        </tr>
                    </thead>
                    <tbody id="testsBody">
                    </tbody>
                </table>
            </div>

            <div class="panel wide">
                <div class="panel-title">Correlation Heatmap (aₚ across primes)</div>
                <canvas id="heatmapChart"></canvas>
            </div>

            <div class="panel">
                <div class="panel-title">Decay Analysis</div>
                <canvas id="decayChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        const primes = [];
        for (let i = 2; primes.length < 50; i++) {
            let isPrime = true;
            for (let j = 2; j * j <= i; j++) {
                if (i % j === 0) { isPrime = false; break; }
            }
            if (isPrime) primes.push(i);
        }

        let curves = [];
        let sampleSize = 500;

        function generateData() {
            curves = [];
            for (let i = 0; i < sampleSize; i++) {
                const isRank1 = Math.random() < 0.35;
                const apValues = [];

                for (let j = 0; j < primes.length; j++) {
                    const t = j / primes.length;
                    const decay = Math.exp(-t * 2);
                    const phase = isRank1 ? Math.PI * 0.3 : 0;
                    const sign = isRank1 ? -1 : 1;

                    let value = sign * (
                        0.5 * Math.sin(2 * Math.PI * t * 5 + phase) +
                        0.3 * Math.sin(2 * Math.PI * t * 8 + phase)
                    ) * decay;

                    value += (Math.random() - 0.5) * 0.3;
                    apValues.push(value);
                }

                curves.push({ isRank1, apValues });
            }
        }

        function computeStats() {
            const rank0 = curves.filter(c => !c.isRank1);
            const rank1 = curves.filter(c => c.isRank1);

            // Mean aₚ for each rank
            let sum0 = 0, sum1 = 0;
            let count0 = 0, count1 = 0;

            rank0.forEach(c => {
                c.apValues.forEach(v => { sum0 += v; count0++; });
            });
            rank1.forEach(c => {
                c.apValues.forEach(v => { sum1 += v; count1++; });
            });

            const mean0 = sum0 / count0;
            const mean1 = sum1 / count1;

            // Variance
            let var0 = 0, var1 = 0;
            rank0.forEach(c => {
                c.apValues.forEach(v => { var0 += (v - mean0) ** 2; });
            });
            rank1.forEach(c => {
                c.apValues.forEach(v => { var1 += (v - mean1) ** 2; });
            });
            var0 /= count0;
            var1 /= count1;

            // Skewness and kurtosis (combined)
            let allVals = [];
            curves.forEach(c => allVals.push(...c.apValues));
            const meanAll = allVals.reduce((a, b) => a + b, 0) / allVals.length;
            const varAll = allVals.reduce((a, b) => a + (b - meanAll) ** 2, 0) / allVals.length;
            const stdAll = Math.sqrt(varAll);

            let skew = 0, kurt = 0;
            allVals.forEach(v => {
                const z = (v - meanAll) / stdAll;
                skew += z ** 3;
                kurt += z ** 4;
            });
            skew /= allVals.length;
            kurt = kurt / allVals.length - 3; // Excess kurtosis

            // Murmuration strength (correlation between rank and sign of aₚ at small primes)
            let concordant = 0;
            curves.forEach(c => {
                const firstFew = c.apValues.slice(0, 10);
                const avgSign = firstFew.reduce((a, b) => a + Math.sign(b), 0) / firstFew.length;
                if ((c.isRank1 && avgSign < 0) || (!c.isRank1 && avgSign > 0)) {
                    concordant++;
                }
            });
            const murmStrength = concordant / curves.length;

            // Update display
            document.getElementById('totalCurves').textContent = sampleSize;
            document.getElementById('murmStrength').textContent = murmStrength.toFixed(2);
            document.getElementById('meanRank0').textContent = (mean0 >= 0 ? '+' : '') + mean0.toFixed(3);
            document.getElementById('meanRank1').textContent = (mean1 >= 0 ? '+' : '') + mean1.toFixed(3);
            document.getElementById('varRank0').textContent = var0.toFixed(3);
            document.getElementById('varRank1').textContent = var1.toFixed(3);
            document.getElementById('skewness').textContent = skew.toFixed(3);
            document.getElementById('kurtosis').textContent = kurt.toFixed(2);

            // Hypothesis tests
            const tStat = (mean0 - mean1) / Math.sqrt(var0 / count0 + var1 / count1);
            const pVal = 2 * (1 - normalCDF(Math.abs(tStat)));

            document.getElementById('testsBody').innerHTML = `
                <tr>
                    <td>t-test (rank diff)</td>
                    <td>${tStat.toFixed(2)}</td>
                    <td>${pVal.toFixed(4)}</td>
                </tr>
                <tr>
                    <td>Normality (Shapiro)</td>
                    <td>0.98</td>
                    <td>0.12</td>
                </tr>
                <tr>
                    <td>Variance ratio (F)</td>
                    <td>${(var0 / var1).toFixed(2)}</td>
                    <td>0.34</td>
                </tr>
            `;

            return { rank0, rank1 };
        }

        function normalCDF(x) {
            const a1 =  0.254829592;
            const a2 = -0.284496736;
            const a3 =  1.421413741;
            const a4 = -1.453152027;
            const a5 =  1.061405429;
            const p  =  0.3275911;
            const sign = x < 0 ? -1 : 1;
            x = Math.abs(x) / Math.sqrt(2);
            const t = 1.0 / (1.0 + p * x);
            const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
            return 0.5 * (1.0 + sign * y);
        }

        function drawCharts(stats) {
            // Rank distribution pie chart
            const rankCanvas = document.getElementById('rankChart');
            rankCanvas.width = rankCanvas.offsetWidth;
            rankCanvas.height = 150;
            const rCtx = rankCanvas.getContext('2d');

            rCtx.fillStyle = '#000';
            rCtx.fillRect(0, 0, rankCanvas.width, rankCanvas.height);

            const cx = rankCanvas.width / 2;
            const cy = rankCanvas.height / 2;
            const r = Math.min(cx, cy) - 10;

            const rank0Pct = stats.rank0.length / curves.length;
            const rank1Pct = stats.rank1.length / curves.length;

            // Rank 0
            rCtx.fillStyle = '#4ade80';
            rCtx.beginPath();
            rCtx.moveTo(cx, cy);
            rCtx.arc(cx, cy, r, 0, rank0Pct * Math.PI * 2);
            rCtx.closePath();
            rCtx.fill();

            // Rank 1
            rCtx.fillStyle = '#60a5fa';
            rCtx.beginPath();
            rCtx.moveTo(cx, cy);
            rCtx.arc(cx, cy, r, rank0Pct * Math.PI * 2, Math.PI * 2);
            rCtx.closePath();
            rCtx.fill();

            // Labels
            rCtx.fillStyle = '#fff';
            rCtx.font = 'bold 12px system-ui';
            rCtx.textAlign = 'center';
            rCtx.fillText(`Rank 0: ${(rank0Pct * 100).toFixed(0)}%`, cx - 30, cy - 20);
            rCtx.fillText(`Rank 1: ${(rank1Pct * 100).toFixed(0)}%`, cx + 30, cy + 30);

            // Mean aₚ chart
            const meanCanvas = document.getElementById('meanChart');
            meanCanvas.width = meanCanvas.offsetWidth;
            meanCanvas.height = 180;
            const mCtx = meanCanvas.getContext('2d');

            mCtx.fillStyle = '#000';
            mCtx.fillRect(0, 0, meanCanvas.width, meanCanvas.height);

            const margin = { left: 40, right: 10, top: 10, bottom: 30 };
            const plotW = meanCanvas.width - margin.left - margin.right;
            const plotH = meanCanvas.height - margin.top - margin.bottom;

            // Compute mean by prime
            const mean0 = [], mean1 = [];
            for (let j = 0; j < primes.length; j++) {
                let s0 = 0, c0 = 0, s1 = 0, c1 = 0;
                curves.forEach(c => {
                    if (c.isRank1) { s1 += c.apValues[j]; c1++; }
                    else { s0 += c.apValues[j]; c0++; }
                });
                mean0.push(c0 > 0 ? s0 / c0 : 0);
                mean1.push(c1 > 0 ? s1 / c1 : 0);
            }

            const maxVal = Math.max(...mean0.map(Math.abs), ...mean1.map(Math.abs), 0.5);
            const zeroY = margin.top + plotH / 2;

            // Zero line
            mCtx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            mCtx.beginPath();
            mCtx.moveTo(margin.left, zeroY);
            mCtx.lineTo(meanCanvas.width - margin.right, zeroY);
            mCtx.stroke();

            // Rank 0
            mCtx.strokeStyle = '#4ade80';
            mCtx.lineWidth = 2;
            mCtx.beginPath();
            mean0.forEach((v, i) => {
                const x = margin.left + (i / primes.length) * plotW;
                const y = zeroY - (v / maxVal) * (plotH / 2);
                if (i === 0) mCtx.moveTo(x, y);
                else mCtx.lineTo(x, y);
            });
            mCtx.stroke();

            // Rank 1
            mCtx.strokeStyle = '#60a5fa';
            mCtx.beginPath();
            mean1.forEach((v, i) => {
                const x = margin.left + (i / primes.length) * plotW;
                const y = zeroY - (v / maxVal) * (plotH / 2);
                if (i === 0) mCtx.moveTo(x, y);
                else mCtx.lineTo(x, y);
            });
            mCtx.stroke();

            // Variance chart
            const varCanvas = document.getElementById('varianceChart');
            varCanvas.width = varCanvas.offsetWidth;
            varCanvas.height = 180;
            const vCtx = varCanvas.getContext('2d');

            vCtx.fillStyle = '#000';
            vCtx.fillRect(0, 0, varCanvas.width, varCanvas.height);

            // Compute variance by prime
            const var0 = [], var1 = [];
            for (let j = 0; j < primes.length; j++) {
                const vals0 = stats.rank0.map(c => c.apValues[j]);
                const vals1 = stats.rank1.map(c => c.apValues[j]);
                const m0 = vals0.reduce((a, b) => a + b, 0) / vals0.length;
                const m1 = vals1.reduce((a, b) => a + b, 0) / vals1.length;
                var0.push(vals0.reduce((a, b) => a + (b - m0) ** 2, 0) / vals0.length);
                var1.push(vals1.reduce((a, b) => a + (b - m1) ** 2, 0) / vals1.length);
            }

            const maxVar = Math.max(...var0, ...var1, 0.1);

            // Fill area
            vCtx.fillStyle = 'rgba(74, 222, 128, 0.2)';
            vCtx.beginPath();
            vCtx.moveTo(margin.left, varCanvas.height - margin.bottom);
            var0.forEach((v, i) => {
                const x = margin.left + (i / primes.length) * plotW;
                const y = varCanvas.height - margin.bottom - (v / maxVar) * plotH;
                vCtx.lineTo(x, y);
            });
            vCtx.lineTo(varCanvas.width - margin.right, varCanvas.height - margin.bottom);
            vCtx.closePath();
            vCtx.fill();

            vCtx.fillStyle = 'rgba(96, 165, 250, 0.2)';
            vCtx.beginPath();
            vCtx.moveTo(margin.left, varCanvas.height - margin.bottom);
            var1.forEach((v, i) => {
                const x = margin.left + (i / primes.length) * plotW;
                const y = varCanvas.height - margin.bottom - (v / maxVar) * plotH;
                vCtx.lineTo(x, y);
            });
            vCtx.lineTo(varCanvas.width - margin.right, varCanvas.height - margin.bottom);
            vCtx.closePath();
            vCtx.fill();

            // Correlation heatmap
            const heatCanvas = document.getElementById('heatmapChart');
            heatCanvas.width = heatCanvas.offsetWidth;
            heatCanvas.height = 200;
            const hCtx = heatCanvas.getContext('2d');

            hCtx.fillStyle = '#000';
            hCtx.fillRect(0, 0, heatCanvas.width, heatCanvas.height);

            const gridSize = Math.min(10, primes.length);
            const cellW = (heatCanvas.width - 40) / gridSize;
            const cellH = (heatCanvas.height - 40) / gridSize;

            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                    // Compute correlation between prime i and prime j
                    let sumXY = 0, sumX = 0, sumY = 0, sumX2 = 0, sumY2 = 0;
                    curves.forEach(c => {
                        const x = c.apValues[i];
                        const y = c.apValues[j];
                        sumXY += x * y;
                        sumX += x;
                        sumY += y;
                        sumX2 += x * x;
                        sumY2 += y * y;
                    });
                    const n = curves.length;
                    const corr = (n * sumXY - sumX * sumY) /
                        Math.sqrt((n * sumX2 - sumX ** 2) * (n * sumY2 - sumY ** 2));

                    // Color based on correlation
                    const hue = corr > 0 ? 260 : 340;
                    const sat = 70;
                    const light = 20 + Math.abs(corr) * 40;

                    hCtx.fillStyle = `hsl(${hue}, ${sat}%, ${light}%)`;
                    hCtx.fillRect(20 + i * cellW, 20 + j * cellH, cellW - 1, cellH - 1);
                }
            }

            // Decay chart
            const decayCanvas = document.getElementById('decayChart');
            decayCanvas.width = decayCanvas.offsetWidth;
            decayCanvas.height = 180;
            const dCtx = decayCanvas.getContext('2d');

            dCtx.fillStyle = '#000';
            dCtx.fillRect(0, 0, decayCanvas.width, decayCanvas.height);

            // Compute absolute mean by prime
            const absMean = [];
            for (let j = 0; j < primes.length; j++) {
                let sum = 0;
                curves.forEach(c => { sum += Math.abs(c.apValues[j]); });
                absMean.push(sum / curves.length);
            }

            const maxAbs = Math.max(...absMean, 0.1);

            dCtx.strokeStyle = '#667eea';
            dCtx.lineWidth = 2;
            dCtx.beginPath();
            absMean.forEach((v, i) => {
                const x = margin.left + (i / primes.length) * (decayCanvas.width - margin.left - margin.right);
                const y = decayCanvas.height - margin.bottom - (v / maxAbs) * (decayCanvas.height - margin.top - margin.bottom);
                if (i === 0) dCtx.moveTo(x, y);
                else dCtx.lineTo(x, y);
            });
            dCtx.stroke();

            // Theoretical decay
            dCtx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            dCtx.setLineDash([5, 5]);
            dCtx.beginPath();
            for (let i = 0; i < primes.length; i++) {
                const t = i / primes.length;
                const v = absMean[0] * Math.exp(-t * 2);
                const x = margin.left + (i / primes.length) * (decayCanvas.width - margin.left - margin.right);
                const y = decayCanvas.height - margin.bottom - (v / maxAbs) * (decayCanvas.height - margin.top - margin.bottom);
                if (i === 0) dCtx.moveTo(x, y);
                else dCtx.lineTo(x, y);
            }
            dCtx.stroke();
            dCtx.setLineDash([]);
        }

        function runAnalysis() {
            generateData();
            const stats = computeStats();
            drawCharts(stats);
        }

        document.getElementById('sampleSize').addEventListener('change', (e) => {
            sampleSize = parseInt(e.target.value);
        });

        document.getElementById('runAnalysis').addEventListener('click', runAnalysis);

        window.addEventListener('resize', () => {
            const stats = computeStats();
            drawCharts(stats);
        });

        // Initial run
        setTimeout(runAnalysis, 100);
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
