<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Murmuration Phase Portrait | CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 100%);
            color: #fff;
            min-height: 100vh;
            display: flex;
        }
        .canvas-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        canvas {
            background: #000;
            border-radius: 12px;
            box-shadow: 0 0 40px rgba(102, 126, 234, 0.3);
        }
        .sidebar {
            width: 320px;
            padding: 24px;
            background: rgba(255,255,255,0.05);
            border-left: 1px solid rgba(255,255,255,0.1);
            overflow-y: auto;
        }
        h1 {
            font-size: 1.5rem;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subtitle {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 24px;
        }
        .control-group {
            margin-bottom: 20px;
        }
        label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        .value { color: #667eea; font-weight: bold; }
        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255,255,255,0.1);
            -webkit-appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            cursor: pointer;
        }
        .legend {
            padding: 16px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .info-box {
            background: rgba(102, 126, 234, 0.1);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid rgba(102, 126, 234, 0.3);
            font-size: 0.85rem;
            line-height: 1.6;
        }
        .info-box h3 {
            color: #667eea;
            margin-bottom: 8px;
        }
        button {
            width: 100%;
            padding: 12px;
            margin-top: 16px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
        }
        button:hover { transform: translateY(-2px); }
        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #667eea;
            text-decoration: none;
            font-size: 0.9rem;
            opacity: 0.8;
            z-index: 100;
        }
        .back-link:hover { opacity: 1; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back to Gallery</a>

    <div class="canvas-area">
        <canvas id="canvas"></canvas>
    </div>

    <div class="sidebar">
        <h1>Phase Portrait</h1>
        <p class="subtitle">Murmuration dynamics in phase space</p>

        <div class="control-group">
            <label>Trail Length <span class="value" id="trailValue">100</span></label>
            <input type="range" id="trailLength" min="20" max="300" value="100">
        </div>

        <div class="control-group">
            <label>Animation Speed <span class="value" id="speedValue">1.0</span></label>
            <input type="range" id="speed" min="0.2" max="3" step="0.1" value="1">
        </div>

        <div class="control-group">
            <label>Coupling <span class="value" id="couplingValue">0.3</span></label>
            <input type="range" id="coupling" min="0" max="1" step="0.05" value="0.3">
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-dot" style="background: #4ade80"></div>
                <span>Rank 0 trajectory</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #60a5fa"></div>
                <span>Rank 1 trajectory</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #f472b6"></div>
                <span>Combined attractor</span>
            </div>
        </div>

        <button id="resetBtn">Reset Trajectories</button>

        <div class="info-box">
            <h3>Phase Space Analysis</h3>
            <p>The phase portrait shows how aₚ (x-axis) relates to its rate of change daₚ/dp (y-axis).</p>
            <p style="margin-top: 8px;">The spiraling patterns indicate oscillatory behavior—the signature of murmurations.</p>
            <p style="margin-top: 8px;">Rank 0 and Rank 1 curves trace different but related paths through phase space.</p>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let trailLength = 100;
        let speed = 1;
        let coupling = 0.3;

        function resize() {
            const size = Math.min(window.innerWidth - 360, window.innerHeight - 40);
            canvas.width = size;
            canvas.height = size;
        }
        resize();
        window.addEventListener('resize', resize);

        // Phase space trajectories
        let t = 0;
        let rank0Trail = [];
        let rank1Trail = [];
        let combinedTrail = [];

        function getState(time, isRank1) {
            // Generate aₚ value
            const decay = Math.exp(-time * 0.01);
            const phase = isRank1 ? Math.PI * 0.3 : 0;
            const sign = isRank1 ? -1 : 1;

            const ap = sign * (
                0.5 * Math.sin(time * 0.1 + phase) +
                0.3 * Math.sin(time * 0.16 + phase) +
                0.2 * Math.cos(time * 0.25)
            ) * decay;

            // Derivative (velocity)
            const dap = sign * (
                0.5 * 0.1 * Math.cos(time * 0.1 + phase) +
                0.3 * 0.16 * Math.cos(time * 0.16 + phase) -
                0.2 * 0.25 * Math.sin(time * 0.25)
            ) * decay;

            return { ap, dap };
        }

        function draw() {
            const w = canvas.width;
            const h = canvas.height;
            const cx = w / 2;
            const cy = h / 2;
            const scale = w * 0.35;

            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.fillRect(0, 0, w, h);

            // Draw grid (faded)
            ctx.strokeStyle = 'rgba(102, 126, 234, 0.1)';
            ctx.lineWidth = 1;
            for (let i = -5; i <= 5; i++) {
                ctx.beginPath();
                ctx.moveTo(cx + i * (scale / 5), 0);
                ctx.lineTo(cx + i * (scale / 5), h);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(0, cy + i * (scale / 5));
                ctx.lineTo(w, cy + i * (scale / 5));
                ctx.stroke();
            }

            // Axes
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, cy);
            ctx.lineTo(w, cy);
            ctx.moveTo(cx, 0);
            ctx.lineTo(cx, h);
            ctx.stroke();

            // Update state
            const state0 = getState(t, false);
            const state1 = getState(t, true);

            // Add to trails
            rank0Trail.push({ x: cx + state0.ap * scale, y: cy - state0.dap * scale * 5 });
            rank1Trail.push({ x: cx + state1.ap * scale, y: cy - state1.dap * scale * 5 });

            // Combined (with coupling)
            const combinedAp = (state0.ap + state1.ap) / 2 + coupling * (state0.ap - state1.ap);
            const combinedDap = (state0.dap + state1.dap) / 2;
            combinedTrail.push({ x: cx + combinedAp * scale, y: cy - combinedDap * scale * 5 });

            // Trim trails
            if (rank0Trail.length > trailLength) rank0Trail.shift();
            if (rank1Trail.length > trailLength) rank1Trail.shift();
            if (combinedTrail.length > trailLength) combinedTrail.shift();

            // Draw trails
            function drawTrail(trail, color) {
                if (trail.length < 2) return;

                ctx.beginPath();
                trail.forEach((p, i) => {
                    const alpha = i / trail.length;
                    ctx.strokeStyle = color.replace('1)', `${alpha})`);
                    ctx.lineWidth = 1 + alpha * 2;

                    if (i === 0) ctx.moveTo(p.x, p.y);
                    else {
                        ctx.lineTo(p.x, p.y);
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.moveTo(p.x, p.y);
                    }
                });
            }

            drawTrail(rank0Trail, 'rgba(74, 222, 128, 1)');
            drawTrail(rank1Trail, 'rgba(96, 165, 250, 1)');
            drawTrail(combinedTrail, 'rgba(244, 114, 182, 1)');

            // Draw current points
            const last0 = rank0Trail[rank0Trail.length - 1];
            const last1 = rank1Trail[rank1Trail.length - 1];
            const lastC = combinedTrail[combinedTrail.length - 1];

            if (last0) {
                ctx.fillStyle = '#4ade80';
                ctx.beginPath();
                ctx.arc(last0.x, last0.y, 8, 0, Math.PI * 2);
                ctx.fill();

                ctx.shadowColor = '#4ade80';
                ctx.shadowBlur = 20;
                ctx.beginPath();
                ctx.arc(last0.x, last0.y, 4, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;
            }

            if (last1) {
                ctx.fillStyle = '#60a5fa';
                ctx.beginPath();
                ctx.arc(last1.x, last1.y, 8, 0, Math.PI * 2);
                ctx.fill();

                ctx.shadowColor = '#60a5fa';
                ctx.shadowBlur = 20;
                ctx.beginPath();
                ctx.arc(last1.x, last1.y, 4, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;
            }

            if (lastC) {
                ctx.fillStyle = '#f472b6';
                ctx.beginPath();
                ctx.arc(lastC.x, lastC.y, 6, 0, Math.PI * 2);
                ctx.fill();
            }

            // Labels
            ctx.fillStyle = '#888';
            ctx.font = '14px system-ui';
            ctx.textAlign = 'center';
            ctx.fillText('aₚ', w - 30, cy - 10);
            ctx.fillText('daₚ/dp', cx + 10, 20);

            t += 0.05 * speed;
        }

        function animate() {
            draw();
            requestAnimationFrame(animate);
        }

        document.getElementById('trailLength').addEventListener('input', (e) => {
            trailLength = parseInt(e.target.value);
            document.getElementById('trailValue').textContent = trailLength;
        });

        document.getElementById('speed').addEventListener('input', (e) => {
            speed = parseFloat(e.target.value);
            document.getElementById('speedValue').textContent = speed.toFixed(1);
        });

        document.getElementById('coupling').addEventListener('input', (e) => {
            coupling = parseFloat(e.target.value);
            document.getElementById('couplingValue').textContent = coupling.toFixed(2);
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            t = 0;
            rank0Trail = [];
            rank1Trail = [];
            combinedTrail = [];
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        });

        animate();
    </script>
</body>
</html>
