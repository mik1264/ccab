<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Murmuration Density Heatmap | CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        h1 {
            text-align: center;
            font-size: 2rem;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .panel {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .panel-title {
            font-size: 1.1rem;
            color: #667eea;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .rank-badge {
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
        }
        .rank-0 { background: rgba(74, 222, 128, 0.2); color: #4ade80; }
        .rank-1 { background: rgba(96, 165, 250, 0.2); color: #60a5fa; }
        canvas {
            width: 100%;
            height: 400px;
            background: #000;
            border-radius: 8px;
        }
        .colorbar {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            font-size: 0.8rem;
        }
        .colorbar-gradient {
            flex: 1;
            height: 16px;
            border-radius: 4px;
        }
        .info-panel {
            grid-column: span 2;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        .info-box h3 {
            color: #667eea;
            margin-bottom: 8px;
        }
        .info-box p {
            font-size: 0.85rem;
            color: #aaa;
            line-height: 1.6;
        }
        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #667eea;
            text-decoration: none;
            font-size: 0.9rem;
            opacity: 0.8;
            z-index: 100;
        }
        .back-link:hover { opacity: 1; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back to Gallery</a>
    <h1>Murmuration Density Heatmap</h1>
    <p class="subtitle">Where aₚ values concentrate across prime and conductor space</p>

    <div class="container">
        <div class="panel">
            <div class="panel-title">
                <span class="rank-badge rank-0">Rank 0</span>
                <span>Density Distribution</span>
            </div>
            <canvas id="canvas0"></canvas>
            <div class="colorbar">
                <span>Low</span>
                <div class="colorbar-gradient" style="background: linear-gradient(90deg, #000, #065f46, #4ade80, #fef08a)"></div>
                <span>High</span>
            </div>
        </div>

        <div class="panel">
            <div class="panel-title">
                <span class="rank-badge rank-1">Rank 1</span>
                <span>Density Distribution</span>
            </div>
            <canvas id="canvas1"></canvas>
            <div class="colorbar">
                <span>Low</span>
                <div class="colorbar-gradient" style="background: linear-gradient(90deg, #000, #1e3a8a, #60a5fa, #fef08a)"></div>
                <span>High</span>
            </div>
        </div>

        <div class="info-panel">
            <div class="info-grid">
                <div class="info-box">
                    <h3>Reading the Heatmap</h3>
                    <p>X-axis: Prime p (where aₚ is computed)<br>
                    Y-axis: Normalized aₚ value<br>
                    Color: Density of curves with that (p, aₚ) combination</p>
                </div>
                <div class="info-box">
                    <h3>Visible Patterns</h3>
                    <p>Bright bands show where aₚ values cluster. Notice how rank 0 curves tend toward positive values while rank 1 curves favor negative ones.</p>
                </div>
                <div class="info-box">
                    <h3>The Murmuration Signature</h3>
                    <p>The oscillating bright bands across primes create the characteristic wave pattern—this is the murmuration made visible in density space.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        function createHeatmap(canvasId, isRank1) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');

            canvas.width = canvas.offsetWidth * 2;
            canvas.height = 800;

            const w = canvas.width;
            const h = canvas.height;
            const margin = { top: 40, right: 60, bottom: 60, left: 60 };

            const plotW = w - margin.left - margin.right;
            const plotH = h - margin.top - margin.bottom;

            // Create density grid
            const gridX = 100;  // primes
            const gridY = 80;   // aₚ values
            const density = Array(gridY).fill(null).map(() => Array(gridX).fill(0));

            // Simulate many curves
            const numCurves = 5000;
            const numPrimes = 50;

            for (let curve = 0; curve < numCurves; curve++) {
                for (let pIdx = 0; pIdx < numPrimes; pIdx++) {
                    const t = pIdx / numPrimes;
                    const p = 10 + t * 490;
                    const hasseBound = 2 * Math.sqrt(p);

                    // Generate aₚ with murmuration pattern
                    const phase = isRank1 ? Math.PI * 0.3 : 0;
                    const sign = isRank1 ? -1 : 1;

                    const baseWave = sign * (
                        0.4 * Math.sin(2 * Math.PI * t * 4 + phase) +
                        0.2 * Math.sin(2 * Math.PI * t * 7 + phase)
                    );

                    const decay = Math.exp(-t * 1.5);
                    const center = baseWave * decay;

                    // Add spread around the center
                    const spread = 0.3 + t * 0.2;
                    const ap = center + (Math.random() - 0.5) * spread * 2;

                    // Map to grid
                    const gx = Math.floor((pIdx / numPrimes) * gridX);
                    const gy = Math.floor(((ap + 1) / 2) * gridY);

                    if (gx >= 0 && gx < gridX && gy >= 0 && gy < gridY) {
                        density[gy][gx]++;
                    }
                }
            }

            // Find max density
            let maxDensity = 0;
            for (let y = 0; y < gridY; y++) {
                for (let x = 0; x < gridX; x++) {
                    maxDensity = Math.max(maxDensity, density[y][x]);
                }
            }

            // Draw heatmap
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, w, h);

            const cellW = plotW / gridX;
            const cellH = plotH / gridY;

            for (let y = 0; y < gridY; y++) {
                for (let x = 0; x < gridX; x++) {
                    const val = density[y][x] / maxDensity;

                    let r, g, b;
                    if (isRank1) {
                        // Blue color scheme
                        if (val < 0.25) {
                            r = 0;
                            g = 0;
                            b = Math.floor(val * 4 * 139);
                        } else if (val < 0.5) {
                            r = Math.floor((val - 0.25) * 4 * 30);
                            g = Math.floor((val - 0.25) * 4 * 58);
                            b = 139 + Math.floor((val - 0.25) * 4 * 111);
                        } else if (val < 0.75) {
                            r = 30 + Math.floor((val - 0.5) * 4 * 66);
                            g = 58 + Math.floor((val - 0.5) * 4 * 107);
                            b = 250;
                        } else {
                            r = 96 + Math.floor((val - 0.75) * 4 * 158);
                            g = 165 + Math.floor((val - 0.75) * 4 * 75);
                            b = 250 - Math.floor((val - 0.75) * 4 * 112);
                        }
                    } else {
                        // Green color scheme
                        if (val < 0.25) {
                            r = 0;
                            g = Math.floor(val * 4 * 95);
                            b = Math.floor(val * 4 * 70);
                        } else if (val < 0.5) {
                            r = Math.floor((val - 0.25) * 4 * 6);
                            g = 95 + Math.floor((val - 0.25) * 4 * 78);
                            b = 70 - Math.floor((val - 0.25) * 4 * 70);
                        } else if (val < 0.75) {
                            r = 6 + Math.floor((val - 0.5) * 4 * 68);
                            g = 173 + Math.floor((val - 0.5) * 4 * 49);
                            b = Math.floor((val - 0.5) * 4 * 128);
                        } else {
                            r = 74 + Math.floor((val - 0.75) * 4 * 180);
                            g = 222 + Math.floor((val - 0.75) * 4 * 18);
                            b = 128 + Math.floor((val - 0.75) * 4 * 10);
                        }
                    }

                    ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;
                    ctx.fillRect(
                        margin.left + x * cellW,
                        margin.top + (gridY - 1 - y) * cellH,
                        cellW + 1,
                        cellH + 1
                    );
                }
            }

            // Draw murmuration center line
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();

            for (let x = 0; x < gridX; x++) {
                const t = x / gridX;
                const phase = isRank1 ? Math.PI * 0.3 : 0;
                const sign = isRank1 ? -1 : 1;

                const wave = sign * (
                    0.4 * Math.sin(2 * Math.PI * t * 4 + phase) +
                    0.2 * Math.sin(2 * Math.PI * t * 7 + phase)
                );
                const decay = Math.exp(-t * 1.5);
                const center = wave * decay;

                const px = margin.left + x * cellW + cellW / 2;
                const py = margin.top + (1 - (center + 1) / 2) * plotH;

                if (x === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            }
            ctx.stroke();
            ctx.setLineDash([]);

            // Axes labels
            ctx.fillStyle = '#888';
            ctx.font = '24px system-ui';
            ctx.textAlign = 'center';
            ctx.fillText('Prime p', w / 2, h - 15);

            ctx.save();
            ctx.translate(20, h / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Normalized aₚ', 0, 0);
            ctx.restore();

            // Tick labels
            ctx.font = '18px system-ui';
            ctx.fillText('10', margin.left, h - margin.bottom + 25);
            ctx.fillText('500', w - margin.right, h - margin.bottom + 25);
            ctx.fillText('+1', margin.left - 25, margin.top + 10);
            ctx.fillText('-1', margin.left - 25, h - margin.bottom);
            ctx.fillText('0', margin.left - 20, margin.top + plotH / 2 + 5);
        }

        createHeatmap('canvas0', false);
        createHeatmap('canvas1', true);

        window.addEventListener('resize', () => {
            createHeatmap('canvas0', false);
            createHeatmap('canvas1', true);
        });
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
