<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloth Simulation - Advanced Verlet Physics - CCAB</title>
    <meta name="description" content="Advanced cloth simulation with Verlet integration, shear/bend springs, sphere collision, wind turbulence, and shaded rendering.">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0a0a12;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            color: #ccc;
        }
        canvas { display: block; position: fixed; top: 0; left: 0; }
        .back-link {
            position: fixed; top: 12px; left: 12px; padding: 8px 16px;
            background: rgba(10,10,20,0.6); color: #7eb8da; text-decoration: none;
            border-radius: 8px; font-size: 13px; z-index: 1000;
            backdrop-filter: blur(12px); border: 1px solid rgba(126,184,218,0.2);
            transition: all 0.3s ease;
        }
        .back-link:hover { background: rgba(126,184,218,0.15); transform: translateX(-3px); }
        #panel {
            position: fixed; top: 12px; right: 12px; width: 260px;
            max-height: calc(100vh - 24px); overflow-y: auto;
            background: rgba(15,15,30,0.55); backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(126,184,218,0.15); border-radius: 14px;
            padding: 16px; z-index: 1000; font-size: 12px;
        }
        #panel::-webkit-scrollbar { width: 4px; }
        #panel::-webkit-scrollbar-track { background: transparent; }
        #panel::-webkit-scrollbar-thumb { background: rgba(126,184,218,0.3); border-radius: 2px; }
        #panel h2 { font-size: 15px; color: #7eb8da; margin-bottom: 4px; font-weight: 600; }
        #panel .subtitle { font-size: 10px; color: #667; margin-bottom: 14px; }
        .section-title {
            font-size: 10px; text-transform: uppercase; letter-spacing: 1.2px;
            color: #556; margin: 14px 0 8px; padding-top: 10px;
            border-top: 1px solid rgba(126,184,218,0.08);
        }
        .section-title:first-of-type { border-top: none; margin-top: 0; }
        .preset-row { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 4px; }
        .preset-btn {
            background: rgba(126,184,218,0.08); border: 1px solid rgba(126,184,218,0.15);
            color: #8ab4cc; padding: 7px 6px; border-radius: 6px; cursor: pointer;
            font-size: 11px; transition: all 0.2s; text-align: center;
        }
        .preset-btn:hover { background: rgba(126,184,218,0.18); }
        .preset-btn.active {
            background: rgba(126,184,218,0.25); border-color: rgba(126,184,218,0.5); color: #b8daf0;
        }
        .slider-row {
            display: flex; align-items: center; justify-content: space-between; margin: 5px 0;
        }
        .slider-row label { font-size: 11px; color: #899; min-width: 70px; }
        .slider-row input[type="range"] {
            flex: 1; margin: 0 8px; height: 3px; -webkit-appearance: none; appearance: none;
            background: rgba(126,184,218,0.15); border-radius: 2px; outline: none;
        }
        .slider-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 12px; height: 12px; border-radius: 50%;
            background: #7eb8da; cursor: pointer;
        }
        .slider-row .val {
            font-size: 10px; color: #7eb8da; min-width: 28px; text-align: right;
            font-family: 'SF Mono','Fira Code',monospace;
        }
        .toggle-row { display: flex; gap: 6px; margin: 6px 0; flex-wrap: wrap; }
        .toggle-btn {
            background: rgba(126,184,218,0.06); border: 1px solid rgba(126,184,218,0.12);
            color: #667; padding: 5px 10px; border-radius: 5px; cursor: pointer;
            font-size: 10px; transition: all 0.2s;
        }
        .toggle-btn:hover { background: rgba(126,184,218,0.12); }
        .toggle-btn.active {
            background: rgba(126,184,218,0.2); border-color: rgba(126,184,218,0.4); color: #7eb8da;
        }
        .stats-row {
            display: flex; justify-content: space-between; font-size: 10px; color: #556; margin: 2px 0;
        }
        .stats-row .stat-val { color: #7eb8da; font-family: 'SF Mono','Fira Code',monospace; }
        .shortcuts { margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(126,184,218,0.08); }
        .shortcut-item {
            display: flex; justify-content: space-between; margin: 3px 0; font-size: 10px; color: #556;
        }
        .shortcut-item kbd {
            background: rgba(126,184,218,0.1); border: 1px solid rgba(126,184,218,0.15);
            border-radius: 3px; padding: 1px 5px; font-size: 9px; color: #7eb8da;
            font-family: 'SF Mono','Fira Code',monospace;
        }
        #pause-overlay {
            display: none; position: fixed; top: 50%; left: 50%;
            transform: translate(-50%,-50%); background: rgba(10,10,20,0.7);
            backdrop-filter: blur(10px); padding: 20px 40px; border-radius: 12px;
            border: 1px solid rgba(126,184,218,0.2); z-index: 999; text-align: center;
        }
        #pause-overlay h3 { color: #7eb8da; font-size: 18px; margin-bottom: 4px; }
        #pause-overlay p { color: #556; font-size: 11px; }
    </style>
</head>
<body>
    <a href="../index.html" class="back-link">&#8592; Back to Gallery</a>
    <canvas id="canvas"></canvas>
    <div id="pause-overlay"><h3>PAUSED</h3><p>Press Space to resume</p></div>
    <div id="panel">
        <h2>Cloth Simulation</h2>
        <div class="subtitle">Advanced Verlet Integration Physics</div>
        <div class="section-title">Presets</div>
        <div class="preset-row">
            <button class="preset-btn active" data-preset="curtain">1 Curtain</button>
            <button class="preset-btn" data-preset="flag">2 Flag</button>
        </div>
        <div class="preset-row">
            <button class="preset-btn" data-preset="tablecloth">3 Tablecloth</button>
            <button class="preset-btn" data-preset="hammock">4 Hammock</button>
        </div>
        <div class="section-title">Physics</div>
        <div class="slider-row">
            <label>Gravity</label>
            <input type="range" id="sl-gravity" min="0" max="3" value="0.8" step="0.05">
            <span class="val" id="v-gravity">0.80</span>
        </div>
        <div class="slider-row">
            <label>Iterations</label>
            <input type="range" id="sl-iterations" min="2" max="20" value="10" step="1">
            <span class="val" id="v-iterations">10</span>
        </div>
        <div class="slider-row">
            <label>Damping</label>
            <input type="range" id="sl-damping" min="0.98" max="1.0" value="0.995" step="0.001">
            <span class="val" id="v-damping">0.995</span>
        </div>
        <div class="slider-row">
            <label>Resolution</label>
            <input type="range" id="sl-resolution" min="15" max="80" value="45" step="5">
            <span class="val" id="v-resolution">45</span>
        </div>
        <div class="section-title">Wind</div>
        <div class="slider-row">
            <label>Strength</label>
            <input type="range" id="sl-wind-str" min="0" max="2" value="0" step="0.05">
            <span class="val" id="v-wind-str">0.00</span>
        </div>
        <div class="slider-row">
            <label>Direction</label>
            <input type="range" id="sl-wind-dir" min="0" max="360" value="0" step="5">
            <span class="val" id="v-wind-dir">0</span>
        </div>
        <div class="slider-row">
            <label>Turbulence</label>
            <input type="range" id="sl-turbulence" min="0" max="1" value="0.3" step="0.05">
            <span class="val" id="v-turbulence">0.30</span>
        </div>
        <div class="section-title">Sphere Obstacle</div>
        <div class="slider-row">
            <label>Radius</label>
            <input type="range" id="sl-sphere-r" min="30" max="200" value="100" step="5">
            <span class="val" id="v-sphere-r">100</span>
        </div>
        <div class="toggle-row">
            <button class="toggle-btn" id="btn-sphere">Show Sphere</button>
        </div>
        <div class="section-title">Rendering</div>
        <div class="toggle-row">
            <button class="toggle-btn active" id="btn-shaded">Shaded</button>
            <button class="toggle-btn" id="btn-wireframe">Wireframe</button>
            <button class="toggle-btn" id="btn-stress">Stress</button>
        </div>
        <div class="section-title">Actions</div>
        <div class="toggle-row">
            <button class="toggle-btn" id="btn-wind-toggle">Wind (W)</button>
            <button class="toggle-btn" id="btn-pause">Pause</button>
            <button class="toggle-btn" id="btn-reset">Reset (R)</button>
        </div>
        <div class="section-title">Stats</div>
        <div class="stats-row"><span>Particles</span><span class="stat-val" id="st-particles">0</span></div>
        <div class="stats-row"><span>Constraints</span><span class="stat-val" id="st-constraints">0</span></div>
        <div class="stats-row"><span>FPS</span><span class="stat-val" id="st-fps">0</span></div>
        <div class="shortcuts">
            <div class="shortcut-item"><span>Pause / Resume</span><kbd>Space</kbd></div>
            <div class="shortcut-item"><span>Reset</span><kbd>R</kbd></div>
            <div class="shortcut-item"><span>Toggle Wind</span><kbd>W</kbd></div>
            <div class="shortcut-item"><span>Presets</span><kbd>1-4</kbd></div>
            <div class="shortcut-item"><span>Drag cloth</span><span>Left click</span></div>
            <div class="shortcut-item"><span>Tear cloth</span><span>Right click</span></div>
        </div>
    </div>
    <script>
    (function() {
        "use strict";

        var canvas = document.getElementById('canvas');
        var ctx = canvas.getContext('2d');
        var W, H;

        function resize() {
            W = canvas.width = window.innerWidth;
            H = canvas.height = window.innerHeight;
        }
        resize();
        window.addEventListener('resize', function() { resize(); initCloth(); });

        var config = {
            gravity: 0.8, damping: 0.995, iterations: 10, resolution: 45,
            windStrength: 0.0, windDir: 0, turbulence: 0.3,
            sphereRadius: 100, showSphere: false,
            renderMode: 'shaded', paused: false, preset: 'curtain'
        };

        // ---- Simplex 2D noise for wind turbulence ----
        var perm = new Uint8Array(512);
        var grad3 = [[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]];
        (function() {
            var p = [];
            for (var i = 0; i < 256; i++) p[i] = i;
            for (var i = 255; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var tmp = p[i]; p[i] = p[j]; p[j] = tmp;
            }
            for (var i = 0; i < 512; i++) perm[i] = p[i & 255];
        })();

        function dot2(g, x, y) { return g[0]*x + g[1]*y; }

        function noise2D(xin, yin) {
            var F2 = 0.5*(Math.sqrt(3.0)-1.0), G2 = (3.0-Math.sqrt(3.0))/6.0;
            var s = (xin+yin)*F2, i = Math.floor(xin+s), j = Math.floor(yin+s);
            var t = (i+j)*G2, x0 = xin-(i-t), y0 = yin-(j-t);
            var i1, j1;
            if (x0 > y0) { i1=1; j1=0; } else { i1=0; j1=1; }
            var x1=x0-i1+G2, y1=y0-j1+G2, x2=x0-1+2*G2, y2=y0-1+2*G2;
            var ii=i&255, jj=j&255, n0=0, n1=0, n2=0;
            var t0=0.5-x0*x0-y0*y0;
            if(t0>=0){t0*=t0; n0=t0*t0*dot2(grad3[perm[ii+perm[jj]]%12],x0,y0);}
            var t1=0.5-x1*x1-y1*y1;
            if(t1>=0){t1*=t1; n1=t1*t1*dot2(grad3[perm[ii+i1+perm[jj+j1]]%12],x1,y1);}
            var t2=0.5-x2*x2-y2*y2;
            if(t2>=0){t2*=t2; n2=t2*t2*dot2(grad3[perm[ii+1+perm[jj+1]]%12],x2,y2);}
            return 70*(n0+n1+n2);
        }

        // ---- Cloth data (typed arrays for performance) ----
        var numCols, numRows, numParticles;
        var posX, posY, posZ, oldX, oldY, oldZ, pinnedArr, accX, accY, accZ;
        var cP1, cP2, cRestLen, cActive, cType, numConstraints;
        var spacing, clothStartX, clothStartY, simTime = 0;
        var sphereX, sphereY, sphereZ;

        // ---- Presets ----
        function getPreset(name) {
            switch(name) {
                case 'curtain': return {
                    pinFn: function(r,c,cols,rows){return r===0;},
                    windStr:0, startY:60
                };
                case 'flag': return {
                    pinFn: function(r,c,cols,rows){return c===0;},
                    windStr:0.8, startY:100
                };
                case 'tablecloth': return {
                    pinFn: function(){return false;},
                    windStr:0, startY:80, sphere:true
                };
                case 'hammock': return {
                    pinFn: function(r,c,cols,rows){
                        return (r===0&&c===0)||(r===0&&c===cols-1)||(r===rows-1&&c===0)||(r===rows-1&&c===cols-1);
                    },
                    windStr:0, startY:80
                };
                default: return getPreset('curtain');
            }
        }

        // ---- Initialize cloth ----
        function initCloth() {
            var preset = getPreset(config.preset);
            numCols = config.resolution;
            numRows = Math.round(config.resolution * 0.7);
            numParticles = numCols * numRows;
            var totalW = Math.min(W*0.6, 700);
            spacing = totalW / numCols;
            clothStartX = (W - numCols*spacing) / 2;
            clothStartY = preset.startY || 60;

            posX = new Float64Array(numParticles);
            posY = new Float64Array(numParticles);
            posZ = new Float64Array(numParticles);
            oldX = new Float64Array(numParticles);
            oldY = new Float64Array(numParticles);
            oldZ = new Float64Array(numParticles);
            pinnedArr = new Uint8Array(numParticles);
            accX = new Float64Array(numParticles);
            accY = new Float64Array(numParticles);
            accZ = new Float64Array(numParticles);

            for (var r = 0; r < numRows; r++) {
                for (var c = 0; c < numCols; c++) {
                    var idx = r*numCols+c;
                    var x = clothStartX + c*spacing, y = clothStartY + r*spacing;
                    posX[idx]=oldX[idx]=x; posY[idx]=oldY[idx]=y; posZ[idx]=oldZ[idx]=0;
                    pinnedArr[idx] = preset.pinFn(r,c,numCols,numRows) ? 1 : 0;
                }
            }

            // Constraint count: structural + shear + bend
            var count = (numCols-1)*numRows + numCols*(numRows-1) +
                        2*(numCols-1)*(numRows-1) +
                        (numCols-2)*numRows + numCols*(numRows-2);
            cP1 = new Int32Array(count);
            cP2 = new Int32Array(count);
            cRestLen = new Float64Array(count);
            cActive = new Uint8Array(count);
            cType = new Uint8Array(count);

            var ci = 0;
            function addC(a,b,type) {
                cP1[ci]=a; cP2[ci]=b;
                var dx=posX[b]-posX[a], dy=posY[b]-posY[a], dz=posZ[b]-posZ[a];
                cRestLen[ci]=Math.sqrt(dx*dx+dy*dy+dz*dz);
                cActive[ci]=1; cType[ci]=type; ci++;
            }
            for (var r=0; r<numRows; r++) {
                for (var c=0; c<numCols; c++) {
                    var idx = r*numCols+c;
                    // Structural (horizontal + vertical)
                    if (c<numCols-1) addC(idx, idx+1, 0);
                    if (r<numRows-1) addC(idx, idx+numCols, 0);
                    // Shear (diagonals)
                    if (c<numCols-1 && r<numRows-1) {
                        addC(idx, idx+numCols+1, 1);
                        addC(idx+1, idx+numCols, 1);
                    }
                    // Bend (skip-one)
                    if (c<numCols-2) addC(idx, idx+2, 2);
                    if (r<numRows-2) addC(idx, idx+numCols*2, 2);
                }
            }
            numConstraints = ci;

            // Sphere position centered under cloth
            sphereX = W/2;
            sphereY = clothStartY + numRows*spacing*0.5;
            sphereZ = 0;

            // Apply preset defaults
            if (preset.windStr > 0) {
                config.windStrength = preset.windStr;
                document.getElementById('sl-wind-str').value = config.windStrength;
                document.getElementById('v-wind-str').textContent = config.windStrength.toFixed(2);
                setWindBtn(true);
            }
            if (preset.sphere) {
                config.showSphere = true;
                document.getElementById('btn-sphere').classList.add('active');
            }

            document.getElementById('st-particles').textContent = numParticles;
            document.getElementById('st-constraints').textContent = numConstraints;
            simTime = 0;
        }

        // ---- Physics step ----
        function physicsStep() {
            if (config.paused) return;
            var grav=config.gravity, damp=config.damping, windStr=config.windStrength;
            var wRad=config.windDir*Math.PI/180;
            var wX=Math.cos(wRad)*windStr, wY=Math.sin(wRad)*windStr*0.3, wZ=Math.sin(wRad)*windStr;
            var turb=config.turbulence;
            simTime += 0.02;

            var i, dx, dy, dz, dist, rest, diff, stiff, ox, oy, oz, a, b;

            // Accumulate forces
            for (i=0; i<numParticles; i++) { accX[i]=0; accY[i]=grav; accZ[i]=0; }

            // Wind with Perlin-like turbulence
            if (windStr > 0.001) {
                for (i=0; i<numParticles; i++) {
                    var nx=noise2D(posX[i]*0.005+simTime, posY[i]*0.005);
                    var ny=noise2D(posX[i]*0.005, posY[i]*0.005+simTime+100);
                    var nz=noise2D(posX[i]*0.005+200, posY[i]*0.005+simTime);
                    accX[i]+=wX+nx*turb*windStr;
                    accY[i]+=wY+ny*turb*windStr*0.3;
                    accZ[i]+=wZ+nz*turb*windStr;
                }
            }

            // Verlet integration
            for (i=0; i<numParticles; i++) {
                if (pinnedArr[i]) continue;
                var vx=(posX[i]-oldX[i])*damp;
                var vy=(posY[i]-oldY[i])*damp;
                var vz=(posZ[i]-oldZ[i])*damp;
                oldX[i]=posX[i]; oldY[i]=posY[i]; oldZ[i]=posZ[i];
                posX[i]+=vx+accX[i];
                posY[i]+=vy+accY[i];
                posZ[i]+=vz+accZ[i];
            }

            // Constraint solving -- multiple iterations for stability (8+)
            var iters = config.iterations;
            for (var iter=0; iter<iters; iter++) {
                for (i=0; i<numConstraints; i++) {
                    if (!cActive[i]) continue;
                    a=cP1[i]; b=cP2[i];
                    dx=posX[b]-posX[a]; dy=posY[b]-posY[a]; dz=posZ[b]-posZ[a];
                    dist=Math.sqrt(dx*dx+dy*dy+dz*dz);
                    if (dist<0.0001) continue;
                    rest=cRestLen[i]; diff=(rest-dist)/dist;
                    // Structural=0.5, Shear=0.4, Bend=0.2
                    stiff = cType[i]===0 ? 0.5 : (cType[i]===1 ? 0.4 : 0.2);
                    ox=dx*diff*stiff; oy=dy*diff*stiff; oz=dz*diff*stiff;
                    if (pinnedArr[a] && pinnedArr[b]) continue;
                    if (pinnedArr[a]) {
                        posX[b]+=ox; posY[b]+=oy; posZ[b]+=oz;
                    } else if (pinnedArr[b]) {
                        posX[a]-=ox; posY[a]-=oy; posZ[a]-=oz;
                    } else {
                        posX[a]-=ox*0.5; posY[a]-=oy*0.5; posZ[a]-=oz*0.5;
                        posX[b]+=ox*0.5; posY[b]+=oy*0.5; posZ[b]+=oz*0.5;
                    }
                }

                // Sphere collision
                if (config.showSphere) {
                    var sr=config.sphereRadius+2;
                    for (i=0; i<numParticles; i++) {
                        if (pinnedArr[i]) continue;
                        dx=posX[i]-sphereX; dy=posY[i]-sphereY; dz=posZ[i]-sphereZ;
                        var d=Math.sqrt(dx*dx+dy*dy+dz*dz);
                        if (d<sr && d>0.001) {
                            var push=sr/d;
                            posX[i]=sphereX+dx*push;
                            posY[i]=sphereY+dy*push;
                            posZ[i]=sphereZ+dz*push;
                        }
                    }
                }

                // Floor + wall boundaries
                for (i=0; i<numParticles; i++) {
                    if (pinnedArr[i]) continue;
                    if (posY[i]>H-5) {
                        posY[i]=H-5;
                        oldY[i]=posY[i]+(posY[i]-oldY[i])*0.1;
                    }
                    if (posX[i]<5) posX[i]=5;
                    if (posX[i]>W-5) posX[i]=W-5;
                }
            }
        }

        // ---- Mouse interaction ----
        var mouseX=0, mouseY=0, mouseDown=false, mouseButton=0;
        var dragIndex=-1, dragRadius=40, tearRadius=25;

        function findClosest(mx, my, radius) {
            var best=-1, bestD=radius*radius;
            for (var i=0; i<numParticles; i++) {
                var dx=posX[i]-mx, dy=posY[i]-my, d2=dx*dx+dy*dy;
                if (d2<bestD) { bestD=d2; best=i; }
            }
            return best;
        }

        canvas.addEventListener('mousedown', function(e) {
            e.preventDefault();
            mouseDown=true; mouseButton=e.button;
            mouseX=e.clientX; mouseY=e.clientY;
            if (e.button===0) dragIndex=findClosest(mouseX, mouseY, dragRadius);
        });

        canvas.addEventListener('mousemove', function(e) {
            mouseX=e.clientX; mouseY=e.clientY;
            // Left-click drag: soft-body grab with quadratic falloff
            if (mouseDown && mouseButton===0 && dragIndex>=0) {
                for (var i=0; i<numParticles; i++) {
                    if (pinnedArr[i]) continue;
                    var dx=posX[i]-posX[dragIndex], dy=posY[i]-posY[dragIndex];
                    var d=Math.sqrt(dx*dx+dy*dy);
                    if (d<dragRadius) {
                        var inf=1-d/dragRadius; inf*=inf;
                        posX[i]+=(mouseX-posX[dragIndex])*inf*0.8;
                        posY[i]+=(mouseY-posY[dragIndex])*inf*0.8;
                    }
                }
                posX[dragIndex]=mouseX; posY[dragIndex]=mouseY;
            }
            // Right-click drag: continuous tear
            if (mouseDown && mouseButton===2) tearAt(mouseX, mouseY);
        });

        canvas.addEventListener('mouseup', function() { mouseDown=false; dragIndex=-1; });
        canvas.addEventListener('mouseleave', function() { mouseDown=false; dragIndex=-1; });
        canvas.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            tearAt(e.clientX, e.clientY);
        });

        function tearAt(mx, my) {
            var r2=tearRadius*tearRadius;
            for (var i=0; i<numConstraints; i++) {
                if (!cActive[i]) continue;
                var cx=(posX[cP1[i]]+posX[cP2[i]])*0.5;
                var cy=(posY[cP1[i]]+posY[cP2[i]])*0.5;
                var dx=cx-mx, dy=cy-my;
                if (dx*dx+dy*dy<r2) cActive[i]=0;
            }
        }

        // Touch support
        canvas.addEventListener('touchstart', function(e) {
            e.preventDefault(); var t=e.touches[0];
            mouseDown=true; mouseButton=0; mouseX=t.clientX; mouseY=t.clientY;
            dragIndex=findClosest(mouseX, mouseY, dragRadius);
        });
        canvas.addEventListener('touchmove', function(e) {
            e.preventDefault(); var t=e.touches[0];
            mouseX=t.clientX; mouseY=t.clientY;
            if (dragIndex>=0) { posX[dragIndex]=mouseX; posY[dragIndex]=mouseY; }
        });
        canvas.addEventListener('touchend', function() { mouseDown=false; dragIndex=-1; });

        // ---- Rendering ----
        // Normalized light direction
        var lx=0.3, ly=-0.6, lz=0.7;
        var ll=Math.sqrt(lx*lx+ly*ly+lz*lz);
        lx/=ll; ly/=ll; lz/=ll;

        // Reusable normal vector to avoid allocations
        var _n=[0,0,0];

        function triNorm(ax,ay,az,bx,by,bz,cx,cy,cz) {
            var e1x=bx-ax,e1y=by-ay,e1z=bz-az;
            var e2x=cx-ax,e2y=cy-ay,e2z=cz-az;
            _n[0]=e1y*e2z-e1z*e2y;
            _n[1]=e1z*e2x-e1x*e2z;
            _n[2]=e1x*e2y-e1y*e2x;
            var len=Math.sqrt(_n[0]*_n[0]+_n[1]*_n[1]+_n[2]*_n[2]);
            if(len<0.0001){_n[0]=0;_n[1]=0;_n[2]=1;}
            else{_n[0]/=len;_n[1]/=len;_n[2]/=len;}
        }

        function drawGrid() {
            ctx.strokeStyle='rgba(60,65,90,0.15)'; ctx.lineWidth=1;
            ctx.beginPath();
            for(var x=0;x<W;x+=50){ctx.moveTo(x,0);ctx.lineTo(x,H);}
            for(var y=0;y<H;y+=50){ctx.moveTo(0,y);ctx.lineTo(W,y);}
            ctx.stroke();
        }

        // Stress/strain color: teal -> yellow -> red
        function stressColor(strain) {
            var s=Math.min(strain,2), r,g,b;
            if(s<0.3){
                var t=s/0.3; r=40+t*30; g=140+t*40; b=180-t*20;
            } else if(s<1){
                var t=(s-0.3)/0.7; r=70+t*185; g=180-t*40; b=160-t*130;
            } else {
                var t=Math.min(s-1,1); r=255; g=140-t*100; b=30-t*30;
            }
            return (r|0)<<16|(g|0)<<8|(b|0);
        }

        // Check if a triangle face is torn (edges stretched beyond 3x rest length)
        function isTorn(i1,i2,i3) {
            var ms2=spacing*spacing*9, dx,dy;
            dx=posX[i2]-posX[i1]; dy=posY[i2]-posY[i1];
            if(dx*dx+dy*dy>ms2)return true;
            dx=posX[i3]-posX[i2]; dy=posY[i3]-posY[i2];
            if(dx*dx+dy*dy>ms2)return true;
            dx=posX[i1]-posX[i3]; dy=posY[i1]-posY[i3];
            if(dx*dx+dy*dy>ms2)return true;
            return false;
        }

        function render() {
            ctx.fillStyle='#0a0a12';
            ctx.fillRect(0,0,W,H);
            drawGrid();

            // Draw sphere obstacle
            if (config.showSphere) {
                var sr=config.sphereRadius;
                var grd=ctx.createRadialGradient(
                    sphereX-sr*0.3, sphereY-sr*0.3, sr*0.1,
                    sphereX, sphereY, sr
                );
                grd.addColorStop(0,'rgba(80,90,120,0.6)');
                grd.addColorStop(0.7,'rgba(40,45,65,0.5)');
                grd.addColorStop(1,'rgba(20,22,35,0.3)');
                ctx.fillStyle=grd;
                ctx.beginPath();
                ctx.arc(sphereX,sphereY,sr,0,Math.PI*2);
                ctx.fill();
                ctx.strokeStyle='rgba(100,115,155,0.3)';
                ctx.lineWidth=1.5;
                ctx.stroke();
            }

            // Render cloth
            if (config.renderMode==='wireframe') renderWireframe();
            else renderShaded(config.renderMode==='stress');

            // Pinned point indicators
            ctx.fillStyle='#7eb8da';
            for(var i=0;i<numParticles;i++){
                if(pinnedArr[i]){
                    ctx.beginPath();
                    ctx.arc(posX[i],posY[i],3.5,0,Math.PI*2);
                    ctx.fill();
                }
            }

            // Mouse drag radius indicator
            if(mouseDown && dragIndex>=0){
                ctx.strokeStyle='rgba(126,184,218,0.4)';
                ctx.lineWidth=1.5;
                ctx.beginPath();
                ctx.arc(mouseX,mouseY,dragRadius,0,Math.PI*2);
                ctx.stroke();
            }
        }

        function renderWireframe() {
            ctx.strokeStyle='rgba(126,184,218,0.35)';
            ctx.lineWidth=0.8;
            ctx.beginPath();
            for(var i=0;i<numConstraints;i++){
                if(!cActive[i]||cType[i]===2)continue;
                ctx.moveTo(posX[cP1[i]],posY[cP1[i]]);
                ctx.lineTo(posX[cP2[i]],posY[cP2[i]]);
            }
            ctx.stroke();
        }

        function renderShaded(showStress) {
            var amb=0.25, dMul=0.75;

            for(var r=0;r<numRows-1;r++){
                for(var c=0;c<numCols-1;c++){
                    var i0=r*numCols+c, i1=i0+1, i2=i0+numCols, i3=i2+1;

                    // Triangle 1: i0, i1, i2
                    if(!isTorn(i0,i1,i2)){
                        triNorm(
                            posX[i0],posY[i0],posZ[i0],
                            posX[i1],posY[i1],posZ[i1],
                            posX[i2],posY[i2],posZ[i2]
                        );
                        var ndl=_n[0]*lx+_n[1]*ly+_n[2]*lz;
                        var light=amb+Math.max(0,ndl)*dMul;
                        var br,bg,bb;

                        if(showStress){
                            var d01=Math.sqrt((posX[i1]-posX[i0])*(posX[i1]-posX[i0])+(posY[i1]-posY[i0])*(posY[i1]-posY[i0])+(posZ[i1]-posZ[i0])*(posZ[i1]-posZ[i0]));
                            var d02=Math.sqrt((posX[i2]-posX[i0])*(posX[i2]-posX[i0])+(posY[i2]-posY[i0])*(posY[i2]-posY[i0])+(posZ[i2]-posZ[i0])*(posZ[i2]-posZ[i0]));
                            var strain=Math.abs(((d01/spacing-1)+(d02/spacing-1))*0.5)*3;
                            var sc=stressColor(strain);
                            br=((sc>>16)&255)*light;
                            bg=((sc>>8)&255)*light;
                            bb=(sc&255)*light;
                        } else {
                            var depth=(posZ[i0]+posZ[i1]+posZ[i2])/3;
                            var df=Math.max(0.5,1+depth*0.002);
                            br=100*df*light; bg=145*df*light; bb=200*df*light;
                        }

                        ctx.fillStyle='rgb('+Math.min(255,br|0)+','+Math.min(255,bg|0)+','+Math.min(255,bb|0)+')';
                        ctx.beginPath();
                        ctx.moveTo(posX[i0],posY[i0]);
                        ctx.lineTo(posX[i1],posY[i1]);
                        ctx.lineTo(posX[i2],posY[i2]);
                        ctx.closePath();
                        ctx.fill();
                    }

                    // Triangle 2: i1, i3, i2
                    if(!isTorn(i1,i3,i2)){
                        triNorm(
                            posX[i1],posY[i1],posZ[i1],
                            posX[i3],posY[i3],posZ[i3],
                            posX[i2],posY[i2],posZ[i2]
                        );
                        var ndl2=_n[0]*lx+_n[1]*ly+_n[2]*lz;
                        var light2=amb+Math.max(0,ndl2)*dMul;
                        var br2,bg2,bb2;

                        if(showStress){
                            var d13=Math.sqrt((posX[i3]-posX[i1])*(posX[i3]-posX[i1])+(posY[i3]-posY[i1])*(posY[i3]-posY[i1])+(posZ[i3]-posZ[i1])*(posZ[i3]-posZ[i1]));
                            var d32=Math.sqrt((posX[i2]-posX[i3])*(posX[i2]-posX[i3])+(posY[i2]-posY[i3])*(posY[i2]-posY[i3])+(posZ[i2]-posZ[i3])*(posZ[i2]-posZ[i3]));
                            var strain2=Math.abs(((d13/spacing-1)+(d32/spacing-1))*0.5)*3;
                            var sc2=stressColor(strain2);
                            br2=((sc2>>16)&255)*light2;
                            bg2=((sc2>>8)&255)*light2;
                            bb2=(sc2&255)*light2;
                        } else {
                            var depth2=(posZ[i1]+posZ[i3]+posZ[i2])/3;
                            var df2=Math.max(0.5,1+depth2*0.002);
                            br2=100*df2*light2; bg2=145*df2*light2; bb2=200*df2*light2;
                        }

                        ctx.fillStyle='rgb('+Math.min(255,br2|0)+','+Math.min(255,bg2|0)+','+Math.min(255,bb2|0)+')';
                        ctx.beginPath();
                        ctx.moveTo(posX[i1],posY[i1]);
                        ctx.lineTo(posX[i3],posY[i3]);
                        ctx.lineTo(posX[i2],posY[i2]);
                        ctx.closePath();
                        ctx.fill();
                    }
                }
            }

            // Subtle structural wireframe overlay for mesh definition
            ctx.strokeStyle='rgba(126,184,218,0.08)';
            ctx.lineWidth=0.5;
            ctx.beginPath();
            for(var i=0;i<numConstraints;i++){
                if(!cActive[i]||cType[i]!==0)continue;
                ctx.moveTo(posX[cP1[i]],posY[cP1[i]]);
                ctx.lineTo(posX[cP2[i]],posY[cP2[i]]);
            }
            ctx.stroke();
        }

        // ---- FPS counter ----
        var fpsFrames=0, fpsLast=performance.now();
        function updateFPS() {
            fpsFrames++;
            var now=performance.now();
            if(now-fpsLast>=500){
                document.getElementById('st-fps').textContent=Math.round(fpsFrames*1000/(now-fpsLast));
                fpsFrames=0; fpsLast=now;
            }
        }

        // ---- Main loop ----
        function loop() {
            updateFPS();
            physicsStep();
            render();
            requestAnimationFrame(loop);
        }

        // ---- UI wiring ----
        function wireSlider(id,key,vid,fmt){
            var el=document.getElementById(id), vl=document.getElementById(vid);
            el.addEventListener('input',function(){
                config[key]=parseFloat(el.value);
                vl.textContent=fmt?fmt(config[key]):config[key];
            });
        }
        wireSlider('sl-gravity','gravity','v-gravity',function(v){return v.toFixed(2);});
        wireSlider('sl-iterations','iterations','v-iterations',function(v){return v|0;});
        wireSlider('sl-damping','damping','v-damping',function(v){return v.toFixed(3);});
        wireSlider('sl-wind-str','windStrength','v-wind-str',function(v){return v.toFixed(2);});
        wireSlider('sl-wind-dir','windDir','v-wind-dir',function(v){return (v|0)+'\u00b0';});
        wireSlider('sl-turbulence','turbulence','v-turbulence',function(v){return v.toFixed(2);});
        wireSlider('sl-sphere-r','sphereRadius','v-sphere-r',function(v){return v|0;});

        // Resolution slider triggers re-init
        document.getElementById('sl-resolution').addEventListener('input',function(){
            config.resolution=parseInt(this.value);
            document.getElementById('v-resolution').textContent=config.resolution;
            initCloth();
        });

        // Preset buttons
        var presetBtns=document.querySelectorAll('.preset-btn');
        presetBtns.forEach(function(btn){
            btn.addEventListener('click',function(){
                config.preset=btn.dataset.preset;
                presetBtns.forEach(function(b){b.classList.remove('active');});
                btn.classList.add('active');
                config.showSphere=false;
                config.windStrength=0;
                document.getElementById('btn-sphere').classList.remove('active');
                document.getElementById('sl-wind-str').value=0;
                document.getElementById('v-wind-str').textContent='0.00';
                initCloth();
            });
        });

        // Wind toggle helper
        function setWindBtn(on){
            var btn=document.getElementById('btn-wind-toggle');
            if(on){
                btn.classList.add('active');
                if(config.windStrength<0.05){
                    config.windStrength=0.6;
                    document.getElementById('sl-wind-str').value=0.6;
                    document.getElementById('v-wind-str').textContent='0.60';
                }
            } else {
                btn.classList.remove('active');
                config.windStrength=0;
                document.getElementById('sl-wind-str').value=0;
                document.getElementById('v-wind-str').textContent='0.00';
            }
        }

        document.getElementById('btn-wind-toggle').addEventListener('click',function(){
            setWindBtn(!this.classList.contains('active'));
        });

        document.getElementById('btn-sphere').addEventListener('click',function(){
            config.showSphere=!config.showSphere;
            this.classList.toggle('active',config.showSphere);
        });

        document.getElementById('btn-pause').addEventListener('click',function(){
            config.paused=!config.paused;
            this.classList.toggle('active',config.paused);
            this.textContent=config.paused?'Resume':'Pause';
            document.getElementById('pause-overlay').style.display=config.paused?'block':'none';
        });

        document.getElementById('btn-reset').addEventListener('click',function(){
            initCloth();
        });

        // Render mode toggle buttons
        var rMap={'btn-shaded':'shaded','btn-wireframe':'wireframe','btn-stress':'stress'};
        Object.keys(rMap).forEach(function(id){
            document.getElementById(id).addEventListener('click',function(){
                config.renderMode=rMap[id];
                document.getElementById('btn-shaded').classList.toggle('active',config.renderMode==='shaded');
                document.getElementById('btn-wireframe').classList.toggle('active',config.renderMode==='wireframe');
                document.getElementById('btn-stress').classList.toggle('active',config.renderMode==='stress');
            });
        });

        // ---- Keyboard shortcuts ----
        document.addEventListener('keydown',function(e){
            if(e.target.tagName==='INPUT') return;
            switch(e.code){
                case 'Space':
                    e.preventDefault();
                    document.getElementById('btn-pause').click();
                    break;
                case 'KeyR': initCloth(); break;
                case 'KeyW': document.getElementById('btn-wind-toggle').click(); break;
                case 'Digit1': document.querySelector('[data-preset="curtain"]').click(); break;
                case 'Digit2': document.querySelector('[data-preset="flag"]').click(); break;
                case 'Digit3': document.querySelector('[data-preset="tablecloth"]').click(); break;
                case 'Digit4': document.querySelector('[data-preset="hammock"]').click(); break;
            }
        });

        // Expose for enhance.js keyboard shortcuts
        window.reset = initCloth;
        window.init = initCloth;

        // ---- Start ----
        initCloth();
        loop();
    })();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
