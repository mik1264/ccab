<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three-Body Problem - CCAB</title>
    <meta name="description" content="Interactive gravitational three-body problem simulation featuring the famous Figure-8 orbit, Lagrange points, and chaotic systems. Watch celestial mechanics unfold.">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #0f0f1a 50%, #000 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }

        canvas {
            display: block;
        }

        .back-link {
            position: fixed;
            top: 15px;
            left: 15px;
            padding: 10px 18px;
            background: rgba(0, 0, 0, 0.6);
            color: #ffd700;
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            transition: all 0.3s ease;
        }

        .back-link:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: translateX(-4px);
        }

        #info {
            position: fixed;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px 20px;
            border-radius: 12px;
            color: #ffd700;
            font-size: 13px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.2);
            z-index: 1000;
            max-width: 250px;
        }

        #info h3 {
            margin-bottom: 10px;
            color: #fff;
        }

        #info p {
            font-size: 11px;
            opacity: 0.8;
            line-height: 1.5;
            margin-top: 10px;
            color: #ddd;
        }

        #presets {
            position: fixed;
            top: 80px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1000;
        }

        button {
            background: rgba(255, 215, 0, 0.15);
            border: 1px solid rgba(255, 215, 0, 0.4);
            color: #ffd700;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        button:hover {
            background: rgba(255, 215, 0, 0.3);
        }

        button.active {
            background: rgba(255, 215, 0, 0.4);
            border-color: #ffd700;
        }

        #controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            z-index: 1000;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-group {
            background: rgba(0, 0, 0, 0.7);
            padding: 12px 16px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .control-group label {
            color: #ffd700;
            font-size: 11px;
            display: block;
            margin-bottom: 5px;
        }

        .control-group input[type="range"] {
            width: 100px;
            accent-color: #ffd700;
        }

        .control-group span {
            color: #fff;
            font-size: 10px;
            margin-left: 6px;
        }

        #fps-display {
            position: fixed;
            bottom: 80px;
            right: 15px;
            background: rgba(0, 0, 0, 0.6);
            color: #ffd700;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
        }

        .legend {
            position: fixed;
            bottom: 20px;
            right: 15px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 11px;
            z-index: 1000;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 4px 0;
            color: #ddd;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <a href="../index.html" class="back-link">‚Üê Back to Gallery</a>

    <div id="info">
        <h3>Three-Body Problem</h3>
        <div>Configuration: <span id="config-name">Figure-8</span></div>
        <div>Energy: <span id="energy">0</span></div>
        <p>
            The three-body problem demonstrates chaotic dynamics -
            no general solution exists. Watch as gravitational forces
            create complex orbital patterns.
        </p>
    </div>

    <div id="presets">
        <button onclick="loadPreset('figure8')" class="active">Figure-8</button>
        <button onclick="loadPreset('lagrange')">Lagrange L4/L5</button>
        <button onclick="loadPreset('binary')">Binary System</button>
        <button onclick="loadPreset('chaotic')">Chaotic</button>
        <button onclick="loadPreset('butterfly')">Butterfly</button>
    </div>

    <div id="fps-display">FPS: <span id="fps">60</span></div>

    <div class="legend">
        <div class="legend-item">
            <div class="legend-dot" style="background: #ff6b6b;"></div>
            Body 1
        </div>
        <div class="legend-item">
            <div class="legend-dot" style="background: #4ecdc4;"></div>
            Body 2
        </div>
        <div class="legend-item">
            <div class="legend-dot" style="background: #ffe66d;"></div>
            Body 3
        </div>
    </div>

    <div id="controls">
        <div class="control-group">
            <label>Trail Length</label>
            <input type="range" id="trailLength" min="100" max="3000" value="1000">
            <span id="trailLengthVal">1000</span>
        </div>
        <div class="control-group">
            <label>Time Scale</label>
            <input type="range" id="timeScale" min="0.1" max="3" step="0.1" value="1">
            <span id="timeScaleVal">1x</span>
        </div>
        <div class="control-group">
            <label>Zoom</label>
            <input type="range" id="zoom" min="50" max="300" value="150">
            <span id="zoomVal">150</span>
        </div>
        <button onclick="resetSimulation()">Reset</button>
        <button onclick="togglePause()">Pause</button>
    </div>

    <canvas id="canvas"></canvas>

    <script>
    // Three-Body Problem Simulation
    // Uses RK4 integration for accurate orbital mechanics
    // Features famous periodic solutions like the Figure-8 orbit

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    // Configuration
    let config = {
        G: 1,                  // Gravitational constant
        trailLength: 1000,
        timeScale: 1,
        zoom: 150,
        dt: 0.001              // Integration timestep
    };

    let paused = false;
    let bodies = [];
    let trails = [[], [], []];

    // Body colors
    const colors = ['#ff6b6b', '#4ecdc4', '#ffe66d'];

    // Preset configurations
    const presets = {
        // Figure-8 orbit discovered by Cris Moore (1993)
        // Three equal masses chase each other along a figure-8 path
        figure8: {
            name: 'Figure-8',
            bodies: [
                { x: -0.97000436, y: 0.24308753, vx: 0.4662036850, vy: 0.4323657300, m: 1 },
                { x: 0.97000436, y: -0.24308753, vx: 0.4662036850, vy: 0.4323657300, m: 1 },
                { x: 0, y: 0, vx: -0.93240737, vy: -0.86473146, m: 1 }
            ]
        },
        // Lagrange point configuration (equilateral triangle)
        lagrange: {
            name: 'Lagrange L4/L5',
            bodies: [
                { x: 0, y: 0, vx: 0, vy: 0, m: 10 },  // Central mass
                { x: 1, y: 0, vx: 0, vy: 1, m: 0.1 },
                { x: 0.5, y: 0.866, vx: -0.866, vy: 0.5, m: 0.1 }
            ]
        },
        // Binary star with planet
        binary: {
            name: 'Binary System',
            bodies: [
                { x: -0.5, y: 0, vx: 0, vy: -0.5, m: 2 },
                { x: 0.5, y: 0, vx: 0, vy: 0.5, m: 2 },
                { x: 2, y: 0, vx: 0, vy: 0.8, m: 0.01 }
            ]
        },
        // Chaotic three-body configuration
        chaotic: {
            name: 'Chaotic',
            bodies: [
                { x: -1, y: 0, vx: 0, vy: 0.2, m: 1 },
                { x: 1, y: 0, vx: 0, vy: -0.1, m: 1 },
                { x: 0, y: 1.5, vx: 0.1, vy: 0, m: 1 }
            ]
        },
        // Butterfly orbit
        butterfly: {
            name: 'Butterfly',
            bodies: [
                { x: -1, y: 0, vx: 0.306893, vy: 0.125507, m: 1 },
                { x: 1, y: 0, vx: 0.306893, vy: 0.125507, m: 1 },
                { x: 0, y: 0, vx: -0.613786, vy: -0.251014, m: 1 }
            ]
        }
    };

    // Resize canvas
    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    resize();
    window.addEventListener('resize', resize);

    // Initialize bodies from preset
    function loadPreset(name) {
        const preset = presets[name];
        bodies = preset.bodies.map(b => ({
            x: b.x, y: b.y,
            vx: b.vx, vy: b.vy,
            m: b.m
        }));
        trails = [[], [], []];
        document.getElementById('config-name').textContent = preset.name;

        // Update button states
        document.querySelectorAll('#presets button').forEach(btn => {
            btn.classList.toggle('active', btn.textContent.toLowerCase().includes(name.split(/(?=[A-Z])/).join(' ').toLowerCase()) ||
                                          btn.textContent === preset.name);
        });
    }

    // Calculate gravitational acceleration on body i
    function computeAcceleration(bodies, i) {
        let ax = 0, ay = 0;
        const bi = bodies[i];

        for (let j = 0; j < bodies.length; j++) {
            if (i === j) continue;
            const bj = bodies[j];

            const dx = bj.x - bi.x;
            const dy = bj.y - bi.y;
            const r2 = dx * dx + dy * dy;
            const r = Math.sqrt(r2);

            // Softening to prevent singularity
            const softening = 0.01;
            const r3 = Math.pow(r2 + softening * softening, 1.5);

            const f = config.G * bj.m / r3;
            ax += f * dx;
            ay += f * dy;
        }

        return { ax, ay };
    }

    // RK4 integration step
    function rk4Step(bodies, dt) {
        const n = bodies.length;

        // Store initial state
        const state0 = bodies.map(b => ({ x: b.x, y: b.y, vx: b.vx, vy: b.vy, m: b.m }));

        // k1
        const k1 = bodies.map((b, i) => {
            const acc = computeAcceleration(bodies, i);
            return { dx: b.vx, dy: b.vy, dvx: acc.ax, dvy: acc.ay };
        });

        // k2
        const state2 = state0.map((b, i) => ({
            x: b.x + k1[i].dx * dt / 2,
            y: b.y + k1[i].dy * dt / 2,
            vx: b.vx + k1[i].dvx * dt / 2,
            vy: b.vy + k1[i].dvy * dt / 2,
            m: b.m
        }));
        const k2 = state2.map((b, i) => {
            const acc = computeAcceleration(state2, i);
            return { dx: b.vx, dy: b.vy, dvx: acc.ax, dvy: acc.ay };
        });

        // k3
        const state3 = state0.map((b, i) => ({
            x: b.x + k2[i].dx * dt / 2,
            y: b.y + k2[i].dy * dt / 2,
            vx: b.vx + k2[i].dvx * dt / 2,
            vy: b.vy + k2[i].dvy * dt / 2,
            m: b.m
        }));
        const k3 = state3.map((b, i) => {
            const acc = computeAcceleration(state3, i);
            return { dx: b.vx, dy: b.vy, dvx: acc.ax, dvy: acc.ay };
        });

        // k4
        const state4 = state0.map((b, i) => ({
            x: b.x + k3[i].dx * dt,
            y: b.y + k3[i].dy * dt,
            vx: b.vx + k3[i].dvx * dt,
            vy: b.vy + k3[i].dvy * dt,
            m: b.m
        }));
        const k4 = state4.map((b, i) => {
            const acc = computeAcceleration(state4, i);
            return { dx: b.vx, dy: b.vy, dvx: acc.ax, dvy: acc.ay };
        });

        // Combine
        for (let i = 0; i < n; i++) {
            bodies[i].x = state0[i].x + dt / 6 * (k1[i].dx + 2 * k2[i].dx + 2 * k3[i].dx + k4[i].dx);
            bodies[i].y = state0[i].y + dt / 6 * (k1[i].dy + 2 * k2[i].dy + 2 * k3[i].dy + k4[i].dy);
            bodies[i].vx = state0[i].vx + dt / 6 * (k1[i].dvx + 2 * k2[i].dvx + 2 * k3[i].dvx + k4[i].dvx);
            bodies[i].vy = state0[i].vy + dt / 6 * (k1[i].dvy + 2 * k2[i].dvy + 2 * k3[i].dvy + k4[i].dvy);
        }
    }

    // Calculate total energy (for display)
    function calculateEnergy() {
        let kinetic = 0;
        let potential = 0;

        for (let i = 0; i < bodies.length; i++) {
            const bi = bodies[i];
            kinetic += 0.5 * bi.m * (bi.vx * bi.vx + bi.vy * bi.vy);

            for (let j = i + 1; j < bodies.length; j++) {
                const bj = bodies[j];
                const dx = bj.x - bi.x;
                const dy = bj.y - bi.y;
                const r = Math.sqrt(dx * dx + dy * dy);
                potential -= config.G * bi.m * bj.m / r;
            }
        }

        return kinetic + potential;
    }

    // Convert simulation coordinates to screen
    function toScreen(x, y) {
        const cx = canvas.width / 2;
        const cy = canvas.height / 2;
        return {
            x: cx + x * config.zoom,
            y: cy - y * config.zoom
        };
    }

    // Drawing
    function draw() {
        // Clear with fade effect for trails
        ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Draw trails
        for (let i = 0; i < bodies.length; i++) {
            const trail = trails[i];
            if (trail.length > 1) {
                ctx.beginPath();
                const start = toScreen(trail[0].x, trail[0].y);
                ctx.moveTo(start.x, start.y);

                for (let j = 1; j < trail.length; j++) {
                    const alpha = j / trail.length;
                    const pos = toScreen(trail[j].x, trail[j].y);
                    ctx.lineTo(pos.x, pos.y);
                }

                ctx.strokeStyle = colors[i];
                ctx.lineWidth = 1.5;
                ctx.globalAlpha = 0.6;
                ctx.stroke();
                ctx.globalAlpha = 1;
            }
        }

        // Draw bodies
        for (let i = 0; i < bodies.length; i++) {
            const b = bodies[i];
            const pos = toScreen(b.x, b.y);
            const radius = 8 + Math.log(b.m + 1) * 4;

            // Glow effect
            const gradient = ctx.createRadialGradient(pos.x, pos.y, 0, pos.x, pos.y, radius * 2);
            gradient.addColorStop(0, colors[i]);
            gradient.addColorStop(0.5, colors[i] + '88');
            gradient.addColorStop(1, 'transparent');
            ctx.beginPath();
            ctx.arc(pos.x, pos.y, radius * 2, 0, Math.PI * 2);
            ctx.fillStyle = gradient;
            ctx.fill();

            // Body
            ctx.beginPath();
            ctx.arc(pos.x, pos.y, radius, 0, Math.PI * 2);
            ctx.fillStyle = colors[i];
            ctx.fill();
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 1;
            ctx.stroke();
        }

        // Draw center of mass
        let comX = 0, comY = 0, totalMass = 0;
        for (const b of bodies) {
            comX += b.x * b.m;
            comY += b.y * b.m;
            totalMass += b.m;
        }
        const com = toScreen(comX / totalMass, comY / totalMass);
        ctx.beginPath();
        ctx.arc(com.x, com.y, 3, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
        ctx.fill();
    }

    function resetSimulation() {
        const currentPreset = document.querySelector('#presets button.active').textContent;
        for (const [key, preset] of Object.entries(presets)) {
            if (preset.name === currentPreset) {
                loadPreset(key);
                break;
            }
        }
    }

    function togglePause() {
        paused = !paused;
    }

    // Setup controls
    function setupControls() {
        document.getElementById('trailLength').addEventListener('input', (e) => {
            config.trailLength = parseInt(e.target.value);
            document.getElementById('trailLengthVal').textContent = config.trailLength;
        });

        document.getElementById('timeScale').addEventListener('input', (e) => {
            config.timeScale = parseFloat(e.target.value);
            document.getElementById('timeScaleVal').textContent = config.timeScale.toFixed(1) + 'x';
        });

        document.getElementById('zoom').addEventListener('input', (e) => {
            config.zoom = parseInt(e.target.value);
            document.getElementById('zoomVal').textContent = config.zoom;
        });
    }

    // Animation loop
    let lastTime = 0;
    let frameCount = 0;
    let fpsTime = 0;

    function animate(currentTime) {
        // FPS counter
        frameCount++;
        if (currentTime - fpsTime > 1000) {
            document.getElementById('fps').textContent = frameCount;
            frameCount = 0;
            fpsTime = currentTime;
        }

        if (!paused) {
            // Integration (multiple sub-steps for stability)
            const subSteps = Math.ceil(10 * config.timeScale);
            const dt = config.dt * config.timeScale / subSteps;

            for (let step = 0; step < subSteps; step++) {
                rk4Step(bodies, dt);
            }

            // Update trails
            for (let i = 0; i < bodies.length; i++) {
                trails[i].push({ x: bodies[i].x, y: bodies[i].y });
                if (trails[i].length > config.trailLength) {
                    trails[i].shift();
                }
            }

            // Update energy display
            const energy = calculateEnergy();
            document.getElementById('energy').textContent = energy.toFixed(4);
        }

        draw();
        lastTime = currentTime;
        requestAnimationFrame(animate);
    }

    // Start
    setupControls();
    loadPreset('figure8');
    requestAnimationFrame(animate);
    </script>
</body>
</html>
