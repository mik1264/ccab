<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Public Transit Network | Traffic Systems</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            overflow: hidden;
        }
        #canvas { display: block; }
        .controls {
            position: fixed;
            top: 20px; right: 20px;
            background: rgba(0,0,0,0.85);
            padding: 20px; border-radius: 15px;
            min-width: 280px;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        h1 { color: #60a5fa; font-size: 1.3em; margin-bottom: 15px; }
        .control-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; color: #aaa; font-size: 0.9em; }
        input[type="range"], select { width: 100%; }
        .value { float: right; color: #60a5fa; }
        button {
            width: 100%; padding: 10px; margin: 5px 0;
            border: none; border-radius: 8px;
            background: #3b82f6; color: white;
            font-weight: bold; cursor: pointer;
        }
        button:hover { background: #60a5fa; }
        .stats { margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); }
        .stat-row { display: flex; justify-content: space-between; padding: 5px 0; font-size: 0.9em; }
        .stat-label { color: #888; }
        .stat-value { color: #60a5fa; font-weight: bold; }
        .info { font-size: 0.8em; color: #666; margin-top: 15px; line-height: 1.5; }
        a.back-link {
            position: fixed; top: 20px; left: 20px;
            color: #60a5fa; text-decoration: none;
            background: rgba(0,0,0,0.8); padding: 10px 20px;
            border-radius: 25px; font-size: 0.9em;
        }
        .line-legend {
            display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;
        }
        .line-item {
            display: flex; align-items: center; gap: 5px; font-size: 0.85em;
        }
        .line-color { width: 20px; height: 8px; border-radius: 2px; }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <a href="index.html" class="back-link">‚Üê Back to Traffic Systems</a>

    <div class="controls">
        <h1>Public Transit Network</h1>
        <p style="font-size:0.85em; color:#888; margin-bottom:15px;">Bus/metro simulation</p>

        <div class="control-group">
            <label>Passenger Spawn Rate: <span class="value" id="spawnValue">0.1</span></label>
            <input type="range" id="spawnRate" min="0.02" max="0.3" step="0.02" value="0.1">
        </div>

        <div class="control-group">
            <label>Vehicle Capacity: <span class="value" id="capacityValue">30</span></label>
            <input type="range" id="capacity" min="10" max="60" step="5" value="30">
        </div>

        <div class="control-group">
            <label>Frequency (vehicles): <span class="value" id="freqValue">3</span></label>
            <input type="range" id="frequency" min="1" max="5" step="1" value="3">
        </div>

        <div class="control-group">
            <label>Speed: <span class="value" id="speedValue">2</span></label>
            <input type="range" id="speed" min="1" max="4" step="0.5" value="2">
        </div>

        <button id="runBtn">Start Simulation</button>
        <button id="resetBtn" style="background:#444;color:#fff">Reset</button>

        <div class="stats">
            <div class="stat-row">
                <span class="stat-label">Passengers Delivered</span>
                <span class="stat-value" id="delivered">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Waiting at Stations</span>
                <span class="stat-value" id="waiting">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">In Transit</span>
                <span class="stat-value" id="inTransit">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Avg Wait Time</span>
                <span class="stat-value" id="avgWait">0</span>
            </div>
        </div>

        <div class="line-legend" id="legend"></div>

        <div class="info">
            <strong>Network:</strong> Multi-line transit with transfers.<br>
            <strong>Goal:</strong> Efficient passenger movement.
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            initNetwork();
        }
        resize();
        window.onresize = resize;

        let stations = [];
        let lines = [];
        let vehicles = [];
        let passengers = [];
        let spawnRate = 0.1;
        let vehicleCapacity = 30;
        let vehicleFrequency = 3;
        let vehicleSpeed = 2;
        let running = false;
        let timeStep = 0;
        let passengersDelivered = 0;
        let totalWaitTime = 0;

        const lineColors = ['#ef4444', '#3b82f6', '#22c55e', '#f59e0b'];
        const lineNames = ['Red Line', 'Blue Line', 'Green Line', 'Orange Line'];

        function initNetwork() {
            stations = [];
            lines = [];
            vehicles = [];
            passengers = [];
            timeStep = 0;
            passengersDelivered = 0;
            totalWaitTime = 0;

            const centerX = (canvas.width - 350) / 2;
            const centerY = canvas.height / 2;

            // Create stations
            const stationPositions = [
                { x: centerX - 200, y: centerY - 150, name: 'North West' },
                { x: centerX, y: centerY - 180, name: 'North Central' },
                { x: centerX + 200, y: centerY - 150, name: 'North East' },
                { x: centerX - 250, y: centerY, name: 'West' },
                { x: centerX, y: centerY, name: 'Central' },
                { x: centerX + 250, y: centerY, name: 'East' },
                { x: centerX - 200, y: centerY + 150, name: 'South West' },
                { x: centerX, y: centerY + 180, name: 'South Central' },
                { x: centerX + 200, y: centerY + 150, name: 'South East' }
            ];

            for (let i = 0; i < stationPositions.length; i++) {
                stations.push({
                    id: i,
                    x: stationPositions[i].x,
                    y: stationPositions[i].y,
                    name: stationPositions[i].name,
                    passengers: []
                });
            }

            // Create lines (connecting stations)
            lines = [
                { id: 0, color: lineColors[0], stations: [0, 1, 2, 5, 8], name: lineNames[0] },
                { id: 1, color: lineColors[1], stations: [0, 3, 6, 7, 8], name: lineNames[1] },
                { id: 2, color: lineColors[2], stations: [3, 4, 5], name: lineNames[2] },
                { id: 3, color: lineColors[3], stations: [1, 4, 7], name: lineNames[3] }
            ];

            // Create vehicles for each line
            for (const line of lines) {
                for (let i = 0; i < vehicleFrequency; i++) {
                    const offset = i / vehicleFrequency;
                    vehicles.push({
                        lineId: line.id,
                        color: line.color,
                        position: offset,
                        direction: 1,
                        currentStationIndex: Math.floor(offset * line.stations.length),
                        passengers: [],
                        atStation: false,
                        dwellTime: 0
                    });
                }
            }

            updateLegend();
        }

        function updateLegend() {
            const legend = document.getElementById('legend');
            legend.innerHTML = '';
            for (let i = 0; i < lines.length; i++) {
                const item = document.createElement('div');
                item.className = 'line-item';
                item.innerHTML = `<div class="line-color" style="background:${lineColors[i]}"></div>${lineNames[i]}`;
                legend.appendChild(item);
            }
        }

        function findPath(fromStation, toStation) {
            // BFS to find path through lines
            const queue = [{ station: fromStation, path: [], line: null }];
            const visited = new Set([fromStation]);

            while (queue.length > 0) {
                const current = queue.shift();

                for (const line of lines) {
                    const stationIdx = line.stations.indexOf(current.station);
                    if (stationIdx === -1) continue;

                    // Check neighbors on this line
                    for (const delta of [-1, 1]) {
                        const neighborIdx = stationIdx + delta;
                        if (neighborIdx < 0 || neighborIdx >= line.stations.length) continue;

                        const neighbor = line.stations[neighborIdx];
                        if (visited.has(neighbor)) continue;

                        const newPath = [...current.path, { lineId: line.id, toStation: neighbor }];

                        if (neighbor === toStation) {
                            return newPath;
                        }

                        visited.add(neighbor);
                        queue.push({ station: neighbor, path: newPath, line: line.id });
                    }
                }
            }
            return null;
        }

        function spawnPassenger() {
            const fromIdx = Math.floor(Math.random() * stations.length);
            let toIdx;
            do {
                toIdx = Math.floor(Math.random() * stations.length);
            } while (toIdx === fromIdx);

            const path = findPath(fromIdx, toIdx);
            if (!path) return;

            stations[fromIdx].passengers.push({
                from: fromIdx,
                to: toIdx,
                path: path,
                pathIndex: 0,
                waitTime: 0,
                spawnTime: timeStep
            });
        }

        function update() {
            if (!running) return;

            timeStep++;

            // Spawn passengers
            if (Math.random() < spawnRate) {
                spawnPassenger();
            }

            // Update waiting times
            for (const station of stations) {
                for (const p of station.passengers) {
                    p.waitTime++;
                }
            }

            // Update vehicles
            for (const vehicle of vehicles) {
                const line = lines[vehicle.lineId];

                if (vehicle.atStation) {
                    vehicle.dwellTime++;

                    // Passenger alighting
                    const currentStation = line.stations[vehicle.currentStationIndex];
                    vehicle.passengers = vehicle.passengers.filter(p => {
                        if (p.path[p.pathIndex].toStation === currentStation) {
                            p.pathIndex++;
                            if (p.pathIndex >= p.path.length) {
                                // Reached destination
                                passengersDelivered++;
                                totalWaitTime += p.waitTime;
                                return false;
                            } else {
                                // Transfer needed
                                stations[currentStation].passengers.push(p);
                                return false;
                            }
                        }
                        return true;
                    });

                    // Passenger boarding
                    const station = stations[currentStation];
                    station.passengers = station.passengers.filter(p => {
                        if (vehicle.passengers.length >= vehicleCapacity) return true;
                        if (p.pathIndex >= p.path.length) return true;

                        const nextStep = p.path[p.pathIndex];
                        if (nextStep.lineId === vehicle.lineId) {
                            // Check direction
                            const nextStationIdx = line.stations.indexOf(nextStep.toStation);
                            const goingRight = nextStationIdx > vehicle.currentStationIndex;
                            if ((goingRight && vehicle.direction === 1) ||
                                (!goingRight && vehicle.direction === -1)) {
                                vehicle.passengers.push(p);
                                return false;
                            }
                        }
                        return true;
                    });

                    if (vehicle.dwellTime > 30) {
                        vehicle.atStation = false;
                        vehicle.dwellTime = 0;
                    }
                } else {
                    // Move vehicle
                    vehicle.position += vehicleSpeed * 0.005 * vehicle.direction;

                    // Check if at station
                    const nextStationIndex = vehicle.currentStationIndex + vehicle.direction;
                    const progress = vehicle.currentStationIndex / (line.stations.length - 1);
                    const nextProgress = nextStationIndex / (line.stations.length - 1);

                    if ((vehicle.direction === 1 && vehicle.position >= nextProgress) ||
                        (vehicle.direction === -1 && vehicle.position <= nextProgress)) {

                        vehicle.currentStationIndex = nextStationIndex;
                        vehicle.position = nextProgress;
                        vehicle.atStation = true;

                        // Reverse at end
                        if (nextStationIndex === 0 || nextStationIndex === line.stations.length - 1) {
                            vehicle.direction *= -1;
                        }
                    }
                }
            }

            updateStats();
        }

        function updateStats() {
            let waiting = 0;
            for (const station of stations) {
                waiting += station.passengers.length;
            }

            let inTransit = 0;
            for (const vehicle of vehicles) {
                inTransit += vehicle.passengers.length;
            }

            document.getElementById('delivered').textContent = passengersDelivered;
            document.getElementById('waiting').textContent = waiting;
            document.getElementById('inTransit').textContent = inTransit;
            document.getElementById('avgWait').textContent = passengersDelivered > 0 ?
                (totalWaitTime / passengersDelivered).toFixed(1) : '0';
        }

        function draw() {
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            update();

            // Draw lines
            for (const line of lines) {
                ctx.strokeStyle = line.color;
                ctx.lineWidth = 6;
                ctx.lineCap = 'round';
                ctx.beginPath();

                for (let i = 0; i < line.stations.length; i++) {
                    const station = stations[line.stations[i]];
                    if (i === 0) ctx.moveTo(station.x, station.y);
                    else ctx.lineTo(station.x, station.y);
                }
                ctx.stroke();
            }

            // Draw stations
            for (const station of stations) {
                // Station circle
                ctx.beginPath();
                ctx.arc(station.x, station.y, 15, 0, Math.PI * 2);
                ctx.fillStyle = '#fff';
                ctx.fill();
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 3;
                ctx.stroke();

                // Waiting count
                if (station.passengers.length > 0) {
                    ctx.beginPath();
                    ctx.arc(station.x + 15, station.y - 15, 10, 0, Math.PI * 2);
                    ctx.fillStyle = '#fbbf24';
                    ctx.fill();
                    ctx.fillStyle = '#000';
                    ctx.font = 'bold 10px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(station.passengers.length, station.x + 15, station.y - 11);
                }

                // Station name
                ctx.fillStyle = '#888';
                ctx.font = '11px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(station.name, station.x, station.y + 30);
            }

            // Draw vehicles
            for (const vehicle of vehicles) {
                const line = lines[vehicle.lineId];

                // Calculate position along line
                const stationIdx = Math.floor(vehicle.position * (line.stations.length - 1));
                const nextIdx = Math.min(stationIdx + 1, line.stations.length - 1);
                const t = (vehicle.position * (line.stations.length - 1)) - stationIdx;

                const s1 = stations[line.stations[stationIdx]];
                const s2 = stations[line.stations[nextIdx]];

                const x = s1.x + (s2.x - s1.x) * t;
                const y = s1.y + (s2.y - s1.y) * t;

                // Vehicle body
                ctx.beginPath();
                ctx.arc(x, y, 12, 0, Math.PI * 2);
                ctx.fillStyle = vehicle.color;
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Passenger count
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 9px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(vehicle.passengers.length, x, y + 3);

                // At station indicator
                if (vehicle.atStation) {
                    ctx.beginPath();
                    ctx.arc(x, y, 16, 0, Math.PI * 2);
                    ctx.strokeStyle = '#fbbf24';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            }

            // Title
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 18px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('Public Transit Network', 50, 30);

            requestAnimationFrame(draw);
        }

        // Event listeners
        document.getElementById('spawnRate').oninput = (e) => {
            spawnRate = parseFloat(e.target.value);
            document.getElementById('spawnValue').textContent = spawnRate.toFixed(2);
        };

        document.getElementById('capacity').oninput = (e) => {
            vehicleCapacity = parseInt(e.target.value);
            document.getElementById('capacityValue').textContent = vehicleCapacity;
        };

        document.getElementById('frequency').oninput = (e) => {
            vehicleFrequency = parseInt(e.target.value);
            document.getElementById('freqValue').textContent = vehicleFrequency;
        };

        document.getElementById('speed').oninput = (e) => {
            vehicleSpeed = parseFloat(e.target.value);
            document.getElementById('speedValue').textContent = vehicleSpeed;
        };

        document.getElementById('runBtn').onclick = () => {
            running = !running;
            document.getElementById('runBtn').textContent = running ? 'Pause' : 'Start Simulation';
        };

        document.getElementById('resetBtn').onclick = initNetwork;

        // Initialize
        initNetwork();
        draw();
    </script>
</body>
</html>
