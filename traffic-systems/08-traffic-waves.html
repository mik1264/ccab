<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phantom Traffic Jams | Traffic Systems</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            overflow: hidden;
        }
        #canvas { display: block; }
        .controls {
            position: fixed;
            top: 20px; right: 20px;
            background: rgba(0,0,0,0.85);
            padding: 20px; border-radius: 15px;
            min-width: 280px;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        h1 { color: #60a5fa; font-size: 1.3em; margin-bottom: 15px; }
        .control-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; color: #aaa; font-size: 0.9em; }
        input[type="range"], select { width: 100%; }
        .value { float: right; color: #60a5fa; }
        button {
            width: 100%; padding: 10px; margin: 5px 0;
            border: none; border-radius: 8px;
            background: #3b82f6; color: white;
            font-weight: bold; cursor: pointer;
        }
        button:hover { background: #60a5fa; }
        .stats { margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); }
        .stat-row { display: flex; justify-content: space-between; padding: 5px 0; font-size: 0.9em; }
        .stat-label { color: #888; }
        .stat-value { color: #60a5fa; font-weight: bold; }
        .info { font-size: 0.8em; color: #666; margin-top: 15px; line-height: 1.5; }
        a.back-link {
            position: fixed; top: 20px; left: 20px;
            color: #60a5fa; text-decoration: none;
            background: rgba(0,0,0,0.8); padding: 10px 20px;
            border-radius: 25px; font-size: 0.9em;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <a href="index.html" class="back-link">‚Üê Back to Traffic Systems</a>

    <div class="controls">
        <h1>Phantom Traffic Jams</h1>
        <p style="font-size:0.85em; color:#888; margin-bottom:15px;">Self-organizing traffic waves</p>

        <div class="control-group">
            <label>Number of Cars: <span class="value" id="carsValue">30</span></label>
            <input type="range" id="numCars" min="10" max="50" step="1" value="30">
        </div>

        <div class="control-group">
            <label>Desired Speed: <span class="value" id="speedValue">5</span></label>
            <input type="range" id="desiredSpeed" min="2" max="10" step="0.5" value="5">
        </div>

        <div class="control-group">
            <label>Reaction Time: <span class="value" id="reactionValue">0.8</span></label>
            <input type="range" id="reactionTime" min="0.3" max="1.5" step="0.1" value="0.8">
        </div>

        <div class="control-group">
            <label>Following Distance: <span class="value" id="followingValue">2</span></label>
            <input type="range" id="followingDist" min="1" max="5" step="0.5" value="2">
        </div>

        <button id="runBtn">Start Simulation</button>
        <button id="resetBtn" style="background:#444;color:#fff">Reset</button>
        <button id="brakeBtn" style="background:#ef4444">Trigger Brake</button>

        <div class="stats">
            <div class="stat-row">
                <span class="stat-label">Time</span>
                <span class="stat-value" id="timeStep">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Average Speed</span>
                <span class="stat-value" id="avgSpeed">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Speed Variance</span>
                <span class="stat-value" id="variance">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Wave Detected</span>
                <span class="stat-value" id="waveDetected">No</span>
            </div>
        </div>

        <div class="info">
            <strong>Phantom jam:</strong> Traffic wave with no apparent cause.<br>
            <strong>Trigger:</strong> Small perturbation amplifies into stop-and-go.
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            initSimulation();
        }
        resize();
        window.onresize = resize;

        let cars = [];
        let numCars = 30;
        let desiredSpeed = 5;
        let reactionTime = 0.8;
        let followingDistance = 2;
        let running = false;
        let timeStep = 0;
        let speedHistory = [];

        const centerX = 400;
        const centerY = 300;
        let radius;

        function initSimulation() {
            cars = [];
            timeStep = 0;
            speedHistory = [];

            const maxRadius = Math.min(canvas.width - 400, canvas.height - 100) / 2 - 50;
            radius = Math.max(150, maxRadius);

            const circumference = 2 * Math.PI * radius;
            const spacing = circumference / numCars;

            for (let i = 0; i < numCars; i++) {
                const angle = (i / numCars) * 2 * Math.PI;
                cars.push({
                    angle,
                    speed: desiredSpeed,
                    targetSpeed: desiredSpeed,
                    acceleration: 0,
                    color: `hsl(${(i / numCars) * 360}, 70%, 50%)`
                });
            }
        }

        function triggerBrake() {
            // One car brakes suddenly
            const brakeIdx = Math.floor(Math.random() * cars.length);
            cars[brakeIdx].speed = 0;
            cars[brakeIdx].targetSpeed = 0;
        }

        function getDistance(car1, car2) {
            let angleDiff = car2.angle - car1.angle;
            if (angleDiff < 0) angleDiff += 2 * Math.PI;
            return angleDiff * radius;
        }

        function update() {
            if (!running) return;

            timeStep++;
            const dt = 0.1;

            // IDM (Intelligent Driver Model) parameters
            const a = 1.5;  // Max acceleration
            const b = 2.0;  // Comfortable deceleration
            const s0 = 20;  // Minimum gap
            const T = reactionTime;  // Desired time headway

            for (let i = 0; i < cars.length; i++) {
                const car = cars[i];
                const nextCar = cars[(i + 1) % cars.length];

                // Distance to car ahead
                let gap = getDistance(car, nextCar) - 30; // 30 = car length
                if (gap < 0) gap += 2 * Math.PI * radius;

                // Relative speed
                const deltaV = car.speed - nextCar.speed;

                // Desired dynamic distance
                const sStar = s0 + Math.max(0, car.speed * T + (car.speed * deltaV) / (2 * Math.sqrt(a * b)));

                // IDM acceleration
                const freeRoadTerm = Math.pow(car.speed / desiredSpeed, 4);
                const interactionTerm = Math.pow(sStar / gap, 2);
                car.acceleration = a * (1 - freeRoadTerm - interactionTerm);

                // Limit acceleration
                car.acceleration = Math.max(-b * 2, Math.min(a, car.acceleration));
            }

            // Update speeds and positions
            for (const car of cars) {
                car.speed += car.acceleration * dt;
                car.speed = Math.max(0, Math.min(desiredSpeed * 1.5, car.speed));

                // Move along circle
                car.angle += (car.speed * dt) / radius;
                if (car.angle > 2 * Math.PI) car.angle -= 2 * Math.PI;
            }

            updateStats();
        }

        function updateStats() {
            let totalSpeed = 0;
            for (const car of cars) {
                totalSpeed += car.speed;
            }
            const avgSpeed = totalSpeed / cars.length;

            let variance = 0;
            for (const car of cars) {
                variance += Math.pow(car.speed - avgSpeed, 2);
            }
            variance = Math.sqrt(variance / cars.length);

            const waveDetected = variance > desiredSpeed * 0.3;

            document.getElementById('timeStep').textContent = timeStep;
            document.getElementById('avgSpeed').textContent = avgSpeed.toFixed(2);
            document.getElementById('variance').textContent = variance.toFixed(2);
            document.getElementById('waveDetected').textContent = waveDetected ? 'Yes' : 'No';
            document.getElementById('waveDetected').style.color = waveDetected ? '#ef4444' : '#22c55e';

            speedHistory.push({ avg: avgSpeed, variance });
            if (speedHistory.length > 300) speedHistory.shift();
        }

        function drawSpeedGraph() {
            const graphX = 50;
            const graphY = canvas.height - 200;
            const graphW = canvas.width - 450;
            const graphH = 150;

            ctx.fillStyle = 'rgba(0,0,0,0.4)';
            ctx.fillRect(graphX - 10, graphY - 30, graphW + 20, graphH + 50);

            ctx.fillStyle = '#fff';
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('Average Speed & Variance Over Time', graphX, graphY - 10);

            if (speedHistory.length < 2) return;

            // Average speed
            ctx.beginPath();
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 2;
            for (let i = 0; i < speedHistory.length; i++) {
                const x = graphX + (i / (speedHistory.length - 1)) * graphW;
                const y = graphY + graphH - (speedHistory[i].avg / (desiredSpeed * 1.5)) * graphH;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            // Variance
            ctx.beginPath();
            ctx.strokeStyle = '#ef4444';
            ctx.lineWidth = 1;
            ctx.setLineDash([4, 4]);
            const maxVariance = Math.max(...speedHistory.map(h => h.variance), 1);
            for (let i = 0; i < speedHistory.length; i++) {
                const x = graphX + (i / (speedHistory.length - 1)) * graphW;
                const y = graphY + graphH - (speedHistory[i].variance / maxVariance) * graphH * 0.5;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();
            ctx.setLineDash([]);

            // Legend
            ctx.fillStyle = '#3b82f6';
            ctx.fillRect(graphX + graphW - 150, graphY - 20, 15, 3);
            ctx.fillStyle = '#ef4444';
            ctx.fillRect(graphX + graphW - 150, graphY - 10, 15, 3);
            ctx.fillStyle = '#888';
            ctx.font = '11px sans-serif';
            ctx.fillText('Avg Speed', graphX + graphW - 130, graphY - 16);
            ctx.fillText('Variance', graphX + graphW - 130, graphY - 6);
        }

        function draw() {
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            update();

            const cx = (canvas.width - 350) / 2;
            const cy = canvas.height / 2 - 50;

            // Draw road (ring)
            ctx.beginPath();
            ctx.arc(cx, cy, radius + 25, 0, Math.PI * 2);
            ctx.fillStyle = '#333';
            ctx.fill();

            ctx.beginPath();
            ctx.arc(cx, cy, radius - 25, 0, Math.PI * 2);
            ctx.fillStyle = '#1a1a2e';
            ctx.fill();

            // Road markings
            ctx.setLineDash([10, 15]);
            ctx.strokeStyle = '#555';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(cx, cy, radius, 0, Math.PI * 2);
            ctx.stroke();
            ctx.setLineDash([]);

            // Outer edge
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(cx, cy, radius + 25, 0, Math.PI * 2);
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(cx, cy, radius - 25, 0, Math.PI * 2);
            ctx.stroke();

            // Draw cars
            for (const car of cars) {
                const x = cx + Math.cos(car.angle) * radius;
                const y = cy + Math.sin(car.angle) * radius;

                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(car.angle + Math.PI / 2);

                // Speed-based color (red = slow, green = fast)
                const speedRatio = car.speed / desiredSpeed;
                const hue = speedRatio * 120; // 0 = red, 120 = green
                ctx.fillStyle = `hsl(${hue}, 70%, 50%)`;

                // Car body
                ctx.fillRect(-10, -15, 20, 30);

                // Brake lights
                if (car.speed < desiredSpeed * 0.3) {
                    ctx.fillStyle = '#ef4444';
                    ctx.fillRect(-8, 12, 5, 3);
                    ctx.fillRect(3, 12, 5, 3);
                }

                ctx.restore();
            }

            // Speed distribution around ring
            ctx.font = '11px sans-serif';
            ctx.textAlign = 'center';
            for (let i = 0; i < 8; i++) {
                const angle = (i / 8) * Math.PI * 2;
                const x = cx + Math.cos(angle) * (radius + 50);
                const y = cy + Math.sin(angle) * (radius + 50);

                // Find nearest car
                let minDist = Infinity;
                let nearestSpeed = 0;
                for (const car of cars) {
                    const dist = Math.abs(car.angle - angle);
                    if (dist < minDist) {
                        minDist = dist;
                        nearestSpeed = car.speed;
                    }
                }

                ctx.fillStyle = `hsl(${(nearestSpeed / desiredSpeed) * 120}, 70%, 50%)`;
                ctx.fillText(nearestSpeed.toFixed(1), x, y);
            }

            drawSpeedGraph();

            // Title
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 18px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('Phantom Traffic Jam Demonstration', 50, 30);

            ctx.font = '12px sans-serif';
            ctx.fillStyle = '#888';
            ctx.fillText('Ring road simulation - watch for traffic waves', 50, 50);

            requestAnimationFrame(draw);
        }

        // Event listeners
        document.getElementById('numCars').oninput = (e) => {
            numCars = parseInt(e.target.value);
            document.getElementById('carsValue').textContent = numCars;
        };

        document.getElementById('desiredSpeed').oninput = (e) => {
            desiredSpeed = parseFloat(e.target.value);
            document.getElementById('speedValue').textContent = desiredSpeed;
        };

        document.getElementById('reactionTime').oninput = (e) => {
            reactionTime = parseFloat(e.target.value);
            document.getElementById('reactionValue').textContent = reactionTime.toFixed(1);
        };

        document.getElementById('followingDist').oninput = (e) => {
            followingDistance = parseFloat(e.target.value);
            document.getElementById('followingValue').textContent = followingDistance;
        };

        document.getElementById('runBtn').onclick = () => {
            running = !running;
            document.getElementById('runBtn').textContent = running ? 'Pause' : 'Start Simulation';
        };

        document.getElementById('resetBtn').onclick = initSimulation;
        document.getElementById('brakeBtn').onclick = triggerBrake;

        // Initialize
        initSimulation();
        draw();
    </script>
</body>
</html>
