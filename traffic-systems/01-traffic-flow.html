<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffic Flow | Traffic Systems</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            overflow: hidden;
        }
        #canvas { display: block; }
        .controls {
            position: fixed;
            top: 20px; right: 20px;
            background: rgba(0,0,0,0.85);
            padding: 20px; border-radius: 15px;
            min-width: 280px;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        h1 { color: #60a5fa; font-size: 1.3em; margin-bottom: 15px; }
        .control-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; color: #aaa; font-size: 0.9em; }
        input[type="range"], select { width: 100%; }
        .value { float: right; color: #60a5fa; }
        button {
            width: 100%; padding: 10px; margin: 5px 0;
            border: none; border-radius: 8px;
            background: #3b82f6; color: white;
            font-weight: bold; cursor: pointer;
        }
        button:hover { background: #60a5fa; }
        .stats { margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); }
        .stat-row { display: flex; justify-content: space-between; padding: 5px 0; font-size: 0.9em; }
        .stat-label { color: #888; }
        .stat-value { color: #60a5fa; font-weight: bold; }
        .info { font-size: 0.8em; color: #666; margin-top: 15px; line-height: 1.5; }
        a.back-link {
            position: fixed; top: 20px; left: 20px;
            color: #60a5fa; text-decoration: none;
            background: rgba(0,0,0,0.8); padding: 10px 20px;
            border-radius: 25px; font-size: 0.9em;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <a href="index.html" class="back-link">← Back to Traffic Systems</a>

    <div class="controls">
        <h1>Traffic Flow Simulation</h1>
        <p style="font-size:0.85em; color:#888; margin-bottom:15px;">Nagel-Schreckenberg model</p>

        <div class="control-group">
            <label>Road Length: <span class="value" id="lengthValue">100</span></label>
            <input type="range" id="roadLength" min="50" max="200" step="10" value="100">
        </div>

        <div class="control-group">
            <label>Vehicle Density: <span class="value" id="densityValue">0.3</span></label>
            <input type="range" id="density" min="0.1" max="0.8" step="0.05" value="0.3">
        </div>

        <div class="control-group">
            <label>Max Speed: <span class="value" id="speedValue">5</span></label>
            <input type="range" id="maxSpeed" min="1" max="10" step="1" value="5">
        </div>

        <div class="control-group">
            <label>Random Slowdown: <span class="value" id="slowdownValue">0.3</span></label>
            <input type="range" id="slowdown" min="0" max="0.8" step="0.05" value="0.3">
        </div>

        <div class="control-group">
            <label>Lanes: <span class="value" id="lanesValue">3</span></label>
            <input type="range" id="lanes" min="1" max="5" step="1" value="3">
        </div>

        <button id="runBtn">Start Simulation</button>
        <button id="resetBtn" style="background:#444;color:#fff">Reset</button>

        <div class="stats">
            <div class="stat-row">
                <span class="stat-label">Time Step</span>
                <span class="stat-value" id="timeStep">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Average Speed</span>
                <span class="stat-value" id="avgSpeed">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Flow Rate</span>
                <span class="stat-value" id="flowRate">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Traffic Jams</span>
                <span class="stat-value" id="jams">0</span>
            </div>
        </div>

        <div class="info">
            <strong>Nagel-Schreckenberg:</strong> Discrete cellular automaton for traffic.<br>
            <strong>Random slowdown:</strong> Models driver reaction time and imperfection.
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            initRoad();
        }
        resize();
        window.onresize = resize;

        let road = [];
        let roadLength = 100;
        let density = 0.3;
        let maxSpeed = 5;
        let randomSlowdown = 0.3;
        let numLanes = 3;
        let running = false;
        let timeStep = 0;
        let history = [];

        function initRoad() {
            road = [];
            history = [];
            timeStep = 0;

            for (let lane = 0; lane < numLanes; lane++) {
                road[lane] = [];
                for (let i = 0; i < roadLength; i++) {
                    if (Math.random() < density) {
                        road[lane][i] = {
                            speed: Math.floor(Math.random() * (maxSpeed + 1)),
                            color: `hsl(${Math.random() * 60 + 180}, 70%, 50%)`
                        };
                    } else {
                        road[lane][i] = null;
                    }
                }
            }

            updateStats();
        }

        function getDistance(lane, pos) {
            for (let d = 1; d <= roadLength; d++) {
                const nextPos = (pos + d) % roadLength;
                if (road[lane][nextPos]) return d;
            }
            return roadLength;
        }

        function step() {
            // Nagel-Schreckenberg rules for each lane
            for (let lane = 0; lane < numLanes; lane++) {
                const newLane = new Array(roadLength).fill(null);

                for (let i = 0; i < roadLength; i++) {
                    const car = road[lane][i];
                    if (!car) continue;

                    // Rule 1: Acceleration
                    if (car.speed < maxSpeed) {
                        car.speed++;
                    }

                    // Rule 2: Slowing down
                    const dist = getDistance(lane, i);
                    if (car.speed >= dist) {
                        car.speed = dist - 1;
                    }

                    // Rule 3: Randomization
                    if (car.speed > 0 && Math.random() < randomSlowdown) {
                        car.speed--;
                    }

                    // Rule 4: Movement
                    const newPos = (i + car.speed) % roadLength;
                    if (!newLane[newPos]) {
                        newLane[newPos] = car;
                    } else {
                        // Collision prevention
                        newLane[i] = car;
                        car.speed = 0;
                    }
                }

                road[lane] = newLane;
            }

            // Lane changing
            for (let lane = 0; lane < numLanes; lane++) {
                for (let i = 0; i < roadLength; i++) {
                    const car = road[lane][i];
                    if (!car) continue;

                    const distAhead = getDistance(lane, i);

                    // Try to change lane if blocked
                    if (distAhead < car.speed + 2) {
                        // Check left lane
                        if (lane > 0 && !road[lane - 1][i]) {
                            const leftDist = getDistance(lane - 1, i);
                            if (leftDist > distAhead && Math.random() < 0.5) {
                                road[lane - 1][i] = car;
                                road[lane][i] = null;
                                continue;
                            }
                        }
                        // Check right lane
                        if (lane < numLanes - 1 && !road[lane + 1][i]) {
                            const rightDist = getDistance(lane + 1, i);
                            if (rightDist > distAhead && Math.random() < 0.5) {
                                road[lane + 1][i] = car;
                                road[lane][i] = null;
                            }
                        }
                    }
                }
            }

            timeStep++;
        }

        function update() {
            if (!running) return;
            step();
            updateStats();
        }

        function countJams() {
            let jams = 0;
            for (let lane = 0; lane < numLanes; lane++) {
                let jamLength = 0;
                for (let i = 0; i < roadLength; i++) {
                    if (road[lane][i] && road[lane][i].speed === 0) {
                        jamLength++;
                    } else {
                        if (jamLength >= 3) jams++;
                        jamLength = 0;
                    }
                }
                if (jamLength >= 3) jams++;
            }
            return jams;
        }

        function getAverageSpeed() {
            let totalSpeed = 0;
            let count = 0;
            for (let lane = 0; lane < numLanes; lane++) {
                for (const car of road[lane]) {
                    if (car) {
                        totalSpeed += car.speed;
                        count++;
                    }
                }
            }
            return count > 0 ? totalSpeed / count : 0;
        }

        function getFlowRate() {
            let flow = 0;
            for (let lane = 0; lane < numLanes; lane++) {
                for (const car of road[lane]) {
                    if (car) flow += car.speed;
                }
            }
            return flow;
        }

        function updateStats() {
            const avgSpeed = getAverageSpeed();
            const flow = getFlowRate();

            document.getElementById('timeStep').textContent = timeStep;
            document.getElementById('avgSpeed').textContent = avgSpeed.toFixed(2);
            document.getElementById('flowRate').textContent = flow;
            document.getElementById('jams').textContent = countJams();

            history.push({ speed: avgSpeed, flow: flow / (numLanes * roadLength) });
            if (history.length > 200) history.shift();
        }

        function drawHistory() {
            const graphX = 50;
            const graphY = canvas.height - 180;
            const graphW = canvas.width - 450;
            const graphH = 150;

            ctx.fillStyle = 'rgba(0,0,0,0.4)';
            ctx.fillRect(graphX - 10, graphY - 30, graphW + 20, graphH + 50);

            ctx.fillStyle = '#fff';
            ctx.font = '14px sans-serif';
            ctx.fillText('Traffic Flow Over Time', graphX, graphY - 10);

            if (history.length < 2) return;

            // Speed line
            ctx.beginPath();
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 2;
            for (let i = 0; i < history.length; i++) {
                const x = graphX + (i / (history.length - 1)) * graphW;
                const y = graphY + graphH - (history[i].speed / maxSpeed) * graphH;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            // Flow line
            const maxFlow = Math.max(...history.map(h => h.flow), 1);
            ctx.beginPath();
            ctx.strokeStyle = '#22c55e';
            ctx.lineWidth = 1;
            ctx.setLineDash([4, 4]);
            for (let i = 0; i < history.length; i++) {
                const x = graphX + (i / (history.length - 1)) * graphW;
                const y = graphY + graphH - (history[i].flow / maxFlow) * graphH;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();
            ctx.setLineDash([]);
        }

        function draw() {
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            update();

            const roadWidth = canvas.width - 400;
            const laneHeight = 40;
            const startY = 100;
            const cellWidth = roadWidth / roadLength;

            // Draw road
            for (let lane = 0; lane < numLanes; lane++) {
                const y = startY + lane * laneHeight;

                // Road surface
                ctx.fillStyle = '#333';
                ctx.fillRect(50, y, roadWidth, laneHeight - 5);

                // Lane markings
                if (lane < numLanes - 1) {
                    ctx.setLineDash([20, 15]);
                    ctx.strokeStyle = '#666';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(50, y + laneHeight - 2);
                    ctx.lineTo(50 + roadWidth, y + laneHeight - 2);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }

                // Draw cars
                for (let i = 0; i < roadLength; i++) {
                    const car = road[lane][i];
                    if (car) {
                        const x = 50 + i * cellWidth;

                        // Speed-based color
                        const speedRatio = car.speed / maxSpeed;
                        const hue = speedRatio * 120; // Red to green
                        ctx.fillStyle = `hsl(${hue}, 70%, 50%)`;

                        ctx.fillRect(x + 1, y + 8, cellWidth - 2, laneHeight - 21);

                        // Brake lights if stopped
                        if (car.speed === 0) {
                            ctx.fillStyle = '#ef4444';
                            ctx.fillRect(x + 1, y + 8, 3, laneHeight - 21);
                        }
                    }
                }
            }

            // Road edges
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(50, startY);
            ctx.lineTo(50 + roadWidth, startY);
            ctx.moveTo(50, startY + numLanes * laneHeight - 5);
            ctx.lineTo(50 + roadWidth, startY + numLanes * laneHeight - 5);
            ctx.stroke();

            drawHistory();

            // Legend
            ctx.fillStyle = '#3b82f6';
            ctx.fillRect(canvas.width - 340, canvas.height - 100, 15, 15);
            ctx.fillStyle = '#22c55e';
            ctx.fillRect(canvas.width - 340, canvas.height - 75, 15, 15);
            ctx.fillStyle = '#fff';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('Average Speed', canvas.width - 320, canvas.height - 88);
            ctx.fillText('Flow Rate', canvas.width - 320, canvas.height - 63);

            // Title
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 18px sans-serif';
            ctx.fillText('Highway Traffic Flow', 50, 30);

            // Speed legend
            ctx.font = '12px sans-serif';
            ctx.fillText('Car colors: Red (stopped) → Green (max speed)', 50, 55);

            requestAnimationFrame(draw);
        }

        // Event listeners
        document.getElementById('roadLength').oninput = (e) => {
            roadLength = parseInt(e.target.value);
            document.getElementById('lengthValue').textContent = roadLength;
        };

        document.getElementById('density').oninput = (e) => {
            density = parseFloat(e.target.value);
            document.getElementById('densityValue').textContent = density.toFixed(2);
        };

        document.getElementById('maxSpeed').oninput = (e) => {
            maxSpeed = parseInt(e.target.value);
            document.getElementById('speedValue').textContent = maxSpeed;
        };

        document.getElementById('slowdown').oninput = (e) => {
            randomSlowdown = parseFloat(e.target.value);
            document.getElementById('slowdownValue').textContent = randomSlowdown.toFixed(2);
        };

        document.getElementById('lanes').oninput = (e) => {
            numLanes = parseInt(e.target.value);
            document.getElementById('lanesValue').textContent = numLanes;
        };

        document.getElementById('runBtn').onclick = () => {
            running = !running;
            document.getElementById('runBtn').textContent = running ? 'Pause' : 'Start Simulation';
        };

        document.getElementById('resetBtn').onclick = initRoad;

        // Initialize
        initRoad();
        draw();
    </script>
</body>
</html>
