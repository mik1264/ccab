<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BB84 Quantum Key Distribution - CCAB</title>
    <link rel="stylesheet" href="../assets/css/gallery-standard.css">
    <style>
        body {
            background: #0f172a;
            color: #e2e8f0;
            font-family: 'Segoe UI', system-ui;
            padding: 2rem;
            text-align: center;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        
        .protocol-grid {
            display: grid;
            grid-template-columns: 100px repeat(10, 1fr);
            gap: 5px;
            overflow-x: auto;
            background: #1e293b;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .row-label {
            font-weight: bold;
            text-align: right;
            padding-right: 10px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }
        
        .cell {
            width: 40px;
            height: 40px;
            background: #334155;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-family: monospace;
            font-size: 1.1rem;
            position: relative;
        }
        
        .cell.match { background: #059669; color: white; } /* Green */
        .cell.discard { background: #334155; opacity: 0.3; }
        
        .arrow-up { transform: rotate(0deg); }
        .arrow-right { transform: rotate(90deg); }
        .arrow-diag-1 { transform: rotate(45deg); }
        .arrow-diag-2 { transform: rotate(-45deg); }
        
        .controls {
            margin: 20px 0;
            padding: 20px;
            background: #334155;
            border-radius: 8px;
        }
        
        button {
            padding: 10px 20px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
        }
        button:disabled { background: #475569; cursor: not-allowed; }
        
        .eve-panel {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ef4444;
            border-radius: 4px;
            display: inline-block;
        }
        
        #final-key {
            font-size: 1.5rem;
            letter-spacing: 5px;
            color: #38bdf8;
            min-height: 30px;
            margin-top: 10px;
        }
        
    </style>
</head>
<body>

<div class="container">
    <a href="../index.html" class="gallery-back">← Back to Gallery</a>
    <h1>BB84 Quantum Key Distribution</h1>
    <p>Simulating the secure key exchange protocol. If Eve listens in, the error rate increases.</p>
    
    <div class="controls">
        <button onclick="step1()" id="btn-1">1. Alice Prepares</button>
        <button onclick="step2()" id="btn-2" disabled>2. Send to Bob (Measure)</button>
        <button onclick="step3()" id="btn-3" disabled>3. Sifting (Compare Bases)</button>
        <button onclick="reset()">Reset</button>
        
        <div class="eve-panel">
            <label><input type="checkbox" id="eve-check"> Eve Eavesdropping?</label>
        </div>
    </div>

    <div class="protocol-grid" id="grid">
        <!-- Injected -->
    </div>
    
    <h3>Final Shared Key</h3>
    <div id="final-key"></div>
    <div id="error-rate"></div>
</div>

<script>
    const N = 10;
    let aliceBits = [];
    let aliceBases = []; // 0 = Rectilinear (+), 1 = Diagonal (x)
    let bobBases = [];
    let bobBits = [];
    let eveBases = [];
    let eveBits = [];
    
    const grid = document.getElementById('grid');
    const finalKeyDisplay = document.getElementById('final-key');
    const errorRateDisplay = document.getElementById('error-rate');
    
    function reset() {
        aliceBits = [];
        aliceBases = [];
        bobBases = [];
        bobBits = [];
        eveBases = [];
        eveBits = [];
        
        grid.innerHTML = '';
        finalKeyDisplay.textContent = '';
        errorRateDisplay.textContent = '';
        
        document.getElementById('btn-1').disabled = false;
        document.getElementById('btn-2').disabled = true;
        document.getElementById('btn-3').disabled = true;
    }
    
    function getRandomBit() { return Math.random() < 0.5 ? 0 : 1; }
    function getRandomBasis() { return Math.random() < 0.5 ? '+' : 'x'; }
    
    function step1() {
        // Alice Generates
        for(let i=0; i<N; i++) {
            aliceBits.push(getRandomBit());
            aliceBases.push(getRandomBasis());
        }
        render(1);
        document.getElementById('btn-1').disabled = true;
        document.getElementById('btn-2').disabled = false;
    }
    
    function step2() {
        // Bob Measures (and maybe Eve intercepts)
        const evePresent = document.getElementById('eve-check').checked;
        
        for(let i=0; i<N; i++) {
            bobBases.push(getRandomBasis());
            
            // Logic:
            // State sent: 
            // If basis +, bit 0 -> ↑ (0 deg)
            // If basis +, bit 1 -> → (90 deg)
            // If basis x, bit 0 -> ↗ (45 deg)
            // If basis x, bit 1 -> ↘ (-45 deg)
            
            let currentBit = aliceBits[i];
            let currentBasis = aliceBases[i];
            
            if (evePresent) {
                // Eve measures first
                const eveBasis = getRandomBasis();
                eveBases.push(eveBasis);
                
                let measuredBit;
                if (eveBasis === currentBasis) {
                    measuredBit = currentBit; // Deterministic
                } else {
                    measuredBit = getRandomBit(); // 50/50 collapse
                }
                eveBits.push(measuredBit);
                
                // State collapses to what Eve measured
                currentBit = measuredBit;
                currentBasis = eveBasis;
            }
            
            // Bob measures
            let bobBit;
            if (bobBases[i] === currentBasis) {
                bobBit = currentBit;
            } else {
                bobBit = getRandomBit();
            }
            bobBits.push(bobBit);
        }
        
        render(2);
        document.getElementById('btn-2').disabled = true;
        document.getElementById('btn-3').disabled = false;
    }
    
    function step3() {
        // Sifting
        render(3);
        
        // Calculate key
        let key = '';
        let errors = 0;
        let matchCount = 0;
        
        for(let i=0; i<N; i++) {
            if (aliceBases[i] === bobBases[i]) {
                key += aliceBits[i];
                matchCount++;
                if (aliceBits[i] !== bobBits[i]) errors++;
            }
        }
        
        finalKeyDisplay.textContent = key;
        
        if (matchCount > 0) {
            const rate = (errors / matchCount) * 100;
            let msg = `Error Rate: ${rate.toFixed(1)}%`;
            if (rate > 0) msg += " (Eavesdropper Detected!)";
            else msg += " (Secure)";
            errorRateDisplay.textContent = msg;
            errorRateDisplay.style.color = rate > 0 ? '#ef4444' : '#10b981';
        }
        
        document.getElementById('btn-3').disabled = true;
    }
    
    function render(step) {
        grid.innerHTML = '';
        
        // Headers
        grid.appendChild(createCell('Alice Bit', 'row-label'));
        aliceBits.forEach(b => grid.appendChild(createCell(b)));
        
        grid.appendChild(createCell('Alice Basis', 'row-label'));
        aliceBases.forEach(b => grid.appendChild(createCell(b === '+' ? '✚' : '✖')));
        
        grid.appendChild(createCell('Photon', 'row-label'));
        aliceBits.forEach((b, i) => {
             // 0/+: ↑, 1/+: →, 0/x: ↗, 1/x: ↘
             const basis = aliceBases[i];
             let arrow = '';
             if (basis === '+') arrow = b === 0 ? '↑' : '→';
             else arrow = b === 0 ? '↗' : '↘';
             grid.appendChild(createCell(arrow));
        });
        
        if (step >= 2) {
            grid.appendChild(createCell('Bob Basis', 'row-label'));
            bobBases.forEach(b => grid.appendChild(createCell(b === '+' ? '✚' : '✖')));
            
            grid.appendChild(createCell('Bob Meas.', 'row-label'));
            bobBits.forEach(b => grid.appendChild(createCell(b)));
        }
        
        if (step >= 3) {
            // Highlight matches
            // We need to re-render or just modify classes? 
            // Re-rendering entire grid is cleaner logic
            // Add 'Key' Row
            grid.appendChild(createCell('Sifted Key', 'row-label'));
            for(let i=0; i<N; i++) {
                if (aliceBases[i] === bobBases[i]) {
                    const c = createCell(bobBits[i]);
                    c.classList.add('match');
                    if (aliceBits[i] !== bobBits[i]) c.style.backgroundColor = '#ef4444'; // Error
                    grid.appendChild(c);
                } else {
                    const c = createCell('');
                    c.classList.add('discard');
                    grid.appendChild(c);
                }
            }
        }
    }
    
    function createCell(content, className = 'cell') {
        const div = document.createElement('div');
        div.className = className;
        div.textContent = content;
        return div;
    }
    
    reset(); // init
</script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
