<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Totalistic Cellular Automata - Interactive Visualization - CCAB</title>
    <meta name="description" content="Interactive visualization of totalistic cellular automata. Explore multi-color 1D CA where rules depend only on the sum of neighbor values, not their individual positions.">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }

        canvas {
            display: block;
            image-rendering: pixelated;
        }

        .back-link {
            position: fixed;
            top: 15px;
            left: 15px;
            padding: 10px 18px;
            background: rgba(0, 0, 0, 0.6);
            color: #e94560;
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(233, 69, 96, 0.3);
            transition: all 0.3s ease;
        }

        .back-link:hover {
            background: rgba(233, 69, 96, 0.2);
            transform: translateX(-4px);
        }

        #info {
            position: fixed;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.85);
            padding: 15px 20px;
            border-radius: 12px;
            color: #e94560;
            font-size: 13px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(233, 69, 96, 0.2);
            z-index: 1000;
            max-width: 320px;
        }

        #info h3 {
            margin-bottom: 10px;
            color: #f29191;
        }

        #info .stat {
            margin: 5px 0;
        }

        #info .stat-label {
            color: #888;
            font-size: 11px;
        }

        #info .stat-value {
            color: #e94560;
            font-weight: bold;
        }

        #info p {
            font-size: 11px;
            opacity: 0.8;
            line-height: 1.5;
            margin-top: 10px;
            color: #aaa;
        }

        .rule-display {
            background: rgba(233, 69, 96, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 11px;
            color: #f29191;
        }

        .rule-table {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-top: 8px;
        }

        .rule-cell {
            text-align: center;
            padding: 4px;
            border-radius: 4px;
            font-size: 10px;
        }

        .rule-cell.header {
            background: rgba(233, 69, 96, 0.2);
            color: #f29191;
        }

        .rule-cell.value {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        #presets {
            position: fixed;
            top: 380px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            z-index: 1000;
            max-height: 35vh;
            overflow-y: auto;
        }

        button {
            background: rgba(233, 69, 96, 0.15);
            border: 1px solid rgba(233, 69, 96, 0.4);
            color: #e94560;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s;
            text-align: left;
        }

        button:hover {
            background: rgba(233, 69, 96, 0.3);
        }

        button.active {
            background: rgba(233, 69, 96, 0.4);
            border-color: #e94560;
        }

        #controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            z-index: 1000;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-group {
            background: rgba(0, 0, 0, 0.7);
            padding: 12px 16px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(233, 69, 96, 0.2);
        }

        .control-group label {
            color: #e94560;
            font-size: 11px;
            display: block;
            margin-bottom: 5px;
        }

        .control-group input[type="range"] {
            width: 80px;
            accent-color: #e94560;
        }

        .control-group input[type="number"] {
            width: 70px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(233, 69, 96, 0.3);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .control-group span {
            color: #fff;
            font-size: 10px;
            margin-left: 6px;
        }

        .control-btn {
            padding: 10px 16px;
        }

        .color-palette {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }

        .color-swatch {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <a href="../index.html" class="back-link">← Back to Gallery</a>

    <canvas id="canvas"></canvas>

    <div id="info">
        <h3>Totalistic Cellular Automata</h3>
        <div class="stat">
            <span class="stat-label">Colors (k)</span>
            <span class="stat-value" id="colors">3</span>
        </div>
        <div class="stat">
            <span class="stat-label">Rule Code</span>
            <span class="stat-value" id="rule-code">777</span>
        </div>
        <div class="stat">
            <span class="stat-label">Generation</span>
            <span class="stat-value" id="generation">0</span>
        </div>
        <div class="stat">
            <span class="stat-label">Width</span>
            <span class="stat-value" id="width">0</span>
        </div>
        <div class="rule-display">
            <div>Sum → Output</div>
            <div class="rule-table" id="rule-table"></div>
        </div>
        <div class="color-palette" id="color-palette"></div>
        <p>Totalistic CA rules depend only on the SUM of cell values in a neighborhood, not their positions. Discovered by Wolfram in 1983. The rule code specifies the output for each possible sum.</p>
    </div>

    <div id="presets">
        <button class="active" data-rule="777" data-colors="3">Rule 777 (k=3)</button>
        <button data-rule="600" data-colors="3">Rule 600 (k=3)</button>
        <button data-rule="993" data-colors="3">Rule 993 (k=3)</button>
        <button data-rule="1020" data-colors="3">Rule 1020 (k=3)</button>
        <button data-rule="1074" data-colors="3">Rule 1074 (k=3)</button>
        <button data-rule="1635" data-colors="3">Rule 1635 (k=3)</button>
        <button data-rule="2049" data-colors="3">Rule 2049 (k=3)</button>
        <button data-rule="177147" data-colors="4">Rule 177147 (k=4)</button>
        <button data-rule="294831" data-colors="4">Rule 294831 (k=4)</button>
        <button data-rule="3125" data-colors="5">Rule 3125 (k=5)</button>
    </div>

    <div id="controls">
        <div class="control-group">
            <label>Colors: <span id="colors-val">3</span></label>
            <input type="range" id="colors-slider" min="2" max="6" value="3">
        </div>
        <div class="control-group">
            <label>Rule Code:</label>
            <input type="number" id="rule-input" value="777" min="0">
        </div>
        <div class="control-group">
            <label>Cell Size: <span id="size-val">3</span>px</label>
            <input type="range" id="size" min="1" max="6" value="3">
        </div>
        <div class="control-group">
            <label>Speed: <span id="speed-val">30</span>ms</label>
            <input type="range" id="speed" min="1" max="100" value="30">
        </div>
        <button class="control-btn" id="start-btn">Start</button>
        <button class="control-btn" id="reset-btn">Reset</button>
        <button class="control-btn" id="random-btn">Random Rule</button>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let cellSize = 3;
        let speed = 30;
        let numColors = 3;
        let ruleCode = 777;
        let gridWidth, gridHeight;
        let grid = [];
        let generation = 0;
        let running = false;
        let animationId;

        // Color palettes for different k values
        const colorPalettes = {
            2: ['#1a1a2e', '#e94560'],
            3: ['#1a1a2e', '#e94560', '#ffc93c'],
            4: ['#1a1a2e', '#4a47a3', '#e94560', '#ffc93c'],
            5: ['#1a1a2e', '#4a47a3', '#e94560', '#ff7f50', '#ffc93c'],
            6: ['#1a1a2e', '#4a47a3', '#e94560', '#ff7f50', '#ffc93c', '#90ee90']
        };

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            gridWidth = Math.floor(canvas.width / cellSize);
            gridHeight = Math.floor(canvas.height / cellSize);
            initGrid();
        }

        function initGrid() {
            grid = [];
            generation = 0;

            // First row - single center cell with highest color value
            const firstRow = new Array(gridWidth).fill(0);
            firstRow[Math.floor(gridWidth / 2)] = numColors - 1;
            grid.push(firstRow);

            render();
            updateStats();
            updateRuleTable();
            updateColorPalette();
        }

        function getRuleDigits() {
            // Convert rule code to base-k digits for lookup table
            // Number of possible sums: 3k - 2 (for 3-cell neighborhood)
            const numSums = 3 * numColors - 2;
            const digits = [];

            let code = ruleCode;
            for (let i = 0; i < numSums; i++) {
                digits.push(code % numColors);
                code = Math.floor(code / numColors);
            }

            return digits;
        }

        function evolve() {
            const ruleDigits = getRuleDigits();
            const lastRow = grid[grid.length - 1];
            const newRow = new Array(gridWidth).fill(0);

            for (let x = 0; x < gridWidth; x++) {
                // Get neighbors with wrap-around
                const left = lastRow[(x - 1 + gridWidth) % gridWidth];
                const center = lastRow[x];
                const right = lastRow[(x + 1) % gridWidth];

                // Sum of neighbors (totalistic rule)
                const sum = left + center + right;

                // Look up new value from rule
                newRow[x] = ruleDigits[sum] || 0;
            }

            grid.push(newRow);
            generation++;

            // Remove old rows if exceeding display height
            if (grid.length > gridHeight) {
                grid.shift();
            }
        }

        function render() {
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const palette = colorPalettes[numColors] || colorPalettes[3];

            for (let y = 0; y < grid.length; y++) {
                for (let x = 0; x < gridWidth; x++) {
                    const value = grid[y][x];
                    if (value > 0) {
                        ctx.fillStyle = palette[value] || palette[palette.length - 1];
                        ctx.fillRect(x * cellSize, y * cellSize, cellSize, cellSize);
                    }
                }
            }
        }

        function updateStats() {
            document.getElementById('colors').textContent = numColors;
            document.getElementById('rule-code').textContent = ruleCode;
            document.getElementById('generation').textContent = generation.toLocaleString();
            document.getElementById('width').textContent = gridWidth;
        }

        function updateRuleTable() {
            const table = document.getElementById('rule-table');
            const ruleDigits = getRuleDigits();
            const numSums = 3 * numColors - 2;

            let html = '';
            // Header row (sums)
            for (let i = 0; i < Math.min(numSums, 7); i++) {
                html += `<div class="rule-cell header">${i}</div>`;
            }
            // Value row
            for (let i = 0; i < Math.min(numSums, 7); i++) {
                html += `<div class="rule-cell value">${ruleDigits[i] || 0}</div>`;
            }

            table.innerHTML = html;
        }

        function updateColorPalette() {
            const palette = document.getElementById('color-palette');
            const colors = colorPalettes[numColors] || colorPalettes[3];

            palette.innerHTML = colors.map(c =>
                `<div class="color-swatch" style="background: ${c};" title="Color ${colors.indexOf(c)}"></div>`
            ).join('');
        }

        function animate() {
            if (!running) return;

            evolve();
            render();
            updateStats();

            setTimeout(() => {
                animationId = requestAnimationFrame(animate);
            }, speed);
        }

        function start() {
            if (running) return;
            running = true;
            document.getElementById('start-btn').textContent = 'Pause';
            animate();
        }

        function pause() {
            running = false;
            document.getElementById('start-btn').textContent = 'Start';
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        }

        function getMaxRuleCode() {
            const numSums = 3 * numColors - 2;
            return Math.pow(numColors, numSums) - 1;
        }

        function randomRule() {
            const max = Math.min(getMaxRuleCode(), 999999);
            ruleCode = Math.floor(Math.random() * max);
            document.getElementById('rule-input').value = ruleCode;
            initGrid();

            // Unselect preset buttons
            document.querySelectorAll('#presets button').forEach(b => b.classList.remove('active'));
        }

        // Event listeners
        document.getElementById('colors-slider').addEventListener('input', (e) => {
            numColors = parseInt(e.target.value);
            document.getElementById('colors-val').textContent = numColors;

            // Adjust rule code if too large for new color count
            const maxRule = getMaxRuleCode();
            if (ruleCode > maxRule) {
                ruleCode = ruleCode % (maxRule + 1);
                document.getElementById('rule-input').value = ruleCode;
            }

            initGrid();
        });

        document.getElementById('rule-input').addEventListener('change', (e) => {
            const value = parseInt(e.target.value);
            const maxRule = getMaxRuleCode();
            ruleCode = Math.max(0, Math.min(value, maxRule));
            e.target.value = ruleCode;
            initGrid();

            // Unselect preset buttons
            document.querySelectorAll('#presets button').forEach(b => b.classList.remove('active'));
        });

        document.getElementById('size').addEventListener('input', (e) => {
            cellSize = parseInt(e.target.value);
            document.getElementById('size-val').textContent = cellSize;
            resize();
        });

        document.getElementById('speed').addEventListener('input', (e) => {
            speed = parseInt(e.target.value);
            document.getElementById('speed-val').textContent = speed;
        });

        document.getElementById('start-btn').addEventListener('click', () => {
            if (running) {
                pause();
            } else {
                start();
            }
        });

        document.getElementById('reset-btn').addEventListener('click', () => {
            pause();
            initGrid();
        });

        document.getElementById('random-btn').addEventListener('click', randomRule);

        // Preset buttons
        document.querySelectorAll('#presets button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('#presets button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                ruleCode = parseInt(btn.dataset.rule);
                numColors = parseInt(btn.dataset.colors);

                document.getElementById('rule-input').value = ruleCode;
                document.getElementById('colors-slider').value = numColors;
                document.getElementById('colors-val').textContent = numColors;

                initGrid();
            });
        });

        // Initialize
        window.addEventListener('resize', resize);
        resize();
    </script>
</body>
</html>
