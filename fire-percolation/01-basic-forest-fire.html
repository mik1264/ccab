<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basic Forest Fire Simulation - Fire Percolation</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
            min-height: 100vh;
        }
        h1 {
            margin: 0 0 10px 0;
            font-size: 2em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .description {
            text-align: center;
            max-width: 800px;
            margin-bottom: 20px;
            line-height: 1.6;
            opacity: 0.9;
        }
        .controls {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
            backdrop-filter: blur(10px);
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        input[type="range"] {
            width: 150px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        canvas {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 5px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            background: black;
        }
        .stats {
            background: rgba(255,255,255,0.1);
            padding: 15px 30px;
            border-radius: 10px;
            margin-top: 20px;
            display: flex;
            gap: 30px;
            backdrop-filter: blur(10px);
        }
        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
        }
        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <h1>Basic Forest Fire Simulation</h1>
    <div class="description">
        Classic forest fire model demonstrating percolation. Fire starts from the left edge and spreads
        deterministically to adjacent trees (Von Neumann neighborhood). Adjust density to see how connectivity
        affects fire spread. Critical threshold is around 59%.
    </div>

    <div class="controls">
        <div class="control-group">
            <label>Forest Density: <span id="densityValue">59</span>%</label>
            <input type="range" id="density" min="0" max="100" value="59">
        </div>
        <div class="control-group">
            <label>Grid Size: <span id="sizeValue">100</span></label>
            <input type="range" id="gridSize" min="50" max="200" value="100">
        </div>
        <div class="control-group">
            <label>Speed: <span id="speedValue">5</span></label>
            <input type="range" id="speed" min="1" max="20" value="5">
        </div>
        <button id="startBtn">Start Fire</button>
        <button id="resetBtn">Reset Forest</button>
    </div>

    <canvas id="canvas"></canvas>

    <div class="stats">
        <div class="stat">
            <div class="stat-value" id="tickCount">0</div>
            <div class="stat-label">Ticks</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="burnedCount">0</div>
            <div class="stat-label">Trees Burned</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="totalTrees">0</div>
            <div class="stat-label">Total Trees</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="percentBurned">0</div>
            <div class="stat-label">% Burned</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="reachedEdge">-</div>
            <div class="stat-label">Reached Edge</div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        const densitySlider = document.getElementById('density');
        const densityValue = document.getElementById('densityValue');
        const sizeSlider = document.getElementById('gridSize');
        const sizeValue = document.getElementById('sizeValue');
        const speedSlider = document.getElementById('speed');
        const speedValue = document.getElementById('speedValue');
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');

        let gridSize = 100;
        let cellSize;
        let density = 0.59;
        let speed = 5;
        let running = false;
        let frameCount = 0;

        // Grid states: 0 = empty, 1 = tree, 2 = fire, 3+ = ember (fading)
        let grid = [];
        let fires = []; // Active fire positions
        let totalTrees = 0;
        let burnedTrees = 0;
        let tickCount = 0;
        let reachedRightEdge = false;

        function initCanvas() {
            const maxSize = Math.min(window.innerWidth - 40, window.innerHeight - 400);
            canvas.width = maxSize;
            canvas.height = maxSize;
            cellSize = maxSize / gridSize;
        }

        function initGrid() {
            grid = Array(gridSize).fill(0).map(() => Array(gridSize).fill(0));
            fires = [];
            totalTrees = 0;
            burnedTrees = 0;
            tickCount = 0;
            reachedRightEdge = false;

            // Randomly place trees based on density
            for (let y = 0; y < gridSize; y++) {
                for (let x = 0; x < gridSize; x++) {
                    if (Math.random() < density) {
                        grid[y][x] = 1;
                        totalTrees++;
                    }
                }
            }

            updateStats();
            drawGrid();
        }

        function startFire() {
            if (running) return;

            // Ignite leftmost column
            for (let y = 0; y < gridSize; y++) {
                if (grid[y][0] === 1) {
                    grid[y][0] = 2;
                    fires.push({x: 0, y: y});
                    burnedTrees++;
                }
            }

            running = true;
            startBtn.disabled = true;
            updateStats();
        }

        function updateFire() {
            if (!running || fires.length === 0) {
                if (running) {
                    running = false;
                    startBtn.disabled = false;
                }
                return;
            }

            const newFires = [];

            // Spread fire to neighbors (Von Neumann neighborhood)
            for (const fire of fires) {
                const {x, y} = fire;

                // Check 4 cardinal directions
                const neighbors = [
                    {x: x, y: y - 1}, // North
                    {x: x, y: y + 1}, // South
                    {x: x - 1, y: y}, // West
                    {x: x + 1, y: y}  // East
                ];

                for (const n of neighbors) {
                    if (n.x >= 0 && n.x < gridSize && n.y >= 0 && n.y < gridSize) {
                        if (grid[n.y][n.x] === 1) {
                            grid[n.y][n.x] = 2;
                            newFires.push({x: n.x, y: n.y});
                            burnedTrees++;

                            // Check if reached right edge
                            if (n.x === gridSize - 1) {
                                reachedRightEdge = true;
                            }
                        }
                    }
                }

                // Convert fire to ember
                grid[y][x] = 3;
            }

            // Update embers (fade over ~12 ticks)
            for (let y = 0; y < gridSize; y++) {
                for (let x = 0; x < gridSize; x++) {
                    if (grid[y][x] >= 3 && grid[y][x] < 15) {
                        grid[y][x]++;
                    } else if (grid[y][x] >= 15) {
                        grid[y][x] = 0; // Fully faded
                    }
                }
            }

            fires = newFires;
            tickCount++;
            updateStats();
        }

        function drawGrid() {
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            for (let y = 0; y < gridSize; y++) {
                for (let x = 0; x < gridSize; x++) {
                    const state = grid[y][x];

                    if (state === 1) {
                        // Tree (green)
                        ctx.fillStyle = '#00ff00';
                    } else if (state === 2) {
                        // Fire (bright red)
                        ctx.fillStyle = '#ff0000';
                    } else if (state >= 3) {
                        // Ember (fading)
                        const fade = (state - 3) / 12;
                        const intensity = Math.floor(255 * (1 - fade));
                        ctx.fillStyle = `rgb(${intensity}, 0, 0)`;
                    } else {
                        continue; // Empty
                    }

                    ctx.fillRect(
                        x * cellSize,
                        y * cellSize,
                        cellSize,
                        cellSize
                    );
                }
            }
        }

        function updateStats() {
            document.getElementById('tickCount').textContent = tickCount;
            document.getElementById('burnedCount').textContent = burnedTrees;
            document.getElementById('totalTrees').textContent = totalTrees;
            const percent = totalTrees > 0 ? ((burnedTrees / totalTrees) * 100).toFixed(1) : 0;
            document.getElementById('percentBurned').textContent = percent + '%';
            document.getElementById('reachedEdge').textContent = reachedRightEdge ? 'Yes' : 'No';
        }

        function animate() {
            frameCount++;

            if (frameCount % Math.floor(21 - speed) === 0) {
                updateFire();
                drawGrid();
            }

            requestAnimationFrame(animate);
        }

        // Event listeners
        densitySlider.addEventListener('input', (e) => {
            densityValue.textContent = e.target.value;
            density = e.target.value / 100;
        });

        sizeSlider.addEventListener('input', (e) => {
            sizeValue.textContent = e.target.value;
            gridSize = parseInt(e.target.value);
            initCanvas();
            initGrid();
        });

        speedSlider.addEventListener('input', (e) => {
            speedValue.textContent = e.target.value;
            speed = parseInt(e.target.value);
        });

        startBtn.addEventListener('click', startFire);
        resetBtn.addEventListener('click', () => {
            running = false;
            startBtn.disabled = false;
            initGrid();
        });

        // Expose functions for enhance.js keyboard shortcuts
        window.reset = function() { running = false; startBtn.disabled = false; initGrid(); };

        // Initialize
        initCanvas();
        initGrid();
        animate();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
