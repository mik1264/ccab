<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time to Reach Edge Statistics - Fire Percolation</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: linear-gradient(135deg, #606c88 0%, #3f4c6b 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
            min-height: 100vh;
        }
        h1 {
            margin: 0 0 10px 0;
            font-size: 2em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .description {
            text-align: center;
            max-width: 900px;
            margin-bottom: 20px;
            line-height: 1.6;
            opacity: 0.9;
        }
        .controls {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }
        button:hover {
            background: #2980b9;
        }
        .chart-container {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }
        canvas {
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 5px;
            background: white;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            max-width: 900px;
        }
        .stat-box {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            text-align: center;
        }
        .stat-label {
            opacity: 0.8;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Time to Reach Edge Statistics</h1>
    <div class="description">
        Measure how many ticks it takes for fire to reach the right edge at different densities.
        Near critical threshold, time-to-cross shows high variance (some quick, some never).
        Above threshold, time scales roughly linearly with distance.
    </div>

    <div class="controls">
        <div class="control-group">
            <label>Density: <span id="densityValue">65</span>%</label>
            <input type="range" id="density" min="50" max="80" value="65" style="width: 150px;">
        </div>
        <div class="control-group">
            <label>Trials: <span id="trialsValue">20</span></label>
            <input type="range" id="trials" min="5" max="50" value="20" style="width: 150px;">
        </div>
        <button id="runBtn">Run Trials</button>
        <button id="clearBtn">Clear Data</button>
    </div>

    <div class="chart-container">
        <canvas id="histogram" width="800" height="400"></canvas>
    </div>

    <div class="stats-grid">
        <div class="stat-box">
            <div class="stat-label">Success Rate</div>
            <div class="stat-value" id="successRate">-</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Avg Time (Ticks)</div>
            <div class="stat-value" id="avgTime">-</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Min Time</div>
            <div class="stat-value" id="minTime">-</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Max Time</div>
            <div class="stat-value" id="maxTime">-</div>
        </div>
    </div>

    <script>
        const histogram = document.getElementById('histogram');
        const ctx = histogram.getContext('2d');

        let density = 0.65;
        let numTrials = 20;
        let results = [];
        const gridSize = 100;

        function runSimulation() {
            return new Promise(resolve => {
                const grid = Array(gridSize).fill(0).map(() => Array(gridSize).fill(0));

                for (let y = 0; y < gridSize; y++) {
                    for (let x = 0; x < gridSize; x++) {
                        if (Math.random() < density) {
                            grid[y][x] = 1;
                        }
                    }
                }

                let fires = [];
                for (let y = 0; y < gridSize; y++) {
                    if (grid[y][0] === 1) {
                        grid[y][0] = 2;
                        fires.push({x: 0, y});
                    }
                }

                let ticks = 0;
                let reachedEdge = false;

                while (fires.length > 0 && !reachedEdge && ticks < 500) {
                    const newFires = [];

                    for (const {x, y} of fires) {
                        const neighbors = [
                            {x, y: y - 1},
                            {x, y: y + 1},
                            {x: x - 1, y},
                            {x: x + 1, y}
                        ];

                        for (const n of neighbors) {
                            if (n.x >= 0 && n.x < gridSize && n.y >= 0 && n.y < gridSize) {
                                if (grid[n.y][n.x] === 1) {
                                    grid[n.y][n.x] = 2;
                                    newFires.push(n);

                                    if (n.x === gridSize - 1) {
                                        reachedEdge = true;
                                    }
                                }
                            }
                        }
                    }

                    fires = newFires;
                    ticks++;
                }

                resolve({
                    success: reachedEdge,
                    ticks: reachedEdge ? ticks : null
                });
            });
        }

        async function runTrials() {
            document.getElementById('runBtn').disabled = true;
            results = [];

            for (let i = 0; i < numTrials; i++) {
                const result = await runSimulation();
                results.push(result);
                drawHistogram();
                updateStats();
                await new Promise(r => setTimeout(r, 50));
            }

            document.getElementById('runBtn').disabled = false;
        }

        function drawHistogram() {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, histogram.width, histogram.height);

            const margin = {top: 40, right: 40, bottom: 60, left: 60};
            const width = histogram.width - margin.left - margin.right;
            const height = histogram.height - margin.top - margin.bottom;

            // Axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(margin.left, margin.top);
            ctx.lineTo(margin.left, margin.top + height);
            ctx.lineTo(margin.left + width, margin.top + height);
            ctx.stroke();

            // Labels
            ctx.fillStyle = '#333';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Time to Reach Edge (Ticks)', margin.left + width / 2, histogram.height - 10);

            ctx.save();
            ctx.translate(15, margin.top + height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Frequency', 0, 0);
            ctx.restore();

            const successfulResults = results.filter(r => r.success).map(r => r.ticks);

            if (successfulResults.length === 0) return;

            const minTicks = Math.min(...successfulResults);
            const maxTicks = Math.max(...successfulResults);
            const numBins = Math.min(10, successfulResults.length);
            const binSize = Math.ceil((maxTicks - minTicks + 1) / numBins);

            const bins = Array(numBins).fill(0);
            successfulResults.forEach(ticks => {
                const binIndex = Math.min(Math.floor((ticks - minTicks) / binSize), numBins - 1);
                bins[binIndex]++;
            });

            const maxCount = Math.max(...bins);
            const barWidth = width / numBins;

            ctx.fillStyle = '#3498db';
            bins.forEach((count, i) => {
                const barHeight = (count / maxCount) * height;
                const x = margin.left + i * barWidth;
                const y = margin.top + height - barHeight;

                ctx.fillRect(x, y, barWidth - 2, barHeight);

                // Bar label
                ctx.fillStyle = '#333';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                const binStart = minTicks + i * binSize;
                const binEnd = binStart + binSize - 1;
                ctx.fillText(`${binStart}-${binEnd}`, x + barWidth / 2, margin.top + height + 20);

                // Count
                if (count > 0) {
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 12px Arial';
                    ctx.fillText(count, x + barWidth / 2, y - 5);
                }

                ctx.fillStyle = '#3498db';
            });

            // Failed trials indicator
            const failedCount = results.filter(r => !r.success).length;
            if (failedCount > 0) {
                ctx.fillStyle = '#e74c3c';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(`${failedCount} trials did not reach edge`, margin.left, margin.top - 10);
            }
        }

        function updateStats() {
            const successfulResults = results.filter(r => r.success);
            const successRate = results.length > 0 ? (successfulResults.length / results.length * 100).toFixed(1) : 0;

            document.getElementById('successRate').textContent = successRate + '%';

            if (successfulResults.length > 0) {
                const times = successfulResults.map(r => r.ticks);
                const avg = (times.reduce((a, b) => a + b, 0) / times.length).toFixed(1);
                const min = Math.min(...times);
                const max = Math.max(...times);

                document.getElementById('avgTime').textContent = avg;
                document.getElementById('minTime').textContent = min;
                document.getElementById('maxTime').textContent = max;
            } else {
                document.getElementById('avgTime').textContent = 'N/A';
                document.getElementById('minTime').textContent = 'N/A';
                document.getElementById('maxTime').textContent = 'N/A';
            }
        }

        function clearData() {
            results = [];
            drawHistogram();
            document.getElementById('successRate').textContent = '-';
            document.getElementById('avgTime').textContent = '-';
            document.getElementById('minTime').textContent = '-';
            document.getElementById('maxTime').textContent = '-';
        }

        document.getElementById('density').addEventListener('input', (e) => {
            document.getElementById('densityValue').textContent = e.target.value;
            density = e.target.value / 100;
        });

        document.getElementById('trials').addEventListener('input', (e) => {
            document.getElementById('trialsValue').textContent = e.target.value;
            numTrials = parseInt(e.target.value);
        });

        document.getElementById('runBtn').addEventListener('click', runTrials);
        document.getElementById('clearBtn').addEventListener('click', clearData);

        drawHistogram();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
