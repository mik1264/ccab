<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cross-Correlation - Signal Detection & Matching</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3e 100%);
            color: #00aaff; min-height: 100vh; padding: 20px;
        }
        .back-link {
            position: fixed; top: 20px; left: 20px; color: #00aaff;
            text-decoration: none; padding: 10px 20px;
            background: rgba(0,170,255,0.1); border: 1px solid #00aaff;
            border-radius: 5px; z-index: 100;
        }
        .container { max-width: 1100px; margin: 60px auto 0; }
        h1 { font-size: 2rem; margin-bottom: 10px; text-align: center; }
        .subtitle { color: #888; margin-bottom: 30px; text-align: center; }
        .viz-grid {
            display: grid; gap: 15px; margin-bottom: 20px;
        }
        .panel {
            background: rgba(0,0,0,0.5); padding: 15px;
            border-radius: 15px; border: 1px solid #00aaff;
        }
        .panel h3 { color: #00ccff; margin-bottom: 10px; text-align: center; font-size: 0.95rem; }
        canvas { width: 100%; height: 120px; background: rgba(0,20,40,0.5); border-radius: 8px; }
        .detection {
            text-align: center; padding: 15px;
            background: rgba(0,255,136,0.1); border: 1px solid #00ff88;
            border-radius: 10px; margin-bottom: 20px;
        }
        .detection h4 { color: #00ff88; }
        .controls {
            display: flex; gap: 15px; justify-content: center;
            flex-wrap: wrap; margin-bottom: 20px;
        }
        button {
            padding: 10px 25px; font-family: inherit;
            background: rgba(0,170,255,0.1); border: 1px solid #00aaff;
            color: #00aaff; border-radius: 5px; cursor: pointer;
        }
        button:hover { background: rgba(0,170,255,0.3); }
        .info { background: rgba(0,170,255,0.05); padding: 20px; border-radius: 10px; }
        .info h3 { color: #00ccff; margin-bottom: 10px; }
        .info p { color: #aaa; line-height: 1.6; margin-bottom: 10px; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back</a>
    <div class="container">
        <h1>Cross-Correlation</h1>
        <p class="subtitle">Find a known pattern within a noisy signal</p>

        <div class="controls">
            <button onclick="generateNew()">New Random Position</button>
            <button onclick="toggleAnimation()" id="animBtn">Start Animation</button>
        </div>

        <div class="detection">
            <h4>Pattern Detection</h4>
            <span id="detectionText" style="font-size:1.1rem;">Searching...</span>
        </div>

        <div class="viz-grid">
            <div class="panel">
                <h3>Signal x[n] - Pattern Hidden in Noise</h3>
                <canvas id="signalCanvas"></canvas>
            </div>
            <div class="panel">
                <h3>Template h[n] - Known Pattern to Find</h3>
                <canvas id="templateCanvas"></canvas>
            </div>
            <div class="panel">
                <h3>Cross-Correlation R_xh[k] - Peak Shows Pattern Location</h3>
                <canvas id="xcorrCanvas"></canvas>
            </div>
            <div class="panel">
                <h3>Sliding Template Animation</h3>
                <canvas id="animCanvas"></canvas>
            </div>
        </div>

        <div class="info">
            <h3>Cross-Correlation Applications</h3>
            <p><strong>Radar Systems:</strong> Detect the return time of a transmitted pulse to measure distance.</p>
            <p><strong>GPS:</strong> Correlate satellite signals with known codes to determine position.</p>
            <p><strong>Template Matching:</strong> Find a known pattern (face, fingerprint, signature) in an image or signal.</p>
            <p><strong>Time Delay Estimation:</strong> Determine the lag between two recordings of the same event.</p>
            <p><strong>Formula:</strong> R_xh[k] = Σ x[n] · h[n-k] - slides the template across the signal</p>
        </div>
    </div>

    <script>
        const N = 512;
        const templateLength = 64;
        let signal = [];
        let template = [];
        let xcorr = [];
        let truePosition = 0;
        let currentLag = 0;
        let isAnimating = false;

        function resizeCanvas(canvas) {
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvas.getContext('2d').scale(dpr, dpr);
        }

        function generateTemplate() {
            template = [];
            for (let i = 0; i < templateLength; i++) {
                const t = i / templateLength;
                // Distinctive pattern
                template.push(
                    Math.sin(2 * Math.PI * 4 * t) *
                    Math.exp(-4 * (t - 0.5) * (t - 0.5))
                );
            }
            return template;
        }

        function generateSignal() {
            signal = [];
            truePosition = Math.floor(Math.random() * (N - templateLength - 20)) + 10;

            for (let i = 0; i < N; i++) {
                // Noise
                signal.push((Math.random() - 0.5) * 0.5);
            }

            // Insert template
            for (let i = 0; i < templateLength; i++) {
                signal[truePosition + i] += template[i];
            }
        }

        function computeCrossCorrelation() {
            xcorr = [];
            for (let lag = 0; lag < N - templateLength; lag++) {
                let sum = 0;
                for (let i = 0; i < templateLength; i++) {
                    sum += signal[lag + i] * template[i];
                }
                xcorr.push(sum);
            }
            return xcorr;
        }

        function findPeak(data) {
            let maxIdx = 0;
            let maxVal = data[0];
            for (let i = 1; i < data.length; i++) {
                if (data[i] > maxVal) {
                    maxVal = data[i];
                    maxIdx = i;
                }
            }
            return maxIdx;
        }

        function drawSignal(canvas, data, color, highlightStart = -1, highlightLen = 0) {
            const ctx = canvas.getContext('2d');
            const w = canvas.width / (window.devicePixelRatio || 1);
            const h = canvas.height / (window.devicePixelRatio || 1);

            ctx.fillStyle = 'rgba(0,20,40,0.5)';
            ctx.fillRect(0, 0, w, h);

            ctx.strokeStyle = 'rgba(0,170,255,0.2)';
            ctx.beginPath();
            ctx.moveTo(0, h / 2);
            ctx.lineTo(w, h / 2);
            ctx.stroke();

            // Highlight region
            if (highlightStart >= 0) {
                const x1 = (highlightStart / data.length) * w;
                const x2 = ((highlightStart + highlightLen) / data.length) * w;
                ctx.fillStyle = 'rgba(0,255,136,0.2)';
                ctx.fillRect(x1, 0, x2 - x1, h);
            }

            const max = Math.max(...data.map(Math.abs), 0.01);

            ctx.strokeStyle = color;
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            for (let i = 0; i < data.length; i++) {
                const x = (i / data.length) * w;
                const y = h / 2 - (data[i] / max) * (h * 0.4);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();
        }

        function drawXCorr(data, peakIdx) {
            const ctx = document.getElementById('xcorrCanvas').getContext('2d');
            const canvas = document.getElementById('xcorrCanvas');
            const w = canvas.width / (window.devicePixelRatio || 1);
            const h = canvas.height / (window.devicePixelRatio || 1);

            ctx.fillStyle = 'rgba(0,20,40,0.5)';
            ctx.fillRect(0, 0, w, h);

            ctx.strokeStyle = 'rgba(0,170,255,0.2)';
            ctx.beginPath();
            ctx.moveTo(0, h / 2);
            ctx.lineTo(w, h / 2);
            ctx.stroke();

            const max = Math.max(...data.map(Math.abs), 0.01);

            // Mark peak
            const peakX = (peakIdx / data.length) * w;
            ctx.fillStyle = 'rgba(255,170,0,0.3)';
            ctx.fillRect(peakX - 5, 0, 10, h);

            ctx.strokeStyle = '#00ffaa';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let i = 0; i < data.length; i++) {
                const x = (i / data.length) * w;
                const y = h / 2 - (data[i] / max) * (h * 0.4);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            ctx.fillStyle = '#ffaa00';
            ctx.font = '11px Courier New';
            ctx.fillText(`Peak at ${peakIdx}`, peakX + 10, 20);
        }

        function drawAnimation() {
            const canvas = document.getElementById('animCanvas');
            const ctx = canvas.getContext('2d');
            const w = canvas.width / (window.devicePixelRatio || 1);
            const h = canvas.height / (window.devicePixelRatio || 1);

            ctx.fillStyle = 'rgba(0,20,40,0.5)';
            ctx.fillRect(0, 0, w, h);

            const max = Math.max(...signal.map(Math.abs), 0.01);

            // Draw signal
            ctx.strokeStyle = '#00aaff';
            ctx.lineWidth = 1;
            ctx.beginPath();
            for (let i = 0; i < signal.length; i++) {
                const x = (i / signal.length) * w;
                const y = h / 2 - (signal[i] / max) * (h * 0.35);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            // Draw sliding template
            ctx.strokeStyle = '#ff6688';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let i = 0; i < template.length; i++) {
                const x = ((currentLag + i) / signal.length) * w;
                const y = h / 2 - (template[i] / max) * (h * 0.35);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            // Current correlation value
            let corr = 0;
            for (let i = 0; i < template.length && currentLag + i < signal.length; i++) {
                corr += signal[currentLag + i] * template[i];
            }

            ctx.fillStyle = '#888';
            ctx.font = '12px Courier New';
            ctx.fillText(`Lag: ${currentLag}  Correlation: ${corr.toFixed(2)}`, 10, 20);
        }

        function generateNew() {
            generateTemplate();
            generateSignal();
            xcorr = computeCrossCorrelation();
            const detectedPos = findPeak(xcorr);

            document.getElementById('detectionText').innerHTML =
                `True: ${truePosition}, Detected: ${detectedPos} ` +
                (Math.abs(detectedPos - truePosition) <= 1 ?
                    '<span style="color:#00ff88">✓ MATCH</span>' :
                    '<span style="color:#ff4444">✗ ERROR</span>');

            draw();
        }

        function draw() {
            drawSignal(document.getElementById('signalCanvas'), signal, '#00aaff', truePosition, templateLength);
            drawSignal(document.getElementById('templateCanvas'), template, '#ff6688');
            drawXCorr(xcorr, findPeak(xcorr));
            drawAnimation();
        }

        function toggleAnimation() {
            isAnimating = !isAnimating;
            document.getElementById('animBtn').textContent =
                isAnimating ? 'Stop Animation' : 'Start Animation';
            if (isAnimating) animate();
        }

        function animate() {
            if (!isAnimating) return;
            currentLag = (currentLag + 2) % (N - templateLength);
            drawAnimation();
            requestAnimationFrame(animate);
        }

        function init() {
            ['signalCanvas', 'templateCanvas', 'xcorrCanvas', 'animCanvas'].forEach(id => {
                resizeCanvas(document.getElementById(id));
            });
            generateNew();
        }

        window.addEventListener('resize', init);
        init();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
