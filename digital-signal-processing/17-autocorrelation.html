<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autocorrelation Function - Signal Self-Similarity</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3e 100%);
            color: #00aaff; min-height: 100vh; padding: 20px;
        }
        .back-link {
            position: fixed; top: 20px; left: 20px; color: #00aaff;
            text-decoration: none; padding: 10px 20px;
            background: rgba(0,170,255,0.1); border: 1px solid #00aaff;
            border-radius: 5px; z-index: 100;
        }
        .container { max-width: 1100px; margin: 60px auto 0; }
        h1 { font-size: 2rem; margin-bottom: 10px; text-align: center; }
        .subtitle { color: #888; margin-bottom: 30px; text-align: center; }
        .viz-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 20px; margin-bottom: 30px;
        }
        .panel {
            background: rgba(0,0,0,0.5); padding: 20px;
            border-radius: 15px; border: 1px solid #00aaff;
        }
        .panel h3 { color: #00ccff; margin-bottom: 15px; text-align: center; }
        canvas { width: 100%; height: 200px; background: rgba(0,20,40,0.5); border-radius: 10px; }
        .controls {
            background: rgba(0,170,255,0.05); padding: 20px;
            border-radius: 15px; margin-bottom: 30px;
        }
        .control-row {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;
        }
        .control-group label { display: block; color: #888; margin-bottom: 8px; }
        select, input[type="range"] {
            width: 100%; padding: 8px; font-family: inherit;
            background: rgba(0,170,255,0.1); border: 1px solid #00aaff;
            color: #00aaff; border-radius: 5px;
        }
        input[type="range"] { padding: 0; height: 8px; }
        .value { color: #00ffff; font-size: 0.9rem; margin-top: 5px; }
        .detection {
            text-align: center; padding: 15px;
            background: rgba(0,255,136,0.1); border: 1px solid #00ff88;
            border-radius: 10px; margin-bottom: 20px;
        }
        .detection h4 { color: #00ff88; margin-bottom: 5px; }
        .info { background: rgba(0,170,255,0.05); padding: 20px; border-radius: 10px; }
        .info h3 { color: #00ccff; margin-bottom: 10px; }
        .info p { color: #aaa; line-height: 1.6; margin-bottom: 10px; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back</a>
    <div class="container">
        <h1>Autocorrelation Function</h1>
        <p class="subtitle">Measure how similar a signal is to a time-shifted version of itself</p>

        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label>Signal Type</label>
                    <select id="signal">
                        <option value="sine">Pure Sine Wave</option>
                        <option value="noisy">Noisy Sine Wave</option>
                        <option value="pulse">Pulse Train</option>
                        <option value="chirp">Chirp Signal</option>
                        <option value="noise">White Noise</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Signal Frequency</label>
                    <input type="range" id="freq" min="5" max="50" value="20" step="1">
                    <div class="value" id="freqVal">20 Hz</div>
                </div>
                <div class="control-group">
                    <label>Noise Level</label>
                    <input type="range" id="noise" min="0" max="100" value="30" step="5">
                    <div class="value" id="noiseVal">30%</div>
                </div>
            </div>
        </div>

        <div class="detection">
            <h4>Detected Period</h4>
            <span id="periodText" style="font-size:1.3rem;">-- samples (-- Hz)</span>
        </div>

        <div class="viz-grid">
            <div class="panel">
                <h3>Original Signal x[n]</h3>
                <canvas id="signalCanvas"></canvas>
            </div>
            <div class="panel">
                <h3>Autocorrelation R[k]</h3>
                <canvas id="acfCanvas"></canvas>
            </div>
        </div>

        <div class="viz-grid">
            <div class="panel">
                <h3>Sliding Correlation Animation</h3>
                <canvas id="animCanvas"></canvas>
            </div>
            <div class="panel">
                <h3>Power Spectral Density</h3>
                <canvas id="psdCanvas"></canvas>
            </div>
        </div>

        <div class="info">
            <h3>Autocorrelation Applications</h3>
            <p><strong>Pitch Detection:</strong> Find the fundamental frequency of speech or music by locating the first major peak after lag 0.</p>
            <p><strong>Periodicity Detection:</strong> Identify repeating patterns in time series data (machine vibrations, ECG, etc.).</p>
            <p><strong>Noise Reduction:</strong> Random noise has near-zero autocorrelation at non-zero lags, while periodic signals maintain correlation.</p>
            <p><strong>Wiener-Khinchin Theorem:</strong> The autocorrelation and power spectral density are Fourier transform pairs.</p>
        </div>
    </div>

    <script>
        const signalCanvas = document.getElementById('signalCanvas');
        const acfCanvas = document.getElementById('acfCanvas');
        const animCanvas = document.getElementById('animCanvas');
        const psdCanvas = document.getElementById('psdCanvas');

        const N = 256;
        const sampleRate = 1000;
        let currentLag = 0;

        function resizeCanvas(canvas) {
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvas.getContext('2d').scale(dpr, dpr);
        }

        function generateSignal(type, freq, noiseLevel) {
            const sig = [];
            for (let i = 0; i < N; i++) {
                const t = i / sampleRate;
                let s = 0;
                switch (type) {
                    case 'sine':
                        s = Math.sin(2 * Math.PI * freq * t);
                        break;
                    case 'noisy':
                        s = Math.sin(2 * Math.PI * freq * t) + noiseLevel * (Math.random() - 0.5) * 2;
                        break;
                    case 'pulse':
                        const period = Math.floor(sampleRate / freq);
                        s = (i % period < period / 4) ? 1 : 0;
                        break;
                    case 'chirp':
                        s = Math.sin(2 * Math.PI * (freq + freq * t * 2) * t);
                        break;
                    case 'noise':
                        s = (Math.random() - 0.5) * 2;
                        break;
                }
                sig.push(s);
            }
            return sig;
        }

        function computeAutocorrelation(signal) {
            const n = signal.length;
            const acf = [];

            for (let lag = 0; lag < n / 2; lag++) {
                let sum = 0;
                for (let i = 0; i < n - lag; i++) {
                    sum += signal[i] * signal[i + lag];
                }
                acf.push(sum / (n - lag));
            }

            // Normalize
            const max = acf[0];
            return acf.map(v => v / max);
        }

        function findPeriod(acf) {
            // Find first significant peak after lag 0
            let inDip = false;
            for (let i = 1; i < acf.length; i++) {
                if (acf[i] < 0.5) inDip = true;
                if (inDip && acf[i] > 0.7) {
                    return i;
                }
            }
            return 0;
        }

        function computePSD(signal) {
            // Simple periodogram
            const psd = [];
            for (let k = 0; k < signal.length / 2; k++) {
                let re = 0, im = 0;
                for (let n = 0; n < signal.length; n++) {
                    const angle = -2 * Math.PI * k * n / signal.length;
                    re += signal[n] * Math.cos(angle);
                    im += signal[n] * Math.sin(angle);
                }
                psd.push((re * re + im * im) / signal.length);
            }
            return psd;
        }

        function drawSignal(canvas, data, color, shiftedData = null, lag = 0) {
            const ctx = canvas.getContext('2d');
            const w = canvas.width / (window.devicePixelRatio || 1);
            const h = canvas.height / (window.devicePixelRatio || 1);

            ctx.fillStyle = 'rgba(0,20,40,0.5)';
            ctx.fillRect(0, 0, w, h);

            ctx.strokeStyle = 'rgba(0,170,255,0.2)';
            ctx.beginPath();
            ctx.moveTo(0, h / 2);
            ctx.lineTo(w, h / 2);
            ctx.stroke();

            const max = Math.max(...data.map(Math.abs), 0.01);

            ctx.strokeStyle = color;
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            for (let i = 0; i < data.length; i++) {
                const x = (i / data.length) * w;
                const y = h / 2 - (data[i] / max) * (h * 0.4);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            if (shiftedData) {
                ctx.strokeStyle = '#ff6688';
                ctx.globalAlpha = 0.7;
                ctx.beginPath();
                for (let i = 0; i < shiftedData.length; i++) {
                    const x = ((i + lag) / data.length) * w;
                    const y = h / 2 - (shiftedData[i] / max) * (h * 0.4);
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
                ctx.globalAlpha = 1;

                ctx.fillStyle = '#888';
                ctx.font = '12px Courier New';
                ctx.fillText(`Lag = ${lag} samples`, 10, 20);
            }
        }

        function drawACF(acf, detectedPeriod) {
            const ctx = acfCanvas.getContext('2d');
            const w = acfCanvas.width / (window.devicePixelRatio || 1);
            const h = acfCanvas.height / (window.devicePixelRatio || 1);

            ctx.fillStyle = 'rgba(0,20,40,0.5)';
            ctx.fillRect(0, 0, w, h);

            ctx.strokeStyle = 'rgba(0,170,255,0.2)';
            ctx.beginPath();
            ctx.moveTo(0, h / 2);
            ctx.lineTo(w, h / 2);
            ctx.stroke();

            ctx.strokeStyle = '#00ffaa';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let i = 0; i < acf.length; i++) {
                const x = (i / acf.length) * w;
                const y = h / 2 - acf[i] * (h * 0.45);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            // Mark detected period
            if (detectedPeriod > 0) {
                const periodX = (detectedPeriod / acf.length) * w;
                ctx.strokeStyle = '#ffaa00';
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(periodX, 0);
                ctx.lineTo(periodX, h);
                ctx.stroke();
                ctx.setLineDash([]);
            }

            ctx.fillStyle = '#888';
            ctx.font = '11px Courier New';
            ctx.fillText('Lag →', w - 50, h - 10);
        }

        function drawPSD(psd) {
            const ctx = psdCanvas.getContext('2d');
            const w = psdCanvas.width / (window.devicePixelRatio || 1);
            const h = psdCanvas.height / (window.devicePixelRatio || 1);

            ctx.fillStyle = 'rgba(0,20,40,0.5)';
            ctx.fillRect(0, 0, w, h);

            const maxPsd = Math.max(...psd);
            const dbPsd = psd.map(v => 10 * Math.log10(v / maxPsd + 1e-10));

            ctx.strokeStyle = '#aa88ff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let i = 0; i < psd.length; i++) {
                const x = (i / psd.length) * w;
                const y = (-dbPsd[i] / 40) * h;
                if (i === 0) ctx.moveTo(x, Math.max(0, Math.min(h, y)));
                else ctx.lineTo(x, Math.max(0, Math.min(h, y)));
            }
            ctx.stroke();

            ctx.fillStyle = '#888';
            ctx.font = '11px Courier New';
            ctx.fillText('0 Hz', 5, h - 5);
            ctx.fillText(`${sampleRate / 2} Hz`, w - 50, h - 5);
        }

        let signal = [];
        let acf = [];

        function update() {
            const signalType = document.getElementById('signal').value;
            const freq = parseInt(document.getElementById('freq').value);
            const noise = parseInt(document.getElementById('noise').value) / 100;

            document.getElementById('freqVal').textContent = freq + ' Hz';
            document.getElementById('noiseVal').textContent = (noise * 100) + '%';

            signal = generateSignal(signalType, freq, noise);
            acf = computeAutocorrelation(signal);
            const psd = computePSD(signal);

            const period = findPeriod(acf);
            const detectedFreq = period > 0 ? sampleRate / period : 0;
            document.getElementById('periodText').textContent =
                period > 0 ? `${period} samples (${detectedFreq.toFixed(1)} Hz)` : 'No periodicity detected';

            drawSignal(signalCanvas, signal, '#00aaff');
            drawACF(acf, period);
            drawPSD(psd);
        }

        function animate() {
            currentLag = (currentLag + 1) % (N / 2);
            const shifted = signal.slice(0, N - currentLag);
            drawSignal(animCanvas, signal, '#00aaff', shifted, currentLag);
            requestAnimationFrame(animate);
        }

        function init() {
            [signalCanvas, acfCanvas, animCanvas, psdCanvas].forEach(resizeCanvas);
            update();
            animate();
        }

        ['signal', 'freq', 'noise'].forEach(id => {
            document.getElementById(id).addEventListener('input', update);
            document.getElementById(id).addEventListener('change', update);
        });

        window.addEventListener('resize', init);
        init();
    </script>
</body>
</html>
