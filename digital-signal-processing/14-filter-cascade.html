<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filter Cascade - Series Combination</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3e 100%);
            color: #00aaff; min-height: 100vh; padding: 20px;
        }
        .back-link {
            position: fixed; top: 20px; left: 20px; color: #00aaff;
            text-decoration: none; padding: 10px 20px;
            background: rgba(0,170,255,0.1); border: 1px solid #00aaff;
            border-radius: 5px; z-index: 100;
        }
        .container { max-width: 1100px; margin: 60px auto 0; }
        h1 { font-size: 2rem; margin-bottom: 10px; text-align: center; }
        .subtitle { color: #888; margin-bottom: 30px; text-align: center; }
        .cascade-diagram {
            display: flex; align-items: center; justify-content: center;
            gap: 15px; margin-bottom: 30px; flex-wrap: wrap;
        }
        .filter-box {
            background: rgba(0,170,255,0.1); padding: 15px 25px;
            border-radius: 10px; border: 2px solid #00aaff;
            text-align: center; cursor: pointer; transition: all 0.3s;
        }
        .filter-box:hover { background: rgba(0,170,255,0.2); }
        .filter-box.active { border-color: #00ffaa; background: rgba(0,255,170,0.15); }
        .filter-box h4 { color: #00ccff; margin-bottom: 5px; }
        .filter-box p { color: #888; font-size: 0.85rem; }
        .arrow { color: #00aaff; font-size: 1.5rem; }
        .main-panel {
            background: rgba(0,0,0,0.5); padding: 25px;
            border-radius: 15px; border: 1px solid #00aaff; margin-bottom: 30px;
        }
        canvas { width: 100%; height: 280px; background: rgba(0,20,40,0.5); border-radius: 10px; }
        .legend {
            display: flex; justify-content: center; gap: 30px;
            margin-top: 15px; flex-wrap: wrap;
        }
        .legend-item { display: flex; align-items: center; gap: 8px; }
        .legend-color { width: 25px; height: 4px; border-radius: 2px; }
        .controls {
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 15px; margin-top: 20px;
        }
        .control-group label { display: block; color: #888; margin-bottom: 5px; font-size: 0.9rem; }
        input[type="range"] {
            width: 100%; height: 6px; background: rgba(0,170,255,0.2); border-radius: 3px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 14px; height: 14px;
            background: #00aaff; border-radius: 50%; cursor: pointer;
        }
        .value { color: #00ffff; font-size: 0.85rem; margin-top: 3px; }
        .info { background: rgba(0,170,255,0.05); padding: 20px; border-radius: 10px; }
        .info h3 { color: #00ccff; margin-bottom: 10px; }
        .info p { color: #aaa; line-height: 1.6; margin-bottom: 10px; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back</a>
    <div class="container">
        <h1>Filter Cascade</h1>
        <p class="subtitle">Combine filters in series - magnitudes multiply, phases add</p>

        <div class="cascade-diagram">
            <div class="filter-box active" id="box1" onclick="toggleFilter(1)">
                <h4>Low-Pass</h4>
                <p>Butterworth</p>
            </div>
            <span class="arrow">→</span>
            <div class="filter-box active" id="box2" onclick="toggleFilter(2)">
                <h4>Notch</h4>
                <p>60 Hz reject</p>
            </div>
            <span class="arrow">→</span>
            <div class="filter-box" id="box3" onclick="toggleFilter(3)">
                <h4>High-Pass</h4>
                <p>DC blocking</p>
            </div>
            <span class="arrow">→</span>
            <span style="color:#00ffaa; font-size:1.2rem;">Output</span>
        </div>

        <div class="main-panel">
            <canvas id="mainCanvas"></canvas>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff6688;"></div>
                    <span>Low-Pass</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffaa00;"></div>
                    <span>Notch</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #aa88ff;"></div>
                    <span>High-Pass</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #00ffaa; height: 6px;"></div>
                    <span>Combined (thick)</span>
                </div>
            </div>
            <div class="controls">
                <div class="control-group">
                    <label>LP Cutoff</label>
                    <input type="range" id="lpCutoff" min="0.1" max="0.8" value="0.4" step="0.05">
                    <div class="value" id="lpCutoffVal">0.40π</div>
                </div>
                <div class="control-group">
                    <label>Notch Frequency</label>
                    <input type="range" id="notchFreq" min="0.05" max="0.45" value="0.15" step="0.01">
                    <div class="value" id="notchFreqVal">0.15π</div>
                </div>
                <div class="control-group">
                    <label>HP Cutoff</label>
                    <input type="range" id="hpCutoff" min="0.01" max="0.3" value="0.05" step="0.01">
                    <div class="value" id="hpCutoffVal">0.05π</div>
                </div>
            </div>
        </div>

        <div class="info">
            <h3>Cascading Filters</h3>
            <p><strong>Magnitude:</strong> |H_total(ω)| = |H₁(ω)| × |H₂(ω)| × |H₃(ω)| - Multiply in linear domain, add in dB</p>
            <p><strong>Phase:</strong> ∠H_total(ω) = ∠H₁(ω) + ∠H₂(ω) + ∠H₃(ω) - Phases always add</p>
            <p><strong>Common Use Cases:</strong></p>
            <p>• Band-pass = Low-pass + High-pass cascaded</p>
            <p>• Anti-aliasing = Multiple stages for sharper rolloff</p>
            <p>• Signal conditioning = DC blocking + notch + smoothing</p>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');

        let activeFilters = [true, true, false];

        function resizeCanvas() {
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
        }

        function butterworth(omega, n, wc) {
            return 1 / Math.sqrt(1 + Math.pow(omega / wc, 2 * n));
        }

        function highpass(omega, n, wc) {
            if (omega < 0.001) return 0;
            return 1 / Math.sqrt(1 + Math.pow(wc / omega, 2 * n));
        }

        function notch(omega, notchFreq, Q) {
            const r = 1 - notchFreq / (2 * Q);
            const cosW0 = Math.cos(notchFreq * Math.PI);
            const cosW = Math.cos(omega * Math.PI);
            const sinW = Math.sin(omega * Math.PI);

            const numRe = 1 - 2 * cosW0 * cosW + Math.cos(2 * omega * Math.PI);
            const numIm = -2 * cosW0 * sinW + Math.sin(2 * omega * Math.PI);
            const denRe = 1 - 2 * r * cosW0 * cosW + r * r * Math.cos(2 * omega * Math.PI);
            const denIm = -2 * r * cosW0 * sinW + r * r * Math.sin(2 * omega * Math.PI);

            const numMag = Math.sqrt(numRe * numRe + numIm * numIm);
            const denMag = Math.sqrt(denRe * denRe + denIm * denIm);

            return numMag / (denMag + 1e-10);
        }

        function draw() {
            const w = canvas.width / (window.devicePixelRatio || 1);
            const h = canvas.height / (window.devicePixelRatio || 1);

            const lpCutoff = parseFloat(document.getElementById('lpCutoff').value);
            const notchFreq = parseFloat(document.getElementById('notchFreq').value);
            const hpCutoff = parseFloat(document.getElementById('hpCutoff').value);

            ctx.fillStyle = 'rgba(0,20,40,0.5)';
            ctx.fillRect(0, 0, w, h);

            // Grid
            ctx.strokeStyle = 'rgba(0,170,255,0.1)';
            ctx.fillStyle = '#666';
            ctx.font = '10px Courier New';
            for (let db = 0; db >= -60; db -= 10) {
                const y = (-db / 60) * h;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(w, y);
                ctx.stroke();
                if (db % 20 === 0) ctx.fillText(`${db}dB`, 5, y - 3);
            }

            const responses = [];
            const colors = ['#ff6688', '#ffaa00', '#aa88ff'];
            const names = ['LP', 'Notch', 'HP'];

            // Calculate individual responses
            for (let x = 0; x < w; x++) {
                const omega = x / w;
                const lp = butterworth(omega, 4, lpCutoff);
                const nt = notch(omega, notchFreq, 10);
                const hp = highpass(omega, 4, hpCutoff);
                responses.push([lp, nt, hp]);
            }

            // Draw individual filters
            for (let f = 0; f < 3; f++) {
                if (!activeFilters[f]) continue;
                ctx.strokeStyle = colors[f];
                ctx.lineWidth = 1.5;
                ctx.globalAlpha = 0.7;
                ctx.beginPath();
                for (let x = 0; x < w; x++) {
                    const mag = responses[x][f];
                    const db = 20 * Math.log10(mag + 1e-10);
                    const y = Math.min(h, Math.max(0, (-db / 60) * h));
                    if (x === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
            }
            ctx.globalAlpha = 1;

            // Draw combined response
            ctx.strokeStyle = '#00ffaa';
            ctx.lineWidth = 3;
            ctx.beginPath();
            for (let x = 0; x < w; x++) {
                let combined = 1;
                for (let f = 0; f < 3; f++) {
                    if (activeFilters[f]) combined *= responses[x][f];
                }
                const db = 20 * Math.log10(combined + 1e-10);
                const y = Math.min(h, Math.max(0, (-db / 60) * h));
                if (x === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            // Frequency labels
            ctx.fillStyle = '#888';
            ctx.fillText('0', 5, h - 5);
            ctx.fillText('π', w - 15, h - 5);
        }

        function toggleFilter(num) {
            activeFilters[num - 1] = !activeFilters[num - 1];
            document.getElementById('box' + num).classList.toggle('active');
            draw();
        }

        function update() {
            document.getElementById('lpCutoffVal').textContent =
                parseFloat(document.getElementById('lpCutoff').value).toFixed(2) + 'π';
            document.getElementById('notchFreqVal').textContent =
                parseFloat(document.getElementById('notchFreq').value).toFixed(2) + 'π';
            document.getElementById('hpCutoffVal').textContent =
                parseFloat(document.getElementById('hpCutoff').value).toFixed(2) + 'π';
            draw();
        }

        function init() {
            resizeCanvas();
            update();
        }

        ['lpCutoff', 'notchFreq', 'hpCutoff'].forEach(id => {
            document.getElementById(id).addEventListener('input', update);
        });

        window.addEventListener('resize', init);
        init();
    </script>
</body>
</html>
