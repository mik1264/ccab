<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIR Filter Designer - Finite Impulse Response</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3e 100%);
            color: #00aaff;
            min-height: 100vh;
            padding: 20px;
        }
        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #00aaff;
            text-decoration: none;
            padding: 10px 20px;
            background: rgba(0,170,255,0.1);
            border: 1px solid #00aaff;
            border-radius: 5px;
            z-index: 100;
        }
        .back-link:hover { background: rgba(0,170,255,0.2); }
        .container {
            max-width: 1200px;
            margin: 60px auto 0;
        }
        h1 { font-size: 2rem; margin-bottom: 10px; text-align: center; }
        .subtitle { color: #888; margin-bottom: 30px; text-align: center; }
        .viz-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .panel {
            background: rgba(0,0,0,0.5);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #00aaff;
        }
        .panel h3 { color: #00ccff; margin-bottom: 15px; text-align: center; }
        canvas {
            width: 100%;
            height: 200px;
            background: rgba(0,20,40,0.5);
            border-radius: 10px;
        }
        .controls {
            background: rgba(0,170,255,0.05);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        .control-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 15px;
        }
        .control-group label { display: block; color: #888; margin-bottom: 5px; font-size: 0.9rem; }
        input[type="range"] {
            width: 100%;
            height: 8px;
            background: rgba(0,170,255,0.2);
            border-radius: 4px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #00aaff;
            border-radius: 50%;
            cursor: pointer;
        }
        .value { color: #00ffff; font-size: 0.9rem; margin-top: 3px; }
        select {
            width: 100%;
            padding: 8px;
            font-family: inherit;
            background: rgba(0,170,255,0.1);
            border: 1px solid #00aaff;
            color: #00aaff;
            border-radius: 5px;
        }
        .specs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .spec-box {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .spec-box h4 { color: #888; font-size: 0.8rem; margin-bottom: 5px; }
        .spec-box .value { font-size: 1.1rem; }
        .info {
            background: rgba(0,170,255,0.05);
            padding: 20px;
            border-radius: 10px;
        }
        .info h3 { color: #00ccff; margin-bottom: 10px; }
        .info p { color: #aaa; line-height: 1.6; margin-bottom: 10px; }
        @media (max-width: 768px) {
            .viz-grid { grid-template-columns: 1fr; }
            .control-row { grid-template-columns: 1fr 1fr; }
            .specs { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back</a>
    <div class="container">
        <h1>FIR Filter Designer</h1>
        <p class="subtitle">Design finite impulse response filters with linear phase</p>

        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label>Filter Type</label>
                    <select id="filterType">
                        <option value="lowpass">Low-Pass</option>
                        <option value="highpass">High-Pass</option>
                        <option value="bandpass">Band-Pass</option>
                        <option value="bandstop">Band-Stop</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Cutoff Frequency</label>
                    <input type="range" id="cutoff" min="0.01" max="0.49" value="0.2" step="0.01">
                    <div class="value" id="cutoffVal">0.20 (normalized)</div>
                </div>
                <div class="control-group">
                    <label>Filter Order (taps - 1)</label>
                    <input type="range" id="order" min="4" max="64" value="21" step="1">
                    <div class="value" id="orderVal">21 taps</div>
                </div>
                <div class="control-group">
                    <label>Window Function</label>
                    <select id="window">
                        <option value="rectangular">Rectangular</option>
                        <option value="hamming" selected>Hamming</option>
                        <option value="hann">Hann</option>
                        <option value="blackman">Blackman</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="specs">
            <div class="spec-box">
                <h4>Passband Ripple</h4>
                <div class="value" id="passRipple">< 0.1 dB</div>
            </div>
            <div class="spec-box">
                <h4>Stopband Attenuation</h4>
                <div class="value" id="stopAtten">-53 dB</div>
            </div>
            <div class="spec-box">
                <h4>Transition Width</h4>
                <div class="value" id="transWidth">0.09 (norm)</div>
            </div>
        </div>

        <div class="viz-grid">
            <div class="panel">
                <h3>Impulse Response h[n]</h3>
                <canvas id="impulseCanvas"></canvas>
            </div>
            <div class="panel">
                <h3>Frequency Response |H(f)| (dB)</h3>
                <canvas id="freqCanvas"></canvas>
            </div>
            <div class="panel">
                <h3>Phase Response ∠H(f)</h3>
                <canvas id="phaseCanvas"></canvas>
            </div>
            <div class="panel">
                <h3>Group Delay</h3>
                <canvas id="delayCanvas"></canvas>
            </div>
        </div>

        <div class="info">
            <h3>FIR Filter Properties</h3>
            <p><strong>Finite Impulse Response:</strong> The output depends only on a finite number of input samples. The impulse response has finite duration.</p>
            <p><strong>Linear Phase:</strong> Symmetric FIR filters have exactly linear phase, meaning all frequencies are delayed by the same amount - no phase distortion.</p>
            <p><strong>Always Stable:</strong> FIR filters have no feedback (no poles), so they cannot become unstable.</p>
            <p><strong>Trade-off:</strong> Higher order (more taps) gives sharper transitions but increases computation and delay.</p>
        </div>
    </div>

    <script>
        const impulseCanvas = document.getElementById('impulseCanvas');
        const freqCanvas = document.getElementById('freqCanvas');
        const phaseCanvas = document.getElementById('phaseCanvas');
        const delayCanvas = document.getElementById('delayCanvas');

        function resizeCanvas(canvas) {
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvas.getContext('2d').scale(dpr, dpr);
        }

        function sinc(x) {
            return x === 0 ? 1 : Math.sin(Math.PI * x) / (Math.PI * x);
        }

        function getWindow(type, N) {
            const w = new Array(N);
            for (let n = 0; n < N; n++) {
                switch (type) {
                    case 'rectangular': w[n] = 1; break;
                    case 'hamming': w[n] = 0.54 - 0.46 * Math.cos(2 * Math.PI * n / (N - 1)); break;
                    case 'hann': w[n] = 0.5 * (1 - Math.cos(2 * Math.PI * n / (N - 1))); break;
                    case 'blackman': w[n] = 0.42 - 0.5 * Math.cos(2 * Math.PI * n / (N - 1)) + 0.08 * Math.cos(4 * Math.PI * n / (N - 1)); break;
                }
            }
            return w;
        }

        function designFIR(type, cutoff, order, windowType) {
            const N = order;
            const M = (N - 1) / 2;
            const h = new Array(N);
            const w = getWindow(windowType, N);

            for (let n = 0; n < N; n++) {
                const ideal = type === 'lowpass' ?
                    2 * cutoff * sinc(2 * cutoff * (n - M)) :
                    type === 'highpass' ?
                    sinc(n - M) - 2 * cutoff * sinc(2 * cutoff * (n - M)) :
                    2 * 0.3 * sinc(2 * 0.3 * (n - M)) - 2 * cutoff * sinc(2 * cutoff * (n - M));
                h[n] = ideal * w[n];
            }
            return h;
        }

        function computeFreqResponse(h, numPoints = 256) {
            const mag = new Array(numPoints);
            const phase = new Array(numPoints);

            for (let k = 0; k < numPoints; k++) {
                const freq = k / (2 * numPoints);
                let re = 0, im = 0;
                for (let n = 0; n < h.length; n++) {
                    const angle = -2 * Math.PI * freq * n;
                    re += h[n] * Math.cos(angle);
                    im += h[n] * Math.sin(angle);
                }
                mag[k] = Math.sqrt(re * re + im * im);
                phase[k] = Math.atan2(im, re);
            }
            return { mag, phase };
        }

        function drawImpulse(h) {
            const ctx = impulseCanvas.getContext('2d');
            const w = impulseCanvas.width / (window.devicePixelRatio || 1);
            const height = impulseCanvas.height / (window.devicePixelRatio || 1);

            ctx.fillStyle = 'rgba(0,20,40,0.5)';
            ctx.fillRect(0, 0, w, height);

            // Grid
            ctx.strokeStyle = 'rgba(0,170,255,0.1)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, height / 2);
            ctx.lineTo(w, height / 2);
            ctx.stroke();

            const max = Math.max(...h.map(Math.abs));
            const barWidth = w / h.length;

            h.forEach((val, i) => {
                const x = i * barWidth + barWidth / 2;
                const barHeight = (val / max) * (height * 0.45);

                ctx.fillStyle = '#00aaff';
                ctx.beginPath();
                ctx.arc(x, height / 2 - barHeight, 4, 0, Math.PI * 2);
                ctx.fill();

                ctx.strokeStyle = '#00aaff';
                ctx.beginPath();
                ctx.moveTo(x, height / 2);
                ctx.lineTo(x, height / 2 - barHeight);
                ctx.stroke();
            });
        }

        function drawFreqResponse(mag) {
            const ctx = freqCanvas.getContext('2d');
            const w = freqCanvas.width / (window.devicePixelRatio || 1);
            const h = freqCanvas.height / (window.devicePixelRatio || 1);

            ctx.fillStyle = 'rgba(0,20,40,0.5)';
            ctx.fillRect(0, 0, w, h);

            // Grid with dB labels
            ctx.strokeStyle = 'rgba(0,170,255,0.1)';
            ctx.fillStyle = '#666';
            ctx.font = '10px Courier New';
            for (let db = 0; db >= -80; db -= 20) {
                const y = (db / -80) * h;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(w, y);
                ctx.stroke();
                ctx.fillText(`${db}dB`, 5, y - 3);
            }

            // Frequency response
            ctx.strokeStyle = '#00ffaa';
            ctx.lineWidth = 2;
            ctx.beginPath();
            const maxMag = Math.max(...mag);
            for (let i = 0; i < mag.length; i++) {
                const x = (i / mag.length) * w;
                const db = 20 * Math.log10(mag[i] / maxMag + 1e-10);
                const y = Math.max(0, Math.min(h, (db / -80) * h));
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            // Labels
            ctx.fillStyle = '#888';
            ctx.font = '11px Courier New';
            ctx.fillText('0', 5, h - 5);
            ctx.fillText('0.5 (Nyquist)', w - 80, h - 5);
        }

        function drawPhase(phase) {
            const ctx = phaseCanvas.getContext('2d');
            const w = phaseCanvas.width / (window.devicePixelRatio || 1);
            const h = phaseCanvas.height / (window.devicePixelRatio || 1);

            ctx.fillStyle = 'rgba(0,20,40,0.5)';
            ctx.fillRect(0, 0, w, h);

            ctx.strokeStyle = 'rgba(0,170,255,0.1)';
            ctx.beginPath();
            ctx.moveTo(0, h / 2);
            ctx.lineTo(w, h / 2);
            ctx.stroke();

            ctx.strokeStyle = '#ff6688';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let i = 0; i < phase.length; i++) {
                const x = (i / phase.length) * w;
                const y = h / 2 - (phase[i] / Math.PI) * (h * 0.45);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            ctx.fillStyle = '#888';
            ctx.font = '10px Courier New';
            ctx.fillText('+π', 5, 15);
            ctx.fillText('-π', 5, h - 5);
        }

        function drawGroupDelay(h) {
            const ctx = delayCanvas.getContext('2d');
            const w = delayCanvas.width / (window.devicePixelRatio || 1);
            const height = delayCanvas.height / (window.devicePixelRatio || 1);

            ctx.fillStyle = 'rgba(0,20,40,0.5)';
            ctx.fillRect(0, 0, w, height);

            // For symmetric FIR, group delay is constant = (N-1)/2
            const delay = (h.length - 1) / 2;

            ctx.strokeStyle = '#ffaa00';
            ctx.lineWidth = 2;
            const y = height * 0.3;
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(w, y);
            ctx.stroke();

            ctx.fillStyle = '#ffaa00';
            ctx.font = '14px Courier New';
            ctx.textAlign = 'center';
            ctx.fillText(`Constant delay: ${delay.toFixed(1)} samples`, w / 2, height / 2);
            ctx.font = '11px Courier New';
            ctx.fillStyle = '#888';
            ctx.fillText('(Linear phase = constant group delay)', w / 2, height / 2 + 20);
        }

        function update() {
            const type = document.getElementById('filterType').value;
            const cutoff = parseFloat(document.getElementById('cutoff').value);
            const order = parseInt(document.getElementById('order').value) | 1; // Ensure odd
            const windowType = document.getElementById('window').value;

            document.getElementById('cutoffVal').textContent = cutoff.toFixed(2) + ' (normalized)';
            document.getElementById('orderVal').textContent = order + ' taps';

            const h = designFIR(type, cutoff, order, windowType);
            const { mag, phase } = computeFreqResponse(h);

            drawImpulse(h);
            drawFreqResponse(mag);
            drawPhase(phase);
            drawGroupDelay(h);

            // Update specs based on window
            const specs = {
                rectangular: { ripple: '< 0.7 dB', atten: '-21 dB' },
                hamming: { ripple: '< 0.02 dB', atten: '-53 dB' },
                hann: { ripple: '< 0.05 dB', atten: '-44 dB' },
                blackman: { ripple: '< 0.01 dB', atten: '-74 dB' }
            };
            document.getElementById('passRipple').textContent = specs[windowType].ripple;
            document.getElementById('stopAtten').textContent = specs[windowType].atten;
            document.getElementById('transWidth').textContent = (4 / order).toFixed(2) + ' (norm)';
        }

        function init() {
            [impulseCanvas, freqCanvas, phaseCanvas, delayCanvas].forEach(resizeCanvas);
            update();
        }

        ['filterType', 'cutoff', 'order', 'window'].forEach(id => {
            document.getElementById(id).addEventListener('input', update);
            document.getElementById(id).addEventListener('change', update);
        });

        window.addEventListener('resize', init);
        init();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
