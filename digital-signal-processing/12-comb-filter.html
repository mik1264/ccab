<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comb Filter - Periodic Nulls</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3e 100%);
            color: #00aaff; min-height: 100vh; padding: 20px;
        }
        .back-link {
            position: fixed; top: 20px; left: 20px; color: #00aaff;
            text-decoration: none; padding: 10px 20px;
            background: rgba(0,170,255,0.1); border: 1px solid #00aaff;
            border-radius: 5px; z-index: 100;
        }
        .container { max-width: 1100px; margin: 60px auto 0; }
        h1 { font-size: 2rem; margin-bottom: 10px; text-align: center; }
        .subtitle { color: #888; margin-bottom: 30px; text-align: center; }
        .main-panel {
            background: rgba(0,0,0,0.5); padding: 25px;
            border-radius: 15px; border: 1px solid #00aaff; margin-bottom: 30px;
        }
        canvas { width: 100%; height: 250px; background: rgba(0,20,40,0.5); border-radius: 10px; }
        .controls {
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 20px; margin-top: 20px;
        }
        .control-group label { display: block; color: #888; margin-bottom: 8px; }
        input[type="range"] {
            width: 100%; height: 8px; background: rgba(0,170,255,0.2); border-radius: 4px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 16px; height: 16px;
            background: #00aaff; border-radius: 50%; cursor: pointer;
        }
        select {
            width: 100%; padding: 8px; font-family: inherit;
            background: rgba(0,170,255,0.1); border: 1px solid #00aaff;
            color: #00aaff; border-radius: 5px;
        }
        .value { color: #00ffff; font-size: 0.95rem; margin-top: 5px; }
        .comparison {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 20px; margin-bottom: 30px;
        }
        .panel {
            background: rgba(0,0,0,0.5); padding: 20px;
            border-radius: 15px; border: 1px solid #00aaff;
        }
        .panel h3 { color: #00ccff; margin-bottom: 15px; text-align: center; }
        .small-canvas { height: 180px; }
        .info { background: rgba(0,170,255,0.05); padding: 20px; border-radius: 10px; }
        .info h3 { color: #00ccff; margin-bottom: 10px; }
        .info p { color: #aaa; line-height: 1.6; margin-bottom: 10px; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back</a>
    <div class="container">
        <h1>Comb Filter</h1>
        <p class="subtitle">Creates periodic peaks or notches - the basis of flanging and chorus</p>

        <div class="main-panel">
            <canvas id="freqCanvas"></canvas>
            <div class="controls">
                <div class="control-group">
                    <label>Filter Type</label>
                    <select id="type">
                        <option value="feedforward">Feedforward (FIR)</option>
                        <option value="feedback">Feedback (IIR)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Delay (samples)</label>
                    <input type="range" id="delay" min="2" max="50" value="10" step="1">
                    <div class="value" id="delayVal">10 samples</div>
                </div>
                <div class="control-group">
                    <label>Feedback/Mix Gain (α)</label>
                    <input type="range" id="gain" min="-0.9" max="0.9" value="0.5" step="0.05">
                    <div class="value" id="gainVal">α = 0.50</div>
                </div>
            </div>
        </div>

        <div class="comparison">
            <div class="panel">
                <h3>Impulse Response</h3>
                <canvas id="impulseCanvas" class="small-canvas"></canvas>
            </div>
            <div class="panel">
                <h3>Block Diagram</h3>
                <canvas id="diagramCanvas" class="small-canvas"></canvas>
            </div>
        </div>

        <div class="info">
            <h3>Comb Filter Applications</h3>
            <p><strong>Flanging Effect:</strong> Varying the delay creates the classic "jet plane" sweeping sound.</p>
            <p><strong>Chorus Effect:</strong> Multiple slightly-detuned copies of a signal create a richer, ensemble-like sound.</p>
            <p><strong>Room Acoustics:</strong> Comb filtering occurs naturally when direct and reflected sounds combine.</p>
            <p><strong>Feedforward (FIR):</strong> y[n] = x[n] + α·x[n-D] - Creates notches (zeros)</p>
            <p><strong>Feedback (IIR):</strong> y[n] = x[n] + α·y[n-D] - Creates peaks (poles) - can be unstable if |α| ≥ 1</p>
        </div>
    </div>

    <script>
        const freqCanvas = document.getElementById('freqCanvas');
        const impulseCanvas = document.getElementById('impulseCanvas');
        const diagramCanvas = document.getElementById('diagramCanvas');

        function resizeCanvas(canvas) {
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvas.getContext('2d').scale(dpr, dpr);
        }

        function combResponse(omega, D, alpha, isFeedback) {
            if (isFeedback) {
                // IIR: H(z) = 1 / (1 - α·z^(-D))
                const re = 1 - alpha * Math.cos(omega * D);
                const im = alpha * Math.sin(omega * D);
                return 1 / Math.sqrt(re * re + im * im);
            } else {
                // FIR: H(z) = 1 + α·z^(-D)
                const re = 1 + alpha * Math.cos(omega * D);
                const im = -alpha * Math.sin(omega * D);
                return Math.sqrt(re * re + im * im);
            }
        }

        function drawFreqResponse() {
            const ctx = freqCanvas.getContext('2d');
            const w = freqCanvas.width / (window.devicePixelRatio || 1);
            const h = freqCanvas.height / (window.devicePixelRatio || 1);

            const D = parseInt(document.getElementById('delay').value);
            const alpha = parseFloat(document.getElementById('gain').value);
            const isFeedback = document.getElementById('type').value === 'feedback';

            ctx.fillStyle = 'rgba(0,20,40,0.5)';
            ctx.fillRect(0, 0, w, h);

            // Grid
            ctx.strokeStyle = 'rgba(0,170,255,0.1)';
            ctx.fillStyle = '#666';
            ctx.font = '10px Courier New';
            for (let db = 20; db >= -20; db -= 10) {
                const y = ((20 - db) / 40) * h;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(w, y);
                ctx.stroke();
                ctx.fillText(`${db}dB`, 5, y - 3);
            }

            // Response
            ctx.strokeStyle = isFeedback ? '#ff6688' : '#00ffaa';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let x = 0; x < w; x++) {
                const omega = (x / w) * Math.PI;
                const mag = combResponse(omega, D, alpha, isFeedback);
                const db = 20 * Math.log10(mag + 1e-10);
                const y = ((20 - db) / 40) * h;
                if (x === 0) ctx.moveTo(x, Math.max(0, Math.min(h, y)));
                else ctx.lineTo(x, Math.max(0, Math.min(h, y)));
            }
            ctx.stroke();

            // Frequency markers
            ctx.fillStyle = '#888';
            ctx.fillText('0', 5, h - 5);
            ctx.fillText('π (Nyquist)', w - 70, h - 5);

            // Show peak/notch spacing
            const spacing = Math.PI / D;
            ctx.fillStyle = '#00ccff';
            ctx.fillText(`Peak/Notch spacing: π/${D}`, w - 150, 20);
        }

        function drawImpulse() {
            const ctx = impulseCanvas.getContext('2d');
            const w = impulseCanvas.width / (window.devicePixelRatio || 1);
            const h = impulseCanvas.height / (window.devicePixelRatio || 1);

            const D = parseInt(document.getElementById('delay').value);
            const alpha = parseFloat(document.getElementById('gain').value);
            const isFeedback = document.getElementById('type').value === 'feedback';

            ctx.fillStyle = 'rgba(0,20,40,0.5)';
            ctx.fillRect(0, 0, w, h);

            // Generate impulse response
            const N = 100;
            const impulse = new Array(N).fill(0);

            if (isFeedback) {
                impulse[0] = 1;
                for (let n = D; n < N; n++) {
                    impulse[n] = alpha * impulse[n - D];
                }
            } else {
                impulse[0] = 1;
                if (D < N) impulse[D] = alpha;
            }

            // Draw
            const max = Math.max(...impulse.map(Math.abs), 0.1);
            const barWidth = w / N;

            impulse.forEach((val, i) => {
                if (Math.abs(val) > 0.001) {
                    const x = i * barWidth + barWidth / 2;
                    const barHeight = (val / max) * (h * 0.4);

                    ctx.fillStyle = val > 0 ? '#00ffaa' : '#ff6688';
                    ctx.beginPath();
                    ctx.arc(x, h / 2 - barHeight, 4, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.strokeStyle = val > 0 ? '#00ffaa' : '#ff6688';
                    ctx.beginPath();
                    ctx.moveTo(x, h / 2);
                    ctx.lineTo(x, h / 2 - barHeight);
                    ctx.stroke();
                }
            });

            ctx.strokeStyle = 'rgba(0,170,255,0.3)';
            ctx.beginPath();
            ctx.moveTo(0, h / 2);
            ctx.lineTo(w, h / 2);
            ctx.stroke();

            ctx.fillStyle = '#888';
            ctx.font = '11px Courier New';
            ctx.fillText('h[n]', 10, 20);
        }

        function drawDiagram() {
            const ctx = diagramCanvas.getContext('2d');
            const w = diagramCanvas.width / (window.devicePixelRatio || 1);
            const h = diagramCanvas.height / (window.devicePixelRatio || 1);

            const isFeedback = document.getElementById('type').value === 'feedback';

            ctx.fillStyle = 'rgba(0,20,40,0.5)';
            ctx.fillRect(0, 0, w, h);

            ctx.strokeStyle = '#00aaff';
            ctx.fillStyle = '#00aaff';
            ctx.lineWidth = 2;
            ctx.font = '12px Courier New';

            const cx = w / 2;
            const cy = h / 2;

            // Input
            ctx.fillText('x[n]', 30, cy - 30);
            ctx.beginPath();
            ctx.moveTo(60, cy - 25);
            ctx.lineTo(cx - 80, cy - 25);
            ctx.stroke();

            // Adder
            ctx.beginPath();
            ctx.arc(cx - 60, cy - 25, 15, 0, Math.PI * 2);
            ctx.stroke();
            ctx.fillText('+', cx - 65, cy - 20);

            // To output
            ctx.beginPath();
            ctx.moveTo(cx - 45, cy - 25);
            ctx.lineTo(w - 60, cy - 25);
            ctx.stroke();
            ctx.fillText('y[n]', w - 50, cy - 30);

            // Delay branch
            if (isFeedback) {
                // Feedback from output
                ctx.beginPath();
                ctx.moveTo(w - 100, cy - 25);
                ctx.lineTo(w - 100, cy + 40);
                ctx.lineTo(cx - 60, cy + 40);
                ctx.lineTo(cx - 60, cy - 10);
                ctx.stroke();
            } else {
                // Feedforward from input
                ctx.beginPath();
                ctx.moveTo(80, cy - 25);
                ctx.lineTo(80, cy + 40);
                ctx.lineTo(cx - 60, cy + 40);
                ctx.lineTo(cx - 60, cy - 10);
                ctx.stroke();
            }

            // Delay box
            ctx.strokeRect(cx - 100, cy + 25, 80, 30);
            ctx.fillText('z^(-D)', cx - 85, cy + 45);

            // Gain
            ctx.fillText('α', cx - 30, cy + 45);

            ctx.fillStyle = '#888';
            ctx.fillText(isFeedback ? 'Feedback (IIR)' : 'Feedforward (FIR)', 10, h - 10);
        }

        function update() {
            document.getElementById('delayVal').textContent =
                document.getElementById('delay').value + ' samples';
            document.getElementById('gainVal').textContent =
                'α = ' + parseFloat(document.getElementById('gain').value).toFixed(2);

            drawFreqResponse();
            drawImpulse();
            drawDiagram();
        }

        function init() {
            [freqCanvas, impulseCanvas, diagramCanvas].forEach(resizeCanvas);
            update();
        }

        ['type', 'delay', 'gain'].forEach(id => {
            document.getElementById(id).addEventListener('input', update);
            document.getElementById(id).addEventListener('change', update);
        });

        window.addEventListener('resize', init);
        init();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
