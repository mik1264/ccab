<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simulated Annealing - TSP</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; overflow: hidden; font-family: sans-serif; }
canvas { display: block; }
#title {
    position: fixed; top: 50px; left: 50%; transform: translateX(-50%);
    color: #f97316; font-size: 20px; font-weight: bold; z-index: 10;
    text-shadow: 0 0 20px rgba(249,115,22,0.5);
    pointer-events: none;
}
#controls {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
    display: flex; gap: 15px; align-items: center; z-index: 10;
    background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 10px;
}
#controls label { color: #fb923c; font-size: 13px; }
#controls input[type=range] { width: 80px; cursor: pointer; }
#controls select {
    background: rgba(0,0,0,0.5); color: #fb923c; border: 1px solid #fb923c;
    padding: 3px 8px; border-radius: 4px; font-size: 13px; cursor: pointer;
}
#controls button {
    background: rgba(249,115,22,0.2); color: #fb923c; border: 1px solid #fb923c;
    padding: 5px 12px; border-radius: 5px; cursor: pointer; font-size: 13px;
}
#controls button:hover { background: rgba(249,115,22,0.4); }
#info {
    position: fixed; top: 80px; right: 20px; color: #94a3b8; font-size: 12px;
    z-index: 10; text-align: right; line-height: 1.8;
    background: rgba(0,0,0,0.5); padding: 10px 15px; border-radius: 8px;
}
.info-val { color: #fb923c; font-weight: bold; }
</style>
</head>
<body>
<a href="../index.html" style="position:fixed;top:10px;left:10px;padding:8px 16px;background:rgba(0,0,0,0.7);color:#fbbf24;text-decoration:none;border-radius:6px;font-size:14px;z-index:999;font-family:sans-serif;">&#8592; Back to Gallery</a>
<div id="title">Simulated Annealing - Traveling Salesman Problem</div>
<div id="info">
    Cities: <span class="info-val" id="cityCount">30</span><br>
    Temperature: <span class="info-val" id="tempDisplay">1000</span><br>
    Tour Length: <span class="info-val" id="tourLength">0</span><br>
    Best Length: <span class="info-val" id="bestLength">0</span><br>
    Iteration: <span class="info-val" id="iteration">0</span><br>
    Accepted: <span class="info-val" id="acceptRate">0%</span>
</div>
<div id="controls">
    <label>Cities: <select id="numCities">
        <option value="15">15</option>
        <option value="30" selected>30</option>
        <option value="50">50</option>
        <option value="80">80</option>
    </select></label>
    <label>Cooling: <input type="range" id="cooling" min="1" max="10" value="5" step="1"></label>
    <label>Speed: <input type="range" id="speed" min="1" max="100" value="30" step="1"></label>
    <button id="resetBtn">New Problem</button>
    <button id="pauseBtn">Pause</button>
</div>
<canvas id="canvas"></canvas>
<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let W, H;
let cities = [];
let tour = [];
let bestTour = [];
let bestDistance = Infinity;
let temperature = 1000;
let coolingRate = 0.9995;
let iteration = 0;
let speed = 30;
let paused = false;
let numCities = 30;
let distHistory = [];
let tempHistory = [];
let accepted = 0;
let attempted = 0;

function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
}

function distance(a, b) {
    const dx = a.x - b.x;
    const dy = a.y - b.y;
    return Math.sqrt(dx * dx + dy * dy);
}

function tourDistance(t) {
    let d = 0;
    for (let i = 0; i < t.length; i++) {
        d += distance(cities[t[i]], cities[t[(i + 1) % t.length]]);
    }
    return d;
}

function init() {
    resize();
    cities = [];
    const margin = 120;
    const mapW = W * 0.6;
    const mapH = H - 250;

    for (let i = 0; i < numCities; i++) {
        cities.push({
            x: margin + Math.random() * mapW,
            y: 120 + Math.random() * mapH
        });
    }

    // Initial tour: sequential
    tour = Array.from({ length: numCities }, (_, i) => i);
    // Shuffle
    for (let i = tour.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [tour[i], tour[j]] = [tour[j], tour[i]];
    }

    bestTour = [...tour];
    bestDistance = tourDistance(tour);
    temperature = 1000;
    iteration = 0;
    distHistory = [];
    tempHistory = [];
    accepted = 0;
    attempted = 0;
}

function annealStep() {
    // 2-opt swap
    const i = Math.floor(Math.random() * numCities);
    let j = Math.floor(Math.random() * numCities);
    while (j === i) j = Math.floor(Math.random() * numCities);

    const newTour = [...tour];
    // Reverse segment between i and j
    let left = Math.min(i, j);
    let right = Math.max(i, j);
    while (left < right) {
        [newTour[left], newTour[right]] = [newTour[right], newTour[left]];
        left++;
        right--;
    }

    const currentDist = tourDistance(tour);
    const newDist = tourDistance(newTour);
    const delta = newDist - currentDist;

    attempted++;

    if (delta < 0 || Math.random() < Math.exp(-delta / temperature)) {
        tour = newTour;
        accepted++;
        if (newDist < bestDistance) {
            bestDistance = newDist;
            bestTour = [...newTour];
        }
    }

    temperature *= coolingRate;
    iteration++;

    if (iteration % 50 === 0) {
        distHistory.push(tourDistance(tour));
        tempHistory.push(temperature);
    }
}

function drawTour(t, color, alpha, lineWidth) {
    ctx.strokeStyle = color;
    ctx.globalAlpha = alpha;
    ctx.lineWidth = lineWidth;
    ctx.beginPath();
    for (let i = 0; i <= t.length; i++) {
        const city = cities[t[i % t.length]];
        if (i === 0) ctx.moveTo(city.x, city.y);
        else ctx.lineTo(city.x, city.y);
    }
    ctx.stroke();
    ctx.globalAlpha = 1;
}

function drawGraph() {
    const gx = W * 0.65;
    const gy = 120;
    const gw = W * 0.3;
    const gh = (H - 280) * 0.45;

    // Distance graph
    ctx.fillStyle = 'rgba(15,20,40,0.8)';
    ctx.strokeStyle = '#334155';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.roundRect(gx, gy, gw, gh, 8);
    ctx.fill();
    ctx.stroke();

    ctx.fillStyle = '#94a3b8';
    ctx.font = '11px sans-serif';
    ctx.textAlign = 'left';
    ctx.fillText('Tour Length over Time', gx + 10, gy + 18);

    if (distHistory.length > 1) {
        const maxD = Math.max(...distHistory) * 1.05;
        const minD = Math.min(...distHistory) * 0.95;
        const range = maxD - minD || 1;

        ctx.strokeStyle = '#f97316';
        ctx.lineWidth = 1.5;
        ctx.beginPath();
        for (let i = 0; i < distHistory.length; i++) {
            const x = gx + 5 + (i / (distHistory.length - 1)) * (gw - 10);
            const y = gy + gh - 10 - ((distHistory[i] - minD) / range) * (gh - 30);
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        }
        ctx.stroke();

        // Best line
        ctx.strokeStyle = '#22c55e';
        ctx.setLineDash([3, 3]);
        const bestY = gy + gh - 10 - ((bestDistance - minD) / range) * (gh - 30);
        ctx.beginPath();
        ctx.moveTo(gx + 5, bestY);
        ctx.lineTo(gx + gw - 5, bestY);
        ctx.stroke();
        ctx.setLineDash([]);
        ctx.fillStyle = '#22c55e';
        ctx.fillText('Best: ' + bestDistance.toFixed(0), gx + gw - 80, bestY - 5);
    }

    // Temperature graph
    const gy2 = gy + gh + 30;
    ctx.fillStyle = 'rgba(15,20,40,0.8)';
    ctx.strokeStyle = '#334155';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.roundRect(gx, gy2, gw, gh, 8);
    ctx.fill();
    ctx.stroke();

    ctx.fillStyle = '#94a3b8';
    ctx.fillText('Temperature Decay', gx + 10, gy2 + 18);

    if (tempHistory.length > 1) {
        const maxT = Math.max(...tempHistory) * 1.05;

        ctx.strokeStyle = '#ef4444';
        ctx.lineWidth = 1.5;
        ctx.beginPath();
        for (let i = 0; i < tempHistory.length; i++) {
            const x = gx + 5 + (i / (tempHistory.length - 1)) * (gw - 10);
            const y = gy2 + gh - 10 - (tempHistory[i] / maxT) * (gh - 30);
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        }
        ctx.stroke();
    }
}

function draw() {
    ctx.fillStyle = '#0a0e1a';
    ctx.fillRect(0, 0, W, H);

    // Draw best tour (faint)
    if (bestTour.length > 0) {
        drawTour(bestTour, '#22c55e', 0.2, 1);
    }

    // Draw current tour
    drawTour(tour, '#f97316', 0.8, 2);

    // Draw cities
    for (let i = 0; i < cities.length; i++) {
        const c = cities[i];
        ctx.beginPath();
        ctx.arc(c.x, c.y, 5, 0, Math.PI * 2);
        ctx.fillStyle = '#fbbf24';
        ctx.fill();
        ctx.strokeStyle = '#0a0e1a';
        ctx.lineWidth = 1;
        ctx.stroke();

        // City number
        ctx.fillStyle = '#94a3b8';
        ctx.font = '9px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(i + '', c.x, c.y - 9);
    }

    // Draw graphs
    drawGraph();

    // Temperature color bar
    const barX = 20;
    const barY = H - 70;
    const barW = W * 0.55;
    const barH = 8;
    const tempFrac = Math.min(temperature / 1000, 1);

    ctx.fillStyle = 'rgba(15,20,40,0.8)';
    ctx.fillRect(barX - 5, barY - 15, barW + 10, 35);

    const gradient = ctx.createLinearGradient(barX, 0, barX + barW, 0);
    gradient.addColorStop(0, '#3b82f6');
    gradient.addColorStop(0.5, '#f97316');
    gradient.addColorStop(1, '#ef4444');
    ctx.fillStyle = gradient;
    ctx.fillRect(barX, barY, barW * tempFrac, barH);
    ctx.strokeStyle = '#475569';
    ctx.strokeRect(barX, barY, barW, barH);

    ctx.fillStyle = '#94a3b8';
    ctx.font = '10px sans-serif';
    ctx.textAlign = 'left';
    ctx.fillText('Temperature: ' + temperature.toFixed(2), barX, barY - 3);

    // Update info
    document.getElementById('cityCount').textContent = numCities;
    document.getElementById('tempDisplay').textContent = temperature.toFixed(2);
    document.getElementById('tourLength').textContent = tourDistance(tour).toFixed(0);
    document.getElementById('bestLength').textContent = bestDistance.toFixed(0);
    document.getElementById('iteration').textContent = iteration;
    document.getElementById('acceptRate').textContent =
        attempted > 0 ? (accepted / attempted * 100).toFixed(1) + '%' : '0%';
}

function animate() {
    if (!paused) {
        for (let i = 0; i < speed; i++) {
            annealStep();
        }
        draw();
    }
    requestAnimationFrame(animate);
}

document.getElementById('numCities').addEventListener('change', (e) => {
    numCities = parseInt(e.target.value);
    init();
});
document.getElementById('cooling').addEventListener('input', (e) => {
    const v = parseInt(e.target.value);
    coolingRate = 0.999 + (10 - v) * 0.0001;
});
document.getElementById('speed').addEventListener('input', (e) => {
    speed = parseInt(e.target.value);
});
document.getElementById('resetBtn').addEventListener('click', init);
document.getElementById('pauseBtn').addEventListener('click', () => {
    paused = !paused;
    document.getElementById('pauseBtn').textContent = paused ? 'Resume' : 'Pause';
});
window.addEventListener('resize', resize);

init();
animate();
</script>
</body>
</html>
