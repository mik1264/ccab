<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Action Potential - NetLogo Simulations III</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header {
            background: rgba(0,0,0,0.3);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        h1 { color: #00d9ff; font-size: 1.5rem; }
        .back-link {
            color: #888;
            text-decoration: none;
            font-size: 0.9rem;
        }
        .back-link:hover { color: #00d9ff; }
        .main-container {
            display: flex;
            flex: 1;
            gap: 1rem;
            padding: 1rem;
            overflow: hidden;
        }
        .canvas-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        #simCanvas {
            flex: 1;
            background: #0a0a1a;
            border-radius: 8px;
            border: 1px solid #333;
        }
        .controls-panel {
            width: 340px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            overflow-y: auto;
        }
        .control-group { margin-bottom: 0.3rem; }
        .control-group label {
            display: block;
            margin-bottom: 0.2rem;
            color: #aaa;
            font-size: 0.8rem;
        }
        .control-group input[type="range"] {
            width: 100%;
            accent-color: #00d9ff;
        }
        .control-group .value {
            float: right;
            color: #00d9ff;
            font-weight: bold;
        }
        .btn {
            padding: 0.5rem 0.8rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #00d9ff;
            color: #000;
        }
        .btn-primary:hover { background: #00b8d9; }
        .btn-secondary {
            background: #444;
            color: #fff;
        }
        .btn-secondary:hover { background: #555; }
        .btn-stimulus {
            background: #ff9900;
            color: #000;
        }
        .btn-stimulus:hover { background: #ffaa22; }
        .btn-row {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .stats-panel {
            background: rgba(0,100,150,0.2);
            border: 1px solid #00d9ff44;
            border-radius: 5px;
            padding: 0.6rem;
        }
        .stats-panel h3 {
            color: #00d9ff;
            margin-bottom: 0.4rem;
            font-size: 0.9rem;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            margin: 0.15rem 0;
        }
        .stat-value { font-weight: bold; }
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            font-size: 0.7rem;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.2rem;
        }
        .legend-color {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: #1a1a2e;
            padding: 2rem;
            border-radius: 10px;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid #00d9ff44;
        }
        .modal-content h2 {
            color: #00d9ff;
            margin-bottom: 1rem;
        }
        .modal-content p {
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        .modal-content ul {
            margin: 1rem 0 1rem 1.5rem;
        }
        .modal-content li { margin: 0.5rem 0; }
        .close-modal {
            float: right;
            font-size: 1.5rem;
            cursor: pointer;
            color: #888;
        }
        .close-modal:hover { color: #fff; }
        .section-title {
            color: #00d9ff;
            font-size: 0.85rem;
            margin-top: 0.5rem;
            padding-bottom: 0.2rem;
            border-bottom: 1px solid #333;
        }
        .vm-display {
            font-size: 1.6rem;
            font-weight: bold;
            text-align: center;
            padding: 0.6rem;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
        }
        .phase-indicator {
            text-align: center;
            padding: 0.5rem;
            background: rgba(0,0,0,0.2);
            border-radius: 5px;
            font-size: 0.9rem;
        }
    
        .explain-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
        }
        .explain-btn:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            transform: translateY(-2px);
        }
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
        }
        .modal {
            background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%);
            border-radius: 16px;
            padding: 30px;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: #888;
            font-size: 28px;
            cursor: pointer;
            width: auto;
            padding: 0;
            margin: 0;
        }
        .modal-close:hover {
            color: #fff;
            background: none;
        }
        .modal h2 {
            color: #00d9ff;
            margin-bottom: 20px;
            font-size: 1.5rem;
            padding-right: 40px;
        }
        .modal-body {
            color: #ccc;
            line-height: 1.8;
            font-size: 0.95rem;
        }
        .modal-body h3 {
            color: #00ff88;
            margin: 20px 0 10px 0;
            font-size: 1.1rem;
        }
        .modal-body p {
            margin-bottom: 15px;
        }
        .modal-body ul {
            margin: 10px 0 15px 20px;
        }
        .modal-body li {
            margin-bottom: 8px;
        }
        .modal-body strong {
            color: #00d9ff;
        }
        .modal-body em {
            color: #a5b4fc;
            font-style: normal;
        }
        .modal-body code {
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            color: #fbbf24;
        }
    </style>
</head>
<body>
    <header>
        <div>
            <a href="index.html" class="back-link">‚Üê Back to Gallery</a>
            <h1>203. Action Potential</h1>
        </div>
        <div class="btn-row">
            <button class="btn btn-secondary" onclick="showExplanation()">Explain</button>
        </div>
    </header>

    <div class="main-container">
        <div class="canvas-container">
            <canvas id="simCanvas"></canvas>
        </div>

        <div class="controls-panel">
            <div class="btn-row">
                <button class="btn btn-primary" id="playPauseBtn" onclick="toggleSimulation()">Pause</button>
                <button class="btn btn-secondary" onclick="resetSimulation()">Reset</button>
                <button class="btn btn-stimulus" onclick="applyStimulus()">Stimulus</button>
            </div>

            <div class="vm-display">
                V<sub>m</sub> = <span id="vmValue" style="color: #00ff88;">-65.0</span> mV
            </div>

            <div class="phase-indicator">
                Phase: <span id="phaseDisplay">Resting</span>
            </div>

            <div class="section-title">Stimulus</div>
            <div class="control-group">
                <label>Stimulus Current (I<sub>stim</sub>) <span class="value" id="stimVal">10 ¬µA/cm¬≤</span></label>
                <input type="range" id="stimCurrent" min="0" max="30" value="10">
            </div>
            <div class="control-group">
                <label>Stimulus Duration <span class="value" id="durVal">2 ms</span></label>
                <input type="range" id="stimDuration" min="0.5" max="5" value="2" step="0.5">
            </div>

            <div class="section-title">Conductances</div>
            <div class="control-group">
                <label>g<sub>Na</sub> max <span class="value" id="gnaVal">120 mS/cm¬≤</span></label>
                <input type="range" id="gNaMax" min="0" max="200" value="120">
            </div>
            <div class="control-group">
                <label>g<sub>K</sub> max <span class="value" id="gkVal">36 mS/cm¬≤</span></label>
                <input type="range" id="gKMax" min="0" max="100" value="36">
            </div>

            <div class="stats-panel">
                <h3>Gating Variables</h3>
                <div class="stat-row">
                    <span>m (Na‚Å∫ activation)</span>
                    <span class="stat-value" id="mVal" style="color: #ff6644;">0.053</span>
                </div>
                <div class="stat-row">
                    <span>h (Na‚Å∫ inactivation)</span>
                    <span class="stat-value" id="hVal" style="color: #ff9966;">0.596</span>
                </div>
                <div class="stat-row">
                    <span>n (K‚Å∫ activation)</span>
                    <span class="stat-value" id="nVal" style="color: #44aaff;">0.318</span>
                </div>
            </div>

            <div class="stats-panel">
                <h3>Ionic Currents</h3>
                <div class="stat-row">
                    <span>I<sub>Na</sub></span>
                    <span class="stat-value" id="iNaVal" style="color: #ff6644;">0.0 ¬µA/cm¬≤</span>
                </div>
                <div class="stat-row">
                    <span>I<sub>K</sub></span>
                    <span class="stat-value" id="iKVal" style="color: #44aaff;">0.0 ¬µA/cm¬≤</span>
                </div>
                <div class="stat-row">
                    <span>I<sub>L</sub></span>
                    <span class="stat-value" id="iLVal" style="color: #888;">0.0 ¬µA/cm¬≤</span>
                </div>
            </div>

            <div class="stats-panel">
                <h3>Conductances</h3>
                <div class="stat-row">
                    <span>g<sub>Na</sub> = gÃÖ<sub>Na</sub>m¬≥h</span>
                    <span class="stat-value" id="gNaVal" style="color: #ff6644;">0.0 mS/cm¬≤</span>
                </div>
                <div class="stat-row">
                    <span>g<sub>K</sub> = gÃÖ<sub>K</sub>n‚Å¥</span>
                    <span class="stat-value" id="gKVal2" style="color: #44aaff;">0.0 mS/cm¬≤</span>
                </div>
            </div>

            <div class="legend">
                <div class="legend-item"><div class="legend-color" style="background: #00ff88;"></div> V<sub>m</sub></div>
                <div class="legend-item"><div class="legend-color" style="background: #ff6644;"></div> I<sub>Na</sub></div>
                <div class="legend-item"><div class="legend-color" style="background: #44aaff;"></div> I<sub>K</sub></div>
                <div class="legend-item"><div class="legend-color" style="background: #ff9900;"></div> Stimulus</div>
            </div>
        </div>
    </div>

    <div class="modal" id="explanationModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeExplanation()">&times;</span>
            <h2>Action Potential</h2>
            <p>
                This simulation implements the Hodgkin-Huxley model of the action potential,
                showing how voltage-gated sodium and potassium channels generate the all-or-none
                electrical signal that propagates along neurons.
            </p>

            <h3>The Hodgkin-Huxley Equations</h3>
            <p>
                The membrane potential (V) changes according to:
            </p>
            <p style="text-align: center; font-family: monospace;">
                C<sub>m</sub> dV/dt = I<sub>stim</sub> - I<sub>Na</sub> - I<sub>K</sub> - I<sub>L</sub>
            </p>
            <p>where:</p>
            <ul>
                <li>I<sub>Na</sub> = gÃÖ<sub>Na</sub>m¬≥h(V - E<sub>Na</sub>)</li>
                <li>I<sub>K</sub> = gÃÖ<sub>K</sub>n‚Å¥(V - E<sub>K</sub>)</li>
                <li>I<sub>L</sub> = g<sub>L</sub>(V - E<sub>L</sub>)</li>
            </ul>

            <h3>Phases of the Action Potential</h3>
            <ul>
                <li><strong>Resting:</strong> V ‚âà -65 mV, dominated by K‚Å∫ leak</li>
                <li><strong>Threshold:</strong> Depolarization to ~-55 mV triggers rapid Na‚Å∫ channel opening</li>
                <li><strong>Depolarization:</strong> Na‚Å∫ rushes in, V approaches E<sub>Na</sub> (+55 mV)</li>
                <li><strong>Repolarization:</strong> Na‚Å∫ channels inactivate, K‚Å∫ channels open</li>
                <li><strong>Hyperpolarization:</strong> K‚Å∫ outflow overshoots resting potential</li>
                <li><strong>Refractory Period:</strong> Na‚Å∫ channels recover from inactivation</li>
            </ul>

            <h3>All-or-None Response</h3>
            <p>
                Once threshold is reached, the action potential fires with full amplitude regardless
                of stimulus strength. This is due to the positive feedback loop: depolarization
                opens more Na‚Å∫ channels, causing more depolarization.
            </p>

            <h3>Refractory Periods</h3>
            <ul>
                <li><strong>Absolute:</strong> Na‚Å∫ channels inactivated, no AP possible</li>
                <li><strong>Relative:</strong> Some Na‚Å∫ channels recovered, stronger stimulus needed</li>
            </ul>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');

        let running = true;
        let animationId = null;

        // Hodgkin-Huxley parameters
        const C_m = 1.0; // Membrane capacitance ¬µF/cm¬≤
        const E_Na = 55; // Sodium reversal potential mV
        const E_K = -77; // Potassium reversal potential mV
        const E_L = -54.4; // Leak reversal potential mV
        const g_L = 0.3; // Leak conductance mS/cm¬≤

        // State variables
        let V = -65;
        let m = 0.0529;
        let h = 0.5961;
        let n = 0.3177;

        // Stimulus
        let stimulusActive = false;
        let stimulusTimer = 0;

        // History for plotting
        let voltageHistory = [];
        let iNaHistory = [];
        let iKHistory = [];
        const maxHistory = 400;
        let time = 0;

        function getParams() {
            return {
                stimCurrent: parseFloat(document.getElementById('stimCurrent').value),
                stimDuration: parseFloat(document.getElementById('stimDuration').value),
                gNaMax: parseFloat(document.getElementById('gNaMax').value),
                gKMax: parseFloat(document.getElementById('gKMax').value)
            };
        }

        function updateSliderDisplay() {
            document.getElementById('stimVal').textContent = document.getElementById('stimCurrent').value + ' ¬µA/cm¬≤';
            document.getElementById('durVal').textContent = document.getElementById('stimDuration').value + ' ms';
            document.getElementById('gnaVal').textContent = document.getElementById('gNaMax').value + ' mS/cm¬≤';
            document.getElementById('gkVal').textContent = document.getElementById('gKMax').value + ' mS/cm¬≤';
        }

        document.querySelectorAll('input[type="range"]').forEach(slider => {
            slider.addEventListener('input', updateSliderDisplay);
        });

        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }

        // Rate functions
        function alpha_m(V) { return 0.1 * (V + 40) / (1 - Math.exp(-(V + 40) / 10)); }
        function beta_m(V) { return 4 * Math.exp(-(V + 65) / 18); }
        function alpha_h(V) { return 0.07 * Math.exp(-(V + 65) / 20); }
        function beta_h(V) { return 1 / (1 + Math.exp(-(V + 35) / 10)); }
        function alpha_n(V) { return 0.01 * (V + 55) / (1 - Math.exp(-(V + 55) / 10)); }
        function beta_n(V) { return 0.125 * Math.exp(-(V + 65) / 80); }

        // Steady state and time constants
        function m_inf(V) { return alpha_m(V) / (alpha_m(V) + beta_m(V)); }
        function h_inf(V) { return alpha_h(V) / (alpha_h(V) + beta_h(V)); }
        function n_inf(V) { return alpha_n(V) / (alpha_n(V) + beta_n(V)); }

        function initSimulation() {
            resizeCanvas();
            V = -65;
            m = m_inf(V);
            h = h_inf(V);
            n = n_inf(V);
            stimulusActive = false;
            stimulusTimer = 0;
            voltageHistory = [];
            iNaHistory = [];
            iKHistory = [];
            time = 0;
        }

        function applyStimulus() {
            const params = getParams();
            stimulusActive = true;
            stimulusTimer = params.stimDuration;
        }

        function update() {
            const params = getParams();
            const dt = 0.025; // Time step in ms

            // Stimulus current
            let I_stim = 0;
            if (stimulusActive) {
                I_stim = params.stimCurrent;
                stimulusTimer -= dt;
                if (stimulusTimer <= 0) {
                    stimulusActive = false;
                }
            }

            // Calculate conductances
            const g_Na = params.gNaMax * Math.pow(m, 3) * h;
            const g_K = params.gKMax * Math.pow(n, 4);

            // Calculate currents
            const I_Na = g_Na * (V - E_Na);
            const I_K = g_K * (V - E_K);
            const I_L = g_L * (V - E_L);

            // Update voltage
            const dV = (I_stim - I_Na - I_K - I_L) / C_m * dt;
            V += dV;

            // Update gating variables
            m += (alpha_m(V) * (1 - m) - beta_m(V) * m) * dt;
            h += (alpha_h(V) * (1 - h) - beta_h(V) * h) * dt;
            n += (alpha_n(V) * (1 - n) - beta_n(V) * n) * dt;

            // Clamp values
            m = Math.max(0, Math.min(1, m));
            h = Math.max(0, Math.min(1, h));
            n = Math.max(0, Math.min(1, n));

            // Store history
            voltageHistory.push(V);
            iNaHistory.push(-I_Na); // Inward current shown as positive
            iKHistory.push(-I_K);
            if (voltageHistory.length > maxHistory) {
                voltageHistory.shift();
                iNaHistory.shift();
                iKHistory.shift();
            }

            time += dt;

            updateStats(I_Na, I_K, I_L, g_Na, g_K);
        }

        function updateStats(I_Na, I_K, I_L, g_Na, g_K) {
            // Voltage with color coding
            const vmSpan = document.getElementById('vmValue');
            vmSpan.textContent = V.toFixed(1);
            if (V > 0) {
                vmSpan.style.color = '#ff4444';
            } else if (V > -50) {
                vmSpan.style.color = '#ffaa00';
            } else {
                vmSpan.style.color = '#00ff88';
            }

            // Phase determination
            let phase = 'Resting';
            if (stimulusActive) {
                phase = 'Stimulus';
            } else if (V > 0) {
                phase = 'Peak';
            } else if (V > -55 && m > 0.3) {
                phase = 'Depolarizing';
            } else if (V < -70) {
                phase = 'Hyperpolarization';
            } else if (h < 0.2) {
                phase = 'Refractory';
            } else if (V < -60 && V > -70 && n > 0.4) {
                phase = 'Repolarizing';
            }
            document.getElementById('phaseDisplay').textContent = phase;

            document.getElementById('mVal').textContent = m.toFixed(3);
            document.getElementById('hVal').textContent = h.toFixed(3);
            document.getElementById('nVal').textContent = n.toFixed(3);

            document.getElementById('iNaVal').textContent = I_Na.toFixed(2) + ' ¬µA/cm¬≤';
            document.getElementById('iKVal').textContent = I_K.toFixed(2) + ' ¬µA/cm¬≤';
            document.getElementById('iLVal').textContent = I_L.toFixed(2) + ' ¬µA/cm¬≤';

            document.getElementById('gNaVal').textContent = g_Na.toFixed(2) + ' mS/cm¬≤';
            document.getElementById('gKVal2').textContent = g_K.toFixed(2) + ' mS/cm¬≤';
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const padding = 50;
            const graphHeight = (canvas.height - padding * 3) / 2;
            const graphWidth = canvas.width - padding * 2;

            // Draw voltage trace (top graph)
            drawGraph(
                padding, padding,
                graphWidth, graphHeight,
                'Membrane Potential (mV)',
                voltageHistory,
                '#00ff88',
                -100, 60
            );

            // Draw reference lines for voltage
            ctx.strokeStyle = '#444';
            ctx.setLineDash([5, 5]);
            ctx.lineWidth = 1;

            // Resting potential line
            const restingY = padding + graphHeight - ((-65 + 100) / 160) * graphHeight;
            ctx.beginPath();
            ctx.moveTo(padding, restingY);
            ctx.lineTo(padding + graphWidth, restingY);
            ctx.stroke();

            // Threshold line
            const threshY = padding + graphHeight - ((-55 + 100) / 160) * graphHeight;
            ctx.beginPath();
            ctx.moveTo(padding, threshY);
            ctx.lineTo(padding + graphWidth, threshY);
            ctx.stroke();
            ctx.setLineDash([]);

            ctx.fillStyle = '#666';
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('-65 mV (rest)', padding + graphWidth + 5, restingY + 3);
            ctx.fillText('-55 mV (threshold)', padding + graphWidth + 5, threshY + 3);

            // Draw current traces (bottom graph)
            const graph2Y = padding * 2 + graphHeight;

            // Background
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.fillRect(padding, graph2Y, graphWidth, graphHeight);

            // I_Na trace
            ctx.beginPath();
            ctx.strokeStyle = '#ff6644';
            ctx.lineWidth = 2;
            for (let i = 0; i < iNaHistory.length; i++) {
                const x = padding + (i / maxHistory) * graphWidth;
                const normalized = Math.max(-1, Math.min(1, iNaHistory[i] / 500));
                const y = graph2Y + graphHeight / 2 - normalized * (graphHeight / 2 - 10);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            // I_K trace
            ctx.beginPath();
            ctx.strokeStyle = '#44aaff';
            ctx.lineWidth = 2;
            for (let i = 0; i < iKHistory.length; i++) {
                const x = padding + (i / maxHistory) * graphWidth;
                const normalized = Math.max(-1, Math.min(1, iKHistory[i] / 500));
                const y = graph2Y + graphHeight / 2 - normalized * (graphHeight / 2 - 10);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            // Zero line
            ctx.strokeStyle = '#444';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, graph2Y + graphHeight / 2);
            ctx.lineTo(padding + graphWidth, graph2Y + graphHeight / 2);
            ctx.stroke();

            // Labels
            ctx.fillStyle = '#888';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Ionic Currents (¬µA/cm¬≤)', padding + graphWidth / 2, graph2Y - 5);

            ctx.fillStyle = '#ff6644';
            ctx.textAlign = 'left';
            ctx.fillText('I_Na (inward)', padding + 5, graph2Y + 15);
            ctx.fillStyle = '#44aaff';
            ctx.fillText('I_K (outward)', padding + 100, graph2Y + 15);

            // Stimulus indicator
            if (stimulusActive) {
                ctx.fillStyle = 'rgba(255, 153, 0, 0.3)';
                ctx.fillRect(padding + graphWidth - 30, padding, 25, graphHeight);
                ctx.fillStyle = '#ff9900';
                ctx.font = 'bold 12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('STIM', padding + graphWidth - 17, padding + 20);
            }

            // Draw gating variable bars at bottom
            const barY = canvas.height - 30;
            const barWidth = graphWidth / 3 - 20;

            // m bar
            ctx.fillStyle = '#222';
            ctx.fillRect(padding, barY, barWidth, 15);
            ctx.fillStyle = '#ff6644';
            ctx.fillRect(padding, barY, barWidth * m, 15);
            ctx.fillStyle = '#fff';
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('m', padding + barWidth / 2, barY + 11);

            // h bar
            ctx.fillStyle = '#222';
            ctx.fillRect(padding + barWidth + 10, barY, barWidth, 15);
            ctx.fillStyle = '#ff9966';
            ctx.fillRect(padding + barWidth + 10, barY, barWidth * h, 15);
            ctx.fillStyle = '#fff';
            ctx.fillText('h', padding + barWidth * 1.5 + 10, barY + 11);

            // n bar
            ctx.fillStyle = '#222';
            ctx.fillRect(padding + barWidth * 2 + 20, barY, barWidth, 15);
            ctx.fillStyle = '#44aaff';
            ctx.fillRect(padding + barWidth * 2 + 20, barY, barWidth * n, 15);
            ctx.fillStyle = '#fff';
            ctx.fillText('n', padding + barWidth * 2.5 + 20, barY + 11);
        }

        function drawGraph(x, y, width, height, title, data, color, minVal, maxVal) {
            // Background
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.fillRect(x, y, width, height);

            // Axes
            ctx.strokeStyle = '#444';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(x, y + height);
            ctx.lineTo(x + width, y + height);
            ctx.moveTo(x, y);
            ctx.lineTo(x, y + height);
            ctx.stroke();

            // Title
            ctx.fillStyle = '#888';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(title, x + width / 2, y - 5);

            // Y-axis labels
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'right';
            ctx.fillText(maxVal.toString(), x - 5, y + 10);
            ctx.fillText(minVal.toString(), x - 5, y + height);

            if (data.length < 2) return;

            // Data trace
            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;

            for (let i = 0; i < data.length; i++) {
                const px = x + (i / maxHistory) * width;
                const normalized = (data[i] - minVal) / (maxVal - minVal);
                const py = y + height - normalized * height;

                if (i === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            }
            ctx.stroke();
        }

        function animate() {
            if (running) {
                // Run multiple update steps per frame for real-time feel
                for (let i = 0; i < 4; i++) {
                    update();
                }
            }
            draw();
            animationId = requestAnimationFrame(animate);
        }

        function toggleSimulation() {
            running = !running;
            document.getElementById('playPauseBtn').textContent = running ? 'Pause' : 'Play';
        }

        function resetSimulation() {
            initSimulation();
        }

        function showExplanation() {
            document.getElementById('explanationModal').classList.add('active');
        }

        function closeExplanation() {
            document.getElementById('explanationModal').classList.remove('active');
        }

        window.addEventListener('resize', resizeCanvas);
        document.getElementById('explanationModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('explanationModal')) {
                closeExplanation();
            }
        });

        initSimulation();
        animate();
    

    // Modal functionality
    const modal = document.getElementById('explainModal');
    if (modal) {
        document.getElementById('explainBtn').addEventListener('click', () => {
            modal.classList.add('active');
        });
        modal.querySelector('.modal-close').addEventListener('click', () => {
            modal.classList.remove('active');
        });
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.classList.remove('active');
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal.classList.contains('active')) {
                modal.classList.remove('active');
            }
        });
    }

    </script>

    <div id="explainModal" class="modal-overlay">
        <div class="modal">
            <button class="modal-close">&times;</button>
            <h2>üìä Action Potential</h2>
            <div class="modal-body">
                <p>This agent-based simulation explores concepts from <strong>molecular mechanisms and biochemical pathways</strong>.</p>

                <h3>What This Simulation Models</h3>
                <p>Create a Hodgkin-Huxley style action potential model with sodium and potassium currents.</p>

                <h3>Key Concepts</h3>
                <ul>
                    <li><strong>Agent-Based Modeling:</strong> Individual agents follow simple rules, producing complex emergent behaviors</li>
                    <li><strong>Emergent Properties:</strong> System-level patterns arise from local interactions</li>
                    <li><strong>Parameter Exploration:</strong> Adjust controls to explore different scenarios and outcomes</li>
                </ul>

                <h3>How to Explore</h3>
                <ul>
                    <li>Use the sliders to modify simulation parameters</li>
                    <li>Observe how changes affect the overall system behavior</li>
                    <li>Look for phase transitions and tipping points</li>
                    <li>Consider what real-world phenomena this model might represent</li>
                </ul>

                <h3>Category: Biochemistry & Molecular Biology</h3>
                <p>This simulation is part of the <em>Biochemistry & Molecular Biology</em> collection, which explores various aspects of molecular mechanisms and biochemical pathways.</p>
            </div>
        </div>
    </div>

</body>
</html>
