<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cryptic Genetic Variation - CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a2e; color: #e8e6e1; overflow: hidden; }
        #container { display: flex; height: 100vh; }
        #main-area { flex: 1; display: flex; flex-direction: column; padding: 20px; gap: 15px; }
        canvas { background: rgba(0,0,0,0.3); border-radius: 8px; flex: 1; }
        #controls { width: 300px; background: rgba(0,0,0,0.8); padding: 20px; overflow-y: auto; }
        h1 { font-size: 1.2rem; margin-bottom: 10px; color: #8b5cf6; }
        .description { font-size: 0.75rem; color: #888; margin-bottom: 15px; line-height: 1.4; }
        .control-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: #aaa; }
        input[type="range"] { width: 100%; margin-bottom: 5px; }
        .value-display { font-size: 0.75rem; color: #8b5cf6; }
        button { width: 100%; padding: 10px; margin-bottom: 10px; background: #8b5cf6; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: #7c3aed; }
        .stats { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; font-size: 0.8rem; margin-top: 15px; }
        .stats div { margin-bottom: 5px; }
        .stats span { color: #8b5cf6; }
        .back-link { position: fixed; top: 10px; left: 10px; padding: 8px 16px; background: rgba(0,0,0,0.7); color: #8b5cf6; text-decoration: none; border-radius: 6px; font-size: 14px; z-index: 999; }
        .theory { background: rgba(139,92,246,0.1); padding: 10px; border-radius: 5px; font-size: 0.7rem; margin-top: 15px; border-left: 3px solid #8b5cf6; }
        .env-indicator { padding: 8px; margin-top: 10px; border-radius: 5px; text-align: center; font-size: 0.9rem; }
    
        .explain-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            font-weight: 600;
        }
        .explain-btn:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            padding: 20px;
            overflow-y: auto;
        }
        .modal-overlay.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }
        .modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #252542 100%);
            border-radius: 20px;
            padding: 35px;
            max-width: 750px;
            width: 100%;
            margin: 40px auto;
            position: relative;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        .modal-close:hover {
            color: #fff;
            background: rgba(255,255,255,0.2);
        }
        .modal h2 {
            color: #00d9ff;
            margin-bottom: 25px;
            font-size: 1.6rem;
            padding-right: 50px;
            line-height: 1.3;
        }
        .modal-body {
            color: #d1d5db;
            line-height: 1.9;
            font-size: 1rem;
        }
        .modal-body h3 {
            color: #00ff88;
            margin: 28px 0 14px 0;
            font-size: 1.15rem;
            font-weight: 600;
        }
        .modal-body p {
            margin-bottom: 16px;
        }
        .modal-body ul {
            margin: 12px 0 18px 24px;
        }
        .modal-body li {
            margin-bottom: 10px;
        }
        .modal-body strong {
            color: #00d9ff;
        }
        .modal-body em {
            color: #a5b4fc;
            font-style: italic;
        }
        .modal-body code {
            background: rgba(0,0,0,0.3);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Fira Code', monospace;
            color: #fbbf24;
            font-size: 0.9em;
        }
        .modal-category {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <a href="../netlogo-simulations/index.html" class="back-link">‚Üê Back to Simulations</a>

    <div id="container">
        <div id="main-area">
            <canvas id="canvas"></canvas>
        </div>

        <div id="controls">
            <h1>üîÆ Cryptic Genetic Variation</h1>
            <p class="description">
                HSP90 acts as a "capacitor" buffering genetic variation.
                Under stress (heat, drugs), buffering fails and hidden variation
                is revealed. Selection can then act on previously cryptic alleles.
            </p>

            <div class="control-group">
                <label>Population Size: <span class="value-display" id="popValue">100</span></label>
                <input type="range" id="popSlider" min="50" max="300" value="100">
            </div>

            <div class="control-group">
                <label>HSP90 Buffering: <span class="value-display" id="bufferValue">0.9</span></label>
                <input type="range" id="bufferSlider" min="0" max="1" step="0.05" value="0.9">
            </div>

            <div class="control-group">
                <label>Mutation Rate: <span class="value-display" id="mutValue">0.05</span></label>
                <input type="range" id="mutSlider" min="0.01" max="0.2" step="0.01" value="0.05">
            </div>

            <div class="control-group">
                <label>Selection Strength: <span class="value-display" id="selValue">0.5</span></label>
                <input type="range" id="selSlider" min="0.1" max="1" step="0.1" value="0.5">
            </div>

            <div class="env-indicator" id="envIndicator" style="background: #22c55e;">
                Normal Conditions (HSP90 Active)
            </div>

            <button id="startBtn">Start Simulation</button>
            <button id="resetBtn">Reset</button>
                <button id="explainBtn" class="explain-btn">üìö Explain This Simulation</button>
            <button id="stressBtn">Apply Stress (Reduce HSP90)</button>
            <button id="releaseBtn">Remove Stress</button>

            <div class="stats">
                <div>Generation: <span id="generation">0</span></div>
                <div>Mean Fitness: <span id="meanFitness">1.00</span></div>
                <div>Cryptic Variation: <span id="crypticVar">0.00</span></div>
                <div>Expressed Variation: <span id="expressVar">0.00</span></div>
                <div>HSP90 Level: <span id="hsp90Level">90%</span></div>
            </div>

            <div class="theory">
                <strong>HSP90 as Capacitor:</strong> Rutherford & Lindquist (1998) showed that
                Hsp90 buffers morphological variation in Drosophila. When Hsp90 is compromised,
                cryptic variants are expressed, allowing selection to act on them.
                This may accelerate adaptation to new environments.
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            canvas.width = canvas.parentElement.clientWidth - 15;
            canvas.height = canvas.parentElement.clientHeight - 15;
        }
        resize();
        window.addEventListener('resize', resize);

        let running = false;
        let generation = 0;
        let population = [];
        let fitnessHistory = [];
        let crypticHistory = [];
        let expressedHistory = [];
        let stressed = false;

        let popSize = 100;
        let bufferStrength = 0.9;
        let mutRate = 0.05;
        let selStrength = 0.5;

        const NUM_LOCI = 20;

        class Individual {
            constructor(genotype = null) {
                // Each locus has a cryptic value that may or may not be expressed
                this.genotype = genotype || new Array(NUM_LOCI).fill(0).map(() => ({
                    value: (Math.random() - 0.5) * 2, // -1 to 1
                    cryptic: Math.random() < 0.7 // Most variation starts cryptic
                }));
            }

            get expressedPhenotype() {
                let sum = 0;
                let count = 0;
                for (const locus of this.genotype) {
                    // If stressed or locus not cryptic, express it
                    const expressed = !locus.cryptic || stressed && Math.random() > bufferStrength;
                    if (expressed || !locus.cryptic) {
                        sum += locus.value;
                        count++;
                    }
                }
                return count > 0 ? sum / count : 0;
            }

            get crypticVariation() {
                return this.genotype.filter(l => l.cryptic).reduce((s, l) => s + Math.abs(l.value), 0) / NUM_LOCI;
            }

            get expressedVariation() {
                let sum = 0;
                for (const locus of this.genotype) {
                    const expressed = !locus.cryptic || (stressed && Math.random() > bufferStrength);
                    if (expressed) sum += Math.abs(locus.value);
                }
                return sum / NUM_LOCI;
            }

            get fitness() {
                // Optimal phenotype is 0 (intermediate)
                const pheno = this.expressedPhenotype;
                return Math.exp(-Math.pow(pheno, 2) * selStrength * 3);
            }

            replicate() {
                const newGeno = this.genotype.map(locus => {
                    let newValue = locus.value;
                    let newCryptic = locus.cryptic;

                    // Mutation in value
                    if (Math.random() < mutRate) {
                        newValue += (Math.random() - 0.5) * 0.3;
                        newValue = Math.max(-1, Math.min(1, newValue));
                    }

                    // Occasionally a cryptic allele becomes expressed (or vice versa)
                    if (Math.random() < mutRate * 0.5) {
                        newCryptic = !newCryptic;
                    }

                    return { value: newValue, cryptic: newCryptic };
                });

                return new Individual(newGeno);
            }
        }

        function initPopulation() {
            population = [];
            fitnessHistory = [];
            crypticHistory = [];
            expressedHistory = [];
            stressed = false;

            for (let i = 0; i < popSize; i++) {
                population.push(new Individual());
            }
            updateEnvIndicator();
        }

        function updateEnvIndicator() {
            const indicator = document.getElementById('envIndicator');
            if (stressed) {
                indicator.style.background = '#ef4444';
                indicator.textContent = 'Stressed (HSP90 Reduced)';
            } else {
                indicator.style.background = '#22c55e';
                indicator.textContent = 'Normal Conditions (HSP90 Active)';
            }
            document.getElementById('hsp90Level').textContent =
                stressed ? `${Math.round(bufferStrength * 100)}% (stressed)` : '100%';
        }

        function reproduce() {
            const totalFit = population.reduce((sum, ind) => sum + ind.fitness, 0);
            const newPop = [];

            const selectParent = () => {
                let r = Math.random() * totalFit;
                for (const ind of population) {
                    r -= ind.fitness;
                    if (r <= 0) return ind;
                }
                return population[population.length - 1];
            };

            while (newPop.length < popSize) {
                const parent = selectParent();
                newPop.push(parent.replicate());
            }

            population = newPop;
        }

        function update() {
            if (!running) return;

            generation++;
            reproduce();

            const meanFit = population.reduce((sum, ind) => sum + ind.fitness, 0) / popSize;
            const crypticVar = population.reduce((sum, ind) => sum + ind.crypticVariation, 0) / popSize;
            const expressVar = population.reduce((sum, ind) => sum + ind.expressedVariation, 0) / popSize;

            fitnessHistory.push(meanFit);
            crypticHistory.push(crypticVar);
            expressedHistory.push(expressVar);

            if (fitnessHistory.length > 400) {
                fitnessHistory.shift();
                crypticHistory.shift();
                expressedHistory.shift();
            }

            render();
            updateStats();
            requestAnimationFrame(update);
        }

        function render() {
            ctx.fillStyle = 'rgba(26, 26, 46, 1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const padding = 50;
            const width = canvas.width - padding * 2;
            const height = (canvas.height - padding * 3) / 2;

            // Phenotype distribution
            ctx.fillStyle = '#888';
            ctx.font = '12px sans-serif';
            ctx.fillText('Phenotype Distribution (Cryptic vs Expressed)', padding, 25);

            const bins = 30;
            const histogram = new Array(bins).fill(0);
            for (const ind of population) {
                const pheno = (ind.expressedPhenotype + 1) / 2; // Normalize to 0-1
                const bin = Math.floor(pheno * (bins - 1));
                histogram[Math.max(0, Math.min(bins - 1, bin))]++;
            }
            const maxCount = Math.max(...histogram);

            const barWidth = width / bins;
            for (let i = 0; i < bins; i++) {
                const barHeight = (histogram[i] / maxCount) * (height - 20);
                const x = padding + i * barWidth;
                const y = padding + height - 20 - barHeight;

                ctx.fillStyle = stressed ? '#ef4444' : '#8b5cf6';
                ctx.fillRect(x, y, barWidth - 1, barHeight);
            }

            // Optimal line
            ctx.strokeStyle = '#22c55e';
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(padding + width / 2, padding);
            ctx.lineTo(padding + width / 2, padding + height - 20);
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.fillStyle = '#22c55e';
            ctx.fillText('Optimum', padding + width / 2 - 25, padding + 15);

            ctx.strokeStyle = '#444';
            ctx.beginPath();
            ctx.moveTo(padding, padding + height - 20);
            ctx.lineTo(padding + width, padding + height - 20);
            ctx.stroke();

            // Variation over time
            const chartY = padding * 2 + height;
            ctx.fillStyle = '#888';
            ctx.fillText('Cryptic vs Expressed Variation Over Time', padding, chartY - 10);

            ctx.strokeStyle = '#444';
            ctx.beginPath();
            ctx.moveTo(padding, chartY);
            ctx.lineTo(padding, chartY + height);
            ctx.lineTo(padding + width, chartY + height);
            ctx.stroke();

            if (crypticHistory.length > 1) {
                const maxVar = Math.max(...crypticHistory, ...expressedHistory) * 1.2 || 0.5;

                // Cryptic variation
                ctx.strokeStyle = '#8b5cf6';
                ctx.lineWidth = 2;
                ctx.beginPath();
                for (let i = 0; i < crypticHistory.length; i++) {
                    const x = padding + (i / crypticHistory.length) * width;
                    const y = chartY + height - (crypticHistory[i] / maxVar) * height;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();

                // Expressed variation
                ctx.strokeStyle = '#ef4444';
                ctx.lineWidth = 2;
                ctx.beginPath();
                for (let i = 0; i < expressedHistory.length; i++) {
                    const x = padding + (i / expressedHistory.length) * width;
                    const y = chartY + height - (expressedHistory[i] / maxVar) * height;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();

                // Fitness
                ctx.strokeStyle = '#22c55e';
                ctx.lineWidth = 1;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                for (let i = 0; i < fitnessHistory.length; i++) {
                    const x = padding + (i / fitnessHistory.length) * width;
                    const y = chartY + height - fitnessHistory[i] * height;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
                ctx.setLineDash([]);
            }

            // Legend
            ctx.fillStyle = '#8b5cf6';
            ctx.fillRect(padding + width - 130, chartY + 10, 15, 10);
            ctx.fillStyle = '#888';
            ctx.fillText('Cryptic', padding + width - 110, chartY + 18);
            ctx.fillStyle = '#ef4444';
            ctx.fillRect(padding + width - 130, chartY + 25, 15, 10);
            ctx.fillStyle = '#888';
            ctx.fillText('Expressed', padding + width - 110, chartY + 33);
            ctx.fillStyle = '#22c55e';
            ctx.fillRect(padding + width - 130, chartY + 40, 15, 10);
            ctx.fillStyle = '#888';
            ctx.fillText('Fitness', padding + width - 110, chartY + 48);
        }

        function updateStats() {
            const meanFit = population.reduce((sum, ind) => sum + ind.fitness, 0) / popSize;
            const crypticVar = population.reduce((sum, ind) => sum + ind.crypticVariation, 0) / popSize;
            const expressVar = population.reduce((sum, ind) => sum + ind.expressedVariation, 0) / popSize;

            document.getElementById('generation').textContent = generation;
            document.getElementById('meanFitness').textContent = meanFit.toFixed(4);
            document.getElementById('crypticVar').textContent = crypticVar.toFixed(4);
            document.getElementById('expressVar').textContent = expressVar.toFixed(4);
        }

        document.getElementById('popSlider').addEventListener('input', (e) => {
            popSize = parseInt(e.target.value);
            document.getElementById('popValue').textContent = popSize;
        });

        document.getElementById('bufferSlider').addEventListener('input', (e) => {
            bufferStrength = parseFloat(e.target.value);
            document.getElementById('bufferValue').textContent = bufferStrength.toFixed(2);
        });

        document.getElementById('mutSlider').addEventListener('input', (e) => {
            mutRate = parseFloat(e.target.value);
            document.getElementById('mutValue').textContent = mutRate.toFixed(2);
        });

        document.getElementById('selSlider').addEventListener('input', (e) => {
            selStrength = parseFloat(e.target.value);
            document.getElementById('selValue').textContent = selStrength.toFixed(1);
        });

        document.getElementById('startBtn').addEventListener('click', () => {
            running = !running;
            document.getElementById('startBtn').textContent = running ? 'Pause' : 'Start Simulation';
            if (running) update();
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            running = false;
            generation = 0;
            document.getElementById('startBtn').textContent = 'Start Simulation';
            initPopulation();
            render();
            updateStats();
        });

        document.getElementById('stressBtn').addEventListener('click', () => {
            stressed = true;
            updateEnvIndicator();
        });

        document.getElementById('releaseBtn').addEventListener('click', () => {
            stressed = false;
            updateEnvIndicator();
        });

        initPopulation();
        render();
        updateStats();
    </script>


    <div id="explainModal" class="modal-overlay">
        <div class="modal">
            <button class="modal-close">&times;</button>
            <h2>üìä Cryptic Genetic Variation</h2>
            <div class="modal-body">
                <p>Evolution occurs through changes in allele frequencies over generations. This simulation demonstrates key evolutionary mechanisms including natural selection, genetic drift, and mutation.</p>

                <h3>About This Simulation</h3>
                <p>Develop a model where hidden genetic variation is released under novel conditions.</p>

                <h3>Key Concepts</h3>
                <ul>
                    <li><strong>Fitness Landscapes:</strong> Populations navigate through "fitness landscapes" - conceptual maps where height represents reproductive success. Rugged landscapes have multiple peaks separated by valleys of lower fitness.</li>
                    <li><strong>Genetic Drift:</strong> Random changes in allele frequencies, especially important in small populations. Can cause alleles to become fixed or lost regardless of their fitness effects.</li>
                    <li><strong>Natural Selection:</strong> Differential survival and reproduction based on heritable traits. Drives adaptation but can be overwhelmed by drift in small populations.</li>
                    <li><strong>Epistasis:</strong> Gene interactions where the effect of one gene depends on others. Creates rugged fitness landscapes with multiple local optima.</li>
                </ul>

                <h3>Why It Matters</h3>
                <p>Understanding evolutionary dynamics is crucial for conservation biology, disease evolution, antibiotic resistance, and breeding programs.</p>

                <h3>How to Explore</h3>
                <ul>
                    <li>Adjust the sliders to modify simulation parameters and observe how the system responds</li>
                    <li>Look for emergent patterns that arise from agent interactions</li>
                    <li>Try extreme parameter values to find phase transitions and tipping points</li>
                    <li>Compare the simulation behavior to real-world phenomena</li>
                </ul>

                <p class="modal-category"><em>Category: Evolutionary Dynamics ‚Äî Exploring evolutionary biology and population genetics</em></p>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('explainModal');
        const explainBtn = document.getElementById('explainBtn');
        if (modal && explainBtn) {
            explainBtn.addEventListener('click', function() {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            });
            modal.querySelector('.modal-close').addEventListener('click', function() {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            });
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.classList.contains('active')) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
        }
    });
    </script>

    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
