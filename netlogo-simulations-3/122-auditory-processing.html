<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditory Processing | NetLogo-Style Simulation</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            color: #e0e0e0;
        }
        h1 { font-size: 1.6rem; margin-bottom: 10px; color: #66aaff; text-shadow: 0 0 15px rgba(102, 170, 255, 0.5); }
        .simulation-container { display: flex; gap: 20px; max-width: 1200px; width: 100%; flex-wrap: wrap; justify-content: center; }
        .canvas-panel { background: rgba(20, 20, 40, 0.9); border-radius: 15px; padding: 15px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); border: 1px solid rgba(102, 170, 255, 0.2); }
        canvas { border-radius: 10px; display: block; background: #000; }
        .control-panel { background: rgba(20, 20, 40, 0.95); border-radius: 15px; padding: 20px; min-width: 280px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); border: 1px solid rgba(102, 170, 255, 0.2); }
        .control-group { margin-bottom: 18px; }
        .control-group label { display: block; margin-bottom: 6px; color: #66aaff; font-weight: 500; font-size: 0.9rem; }
        .slider-container { display: flex; align-items: center; gap: 10px; }
        input[type="range"] { flex: 1; height: 6px; border-radius: 3px; background: linear-gradient(to right, #66aaff, #4488dd); outline: none; -webkit-appearance: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #66aaff; cursor: pointer; }
        .button-group { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        button { flex: 1; padding: 10px 15px; border: none; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; min-width: 80px; }
        .start-btn { background: linear-gradient(135deg, #66aaff 0%, #4488dd 100%); color: white; }
        .reset-btn { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%); color: white; }
        .stats-panel { background: rgba(0, 0, 0, 0.3); border-radius: 10px; padding: 15px; margin-top: 15px; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.85rem; }
        .stat-label { color: #aaa; }
        .stat-value { color: #66aaff; font-weight: bold; }
        .theory-box { background: rgba(102, 170, 255, 0.1); border-left: 3px solid #66aaff; padding: 12px; margin-top: 15px; border-radius: 0 8px 8px 0; font-size: 0.8rem; line-height: 1.5; }
        .back-link { position: fixed; top: 15px; left: 15px; color: #66aaff; text-decoration: none; font-size: 0.9rem; opacity: 0.8; }
    
        .explain-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
        }
        .explain-btn:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            transform: translateY(-2px);
        }
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
        }
        .modal {
            background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%);
            border-radius: 16px;
            padding: 30px;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: #888;
            font-size: 28px;
            cursor: pointer;
            width: auto;
            padding: 0;
            margin: 0;
        }
        .modal-close:hover {
            color: #fff;
            background: none;
        }
        .modal h2 {
            color: #00d9ff;
            margin-bottom: 20px;
            font-size: 1.5rem;
            padding-right: 40px;
        }
        .modal-body {
            color: #ccc;
            line-height: 1.8;
            font-size: 0.95rem;
        }
        .modal-body h3 {
            color: #00ff88;
            margin: 20px 0 10px 0;
            font-size: 1.1rem;
        }
        .modal-body p {
            margin-bottom: 15px;
        }
        .modal-body ul {
            margin: 10px 0 15px 20px;
        }
        .modal-body li {
            margin-bottom: 8px;
        }
        .modal-body strong {
            color: #00d9ff;
        }
        .modal-body em {
            color: #a5b4fc;
            font-style: normal;
        }
        .modal-body code {
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            color: #fbbf24;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Gallery</a>
    <h1>üëÇ Auditory Processing Simulation</h1>

    <div class="simulation-container">
        <div class="canvas-panel">
            <canvas id="simCanvas" width="550" height="550"></canvas>
        </div>

        <div class="control-panel">
            <div class="button-group">
                <button class="start-btn" id="startBtn">Start</button>
                <button class="reset-btn" id="resetBtn">Reset</button>
            </div>

            <div class="control-group">
                <label>Sound Frequency: <span id="freqVal">1000 Hz</span></label>
                <div class="slider-container">
                    <input type="range" id="freq" min="100" max="8000" value="1000">
                </div>
            </div>

            <div class="control-group">
                <label>Sound Volume: <span id="volumeVal">70 dB</span></label>
                <div class="slider-container">
                    <input type="range" id="volume" min="20" max="120" value="70">
                </div>
            </div>

            <div class="control-group">
                <label>Sound Direction: <span id="directionVal">0¬∞</span></label>
                <div class="slider-container">
                    <input type="range" id="direction" min="-90" max="90" value="0">
                </div>
            </div>

            <div class="stats-panel">
                <div class="stat-row">
                    <span class="stat-label">Cycle:</span>
                    <span class="stat-value" id="generation">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Basilar Peak:</span>
                    <span class="stat-value" id="basilarPeak">Center</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">ITD:</span>
                    <span class="stat-value" id="itd">0 Œºs</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">ILD:</span>
                    <span class="stat-value" id="ild">0 dB</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Perceived Location:</span>
                    <span class="stat-value" id="location">Center</span>
                </div>
            </div>

            <div class="theory-box">
                <strong>Auditory Pathway:</strong><br>
                Sound waves cause basilar membrane displacement (tonotopy). Hair cells transduce
                vibrations. Cochlear nucleus processes timing (ITD) and level (ILD) differences
                for sound localization. Auditory cortex creates spatial maps.
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');

        let running = false;
        let generation = 0;
        let animationId = null;
        let time = 0;

        let params = {
            frequency: 1000,
            volume: 70,
            direction: 0
        };

        // Cochlea - basilar membrane sections
        const NUM_SECTIONS = 50;
        let basilarMembrane = [];

        // Hair cells
        let hairCells = [];

        // Neural responses
        let leftEar = { signal: 0, timing: 0 };
        let rightEar = { signal: 0, timing: 0 };

        // Brain regions
        let brainActivity = {
            cochlearNucleus: 0,
            superiorOlive: 0,
            inferiorColliculus: 0,
            auditoryCortex: 0
        };

        function init() {
            generation = 0;
            time = 0;

            // Initialize basilar membrane (high freq at base, low at apex)
            basilarMembrane = [];
            for (let i = 0; i < NUM_SECTIONS; i++) {
                const charFreq = 20000 * Math.pow(10, -i / NUM_SECTIONS * 3); // 20kHz to 20Hz
                basilarMembrane.push({
                    position: i,
                    charFreq: charFreq,
                    displacement: 0
                });
            }

            // Initialize hair cells
            hairCells = [];
            for (let i = 0; i < NUM_SECTIONS; i++) {
                hairCells.push({
                    position: i,
                    innerHair: { deflection: 0, firing: 0 },
                    outerHair: [
                        { deflection: 0, amplification: 1 },
                        { deflection: 0, amplification: 1 },
                        { deflection: 0, amplification: 1 }
                    ]
                });
            }

            leftEar = { signal: 0, timing: 0 };
            rightEar = { signal: 0, timing: 0 };

            for (const key in brainActivity) brainActivity[key] = 0;

            updateUI();
            draw();
        }

        function update() {
            generation++;
            time += 0.02;

            // Calculate interaural differences based on direction
            const dirRad = params.direction * Math.PI / 180;
            const headRadius = 0.085; // ~8.5cm head radius
            const speedOfSound = 343; // m/s

            // Interaural Time Difference (ITD) - path difference
            const pathDiff = headRadius * (Math.sin(dirRad) + dirRad);
            const itd = pathDiff / speedOfSound * 1000000; // in microseconds

            // Interaural Level Difference (ILD) - head shadow
            const ild = Math.sin(dirRad) * 10 * (params.frequency / 4000); // More ILD at higher freq

            // Update ear signals
            const baseSignal = Math.pow(10, (params.volume - 60) / 20);
            leftEar.signal = baseSignal * (1 + Math.sin(dirRad) * 0.5);
            rightEar.signal = baseSignal * (1 - Math.sin(dirRad) * 0.5);

            leftEar.timing = -itd / 2;
            rightEar.timing = itd / 2;

            // Update basilar membrane
            updateBasilarMembrane();

            // Update hair cells
            updateHairCells();

            // Update brain activity
            updateBrain(itd, ild);

            updateUI();
        }

        function updateBasilarMembrane() {
            const inputFreq = params.frequency;
            const amplitude = Math.pow(10, (params.volume - 60) / 20) * 0.5;

            for (let i = 0; i < NUM_SECTIONS; i++) {
                const section = basilarMembrane[i];
                const freqRatio = inputFreq / section.charFreq;

                // Resonance - peaks when input matches characteristic frequency
                const tuning = Math.exp(-Math.pow(Math.log10(freqRatio), 2) * 5);
                const targetDisp = amplitude * tuning * Math.sin(time * inputFreq * 0.01);

                // Add traveling wave delay
                const delay = i * 0.02;
                const delayedDisp = amplitude * tuning * Math.sin((time - delay) * inputFreq * 0.01);

                section.displacement += (delayedDisp - section.displacement) * 0.3;
            }
        }

        function updateHairCells() {
            for (let i = 0; i < NUM_SECTIONS; i++) {
                const cell = hairCells[i];
                const displacement = basilarMembrane[i].displacement;

                // Inner hair cells - transduce displacement
                cell.innerHair.deflection = displacement;
                cell.innerHair.firing = Math.max(0, displacement) * 2;

                // Outer hair cells - amplification
                for (const ohc of cell.outerHair) {
                    ohc.deflection = displacement * 0.5;
                    ohc.amplification = 1 + Math.abs(displacement) * 0.5;
                }
            }
        }

        function updateBrain(itd, ild) {
            // Cochlear nucleus - receives from hair cells
            let cnInput = 0;
            for (const cell of hairCells) {
                cnInput += cell.innerHair.firing;
            }
            cnInput /= hairCells.length;
            brainActivity.cochlearNucleus += (cnInput - brainActivity.cochlearNucleus) * 0.2;

            // Superior olive - ITD and ILD processing
            const itdNorm = Math.abs(itd) / 700; // Max ~700Œºs for 90¬∞ azimuth
            const ildNorm = Math.abs(ild) / 20;
            brainActivity.superiorOlive += ((itdNorm + ildNorm) * 0.5 - brainActivity.superiorOlive) * 0.15;

            // Inferior colliculus - integration
            brainActivity.inferiorColliculus += (
                (brainActivity.cochlearNucleus + brainActivity.superiorOlive) * 0.5 -
                brainActivity.inferiorColliculus
            ) * 0.12;

            // Auditory cortex - final processing
            brainActivity.auditoryCortex += (
                brainActivity.inferiorColliculus * 0.8 - brainActivity.auditoryCortex
            ) * 0.1;
        }

        function draw() {
            ctx.fillStyle = '#0a0a1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            drawEars();
            drawCochlea();
            drawBrainPathway();
            drawSoundSource();
            drawSpectrogram();
        }

        function drawEars() {
            // Left ear
            ctx.beginPath();
            ctx.ellipse(80, 250, 25, 40, 0, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(200, 180, 160, ${0.3 + leftEar.signal * 0.3})`;
            ctx.fill();
            ctx.strokeStyle = '#aa9988';
            ctx.lineWidth = 2;
            ctx.stroke();

            // Right ear
            ctx.beginPath();
            ctx.ellipse(470, 250, 25, 40, 0, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(200, 180, 160, ${0.3 + rightEar.signal * 0.3})`;
            ctx.fill();
            ctx.stroke();

            // Labels
            ctx.fillStyle = '#888';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Left', 80, 300);
            ctx.fillText('Right', 470, 300);
        }

        function drawCochlea() {
            // Unrolled cochlea visualization
            const cx = 275, cy = 420;
            const width = 400, height = 60;

            // Background
            ctx.fillStyle = 'rgba(100, 100, 150, 0.3)';
            ctx.fillRect(cx - width/2, cy - height/2, width, height);

            // Basilar membrane
            ctx.beginPath();
            ctx.moveTo(cx - width/2, cy);
            for (let i = 0; i < NUM_SECTIONS; i++) {
                const x = cx - width/2 + (i / NUM_SECTIONS) * width;
                const y = cy + basilarMembrane[i].displacement * 20;
                ctx.lineTo(x, y);
            }
            ctx.strokeStyle = '#66aaff';
            ctx.lineWidth = 3;
            ctx.stroke();

            // Hair cells
            for (let i = 0; i < NUM_SECTIONS; i += 2) {
                const x = cx - width/2 + (i / NUM_SECTIONS) * width;
                const cell = hairCells[i];
                const firing = cell.innerHair.firing;

                ctx.beginPath();
                ctx.arc(x, cy - 20, 3 + firing * 3, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 200, 100, ${0.3 + firing * 0.7})`;
                ctx.fill();
            }

            // Frequency labels
            ctx.fillStyle = '#888';
            ctx.font = '9px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('20kHz (Base)', cx - width/2 + 30, cy + 45);
            ctx.fillText('20Hz (Apex)', cx + width/2 - 30, cy + 45);
            ctx.fillText('Basilar Membrane / Hair Cells', cx, cy + 55);
        }

        function drawBrainPathway() {
            const regions = [
                { name: 'Cochlear\nNucleus', x: 200, y: 320, key: 'cochlearNucleus' },
                { name: 'Superior\nOlive', x: 275, y: 250, key: 'superiorOlive' },
                { name: 'Inferior\nColliculus', x: 275, y: 170, key: 'inferiorColliculus' },
                { name: 'Auditory\nCortex', x: 275, y: 80, key: 'auditoryCortex' }
            ];

            // Draw connections
            ctx.strokeStyle = 'rgba(102, 170, 255, 0.3)';
            ctx.lineWidth = 2;
            for (let i = 0; i < regions.length - 1; i++) {
                ctx.beginPath();
                ctx.moveTo(regions[i].x, regions[i].y - 15);
                ctx.lineTo(regions[i + 1].x, regions[i + 1].y + 15);
                ctx.stroke();
            }

            // Draw regions
            for (const region of regions) {
                const activity = brainActivity[region.key];
                const size = 25 + activity * 10;

                ctx.beginPath();
                ctx.arc(region.x, region.y, size, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(102, 170, 255, ${0.3 + activity * 0.7})`;
                ctx.fill();
                ctx.strokeStyle = '#4488cc';
                ctx.lineWidth = 2;
                ctx.stroke();

                ctx.fillStyle = '#aaa';
                ctx.font = '9px Arial';
                ctx.textAlign = 'center';
                const lines = region.name.split('\n');
                lines.forEach((line, i) => {
                    ctx.fillText(line, region.x, region.y + size + 12 + i * 11);
                });
            }

            // Bilateral pathway (right side)
            ctx.beginPath();
            ctx.arc(350, 320, 20 + brainActivity.cochlearNucleus * 8, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(102, 170, 255, ${0.3 + brainActivity.cochlearNucleus * 0.5})`;
            ctx.fill();
        }

        function drawSoundSource() {
            const dirRad = params.direction * Math.PI / 180;
            const cx = 275, cy = 250;
            const r = 100;

            // Direction arc
            ctx.beginPath();
            ctx.arc(cx, cy, r, Math.PI, 0);
            ctx.strokeStyle = '#444';
            ctx.lineWidth = 2;
            ctx.stroke();

            // Sound source position
            const sx = cx + Math.sin(dirRad) * r;
            const sy = cy - Math.cos(dirRad) * Math.abs(Math.cos(dirRad)) * 50;

            // Sound waves
            const wavePhase = time * 5;
            for (let i = 0; i < 3; i++) {
                const waveR = ((wavePhase + i * 20) % 60);
                ctx.beginPath();
                ctx.arc(sx, sy, waveR, 0, Math.PI * 2);
                ctx.strokeStyle = `rgba(102, 170, 255, ${0.5 - waveR / 120})`;
                ctx.lineWidth = 2;
                ctx.stroke();
            }

            // Source
            ctx.beginPath();
            ctx.arc(sx, sy, 10, 0, Math.PI * 2);
            ctx.fillStyle = '#66aaff';
            ctx.fill();

            ctx.fillStyle = '#888';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('üîä', sx, sy + 5);
        }

        function drawSpectrogram() {
            const x = 40, y = 100, w = 80, h = 100;

            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(x, y, w, h);

            // Find peak in basilar membrane
            let peakIdx = 0;
            let peakVal = 0;
            for (let i = 0; i < NUM_SECTIONS; i++) {
                if (Math.abs(basilarMembrane[i].displacement) > peakVal) {
                    peakVal = Math.abs(basilarMembrane[i].displacement);
                    peakIdx = i;
                }
            }

            // Draw frequency bars
            for (let i = 0; i < NUM_SECTIONS; i += 2) {
                const barH = Math.abs(basilarMembrane[i].displacement) * 50;
                const by = y + h - (i / NUM_SECTIONS) * h;
                ctx.fillStyle = `rgba(102, 170, 255, ${0.3 + Math.abs(basilarMembrane[i].displacement)})`;
                ctx.fillRect(x + 10, by - 1, barH, 2);
            }

            ctx.fillStyle = '#888';
            ctx.font = '9px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Spectrum', x + w/2, y + h + 15);
        }

        function updateUI() {
            document.getElementById('generation').textContent = generation;

            // Find peak frequency
            let peakIdx = 0;
            let peakVal = 0;
            for (let i = 0; i < NUM_SECTIONS; i++) {
                if (Math.abs(basilarMembrane[i].displacement) > peakVal) {
                    peakVal = Math.abs(basilarMembrane[i].displacement);
                    peakIdx = i;
                }
            }
            const peakPos = peakIdx < NUM_SECTIONS / 3 ? 'Base' :
                           peakIdx < 2 * NUM_SECTIONS / 3 ? 'Middle' : 'Apex';
            document.getElementById('basilarPeak').textContent = peakPos;

            // ITD calculation
            const dirRad = params.direction * Math.PI / 180;
            const itd = Math.round(Math.sin(dirRad) * 700);
            document.getElementById('itd').textContent = itd + ' Œºs';

            // ILD
            const ild = (Math.sin(dirRad) * 10 * (params.frequency / 4000)).toFixed(1);
            document.getElementById('ild').textContent = ild + ' dB';

            // Perceived location
            let location;
            if (Math.abs(params.direction) < 10) location = 'Center';
            else if (params.direction < -45) location = 'Far Left';
            else if (params.direction < 0) location = 'Left';
            else if (params.direction > 45) location = 'Far Right';
            else location = 'Right';
            document.getElementById('location').textContent = location;
        }

        function animate() {
            if (!running) return;
            update();
            draw();
            animationId = requestAnimationFrame(animate);
        }

        document.getElementById('startBtn').addEventListener('click', () => {
            running = !running;
            document.getElementById('startBtn').textContent = running ? 'Pause' : 'Start';
            if (running) animate();
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            running = false;
            document.getElementById('startBtn').textContent = 'Start';
            if (animationId) cancelAnimationFrame(animationId);
            init();
        });

        document.getElementById('freq').addEventListener('input', (e) => {
            params.frequency = parseInt(e.target.value);
            document.getElementById('freqVal').textContent = params.frequency + ' Hz';
        });

        document.getElementById('volume').addEventListener('input', (e) => {
            params.volume = parseInt(e.target.value);
            document.getElementById('volumeVal').textContent = params.volume + ' dB';
        });

        document.getElementById('direction').addEventListener('input', (e) => {
            params.direction = parseInt(e.target.value);
            document.getElementById('directionVal').textContent = params.direction + '¬∞';
        });

        init();
    

    // Modal functionality
    const modal = document.getElementById('explainModal');
    if (modal) {
        document.getElementById('explainBtn').addEventListener('click', () => {
            modal.classList.add('active');
        });
        modal.querySelector('.modal-close').addEventListener('click', () => {
            modal.classList.remove('active');
        });
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.classList.remove('active');
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal.classList.contains('active')) {
                modal.classList.remove('active');
            }
        });
    }

    </script>

    <div id="explainModal" class="modal-overlay">
        <div class="modal">
            <button class="modal-close">&times;</button>
            <h2>üìä Aggression Circuits</h2>
            <div class="modal-body">
                <p>This agent-based simulation explores concepts from <strong>neural systems and behavioral patterns</strong>.</p>

                <h3>What This Simulation Models</h3>
                <p>Build a neural aggression model with threat assessment and attack initiation.</p>

                <h3>Key Concepts</h3>
                <ul>
                    <li><strong>Agent-Based Modeling:</strong> Individual agents follow simple rules, producing complex emergent behaviors</li>
                    <li><strong>Emergent Properties:</strong> System-level patterns arise from local interactions</li>
                    <li><strong>Parameter Exploration:</strong> Adjust controls to explore different scenarios and outcomes</li>
                </ul>

                <h3>How to Explore</h3>
                <ul>
                    <li>Use the sliders to modify simulation parameters</li>
                    <li>Observe how changes affect the overall system behavior</li>
                    <li>Look for phase transitions and tipping points</li>
                    <li>Consider what real-world phenomena this model might represent</li>
                </ul>

                <h3>Category: Neuroscience & Behavior</h3>
                <p>This simulation is part of the <em>Neuroscience & Behavior</em> collection, which explores various aspects of neural systems and behavioral patterns.</p>
            </div>
        </div>
    </div>

</body>
</html>
