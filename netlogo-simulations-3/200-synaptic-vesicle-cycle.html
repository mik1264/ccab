<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synaptic Vesicle Cycle - NetLogo Simulations III</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header {
            background: rgba(0,0,0,0.3);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        h1 { color: #00d9ff; font-size: 1.5rem; }
        .back-link {
            color: #888;
            text-decoration: none;
            font-size: 0.9rem;
        }
        .back-link:hover { color: #00d9ff; }
        .main-container {
            display: flex;
            flex: 1;
            gap: 1rem;
            padding: 1rem;
            overflow: hidden;
        }
        .canvas-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        #simCanvas {
            flex: 1;
            background: #0a0a1a;
            border-radius: 8px;
            border: 1px solid #333;
        }
        .controls-panel {
            width: 320px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
        }
        .control-group { margin-bottom: 0.5rem; }
        .control-group label {
            display: block;
            margin-bottom: 0.3rem;
            color: #aaa;
            font-size: 0.85rem;
        }
        .control-group input[type="range"] {
            width: 100%;
            accent-color: #00d9ff;
        }
        .control-group .value {
            float: right;
            color: #00d9ff;
            font-weight: bold;
        }
        .btn {
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #00d9ff;
            color: #000;
        }
        .btn-primary:hover { background: #00b8d9; }
        .btn-secondary {
            background: #444;
            color: #fff;
        }
        .btn-secondary:hover { background: #555; }
        .btn-action {
            background: #ff9900;
            color: #000;
        }
        .btn-action:hover { background: #ffaa22; }
        .btn-row {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .stats-panel {
            background: rgba(0,100,150,0.2);
            border: 1px solid #00d9ff44;
            border-radius: 5px;
            padding: 0.8rem;
        }
        .stats-panel h3 {
            color: #00d9ff;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            margin: 0.2rem 0;
        }
        .stat-value { color: #00d9ff; font-weight: bold; }
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            font-size: 0.75rem;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: #1a1a2e;
            padding: 2rem;
            border-radius: 10px;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid #00d9ff44;
        }
        .modal-content h2 {
            color: #00d9ff;
            margin-bottom: 1rem;
        }
        .modal-content p {
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        .modal-content ul {
            margin: 1rem 0 1rem 1.5rem;
        }
        .modal-content li { margin: 0.5rem 0; }
        .close-modal {
            float: right;
            font-size: 1.5rem;
            cursor: pointer;
            color: #888;
        }
        .close-modal:hover { color: #fff; }
        .section-title {
            color: #00d9ff;
            font-size: 0.9rem;
            margin-top: 1rem;
            padding-bottom: 0.3rem;
            border-bottom: 1px solid #333;
        }
        .pool-bar {
            height: 20px;
            background: #222;
            border-radius: 3px;
            margin: 5px 0;
            overflow: hidden;
            display: flex;
        }
        .pool-segment {
            height: 100%;
            transition: width 0.3s;
        }
    
        .explain-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            font-weight: 600;
        }
        .explain-btn:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            padding: 20px;
            overflow-y: auto;
        }
        .modal-overlay.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }
        .modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #252542 100%);
            border-radius: 20px;
            padding: 35px;
            max-width: 750px;
            width: 100%;
            margin: 40px auto;
            position: relative;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        .modal-close:hover {
            color: #fff;
            background: rgba(255,255,255,0.2);
        }
        .modal h2 {
            color: #00d9ff;
            margin-bottom: 25px;
            font-size: 1.6rem;
            padding-right: 50px;
            line-height: 1.3;
        }
        .modal-body {
            color: #d1d5db;
            line-height: 1.9;
            font-size: 1rem;
        }
        .modal-body h3 {
            color: #00ff88;
            margin: 28px 0 14px 0;
            font-size: 1.15rem;
            font-weight: 600;
        }
        .modal-body p {
            margin-bottom: 16px;
        }
        .modal-body ul {
            margin: 12px 0 18px 24px;
        }
        .modal-body li {
            margin-bottom: 10px;
        }
        .modal-body strong {
            color: #00d9ff;
        }
        .modal-body em {
            color: #a5b4fc;
            font-style: italic;
        }
        .modal-body code {
            background: rgba(0,0,0,0.3);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Fira Code', monospace;
            color: #fbbf24;
            font-size: 0.9em;
        }
        .modal-category {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <header>
        <div>
            <a href="index.html" class="back-link">‚Üê Back to Gallery</a>
            <h1>200. Synaptic Vesicle Cycle</h1>
        </div>
        <div class="btn-row">
            <button class="btn btn-secondary" onclick="showExplanation()">Explain</button>
        </div>
    </header>

    <div class="main-container">
        <div class="canvas-container">
            <canvas id="simCanvas"></canvas>
        </div>

        <div class="controls-panel">
            <div class="btn-row">
                <button class="btn btn-primary" id="playPauseBtn" onclick="toggleSimulation()">Pause</button>
                <button class="btn btn-secondary" onclick="resetSimulation()">Reset</button>
                <button id="explainBtn" class="explain-btn">üìö Explain This Simulation</button>
                <button class="btn btn-action" onclick="triggerActionPotential()">Action Potential</button>
            </div>

            <div class="control-group">
                <label>Calcium Influx <span class="value" id="calciumVal">60%</span></label>
                <input type="range" id="calciumInflux" min="0" max="100" value="60">
            </div>
            <div class="control-group">
                <label>Docking Rate <span class="value" id="dockingVal">50%</span></label>
                <input type="range" id="dockingRate" min="0" max="100" value="50">
            </div>
            <div class="control-group">
                <label>Priming Rate <span class="value" id="primingVal">40%</span></label>
                <input type="range" id="primingRate" min="0" max="100" value="40">
            </div>
            <div class="control-group">
                <label>Endocytosis Rate <span class="value" id="endoVal">45%</span></label>
                <input type="range" id="endoRate" min="0" max="100" value="45">
            </div>
            <div class="control-group">
                <label>Refilling Rate <span class="value" id="refillVal">50%</span></label>
                <input type="range" id="refillRate" min="0" max="100" value="50">
            </div>

            <div class="section-title">Vesicle Pools</div>
            <div class="stats-panel">
                <div class="stat-row">
                    <span>Reserve Pool</span>
                    <span class="stat-value" id="reserveCount">0</span>
                </div>
                <div class="stat-row">
                    <span>Recycling Pool</span>
                    <span class="stat-value" id="recyclingCount">0</span>
                </div>
                <div class="stat-row">
                    <span>Docked</span>
                    <span class="stat-value" id="dockedCount">0</span>
                </div>
                <div class="stat-row">
                    <span>Primed (RRP)</span>
                    <span class="stat-value" id="primedCount">0</span>
                </div>
                <div class="pool-bar" id="poolBar"></div>
            </div>

            <div class="stats-panel">
                <h3>Release Events</h3>
                <div class="stat-row">
                    <span>Total Released</span>
                    <span class="stat-value" id="totalReleased">0</span>
                </div>
                <div class="stat-row">
                    <span>Calcium Level</span>
                    <span class="stat-value" id="calciumLevel">0%</span>
                </div>
                <div class="stat-row">
                    <span>Fusing Now</span>
                    <span class="stat-value" id="fusingCount">0</span>
                </div>
                <div class="stat-row">
                    <span>Endocytosing</span>
                    <span class="stat-value" id="endoCount">0</span>
                </div>
            </div>

            <div class="legend">
                <div class="legend-item"><div class="legend-color" style="background: #666;"></div> Reserve</div>
                <div class="legend-item"><div class="legend-color" style="background: #4488ff;"></div> Recycling</div>
                <div class="legend-item"><div class="legend-color" style="background: #00ff88;"></div> Docked</div>
                <div class="legend-item"><div class="legend-color" style="background: #ffcc00;"></div> Primed</div>
                <div class="legend-item"><div class="legend-color" style="background: #ff4444;"></div> Fusing</div>
                <div class="legend-item"><div class="legend-color" style="background: #ff00ff;"></div> Endocytosing</div>
                <div class="legend-item"><div class="legend-color" style="background: #00ffff;"></div> Calcium</div>
                <div class="legend-item"><div class="legend-color" style="background: #ff9900;"></div> Neurotransmitter</div>
            </div>
        </div>
    </div>

    <div class="modal" id="explanationModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeExplanation()">&times;</span>
            <h2>Synaptic Vesicle Cycle</h2>
            <p>
                This simulation models the complete life cycle of synaptic vesicles at the presynaptic terminal,
                from docking through neurotransmitter release and membrane recycling. The cycle is fundamental
                to all chemical synaptic transmission.
            </p>

            <h3>SNARE-Mediated Fusion</h3>
            <ul>
                <li><strong>v-SNAREs:</strong> Synaptobrevin-2 on vesicle membrane</li>
                <li><strong>t-SNAREs:</strong> Syntaxin-1 and SNAP-25 on plasma membrane</li>
                <li><strong>Zippering:</strong> SNARE complex assembly drives membrane fusion</li>
            </ul>

            <h3>The Cycle Stages</h3>
            <ul>
                <li><strong>Docking:</strong> Physical attachment of vesicles to active zone via Munc-18 and RIM</li>
                <li><strong>Priming:</strong> Munc-13 opens syntaxin conformation, SNARE complex partially assembles</li>
                <li><strong>Calcium Sensing:</strong> Synaptotagmin-1 (Syt1) binds Ca¬≤‚Å∫, triggers membrane merger</li>
                <li><strong>Fusion:</strong> Full SNARE zippering, pore formation, neurotransmitter release</li>
                <li><strong>Endocytosis:</strong> Membrane retrieval via clathrin-mediated or ultrafast endocytosis</li>
                <li><strong>Refilling:</strong> Vesicle re-acidification and neurotransmitter loading</li>
            </ul>

            <h3>Vesicle Pools</h3>
            <ul>
                <li><strong>Reserve Pool:</strong> ~80% of vesicles, mobilized only during intense stimulation</li>
                <li><strong>Recycling Pool:</strong> ~15% of vesicles, sustain transmission during moderate activity</li>
                <li><strong>Readily Releasable Pool (RRP):</strong> ~5% of vesicles, docked and primed for immediate release</li>
            </ul>

            <h3>Recycling Modes</h3>
            <ul>
                <li><strong>Kiss-and-Run:</strong> Brief fusion pore opening, rapid closure, fastest recycling</li>
                <li><strong>Clathrin-Mediated:</strong> Full collapse, coat assembly, scission by dynamin</li>
                <li><strong>Ultrafast Endocytosis (UFE):</strong> 50-100ms retrieval of large membrane patches</li>
                <li><strong>Activity-Dependent Bulk Endocytosis:</strong> Large endosome formation during intense activity</li>
            </ul>

            <h3>SNARE Recycling</h3>
            <p>
                After fusion, NSF (N-ethylmaleimide-sensitive factor) uses ATP hydrolysis to disassemble
                cis-SNARE complexes on the plasma membrane, allowing synaptobrevin to be endocytosed
                and repackaged into new vesicles.
            </p>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');

        let running = true;
        let animationId = null;

        // Vesicle states
        const RESERVE = 0;
        const RECYCLING = 1;
        const DOCKED = 2;
        const PRIMED = 3;
        const FUSING = 4;
        const ENDOCYTOSING = 5;
        const REFILLING = 6;

        // Simulation state
        let vesicles = [];
        let neurotransmitters = [];
        let calciumParticles = [];
        let calciumLevel = 0;
        let totalReleased = 0;
        let actionPotentialActive = false;
        let apTimer = 0;

        // Active zone slots
        const NUM_ACTIVE_ZONE_SLOTS = 12;
        let activeZoneSlots = [];

        function getParams() {
            return {
                calciumInflux: parseInt(document.getElementById('calciumInflux').value) / 100,
                dockingRate: parseInt(document.getElementById('dockingRate').value) / 100,
                primingRate: parseInt(document.getElementById('primingRate').value) / 100,
                endoRate: parseInt(document.getElementById('endoRate').value) / 100,
                refillRate: parseInt(document.getElementById('refillRate').value) / 100
            };
        }

        function updateSliderDisplay() {
            document.getElementById('calciumVal').textContent = document.getElementById('calciumInflux').value + '%';
            document.getElementById('dockingVal').textContent = document.getElementById('dockingRate').value + '%';
            document.getElementById('primingVal').textContent = document.getElementById('primingRate').value + '%';
            document.getElementById('endoVal').textContent = document.getElementById('endoRate').value + '%';
            document.getElementById('refillVal').textContent = document.getElementById('refillRate').value + '%';
        }

        document.querySelectorAll('input[type="range"]').forEach(slider => {
            slider.addEventListener('input', updateSliderDisplay);
        });

        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            initActiveZoneSlots();
        }

        function initActiveZoneSlots() {
            activeZoneSlots = [];
            const azStartX = canvas.width * 0.25;
            const azEndX = canvas.width * 0.75;
            const slotWidth = (azEndX - azStartX) / NUM_ACTIVE_ZONE_SLOTS;
            for (let i = 0; i < NUM_ACTIVE_ZONE_SLOTS; i++) {
                activeZoneSlots.push({
                    x: azStartX + slotWidth * (i + 0.5),
                    y: canvas.height * 0.22,
                    occupied: false,
                    vesicle: null
                });
            }
        }

        class Vesicle {
            constructor(x, y, state = RESERVE) {
                this.x = x;
                this.y = y;
                this.state = state;
                this.timer = 0;
                this.targetX = x;
                this.targetY = y;
                this.radius = 12;
                this.slot = null;
                this.neurotransmitterCount = 5000 + Math.random() * 2000;
                this.fusionProgress = 0;
                this.endocytoticProgress = 0;
                this.snareEngaged = false;
            }

            getColor() {
                switch (this.state) {
                    case RESERVE: return '#666666';
                    case RECYCLING: return '#4488ff';
                    case DOCKED: return '#00ff88';
                    case PRIMED: return '#ffcc00';
                    case FUSING: return '#ff4444';
                    case ENDOCYTOSING: return '#ff00ff';
                    case REFILLING: return '#4488ff';
                    default: return '#666666';
                }
            }
        }

        class Neurotransmitter {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 4;
                this.vy = Math.random() * 3 + 2;
                this.life = 100 + Math.random() * 50;
            }
        }

        class CalciumParticle {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.vy = Math.random() * 2 + 1;
                this.life = 60 + Math.random() * 40;
                this.size = 3 + Math.random() * 2;
            }
        }

        function initSimulation() {
            resizeCanvas();
            vesicles = [];
            neurotransmitters = [];
            calciumParticles = [];
            calciumLevel = 0;
            totalReleased = 0;
            actionPotentialActive = false;
            apTimer = 0;

            // Initialize active zone slots
            initActiveZoneSlots();

            // Create reserve pool vesicles (scattered in upper region)
            for (let i = 0; i < 50; i++) {
                const x = 50 + Math.random() * (canvas.width - 100);
                const y = canvas.height * 0.35 + Math.random() * (canvas.height * 0.35);
                vesicles.push(new Vesicle(x, y, RESERVE));
            }

            // Create some initially docked vesicles
            for (let i = 0; i < 6; i++) {
                const slot = activeZoneSlots[i * 2];
                if (slot) {
                    const v = new Vesicle(slot.x, slot.y, Math.random() < 0.5 ? DOCKED : PRIMED);
                    v.slot = slot;
                    slot.occupied = true;
                    slot.vesicle = v;
                    vesicles.push(v);
                }
            }
        }

        function triggerActionPotential() {
            actionPotentialActive = true;
            apTimer = 100;
        }

        function update() {
            const params = getParams();

            // Handle action potential and calcium dynamics
            if (actionPotentialActive) {
                apTimer--;
                if (apTimer <= 0) {
                    actionPotentialActive = false;
                }

                // Calcium influx during AP
                if (apTimer > 80) {
                    calciumLevel = Math.min(1, calciumLevel + params.calciumInflux * 0.1);
                    // Spawn calcium particles at active zone
                    for (let i = 0; i < 5; i++) {
                        const x = canvas.width * 0.25 + Math.random() * canvas.width * 0.5;
                        calciumParticles.push(new CalciumParticle(x, canvas.height * 0.15));
                    }
                }
            }

            // Calcium decay
            calciumLevel = Math.max(0, calciumLevel - 0.01);

            // Update calcium particles
            for (let i = calciumParticles.length - 1; i >= 0; i--) {
                const p = calciumParticles[i];
                p.y += p.vy;
                p.life--;
                if (p.life <= 0 || p.y > canvas.height * 0.4) {
                    calciumParticles.splice(i, 1);
                }
            }

            // Update vesicles
            for (const vesicle of vesicles) {
                vesicle.timer++;

                switch (vesicle.state) {
                    case RESERVE:
                        // Random Brownian motion
                        vesicle.x += (Math.random() - 0.5) * 1;
                        vesicle.y += (Math.random() - 0.5) * 1;
                        vesicle.x = Math.max(40, Math.min(canvas.width - 40, vesicle.x));
                        vesicle.y = Math.max(canvas.height * 0.35, Math.min(canvas.height * 0.75, vesicle.y));

                        // Mobilization to recycling pool
                        if (Math.random() < 0.002) {
                            vesicle.state = RECYCLING;
                        }
                        break;

                    case RECYCLING:
                        // Move towards active zone if slot available
                        const freeSlot = activeZoneSlots.find(s => !s.occupied);
                        if (freeSlot && Math.random() < params.dockingRate * 0.02) {
                            vesicle.targetX = freeSlot.x;
                            vesicle.targetY = freeSlot.y;
                            vesicle.slot = freeSlot;
                            freeSlot.occupied = true;
                            freeSlot.vesicle = vesicle;
                        }

                        // Move towards target or wander
                        if (vesicle.slot) {
                            const dx = vesicle.targetX - vesicle.x;
                            const dy = vesicle.targetY - vesicle.y;
                            const dist = Math.sqrt(dx * dx + dy * dy);

                            if (dist < 5) {
                                vesicle.state = DOCKED;
                                vesicle.x = vesicle.slot.x;
                                vesicle.y = vesicle.slot.y;
                                vesicle.timer = 0;
                            } else {
                                vesicle.x += dx / dist * 2;
                                vesicle.y += dy / dist * 2;
                            }
                        } else {
                            vesicle.x += (Math.random() - 0.5) * 2;
                            vesicle.y += (Math.random() - 0.5) * 2;
                            vesicle.y = Math.min(vesicle.y, canvas.height * 0.5);
                        }
                        break;

                    case DOCKED:
                        // SNARE engagement and priming
                        if (vesicle.timer > 30 && Math.random() < params.primingRate * 0.02) {
                            vesicle.state = PRIMED;
                            vesicle.snareEngaged = true;
                            vesicle.timer = 0;
                        }
                        break;

                    case PRIMED:
                        // Calcium-triggered fusion
                        if (calciumLevel > 0.3 && Math.random() < calciumLevel * 0.15) {
                            vesicle.state = FUSING;
                            vesicle.fusionProgress = 0;
                            vesicle.timer = 0;
                        }
                        break;

                    case FUSING:
                        vesicle.fusionProgress += 0.05;

                        // Release neurotransmitters
                        if (vesicle.fusionProgress > 0.3 && vesicle.neurotransmitterCount > 0) {
                            for (let i = 0; i < 5; i++) {
                                neurotransmitters.push(new Neurotransmitter(
                                    vesicle.x + (Math.random() - 0.5) * 10,
                                    vesicle.y + 10
                                ));
                                vesicle.neurotransmitterCount -= 50;
                                totalReleased++;
                            }
                        }

                        // Transition to endocytosis
                        if (vesicle.fusionProgress >= 1) {
                            vesicle.state = ENDOCYTOSING;
                            vesicle.endocytoticProgress = 0;
                            vesicle.timer = 0;
                            // Release slot
                            if (vesicle.slot) {
                                vesicle.slot.occupied = false;
                                vesicle.slot.vesicle = null;
                            }
                        }
                        break;

                    case ENDOCYTOSING:
                        vesicle.endocytoticProgress += params.endoRate * 0.01;
                        vesicle.y += 1;

                        if (vesicle.endocytoticProgress >= 1) {
                            vesicle.state = REFILLING;
                            vesicle.timer = 0;
                            vesicle.slot = null;
                        }
                        break;

                    case REFILLING:
                        // Refilling with neurotransmitters
                        vesicle.neurotransmitterCount = Math.min(
                            7000,
                            vesicle.neurotransmitterCount + params.refillRate * 50
                        );

                        // Move back towards recycling pool
                        vesicle.y += 0.5;
                        if (vesicle.y > canvas.height * 0.5) {
                            vesicle.y = canvas.height * 0.5;
                        }

                        if (vesicle.neurotransmitterCount >= 5000 && vesicle.timer > 60) {
                            vesicle.state = RECYCLING;
                            vesicle.snareEngaged = false;
                        }
                        break;
                }
            }

            // Update neurotransmitters
            for (let i = neurotransmitters.length - 1; i >= 0; i--) {
                const nt = neurotransmitters[i];
                nt.x += nt.vx;
                nt.y += nt.vy;
                nt.vy += 0.1; // Gravity
                nt.life--;

                if (nt.life <= 0 || nt.y > canvas.height) {
                    neurotransmitters.splice(i, 1);
                }
            }

            updateStats();
        }

        function updateStats() {
            const counts = {
                [RESERVE]: 0,
                [RECYCLING]: 0,
                [DOCKED]: 0,
                [PRIMED]: 0,
                [FUSING]: 0,
                [ENDOCYTOSING]: 0,
                [REFILLING]: 0
            };

            for (const v of vesicles) {
                counts[v.state]++;
            }

            document.getElementById('reserveCount').textContent = counts[RESERVE];
            document.getElementById('recyclingCount').textContent = counts[RECYCLING] + counts[REFILLING];
            document.getElementById('dockedCount').textContent = counts[DOCKED];
            document.getElementById('primedCount').textContent = counts[PRIMED];
            document.getElementById('totalReleased').textContent = totalReleased;
            document.getElementById('calciumLevel').textContent = Math.round(calciumLevel * 100) + '%';
            document.getElementById('fusingCount').textContent = counts[FUSING];
            document.getElementById('endoCount').textContent = counts[ENDOCYTOSING];

            // Update pool bar
            const total = vesicles.length;
            const poolBar = document.getElementById('poolBar');
            poolBar.innerHTML = `
                <div class="pool-segment" style="width: ${counts[RESERVE] / total * 100}%; background: #666;"></div>
                <div class="pool-segment" style="width: ${(counts[RECYCLING] + counts[REFILLING]) / total * 100}%; background: #4488ff;"></div>
                <div class="pool-segment" style="width: ${counts[DOCKED] / total * 100}%; background: #00ff88;"></div>
                <div class="pool-segment" style="width: ${counts[PRIMED] / total * 100}%; background: #ffcc00;"></div>
                <div class="pool-segment" style="width: ${counts[FUSING] / total * 100}%; background: #ff4444;"></div>
                <div class="pool-segment" style="width: ${counts[ENDOCYTOSING] / total * 100}%; background: #ff00ff;"></div>
            `;
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw presynaptic terminal (top)
            const preGrad = ctx.createLinearGradient(0, 0, 0, canvas.height * 0.25);
            preGrad.addColorStop(0, '#2a2a4a');
            preGrad.addColorStop(1, '#1a1a3a');
            ctx.fillStyle = preGrad;
            ctx.fillRect(0, 0, canvas.width, canvas.height * 0.25);

            // Draw plasma membrane
            ctx.fillStyle = '#554433';
            ctx.fillRect(0, canvas.height * 0.18, canvas.width, canvas.height * 0.07);

            // Draw active zone
            ctx.fillStyle = '#774422';
            ctx.fillRect(canvas.width * 0.2, canvas.height * 0.18, canvas.width * 0.6, canvas.height * 0.07);
            ctx.fillStyle = '#aa8866';
            ctx.font = '11px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Active Zone', canvas.width / 2, canvas.height * 0.21);

            // Draw active zone slots
            for (const slot of activeZoneSlots) {
                ctx.beginPath();
                ctx.arc(slot.x, slot.y, 16, 0, Math.PI * 2);
                ctx.strokeStyle = slot.occupied ? '#00ff8844' : '#ffffff22';
                ctx.lineWidth = 2;
                ctx.stroke();
            }

            // Draw synaptic cleft
            ctx.fillStyle = '#0a0a2a';
            ctx.fillRect(0, canvas.height * 0.25, canvas.width, canvas.height * 0.15);
            ctx.fillStyle = '#666';
            ctx.font = '10px sans-serif';
            ctx.fillText('Synaptic Cleft', canvas.width / 2, canvas.height * 0.32);

            // Draw postsynaptic membrane
            ctx.fillStyle = '#554433';
            ctx.fillRect(0, canvas.height * 0.4, canvas.width, canvas.height * 0.05);

            // Draw cytoplasm
            const cytoGrad = ctx.createLinearGradient(0, canvas.height * 0.45, 0, canvas.height);
            cytoGrad.addColorStop(0, '#1a1a3e');
            cytoGrad.addColorStop(1, '#0a0a2e');
            ctx.fillStyle = cytoGrad;
            ctx.fillRect(0, canvas.height * 0.45, canvas.width, canvas.height * 0.55);

            // Draw endosome region
            ctx.fillStyle = 'rgba(68, 136, 255, 0.1)';
            ctx.beginPath();
            ctx.ellipse(canvas.width / 2, canvas.height * 0.65, canvas.width * 0.3, canvas.height * 0.15, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = 'rgba(68, 136, 255, 0.3)';
            ctx.stroke();
            ctx.fillStyle = '#4488ff88';
            ctx.font = '10px sans-serif';
            ctx.fillText('Early Endosome', canvas.width / 2, canvas.height * 0.62);

            // Draw calcium channels during AP
            if (actionPotentialActive) {
                ctx.fillStyle = `rgba(0, 255, 255, ${apTimer / 100 * 0.3})`;
                ctx.fillRect(canvas.width * 0.2, canvas.height * 0.15, canvas.width * 0.6, canvas.height * 0.03);

                // Voltage-gated calcium channel representations
                for (let x = canvas.width * 0.25; x < canvas.width * 0.75; x += 30) {
                    ctx.beginPath();
                    ctx.arc(x, canvas.height * 0.165, 5, 0, Math.PI * 2);
                    ctx.fillStyle = '#00ffff';
                    ctx.fill();
                }
            }

            // Draw calcium particles
            for (const p of calciumParticles) {
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(0, 255, 255, ${p.life / 100})`;
                ctx.fill();
            }

            // Draw vesicles
            for (const vesicle of vesicles) {
                ctx.save();
                ctx.translate(vesicle.x, vesicle.y);

                const color = vesicle.getColor();
                let radius = vesicle.radius;

                // Draw SNARE complex for docked/primed vesicles
                if (vesicle.state === DOCKED || vesicle.state === PRIMED) {
                    ctx.beginPath();
                    ctx.moveTo(-5, radius);
                    ctx.lineTo(-5, radius + 10);
                    ctx.moveTo(5, radius);
                    ctx.lineTo(5, radius + 10);
                    ctx.strokeStyle = vesicle.state === PRIMED ? '#ffcc00' : '#00ff88';
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    // Draw synaptotagmin for primed
                    if (vesicle.state === PRIMED) {
                        ctx.beginPath();
                        ctx.arc(0, radius + 5, 4, 0, Math.PI * 2);
                        ctx.fillStyle = calciumLevel > 0.3 ? '#ff4444' : '#888';
                        ctx.fill();
                    }
                }

                // Special rendering for fusing vesicles
                if (vesicle.state === FUSING) {
                    radius = vesicle.radius * (1 - vesicle.fusionProgress * 0.3);

                    // Draw fusion pore
                    ctx.beginPath();
                    ctx.ellipse(0, radius * 0.5, vesicle.fusionProgress * 8, 3, 0, 0, Math.PI * 2);
                    ctx.fillStyle = '#ff6666';
                    ctx.fill();
                }

                // Draw vesicle body
                ctx.beginPath();
                ctx.arc(0, 0, radius, 0, Math.PI * 2);

                const grad = ctx.createRadialGradient(-3, -3, 0, 0, 0, radius);
                grad.addColorStop(0, color);
                grad.addColorStop(1, shadeColor(color, -40));
                ctx.fillStyle = grad;
                ctx.fill();
                ctx.strokeStyle = 'rgba(255,255,255,0.3)';
                ctx.lineWidth = 1;
                ctx.stroke();

                // Draw synaptobrevin (v-SNARE) markers
                for (let i = 0; i < 4; i++) {
                    const angle = (i / 4) * Math.PI * 2;
                    ctx.beginPath();
                    ctx.arc(Math.cos(angle) * radius * 0.7, Math.sin(angle) * radius * 0.7, 2, 0, Math.PI * 2);
                    ctx.fillStyle = '#ffaa00';
                    ctx.fill();
                }

                ctx.restore();
            }

            // Draw neurotransmitters
            for (const nt of neurotransmitters) {
                ctx.beginPath();
                ctx.arc(nt.x, nt.y, 3, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 153, 0, ${nt.life / 150})`;
                ctx.fill();
            }

            // Draw labels
            ctx.fillStyle = '#888';
            ctx.font = '11px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('Presynaptic Terminal', 10, 20);
            ctx.fillText('Reserve Pool', 10, canvas.height * 0.55);
            ctx.fillText('Recycling Pool', 10, canvas.height * 0.45);

            // AP indicator
            if (actionPotentialActive) {
                ctx.fillStyle = '#00ffff';
                ctx.font = 'bold 14px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText('ACTION POTENTIAL', canvas.width - 15, 25);
            }

            // Calcium level indicator
            ctx.fillStyle = '#00ffff';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText(`[Ca¬≤‚Å∫]: ${Math.round(calciumLevel * 100)}%`, 10, canvas.height * 0.15);
        }

        function shadeColor(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return '#' + (0x1000000 +
                (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255)
            ).toString(16).slice(1);
        }

        function animate() {
            if (running) {
                update();
            }
            draw();
            animationId = requestAnimationFrame(animate);
        }

        function toggleSimulation() {
            running = !running;
            document.getElementById('playPauseBtn').textContent = running ? 'Pause' : 'Play';
        }

        function resetSimulation() {
            initSimulation();
        }

        function showExplanation() {
            document.getElementById('explanationModal').classList.add('active');
        }

        function closeExplanation() {
            document.getElementById('explanationModal').classList.remove('active');
        }

        window.addEventListener('resize', resizeCanvas);
        document.getElementById('explanationModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('explanationModal')) {
                closeExplanation();
            }
        });

        initSimulation();
        animate();
    </script>


    <div id="explainModal" class="modal-overlay">
        <div class="modal">
            <button class="modal-close">&times;</button>
            <h2>üìä Synaptic Vesicle Cycle</h2>
            <div class="modal-body">
                <p>Life operates through precise molecular machinery. This simulation models biochemical reactions and molecular interactions at the cellular level.</p>

                <h3>About This Simulation</h3>
                <p>Create a neurotransmitter release model with docking, fusion, and recycling.</p>

                <h3>Key Concepts</h3>
                <ul>
                    <li><strong>Enzyme Kinetics:</strong> Enzymes catalyze reactions following Michaelis-Menten kinetics, with rates determined by substrate concentration and enzyme affinity (Km).</li>
                    <li><strong>Lock and Key vs Induced Fit:</strong> Enzymes recognize substrates either through rigid complementarity (lock-key) or conformational changes upon binding (induced fit).</li>
                    <li><strong>Allosteric Regulation:</strong> Enzyme activity modulated by molecules binding at sites other than the active site, enabling sophisticated metabolic control.</li>
                    <li><strong>Signal Transduction:</strong> Cascades of molecular interactions that amplify and transmit signals from cell surface to nucleus.</li>
                </ul>

                <h3>Why It Matters</h3>
                <p>Molecular understanding enables drug design, metabolic engineering, and synthetic biology.</p>

                <h3>How to Explore</h3>
                <ul>
                    <li>Adjust the sliders to modify simulation parameters and observe how the system responds</li>
                    <li>Look for emergent patterns that arise from agent interactions</li>
                    <li>Try extreme parameter values to find phase transitions and tipping points</li>
                    <li>Compare the simulation behavior to real-world phenomena</li>
                </ul>

                <p class="modal-category"><em>Category: Biochemistry & Molecular Biology ‚Äî Exploring molecular mechanisms and biochemical pathways</em></p>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('explainModal');
        const explainBtn = document.getElementById('explainBtn');
        if (modal && explainBtn) {
            explainBtn.addEventListener('click', function() {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            });
            modal.querySelector('.modal-close').addEventListener('click', function() {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            });
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.classList.contains('active')) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
        }
    });
    </script>

    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
