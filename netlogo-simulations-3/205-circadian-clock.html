<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circadian Clock Molecular - NetLogo Simulations III</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header {
            background: rgba(0,0,0,0.3);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        h1 { color: #00d9ff; font-size: 1.5rem; }
        .back-link {
            color: #888;
            text-decoration: none;
            font-size: 0.9rem;
        }
        .back-link:hover { color: #00d9ff; }
        .main-container {
            display: flex;
            flex: 1;
            gap: 1rem;
            padding: 1rem;
            overflow: hidden;
        }
        .canvas-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        #simCanvas {
            flex: 1;
            background: #0a0a1a;
            border-radius: 8px;
            border: 1px solid #333;
        }
        .controls-panel {
            width: 340px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            overflow-y: auto;
        }
        .control-group { margin-bottom: 0.3rem; }
        .control-group label {
            display: block;
            margin-bottom: 0.2rem;
            color: #aaa;
            font-size: 0.8rem;
        }
        .control-group input[type="range"] {
            width: 100%;
            accent-color: #00d9ff;
        }
        .control-group .value {
            float: right;
            color: #00d9ff;
            font-weight: bold;
        }
        .btn {
            padding: 0.5rem 0.8rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #00d9ff;
            color: #000;
        }
        .btn-primary:hover { background: #00b8d9; }
        .btn-secondary {
            background: #444;
            color: #fff;
        }
        .btn-secondary:hover { background: #555; }
        .btn-row {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .stats-panel {
            background: rgba(0,100,150,0.2);
            border: 1px solid #00d9ff44;
            border-radius: 5px;
            padding: 0.6rem;
        }
        .stats-panel h3 {
            color: #00d9ff;
            margin-bottom: 0.4rem;
            font-size: 0.9rem;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            margin: 0.15rem 0;
        }
        .stat-value { font-weight: bold; color: #00d9ff; }
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            font-size: 0.7rem;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.2rem;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: #1a1a2e;
            padding: 2rem;
            border-radius: 10px;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid #00d9ff44;
        }
        .modal-content h2 {
            color: #00d9ff;
            margin-bottom: 1rem;
        }
        .modal-content p {
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        .modal-content ul {
            margin: 1rem 0 1rem 1.5rem;
        }
        .modal-content li { margin: 0.5rem 0; }
        .close-modal {
            float: right;
            font-size: 1.5rem;
            cursor: pointer;
            color: #888;
        }
        .close-modal:hover { color: #fff; }
        .section-title {
            color: #00d9ff;
            font-size: 0.85rem;
            margin-top: 0.5rem;
            padding-bottom: 0.2rem;
            border-bottom: 1px solid #333;
        }
        .time-display {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            padding: 0.8rem;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
        }
        .day-night {
            display: flex;
            height: 30px;
            border-radius: 5px;
            overflow: hidden;
            margin: 5px 0;
        }
        .day-segment {
            flex: 1;
            transition: opacity 0.5s;
        }
    
        .explain-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            font-weight: 600;
        }
        .explain-btn:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            padding: 20px;
            overflow-y: auto;
        }
        .modal-overlay.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }
        .modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #252542 100%);
            border-radius: 20px;
            padding: 35px;
            max-width: 750px;
            width: 100%;
            margin: 40px auto;
            position: relative;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        .modal-close:hover {
            color: #fff;
            background: rgba(255,255,255,0.2);
        }
        .modal h2 {
            color: #00d9ff;
            margin-bottom: 25px;
            font-size: 1.6rem;
            padding-right: 50px;
            line-height: 1.3;
        }
        .modal-body {
            color: #d1d5db;
            line-height: 1.9;
            font-size: 1rem;
        }
        .modal-body h3 {
            color: #00ff88;
            margin: 28px 0 14px 0;
            font-size: 1.15rem;
            font-weight: 600;
        }
        .modal-body p {
            margin-bottom: 16px;
        }
        .modal-body ul {
            margin: 12px 0 18px 24px;
        }
        .modal-body li {
            margin-bottom: 10px;
        }
        .modal-body strong {
            color: #00d9ff;
        }
        .modal-body em {
            color: #a5b4fc;
            font-style: italic;
        }
        .modal-body code {
            background: rgba(0,0,0,0.3);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Fira Code', monospace;
            color: #fbbf24;
            font-size: 0.9em;
        }
        .modal-category {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <header>
        <div>
            <a href="index.html" class="back-link">‚Üê Back to Gallery</a>
            <h1>205. Circadian Clock Molecular</h1>
        </div>
        <div class="btn-row">
            <button class="btn btn-secondary" onclick="showExplanation()">Explain</button>
        </div>
    </header>

    <div class="main-container">
        <div class="canvas-container">
            <canvas id="simCanvas"></canvas>
        </div>

        <div class="controls-panel">
            <div class="btn-row">
                <button class="btn btn-primary" id="playPauseBtn" onclick="toggleSimulation()">Pause</button>
                <button class="btn btn-secondary" onclick="resetSimulation()">Reset</button>
                <button id="explainBtn" class="explain-btn">üìö Explain This Simulation</button>
                <button class="btn btn-secondary" onclick="setTimeOfDay('day')">Set Day</button>
                <button class="btn btn-secondary" onclick="setTimeOfDay('night')">Set Night</button>
            </div>

            <div class="time-display">
                <span id="timeDisplay">12:00</span>
                <span id="periodIndicator" style="font-size: 0.8rem; color: #ffaa00;">‚òÄÔ∏è Day</span>
            </div>

            <div class="day-night" id="dayNightBar"></div>

            <div class="section-title">Clock Parameters</div>
            <div class="control-group">
                <label>CLOCK:BMAL1 Binding <span class="value" id="cbVal">60%</span></label>
                <input type="range" id="cbBinding" min="0" max="100" value="60">
            </div>
            <div class="control-group">
                <label>Per/Cry Transcription <span class="value" id="pcVal">50%</span></label>
                <input type="range" id="pcTranscription" min="0" max="100" value="50">
            </div>
            <div class="control-group">
                <label>CK1 Phosphorylation <span class="value" id="ckVal">70%</span></label>
                <input type="range" id="ck1Activity" min="0" max="100" value="70">
            </div>
            <div class="control-group">
                <label>Proteasome Degradation <span class="value" id="protVal">50%</span></label>
                <input type="range" id="proteasome" min="0" max="100" value="50">
            </div>
            <div class="control-group">
                <label>Simulation Speed <span class="value" id="speedVal">1x</span></label>
                <input type="range" id="simSpeed" min="1" max="10" value="3">
            </div>

            <div class="stats-panel">
                <h3>Protein Levels</h3>
                <div class="stat-row">
                    <span>CLOCK:BMAL1</span>
                    <span class="stat-value" id="cbLevel" style="color: #ffaa00;">0.0</span>
                </div>
                <div class="stat-row">
                    <span>PER proteins</span>
                    <span class="stat-value" id="perLevel" style="color: #ff6644;">0.0</span>
                </div>
                <div class="stat-row">
                    <span>CRY proteins</span>
                    <span class="stat-value" id="cryLevel" style="color: #44aaff;">0.0</span>
                </div>
                <div class="stat-row">
                    <span>PER:CRY complex</span>
                    <span class="stat-value" id="pcxLevel" style="color: #aa66ff;">0.0</span>
                </div>
            </div>

            <div class="stats-panel">
                <h3>Gene Expression</h3>
                <div class="stat-row">
                    <span>Per1/2 mRNA</span>
                    <span class="stat-value" id="perMRNA" style="color: #ff6644;">0.0</span>
                </div>
                <div class="stat-row">
                    <span>Cry1/2 mRNA</span>
                    <span class="stat-value" id="cryMRNA" style="color: #44aaff;">0.0</span>
                </div>
                <div class="stat-row">
                    <span>Bmal1 mRNA</span>
                    <span class="stat-value" id="bmalMRNA" style="color: #ffaa00;">0.0</span>
                </div>
            </div>

            <div class="stats-panel">
                <h3>Clock Phase</h3>
                <div class="stat-row">
                    <span>Period</span>
                    <span class="stat-value" id="periodVal">~24 h</span>
                </div>
                <div class="stat-row">
                    <span>Phase</span>
                    <span class="stat-value" id="phaseVal">Activating</span>
                </div>
            </div>

            <div class="legend">
                <div class="legend-item"><div class="legend-color" style="background: #ffaa00;"></div> CLOCK:BMAL1</div>
                <div class="legend-item"><div class="legend-color" style="background: #ff6644;"></div> PER</div>
                <div class="legend-item"><div class="legend-color" style="background: #44aaff;"></div> CRY</div>
                <div class="legend-item"><div class="legend-color" style="background: #aa66ff;"></div> PER:CRY</div>
                <div class="legend-item"><div class="legend-color" style="background: #888;"></div> E-box</div>
            </div>
        </div>
    </div>

    <div class="modal" id="explanationModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeExplanation()">&times;</span>
            <h2>Circadian Clock Molecular</h2>
            <p>
                This simulation models the mammalian circadian clock, a molecular oscillator
                that generates ~24-hour rhythms in gene expression, physiology, and behavior.
            </p>

            <h3>Core Transcription-Translation Feedback Loop (TTFL)</h3>
            <ul>
                <li><strong>Positive Limb:</strong> CLOCK:BMAL1 heterodimer binds E-box sequences, activating Per and Cry gene transcription</li>
                <li><strong>Negative Limb:</strong> PER and CRY proteins accumulate, enter nucleus, and inhibit CLOCK:BMAL1</li>
                <li><strong>Delay:</strong> Post-translational modifications create the ~24h period</li>
            </ul>

            <h3>Dual Repression Mechanisms</h3>
            <ul>
                <li><strong>Blocking (CRY alone):</strong> CRY binds CLOCK:BMAL1 on DNA, blocking transcription without displacement</li>
                <li><strong>Displacement (PER+CRY):</strong> PER enables CK1-mediated phosphorylation that removes CLOCK:BMAL1 from E-boxes</li>
            </ul>

            <h3>Post-Translational Regulation</h3>
            <ul>
                <li><strong>CK1Œµ/Œ¥:</strong> Phosphorylates PER proteins, promoting ubiquitination and degradation</li>
                <li><strong>AMPK:</strong> Phosphorylates CRY proteins for degradation</li>
                <li><strong>SCF E3 ligases:</strong> Œ≤TrCP and FBXL3 target phosphorylated PER and CRY</li>
            </ul>

            <h3>Additional Feedback Loops</h3>
            <ul>
                <li><strong>REV-ERBŒ±:</strong> Represses Bmal1 transcription (stabilizing loop)</li>
                <li><strong>RORŒ±:</strong> Activates Bmal1 transcription</li>
                <li><strong>PER2:</strong> Positive regulator of Bmal1 expression</li>
            </ul>

            <h3>Circadian Phases</h3>
            <ul>
                <li><strong>Day (Activation):</strong> CLOCK:BMAL1 active, Per/Cry genes transcribed</li>
                <li><strong>Evening (Repression):</strong> PER:CRY complex accumulates, inhibits CLOCK:BMAL1</li>
                <li><strong>Night (Repressed):</strong> Minimal transcription, proteins degrading</li>
                <li><strong>Dawn (Recovery):</strong> PER/CRY cleared, CLOCK:BMAL1 reactivates</li>
            </ul>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');

        let running = true;
        let animationId = null;

        // Simulation time (hours)
        let simTime = 6; // Start at 6 AM
        const periodLength = 24; // hours

        // Molecular concentrations
        let clock_bmal1 = 0.8; // CLOCK:BMAL1 complex
        let per_mRNA = 0.1;
        let cry_mRNA = 0.1;
        let bmal1_mRNA = 0.5;
        let per_protein = 0.1;
        let cry_protein = 0.1;
        let per_cry_complex = 0.05;
        let per_phospho = 0;
        let cry_phospho = 0;

        // History for plotting
        let history = {
            time: [],
            clock_bmal1: [],
            per: [],
            cry: [],
            per_cry: []
        };
        const maxHistoryLength = 500;

        // Visual entities
        let clockBmalProteins = [];
        let perProteins = [];
        let cryProteins = [];
        let complexes = [];

        function getParams() {
            return {
                cbBinding: parseInt(document.getElementById('cbBinding').value) / 100,
                pcTranscription: parseInt(document.getElementById('pcTranscription').value) / 100,
                ck1Activity: parseInt(document.getElementById('ck1Activity').value) / 100,
                proteasome: parseInt(document.getElementById('proteasome').value) / 100,
                simSpeed: parseInt(document.getElementById('simSpeed').value)
            };
        }

        function updateSliderDisplay() {
            document.getElementById('cbVal').textContent = document.getElementById('cbBinding').value + '%';
            document.getElementById('pcVal').textContent = document.getElementById('pcTranscription').value + '%';
            document.getElementById('ckVal').textContent = document.getElementById('ck1Activity').value + '%';
            document.getElementById('protVal').textContent = document.getElementById('proteasome').value + '%';
            document.getElementById('speedVal').textContent = document.getElementById('simSpeed').value + 'x';
        }

        document.querySelectorAll('input[type="range"]').forEach(slider => {
            slider.addEventListener('input', updateSliderDisplay);
        });

        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }

        function initSimulation() {
            resizeCanvas();
            simTime = 6;
            clock_bmal1 = 0.8;
            per_mRNA = 0.1;
            cry_mRNA = 0.1;
            bmal1_mRNA = 0.5;
            per_protein = 0.1;
            cry_protein = 0.1;
            per_cry_complex = 0.05;

            history = {
                time: [],
                clock_bmal1: [],
                per: [],
                cry: [],
                per_cry: []
            };

            initProteins();
        }

        function initProteins() {
            clockBmalProteins = [];
            perProteins = [];
            cryProteins = [];
            complexes = [];

            // Create initial proteins
            for (let i = 0; i < 20; i++) {
                clockBmalProteins.push({
                    x: canvas.width * 0.3 + Math.random() * canvas.width * 0.4,
                    y: canvas.height * 0.4 + Math.random() * canvas.height * 0.2,
                    vx: (Math.random() - 0.5) * 2,
                    vy: (Math.random() - 0.5) * 2,
                    bound: false
                });
            }
        }

        function setTimeOfDay(period) {
            if (period === 'day') {
                simTime = 12;
                clock_bmal1 = 0.9;
                per_protein = 0.2;
                cry_protein = 0.2;
                per_cry_complex = 0.1;
            } else {
                simTime = 0;
                clock_bmal1 = 0.2;
                per_protein = 0.8;
                cry_protein = 0.8;
                per_cry_complex = 0.6;
            }
        }

        function update() {
            const params = getParams();
            const dt = 0.01 * params.simSpeed; // Hours per frame

            // Update simulation time
            simTime += dt;
            if (simTime >= 24) simTime -= 24;

            // Molecular dynamics
            // CLOCK:BMAL1 E-box binding depends on PER:CRY inhibition
            const inhibition = per_cry_complex / (per_cry_complex + 0.3);
            const cbActivity = clock_bmal1 * (1 - inhibition) * params.cbBinding;

            // Transcription (mRNA production)
            const perTranscription = cbActivity * params.pcTranscription * 0.5;
            const cryTranscription = cbActivity * params.pcTranscription * 0.4;

            // mRNA dynamics
            per_mRNA += (perTranscription - per_mRNA * 0.15) * dt;
            cry_mRNA += (cryTranscription - cry_mRNA * 0.15) * dt;

            // Bmal1 transcription (repressed by REV-ERBŒ±, activated by RORŒ±)
            const bmal1Activation = 0.3 + 0.2 * Math.sin((simTime / 24) * Math.PI * 2 + Math.PI);
            bmal1_mRNA += (bmal1Activation - bmal1_mRNA * 0.1) * dt;

            // Translation (protein production)
            per_protein += (per_mRNA * 0.3 - per_protein * 0.1) * dt;
            cry_protein += (cry_mRNA * 0.3 - cry_protein * 0.1) * dt;
            clock_bmal1 += (bmal1_mRNA * 0.3 - clock_bmal1 * 0.05) * dt;

            // PER:CRY complex formation
            const complexFormation = per_protein * cry_protein * 0.5;
            per_cry_complex += (complexFormation - per_cry_complex * 0.1 * params.proteasome) * dt;

            // CK1 phosphorylation and degradation
            per_phospho = per_protein * params.ck1Activity * 0.3;
            cry_phospho = cry_protein * 0.2;

            // Degradation
            per_protein -= per_phospho * params.proteasome * 0.2 * dt;
            cry_protein -= cry_phospho * params.proteasome * 0.15 * dt;

            // Clamp values
            per_mRNA = Math.max(0, per_mRNA);
            cry_mRNA = Math.max(0, cry_mRNA);
            bmal1_mRNA = Math.max(0, bmal1_mRNA);
            per_protein = Math.max(0, per_protein);
            cry_protein = Math.max(0, cry_protein);
            clock_bmal1 = Math.max(0.1, Math.min(1.5, clock_bmal1));
            per_cry_complex = Math.max(0, per_cry_complex);

            // Store history
            history.time.push(simTime);
            history.clock_bmal1.push(clock_bmal1);
            history.per.push(per_protein);
            history.cry.push(cry_protein);
            history.per_cry.push(per_cry_complex);

            if (history.time.length > maxHistoryLength) {
                history.time.shift();
                history.clock_bmal1.shift();
                history.per.shift();
                history.cry.shift();
                history.per_cry.shift();
            }

            // Update visual proteins
            updateProteins();
            updateStats();
        }

        function updateProteins() {
            // Scale protein counts to molecular levels
            const targetCB = Math.floor(clock_bmal1 * 25);
            const targetPER = Math.floor(per_protein * 30);
            const targetCRY = Math.floor(cry_protein * 30);
            const targetComplex = Math.floor(per_cry_complex * 20);

            // Adjust protein arrays
            while (clockBmalProteins.length < targetCB) {
                clockBmalProteins.push({
                    x: canvas.width * 0.2 + Math.random() * canvas.width * 0.6,
                    y: canvas.height * 0.3 + Math.random() * canvas.height * 0.4,
                    vx: (Math.random() - 0.5) * 2,
                    vy: (Math.random() - 0.5) * 2,
                    bound: Math.random() < 0.3
                });
            }
            while (clockBmalProteins.length > targetCB && clockBmalProteins.length > 5) {
                clockBmalProteins.pop();
            }

            while (perProteins.length < targetPER) {
                perProteins.push({
                    x: Math.random() * canvas.width,
                    y: canvas.height * 0.5 + Math.random() * canvas.height * 0.4,
                    vx: (Math.random() - 0.5) * 3,
                    vy: (Math.random() - 0.5) * 3
                });
            }
            while (perProteins.length > targetPER) {
                perProteins.pop();
            }

            while (cryProteins.length < targetCRY) {
                cryProteins.push({
                    x: Math.random() * canvas.width,
                    y: canvas.height * 0.5 + Math.random() * canvas.height * 0.4,
                    vx: (Math.random() - 0.5) * 3,
                    vy: (Math.random() - 0.5) * 3
                });
            }
            while (cryProteins.length > targetCRY) {
                cryProteins.pop();
            }

            while (complexes.length < targetComplex) {
                complexes.push({
                    x: canvas.width * 0.3 + Math.random() * canvas.width * 0.4,
                    y: canvas.height * 0.35 + Math.random() * canvas.height * 0.3,
                    vx: (Math.random() - 0.5) * 1.5,
                    vy: (Math.random() - 0.5) * 1.5
                });
            }
            while (complexes.length > targetComplex) {
                complexes.pop();
            }

            // Move proteins
            for (const p of clockBmalProteins) {
                if (!p.bound) {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vx += (Math.random() - 0.5) * 0.5;
                    p.vy += (Math.random() - 0.5) * 0.5;
                    p.vx *= 0.95;
                    p.vy *= 0.95;
                }
                p.x = Math.max(50, Math.min(canvas.width - 50, p.x));
                p.y = Math.max(canvas.height * 0.25, Math.min(canvas.height * 0.75, p.y));
            }

            for (const p of perProteins) {
                p.x += p.vx;
                p.y += p.vy;
                p.vx += (Math.random() - 0.5) * 0.5;
                p.vy += (Math.random() - 0.5) * 0.5;
                p.vx *= 0.95;
                p.vy *= 0.95;
                p.x = Math.max(20, Math.min(canvas.width - 20, p.x));
                p.y = Math.max(canvas.height * 0.2, Math.min(canvas.height - 30, p.y));
            }

            for (const p of cryProteins) {
                p.x += p.vx;
                p.y += p.vy;
                p.vx += (Math.random() - 0.5) * 0.5;
                p.vy += (Math.random() - 0.5) * 0.5;
                p.vx *= 0.95;
                p.vy *= 0.95;
                p.x = Math.max(20, Math.min(canvas.width - 20, p.x));
                p.y = Math.max(canvas.height * 0.2, Math.min(canvas.height - 30, p.y));
            }

            for (const c of complexes) {
                c.x += c.vx;
                c.y += c.vy;
                c.vx *= 0.98;
                c.vy *= 0.98;
                // Move towards nucleus
                c.x += (canvas.width / 2 - c.x) * 0.01;
                c.y += (canvas.height * 0.45 - c.y) * 0.01;
            }
        }

        function updateStats() {
            const hours = Math.floor(simTime);
            const mins = Math.floor((simTime - hours) * 60);
            document.getElementById('timeDisplay').textContent =
                hours.toString().padStart(2, '0') + ':' + mins.toString().padStart(2, '0');

            // Day/night indicator
            const isDay = simTime >= 6 && simTime < 18;
            document.getElementById('periodIndicator').textContent = isDay ? '‚òÄÔ∏è Day' : 'üåô Night';

            // Protein levels
            document.getElementById('cbLevel').textContent = clock_bmal1.toFixed(2);
            document.getElementById('perLevel').textContent = per_protein.toFixed(2);
            document.getElementById('cryLevel').textContent = cry_protein.toFixed(2);
            document.getElementById('pcxLevel').textContent = per_cry_complex.toFixed(2);

            // mRNA levels
            document.getElementById('perMRNA').textContent = per_mRNA.toFixed(2);
            document.getElementById('cryMRNA').textContent = cry_mRNA.toFixed(2);
            document.getElementById('bmalMRNA').textContent = bmal1_mRNA.toFixed(2);

            // Phase
            let phase = 'Activating';
            if (per_cry_complex > 0.3) {
                phase = 'Repressing';
            } else if (per_protein > 0.4 || cry_protein > 0.4) {
                phase = 'Accumulating';
            } else if (clock_bmal1 > 0.6 && per_protein < 0.3) {
                phase = 'Activating';
            }
            document.getElementById('phaseVal').textContent = phase;

            // Update day/night bar
            updateDayNightBar();
        }

        function updateDayNightBar() {
            const bar = document.getElementById('dayNightBar');
            bar.innerHTML = '';
            for (let h = 0; h < 24; h++) {
                const segment = document.createElement('div');
                segment.className = 'day-segment';
                const isCurrentHour = Math.floor(simTime) === h;
                if (h >= 6 && h < 18) {
                    segment.style.background = isCurrentHour ? '#ffcc00' : '#ffaa0066';
                } else {
                    segment.style.background = isCurrentHour ? '#4444ff' : '#22224466';
                }
                bar.appendChild(segment);
            }
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Day/night background gradient
            const isDay = simTime >= 6 && simTime < 18;
            const dayProgress = isDay ?
                (simTime - 6) / 12 :
                (simTime < 6 ? (simTime + 6) / 12 : (simTime - 18) / 6);

            const bgGrad = ctx.createLinearGradient(0, 0, 0, canvas.height);
            if (isDay) {
                bgGrad.addColorStop(0, '#1a2a4a');
                bgGrad.addColorStop(1, '#0a1a3a');
            } else {
                bgGrad.addColorStop(0, '#0a0a2e');
                bgGrad.addColorStop(1, '#050518');
            }
            ctx.fillStyle = bgGrad;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw nucleus
            const nucleusX = canvas.width / 2;
            const nucleusY = canvas.height * 0.45;
            const nucleusRadius = Math.min(canvas.width, canvas.height) * 0.25;

            ctx.beginPath();
            ctx.arc(nucleusX, nucleusY, nucleusRadius, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(80, 60, 100, 0.3)';
            ctx.fill();
            ctx.strokeStyle = '#886699';
            ctx.lineWidth = 3;
            ctx.stroke();

            ctx.fillStyle = '#aa88bb';
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Nucleus', nucleusX, nucleusY - nucleusRadius - 10);

            // Draw E-box (DNA binding site)
            const eboxX = nucleusX;
            const eboxY = nucleusY;
            ctx.fillStyle = '#888888';
            ctx.fillRect(eboxX - 40, eboxY - 10, 80, 20);
            ctx.fillStyle = '#ffff00';
            ctx.font = 'bold 12px monospace';
            ctx.fillText('CACGTG', eboxX, eboxY + 4);
            ctx.fillStyle = '#aaa';
            ctx.font = '10px sans-serif';
            ctx.fillText('E-box', eboxX, eboxY + 22);

            // Draw CLOCK:BMAL1 proteins
            for (const p of clockBmalProteins) {
                ctx.beginPath();
                ctx.arc(p.x, p.y, 8, 0, Math.PI * 2);
                ctx.fillStyle = p.bound ? '#ffcc00' : '#ffaa00';
                ctx.fill();
                ctx.strokeStyle = '#ffffff44';
                ctx.stroke();
            }

            // Draw PER proteins
            for (const p of perProteins) {
                ctx.beginPath();
                ctx.moveTo(p.x, p.y - 7);
                ctx.lineTo(p.x - 6, p.y + 5);
                ctx.lineTo(p.x + 6, p.y + 5);
                ctx.closePath();
                ctx.fillStyle = '#ff6644';
                ctx.fill();
            }

            // Draw CRY proteins
            for (const p of cryProteins) {
                ctx.fillStyle = '#44aaff';
                ctx.fillRect(p.x - 5, p.y - 5, 10, 10);
            }

            // Draw PER:CRY complexes
            for (const c of complexes) {
                // Combined shape
                ctx.beginPath();
                ctx.arc(c.x, c.y, 10, 0, Math.PI * 2);
                ctx.fillStyle = '#aa66ff';
                ctx.fill();
                ctx.strokeStyle = '#ff6644';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Draw interaction with E-box if close
                const distToEbox = Math.sqrt(Math.pow(c.x - eboxX, 2) + Math.pow(c.y - eboxY, 2));
                if (distToEbox < 60) {
                    ctx.beginPath();
                    ctx.moveTo(c.x, c.y);
                    ctx.lineTo(eboxX, eboxY);
                    ctx.strokeStyle = 'rgba(255, 100, 100, 0.5)';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
            }

            // Draw history chart
            drawHistoryChart();

            // Draw legend for chart
            ctx.fillStyle = '#ffaa00';
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('CLOCK:BMAL1', 60, canvas.height - 85);
            ctx.fillStyle = '#ff6644';
            ctx.fillText('PER', 150, canvas.height - 85);
            ctx.fillStyle = '#44aaff';
            ctx.fillText('CRY', 190, canvas.height - 85);
            ctx.fillStyle = '#aa66ff';
            ctx.fillText('PER:CRY', 230, canvas.height - 85);

            // Cytoplasm label
            ctx.fillStyle = '#888';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('Cytoplasm', 20, canvas.height - 90);
        }

        function drawHistoryChart() {
            const chartX = 50;
            const chartY = canvas.height - 80;
            const chartWidth = canvas.width - 100;
            const chartHeight = 60;

            // Background
            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.fillRect(chartX, chartY, chartWidth, chartHeight);

            if (history.time.length < 2) return;

            // Draw traces
            const traces = [
                { data: history.clock_bmal1, color: '#ffaa00' },
                { data: history.per, color: '#ff6644' },
                { data: history.cry, color: '#44aaff' },
                { data: history.per_cry, color: '#aa66ff' }
            ];

            for (const trace of traces) {
                ctx.beginPath();
                ctx.strokeStyle = trace.color;
                ctx.lineWidth = 1.5;

                for (let i = 0; i < trace.data.length; i++) {
                    const x = chartX + (i / maxHistoryLength) * chartWidth;
                    const y = chartY + chartHeight - (trace.data[i] / 1.5) * chartHeight;

                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
            }
        }

        function animate() {
            if (running) {
                update();
            }
            draw();
            animationId = requestAnimationFrame(animate);
        }

        function toggleSimulation() {
            running = !running;
            document.getElementById('playPauseBtn').textContent = running ? 'Pause' : 'Play';
        }

        function resetSimulation() {
            initSimulation();
        }

        function showExplanation() {
            document.getElementById('explanationModal').classList.add('active');
        }

        function closeExplanation() {
            document.getElementById('explanationModal').classList.remove('active');
        }

        window.addEventListener('resize', resizeCanvas);
        document.getElementById('explanationModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('explanationModal')) {
                closeExplanation();
            }
        });

        initSimulation();
        animate();
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal.classList.contains('active')) {
                modal.classList.remove('active');
            }
        });
    }

    </script>


    <div id="explainModal" class="modal-overlay">
        <div class="modal">
            <button class="modal-close">&times;</button>
            <h2>üìä Circadian Clock Molecular</h2>
            <div class="modal-body">
                <p>Life operates through precise molecular machinery. This simulation models biochemical reactions and molecular interactions at the cellular level.</p>

                <h3>About This Simulation</h3>
                <p>Build a molecular circadian oscillator with PER/CRY feedback loops.</p>

                <h3>Key Concepts</h3>
                <ul>
                    <li><strong>Enzyme Kinetics:</strong> Enzymes catalyze reactions following Michaelis-Menten kinetics, with rates determined by substrate concentration and enzyme affinity (Km).</li>
                    <li><strong>Lock and Key vs Induced Fit:</strong> Enzymes recognize substrates either through rigid complementarity (lock-key) or conformational changes upon binding (induced fit).</li>
                    <li><strong>Allosteric Regulation:</strong> Enzyme activity modulated by molecules binding at sites other than the active site, enabling sophisticated metabolic control.</li>
                    <li><strong>Signal Transduction:</strong> Cascades of molecular interactions that amplify and transmit signals from cell surface to nucleus.</li>
                </ul>

                <h3>Why It Matters</h3>
                <p>Molecular understanding enables drug design, metabolic engineering, and synthetic biology.</p>

                <h3>How to Explore</h3>
                <ul>
                    <li>Adjust the sliders to modify simulation parameters and observe how the system responds</li>
                    <li>Look for emergent patterns that arise from agent interactions</li>
                    <li>Try extreme parameter values to find phase transitions and tipping points</li>
                    <li>Compare the simulation behavior to real-world phenomena</li>
                </ul>

                <p class="modal-category"><em>Category: Biochemistry & Molecular Biology ‚Äî Exploring molecular mechanisms and biochemical pathways</em></p>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('explainModal');
        const explainBtn = document.getElementById('explainBtn');
        if (modal && explainBtn) {
            explainBtn.addEventListener('click', function() {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            });
            modal.querySelector('.modal-close').addEventListener('click', function() {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            });
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.classList.contains('active')) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
        }
    });
    </script>

</body>
</html>
