<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telomere Dynamics - NetLogo Simulations III</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 100%);
            min-height: 100vh;
            color: #e0e0e0;
            display: flex;
        }

        .container { flex: 1; display: flex; flex-direction: column; }

        header {
            padding: 15px 25px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(100,200,255,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-link {
            color: #64b5f6;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-link:hover { color: #90caf9; }

        h1 {
            font-size: 1.5rem;
            background: linear-gradient(90deg, #64b5f6, #4fc3f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .main-content { flex: 1; display: flex; overflow: hidden; }

        .canvas-container {
            flex: 1;
            position: relative;
            background: #050510;
        }

        canvas { width: 100%; height: 100%; }

        .control-panel {
            width: 320px;
            background: rgba(0,0,0,0.4);
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid rgba(100,200,255,0.2);
        }

        .panel-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .panel-section h3 {
            color: #4fc3f7;
            margin-bottom: 12px;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .control-group { margin-bottom: 12px; }
        .control-group label { display: block; font-size: 0.85rem; color: #aaa; margin-bottom: 5px; }
        .control-group input[type="range"] { width: 100%; margin-bottom: 3px; }
        .control-value { font-size: 0.8rem; color: #64b5f6; text-align: right; }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .btn-primary { background: linear-gradient(135deg, #1976d2, #1565c0); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(25,118,210,0.4); }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); }
        .btn-secondary:hover { background: rgba(255,255,255,0.2); }
        .btn-action { background: linear-gradient(135deg, #43a047, #388e3c); color: white; font-size: 0.8rem; padding: 8px 12px; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-item { background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 1.3rem; font-weight: bold; color: #4fc3f7; }
        .stat-label { font-size: 0.75rem; color: #888; margin-top: 3px; }

        .telomere-meter {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
        }

        .meter-label { font-size: 0.8rem; color: #aaa; margin-bottom: 8px; }

        .meter-bar {
            height: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .meter-fill {
            height: 100%;
            transition: width 0.5s, background 0.5s;
            border-radius: 10px;
        }

        .meter-zones {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
        }

        .zone { height: 100%; opacity: 0.3; }
        .zone-healthy { flex: 0.6; background: #4caf50; }
        .zone-warning { flex: 0.25; background: #ff9800; }
        .zone-critical { flex: 0.15; background: #f44336; }

        .legend { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .legend-item { display: flex; align-items: center; gap: 5px; font-size: 0.75rem; }
        .legend-color { width: 14px; height: 14px; border-radius: 3px; }

        .cell-status {
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
        }

        .status-dividing { background: rgba(76, 175, 80, 0.3); color: #81c784; }
        .status-senescent { background: rgba(255, 152, 0, 0.3); color: #ffb74d; }
        .status-crisis { background: rgba(244, 67, 54, 0.3); color: #e57373; }

        .modal.active { display: flex; }

        .modal-content {
            background: #1a1a2e;
            padding: 30px;
            border-radius: 12px;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(100,200,255,0.3);
        }

        .modal-content h2 { color: #4fc3f7; margin-bottom: 15px; }
        .modal-content p { line-height: 1.7; margin-bottom: 12px; color: #ccc; }
        .modal-content ul { margin-left: 20px; margin-bottom: 12px; }
        .modal-content li { margin-bottom: 6px; color: #bbb; }

        .close-btn { float: right; background: none; border: none; color: #888; font-size: 1.5rem; cursor: pointer; }
        .close-btn:hover { color: #fff; }
    
        .explain-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            font-weight: 600;
        }
        .explain-btn:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            padding: 20px;
            overflow-y: auto;
        }
        .modal-overlay.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }
        .modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #252542 100%);
            border-radius: 20px;
            padding: 35px;
            max-width: 750px;
            width: 100%;
            margin: 40px auto;
            position: relative;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        .modal-close:hover {
            color: #fff;
            background: rgba(255,255,255,0.2);
        }
        .modal h2 {
            color: #00d9ff;
            margin-bottom: 25px;
            font-size: 1.6rem;
            padding-right: 50px;
            line-height: 1.3;
        }
        .modal-body {
            color: #d1d5db;
            line-height: 1.9;
            font-size: 1rem;
        }
        .modal-body h3 {
            color: #00ff88;
            margin: 28px 0 14px 0;
            font-size: 1.15rem;
            font-weight: 600;
        }
        .modal-body p {
            margin-bottom: 16px;
        }
        .modal-body ul {
            margin: 12px 0 18px 24px;
        }
        .modal-body li {
            margin-bottom: 10px;
        }
        .modal-body strong {
            color: #00d9ff;
        }
        .modal-body em {
            color: #a5b4fc;
            font-style: italic;
        }
        .modal-body code {
            background: rgba(0,0,0,0.3);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Fira Code', monospace;
            color: #fbbf24;
            font-size: 0.9em;
        }
        .modal-category {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="index.html" class="back-link">‚Üê Back to Simulations</a>
            <h1>Telomere Dynamics</h1>
            <button class="btn btn-secondary" onclick="showModal()">Explain</button>
        </header>

        <div class="main-content">
            <div class="canvas-container">
                <canvas id="canvas"></canvas>
            </div>

            <div class="control-panel">
                <div class="panel-section">
                    <h3>Simulation Controls</h3>
                    <button class="btn btn-primary" id="startBtn" onclick="toggleSimulation()">Start</button>
                    <button class="btn btn-secondary" onclick="resetSimulation()">Reset</button>
                <button id="explainBtn" class="explain-btn">üìö Explain This Simulation</button>
                    <button class="btn btn-action" onclick="triggerDivision()">Divide Cell</button>
                </div>

                <div class="panel-section">
                    <h3>Parameters</h3>

                    <div class="control-group">
                        <label>Telomerase Activity</label>
                        <input type="range" id="telomeraseActivity" min="0" max="1" step="0.05" value="0">
                        <div class="control-value"><span id="telomeraseActivityVal">0</span>% (somatic cell)</div>
                    </div>

                    <div class="control-group">
                        <label>Base Loss Per Division</label>
                        <input type="range" id="baseLoss" min="20" max="200" step="10" value="50">
                        <div class="control-value"><span id="baseLossVal">50</span> bp</div>
                    </div>

                    <div class="control-group">
                        <label>Critical Length</label>
                        <input type="range" id="criticalLength" min="500" max="3000" step="100" value="2000">
                        <div class="control-value"><span id="criticalLengthVal">2000</span> bp</div>
                    </div>

                    <div class="control-group">
                        <label>Shelterin Protection</label>
                        <input type="range" id="shelterinLevel" min="0.5" max="1" step="0.05" value="1">
                        <div class="control-value"><span id="shelterinLevelVal">100</span>%</div>
                    </div>
                </div>

                <div class="panel-section">
                    <h3>Telomere Status</h3>
                    <div class="telomere-meter">
                        <div class="meter-label">Telomere Length</div>
                        <div class="meter-bar">
                            <div class="meter-zones">
                                <div class="zone zone-healthy"></div>
                                <div class="zone zone-warning"></div>
                                <div class="zone zone-critical"></div>
                            </div>
                            <div class="meter-fill" id="telomereMeter" style="width: 100%; background: #4caf50;"></div>
                        </div>
                    </div>
                    <div class="cell-status status-dividing" id="cellStatus">ACTIVELY DIVIDING</div>
                </div>

                <div class="panel-section">
                    <h3>Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="currentLength">15000</div>
                            <div class="stat-label">Telomere Length (bp)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="divisions">0</div>
                            <div class="stat-label">Cell Divisions</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="hayflickLimit">~50</div>
                            <div class="stat-label">Est. Divisions Left</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="tloopStatus">Intact</div>
                            <div class="stat-label">T-Loop Status</div>
                        </div>
                    </div>
                </div>

                <div class="panel-section">
                    <h3>Legend</h3>
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #4fc3f7;"></div>
                            <span>Telomeric DNA (TTAGGG)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ff9800;"></div>
                            <span>Shelterin Complex</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #81c784;"></div>
                            <span>Telomerase</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #e57373;"></div>
                            <span>3' Overhang</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="hideModal()">&times;</button>
            <h2>Telomere Dynamics</h2>
            <p>
                Telomeres are repetitive DNA sequences (TTAGGG in humans) at chromosome ends that protect
                genetic information. They solve the "end replication problem" but shorten with each cell
                division, acting as a molecular clock for cellular aging.
            </p>
            <h3>The End Replication Problem</h3>
            <p>
                DNA polymerase requires RNA primers and can only synthesize in the 5'‚Üí3' direction. After
                replication, the RNA primer at the lagging strand's 5' end is removed, leaving a gap that
                cannot be filled. This causes 50-200 bp loss per division in human cells.
            </p>
            <h3>Shelterin Complex</h3>
            <ul>
                <li><strong>TRF1 & TRF2:</strong> Bind double-stranded telomeric DNA</li>
                <li><strong>POT1:</strong> Binds single-stranded 3' overhang</li>
                <li><strong>TPP1:</strong> Links POT1 to TIN2, recruits telomerase</li>
                <li><strong>TIN2:</strong> Central hub connecting TRF1, TRF2, and TPP1</li>
                <li><strong>RAP1:</strong> Associates with TRF2, regulates telomere length</li>
            </ul>
            <h3>T-Loop Structure</h3>
            <p>
                The 3' single-stranded overhang folds back and invades the double-stranded telomeric DNA,
                forming a protective loop structure. This hides the chromosome end from being recognized
                as a DNA break.
            </p>
            <h3>Telomerase</h3>
            <p>
                Telomerase is a ribonucleoprotein with reverse transcriptase activity (TERT) and an RNA
                template (TERC). It adds TTAGGG repeats to the 3' end. Active in stem cells and germ cells,
                but repressed in most somatic cells. Reactivation occurs in ~90% of cancers.
            </p>
            <h3>Cellular Senescence</h3>
            <p>
                When telomeres become critically short (~2-4 kb), the DNA damage response is activated.
                Cells enter replicative senescence (Hayflick limit, ~50-70 divisions for human fibroblasts).
                Further shortening leads to crisis and cell death or, rarely, immortalization.
            </p>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let running = false;
        let animationId = null;

        // Initial telomere length (human cells start with ~10-15 kb)
        const INITIAL_LENGTH = 15000;
        const SENESCENCE_THRESHOLD = 4000;

        let state = {
            telomereLength: INITIAL_LENGTH,
            divisions: 0,
            dividing: false,
            divisionProgress: 0,
            cellStatus: 'dividing', // 'dividing', 'senescent', 'crisis'
            tloopIntact: true,
            shelterinBound: true,
            telomeraseActive: false,
            time: 0
        };

        const params = {
            telomeraseActivity: 0,
            baseLoss: 50,
            criticalLength: 2000,
            shelterinLevel: 1
        };

        function resize() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
        }

        function resetSimulation() {
            running = false;
            document.getElementById('startBtn').textContent = 'Start';

            state = {
                telomereLength: INITIAL_LENGTH,
                divisions: 0,
                dividing: false,
                divisionProgress: 0,
                cellStatus: 'dividing',
                tloopIntact: true,
                shelterinBound: true,
                telomeraseActive: false,
                time: 0
            };

            updateStats();
            draw();
        }

        function toggleSimulation() {
            running = !running;
            document.getElementById('startBtn').textContent = running ? 'Pause' : 'Start';
            if (running) animate();
        }

        function updateParams() {
            params.telomeraseActivity = parseFloat(document.getElementById('telomeraseActivity').value);
            params.baseLoss = parseFloat(document.getElementById('baseLoss').value);
            params.criticalLength = parseFloat(document.getElementById('criticalLength').value);
            params.shelterinLevel = parseFloat(document.getElementById('shelterinLevel').value);

            document.getElementById('telomeraseActivityVal').textContent = Math.round(params.telomeraseActivity * 100);
            document.getElementById('baseLossVal').textContent = params.baseLoss;
            document.getElementById('criticalLengthVal').textContent = params.criticalLength;
            document.getElementById('shelterinLevelVal').textContent = Math.round(params.shelterinLevel * 100);

            // Update telomerase activity label
            const activityLabel = params.telomeraseActivity > 0.5 ? '(stem/cancer cell)' :
                                 params.telomeraseActivity > 0 ? '(partial)' : '(somatic cell)';
            document.getElementById('telomeraseActivityVal').parentElement.innerHTML =
                `<span id="telomeraseActivityVal">${Math.round(params.telomeraseActivity * 100)}</span>% ${activityLabel}`;
        }

        document.querySelectorAll('input[type="range"]').forEach(input => {
            input.addEventListener('input', updateParams);
        });

        function triggerDivision() {
            if (state.cellStatus !== 'dividing' || state.dividing) return;
            state.dividing = true;
            state.divisionProgress = 0;
        }

        function update() {
            state.time++;

            // Cell division animation
            if (state.dividing) {
                state.divisionProgress += 0.02;

                if (state.divisionProgress >= 1) {
                    // Complete division
                    state.dividing = false;
                    state.divisionProgress = 0;
                    state.divisions++;

                    // Telomere shortening (end replication problem)
                    const loss = params.baseLoss * (1 + Math.random() * 0.3);
                    state.telomereLength -= loss;

                    // Telomerase can add bases back
                    if (params.telomeraseActivity > 0) {
                        const addBack = params.telomeraseActivity * params.baseLoss * 1.2 * (0.8 + Math.random() * 0.4);
                        state.telomereLength += addBack;
                    }

                    // Cap at initial length
                    state.telomereLength = Math.min(state.telomereLength, INITIAL_LENGTH);

                    // Check for critical shortening
                    if (state.telomereLength <= params.criticalLength) {
                        state.tloopIntact = false;
                        state.cellStatus = 'crisis';
                    } else if (state.telomereLength <= SENESCENCE_THRESHOLD) {
                        state.cellStatus = 'senescent';
                    }

                    // Shelterin can become destabilized
                    if (state.telomereLength < SENESCENCE_THRESHOLD * 1.5) {
                        state.shelterinBound = Math.random() < params.shelterinLevel;
                    }
                }
            }

            // Auto-divide if running and healthy
            if (running && state.cellStatus === 'dividing' && !state.dividing) {
                if (state.time % 120 === 0) {
                    triggerDivision();
                }
            }

            updateStats();
        }

        function updateStats() {
            document.getElementById('currentLength').textContent = Math.round(state.telomereLength);
            document.getElementById('divisions').textContent = state.divisions;

            // Estimate remaining divisions
            const remaining = Math.max(0, Math.floor((state.telomereLength - params.criticalLength) / params.baseLoss));
            document.getElementById('hayflickLimit').textContent = state.cellStatus === 'dividing' ? `~${remaining}` : 0;

            document.getElementById('tloopStatus').textContent = state.tloopIntact ? 'Intact' : 'Disrupted';

            // Update meter
            const meterPct = (state.telomereLength / INITIAL_LENGTH) * 100;
            const meter = document.getElementById('telomereMeter');
            meter.style.width = meterPct + '%';

            if (state.telomereLength > SENESCENCE_THRESHOLD) {
                meter.style.background = '#4caf50';
            } else if (state.telomereLength > params.criticalLength) {
                meter.style.background = '#ff9800';
            } else {
                meter.style.background = '#f44336';
            }

            // Update cell status display
            const statusEl = document.getElementById('cellStatus');
            statusEl.className = 'cell-status';
            if (state.cellStatus === 'dividing') {
                statusEl.classList.add('status-dividing');
                statusEl.textContent = 'ACTIVELY DIVIDING';
            } else if (state.cellStatus === 'senescent') {
                statusEl.classList.add('status-senescent');
                statusEl.textContent = 'SENESCENT (Hayflick Limit)';
            } else {
                statusEl.classList.add('status-crisis');
                statusEl.textContent = 'CRISIS / APOPTOSIS';
            }
        }

        function draw() {
            ctx.fillStyle = '#050510';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;

            // Draw chromosome end visualization
            drawChromosomeEnd(centerX, centerY);

            // Draw telomere length graph
            drawLengthHistory();

            // Labels
            ctx.fillStyle = '#aaa';
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('Telomere Structure (Chromosome End)', 20, 30);

            // Division indicator
            if (state.dividing) {
                ctx.fillStyle = '#81c784';
                ctx.font = 'bold 16px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('REPLICATING...', centerX, 60);

                // Progress bar
                ctx.fillStyle = 'rgba(129, 199, 132, 0.3)';
                ctx.fillRect(centerX - 100, 70, 200, 10);
                ctx.fillStyle = '#81c784';
                ctx.fillRect(centerX - 100, 70, 200 * state.divisionProgress, 10);
            }
        }

        function drawChromosomeEnd(cx, cy) {
            // Scale telomere visualization to length
            const lengthScale = state.telomereLength / INITIAL_LENGTH;
            const telomereVisualLength = 200 * lengthScale;

            // Draw main chromosome (subtelomeric region)
            ctx.fillStyle = '#5c6bc0';
            ctx.fillRect(cx - 250, cy - 20, 100, 40);

            // Draw telomeric DNA
            const telomereStartX = cx - 150;

            // Double helix representation
            for (let i = 0; i < telomereVisualLength; i += 4) {
                const x = telomereStartX + i;
                const waveY1 = cy - 8 + Math.sin(i * 0.1 + state.time * 0.05) * 5;
                const waveY2 = cy + 8 + Math.sin(i * 0.1 + state.time * 0.05 + Math.PI) * 5;

                // Top strand
                ctx.fillStyle = state.tloopIntact ? '#4fc3f7' : '#e57373';
                ctx.beginPath();
                ctx.arc(x, waveY1, 3, 0, Math.PI * 2);
                ctx.fill();

                // Bottom strand
                ctx.fillStyle = state.tloopIntact ? '#4fc3f7' : '#e57373';
                ctx.beginPath();
                ctx.arc(x, waveY2, 3, 0, Math.PI * 2);
                ctx.fill();

                // Base pair connections
                if (i % 12 === 0) {
                    ctx.strokeStyle = 'rgba(79, 195, 247, 0.3)';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(x, waveY1);
                    ctx.lineTo(x, waveY2);
                    ctx.stroke();
                }
            }

            // Draw 3' overhang (single-stranded)
            const overhangStart = telomereStartX + telomereVisualLength;
            ctx.strokeStyle = '#e57373';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(overhangStart, cy - 8);
            for (let i = 0; i < 40; i += 4) {
                const x = overhangStart + i;
                const y = cy - 8 + Math.sin(i * 0.15 + state.time * 0.08) * 3;
                ctx.lineTo(x, y);
            }
            ctx.stroke();

            // Draw T-loop (if intact)
            if (state.tloopIntact && lengthScale > 0.3) {
                const loopCenterX = overhangStart + 60;
                const loopCenterY = cy + 30;

                ctx.strokeStyle = 'rgba(79, 195, 247, 0.6)';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.ellipse(loopCenterX, loopCenterY, 30, 20, 0, 0, Math.PI * 2);
                ctx.stroke();

                ctx.fillStyle = '#aaa';
                ctx.font = '10px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('T-loop', loopCenterX, loopCenterY + 35);
            }

            // Draw shelterin proteins
            if (state.shelterinBound && params.shelterinLevel > 0.5) {
                const proteins = [
                    { name: 'TRF1', x: telomereStartX + telomereVisualLength * 0.2, color: '#ff9800' },
                    { name: 'TRF2', x: telomereStartX + telomereVisualLength * 0.5, color: '#ff9800' },
                    { name: 'TIN2', x: telomereStartX + telomereVisualLength * 0.35, color: '#ffc107' },
                    { name: 'POT1', x: overhangStart + 20, color: '#ffb74d' },
                    { name: 'TPP1', x: telomereStartX + telomereVisualLength * 0.7, color: '#ffe082' }
                ];

                proteins.forEach(p => {
                    if (Math.random() < params.shelterinLevel) {
                        ctx.fillStyle = p.color;
                        ctx.beginPath();
                        ctx.arc(p.x, cy - 25, 8, 0, Math.PI * 2);
                        ctx.fill();

                        ctx.fillStyle = '#000';
                        ctx.font = 'bold 6px sans-serif';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(p.name.slice(0, 3), p.x, cy - 25);
                    }
                });
            }

            // Draw telomerase (if active)
            if (params.telomeraseActivity > 0.1) {
                const telomeraseX = overhangStart + 20;
                const telomeraseY = cy - 35;

                ctx.fillStyle = `rgba(129, 199, 132, ${params.telomeraseActivity})`;
                ctx.beginPath();
                ctx.arc(telomeraseX, telomeraseY, 15, 0, Math.PI * 2);
                ctx.fill();

                ctx.strokeStyle = '#4caf50';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(telomeraseX, telomeraseY, 15, 0, Math.PI * 2);
                ctx.stroke();

                ctx.fillStyle = '#fff';
                ctx.font = 'bold 8px sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('TERT', telomeraseX, telomeraseY);

                // RNA template
                ctx.fillStyle = '#a5d6a7';
                ctx.font = '8px sans-serif';
                ctx.fillText('AAUCCC', telomeraseX, telomeraseY + 25);
            }

            // Sequence labels
            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            ctx.font = '10px monospace';
            ctx.textAlign = 'left';
            ctx.fillText('5\'-TTAGGG TTAGGG TTAGGG...', telomereStartX, cy + 50);
            ctx.fillText('3\'-AATCCC AATCCC AATCCC...', telomereStartX, cy + 65);
        }

        function drawLengthHistory() {
            // Simple representation at bottom
            const graphY = canvas.height - 80;
            const graphWidth = canvas.width - 100;

            ctx.fillStyle = '#aaa';
            ctx.font = '11px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('Telomere Length Over Divisions', 50, graphY - 60);

            // Draw axis
            ctx.strokeStyle = 'rgba(255,255,255,0.2)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(50, graphY);
            ctx.lineTo(50 + graphWidth, graphY);
            ctx.moveTo(50, graphY);
            ctx.lineTo(50, graphY - 50);
            ctx.stroke();

            // Draw current point
            const x = 50 + (state.divisions / 60) * graphWidth;
            const y = graphY - (state.telomereLength / INITIAL_LENGTH) * 50;

            ctx.fillStyle = state.cellStatus === 'dividing' ? '#4caf50' :
                           state.cellStatus === 'senescent' ? '#ff9800' : '#f44336';
            ctx.beginPath();
            ctx.arc(Math.min(x, 50 + graphWidth), y, 6, 0, Math.PI * 2);
            ctx.fill();

            // Critical threshold line
            const critY = graphY - (params.criticalLength / INITIAL_LENGTH) * 50;
            ctx.strokeStyle = 'rgba(244, 67, 54, 0.5)';
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(50, critY);
            ctx.lineTo(50 + graphWidth, critY);
            ctx.stroke();
            ctx.setLineDash([]);

            ctx.fillStyle = '#e57373';
            ctx.font = '9px sans-serif';
            ctx.fillText('Critical', 50 + graphWidth + 5, critY + 3);

            // Senescence threshold line
            const senY = graphY - (SENESCENCE_THRESHOLD / INITIAL_LENGTH) * 50;
            ctx.strokeStyle = 'rgba(255, 152, 0, 0.5)';
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(50, senY);
            ctx.lineTo(50 + graphWidth, senY);
            ctx.stroke();
            ctx.setLineDash([]);

            ctx.fillStyle = '#ffb74d';
            ctx.fillText('Senescence', 50 + graphWidth + 5, senY + 3);
        }

        function animate() {
            if (!running && !state.dividing) return;

            update();
            draw();
            animationId = requestAnimationFrame(animate);

            if (!running && !state.dividing) return;
        }

        function showModal() {
            document.getElementById('modal').classList.add('active');
        }

        function hideModal() {
            document.getElementById('modal').classList.remove('active');
        }

        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target.id === 'modal') hideModal();
        });

        window.addEventListener('resize', resize);
        resize();
        updateParams();
        draw();
    </script>


    <div id="explainModal" class="modal-overlay">
        <div class="modal">
            <button class="modal-close">&times;</button>
            <h2>üìä Telomere Dynamics</h2>
            <div class="modal-body">
                <p>Life operates through precise molecular machinery. This simulation models biochemical reactions and molecular interactions at the cellular level.</p>

                <h3>About This Simulation</h3>
                <p>Create a telomere shortening model with end replication problem and telomerase.</p>

                <h3>Key Concepts</h3>
                <ul>
                    <li><strong>Enzyme Kinetics:</strong> Enzymes catalyze reactions following Michaelis-Menten kinetics, with rates determined by substrate concentration and enzyme affinity (Km).</li>
                    <li><strong>Lock and Key vs Induced Fit:</strong> Enzymes recognize substrates either through rigid complementarity (lock-key) or conformational changes upon binding (induced fit).</li>
                    <li><strong>Allosteric Regulation:</strong> Enzyme activity modulated by molecules binding at sites other than the active site, enabling sophisticated metabolic control.</li>
                    <li><strong>Signal Transduction:</strong> Cascades of molecular interactions that amplify and transmit signals from cell surface to nucleus.</li>
                </ul>

                <h3>Why It Matters</h3>
                <p>Molecular understanding enables drug design, metabolic engineering, and synthetic biology.</p>

                <h3>How to Explore</h3>
                <ul>
                    <li>Adjust the sliders to modify simulation parameters and observe how the system responds</li>
                    <li>Look for emergent patterns that arise from agent interactions</li>
                    <li>Try extreme parameter values to find phase transitions and tipping points</li>
                    <li>Compare the simulation behavior to real-world phenomena</li>
                </ul>

                <p class="modal-category"><em>Category: Biochemistry & Molecular Biology ‚Äî Exploring molecular mechanisms and biochemical pathways</em></p>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('explainModal');
        const explainBtn = document.getElementById('explainBtn');
        if (modal && explainBtn) {
            explainBtn.addEventListener('click', function() {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            });
            modal.querySelector('.modal-close').addEventListener('click', function() {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            });
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.classList.contains('active')) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
        }
    });
    </script>

</body>
</html>
