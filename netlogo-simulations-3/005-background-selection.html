<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Background Selection - CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #e8e6e1;
            overflow: hidden;
        }
        #container { display: flex; height: 100vh; }
        #main-area { flex: 1; display: flex; flex-direction: column; padding: 20px; gap: 15px; }
        canvas { background: rgba(0,0,0,0.3); border-radius: 8px; }
        #controls { width: 300px; background: rgba(0,0,0,0.8); padding: 20px; overflow-y: auto; }
        h1 { font-size: 1.2rem; margin-bottom: 10px; color: #6366f1; }
        .description { font-size: 0.75rem; color: #888; margin-bottom: 15px; line-height: 1.4; }
        .control-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: #aaa; }
        input[type="range"] { width: 100%; margin-bottom: 5px; }
        .value-display { font-size: 0.75rem; color: #6366f1; }
        button { width: 100%; padding: 10px; margin-bottom: 10px; background: #6366f1; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: #4f46e5; }
        .stats { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; font-size: 0.8rem; margin-top: 15px; }
        .stats div { margin-bottom: 5px; }
        .stats span { color: #6366f1; }
        .back-link { position: fixed; top: 10px; left: 10px; padding: 8px 16px; background: rgba(0,0,0,0.7); color: #6366f1; text-decoration: none; border-radius: 6px; font-size: 14px; z-index: 999; }
        .legend { margin-top: 15px; font-size: 0.75rem; }
        .legend-item { display: flex; align-items: center; margin-bottom: 5px; }
        .legend-color { width: 12px; height: 12px; margin-right: 8px; border-radius: 2px; }
        .theory { background: rgba(99,102,241,0.1); padding: 10px; border-radius: 5px; font-size: 0.7rem; margin-top: 15px; border-left: 3px solid #6366f1; }
    </style>
</head>
<body>
    <a href="../netlogo-simulations/index.html" class="back-link">‚Üê Back to Simulations</a>

    <div id="container">
        <div id="main-area">
            <canvas id="genome-canvas"></canvas>
            <canvas id="diversity-canvas"></canvas>
        </div>

        <div id="controls">
            <h1>üßπ Background Selection</h1>
            <p class="description">
                Purifying selection against deleterious mutations reduces neutral diversity
                in linked regions. The tighter the linkage, the stronger the diversity reduction.
            </p>

            <div class="control-group">
                <label>Population Size: <span class="value-display" id="popValue">100</span></label>
                <input type="range" id="popSlider" min="50" max="300" value="100">
            </div>

            <div class="control-group">
                <label>Deleterious Mutation Rate: <span class="value-display" id="delMutValue">0.05</span></label>
                <input type="range" id="delMutSlider" min="0.01" max="0.2" step="0.01" value="0.05">
            </div>

            <div class="control-group">
                <label>Selection Against Deleterious: <span class="value-display" id="selValue">0.2</span></label>
                <input type="range" id="selSlider" min="0.05" max="0.5" step="0.01" value="0.2">
            </div>

            <div class="control-group">
                <label>Recombination Rate: <span class="value-display" id="recValue">0.01</span></label>
                <input type="range" id="recSlider" min="0" max="0.1" step="0.005" value="0.01">
            </div>

            <div class="control-group">
                <label>Neutral Sites: <span class="value-display" id="neutralValue">30</span></label>
                <input type="range" id="neutralSlider" min="10" max="60" value="30">
            </div>

            <button id="startBtn">Start Simulation</button>
            <button id="resetBtn">Reset</button>

            <div class="stats">
                <div>Generation: <span id="generation">0</span></div>
                <div>Neutral Diversity (œÄ): <span id="diversity">0.50</span></div>
                <div>Expected Diversity: <span id="expectedDiv">0.50</span></div>
                <div>Reduction Factor: <span id="reduction">1.00</span></div>
                <div>Del Mutations Fixed: <span id="delFixed">0</span></div>
                <div>Del Mutations Lost: <span id="delLost">0</span></div>
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #22c55e;"></div>
                    <span>Neutral sites (tracked diversity)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ef4444;"></div>
                    <span>Deleterious sites (under selection)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #6366f1;"></div>
                    <span>Observed diversity</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #fbbf24;"></div>
                    <span>Neutral expectation</span>
                </div>
            </div>

            <div class="theory">
                <strong>Background Selection:</strong> When purifying selection removes
                deleterious mutations, linked neutral variants are dragged along. This
                reduces effective population size and genetic diversity near selected sites.
            </div>
        </div>
    </div>

    <script>
        const genomeCanvas = document.getElementById('genome-canvas');
        const divCanvas = document.getElementById('diversity-canvas');
        const genomeCtx = genomeCanvas.getContext('2d');
        const divCtx = divCanvas.getContext('2d');

        function resizeCanvases() {
            const mainArea = document.getElementById('main-area');
            const w = mainArea.clientWidth - 15;
            const h = (mainArea.clientHeight - 30) / 2;
            genomeCanvas.width = divCanvas.width = w;
            genomeCanvas.height = divCanvas.height = h;
        }
        resizeCanvases();
        window.addEventListener('resize', resizeCanvases);

        let running = false;
        let generation = 0;
        let population = [];
        let diversityHistory = [];
        let delFixed = 0, delLost = 0;

        let popSize = 100;
        let delMutRate = 0.05;
        let selCoef = 0.2;
        let recRate = 0.01;
        let neutralSites = 30;
        const delSites = 10; // Fixed number of sites under selection

        // Genome: [neutral sites...][deleterious sites...]
        class Individual {
            constructor(genome = null) {
                const totalSites = neutralSites + delSites;
                if (genome) {
                    this.genome = [...genome];
                } else {
                    this.genome = new Array(totalSites).fill(0).map((_, i) =>
                        i < neutralSites ? (Math.random() < 0.5 ? 1 : 0) : 0
                    );
                }
            }

            get fitness() {
                let fit = 1;
                for (let i = neutralSites; i < this.genome.length; i++) {
                    if (this.genome[i] === 1) fit *= (1 - selCoef);
                }
                return fit;
            }

            mutate() {
                // Only deleterious sites mutate
                for (let i = neutralSites; i < this.genome.length; i++) {
                    if (this.genome[i] === 0 && Math.random() < delMutRate) {
                        this.genome[i] = 1;
                    }
                }
            }

            recombine(other) {
                const offspring = new Array(this.genome.length);
                let useThis = Math.random() < 0.5;

                for (let i = 0; i < this.genome.length; i++) {
                    if (Math.random() < recRate) useThis = !useThis;
                    offspring[i] = useThis ? this.genome[i] : other.genome[i];
                }
                return offspring;
            }
        }

        function initPopulation() {
            population = [];
            diversityHistory = [];
            delFixed = delLost = 0;

            for (let i = 0; i < popSize; i++) {
                population.push(new Individual());
            }
        }

        function calculateNeutralDiversity() {
            let totalPi = 0;
            for (let site = 0; site < neutralSites; site++) {
                let freq = 0;
                for (const ind of population) {
                    freq += ind.genome[site];
                }
                freq /= popSize;
                totalPi += 2 * freq * (1 - freq);
            }
            return totalPi / neutralSites;
        }

        function reproduce() {
            const newPop = [];
            const fitness = population.map(ind => ind.fitness);
            const totalFit = fitness.reduce((a, b) => a + b, 0);

            const selectParent = () => {
                let r = Math.random() * totalFit;
                for (let i = 0; i < population.length; i++) {
                    r -= fitness[i];
                    if (r <= 0) return population[i];
                }
                return population[population.length - 1];
            };

            while (newPop.length < popSize) {
                const p1 = selectParent();
                const p2 = selectParent();
                const offspringGenome = p1.recombine(p2);
                const offspring = new Individual(offspringGenome);
                offspring.mutate();
                newPop.push(offspring);
            }

            // Track deleterious allele fate
            for (let i = neutralSites; i < neutralSites + delSites; i++) {
                const oldFreq = population.reduce((sum, ind) => sum + ind.genome[i], 0) / popSize;
                const newFreq = newPop.reduce((sum, ind) => sum + ind.genome[i], 0) / popSize;
                if (oldFreq > 0 && newFreq === 0) delLost++;
                if (oldFreq < 1 && newFreq === 1) delFixed++;
            }

            population = newPop;
        }

        function update() {
            if (!running) return;

            generation++;
            reproduce();

            const diversity = calculateNeutralDiversity();
            diversityHistory.push(diversity);
            if (diversityHistory.length > 300) diversityHistory.shift();

            render();
            updateStats();
            requestAnimationFrame(update);
        }

        function renderGenome() {
            genomeCtx.fillStyle = 'rgba(26, 26, 46, 1)';
            genomeCtx.fillRect(0, 0, genomeCanvas.width, genomeCanvas.height);

            const padding = 30;
            const totalSites = neutralSites + delSites;
            const cellW = (genomeCanvas.width - padding * 2) / totalSites;
            const cellH = Math.min(4, (genomeCanvas.height - padding * 2) / popSize);

            genomeCtx.fillStyle = '#888';
            genomeCtx.font = '11px sans-serif';
            genomeCtx.fillText('Genome View: Neutral (green) ‚Üí Deleterious (red)', 10, 15);

            // Draw site type indicator
            for (let i = 0; i < totalSites; i++) {
                genomeCtx.fillStyle = i < neutralSites ? 'rgba(34,197,94,0.3)' : 'rgba(239,68,68,0.3)';
                genomeCtx.fillRect(padding + i * cellW, padding - 10, cellW, 8);
            }

            // Draw population genomes
            for (let p = 0; p < Math.min(popSize, 80); p++) {
                const ind = population[p];
                for (let i = 0; i < totalSites; i++) {
                    if (ind.genome[i] === 1) {
                        genomeCtx.fillStyle = i < neutralSites ? '#22c55e' : '#ef4444';
                    } else {
                        genomeCtx.fillStyle = '#1e293b';
                    }
                    genomeCtx.fillRect(
                        padding + i * cellW,
                        padding + p * cellH,
                        cellW - 0.5,
                        cellH - 0.5
                    );
                }
            }

            // Draw divider between neutral and deleterious
            genomeCtx.strokeStyle = '#fbbf24';
            genomeCtx.lineWidth = 2;
            genomeCtx.setLineDash([5, 5]);
            const divX = padding + neutralSites * cellW;
            genomeCtx.beginPath();
            genomeCtx.moveTo(divX, padding - 15);
            genomeCtx.lineTo(divX, genomeCanvas.height - 10);
            genomeCtx.stroke();
            genomeCtx.setLineDash([]);

            genomeCtx.fillStyle = '#22c55e';
            genomeCtx.fillText('Neutral', padding, genomeCanvas.height - 5);
            genomeCtx.fillStyle = '#ef4444';
            genomeCtx.fillText('Selected', divX + 5, genomeCanvas.height - 5);
        }

        function renderDiversity() {
            divCtx.fillStyle = 'rgba(26, 26, 46, 1)';
            divCtx.fillRect(0, 0, divCanvas.width, divCanvas.height);

            const padding = 40;
            const width = divCanvas.width - padding * 2;
            const height = divCanvas.height - padding * 2;

            divCtx.fillStyle = '#888';
            divCtx.font = '11px sans-serif';
            divCtx.fillText('Neutral Diversity Over Time', 10, 15);

            // Axes
            divCtx.strokeStyle = '#333';
            divCtx.beginPath();
            divCtx.moveTo(padding, padding);
            divCtx.lineTo(padding, padding + height);
            divCtx.lineTo(padding + width, padding + height);
            divCtx.stroke();

            divCtx.fillText('œÄ', padding - 15, padding + 5);
            divCtx.fillText('1.0', padding - 30, padding + 5);
            divCtx.fillText('0.0', padding - 30, padding + height);
            divCtx.fillText('Generation', padding + width / 2, padding + height + 25);

            // Expected neutral diversity line (without background selection)
            const expectedPi = 0.5; // Initial expected diversity
            const expectedY = padding + height - expectedPi * height;
            divCtx.strokeStyle = '#fbbf24';
            divCtx.setLineDash([5, 5]);
            divCtx.beginPath();
            divCtx.moveTo(padding, expectedY);
            divCtx.lineTo(padding + width, expectedY);
            divCtx.stroke();
            divCtx.setLineDash([]);
            divCtx.fillStyle = '#fbbf24';
            divCtx.fillText('Neutral expectation', padding + width - 100, expectedY - 5);

            if (diversityHistory.length < 2) return;

            // Observed diversity
            divCtx.strokeStyle = '#6366f1';
            divCtx.lineWidth = 2;
            divCtx.beginPath();

            for (let i = 0; i < diversityHistory.length; i++) {
                const x = padding + (i / diversityHistory.length) * width;
                const y = padding + height - diversityHistory[i] * height;
                if (i === 0) divCtx.moveTo(x, y);
                else divCtx.lineTo(x, y);
            }
            divCtx.stroke();

            // Current diversity marker
            const currentDiv = diversityHistory[diversityHistory.length - 1];
            const lastX = padding + width;
            const lastY = padding + height - currentDiv * height;
            divCtx.fillStyle = '#6366f1';
            divCtx.beginPath();
            divCtx.arc(lastX, lastY, 5, 0, Math.PI * 2);
            divCtx.fill();
        }

        function render() {
            renderGenome();
            renderDiversity();
        }

        function updateStats() {
            document.getElementById('generation').textContent = generation;

            const diversity = diversityHistory.length > 0 ?
                diversityHistory[diversityHistory.length - 1] : 0.5;
            document.getElementById('diversity').textContent = diversity.toFixed(4);

            const expectedDiv = 0.5;
            document.getElementById('expectedDiv').textContent = expectedDiv.toFixed(4);
            document.getElementById('reduction').textContent = (diversity / expectedDiv).toFixed(3);
            document.getElementById('delFixed').textContent = delFixed;
            document.getElementById('delLost').textContent = delLost;
        }

        document.getElementById('popSlider').addEventListener('input', (e) => {
            popSize = parseInt(e.target.value);
            document.getElementById('popValue').textContent = popSize;
        });

        document.getElementById('delMutSlider').addEventListener('input', (e) => {
            delMutRate = parseFloat(e.target.value);
            document.getElementById('delMutValue').textContent = delMutRate.toFixed(2);
        });

        document.getElementById('selSlider').addEventListener('input', (e) => {
            selCoef = parseFloat(e.target.value);
            document.getElementById('selValue').textContent = selCoef.toFixed(2);
        });

        document.getElementById('recSlider').addEventListener('input', (e) => {
            recRate = parseFloat(e.target.value);
            document.getElementById('recValue').textContent = recRate.toFixed(3);
        });

        document.getElementById('neutralSlider').addEventListener('input', (e) => {
            neutralSites = parseInt(e.target.value);
            document.getElementById('neutralValue').textContent = neutralSites;
        });

        document.getElementById('startBtn').addEventListener('click', () => {
            running = !running;
            document.getElementById('startBtn').textContent = running ? 'Pause' : 'Start Simulation';
            if (running) update();
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            running = false;
            generation = 0;
            document.getElementById('startBtn').textContent = 'Start Simulation';
            initPopulation();
            render();
            updateStats();
        });

        initPopulation();
        render();
        updateStats();
    </script>
</body>
</html>
