<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receptor Desensitization - NetLogo Simulations III</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header {
            background: rgba(0,0,0,0.3);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        h1 { color: #00d9ff; font-size: 1.5rem; }
        .back-link {
            color: #888;
            text-decoration: none;
            font-size: 0.9rem;
        }
        .back-link:hover { color: #00d9ff; }
        .main-container {
            display: flex;
            flex: 1;
            gap: 1rem;
            padding: 1rem;
            overflow: hidden;
        }
        .canvas-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        #simCanvas {
            flex: 1;
            background: #0a0a1a;
            border-radius: 8px;
            border: 1px solid #333;
        }
        .controls-panel {
            width: 320px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
        }
        .control-group { margin-bottom: 0.5rem; }
        .control-group label {
            display: block;
            margin-bottom: 0.3rem;
            color: #aaa;
            font-size: 0.85rem;
        }
        .control-group input[type="range"] {
            width: 100%;
            accent-color: #00d9ff;
        }
        .control-group .value {
            float: right;
            color: #00d9ff;
            font-weight: bold;
        }
        .btn {
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #00d9ff;
            color: #000;
        }
        .btn-primary:hover { background: #00b8d9; }
        .btn-secondary {
            background: #444;
            color: #fff;
        }
        .btn-secondary:hover { background: #555; }
        .btn-danger {
            background: #ff4757;
            color: #fff;
        }
        .btn-danger:hover { background: #ff3344; }
        .btn-row {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .stats-panel {
            background: rgba(0,100,150,0.2);
            border: 1px solid #00d9ff44;
            border-radius: 5px;
            padding: 0.8rem;
        }
        .stats-panel h3 {
            color: #00d9ff;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            margin: 0.2rem 0;
        }
        .stat-value { color: #00d9ff; font-weight: bold; }
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            font-size: 0.75rem;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: #1a1a2e;
            padding: 2rem;
            border-radius: 10px;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid #00d9ff44;
        }
        .modal-content h2 {
            color: #00d9ff;
            margin-bottom: 1rem;
        }
        .modal-content p {
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        .modal-content ul {
            margin: 1rem 0 1rem 1.5rem;
        }
        .modal-content li { margin: 0.5rem 0; }
        .close-modal {
            float: right;
            font-size: 1.5rem;
            cursor: pointer;
            color: #888;
        }
        .close-modal:hover { color: #fff; }
        .section-title {
            color: #00d9ff;
            font-size: 0.9rem;
            margin-top: 1rem;
            padding-bottom: 0.3rem;
            border-bottom: 1px solid #333;
        }
        .chart-container {
            height: 100px;
            background: rgba(0,0,0,0.3);
            border-radius: 5px;
            padding: 0.5rem;
        }
        #responseChart {
            width: 100%;
            height: 100%;
        }
    
        .explain-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            font-weight: 600;
        }
        .explain-btn:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            padding: 20px;
            overflow-y: auto;
        }
        .modal-overlay.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }
        .modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #252542 100%);
            border-radius: 20px;
            padding: 35px;
            max-width: 750px;
            width: 100%;
            margin: 40px auto;
            position: relative;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        .modal-close:hover {
            color: #fff;
            background: rgba(255,255,255,0.2);
        }
        .modal h2 {
            color: #00d9ff;
            margin-bottom: 25px;
            font-size: 1.6rem;
            padding-right: 50px;
            line-height: 1.3;
        }
        .modal-body {
            color: #d1d5db;
            line-height: 1.9;
            font-size: 1rem;
        }
        .modal-body h3 {
            color: #00ff88;
            margin: 28px 0 14px 0;
            font-size: 1.15rem;
            font-weight: 600;
        }
        .modal-body p {
            margin-bottom: 16px;
        }
        .modal-body ul {
            margin: 12px 0 18px 24px;
        }
        .modal-body li {
            margin-bottom: 10px;
        }
        .modal-body strong {
            color: #00d9ff;
        }
        .modal-body em {
            color: #a5b4fc;
            font-style: italic;
        }
        .modal-body code {
            background: rgba(0,0,0,0.3);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Fira Code', monospace;
            color: #fbbf24;
            font-size: 0.9em;
        }
        .modal-category {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <header>
        <div>
            <a href="index.html" class="back-link">‚Üê Back to Gallery</a>
            <h1>199. Receptor Desensitization</h1>
        </div>
        <div class="btn-row">
            <button class="btn btn-secondary" onclick="showExplanation()">Explain</button>
        </div>
    </header>

    <div class="main-container">
        <div class="canvas-container">
            <canvas id="simCanvas"></canvas>
        </div>

        <div class="controls-panel">
            <div class="btn-row">
                <button class="btn btn-primary" id="playPauseBtn" onclick="toggleSimulation()">Pause</button>
                <button class="btn btn-secondary" onclick="resetSimulation()">Reset</button>
                <button id="explainBtn" class="explain-btn">üìö Explain This Simulation</button>
                <button class="btn btn-danger" onclick="applyAgonist()">Apply Agonist</button>
            </div>

            <div class="control-group">
                <label>Agonist Concentration <span class="value" id="agonistVal">50%</span></label>
                <input type="range" id="agonistConc" min="0" max="100" value="50">
            </div>
            <div class="control-group">
                <label>GRK Activity <span class="value" id="grkVal">60%</span></label>
                <input type="range" id="grkActivity" min="0" max="100" value="60">
            </div>
            <div class="control-group">
                <label>Œ≤-Arrestin Level <span class="value" id="arrestinVal">50%</span></label>
                <input type="range" id="arrestinLevel" min="0" max="100" value="50">
            </div>
            <div class="control-group">
                <label>Dephosphorylation Rate <span class="value" id="dephosVal">30%</span></label>
                <input type="range" id="dephosRate" min="0" max="100" value="30">
            </div>
            <div class="control-group">
                <label>Recycling Rate <span class="value" id="recycleVal">40%</span></label>
                <input type="range" id="recycleRate" min="0" max="100" value="40">
            </div>

            <div class="section-title">Signal Response</div>
            <div class="chart-container">
                <canvas id="responseChart"></canvas>
            </div>

            <div class="stats-panel">
                <h3>Receptor States</h3>
                <div class="stat-row">
                    <span>Active (Signaling)</span>
                    <span class="stat-value" id="activeCount">0</span>
                </div>
                <div class="stat-row">
                    <span>Phosphorylated</span>
                    <span class="stat-value" id="phosphoCount">0</span>
                </div>
                <div class="stat-row">
                    <span>Arrestin-Bound</span>
                    <span class="stat-value" id="arrestinCount">0</span>
                </div>
                <div class="stat-row">
                    <span>Internalized</span>
                    <span class="stat-value" id="internalCount">0</span>
                </div>
                <div class="stat-row">
                    <span>Recycling</span>
                    <span class="stat-value" id="recycleCount">0</span>
                </div>
            </div>

            <div class="stats-panel">
                <h3>Signaling Output</h3>
                <div class="stat-row">
                    <span>cAMP Level</span>
                    <span class="stat-value" id="campLevel">0%</span>
                </div>
                <div class="stat-row">
                    <span>ERK Activation</span>
                    <span class="stat-value" id="erkLevel">0%</span>
                </div>
                <div class="stat-row">
                    <span>Desensitization</span>
                    <span class="stat-value" id="desensLevel">0%</span>
                </div>
            </div>

            <div class="legend">
                <div class="legend-item"><div class="legend-color" style="background: #888;"></div> Inactive</div>
                <div class="legend-item"><div class="legend-color" style="background: #00ff88;"></div> Active</div>
                <div class="legend-item"><div class="legend-color" style="background: #ff9900;"></div> Phosphorylated</div>
                <div class="legend-item"><div class="legend-color" style="background: #ff00ff;"></div> Arrestin-Bound</div>
                <div class="legend-item"><div class="legend-color" style="background: #ff4444;"></div> Internalized</div>
                <div class="legend-item"><div class="legend-color" style="background: #00d9ff;"></div> Recycling</div>
                <div class="legend-item"><div class="legend-color" style="background: #ffff00;"></div> GRK</div>
                <div class="legend-item"><div class="legend-color" style="background: #9944ff;"></div> Œ≤-Arrestin</div>
            </div>
        </div>
    </div>

    <div class="modal" id="explanationModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeExplanation()">&times;</span>
            <h2>Receptor Desensitization</h2>
            <p>
                This simulation models the molecular mechanisms by which G protein-coupled receptors (GPCRs)
                become desensitized following prolonged agonist exposure, a process critical for preventing
                signal overload and maintaining cellular homeostasis.
            </p>

            <h3>The Desensitization Cascade</h3>
            <ul>
                <li><strong>Receptor Activation:</strong> Agonist binding induces conformational change, enabling G-protein coupling and cAMP signaling</li>
                <li><strong>GRK Phosphorylation:</strong> G protein-coupled receptor kinases (GRK2/3 and GRK5/6) phosphorylate activated receptors at multiple C-terminal serine/threonine residues</li>
                <li><strong>Œ≤-Arrestin Binding:</strong> Phosphorylation increases receptor affinity for Œ≤-arrestins, which sterically block G-protein coupling (homologous desensitization)</li>
                <li><strong>Clathrin-Mediated Endocytosis:</strong> Œ≤-arrestins scaffold with clathrin and AP-2, stabilizing clathrin-coated pits that invaginate and pinch off via dynamin</li>
            </ul>

            <h3>GRK Isoform Specificity</h3>
            <p>
                Different GRK isoforms have distinct functional consequences:
            </p>
            <ul>
                <li><strong>GRK2/3:</strong> Bulk phosphorylation enabling Œ≤-arrestin binding and internalization</li>
                <li><strong>GRK5/6:</strong> Phosphorylation enabling Œ≤-arrestin-dependent ERK activation without promoting robust internalization</li>
            </ul>

            <h3>Three Desensitization Regimes</h3>
            <p>
                Recent kinetic modeling (2024) identified three distinct regimes determined by the balance between:
            </p>
            <ul>
                <li>Phosphorylation rate (GRK activity)</li>
                <li>Dephosphorylation rate (phosphatase activity)</li>
                <li>Cellular Œ≤-arrestin concentration</li>
            </ul>

            <h3>Receptor Fate</h3>
            <ul>
                <li><strong>Rapid Recycling:</strong> Receptors return to plasma membrane within minutes (Class A pattern)</li>
                <li><strong>Slow Recycling:</strong> Extended endosomal residence before recycling (Class B pattern)</li>
                <li><strong>Degradation:</strong> Lysosomal targeting leads to receptor downregulation</li>
            </ul>

            <h3>Clinical Relevance</h3>
            <p>
                Receptor desensitization underlies drug tolerance (e.g., opioid tolerance requires multisite phosphorylation),
                and Œ≤-arrestin dysfunction is implicated in neurodegenerative diseases including Alzheimer's and Parkinson's disease.
            </p>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const chartCanvas = document.getElementById('responseChart');
        const chartCtx = chartCanvas.getContext('2d');

        let running = true;
        let animationId = null;

        // Receptor states
        const INACTIVE = 0;
        const ACTIVE = 1;
        const PHOSPHORYLATED = 2;
        const ARRESTIN_BOUND = 3;
        const INTERNALIZED = 4;
        const RECYCLING = 5;

        // Simulation entities
        let receptors = [];
        let grks = [];
        let arrestins = [];
        let vesicles = [];
        let agonistApplied = false;
        let agonistTime = 0;

        // Signaling history for chart
        let signalHistory = [];
        const maxHistory = 150;

        // Parameters
        function getParams() {
            return {
                agonistConc: parseInt(document.getElementById('agonistConc').value) / 100,
                grkActivity: parseInt(document.getElementById('grkActivity').value) / 100,
                arrestinLevel: parseInt(document.getElementById('arrestinLevel').value) / 100,
                dephosRate: parseInt(document.getElementById('dephosRate').value) / 100,
                recycleRate: parseInt(document.getElementById('recycleRate').value) / 100
            };
        }

        function updateSliderDisplay() {
            document.getElementById('agonistVal').textContent = document.getElementById('agonistConc').value + '%';
            document.getElementById('grkVal').textContent = document.getElementById('grkActivity').value + '%';
            document.getElementById('arrestinVal').textContent = document.getElementById('arrestinLevel').value + '%';
            document.getElementById('dephosVal').textContent = document.getElementById('dephosRate').value + '%';
            document.getElementById('recycleVal').textContent = document.getElementById('recycleRate').value + '%';
        }

        document.querySelectorAll('input[type="range"]').forEach(slider => {
            slider.addEventListener('input', updateSliderDisplay);
        });

        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            chartCanvas.width = chartCanvas.parentElement.clientWidth;
            chartCanvas.height = chartCanvas.parentElement.clientHeight;
        }

        class Receptor {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.state = INACTIVE;
                this.phosphoSites = 0; // 0-4 phosphorylation sites
                this.timer = 0;
                this.internalDepth = 0; // Distance from membrane
                this.angle = Math.random() * Math.PI * 2;
                this.oscillation = Math.random() * Math.PI * 2;
            }

            getColor() {
                switch(this.state) {
                    case INACTIVE: return '#888888';
                    case ACTIVE: return '#00ff88';
                    case PHOSPHORYLATED: return '#ff9900';
                    case ARRESTIN_BOUND: return '#ff00ff';
                    case INTERNALIZED: return '#ff4444';
                    case RECYCLING: return '#00d9ff';
                    default: return '#888888';
                }
            }
        }

        class GRK {
            constructor() {
                this.x = 0;
                this.y = 0;
                this.targetReceptor = null;
                this.active = false;
            }
        }

        class Arrestin {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = canvas.height * 0.5 + Math.random() * canvas.height * 0.4;
                this.targetReceptor = null;
                this.bound = false;
                this.vx = (Math.random() - 0.5) * 2;
                this.vy = (Math.random() - 0.5) * 2;
            }
        }

        class Vesicle {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.receptors = [];
                this.targetY = canvas.height * 0.7;
                this.phase = 'descending'; // descending, endosome, ascending
                this.timer = 0;
            }
        }

        function initSimulation() {
            resizeCanvas();
            receptors = [];
            grks = [];
            arrestins = [];
            vesicles = [];
            signalHistory = [];
            agonistApplied = false;
            agonistTime = 0;

            // Create membrane receptors (top 15% of canvas)
            const membraneY = canvas.height * 0.12;
            const numReceptors = 60;
            for (let i = 0; i < numReceptors; i++) {
                const x = 50 + (canvas.width - 100) * (i / numReceptors);
                receptors.push(new Receptor(x, membraneY));
            }

            // Create GRKs
            for (let i = 0; i < 12; i++) {
                const grk = new GRK();
                grk.x = Math.random() * canvas.width;
                grk.y = canvas.height * 0.2 + Math.random() * canvas.height * 0.1;
                grks.push(grk);
            }

            // Create Œ≤-arrestins
            const params = getParams();
            const numArrestins = Math.floor(20 * params.arrestinLevel);
            for (let i = 0; i < numArrestins; i++) {
                arrestins.push(new Arrestin());
            }
        }

        function applyAgonist() {
            agonistApplied = true;
            agonistTime = Date.now();
        }

        function update() {
            const params = getParams();

            // Update arrestin count based on slider
            const targetArrestins = Math.floor(20 * params.arrestinLevel);
            while (arrestins.length < targetArrestins) {
                arrestins.push(new Arrestin());
            }
            while (arrestins.length > targetArrestins) {
                const unbound = arrestins.findIndex(a => !a.bound);
                if (unbound >= 0) arrestins.splice(unbound, 1);
                else break;
            }

            // Update receptors
            for (const receptor of receptors) {
                receptor.oscillation += 0.05;

                switch (receptor.state) {
                    case INACTIVE:
                        if (agonistApplied && Math.random() < params.agonistConc * 0.05) {
                            receptor.state = ACTIVE;
                            receptor.timer = 0;
                        }
                        break;

                    case ACTIVE:
                        receptor.timer++;
                        // GRK phosphorylation check handled in GRK update
                        // Spontaneous deactivation
                        if (Math.random() < 0.002) {
                            receptor.state = INACTIVE;
                        }
                        break;

                    case PHOSPHORYLATED:
                        receptor.timer++;
                        // Dephosphorylation
                        if (Math.random() < params.dephosRate * 0.01) {
                            receptor.phosphoSites--;
                            if (receptor.phosphoSites <= 0) {
                                receptor.state = INACTIVE;
                                receptor.phosphoSites = 0;
                            }
                        }
                        // Œ≤-arrestin binding handled in arrestin update
                        break;

                    case ARRESTIN_BOUND:
                        receptor.timer++;
                        // Clathrin-mediated endocytosis
                        if (receptor.timer > 60 && Math.random() < 0.02) {
                            receptor.state = INTERNALIZED;
                            receptor.internalDepth = 0;
                            receptor.timer = 0;
                            // Release bound arrestin
                            const boundArrestin = arrestins.find(a => a.targetReceptor === receptor);
                            if (boundArrestin) {
                                boundArrestin.bound = false;
                                boundArrestin.targetReceptor = null;
                            }
                        }
                        break;

                    case INTERNALIZED:
                        receptor.timer++;
                        receptor.internalDepth = Math.min(receptor.internalDepth + 2, canvas.height * 0.5);
                        // Transition to recycling
                        if (receptor.timer > 100 && Math.random() < params.recycleRate * 0.01) {
                            receptor.state = RECYCLING;
                            receptor.timer = 0;
                        }
                        break;

                    case RECYCLING:
                        receptor.timer++;
                        receptor.internalDepth = Math.max(receptor.internalDepth - 3, 0);
                        if (receptor.internalDepth <= 0) {
                            receptor.state = INACTIVE;
                            receptor.phosphoSites = 0;
                            receptor.y = canvas.height * 0.12;
                        }
                        break;
                }
            }

            // Update GRKs
            for (const grk of grks) {
                if (!grk.targetReceptor) {
                    // Find active receptor to phosphorylate
                    const activeReceptors = receptors.filter(r => r.state === ACTIVE);
                    if (activeReceptors.length > 0 && Math.random() < params.grkActivity * 0.1) {
                        grk.targetReceptor = activeReceptors[Math.floor(Math.random() * activeReceptors.length)];
                    }
                    // Random movement
                    grk.x += (Math.random() - 0.5) * 4;
                    grk.y += (Math.random() - 0.5) * 2;
                    grk.x = Math.max(20, Math.min(canvas.width - 20, grk.x));
                    grk.y = Math.max(canvas.height * 0.15, Math.min(canvas.height * 0.35, grk.y));
                } else {
                    // Move towards target
                    const dx = grk.targetReceptor.x - grk.x;
                    const dy = grk.targetReceptor.y - grk.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist < 15) {
                        // Phosphorylate
                        if (grk.targetReceptor.state === ACTIVE) {
                            grk.targetReceptor.phosphoSites++;
                            if (grk.targetReceptor.phosphoSites >= 2) {
                                grk.targetReceptor.state = PHOSPHORYLATED;
                            }
                        }
                        grk.targetReceptor = null;
                        grk.active = false;
                    } else {
                        grk.x += dx / dist * 3;
                        grk.y += dy / dist * 3;
                        grk.active = true;
                    }
                }
            }

            // Update Œ≤-arrestins
            for (const arrestin of arrestins) {
                if (!arrestin.bound) {
                    // Find phosphorylated receptor
                    const phosphoReceptors = receptors.filter(r =>
                        r.state === PHOSPHORYLATED && r.phosphoSites >= 2 &&
                        !arrestins.some(a => a.targetReceptor === r && a.bound)
                    );

                    if (arrestin.targetReceptor) {
                        // Move towards target
                        const dx = arrestin.targetReceptor.x - arrestin.x;
                        const dy = arrestin.targetReceptor.y - arrestin.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);

                        if (dist < 15 && arrestin.targetReceptor.state === PHOSPHORYLATED) {
                            arrestin.bound = true;
                            arrestin.targetReceptor.state = ARRESTIN_BOUND;
                            arrestin.targetReceptor.timer = 0;
                        } else if (dist > 5) {
                            arrestin.x += dx / dist * 2.5;
                            arrestin.y += dy / dist * 2.5;
                        }

                        if (arrestin.targetReceptor.state !== PHOSPHORYLATED && !arrestin.bound) {
                            arrestin.targetReceptor = null;
                        }
                    } else if (phosphoReceptors.length > 0 && Math.random() < 0.05) {
                        arrestin.targetReceptor = phosphoReceptors[Math.floor(Math.random() * phosphoReceptors.length)];
                    } else {
                        // Random movement
                        arrestin.vx += (Math.random() - 0.5) * 0.5;
                        arrestin.vy += (Math.random() - 0.5) * 0.5;
                        arrestin.vx *= 0.95;
                        arrestin.vy *= 0.95;
                        arrestin.x += arrestin.vx;
                        arrestin.y += arrestin.vy;
                        arrestin.x = Math.max(20, Math.min(canvas.width - 20, arrestin.x));
                        arrestin.y = Math.max(canvas.height * 0.2, Math.min(canvas.height * 0.9, arrestin.y));
                    }
                } else if (arrestin.targetReceptor) {
                    // Follow bound receptor
                    arrestin.x = arrestin.targetReceptor.x;
                    arrestin.y = arrestin.targetReceptor.y + arrestin.targetReceptor.internalDepth;
                }
            }

            // Calculate signal output
            const activeCount = receptors.filter(r => r.state === ACTIVE).length;
            const totalMembrane = receptors.filter(r => r.state !== INTERNALIZED && r.state !== RECYCLING).length;
            const signalLevel = totalMembrane > 0 ? activeCount / receptors.length : 0;

            // ERK activation from arrestin-bound receptors (GRK5/6 pathway)
            const arrestinBound = receptors.filter(r => r.state === ARRESTIN_BOUND).length;
            const erkSignal = arrestinBound / receptors.length * 0.5;

            // Store signal history
            signalHistory.push({
                cAMP: signalLevel,
                ERK: erkSignal,
                time: Date.now()
            });
            if (signalHistory.length > maxHistory) {
                signalHistory.shift();
            }

            // Update stats
            updateStats();
        }

        function updateStats() {
            const counts = {
                [INACTIVE]: 0,
                [ACTIVE]: 0,
                [PHOSPHORYLATED]: 0,
                [ARRESTIN_BOUND]: 0,
                [INTERNALIZED]: 0,
                [RECYCLING]: 0
            };

            for (const r of receptors) {
                counts[r.state]++;
            }

            document.getElementById('activeCount').textContent = counts[ACTIVE];
            document.getElementById('phosphoCount').textContent = counts[PHOSPHORYLATED];
            document.getElementById('arrestinCount').textContent = counts[ARRESTIN_BOUND];
            document.getElementById('internalCount').textContent = counts[INTERNALIZED];
            document.getElementById('recycleCount').textContent = counts[RECYCLING];

            const totalMembrane = counts[INACTIVE] + counts[ACTIVE] + counts[PHOSPHORYLATED] + counts[ARRESTIN_BOUND];
            const signalOutput = totalMembrane > 0 ? Math.round(counts[ACTIVE] / receptors.length * 100) : 0;
            const erkOutput = Math.round(counts[ARRESTIN_BOUND] / receptors.length * 50);
            const desens = 100 - Math.round(totalMembrane / receptors.length * 100);

            document.getElementById('campLevel').textContent = signalOutput + '%';
            document.getElementById('erkLevel').textContent = erkOutput + '%';
            document.getElementById('desensLevel').textContent = desens + '%';
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw plasma membrane
            const membraneGrad = ctx.createLinearGradient(0, 0, 0, canvas.height * 0.25);
            membraneGrad.addColorStop(0, '#664422');
            membraneGrad.addColorStop(0.5, '#886644');
            membraneGrad.addColorStop(1, '#553311');
            ctx.fillStyle = membraneGrad;
            ctx.fillRect(0, 0, canvas.width, canvas.height * 0.18);

            // Membrane phospholipid bilayer effect
            ctx.strokeStyle = '#aa8866';
            ctx.lineWidth = 1;
            for (let x = 0; x < canvas.width; x += 8) {
                ctx.beginPath();
                ctx.arc(x, canvas.height * 0.05, 3, 0, Math.PI * 2);
                ctx.stroke();
                ctx.beginPath();
                ctx.arc(x, canvas.height * 0.16, 3, Math.PI, Math.PI * 2);
                ctx.stroke();
            }

            // Draw cytoplasm gradient
            const cytoGrad = ctx.createLinearGradient(0, canvas.height * 0.18, 0, canvas.height);
            cytoGrad.addColorStop(0, '#1a1a3e');
            cytoGrad.addColorStop(1, '#0a0a2e');
            ctx.fillStyle = cytoGrad;
            ctx.fillRect(0, canvas.height * 0.18, canvas.width, canvas.height * 0.82);

            // Draw endosome region
            ctx.fillStyle = 'rgba(100, 50, 100, 0.2)';
            ctx.beginPath();
            ctx.ellipse(canvas.width / 2, canvas.height * 0.6, canvas.width * 0.35, canvas.height * 0.2, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = 'rgba(150, 80, 150, 0.3)';
            ctx.stroke();
            ctx.fillStyle = '#aa88aa';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Early Endosome', canvas.width / 2, canvas.height * 0.55);

            // Draw labels
            ctx.fillStyle = '#aa8866';
            ctx.font = '11px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('Plasma Membrane', 10, canvas.height * 0.1);
            ctx.fillStyle = '#8888aa';
            ctx.fillText('Cytoplasm', 10, canvas.height * 0.35);

            // Draw GRKs
            for (const grk of grks) {
                ctx.beginPath();
                ctx.arc(grk.x, grk.y, 6, 0, Math.PI * 2);
                ctx.fillStyle = grk.active ? '#ffff00' : '#aaaa00';
                ctx.fill();
                ctx.strokeStyle = '#ffffff44';
                ctx.stroke();
            }

            // Draw Œ≤-arrestins
            for (const arrestin of arrestins) {
                if (!arrestin.bound) {
                    ctx.beginPath();
                    ctx.moveTo(arrestin.x, arrestin.y - 8);
                    ctx.lineTo(arrestin.x - 7, arrestin.y + 5);
                    ctx.lineTo(arrestin.x + 7, arrestin.y + 5);
                    ctx.closePath();
                    ctx.fillStyle = '#9944ff';
                    ctx.fill();
                    ctx.strokeStyle = '#ffffff44';
                    ctx.stroke();
                }
            }

            // Draw receptors
            for (const receptor of receptors) {
                const displayY = receptor.y + receptor.internalDepth;
                const wobble = Math.sin(receptor.oscillation) * 2;

                // Receptor body (7-transmembrane helix representation)
                ctx.save();
                ctx.translate(receptor.x + wobble, displayY);

                // Draw 7TM receptor shape
                ctx.beginPath();
                ctx.moveTo(-8, -15);
                for (let i = 0; i < 7; i++) {
                    const x = -6 + i * 2;
                    ctx.lineTo(x, i % 2 === 0 ? -12 : 12);
                }
                ctx.lineTo(8, -15);
                ctx.closePath();

                ctx.fillStyle = receptor.getColor();
                ctx.fill();
                ctx.strokeStyle = '#ffffff33';
                ctx.lineWidth = 1;
                ctx.stroke();

                // Draw phosphorylation sites
                for (let i = 0; i < receptor.phosphoSites; i++) {
                    ctx.beginPath();
                    ctx.arc(-4 + i * 3, 15, 2, 0, Math.PI * 2);
                    ctx.fillStyle = '#ffff00';
                    ctx.fill();
                }

                // Draw bound arrestin
                if (receptor.state === ARRESTIN_BOUND) {
                    ctx.beginPath();
                    ctx.moveTo(0, 20);
                    ctx.lineTo(-7, 32);
                    ctx.lineTo(7, 32);
                    ctx.closePath();
                    ctx.fillStyle = '#9944ff';
                    ctx.fill();
                }

                ctx.restore();
            }

            // Draw agonist indicator
            if (agonistApplied) {
                const elapsed = (Date.now() - agonistTime) / 1000;
                ctx.fillStyle = `rgba(0, 255, 100, ${Math.max(0, 0.3 - elapsed * 0.02)})`;
                ctx.fillRect(0, 0, canvas.width, canvas.height * 0.18);

                ctx.fillStyle = '#00ff88';
                ctx.font = 'bold 14px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(`Agonist Applied: ${elapsed.toFixed(1)}s`, canvas.width - 15, 25);
            }

            // Draw response chart
            drawChart();
        }

        function drawChart() {
            chartCtx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);

            if (signalHistory.length < 2) return;

            const h = chartCanvas.height;
            const w = chartCanvas.width;
            const padding = 5;

            // Draw cAMP signal
            chartCtx.beginPath();
            chartCtx.strokeStyle = '#00ff88';
            chartCtx.lineWidth = 2;
            for (let i = 0; i < signalHistory.length; i++) {
                const x = padding + (i / maxHistory) * (w - padding * 2);
                const y = h - padding - signalHistory[i].cAMP * (h - padding * 2);
                if (i === 0) chartCtx.moveTo(x, y);
                else chartCtx.lineTo(x, y);
            }
            chartCtx.stroke();

            // Draw ERK signal
            chartCtx.beginPath();
            chartCtx.strokeStyle = '#ff00ff';
            chartCtx.lineWidth = 2;
            for (let i = 0; i < signalHistory.length; i++) {
                const x = padding + (i / maxHistory) * (w - padding * 2);
                const y = h - padding - signalHistory[i].ERK * (h - padding * 2);
                if (i === 0) chartCtx.moveTo(x, y);
                else chartCtx.lineTo(x, y);
            }
            chartCtx.stroke();

            // Labels
            chartCtx.font = '9px sans-serif';
            chartCtx.fillStyle = '#00ff88';
            chartCtx.textAlign = 'left';
            chartCtx.fillText('cAMP', 5, 12);
            chartCtx.fillStyle = '#ff00ff';
            chartCtx.fillText('ERK', 40, 12);
        }

        function animate() {
            if (running) {
                update();
            }
            draw();
            animationId = requestAnimationFrame(animate);
        }

        function toggleSimulation() {
            running = !running;
            document.getElementById('playPauseBtn').textContent = running ? 'Pause' : 'Play';
        }

        function resetSimulation() {
            initSimulation();
        }

        function showExplanation() {
            document.getElementById('explanationModal').classList.add('active');
        }

        function closeExplanation() {
            document.getElementById('explanationModal').classList.remove('active');
        }

        window.addEventListener('resize', resizeCanvas);
        document.getElementById('explanationModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('explanationModal')) {
                closeExplanation();
            }
        });

        initSimulation();
        animate();
    </script>


    <div id="explainModal" class="modal-overlay">
        <div class="modal">
            <button class="modal-close">&times;</button>
            <h2>üìä Receptor Desensitization</h2>
            <div class="modal-body">
                <p>Life operates through precise molecular machinery. This simulation models biochemical reactions and molecular interactions at the cellular level.</p>

                <h3>About This Simulation</h3>
                <p>Build a receptor adaptation model with phosphorylation and internalization.</p>

                <h3>Key Concepts</h3>
                <ul>
                    <li><strong>Enzyme Kinetics:</strong> Enzymes catalyze reactions following Michaelis-Menten kinetics, with rates determined by substrate concentration and enzyme affinity (Km).</li>
                    <li><strong>Lock and Key vs Induced Fit:</strong> Enzymes recognize substrates either through rigid complementarity (lock-key) or conformational changes upon binding (induced fit).</li>
                    <li><strong>Allosteric Regulation:</strong> Enzyme activity modulated by molecules binding at sites other than the active site, enabling sophisticated metabolic control.</li>
                    <li><strong>Signal Transduction:</strong> Cascades of molecular interactions that amplify and transmit signals from cell surface to nucleus.</li>
                </ul>

                <h3>Why It Matters</h3>
                <p>Molecular understanding enables drug design, metabolic engineering, and synthetic biology.</p>

                <h3>How to Explore</h3>
                <ul>
                    <li>Adjust the sliders to modify simulation parameters and observe how the system responds</li>
                    <li>Look for emergent patterns that arise from agent interactions</li>
                    <li>Try extreme parameter values to find phase transitions and tipping points</li>
                    <li>Compare the simulation behavior to real-world phenomena</li>
                </ul>

                <p class="modal-category"><em>Category: Biochemistry & Molecular Biology ‚Äî Exploring molecular mechanisms and biochemical pathways</em></p>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('explainModal');
        const explainBtn = document.getElementById('explainBtn');
        if (modal && explainBtn) {
            explainBtn.addEventListener('click', function() {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            });
            modal.querySelector('.modal-close').addEventListener('click', function() {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            });
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.classList.contains('active')) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
        }
    });
    </script>

    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
