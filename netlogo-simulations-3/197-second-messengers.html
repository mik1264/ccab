<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Second Messengers - NetLogo Simulation</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            display: flex;
            flex-direction: column;
        }
        .header {
            padding: 15px 20px;
            background: rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .header h1 { font-size: 1.4rem; color: #64ffda; }
        .back-link { color: #64ffda; text-decoration: none; font-size: 0.9rem; }
        .main-container { display: flex; flex: 1; gap: 15px; padding: 15px; }
        .canvas-container { flex: 1; background: #000; border-radius: 10px; overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; }
        .controls {
            width: 320px;
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }
        .control-group { margin-bottom: 8px; }
        .control-group label { display: block; margin-bottom: 5px; color: #8892b0; font-size: 0.85rem; }
        .control-group input[type="range"] { width: 100%; }
        .control-group .value { text-align: right; color: #64ffda; font-size: 0.8rem; }
        .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9rem; }
        .btn-primary { background: #64ffda; color: #1a1a2e; }
        .btn-secondary { background: #2a3f5f; color: #fff; }
        .btn-danger { background: #ff6b6b; color: #fff; }
        .stats { background: rgba(100,255,218,0.1); border-radius: 8px; padding: 12px; }
        .stats h3 { color: #64ffda; margin-bottom: 8px; font-size: 0.95rem; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 0.85rem; }
        .stat-label { color: #8892b0; }
        .stat-value { color: #fff; font-weight: bold; }
        .legend { display: flex; flex-wrap: wrap; gap: 8px; font-size: 0.75rem; margin-top: 10px; }
        .legend-item { display: flex; align-items: center; gap: 4px; }
        .legend-color { width: 12px; height: 12px; border-radius: 50%; }
        .button-row { display: flex; gap: 8px; }
        .button-row .btn { flex: 1; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: #1a1a2e; border-radius: 15px; padding: 25px; max-width: 600px; max-height: 80vh; overflow-y: auto; border: 1px solid #64ffda; }
        .modal-content h2 { color: #64ffda; margin-bottom: 15px; }
        .modal-content p { color: #ccc; line-height: 1.6; margin-bottom: 12px; }
        .modal-content ul { color: #ccc; margin-left: 20px; margin-bottom: 12px; }
        .modal-content li { margin-bottom: 6px; }
        .close-modal { float: right; background: none; border: none; color: #64ffda; font-size: 1.5rem; cursor: pointer; }
    </style>
</head>
<body>
    <div class="header">
        <a href="index.html" class="back-link">← Back to Gallery</a>
        <h1>197. Second Messengers</h1>
        <button class="btn btn-secondary" onclick="showExplain()">Explain</button>
    </div>

    <div class="main-container">
        <div class="canvas-container">
            <canvas id="simCanvas"></canvas>
        </div>

        <div class="controls">
            <div class="stats">
                <h3>Calcium Dynamics</h3>
                <div class="stat-row">
                    <span class="stat-label">Cytosolic [Ca²⁺]:</span>
                    <span class="stat-value" id="cytoCa">0 nM</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">ER [Ca²⁺]:</span>
                    <span class="stat-value" id="erCa">0 μM</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">[IP₃]:</span>
                    <span class="stat-value" id="ip3Level">0 μM</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Open IP₃Rs:</span>
                    <span class="stat-value" id="openIP3R">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Oscillation Freq:</span>
                    <span class="stat-value" id="oscFreq">0 Hz</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Wave Count:</span>
                    <span class="stat-value" id="waveCount">0</span>
                </div>
            </div>

            <div class="control-group">
                <label>IP₃ Concentration: <span class="value" id="ip3Val">0.5</span> μM</label>
                <input type="range" id="ip3Conc" min="0" max="100" value="50">
            </div>

            <div class="control-group">
                <label>IP₃R Sensitivity: <span class="value" id="ip3rVal">0.5</span></label>
                <input type="range" id="ip3rSensitivity" min="10" max="100" value="50">
            </div>

            <div class="control-group">
                <label>RyR Sensitivity: <span class="value" id="ryrVal">0.3</span></label>
                <input type="range" id="ryrSensitivity" min="0" max="100" value="30">
            </div>

            <div class="control-group">
                <label>SERCA Pump Rate: <span class="value" id="sercaVal">0.5</span></label>
                <input type="range" id="sercaRate" min="10" max="100" value="50">
            </div>

            <div class="control-group">
                <label>ER Store Capacity: <span class="value" id="erCapVal">100</span> μM</label>
                <input type="range" id="erCapacity" min="50" max="200" value="100">
            </div>

            <div class="button-row">
                <button class="btn btn-primary" id="startBtn" onclick="toggleSimulation()">Start</button>
                <button class="btn btn-secondary" onclick="resetSimulation()">Reset</button>
            </div>

            <div class="button-row">
                <button class="btn btn-danger" onclick="stimulate()">Stimulate</button>
                <button class="btn btn-secondary" onclick="localRelease()">Local Release</button>
            </div>

            <div class="legend">
                <div class="legend-item"><div class="legend-color" style="background:#00ff88"></div>Ca²⁺</div>
                <div class="legend-item"><div class="legend-color" style="background:#9b59b6"></div>IP₃R</div>
                <div class="legend-item"><div class="legend-color" style="background:#3498db"></div>RyR</div>
                <div class="legend-item"><div class="legend-color" style="background:#f39c12"></div>SERCA</div>
                <div class="legend-item"><div class="legend-color" style="background:#e74c3c"></div>ER Store</div>
            </div>
        </div>
    </div>

    <div class="modal" id="explainModal">
        <div class="modal-content">
            <button class="close-modal" onclick="hideExplain()">&times;</button>
            <h2>Calcium Signaling: Second Messengers</h2>
            <p><strong>Calcium ions (Ca²⁺)</strong> are universal second messengers that control processes from muscle contraction to gene transcription. Cells maintain a 10,000-fold gradient between cytosol (~100 nM) and ER/SR stores (~100 μM).</p>

            <h3 style="color:#64ffda; margin: 15px 0 10px;">Calcium Release Channels</h3>
            <ul>
                <li><strong>IP₃ Receptors (IP₃Rs):</strong> Activated by IP₃ and Ca²⁺ (biphasic); mediate oscillations</li>
                <li><strong>Ryanodine Receptors (RyRs):</strong> Ca²⁺-induced Ca²⁺ release (CICR); important in muscle</li>
            </ul>

            <h3 style="color:#64ffda; margin: 15px 0 10px;">Calcium Oscillations</h3>
            <p>IP₃R has a bell-shaped Ca²⁺ dependence:</p>
            <ul>
                <li>Low [Ca²⁺]: activates IP₃R (positive feedback)</li>
                <li>High [Ca²⁺]: inhibits IP₃R (negative feedback)</li>
                <li>This creates self-limiting Ca²⁺ spikes → oscillations</li>
            </ul>
            <p>Oscillation <strong>frequency</strong> encodes signal information (e.g., activates different transcription factors).</p>

            <h3 style="color:#64ffda; margin: 15px 0 10px;">Calcium Waves</h3>
            <p>Local Ca²⁺ release (a "puff") can trigger neighboring channels via CICR, creating waves that propagate across the cell. Wave speed depends on channel sensitivity and store content.</p>

            <h3 style="color:#64ffda; margin: 15px 0 10px;">Calcium Homeostasis</h3>
            <ul>
                <li><strong>SERCA:</strong> Pumps Ca²⁺ back into ER (ATP-dependent)</li>
                <li><strong>PMCA:</strong> Exports Ca²⁺ across plasma membrane</li>
                <li><strong>NCX:</strong> Na⁺/Ca²⁺ exchanger</li>
                <li><strong>STIM/Orai:</strong> Store-operated Ca²⁺ entry (SOCE) to refill ER</li>
            </ul>

            <h3 style="color:#64ffda; margin: 15px 0 10px;">Physiological Roles</h3>
            <ul>
                <li>Muscle contraction (cardiac, skeletal, smooth)</li>
                <li>Neurotransmitter release</li>
                <li>Gene transcription (NFAT, CREB)</li>
                <li>Fertilization (Ca²⁺ waves in oocytes)</li>
            </ul>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');

        let running = false;
        let animationId = null;

        let params = {
            ip3Conc: 0.5,
            ip3rSensitivity: 0.5,
            ryrSensitivity: 0.3,
            sercaRate: 0.5,
            erCapacity: 100
        };

        // Spatial grid for Ca²⁺ concentration
        const gridSize = 50;
        let cytoCaGrid = [];
        let erCaGrid = [];

        // Receptors
        let ip3Receptors = [];
        let ryReceptors = [];
        let sercaPumps = [];

        // Stats
        let peakTimes = [];
        let waveCount = 0;

        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }

        function initSimulation() {
            resizeCanvas();
            cytoCaGrid = [];
            erCaGrid = [];
            ip3Receptors = [];
            ryReceptors = [];
            sercaPumps = [];
            peakTimes = [];
            waveCount = 0;

            // Initialize concentration grids
            for (let i = 0; i < gridSize; i++) {
                cytoCaGrid[i] = [];
                erCaGrid[i] = [];
                for (let j = 0; j < gridSize; j++) {
                    cytoCaGrid[i][j] = 50 + Math.random() * 20; // ~50-70 nM baseline
                    erCaGrid[i][j] = params.erCapacity * 0.8; // 80% filled
                }
            }

            // Create IP3 receptors (clustered)
            const numClusters = 15;
            for (let c = 0; c < numClusters; c++) {
                const cx = Math.floor(5 + Math.random() * (gridSize - 10));
                const cy = Math.floor(5 + Math.random() * (gridSize - 10));
                for (let i = 0; i < 4; i++) {
                    ip3Receptors.push({
                        x: cx + Math.floor(Math.random() * 3 - 1),
                        y: cy + Math.floor(Math.random() * 3 - 1),
                        open: false,
                        activationState: 0, // 0-1
                        inhibitionState: 0  // 0-1 (slow inhibition)
                    });
                }
            }

            // Create RyR receptors
            for (let i = 0; i < 30; i++) {
                ryReceptors.push({
                    x: Math.floor(3 + Math.random() * (gridSize - 6)),
                    y: Math.floor(3 + Math.random() * (gridSize - 6)),
                    open: false,
                    openProbability: 0
                });
            }

            // Create SERCA pumps (distributed)
            for (let i = 2; i < gridSize - 2; i += 3) {
                for (let j = 2; j < gridSize - 2; j += 3) {
                    sercaPumps.push({ x: i, y: j });
                }
            }
        }

        function updateSimulation() {
            const dt = 0.01;

            // Update IP3 receptors
            for (const rec of ip3Receptors) {
                const ca = cytoCaGrid[rec.x][rec.y];
                const er = erCaGrid[rec.x][rec.y];

                // IP3R activation: depends on IP3 and Ca2+
                // Bell-shaped Ca2+ dependence
                const ip3Factor = params.ip3Conc / (0.3 + params.ip3Conc);
                const caActivation = ca / (100 + ca); // Activation by Ca2+
                const caInhibition = 1 / (1 + (ca / 500) ** 2); // Inhibition at high Ca2+

                // Slow inhibition builds up when open
                if (rec.open) {
                    rec.inhibitionState = Math.min(1, rec.inhibitionState + 0.02);
                } else {
                    rec.inhibitionState = Math.max(0, rec.inhibitionState - 0.01);
                }

                const openProb = ip3Factor * caActivation * caInhibition *
                                (1 - rec.inhibitionState) * params.ip3rSensitivity;

                rec.open = Math.random() < openProb && er > 10;

                // Ca2+ release through open IP3R
                if (rec.open && er > 0) {
                    const release = Math.min(er * 0.1, 20);
                    cytoCaGrid[rec.x][rec.y] += release;
                    erCaGrid[rec.x][rec.y] -= release;
                }
            }

            // Update RyR receptors (CICR)
            for (const ryr of ryReceptors) {
                const ca = cytoCaGrid[ryr.x][ryr.y];
                const er = erCaGrid[ryr.x][ryr.y];

                // RyR activation by Ca2+
                const openProb = (ca / (200 + ca)) * params.ryrSensitivity;
                ryr.open = Math.random() < openProb * 0.5 && er > 5;

                if (ryr.open && er > 0) {
                    const release = Math.min(er * 0.15, 30);
                    cytoCaGrid[ryr.x][ryr.y] += release;
                    erCaGrid[ryr.x][ryr.y] -= release;
                }
            }

            // SERCA pumps: cytosol -> ER
            for (const pump of sercaPumps) {
                const ca = cytoCaGrid[pump.x][pump.y];
                const er = erCaGrid[pump.x][pump.y];

                if (ca > 50 && er < params.erCapacity) {
                    const uptake = (ca - 50) * params.sercaRate * 0.02;
                    const actual = Math.min(uptake, ca - 30, params.erCapacity - er);
                    if (actual > 0) {
                        cytoCaGrid[pump.x][pump.y] -= actual;
                        erCaGrid[pump.x][pump.y] += actual;
                    }
                }
            }

            // Diffusion of cytosolic Ca2+
            const newGrid = [];
            for (let i = 0; i < gridSize; i++) {
                newGrid[i] = [];
                for (let j = 0; j < gridSize; j++) {
                    let sum = cytoCaGrid[i][j] * 0.8; // Self contribution
                    let count = 0.8;

                    // Neighbors
                    if (i > 0) { sum += cytoCaGrid[i-1][j] * 0.05; count += 0.05; }
                    if (i < gridSize-1) { sum += cytoCaGrid[i+1][j] * 0.05; count += 0.05; }
                    if (j > 0) { sum += cytoCaGrid[i][j-1] * 0.05; count += 0.05; }
                    if (j < gridSize-1) { sum += cytoCaGrid[i][j+1] * 0.05; count += 0.05; }

                    newGrid[i][j] = sum / count;

                    // Leak/buffering toward baseline
                    newGrid[i][j] += (50 - newGrid[i][j]) * 0.01;
                }
            }
            cytoCaGrid = newGrid;

            // ER leak (small)
            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                    const leak = erCaGrid[i][j] * 0.001;
                    erCaGrid[i][j] -= leak;
                    cytoCaGrid[i][j] += leak;
                }
            }

            // Detect waves (peaks)
            const avgCa = cytoCaGrid.flat().reduce((a, b) => a + b, 0) / (gridSize * gridSize);
            if (avgCa > 300 && (peakTimes.length === 0 || Date.now() - peakTimes[peakTimes.length - 1] > 500)) {
                peakTimes.push(Date.now());
                waveCount++;
                if (peakTimes.length > 10) peakTimes.shift();
            }

            updateStats();
        }

        function updateStats() {
            const avgCytoCa = cytoCaGrid.flat().reduce((a, b) => a + b, 0) / (gridSize * gridSize);
            const avgErCa = erCaGrid.flat().reduce((a, b) => a + b, 0) / (gridSize * gridSize);
            const openIP3Rs = ip3Receptors.filter(r => r.open).length;

            document.getElementById('cytoCa').textContent = Math.round(avgCytoCa) + ' nM';
            document.getElementById('erCa').textContent = (avgErCa / 1000).toFixed(1) + ' μM';
            document.getElementById('ip3Level').textContent = params.ip3Conc.toFixed(1) + ' μM';
            document.getElementById('openIP3R').textContent = openIP3Rs;
            document.getElementById('waveCount').textContent = waveCount;

            // Calculate frequency
            if (peakTimes.length >= 2) {
                const intervals = [];
                for (let i = 1; i < peakTimes.length; i++) {
                    intervals.push(peakTimes[i] - peakTimes[i-1]);
                }
                const avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
                const freq = 1000 / avgInterval;
                document.getElementById('oscFreq').textContent = freq.toFixed(2) + ' Hz';
            } else {
                document.getElementById('oscFreq').textContent = '0 Hz';
            }
        }

        function draw() {
            ctx.fillStyle = '#0a0a1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const cellWidth = canvas.width / gridSize;
            const cellHeight = canvas.height / gridSize;

            // Draw cytosolic Ca2+ concentration as heatmap
            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                    const ca = cytoCaGrid[i][j];
                    // Color: blue (low) -> green -> yellow -> red (high)
                    let r, g, b;
                    if (ca < 100) {
                        const t = ca / 100;
                        r = 0; g = Math.floor(t * 100); b = Math.floor(50 + t * 100);
                    } else if (ca < 500) {
                        const t = (ca - 100) / 400;
                        r = Math.floor(t * 255); g = Math.floor(100 + t * 155); b = Math.floor(150 - t * 150);
                    } else {
                        const t = Math.min(1, (ca - 500) / 500);
                        r = 255; g = Math.floor(255 - t * 200); b = 0;
                    }

                    ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;
                    ctx.fillRect(i * cellWidth, j * cellHeight, cellWidth + 1, cellHeight + 1);
                }
            }

            // Draw IP3 receptors
            for (const rec of ip3Receptors) {
                ctx.fillStyle = rec.open ? '#ff00ff' : '#9b59b6';
                ctx.beginPath();
                ctx.arc(
                    (rec.x + 0.5) * cellWidth,
                    (rec.y + 0.5) * cellHeight,
                    rec.open ? 5 : 3,
                    0, Math.PI * 2
                );
                ctx.fill();
            }

            // Draw RyR receptors
            for (const ryr of ryReceptors) {
                ctx.fillStyle = ryr.open ? '#00ffff' : '#3498db';
                ctx.beginPath();
                ctx.rect(
                    (ryr.x + 0.3) * cellWidth,
                    (ryr.y + 0.3) * cellHeight,
                    ryr.open ? 6 : 4,
                    ryr.open ? 6 : 4
                );
                ctx.fill();
            }

            // Draw ER store indicator (corner)
            const avgEr = erCaGrid.flat().reduce((a, b) => a + b, 0) / (gridSize * gridSize);
            const erFill = avgEr / params.erCapacity;
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(10, 10, 100, 20);
            ctx.fillStyle = '#e74c3c';
            ctx.fillRect(12, 12, 96 * erFill, 16);
            ctx.strokeStyle = '#fff';
            ctx.strokeRect(10, 10, 100, 20);
            ctx.fillStyle = '#fff';
            ctx.font = '10px Arial';
            ctx.fillText('ER Store', 40, 24);

            // Color scale legend
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(canvas.width - 40, 10, 30, 150);
            const gradient = ctx.createLinearGradient(0, 10, 0, 160);
            gradient.addColorStop(0, 'rgb(255, 55, 0)');
            gradient.addColorStop(0.5, 'rgb(255, 255, 0)');
            gradient.addColorStop(0.8, 'rgb(0, 100, 150)');
            gradient.addColorStop(1, 'rgb(0, 0, 50)');
            ctx.fillStyle = gradient;
            ctx.fillRect(canvas.width - 35, 15, 20, 140);
            ctx.fillStyle = '#fff';
            ctx.font = '8px Arial';
            ctx.fillText('1μM', canvas.width - 38, 25);
            ctx.fillText('100nM', canvas.width - 38, 90);
            ctx.fillText('50nM', canvas.width - 38, 155);
        }

        function animate() {
            if (running) {
                for (let i = 0; i < 3; i++) { // Multiple steps per frame
                    updateSimulation();
                }
            }
            draw();
            animationId = requestAnimationFrame(animate);
        }

        function toggleSimulation() {
            running = !running;
            document.getElementById('startBtn').textContent = running ? 'Pause' : 'Start';
        }

        function resetSimulation() {
            running = false;
            document.getElementById('startBtn').textContent = 'Start';
            initSimulation();
        }

        function stimulate() {
            // Increase IP3 to trigger oscillations
            params.ip3Conc = Math.min(2, params.ip3Conc + 0.5);
            document.getElementById('ip3Conc').value = params.ip3Conc * 100;
            document.getElementById('ip3Val').textContent = params.ip3Conc.toFixed(1);
        }

        function localRelease() {
            // Create a local Ca2+ puff
            const cx = Math.floor(gridSize / 2);
            const cy = Math.floor(gridSize / 2);
            for (let i = -2; i <= 2; i++) {
                for (let j = -2; j <= 2; j++) {
                    if (cx + i >= 0 && cx + i < gridSize && cy + j >= 0 && cy + j < gridSize) {
                        cytoCaGrid[cx + i][cy + j] += 500;
                    }
                }
            }
        }

        function showExplain() {
            document.getElementById('explainModal').classList.add('active');
        }

        function hideExplain() {
            document.getElementById('explainModal').classList.remove('active');
        }

        // Event listeners
        document.getElementById('ip3Conc').addEventListener('input', (e) => {
            params.ip3Conc = parseInt(e.target.value) / 100;
            document.getElementById('ip3Val').textContent = params.ip3Conc.toFixed(1);
        });

        document.getElementById('ip3rSensitivity').addEventListener('input', (e) => {
            params.ip3rSensitivity = parseInt(e.target.value) / 100;
            document.getElementById('ip3rVal').textContent = params.ip3rSensitivity.toFixed(1);
        });

        document.getElementById('ryrSensitivity').addEventListener('input', (e) => {
            params.ryrSensitivity = parseInt(e.target.value) / 100;
            document.getElementById('ryrVal').textContent = params.ryrSensitivity.toFixed(1);
        });

        document.getElementById('sercaRate').addEventListener('input', (e) => {
            params.sercaRate = parseInt(e.target.value) / 100;
            document.getElementById('sercaVal').textContent = params.sercaRate.toFixed(1);
        });

        document.getElementById('erCapacity').addEventListener('input', (e) => {
            params.erCapacity = parseInt(e.target.value);
            document.getElementById('erCapVal').textContent = params.erCapacity;
        });

        window.addEventListener('resize', resizeCanvas);
        initSimulation();
        animate();
    </script>
</body>
</html>
