<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limb Bud Patterning - CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a2e; color: #e8e6e1; overflow: hidden; }
        #container { display: flex; height: 100vh; }
        #main-area { flex: 1; display: flex; flex-direction: column; padding: 20px; gap: 15px; }
        canvas { background: rgba(0,0,0,0.3); border-radius: 8px; flex: 1; }
        #controls { width: 300px; background: rgba(0,0,0,0.8); padding: 20px; overflow-y: auto; }
        h1 { font-size: 1.2rem; margin-bottom: 10px; color: #22c55e; }
        .description { font-size: 0.75rem; color: #888; margin-bottom: 15px; line-height: 1.4; }
        .control-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: #aaa; }
        input[type="range"] { width: 100%; margin-bottom: 5px; }
        .value-display { font-size: 0.75rem; color: #22c55e; }
        button { width: 100%; padding: 10px; margin-bottom: 10px; background: #22c55e; color: #1a1a2e; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: #16a34a; }
        .stats { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; font-size: 0.8rem; margin-top: 15px; }
        .stats div { margin-bottom: 5px; }
        .stats span { color: #22c55e; }
        .back-link { position: fixed; top: 10px; left: 10px; padding: 8px 16px; background: rgba(0,0,0,0.7); color: #22c55e; text-decoration: none; border-radius: 6px; font-size: 14px; z-index: 999; }
        .theory { background: rgba(34,197,94,0.1); padding: 10px; border-radius: 5px; font-size: 0.7rem; margin-top: 15px; border-left: 3px solid #22c55e; }
    </style>
</head>
<body>
    <a href="../netlogo-simulations/index.html" class="back-link">← Back to Simulations</a>

    <div id="container">
        <div id="main-area">
            <canvas id="canvas"></canvas>
        </div>

        <div id="controls">
            <h1>✋ Limb Bud Patterning</h1>
            <p class="description">
                Three signaling centers pattern limb axes: AER (FGF) for proximal-distal,
                ZPA (Shh) for anterior-posterior, and dorsal ectoderm (Wnt7a) for
                dorsal-ventral. Morphogen gradients specify digit identity.
            </p>

            <div class="control-group">
                <label>FGF Level (AER): <span class="value-display" id="fgfValue">1.0</span></label>
                <input type="range" id="fgfSlider" min="0.2" max="2" step="0.1" value="1.0">
                <div style="font-size: 0.65rem; color: #666;">Promotes outgrowth</div>
            </div>

            <div class="control-group">
                <label>Shh Level (ZPA): <span class="value-display" id="shhValue">1.0</span></label>
                <input type="range" id="shhSlider" min="0.2" max="2" step="0.1" value="1.0">
                <div style="font-size: 0.65rem; color: #666;">Anterior-posterior patterning</div>
            </div>

            <div class="control-group">
                <label>Wnt7a Level: <span class="value-display" id="wntValue">1.0</span></label>
                <input type="range" id="wntSlider" min="0.2" max="2" step="0.1" value="1.0">
                <div style="font-size: 0.65rem; color: #666;">Dorsal-ventral polarity</div>
            </div>

            <div class="control-group">
                <label>Growth Rate: <span class="value-display" id="growthValue">0.5</span></label>
                <input type="range" id="growthSlider" min="0.1" max="1" step="0.1" value="0.5">
            </div>

            <button id="startBtn">Start Simulation</button>
            <button id="resetBtn">Reset</button>

            <div class="stats">
                <div>Generation: <span id="generation">0</span></div>
                <div>Limb Length: <span id="limbLength">0</span></div>
                <div>Digits Forming: <span id="digits">0</span></div>
                <div>PD Axis: <span id="pdAxis">-</span></div>
                <div>AP Axis: <span id="apAxis">-</span></div>
            </div>

            <div class="theory">
                <strong>Three Axes:</strong><br>
                • <b>Proximal-Distal:</b> FGF from AER maintains progress zone<br>
                • <b>Anterior-Posterior:</b> Shh from ZPA patterns digits (1→5)<br>
                • <b>Dorsal-Ventral:</b> Wnt7a induces Lmx1b in dorsal mesoderm<br>
                Digit identity = Shh concentration × exposure time
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            canvas.width = canvas.parentElement.clientWidth - 15;
            canvas.height = canvas.parentElement.clientHeight - 15;
        }
        resize();
        window.addEventListener('resize', resize);

        let running = false;
        let generation = 0;
        let cells = [];
        let limbLength = 20;
        const GRID_WIDTH = 40;
        const GRID_HEIGHT = 30;

        let fgfLevel = 1.0;
        let shhLevel = 1.0;
        let wntLevel = 1.0;
        let growthRate = 0.5;

        class Cell {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.fgf = 0;
                this.shh = 0;
                this.wnt = 0;
                this.digitIdentity = 0; // 0-5
                this.isLimb = false;
                this.differentiated = false;
            }

            get zone() {
                // Proximal-distal zones
                if (this.fgf > 0.7) return 'progress';
                if (this.fgf > 0.4) return 'distal';
                if (this.fgf > 0.1) return 'medial';
                return 'proximal';
            }
        }

        function initCells() {
            cells = [];
            limbLength = 20;

            for (let y = 0; y < GRID_HEIGHT; y++) {
                cells[y] = [];
                for (let x = 0; x < GRID_WIDTH; x++) {
                    cells[y][x] = new Cell(x, y);
                }
            }

            // Initialize limb bud shape
            updateLimbShape();
        }

        function updateLimbShape() {
            const centerY = GRID_HEIGHT / 2;

            for (let y = 0; y < GRID_HEIGHT; y++) {
                for (let x = 0; x < GRID_WIDTH; x++) {
                    const cell = cells[y][x];

                    // Limb bud shape (ellipse)
                    const distFromCenter = Math.abs(y - centerY);
                    const width = Math.max(0, (limbLength - x) / 3);
                    cell.isLimb = x < limbLength && distFromCenter < width;
                }
            }
        }

        function calculateMorphogens() {
            const centerY = GRID_HEIGHT / 2;

            for (let y = 0; y < GRID_HEIGHT; y++) {
                for (let x = 0; x < GRID_WIDTH; x++) {
                    const cell = cells[y][x];
                    if (!cell.isLimb) continue;

                    // FGF gradient (from distal tip - AER)
                    const distFromTip = limbLength - x;
                    cell.fgf = Math.max(0, fgfLevel * Math.exp(-distFromTip * 0.1));

                    // Shh gradient (from posterior - ZPA at posterior-distal)
                    const distFromZPA = Math.sqrt(
                        Math.pow(limbLength - 5 - x, 2) +
                        Math.pow(centerY + 5 - y, 2)
                    );
                    cell.shh = Math.max(0, shhLevel * Math.exp(-distFromZPA * 0.1));

                    // Wnt gradient (from dorsal surface)
                    const dorsalness = (centerY - y) / (GRID_HEIGHT / 2);
                    cell.wnt = wntLevel * Math.max(0, dorsalness);

                    // Digit identity based on Shh
                    if (cell.fgf < 0.3 && x > limbLength - 10) {
                        // In autopod (hand plate)
                        if (cell.shh > 0.8) cell.digitIdentity = 5;
                        else if (cell.shh > 0.6) cell.digitIdentity = 4;
                        else if (cell.shh > 0.4) cell.digitIdentity = 3;
                        else if (cell.shh > 0.2) cell.digitIdentity = 2;
                        else if (cell.shh > 0.05) cell.digitIdentity = 1;
                        else cell.digitIdentity = 0;
                    }
                }
            }
        }

        function grow() {
            if (limbLength < GRID_WIDTH - 5) {
                limbLength += growthRate * fgfLevel * 0.1;
                updateLimbShape();
            }
        }

        function update() {
            if (!running) return;

            generation++;
            grow();
            calculateMorphogens();

            render();
            updateStats();
            requestAnimationFrame(update);
        }

        function render() {
            ctx.fillStyle = 'rgba(26, 26, 46, 1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const padding = 50;
            const width = canvas.width - padding * 2;
            const height = (canvas.height - padding * 3) / 2 - 20;

            const cellWidth = width / GRID_WIDTH;
            const cellHeight = height / GRID_HEIGHT;

            // Main limb visualization
            ctx.fillStyle = '#888';
            ctx.font = '12px sans-serif';
            ctx.fillText('Limb Bud Development (color = Shh gradient, brightness = FGF)', padding, 25);

            for (let y = 0; y < GRID_HEIGHT; y++) {
                for (let x = 0; x < GRID_WIDTH; x++) {
                    const cell = cells[y][x];
                    if (!cell.isLimb) continue;

                    const px = padding + x * cellWidth;
                    const py = padding + y * cellHeight;

                    // Color by Shh (posterior = green, anterior = blue)
                    const shh = cell.shh;
                    const fgf = cell.fgf;

                    const r = Math.floor(shh * 50 + fgf * 150);
                    const g = Math.floor(shh * 200 + 55);
                    const b = Math.floor((1 - shh) * 200 + 55);

                    ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;
                    ctx.fillRect(px, py, cellWidth, cellHeight);

                    // Digit identity markers
                    if (cell.digitIdentity > 0 && x > limbLength - 8) {
                        ctx.fillStyle = '#fff';
                        ctx.font = '8px sans-serif';
                        ctx.fillText(cell.digitIdentity.toString(), px + 2, py + 10);
                    }
                }
            }

            // Signaling centers
            const centerY = padding + (GRID_HEIGHT / 2) * cellHeight;

            // AER (distal tip)
            ctx.fillStyle = '#f59e0b';
            ctx.beginPath();
            ctx.arc(padding + limbLength * cellWidth, centerY, 8, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#fff';
            ctx.font = '10px sans-serif';
            ctx.fillText('AER', padding + limbLength * cellWidth - 10, centerY + 20);

            // ZPA (posterior-distal)
            ctx.fillStyle = '#22c55e';
            ctx.beginPath();
            ctx.arc(padding + (limbLength - 5) * cellWidth, centerY + 5 * cellHeight, 8, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillText('ZPA', padding + (limbLength - 5) * cellWidth - 10, centerY + 5 * cellHeight + 20);

            // Axis labels
            ctx.fillStyle = '#888';
            ctx.fillText('← Proximal', padding, padding + height + 15);
            ctx.fillText('Distal →', padding + width - 60, padding + height + 15);
            ctx.fillText('Anterior ↑', padding - 45, centerY - 30);
            ctx.fillText('Posterior ↓', padding - 45, centerY + 40);

            // Morphogen profiles
            const chartY = padding * 2 + height + 30;
            ctx.fillText('Morphogen Gradients Along PD Axis', padding, chartY - 10);

            ctx.strokeStyle = '#444';
            ctx.beginPath();
            ctx.moveTo(padding, chartY + height / 2);
            ctx.lineTo(padding + width, chartY + height / 2);
            ctx.stroke();

            // Sample row at center
            const sampleY = Math.floor(GRID_HEIGHT / 2);

            // FGF profile
            ctx.strokeStyle = '#f59e0b';
            ctx.lineWidth = 2;
            ctx.beginPath();
            let started = false;
            for (let x = 0; x < GRID_WIDTH; x++) {
                if (cells[sampleY][x].isLimb) {
                    const px = padding + x * cellWidth;
                    const py = chartY + height / 2 - cells[sampleY][x].fgf * (height / 2 - 10);
                    if (!started) { ctx.moveTo(px, py); started = true; }
                    else ctx.lineTo(px, py);
                }
            }
            ctx.stroke();

            // Shh profile
            ctx.strokeStyle = '#22c55e';
            ctx.beginPath();
            started = false;
            for (let x = 0; x < GRID_WIDTH; x++) {
                if (cells[sampleY][x].isLimb) {
                    const px = padding + x * cellWidth;
                    const py = chartY + height / 2 - cells[sampleY][x].shh * (height / 2 - 10);
                    if (!started) { ctx.moveTo(px, py); started = true; }
                    else ctx.lineTo(px, py);
                }
            }
            ctx.stroke();

            // Legend
            ctx.fillStyle = '#f59e0b';
            ctx.fillRect(padding + 10, chartY + 10, 15, 3);
            ctx.fillStyle = '#888';
            ctx.fillText('FGF (AER)', padding + 30, chartY + 14);

            ctx.fillStyle = '#22c55e';
            ctx.fillRect(padding + 100, chartY + 10, 15, 3);
            ctx.fillText('Shh (ZPA)', padding + 120, chartY + 14);
        }

        function updateStats() {
            // Count forming digits
            let digitCells = new Set();
            for (let y = 0; y < GRID_HEIGHT; y++) {
                for (let x = 0; x < GRID_WIDTH; x++) {
                    if (cells[y][x].digitIdentity > 0) {
                        digitCells.add(cells[y][x].digitIdentity);
                    }
                }
            }

            document.getElementById('generation').textContent = generation;
            document.getElementById('limbLength').textContent = limbLength.toFixed(1);
            document.getElementById('digits').textContent = digitCells.size;
            document.getElementById('pdAxis').textContent = limbLength > 30 ? 'Stylopod→Zeugopod→Autopod' : 'Developing';
            document.getElementById('apAxis').textContent = digitCells.size > 0 ? `Digits 1-${Math.max(...digitCells)}` : 'Patterning';
        }

        document.getElementById('fgfSlider').addEventListener('input', (e) => {
            fgfLevel = parseFloat(e.target.value);
            document.getElementById('fgfValue').textContent = fgfLevel.toFixed(1);
        });

        document.getElementById('shhSlider').addEventListener('input', (e) => {
            shhLevel = parseFloat(e.target.value);
            document.getElementById('shhValue').textContent = shhLevel.toFixed(1);
        });

        document.getElementById('wntSlider').addEventListener('input', (e) => {
            wntLevel = parseFloat(e.target.value);
            document.getElementById('wntValue').textContent = wntLevel.toFixed(1);
        });

        document.getElementById('growthSlider').addEventListener('input', (e) => {
            growthRate = parseFloat(e.target.value);
            document.getElementById('growthValue').textContent = growthRate.toFixed(1);
        });

        document.getElementById('startBtn').addEventListener('click', () => {
            running = !running;
            document.getElementById('startBtn').textContent = running ? 'Pause' : 'Start Simulation';
            if (running) update();
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            running = false;
            generation = 0;
            document.getElementById('startBtn').textContent = 'Start Simulation';
            initCells();
            calculateMorphogens();
            render();
            updateStats();
        });

        initCells();
        calculateMorphogens();
        render();
        updateStats();
    </script>
</body>
</html>
