<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNA Repair Pathways - NetLogo Simulations III</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 100%);
            min-height: 100vh;
            color: #e0e0e0;
            display: flex;
        }

        .container { flex: 1; display: flex; flex-direction: column; }

        header {
            padding: 15px 25px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(100,200,255,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-link {
            color: #64b5f6;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.3s;
        }

        .back-link:hover { color: #90caf9; }

        h1 {
            font-size: 1.5rem;
            background: linear-gradient(90deg, #64b5f6, #4fc3f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .main-content { flex: 1; display: flex; overflow: hidden; }

        .canvas-container {
            flex: 1;
            position: relative;
            background: #050510;
        }

        canvas { width: 100%; height: 100%; }

        .control-panel {
            width: 320px;
            background: rgba(0,0,0,0.4);
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid rgba(100,200,255,0.2);
        }

        .panel-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .panel-section h3 {
            color: #4fc3f7;
            margin-bottom: 12px;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .control-group { margin-bottom: 12px; }

        .control-group label {
            display: block;
            font-size: 0.85rem;
            color: #aaa;
            margin-bottom: 5px;
        }

        .control-group input[type="range"] { width: 100%; margin-bottom: 3px; }

        .control-value { font-size: 0.8rem; color: #64b5f6; text-align: right; }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1976d2, #1565c0);
            color: white;
        }

        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(25,118,210,0.4); }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #e0e0e0;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn-secondary:hover { background: rgba(255,255,255,0.2); }

        .btn-damage {
            background: linear-gradient(135deg, #e53935, #c62828);
            color: white;
            font-size: 0.8rem;
            padding: 8px 12px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .stat-item {
            background: rgba(0,0,0,0.3);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value { font-size: 1.3rem; font-weight: bold; color: #4fc3f7; }
        .stat-label { font-size: 0.75rem; color: #888; margin-top: 3px; }

        .legend { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }

        .legend-item { display: flex; align-items: center; gap: 5px; font-size: 0.75rem; }

        .legend-color { width: 14px; height: 14px; border-radius: 3px; }

        .pathway-indicator {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 10px;
        }

        .pathway-bar {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pathway-name {
            font-size: 0.75rem;
            width: 40px;
            color: #aaa;
        }

        .pathway-progress {
            flex: 1;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .pathway-fill {
            height: 100%;
            transition: width 0.3s;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: #1a1a2e;
            padding: 30px;
            border-radius: 12px;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(100,200,255,0.3);
        }

        .modal-content h2 { color: #4fc3f7; margin-bottom: 15px; }
        .modal-content p { line-height: 1.7; margin-bottom: 12px; color: #ccc; }
        .modal-content ul { margin-left: 20px; margin-bottom: 12px; }
        .modal-content li { margin-bottom: 6px; color: #bbb; }

        .close-btn {
            float: right;
            background: none;
            border: none;
            color: #888;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .close-btn:hover { color: #fff; }
    
        .explain-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            font-weight: 600;
        }
        .explain-btn:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            padding: 20px;
            overflow-y: auto;
        }
        .modal-overlay.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }
        .modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #252542 100%);
            border-radius: 20px;
            padding: 35px;
            max-width: 750px;
            width: 100%;
            margin: 40px auto;
            position: relative;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        .modal-close:hover {
            color: #fff;
            background: rgba(255,255,255,0.2);
        }
        .modal h2 {
            color: #00d9ff;
            margin-bottom: 25px;
            font-size: 1.6rem;
            padding-right: 50px;
            line-height: 1.3;
        }
        .modal-body {
            color: #d1d5db;
            line-height: 1.9;
            font-size: 1rem;
        }
        .modal-body h3 {
            color: #00ff88;
            margin: 28px 0 14px 0;
            font-size: 1.15rem;
            font-weight: 600;
        }
        .modal-body p {
            margin-bottom: 16px;
        }
        .modal-body ul {
            margin: 12px 0 18px 24px;
        }
        .modal-body li {
            margin-bottom: 10px;
        }
        .modal-body strong {
            color: #00d9ff;
        }
        .modal-body em {
            color: #a5b4fc;
            font-style: italic;
        }
        .modal-body code {
            background: rgba(0,0,0,0.3);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Fira Code', monospace;
            color: #fbbf24;
            font-size: 0.9em;
        }
        .modal-category {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="index.html" class="back-link">‚Üê Back to Simulations</a>
            <h1>DNA Repair Pathways</h1>
            <button class="btn btn-secondary" onclick="showModal()">Explain</button>
        </header>

        <div class="main-content">
            <div class="canvas-container">
                <canvas id="canvas"></canvas>
            </div>

            <div class="control-panel">
                <div class="panel-section">
                    <h3>Simulation Controls</h3>
                    <button class="btn btn-primary" id="startBtn" onclick="toggleSimulation()">Start</button>
                    <button class="btn btn-secondary" onclick="resetSimulation()">Reset</button>
                <button id="explainBtn" class="explain-btn">üìö Explain This Simulation</button>
                </div>

                <div class="panel-section">
                    <h3>Induce Damage</h3>
                    <button class="btn btn-damage" onclick="induceDamage('oxidation')">Oxidation (ROS)</button>
                    <button class="btn btn-damage" onclick="induceDamage('uv')">UV Light</button>
                    <button class="btn btn-damage" onclick="induceDamage('mismatch')">Replication Error</button>
                    <button class="btn btn-damage" onclick="induceDamage('dsb')">Double-Strand Break</button>
                </div>

                <div class="panel-section">
                    <h3>Parameters</h3>

                    <div class="control-group">
                        <label>Damage Detection Rate</label>
                        <input type="range" id="detectionRate" min="0.3" max="1" step="0.05" value="0.8">
                        <div class="control-value"><span id="detectionRateVal">80</span>%</div>
                    </div>

                    <div class="control-group">
                        <label>Repair Efficiency</label>
                        <input type="range" id="repairEff" min="0.5" max="1" step="0.05" value="0.9">
                        <div class="control-value"><span id="repairEffVal">90</span>%</div>
                    </div>

                    <div class="control-group">
                        <label>HR Availability (S/G2)</label>
                        <input type="range" id="hrAvailable" min="0" max="1" step="0.1" value="0.7">
                        <div class="control-value"><span id="hrAvailableVal">70</span>%</div>
                    </div>
                </div>

                <div class="panel-section">
                    <h3>Pathway Activity</h3>
                    <div class="pathway-indicator">
                        <div class="pathway-bar">
                            <span class="pathway-name">BER</span>
                            <div class="pathway-progress">
                                <div class="pathway-fill" id="berFill" style="background: #81c784; width: 0%;"></div>
                            </div>
                        </div>
                        <div class="pathway-bar">
                            <span class="pathway-name">NER</span>
                            <div class="pathway-progress">
                                <div class="pathway-fill" id="nerFill" style="background: #64b5f6; width: 0%;"></div>
                            </div>
                        </div>
                        <div class="pathway-bar">
                            <span class="pathway-name">MMR</span>
                            <div class="pathway-progress">
                                <div class="pathway-fill" id="mmrFill" style="background: #ba68c8; width: 0%;"></div>
                            </div>
                        </div>
                        <div class="pathway-bar">
                            <span class="pathway-name">HR</span>
                            <div class="pathway-progress">
                                <div class="pathway-fill" id="hrFill" style="background: #4db6ac; width: 0%;"></div>
                            </div>
                        </div>
                        <div class="pathway-bar">
                            <span class="pathway-name">NHEJ</span>
                            <div class="pathway-progress">
                                <div class="pathway-fill" id="nhejFill" style="background: #ffb74d; width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel-section">
                    <h3>Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="damageCount">0</div>
                            <div class="stat-label">Active Damage</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="repairedCount">0</div>
                            <div class="stat-label">Repaired</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="mutationsCount">0</div>
                            <div class="stat-label">Mutations</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="fidelity">100</div>
                            <div class="stat-label">Fidelity %</div>
                        </div>
                    </div>
                </div>

                <div class="panel-section">
                    <h3>Legend</h3>
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #4fc3f7;"></div>
                            <span>Normal DNA</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #e57373;"></div>
                            <span>Oxidative Damage</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ffd54f;"></div>
                            <span>UV Lesion</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ce93d8;"></div>
                            <span>Mismatch</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ff5722;"></div>
                            <span>DSB</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #81c784;"></div>
                            <span>Repaired</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="hideModal()">&times;</button>
            <h2>DNA Repair Pathways</h2>
            <p>
                Cells possess multiple DNA repair pathways to maintain genomic integrity. Each pathway is specialized
                for different types of DNA damage, and the choice of pathway depends on the nature of the lesion and
                cell cycle stage.
            </p>
            <h3>Single-Strand Repair</h3>
            <ul>
                <li><strong>Base Excision Repair (BER):</strong> Repairs small lesions from oxidation, alkylation, or
                    deamination. Glycosylases remove damaged bases, AP endonuclease cleaves the backbone, and
                    polymerase/ligase fill the gap.</li>
                <li><strong>Nucleotide Excision Repair (NER):</strong> Repairs bulky adducts like UV-induced pyrimidine
                    dimers. Excises a ~30nt segment containing the damage and fills the gap.</li>
                <li><strong>Mismatch Repair (MMR):</strong> Corrects base-base mismatches and insertion/deletion loops
                    from replication errors. MutS/MutL homologs recognize mismatches and direct excision.</li>
            </ul>
            <h3>Double-Strand Break Repair</h3>
            <ul>
                <li><strong>Homologous Recombination (HR):</strong> Uses sister chromatid as template for error-free repair.
                    Active primarily in S/G2 phases. Involves BRCA1/2, RAD51, and extensive end resection.</li>
                <li><strong>Non-Homologous End Joining (NHEJ):</strong> Directly ligates broken ends without template.
                    Active throughout cell cycle but error-prone. Uses Ku70/80, DNA-PKcs, and ligase IV.</li>
            </ul>
            <h3>Pathway Choice</h3>
            <p>
                The choice between HR and NHEJ for DSB repair is influenced by cell cycle stage and DNA end processing.
                BRCA1 promotes HR by facilitating end resection, while 53BP1 promotes NHEJ by blocking resection.
            </p>
            <h3>Consequences of Repair Failure</h3>
            <p>
                Unrepaired or misrepaired damage leads to mutations, chromosomal aberrations, or cell death.
                Defects in repair pathways cause cancer predisposition syndromes (e.g., Lynch syndrome from MMR defects,
                hereditary breast/ovarian cancer from BRCA mutations).
            </p>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let running = false;
        let animationId = null;

        // Damage types and their repair pathways
        const DAMAGE_TYPES = {
            OXIDATION: { color: '#e57373', pathway: 'BER', name: 'Oxidation' },
            UV: { color: '#ffd54f', pathway: 'NER', name: 'UV Lesion' },
            MISMATCH: { color: '#ce93d8', pathway: 'MMR', name: 'Mismatch' },
            DSB: { color: '#ff5722', pathway: 'HR_NHEJ', name: 'DSB' }
        };

        // State
        let state = {
            damages: [],
            repairProteins: [],
            repairedCount: 0,
            mutationsCount: 0,
            pathwayActivity: { BER: 0, NER: 0, MMR: 0, HR: 0, NHEJ: 0 }
        };

        // DNA segments for visualization
        let dnaSegments = [];

        const params = {
            detectionRate: 0.8,
            repairEff: 0.9,
            hrAvailable: 0.7
        };

        function resize() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
            initDNA();
        }

        function initDNA() {
            dnaSegments = [];
            const segmentWidth = 8;
            const rows = 15;
            const segmentsPerRow = Math.ceil(canvas.width / segmentWidth);

            for (let row = 0; row < rows; row++) {
                for (let i = 0; i < segmentsPerRow; i++) {
                    dnaSegments.push({
                        x: i * segmentWidth,
                        y: 80 + row * 40,
                        width: segmentWidth,
                        state: 'normal',
                        damageType: null,
                        repairProgress: 0,
                        flashTimer: 0
                    });
                }
            }
        }

        function resetSimulation() {
            running = false;
            document.getElementById('startBtn').textContent = 'Start';

            state = {
                damages: [],
                repairProteins: [],
                repairedCount: 0,
                mutationsCount: 0,
                pathwayActivity: { BER: 0, NER: 0, MMR: 0, HR: 0, NHEJ: 0 }
            };

            initDNA();
            updateStats();
            draw();
        }

        function toggleSimulation() {
            running = !running;
            document.getElementById('startBtn').textContent = running ? 'Pause' : 'Start';
            if (running) animate();
        }

        function updateParams() {
            params.detectionRate = parseFloat(document.getElementById('detectionRate').value);
            params.repairEff = parseFloat(document.getElementById('repairEff').value);
            params.hrAvailable = parseFloat(document.getElementById('hrAvailable').value);

            document.getElementById('detectionRateVal').textContent = Math.round(params.detectionRate * 100);
            document.getElementById('repairEffVal').textContent = Math.round(params.repairEff * 100);
            document.getElementById('hrAvailableVal').textContent = Math.round(params.hrAvailable * 100);
        }

        document.querySelectorAll('input[type="range"]').forEach(input => {
            input.addEventListener('input', updateParams);
        });

        function induceDamage(type) {
            const numDamages = 5 + Math.floor(Math.random() * 10);
            const damageType = type === 'oxidation' ? DAMAGE_TYPES.OXIDATION :
                              type === 'uv' ? DAMAGE_TYPES.UV :
                              type === 'mismatch' ? DAMAGE_TYPES.MISMATCH :
                              DAMAGE_TYPES.DSB;

            for (let i = 0; i < numDamages; i++) {
                const normalSegments = dnaSegments.filter(s => s.state === 'normal');
                if (normalSegments.length === 0) break;

                const segment = normalSegments[Math.floor(Math.random() * normalSegments.length)];
                segment.state = 'damaged';
                segment.damageType = damageType;
                segment.repairProgress = 0;

                state.damages.push({
                    segment: segment,
                    type: damageType,
                    detected: false,
                    repairing: false,
                    repairPathway: null
                });
            }
        }

        function update() {
            // Reset pathway activity
            Object.keys(state.pathwayActivity).forEach(k => {
                state.pathwayActivity[k] *= 0.95;
            });

            // Process damages
            state.damages.forEach((damage, idx) => {
                if (!damage.detected) {
                    // Detection phase
                    if (Math.random() < params.detectionRate * 0.02) {
                        damage.detected = true;

                        // Choose repair pathway
                        if (damage.type.pathway === 'HR_NHEJ') {
                            // DSB: choose between HR and NHEJ based on availability
                            damage.repairPathway = Math.random() < params.hrAvailable ? 'HR' : 'NHEJ';
                        } else {
                            damage.repairPathway = damage.type.pathway;
                        }

                        // Spawn repair protein
                        state.repairProteins.push({
                            x: damage.segment.x + damage.segment.width / 2,
                            y: damage.segment.y - 30,
                            targetY: damage.segment.y,
                            damage: damage,
                            pathway: damage.repairPathway,
                            arrived: false
                        });
                    }
                } else if (damage.repairing) {
                    // Repair in progress
                    const repairSpeed = damage.repairPathway === 'HR' ? 0.005 :
                                       damage.repairPathway === 'NHEJ' ? 0.015 :
                                       damage.repairPathway === 'BER' ? 0.02 :
                                       damage.repairPathway === 'NER' ? 0.01 : 0.012;

                    damage.segment.repairProgress += repairSpeed * params.repairEff;
                    state.pathwayActivity[damage.repairPathway] += 0.1;

                    if (damage.segment.repairProgress >= 1) {
                        // Repair complete
                        const errorRate = damage.repairPathway === 'NHEJ' ? 0.1 :
                                         damage.repairPathway === 'HR' ? 0.01 :
                                         0.02;

                        if (Math.random() < errorRate * (1 - params.repairEff)) {
                            damage.segment.state = 'mutated';
                            state.mutationsCount++;
                        } else {
                            damage.segment.state = 'repaired';
                            damage.segment.flashTimer = 30;
                        }

                        state.repairedCount++;
                        state.damages.splice(idx, 1);
                    }
                }
            });

            // Update repair proteins
            state.repairProteins = state.repairProteins.filter(protein => {
                if (!protein.arrived) {
                    protein.y += 2;
                    if (protein.y >= protein.targetY) {
                        protein.arrived = true;
                        protein.damage.repairing = true;
                    }
                }
                return protein.damage.segment.state === 'damaged';
            });

            // Fade repaired segments back to normal
            dnaSegments.forEach(seg => {
                if (seg.state === 'repaired') {
                    seg.flashTimer--;
                    if (seg.flashTimer <= 0) {
                        seg.state = 'normal';
                        seg.damageType = null;
                    }
                }
            });

            // Cap pathway activity
            Object.keys(state.pathwayActivity).forEach(k => {
                state.pathwayActivity[k] = Math.min(1, state.pathwayActivity[k]);
            });

            updateStats();
        }

        function updateStats() {
            const activeDamage = state.damages.length;
            document.getElementById('damageCount').textContent = activeDamage;
            document.getElementById('repairedCount').textContent = state.repairedCount;
            document.getElementById('mutationsCount').textContent = state.mutationsCount;

            const total = state.repairedCount + state.mutationsCount;
            const fidelity = total > 0 ? ((state.repairedCount / total) * 100).toFixed(1) : '100';
            document.getElementById('fidelity').textContent = fidelity;

            // Update pathway bars
            document.getElementById('berFill').style.width = (state.pathwayActivity.BER * 100) + '%';
            document.getElementById('nerFill').style.width = (state.pathwayActivity.NER * 100) + '%';
            document.getElementById('mmrFill').style.width = (state.pathwayActivity.MMR * 100) + '%';
            document.getElementById('hrFill').style.width = (state.pathwayActivity.HR * 100) + '%';
            document.getElementById('nhejFill').style.width = (state.pathwayActivity.NHEJ * 100) + '%';
        }

        function draw() {
            ctx.fillStyle = '#050510';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw DNA double helix background pattern
            ctx.strokeStyle = 'rgba(79, 195, 247, 0.1)';
            ctx.lineWidth = 2;
            for (let y = 0; y < canvas.height; y += 60) {
                ctx.beginPath();
                for (let x = 0; x < canvas.width; x += 5) {
                    const yOffset = Math.sin(x * 0.02 + y * 0.01) * 10;
                    if (x === 0) ctx.moveTo(x, y + yOffset);
                    else ctx.lineTo(x, y + yOffset);
                }
                ctx.stroke();
            }

            // Draw DNA segments
            dnaSegments.forEach(seg => {
                let color = '#4fc3f7';

                if (seg.state === 'damaged' && seg.damageType) {
                    color = seg.damageType.color;

                    // Show repair progress
                    if (seg.repairProgress > 0) {
                        // Background (damaged)
                        ctx.fillStyle = color;
                        ctx.fillRect(seg.x, seg.y - 3, seg.width - 1, 6);

                        // Repair overlay
                        ctx.fillStyle = '#81c784';
                        ctx.fillRect(seg.x, seg.y - 3, (seg.width - 1) * seg.repairProgress, 6);
                    } else {
                        ctx.fillStyle = color;
                        ctx.fillRect(seg.x, seg.y - 3, seg.width - 1, 6);

                        // Damage glow
                        ctx.shadowColor = color;
                        ctx.shadowBlur = 10;
                        ctx.fillRect(seg.x, seg.y - 3, seg.width - 1, 6);
                        ctx.shadowBlur = 0;
                    }
                } else if (seg.state === 'repaired') {
                    ctx.fillStyle = '#81c784';
                    ctx.fillRect(seg.x, seg.y - 3, seg.width - 1, 6);

                    // Flash effect
                    if (seg.flashTimer > 20) {
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                        ctx.fillRect(seg.x, seg.y - 3, seg.width - 1, 6);
                    }
                } else if (seg.state === 'mutated') {
                    ctx.fillStyle = '#ff1744';
                    ctx.fillRect(seg.x, seg.y - 3, seg.width - 1, 6);
                } else {
                    ctx.fillStyle = color;
                    ctx.fillRect(seg.x, seg.y - 3, seg.width - 1, 6);
                }

                // Base pair connections (occasional)
                if (Math.random() < 0.05 && seg.state === 'normal') {
                    ctx.fillStyle = 'rgba(79, 195, 247, 0.2)';
                    ctx.fillRect(seg.x + 2, seg.y - 1, seg.width - 4, 2);
                }
            });

            // Draw repair proteins
            state.repairProteins.forEach(protein => {
                const colors = {
                    BER: '#81c784',
                    NER: '#64b5f6',
                    MMR: '#ba68c8',
                    HR: '#4db6ac',
                    NHEJ: '#ffb74d'
                };

                ctx.fillStyle = colors[protein.pathway] || '#fff';
                ctx.beginPath();
                ctx.arc(protein.x, protein.y, 8, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = '#000';
                ctx.font = 'bold 6px sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(protein.pathway.slice(0, 2), protein.x, protein.y);
            });

            // Title and info
            ctx.fillStyle = '#aaa';
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('DNA Repair Pathways Simulation', 20, 30);
            ctx.font = '12px sans-serif';
            ctx.fillText('Click damage buttons to induce DNA lesions', 20, 50);
        }

        function animate() {
            if (!running) return;

            update();
            draw();
            animationId = requestAnimationFrame(animate);
        }

        function showModal() {
            document.getElementById('modal').classList.add('active');
        }

        function hideModal() {
            document.getElementById('modal').classList.remove('active');
        }

        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target.id === 'modal') hideModal();
        });

        window.addEventListener('resize', resize);
        resize();
        updateParams();
        draw();
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal.classList.contains('active')) {
                modal.classList.remove('active');
            }
        });
    }

    </script>


    <div id="explainModal" class="modal-overlay">
        <div class="modal">
            <button class="modal-close">&times;</button>
            <h2>üìä DNA Repair</h2>
            <div class="modal-body">
                <p>Life operates through precise molecular machinery. This simulation models biochemical reactions and molecular interactions at the cellular level.</p>

                <h3>About This Simulation</h3>
                <p>Build DNA damage response with detection, pathway choice, and repair fidelity.</p>

                <h3>Key Concepts</h3>
                <ul>
                    <li><strong>Enzyme Kinetics:</strong> Enzymes catalyze reactions following Michaelis-Menten kinetics, with rates determined by substrate concentration and enzyme affinity (Km).</li>
                    <li><strong>Lock and Key vs Induced Fit:</strong> Enzymes recognize substrates either through rigid complementarity (lock-key) or conformational changes upon binding (induced fit).</li>
                    <li><strong>Allosteric Regulation:</strong> Enzyme activity modulated by molecules binding at sites other than the active site, enabling sophisticated metabolic control.</li>
                    <li><strong>Signal Transduction:</strong> Cascades of molecular interactions that amplify and transmit signals from cell surface to nucleus.</li>
                </ul>

                <h3>Why It Matters</h3>
                <p>Molecular understanding enables drug design, metabolic engineering, and synthetic biology.</p>

                <h3>How to Explore</h3>
                <ul>
                    <li>Adjust the sliders to modify simulation parameters and observe how the system responds</li>
                    <li>Look for emergent patterns that arise from agent interactions</li>
                    <li>Try extreme parameter values to find phase transitions and tipping points</li>
                    <li>Compare the simulation behavior to real-world phenomena</li>
                </ul>

                <p class="modal-category"><em>Category: Biochemistry & Molecular Biology ‚Äî Exploring molecular mechanisms and biochemical pathways</em></p>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('explainModal');
        const explainBtn = document.getElementById('explainBtn');
        if (modal && explainBtn) {
            explainBtn.addEventListener('click', function() {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            });
            modal.querySelector('.modal-close').addEventListener('click', function() {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            });
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.classList.contains('active')) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
        }
    });
    </script>

</body>
</html>
