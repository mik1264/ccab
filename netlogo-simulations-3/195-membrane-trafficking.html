<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Membrane Trafficking - NetLogo Simulation</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            display: flex;
            flex-direction: column;
        }
        .header {
            padding: 15px 20px;
            background: rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .header h1 { font-size: 1.4rem; color: #64ffda; }
        .back-link {
            color: #64ffda;
            text-decoration: none;
            font-size: 0.9rem;
        }
        .back-link:hover { text-decoration: underline; }
        .main-container {
            display: flex;
            flex: 1;
            gap: 15px;
            padding: 15px;
        }
        .canvas-container {
            flex: 1;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
        }
        canvas { display: block; width: 100%; height: 100%; }
        .controls {
            width: 320px;
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }
        .control-group { margin-bottom: 8px; }
        .control-group label {
            display: block;
            margin-bottom: 5px;
            color: #8892b0;
            font-size: 0.85rem;
        }
        .control-group input[type="range"] { width: 100%; cursor: pointer; }
        .control-group .value {
            text-align: right;
            color: #64ffda;
            font-size: 0.8rem;
        }
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        .btn-primary { background: #64ffda; color: #1a1a2e; }
        .btn-primary:hover { background: #4dd4b4; }
        .btn-secondary { background: #2a3f5f; color: #fff; }
        .btn-secondary:hover { background: #3a5f8f; }
        .stats {
            background: rgba(100,255,218,0.1);
            border-radius: 8px;
            padding: 12px;
        }
        .stats h3 { color: #64ffda; margin-bottom: 8px; font-size: 0.95rem; }
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 0.85rem;
        }
        .stat-label { color: #8892b0; }
        .stat-value { color: #fff; font-weight: bold; }
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 0.75rem;
            margin-top: 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .button-row {
            display: flex;
            gap: 8px;
        }
        .button-row .btn { flex: 1; }
        .modal.active { display: flex; }
        .modal-content {
            background: #1a1a2e;
            border-radius: 15px;
            padding: 25px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid #64ffda;
        }
        .modal-content h2 { color: #64ffda; margin-bottom: 15px; }
        .modal-content p { color: #ccc; line-height: 1.6; margin-bottom: 12px; }
        .modal-content ul { color: #ccc; margin-left: 20px; margin-bottom: 12px; }
        .modal-content li { margin-bottom: 6px; }
        .close-modal {
            float: right;
            background: none;
            border: none;
            color: #64ffda;
            font-size: 1.5rem;
            cursor: pointer;
        }
    
        .explain-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            font-weight: 600;
        }
        .explain-btn:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            padding: 20px;
            overflow-y: auto;
        }
        .modal-overlay.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }
        .modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #252542 100%);
            border-radius: 20px;
            padding: 35px;
            max-width: 750px;
            width: 100%;
            margin: 40px auto;
            position: relative;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        .modal-close:hover {
            color: #fff;
            background: rgba(255,255,255,0.2);
        }
        .modal h2 {
            color: #00d9ff;
            margin-bottom: 25px;
            font-size: 1.6rem;
            padding-right: 50px;
            line-height: 1.3;
        }
        .modal-body {
            color: #d1d5db;
            line-height: 1.9;
            font-size: 1rem;
        }
        .modal-body h3 {
            color: #00ff88;
            margin: 28px 0 14px 0;
            font-size: 1.15rem;
            font-weight: 600;
        }
        .modal-body p {
            margin-bottom: 16px;
        }
        .modal-body ul {
            margin: 12px 0 18px 24px;
        }
        .modal-body li {
            margin-bottom: 10px;
        }
        .modal-body strong {
            color: #00d9ff;
        }
        .modal-body em {
            color: #a5b4fc;
            font-style: italic;
        }
        .modal-body code {
            background: rgba(0,0,0,0.3);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Fira Code', monospace;
            color: #fbbf24;
            font-size: 0.9em;
        }
        .modal-category {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="index.html" class="back-link">‚Üê Back to Gallery</a>
        <h1>195. Membrane Trafficking</h1>
        <button class="btn btn-secondary" onclick="showExplain()">Explain</button>
    </div>

    <div class="main-container">
        <div class="canvas-container">
            <canvas id="simCanvas"></canvas>
        </div>

        <div class="controls">
            <div class="stats">
                <h3>Traffic Statistics</h3>
                <div class="stat-row">
                    <span class="stat-label">ER Cargo:</span>
                    <span class="stat-value" id="erCargo">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">COPII Vesicles:</span>
                    <span class="stat-value" id="copiiCount">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Golgi Cargo:</span>
                    <span class="stat-value" id="golgiCargo">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">COPI Vesicles:</span>
                    <span class="stat-value" id="copiCount">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Secreted:</span>
                    <span class="stat-value" id="secretedCount">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Retrieved:</span>
                    <span class="stat-value" id="retrievedCount">0</span>
                </div>
            </div>

            <div class="control-group">
                <label>Cargo Production: <span class="value" id="prodVal">0.3</span></label>
                <input type="range" id="production" min="0" max="100" value="30">
            </div>

            <div class="control-group">
                <label>COPII Budding Rate: <span class="value" id="copiiVal">0.5</span></label>
                <input type="range" id="copiiBudding" min="0" max="100" value="50">
            </div>

            <div class="control-group">
                <label>COPI Retrieval Rate: <span class="value" id="copiVal">0.3</span></label>
                <input type="range" id="copiRetrieval" min="0" max="100" value="30">
            </div>

            <div class="control-group">
                <label>Vesicle Speed: <span class="value" id="speedVal">2</span></label>
                <input type="range" id="vesicleSpeed" min="1" max="10" value="2">
            </div>

            <div class="control-group">
                <label>Fusion Efficiency: <span class="value" id="fusionVal">0.8</span></label>
                <input type="range" id="fusionRate" min="10" max="100" value="80">
            </div>

            <div class="button-row">
                <button class="btn btn-primary" id="startBtn" onclick="toggleSimulation()">Start</button>
                <button class="btn btn-secondary" onclick="resetSimulation()">Reset</button>
                <button id="explainBtn" class="explain-btn">üìö Explain This Simulation</button>
            </div>

            <div class="legend">
                <div class="legend-item"><div class="legend-color" style="background:#3498db"></div>ER</div>
                <div class="legend-item"><div class="legend-color" style="background:#9b59b6"></div>ERGIC</div>
                <div class="legend-item"><div class="legend-color" style="background:#f39c12"></div>Golgi</div>
                <div class="legend-item"><div class="legend-color" style="background:#64ffda"></div>COPII</div>
                <div class="legend-item"><div class="legend-color" style="background:#ff6b6b"></div>COPI</div>
                <div class="legend-item"><div class="legend-color" style="background:#00ff88"></div>Cargo</div>
            </div>
        </div>
    </div>

    <div class="modal" id="explainModal">
        <div class="modal-content">
            <button class="close-modal" onclick="hideExplain()">&times;</button>
            <h2>Membrane Trafficking</h2>
            <p>The <strong>secretory pathway</strong> transports proteins from the ER to the Golgi and onward to the plasma membrane or extracellular space. <strong>Coat proteins</strong> mediate vesicle formation and cargo selection.</p>

            <h3 style="color:#64ffda; margin: 15px 0 10px;">COPII - Anterograde Transport</h3>
            <ul>
                <li><strong>Function:</strong> ER ‚Üí ERGIC ‚Üí Golgi (forward direction)</li>
                <li><strong>GTPase:</strong> Sar1 (activated by Sec12 at ER exit sites)</li>
                <li><strong>Coat:</strong> Sec23/24 (inner) + Sec13/31 (outer cage)</li>
                <li><strong>Cargo:</strong> Newly synthesized secretory and membrane proteins</li>
            </ul>

            <h3 style="color:#64ffda; margin: 15px 0 10px;">COPI - Retrograde Transport</h3>
            <ul>
                <li><strong>Function:</strong> Golgi ‚Üí ER (backward retrieval)</li>
                <li><strong>GTPase:</strong> Arf1 (activated at Golgi membranes)</li>
                <li><strong>Coat:</strong> B-subcomplex (scaffold) + F-subcomplex (adaptor)</li>
                <li><strong>Cargo:</strong> ER-resident proteins with KDEL/HDEL signals</li>
            </ul>

            <h3 style="color:#64ffda; margin: 15px 0 10px;">Vesicle Lifecycle</h3>
            <ol style="color: #ccc; margin-left: 20px;">
                <li>GTPase activation on donor membrane</li>
                <li>Coat recruitment and cargo sorting</li>
                <li>Membrane deformation and budding</li>
                <li>Scission (pinching off)</li>
                <li>Transport along cytoskeleton</li>
                <li>Coat dissociation (GTPase hydrolysis)</li>
                <li>Tethering to acceptor membrane</li>
                <li>SNARE-mediated fusion and cargo release</li>
            </ol>

            <h3 style="color:#64ffda; margin: 15px 0 10px;">Compartments</h3>
            <ul>
                <li><strong>ER:</strong> Protein synthesis and folding</li>
                <li><strong>ERGIC:</strong> ER-Golgi intermediate compartment</li>
                <li><strong>Golgi:</strong> Post-translational modifications, sorting</li>
            </ul>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');

        let running = false;
        let animationId = null;

        let params = {
            production: 0.3,
            copiiBudding: 0.5,
            copiRetrieval: 0.3,
            vesicleSpeed: 2,
            fusionRate: 0.8
        };

        // Compartments
        let er = { x: 0, y: 0, width: 0, height: 0, cargo: [] };
        let ergic = { x: 0, y: 0, width: 0, height: 0, cargo: [] };
        let golgi = { cisternae: [], cargo: [] };
        let vesicles = [];

        let stats = {
            secreted: 0,
            retrieved: 0
        };

        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            setupCompartments();
        }

        function setupCompartments() {
            // ER - bottom region
            er.x = 50;
            er.y = canvas.height - 150;
            er.width = canvas.width - 100;
            er.height = 100;

            // ERGIC - middle region
            ergic.x = canvas.width / 2 - 60;
            ergic.y = canvas.height / 2;
            ergic.width = 120;
            ergic.height = 60;

            // Golgi cisternae - top region (stacked)
            golgi.cisternae = [];
            const golgiX = canvas.width / 2;
            const golgiY = 120;
            for (let i = 0; i < 5; i++) {
                golgi.cisternae.push({
                    x: golgiX,
                    y: golgiY + i * 25,
                    width: 200 - i * 20,
                    height: 20,
                    type: i < 2 ? 'cis' : (i < 4 ? 'medial' : 'trans')
                });
            }
        }

        function initSimulation() {
            resizeCanvas();
            er.cargo = [];
            ergic.cargo = [];
            golgi.cargo = [];
            vesicles = [];
            stats = { secreted: 0, retrieved: 0 };

            // Initial cargo in ER
            for (let i = 0; i < 10; i++) {
                er.cargo.push(createCargo('secretory'));
            }
        }

        function createCargo(type) {
            return {
                x: er.x + 20 + Math.random() * (er.width - 40),
                y: er.y + 10 + Math.random() * (er.height - 20),
                type: type, // 'secretory' or 'resident'
                hasKDEL: type === 'resident'
            };
        }

        function createVesicle(x, y, coatType, cargo, target) {
            return {
                x: x,
                y: y,
                radius: 12,
                coatType: coatType, // 'COPII' or 'COPI'
                cargo: cargo,
                target: target,
                coated: true,
                state: 'budding', // budding, transport, tethering, fusing
                progress: 0
            };
        }

        function updateSimulation() {
            // Cargo production in ER
            if (Math.random() < params.production * 0.05) {
                const type = Math.random() < 0.2 ? 'resident' : 'secretory';
                er.cargo.push(createCargo(type));
            }

            // COPII budding from ER
            if (er.cargo.length > 0 && Math.random() < params.copiiBudding * 0.03) {
                // Select cargo for COPII vesicle
                const secretoryCargo = er.cargo.filter(c => c.type === 'secretory');
                if (secretoryCargo.length > 0) {
                    const numCargo = Math.min(3, secretoryCargo.length);
                    const selectedCargo = [];
                    for (let i = 0; i < numCargo; i++) {
                        const idx = er.cargo.indexOf(secretoryCargo[i]);
                        if (idx > -1) {
                            selectedCargo.push(er.cargo.splice(idx, 1)[0]);
                        }
                    }

                    // Create COPII vesicle
                    const budX = er.x + 50 + Math.random() * (er.width - 100);
                    vesicles.push(createVesicle(budX, er.y, 'COPII', selectedCargo, 'ergic'));
                }
            }

            // COPI budding from Golgi (retrieval)
            if (golgi.cargo.length > 0 && Math.random() < params.copiRetrieval * 0.03) {
                const residentCargo = golgi.cargo.filter(c => c.hasKDEL);
                if (residentCargo.length > 0) {
                    const cargo = residentCargo[0];
                    const idx = golgi.cargo.indexOf(cargo);
                    if (idx > -1) {
                        golgi.cargo.splice(idx, 1);
                        const cis = golgi.cisternae[0];
                        vesicles.push(createVesicle(cis.x, cis.y + cis.height, 'COPI', [cargo], 'er'));
                    }
                }
            }

            // Update vesicles
            for (let i = vesicles.length - 1; i >= 0; i--) {
                const v = vesicles[i];

                if (v.state === 'budding') {
                    v.progress += 0.05;
                    if (v.progress >= 1) {
                        v.state = 'transport';
                        v.progress = 0;
                    }
                } else if (v.state === 'transport') {
                    // Move toward target
                    let targetX, targetY;
                    if (v.target === 'ergic') {
                        targetX = ergic.x + ergic.width / 2;
                        targetY = ergic.y + ergic.height / 2;
                    } else if (v.target === 'golgi') {
                        targetX = golgi.cisternae[0].x;
                        targetY = golgi.cisternae[0].y;
                    } else if (v.target === 'er') {
                        targetX = er.x + er.width / 2;
                        targetY = er.y;
                    } else if (v.target === 'secretion') {
                        targetY = -20;
                        targetX = v.x;
                    }

                    const dx = targetX - v.x;
                    const dy = targetY - v.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist > params.vesicleSpeed) {
                        v.x += (dx / dist) * params.vesicleSpeed;
                        v.y += (dy / dist) * params.vesicleSpeed;
                    } else {
                        v.state = 'tethering';
                        v.coated = false; // Coat dissociation
                    }
                } else if (v.state === 'tethering') {
                    v.progress += 0.1;
                    if (v.progress >= 1) {
                        v.state = 'fusing';
                        v.progress = 0;
                    }
                } else if (v.state === 'fusing') {
                    v.progress += 0.1 * params.fusionRate;
                    if (v.progress >= 1) {
                        // Fusion complete - deliver cargo
                        if (v.target === 'ergic') {
                            ergic.cargo.push(...v.cargo);
                        } else if (v.target === 'golgi') {
                            golgi.cargo.push(...v.cargo);
                        } else if (v.target === 'er') {
                            er.cargo.push(...v.cargo);
                            stats.retrieved++;
                        } else if (v.target === 'secretion') {
                            stats.secreted += v.cargo.length;
                        }
                        vesicles.splice(i, 1);
                    }
                }
            }

            // ERGIC to Golgi traffic
            if (ergic.cargo.length > 0 && Math.random() < 0.05) {
                const cargo = ergic.cargo.shift();
                vesicles.push(createVesicle(ergic.x + ergic.width / 2, ergic.y, 'COPII', [cargo], 'golgi'));
            }

            // Golgi processing and secretion
            if (golgi.cargo.length > 0 && Math.random() < 0.02) {
                const secretoryCargo = golgi.cargo.filter(c => !c.hasKDEL);
                if (secretoryCargo.length > 0) {
                    const cargo = secretoryCargo[0];
                    const idx = golgi.cargo.indexOf(cargo);
                    if (idx > -1) {
                        golgi.cargo.splice(idx, 1);
                        const trans = golgi.cisternae[golgi.cisternae.length - 1];
                        vesicles.push(createVesicle(trans.x, trans.y - 10, 'secretory', [cargo], 'secretion'));
                    }
                }
            }

            // Update cargo positions within compartments
            updateCargoPositions();
            updateStats();
        }

        function updateCargoPositions() {
            // Jiggle cargo in ER
            for (const c of er.cargo) {
                c.x += (Math.random() - 0.5) * 2;
                c.y += (Math.random() - 0.5) * 1;
                c.x = Math.max(er.x + 10, Math.min(er.x + er.width - 10, c.x));
                c.y = Math.max(er.y + 10, Math.min(er.y + er.height - 10, c.y));
            }

            // Cargo in ERGIC
            for (let i = 0; i < ergic.cargo.length; i++) {
                const c = ergic.cargo[i];
                c.x = ergic.x + 20 + (i % 4) * 25;
                c.y = ergic.y + 20 + Math.floor(i / 4) * 20;
            }

            // Cargo in Golgi
            for (let i = 0; i < golgi.cargo.length; i++) {
                const c = golgi.cargo[i];
                const cisIdx = Math.min(Math.floor(i / 4), golgi.cisternae.length - 1);
                const cis = golgi.cisternae[cisIdx];
                c.x = cis.x - cis.width / 2 + 20 + (i % 4) * 30;
                c.y = cis.y + 5;
            }
        }

        function updateStats() {
            document.getElementById('erCargo').textContent = er.cargo.length;
            document.getElementById('copiiCount').textContent =
                vesicles.filter(v => v.coatType === 'COPII').length;
            document.getElementById('golgiCargo').textContent = golgi.cargo.length;
            document.getElementById('copiCount').textContent =
                vesicles.filter(v => v.coatType === 'COPI').length;
            document.getElementById('secretedCount').textContent = stats.secreted;
            document.getElementById('retrievedCount').textContent = stats.retrieved;
        }

        function draw() {
            ctx.fillStyle = '#0a0a1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw ER
            ctx.fillStyle = 'rgba(52, 152, 219, 0.3)';
            ctx.strokeStyle = '#3498db';
            ctx.lineWidth = 3;

            // ER network shape
            ctx.beginPath();
            ctx.moveTo(er.x, er.y + er.height);
            for (let x = er.x; x < er.x + er.width; x += 30) {
                const y = er.y + Math.sin(x / 20 + Date.now() / 1000) * 15;
                ctx.lineTo(x, y);
            }
            ctx.lineTo(er.x + er.width, er.y + er.height);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            // ER label
            ctx.fillStyle = '#3498db';
            ctx.font = 'bold 14px Arial';
            ctx.fillText('Endoplasmic Reticulum', er.x + 10, er.y + er.height - 10);

            // ER Exit Sites
            ctx.fillStyle = 'rgba(100, 255, 218, 0.5)';
            for (let x = er.x + 80; x < er.x + er.width - 80; x += 100) {
                ctx.beginPath();
                ctx.arc(x, er.y + 20, 15, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#64ffda';
                ctx.font = '8px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ERES', x, er.y + 23);
                ctx.fillStyle = 'rgba(100, 255, 218, 0.5)';
            }

            // Draw ERGIC
            ctx.fillStyle = 'rgba(155, 89, 182, 0.4)';
            ctx.strokeStyle = '#9b59b6';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.roundRect(ergic.x, ergic.y, ergic.width, ergic.height, 10);
            ctx.fill();
            ctx.stroke();
            ctx.fillStyle = '#9b59b6';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('ERGIC', ergic.x + ergic.width / 2, ergic.y + ergic.height / 2 + 4);

            // Draw Golgi cisternae
            for (let i = 0; i < golgi.cisternae.length; i++) {
                const cis = golgi.cisternae[i];
                let color;
                if (cis.type === 'cis') color = 'rgba(241, 196, 15, 0.5)';
                else if (cis.type === 'medial') color = 'rgba(230, 126, 34, 0.5)';
                else color = 'rgba(211, 84, 0, 0.5)';

                ctx.fillStyle = color;
                ctx.beginPath();
                // Curved cisterna shape
                ctx.ellipse(cis.x, cis.y + cis.height / 2, cis.width / 2, cis.height / 2, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = cis.type === 'cis' ? '#f1c40f' :
                                 cis.type === 'medial' ? '#e67e22' : '#d35400';
                ctx.lineWidth = 2;
                ctx.stroke();
            }

            // Golgi labels
            ctx.fillStyle = '#f39c12';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Golgi Apparatus', golgi.cisternae[2].x, golgi.cisternae[0].y - 20);
            ctx.font = '10px Arial';
            ctx.fillText('cis', golgi.cisternae[0].x + golgi.cisternae[0].width / 2 + 20, golgi.cisternae[0].y + 10);
            ctx.fillText('trans', golgi.cisternae[4].x + golgi.cisternae[4].width / 2 + 20, golgi.cisternae[4].y + 10);

            // Draw cargo in ER
            for (const c of er.cargo) {
                ctx.fillStyle = c.hasKDEL ? '#ff6b6b' : '#00ff88';
                ctx.beginPath();
                ctx.arc(c.x, c.y, 4, 0, Math.PI * 2);
                ctx.fill();
            }

            // Draw cargo in ERGIC
            for (const c of ergic.cargo) {
                ctx.fillStyle = c.hasKDEL ? '#ff6b6b' : '#00ff88';
                ctx.beginPath();
                ctx.arc(c.x, c.y, 4, 0, Math.PI * 2);
                ctx.fill();
            }

            // Draw cargo in Golgi
            for (const c of golgi.cargo) {
                ctx.fillStyle = c.hasKDEL ? '#ff6b6b' : '#00ff88';
                ctx.beginPath();
                ctx.arc(c.x, c.y, 4, 0, Math.PI * 2);
                ctx.fill();
            }

            // Draw vesicles
            for (const v of vesicles) {
                // Vesicle membrane
                if (v.coatType === 'COPII') {
                    ctx.fillStyle = v.coated ? 'rgba(100, 255, 218, 0.6)' : 'rgba(100, 255, 218, 0.3)';
                    ctx.strokeStyle = '#64ffda';
                } else if (v.coatType === 'COPI') {
                    ctx.fillStyle = v.coated ? 'rgba(255, 107, 107, 0.6)' : 'rgba(255, 107, 107, 0.3)';
                    ctx.strokeStyle = '#ff6b6b';
                } else {
                    ctx.fillStyle = 'rgba(255, 255, 100, 0.6)';
                    ctx.strokeStyle = '#ffff66';
                }

                ctx.lineWidth = v.coated ? 3 : 1;
                ctx.beginPath();

                // Size varies with state
                let r = v.radius;
                if (v.state === 'budding') r = v.radius * v.progress;
                if (v.state === 'fusing') r = v.radius * (1 - v.progress * 0.5);

                ctx.arc(v.x, v.y, r, 0, Math.PI * 2);
                ctx.fill();
                ctx.stroke();

                // Coat pattern
                if (v.coated) {
                    ctx.strokeStyle = v.coatType === 'COPII' ? '#4dd4b4' : '#cc5555';
                    ctx.lineWidth = 1;
                    for (let i = 0; i < 6; i++) {
                        const angle = (i / 6) * Math.PI * 2;
                        ctx.beginPath();
                        ctx.moveTo(v.x, v.y);
                        ctx.lineTo(
                            v.x + Math.cos(angle) * r * 1.2,
                            v.y + Math.sin(angle) * r * 1.2
                        );
                        ctx.stroke();
                    }
                }

                // Cargo inside vesicle
                for (let i = 0; i < Math.min(v.cargo.length, 3); i++) {
                    ctx.fillStyle = '#00ff88';
                    ctx.beginPath();
                    const offset = (i - 1) * 5;
                    ctx.arc(v.x + offset, v.y, 2, 0, Math.PI * 2);
                    ctx.fill();
                }

                // Label
                ctx.fillStyle = '#fff';
                ctx.font = '8px Arial';
                ctx.textAlign = 'center';
                if (v.coatType === 'COPII') ctx.fillText('II', v.x, v.y + 3);
                else if (v.coatType === 'COPI') ctx.fillText('I', v.x, v.y + 3);
            }

            // Draw transport arrows
            ctx.strokeStyle = 'rgba(100, 255, 218, 0.2)';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);

            // ER to ERGIC arrow
            ctx.beginPath();
            ctx.moveTo(er.x + er.width / 2, er.y);
            ctx.lineTo(ergic.x + ergic.width / 2, ergic.y + ergic.height);
            ctx.stroke();

            // ERGIC to Golgi arrow
            ctx.beginPath();
            ctx.moveTo(ergic.x + ergic.width / 2, ergic.y);
            ctx.lineTo(golgi.cisternae[0].x, golgi.cisternae[0].y + golgi.cisternae[0].height);
            ctx.stroke();

            // Retrograde arrow (COPI)
            ctx.strokeStyle = 'rgba(255, 107, 107, 0.2)';
            ctx.beginPath();
            ctx.moveTo(golgi.cisternae[0].x - 50, golgi.cisternae[0].y);
            ctx.quadraticCurveTo(
                er.x + 100, canvas.height / 2,
                er.x + 100, er.y
            );
            ctx.stroke();

            ctx.setLineDash([]);

            // Legend for cargo
            ctx.fillStyle = '#00ff88';
            ctx.font = '10px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('‚óè Secretory cargo', 10, 20);
            ctx.fillStyle = '#ff6b6b';
            ctx.fillText('‚óè ER-resident (KDEL)', 10, 35);
        }

        function animate() {
            if (running) {
                updateSimulation();
            }
            draw();
            animationId = requestAnimationFrame(animate);
        }

        function toggleSimulation() {
            running = !running;
            document.getElementById('startBtn').textContent = running ? 'Pause' : 'Start';
        }

        function resetSimulation() {
            running = false;
            document.getElementById('startBtn').textContent = 'Start';
            initSimulation();
        }

        function showExplain() {
            document.getElementById('explainModal').classList.add('active');
        }

        function hideExplain() {
            document.getElementById('explainModal').classList.remove('active');
        }

        // Event listeners
        document.getElementById('production').addEventListener('input', (e) => {
            params.production = parseInt(e.target.value) / 100;
            document.getElementById('prodVal').textContent = params.production.toFixed(2);
        });

        document.getElementById('copiiBudding').addEventListener('input', (e) => {
            params.copiiBudding = parseInt(e.target.value) / 100;
            document.getElementById('copiiVal').textContent = params.copiiBudding.toFixed(2);
        });

        document.getElementById('copiRetrieval').addEventListener('input', (e) => {
            params.copiRetrieval = parseInt(e.target.value) / 100;
            document.getElementById('copiVal').textContent = params.copiRetrieval.toFixed(2);
        });

        document.getElementById('vesicleSpeed').addEventListener('input', (e) => {
            params.vesicleSpeed = parseInt(e.target.value);
            document.getElementById('speedVal').textContent = params.vesicleSpeed;
        });

        document.getElementById('fusionRate').addEventListener('input', (e) => {
            params.fusionRate = parseInt(e.target.value) / 100;
            document.getElementById('fusionVal').textContent = params.fusionRate.toFixed(2);
        });

        window.addEventListener('resize', resizeCanvas);
        initSimulation();
        animate();
    </script>

    <div id="explainModal" class="modal-overlay">
        <div class="modal">
            <button class="modal-close">&times;</button>
            <h2>üìä Membrane Trafficking</h2>
            <div class="modal-body">
                <p>Life operates through precise molecular machinery. This simulation models biochemical reactions and molecular interactions at the cellular level.</p>

                <h3>About This Simulation</h3>
                <p>Implement vesicle budding, transport, and fusion with cargo sorting.</p>

                <h3>Key Concepts</h3>
                <ul>
                    <li><strong>Enzyme Kinetics:</strong> Enzymes catalyze reactions following Michaelis-Menten kinetics, with rates determined by substrate concentration and enzyme affinity (Km).</li>
                    <li><strong>Lock and Key vs Induced Fit:</strong> Enzymes recognize substrates either through rigid complementarity (lock-key) or conformational changes upon binding (induced fit).</li>
                    <li><strong>Allosteric Regulation:</strong> Enzyme activity modulated by molecules binding at sites other than the active site, enabling sophisticated metabolic control.</li>
                    <li><strong>Signal Transduction:</strong> Cascades of molecular interactions that amplify and transmit signals from cell surface to nucleus.</li>
                </ul>

                <h3>Why It Matters</h3>
                <p>Molecular understanding enables drug design, metabolic engineering, and synthetic biology.</p>

                <h3>How to Explore</h3>
                <ul>
                    <li>Adjust the sliders to modify simulation parameters and observe how the system responds</li>
                    <li>Look for emergent patterns that arise from agent interactions</li>
                    <li>Try extreme parameter values to find phase transitions and tipping points</li>
                    <li>Compare the simulation behavior to real-world phenomena</li>
                </ul>

                <p class="modal-category"><em>Category: Biochemistry & Molecular Biology ‚Äî Exploring molecular mechanisms and biochemical pathways</em></p>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('explainModal');
        const explainBtn = document.getElementById('explainBtn');
        if (modal && explainBtn) {
            explainBtn.addEventListener('click', function() {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            });
            modal.querySelector('.modal-close').addEventListener('click', function() {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            });
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.classList.contains('active')) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
        }
    });
    </script>

</body>
</html>
