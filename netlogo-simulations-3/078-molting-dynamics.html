<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Molting Dynamics - CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a2e; color: #e8e6e1; overflow: hidden; }
        #container { display: flex; height: 100vh; }
        #main-area { flex: 1; display: flex; flex-direction: column; padding: 20px; gap: 15px; }
        canvas { background: rgba(0,0,0,0.3); border-radius: 8px; flex: 1; }
        #controls { width: 300px; background: rgba(0,0,0,0.8); padding: 20px; overflow-y: auto; }
        h1 { font-size: 1.2rem; margin-bottom: 10px; color: #a78bfa; }
        .description { font-size: 0.75rem; color: #888; margin-bottom: 15px; line-height: 1.4; }
        .control-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: #aaa; }
        input[type="range"] { width: 100%; margin-bottom: 5px; }
        .value-display { font-size: 0.75rem; color: #a78bfa; }
        button { width: 100%; padding: 10px; margin-bottom: 10px; background: #a78bfa; color: #1a1a2e; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: #8b5cf6; }
        .stats { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; font-size: 0.8rem; margin-top: 15px; }
        .stats div { margin-bottom: 5px; }
        .stats span { color: #a78bfa; }
        .back-link { position: fixed; top: 10px; left: 10px; padding: 8px 16px; background: rgba(0,0,0,0.7); color: #a78bfa; text-decoration: none; border-radius: 6px; font-size: 14px; z-index: 999; }
        .theory { background: rgba(167,139,250,0.1); padding: 10px; border-radius: 5px; font-size: 0.7rem; margin-top: 15px; border-left: 3px solid #a78bfa; }
    </style>
</head>
<body>
    <a href="../netlogo-simulations/index.html" class="back-link">‚Üê Back to Simulations</a>

    <div id="container">
        <div id="main-area">
            <canvas id="canvas"></canvas>
        </div>

        <div id="controls">
            <h1>ü¶ó Molting Dynamics</h1>
            <p class="description">
                Arthropod molting (ecdysis) involves hormone cycling between ecdysone and
                juvenile hormone, cuticle synthesis and degradation, and precise timing
                of behavioral phases from apolysis to sclerotization.
            </p>

            <div class="control-group">
                <label>Ecdysone Sensitivity: <span class="value-display" id="ecdysoneValue">0.5</span></label>
                <input type="range" id="ecdysoneSlider" min="0.2" max="1" step="0.1" value="0.5">
            </div>

            <div class="control-group">
                <label>JH Level: <span class="value-display" id="jhValue">0.5</span></label>
                <input type="range" id="jhSlider" min="0" max="1" step="0.1" value="0.5">
            </div>

            <div class="control-group">
                <label>Cuticle Synthesis Rate: <span class="value-display" id="cuticleValue">0.3</span></label>
                <input type="range" id="cuticleSlider" min="0.1" max="0.6" step="0.05" value="0.3">
            </div>

            <div class="control-group">
                <label>Molt Cycle Speed: <span class="value-display" id="speedValue">1</span></label>
                <input type="range" id="speedSlider" min="0.5" max="2" step="0.1" value="1">
            </div>

            <button id="startBtn">Start Simulation</button>
            <button id="resetBtn">Reset</button>

            <div class="stats">
                <div>Generation: <span id="generation">0</span></div>
                <div>Molt Phase: <span id="phase">Intermolt</span></div>
                <div>Instar: <span id="instar">1</span></div>
                <div>Body Size: <span id="size">1.00</span></div>
                <div>Cuticle Thickness: <span id="cuticle">0.5</span></div>
            </div>

            <div class="theory">
                <strong>Ecdysis Phases:</strong><br>
                ‚Ä¢ <b>Intermolt:</b> Growth, cuticle synthesis<br>
                ‚Ä¢ <b>Apolysis:</b> Old cuticle separation<br>
                ‚Ä¢ <b>Ecdysis:</b> Cuticle shedding<br>
                ‚Ä¢ <b>Sclerotization:</b> New cuticle hardening
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            canvas.width = canvas.parentElement.clientWidth - 15;
            canvas.height = canvas.parentElement.clientHeight - 15;
        }
        resize();
        window.addEventListener('resize', resize);

        let running = false;
        let generation = 0;

        let ecdysoneSensitivity = 0.5;
        let juvenileHormone = 0.5;
        let cuticleSynthesisRate = 0.3;
        let cycleSpeed = 1;

        // Molt state
        let phase = 'intermolt'; // intermolt, apolysis, ecdysis, sclerotization
        let phaseTime = 0;
        let instar = 1;
        let bodySize = 1;
        let cuticleThickness = 0.5;
        let ecdysoneLevel = 0;
        let oldCuticle = null;
        let newCuticle = null;

        // Hormone history for plotting
        let hormoneHistory = [];

        const PHASES = {
            intermolt: { duration: 200, color: '#22c55e' },
            apolysis: { duration: 50, color: '#eab308' },
            ecdysis: { duration: 30, color: '#ef4444' },
            sclerotization: { duration: 80, color: '#3b82f6' }
        };

        function reset() {
            phase = 'intermolt';
            phaseTime = 0;
            instar = 1;
            bodySize = 1;
            cuticleThickness = 0.5;
            ecdysoneLevel = 0;
            oldCuticle = null;
            newCuticle = { thickness: 0, hardness: 0 };
            hormoneHistory = [];
        }

        function updateHormones() {
            // Ecdysone pulse during molt
            if (phase === 'apolysis' || phase === 'ecdysis') {
                ecdysoneLevel = Math.min(1, ecdysoneLevel + 0.05 * ecdysoneSensitivity);
            } else {
                ecdysoneLevel = Math.max(0, ecdysoneLevel - 0.02);
            }

            // Track history
            hormoneHistory.push({
                ecdysone: ecdysoneLevel,
                jh: juvenileHormone,
                time: generation
            });
            if (hormoneHistory.length > 300) hormoneHistory.shift();
        }

        function update() {
            if (!running) return;

            generation++;
            phaseTime += cycleSpeed;
            updateHormones();

            const phaseDuration = PHASES[phase].duration / cycleSpeed;

            switch (phase) {
                case 'intermolt':
                    // Cuticle synthesis
                    cuticleThickness = Math.min(1, cuticleThickness + cuticleSynthesisRate * 0.01);
                    newCuticle.thickness = Math.min(1, newCuticle.thickness + cuticleSynthesisRate * 0.005);

                    if (phaseTime > phaseDuration) {
                        phase = 'apolysis';
                        phaseTime = 0;
                        oldCuticle = { thickness: cuticleThickness };
                    }
                    break;

                case 'apolysis':
                    // Old cuticle separating from epidermis
                    if (oldCuticle) {
                        oldCuticle.separation = Math.min(1, (oldCuticle.separation || 0) + 0.03);
                    }

                    if (phaseTime > phaseDuration) {
                        phase = 'ecdysis';
                        phaseTime = 0;
                    }
                    break;

                case 'ecdysis':
                    // Shedding old cuticle
                    if (oldCuticle) {
                        oldCuticle.shed = Math.min(1, (oldCuticle.shed || 0) + 0.05);
                    }

                    if (phaseTime > phaseDuration) {
                        phase = 'sclerotization';
                        phaseTime = 0;
                        oldCuticle = null;
                        // Size increase depends on JH level
                        const sizeIncrease = juvenileHormone > 0.3 ? 0.3 : 0.1;
                        bodySize += sizeIncrease;
                    }
                    break;

                case 'sclerotization':
                    // New cuticle hardening
                    newCuticle.hardness = Math.min(1, newCuticle.hardness + 0.02);
                    cuticleThickness = newCuticle.thickness * newCuticle.hardness;

                    if (phaseTime > phaseDuration) {
                        phase = 'intermolt';
                        phaseTime = 0;
                        instar++;
                        newCuticle = { thickness: 0, hardness: 0 };
                    }
                    break;
            }

            render();
            updateStats();
            requestAnimationFrame(update);
        }

        function render() {
            ctx.fillStyle = 'rgba(26, 26, 46, 1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const centerX = canvas.width * 0.35;
            const centerY = canvas.height * 0.5;
            const baseRadius = Math.min(canvas.width, canvas.height) * 0.15;
            const radius = baseRadius * bodySize;

            // Draw title
            ctx.fillStyle = '#888';
            ctx.font = '12px sans-serif';
            ctx.fillText('Molting Dynamics: Ecdysis Cycle', 20, 25);

            // Draw phase indicator
            ctx.fillStyle = PHASES[phase].color;
            ctx.font = 'bold 16px sans-serif';
            ctx.fillText(phase.charAt(0).toUpperCase() + phase.slice(1), centerX - 40, 60);

            // Draw old cuticle if present
            if (oldCuticle) {
                const sep = oldCuticle.separation || 0;
                const shed = oldCuticle.shed || 0;

                ctx.strokeStyle = `rgba(139, 92, 246, ${0.8 - shed * 0.8})`;
                ctx.lineWidth = oldCuticle.thickness * 15;
                ctx.beginPath();

                // Cuticle separating and shedding
                const startAngle = -Math.PI/2 + shed * Math.PI;
                const endAngle = Math.PI * 1.5 - shed * Math.PI;
                ctx.arc(centerX, centerY, radius + sep * 20 + shed * 30, startAngle, endAngle);
                ctx.stroke();
            }

            // Draw new/current cuticle
            const cuticleColor = phase === 'sclerotization'
                ? `rgba(167, 139, 250, ${0.3 + newCuticle.hardness * 0.7})`
                : 'rgba(167, 139, 250, 0.8)';

            ctx.strokeStyle = cuticleColor;
            ctx.lineWidth = cuticleThickness * 12;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
            ctx.stroke();

            // Draw body
            ctx.fillStyle = '#6366f1';
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius - 5, 0, Math.PI * 2);
            ctx.fill();

            // Draw segments
            ctx.strokeStyle = 'rgba(0,0,0,0.3)';
            ctx.lineWidth = 2;
            for (let i = 1; i < 6; i++) {
                const y = centerY - radius + (radius * 2 * i) / 6;
                ctx.beginPath();
                const halfWidth = Math.sqrt(radius * radius - Math.pow(y - centerY, 2)) || 0;
                ctx.moveTo(centerX - halfWidth, y);
                ctx.lineTo(centerX + halfWidth, y);
                ctx.stroke();
            }

            // Draw instar label
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 14px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(`Instar ${instar}`, centerX, centerY + 5);
            ctx.textAlign = 'left';

            // Draw hormone graph
            drawHormoneGraph();

            // Draw cycle diagram
            drawCycleDiagram();
        }

        function drawHormoneGraph() {
            const graphX = canvas.width * 0.55;
            const graphY = 80;
            const graphW = canvas.width * 0.4;
            const graphH = 120;

            // Background
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.fillRect(graphX, graphY, graphW, graphH);

            // Labels
            ctx.fillStyle = '#888';
            ctx.font = '10px sans-serif';
            ctx.fillText('Hormone Levels', graphX + 5, graphY + 15);

            // Draw hormone traces
            if (hormoneHistory.length > 1) {
                // Ecdysone (purple)
                ctx.strokeStyle = '#a78bfa';
                ctx.lineWidth = 2;
                ctx.beginPath();
                for (let i = 0; i < hormoneHistory.length; i++) {
                    const x = graphX + (i / 300) * graphW;
                    const y = graphY + graphH - hormoneHistory[i].ecdysone * (graphH - 30) - 10;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();

                // JH (green)
                ctx.strokeStyle = '#22c55e';
                ctx.beginPath();
                for (let i = 0; i < hormoneHistory.length; i++) {
                    const x = graphX + (i / 300) * graphW;
                    const y = graphY + graphH - hormoneHistory[i].jh * (graphH - 30) - 10;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
            }

            // Legend
            ctx.fillStyle = '#a78bfa';
            ctx.fillRect(graphX + graphW - 80, graphY + 5, 10, 10);
            ctx.fillStyle = '#888';
            ctx.fillText('Ecdysone', graphX + graphW - 65, graphY + 14);

            ctx.fillStyle = '#22c55e';
            ctx.fillRect(graphX + graphW - 80, graphY + 20, 10, 10);
            ctx.fillStyle = '#888';
            ctx.fillText('JH', graphX + graphW - 65, graphY + 29);
        }

        function drawCycleDiagram() {
            const cx = canvas.width * 0.75;
            const cy = canvas.height * 0.65;
            const r = 60;

            // Draw cycle circle
            ctx.strokeStyle = 'rgba(255,255,255,0.2)';
            ctx.lineWidth = 20;
            ctx.beginPath();
            ctx.arc(cx, cy, r, 0, Math.PI * 2);
            ctx.stroke();

            // Draw phase arcs
            const phaseOrder = ['intermolt', 'apolysis', 'ecdysis', 'sclerotization'];
            const totalDuration = Object.values(PHASES).reduce((a, b) => a + b.duration, 0);
            let startAngle = -Math.PI / 2;

            for (const p of phaseOrder) {
                const angle = (PHASES[p].duration / totalDuration) * Math.PI * 2;
                ctx.strokeStyle = p === phase ? PHASES[p].color : `${PHASES[p].color}66`;
                ctx.lineWidth = p === phase ? 25 : 18;
                ctx.beginPath();
                ctx.arc(cx, cy, r, startAngle, startAngle + angle);
                ctx.stroke();
                startAngle += angle;
            }

            // Labels
            ctx.fillStyle = '#888';
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Intermolt', cx, cy - r - 30);
            ctx.fillText('Apolysis', cx + r + 30, cy);
            ctx.fillText('Ecdysis', cx, cy + r + 40);
            ctx.fillText('Sclero.', cx - r - 25, cy);
            ctx.textAlign = 'left';

            // Center text
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Molt', cx, cy - 5);
            ctx.fillText('Cycle', cx, cy + 10);
            ctx.textAlign = 'left';
        }

        function updateStats() {
            document.getElementById('generation').textContent = generation;
            document.getElementById('phase').textContent = phase.charAt(0).toUpperCase() + phase.slice(1);
            document.getElementById('instar').textContent = instar;
            document.getElementById('size').textContent = bodySize.toFixed(2);
            document.getElementById('cuticle').textContent = cuticleThickness.toFixed(2);
        }

        document.getElementById('ecdysoneSlider').addEventListener('input', (e) => {
            ecdysoneSensitivity = parseFloat(e.target.value);
            document.getElementById('ecdysoneValue').textContent = ecdysoneSensitivity.toFixed(1);
        });

        document.getElementById('jhSlider').addEventListener('input', (e) => {
            juvenileHormone = parseFloat(e.target.value);
            document.getElementById('jhValue').textContent = juvenileHormone.toFixed(1);
        });

        document.getElementById('cuticleSlider').addEventListener('input', (e) => {
            cuticleSynthesisRate = parseFloat(e.target.value);
            document.getElementById('cuticleValue').textContent = cuticleSynthesisRate.toFixed(2);
        });

        document.getElementById('speedSlider').addEventListener('input', (e) => {
            cycleSpeed = parseFloat(e.target.value);
            document.getElementById('speedValue').textContent = cycleSpeed.toFixed(1);
        });

        document.getElementById('startBtn').addEventListener('click', () => {
            running = !running;
            document.getElementById('startBtn').textContent = running ? 'Pause' : 'Start Simulation';
            if (running) update();
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            running = false;
            generation = 0;
            document.getElementById('startBtn').textContent = 'Start Simulation';
            reset();
            render();
            updateStats();
        });

        reset();
        render();
        updateStats();
    </script>
</body>
</html>
