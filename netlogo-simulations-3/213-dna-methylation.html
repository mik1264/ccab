<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNA Methylation - NetLogo Simulations III</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 100%);
            min-height: 100vh;
            color: #e0e0e0;
            display: flex;
        }

        .container { flex: 1; display: flex; flex-direction: column; }

        header {
            padding: 15px 25px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(100,200,255,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-link { color: #64b5f6; text-decoration: none; }
        h1 {
            font-size: 1.5rem;
            background: linear-gradient(90deg, #64b5f6, #4fc3f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .main-content { flex: 1; display: flex; overflow: hidden; }
        .canvas-container { flex: 1; position: relative; background: #050510; }
        canvas { width: 100%; height: 100%; }

        .control-panel {
            width: 320px;
            background: rgba(0,0,0,0.4);
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid rgba(100,200,255,0.2);
        }

        .panel-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .panel-section h3 {
            color: #4fc3f7;
            margin-bottom: 12px;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .control-group { margin-bottom: 12px; }
        .control-group label { display: block; font-size: 0.85rem; color: #aaa; margin-bottom: 5px; }
        .control-group input[type="range"] { width: 100%; margin-bottom: 3px; }
        .control-value { font-size: 0.8rem; color: #64b5f6; text-align: right; }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .btn-primary { background: linear-gradient(135deg, #1976d2, #1565c0); color: white; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); }
        .btn-action { background: linear-gradient(135deg, #43a047, #388e3c); color: white; font-size: 0.8rem; padding: 8px 12px; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-item { background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 1.3rem; font-weight: bold; color: #4fc3f7; }
        .stat-label { font-size: 0.75rem; color: #888; margin-top: 3px; }

        .legend { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .legend-item { display: flex; align-items: center; gap: 5px; font-size: 0.75rem; }
        .legend-color { width: 14px; height: 14px; border-radius: 3px; }

        .modal.active { display: flex; }

        .modal-content {
            background: #1a1a2e;
            padding: 30px;
            border-radius: 12px;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(100,200,255,0.3);
        }

        .modal-content h2 { color: #4fc3f7; margin-bottom: 15px; }
        .modal-content p { line-height: 1.7; margin-bottom: 12px; color: #ccc; }
        .modal-content ul { margin-left: 20px; margin-bottom: 12px; }
        .modal-content li { margin-bottom: 6px; color: #bbb; }

        .close-btn { float: right; background: none; border: none; color: #888; font-size: 1.5rem; cursor: pointer; }
    
        .explain-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            font-weight: 600;
        }
        .explain-btn:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            padding: 20px;
            overflow-y: auto;
        }
        .modal-overlay.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }
        .modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #252542 100%);
            border-radius: 20px;
            padding: 35px;
            max-width: 750px;
            width: 100%;
            margin: 40px auto;
            position: relative;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        .modal-close:hover {
            color: #fff;
            background: rgba(255,255,255,0.2);
        }
        .modal h2 {
            color: #00d9ff;
            margin-bottom: 25px;
            font-size: 1.6rem;
            padding-right: 50px;
            line-height: 1.3;
        }
        .modal-body {
            color: #d1d5db;
            line-height: 1.9;
            font-size: 1rem;
        }
        .modal-body h3 {
            color: #00ff88;
            margin: 28px 0 14px 0;
            font-size: 1.15rem;
            font-weight: 600;
        }
        .modal-body p {
            margin-bottom: 16px;
        }
        .modal-body ul {
            margin: 12px 0 18px 24px;
        }
        .modal-body li {
            margin-bottom: 10px;
        }
        .modal-body strong {
            color: #00d9ff;
        }
        .modal-body em {
            color: #a5b4fc;
            font-style: italic;
        }
        .modal-body code {
            background: rgba(0,0,0,0.3);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Fira Code', monospace;
            color: #fbbf24;
            font-size: 0.9em;
        }
        .modal-category {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="index.html" class="back-link">‚Üê Back to Simulations</a>
            <h1>DNA Methylation</h1>
            <button class="btn btn-secondary" onclick="showModal()">Explain</button>
        </header>

        <div class="main-content">
            <div class="canvas-container">
                <canvas id="canvas"></canvas>
            </div>

            <div class="control-panel">
                <div class="panel-section">
                    <h3>Simulation Controls</h3>
                    <button class="btn btn-primary" id="startBtn" onclick="toggleSimulation()">Start</button>
                    <button class="btn btn-secondary" onclick="resetSimulation()">Reset</button>
                <button id="explainBtn" class="explain-btn">üìö Explain This Simulation</button>
                    <button class="btn btn-action" onclick="replicateDNA()">Replicate DNA</button>
                </div>

                <div class="panel-section">
                    <h3>Parameters</h3>

                    <div class="control-group">
                        <label>DNMT1 Activity (Maintenance)</label>
                        <input type="range" id="dnmt1Activity" min="0" max="1" step="0.05" value="0.9">
                        <div class="control-value"><span id="dnmt1ActivityVal">90</span>%</div>
                    </div>

                    <div class="control-group">
                        <label>DNMT3A/B Activity (De Novo)</label>
                        <input type="range" id="dnmt3Activity" min="0" max="0.5" step="0.02" value="0.1">
                        <div class="control-value"><span id="dnmt3ActivityVal">10</span>%</div>
                    </div>

                    <div class="control-group">
                        <label>TET Activity (Demethylation)</label>
                        <input type="range" id="tetActivity" min="0" max="0.5" step="0.02" value="0.1">
                        <div class="control-value"><span id="tetActivityVal">10</span>%</div>
                    </div>

                    <div class="control-group">
                        <label>CpG Island Protection</label>
                        <input type="range" id="islandProtection" min="0" max="1" step="0.05" value="0.8">
                        <div class="control-value"><span id="islandProtectionVal">80</span>%</div>
                    </div>
                </div>

                <div class="panel-section">
                    <h3>Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="methylatedCpG">0</div>
                            <div class="stat-label">Methylated CpGs</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="unmethylatedCpG">0</div>
                            <div class="stat-label">Unmethylated CpGs</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="generations">0</div>
                            <div class="stat-label">Cell Generations</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="fidelity">100</div>
                            <div class="stat-label">Inheritance %</div>
                        </div>
                    </div>
                </div>

                <div class="panel-section">
                    <h3>Legend</h3>
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #4fc3f7;"></div>
                            <span>Unmethylated C</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #f44336;"></div>
                            <span>5-methylcytosine</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ff9800;"></div>
                            <span>5-hydroxymethylC</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #4caf50;"></div>
                            <span>CpG Island</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #9c27b0;"></div>
                            <span>DNMT Enzyme</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #00bcd4;"></div>
                            <span>TET Enzyme</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="hideModal()">&times;</button>
            <h2>DNA Methylation</h2>
            <p>
                DNA methylation is a crucial epigenetic mark where a methyl group is added to the 5-carbon
                of cytosine (5mC), primarily at CpG dinucleotides. It's essential for gene silencing,
                genomic imprinting, and X-chromosome inactivation.
            </p>
            <h3>DNA Methyltransferases (DNMTs)</h3>
            <ul>
                <li><strong>DNMT1:</strong> Maintenance methyltransferase that copies methylation patterns
                    to newly synthesized DNA during replication (with UHRF1)</li>
                <li><strong>DNMT3A/3B:</strong> De novo methyltransferases that establish new methylation
                    patterns, active in development and cell differentiation</li>
                <li><strong>DNMT3L:</strong> Catalytically inactive, enhances DNMT3A/B activity</li>
            </ul>
            <h3>TET Enzymes and Demethylation</h3>
            <p>
                TET enzymes (TET1/2/3) oxidize 5mC to 5-hydroxymethylcytosine (5hmC), then to 5-formylC (5fC)
                and 5-carboxyC (5caC). These oxidized forms are removed by TDG and base excision repair,
                completing active demethylation.
            </p>
            <h3>CpG Islands</h3>
            <p>
                CpG islands are regions with high CpG density, often found at promoters. They're typically
                unmethylated in active genes. H3K4me3 protects CpG islands from de novo methylation by
                blocking DNMT3 binding.
            </p>
            <h3>Inheritance</h3>
            <p>
                DNMT1's high fidelity (~95%) ensures methylation patterns are inherited through cell
                divisions. Hemi-methylated CpGs after replication are recognized by UHRF1, which recruits
                DNMT1 to complete methylation of the daughter strand.
            </p>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let running = false;
        let animationId = null;

        // Methylation states
        const METH = {
            UNMETHYLATED: 0,
            METHYLATED: 1,
            HYDROXYMETHYL: 2,
            HEMI: 3  // Hemi-methylated (one strand only)
        };

        let state = {
            cpgSites: [],
            enzymes: [],
            generations: 0,
            replicating: false,
            replicationProgress: 0,
            time: 0
        };

        const params = {
            dnmt1Activity: 0.9,
            dnmt3Activity: 0.1,
            tetActivity: 0.1,
            islandProtection: 0.8
        };

        function resize() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
            initCpGs();
        }

        function initCpGs() {
            state.cpgSites = [];
            const rows = 2; // Top and bottom strand
            const cols = 30;
            const startX = 80;
            const startY = canvas.height / 2 - 50;
            const spacingX = 25;

            // Create CpG sites with some CpG islands
            for (let col = 0; col < cols; col++) {
                const isInIsland = col >= 8 && col <= 15; // CpG island region

                state.cpgSites.push({
                    x: startX + col * spacingX,
                    y: startY,
                    topStrand: METH.UNMETHYLATED,
                    bottomStrand: METH.UNMETHYLATED,
                    isIsland: isInIsland,
                    originalTop: METH.UNMETHYLATED,
                    originalBottom: METH.UNMETHYLATED
                });
            }

            // Initialize some methylation outside islands
            state.cpgSites.forEach(cpg => {
                if (!cpg.isIsland && Math.random() < 0.6) {
                    cpg.topStrand = METH.METHYLATED;
                    cpg.bottomStrand = METH.METHYLATED;
                    cpg.originalTop = METH.METHYLATED;
                    cpg.originalBottom = METH.METHYLATED;
                }
            });

            state.enzymes = [];
            state.generations = 0;
        }

        function resetSimulation() {
            running = false;
            document.getElementById('startBtn').textContent = 'Start';

            state = {
                cpgSites: [],
                enzymes: [],
                generations: 0,
                replicating: false,
                replicationProgress: 0,
                time: 0
            };

            initCpGs();
            updateStats();
            draw();
        }

        function toggleSimulation() {
            running = !running;
            document.getElementById('startBtn').textContent = running ? 'Pause' : 'Start';
            if (running) animate();
        }

        function updateParams() {
            params.dnmt1Activity = parseFloat(document.getElementById('dnmt1Activity').value);
            params.dnmt3Activity = parseFloat(document.getElementById('dnmt3Activity').value);
            params.tetActivity = parseFloat(document.getElementById('tetActivity').value);
            params.islandProtection = parseFloat(document.getElementById('islandProtection').value);

            document.getElementById('dnmt1ActivityVal').textContent = Math.round(params.dnmt1Activity * 100);
            document.getElementById('dnmt3ActivityVal').textContent = Math.round(params.dnmt3Activity * 100);
            document.getElementById('tetActivityVal').textContent = Math.round(params.tetActivity * 100);
            document.getElementById('islandProtectionVal').textContent = Math.round(params.islandProtection * 100);
        }

        document.querySelectorAll('input[type="range"]').forEach(input => {
            input.addEventListener('input', updateParams);
        });

        function replicateDNA() {
            if (state.replicating) return;
            state.replicating = true;
            state.replicationProgress = 0;
        }

        function update() {
            state.time++;

            // DNA Replication
            if (state.replicating) {
                state.replicationProgress += 0.015;

                const replicationIndex = Math.floor(state.replicationProgress * state.cpgSites.length);

                // Create hemi-methylated sites at replication fork
                for (let i = 0; i < replicationIndex && i < state.cpgSites.length; i++) {
                    const cpg = state.cpgSites[i];
                    if (cpg.topStrand === METH.METHYLATED && cpg.bottomStrand === METH.METHYLATED) {
                        // After replication: one strand methylated, daughter strand unmethylated
                        cpg.topStrand = METH.HEMI;
                    }
                }

                if (state.replicationProgress >= 1) {
                    state.replicating = false;
                    state.generations++;

                    // DNMT1 maintenance methylation
                    state.cpgSites.forEach(cpg => {
                        if (cpg.topStrand === METH.HEMI) {
                            if (Math.random() < params.dnmt1Activity) {
                                cpg.topStrand = METH.METHYLATED;
                                cpg.bottomStrand = METH.METHYLATED;
                            } else {
                                // Failed maintenance - passive demethylation
                                cpg.topStrand = METH.UNMETHYLATED;
                                cpg.bottomStrand = METH.UNMETHYLATED;
                            }
                        }
                    });
                }
            }

            // DNMT3 de novo methylation
            state.cpgSites.forEach(cpg => {
                if (cpg.topStrand === METH.UNMETHYLATED && cpg.bottomStrand === METH.UNMETHYLATED) {
                    // CpG islands are protected
                    const protection = cpg.isIsland ? params.islandProtection : 0;
                    if (Math.random() < params.dnmt3Activity * 0.01 * (1 - protection)) {
                        cpg.topStrand = METH.METHYLATED;
                        cpg.bottomStrand = METH.METHYLATED;

                        // Spawn DNMT3 enzyme animation
                        state.enzymes.push({
                            x: cpg.x,
                            y: cpg.y - 60,
                            type: 'DNMT3',
                            targetY: cpg.y - 20,
                            timer: 40
                        });
                    }
                }
            });

            // TET demethylation
            state.cpgSites.forEach(cpg => {
                if (cpg.topStrand === METH.METHYLATED && !cpg.isIsland) {
                    if (Math.random() < params.tetActivity * 0.005) {
                        cpg.topStrand = METH.HYDROXYMETHYL;
                        cpg.bottomStrand = METH.HYDROXYMETHYL;

                        state.enzymes.push({
                            x: cpg.x,
                            y: cpg.y + 60,
                            type: 'TET',
                            targetY: cpg.y + 20,
                            timer: 40
                        });
                    }
                } else if (cpg.topStrand === METH.HYDROXYMETHYL) {
                    if (Math.random() < 0.02) {
                        cpg.topStrand = METH.UNMETHYLATED;
                        cpg.bottomStrand = METH.UNMETHYLATED;
                    }
                }
            });

            // Update enzyme animations
            state.enzymes = state.enzymes.filter(e => {
                e.timer--;
                if (e.y < e.targetY && e.type === 'DNMT3') e.y += 2;
                if (e.y > e.targetY && e.type === 'TET') e.y -= 2;
                return e.timer > 0;
            });

            updateStats();
        }

        function updateStats() {
            let methylated = 0;
            let unmethylated = 0;

            state.cpgSites.forEach(cpg => {
                if (cpg.topStrand === METH.METHYLATED || cpg.topStrand === METH.HYDROXYMETHYL) {
                    methylated++;
                } else {
                    unmethylated++;
                }
            });

            document.getElementById('methylatedCpG').textContent = methylated;
            document.getElementById('unmethylatedCpG').textContent = unmethylated;
            document.getElementById('generations').textContent = state.generations;

            // Calculate inheritance fidelity
            let inherited = 0;
            let total = 0;
            state.cpgSites.forEach(cpg => {
                if (cpg.originalTop === METH.METHYLATED) {
                    total++;
                    if (cpg.topStrand === METH.METHYLATED) inherited++;
                }
            });
            const fidelity = total > 0 ? ((inherited / total) * 100).toFixed(0) : 100;
            document.getElementById('fidelity').textContent = fidelity;
        }

        function draw() {
            ctx.fillStyle = '#050510';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const centerY = canvas.height / 2;

            // Draw DNA backbone
            ctx.strokeStyle = '#666';
            ctx.lineWidth = 4;

            // Top strand backbone
            ctx.beginPath();
            ctx.moveTo(40, centerY - 50);
            ctx.lineTo(canvas.width - 40, centerY - 50);
            ctx.stroke();

            // Bottom strand backbone
            ctx.beginPath();
            ctx.moveTo(40, centerY + 50);
            ctx.lineTo(canvas.width - 40, centerY + 50);
            ctx.stroke();

            // Draw replication fork
            if (state.replicating) {
                const forkX = 80 + state.replicationProgress * (state.cpgSites.length * 25);

                ctx.strokeStyle = '#ff9800';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(forkX, centerY - 70);
                ctx.lineTo(forkX, centerY + 70);
                ctx.stroke();

                ctx.fillStyle = '#ff9800';
                ctx.font = 'bold 12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('Replication Fork', forkX, centerY - 80);
            }

            // Draw CpG sites
            state.cpgSites.forEach((cpg, i) => {
                // CpG island background
                if (cpg.isIsland) {
                    ctx.fillStyle = 'rgba(76, 175, 80, 0.2)';
                    ctx.fillRect(cpg.x - 12, centerY - 70, 24, 140);
                }

                // Top strand cytosine
                let topColor = '#4fc3f7';
                if (cpg.topStrand === METH.METHYLATED) topColor = '#f44336';
                else if (cpg.topStrand === METH.HYDROXYMETHYL) topColor = '#ff9800';
                else if (cpg.topStrand === METH.HEMI) topColor = '#e91e63';

                ctx.fillStyle = topColor;
                ctx.beginPath();
                ctx.arc(cpg.x, centerY - 50, 10, 0, Math.PI * 2);
                ctx.fill();

                // Methyl group indicator
                if (cpg.topStrand === METH.METHYLATED) {
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 8px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('Me', cpg.x, centerY - 50);
                } else if (cpg.topStrand === METH.HYDROXYMETHYL) {
                    ctx.fillText('hm', cpg.x, centerY - 50);
                }

                // Guanine partner
                ctx.fillStyle = '#9c27b0';
                ctx.beginPath();
                ctx.arc(cpg.x + 8, centerY - 35, 6, 0, Math.PI * 2);
                ctx.fill();

                // Bottom strand (complementary)
                let bottomColor = '#4fc3f7';
                if (cpg.bottomStrand === METH.METHYLATED) bottomColor = '#f44336';
                else if (cpg.bottomStrand === METH.HYDROXYMETHYL) bottomColor = '#ff9800';

                ctx.fillStyle = bottomColor;
                ctx.beginPath();
                ctx.arc(cpg.x, centerY + 50, 10, 0, Math.PI * 2);
                ctx.fill();

                if (cpg.bottomStrand === METH.METHYLATED) {
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 8px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('Me', cpg.x, centerY + 50);
                }

                // Base pair connection
                ctx.strokeStyle = 'rgba(255,255,255,0.3)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(cpg.x, centerY - 40);
                ctx.lineTo(cpg.x, centerY + 40);
                ctx.stroke();

                // CpG label
                if (i === 0 || (cpg.isIsland && !state.cpgSites[i-1].isIsland)) {
                    ctx.fillStyle = '#aaa';
                    ctx.font = '10px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('CpG', cpg.x, centerY - 70);
                }
            });

            // CpG island label
            const islandStart = state.cpgSites.find(c => c.isIsland);
            if (islandStart) {
                ctx.fillStyle = '#4caf50';
                ctx.font = 'bold 12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('CpG Island (Protected)', islandStart.x + 87, centerY - 90);
            }

            // Draw enzymes
            state.enzymes.forEach(enzyme => {
                ctx.fillStyle = enzyme.type === 'DNMT3' ? '#9c27b0' : '#00bcd4';
                ctx.beginPath();
                ctx.arc(enzyme.x, enzyme.y, 15, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = '#fff';
                ctx.font = 'bold 8px sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(enzyme.type, enzyme.x, enzyme.y);
            });

            // Strand labels
            ctx.fillStyle = '#888';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText("5' ‚Äî‚Üí 3'", 40, centerY - 65);
            ctx.fillText("3' ‚Üê‚Äî 5'", 40, centerY + 65);

            // Title
            ctx.fillStyle = '#aaa';
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('DNA Methylation: Establishment, Maintenance, and Inheritance', 20, 30);
        }

        function animate() {
            if (!running && !state.replicating) return;

            update();
            draw();
            animationId = requestAnimationFrame(animate);
        }

        function showModal() {
            document.getElementById('modal').classList.add('active');
        }

        function hideModal() {
            document.getElementById('modal').classList.remove('active');
        }

        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target.id === 'modal') hideModal();
        });

        window.addEventListener('resize', resize);
        resize();
        updateParams();
        draw();
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal.classList.contains('active')) {
                modal.classList.remove('active');
            }
        });
    }

    </script>


    <div id="explainModal" class="modal-overlay">
        <div class="modal">
            <button class="modal-close">&times;</button>
            <h2>üìä DNA Methylation</h2>
            <div class="modal-body">
                <p>Life operates through precise molecular machinery. This simulation models biochemical reactions and molecular interactions at the cellular level.</p>

                <h3>About This Simulation</h3>
                <p>Implement methylation establishment, maintenance, and inheritance patterns.</p>

                <h3>Key Concepts</h3>
                <ul>
                    <li><strong>Enzyme Kinetics:</strong> Enzymes catalyze reactions following Michaelis-Menten kinetics, with rates determined by substrate concentration and enzyme affinity (Km).</li>
                    <li><strong>Lock and Key vs Induced Fit:</strong> Enzymes recognize substrates either through rigid complementarity (lock-key) or conformational changes upon binding (induced fit).</li>
                    <li><strong>Allosteric Regulation:</strong> Enzyme activity modulated by molecules binding at sites other than the active site, enabling sophisticated metabolic control.</li>
                    <li><strong>Signal Transduction:</strong> Cascades of molecular interactions that amplify and transmit signals from cell surface to nucleus.</li>
                </ul>

                <h3>Why It Matters</h3>
                <p>Molecular understanding enables drug design, metabolic engineering, and synthetic biology.</p>

                <h3>How to Explore</h3>
                <ul>
                    <li>Adjust the sliders to modify simulation parameters and observe how the system responds</li>
                    <li>Look for emergent patterns that arise from agent interactions</li>
                    <li>Try extreme parameter values to find phase transitions and tipping points</li>
                    <li>Compare the simulation behavior to real-world phenomena</li>
                </ul>

                <p class="modal-category"><em>Category: Biochemistry & Molecular Biology ‚Äî Exploring molecular mechanisms and biochemical pathways</em></p>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('explainModal');
        const explainBtn = document.getElementById('explainBtn');
        if (modal && explainBtn) {
            explainBtn.addEventListener('click', function() {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            });
            modal.querySelector('.modal-close').addEventListener('click', function() {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            });
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.classList.contains('active')) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
        }
    });
    </script>

</body>
</html>
