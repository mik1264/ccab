<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gastrulation - CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a2e; color: #e8e6e1; overflow: hidden; }
        #container { display: flex; height: 100vh; }
        #main-area { flex: 1; display: flex; flex-direction: column; padding: 20px; gap: 15px; }
        canvas { background: rgba(0,0,0,0.3); border-radius: 8px; flex: 1; }
        #controls { width: 300px; background: rgba(0,0,0,0.8); padding: 20px; overflow-y: auto; }
        h1 { font-size: 1.2rem; margin-bottom: 10px; color: #f59e0b; }
        .description { font-size: 0.75rem; color: #888; margin-bottom: 15px; line-height: 1.4; }
        .control-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: #aaa; }
        input[type="range"] { width: 100%; margin-bottom: 5px; }
        .value-display { font-size: 0.75rem; color: #f59e0b; }
        button { width: 100%; padding: 10px; margin-bottom: 10px; background: #f59e0b; color: #1a1a2e; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: #d97706; }
        .stats { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; font-size: 0.8rem; margin-top: 15px; }
        .stats div { margin-bottom: 5px; }
        .stats span { color: #f59e0b; }
        .back-link { position: fixed; top: 10px; left: 10px; padding: 8px 16px; background: rgba(0,0,0,0.7); color: #f59e0b; text-decoration: none; border-radius: 6px; font-size: 14px; z-index: 999; }
        .theory { background: rgba(245,158,11,0.1); padding: 10px; border-radius: 5px; font-size: 0.7rem; margin-top: 15px; border-left: 3px solid #f59e0b; }
    </style>
</head>
<body>
    <a href="../netlogo-simulations/index.html" class="back-link">‚Üê Back to Simulations</a>

    <div id="container">
        <div id="main-area">
            <canvas id="canvas"></canvas>
        </div>

        <div id="controls">
            <h1>ü•ö Gastrulation</h1>
            <p class="description">
                Gastrulation transforms the blastula into a gastrula with three germ layers:
                ectoderm, mesoderm, and endoderm. Cells migrate inward through the
                blastopore to form the body plan.
            </p>

            <div class="control-group">
                <label>Invagination Rate: <span class="value-display" id="invagValue">0.5</span></label>
                <input type="range" id="invagSlider" min="0.1" max="1" step="0.1" value="0.5">
            </div>

            <div class="control-group">
                <label>Cell Migration Speed: <span class="value-display" id="migValue">0.3</span></label>
                <input type="range" id="migSlider" min="0.1" max="1" step="0.1" value="0.3">
            </div>

            <div class="control-group">
                <label>Convergent Extension: <span class="value-display" id="ceValue">0.4</span></label>
                <input type="range" id="ceSlider" min="0" max="1" step="0.1" value="0.4">
                <div style="font-size: 0.65rem; color: #666;">Tissue narrowing and lengthening</div>
            </div>

            <div class="control-group">
                <label>Bottle Cell Constriction: <span class="value-display" id="bottleValue">0.5</span></label>
                <input type="range" id="bottleSlider" min="0" max="1" step="0.1" value="0.5">
            </div>

            <button id="startBtn">Start Simulation</button>
            <button id="resetBtn">Reset</button>

            <div class="stats">
                <div>Generation: <span id="generation">0</span></div>
                <div>Stage: <span id="stage">Blastula</span></div>
                <div>Ectoderm Cells: <span id="ectoderm">0</span></div>
                <div>Mesoderm Cells: <span id="mesoderm">0</span></div>
                <div>Endoderm Cells: <span id="endoderm">0</span></div>
                <div>Archenteron Depth: <span id="archenteron">0%</span></div>
            </div>

            <div class="theory">
                <strong>Germ Layer Formation:</strong><br>
                ‚Ä¢ <b>Ectoderm:</b> Outer layer ‚Üí skin, nervous system<br>
                ‚Ä¢ <b>Mesoderm:</b> Middle ‚Üí muscle, bone, blood<br>
                ‚Ä¢ <b>Endoderm:</b> Inner ‚Üí gut, organs<br>
                Key movements: invagination, involution, ingression, epiboly
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            canvas.width = canvas.parentElement.clientWidth - 15;
            canvas.height = canvas.parentElement.clientHeight - 15;
        }
        resize();
        window.addEventListener('resize', resize);

        let running = false;
        let generation = 0;
        let cells = [];
        let archenteronDepth = 0;

        let invaginationRate = 0.5;
        let migrationSpeed = 0.3;
        let convergentExtension = 0.4;
        let bottleCellConstriction = 0.5;

        const LAYERS = {
            ECTODERM: 0,
            MESODERM: 1,
            ENDODERM: 2
        };

        class Cell {
            constructor(angle, radius, layer) {
                this.angle = angle;
                this.radius = radius;
                this.layer = layer;
                this.migrating = false;
                this.isBottleCell = false;
            }

            get x() {
                return Math.cos(this.angle) * this.radius;
            }

            get y() {
                return Math.sin(this.angle) * this.radius;
            }

            get color() {
                switch (this.layer) {
                    case LAYERS.ECTODERM: return '#3b82f6';
                    case LAYERS.MESODERM: return '#ef4444';
                    case LAYERS.ENDODERM: return '#fbbf24';
                }
            }
        }

        function initCells() {
            cells = [];
            archenteronDepth = 0;

            const numCells = 60;
            const radius = 100;

            for (let i = 0; i < numCells; i++) {
                const angle = (i / numCells) * Math.PI * 2;
                const layer = LAYERS.ECTODERM; // Start as blastula (all ectoderm)
                const cell = new Cell(angle, radius, layer);

                // Cells near vegetal pole will become endoderm/mesoderm
                if (angle > Math.PI * 0.6 && angle < Math.PI * 1.4) {
                    cell.layer = LAYERS.ENDODERM;
                    if (angle > Math.PI * 0.75 && angle < Math.PI * 1.25) {
                        cell.isBottleCell = true;
                    }
                }

                cells.push(cell);
            }
        }

        function invaginate() {
            for (const cell of cells) {
                // Bottle cells at blastopore initiate invagination
                if (cell.isBottleCell) {
                    // Move inward
                    cell.radius -= invaginationRate * 0.5;
                    cell.radius = Math.max(20, cell.radius);
                }

                // Endoderm cells follow
                if (cell.layer === LAYERS.ENDODERM && !cell.isBottleCell) {
                    // Migrate toward archenteron
                    const targetAngle = Math.PI; // Vegetal pole
                    const angleDiff = targetAngle - cell.angle;
                    cell.angle += angleDiff * migrationSpeed * 0.02;

                    // Move inward following bottle cells
                    if (cell.radius > 40) {
                        cell.radius -= invaginationRate * 0.2;
                    }
                }

                // Mesoderm involution (cells roll over lip)
                if (Math.abs(cell.angle - Math.PI * 0.7) < 0.3 ||
                    Math.abs(cell.angle - Math.PI * 1.3) < 0.3) {
                    if (cell.layer === LAYERS.ECTODERM) {
                        cell.layer = LAYERS.MESODERM;
                        cell.migrating = true;
                    }
                }

                if (cell.layer === LAYERS.MESODERM && cell.migrating) {
                    // Move between ectoderm and endoderm
                    cell.radius = Math.max(50, cell.radius - migrationSpeed * 0.3);
                }
            }

            // Update archenteron depth
            const endodermCells = cells.filter(c => c.layer === LAYERS.ENDODERM);
            if (endodermCells.length > 0) {
                const minRadius = Math.min(...endodermCells.map(c => c.radius));
                archenteronDepth = (100 - minRadius) / 80 * 100;
            }
        }

        function convergentExtend() {
            // Cells intercalate causing tissue to narrow and lengthen
            const mesodermCells = cells.filter(c => c.layer === LAYERS.MESODERM);

            for (const cell of mesodermCells) {
                // Narrow toward midline
                const midlineAngle = Math.PI;
                const angleDiff = midlineAngle - cell.angle;
                cell.angle += angleDiff * convergentExtension * 0.01;
            }
        }

        function update() {
            if (!running) return;

            generation++;

            invaginate();
            convergentExtend();

            render();
            updateStats();
            requestAnimationFrame(update);
        }

        function render() {
            ctx.fillStyle = 'rgba(26, 26, 46, 1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const scale = Math.min(canvas.width, canvas.height) / 350;

            // Title
            ctx.fillStyle = '#888';
            ctx.font = '12px sans-serif';
            ctx.fillText('Gastrulation: Blastula ‚Üí Gastrula', 50, 25);

            // Draw blastocoel (cavity)
            ctx.fillStyle = 'rgba(50, 50, 80, 0.5)';
            ctx.beginPath();
            ctx.arc(centerX, centerY, 90 * scale, 0, Math.PI * 2);
            ctx.fill();

            // Draw archenteron (primitive gut)
            if (archenteronDepth > 10) {
                ctx.fillStyle = 'rgba(100, 80, 50, 0.5)';
                ctx.beginPath();
                ctx.ellipse(
                    centerX,
                    centerY + 60 * scale,
                    20 * scale,
                    archenteronDepth * 0.8 * scale,
                    0, 0, Math.PI * 2
                );
                ctx.fill();
            }

            // Draw cells by layer (back to front)
            // Endoderm first (innermost)
            for (const cell of cells.filter(c => c.layer === LAYERS.ENDODERM)) {
                drawCell(cell, centerX, centerY, scale);
            }

            // Mesoderm
            for (const cell of cells.filter(c => c.layer === LAYERS.MESODERM)) {
                drawCell(cell, centerX, centerY, scale);
            }

            // Ectoderm (outermost)
            for (const cell of cells.filter(c => c.layer === LAYERS.ECTODERM)) {
                drawCell(cell, centerX, centerY, scale);
            }

            // Blastopore label
            ctx.fillStyle = '#888';
            ctx.fillText('Blastopore', centerX - 30, centerY + 120 * scale);

            // Animal/Vegetal poles
            ctx.fillText('Animal Pole', centerX - 35, centerY - 110 * scale);
            ctx.fillText('Vegetal Pole', centerX - 35, centerY + 140 * scale);

            // Legend
            const legendY = canvas.height - 60;
            ctx.fillStyle = '#3b82f6';
            ctx.fillRect(50, legendY, 15, 15);
            ctx.fillStyle = '#888';
            ctx.fillText('Ectoderm', 70, legendY + 12);

            ctx.fillStyle = '#ef4444';
            ctx.fillRect(150, legendY, 15, 15);
            ctx.fillText('Mesoderm', 170, legendY + 12);

            ctx.fillStyle = '#fbbf24';
            ctx.fillRect(250, legendY, 15, 15);
            ctx.fillText('Endoderm', 270, legendY + 12);

            // Stage indicator
            const stage = getStage();
            ctx.fillStyle = '#f59e0b';
            ctx.font = '14px sans-serif';
            ctx.fillText(`Stage: ${stage}`, centerX - 40, 50);
        }

        function drawCell(cell, centerX, centerY, scale) {
            const x = centerX + cell.x * scale;
            const y = centerY + cell.y * scale;

            ctx.fillStyle = cell.color;
            ctx.beginPath();
            ctx.arc(x, y, cell.isBottleCell ? 4 : 6, 0, Math.PI * 2);
            ctx.fill();

            if (cell.isBottleCell) {
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 1;
                ctx.stroke();
            }
        }

        function getStage() {
            if (archenteronDepth < 10) return 'Blastula';
            if (archenteronDepth < 30) return 'Early Gastrula';
            if (archenteronDepth < 60) return 'Mid Gastrula';
            if (archenteronDepth < 80) return 'Late Gastrula';
            return 'Gastrula Complete';
        }

        function updateStats() {
            const ectoderm = cells.filter(c => c.layer === LAYERS.ECTODERM).length;
            const mesoderm = cells.filter(c => c.layer === LAYERS.MESODERM).length;
            const endoderm = cells.filter(c => c.layer === LAYERS.ENDODERM).length;

            document.getElementById('generation').textContent = generation;
            document.getElementById('stage').textContent = getStage();
            document.getElementById('ectoderm').textContent = ectoderm;
            document.getElementById('mesoderm').textContent = mesoderm;
            document.getElementById('endoderm').textContent = endoderm;
            document.getElementById('archenteron').textContent = archenteronDepth.toFixed(1) + '%';
        }

        document.getElementById('invagSlider').addEventListener('input', (e) => {
            invaginationRate = parseFloat(e.target.value);
            document.getElementById('invagValue').textContent = invaginationRate.toFixed(1);
        });

        document.getElementById('migSlider').addEventListener('input', (e) => {
            migrationSpeed = parseFloat(e.target.value);
            document.getElementById('migValue').textContent = migrationSpeed.toFixed(1);
        });

        document.getElementById('ceSlider').addEventListener('input', (e) => {
            convergentExtension = parseFloat(e.target.value);
            document.getElementById('ceValue').textContent = convergentExtension.toFixed(1);
        });

        document.getElementById('bottleSlider').addEventListener('input', (e) => {
            bottleCellConstriction = parseFloat(e.target.value);
            document.getElementById('bottleValue').textContent = bottleCellConstriction.toFixed(1);
        });

        document.getElementById('startBtn').addEventListener('click', () => {
            running = !running;
            document.getElementById('startBtn').textContent = running ? 'Pause' : 'Start Simulation';
            if (running) update();
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            running = false;
            generation = 0;
            document.getElementById('startBtn').textContent = 'Start Simulation';
            initCells();
            render();
            updateStats();
        });

        initCells();
        render();
        updateStats();
    </script>
</body>
</html>
