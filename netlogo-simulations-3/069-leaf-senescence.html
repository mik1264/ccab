<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaf Senescence - CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a2e; color: #e8e6e1; overflow: hidden; }
        #container { display: flex; height: 100vh; }
        #main-area { flex: 1; display: flex; flex-direction: column; padding: 20px; gap: 15px; }
        canvas { background: rgba(0,0,0,0.3); border-radius: 8px; flex: 1; }
        #controls { width: 300px; background: rgba(0,0,0,0.8); padding: 20px; overflow-y: auto; }
        h1 { font-size: 1.2rem; margin-bottom: 10px; color: #f59e0b; }
        .description { font-size: 0.75rem; color: #888; margin-bottom: 15px; line-height: 1.4; }
        .control-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: #aaa; }
        input[type="range"] { width: 100%; margin-bottom: 5px; }
        .value-display { font-size: 0.75rem; color: #f59e0b; }
        button { width: 100%; padding: 10px; margin-bottom: 10px; background: #f59e0b; color: #1a1a2e; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: #d97706; }
        .stats { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; font-size: 0.8rem; margin-top: 15px; }
        .stats div { margin-bottom: 5px; }
        .stats span { color: #f59e0b; }
        .back-link { position: fixed; top: 10px; left: 10px; padding: 8px 16px; background: rgba(0,0,0,0.7); color: #f59e0b; text-decoration: none; border-radius: 6px; font-size: 14px; z-index: 999; }
        .theory { background: rgba(245,158,11,0.1); padding: 10px; border-radius: 5px; font-size: 0.7rem; margin-top: 15px; border-left: 3px solid #f59e0b; }
    </style>
</head>
<body>
    <a href="../netlogo-simulations/index.html" class="back-link">‚Üê Back to Simulations</a>

    <div id="container">
        <div id="main-area">
            <canvas id="canvas"></canvas>
        </div>

        <div id="controls">
            <h1>üçÇ Leaf Senescence</h1>
            <p class="description">
                Programmed leaf death involves chlorophyll degradation, nutrient
                remobilization to other tissues, and accumulation of protective pigments.
                Short days and low temperatures trigger senescence in deciduous plants.
            </p>

            <div class="control-group">
                <label>Day Length: <span class="value-display" id="dayValue">12h</span></label>
                <input type="range" id="daySlider" min="8" max="16" step="1" value="12">
            </div>

            <div class="control-group">
                <label>Temperature: <span class="value-display" id="tempValue">15¬∞C</span></label>
                <input type="range" id="tempSlider" min="0" max="25" step="5" value="15">
            </div>

            <div class="control-group">
                <label>Nitrogen Status: <span class="value-display" id="nValue">0.7</span></label>
                <input type="range" id="nSlider" min="0.2" max="1" step="0.1" value="0.7">
            </div>

            <div class="control-group">
                <label>Senescence Rate: <span class="value-display" id="senValue">0.5</span></label>
                <input type="range" id="senSlider" min="0.1" max="1" step="0.1" value="0.5">
            </div>

            <button id="startBtn">Start Simulation</button>
            <button id="resetBtn">Reset</button>

            <div class="stats">
                <div>Generation: <span id="generation">0</span></div>
                <div>Season: <span id="season">Summer</span></div>
                <div>Chlorophyll: <span id="chlorophyll">100%</span></div>
                <div>Carotenoids: <span id="carotenoids">20%</span></div>
                <div>Anthocyanins: <span id="anthocyanins">0%</span></div>
                <div>N Remobilized: <span id="nRemob">0%</span></div>
            </div>

            <div class="theory">
                <strong>Senescence Biochemistry:</strong><br>
                ‚Ä¢ <b>Chlorophyll breakdown:</b> Reveals hidden carotenoids<br>
                ‚Ä¢ <b>Anthocyanin synthesis:</b> Protection during N export<br>
                ‚Ä¢ <b>Nutrient remobilization:</b> N, P, K to perennial tissues<br>
                ‚Ä¢ <b>Abscission layer:</b> Controlled separation
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            canvas.width = canvas.parentElement.clientWidth - 15;
            canvas.height = canvas.parentElement.clientHeight - 15;
        }
        resize();
        window.addEventListener('resize', resize);

        let running = false;
        let generation = 0;

        let dayLength = 12;
        let temperature = 15;
        let nitrogenStatus = 0.7;
        let senescenceRate = 0.5;

        let leaf = {
            chlorophyll: 1.0,
            carotenoids: 0.2,
            anthocyanins: 0,
            nitrogenRemobilized: 0,
            cells: []
        };

        function initLeaf() {
            leaf = {
                chlorophyll: 1.0,
                carotenoids: 0.2,
                anthocyanins: 0,
                nitrogenRemobilized: 0,
                cells: []
            };

            // Create leaf cell grid
            const gridSize = 30;
            for (let y = 0; y < gridSize; y++) {
                leaf.cells[y] = [];
                for (let x = 0; x < gridSize; x++) {
                    leaf.cells[y][x] = {
                        chlorophyll: 0.9 + Math.random() * 0.1,
                        carotenoids: 0.15 + Math.random() * 0.1,
                        anthocyanins: 0,
                        senescent: false
                    };
                }
            }
        }

        function getSeason() {
            if (dayLength >= 14) return 'Summer';
            if (dayLength >= 12) return 'Early Autumn';
            if (dayLength >= 10) return 'Mid Autumn';
            return 'Late Autumn';
        }

        function update() {
            if (!running) return;

            generation++;

            // Environmental triggers for senescence
            const shortDayTrigger = dayLength < 13 ? (13 - dayLength) / 5 : 0;
            const coldTrigger = temperature < 15 ? (15 - temperature) / 15 : 0;
            const senTrigger = (shortDayTrigger + coldTrigger) * senescenceRate * 0.01;

            // Update each cell
            const gridSize = leaf.cells.length;
            for (let y = 0; y < gridSize; y++) {
                for (let x = 0; x < gridSize; x++) {
                    const cell = leaf.cells[y][x];

                    // Check neighbors for senescence propagation
                    let senescentNeighbors = 0;
                    for (let dy = -1; dy <= 1; dy++) {
                        for (let dx = -1; dx <= 1; dx++) {
                            const ny = y + dy;
                            const nx = x + dx;
                            if (ny >= 0 && ny < gridSize && nx >= 0 && nx < gridSize) {
                                if (leaf.cells[ny][nx].senescent) senescentNeighbors++;
                            }
                        }
                    }

                    // Senescence spreads from edges and neighbors
                    const edgeFactor = (x < 3 || x > gridSize - 4 || y < 3 || y > gridSize - 4) ? 1.5 : 1;
                    const neighborFactor = 1 + senescentNeighbors * 0.1;

                    if (!cell.senescent && Math.random() < senTrigger * edgeFactor * neighborFactor) {
                        cell.senescent = true;
                    }

                    if (cell.senescent || senTrigger > 0) {
                        // Chlorophyll degradation
                        cell.chlorophyll = Math.max(0, cell.chlorophyll - senescenceRate * 0.01 * (cell.senescent ? 2 : 0.5));

                        // Anthocyanin synthesis (protection during N remobilization)
                        if (cell.chlorophyll < 0.7 && temperature < 15) {
                            cell.anthocyanins = Math.min(1, cell.anthocyanins + 0.005 * (15 - temperature) / 15);
                        }
                    }
                }
            }

            // Calculate leaf-level averages
            let totalChl = 0, totalCar = 0, totalAnth = 0;
            for (let y = 0; y < gridSize; y++) {
                for (let x = 0; x < gridSize; x++) {
                    totalChl += leaf.cells[y][x].chlorophyll;
                    totalCar += leaf.cells[y][x].carotenoids;
                    totalAnth += leaf.cells[y][x].anthocyanins;
                }
            }
            const numCells = gridSize * gridSize;
            leaf.chlorophyll = totalChl / numCells;
            leaf.carotenoids = totalCar / numCells;
            leaf.anthocyanins = totalAnth / numCells;

            // Nitrogen remobilization correlates with chlorophyll loss
            leaf.nitrogenRemobilized = (1 - leaf.chlorophyll) * nitrogenStatus;

            render();
            updateStats();
            requestAnimationFrame(update);
        }

        function render() {
            ctx.fillStyle = 'rgba(26, 26, 46, 1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const padding = 50;
            const size = Math.min(canvas.width - padding * 2, canvas.height - padding * 2);
            const centerX = padding + size / 2;
            const centerY = padding + size / 2;

            ctx.fillStyle = '#888';
            ctx.font = '12px sans-serif';
            ctx.fillText('Leaf Senescence: Chlorophyll Degradation & Nutrient Remobilization', padding, 25);

            // Draw leaf shape with cell-level coloring
            const gridSize = leaf.cells.length;
            const leafWidth = size * 0.6;
            const leafHeight = size * 0.8;

            for (let y = 0; y < gridSize; y++) {
                for (let x = 0; x < gridSize; x++) {
                    const cell = leaf.cells[y][x];

                    // Check if point is inside leaf shape
                    const nx = (x / gridSize - 0.5) * 2;
                    const ny = (y / gridSize - 0.5) * 2;

                    // Leaf shape equation (roughly elliptical with pointed tip)
                    const leafShape = Math.abs(nx) < (1 - ny * ny * 0.3) * (1 - ny * 0.4);

                    if (leafShape) {
                        // Calculate cell color based on pigments
                        const chl = cell.chlorophyll;
                        const car = cell.carotenoids;
                        const anth = cell.anthocyanins;

                        const r = Math.floor(50 + car * 200 + anth * 150);
                        const g = Math.floor(chl * 200 + car * 80);
                        const b = Math.floor(20 + anth * 30);

                        ctx.fillStyle = `rgb(${Math.min(255, r)}, ${Math.min(255, g)}, ${Math.min(255, b)})`;

                        const cellX = centerX + (x / gridSize - 0.5) * leafWidth;
                        const cellY = centerY + (y / gridSize - 0.5) * leafHeight;
                        const cellSize = leafWidth / gridSize;

                        ctx.fillRect(cellX - cellSize/2, cellY - cellSize/2, cellSize, cellSize);
                    }
                }
            }

            // Leaf veins
            ctx.strokeStyle = 'rgba(100, 80, 60, 0.5)';
            ctx.lineWidth = 2;

            // Main vein
            ctx.beginPath();
            ctx.moveTo(centerX, centerY - leafHeight * 0.4);
            ctx.lineTo(centerX, centerY + leafHeight * 0.45);
            ctx.stroke();

            // Side veins
            for (let i = 0; i < 5; i++) {
                const y = centerY - leafHeight * 0.3 + i * leafHeight * 0.15;
                const spread = leafWidth * 0.3 * (1 - Math.abs((i - 2) / 3));

                ctx.beginPath();
                ctx.moveTo(centerX, y);
                ctx.lineTo(centerX - spread, y - 10);
                ctx.moveTo(centerX, y);
                ctx.lineTo(centerX + spread, y - 10);
                ctx.stroke();
            }

            // Petiole (stem)
            ctx.strokeStyle = '#8b5cf6';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(centerX, centerY + leafHeight * 0.4);
            ctx.lineTo(centerX, centerY + leafHeight * 0.5);
            ctx.stroke();

            // Pigment composition bar
            const barY = canvas.height - 60;
            const barWidth = 200;
            const barHeight = 15;

            ctx.fillStyle = '#888';
            ctx.font = '10px sans-serif';
            ctx.fillText('Pigment composition:', padding, barY - 5);

            // Chlorophyll
            ctx.fillStyle = '#22c55e';
            ctx.fillRect(padding, barY, barWidth * leaf.chlorophyll, barHeight);

            // Carotenoids
            ctx.fillStyle = '#f59e0b';
            ctx.fillRect(padding + barWidth * leaf.chlorophyll, barY, barWidth * leaf.carotenoids, barHeight);

            // Anthocyanins
            ctx.fillStyle = '#dc2626';
            ctx.fillRect(padding + barWidth * (leaf.chlorophyll + leaf.carotenoids), barY, barWidth * leaf.anthocyanins * 0.5, barHeight);

            // Legend
            const legendY = canvas.height - 30;
            ctx.fillStyle = '#22c55e';
            ctx.fillRect(padding, legendY, 12, 8);
            ctx.fillStyle = '#888';
            ctx.fillText('Chlorophyll', padding + 16, legendY + 7);

            ctx.fillStyle = '#f59e0b';
            ctx.fillRect(padding + 90, legendY, 12, 8);
            ctx.fillText('Carotenoids', padding + 106, legendY + 7);

            ctx.fillStyle = '#dc2626';
            ctx.fillRect(padding + 190, legendY, 12, 8);
            ctx.fillText('Anthocyanins', padding + 206, legendY + 7);
        }

        function updateStats() {
            document.getElementById('generation').textContent = generation;
            document.getElementById('season').textContent = getSeason();
            document.getElementById('chlorophyll').textContent = (leaf.chlorophyll * 100).toFixed(0) + '%';
            document.getElementById('carotenoids').textContent = (leaf.carotenoids * 100).toFixed(0) + '%';
            document.getElementById('anthocyanins').textContent = (leaf.anthocyanins * 100).toFixed(0) + '%';
            document.getElementById('nRemob').textContent = (leaf.nitrogenRemobilized * 100).toFixed(0) + '%';
        }

        document.getElementById('daySlider').addEventListener('input', (e) => {
            dayLength = parseFloat(e.target.value);
            document.getElementById('dayValue').textContent = dayLength + 'h';
        });

        document.getElementById('tempSlider').addEventListener('input', (e) => {
            temperature = parseFloat(e.target.value);
            document.getElementById('tempValue').textContent = temperature + '¬∞C';
        });

        document.getElementById('nSlider').addEventListener('input', (e) => {
            nitrogenStatus = parseFloat(e.target.value);
            document.getElementById('nValue').textContent = nitrogenStatus.toFixed(1);
        });

        document.getElementById('senSlider').addEventListener('input', (e) => {
            senescenceRate = parseFloat(e.target.value);
            document.getElementById('senValue').textContent = senescenceRate.toFixed(1);
        });

        document.getElementById('startBtn').addEventListener('click', () => {
            running = !running;
            document.getElementById('startBtn').textContent = running ? 'Pause' : 'Start Simulation';
            if (running) update();
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            running = false;
            generation = 0;
            document.getElementById('startBtn').textContent = 'Start Simulation';
            initLeaf();
            render();
            updateStats();
        });

        initLeaf();
        render();
        updateStats();
    </script>
</body>
</html>
