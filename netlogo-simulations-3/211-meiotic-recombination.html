<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meiotic Recombination - NetLogo Simulations III</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 100%);
            min-height: 100vh;
            color: #e0e0e0;
            display: flex;
        }

        .container { flex: 1; display: flex; flex-direction: column; }

        header {
            padding: 15px 25px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(100,200,255,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-link { color: #64b5f6; text-decoration: none; }
        .back-link:hover { color: #90caf9; }

        h1 {
            font-size: 1.5rem;
            background: linear-gradient(90deg, #64b5f6, #4fc3f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .main-content { flex: 1; display: flex; overflow: hidden; }
        .canvas-container { flex: 1; position: relative; background: #050510; }
        canvas { width: 100%; height: 100%; }

        .control-panel {
            width: 320px;
            background: rgba(0,0,0,0.4);
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid rgba(100,200,255,0.2);
        }

        .panel-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .panel-section h3 {
            color: #4fc3f7;
            margin-bottom: 12px;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .control-group { margin-bottom: 12px; }
        .control-group label { display: block; font-size: 0.85rem; color: #aaa; margin-bottom: 5px; }
        .control-group input[type="range"] { width: 100%; margin-bottom: 3px; }
        .control-value { font-size: 0.8rem; color: #64b5f6; text-align: right; }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .btn-primary { background: linear-gradient(135deg, #1976d2, #1565c0); color: white; }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); }
        .btn-secondary:hover { background: rgba(255,255,255,0.2); }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-item { background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 1.3rem; font-weight: bold; color: #4fc3f7; }
        .stat-label { font-size: 0.75rem; color: #888; margin-top: 3px; }

        .phase-indicator {
            text-align: center;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            margin-top: 10px;
        }

        .phase-name { font-size: 1.2rem; font-weight: bold; color: #4fc3f7; }
        .phase-desc { font-size: 0.8rem; color: #888; margin-top: 5px; }

        .legend { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .legend-item { display: flex; align-items: center; gap: 5px; font-size: 0.75rem; }
        .legend-color { width: 14px; height: 14px; border-radius: 3px; }

        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: #1a1a2e;
            padding: 30px;
            border-radius: 12px;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(100,200,255,0.3);
        }

        .modal-content h2 { color: #4fc3f7; margin-bottom: 15px; }
        .modal-content p { line-height: 1.7; margin-bottom: 12px; color: #ccc; }
        .modal-content ul { margin-left: 20px; margin-bottom: 12px; }
        .modal-content li { margin-bottom: 6px; color: #bbb; }

        .close-btn { float: right; background: none; border: none; color: #888; font-size: 1.5rem; cursor: pointer; }
        .close-btn:hover { color: #fff; }
    
        .explain-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
        }
        .explain-btn:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            transform: translateY(-2px);
        }
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
        }
        .modal {
            background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%);
            border-radius: 16px;
            padding: 30px;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: #888;
            font-size: 28px;
            cursor: pointer;
            width: auto;
            padding: 0;
            margin: 0;
        }
        .modal-close:hover {
            color: #fff;
            background: none;
        }
        .modal h2 {
            color: #00d9ff;
            margin-bottom: 20px;
            font-size: 1.5rem;
            padding-right: 40px;
        }
        .modal-body {
            color: #ccc;
            line-height: 1.8;
            font-size: 0.95rem;
        }
        .modal-body h3 {
            color: #00ff88;
            margin: 20px 0 10px 0;
            font-size: 1.1rem;
        }
        .modal-body p {
            margin-bottom: 15px;
        }
        .modal-body ul {
            margin: 10px 0 15px 20px;
        }
        .modal-body li {
            margin-bottom: 8px;
        }
        .modal-body strong {
            color: #00d9ff;
        }
        .modal-body em {
            color: #a5b4fc;
            font-style: normal;
        }
        .modal-body code {
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            color: #fbbf24;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="index.html" class="back-link">‚Üê Back to Simulations</a>
            <h1>Meiotic Recombination</h1>
            <button class="btn btn-secondary" onclick="showModal()">Explain</button>
        </header>

        <div class="main-content">
            <div class="canvas-container">
                <canvas id="canvas"></canvas>
            </div>

            <div class="control-panel">
                <div class="panel-section">
                    <h3>Simulation Controls</h3>
                    <button class="btn btn-primary" id="startBtn" onclick="toggleSimulation()">Start</button>
                    <button class="btn btn-secondary" onclick="resetSimulation()">Reset</button>
                </div>

                <div class="panel-section">
                    <h3>Parameters</h3>

                    <div class="control-group">
                        <label>DSB Frequency (Spo11)</label>
                        <input type="range" id="dsbFrequency" min="3" max="12" step="1" value="6">
                        <div class="control-value"><span id="dsbFrequencyVal">6</span> breaks</div>
                    </div>

                    <div class="control-group">
                        <label>Crossover Interference</label>
                        <input type="range" id="interference" min="0" max="1" step="0.05" value="0.7">
                        <div class="control-value"><span id="interferenceVal">70</span>%</div>
                    </div>

                    <div class="control-group">
                        <label>CO/NCO Ratio</label>
                        <input type="range" id="coRatio" min="0.1" max="0.5" step="0.05" value="0.2">
                        <div class="control-value"><span id="coRatioVal">20</span>% CO</div>
                    </div>

                    <div class="control-group">
                        <label>Synapsis Rate</label>
                        <input type="range" id="synapsisRate" min="0.3" max="1" step="0.05" value="0.7">
                        <div class="control-value"><span id="synapsisRateVal">70</span>%</div>
                    </div>
                </div>

                <div class="panel-section">
                    <h3>Meiotic Prophase I Stage</h3>
                    <div class="phase-indicator">
                        <div class="phase-name" id="phaseName">Leptotene</div>
                        <div class="phase-desc" id="phaseDesc">Chromosomes condensing</div>
                    </div>
                </div>

                <div class="panel-section">
                    <h3>Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="dsbCount">0</div>
                            <div class="stat-label">DSBs Formed</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="crossoverCount">0</div>
                            <div class="stat-label">Crossovers (CO)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="ncoCount">0</div>
                            <div class="stat-label">Non-Crossovers</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="chiasmaCount">0</div>
                            <div class="stat-label">Chiasmata</div>
                        </div>
                    </div>
                </div>

                <div class="panel-section">
                    <h3>Legend</h3>
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #e57373;"></div>
                            <span>Maternal Chromatid</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #64b5f6;"></div>
                            <span>Paternal Chromatid</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ffeb3b;"></div>
                            <span>DSB (Spo11)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #81c784;"></div>
                            <span>Synaptonemal Complex</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ba68c8;"></div>
                            <span>Crossover/Chiasma</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="hideModal()">&times;</button>
            <h2>Meiotic Recombination</h2>
            <p>
                Meiotic recombination is essential for proper chromosome segregation and generating genetic diversity.
                It involves the exchange of DNA between homologous chromosomes during meiosis I prophase.
            </p>
            <h3>Stages of Prophase I</h3>
            <ul>
                <li><strong>Leptotene:</strong> Chromosomes condense and begin to pair</li>
                <li><strong>Zygotene:</strong> Homologs begin synapsis; synaptonemal complex forms</li>
                <li><strong>Pachytene:</strong> Full synapsis; crossing over occurs</li>
                <li><strong>Diplotene:</strong> SC disassembles; chiasmata become visible</li>
                <li><strong>Diakinesis:</strong> Chromosomes fully condensed for metaphase I</li>
            </ul>
            <h3>DSB Formation by Spo11</h3>
            <p>
                The topoisomerase-like protein Spo11 creates ~150-200 programmed double-strand breaks (DSBs) genome-wide
                in yeast. Only a fraction (~5-10%) of these mature into crossovers; the rest are repaired as non-crossovers.
            </p>
            <h3>Crossover Interference</h3>
            <p>
                Crossover interference is the phenomenon where the occurrence of one crossover reduces the probability
                of another nearby. This helps ensure even spacing of crossovers across chromosomes. The mechanism
                involves the synaptonemal complex and several protein complexes.
            </p>
            <h3>Obligate Chiasma</h3>
            <p>
                Each chromosome pair must have at least one crossover (obligate chiasma) to ensure proper segregation
                at anaphase I. Without chiasmata, homologs may segregate randomly, leading to aneuploidy.
            </p>
            <h3>CO vs NCO Repair</h3>
            <p>
                DSBs can be repaired as crossovers (CO) with reciprocal exchange, or non-crossovers (NCO) via synthesis-
                dependent strand annealing (SDSA). MLH1/MLH3 mark sites destined for crossover resolution.
            </p>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let running = false;
        let animationId = null;

        // Meiotic stages
        const STAGES = ['leptotene', 'zygotene', 'pachytene', 'diplotene', 'diakinesis'];

        let state = {
            stage: 'leptotene',
            stageProgress: 0,
            chromosomes: [],
            dsbs: [],
            crossovers: [],
            ncos: [],
            synapsisLevel: 0,
            time: 0
        };

        const params = {
            dsbFrequency: 6,
            interference: 0.7,
            coRatio: 0.2,
            synapsisRate: 0.7
        };

        function resize() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
            initChromosomes();
        }

        function initChromosomes() {
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;

            // Create homologous pair (maternal and paternal)
            state.chromosomes = [
                { // Maternal (2 sister chromatids)
                    x: cx - 30,
                    y: cy,
                    color: '#e57373',
                    segments: []
                },
                { // Paternal (2 sister chromatids)
                    x: cx + 30,
                    y: cy,
                    color: '#64b5f6',
                    segments: []
                }
            ];

            // Create chromosome segments for visualization
            const segmentCount = 20;
            state.chromosomes.forEach(chr => {
                chr.segments = [];
                for (let i = 0; i < segmentCount; i++) {
                    chr.segments.push({
                        y: cy - 180 + i * 18,
                        originalColor: chr.color
                    });
                }
            });

            state.dsbs = [];
            state.crossovers = [];
            state.ncos = [];
        }

        function resetSimulation() {
            running = false;
            document.getElementById('startBtn').textContent = 'Start';

            state = {
                stage: 'leptotene',
                stageProgress: 0,
                chromosomes: [],
                dsbs: [],
                crossovers: [],
                ncos: [],
                synapsisLevel: 0,
                time: 0
            };

            initChromosomes();
            updateStats();
            draw();
        }

        function toggleSimulation() {
            running = !running;
            document.getElementById('startBtn').textContent = running ? 'Pause' : 'Start';
            if (running) animate();
        }

        function updateParams() {
            params.dsbFrequency = parseInt(document.getElementById('dsbFrequency').value);
            params.interference = parseFloat(document.getElementById('interference').value);
            params.coRatio = parseFloat(document.getElementById('coRatio').value);
            params.synapsisRate = parseFloat(document.getElementById('synapsisRate').value);

            document.getElementById('dsbFrequencyVal').textContent = params.dsbFrequency;
            document.getElementById('interferenceVal').textContent = Math.round(params.interference * 100);
            document.getElementById('coRatioVal').textContent = Math.round(params.coRatio * 100);
            document.getElementById('synapsisRateVal').textContent = Math.round(params.synapsisRate * 100);
        }

        document.querySelectorAll('input[type="range"]').forEach(input => {
            input.addEventListener('input', updateParams);
        });

        function update() {
            state.time++;
            state.stageProgress += 0.005;

            const cx = canvas.width / 2;

            // Stage transitions
            if (state.stageProgress >= 1) {
                state.stageProgress = 0;
                const currentIndex = STAGES.indexOf(state.stage);
                if (currentIndex < STAGES.length - 1) {
                    state.stage = STAGES[currentIndex + 1];
                }
            }

            switch (state.stage) {
                case 'leptotene':
                    // Chromosomes condensing and beginning to pair
                    break;

                case 'zygotene':
                    // Synapsis begins - homologs pair up
                    if (state.synapsisLevel < 1) {
                        state.synapsisLevel += 0.01 * params.synapsisRate;
                    }

                    // Homologs come together
                    const separation = 60 * (1 - state.synapsisLevel);
                    state.chromosomes[0].x = cx - separation / 2;
                    state.chromosomes[1].x = cx + separation / 2;

                    // DSB formation by Spo11
                    if (state.dsbs.length < params.dsbFrequency && Math.random() < 0.03) {
                        const segmentIdx = Math.floor(Math.random() * 20);

                        // Check interference - avoid DSBs near existing ones
                        let tooClose = false;
                        state.dsbs.forEach(dsb => {
                            if (Math.abs(dsb.segmentIdx - segmentIdx) < 3 * params.interference) {
                                tooClose = true;
                            }
                        });

                        if (!tooClose) {
                            state.dsbs.push({
                                segmentIdx: segmentIdx,
                                processing: true,
                                resolved: false,
                                isCrossover: Math.random() < params.coRatio
                            });
                        }
                    }
                    break;

                case 'pachytene':
                    // Full synapsis - chromosomes fully paired
                    state.synapsisLevel = 1;
                    state.chromosomes[0].x = cx - 5;
                    state.chromosomes[1].x = cx + 5;

                    // Process DSBs into crossovers or non-crossovers
                    state.dsbs.forEach(dsb => {
                        if (dsb.processing && Math.random() < 0.02) {
                            dsb.processing = false;
                            dsb.resolved = true;

                            if (dsb.isCrossover) {
                                // Apply crossover interference
                                let blocked = false;
                                state.crossovers.forEach(co => {
                                    const distance = Math.abs(co.segmentIdx - dsb.segmentIdx);
                                    if (distance < 5 && Math.random() < params.interference) {
                                        blocked = true;
                                    }
                                });

                                if (!blocked) {
                                    state.crossovers.push({ segmentIdx: dsb.segmentIdx });

                                    // Exchange segments below crossover point
                                    for (let i = dsb.segmentIdx; i < 20; i++) {
                                        const temp = state.chromosomes[0].segments[i].originalColor;
                                        state.chromosomes[0].segments[i].originalColor = state.chromosomes[1].segments[i].originalColor;
                                        state.chromosomes[1].segments[i].originalColor = temp;
                                    }
                                } else {
                                    state.ncos.push({ segmentIdx: dsb.segmentIdx });
                                }
                            } else {
                                state.ncos.push({ segmentIdx: dsb.segmentIdx });
                            }
                        }
                    });

                    // Ensure at least one crossover (obligate chiasma)
                    if (state.stageProgress > 0.8 && state.crossovers.length === 0 && state.dsbs.length > 0) {
                        const dsb = state.dsbs.find(d => !d.resolved);
                        if (dsb) {
                            dsb.resolved = true;
                            dsb.processing = false;
                            state.crossovers.push({ segmentIdx: dsb.segmentIdx });
                        }
                    }
                    break;

                case 'diplotene':
                    // SC disassembles - chiasmata become visible
                    state.synapsisLevel = Math.max(0, state.synapsisLevel - 0.02);

                    // Homologs separate except at chiasmata
                    const dipSep = 40 * (1 - state.synapsisLevel);
                    state.chromosomes[0].x = cx - dipSep / 2;
                    state.chromosomes[1].x = cx + dipSep / 2;
                    break;

                case 'diakinesis':
                    // Final condensation before metaphase I
                    break;
            }

            updateStats();
        }

        function updateStats() {
            document.getElementById('dsbCount').textContent = state.dsbs.length;
            document.getElementById('crossoverCount').textContent = state.crossovers.length;
            document.getElementById('ncoCount').textContent = state.ncos.length;
            document.getElementById('chiasmaCount').textContent = state.crossovers.length;

            const stageInfo = {
                leptotene: { name: 'Leptotene', desc: 'Chromosomes condensing' },
                zygotene: { name: 'Zygotene', desc: 'Synapsis beginning, DSBs forming' },
                pachytene: { name: 'Pachytene', desc: 'Full synapsis, crossing over' },
                diplotene: { name: 'Diplotene', desc: 'SC disassembling, chiasmata visible' },
                diakinesis: { name: 'Diakinesis', desc: 'Final condensation' }
            };

            document.getElementById('phaseName').textContent = stageInfo[state.stage].name;
            document.getElementById('phaseDesc').textContent = stageInfo[state.stage].desc;
        }

        function draw() {
            ctx.fillStyle = '#050510';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const cx = canvas.width / 2;
            const cy = canvas.height / 2;

            // Draw synaptonemal complex if present
            if (state.synapsisLevel > 0.3) {
                ctx.strokeStyle = `rgba(129, 199, 132, ${state.synapsisLevel * 0.6})`;
                ctx.lineWidth = 8;
                ctx.beginPath();
                ctx.moveTo(cx, cy - 180);
                ctx.lineTo(cx, cy + 180);
                ctx.stroke();

                // SC ladder rungs
                ctx.strokeStyle = `rgba(129, 199, 132, ${state.synapsisLevel * 0.4})`;
                ctx.lineWidth = 2;
                for (let y = cy - 170; y < cy + 170; y += 20) {
                    ctx.beginPath();
                    ctx.moveTo(cx - 15, y);
                    ctx.lineTo(cx + 15, y);
                    ctx.stroke();
                }
            }

            // Draw chromosomes
            state.chromosomes.forEach((chr, chrIdx) => {
                // Draw each segment
                chr.segments.forEach((seg, segIdx) => {
                    // Sister chromatids (2 per chromosome)
                    const offset = chrIdx === 0 ? -8 : 8;

                    // First chromatid
                    ctx.fillStyle = seg.originalColor;
                    ctx.fillRect(chr.x + offset - 6, seg.y - 7, 6, 16);

                    // Second chromatid (sister)
                    ctx.fillRect(chr.x + offset + 2, seg.y - 7, 6, 16);

                    // Centromere connection
                    if (segIdx === 10) {
                        ctx.fillStyle = '#ffeb3b';
                        ctx.beginPath();
                        ctx.ellipse(chr.x + offset, seg.y, 4, 8, 0, 0, Math.PI * 2);
                        ctx.fill();
                    }
                });
            });

            // Draw DSBs
            state.dsbs.forEach(dsb => {
                const y = cy - 180 + dsb.segmentIdx * 18;

                if (dsb.processing) {
                    // Active DSB - yellow flash
                    ctx.fillStyle = '#ffeb3b';
                    ctx.beginPath();
                    ctx.arc(cx, y, 8 + Math.sin(state.time * 0.2) * 2, 0, Math.PI * 2);
                    ctx.fill();

                    // Spo11 label
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 8px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('Spo11', cx, y - 15);
                }
            });

            // Draw crossovers/chiasmata
            state.crossovers.forEach(co => {
                const y = cy - 180 + co.segmentIdx * 18;

                // Chiasma visualization - X shape
                ctx.strokeStyle = '#ba68c8';
                ctx.lineWidth = 4;

                const x1 = state.chromosomes[0].x;
                const x2 = state.chromosomes[1].x;

                ctx.beginPath();
                ctx.moveTo(x1 - 10, y - 10);
                ctx.lineTo(x2 + 10, y + 10);
                ctx.stroke();

                ctx.beginPath();
                ctx.moveTo(x2 + 10, y - 10);
                ctx.lineTo(x1 - 10, y + 10);
                ctx.stroke();

                // Highlight
                ctx.fillStyle = 'rgba(186, 104, 200, 0.3)';
                ctx.beginPath();
                ctx.arc(cx, y, 15, 0, Math.PI * 2);
                ctx.fill();
            });

            // Draw NCO markers (gene conversion)
            state.ncos.forEach(nco => {
                const y = cy - 180 + nco.segmentIdx * 18;

                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = 2;
                ctx.setLineDash([3, 3]);
                ctx.beginPath();
                ctx.arc(cx, y, 10, 0, Math.PI * 2);
                ctx.stroke();
                ctx.setLineDash([]);
            });

            // Labels
            ctx.fillStyle = '#aaa';
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Homologous Chromosome Pair', cx, 40);

            ctx.font = '11px sans-serif';
            ctx.fillStyle = '#e57373';
            ctx.fillText('Maternal', state.chromosomes[0].x - 20, cy + 210);
            ctx.fillStyle = '#64b5f6';
            ctx.fillText('Paternal', state.chromosomes[1].x + 20, cy + 210);

            // Stage progress bar
            ctx.fillStyle = 'rgba(255,255,255,0.2)';
            ctx.fillRect(50, canvas.height - 40, 200, 8);
            ctx.fillStyle = '#4fc3f7';
            ctx.fillRect(50, canvas.height - 40, 200 * state.stageProgress, 8);
        }

        function animate() {
            if (!running) return;

            update();
            draw();
            animationId = requestAnimationFrame(animate);
        }

        function showModal() {
            document.getElementById('modal').classList.add('active');
        }

        function hideModal() {
            document.getElementById('modal').classList.remove('active');
        }

        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target.id === 'modal') hideModal();
        });

        window.addEventListener('resize', resize);
        resize();
        updateParams();
        draw();
    

    // Modal functionality
    const modal = document.getElementById('explainModal');
    if (modal) {
        document.getElementById('explainBtn').addEventListener('click', () => {
            modal.classList.add('active');
        });
        modal.querySelector('.modal-close').addEventListener('click', () => {
            modal.classList.remove('active');
        });
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.classList.remove('active');
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal.classList.contains('active')) {
                modal.classList.remove('active');
            }
        });
    }

    </script>

    <div id="explainModal" class="modal-overlay">
        <div class="modal">
            <button class="modal-close">&times;</button>
            <h2>üìä Meiotic Recombination</h2>
            <div class="modal-body">
                <p>This agent-based simulation explores concepts from <strong>molecular mechanisms and biochemical pathways</strong>.</p>

                <h3>What This Simulation Models</h3>
                <p>Build a crossover formation model with interference and obligate chiasma.</p>

                <h3>Key Concepts</h3>
                <ul>
                    <li><strong>Agent-Based Modeling:</strong> Individual agents follow simple rules, producing complex emergent behaviors</li>
                    <li><strong>Emergent Properties:</strong> System-level patterns arise from local interactions</li>
                    <li><strong>Parameter Exploration:</strong> Adjust controls to explore different scenarios and outcomes</li>
                </ul>

                <h3>How to Explore</h3>
                <ul>
                    <li>Use the sliders to modify simulation parameters</li>
                    <li>Observe how changes affect the overall system behavior</li>
                    <li>Look for phase transitions and tipping points</li>
                    <li>Consider what real-world phenomena this model might represent</li>
                </ul>

                <h3>Category: Biochemistry & Molecular Biology</h3>
                <p>This simulation is part of the <em>Biochemistry & Molecular Biology</em> collection, which explores various aspects of molecular mechanisms and biochemical pathways.</p>
            </div>
        </div>
    </div>

</body>
</html>
