<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meiotic Recombination - NetLogo Simulations III</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 100%);
            min-height: 100vh;
            color: #e0e0e0;
            display: flex;
        }

        .container { flex: 1; display: flex; flex-direction: column; }

        header {
            padding: 15px 25px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(100,200,255,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-link { color: #64b5f6; text-decoration: none; }
        .back-link:hover { color: #90caf9; }

        h1 {
            font-size: 1.5rem;
            background: linear-gradient(90deg, #64b5f6, #4fc3f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .main-content { flex: 1; display: flex; overflow: hidden; }
        .canvas-container { flex: 1; position: relative; background: #050510; }
        canvas { width: 100%; height: 100%; }

        .control-panel {
            width: 320px;
            background: rgba(0,0,0,0.4);
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid rgba(100,200,255,0.2);
        }

        .panel-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .panel-section h3 {
            color: #4fc3f7;
            margin-bottom: 12px;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .control-group { margin-bottom: 12px; }
        .control-group label { display: block; font-size: 0.85rem; color: #aaa; margin-bottom: 5px; }
        .control-group input[type="range"] { width: 100%; margin-bottom: 3px; }
        .control-value { font-size: 0.8rem; color: #64b5f6; text-align: right; }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .btn-primary { background: linear-gradient(135deg, #1976d2, #1565c0); color: white; }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); }
        .btn-secondary:hover { background: rgba(255,255,255,0.2); }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-item { background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 1.3rem; font-weight: bold; color: #4fc3f7; }
        .stat-label { font-size: 0.75rem; color: #888; margin-top: 3px; }

        .phase-indicator {
            text-align: center;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            margin-top: 10px;
        }

        .phase-name { font-size: 1.2rem; font-weight: bold; color: #4fc3f7; }
        .phase-desc { font-size: 0.8rem; color: #888; margin-top: 5px; }

        .legend { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .legend-item { display: flex; align-items: center; gap: 5px; font-size: 0.75rem; }
        .legend-color { width: 14px; height: 14px; border-radius: 3px; }

        .modal.active { display: flex; }

        .modal-content {
            background: #1a1a2e;
            padding: 30px;
            border-radius: 12px;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(100,200,255,0.3);
        }

        .modal-content h2 { color: #4fc3f7; margin-bottom: 15px; }
        .modal-content p { line-height: 1.7; margin-bottom: 12px; color: #ccc; }
        .modal-content ul { margin-left: 20px; margin-bottom: 12px; }
        .modal-content li { margin-bottom: 6px; color: #bbb; }

        .close-btn { float: right; background: none; border: none; color: #888; font-size: 1.5rem; cursor: pointer; }
        .close-btn:hover { color: #fff; }
    
        .explain-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            font-weight: 600;
        }
        .explain-btn:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            padding: 20px;
            overflow-y: auto;
        }
        .modal-overlay.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }
        .modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #252542 100%);
            border-radius: 20px;
            padding: 35px;
            max-width: 750px;
            width: 100%;
            margin: 40px auto;
            position: relative;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        .modal-close:hover {
            color: #fff;
            background: rgba(255,255,255,0.2);
        }
        .modal h2 {
            color: #00d9ff;
            margin-bottom: 25px;
            font-size: 1.6rem;
            padding-right: 50px;
            line-height: 1.3;
        }
        .modal-body {
            color: #d1d5db;
            line-height: 1.9;
            font-size: 1rem;
        }
        .modal-body h3 {
            color: #00ff88;
            margin: 28px 0 14px 0;
            font-size: 1.15rem;
            font-weight: 600;
        }
        .modal-body p {
            margin-bottom: 16px;
        }
        .modal-body ul {
            margin: 12px 0 18px 24px;
        }
        .modal-body li {
            margin-bottom: 10px;
        }
        .modal-body strong {
            color: #00d9ff;
        }
        .modal-body em {
            color: #a5b4fc;
            font-style: italic;
        }
        .modal-body code {
            background: rgba(0,0,0,0.3);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Fira Code', monospace;
            color: #fbbf24;
            font-size: 0.9em;
        }
        .modal-category {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="index.html" class="back-link">‚Üê Back to Simulations</a>
            <h1>Meiotic Recombination</h1>
            <button class="btn btn-secondary" onclick="showModal()">Explain</button>
        </header>

        <div class="main-content">
            <div class="canvas-container">
                <canvas id="canvas"></canvas>
            </div>

            <div class="control-panel">
                <div class="panel-section">
                    <h3>Simulation Controls</h3>
                    <button class="btn btn-primary" id="startBtn" onclick="toggleSimulation()">Start</button>
                    <button class="btn btn-secondary" onclick="resetSimulation()">Reset</button>
                <button id="explainBtn" class="explain-btn">üìö Explain This Simulation</button>
                </div>

                <div class="panel-section">
                    <h3>Parameters</h3>

                    <div class="control-group">
                        <label>DSB Frequency (Spo11)</label>
                        <input type="range" id="dsbFrequency" min="3" max="12" step="1" value="6">
                        <div class="control-value"><span id="dsbFrequencyVal">6</span> breaks</div>
                    </div>

                    <div class="control-group">
                        <label>Crossover Interference</label>
                        <input type="range" id="interference" min="0" max="1" step="0.05" value="0.7">
                        <div class="control-value"><span id="interferenceVal">70</span>%</div>
                    </div>

                    <div class="control-group">
                        <label>CO/NCO Ratio</label>
                        <input type="range" id="coRatio" min="0.1" max="0.5" step="0.05" value="0.2">
                        <div class="control-value"><span id="coRatioVal">20</span>% CO</div>
                    </div>

                    <div class="control-group">
                        <label>Synapsis Rate</label>
                        <input type="range" id="synapsisRate" min="0.3" max="1" step="0.05" value="0.7">
                        <div class="control-value"><span id="synapsisRateVal">70</span>%</div>
                    </div>
                </div>

                <div class="panel-section">
                    <h3>Meiotic Prophase I Stage</h3>
                    <div class="phase-indicator">
                        <div class="phase-name" id="phaseName">Leptotene</div>
                        <div class="phase-desc" id="phaseDesc">Chromosomes condensing</div>
                    </div>
                </div>

                <div class="panel-section">
                    <h3>Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="dsbCount">0</div>
                            <div class="stat-label">DSBs Formed</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="crossoverCount">0</div>
                            <div class="stat-label">Crossovers (CO)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="ncoCount">0</div>
                            <div class="stat-label">Non-Crossovers</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="chiasmaCount">0</div>
                            <div class="stat-label">Chiasmata</div>
                        </div>
                    </div>
                </div>

                <div class="panel-section">
                    <h3>Legend</h3>
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #e57373;"></div>
                            <span>Maternal Chromatid</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #64b5f6;"></div>
                            <span>Paternal Chromatid</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ffeb3b;"></div>
                            <span>DSB (Spo11)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #81c784;"></div>
                            <span>Synaptonemal Complex</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ba68c8;"></div>
                            <span>Crossover/Chiasma</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="hideModal()">&times;</button>
            <h2>Meiotic Recombination</h2>
            <p>
                Meiotic recombination is essential for proper chromosome segregation and generating genetic diversity.
                It involves the exchange of DNA between homologous chromosomes during meiosis I prophase.
            </p>
            <h3>Stages of Prophase I</h3>
            <ul>
                <li><strong>Leptotene:</strong> Chromosomes condense and begin to pair</li>
                <li><strong>Zygotene:</strong> Homologs begin synapsis; synaptonemal complex forms</li>
                <li><strong>Pachytene:</strong> Full synapsis; crossing over occurs</li>
                <li><strong>Diplotene:</strong> SC disassembles; chiasmata become visible</li>
                <li><strong>Diakinesis:</strong> Chromosomes fully condensed for metaphase I</li>
            </ul>
            <h3>DSB Formation by Spo11</h3>
            <p>
                The topoisomerase-like protein Spo11 creates ~150-200 programmed double-strand breaks (DSBs) genome-wide
                in yeast. Only a fraction (~5-10%) of these mature into crossovers; the rest are repaired as non-crossovers.
            </p>
            <h3>Crossover Interference</h3>
            <p>
                Crossover interference is the phenomenon where the occurrence of one crossover reduces the probability
                of another nearby. This helps ensure even spacing of crossovers across chromosomes. The mechanism
                involves the synaptonemal complex and several protein complexes.
            </p>
            <h3>Obligate Chiasma</h3>
            <p>
                Each chromosome pair must have at least one crossover (obligate chiasma) to ensure proper segregation
                at anaphase I. Without chiasmata, homologs may segregate randomly, leading to aneuploidy.
            </p>
            <h3>CO vs NCO Repair</h3>
            <p>
                DSBs can be repaired as crossovers (CO) with reciprocal exchange, or non-crossovers (NCO) via synthesis-
                dependent strand annealing (SDSA). MLH1/MLH3 mark sites destined for crossover resolution.
            </p>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let running = false;
        let animationId = null;

        // Meiotic stages
        const STAGES = ['leptotene', 'zygotene', 'pachytene', 'diplotene', 'diakinesis'];

        let state = {
            stage: 'leptotene',
            stageProgress: 0,
            chromosomes: [],
            dsbs: [],
            crossovers: [],
            ncos: [],
            synapsisLevel: 0,
            time: 0
        };

        const params = {
            dsbFrequency: 6,
            interference: 0.7,
            coRatio: 0.2,
            synapsisRate: 0.7
        };

        function resize() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
            initChromosomes();
        }

        function initChromosomes() {
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;

            // Create homologous pair (maternal and paternal)
            state.chromosomes = [
                { // Maternal (2 sister chromatids)
                    x: cx - 30,
                    y: cy,
                    color: '#e57373',
                    segments: []
                },
                { // Paternal (2 sister chromatids)
                    x: cx + 30,
                    y: cy,
                    color: '#64b5f6',
                    segments: []
                }
            ];

            // Create chromosome segments for visualization
            const segmentCount = 20;
            state.chromosomes.forEach(chr => {
                chr.segments = [];
                for (let i = 0; i < segmentCount; i++) {
                    chr.segments.push({
                        y: cy - 180 + i * 18,
                        originalColor: chr.color
                    });
                }
            });

            state.dsbs = [];
            state.crossovers = [];
            state.ncos = [];
        }

        function resetSimulation() {
            running = false;
            document.getElementById('startBtn').textContent = 'Start';

            state = {
                stage: 'leptotene',
                stageProgress: 0,
                chromosomes: [],
                dsbs: [],
                crossovers: [],
                ncos: [],
                synapsisLevel: 0,
                time: 0
            };

            initChromosomes();
            updateStats();
            draw();
        }

        function toggleSimulation() {
            running = !running;
            document.getElementById('startBtn').textContent = running ? 'Pause' : 'Start';
            if (running) animate();
        }

        function updateParams() {
            params.dsbFrequency = parseInt(document.getElementById('dsbFrequency').value);
            params.interference = parseFloat(document.getElementById('interference').value);
            params.coRatio = parseFloat(document.getElementById('coRatio').value);
            params.synapsisRate = parseFloat(document.getElementById('synapsisRate').value);

            document.getElementById('dsbFrequencyVal').textContent = params.dsbFrequency;
            document.getElementById('interferenceVal').textContent = Math.round(params.interference * 100);
            document.getElementById('coRatioVal').textContent = Math.round(params.coRatio * 100);
            document.getElementById('synapsisRateVal').textContent = Math.round(params.synapsisRate * 100);
        }

        document.querySelectorAll('input[type="range"]').forEach(input => {
            input.addEventListener('input', updateParams);
        });

        function update() {
            state.time++;
            state.stageProgress += 0.005;

            const cx = canvas.width / 2;

            // Stage transitions
            if (state.stageProgress >= 1) {
                state.stageProgress = 0;
                const currentIndex = STAGES.indexOf(state.stage);
                if (currentIndex < STAGES.length - 1) {
                    state.stage = STAGES[currentIndex + 1];
                }
            }

            switch (state.stage) {
                case 'leptotene':
                    // Chromosomes condensing and beginning to pair
                    break;

                case 'zygotene':
                    // Synapsis begins - homologs pair up
                    if (state.synapsisLevel < 1) {
                        state.synapsisLevel += 0.01 * params.synapsisRate;
                    }

                    // Homologs come together
                    const separation = 60 * (1 - state.synapsisLevel);
                    state.chromosomes[0].x = cx - separation / 2;
                    state.chromosomes[1].x = cx + separation / 2;

                    // DSB formation by Spo11
                    if (state.dsbs.length < params.dsbFrequency && Math.random() < 0.03) {
                        const segmentIdx = Math.floor(Math.random() * 20);

                        // Check interference - avoid DSBs near existing ones
                        let tooClose = false;
                        state.dsbs.forEach(dsb => {
                            if (Math.abs(dsb.segmentIdx - segmentIdx) < 3 * params.interference) {
                                tooClose = true;
                            }
                        });

                        if (!tooClose) {
                            state.dsbs.push({
                                segmentIdx: segmentIdx,
                                processing: true,
                                resolved: false,
                                isCrossover: Math.random() < params.coRatio
                            });
                        }
                    }
                    break;

                case 'pachytene':
                    // Full synapsis - chromosomes fully paired
                    state.synapsisLevel = 1;
                    state.chromosomes[0].x = cx - 5;
                    state.chromosomes[1].x = cx + 5;

                    // Process DSBs into crossovers or non-crossovers
                    state.dsbs.forEach(dsb => {
                        if (dsb.processing && Math.random() < 0.02) {
                            dsb.processing = false;
                            dsb.resolved = true;

                            if (dsb.isCrossover) {
                                // Apply crossover interference
                                let blocked = false;
                                state.crossovers.forEach(co => {
                                    const distance = Math.abs(co.segmentIdx - dsb.segmentIdx);
                                    if (distance < 5 && Math.random() < params.interference) {
                                        blocked = true;
                                    }
                                });

                                if (!blocked) {
                                    state.crossovers.push({ segmentIdx: dsb.segmentIdx });

                                    // Exchange segments below crossover point
                                    for (let i = dsb.segmentIdx; i < 20; i++) {
                                        const temp = state.chromosomes[0].segments[i].originalColor;
                                        state.chromosomes[0].segments[i].originalColor = state.chromosomes[1].segments[i].originalColor;
                                        state.chromosomes[1].segments[i].originalColor = temp;
                                    }
                                } else {
                                    state.ncos.push({ segmentIdx: dsb.segmentIdx });
                                }
                            } else {
                                state.ncos.push({ segmentIdx: dsb.segmentIdx });
                            }
                        }
                    });

                    // Ensure at least one crossover (obligate chiasma)
                    if (state.stageProgress > 0.8 && state.crossovers.length === 0 && state.dsbs.length > 0) {
                        const dsb = state.dsbs.find(d => !d.resolved);
                        if (dsb) {
                            dsb.resolved = true;
                            dsb.processing = false;
                            state.crossovers.push({ segmentIdx: dsb.segmentIdx });
                        }
                    }
                    break;

                case 'diplotene':
                    // SC disassembles - chiasmata become visible
                    state.synapsisLevel = Math.max(0, state.synapsisLevel - 0.02);

                    // Homologs separate except at chiasmata
                    const dipSep = 40 * (1 - state.synapsisLevel);
                    state.chromosomes[0].x = cx - dipSep / 2;
                    state.chromosomes[1].x = cx + dipSep / 2;
                    break;

                case 'diakinesis':
                    // Final condensation before metaphase I
                    break;
            }

            updateStats();
        }

        function updateStats() {
            document.getElementById('dsbCount').textContent = state.dsbs.length;
            document.getElementById('crossoverCount').textContent = state.crossovers.length;
            document.getElementById('ncoCount').textContent = state.ncos.length;
            document.getElementById('chiasmaCount').textContent = state.crossovers.length;

            const stageInfo = {
                leptotene: { name: 'Leptotene', desc: 'Chromosomes condensing' },
                zygotene: { name: 'Zygotene', desc: 'Synapsis beginning, DSBs forming' },
                pachytene: { name: 'Pachytene', desc: 'Full synapsis, crossing over' },
                diplotene: { name: 'Diplotene', desc: 'SC disassembling, chiasmata visible' },
                diakinesis: { name: 'Diakinesis', desc: 'Final condensation' }
            };

            document.getElementById('phaseName').textContent = stageInfo[state.stage].name;
            document.getElementById('phaseDesc').textContent = stageInfo[state.stage].desc;
        }

        function draw() {
            ctx.fillStyle = '#050510';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const cx = canvas.width / 2;
            const cy = canvas.height / 2;

            // Draw synaptonemal complex if present
            if (state.synapsisLevel > 0.3) {
                ctx.strokeStyle = `rgba(129, 199, 132, ${state.synapsisLevel * 0.6})`;
                ctx.lineWidth = 8;
                ctx.beginPath();
                ctx.moveTo(cx, cy - 180);
                ctx.lineTo(cx, cy + 180);
                ctx.stroke();

                // SC ladder rungs
                ctx.strokeStyle = `rgba(129, 199, 132, ${state.synapsisLevel * 0.4})`;
                ctx.lineWidth = 2;
                for (let y = cy - 170; y < cy + 170; y += 20) {
                    ctx.beginPath();
                    ctx.moveTo(cx - 15, y);
                    ctx.lineTo(cx + 15, y);
                    ctx.stroke();
                }
            }

            // Draw chromosomes
            state.chromosomes.forEach((chr, chrIdx) => {
                // Draw each segment
                chr.segments.forEach((seg, segIdx) => {
                    // Sister chromatids (2 per chromosome)
                    const offset = chrIdx === 0 ? -8 : 8;

                    // First chromatid
                    ctx.fillStyle = seg.originalColor;
                    ctx.fillRect(chr.x + offset - 6, seg.y - 7, 6, 16);

                    // Second chromatid (sister)
                    ctx.fillRect(chr.x + offset + 2, seg.y - 7, 6, 16);

                    // Centromere connection
                    if (segIdx === 10) {
                        ctx.fillStyle = '#ffeb3b';
                        ctx.beginPath();
                        ctx.ellipse(chr.x + offset, seg.y, 4, 8, 0, 0, Math.PI * 2);
                        ctx.fill();
                    }
                });
            });

            // Draw DSBs
            state.dsbs.forEach(dsb => {
                const y = cy - 180 + dsb.segmentIdx * 18;

                if (dsb.processing) {
                    // Active DSB - yellow flash
                    ctx.fillStyle = '#ffeb3b';
                    ctx.beginPath();
                    ctx.arc(cx, y, 8 + Math.sin(state.time * 0.2) * 2, 0, Math.PI * 2);
                    ctx.fill();

                    // Spo11 label
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 8px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('Spo11', cx, y - 15);
                }
            });

            // Draw crossovers/chiasmata
            state.crossovers.forEach(co => {
                const y = cy - 180 + co.segmentIdx * 18;

                // Chiasma visualization - X shape
                ctx.strokeStyle = '#ba68c8';
                ctx.lineWidth = 4;

                const x1 = state.chromosomes[0].x;
                const x2 = state.chromosomes[1].x;

                ctx.beginPath();
                ctx.moveTo(x1 - 10, y - 10);
                ctx.lineTo(x2 + 10, y + 10);
                ctx.stroke();

                ctx.beginPath();
                ctx.moveTo(x2 + 10, y - 10);
                ctx.lineTo(x1 - 10, y + 10);
                ctx.stroke();

                // Highlight
                ctx.fillStyle = 'rgba(186, 104, 200, 0.3)';
                ctx.beginPath();
                ctx.arc(cx, y, 15, 0, Math.PI * 2);
                ctx.fill();
            });

            // Draw NCO markers (gene conversion)
            state.ncos.forEach(nco => {
                const y = cy - 180 + nco.segmentIdx * 18;

                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = 2;
                ctx.setLineDash([3, 3]);
                ctx.beginPath();
                ctx.arc(cx, y, 10, 0, Math.PI * 2);
                ctx.stroke();
                ctx.setLineDash([]);
            });

            // Labels
            ctx.fillStyle = '#aaa';
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Homologous Chromosome Pair', cx, 40);

            ctx.font = '11px sans-serif';
            ctx.fillStyle = '#e57373';
            ctx.fillText('Maternal', state.chromosomes[0].x - 20, cy + 210);
            ctx.fillStyle = '#64b5f6';
            ctx.fillText('Paternal', state.chromosomes[1].x + 20, cy + 210);

            // Stage progress bar
            ctx.fillStyle = 'rgba(255,255,255,0.2)';
            ctx.fillRect(50, canvas.height - 40, 200, 8);
            ctx.fillStyle = '#4fc3f7';
            ctx.fillRect(50, canvas.height - 40, 200 * state.stageProgress, 8);
        }

        function animate() {
            if (!running) return;

            update();
            draw();
            animationId = requestAnimationFrame(animate);
        }

        function showModal() {
            document.getElementById('modal').classList.add('active');
        }

        function hideModal() {
            document.getElementById('modal').classList.remove('active');
        }

        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target.id === 'modal') hideModal();
        });

        window.addEventListener('resize', resize);
        resize();
        updateParams();
        draw();
    </script>


    <div id="explainModal" class="modal-overlay">
        <div class="modal">
            <button class="modal-close">&times;</button>
            <h2>üìä Meiotic Recombination</h2>
            <div class="modal-body">
                <p>Life operates through precise molecular machinery. This simulation models biochemical reactions and molecular interactions at the cellular level.</p>

                <h3>About This Simulation</h3>
                <p>Build a crossover formation model with interference and obligate chiasma.</p>

                <h3>Key Concepts</h3>
                <ul>
                    <li><strong>Enzyme Kinetics:</strong> Enzymes catalyze reactions following Michaelis-Menten kinetics, with rates determined by substrate concentration and enzyme affinity (Km).</li>
                    <li><strong>Lock and Key vs Induced Fit:</strong> Enzymes recognize substrates either through rigid complementarity (lock-key) or conformational changes upon binding (induced fit).</li>
                    <li><strong>Allosteric Regulation:</strong> Enzyme activity modulated by molecules binding at sites other than the active site, enabling sophisticated metabolic control.</li>
                    <li><strong>Signal Transduction:</strong> Cascades of molecular interactions that amplify and transmit signals from cell surface to nucleus.</li>
                </ul>

                <h3>Why It Matters</h3>
                <p>Molecular understanding enables drug design, metabolic engineering, and synthetic biology.</p>

                <h3>How to Explore</h3>
                <ul>
                    <li>Adjust the sliders to modify simulation parameters and observe how the system responds</li>
                    <li>Look for emergent patterns that arise from agent interactions</li>
                    <li>Try extreme parameter values to find phase transitions and tipping points</li>
                    <li>Compare the simulation behavior to real-world phenomena</li>
                </ul>

                <p class="modal-category"><em>Category: Biochemistry & Molecular Biology ‚Äî Exploring molecular mechanisms and biochemical pathways</em></p>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('explainModal');
        const explainBtn = document.getElementById('explainBtn');
        if (modal && explainBtn) {
            explainBtn.addEventListener('click', function() {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            });
            modal.querySelector('.modal-close').addEventListener('click', function() {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            });
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.classList.contains('active')) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
        }
    });
    </script>

    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
