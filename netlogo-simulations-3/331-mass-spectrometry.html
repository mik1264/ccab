<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mass Spectrometry</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #1a1a2e; color: #e8e6e1; overflow: hidden; }
        #container { display: flex; height: 100vh; }
        #canvas-container { flex: 1; position: relative; }
        canvas { display: block; width: 100%; height: 100%; }
        #controls { width: 320px; background: rgba(0,0,0,0.8); padding: 20px; overflow-y: auto; }
        h1 { font-size: 1.2rem; margin-bottom: 10px; color: #ff5722; }
        .description { font-size: 0.75rem; color: #888; margin-bottom: 15px; line-height: 1.4; }
        .control-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: #aaa; }
        input[type="range"] { width: 100%; }
        select { width: 100%; padding: 5px; background: #333; color: #fff; border: 1px solid #555; border-radius: 3px; }
        button { width: 100%; padding: 10px; margin-bottom: 8px; background: #ff5722; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .stats { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; font-size: 0.75rem; margin-top: 10px; }
        .back-link { position: fixed; top: 10px; left: 10px; padding: 8px 16px; background: rgba(0,0,0,0.7); color: #ff5722; text-decoration: none; border-radius: 6px; font-size: 14px; z-index: 999; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back to Gallery</a>
    <div id="container">
        <div id="canvas-container"><canvas id="canvas"></canvas></div>
        <div id="controls">
            <h1>Mass Spectrometry</h1>
            <p class="description">MS measures mass-to-charge ratio (m/z). Ionization creates molecular and fragment ions. Quadrupole, TOF, or magnetic sector analyzers separate ions. Pattern reveals molecular structure.</p>

            <div class="control-group">
                <label>Ionization Mode:</label>
                <select id="ionization">
                    <option value="ei">EI (Electron Impact)</option>
                    <option value="esi">ESI (Electrospray)</option>
                    <option value="maldi">MALDI</option>
                </select>
            </div>

            <div class="control-group">
                <label>Sample:</label>
                <select id="sample">
                    <option value="ethanol">Ethanol (MW 46)</option>
                    <option value="glucose">Glucose (MW 180)</option>
                    <option value="caffeine">Caffeine (MW 194)</option>
                </select>
            </div>

            <div class="control-group">
                <label>Ion Energy: <span id="energyVal">70</span> eV</label>
                <input type="range" id="energy" min="10" max="100" value="70">
            </div>

            <button id="reset">Reset</button>
            <button id="ionize">Ionize Sample</button>

            <div class="stats">
                <div>Molecular Ion [M]⁺: <span id="molIon">0</span> m/z</div>
                <div>Base Peak: <span id="basePeak">0</span> m/z</div>
                <div>Total Ions: <span id="totalIons">0</span></div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let width, height;
        let time = 0;

        let ionizationMode = 'ei';
        let sampleType = 'ethanol';
        let ionEnergy = 70;

        let ions = [];
        let spectrum = [];
        let animatingIons = [];

        const SAMPLES = {
            ethanol: {
                mw: 46,
                fragments: [
                    { mz: 46, abundance: 30, label: 'M⁺' },
                    { mz: 45, abundance: 100, label: '[M-H]⁺' },
                    { mz: 31, abundance: 80, label: 'CH₃O⁺' },
                    { mz: 29, abundance: 60, label: 'CHO⁺' },
                    { mz: 27, abundance: 25, label: 'C₂H₃⁺' },
                    { mz: 15, abundance: 40, label: 'CH₃⁺' }
                ]
            },
            glucose: {
                mw: 180,
                fragments: [
                    { mz: 180, abundance: 5, label: 'M⁺' },
                    { mz: 163, abundance: 15, label: '[M-OH]⁺' },
                    { mz: 145, abundance: 20, label: '[M-H₂O-OH]⁺' },
                    { mz: 127, abundance: 30, label: '' },
                    { mz: 109, abundance: 25, label: '' },
                    { mz: 73, abundance: 100, label: '' },
                    { mz: 60, abundance: 80, label: '' },
                    { mz: 43, abundance: 70, label: 'CH₃CO⁺' }
                ]
            },
            caffeine: {
                mw: 194,
                fragments: [
                    { mz: 194, abundance: 100, label: 'M⁺' },
                    { mz: 193, abundance: 15, label: '[M-H]⁺' },
                    { mz: 165, abundance: 10, label: '[M-CHO]⁺' },
                    { mz: 137, abundance: 25, label: '' },
                    { mz: 109, abundance: 35, label: '' },
                    { mz: 82, abundance: 20, label: '' },
                    { mz: 67, abundance: 30, label: '' },
                    { mz: 55, abundance: 40, label: '' },
                    { mz: 42, abundance: 45, label: 'NCO⁺' }
                ]
            }
        };

        function resize() {
            const container = document.getElementById('canvas-container');
            width = container.clientWidth;
            height = container.clientHeight;
            canvas.width = width;
            canvas.height = height;
        }

        function init() {
            resize();
            time = 0;
            ions = [];
            spectrum = [];
            animatingIons = [];
            updateStats();
        }

        function ionize() {
            const sample = SAMPLES[sampleType];
            spectrum = [];
            animatingIons = [];

            // Generate spectrum based on fragmentation
            for (const frag of sample.fragments) {
                // Abundance modified by ionization energy
                let abundance = frag.abundance;
                if (ionizationMode === 'ei') {
                    // Higher energy = more fragmentation
                    if (frag.mz < sample.mw) {
                        abundance *= (ionEnergy / 70);
                    } else {
                        abundance *= (70 / ionEnergy) * 0.5;
                    }
                } else if (ionizationMode === 'esi' || ionizationMode === 'maldi') {
                    // Soft ionization - mainly molecular ion
                    if (frag.mz === sample.mw) {
                        abundance = 100;
                    } else {
                        abundance *= 0.3;
                    }
                }

                spectrum.push({
                    mz: frag.mz,
                    abundance: Math.min(100, abundance),
                    label: frag.label
                });

                // Create animated ions
                const numIons = Math.floor(abundance / 10);
                for (let i = 0; i < numIons; i++) {
                    animatingIons.push({
                        mz: frag.mz,
                        x: 150,
                        y: height / 2 + (Math.random() - 0.5) * 50,
                        vx: 5 + Math.random() * 3,
                        vy: (Math.random() - 0.5) * 2,
                        phase: 'flight',
                        arrived: false,
                        arrivalTime: 0
                    });
                }
            }

            updateStats();
        }

        function step() {
            time += 0.02;

            // Animate ions through mass analyzer
            for (const ion of animatingIons) {
                if (ion.arrived) continue;

                ion.x += ion.vx;

                // Trajectory depends on m/z (heavier = less deflection)
                const deflection = 1000 / (ion.mz * ion.mz);
                ion.vy += deflection * 0.01;
                ion.y += ion.vy;

                // Check if reached detector region
                if (ion.x > width - 450) {
                    ion.arrived = true;
                    ion.arrivalTime = time;
                }
            }
        }

        function draw() {
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, width, height);

            drawInstrument();
            drawAnimatedIons();
            drawSpectrum();

            // Title
            ctx.fillStyle = '#ff5722';
            ctx.font = '14px sans-serif';
            ctx.fillText('Mass Spectrometer', 100, 50);
        }

        function drawInstrument() {
            const y = height / 2;

            // Ion source
            ctx.fillStyle = '#333';
            ctx.fillRect(100, y - 60, 80, 120);

            ctx.fillStyle = '#ff5722';
            ctx.font = '10px sans-serif';
            ctx.fillText('Ion', 125, y - 70);
            ctx.fillText('Source', 118, y - 58);

            // Sample inlet
            ctx.fillStyle = '#666';
            ctx.fillRect(80, y - 20, 30, 40);
            ctx.fillStyle = '#aaa';
            ctx.font = '9px sans-serif';
            ctx.fillText('Sample', 75, y + 35);

            // Ionization effect
            if (animatingIons.length > 0) {
                ctx.fillStyle = 'rgba(255, 87, 34, 0.3)';
                ctx.beginPath();
                ctx.arc(140, y, 30, 0, Math.PI * 2);
                ctx.fill();
            }

            // Accelerating region
            ctx.strokeStyle = '#666';
            ctx.lineWidth = 2;
            for (let i = 0; i < 3; i++) {
                ctx.beginPath();
                ctx.moveTo(190 + i * 20, y - 40);
                ctx.lineTo(190 + i * 20, y + 40);
                ctx.stroke();
            }
            ctx.fillStyle = '#aaa';
            ctx.fillText('Accelerator', 185, y + 55);

            // Mass analyzer (quadrupole representation)
            ctx.fillStyle = '#444';
            ctx.fillRect(260, y - 50, 200, 100);

            // Quadrupole rods
            ctx.fillStyle = '#ff9800';
            ctx.fillRect(270, y - 40, 180, 10);
            ctx.fillRect(270, y + 30, 180, 10);
            ctx.fillStyle = '#2196f3';
            ctx.fillRect(270, y - 10, 10, 20);
            ctx.fillRect(440, y - 10, 10, 20);

            ctx.fillStyle = '#aaa';
            ctx.fillText('Mass Analyzer', 320, y + 70);

            // Ion trajectory path
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(180, y);
            ctx.lineTo(480, y);
            ctx.stroke();
            ctx.setLineDash([]);

            // Detector
            ctx.fillStyle = '#333';
            ctx.fillRect(480, y - 80, 40, 160);

            ctx.fillStyle = '#4caf50';
            ctx.fillRect(485, y - 70, 30, 140);

            ctx.fillStyle = '#aaa';
            ctx.fillText('Detector', 480, y + 95);

            // Vacuum system indicator
            ctx.fillStyle = '#666';
            ctx.font = '9px sans-serif';
            ctx.fillText('Vacuum: 10⁻⁶ torr', 300, y - 60);
        }

        function drawAnimatedIons() {
            for (const ion of animatingIons) {
                if (ion.x < 100 || ion.x > width - 400) continue;

                // Ion color based on m/z
                const hue = (ion.mz / 200) * 240;
                ctx.fillStyle = `hsl(${hue}, 70%, 50%)`;

                ctx.beginPath();
                ctx.arc(ion.x, ion.y, 4, 0, Math.PI * 2);
                ctx.fill();

                // Trail
                ctx.strokeStyle = `hsla(${hue}, 70%, 50%, 0.3)`;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(ion.x, ion.y);
                ctx.lineTo(ion.x - 20, ion.y - ion.vy * 3);
                ctx.stroke();
            }
        }

        function drawSpectrum() {
            const plotX = 100;
            const plotY = height - 250;
            const plotW = width - 450;
            const plotH = 180;

            // Background
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(plotX - 10, plotY - 30, plotW + 20, plotH + 60);

            // Title
            ctx.fillStyle = '#fff';
            ctx.font = '12px sans-serif';
            ctx.fillText('Mass Spectrum', plotX, plotY - 15);

            // Axes
            ctx.strokeStyle = '#666';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(plotX, plotY);
            ctx.lineTo(plotX, plotY + plotH);
            ctx.lineTo(plotX + plotW, plotY + plotH);
            ctx.stroke();

            // Find max m/z for scaling
            const sample = SAMPLES[sampleType];
            const maxMz = sample.mw + 20;

            // Draw peaks
            for (const peak of spectrum) {
                const peakX = plotX + (peak.mz / maxMz) * plotW;
                const peakH = (peak.abundance / 100) * (plotH - 20);

                ctx.fillStyle = '#ff5722';
                ctx.fillRect(peakX - 2, plotY + plotH - peakH, 4, peakH);

                // Peak labels for major peaks
                if (peak.abundance > 30) {
                    ctx.fillStyle = '#fff';
                    ctx.font = '9px sans-serif';
                    ctx.fillText(peak.mz.toString(), peakX - 8, plotY + plotH - peakH - 8);

                    if (peak.label) {
                        ctx.fillStyle = '#aaa';
                        ctx.fillText(peak.label, peakX - 15, plotY + plotH - peakH - 20);
                    }
                }
            }

            // Axis labels
            ctx.fillStyle = '#888';
            ctx.font = '10px sans-serif';
            ctx.fillText('m/z', plotX + plotW / 2, plotY + plotH + 25);

            ctx.save();
            ctx.translate(plotX - 25, plotY + plotH / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Relative Abundance (%)', 0, 0);
            ctx.restore();

            // m/z scale
            for (let mz = 0; mz <= maxMz; mz += 50) {
                const x = plotX + (mz / maxMz) * plotW;
                ctx.fillStyle = '#666';
                ctx.fillRect(x, plotY + plotH, 1, 5);
                ctx.fillStyle = '#888';
                ctx.fillText(mz.toString(), x - 10, plotY + plotH + 15);
            }
        }

        function updateStats() {
            const sample = SAMPLES[sampleType];

            // Find base peak (highest abundance)
            let basePeak = { mz: 0, abundance: 0 };
            for (const peak of spectrum) {
                if (peak.abundance > basePeak.abundance) {
                    basePeak = peak;
                }
            }

            document.getElementById('molIon').textContent = sample.mw;
            document.getElementById('basePeak').textContent = basePeak.mz || '-';
            document.getElementById('totalIons').textContent = animatingIons.length;
        }

        function animate() {
            step();
            draw();
            requestAnimationFrame(animate);
        }

        document.getElementById('ionization').addEventListener('change', e => {
            ionizationMode = e.target.value;
        });

        document.getElementById('sample').addEventListener('change', e => {
            sampleType = e.target.value;
            init();
        });

        document.getElementById('energy').addEventListener('input', e => {
            ionEnergy = parseInt(e.target.value);
            document.getElementById('energyVal').textContent = ionEnergy;
        });

        document.getElementById('reset').addEventListener('click', init);
        document.getElementById('ionize').addEventListener('click', ionize);

        window.addEventListener('resize', init);

        init();
        animate();
    </script>
</body>
</html>
