<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autophagy - NetLogo Simulation</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            display: flex;
            flex-direction: column;
        }
        .header {
            padding: 15px 20px;
            background: rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .header h1 { font-size: 1.4rem; color: #64ffda; }
        .back-link {
            color: #64ffda;
            text-decoration: none;
            font-size: 0.9rem;
        }
        .back-link:hover { text-decoration: underline; }
        .main-container {
            display: flex;
            flex: 1;
            gap: 15px;
            padding: 15px;
        }
        .canvas-container {
            flex: 1;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
        }
        canvas { display: block; width: 100%; height: 100%; }
        .controls {
            width: 320px;
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }
        .control-group { margin-bottom: 8px; }
        .control-group label {
            display: block;
            margin-bottom: 5px;
            color: #8892b0;
            font-size: 0.85rem;
        }
        .control-group input[type="range"] { width: 100%; cursor: pointer; }
        .control-group .value {
            text-align: right;
            color: #64ffda;
            font-size: 0.8rem;
        }
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        .btn-primary { background: #64ffda; color: #1a1a2e; }
        .btn-primary:hover { background: #4dd4b4; }
        .btn-secondary { background: #2a3f5f; color: #fff; }
        .btn-secondary:hover { background: #3a5f8f; }
        .btn-danger { background: #ff6b6b; color: #fff; }
        .stats {
            background: rgba(100,255,218,0.1);
            border-radius: 8px;
            padding: 12px;
        }
        .stats h3 { color: #64ffda; margin-bottom: 8px; font-size: 0.95rem; }
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 0.85rem;
        }
        .stat-label { color: #8892b0; }
        .stat-value { color: #fff; font-weight: bold; }
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 0.75rem;
            margin-top: 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .button-row {
            display: flex;
            gap: 8px;
        }
        .button-row .btn { flex: 1; }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: #1a1a2e;
            border-radius: 15px;
            padding: 25px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid #64ffda;
        }
        .modal-content h2 { color: #64ffda; margin-bottom: 15px; }
        .modal-content p { color: #ccc; line-height: 1.6; margin-bottom: 12px; }
        .modal-content ul { color: #ccc; margin-left: 20px; margin-bottom: 12px; }
        .modal-content li { margin-bottom: 6px; }
        .close-modal {
            float: right;
            background: none;
            border: none;
            color: #64ffda;
            font-size: 1.5rem;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="index.html" class="back-link">← Back to Gallery</a>
        <h1>193. Autophagy</h1>
        <button class="btn btn-secondary" onclick="showExplain()">Explain</button>
    </div>

    <div class="main-container">
        <div class="canvas-container">
            <canvas id="simCanvas"></canvas>
        </div>

        <div class="controls">
            <div class="stats">
                <h3>Statistics</h3>
                <div class="stat-row">
                    <span class="stat-label">Damaged Organelles:</span>
                    <span class="stat-value" id="damagedCount">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Phagophores:</span>
                    <span class="stat-value" id="phagophoreCount">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Autophagosomes:</span>
                    <span class="stat-value" id="autophagosomeCount">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Autolysosomes:</span>
                    <span class="stat-value" id="autolysosomeCount">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Lysosomes:</span>
                    <span class="stat-value" id="lysosomeCount">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Recycled:</span>
                    <span class="stat-value" id="recycledCount">0</span>
                </div>
            </div>

            <div class="control-group">
                <label>Nutrient Level: <span class="value" id="nutrientVal">0.8</span></label>
                <input type="range" id="nutrientLevel" min="0" max="100" value="80">
            </div>

            <div class="control-group">
                <label>mTOR Activity: <span class="value" id="mtorVal">0.7</span></label>
                <input type="range" id="mtorActivity" min="0" max="100" value="70">
            </div>

            <div class="control-group">
                <label>Damage Rate: <span class="value" id="damageVal">0.2</span></label>
                <input type="range" id="damageRate" min="0" max="100" value="20">
            </div>

            <div class="control-group">
                <label>LC3 Expression: <span class="value" id="lc3Val">0.5</span></label>
                <input type="range" id="lc3Level" min="0" max="100" value="50">
            </div>

            <div class="control-group">
                <label>Lysosome Count: <span class="value" id="lysoVal">10</span></label>
                <input type="range" id="lysosomeNum" min="2" max="20" value="10">
            </div>

            <div class="button-row">
                <button class="btn btn-primary" id="startBtn" onclick="toggleSimulation()">Start</button>
                <button class="btn btn-secondary" onclick="resetSimulation()">Reset</button>
            </div>

            <div class="button-row">
                <button class="btn btn-danger" onclick="induceStarvation()">Starvation</button>
                <button class="btn btn-secondary" onclick="addDamage()">Add Damage</button>
            </div>

            <div class="legend">
                <div class="legend-item"><div class="legend-color" style="background:#00ff88"></div>Healthy</div>
                <div class="legend-item"><div class="legend-color" style="background:#ff6b6b"></div>Damaged</div>
                <div class="legend-item"><div class="legend-color" style="background:#64ffda"></div>Phagophore</div>
                <div class="legend-item"><div class="legend-color" style="background:#9b59b6"></div>Autophagosome</div>
                <div class="legend-item"><div class="legend-color" style="background:#ffd93d"></div>Lysosome</div>
                <div class="legend-item"><div class="legend-color" style="background:#ff9f43"></div>Autolysosome</div>
            </div>
        </div>
    </div>

    <div class="modal" id="explainModal">
        <div class="modal-content">
            <button class="close-modal" onclick="hideExplain()">&times;</button>
            <h2>Autophagy: Cellular Self-Eating</h2>
            <p><strong>Autophagy</strong> (meaning "self-eating") is an evolutionarily conserved process that degrades damaged organelles, protein aggregates, and pathogens by delivering them to lysosomes.</p>

            <h3 style="color:#64ffda; margin: 15px 0 10px;">Stages of Autophagy</h3>
            <ul>
                <li><strong>Initiation:</strong> ULK1 complex activated when mTOR is inhibited (starvation)</li>
                <li><strong>Nucleation:</strong> PI3KC3 complex generates PtdIns(3)P at ER membrane</li>
                <li><strong>Elongation:</strong> ATG12-ATG5-ATG16L complex recruits LC3-II to membrane</li>
                <li><strong>Closure:</strong> Phagophore seals to form double-membrane autophagosome</li>
                <li><strong>Fusion:</strong> SNARE proteins and HOPS complex mediate lysosome fusion</li>
                <li><strong>Degradation:</strong> Lysosomal enzymes digest contents; nutrients recycled</li>
            </ul>

            <h3 style="color:#64ffda; margin: 15px 0 10px;">Key Players</h3>
            <ul>
                <li><strong>mTOR:</strong> Master nutrient sensor; inhibits autophagy when active</li>
                <li><strong>LC3 (ATG8):</strong> Decorates autophagosome membranes; LC3-I → LC3-II conjugation</li>
                <li><strong>ATG proteins:</strong> Core autophagy machinery (ATG1-18 and more)</li>
                <li><strong>p62/SQSTM1:</strong> Cargo receptor linking ubiquitinated targets to LC3</li>
                <li><strong>Rab7, STX17:</strong> Regulate autophagosome-lysosome fusion</li>
            </ul>

            <h3 style="color:#64ffda; margin: 15px 0 10px;">Biological Roles</h3>
            <p>Autophagy maintains cellular homeostasis, provides nutrients during starvation, removes damaged mitochondria (mitophagy), clears protein aggregates, and fights pathogens (xenophagy). Dysregulation is linked to cancer, neurodegeneration, and aging.</p>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');

        let running = false;
        let animationId = null;

        let params = {
            nutrientLevel: 0.8,
            mtorActivity: 0.7,
            damageRate: 0.2,
            lc3Level: 0.5,
            lysosomeNum: 10
        };

        let organelles = [];
        let phagophores = [];
        let autophagosomes = [];
        let lysosomes = [];
        let autolysosomes = [];
        let lc3Particles = [];
        let recycledMaterials = [];

        let stats = {
            recycled: 0
        };

        const ORGANELLE_STATE = {
            HEALTHY: 0,
            DAMAGED: 1,
            BEING_ENGULFED: 2
        };

        const AUTOPHAGOSOME_STAGE = {
            PHAGOPHORE: 0,      // Open cup shape
            ELONGATING: 1,      // Growing
            CLOSING: 2,         // Sealing
            COMPLETE: 3         // Closed double membrane
        };

        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }

        function initSimulation() {
            resizeCanvas();
            organelles = [];
            phagophores = [];
            autophagosomes = [];
            lysosomes = [];
            autolysosomes = [];
            lc3Particles = [];
            recycledMaterials = [];
            stats = { recycled: 0 };

            // Create organelles (mitochondria, etc.)
            for (let i = 0; i < 30; i++) {
                organelles.push(createOrganelle());
            }

            // Create lysosomes
            for (let i = 0; i < params.lysosomeNum; i++) {
                lysosomes.push(createLysosome());
            }

            // Create LC3 particles
            for (let i = 0; i < 50; i++) {
                lc3Particles.push(createLC3());
            }
        }

        function createOrganelle() {
            return {
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                vx: (Math.random() - 0.5) * 1,
                vy: (Math.random() - 0.5) * 1,
                width: 20 + Math.random() * 15,
                height: 10 + Math.random() * 8,
                rotation: Math.random() * Math.PI * 2,
                state: ORGANELLE_STATE.HEALTHY,
                type: Math.random() < 0.7 ? 'mitochondria' : 'other'
            };
        }

        function createLysosome() {
            return {
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                vx: (Math.random() - 0.5) * 2,
                vy: (Math.random() - 0.5) * 2,
                radius: 15 + Math.random() * 5,
                acidic: true
            };
        }

        function createLC3() {
            return {
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                vx: (Math.random() - 0.5) * 3,
                vy: (Math.random() - 0.5) * 3,
                conjugated: false // LC3-I vs LC3-II
            };
        }

        function createPhagophore(x, y, target) {
            return {
                x: x,
                y: y,
                radius: 5,
                targetRadius: target.width * 1.5,
                openAngle: Math.PI * 1.5, // Cup opening
                stage: AUTOPHAGOSOME_STAGE.PHAGOPHORE,
                target: target,
                lc3Count: 0,
                progress: 0
            };
        }

        function createAutolysosome(x, y, cargo) {
            return {
                x: x,
                y: y,
                radius: 25,
                cargo: cargo,
                digestionProgress: 0
            };
        }

        function updateSimulation() {
            // mTOR activity depends on nutrients
            params.mtorActivity = Math.min(1, params.nutrientLevel * 1.2);
            document.getElementById('mtorVal').textContent = params.mtorActivity.toFixed(2);

            // Autophagy is activated when mTOR is LOW
            const autophagyActive = 1 - params.mtorActivity;

            // Organelle damage
            for (const org of organelles) {
                if (org.state === ORGANELLE_STATE.HEALTHY) {
                    if (Math.random() < params.damageRate * 0.005) {
                        org.state = ORGANELLE_STATE.DAMAGED;
                    }
                }

                // Movement
                if (org.state !== ORGANELLE_STATE.BEING_ENGULFED) {
                    org.x += org.vx;
                    org.y += org.vy;
                    org.rotation += 0.01;

                    if (org.x < 20 || org.x > canvas.width - 20) org.vx *= -1;
                    if (org.y < 20 || org.y > canvas.height - 20) org.vy *= -1;
                    org.x = Math.max(20, Math.min(canvas.width - 20, org.x));
                    org.y = Math.max(20, Math.min(canvas.height - 20, org.y));
                }
            }

            // Initiate phagophore formation around damaged organelles
            if (autophagyActive > 0.3 && Math.random() < autophagyActive * params.lc3Level * 0.05) {
                const damagedOrgs = organelles.filter(o => o.state === ORGANELLE_STATE.DAMAGED);
                if (damagedOrgs.length > 0 && phagophores.length < 10) {
                    const target = damagedOrgs[Math.floor(Math.random() * damagedOrgs.length)];
                    if (!phagophores.some(p => p.target === target)) {
                        phagophores.push(createPhagophore(target.x, target.y, target));
                        target.state = ORGANELLE_STATE.BEING_ENGULFED;
                    }
                }
            }

            // Update LC3 particles
            for (const lc3 of lc3Particles) {
                lc3.x += lc3.vx;
                lc3.y += lc3.vy;
                if (lc3.x < 5 || lc3.x > canvas.width - 5) lc3.vx *= -1;
                if (lc3.y < 5 || lc3.y > canvas.height - 5) lc3.vy *= -1;

                // LC3 conjugation to phagophores
                if (!lc3.conjugated) {
                    for (const phag of phagophores) {
                        const dx = lc3.x - phag.x;
                        const dy = lc3.y - phag.y;
                        if (Math.sqrt(dx*dx + dy*dy) < phag.radius + 20 && Math.random() < 0.1) {
                            lc3.conjugated = true;
                            phag.lc3Count++;
                            break;
                        }
                    }
                }
            }

            // Update phagophores
            for (let i = phagophores.length - 1; i >= 0; i--) {
                const phag = phagophores[i];

                // Follow target
                phag.x = phag.target.x;
                phag.y = phag.target.y;

                // Progress depends on LC3 recruitment
                if (phag.lc3Count > 0) {
                    phag.progress += 0.02 * Math.min(phag.lc3Count, 5);
                }

                // Grow and close
                if (phag.stage === AUTOPHAGOSOME_STAGE.PHAGOPHORE) {
                    phag.radius = Math.min(phag.targetRadius, phag.radius + 0.3);
                    if (phag.radius >= phag.targetRadius * 0.8) {
                        phag.stage = AUTOPHAGOSOME_STAGE.ELONGATING;
                    }
                } else if (phag.stage === AUTOPHAGOSOME_STAGE.ELONGATING) {
                    phag.openAngle = Math.max(Math.PI * 0.5, phag.openAngle - 0.02);
                    if (phag.openAngle <= Math.PI * 0.5) {
                        phag.stage = AUTOPHAGOSOME_STAGE.CLOSING;
                    }
                } else if (phag.stage === AUTOPHAGOSOME_STAGE.CLOSING) {
                    phag.openAngle = Math.max(0, phag.openAngle - 0.03);
                    if (phag.openAngle <= 0.1) {
                        // Complete autophagosome formed
                        autophagosomes.push({
                            x: phag.x,
                            y: phag.y,
                            vx: (Math.random() - 0.5) * 1.5,
                            vy: (Math.random() - 0.5) * 1.5,
                            radius: phag.radius,
                            cargo: phag.target,
                            lc3Count: phag.lc3Count
                        });
                        // Remove organelle from main list
                        const idx = organelles.indexOf(phag.target);
                        if (idx > -1) organelles.splice(idx, 1);
                        phagophores.splice(i, 1);
                    }
                }
            }

            // Update autophagosomes - seek lysosomes
            for (let i = autophagosomes.length - 1; i >= 0; i--) {
                const auto = autophagosomes[i];

                // Movement toward nearest lysosome
                let nearestLyso = null;
                let nearestDist = Infinity;
                for (const lyso of lysosomes) {
                    const dx = lyso.x - auto.x;
                    const dy = lyso.y - auto.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < nearestDist) {
                        nearestDist = dist;
                        nearestLyso = lyso;
                    }
                }

                if (nearestLyso && nearestDist > 10) {
                    const dx = nearestLyso.x - auto.x;
                    const dy = nearestLyso.y - auto.y;
                    auto.vx += dx / nearestDist * 0.1;
                    auto.vy += dy / nearestDist * 0.1;
                }

                auto.x += auto.vx;
                auto.y += auto.vy;
                auto.vx *= 0.98;
                auto.vy *= 0.98;

                // Boundaries
                if (auto.x < auto.radius || auto.x > canvas.width - auto.radius) auto.vx *= -1;
                if (auto.y < auto.radius || auto.y > canvas.height - auto.radius) auto.vy *= -1;

                // Fusion with lysosome
                if (nearestLyso && nearestDist < auto.radius + nearestLyso.radius) {
                    // Create autolysosome
                    autolysosomes.push(createAutolysosome(
                        (auto.x + nearestLyso.x) / 2,
                        (auto.y + nearestLyso.y) / 2,
                        auto.cargo
                    ));
                    // Remove lysosome temporarily
                    const lysoIdx = lysosomes.indexOf(nearestLyso);
                    if (lysoIdx > -1) lysosomes.splice(lysoIdx, 1);
                    autophagosomes.splice(i, 1);
                }
            }

            // Update autolysosomes - digestion
            for (let i = autolysosomes.length - 1; i >= 0; i--) {
                const autolyso = autolysosomes[i];
                autolyso.digestionProgress += 0.02;

                if (autolyso.digestionProgress >= 1) {
                    // Digestion complete - release nutrients
                    for (let j = 0; j < 8; j++) {
                        recycledMaterials.push({
                            x: autolyso.x,
                            y: autolyso.y,
                            vx: (Math.random() - 0.5) * 4,
                            vy: (Math.random() - 0.5) * 4,
                            life: 60 + Math.random() * 40,
                            size: 3
                        });
                    }
                    // Reform lysosome
                    lysosomes.push(createLysosome());
                    lysosomes[lysosomes.length - 1].x = autolyso.x;
                    lysosomes[lysosomes.length - 1].y = autolyso.y;

                    stats.recycled++;
                    autolysosomes.splice(i, 1);
                }
            }

            // Update lysosomes
            for (const lyso of lysosomes) {
                lyso.x += lyso.vx;
                lyso.y += lyso.vy;
                if (lyso.x < lyso.radius || lyso.x > canvas.width - lyso.radius) lyso.vx *= -1;
                if (lyso.y < lyso.radius || lyso.y > canvas.height - lyso.radius) lyso.vy *= -1;
                lyso.x = Math.max(lyso.radius, Math.min(canvas.width - lyso.radius, lyso.x));
                lyso.y = Math.max(lyso.radius, Math.min(canvas.height - lyso.radius, lyso.y));
            }

            // Update recycled materials
            for (let i = recycledMaterials.length - 1; i >= 0; i--) {
                const mat = recycledMaterials[i];
                mat.x += mat.vx;
                mat.y += mat.vy;
                mat.vx *= 0.98;
                mat.vy *= 0.98;
                mat.life--;
                if (mat.life <= 0) {
                    recycledMaterials.splice(i, 1);
                    // Increase nutrients slightly
                    params.nutrientLevel = Math.min(1, params.nutrientLevel + 0.01);
                }
            }

            // New organelle generation if nutrients available
            if (params.nutrientLevel > 0.5 && organelles.length < 30 && Math.random() < 0.02) {
                organelles.push(createOrganelle());
            }

            updateStats();
        }

        function updateStats() {
            document.getElementById('damagedCount').textContent =
                organelles.filter(o => o.state === ORGANELLE_STATE.DAMAGED).length;
            document.getElementById('phagophoreCount').textContent = phagophores.length;
            document.getElementById('autophagosomeCount').textContent = autophagosomes.length;
            document.getElementById('autolysosomeCount').textContent = autolysosomes.length;
            document.getElementById('lysosomeCount').textContent = lysosomes.length;
            document.getElementById('recycledCount').textContent = stats.recycled;
        }

        function draw() {
            ctx.fillStyle = '#0a0a1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw ER-like background pattern
            ctx.strokeStyle = 'rgba(100, 255, 218, 0.03)';
            ctx.lineWidth = 2;
            for (let i = 0; i < 20; i++) {
                ctx.beginPath();
                const y = 50 + i * 30 + Math.sin(Date.now() / 2000 + i) * 10;
                ctx.moveTo(0, y);
                for (let x = 0; x < canvas.width; x += 20) {
                    ctx.lineTo(x, y + Math.sin(x / 30 + Date.now() / 1000) * 5);
                }
                ctx.stroke();
            }

            // Draw recycled materials
            for (const mat of recycledMaterials) {
                const alpha = mat.life / 100;
                ctx.fillStyle = `rgba(0, 255, 136, ${alpha})`;
                ctx.beginPath();
                ctx.arc(mat.x, mat.y, mat.size, 0, Math.PI * 2);
                ctx.fill();
            }

            // Draw LC3 particles
            for (const lc3 of lc3Particles) {
                if (!lc3.conjugated) {
                    ctx.fillStyle = 'rgba(100, 255, 218, 0.3)';
                    ctx.beginPath();
                    ctx.arc(lc3.x, lc3.y, 3, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            // Draw organelles
            for (const org of organelles) {
                ctx.save();
                ctx.translate(org.x, org.y);
                ctx.rotate(org.rotation);

                if (org.type === 'mitochondria') {
                    // Draw mitochondria shape
                    const color = org.state === ORGANELLE_STATE.HEALTHY ? '#00ff88' :
                                 org.state === ORGANELLE_STATE.DAMAGED ? '#ff6b6b' : '#ff6b6b';

                    ctx.fillStyle = color;
                    ctx.beginPath();
                    ctx.ellipse(0, 0, org.width/2, org.height/2, 0, 0, Math.PI * 2);
                    ctx.fill();

                    // Inner membrane folds (cristae)
                    ctx.strokeStyle = org.state === ORGANELLE_STATE.HEALTHY ?
                        'rgba(0, 100, 50, 0.5)' : 'rgba(100, 0, 0, 0.5)';
                    ctx.lineWidth = 2;
                    for (let i = -org.width/3; i < org.width/3; i += 6) {
                        ctx.beginPath();
                        ctx.moveTo(i, -org.height/3);
                        ctx.lineTo(i, org.height/3);
                        ctx.stroke();
                    }
                } else {
                    // Generic organelle
                    ctx.fillStyle = org.state === ORGANELLE_STATE.HEALTHY ? '#3498db' : '#e74c3c';
                    ctx.beginPath();
                    ctx.arc(0, 0, org.width/3, 0, Math.PI * 2);
                    ctx.fill();
                }

                ctx.restore();
            }

            // Draw phagophores
            for (const phag of phagophores) {
                ctx.strokeStyle = '#64ffda';
                ctx.lineWidth = 4;
                ctx.beginPath();
                const startAngle = -Math.PI/2 - phag.openAngle/2;
                const endAngle = -Math.PI/2 + phag.openAngle/2 + Math.PI * 2;
                ctx.arc(phag.x, phag.y, phag.radius, startAngle, endAngle);
                ctx.stroke();

                // LC3 dots on membrane
                ctx.fillStyle = '#64ffda';
                for (let i = 0; i < Math.min(phag.lc3Count, 8); i++) {
                    const angle = startAngle + (endAngle - startAngle) * (i / 8);
                    ctx.beginPath();
                    ctx.arc(
                        phag.x + Math.cos(angle) * phag.radius,
                        phag.y + Math.sin(angle) * phag.radius,
                        3, 0, Math.PI * 2
                    );
                    ctx.fill();
                }
            }

            // Draw autophagosomes (closed, double membrane)
            for (const auto of autophagosomes) {
                // Outer membrane
                ctx.strokeStyle = '#9b59b6';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(auto.x, auto.y, auto.radius, 0, Math.PI * 2);
                ctx.stroke();

                // Inner membrane
                ctx.beginPath();
                ctx.arc(auto.x, auto.y, auto.radius - 5, 0, Math.PI * 2);
                ctx.stroke();

                // Cargo inside
                ctx.fillStyle = 'rgba(255, 107, 107, 0.5)';
                ctx.beginPath();
                ctx.arc(auto.x, auto.y, auto.radius - 10, 0, Math.PI * 2);
                ctx.fill();

                // LC3-II markers
                ctx.fillStyle = '#64ffda';
                for (let i = 0; i < Math.min(auto.lc3Count, 6); i++) {
                    const angle = (i / 6) * Math.PI * 2;
                    ctx.beginPath();
                    ctx.arc(
                        auto.x + Math.cos(angle) * auto.radius,
                        auto.y + Math.sin(angle) * auto.radius,
                        4, 0, Math.PI * 2
                    );
                    ctx.fill();
                }
            }

            // Draw lysosomes
            for (const lyso of lysosomes) {
                const gradient = ctx.createRadialGradient(lyso.x, lyso.y, 0, lyso.x, lyso.y, lyso.radius);
                gradient.addColorStop(0, '#ffd93d');
                gradient.addColorStop(1, '#cc9900');
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(lyso.x, lyso.y, lyso.radius, 0, Math.PI * 2);
                ctx.fill();

                // Label
                ctx.fillStyle = '#000';
                ctx.font = 'bold 8px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('LYSO', lyso.x, lyso.y + 3);
            }

            // Draw autolysosomes
            for (const autolyso of autolysosomes) {
                const gradient = ctx.createRadialGradient(
                    autolyso.x, autolyso.y, 0,
                    autolyso.x, autolyso.y, autolyso.radius
                );
                gradient.addColorStop(0, '#ff9f43');
                gradient.addColorStop(1, '#cc6600');
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(autolyso.x, autolyso.y, autolyso.radius, 0, Math.PI * 2);
                ctx.fill();

                // Digestion progress
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.fillRect(autolyso.x - 20, autolyso.y + autolyso.radius + 5, 40, 5);
                ctx.fillStyle = '#00ff88';
                ctx.fillRect(autolyso.x - 20, autolyso.y + autolyso.radius + 5, 40 * autolyso.digestionProgress, 5);

                // Inner debris (shrinking)
                const debrisSize = autolyso.radius * 0.6 * (1 - autolyso.digestionProgress);
                if (debrisSize > 2) {
                    ctx.fillStyle = 'rgba(255, 107, 107, 0.5)';
                    ctx.beginPath();
                    ctx.arc(autolyso.x, autolyso.y, debrisSize, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            // mTOR status indicator
            ctx.fillStyle = params.mtorActivity > 0.5 ? '#ff6b6b' : '#00ff88';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(`mTOR: ${params.mtorActivity > 0.5 ? 'ACTIVE' : 'INHIBITED'}`, 10, 20);
            ctx.fillText(`Autophagy: ${params.mtorActivity < 0.5 ? 'ACTIVE' : 'SUPPRESSED'}`, 10, 35);
        }

        function animate() {
            if (running) {
                updateSimulation();
            }
            draw();
            animationId = requestAnimationFrame(animate);
        }

        function toggleSimulation() {
            running = !running;
            document.getElementById('startBtn').textContent = running ? 'Pause' : 'Start';
        }

        function resetSimulation() {
            running = false;
            document.getElementById('startBtn').textContent = 'Start';
            initSimulation();
        }

        function induceStarvation() {
            params.nutrientLevel = 0.1;
            document.getElementById('nutrientLevel').value = 10;
            document.getElementById('nutrientVal').textContent = '0.10';
        }

        function addDamage() {
            for (const org of organelles) {
                if (org.state === ORGANELLE_STATE.HEALTHY && Math.random() < 0.3) {
                    org.state = ORGANELLE_STATE.DAMAGED;
                }
            }
        }

        function showExplain() {
            document.getElementById('explainModal').classList.add('active');
        }

        function hideExplain() {
            document.getElementById('explainModal').classList.remove('active');
        }

        // Event listeners
        document.getElementById('nutrientLevel').addEventListener('input', (e) => {
            params.nutrientLevel = parseInt(e.target.value) / 100;
            document.getElementById('nutrientVal').textContent = params.nutrientLevel.toFixed(2);
        });

        document.getElementById('mtorActivity').addEventListener('input', (e) => {
            params.mtorActivity = parseInt(e.target.value) / 100;
            document.getElementById('mtorVal').textContent = params.mtorActivity.toFixed(2);
        });

        document.getElementById('damageRate').addEventListener('input', (e) => {
            params.damageRate = parseInt(e.target.value) / 100;
            document.getElementById('damageVal').textContent = params.damageRate.toFixed(2);
        });

        document.getElementById('lc3Level').addEventListener('input', (e) => {
            params.lc3Level = parseInt(e.target.value) / 100;
            document.getElementById('lc3Val').textContent = params.lc3Level.toFixed(2);
        });

        document.getElementById('lysosomeNum').addEventListener('input', (e) => {
            params.lysosomeNum = parseInt(e.target.value);
            document.getElementById('lysoVal').textContent = params.lysosomeNum;
        });

        window.addEventListener('resize', resizeCanvas);
        initSimulation();
        animate();
    </script>
</body>
</html>
