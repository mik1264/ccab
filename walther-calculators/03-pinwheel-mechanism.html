<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Pinwheel Mechanism - How Mechanical Calculators Work</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&family=Nunito:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --sage: #8A9A5B;
            --moss: #606C38;
            --earth: #DDA15E;
            --cream: #FEFAE0;
            --terracotta: #BC6C25;
            --dark-moss: #3d4423;
            --brass: #B5A642;
            --steel: #71797E;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #FEFAE0 0%, #F4F1DE 50%, #EDE8D5 100%);
            min-height: 100vh;
            color: var(--dark-moss);
        }

        .back-link {
            position: fixed;
            top: 1.5rem;
            left: 1.5rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--moss);
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .back-link:hover {
            background: rgba(255,255,255,0.95);
            transform: translateX(-5px);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
            padding-top: 3rem;
        }

        h1 {
            font-family: 'Lora', serif;
            font-size: 2.5rem;
            color: var(--moss);
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: var(--terracotta);
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Main Layout */
        .demo-area {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
            margin-top: 2rem;
        }

        @media (max-width: 900px) {
            .demo-area {
                grid-template-columns: 1fr;
            }
        }

        /* Canvas Area */
        .canvas-container {
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        }

        canvas {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 10px;
            background: #1a1a1a;
        }

        .controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .control-label {
            font-size: 0.8rem;
            color: var(--steel);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 25px;
            font-family: 'Nunito', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--moss), var(--dark-moss));
            color: white;
            box-shadow: 0 4px 15px rgba(96, 108, 56, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(96, 108, 56, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--brass), #8a7a32);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
        }

        /* Slider */
        .slider-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 150px;
            height: 8px;
            background: linear-gradient(90deg, var(--sage), var(--moss));
            border-radius: 4px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, var(--brass), #8a7a32);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .slider-value {
            font-family: 'Lora', serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--moss);
            width: 30px;
            text-align: center;
        }

        /* Info Panel */
        .info-panel {
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        }

        .info-panel h2 {
            font-family: 'Lora', serif;
            color: var(--moss);
            font-size: 1.4rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .info-panel h2::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 24px;
            background: linear-gradient(to bottom, var(--earth), var(--terracotta));
            border-radius: 2px;
        }

        .step-list {
            list-style: none;
        }

        .step-item {
            padding: 1rem;
            margin-bottom: 0.75rem;
            background: rgba(255,255,255,0.6);
            border-radius: 12px;
            border-left: 4px solid var(--sage);
            transition: all 0.3s ease;
        }

        .step-item.active {
            border-left-color: var(--brass);
            background: rgba(181, 166, 66, 0.1);
            transform: translateX(5px);
        }

        .step-number {
            display: inline-block;
            width: 24px;
            height: 24px;
            background: var(--sage);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            font-size: 0.8rem;
            font-weight: 700;
            margin-right: 0.5rem;
        }

        .step-item.active .step-number {
            background: var(--brass);
        }

        .step-title {
            font-weight: 600;
            color: var(--dark-moss);
        }

        .step-desc {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.5rem;
            line-height: 1.5;
        }

        /* Accumulator Display */
        .accumulator-display {
            background: linear-gradient(145deg, #333, #1a1a1a);
            padding: 1rem;
            border-radius: 10px;
            margin-top: 1.5rem;
            text-align: center;
        }

        .accumulator-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 0.5rem;
        }

        .accumulator-value {
            font-family: 'Courier New', monospace;
            font-size: 2rem;
            color: #ff6b6b;
            text-shadow: 0 0 20px rgba(255, 107, 107, 0.5);
        }

        /* Legend */
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px dashed rgba(0,0,0,0.1);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">
        <span>←</span>
        <span>Back to Walther Gallery</span>
    </a>

    <div class="container">
        <header>
            <h1>The Odhner Pinwheel</h1>
            <p class="subtitle">
                Invented in 1873, this ingenious mechanism enabled a single wheel to add any digit from 0-9
                with just one rotation
            </p>
        </header>

        <div class="demo-area">
            <div class="canvas-container">
                <canvas id="canvas" width="700" height="500"></canvas>
                <div class="controls">
                    <div class="control-group">
                        <span class="control-label">Set Digit</span>
                        <div class="slider-container">
                            <input type="range" id="digit-slider" min="0" max="9" value="5">
                            <span class="slider-value" id="digit-value">5</span>
                        </div>
                    </div>
                    <div class="control-group">
                        <span class="control-label">Rotate Crank</span>
                        <button class="btn btn-primary" id="rotate-btn">↻ Turn Wheel</button>
                    </div>
                    <div class="control-group">
                        <span class="control-label">Reset</span>
                        <button class="btn btn-secondary" id="reset-btn">Reset</button>
                    </div>
                </div>
            </div>

            <div class="info-panel">
                <h2>How It Works</h2>

                <ul class="step-list">
                    <li class="step-item active" data-step="1">
                        <span class="step-number">1</span>
                        <span class="step-title">Set the Digit</span>
                        <p class="step-desc">Move the slider to extend 0-9 pins from the pinwheel. Each extended pin acts as a gear tooth.</p>
                    </li>
                    <li class="step-item" data-step="2">
                        <span class="step-number">2</span>
                        <span class="step-title">Rotate the Wheel</span>
                        <p class="step-desc">As the crank turns, the extended pins mesh with the counter gear and advance it.</p>
                    </li>
                    <li class="step-item" data-step="3">
                        <span class="step-number">3</span>
                        <span class="step-title">Count the Engagement</span>
                        <p class="step-desc">Each extended pin advances the counter by exactly one position. 5 pins = add 5.</p>
                    </li>
                    <li class="step-item" data-step="4">
                        <span class="step-number">4</span>
                        <span class="step-title">Complete the Turn</span>
                        <p class="step-desc">One full rotation adds your digit once. Multiple rotations multiply the addition.</p>
                    </li>
                </ul>

                <div class="accumulator-display">
                    <div class="accumulator-label">Accumulator Value</div>
                    <div class="accumulator-value" id="accum-display">00</div>
                </div>

                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #B5A642;"></div>
                        <span>Extended Pins</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #555;"></div>
                        <span>Retracted Pins</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4ecdc4;"></div>
                        <span>Counter Gear</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Pinwheel Mechanism Visualization
        class PinwheelDemo {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');

                // High DPI support
                const dpr = window.devicePixelRatio || 1;
                const rect = this.canvas.getBoundingClientRect();
                this.canvas.width = rect.width * dpr;
                this.canvas.height = rect.height * dpr;
                this.ctx.scale(dpr, dpr);
                this.width = rect.width;
                this.height = rect.height;

                // State
                this.extendedPins = 5;
                this.wheelRotation = 0;
                this.counterValue = 0;
                this.isAnimating = false;
                this.currentStep = 1;

                // Geometry
                this.centerX = this.width * 0.35;
                this.centerY = this.height * 0.5;
                this.wheelRadius = 120;
                this.pinLength = 30;
                this.totalPins = 10;

                this.counterCenterX = this.width * 0.72;
                this.counterCenterY = this.height * 0.5;
                this.counterRadius = 60;

                this.setupControls();
                this.draw();
            }

            setupControls() {
                const slider = document.getElementById('digit-slider');
                const digitValue = document.getElementById('digit-value');
                const rotateBtn = document.getElementById('rotate-btn');
                const resetBtn = document.getElementById('reset-btn');

                slider.addEventListener('input', (e) => {
                    this.extendedPins = parseInt(e.target.value);
                    digitValue.textContent = this.extendedPins;
                    this.setStep(1);
                    this.draw();
                });

                rotateBtn.addEventListener('click', () => this.rotate());
                resetBtn.addEventListener('click', () => this.reset());
            }

            setStep(step) {
                this.currentStep = step;
                document.querySelectorAll('.step-item').forEach((el, i) => {
                    el.classList.toggle('active', i + 1 === step);
                });
            }

            rotate() {
                if (this.isAnimating) return;
                this.isAnimating = true;

                const startRotation = this.wheelRotation;
                const startTime = performance.now();
                const duration = 1500;
                const targetRotation = startRotation + Math.PI * 2;

                let pinsEngaged = 0;
                const pinAngleSpacing = (Math.PI * 2) / this.totalPins;
                let lastEngagedPin = -1;

                const animate = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);

                    // Ease out cubic
                    const eased = 1 - Math.pow(1 - progress, 3);
                    this.wheelRotation = startRotation + (Math.PI * 2) * eased;

                    // Check for pin engagement
                    const normalizedRotation = this.wheelRotation % (Math.PI * 2);
                    for (let i = 0; i < this.extendedPins; i++) {
                        const pinAngle = i * pinAngleSpacing;
                        const engagementAngle = Math.PI / 2; // Right side where counter is

                        // Check if pin is in engagement zone
                        const pinCurrentAngle = (pinAngle + this.wheelRotation) % (Math.PI * 2);
                        if (pinCurrentAngle > engagementAngle - 0.3 &&
                            pinCurrentAngle < engagementAngle + 0.3 &&
                            lastEngagedPin !== i) {
                            lastEngagedPin = i;
                            pinsEngaged++;

                            if (pinsEngaged <= this.extendedPins) {
                                this.setStep(3);
                            }
                        }
                    }

                    this.draw();

                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        this.counterValue += this.extendedPins;
                        this.updateAccumulatorDisplay();
                        this.setStep(4);
                        this.isAnimating = false;

                        setTimeout(() => {
                            if (!this.isAnimating) {
                                this.setStep(1);
                            }
                        }, 1500);
                    }
                };

                this.setStep(2);
                requestAnimationFrame(animate);
            }

            reset() {
                this.counterValue = 0;
                this.wheelRotation = 0;
                this.setStep(1);
                this.updateAccumulatorDisplay();
                this.draw();
            }

            updateAccumulatorDisplay() {
                const display = document.getElementById('accum-display');
                display.textContent = this.counterValue.toString().padStart(2, '0');
            }

            draw() {
                const ctx = this.ctx;

                // Clear
                ctx.fillStyle = '#1a1a1a';
                ctx.fillRect(0, 0, this.width, this.height);

                // Draw connection line
                ctx.beginPath();
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 3;
                ctx.setLineDash([5, 5]);
                ctx.moveTo(this.centerX + this.wheelRadius + 30, this.centerY);
                ctx.lineTo(this.counterCenterX - this.counterRadius - 10, this.counterCenterY);
                ctx.stroke();
                ctx.setLineDash([]);

                // Draw pinwheel
                this.drawPinwheel();

                // Draw counter gear
                this.drawCounterGear();

                // Draw labels
                this.drawLabels();
            }

            drawPinwheel() {
                const ctx = this.ctx;
                const cx = this.centerX;
                const cy = this.centerY;

                // Outer ring
                ctx.beginPath();
                ctx.arc(cx, cy, this.wheelRadius + 10, 0, Math.PI * 2);
                ctx.strokeStyle = '#555';
                ctx.lineWidth = 4;
                ctx.stroke();

                // Main wheel
                ctx.beginPath();
                ctx.arc(cx, cy, this.wheelRadius, 0, Math.PI * 2);
                ctx.fillStyle = '#2a2a2a';
                ctx.fill();
                ctx.strokeStyle = '#444';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Center hub
                ctx.beginPath();
                ctx.arc(cx, cy, 25, 0, Math.PI * 2);
                ctx.fillStyle = '#444';
                ctx.fill();
                ctx.beginPath();
                ctx.arc(cx, cy, 15, 0, Math.PI * 2);
                ctx.fillStyle = '#333';
                ctx.fill();

                // Draw pins
                const pinAngleSpacing = (Math.PI * 2) / this.totalPins;

                for (let i = 0; i < this.totalPins; i++) {
                    const angle = i * pinAngleSpacing + this.wheelRotation;
                    const isExtended = i < this.extendedPins;

                    // Pin slot
                    const slotStartX = cx + Math.cos(angle) * 30;
                    const slotStartY = cy + Math.sin(angle) * 30;
                    const slotEndX = cx + Math.cos(angle) * (this.wheelRadius - 5);
                    const slotEndY = cy + Math.sin(angle) * (this.wheelRadius - 5);

                    ctx.beginPath();
                    ctx.moveTo(slotStartX, slotStartY);
                    ctx.lineTo(slotEndX, slotEndY);
                    ctx.strokeStyle = '#3a3a3a';
                    ctx.lineWidth = 8;
                    ctx.stroke();

                    // Pin
                    const pinEndRadius = isExtended ?
                        this.wheelRadius + this.pinLength :
                        this.wheelRadius - 20;

                    const pinStartX = cx + Math.cos(angle) * 35;
                    const pinStartY = cy + Math.sin(angle) * 35;
                    const pinEndX = cx + Math.cos(angle) * pinEndRadius;
                    const pinEndY = cy + Math.sin(angle) * pinEndRadius;

                    ctx.beginPath();
                    ctx.moveTo(pinStartX, pinStartY);
                    ctx.lineTo(pinEndX, pinEndY);
                    ctx.strokeStyle = isExtended ? '#B5A642' : '#555';
                    ctx.lineWidth = 6;
                    ctx.lineCap = 'round';
                    ctx.stroke();

                    // Pin head
                    ctx.beginPath();
                    ctx.arc(pinEndX, pinEndY, 5, 0, Math.PI * 2);
                    ctx.fillStyle = isExtended ? '#d4c35a' : '#666';
                    ctx.fill();
                }

                // Setting indicator
                const indicatorAngle = -Math.PI / 2;
                ctx.beginPath();
                ctx.moveTo(
                    cx + Math.cos(indicatorAngle) * (this.wheelRadius + 45),
                    cy + Math.sin(indicatorAngle) * (this.wheelRadius + 45)
                );
                ctx.lineTo(
                    cx + Math.cos(indicatorAngle) * (this.wheelRadius + 55),
                    cy + Math.sin(indicatorAngle) * (this.wheelRadius + 55)
                );
                ctx.strokeStyle = '#BC6C25';
                ctx.lineWidth = 3;
                ctx.stroke();
            }

            drawCounterGear() {
                const ctx = this.ctx;
                const cx = this.counterCenterX;
                const cy = this.counterCenterY;

                // Outer ring
                ctx.beginPath();
                ctx.arc(cx, cy, this.counterRadius + 8, 0, Math.PI * 2);
                ctx.strokeStyle = '#4ecdc4';
                ctx.lineWidth = 3;
                ctx.stroke();

                // Main gear
                ctx.beginPath();
                ctx.arc(cx, cy, this.counterRadius, 0, Math.PI * 2);
                ctx.fillStyle = '#1a3a38';
                ctx.fill();

                // Gear teeth
                const teethCount = 10;
                const teethAngle = (Math.PI * 2) / teethCount;
                const counterRotation = (this.counterValue % 10) * teethAngle;

                for (let i = 0; i < teethCount; i++) {
                    const angle = i * teethAngle - counterRotation;
                    const innerX = cx + Math.cos(angle) * (this.counterRadius - 15);
                    const innerY = cy + Math.sin(angle) * (this.counterRadius - 15);
                    const outerX = cx + Math.cos(angle) * (this.counterRadius + 3);
                    const outerY = cy + Math.sin(angle) * (this.counterRadius + 3);

                    ctx.beginPath();
                    ctx.moveTo(innerX, innerY);
                    ctx.lineTo(outerX, outerY);
                    ctx.strokeStyle = '#4ecdc4';
                    ctx.lineWidth = 6;
                    ctx.lineCap = 'round';
                    ctx.stroke();
                }

                // Center
                ctx.beginPath();
                ctx.arc(cx, cy, 20, 0, Math.PI * 2);
                ctx.fillStyle = '#2a4a48';
                ctx.fill();

                // Counter value display
                ctx.font = 'bold 28px Courier New';
                ctx.fillStyle = '#4ecdc4';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText((this.counterValue % 10).toString(), cx, cy);
            }

            drawLabels() {
                const ctx = this.ctx;

                ctx.font = '14px Nunito';
                ctx.fillStyle = '#888';
                ctx.textAlign = 'center';

                // Pinwheel label
                ctx.fillText('PINWHEEL (Rotor)', this.centerX, this.centerY + this.wheelRadius + 75);
                ctx.fillText(`${this.extendedPins} pins extended`, this.centerX, this.centerY + this.wheelRadius + 95);

                // Counter label
                ctx.fillText('COUNTER GEAR', this.counterCenterX, this.counterCenterY + this.counterRadius + 40);
                ctx.fillText('(Accumulator)', this.counterCenterX, this.counterCenterY + this.counterRadius + 58);

                // Engagement zone indicator
                ctx.beginPath();
                ctx.arc(this.centerX + this.wheelRadius + this.pinLength + 20, this.centerY, 8, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(78, 205, 196, 0.3)';
                ctx.fill();
                ctx.strokeStyle = '#4ecdc4';
                ctx.lineWidth = 1;
                ctx.stroke();

                ctx.font = '11px Nunito';
                ctx.fillStyle = '#4ecdc4';
                ctx.fillText('Engagement', this.centerX + this.wheelRadius + this.pinLength + 20, this.centerY - 18);
                ctx.fillText('Zone', this.centerX + this.wheelRadius + this.pinLength + 20, this.centerY - 6);
            }
        }

        // Initialize
        const demo = new PinwheelDemo('canvas');

        // Expose for enhance.js keyboard shortcuts
        window.reset = function() { demo.reset(); };
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
