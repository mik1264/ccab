<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pollination Network - CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #1a1a2e; color: #e8e6e1; overflow: hidden; }
        #container { display: flex; height: 100vh; }
        #canvas-container { flex: 1; position: relative; }
        canvas { display: block; width: 100%; height: 100%; }
        #controls { width: 300px; background: rgba(0,0,0,0.8); padding: 20px; overflow-y: auto; }
        h1 { font-size: 1.2rem; margin-bottom: 15px; color: #f472b6; }
        .control-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: #aaa; }
        input[type="range"] { width: 100%; }
        button { width: 100%; padding: 10px; margin-bottom: 10px; background: #f472b6; color: #1a1a2e; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: #ec4899; }
        .stats { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; font-size: 0.8rem; margin-bottom: 15px; }
        .back-link { position: fixed; top: 10px; left: 10px; padding: 8px 16px; background: rgba(0,0,0,0.7); color: #f472b6; text-decoration: none; border-radius: 6px; font-size: 14px; z-index: 999; }
        .explain-btn { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); margin-top: 10px; }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; }
        .modal-overlay.active { display: flex; align-items: center; justify-content: center; }
        .modal { background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%); border-radius: 16px; padding: 30px; max-width: 600px; max-height: 80vh; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); position: relative; }
        .modal-close { position: absolute; top: 15px; right: 20px; background: none; border: none; color: #888; font-size: 28px; cursor: pointer; width: auto; }
        .modal h2 { color: #f472b6; margin-bottom: 20px; }
        .modal-body { color: #ccc; line-height: 1.8; }
        .modal-body h3 { color: #f9a8d4; margin: 20px 0 10px; }
        .modal-body strong { color: #f472b6; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Gallery</a>
    <div id="container">
        <div id="canvas-container"><canvas id="canvas"></canvas></div>
        <div id="controls">
            <h1>Pollination Network</h1>
            <div class="control-group">
                <label>Plant Species: <span id="plantValue">10</span></label>
                <input type="range" id="plants" min="5" max="20" value="10">
            </div>
            <div class="control-group">
                <label>Pollinator Species: <span id="pollinatorValue">15</span></label>
                <input type="range" id="pollinators" min="5" max="30" value="15">
            </div>
            <div class="control-group">
                <label>Specialization: <span id="specValue">0.5</span></label>
                <input type="range" id="spec" min="0.1" max="0.9" step="0.05" value="0.5">
            </div>
            <button id="reset">Generate Network</button>
            <button id="removeSpecies">Remove Species</button>
            <button id="explainBtn" class="explain-btn">üìö Explain</button>
            <div class="stats">
                <div>Plant Species: <span id="plantCount">0</span></div>
                <div>Pollinator Species: <span id="pollinatorCount">0</span></div>
                <div>Total Links: <span id="linkCount">0</span></div>
                <div>Connectance: <span id="connectance">0</span></div>
                <div>Nestedness: <span id="nestedness">0</span></div>
            </div>
        </div>
    </div>
    <div id="explainModal" class="modal-overlay">
        <div class="modal">
            <button class="modal-close">&times;</button>
            <h2>üå∏ Pollination Networks</h2>
            <div class="modal-body">
                <p>A <strong>pollination network</strong> is a bipartite mutualistic network connecting plants and their pollinators.</p>
                <h3>Network Structure</h3>
                <ul>
                    <li><strong>Nestedness:</strong> Specialists interact with subsets of generalists' partners</li>
                    <li><strong>Modularity:</strong> Tightly connected species groups with weak inter-group links</li>
                    <li><strong>Asymmetric specialization:</strong> Specialists often interact with generalists</li>
                </ul>
                <h3>Mutualistic Benefits</h3>
                <ul>
                    <li>Plants receive pollination for reproduction</li>
                    <li>Pollinators receive nectar/pollen as food</li>
                    <li>Generalists provide network stability</li>
                </ul>
                <h3>Robustness</h3>
                <p>Nested structure protects against extinctions‚Äîcore generalists are most robust, while specialists are vulnerable to partner loss.</p>
            </div>
        </div>
    </div>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let params = { plants: 10, pollinators: 15, spec: 0.5 };
        let plants = [], pollinators = [], links = [];
        
        function resize() { canvas.width = document.getElementById('canvas-container').clientWidth; canvas.height = document.getElementById('canvas-container').clientHeight; }
        function init() {
            resize();
            plants = []; pollinators = []; links = [];
            // Create plants (bottom row)
            for (let i = 0; i < params.plants; i++) {
                const generalism = Math.random();
                plants.push({
                    id: i, type: 'plant',
                    x: (i + 1) / (params.plants + 1) * canvas.width,
                    y: canvas.height - 80,
                    generalism: generalism,
                    size: 15 + generalism * 15,
                    color: `hsl(${300 + Math.random() * 60}, 70%, 50%)`,
                    alive: true
                });
            }
            // Create pollinators (top row)
            for (let i = 0; i < params.pollinators; i++) {
                const generalism = Math.random();
                pollinators.push({
                    id: i, type: 'pollinator',
                    x: (i + 1) / (params.pollinators + 1) * canvas.width,
                    y: 80,
                    generalism: generalism,
                    size: 10 + generalism * 10,
                    color: `hsl(${30 + Math.random() * 30}, 80%, 50%)`,
                    alive: true
                });
            }
            // Create links (nested structure)
            // Sort by generalism for nested structure
            const sortedPlants = [...plants].sort((a, b) => b.generalism - a.generalism);
            const sortedPollinators = [...pollinators].sort((a, b) => b.generalism - a.generalism);
            for (let p = 0; p < pollinators.length; p++) {
                const pol = sortedPollinators[p];
                const nLinks = Math.ceil((1 - params.spec) * pol.generalism * params.plants);
                for (let i = 0; i < nLinks && i < sortedPlants.length; i++) {
                    const plant = sortedPlants[i];
                    if (!links.some(l => l.plant === plant.id && l.pollinator === pol.id)) {
                        links.push({ plant: plant.id, pollinator: pol.id });
                    }
                }
            }
        }
        function removeRandomSpecies() {
            const alivePlants = plants.filter(p => p.alive);
            const alivePollinators = pollinators.filter(p => p.alive);
            const all = [...alivePlants, ...alivePollinators];
            if (all.length === 0) return;
            const victim = all[Math.floor(Math.random() * all.length)];
            victim.alive = false;
            // Secondary extinctions
            let changed = true;
            while (changed) {
                changed = false;
                for (let p of pollinators) {
                    if (!p.alive) continue;
                    const pLinks = links.filter(l => l.pollinator === p.id);
                    const aliveLinks = pLinks.filter(l => plants.find(pl => pl.id === l.plant)?.alive);
                    if (aliveLinks.length === 0) { p.alive = false; changed = true; }
                }
                for (let pl of plants) {
                    if (!pl.alive) continue;
                    const plLinks = links.filter(l => l.plant === pl.id);
                    const aliveLinks = plLinks.filter(l => pollinators.find(p => p.id === l.pollinator)?.alive);
                    if (aliveLinks.length === 0) { pl.alive = false; changed = true; }
                }
            }
        }
        function draw() {
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            // Labels
            ctx.fillStyle = '#888';
            ctx.font = '14px sans-serif';
            ctx.fillText('Pollinators', 20, 40);
            ctx.fillText('Plants', 20, canvas.height - 30);
            // Draw links
            for (let link of links) {
                const plant = plants.find(p => p.id === link.plant);
                const pol = pollinators.find(p => p.id === link.pollinator);
                if (plant && pol && plant.alive && pol.alive) {
                    ctx.beginPath();
                    ctx.moveTo(plant.x, plant.y);
                    ctx.lineTo(pol.x, pol.y);
                    ctx.strokeStyle = 'rgba(244, 114, 182, 0.3)';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                }
            }
            // Draw plants
            for (let p of plants) {
                ctx.beginPath();
                // Flower shape
                for (let i = 0; i < 5; i++) {
                    const angle = (i / 5) * Math.PI * 2 - Math.PI / 2;
                    const px = p.x + Math.cos(angle) * p.size * 0.6;
                    const py = p.y + Math.sin(angle) * p.size * 0.6;
                    ctx.beginPath();
                    ctx.arc(px, py, p.size * 0.4, 0, Math.PI * 2);
                    ctx.fillStyle = p.alive ? p.color : '#374151';
                    ctx.fill();
                }
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size * 0.3, 0, Math.PI * 2);
                ctx.fillStyle = p.alive ? '#fbbf24' : '#555';
                ctx.fill();
            }
            // Draw pollinators
            for (let p of pollinators) {
                ctx.beginPath();
                ctx.ellipse(p.x, p.y, p.size, p.size * 0.6, 0, 0, Math.PI * 2);
                ctx.fillStyle = p.alive ? p.color : '#374151';
                ctx.fill();
                // Wings
                ctx.beginPath();
                ctx.ellipse(p.x - p.size * 0.3, p.y - p.size * 0.3, p.size * 0.4, p.size * 0.2, -0.5, 0, Math.PI * 2);
                ctx.ellipse(p.x + p.size * 0.3, p.y - p.size * 0.3, p.size * 0.4, p.size * 0.2, 0.5, 0, Math.PI * 2);
                ctx.fillStyle = p.alive ? 'rgba(255,255,255,0.3)' : 'rgba(100,100,100,0.2)';
                ctx.fill();
            }
            // Stats
            const alivePlants = plants.filter(p => p.alive);
            const alivePollinators = pollinators.filter(p => p.alive);
            const aliveLinks = links.filter(l => 
                plants.find(p => p.id === l.plant)?.alive && 
                pollinators.find(p => p.id === l.pollinator)?.alive
            );
            const maxLinks = alivePlants.length * alivePollinators.length;
            const connectance = maxLinks > 0 ? aliveLinks.length / maxLinks : 0;
            // Simple nestedness measure
            let nestedness = 0;
            if (aliveLinks.length > 0) {
                const degrees = pollinators.filter(p => p.alive).map(p => 
                    aliveLinks.filter(l => l.pollinator === p.id).length
                );
                const maxDeg = Math.max(...degrees);
                if (maxDeg > 0) nestedness = degrees.reduce((a, b) => a + b, 0) / (degrees.length * maxDeg);
            }
            document.getElementById('plantCount').textContent = alivePlants.length;
            document.getElementById('pollinatorCount').textContent = alivePollinators.length;
            document.getElementById('linkCount').textContent = aliveLinks.length;
            document.getElementById('connectance').textContent = connectance.toFixed(2);
            document.getElementById('nestedness').textContent = nestedness.toFixed(2);
        }
        function animate() { draw(); requestAnimationFrame(animate); }
        document.getElementById('plants').addEventListener('input', e => { params.plants = parseInt(e.target.value); document.getElementById('plantValue').textContent = params.plants; });
        document.getElementById('pollinators').addEventListener('input', e => { params.pollinators = parseInt(e.target.value); document.getElementById('pollinatorValue').textContent = params.pollinators; });
        document.getElementById('spec').addEventListener('input', e => { params.spec = parseFloat(e.target.value); document.getElementById('specValue').textContent = params.spec.toFixed(2); });
        document.getElementById('reset').addEventListener('click', init);
        document.getElementById('removeSpecies').addEventListener('click', removeRandomSpecies);
        window.addEventListener('resize', () => { resize(); init(); });
        const modal = document.getElementById('explainModal');
        document.getElementById('explainBtn').addEventListener('click', () => modal.classList.add('active'));
        modal.querySelector('.modal-close').addEventListener('click', () => modal.classList.remove('active'));
        modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('active'); });
        init(); animate();
    </script>
    <script src="../../assets/js/enhance.js" defer></script>
</body>
</html>
