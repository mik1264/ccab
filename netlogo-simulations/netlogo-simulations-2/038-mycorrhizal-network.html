<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mycorrhizal Network - CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #1a1a2e; color: #e8e6e1; overflow: hidden; }
        #container { display: flex; height: 100vh; }
        #canvas-container { flex: 1; position: relative; }
        canvas { display: block; width: 100%; height: 100%; }
        #controls { width: 300px; background: rgba(0,0,0,0.8); padding: 20px; overflow-y: auto; }
        h1 { font-size: 1.2rem; margin-bottom: 15px; color: #a78bfa; }
        .control-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: #aaa; }
        input[type="range"] { width: 100%; }
        button { width: 100%; padding: 10px; margin-bottom: 10px; background: #a78bfa; color: #1a1a2e; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: #8b5cf6; }
        .stats { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; font-size: 0.8rem; margin-bottom: 15px; }
        .back-link { position: fixed; top: 10px; left: 10px; padding: 8px 16px; background: rgba(0,0,0,0.7); color: #a78bfa; text-decoration: none; border-radius: 6px; font-size: 14px; z-index: 999; }
        .explain-btn { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); margin-top: 10px; }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; }
        .modal-overlay.active { display: flex; align-items: center; justify-content: center; }
        .modal { background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%); border-radius: 16px; padding: 30px; max-width: 600px; max-height: 80vh; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); position: relative; }
        .modal-close { position: absolute; top: 15px; right: 20px; background: none; border: none; color: #888; font-size: 28px; cursor: pointer; width: auto; }
        .modal h2 { color: #a78bfa; margin-bottom: 20px; }
        .modal-body { color: #ccc; line-height: 1.8; }
        .modal-body h3 { color: #c4b5fd; margin: 20px 0 10px; }
        .modal-body strong { color: #a78bfa; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Gallery</a>
    <div id="container">
        <div id="canvas-container"><canvas id="canvas"></canvas></div>
        <div id="controls">
            <h1>Mycorrhizal Network</h1>
            <div class="control-group">
                <label>Tree Count: <span id="treeValue">12</span></label>
                <input type="range" id="trees" min="5" max="25" value="12">
            </div>
            <div class="control-group">
                <label>Network Connectivity: <span id="connectValue">0.5</span></label>
                <input type="range" id="connect" min="0.1" max="1.0" step="0.05" value="0.5">
            </div>
            <div class="control-group">
                <label>Resource Transfer Rate: <span id="transferValue">0.3</span></label>
                <input type="range" id="transfer" min="0.1" max="0.8" step="0.05" value="0.3">
            </div>
            <button id="reset">Reset Forest</button>
            <button id="shade">Shade Random Tree</button>
            <button id="explainBtn" class="explain-btn">üìö Explain</button>
            <div class="stats">
                <div>Trees: <span id="treeCount">0</span></div>
                <div>Network Links: <span id="linkCount">0</span></div>
                <div>Avg Resources: <span id="avgResources">0</span></div>
                <div>Resource Inequality: <span id="inequality">0</span></div>
                <div>Transfer Events: <span id="transfers">0</span></div>
            </div>
        </div>
    </div>
    <div id="explainModal" class="modal-overlay">
        <div class="modal">
            <button class="modal-close">&times;</button>
            <h2>üçÑ Mycorrhizal Networks</h2>
            <div class="modal-body">
                <p>A <strong>mycorrhizal network</strong> (wood wide web) connects trees through fungal hyphae, enabling resource and signal sharing.</p>
                <h3>Mutualistic Exchange</h3>
                <ul>
                    <li>Plants provide carbohydrates (sugars) to fungi</li>
                    <li>Fungi provide water and mineral nutrients to plants</li>
                    <li>80-90% of land plants form mycorrhizal associations</li>
                </ul>
                <h3>Network Functions</h3>
                <ul>
                    <li><strong>Resource redistribution:</strong> Carbon flows from sun-lit to shaded trees</li>
                    <li><strong>Mother trees:</strong> Large trees support seedlings through network</li>
                    <li><strong>Defense signaling:</strong> Attacked trees warn neighbors via network</li>
                </ul>
                <h3>Socialist vs Capitalist Networks</h3>
                <p>Networks may distribute resources equally (socialist) or preferentially to best partners (capitalist). Research suggests both patterns exist.</p>
            </div>
        </div>
    </div>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let params = { trees: 12, connect: 0.5, transfer: 0.3 };
        let trees = [], links = [], transfers = 0, resourceFlows = [];
        
        function resize() { canvas.width = document.getElementById('canvas-container').clientWidth; canvas.height = document.getElementById('canvas-container').clientHeight; }
        function init() {
            resize();
            trees = []; links = []; transfers = 0; resourceFlows = [];
            // Create trees
            for (let i = 0; i < params.trees; i++) {
                trees.push({
                    id: i,
                    x: 80 + Math.random() * (canvas.width - 160),
                    y: 80 + Math.random() * (canvas.height - 160),
                    resources: 50 + Math.random() * 50,
                    sunlight: 0.5 + Math.random() * 0.5,
                    size: 20 + Math.random() * 20
                });
            }
            // Create network links based on distance and connectivity
            for (let i = 0; i < trees.length; i++) {
                for (let j = i + 1; j < trees.length; j++) {
                    const dx = trees[j].x - trees[i].x;
                    const dy = trees[j].y - trees[i].y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    const maxDist = 200 * params.connect;
                    if (dist < maxDist && Math.random() < params.connect) {
                        links.push({ from: i, to: j, strength: 1 - dist/maxDist });
                    }
                }
            }
        }
        function shadeRandomTree() {
            const tree = trees[Math.floor(Math.random() * trees.length)];
            tree.sunlight = 0.1;
        }
        function update() {
            // Photosynthesis
            for (let t of trees) {
                t.resources += t.sunlight * 2;
                t.resources = Math.min(150, t.resources);
            }
            // Resource transfer through network
            for (let link of links) {
                const treeA = trees[link.from];
                const treeB = trees[link.to];
                const diff = treeA.resources - treeB.resources;
                if (Math.abs(diff) > 10) {
                    const transferAmount = diff * params.transfer * link.strength * 0.05;
                    treeA.resources -= transferAmount;
                    treeB.resources += transferAmount;
                    transfers++;
                    // Visual flow
                    if (Math.random() < 0.1) {
                        resourceFlows.push({
                            x: diff > 0 ? treeA.x : treeB.x,
                            y: diff > 0 ? treeA.y : treeB.y,
                            tx: diff > 0 ? treeB.x : treeA.x,
                            ty: diff > 0 ? treeB.y : treeA.y,
                            progress: 0
                        });
                    }
                }
            }
            // Update flows
            resourceFlows = resourceFlows.filter(f => {
                f.progress += 0.03;
                return f.progress < 1;
            });
            // Slowly recover sunlight
            for (let t of trees) {
                t.sunlight = Math.min(1, t.sunlight + 0.001);
            }
        }
        function draw() {
            // Background (soil)
            const grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
            grad.addColorStop(0, '#1a1a2e');
            grad.addColorStop(0.3, '#1a1a2e');
            grad.addColorStop(1, '#2d1f0f');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            // Draw underground network (hyphae)
            for (let link of links) {
                const treeA = trees[link.from];
                const treeB = trees[link.to];
                ctx.beginPath();
                ctx.moveTo(treeA.x, treeA.y);
                // Curved path underground
                const midX = (treeA.x + treeB.x) / 2;
                const midY = Math.max(treeA.y, treeB.y) + 50;
                ctx.quadraticCurveTo(midX, midY, treeB.x, treeB.y);
                ctx.strokeStyle = `rgba(167, 139, 250, ${link.strength * 0.4})`;
                ctx.lineWidth = link.strength * 3;
                ctx.stroke();
            }
            // Draw resource flows
            for (let f of resourceFlows) {
                const x = f.x + (f.tx - f.x) * f.progress;
                const y = f.y + (f.ty - f.y) * f.progress + Math.sin(f.progress * Math.PI) * 30;
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, Math.PI * 2);
                ctx.fillStyle = '#fbbf24';
                ctx.fill();
            }
            // Draw trees
            for (let t of trees) {
                // Trunk
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(t.x - 5, t.y - 20, 10, 40);
                // Canopy (color based on resources)
                const health = Math.min(1, t.resources / 100);
                const shade = t.sunlight;
                ctx.beginPath();
                ctx.arc(t.x, t.y - 30, t.size, 0, Math.PI * 2);
                ctx.fillStyle = `rgb(${Math.floor(34 * shade)}, ${Math.floor(139 * health * shade)}, ${Math.floor(34 * shade)})`;
                ctx.fill();
                // Resource indicator
                ctx.fillStyle = '#fff';
                ctx.font = '10px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(Math.floor(t.resources), t.x, t.y + 5);
            }
            // Stats
            const avgRes = trees.reduce((a, t) => a + t.resources, 0) / trees.length;
            const variance = trees.reduce((a, t) => a + Math.pow(t.resources - avgRes, 2), 0) / trees.length;
            const inequality = Math.sqrt(variance) / avgRes;
            document.getElementById('treeCount').textContent = trees.length;
            document.getElementById('linkCount').textContent = links.length;
            document.getElementById('avgResources').textContent = avgRes.toFixed(1);
            document.getElementById('inequality').textContent = inequality.toFixed(2);
            document.getElementById('transfers').textContent = transfers;
        }
        function animate() { update(); draw(); requestAnimationFrame(animate); }
        document.getElementById('trees').addEventListener('input', e => { params.trees = parseInt(e.target.value); document.getElementById('treeValue').textContent = params.trees; });
        document.getElementById('connect').addEventListener('input', e => { params.connect = parseFloat(e.target.value); document.getElementById('connectValue').textContent = params.connect.toFixed(2); });
        document.getElementById('transfer').addEventListener('input', e => { params.transfer = parseFloat(e.target.value); document.getElementById('transferValue').textContent = params.transfer.toFixed(2); });
        document.getElementById('reset').addEventListener('click', init);
        document.getElementById('shade').addEventListener('click', shadeRandomTree);
        window.addEventListener('resize', () => { resize(); init(); });
        const modal = document.getElementById('explainModal');
        document.getElementById('explainBtn').addEventListener('click', () => modal.classList.add('active'));
        modal.querySelector('.modal-close').addEventListener('click', () => modal.classList.remove('active'));
        modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('active'); });
        init(); animate();
    </script>
    <script src="../../assets/js/enhance.js" defer></script>
</body>
</html>
