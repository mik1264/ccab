<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool Use Evolution - CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #e8e6e1;
            overflow: hidden;
        }
        #container { display: flex; height: 100vh; }
        #canvas-container { flex: 1; position: relative; }
        canvas { display: block; width: 100%; height: 100%; }
        #controls {
            width: 300px;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            overflow-y: auto;
        }
        h1 { font-size: 1.2rem; margin-bottom: 15px; color: #f97316; }
        .control-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: #aaa; }
        input[type="range"] { width: 100%; margin-bottom: 5px; }
        button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            background: #f97316;
            color: #1a1a2e;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover { background: #ea580c; }
        .stats {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            margin-bottom: 15px;
        }
        .stats div { margin-bottom: 5px; }
        .back-link {
            position: fixed;
            top: 10px;
            left: 10px;
            padding: 8px 16px;
            background: rgba(0,0,0,0.7);
            color: #f97316;
            text-decoration: none;
            border-radius: 6px;
            font-size: 14px;
            z-index: 999;
        }
        .back-link:hover { background: rgba(249,115,22,0.2); }
        .legend { margin-top: 15px; font-size: 0.75rem; }
        .legend-item { display: flex; align-items: center; margin-bottom: 5px; }
        .legend-color { width: 15px; height: 15px; margin-right: 8px; border-radius: 3px; }
        .explain-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            margin-top: 10px;
        }
        .explain-btn:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        }
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
        }
        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal {
            background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%);
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: #888;
            font-size: 28px;
            cursor: pointer;
            width: auto;
            padding: 0;
        }
        .modal-close:hover { color: #fff; }
        .modal h2 { color: #f97316; margin-bottom: 20px; font-size: 1.5rem; }
        .modal-body { color: #ccc; line-height: 1.8; font-size: 0.95rem; }
        .modal-body h3 { color: #fdba74; margin: 20px 0 10px 0; font-size: 1.1rem; }
        .modal-body p { margin-bottom: 15px; }
        .modal-body ul { margin: 10px 0 15px 20px; }
        .modal-body li { margin-bottom: 8px; }
        .modal-body strong { color: #f97316; }
        .modal-body em { color: #fdba74; font-style: normal; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Gallery</a>

    <div id="container">
        <div id="canvas-container">
            <canvas id="canvas"></canvas>
        </div>
        <div id="controls">
            <h1>Tool Use Evolution</h1>

            <div class="control-group">
                <label>Population Size: <span id="popSizeValue">60</span></label>
                <input type="range" id="popSize" min="20" max="150" value="60">
            </div>

            <div class="control-group">
                <label>Ecological Necessity: <span id="necessityValue">0.5</span></label>
                <input type="range" id="necessity" min="0" max="1.0" step="0.05" value="0.5">
            </div>

            <div class="control-group">
                <label>Innovation Rate: <span id="innovationValue">0.05</span></label>
                <input type="range" id="innovation" min="0" max="0.2" step="0.01" value="0.05">
            </div>

            <div class="control-group">
                <label>Social Tolerance: <span id="toleranceValue">0.7</span></label>
                <input type="range" id="tolerance" min="0" max="1.0" step="0.05" value="0.7">
            </div>

            <div class="control-group">
                <label>Cognitive Cost: <span id="cogCostValue">0.2</span></label>
                <input type="range" id="cogCost" min="0" max="0.5" step="0.02" value="0.2">
            </div>

            <button id="reset">Reset Simulation</button>
            <button id="addHardFood">Add Hard-to-Reach Food</button>
            <button id="explainBtn" class="explain-btn">üìö Explain</button>

            <div class="stats">
                <div>Generation: <span id="generation">0</span></div>
                <div>Tool Users: <span id="toolUsers">0%</span></div>
                <div>Avg Cognitive Level: <span id="avgCognition">0</span></div>
                <div>Innovations: <span id="totalInnovations">0</span></div>
                <div>Tool Types Known: <span id="toolTypes">0</span></div>
                <div>Cultural Complexity: <span id="complexity">0</span></div>
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #94a3b8;"></div>
                    <span>Non-Tool User</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f97316;"></div>
                    <span>Tool User</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #22c55e;"></div>
                    <span>Easy Food</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #a855f7;"></div>
                    <span>Hard-to-Reach Food</span>
                </div>
            </div>
        </div>
    </div>

    <div id="explainModal" class="modal-overlay">
        <div class="modal">
            <button class="modal-close">&times;</button>
            <h2>üîß Tool Use Evolution</h2>
            <div class="modal-body">
                <p>This simulation explores the <strong>conditions favoring tool use evolution</strong>. Tool use requires cognitive investment but can unlock otherwise inaccessible resources.</p>

                <h3>Prerequisites for Tool Use</h3>
                <ul>
                    <li><strong>Ecological Necessity:</strong> Resources that require tools to access</li>
                    <li><strong>Cognitive Capacity:</strong> Causal reasoning, problem-solving ability</li>
                    <li><strong>Social Tolerance:</strong> Close observation opportunities for learning</li>
                    <li><strong>Extended Development:</strong> Time to practice and learn</li>
                </ul>

                <h3>Niche Construction</h3>
                <p>Tool use creates a feedback loop:</p>
                <ul>
                    <li>Tools ‚Üí Access new resources ‚Üí Selection for cognition</li>
                    <li>Higher cognition ‚Üí Better tool innovation ‚Üí More resources</li>
                    <li>Cultural accumulation ‚Üí Ratchet effect</li>
                </ul>

                <h3>Real Examples</h3>
                <ul>
                    <li><strong>Chimpanzees:</strong> Termite fishing, nut-cracking (regionally variable)</li>
                    <li><strong>New Caledonian Crows:</strong> Hook-making, multi-step tool sequences</li>
                    <li><strong>Sea Otters:</strong> Stone anvils for shellfish</li>
                    <li><strong>Bottlenose Dolphins:</strong> Sponge-carrying for foraging</li>
                </ul>

                <h3>Key Findings</h3>
                <p>Research shows that juvenile animals who manipulate objects from young age are more likely to develop tool use later. Social tolerance allows close observation of skilled individuals ‚Äî critical for cultural transmission of tool techniques.</p>

                <h3>Try This</h3>
                <ul>
                    <li>Increase <em>Ecological Necessity</em> with more hard-to-reach food</li>
                    <li>Reduce <em>Social Tolerance</em> to see tool use fail to spread</li>
                    <li>Watch how tool traditions emerge and spread through the population</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let params = {
            popSize: 60,
            necessity: 0.5,
            innovation: 0.05,
            tolerance: 0.7,
            cogCost: 0.2
        };

        let agents = [];
        let easyFood = [];
        let hardFood = [];
        let generation = 0;
        let totalInnovations = 0;
        let knownTools = new Set();

        const TOOL_TYPES = ['probe', 'hammer', 'lever', 'hook', 'container'];

        function resize() {
            const container = document.getElementById('canvas-container');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }

        function createAgent(x, y, parent) {
            const cognition = parent ? 
                Math.max(0, Math.min(1, parent.cognition + (Math.random() - 0.5) * 0.1)) :
                Math.random() * 0.3;
            
            return {
                x: x || Math.random() * canvas.width,
                y: y || Math.random() * canvas.height,
                vx: (Math.random() - 0.5) * 2,
                vy: (Math.random() - 0.5) * 2,
                cognition: cognition,
                tools: parent ? [...parent.tools] : [],
                usesTool: false,
                energy: 0.5,
                fitness: 0,
                age: 0,
                learningTarget: null
            };
        }

        function createFood(hard = false) {
            return {
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                value: hard ? 0.8 + Math.random() * 0.4 : 0.3 + Math.random() * 0.3,
                hard: hard,
                requiredTool: hard ? TOOL_TYPES[Math.floor(Math.random() * TOOL_TYPES.length)] : null
            };
        }

        function init() {
            resize();
            agents = [];
            easyFood = [];
            hardFood = [];
            generation = 0;
            totalInnovations = 0;
            knownTools = new Set();

            for (let i = 0; i < params.popSize; i++) {
                agents.push(createAgent());
            }

            // Create food sources
            const numHardFood = Math.floor(30 * params.necessity);
            for (let i = 0; i < 40 - numHardFood; i++) {
                easyFood.push(createFood(false));
            }
            for (let i = 0; i < numHardFood; i++) {
                hardFood.push(createFood(true));
            }
        }

        function innovate(agent) {
            if (agent.cognition > 0.3 && Math.random() < params.innovation * agent.cognition) {
                const newTool = TOOL_TYPES[Math.floor(Math.random() * TOOL_TYPES.length)];
                if (!agent.tools.includes(newTool)) {
                    agent.tools.push(newTool);
                    knownTools.add(newTool);
                    totalInnovations++;
                    return true;
                }
            }
            return false;
        }

        function socialLearn(agent) {
            // Find nearby skilled agents
            const neighbors = agents.filter(other => {
                if (other === agent || other.tools.length === 0) return false;
                const dx = other.x - agent.x;
                const dy = other.y - agent.y;
                return dx * dx + dy * dy < 80 * 80;
            });

            if (neighbors.length === 0) return;

            // Tolerance affects learning success
            if (Math.random() < params.tolerance) {
                const model = neighbors[Math.floor(Math.random() * neighbors.length)];
                // Try to learn a tool the model has
                for (let tool of model.tools) {
                    if (!agent.tools.includes(tool) && agent.cognition > 0.2) {
                        if (Math.random() < agent.cognition) {
                            agent.tools.push(tool);
                            break;
                        }
                    }
                }
            }
        }

        function updateAgent(agent) {
            agent.age++;
            agent.usesTool = agent.tools.length > 0;

            // Cognitive cost
            agent.energy -= params.cogCost * agent.cognition * 0.01;

            // Movement toward food
            let targetX = agent.x;
            let targetY = agent.y;

            // Find nearest accessible food
            let nearestDist = Infinity;
            let nearestFood = null;
            let targetList = null;

            // Check easy food
            for (let food of easyFood) {
                const dx = food.x - agent.x;
                const dy = food.y - agent.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist < nearestDist) {
                    nearestDist = dist;
                    nearestFood = food;
                    targetList = easyFood;
                }
            }

            // Check hard food if has appropriate tool
            for (let food of hardFood) {
                if (agent.tools.includes(food.requiredTool)) {
                    const dx = food.x - agent.x;
                    const dy = food.y - agent.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < nearestDist) {
                        nearestDist = dist;
                        nearestFood = food;
                        targetList = hardFood;
                    }
                }
            }

            if (nearestFood) {
                targetX = nearestFood.x;
                targetY = nearestFood.y;

                // Eat if close enough
                if (nearestDist < 15) {
                    agent.energy = Math.min(1.5, agent.energy + nearestFood.value);
                    const idx = targetList.indexOf(nearestFood);
                    if (idx >= 0) {
                        targetList.splice(idx, 1);
                        // Respawn food
                        if (targetList === easyFood) {
                            easyFood.push(createFood(false));
                        } else {
                            hardFood.push(createFood(true));
                        }
                    }
                }
            }

            // Movement
            const dx = targetX - agent.x;
            const dy = targetY - agent.y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            if (dist > 1) {
                agent.vx += dx / dist * 0.2;
                agent.vy += dy / dist * 0.2;
            }

            agent.vx *= 0.95;
            agent.vy *= 0.95;
            agent.x += agent.vx;
            agent.y += agent.vy;

            // Boundaries
            if (agent.x < 0 || agent.x > canvas.width) agent.vx *= -1;
            if (agent.y < 0 || agent.y > canvas.height) agent.vy *= -1;
            agent.x = Math.max(0, Math.min(canvas.width, agent.x));
            agent.y = Math.max(0, Math.min(canvas.height, agent.y));

            // Innovation and learning
            if (Math.random() < 0.02) innovate(agent);
            if (Math.random() < 0.05) socialLearn(agent);

            // Fitness
            agent.fitness = agent.energy - params.cogCost * agent.cognition;

            // Death
            agent.energy -= 0.002;
        }

        function reproduce() {
            // Remove dead agents
            agents = agents.filter(a => a.energy > 0);

            // Reproduce if population low
            while (agents.length < params.popSize * 0.8) {
                // Select fit parents
                const sorted = [...agents].sort((a, b) => b.fitness - a.fitness);
                if (sorted.length === 0) break;
                
                const parent = sorted[Math.floor(Math.random() * Math.min(10, sorted.length))];
                const offspring = createAgent(
                    parent.x + (Math.random() - 0.5) * 30,
                    parent.y + (Math.random() - 0.5) * 30,
                    parent
                );
                agents.push(offspring);
            }
        }

        function draw() {
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw easy food
            for (let food of easyFood) {
                ctx.beginPath();
                ctx.arc(food.x, food.y, 6, 0, Math.PI * 2);
                ctx.fillStyle = '#22c55e';
                ctx.fill();
            }

            // Draw hard food with tool indicator
            for (let food of hardFood) {
                ctx.beginPath();
                ctx.arc(food.x, food.y, 8, 0, Math.PI * 2);
                ctx.fillStyle = '#a855f7';
                ctx.fill();
                
                // Tool icon
                ctx.font = '8px sans-serif';
                ctx.fillStyle = '#fff';
                ctx.fillText(food.requiredTool[0].toUpperCase(), food.x - 3, food.y + 3);
            }

            // Draw agents
            for (let agent of agents) {
                updateAgent(agent);

                const size = 6 + agent.cognition * 6;
                ctx.beginPath();
                ctx.arc(agent.x, agent.y, size, 0, Math.PI * 2);
                ctx.fillStyle = agent.usesTool ? '#f97316' : '#94a3b8';
                ctx.fill();

                // Tool indicator
                if (agent.tools.length > 0) {
                    ctx.beginPath();
                    ctx.arc(agent.x, agent.y, size + 3, 0, Math.PI * 2);
                    ctx.strokeStyle = `rgba(249, 115, 22, ${0.3 + agent.tools.length * 0.15})`;
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }

                // Cognition glow
                if (agent.cognition > 0.5) {
                    ctx.beginPath();
                    ctx.arc(agent.x, agent.y - size - 5, 3, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(251, 191, 36, ${agent.cognition})`;
                    ctx.fill();
                }
            }

            // Periodic reproduction
            if (generation % 60 === 0) reproduce();
            generation++;

            // Update stats
            const toolUsers = agents.filter(a => a.usesTool).length;
            const avgCog = agents.length > 0 ? 
                agents.reduce((s, a) => s + a.cognition, 0) / agents.length : 0;
            const avgTools = agents.length > 0 ?
                agents.reduce((s, a) => s + a.tools.length, 0) / agents.length : 0;

            document.getElementById('generation').textContent = generation;
            document.getElementById('toolUsers').textContent = 
                agents.length > 0 ? ((toolUsers / agents.length) * 100).toFixed(0) + '%' : '0%';
            document.getElementById('avgCognition').textContent = avgCog.toFixed(2);
            document.getElementById('totalInnovations').textContent = totalInnovations;
            document.getElementById('toolTypes').textContent = knownTools.size;
            document.getElementById('complexity').textContent = avgTools.toFixed(1);
        }

        function animate() {
            draw();
            requestAnimationFrame(animate);
        }

        // Event listeners
        document.getElementById('popSize').addEventListener('input', (e) => {
            params.popSize = parseInt(e.target.value);
            document.getElementById('popSizeValue').textContent = params.popSize;
        });

        document.getElementById('necessity').addEventListener('input', (e) => {
            params.necessity = parseFloat(e.target.value);
            document.getElementById('necessityValue').textContent = params.necessity.toFixed(2);
        });

        document.getElementById('innovation').addEventListener('input', (e) => {
            params.innovation = parseFloat(e.target.value);
            document.getElementById('innovationValue').textContent = params.innovation.toFixed(2);
        });

        document.getElementById('tolerance').addEventListener('input', (e) => {
            params.tolerance = parseFloat(e.target.value);
            document.getElementById('toleranceValue').textContent = params.tolerance.toFixed(2);
        });

        document.getElementById('cogCost').addEventListener('input', (e) => {
            params.cogCost = parseFloat(e.target.value);
            document.getElementById('cogCostValue').textContent = params.cogCost.toFixed(2);
        });

        document.getElementById('reset').addEventListener('click', init);
        document.getElementById('addHardFood').addEventListener('click', () => {
            for (let i = 0; i < 10; i++) {
                hardFood.push(createFood(true));
            }
        });

        window.addEventListener('resize', () => { resize(); init(); });

        const modal = document.getElementById('explainModal');
        document.getElementById('explainBtn').addEventListener('click', () => modal.classList.add('active'));
        modal.querySelector('.modal-close').addEventListener('click', () => modal.classList.remove('active'));
        modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('active'); });

        init();
        animate();
    </script>
    <script src="../../assets/js/enhance.js" defer></script>
</body>
</html>
