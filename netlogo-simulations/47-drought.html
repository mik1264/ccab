<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agricultural Drought Simulation - CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #e8e6e1;
            overflow: hidden;
        }
        #container { display: flex; height: 100vh; }
        #canvas-container { flex: 1; position: relative; display: flex; flex-direction: column; }
        #main-canvas { flex: 1; }
        #graph-canvas { height: 120px; border-top: 1px solid #333; }
        canvas { display: block; width: 100%; height: 100%; }
        #controls { width: 280px; background: rgba(0,0,0,0.8); padding: 20px; overflow-y: auto; }
        h1 { font-size: 1.2rem; margin-bottom: 15px; color: #eab308; }
        .control-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: #aaa; }
        input[type="range"] { width: 100%; margin-bottom: 5px; }
        button { width: 100%; padding: 10px; margin-bottom: 10px; background: #eab308; color: #1a1a2e; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: #ca8a04; }
        .stats { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; font-size: 0.8rem; }
        .stats div { margin-bottom: 5px; }
        .back-link { position: fixed; top: 10px; left: 10px; padding: 8px 16px; background: rgba(0,0,0,0.7); color: #eab308; text-decoration: none; border-radius: 6px; font-size: 14px; z-index: 999; }
        .description { font-size: 0.75rem; color: #888; margin-bottom: 15px; line-height: 1.5; }
        .alert { background: #dc2626; color: white; padding: 8px; border-radius: 5px; margin-bottom: 10px; font-size: 0.8rem; display: none; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back to Gallery</a>
    <div id="container">
        <div id="canvas-container">
            <canvas id="main-canvas"></canvas>
            <canvas id="graph-canvas"></canvas>
        </div>
        <div id="controls">
            <h1>Agricultural Drought</h1>
            <p class="description">Model soil moisture, rainfall patterns, and crop stress. Watch how drought conditions develop and spread across farmland.</p>
            <div id="alert" class="alert">DROUGHT WARNING: Critical soil moisture levels!</div>
            <div class="control-group">
                <label>Rainfall Probability: <span id="rainProbValue">30</span>%</label>
                <input type="range" id="rainProb" min="0" max="100" value="30">
            </div>
            <div class="control-group">
                <label>Temperature: <span id="tempValue">25</span>°C</label>
                <input type="range" id="temp" min="15" max="45" value="25">
            </div>
            <div class="control-group">
                <label>Evaporation Rate: <span id="evapValue">1.0</span></label>
                <input type="range" id="evap" min="0.5" max="2.0" step="0.1" value="1.0">
            </div>
            <div class="control-group">
                <label>Irrigation Coverage: <span id="irrigValue">20</span>%</label>
                <input type="range" id="irrig" min="0" max="100" value="20">
            </div>
            <button id="reset">Reset Simulation</button>
            <button id="rain">Trigger Rainfall</button>
            <button id="heatwave">Heat Wave Event</button>
            <div class="stats">
                <div>Day: <span id="day">0</span></div>
                <div>Avg Soil Moisture: <span id="moisture">0</span>%</div>
                <div>Healthy Crops: <span id="healthy">0</span>%</div>
                <div>Stressed Crops: <span id="stressed">0</span>%</div>
                <div>Failed Crops: <span id="failed">0</span>%</div>
                <div>Total Rainfall: <span id="totalRain">0</span> mm</div>
            </div>
        </div>
    </div>
    <script>
        const mainCanvas = document.getElementById('main-canvas');
        const mainCtx = mainCanvas.getContext('2d');
        const graphCanvas = document.getElementById('graph-canvas');
        const graphCtx = graphCanvas.getContext('2d');

        let width, height, gridSize = 8, cols, rows;
        let cells = [], day = 0, totalRainfall = 0;
        let moistureHistory = [], healthHistory = [];
        const maxHistory = 200;

        let params = { rainProb: 30, temp: 25, evap: 1.0, irrig: 20 };

        function resize() {
            mainCanvas.width = mainCanvas.clientWidth;
            mainCanvas.height = mainCanvas.clientHeight;
            graphCanvas.width = graphCanvas.clientWidth;
            graphCanvas.height = graphCanvas.clientHeight;
            width = mainCanvas.width;
            height = mainCanvas.height;
            cols = Math.floor(width / gridSize);
            rows = Math.floor(height / gridSize);
        }

        function init() {
            resize();
            cells = [];
            day = 0;
            totalRainfall = 0;
            moistureHistory = [];
            healthHistory = [];

            for (let y = 0; y < rows; y++) {
                cells[y] = [];
                for (let x = 0; x < cols; x++) {
                    const hasIrrigation = Math.random() * 100 < params.irrig;
                    cells[y][x] = {
                        moisture: 50 + Math.random() * 30,
                        crop: Math.random() > 0.1 ? 'wheat' : 'fallow',
                        health: 100,
                        irrigated: hasIrrigation,
                        daysSinceRain: 0
                    };
                }
            }
        }

        function update() {
            day++;
            let rainToday = false;

            // Check for rain
            if (Math.random() * 100 < params.rainProb) {
                rainToday = true;
                const rainAmount = 10 + Math.random() * 30;
                totalRainfall += rainAmount;

                for (let y = 0; y < rows; y++) {
                    for (let x = 0; x < cols; x++) {
                        cells[y][x].moisture = Math.min(100, cells[y][x].moisture + rainAmount);
                        cells[y][x].daysSinceRain = 0;
                    }
                }
            }

            // Update each cell
            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    const cell = cells[y][x];

                    if (!rainToday) cell.daysSinceRain++;

                    // Evaporation (increases with temperature)
                    const tempFactor = (params.temp - 15) / 30;
                    const evapAmount = params.evap * (1 + tempFactor) * (0.5 + Math.random() * 0.5);
                    cell.moisture = Math.max(0, cell.moisture - evapAmount);

                    // Irrigation
                    if (cell.irrigated && cell.moisture < 40) {
                        cell.moisture = Math.min(100, cell.moisture + 5);
                    }

                    // Crop water consumption
                    if (cell.crop !== 'fallow') {
                        cell.moisture = Math.max(0, cell.moisture - 0.5);
                    }

                    // Moisture diffusion from neighbors
                    let neighborMoisture = 0;
                    let neighbors = 0;
                    for (let dy = -1; dy <= 1; dy++) {
                        for (let dx = -1; dx <= 1; dx++) {
                            if (dx === 0 && dy === 0) continue;
                            const ny = y + dy, nx = x + dx;
                            if (ny >= 0 && ny < rows && nx >= 0 && nx < cols) {
                                neighborMoisture += cells[ny][nx].moisture;
                                neighbors++;
                            }
                        }
                    }
                    if (neighbors > 0) {
                        const avgNeighbor = neighborMoisture / neighbors;
                        cell.moisture += (avgNeighbor - cell.moisture) * 0.05;
                    }

                    // Update crop health
                    if (cell.crop !== 'fallow') {
                        if (cell.moisture < 20) {
                            cell.health = Math.max(0, cell.health - 2);
                        } else if (cell.moisture < 40) {
                            cell.health = Math.max(0, cell.health - 0.5);
                        } else if (cell.moisture > 60 && cell.health < 100) {
                            cell.health = Math.min(100, cell.health + 0.3);
                        }

                        // Heat stress
                        if (params.temp > 35) {
                            cell.health = Math.max(0, cell.health - 1);
                        }
                    }
                }
            }

            // Record history
            let totalMoisture = 0, totalHealth = 0, cropCount = 0;
            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    totalMoisture += cells[y][x].moisture;
                    if (cells[y][x].crop !== 'fallow') {
                        totalHealth += cells[y][x].health;
                        cropCount++;
                    }
                }
            }
            const avgMoisture = totalMoisture / (rows * cols);
            const avgHealth = cropCount > 0 ? totalHealth / cropCount : 0;

            moistureHistory.push(avgMoisture);
            healthHistory.push(avgHealth);
            if (moistureHistory.length > maxHistory) moistureHistory.shift();
            if (healthHistory.length > maxHistory) healthHistory.shift();

            // Check for drought alert
            document.getElementById('alert').style.display = avgMoisture < 25 ? 'block' : 'none';
        }

        function draw() {
            // Draw grid
            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    const cell = cells[y][x];
                    let color;

                    if (cell.crop === 'fallow') {
                        // Brown/tan for fallow
                        const m = cell.moisture / 100;
                        color = `rgb(${139 + m * 30}, ${119 + m * 30}, ${101 - m * 20})`;
                    } else {
                        // Color based on crop health and moisture
                        const h = cell.health / 100;
                        const m = cell.moisture / 100;

                        if (cell.health > 70) {
                            // Healthy - green
                            color = `rgb(${34 + (1-h) * 100}, ${139 * h + 80 * (1-h)}, ${34})`;
                        } else if (cell.health > 30) {
                            // Stressed - yellow/brown
                            color = `rgb(${180 + (1-h) * 50}, ${140 * h + 80 * (1-h)}, ${34})`;
                        } else {
                            // Failing - brown/dead
                            color = `rgb(${139 + (1-h) * 50}, ${90 * h + 60}, ${34})`;
                        }
                    }

                    mainCtx.fillStyle = color;
                    mainCtx.fillRect(x * gridSize, y * gridSize, gridSize - 1, gridSize - 1);

                    // Draw irrigation indicator
                    if (cell.irrigated) {
                        mainCtx.fillStyle = 'rgba(0, 150, 255, 0.3)';
                        mainCtx.fillRect(x * gridSize, y * gridSize, 3, 3);
                    }
                }
            }

            // Draw graph
            graphCtx.fillStyle = '#1a1a2e';
            graphCtx.fillRect(0, 0, graphCanvas.width, graphCanvas.height);

            // Moisture line
            graphCtx.strokeStyle = '#3b82f6';
            graphCtx.lineWidth = 2;
            graphCtx.beginPath();
            for (let i = 0; i < moistureHistory.length; i++) {
                const x = (i / maxHistory) * graphCanvas.width;
                const y = graphCanvas.height - (moistureHistory[i] / 100) * graphCanvas.height;
                if (i === 0) graphCtx.moveTo(x, y);
                else graphCtx.lineTo(x, y);
            }
            graphCtx.stroke();

            // Health line
            graphCtx.strokeStyle = '#22c55e';
            graphCtx.beginPath();
            for (let i = 0; i < healthHistory.length; i++) {
                const x = (i / maxHistory) * graphCanvas.width;
                const y = graphCanvas.height - (healthHistory[i] / 100) * graphCanvas.height;
                if (i === 0) graphCtx.moveTo(x, y);
                else graphCtx.lineTo(x, y);
            }
            graphCtx.stroke();

            // Legend
            graphCtx.fillStyle = '#3b82f6';
            graphCtx.fillRect(10, 10, 20, 10);
            graphCtx.fillStyle = '#aaa';
            graphCtx.font = '10px sans-serif';
            graphCtx.fillText('Moisture', 35, 18);

            graphCtx.fillStyle = '#22c55e';
            graphCtx.fillRect(100, 10, 20, 10);
            graphCtx.fillStyle = '#aaa';
            graphCtx.fillText('Crop Health', 125, 18);

            // Update stats
            let healthy = 0, stressed = 0, failed = 0, cropCount = 0;
            let totalMoisture = 0;
            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    totalMoisture += cells[y][x].moisture;
                    if (cells[y][x].crop !== 'fallow') {
                        cropCount++;
                        if (cells[y][x].health > 70) healthy++;
                        else if (cells[y][x].health > 30) stressed++;
                        else failed++;
                    }
                }
            }

            document.getElementById('day').textContent = day;
            document.getElementById('moisture').textContent = (totalMoisture / (rows * cols)).toFixed(1);
            document.getElementById('healthy').textContent = cropCount > 0 ? ((healthy / cropCount) * 100).toFixed(1) : 0;
            document.getElementById('stressed').textContent = cropCount > 0 ? ((stressed / cropCount) * 100).toFixed(1) : 0;
            document.getElementById('failed').textContent = cropCount > 0 ? ((failed / cropCount) * 100).toFixed(1) : 0;
            document.getElementById('totalRain').textContent = totalRainfall.toFixed(0);
        }

        function animate() {
            update();
            draw();
            requestAnimationFrame(animate);
        }

        // Event listeners
        document.getElementById('rainProb').addEventListener('input', e => {
            params.rainProb = parseInt(e.target.value);
            document.getElementById('rainProbValue').textContent = params.rainProb;
        });
        document.getElementById('temp').addEventListener('input', e => {
            params.temp = parseInt(e.target.value);
            document.getElementById('tempValue').textContent = params.temp;
        });
        document.getElementById('evap').addEventListener('input', e => {
            params.evap = parseFloat(e.target.value);
            document.getElementById('evapValue').textContent = params.evap.toFixed(1);
        });
        document.getElementById('irrig').addEventListener('input', e => {
            params.irrig = parseInt(e.target.value);
            document.getElementById('irrigValue').textContent = params.irrig;
        });

        document.getElementById('reset').addEventListener('click', init);
        document.getElementById('rain').addEventListener('click', () => {
            const rainAmount = 30 + Math.random() * 20;
            totalRainfall += rainAmount;
            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    cells[y][x].moisture = Math.min(100, cells[y][x].moisture + rainAmount);
                    cells[y][x].daysSinceRain = 0;
                }
            }
        });
        document.getElementById('heatwave').addEventListener('click', () => {
            params.temp = 42;
            document.getElementById('temp').value = 42;
            document.getElementById('tempValue').textContent = 42;
        });

        window.addEventListener('resize', () => { resize(); init(); });
        init();
        animate();
    </script>
</body>
</html>
