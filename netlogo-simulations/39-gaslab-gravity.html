<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GasLab Gravity Box - Atmospheric Stratification</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e8e8e8;
            min-height: 100vh;
            display: flex;
        }
        .sidebar {
            width: 300px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            overflow-y: auto;
        }
        .main-content { flex: 1; display: flex; flex-direction: column; padding: 20px; }
        h1 { font-size: 1.4rem; margin-bottom: 10px; color: #60a5fa; }
        .description { font-size: 0.85rem; color: #aaa; margin-bottom: 20px; line-height: 1.5; }
        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; font-size: 0.8rem; color: #888; margin-bottom: 5px; }
        .control-group input[type="range"] { width: 100%; }
        .control-group .value { font-size: 0.75rem; color: #60a5fa; }
        .buttons { display: flex; gap: 10px; margin-bottom: 20px; }
        button { padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.85rem; }
        .btn-primary { background: #60a5fa; color: #1a1a2e; }
        .btn-secondary { background: #374151; color: #e8e8e8; }
        button:hover { opacity: 0.8; }
        .stats { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.85rem; }
        .stat-label { color: #888; }
        .stat-value { font-weight: bold; font-family: monospace; }
        .canvas-container { flex: 1; display: flex; gap: 20px; min-height: 0; }
        canvas { border-radius: 8px; background: #0a0a0a; }
        #simCanvas { flex: 2; }
        .charts { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .chart-container { flex: 1; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; }
        .chart-title { font-size: 0.75rem; color: #888; margin-bottom: 5px; }
        .back-link { display: inline-block; color: #60a5fa; text-decoration: none; margin-bottom: 15px; font-size: 0.85rem; }
        .back-link:hover { text-decoration: underline; }
        .equation { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; font-family: monospace; font-size: 0.8rem; margin-bottom: 15px; text-align: center; }
    </style>
</head>
<body>
    <div class="sidebar">
        <a href="index.html" class="back-link">← Back to Gallery</a>
        <h1>GasLab Gravity Box</h1>
        <p class="description">
            Gas molecules under gravitational influence. Pressure decreases exponentially with height
            following the barometric formula. Demonstrates atmospheric stratification and scale height.
        </p>

        <div class="equation">
            P(h) = P₀ × e^(-h/H)<br>
            H = kT/(mg) (scale height)
        </div>

        <div class="buttons">
            <button class="btn-primary" id="startBtn">Start</button>
            <button class="btn-secondary" id="resetBtn">Reset</button>
        </div>

        <div class="control-group">
            <label>Number of Particles: <span class="value" id="numParticlesValue">150</span></label>
            <input type="range" id="numParticles" min="50" max="300" value="150">
        </div>

        <div class="control-group">
            <label>Gravity (g): <span class="value" id="gravityValue">0.1</span></label>
            <input type="range" id="gravity" min="0" max="0.5" step="0.01" value="0.1">
        </div>

        <div class="control-group">
            <label>Temperature: <span class="value" id="tempValue">300 K</span></label>
            <input type="range" id="temp" min="100" max="600" value="300">
        </div>

        <div class="control-group">
            <label>Molecular Mass: <span class="value" id="massValue">28 amu</span></label>
            <input type="range" id="mass" min="4" max="100" value="28">
        </div>

        <div class="stats">
            <div class="stat-row">
                <span class="stat-label">Particles (Bottom):</span>
                <span class="stat-value" id="bottomCount">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Particles (Middle):</span>
                <span class="stat-value" id="middleCount">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Particles (Top):</span>
                <span class="stat-value" id="topCount">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Scale Height:</span>
                <span class="stat-value" id="scaleHeight">-- px</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Bottom Pressure:</span>
                <span class="stat-value" id="bottomPressure">1.0 atm</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Top Pressure:</span>
                <span class="stat-value" id="topPressure">0.0 atm</span>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="canvas-container">
            <canvas id="simCanvas"></canvas>
            <div class="charts">
                <div class="chart-container">
                    <div class="chart-title">Density vs Height</div>
                    <canvas id="densityChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Pressure Profile</div>
                    <canvas id="pressureChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        const simCanvas = document.getElementById('simCanvas');
        const simCtx = simCanvas.getContext('2d');
        const densityCanvas = document.getElementById('densityChart');
        const densityCtx = densityCanvas.getContext('2d');
        const pressureCanvas = document.getElementById('pressureChart');
        const pressureCtx = pressureCanvas.getContext('2d');

        let particles = [];
        let running = false;

        let params = {
            numParticles: 150,
            gravity: 0.1,
            temp: 300,
            mass: 28
        };

        function init() {
            resizeCanvases();
            setupControls();
            reset();
            animate();
        }

        function resizeCanvases() {
            const container = simCanvas.parentElement;
            const size = Math.min(container.clientWidth * 0.6, container.clientHeight - 40);
            simCanvas.width = size;
            simCanvas.height = size;

            document.querySelectorAll('.chart-container').forEach((c, i) => {
                const canvas = i === 0 ? densityCanvas : pressureCanvas;
                canvas.width = c.clientWidth - 20;
                canvas.height = c.clientHeight - 40;
            });
        }

        function setupControls() {
            document.getElementById('startBtn').onclick = () => {
                running = !running;
                document.getElementById('startBtn').textContent = running ? 'Pause' : 'Start';
            };
            document.getElementById('resetBtn').onclick = reset;

            ['numParticles', 'gravity', 'temp', 'mass'].forEach(id => {
                document.getElementById(id).oninput = (e) => {
                    params[id] = parseFloat(e.target.value);
                    let suffix = '';
                    if (id === 'temp') suffix = ' K';
                    else if (id === 'mass') suffix = ' amu';
                    document.getElementById(id + 'Value').textContent = params[id] + suffix;
                    if (id === 'numParticles') createParticles();
                };
            });

            window.addEventListener('resize', resizeCanvases);
        }

        function reset() {
            running = false;
            document.getElementById('startBtn').textContent = 'Start';
            createParticles();
            draw();
        }

        function createParticles() {
            particles = [];
            const w = simCanvas.width, h = simCanvas.height;

            for (let i = 0; i < params.numParticles; i++) {
                // Initialize with Maxwell-Boltzmann distribution
                const speed = getMaxwellSpeed();
                const angle = Math.random() * Math.PI * 2;
                particles.push({
                    x: 20 + Math.random() * (w - 40),
                    y: 20 + Math.random() * (h - 40),
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    radius: 4
                });
            }
        }

        function getMaxwellSpeed() {
            // Approximate Maxwell-Boltzmann using Box-Muller
            const u1 = Math.random(), u2 = Math.random();
            const z = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
            const sigma = Math.sqrt(params.temp / params.mass) * 0.5;
            return Math.abs(z * sigma + sigma * 2);
        }

        function update() {
            const w = simCanvas.width, h = simCanvas.height;

            particles.forEach(p => {
                // Apply gravity
                p.vy += params.gravity;

                // Update position
                p.x += p.vx;
                p.y += p.vy;

                // Wall collisions
                if (p.x - p.radius < 10) { p.x = 10 + p.radius; p.vx *= -1; }
                if (p.x + p.radius > w - 10) { p.x = w - 10 - p.radius; p.vx *= -1; }
                if (p.y - p.radius < 10) { p.y = 10 + p.radius; p.vy *= -1; }
                if (p.y + p.radius > h - 10) { p.y = h - 10 - p.radius; p.vy *= -1; }
            });

            // Particle collisions
            for (let i = 0; i < particles.length; i++) {
                for (let j = i + 1; j < particles.length; j++) {
                    collide(particles[i], particles[j]);
                }
            }

            updateStats();
        }

        function collide(p1, p2) {
            const dx = p2.x - p1.x;
            const dy = p2.y - p1.y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            const minDist = p1.radius + p2.radius;

            if (dist < minDist && dist > 0) {
                const nx = dx / dist;
                const ny = dy / dist;
                const dvx = p1.vx - p2.vx;
                const dvy = p1.vy - p2.vy;
                const dvn = dvx * nx + dvy * ny;

                if (dvn > 0) {
                    p1.vx -= dvn * nx;
                    p1.vy -= dvn * ny;
                    p2.vx += dvn * nx;
                    p2.vy += dvn * ny;

                    const overlap = minDist - dist;
                    p1.x -= overlap * 0.5 * nx;
                    p1.y -= overlap * 0.5 * ny;
                    p2.x += overlap * 0.5 * nx;
                    p2.y += overlap * 0.5 * ny;
                }
            }
        }

        function updateStats() {
            const h = simCanvas.height;
            const third = h / 3;

            let bottom = 0, middle = 0, top = 0;
            particles.forEach(p => {
                if (p.y > h - third) bottom++;
                else if (p.y > third) middle++;
                else top++;
            });

            document.getElementById('bottomCount').textContent = bottom;
            document.getElementById('middleCount').textContent = middle;
            document.getElementById('topCount').textContent = top;

            // Scale height H = kT/(mg) - in simulation units
            const scaleHeight = params.gravity > 0 ? (params.temp / params.mass) / params.gravity * 5 : Infinity;
            document.getElementById('scaleHeight').textContent =
                scaleHeight < 1000 ? Math.round(scaleHeight) + ' px' : '∞';

            // Pressure estimates
            const totalParticles = particles.length;
            const bottomPressure = bottom / totalParticles;
            const topPressure = top / totalParticles;
            document.getElementById('bottomPressure').textContent = bottomPressure.toFixed(2) + ' (rel)';
            document.getElementById('topPressure').textContent = topPressure.toFixed(2) + ' (rel)';
        }

        function draw() {
            drawSimulation();
            drawDensityChart();
            drawPressureChart();
        }

        function drawSimulation() {
            const w = simCanvas.width, h = simCanvas.height;

            // Background gradient (atmosphere effect)
            const gradient = simCtx.createLinearGradient(0, 0, 0, h);
            gradient.addColorStop(0, '#0a0a15');
            gradient.addColorStop(1, '#1a1a3e');
            simCtx.fillStyle = gradient;
            simCtx.fillRect(0, 0, w, h);

            // Chamber walls
            simCtx.strokeStyle = '#4b5563';
            simCtx.lineWidth = 3;
            simCtx.strokeRect(10, 10, w - 20, h - 20);

            // Height markers
            simCtx.strokeStyle = 'rgba(255,255,255,0.1)';
            simCtx.setLineDash([5, 5]);
            for (let y = h/4; y < h; y += h/4) {
                simCtx.beginPath();
                simCtx.moveTo(10, y);
                simCtx.lineTo(w - 10, y);
                simCtx.stroke();
            }
            simCtx.setLineDash([]);

            // Particles colored by height
            particles.forEach(p => {
                const heightRatio = 1 - p.y / h;
                const hue = 200 + heightRatio * 60; // Blue to cyan
                const lightness = 50 + heightRatio * 20;
                simCtx.fillStyle = `hsl(${hue}, 70%, ${lightness}%)`;
                simCtx.beginPath();
                simCtx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                simCtx.fill();
            });

            // Gravity arrow
            simCtx.fillStyle = '#f97316';
            simCtx.beginPath();
            simCtx.moveTo(w - 30, 30);
            simCtx.lineTo(w - 25, 30);
            simCtx.lineTo(w - 25, 60);
            simCtx.lineTo(w - 20, 60);
            simCtx.lineTo(w - 27.5, 75);
            simCtx.lineTo(w - 35, 60);
            simCtx.lineTo(w - 30, 60);
            simCtx.closePath();
            simCtx.fill();
            simCtx.fillStyle = '#888';
            simCtx.font = '10px sans-serif';
            simCtx.fillText('g', w - 32, 25);
        }

        function drawDensityChart() {
            const w = densityCanvas.width, h = densityCanvas.height;
            densityCtx.fillStyle = 'rgba(0,0,0,0.3)';
            densityCtx.fillRect(0, 0, w, h);

            // Build density histogram
            const bins = 20;
            const simH = simCanvas.height;
            const histogram = new Array(bins).fill(0);

            particles.forEach(p => {
                const bin = Math.floor((p.y / simH) * bins);
                if (bin >= 0 && bin < bins) histogram[bin]++;
            });

            const maxCount = Math.max(...histogram, 1);

            // Draw bars (horizontal - height on Y axis)
            densityCtx.fillStyle = 'rgba(96, 165, 250, 0.6)';
            histogram.forEach((count, i) => {
                const barWidth = (count / maxCount) * (w - 40);
                const y = (i / bins) * h;
                const barHeight = h / bins - 2;
                densityCtx.fillRect(30, y + 1, barWidth, barHeight);
            });

            // Theoretical curve (exponential)
            if (params.gravity > 0) {
                const scaleHeight = (params.temp / params.mass) / params.gravity * 5;
                densityCtx.strokeStyle = '#f97316';
                densityCtx.lineWidth = 2;
                densityCtx.beginPath();
                for (let i = 0; i <= bins; i++) {
                    const y = (i / bins) * h;
                    const simY = (i / bins) * simH;
                    const density = Math.exp(-(simH - simY) / scaleHeight);
                    const x = 30 + density * (w - 40);
                    if (i === 0) densityCtx.moveTo(x, y);
                    else densityCtx.lineTo(x, y);
                }
                densityCtx.stroke();
            }

            // Axis labels
            densityCtx.fillStyle = '#666';
            densityCtx.font = '9px sans-serif';
            densityCtx.fillText('Top', 5, 12);
            densityCtx.fillText('Bottom', 5, h - 5);
            densityCtx.fillText('Density →', w - 50, h - 5);
        }

        function drawPressureChart() {
            const w = pressureCanvas.width, h = pressureCanvas.height;
            pressureCtx.fillStyle = 'rgba(0,0,0,0.3)';
            pressureCtx.fillRect(0, 0, w, h);

            // Build pressure profile (cumulative from bottom)
            const bins = 20;
            const simH = simCanvas.height;
            const histogram = new Array(bins).fill(0);

            particles.forEach(p => {
                const bin = Math.floor((p.y / simH) * bins);
                if (bin >= 0 && bin < bins) histogram[bin]++;
            });

            // Cumulative from bottom
            const cumulative = [];
            let sum = 0;
            for (let i = bins - 1; i >= 0; i--) {
                sum += histogram[i];
                cumulative[i] = sum;
            }
            const maxPressure = cumulative[bins - 1];

            // Draw pressure profile
            pressureCtx.strokeStyle = '#22c55e';
            pressureCtx.lineWidth = 2;
            pressureCtx.beginPath();
            cumulative.forEach((p, i) => {
                const y = (i / bins) * h;
                const x = 30 + (p / maxPressure) * (w - 40);
                if (i === 0) pressureCtx.moveTo(x, y);
                else pressureCtx.lineTo(x, y);
            });
            pressureCtx.stroke();

            // Fill area
            pressureCtx.fillStyle = 'rgba(34, 197, 94, 0.2)';
            pressureCtx.lineTo(30, h);
            pressureCtx.lineTo(30, 0);
            pressureCtx.closePath();
            pressureCtx.fill();

            // Theoretical exponential
            if (params.gravity > 0) {
                const scaleHeight = (params.temp / params.mass) / params.gravity * 5;
                pressureCtx.strokeStyle = '#f97316';
                pressureCtx.lineWidth = 1;
                pressureCtx.setLineDash([5, 5]);
                pressureCtx.beginPath();
                for (let i = 0; i <= bins; i++) {
                    const y = (i / bins) * h;
                    const simY = (i / bins) * simH;
                    const pressure = Math.exp(-(simH - simY) / scaleHeight);
                    const x = 30 + pressure * (w - 40);
                    if (i === 0) pressureCtx.moveTo(x, y);
                    else pressureCtx.lineTo(x, y);
                }
                pressureCtx.stroke();
                pressureCtx.setLineDash([]);
            }

            // Axis labels
            pressureCtx.fillStyle = '#666';
            pressureCtx.font = '9px sans-serif';
            pressureCtx.fillText('Top', 5, 12);
            pressureCtx.fillText('Bottom', 5, h - 5);
            pressureCtx.fillText('Pressure →', w - 55, h - 5);
        }

        function animate() {
            if (running) update();
            draw();
            requestAnimationFrame(animate);
        }

        init();
    </script>
</body>
</html>
