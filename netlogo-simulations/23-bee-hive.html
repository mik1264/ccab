<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bee Hive - Division of Labor - CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a0a; color: #e8e6e1; overflow: hidden; }
        #container { display: flex; height: 100vh; }
        #canvas-container { flex: 1; position: relative; display: flex; flex-direction: column; }
        #sim-canvas { flex: 1; }
        #graph-canvas { height: 120px; border-top: 1px solid #333; }
        canvas { display: block; width: 100%; height: 100%; }
        #controls { width: 280px; background: rgba(0,0,0,0.9); padding: 20px; overflow-y: auto; }
        h1 { font-size: 1.1rem; margin-bottom: 15px; color: #fbbf24; }
        .control-group { margin-bottom: 12px; }
        label { display: block; font-size: 0.75rem; margin-bottom: 3px; color: #aaa; }
        input[type="range"] { width: 100%; }
        button { width: 100%; padding: 8px; margin-bottom: 8px; background: #f59e0b; color: #1a1a0a; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: #d97706; }
        .stats { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; font-size: 0.7rem; margin-bottom: 15px; }
        .back-link { position: fixed; top: 10px; left: 10px; padding: 8px 16px; background: rgba(0,0,0,0.7); color: #fbbf24; text-decoration: none; border-radius: 6px; font-size: 14px; z-index: 999; }
        .description { font-size: 0.7rem; color: #888; margin-bottom: 12px; line-height: 1.4; }
        .legend { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; font-size: 0.65rem; }
        .legend-item { display: flex; align-items: center; gap: 4px; }
        .legend-color { width: 10px; height: 10px; border-radius: 50%; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back</a>
    <div id="container">
        <div id="canvas-container">
            <canvas id="sim-canvas"></canvas>
            <canvas id="graph-canvas"></canvas>
        </div>
        <div id="controls">
            <h1>Bee Hive Colony</h1>
            <p class="description">Division of labor in a honeybee colony. Bees transition through roles based on age and colony needs. Foragers perform waggle dances to communicate food locations.</p>
            
            <div class="legend">
                <div class="legend-item"><div class="legend-color" style="background: #fef3c7;"></div>Nurse</div>
                <div class="legend-item"><div class="legend-color" style="background: #fbbf24;"></div>Builder</div>
                <div class="legend-item"><div class="legend-color" style="background: #f59e0b;"></div>Guard</div>
                <div class="legend-item"><div class="legend-color" style="background: #22c55e;"></div>Forager</div>
            </div>
            
            <div class="control-group">
                <label>Colony Size: <span id="beesVal">80</span></label>
                <input type="range" id="bees" min="20" max="200" value="80">
            </div>
            <div class="control-group">
                <label>Food Sources: <span id="foodsVal">3</span></label>
                <input type="range" id="foods" min="1" max="8" value="3">
            </div>
            <div class="control-group">
                <label>Role Flexibility: <span id="flexVal">0.5</span></label>
                <input type="range" id="flex" min="0.1" max="1" step="0.1" value="0.5">
            </div>
            
            <button id="reset">Reset Colony</button>
            <button id="pause">Pause</button>
            <button id="removeFood">Remove Food Source</button>
            
            <div class="stats">
                <div>Nurses: <span id="nurses">0</span></div>
                <div>Builders: <span id="builders">0</span></div>
                <div>Guards: <span id="guards">0</span></div>
                <div>Foragers: <span id="foragers">0</span></div>
                <div>Honey Stored: <span id="honey">0</span></div>
                <div>Larvae: <span id="larvae">0</span></div>
            </div>
            
            <p class="description"><strong>Waggle Dance:</strong> Foragers returning with food dance to communicate direction and distance. Other foragers follow to find food sources.</p>
        </div>
    </div>
    <script>
        const simCanvas = document.getElementById('sim-canvas');
        const simCtx = simCanvas.getContext('2d');
        const graphCanvas = document.getElementById('graph-canvas');
        const graphCtx = graphCanvas.getContext('2d');
        
        let W, H, bees = [], foods = [], hive, paused = false, tick = 0;
        let honey = 100, larvae = 10;
        let history = { nurses: [], builders: [], guards: [], foragers: [] };
        
        const ROLES = { NURSE: 0, BUILDER: 1, GUARD: 2, FORAGER: 3 };
        const ROLE_COLORS = ['#fef3c7', '#fbbf24', '#f59e0b', '#22c55e'];
        
        let params = {
            beeCount: 80,
            foodCount: 3,
            flexibility: 0.5
        };
        
        function resize() {
            const c = document.getElementById('canvas-container');
            simCanvas.width = c.clientWidth;
            simCanvas.height = c.clientHeight - 120;
            graphCanvas.width = c.clientWidth;
            graphCanvas.height = 120;
            W = simCanvas.width;
            H = simCanvas.height;
        }
        
        function init() {
            resize();
            tick = 0;
            honey = 100;
            larvae = 10;
            history = { nurses: [], builders: [], guards: [], foragers: [] };
            
            // Hive at center
            hive = { x: W / 2, y: H / 2, radius: 80 };
            
            // Food sources
            foods = [];
            for (let i = 0; i < params.foodCount; i++) {
                const angle = (i / params.foodCount) * Math.PI * 2;
                const dist = 150 + Math.random() * 100;
                foods.push({
                    x: hive.x + Math.cos(angle) * dist,
                    y: hive.y + Math.sin(angle) * dist,
                    amount: 100 + Math.random() * 100,
                    quality: 0.5 + Math.random() * 0.5
                });
            }
            
            // Create bees
            bees = [];
            for (let i = 0; i < params.beeCount; i++) {
                const age = Math.floor(Math.random() * 40);
                bees.push(createBee(age));
            }
            
            updateStats();
        }
        
        function createBee(age = 0) {
            // Role based on age (roughly)
            let role;
            if (age < 10) role = ROLES.NURSE;
            else if (age < 20) role = ROLES.BUILDER;
            else if (age < 25) role = ROLES.GUARD;
            else role = ROLES.FORAGER;
            
            const angle = Math.random() * Math.PI * 2;
            const dist = Math.random() * hive.radius * 0.8;
            
            return {
                x: hive.x + Math.cos(angle) * dist,
                y: hive.y + Math.sin(angle) * dist,
                angle: Math.random() * Math.PI * 2,
                role: role,
                age: age,
                hasFood: false,
                dancing: false,
                danceTarget: null,
                speed: 1.5
            };
        }
        
        function step() {
            tick++;
            
            // Age bees and potentially change roles
            if (tick % 60 === 0) {
                for (const bee of bees) {
                    bee.age++;
                    
                    // Role transition based on age and colony needs
                    const counts = getRoleCounts();
                    const needNurses = larvae > counts[ROLES.NURSE] * 2;
                    const needForagers = honey < 50 && foods.length > 0;
                    
                    if (Math.random() < params.flexibility * 0.1) {
                        if (needNurses && bee.role !== ROLES.NURSE && bee.age < 15) {
                            bee.role = ROLES.NURSE;
                        } else if (needForagers && bee.role !== ROLES.FORAGER && bee.age > 20) {
                            bee.role = ROLES.FORAGER;
                        }
                    }
                }
                
                // New larvae if enough nurses
                const nurses = bees.filter(b => b.role === ROLES.NURSE).length;
                if (nurses > 5 && honey > 20 && Math.random() < 0.3) {
                    larvae++;
                    honey -= 5;
                }
                
                // Larvae become bees
                if (larvae > 0 && Math.random() < 0.2) {
                    larvae--;
                    bees.push(createBee(0));
                }
            }
            
            // Update each bee
            for (const bee of bees) {
                updateBee(bee);
            }
            
            // Consume honey for colony maintenance
            if (tick % 100 === 0) {
                honey = Math.max(0, honey - bees.length * 0.1);
            }
            
            updateStats();
        }
        
        function updateBee(bee) {
            const inHive = Math.sqrt(Math.pow(bee.x - hive.x, 2) + Math.pow(bee.y - hive.y, 2)) < hive.radius;
            
            switch (bee.role) {
                case ROLES.NURSE:
                    // Stay in hive, move randomly
                    if (!inHive) {
                        const dx = hive.x - bee.x;
                        const dy = hive.y - bee.y;
                        bee.angle = Math.atan2(dy, dx);
                    } else {
                        bee.angle += (Math.random() - 0.5) * 0.5;
                    }
                    break;
                    
                case ROLES.BUILDER:
                    // Move around hive perimeter
                    if (inHive) {
                        const dx = bee.x - hive.x;
                        const dy = bee.y - hive.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        if (dist < hive.radius * 0.6) {
                            bee.angle = Math.atan2(dy, dx);
                        } else {
                            bee.angle += 0.05;
                        }
                    }
                    break;
                    
                case ROLES.GUARD:
                    // Patrol near entrance
                    const entranceX = hive.x + hive.radius * 0.9;
                    const entranceY = hive.y;
                    const toEntrance = Math.sqrt(Math.pow(bee.x - entranceX, 2) + Math.pow(bee.y - entranceY, 2));
                    if (toEntrance > 30) {
                        bee.angle = Math.atan2(entranceY - bee.y, entranceX - bee.x);
                    } else {
                        bee.angle += (Math.random() - 0.5) * 0.8;
                    }
                    break;
                    
                case ROLES.FORAGER:
                    if (bee.hasFood) {
                        // Return to hive
                        const dx = hive.x - bee.x;
                        const dy = hive.y - bee.y;
                        bee.angle = Math.atan2(dy, dx) + (Math.random() - 0.5) * 0.2;
                        
                        if (inHive) {
                            bee.hasFood = false;
                            honey += 2;
                            bee.dancing = true;
                            bee.danceTarget = bee.lastFood;
                            setTimeout(() => { bee.dancing = false; }, 2000);
                        }
                    } else if (bee.dancing) {
                        // Waggle dance
                        bee.angle += 0.3;
                    } else {
                        // Search for food or follow dancer
                        let targetFood = null;
                        
                        // Check for dancing bees
                        for (const other of bees) {
                            if (other.dancing && other.danceTarget && Math.random() < 0.1) {
                                targetFood = other.danceTarget;
                                break;
                            }
                        }
                        
                        if (targetFood) {
                            const dx = targetFood.x - bee.x;
                            const dy = targetFood.y - bee.y;
                            bee.angle = Math.atan2(dy, dx) + (Math.random() - 0.5) * 0.3;
                        } else {
                            bee.angle += (Math.random() - 0.5) * 0.5;
                        }
                        
                        // Check if at food
                        for (const food of foods) {
                            const dist = Math.sqrt(Math.pow(bee.x - food.x, 2) + Math.pow(bee.y - food.y, 2));
                            if (dist < 20 && food.amount > 0) {
                                bee.hasFood = true;
                                bee.lastFood = food;
                                food.amount -= 1;
                                bee.angle += Math.PI;
                                break;
                            }
                        }
                    }
                    break;
            }
            
            // Move
            bee.x += Math.cos(bee.angle) * bee.speed;
            bee.y += Math.sin(bee.angle) * bee.speed;
            
            // Bounds
            bee.x = Math.max(20, Math.min(W - 20, bee.x));
            bee.y = Math.max(20, Math.min(H - 20, bee.y));
        }
        
        function getRoleCounts() {
            const counts = [0, 0, 0, 0];
            for (const bee of bees) counts[bee.role]++;
            return counts;
        }
        
        function updateStats() {
            const counts = getRoleCounts();
            document.getElementById('nurses').textContent = counts[0];
            document.getElementById('builders').textContent = counts[1];
            document.getElementById('guards').textContent = counts[2];
            document.getElementById('foragers').textContent = counts[3];
            document.getElementById('honey').textContent = Math.floor(honey);
            document.getElementById('larvae').textContent = larvae;
            
            // Record history
            history.nurses.push(counts[0]);
            history.builders.push(counts[1]);
            history.guards.push(counts[2]);
            history.foragers.push(counts[3]);
            const maxHist = 200;
            if (history.nurses.length > maxHist) {
                history.nurses.shift();
                history.builders.shift();
                history.guards.shift();
                history.foragers.shift();
            }
        }
        
        function draw() {
            // Main canvas
            simCtx.fillStyle = '#1a1a0a';
            simCtx.fillRect(0, 0, W, H);
            
            // Draw hive
            simCtx.fillStyle = '#78350f';
            simCtx.beginPath();
            simCtx.arc(hive.x, hive.y, hive.radius, 0, Math.PI * 2);
            simCtx.fill();
            simCtx.strokeStyle = '#92400e';
            simCtx.lineWidth = 3;
            simCtx.stroke();
            
            // Honeycomb pattern
            simCtx.strokeStyle = '#a16207';
            simCtx.lineWidth = 1;
            for (let i = 0; i < 20; i++) {
                const angle = (i / 20) * Math.PI * 2;
                for (let r = 20; r < hive.radius; r += 25) {
                    const x = hive.x + Math.cos(angle) * r;
                    const y = hive.y + Math.sin(angle) * r;
                    simCtx.beginPath();
                    simCtx.arc(x, y, 8, 0, Math.PI * 2);
                    simCtx.stroke();
                }
            }
            
            // Draw food sources
            for (const food of foods) {
                const alpha = Math.min(1, food.amount / 50);
                simCtx.fillStyle = `rgba(34, 197, 94, ${alpha})`;
                simCtx.beginPath();
                simCtx.arc(food.x, food.y, 15, 0, Math.PI * 2);
                simCtx.fill();
                simCtx.fillStyle = '#fff';
                simCtx.font = '10px sans-serif';
                simCtx.fillText(Math.floor(food.amount), food.x - 8, food.y + 3);
            }
            
            // Draw bees
            for (const bee of bees) {
                simCtx.fillStyle = ROLE_COLORS[bee.role];
                simCtx.save();
                simCtx.translate(bee.x, bee.y);
                simCtx.rotate(bee.angle);
                
                // Body
                simCtx.beginPath();
                simCtx.ellipse(0, 0, 5, 3, 0, 0, Math.PI * 2);
                simCtx.fill();
                
                // Stripes
                simCtx.strokeStyle = '#000';
                simCtx.lineWidth = 1;
                simCtx.beginPath();
                simCtx.moveTo(-2, -3);
                simCtx.lineTo(-2, 3);
                simCtx.moveTo(1, -3);
                simCtx.lineTo(1, 3);
                simCtx.stroke();
                
                // Wings if flying
                if (bee.role === ROLES.FORAGER) {
                    simCtx.fillStyle = 'rgba(255,255,255,0.3)';
                    simCtx.beginPath();
                    simCtx.ellipse(-2, -4, 3, 2, 0.3, 0, Math.PI * 2);
                    simCtx.ellipse(-2, 4, 3, 2, -0.3, 0, Math.PI * 2);
                    simCtx.fill();
                }
                
                // Dancing indicator
                if (bee.dancing) {
                    simCtx.strokeStyle = '#facc15';
                    simCtx.lineWidth = 2;
                    simCtx.beginPath();
                    simCtx.arc(0, 0, 10, 0, Math.PI * 2);
                    simCtx.stroke();
                }
                
                simCtx.restore();
            }
            
            // Graph
            graphCtx.fillStyle = '#0a0a05';
            graphCtx.fillRect(0, 0, graphCanvas.width, graphCanvas.height);
            
            const drawLine = (data, color) => {
                if (data.length < 2) return;
                const max = Math.max(...history.nurses, ...history.builders, ...history.guards, ...history.foragers, 20);
                graphCtx.strokeStyle = color;
                graphCtx.lineWidth = 1.5;
                graphCtx.beginPath();
                for (let i = 0; i < data.length; i++) {
                    const x = (i / 200) * graphCanvas.width;
                    const y = graphCanvas.height - 10 - (data[i] / max) * (graphCanvas.height - 20);
                    if (i === 0) graphCtx.moveTo(x, y);
                    else graphCtx.lineTo(x, y);
                }
                graphCtx.stroke();
            };
            
            drawLine(history.nurses, ROLE_COLORS[0]);
            drawLine(history.builders, ROLE_COLORS[1]);
            drawLine(history.guards, ROLE_COLORS[2]);
            drawLine(history.foragers, ROLE_COLORS[3]);
            
            graphCtx.fillStyle = '#666';
            graphCtx.font = '10px sans-serif';
            graphCtx.fillText('Role Distribution Over Time', 5, 12);
            
            requestAnimationFrame(draw);
        }
        
        let intervalId = null;
        function startSim() {
            if (intervalId) clearInterval(intervalId);
            intervalId = setInterval(() => { if (!paused) step(); }, 50);
        }
        
        document.getElementById('bees').addEventListener('input', e => {
            params.beeCount = +e.target.value;
            document.getElementById('beesVal').textContent = params.beeCount;
        });
        document.getElementById('foods').addEventListener('input', e => {
            params.foodCount = +e.target.value;
            document.getElementById('foodsVal').textContent = params.foodCount;
        });
        document.getElementById('flex').addEventListener('input', e => {
            params.flexibility = +e.target.value;
            document.getElementById('flexVal').textContent = params.flexibility;
        });
        document.getElementById('reset').addEventListener('click', () => { init(); startSim(); });
        document.getElementById('pause').addEventListener('click', () => {
            paused = !paused;
            document.getElementById('pause').textContent = paused ? 'Resume' : 'Pause';
        });
        document.getElementById('removeFood').addEventListener('click', () => {
            if (foods.length > 0) foods.pop();
        });
        
        window.addEventListener('resize', resize);
        init();
        draw();
        startSim();
    </script>
</body>
</html>
