<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bird Breeders - Artificial Selection - CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1e293b; color: #e8e6e1; overflow: hidden; }
        #container { display: flex; height: 100vh; }
        #canvas-container { flex: 1; position: relative; display: flex; flex-direction: column; }
        #birdCanvas { flex: 2; }
        #graphCanvas { flex: 1; border-top: 1px solid #333; }
        #controls { width: 280px; background: rgba(0,0,0,0.9); padding: 20px; overflow-y: auto; }
        h1 { font-size: 1.1rem; margin-bottom: 15px; color: #f59e0b; }
        .control-group { margin-bottom: 12px; }
        label { display: block; font-size: 0.75rem; margin-bottom: 3px; color: #aaa; }
        input[type="range"] { width: 100%; }
        button { width: 100%; padding: 8px; margin-bottom: 8px; background: #d97706; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 0.85rem; }
        button:hover { background: #b45309; }
        .stats { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; font-size: 0.75rem; margin-bottom: 15px; }
        .stats div { margin-bottom: 3px; }
        .back-link { position: fixed; top: 10px; left: 10px; padding: 8px 16px; background: rgba(0,0,0,0.7); color: #f59e0b; text-decoration: none; border-radius: 6px; font-size: 14px; z-index: 999; }
        .description { font-size: 0.7rem; color: #888; margin-bottom: 12px; line-height: 1.4; }
        .trait-btn { width: 48%; display: inline-block; margin-bottom: 5px; font-size: 0.75rem; padding: 6px; }
        .trait-btn.active { background: #92400e; }

        .explain-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            margin-top: 10px;
        }
        .explain-btn:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        }
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
        }
        .modal {
            background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%);
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: #888;
            font-size: 28px;
            cursor: pointer;
            width: auto;
            padding: 0;
            margin: 0;
        }
        .modal-close:hover {
            color: #fff;
            background: none;
        }
        .modal h2 {
            color: #fbbf24;
            margin-bottom: 20px;
            font-size: 1.5rem;
            padding-right: 30px;
        }
        .modal-body {
            color: #ccc;
            line-height: 1.8;
            font-size: 0.95rem;
        }
        .modal-body h3 {
            color: #a5b4fc;
            margin: 20px 0 10px 0;
            font-size: 1.1rem;
        }
        .modal-body p {
            margin-bottom: 15px;
        }
        .modal-body ul {
            margin: 10px 0 15px 20px;
        }
        .modal-body li {
            margin-bottom: 8px;
        }
        .modal-body strong {
            color: #fbbf24;
        }
        .modal-body em {
            color: #a5b4fc;
            font-style: normal;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back</a>
    <div id="container">
        <div id="canvas-container">
            <canvas id="birdCanvas"></canvas>
            <canvas id="graphCanvas"></canvas>
        </div>
        <div id="controls">
            <h1>Bird Breeders</h1>
            <p class="description">Selective breeding simulation. Choose birds with desired traits to breed. Watch allele frequencies change across generations.</p>
            
            <div class="control-group">
                <label>Population Size: <span id="popVal">30</span></label>
                <input type="range" id="pop" min="10" max="60" value="30">
            </div>
            <div class="control-group">
                <label>Mutation Rate: <span id="mutVal">0.02</span></label>
                <input type="range" id="mut" min="0" max="0.1" step="0.01" value="0.02">
            </div>
            
            <p class="description" style="margin-top:10px;"><strong>Select for trait:</strong></p>
            <button class="trait-btn active" id="selRed">Red Plumage</button>
            <button class="trait-btn" id="selBlue">Blue Plumage</button>
            <button class="trait-btn" id="selLarge">Large Size</button>
            <button class="trait-btn" id="selSmall">Small Size</button>
            
            <button id="breed">Breed Selected</button>
            <button id="random">Random Mating</button>
            <button id="reset">Reset Population</button>
            <button id="explainBtn" class="explain-btn">üìö Explain</button>
            
            <div class="stats">
                <div>Generation: <span id="gen">0</span></div>
                <div>Population: <span id="count">0</span></div>
                <div>Avg Red Allele: <span id="redAllele">0.5</span></div>
                <div>Avg Size Gene: <span id="sizeGene">0.5</span></div>
                <div>Selected: <span id="selected">0</span></div>
            </div>
            
            <p class="description"><strong>Genetics:</strong> Each bird has genes for color (red/blue) and size. Traits are polygenic with continuous variation.</p>
            
            <p class="description"><strong>Click birds</strong> to select/deselect for breeding. "Breed Selected" creates next generation from selected parents.</p>
        </div>
    </div>
    <div id="explainModal" class="modal-overlay">
        <div class="modal">
            <button class="modal-close">&times;</button>
            <h2>üìö Bird Breeders - Artificial Selection</h2>
            <div class="modal-body">
                <p>This simulation demonstrates key concepts in complex systems and agent-based modeling.</p>

                <h3>How It Works</h3>
                <p>Agents follow simple local rules that lead to emergent global behavior.</p>

                <h3>Key Concepts</h3>
                <ul>
                    <li><strong>Emergence:</strong> Complex patterns arise from simple rules</li>
                    <li><strong>Self-organization:</strong> Order without central control</li>
                    <li><strong>Feedback loops:</strong> Actions influence future states</li>
                </ul>

                <h3>Try This</h3>
                <ul>
                    <li>Adjust parameters to see different behaviors</li>
                    <li>Watch for patterns that emerge over time</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        const birdCanvas = document.getElementById('birdCanvas');
        const graphCanvas = document.getElementById('graphCanvas');
        const bctx = birdCanvas.getContext('2d');
        const gctx = graphCanvas.getContext('2d');
        
        let W, H, GW, GH, birds = [], generation = 0;
        let selectedTrait = 'red';
        let history = { red: [], size: [] };
        
        let params = {
            popSize: 30,
            mutationRate: 0.02
        };
        
        function resize() {
            const c = document.getElementById('canvas-container');
            birdCanvas.width = c.clientWidth;
            birdCanvas.height = c.clientHeight * 0.6;
            graphCanvas.width = c.clientWidth;
            graphCanvas.height = c.clientHeight * 0.4;
            W = birdCanvas.width;
            H = birdCanvas.height;
            GW = graphCanvas.width;
            GH = graphCanvas.height;
        }
        
        class Bird {
            constructor(redGene = null, sizeGene = null) {
                // Genes: 0-1 continuous values
                this.redGene = redGene ?? Math.random();
                this.sizeGene = sizeGene ?? Math.random();
                
                // Position for display
                this.x = 50 + Math.random() * (W - 100);
                this.y = 50 + Math.random() * (H - 100);
                this.vx = (Math.random() - 0.5) * 2;
                this.vy = (Math.random() - 0.5) * 2;
                
                this.selected = false;
            }
            
            get color() {
                // Red gene determines red vs blue
                const r = Math.floor(this.redGene * 200 + 55);
                const b = Math.floor((1 - this.redGene) * 200 + 55);
                const g = 50;
                return `rgb(${r}, ${g}, ${b})`;
            }
            
            get size() {
                return 10 + this.sizeGene * 20;
            }
            
            update() {
                this.x += this.vx;
                this.y += this.vy;
                
                this.vx += (Math.random() - 0.5) * 0.3;
                this.vy += (Math.random() - 0.5) * 0.3;
                
                // Speed limit
                const speed = Math.sqrt(this.vx ** 2 + this.vy ** 2);
                if (speed > 2) {
                    this.vx *= 2 / speed;
                    this.vy *= 2 / speed;
                }
                
                // Boundaries
                if (this.x < 30) { this.x = 30; this.vx *= -1; }
                if (this.x > W - 30) { this.x = W - 30; this.vx *= -1; }
                if (this.y < 30) { this.y = 30; this.vy *= -1; }
                if (this.y > H - 30) { this.y = H - 30; this.vy *= -1; }
            }
            
            draw() {
                const size = this.size;
                
                // Selection ring
                if (this.selected) {
                    bctx.strokeStyle = '#fbbf24';
                    bctx.lineWidth = 3;
                    bctx.beginPath();
                    bctx.arc(this.x, this.y, size + 5, 0, Math.PI * 2);
                    bctx.stroke();
                }
                
                // Body
                bctx.fillStyle = this.color;
                bctx.beginPath();
                bctx.ellipse(this.x, this.y, size, size * 0.7, 0, 0, Math.PI * 2);
                bctx.fill();
                
                // Head
                bctx.beginPath();
                bctx.arc(this.x + size * 0.7, this.y - size * 0.2, size * 0.4, 0, Math.PI * 2);
                bctx.fill();
                
                // Beak
                bctx.fillStyle = '#fbbf24';
                bctx.beginPath();
                bctx.moveTo(this.x + size, this.y - size * 0.2);
                bctx.lineTo(this.x + size * 1.4, this.y - size * 0.1);
                bctx.lineTo(this.x + size, this.y);
                bctx.fill();
                
                // Eye
                bctx.fillStyle = '#000';
                bctx.beginPath();
                bctx.arc(this.x + size * 0.8, this.y - size * 0.3, 2, 0, Math.PI * 2);
                bctx.fill();
                
                // Tail
                bctx.fillStyle = this.color;
                bctx.beginPath();
                bctx.moveTo(this.x - size, this.y);
                bctx.lineTo(this.x - size * 1.5, this.y - size * 0.3);
                bctx.lineTo(this.x - size * 1.5, this.y + size * 0.3);
                bctx.fill();
            }
        }
        
        function init() {
            resize();
            generation = 0;
            history = { red: [], size: [] };
            birds = [];
            
            for (let i = 0; i < params.popSize; i++) {
                birds.push(new Bird());
            }
            
            recordHistory();
            updateStats();
        }
        
        function mutate(gene) {
            if (Math.random() < params.mutationRate) {
                gene += (Math.random() - 0.5) * 0.2;
            }
            return Math.max(0, Math.min(1, gene));
        }
        
        function breed(parent1, parent2) {
            // Crossover + mutation
            const redGene = mutate((parent1.redGene + parent2.redGene) / 2 + (Math.random() - 0.5) * 0.1);
            const sizeGene = mutate((parent1.sizeGene + parent2.sizeGene) / 2 + (Math.random() - 0.5) * 0.1);
            
            return new Bird(redGene, sizeGene);
        }
        
        function breedSelected() {
            const selected = birds.filter(b => b.selected);
            if (selected.length < 2) {
                alert('Select at least 2 birds to breed!');
                return;
            }
            
            generation++;
            const newBirds = [];
            
            // Create new generation from selected parents
            while (newBirds.length < params.popSize) {
                const p1 = selected[Math.floor(Math.random() * selected.length)];
                const p2 = selected[Math.floor(Math.random() * selected.length)];
                newBirds.push(breed(p1, p2));
            }
            
            birds = newBirds;
            recordHistory();
            updateStats();
        }
        
        function randomMating() {
            generation++;
            const newBirds = [];
            
            while (newBirds.length < params.popSize) {
                const p1 = birds[Math.floor(Math.random() * birds.length)];
                const p2 = birds[Math.floor(Math.random() * birds.length)];
                newBirds.push(breed(p1, p2));
            }
            
            birds = newBirds;
            recordHistory();
            updateStats();
        }
        
        function autoSelect() {
            // Select birds based on current trait preference
            for (const bird of birds) {
                bird.selected = false;
            }
            
            const sorted = [...birds];
            if (selectedTrait === 'red') {
                sorted.sort((a, b) => b.redGene - a.redGene);
            } else if (selectedTrait === 'blue') {
                sorted.sort((a, b) => a.redGene - b.redGene);
            } else if (selectedTrait === 'large') {
                sorted.sort((a, b) => b.sizeGene - a.sizeGene);
            } else if (selectedTrait === 'small') {
                sorted.sort((a, b) => a.sizeGene - b.sizeGene);
            }
            
            // Select top 30%
            const selectCount = Math.max(2, Math.floor(birds.length * 0.3));
            for (let i = 0; i < selectCount; i++) {
                sorted[i].selected = true;
            }
            
            updateStats();
        }
        
        function recordHistory() {
            const avgRed = birds.reduce((s, b) => s + b.redGene, 0) / birds.length;
            const avgSize = birds.reduce((s, b) => s + b.sizeGene, 0) / birds.length;
            history.red.push(avgRed);
            history.size.push(avgSize);
            if (history.red.length > 50) {
                history.red.shift();
                history.size.shift();
            }
        }
        
        function updateStats() {
            const selected = birds.filter(b => b.selected).length;
            const avgRed = birds.reduce((s, b) => s + b.redGene, 0) / birds.length;
            const avgSize = birds.reduce((s, b) => s + b.sizeGene, 0) / birds.length;
            
            document.getElementById('gen').textContent = generation;
            document.getElementById('count').textContent = birds.length;
            document.getElementById('redAllele').textContent = avgRed.toFixed(3);
            document.getElementById('sizeGene').textContent = avgSize.toFixed(3);
            document.getElementById('selected').textContent = selected;
        }
        
        function drawBirds() {
            bctx.fillStyle = '#1e293b';
            bctx.fillRect(0, 0, W, H);
            
            // Update and draw birds
            for (const bird of birds) {
                bird.update();
                bird.draw();
            }
            
            // Generation label
            bctx.fillStyle = '#666';
            bctx.font = '14px sans-serif';
            bctx.fillText(`Generation ${generation}`, 10, 25);
        }
        
        function drawGraph() {
            gctx.fillStyle = '#0f172a';
            gctx.fillRect(0, 0, GW, GH);
            
            if (history.red.length < 2) return;
            
            const margin = 40;
            const graphW = GW - 2 * margin;
            const graphH = GH - 2 * margin;
            
            // Axes
            gctx.strokeStyle = '#333';
            gctx.lineWidth = 1;
            gctx.beginPath();
            gctx.moveTo(margin, margin);
            gctx.lineTo(margin, GH - margin);
            gctx.lineTo(GW - margin, GH - margin);
            gctx.stroke();
            
            // Labels
            gctx.fillStyle = '#666';
            gctx.font = '11px sans-serif';
            gctx.fillText('Allele Frequency', margin, margin - 10);
            gctx.fillText('Generation', GW - margin - 40, GH - margin + 20);
            
            const n = history.red.length;
            
            // Draw red allele line
            gctx.strokeStyle = '#ef4444';
            gctx.lineWidth = 2;
            gctx.beginPath();
            for (let i = 0; i < n; i++) {
                const x = margin + (i / (n - 1)) * graphW;
                const y = GH - margin - history.red[i] * graphH;
                if (i === 0) gctx.moveTo(x, y);
                else gctx.lineTo(x, y);
            }
            gctx.stroke();
            
            // Draw size gene line
            gctx.strokeStyle = '#22c55e';
            gctx.lineWidth = 2;
            gctx.beginPath();
            for (let i = 0; i < n; i++) {
                const x = margin + (i / (n - 1)) * graphW;
                const y = GH - margin - history.size[i] * graphH;
                if (i === 0) gctx.moveTo(x, y);
                else gctx.lineTo(x, y);
            }
            gctx.stroke();
            
            // Legend
            gctx.fillStyle = '#ef4444';
            gctx.fillText('Red Gene', GW - margin - 100, margin + 15);
            gctx.fillStyle = '#22c55e';
            gctx.fillText('Size Gene', GW - margin - 100, margin + 30);
        }
        
        function draw() {
            drawBirds();
            drawGraph();
            requestAnimationFrame(draw);
        }
        
        // Click to select birds
        birdCanvas.addEventListener('click', e => {
            const rect = birdCanvas.getBoundingClientRect();
            const mx = e.clientX - rect.left;
            const my = e.clientY - rect.top;
            
            for (const bird of birds) {
                const dist = Math.sqrt((bird.x - mx) ** 2 + (bird.y - my) ** 2);
                if (dist < bird.size + 5) {
                    bird.selected = !bird.selected;
                    updateStats();
                    break;
                }
            }
        });
        
        // Event listeners
        document.getElementById('pop').addEventListener('input', e => {
            params.popSize = +e.target.value;
            document.getElementById('popVal').textContent = params.popSize;
        });
        document.getElementById('mut').addEventListener('input', e => {
            params.mutationRate = +e.target.value;
            document.getElementById('mutVal').textContent = params.mutationRate.toFixed(2);
        });
        
        document.getElementById('breed').addEventListener('click', breedSelected);
        document.getElementById('random').addEventListener('click', randomMating);
        document.getElementById('reset').addEventListener('click', init);
        
        // Trait selection buttons
        const traitBtns = ['selRed', 'selBlue', 'selLarge', 'selSmall'];
        const traitNames = ['red', 'blue', 'large', 'small'];
        traitBtns.forEach((id, i) => {
            document.getElementById(id).addEventListener('click', () => {
                traitBtns.forEach(b => document.getElementById(b).classList.remove('active'));
                document.getElementById(id).classList.add('active');
                selectedTrait = traitNames[i];
                autoSelect();
            });
        });
        
        window.addEventListener('resize', resize);

        // Modal functionality
        const modal = document.getElementById('explainModal');
        document.getElementById('explainBtn').addEventListener('click', () => {
            modal.classList.add('active');
        });
        modal.querySelector('.modal-close').addEventListener('click', () => {
            modal.classList.remove('active');
        });
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.classList.remove('active');
        });
        init();
        autoSelect();
        draw();
    </script>
</body>
</html>
