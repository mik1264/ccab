<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connected Chemistry - NetLogo Simulations</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #e0e0e0;
        }
        h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #e74c3c, #f39c12);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .description {
            text-align: center;
            max-width: 700px;
            margin-bottom: 20px;
            color: #aaa;
            line-height: 1.5;
        }
        .container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .main-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        canvas {
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        }
        .controls {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-width: 220px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        label {
            font-size: 0.85rem;
            color: #888;
        }
        input[type="range"] {
            width: 100%;
            cursor: pointer;
        }
        .value { font-size: 0.8rem; color: #e74c3c; }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .primary { background: #e74c3c; color: white; }
        .primary:hover { background: #c0392b; }
        .secondary { background: rgba(255,255,255,0.1); color: #e0e0e0; }
        .secondary:hover { background: rgba(255,255,255,0.2); }
        .stats {
            margin-top: 15px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 5px;
            font-size: 0.85rem;
        }
        .stats div { margin: 3px 0; }
        .stat-value { color: #e74c3c; }
        a.back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #e74c3c;
            text-decoration: none;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        a.back-link:hover { opacity: 1; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back to Gallery</a>
    <h1>Connected Chemistry</h1>
    <p class="description">
        Molecules collide and bond to form polymers. Watch molecular weight distributions evolve
        as monomers link into chains through random collision bonding.
    </p>

    <div class="container">
        <div class="main-panel">
            <canvas id="canvas" width="550" height="400"></canvas>
            <canvas id="histogram" width="550" height="120"></canvas>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>Initial Monomers: <span id="monomerVal" class="value">100</span></label>
                <input type="range" id="monomerCount" min="50" max="200" value="100">
            </div>

            <div class="control-group">
                <label>Bond Probability: <span id="bondVal" class="value">30</span>%</label>
                <input type="range" id="bondProb" min="5" max="80" value="30">
            </div>

            <div class="control-group">
                <label>Temperature: <span id="tempVal" class="value">300</span> K</label>
                <input type="range" id="temperature" min="200" max="500" value="300">
            </div>

            <div class="control-group">
                <label>Max Chain Length: <span id="maxChainVal" class="value">20</span></label>
                <input type="range" id="maxChain" min="5" max="50" value="20">
            </div>

            <button class="primary" id="startBtn">Start</button>
            <button class="secondary" id="resetBtn">Reset</button>

            <div class="stats">
                <div>Molecules: <span id="molecules" class="stat-value">0</span></div>
                <div>Polymers (n≥2): <span id="polymers" class="stat-value">0</span></div>
                <div>Avg MW: <span id="avgMW" class="stat-value">0</span></div>
                <div>Max Chain: <span id="maxLength" class="stat-value">0</span></div>
                <div>Bonds Formed: <span id="bonds" class="stat-value">0</span></div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const histCanvas = document.getElementById('histogram');
        const histCtx = histCanvas.getContext('2d');
        const W = canvas.width, H = canvas.height;

        let molecules = [];
        let running = false;
        let bondsFormed = 0;

        class Molecule {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 4;
                this.vy = (Math.random() - 0.5) * 4;
                this.chain = [this]; // Polymer chain
                this.chainHead = this;
                this.radius = 6;
            }

            get chainLength() {
                return this.chainHead.chain.length;
            }

            move(temp) {
                const speed = temp / 300;
                this.vx += (Math.random() - 0.5) * speed;
                this.vy += (Math.random() - 0.5) * speed;

                const maxSpeed = 3 * speed;
                const currentSpeed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
                if (currentSpeed > maxSpeed) {
                    this.vx = (this.vx / currentSpeed) * maxSpeed;
                    this.vy = (this.vy / currentSpeed) * maxSpeed;
                }

                this.x += this.vx;
                this.y += this.vy;

                // Bounce off walls
                if (this.x < this.radius) { this.x = this.radius; this.vx *= -0.8; }
                if (this.x > W - this.radius) { this.x = W - this.radius; this.vx *= -0.8; }
                if (this.y < this.radius) { this.y = this.radius; this.vy *= -0.8; }
                if (this.y > H - this.radius) { this.y = H - this.radius; this.vy *= -0.8; }
            }
        }

        function init() {
            const count = parseInt(document.getElementById('monomerCount').value);
            molecules = [];
            bondsFormed = 0;

            for (let i = 0; i < count; i++) {
                molecules.push(new Molecule(
                    Math.random() * (W - 40) + 20,
                    Math.random() * (H - 40) + 20
                ));
            }
            updateStats();
        }

        function distance(a, b) {
            return Math.sqrt((a.x - b.x) ** 2 + (a.y - b.y) ** 2);
        }

        function canBond(m1, m2, maxChain) {
            // Can't bond if same chain
            if (m1.chainHead === m2.chainHead) return false;
            // Check max chain length
            if (m1.chainLength + m2.chainLength > maxChain) return false;
            // Must be end of chain
            const chain1 = m1.chainHead.chain;
            const chain2 = m2.chainHead.chain;
            const isEnd1 = m1 === chain1[0] || m1 === chain1[chain1.length - 1];
            const isEnd2 = m2 === chain2[0] || m2 === chain2[chain2.length - 1];
            return isEnd1 && isEnd2;
        }

        function bondMolecules(m1, m2) {
            const chain1 = m1.chainHead.chain;
            const chain2 = m2.chainHead.chain;

            // Determine which ends are bonding and merge
            let newChain;
            if (m1 === chain1[chain1.length - 1] && m2 === chain2[0]) {
                newChain = [...chain1, ...chain2];
            } else if (m1 === chain1[0] && m2 === chain2[chain2.length - 1]) {
                newChain = [...chain2, ...chain1];
            } else if (m1 === chain1[chain1.length - 1] && m2 === chain2[chain2.length - 1]) {
                newChain = [...chain1, ...chain2.reverse()];
            } else {
                newChain = [...chain1.reverse(), ...chain2];
            }

            // Update all molecules to point to new chain
            newChain.forEach(m => {
                m.chainHead = newChain[0];
                m.chainHead.chain = newChain;
            });

            bondsFormed++;
        }

        function update() {
            const temp = parseInt(document.getElementById('temperature').value);
            const bondProb = parseInt(document.getElementById('bondProb').value) / 100;
            const maxChain = parseInt(document.getElementById('maxChain').value);

            // Move molecules
            molecules.forEach(m => m.move(temp));

            // Check for collisions and bonding
            for (let i = 0; i < molecules.length; i++) {
                for (let j = i + 1; j < molecules.length; j++) {
                    const m1 = molecules[i];
                    const m2 = molecules[j];
                    const dist = distance(m1, m2);

                    if (dist < m1.radius + m2.radius + 5) {
                        // Collision - maybe bond
                        if (canBond(m1, m2, maxChain) && Math.random() < bondProb) {
                            bondMolecules(m1, m2);
                        }
                    }
                }
            }
        }

        function getChainColor(length) {
            if (length === 1) return '#3498db';
            if (length <= 3) return '#2ecc71';
            if (length <= 6) return '#f39c12';
            if (length <= 10) return '#e74c3c';
            return '#9b59b6';
        }

        function draw() {
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, W, H);

            // Draw bonds first
            const drawnChains = new Set();
            molecules.forEach(m => {
                const chain = m.chainHead.chain;
                if (drawnChains.has(m.chainHead)) return;
                drawnChains.add(m.chainHead);

                if (chain.length > 1) {
                    ctx.strokeStyle = getChainColor(chain.length);
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(chain[0].x, chain[0].y);
                    for (let i = 1; i < chain.length; i++) {
                        ctx.lineTo(chain[i].x, chain[i].y);
                    }
                    ctx.stroke();
                }
            });

            // Draw molecules
            molecules.forEach(m => {
                ctx.beginPath();
                ctx.arc(m.x, m.y, m.radius, 0, Math.PI * 2);
                ctx.fillStyle = getChainColor(m.chainLength);
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 1;
                ctx.stroke();
            });
        }

        function drawHistogram() {
            histCtx.fillStyle = '#1a1a2e';
            histCtx.fillRect(0, 0, histCanvas.width, histCanvas.height);

            // Count chain lengths
            const counts = {};
            const drawnChains = new Set();
            molecules.forEach(m => {
                if (drawnChains.has(m.chainHead)) return;
                drawnChains.add(m.chainHead);
                const len = m.chainLength;
                counts[len] = (counts[len] || 0) + 1;
            });

            const maxLen = Math.max(...Object.keys(counts).map(Number), 1);
            const maxCount = Math.max(...Object.values(counts), 1);
            const barWidth = Math.max(10, (histCanvas.width - 60) / maxLen);

            histCtx.fillStyle = '#888';
            histCtx.font = '10px sans-serif';
            histCtx.fillText('Molecular Weight Distribution', 10, 15);

            for (let len = 1; len <= maxLen; len++) {
                const count = counts[len] || 0;
                const barHeight = (count / maxCount) * (histCanvas.height - 40);
                const x = 30 + (len - 1) * barWidth;
                const y = histCanvas.height - 20 - barHeight;

                histCtx.fillStyle = getChainColor(len);
                histCtx.fillRect(x, y, barWidth - 2, barHeight);

                if (barWidth > 15) {
                    histCtx.fillStyle = '#888';
                    histCtx.font = '9px sans-serif';
                    histCtx.textAlign = 'center';
                    histCtx.fillText(len, x + barWidth / 2, histCanvas.height - 5);
                }
            }
        }

        function updateStats() {
            const chainHeads = new Set();
            molecules.forEach(m => chainHeads.add(m.chainHead));

            let totalMW = 0;
            let polymerCount = 0;
            let maxLength = 0;

            chainHeads.forEach(head => {
                const len = head.chain.length;
                totalMW += len;
                if (len > 1) polymerCount++;
                if (len > maxLength) maxLength = len;
            });

            const avgMW = chainHeads.size > 0 ? (totalMW / chainHeads.size).toFixed(1) : 0;

            document.getElementById('molecules').textContent = chainHeads.size;
            document.getElementById('polymers').textContent = polymerCount;
            document.getElementById('avgMW').textContent = avgMW;
            document.getElementById('maxLength').textContent = maxLength;
            document.getElementById('bonds').textContent = bondsFormed;

            document.getElementById('monomerVal').textContent = document.getElementById('monomerCount').value;
            document.getElementById('bondVal').textContent = document.getElementById('bondProb').value;
            document.getElementById('tempVal').textContent = document.getElementById('temperature').value;
            document.getElementById('maxChainVal').textContent = document.getElementById('maxChain').value;
        }

        function animate() {
            if (running) {
                update();
            }
            draw();
            drawHistogram();
            updateStats();
            requestAnimationFrame(animate);
        }

        document.getElementById('startBtn').addEventListener('click', function() {
            running = !running;
            this.textContent = running ? 'Pause' : 'Start';
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            running = false;
            document.getElementById('startBtn').textContent = 'Start';
            init();
        });

        ['monomerCount', 'bondProb', 'temperature', 'maxChain'].forEach(id => {
            document.getElementById(id).addEventListener('input', updateStats);
        });

        init();
        animate();
    </script>
</body>
</html>
