<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dice Stalagmite - CCAB</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            font-family: 'Segoe UI', Arial, sans-serif;
            color: white;
        }
        .container { display: flex; height: 100vh; }
        .canvas-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            gap: 10px;
        }
        canvas { border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 8px; }
        .controls {
            width: 320px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.6);
            overflow-y: auto;
        }
        h2 { margin: 0 0 15px 0; color: #dfe6e9; }
        h3 { margin: 15px 0 8px 0; color: #b2bec3; font-size: 14px; }
        .slider-group { margin: 12px 0; }
        .slider-group label { display: block; margin-bottom: 5px; font-size: 13px; }
        input[type="range"] { width: 100%; }
        .stats {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .stat-row { display: flex; justify-content: space-between; margin: 5px 0; font-size: 13px; }
        .description {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.5;
            margin-top: 15px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: #dfe6e9;
            color: #1a1a2e;
            font-weight: bold;
        }
        button:hover { background: #b2bec3; }
        .dice-display {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }
        .die {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: #1a1a2e;
        }
    </style>
</head>
<body>
    <a href="index.html" class="organic-back-link" style="position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; align-items: center; gap: 8px; padding: 10px 16px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-radius: 30px; text-decoration: none; color: #606C38; font-family: 'Nunito', sans-serif; font-weight: 600;">
        <span>‚Üê Gallery</span>
    </a>
    <div class="container">
        <div class="canvas-area">
            <canvas id="histogramCanvas"></canvas>
            <div class="dice-display">
                <div class="die" id="die1">?</div>
                <div class="die" id="die2">?</div>
                <span style="font-size: 24px; line-height: 40px;">= </span>
                <div class="die" id="sum" style="width: 50px; background: #ffeaa7;">?</div>
            </div>
        </div>
        <div class="controls">
            <h2>üé≤ Dice Stalagmite</h2>
            <p style="font-size: 12px; opacity: 0.8;">Probability distribution visualization</p>

            <h3>Number of Dice</h3>
            <div class="slider-group">
                <label>Dice: <span id="numDiceVal">2</span></label>
                <input type="range" id="numDice" min="1" max="6" step="1" value="2">
            </div>

            <h3>Dice Sides</h3>
            <div class="slider-group">
                <label>Sides: <span id="sidesVal">6</span></label>
                <input type="range" id="sides" min="4" max="20" step="2" value="6">
            </div>

            <h3>Roll Speed</h3>
            <div class="slider-group">
                <label>Delay: <span id="speedVal">100</span>ms</label>
                <input type="range" id="speed" min="10" max="500" step="10" value="100">
            </div>

            <h3>Auto Roll</h3>
            <div class="slider-group">
                <label>Rolls per tick: <span id="batchVal">1</span></label>
                <input type="range" id="batch" min="1" max="20" step="1" value="1">
            </div>

            <button onclick="reset()">Reset</button>
            <button onclick="togglePause()" id="pauseBtn">Pause</button>
            <button onclick="rollOnce()">Roll Once</button>
            <button onclick="roll100()">Roll 100x</button>

            <div class="stats">
                <div class="stat-row"><span>Total Rolls:</span><span id="rolls">0</span></div>
                <div class="stat-row"><span>Mean:</span><span id="mean">0</span></div>
                <div class="stat-row"><span>Expected Mean:</span><span id="expected">0</span></div>
                <div class="stat-row"><span>Std Dev:</span><span id="stddev">0</span></div>
                <div class="stat-row"><span>Mode:</span><span id="mode">-</span></div>
                <div class="stat-row"><span>Chi-squared:</span><span id="chi">0</span></div>
            </div>

            <div class="description">
                <strong>Dice Stalagmite:</strong><br>
                Watch probability distributions emerge as dice are rolled repeatedly.<br><br>
                <strong>Key Concepts:</strong><br>
                ‚Ä¢ Sum of dice ‚Üí normal distribution<br>
                ‚Ä¢ Central Limit Theorem in action<br>
                ‚Ä¢ Expected value = n √ó (sides+1)/2<br>
                ‚Ä¢ Variance increases with dice count<br><br>
                <strong>Try:</strong><br>
                Change number of dice and observe the bell curve emergence.
            </div>
        </div>
    </div>

    <script>
        const histogramCanvas = document.getElementById('histogramCanvas');
        const ctx = histogramCanvas.getContext('2d');

        histogramCanvas.width = 700;
        histogramCanvas.height = 450;

        let numDice = 2;
        let sides = 6;
        let speed = 100;
        let batch = 1;
        let paused = false;
        let animationId = null;
        let histogram = {};
        let totalRolls = 0;
        let lastRoll = [];

        function getMinMax() {
            return {
                min: numDice,
                max: numDice * sides
            };
        }

        function rollDice() {
            const rolls = [];
            let sum = 0;
            for (let i = 0; i < numDice; i++) {
                const roll = Math.floor(Math.random() * sides) + 1;
                rolls.push(roll);
                sum += roll;
            }
            return { rolls, sum };
        }

        function reset() {
            if (animationId) clearTimeout(animationId);
            numDice = parseInt(document.getElementById('numDice').value);
            sides = parseInt(document.getElementById('sides').value);
            speed = parseInt(document.getElementById('speed').value);
            batch = parseInt(document.getElementById('batch').value);

            histogram = {};
            totalRolls = 0;
            lastRoll = [];
            paused = false;
            document.getElementById('pauseBtn').textContent = 'Pause';

            // Initialize histogram
            const { min, max } = getMinMax();
            for (let i = min; i <= max; i++) {
                histogram[i] = 0;
            }

            updateDiceDisplay();
            updateStats();
            draw();
            animate();
        }

        function rollOnce() {
            const { rolls, sum } = rollDice();
            lastRoll = rolls;
            histogram[sum] = (histogram[sum] || 0) + 1;
            totalRolls++;
            updateDiceDisplay();
            updateStats();
            draw();
        }

        function roll100() {
            for (let i = 0; i < 100; i++) {
                const { rolls, sum } = rollDice();
                lastRoll = rolls;
                histogram[sum] = (histogram[sum] || 0) + 1;
                totalRolls++;
            }
            updateDiceDisplay();
            updateStats();
            draw();
        }

        function step() {
            for (let i = 0; i < batch; i++) {
                const { rolls, sum } = rollDice();
                lastRoll = rolls;
                histogram[sum] = (histogram[sum] || 0) + 1;
                totalRolls++;
            }
        }

        function updateDiceDisplay() {
            // Show up to 2 dice in the display
            document.getElementById('die1').textContent = lastRoll[0] || '?';
            document.getElementById('die2').textContent = lastRoll[1] || (numDice > 1 ? '?' : '');
            document.getElementById('sum').textContent = lastRoll.length > 0 ? lastRoll.reduce((a, b) => a + b, 0) : '?';

            // Hide second die if only 1 die
            document.getElementById('die2').style.display = numDice > 1 ? 'flex' : 'none';
        }

        function updateStats() {
            const { min, max } = getMinMax();

            // Calculate mean
            let sum = 0;
            for (let i = min; i <= max; i++) {
                sum += i * (histogram[i] || 0);
            }
            const mean = totalRolls > 0 ? sum / totalRolls : 0;

            // Expected mean
            const expectedMean = numDice * (sides + 1) / 2;

            // Standard deviation
            let variance = 0;
            for (let i = min; i <= max; i++) {
                variance += (histogram[i] || 0) * Math.pow(i - mean, 2);
            }
            variance = totalRolls > 0 ? variance / totalRolls : 0;
            const stddev = Math.sqrt(variance);

            // Mode
            let mode = min;
            let maxCount = 0;
            for (let i = min; i <= max; i++) {
                if ((histogram[i] || 0) > maxCount) {
                    maxCount = histogram[i];
                    mode = i;
                }
            }

            // Chi-squared test
            let chiSquared = 0;
            if (totalRolls > 0) {
                for (let i = min; i <= max; i++) {
                    const observed = histogram[i] || 0;
                    const expected = totalRolls * getTheoreticalProbability(i);
                    if (expected > 0) {
                        chiSquared += Math.pow(observed - expected, 2) / expected;
                    }
                }
            }

            document.getElementById('rolls').textContent = totalRolls;
            document.getElementById('mean').textContent = mean.toFixed(2);
            document.getElementById('expected').textContent = expectedMean.toFixed(2);
            document.getElementById('stddev').textContent = stddev.toFixed(2);
            document.getElementById('mode').textContent = mode;
            document.getElementById('chi').textContent = chiSquared.toFixed(2);
        }

        function getTheoreticalProbability(sum) {
            // Calculate theoretical probability of getting this sum
            // Using dynamic programming
            const dp = Array(numDice + 1).fill(null).map(() => Array(sum + 1).fill(0));
            dp[0][0] = 1;

            for (let d = 1; d <= numDice; d++) {
                for (let s = d; s <= d * sides && s <= sum; s++) {
                    for (let face = 1; face <= sides && face <= s; face++) {
                        dp[d][s] += dp[d - 1][s - face];
                    }
                }
            }

            return dp[numDice][sum] / Math.pow(sides, numDice);
        }

        function draw() {
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, histogramCanvas.width, histogramCanvas.height);

            const { min, max } = getMinMax();
            const numBins = max - min + 1;
            const barWidth = Math.min(50, (histogramCanvas.width - 60) / numBins);
            const startX = (histogramCanvas.width - numBins * barWidth) / 2;

            // Find max count for scaling
            let maxCount = 1;
            for (let i = min; i <= max; i++) {
                maxCount = Math.max(maxCount, histogram[i] || 0);
            }

            const maxHeight = histogramCanvas.height - 80;

            // Draw bars
            for (let i = min; i <= max; i++) {
                const count = histogram[i] || 0;
                const barHeight = (count / maxCount) * maxHeight;
                const x = startX + (i - min) * barWidth;
                const y = histogramCanvas.height - 40 - barHeight;

                // Color based on theoretical probability
                const prob = getTheoreticalProbability(i);
                const hue = 200 + prob * 160; // Blue to purple
                ctx.fillStyle = `hsl(${hue}, 70%, 60%)`;

                ctx.fillRect(x + 2, y, barWidth - 4, barHeight);

                // Draw count on top
                if (count > 0 && barHeight > 15) {
                    ctx.fillStyle = 'white';
                    ctx.font = '10px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(count, x + barWidth / 2, y - 3);
                }
            }

            // Draw x-axis labels
            ctx.fillStyle = '#b2bec3';
            ctx.font = '11px Arial';
            ctx.textAlign = 'center';

            for (let i = min; i <= max; i++) {
                const x = startX + (i - min) * barWidth + barWidth / 2;
                ctx.fillText(i, x, histogramCanvas.height - 25);
            }

            // Draw theoretical distribution curve
            if (totalRolls > 10) {
                ctx.strokeStyle = '#ffeaa7';
                ctx.lineWidth = 2;
                ctx.beginPath();

                for (let i = min; i <= max; i++) {
                    const x = startX + (i - min) * barWidth + barWidth / 2;
                    const theoreticalCount = totalRolls * getTheoreticalProbability(i);
                    const y = histogramCanvas.height - 40 - (theoreticalCount / maxCount) * maxHeight;

                    if (i === min) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
            }

            // Labels
            ctx.fillStyle = 'white';
            ctx.font = '12px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(`${numDice}d${sides} - Sum Distribution`, 10, 20);

            if (totalRolls > 10) {
                ctx.fillStyle = '#ffeaa7';
                ctx.fillText('‚Äî Theoretical', histogramCanvas.width - 100, 20);
            }

            // Y-axis label
            ctx.save();
            ctx.translate(15, histogramCanvas.height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillStyle = '#b2bec3';
            ctx.textAlign = 'center';
            ctx.fillText('Count', 0, 0);
            ctx.restore();

            // X-axis label
            ctx.fillStyle = '#b2bec3';
            ctx.textAlign = 'center';
            ctx.fillText('Sum', histogramCanvas.width / 2, histogramCanvas.height - 5);
        }

        function animate() {
            if (!paused) {
                step();
                updateDiceDisplay();
                updateStats();
            }
            draw();
            animationId = setTimeout(animate, speed);
        }

        function togglePause() {
            paused = !paused;
            document.getElementById('pauseBtn').textContent = paused ? 'Resume' : 'Pause';
        }

        // Event listeners
        document.getElementById('numDice').oninput = function() {
            document.getElementById('numDiceVal').textContent = this.value;
        };
        document.getElementById('sides').oninput = function() {
            document.getElementById('sidesVal').textContent = this.value;
        };
        document.getElementById('speed').oninput = function() {
            speed = parseInt(this.value);
            document.getElementById('speedVal').textContent = speed;
        };
        document.getElementById('batch').oninput = function() {
            batch = parseInt(this.value);
            document.getElementById('batchVal').textContent = batch;
        };

        reset();
    </script>
</body>
</html>
