<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Membrane Formation - NetLogo Simulations</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #e0e0e0;
        }
        h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #9b59b6, #3498db);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .description {
            text-align: center;
            max-width: 700px;
            margin-bottom: 20px;
            color: #aaa;
            line-height: 1.5;
        }
        .container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        canvas {
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        }
        .controls {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-width: 220px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        label {
            font-size: 0.85rem;
            color: #888;
        }
        input[type="range"] {
            width: 100%;
            cursor: pointer;
        }
        .value {
            font-size: 0.8rem;
            color: #9b59b6;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .primary { background: #9b59b6; color: white; }
        .primary:hover { background: #8e44ad; }
        .secondary { background: rgba(255,255,255,0.1); color: #e0e0e0; }
        .secondary:hover { background: rgba(255,255,255,0.2); }
        .stats {
            margin-top: 15px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 5px;
            font-size: 0.85rem;
        }
        .stats div { margin: 3px 0; }
        .stat-value { color: #9b59b6; }
        .legend {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 10px;
            font-size: 0.75rem;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .legend-icon {
            width: 24px;
            height: 12px;
            display: flex;
        }
        a.back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #9b59b6;
            text-decoration: none;
            font-size: 0.9rem;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        a.back-link:hover { opacity: 1; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Gallery</a>
    <h1>Membrane Formation</h1>
    <p class="description">
        Watch amphiphilic molecules (lipids with hydrophilic heads and hydrophobic tails) self-assemble
        into micelles, bilayers, and vesicles - the building blocks of cell membranes.
    </p>

    <div class="container">
        <canvas id="canvas" width="600" height="500"></canvas>

        <div class="controls">
            <div class="control-group">
                <label>Lipid Count: <span id="lipidVal" class="value">200</span></label>
                <input type="range" id="lipidCount" min="50" max="400" value="200">
            </div>

            <div class="control-group">
                <label>Temperature: <span id="tempVal" class="value">300</span> K</label>
                <input type="range" id="temperature" min="200" max="400" value="300">
            </div>

            <div class="control-group">
                <label>Hydrophobic Strength: <span id="hydroVal" class="value">5</span></label>
                <input type="range" id="hydroStrength" min="1" max="10" value="5">
            </div>

            <div class="control-group">
                <label>Water Density: <span id="waterVal" class="value">50</span>%</label>
                <input type="range" id="waterDensity" min="10" max="90" value="50">
            </div>

            <button class="primary" id="startBtn">Start</button>
            <button class="secondary" id="resetBtn">Reset</button>

            <div class="stats">
                <div>Micelles: <span id="micelles" class="stat-value">0</span></div>
                <div>Bilayer Segments: <span id="bilayers" class="stat-value">0</span></div>
                <div>Vesicles: <span id="vesicles" class="stat-value">0</span></div>
                <div>Free Lipids: <span id="freeLipids" class="stat-value">0</span></div>
                <div>Time Step: <span id="timestep" class="stat-value">0</span></div>
            </div>

            <div class="legend">
                <div class="legend-item">
                    <svg class="legend-icon" viewBox="0 0 24 12">
                        <circle cx="6" cy="6" r="5" fill="#3498db"/>
                        <rect x="11" y="3" width="12" height="6" fill="#f39c12"/>
                    </svg>
                    <span>Lipid (head + tail)</span>
                </div>
                <div class="legend-item">
                    <svg class="legend-icon" viewBox="0 0 24 12">
                        <circle cx="12" cy="6" r="3" fill="rgba(100,180,255,0.3)"/>
                    </svg>
                    <span>Water molecule</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const W = canvas.width;
        const H = canvas.height;

        let lipids = [];
        let waterMolecules = [];
        let running = false;
        let timestep = 0;

        const HEAD_RADIUS = 5;
        const TAIL_LENGTH = 15;

        class Lipid {
            constructor(x, y, angle) {
                this.x = x;
                this.y = y;
                this.angle = angle;
                this.vx = 0;
                this.vy = 0;
                this.angularVel = 0;
                this.clusterId = -1;
            }

            get headX() { return this.x; }
            get headY() { return this.y; }
            get tailX() { return this.x + Math.cos(this.angle) * TAIL_LENGTH; }
            get tailY() { return this.y + Math.sin(this.angle) * TAIL_LENGTH; }
            get tailMidX() { return this.x + Math.cos(this.angle) * TAIL_LENGTH * 0.5; }
            get tailMidY() { return this.y + Math.sin(this.angle) * TAIL_LENGTH * 0.5; }
        }

        function init() {
            const count = parseInt(document.getElementById('lipidCount').value);
            const waterDensity = parseInt(document.getElementById('waterDensity').value) / 100;

            lipids = [];
            waterMolecules = [];

            // Create lipids
            for (let i = 0; i < count; i++) {
                lipids.push(new Lipid(
                    Math.random() * W,
                    Math.random() * H,
                    Math.random() * Math.PI * 2
                ));
            }

            // Create water molecules
            const waterCount = Math.floor(W * H * waterDensity / 100);
            for (let i = 0; i < waterCount; i++) {
                waterMolecules.push({
                    x: Math.random() * W,
                    y: Math.random() * H
                });
            }

            timestep = 0;
            updateStats();
        }

        function distance(x1, y1, x2, y2) {
            const dx = x1 - x2;
            const dy = y1 - y2;
            return Math.sqrt(dx * dx + dy * dy);
        }

        function wrapCoord(val, max) {
            if (val < 0) return val + max;
            if (val > max) return val - max;
            return val;
        }

        function update() {
            const temperature = parseInt(document.getElementById('temperature').value);
            const hydroStrength = parseInt(document.getElementById('hydroStrength').value);

            const thermalMotion = temperature / 300;
            const hydroForce = hydroStrength / 5;

            // Apply forces
            lipids.forEach((lipid, i) => {
                let fx = 0, fy = 0, torque = 0;

                // Add thermal noise
                lipid.vx += (Math.random() - 0.5) * thermalMotion;
                lipid.vy += (Math.random() - 0.5) * thermalMotion;
                lipid.angularVel += (Math.random() - 0.5) * 0.1 * thermalMotion;

                // Interact with other lipids
                lipids.forEach((other, j) => {
                    if (i === j) return;

                    const headDist = distance(lipid.headX, lipid.headY, other.headX, other.headY);
                    const tailDist = distance(lipid.tailX, lipid.tailY, other.tailX, other.tailY);
                    const headTailDist = distance(lipid.headX, lipid.headY, other.tailX, other.tailY);
                    const tailHeadDist = distance(lipid.tailX, lipid.tailY, other.headX, other.headY);

                    // Head-head repulsion (hydrophilic heads prefer water)
                    if (headDist < 15 && headDist > 0) {
                        const strength = 0.5 / headDist;
                        fx += (lipid.headX - other.headX) * strength;
                        fy += (lipid.headY - other.headY) * strength;
                    }

                    // Tail-tail attraction (hydrophobic effect)
                    if (tailDist < 25 && tailDist > 5) {
                        const strength = -hydroForce * 0.3 / tailDist;
                        fx += (lipid.tailX - other.tailX) * strength;
                        fy += (lipid.tailY - other.tailY) * strength;

                        // Align tails to be parallel (for bilayer formation)
                        const angleDiff = other.angle - lipid.angle;
                        torque += Math.sin(angleDiff) * hydroForce * 0.1;
                    }

                    // Head-tail repulsion (heads avoid hydrophobic tails)
                    if (headTailDist < 12 && headTailDist > 0) {
                        const strength = 1.0 / headTailDist;
                        fx += (lipid.headX - other.tailX) * strength;
                        fy += (lipid.headY - other.tailY) * strength;
                    }

                    if (tailHeadDist < 12 && tailHeadDist > 0) {
                        const strength = 0.5 / tailHeadDist;
                        const dx = lipid.tailX - other.headX;
                        const dy = lipid.tailY - other.headY;
                        torque += (dx * Math.sin(lipid.angle) - dy * Math.cos(lipid.angle)) * strength;
                    }
                });

                // Apply forces
                lipid.vx += fx * 0.1;
                lipid.vy += fy * 0.1;
                lipid.angularVel += torque * 0.05;

                // Damping
                lipid.vx *= 0.95;
                lipid.vy *= 0.95;
                lipid.angularVel *= 0.9;

                // Update position
                lipid.x += lipid.vx;
                lipid.y += lipid.vy;
                lipid.angle += lipid.angularVel;

                // Wrap around
                lipid.x = wrapCoord(lipid.x, W);
                lipid.y = wrapCoord(lipid.y, H);
            });

            // Move water molecules (simple Brownian motion)
            waterMolecules.forEach(water => {
                water.x += (Math.random() - 0.5) * thermalMotion * 2;
                water.y += (Math.random() - 0.5) * thermalMotion * 2;
                water.x = wrapCoord(water.x, W);
                water.y = wrapCoord(water.y, H);
            });

            timestep++;
        }

        function identifyStructures() {
            // Reset cluster IDs
            lipids.forEach(l => l.clusterId = -1);

            // Find clusters using tail proximity
            let clusterId = 0;
            lipids.forEach((lipid, i) => {
                if (lipid.clusterId >= 0) return;

                // BFS to find connected lipids
                const cluster = [i];
                lipid.clusterId = clusterId;
                let queue = [i];

                while (queue.length > 0) {
                    const current = queue.shift();
                    const currentLipid = lipids[current];

                    lipids.forEach((other, j) => {
                        if (other.clusterId >= 0) return;

                        const tailDist = distance(
                            currentLipid.tailX, currentLipid.tailY,
                            other.tailX, other.tailY
                        );

                        if (tailDist < 20) {
                            other.clusterId = clusterId;
                            cluster.push(j);
                            queue.push(j);
                        }
                    });
                }

                if (cluster.length > 1) {
                    clusterId++;
                }
            });

            // Count structures
            const clusterSizes = {};
            lipids.forEach(l => {
                if (l.clusterId >= 0) {
                    clusterSizes[l.clusterId] = (clusterSizes[l.clusterId] || 0) + 1;
                }
            });

            let micelles = 0;
            let bilayers = 0;
            let vesicles = 0;
            let freeLipids = 0;

            Object.values(clusterSizes).forEach(size => {
                if (size >= 20) vesicles++;
                else if (size >= 10) bilayers++;
                else if (size >= 4) micelles++;
            });

            freeLipids = lipids.filter(l => l.clusterId < 0).length;

            return { micelles, bilayers, vesicles, freeLipids };
        }

        function draw() {
            // Dark blue water-like background
            ctx.fillStyle = '#0a1628';
            ctx.fillRect(0, 0, W, H);

            // Draw water molecules
            ctx.fillStyle = 'rgba(100, 180, 255, 0.15)';
            waterMolecules.forEach(water => {
                ctx.beginPath();
                ctx.arc(water.x, water.y, 2, 0, Math.PI * 2);
                ctx.fill();
            });

            // Draw lipids
            lipids.forEach(lipid => {
                // Draw tail (hydrophobic, yellow/orange)
                ctx.strokeStyle = lipid.clusterId >= 0 ? '#f39c12' : '#e67e22';
                ctx.lineWidth = 3;
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(lipid.headX, lipid.headY);
                ctx.lineTo(lipid.tailX, lipid.tailY);
                ctx.stroke();

                // Draw head (hydrophilic, blue)
                ctx.beginPath();
                ctx.arc(lipid.headX, lipid.headY, HEAD_RADIUS, 0, Math.PI * 2);
                ctx.fillStyle = lipid.clusterId >= 0 ? '#3498db' : '#2980b9';
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 1;
                ctx.stroke();
            });
        }

        function updateStats() {
            const structures = identifyStructures();

            document.getElementById('micelles').textContent = structures.micelles;
            document.getElementById('bilayers').textContent = structures.bilayers;
            document.getElementById('vesicles').textContent = structures.vesicles;
            document.getElementById('freeLipids').textContent = structures.freeLipids;
            document.getElementById('timestep').textContent = timestep;

            document.getElementById('lipidVal').textContent = document.getElementById('lipidCount').value;
            document.getElementById('tempVal').textContent = document.getElementById('temperature').value;
            document.getElementById('hydroVal').textContent = document.getElementById('hydroStrength').value;
            document.getElementById('waterVal').textContent = document.getElementById('waterDensity').value;
        }

        function animate() {
            if (running) {
                for (let i = 0; i < 3; i++) {
                    update();
                }
            }
            draw();
            if (timestep % 10 === 0) updateStats();
            requestAnimationFrame(animate);
        }

        document.getElementById('startBtn').addEventListener('click', function() {
            running = !running;
            this.textContent = running ? 'Pause' : 'Start';
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            running = false;
            document.getElementById('startBtn').textContent = 'Start';
            init();
        });

        ['lipidCount', 'temperature', 'hydroStrength', 'waterDensity'].forEach(id => {
            document.getElementById(id).addEventListener('input', updateStats);
        });

        init();
        animate();
    </script>
</body>
</html>
