<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moth Phototaxis - CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f0f1a; color: #e8e6e1; overflow: hidden; }
        #container { display: flex; height: 100vh; }
        #canvas-container { flex: 1; position: relative; }
        canvas { display: block; width: 100%; height: 100%; }
        #controls { width: 280px; background: rgba(0,0,0,0.9); padding: 20px; overflow-y: auto; }
        h1 { font-size: 1.2rem; margin-bottom: 15px; color: #fef3c7; }
        .control-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: #aaa; }
        input[type="range"] { width: 100%; }
        button { width: 100%; padding: 10px; margin-bottom: 10px; background: #fbbf24; color: #0f0f1a; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: #f59e0b; }
        .stats { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; font-size: 0.8rem; margin-bottom: 15px; }
        .stats div { margin-bottom: 5px; }
        .back-link { position: fixed; top: 10px; left: 10px; padding: 8px 16px; background: rgba(0,0,0,0.7); color: #fbbf24; text-decoration: none; border-radius: 6px; font-size: 14px; z-index: 999; }
        .description { font-size: 0.75rem; color: #888; margin-bottom: 15px; line-height: 1.5; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back</a>
    <div id="container">
        <div id="canvas-container">
            <canvas id="canvas"></canvas>
        </div>
        <div id="controls">
            <h1>Moth Navigation</h1>
            <p class="description">Moths navigate by keeping a constant angle to light sources. With the moon (infinitely far), this works. With artificial lights (nearby), moths spiral inward - the "moth to flame" effect.</p>
            
            <div class="control-group">
                <label>Moths: <span id="mothsVal">50</span></label>
                <input type="range" id="moths" min="10" max="150" value="50">
            </div>
            <div class="control-group">
                <label>Light Intensity: <span id="intensityVal">100</span></label>
                <input type="range" id="intensity" min="20" max="200" value="100">
            </div>
            <div class="control-group">
                <label>Turn Angle: <span id="angleVal">5</span>°</label>
                <input type="range" id="angle" min="1" max="15" value="5">
            </div>
            <div class="control-group">
                <label>Speed: <span id="speedVal">2</span></label>
                <input type="range" id="speed" min="1" max="5" value="2">
            </div>
            
            <button id="reset">Reset</button>
            <button id="pause">Pause</button>
            <button id="addLight">Add Light (Click Canvas)</button>
            <button id="moonMode">Toggle Moon Mode</button>
            
            <div class="stats">
                <div>Moths: <span id="mothCount">0</span></div>
                <div>Trapped: <span id="trapped">0</span></div>
                <div>Lights: <span id="lightCount">1</span></div>
                <div>Mode: <span id="mode">Artificial</span></div>
            </div>
            
            <p class="description"><strong>Transverse orientation:</strong> Moths maintain a fixed angle to light rays. Works for distant moon but fails for nearby lights, causing spiral approach.</p>
        </div>
    </div>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        let W, H, moths = [], lights = [], paused = false, moonMode = false;
        let addingLight = false;
        
        let params = {
            mothCount: 50,
            intensity: 100,
            turnAngle: 5 * Math.PI / 180,
            speed: 2
        };
        
        function resize() {
            const c = document.getElementById('canvas-container');
            canvas.width = c.clientWidth;
            canvas.height = c.clientHeight;
            W = canvas.width;
            H = canvas.height;
        }
        
        function init() {
            resize();
            
            // Create moths
            moths = [];
            for (let i = 0; i < params.mothCount; i++) {
                moths.push({
                    x: Math.random() * W,
                    y: Math.random() * H,
                    angle: Math.random() * Math.PI * 2,
                    trapped: false
                });
            }
            
            // Create initial light
            lights = [{
                x: W / 2,
                y: H / 2,
                radius: params.intensity
            }];
            
            updateStats();
        }
        
        function step() {
            for (const moth of moths) {
                if (moth.trapped) continue;
                
                if (moonMode) {
                    // Moon mode: light is infinitely far, so all rays are parallel
                    // Moths fly straight (or with minor random variation)
                    moth.angle += (Math.random() - 0.5) * 0.1;
                } else {
                    // Artificial light mode: moths try to maintain constant angle to light
                    let closestLight = null;
                    let minDist = Infinity;
                    
                    for (const light of lights) {
                        const dx = light.x - moth.x;
                        const dy = light.y - moth.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        if (dist < minDist) {
                            minDist = dist;
                            closestLight = light;
                        }
                    }
                    
                    if (closestLight && minDist < closestLight.radius * 2) {
                        // Calculate angle to light
                        const dx = closestLight.x - moth.x;
                        const dy = closestLight.y - moth.y;
                        const angleToLight = Math.atan2(dy, dx);
                        
                        // Moth tries to keep light at a fixed angle (transverse orientation)
                        // This causes spiral approach
                        const desiredAngle = angleToLight + Math.PI / 2 + params.turnAngle;
                        
                        // Gradually turn toward desired angle
                        let angleDiff = desiredAngle - moth.angle;
                        while (angleDiff > Math.PI) angleDiff -= Math.PI * 2;
                        while (angleDiff < -Math.PI) angleDiff += Math.PI * 2;
                        
                        moth.angle += angleDiff * 0.1;
                        
                        // Check if trapped (too close to light)
                        if (minDist < 10) {
                            moth.trapped = true;
                        }
                    } else {
                        // Random wandering when far from lights
                        moth.angle += (Math.random() - 0.5) * 0.3;
                    }
                }
                
                // Move
                moth.x += Math.cos(moth.angle) * params.speed;
                moth.y += Math.sin(moth.angle) * params.speed;
                
                // Wrap around
                if (moth.x < 0) moth.x = W;
                if (moth.x > W) moth.x = 0;
                if (moth.y < 0) moth.y = H;
                if (moth.y > H) moth.y = 0;
            }
            
            updateStats();
        }
        
        function updateStats() {
            const trapped = moths.filter(m => m.trapped).length;
            document.getElementById('mothCount').textContent = moths.length;
            document.getElementById('trapped').textContent = trapped;
            document.getElementById('lightCount').textContent = lights.length;
            document.getElementById('mode').textContent = moonMode ? 'Moon (parallel rays)' : 'Artificial (point source)';
        }
        
        function draw() {
            // Night sky background
            ctx.fillStyle = '#0f0f1a';
            ctx.fillRect(0, 0, W, H);
            
            // Draw stars
            ctx.fillStyle = '#fff';
            for (let i = 0; i < 100; i++) {
                const x = (i * 137.5) % W;
                const y = (i * 91.3) % H;
                ctx.beginPath();
                ctx.arc(x, y, 0.5 + Math.random(), 0, Math.PI * 2);
                ctx.fill();
            }
            
            if (moonMode) {
                // Draw moon
                ctx.fillStyle = '#fef3c7';
                ctx.beginPath();
                ctx.arc(W - 80, 80, 40, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#fde68a';
                ctx.beginPath();
                ctx.arc(W - 90, 75, 35, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Draw lights
            for (const light of lights) {
                // Glow
                const gradient = ctx.createRadialGradient(light.x, light.y, 0, light.x, light.y, light.radius);
                gradient.addColorStop(0, 'rgba(251, 191, 36, 0.8)');
                gradient.addColorStop(0.5, 'rgba(251, 191, 36, 0.2)');
                gradient.addColorStop(1, 'rgba(251, 191, 36, 0)');
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(light.x, light.y, light.radius, 0, Math.PI * 2);
                ctx.fill();
                
                // Bulb
                ctx.fillStyle = '#fef3c7';
                ctx.beginPath();
                ctx.arc(light.x, light.y, 8, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Draw moths
            for (const moth of moths) {
                ctx.save();
                ctx.translate(moth.x, moth.y);
                ctx.rotate(moth.angle);
                
                // Wings
                ctx.fillStyle = moth.trapped ? '#4a4a4a' : '#a1a1aa';
                ctx.beginPath();
                ctx.ellipse(-3, -5, 5, 8, -0.3, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.ellipse(-3, 5, 5, 8, 0.3, 0, Math.PI * 2);
                ctx.fill();
                
                // Body
                ctx.fillStyle = moth.trapped ? '#333' : '#71717a';
                ctx.beginPath();
                ctx.ellipse(0, 0, 3, 6, 0, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.restore();
            }
            
            // Instructions
            if (addingLight) {
                ctx.fillStyle = '#fbbf24';
                ctx.font = '16px sans-serif';
                ctx.fillText('Click to place light', W/2 - 70, 30);
            }
            
            requestAnimationFrame(draw);
        }
        
        let intervalId = null;
        function startSim() {
            if (intervalId) clearInterval(intervalId);
            intervalId = setInterval(() => { if (!paused) step(); }, 1000/60);
        }
        
        // Event listeners
        document.getElementById('moths').addEventListener('input', e => {
            params.mothCount = +e.target.value;
            document.getElementById('mothsVal').textContent = params.mothCount;
        });
        document.getElementById('intensity').addEventListener('input', e => {
            params.intensity = +e.target.value;
            document.getElementById('intensityVal').textContent = params.intensity;
            for (const light of lights) light.radius = params.intensity;
        });
        document.getElementById('angle').addEventListener('input', e => {
            params.turnAngle = +e.target.value * Math.PI / 180;
            document.getElementById('angleVal').textContent = e.target.value;
        });
        document.getElementById('speed').addEventListener('input', e => {
            params.speed = +e.target.value;
            document.getElementById('speedVal').textContent = params.speed;
        });
        document.getElementById('reset').addEventListener('click', () => { init(); startSim(); });
        document.getElementById('pause').addEventListener('click', () => {
            paused = !paused;
            document.getElementById('pause').textContent = paused ? 'Resume' : 'Pause';
        });
        document.getElementById('addLight').addEventListener('click', () => {
            addingLight = !addingLight;
            document.getElementById('addLight').textContent = addingLight ? 'Click Canvas Now' : 'Add Light (Click Canvas)';
        });
        document.getElementById('moonMode').addEventListener('click', () => {
            moonMode = !moonMode;
            updateStats();
        });
        
        canvas.addEventListener('click', e => {
            if (addingLight) {
                const rect = canvas.getBoundingClientRect();
                lights.push({
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top,
                    radius: params.intensity
                });
                addingLight = false;
                document.getElementById('addLight').textContent = 'Add Light (Click Canvas)';
                updateStats();
            }
        });
        
        window.addEventListener('resize', resize);
        init();
        draw();
        startSim();
    </script>
</body>
</html>
