<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rebellion - Civil Violence Model</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', system-ui, sans-serif;
            color: #e0e0e0;
        }
        .back-link {
            position: fixed;
            top: 15px;
            left: 15px;
            color: #c0392b;
            text-decoration: none;
            z-index: 100;
        }
        header { text-align: center; padding: 15px; }
        h1 { color: #c0392b; font-size: 1.6rem; }
        .container {
            display: grid;
            grid-template-columns: 1fr 280px;
            gap: 15px;
            padding: 0 15px 15px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .main-area { display: flex; flex-direction: column; gap: 15px; }
        .canvas-wrapper {
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            padding: 15px;
        }
        .canvas-wrapper h3 {
            color: #c0392b;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        #gridCanvas {
            width: 100%;
            height: 400px;
            background: #0a0a15;
            border-radius: 8px;
        }
        #graphCanvas {
            width: 100%;
            height: 100px;
            background: #0a0a15;
            border-radius: 8px;
            margin-top: 15px;
        }
        .sidebar {
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            padding: 15px;
        }
        .control-group { margin-bottom: 15px; }
        .control-group label {
            display: block;
            color: #c0392b;
            margin-bottom: 6px;
            font-size: 0.85rem;
        }
        input[type="range"] {
            width: 100%;
            -webkit-appearance: none;
            height: 5px;
            background: #333;
            border-radius: 3px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #c0392b;
            border-radius: 50%;
            cursor: pointer;
        }
        .value-display {
            text-align: right;
            font-size: 0.8rem;
            color: #888;
            margin-top: 4px;
        }
        button {
            width: 100%;
            padding: 10px;
            margin: 4px 0;
            background: #c0392b;
            border: none;
            border-radius: 5px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
        }
        button:hover { background: #a93226; }
        button.secondary { background: #333; }
        button.running { background: #27ae60; }
        .legend {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            font-size: 0.75rem;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        .stats {
            background: rgba(192, 57, 43, 0.1);
            border: 1px solid rgba(192, 57, 43, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 6px 0;
            font-size: 0.8rem;
        }
        .stat-label { color: #888; }
        .stat-value { color: #c0392b; font-family: monospace; }
        .info {
            margin-top: 12px;
            padding: 10px;
            background: rgba(192, 57, 43, 0.1);
            border-radius: 6px;
            font-size: 0.75rem;
            line-height: 1.4;
        }
        .info h4 { color: #c0392b; margin-bottom: 6px; }
        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">&larr; Back</a>

    <header>
        <h1>Rebellion</h1>
        <p style="color: #888; font-size: 0.9rem;">Epstein's Civil Violence Model</p>
    </header>

    <div class="container">
        <div class="main-area">
            <div class="canvas-wrapper">
                <h3>Population Grid</h3>
                <canvas id="gridCanvas"></canvas>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #2ecc71;"></div>
                        <span>Quiet</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #e74c3c;"></div>
                        <span>Active Rebel</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #555;"></div>
                        <span>Jailed</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #3498db;"></div>
                        <span>Cop</span>
                    </div>
                </div>
                <h3 style="margin-top: 15px;">Population Over Time</h3>
                <canvas id="graphCanvas"></canvas>
            </div>
        </div>

        <div class="sidebar">
            <div class="control-group">
                <label>Grid Size</label>
                <input type="range" id="gridSize" min="20" max="60" value="40">
                <div class="value-display"><span id="gridSizeVal">40</span> × 40</div>
            </div>

            <div class="control-group">
                <label>Citizen Density</label>
                <input type="range" id="citizenDensity" min="10" max="90" value="70">
                <div class="value-display"><span id="citizenDensityVal">70</span>%</div>
            </div>

            <div class="control-group">
                <label>Cop Density</label>
                <input type="range" id="copDensity" min="1" max="20" value="4">
                <div class="value-display"><span id="copDensityVal">4</span>%</div>
            </div>

            <div class="control-group">
                <label>Government Legitimacy</label>
                <input type="range" id="legitimacy" min="0" max="100" value="82">
                <div class="value-display"><span id="legitimacyVal">82</span>%</div>
            </div>

            <div class="control-group">
                <label>Max Jail Term</label>
                <input type="range" id="maxJail" min="5" max="50" value="30">
                <div class="value-display"><span id="maxJailVal">30</span> turns</div>
            </div>

            <div class="control-group">
                <label>Vision Radius</label>
                <input type="range" id="vision" min="1" max="7" value="3">
                <div class="value-display"><span id="visionVal">3</span> cells</div>
            </div>

            <button id="startBtn">Start Simulation</button>
            <button id="stepBtn" class="secondary">Single Step</button>
            <button id="resetBtn" class="secondary">Reset</button>

            <div class="stats">
                <div class="stat-row">
                    <span class="stat-label">Time:</span>
                    <span class="stat-value" id="timeStat">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Quiet:</span>
                    <span class="stat-value" id="quietStat">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Active:</span>
                    <span class="stat-value" id="activeStat">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Jailed:</span>
                    <span class="stat-value" id="jailedStat">0</span>
                </div>
            </div>

            <div class="info">
                <h4>Epstein Model</h4>
                <p><strong>Grievance</strong> = Hardship × (1 - Legitimacy)</p>
                <p><strong>Net Risk</strong> = Arrest Prob × Risk Aversion</p>
                <p style="margin-top:6px">Citizens rebel when Grievance - Net Risk > Threshold. Cops arrest nearby rebels.</p>
            </div>
        </div>
    </div>

    <script>
        const gridCanvas = document.getElementById('gridCanvas');
        const graphCanvas = document.getElementById('graphCanvas');
        const gridCtx = gridCanvas.getContext('2d');
        const graphCtx = graphCanvas.getContext('2d');

        // Agent types
        const EMPTY = 0;
        const CITIZEN = 1;
        const COP = 2;

        // Citizen states
        const QUIET = 0;
        const ACTIVE = 1;
        const JAILED = 2;

        let gridSize = 40;
        let citizenDensity = 0.7;
        let copDensity = 0.04;
        let legitimacy = 0.82;
        let maxJailTerm = 30;
        let vision = 3;
        const threshold = 0.1;
        const k = 2.3; // Constant for arrest probability

        let grid = [];
        let agents = [];
        let running = false;
        let timeStep = 0;
        let animFrame;
        let history = { quiet: [], active: [], jailed: [] };

        function resize() {
            gridCanvas.width = gridCanvas.parentElement.clientWidth - 30;
            gridCanvas.height = 400;
            graphCanvas.width = graphCanvas.parentElement.clientWidth - 30;
            graphCanvas.height = 100;
            render();
        }

        function initGrid() {
            grid = [];
            agents = [];

            for (let y = 0; y < gridSize; y++) {
                const row = [];
                for (let x = 0; x < gridSize; x++) {
                    row.push({ type: EMPTY, agent: null });
                }
                grid.push(row);
            }

            // Place citizens
            const totalCells = gridSize * gridSize;
            const numCitizens = Math.floor(totalCells * citizenDensity);
            const numCops = Math.floor(totalCells * copDensity);

            const positions = [];
            for (let y = 0; y < gridSize; y++) {
                for (let x = 0; x < gridSize; x++) {
                    positions.push({ x, y });
                }
            }
            shuffleArray(positions);

            for (let i = 0; i < numCitizens; i++) {
                const pos = positions[i];
                const agent = {
                    type: CITIZEN,
                    x: pos.x,
                    y: pos.y,
                    state: QUIET,
                    hardship: Math.random(),
                    riskAversion: Math.random(),
                    jailTerm: 0
                };
                grid[pos.y][pos.x] = { type: CITIZEN, agent };
                agents.push(agent);
            }

            for (let i = numCitizens; i < numCitizens + numCops; i++) {
                const pos = positions[i];
                const agent = {
                    type: COP,
                    x: pos.x,
                    y: pos.y
                };
                grid[pos.y][pos.x] = { type: COP, agent };
                agents.push(agent);
            }

            timeStep = 0;
            history = { quiet: [], active: [], jailed: [] };
            updateStats();
            render();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function getNeighborhood(x, y, r) {
            const neighbors = [];
            for (let dy = -r; dy <= r; dy++) {
                for (let dx = -r; dx <= r; dx++) {
                    if (dx === 0 && dy === 0) continue;
                    const nx = (x + dx + gridSize) % gridSize;
                    const ny = (y + dy + gridSize) % gridSize;
                    neighbors.push({ x: nx, y: ny, cell: grid[ny][nx] });
                }
            }
            return neighbors;
        }

        function countCopsAndActives(x, y) {
            const neighbors = getNeighborhood(x, y, vision);
            let cops = 0, actives = 1; // Count self as active
            for (const n of neighbors) {
                if (n.cell.type === COP) cops++;
                if (n.cell.type === CITIZEN && n.cell.agent.state === ACTIVE) actives++;
            }
            return { cops, actives };
        }

        function step() {
            // Shuffle agents for random activation order
            const shuffledAgents = [...agents];
            shuffleArray(shuffledAgents);

            for (const agent of shuffledAgents) {
                if (agent.type === CITIZEN) {
                    if (agent.state === JAILED) {
                        agent.jailTerm--;
                        if (agent.jailTerm <= 0) {
                            agent.state = QUIET;
                        }
                    } else {
                        // Calculate grievance
                        const grievance = agent.hardship * (1 - legitimacy);

                        // Calculate arrest probability
                        const { cops, actives } = countCopsAndActives(agent.x, agent.y);
                        const arrestProb = 1 - Math.exp(-k * Math.floor(cops / actives));

                        // Calculate net risk
                        const netRisk = arrestProb * agent.riskAversion;

                        // Decide to rebel or not
                        if (grievance - netRisk > threshold) {
                            agent.state = ACTIVE;
                        } else {
                            agent.state = QUIET;
                        }
                    }

                    // Move to random empty neighbor
                    moveToEmptyNeighbor(agent);

                } else if (agent.type === COP) {
                    // Find active rebels in vision
                    const neighbors = getNeighborhood(agent.x, agent.y, vision);
                    const activeRebels = neighbors.filter(n =>
                        n.cell.type === CITIZEN && n.cell.agent.state === ACTIVE
                    );

                    if (activeRebels.length > 0) {
                        // Arrest random rebel
                        const rebel = activeRebels[Math.floor(Math.random() * activeRebels.length)];
                        rebel.cell.agent.state = JAILED;
                        rebel.cell.agent.jailTerm = Math.ceil(Math.random() * maxJailTerm);
                    }

                    // Move to random empty neighbor
                    moveToEmptyNeighbor(agent);
                }
            }

            timeStep++;

            const counts = getCounts();
            history.quiet.push(counts.quiet);
            history.active.push(counts.active);
            history.jailed.push(counts.jailed);

            if (history.quiet.length > 200) {
                history.quiet.shift();
                history.active.shift();
                history.jailed.shift();
            }

            updateStats();
            render();
        }

        function moveToEmptyNeighbor(agent) {
            const neighbors = getNeighborhood(agent.x, agent.y, 1);
            const emptyNeighbors = neighbors.filter(n => n.cell.type === EMPTY);

            if (emptyNeighbors.length > 0) {
                const target = emptyNeighbors[Math.floor(Math.random() * emptyNeighbors.length)];

                // Update grid
                grid[agent.y][agent.x] = { type: EMPTY, agent: null };
                agent.x = target.x;
                agent.y = target.y;
                grid[agent.y][agent.x] = { type: agent.type, agent };
            }
        }

        function getCounts() {
            let quiet = 0, active = 0, jailed = 0;
            for (const agent of agents) {
                if (agent.type === CITIZEN) {
                    if (agent.state === QUIET) quiet++;
                    else if (agent.state === ACTIVE) active++;
                    else jailed++;
                }
            }
            return { quiet, active, jailed };
        }

        function updateStats() {
            const counts = getCounts();
            document.getElementById('timeStat').textContent = timeStep;
            document.getElementById('quietStat').textContent = counts.quiet;
            document.getElementById('activeStat').textContent = counts.active;
            document.getElementById('jailedStat').textContent = counts.jailed;
        }

        function render() {
            const cellSize = Math.min(gridCanvas.width, gridCanvas.height) / gridSize;
            const offsetX = (gridCanvas.width - gridSize * cellSize) / 2;
            const offsetY = (gridCanvas.height - gridSize * cellSize) / 2;

            gridCtx.fillStyle = '#0a0a15';
            gridCtx.fillRect(0, 0, gridCanvas.width, gridCanvas.height);

            for (let y = 0; y < gridSize; y++) {
                for (let x = 0; x < gridSize; x++) {
                    const cell = grid[y][x];
                    let color = '#1a1a2e';

                    if (cell.type === COP) {
                        color = '#3498db';
                    } else if (cell.type === CITIZEN) {
                        if (cell.agent.state === QUIET) {
                            // Color by grievance level
                            const g = cell.agent.hardship * (1 - legitimacy);
                            const green = Math.floor(236 - g * 100);
                            color = `rgb(46, ${green}, 113)`;
                        } else if (cell.agent.state === ACTIVE) {
                            color = '#e74c3c';
                        } else {
                            color = '#555';
                        }
                    }

                    gridCtx.fillStyle = color;
                    gridCtx.fillRect(
                        offsetX + x * cellSize,
                        offsetY + y * cellSize,
                        cellSize - 0.5,
                        cellSize - 0.5
                    );
                }
            }

            // Draw graph
            graphCtx.fillStyle = '#0a0a15';
            graphCtx.fillRect(0, 0, graphCanvas.width, graphCanvas.height);

            if (history.quiet.length < 2) return;

            const w = graphCanvas.width;
            const h = graphCanvas.height;
            const maxCount = Math.max(
                Math.max(...history.quiet),
                Math.max(...history.active),
                Math.max(...history.jailed),
                1
            );

            const datasets = [
                { data: history.quiet, color: '#2ecc71' },
                { data: history.active, color: '#e74c3c' },
                { data: history.jailed, color: '#555' }
            ];

            for (const dataset of datasets) {
                const dx = w / (dataset.data.length - 1);
                graphCtx.strokeStyle = dataset.color;
                graphCtx.lineWidth = 2;
                graphCtx.beginPath();

                for (let i = 0; i < dataset.data.length; i++) {
                    const x = i * dx;
                    const y = h - (dataset.data[i] / maxCount) * (h - 10) - 5;
                    if (i === 0) graphCtx.moveTo(x, y);
                    else graphCtx.lineTo(x, y);
                }
                graphCtx.stroke();
            }
        }

        function animate() {
            if (!running) return;
            step();
            animFrame = setTimeout(() => requestAnimationFrame(animate), 100);
        }

        // Event listeners
        document.getElementById('gridSize').addEventListener('input', (e) => {
            gridSize = parseInt(e.target.value);
            document.getElementById('gridSizeVal').textContent = gridSize;
        });

        document.getElementById('citizenDensity').addEventListener('input', (e) => {
            citizenDensity = parseInt(e.target.value) / 100;
            document.getElementById('citizenDensityVal').textContent = e.target.value;
        });

        document.getElementById('copDensity').addEventListener('input', (e) => {
            copDensity = parseInt(e.target.value) / 100;
            document.getElementById('copDensityVal').textContent = e.target.value;
        });

        document.getElementById('legitimacy').addEventListener('input', (e) => {
            legitimacy = parseInt(e.target.value) / 100;
            document.getElementById('legitimacyVal').textContent = e.target.value;
        });

        document.getElementById('maxJail').addEventListener('input', (e) => {
            maxJailTerm = parseInt(e.target.value);
            document.getElementById('maxJailVal').textContent = maxJailTerm;
        });

        document.getElementById('vision').addEventListener('input', (e) => {
            vision = parseInt(e.target.value);
            document.getElementById('visionVal').textContent = vision;
        });

        document.getElementById('startBtn').addEventListener('click', (e) => {
            running = !running;
            if (running) {
                e.target.textContent = 'Pause';
                e.target.classList.add('running');
                animate();
            } else {
                e.target.textContent = 'Resume';
                e.target.classList.remove('running');
                clearTimeout(animFrame);
            }
        });

        document.getElementById('stepBtn').addEventListener('click', () => {
            if (!running) step();
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            running = false;
            document.getElementById('startBtn').textContent = 'Start Simulation';
            document.getElementById('startBtn').classList.remove('running');
            clearTimeout(animFrame);
            initGrid();
        });

        window.addEventListener('resize', resize);
        resize();
        initGrid();
    </script>
</body>
</html>
