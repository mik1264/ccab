<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Party - Social Clustering Simulation</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e8e8e8;
            min-height: 100vh;
            display: flex;
        }
        .sidebar {
            width: 300px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            overflow-y: auto;
        }
        .main-content { flex: 1; display: flex; flex-direction: column; padding: 20px; }
        h1 { font-size: 1.4rem; margin-bottom: 10px; color: #ec4899; }
        .description { font-size: 0.85rem; color: #aaa; margin-bottom: 20px; line-height: 1.5; }
        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; font-size: 0.8rem; color: #888; margin-bottom: 5px; }
        .control-group input[type="range"] { width: 100%; }
        .control-group .value { font-size: 0.75rem; color: #ec4899; }
        .buttons { display: flex; gap: 10px; margin-bottom: 20px; }
        button { padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.85rem; }
        .btn-primary { background: #ec4899; color: #fff; }
        .btn-secondary { background: #374151; color: #e8e8e8; }
        button:hover { opacity: 0.8; }
        .stats { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.85rem; }
        .stat-label { color: #888; }
        .stat-value { font-weight: bold; font-family: monospace; }
        .canvas-container { flex: 1; display: flex; gap: 20px; min-height: 0; }
        canvas { border-radius: 8px; background: #0a0a0a; }
        #simCanvas { flex: 2; }
        .charts { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .chart-container { flex: 1; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; }
        .chart-title { font-size: 0.75rem; color: #888; margin-bottom: 5px; }
        .back-link { display: inline-block; color: #ec4899; text-decoration: none; margin-bottom: 15px; font-size: 0.85rem; }
        .back-link:hover { text-decoration: underline; }
        .attribute-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        .attr-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
            padding: 3px 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
        }
        .attr-dot { width: 10px; height: 10px; border-radius: 50%; }
    </style>
</head>
<body>
    <div class="sidebar">
        <a href="index.html" class="back-link">‚Üê Back to Gallery</a>
        <h1>Party Simulation</h1>
        <p class="description">
            Social gathering where agents cluster based on attribute similarity.
            Each person has interests (color hue) and introversion (size).
            People move toward similar others, demonstrating homophily dynamics.
        </p>

        <div class="attribute-legend">
            <div class="attr-item">
                <div class="attr-dot" style="background: hsl(0, 70%, 60%);"></div>
                <span>Sports</span>
            </div>
            <div class="attr-item">
                <div class="attr-dot" style="background: hsl(60, 70%, 60%);"></div>
                <span>Music</span>
            </div>
            <div class="attr-item">
                <div class="attr-dot" style="background: hsl(120, 70%, 60%);"></div>
                <span>Tech</span>
            </div>
            <div class="attr-item">
                <div class="attr-dot" style="background: hsl(180, 70%, 60%);"></div>
                <span>Art</span>
            </div>
            <div class="attr-item">
                <div class="attr-dot" style="background: hsl(240, 70%, 60%);"></div>
                <span>Books</span>
            </div>
            <div class="attr-item">
                <div class="attr-dot" style="background: hsl(300, 70%, 60%);"></div>
                <span>Food</span>
            </div>
        </div>

        <div class="buttons">
            <button class="btn-primary" id="startBtn">Start</button>
            <button class="btn-secondary" id="resetBtn">Reset</button>
        </div>

        <div class="control-group">
            <label>Number of People: <span class="value" id="numPeopleValue">60</span></label>
            <input type="range" id="numPeople" min="20" max="120" value="60">
        </div>

        <div class="control-group">
            <label>Similarity Threshold: <span class="value" id="thresholdValue">0.3</span></label>
            <input type="range" id="threshold" min="0.1" max="0.8" step="0.05" value="0.3">
        </div>

        <div class="control-group">
            <label>Movement Speed: <span class="value" id="speedValue">1.0</span></label>
            <input type="range" id="speed" min="0.2" max="2" step="0.1" value="1">
        </div>

        <div class="control-group">
            <label>Personal Space: <span class="value" id="personalSpaceValue">20</span></label>
            <input type="range" id="personalSpace" min="10" max="50" value="20">
        </div>

        <div class="control-group">
            <label>Interest Diversity: <span class="value" id="diversityValue">0.5</span></label>
            <input type="range" id="diversity" min="0.1" max="1" step="0.1" value="0.5">
        </div>

        <div class="stats">
            <div class="stat-row">
                <span class="stat-label">Time:</span>
                <span class="stat-value" id="timeStep">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Clusters:</span>
                <span class="stat-value" id="clusterCount">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Avg Cluster Size:</span>
                <span class="stat-value" id="avgClusterSize">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Segregation Index:</span>
                <span class="stat-value" id="segregation">0%</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Happy People:</span>
                <span class="stat-value" id="happyCount">0%</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Conversations:</span>
                <span class="stat-value" id="conversations">0</span>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="canvas-container">
            <canvas id="simCanvas"></canvas>
            <div class="charts">
                <div class="chart-container">
                    <div class="chart-title">Happiness Over Time</div>
                    <canvas id="happyChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Interest Distribution</div>
                    <canvas id="interestChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        const simCanvas = document.getElementById('simCanvas');
        const simCtx = simCanvas.getContext('2d');
        const happyCanvas = document.getElementById('happyChart');
        const happyCtx = happyCanvas.getContext('2d');
        const interestCanvas = document.getElementById('interestChart');
        const interestCtx = interestCanvas.getContext('2d');

        let people = [];
        let running = false;
        let timeStep = 0;

        let params = {
            numPeople: 60,
            threshold: 0.3,
            speed: 1,
            personalSpace: 20,
            diversity: 0.5
        };

        let history = { happy: [], segregation: [] };
        const MAX_HISTORY = 200;

        function init() {
            resizeCanvases();
            setupControls();
            reset();
            animate();
        }

        function resizeCanvases() {
            const container = simCanvas.parentElement;
            const size = Math.min(container.clientWidth * 0.6, container.clientHeight - 40);
            simCanvas.width = size;
            simCanvas.height = size;

            document.querySelectorAll('.chart-container').forEach((c, i) => {
                const canvas = i === 0 ? happyCanvas : interestCanvas;
                canvas.width = c.clientWidth - 20;
                canvas.height = c.clientHeight - 40;
            });
        }

        function setupControls() {
            document.getElementById('startBtn').onclick = () => {
                running = !running;
                document.getElementById('startBtn').textContent = running ? 'Pause' : 'Start';
            };
            document.getElementById('resetBtn').onclick = reset;

            ['numPeople', 'threshold', 'speed', 'personalSpace', 'diversity'].forEach(id => {
                document.getElementById(id).oninput = (e) => {
                    params[id] = parseFloat(e.target.value);
                    document.getElementById(id + 'Value').textContent = params[id];
                    if (id === 'numPeople' || id === 'diversity') createPeople();
                };
            });

            window.addEventListener('resize', resizeCanvases);
        }

        function reset() {
            running = false;
            timeStep = 0;
            document.getElementById('startBtn').textContent = 'Start';
            history = { happy: [], segregation: [] };
            createPeople();
            draw();
        }

        function createPeople() {
            people = [];
            const w = simCanvas.width, h = simCanvas.height;

            for (let i = 0; i < params.numPeople; i++) {
                // Interest as hue (0-360)
                let interest;
                if (params.diversity < 0.3) {
                    // Low diversity: cluster around a few interests
                    interest = Math.floor(Math.random() * 3) * 120;
                } else if (params.diversity < 0.7) {
                    // Medium diversity
                    interest = Math.floor(Math.random() * 6) * 60;
                } else {
                    // High diversity: any interest
                    interest = Math.random() * 360;
                }

                // Add some variation
                interest += (Math.random() - 0.5) * 30 * params.diversity;
                interest = (interest + 360) % 360;

                people.push({
                    x: 50 + Math.random() * (w - 100),
                    y: 50 + Math.random() * (h - 100),
                    vx: 0,
                    vy: 0,
                    interest: interest,
                    introversion: 0.3 + Math.random() * 0.7, // Affects personal space
                    happy: false,
                    talking: false,
                    talkPartner: null
                });
            }
        }

        function similarity(p1, p2) {
            // Circular distance on hue wheel
            let diff = Math.abs(p1.interest - p2.interest);
            if (diff > 180) diff = 360 - diff;
            return 1 - diff / 180;
        }

        function update() {
            timeStep++;
            const w = simCanvas.width, h = simCanvas.height;

            // Reset states
            people.forEach(p => {
                p.talking = false;
                p.talkPartner = null;
            });

            people.forEach(p => {
                let fx = 0, fy = 0;
                let nearSimilar = 0;

                people.forEach(other => {
                    if (other === p) return;

                    const dx = other.x - p.x;
                    const dy = other.y - p.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < 1) return;

                    const sim = similarity(p, other);
                    const space = params.personalSpace * p.introversion;

                    if (dist < space * 2) {
                        // Check for conversation
                        if (sim > 0.7 && dist < space * 1.5) {
                            p.talking = true;
                            p.talkPartner = other;
                        }
                    }

                    if (sim > params.threshold) {
                        // Attracted to similar people
                        if (dist > space) {
                            const strength = sim * 0.5 / dist;
                            fx += dx * strength;
                            fy += dy * strength;
                        }
                        if (dist < space * 2) nearSimilar++;
                    }

                    // Repulsion at close range
                    if (dist < space) {
                        const repulsion = (space - dist) / space * 2;
                        fx -= dx / dist * repulsion;
                        fy -= dy / dist * repulsion;
                    }
                });

                // Happy if near similar people
                p.happy = nearSimilar >= 2;

                // Update velocity
                p.vx = p.vx * 0.8 + fx * params.speed;
                p.vy = p.vy * 0.8 + fy * params.speed;

                // Random walk component
                p.vx += (Math.random() - 0.5) * 0.3;
                p.vy += (Math.random() - 0.5) * 0.3;

                // Limit speed
                const speed = Math.sqrt(p.vx * p.vx + p.vy * p.vy);
                if (speed > 3) {
                    p.vx = p.vx / speed * 3;
                    p.vy = p.vy / speed * 3;
                }

                // Update position
                p.x += p.vx;
                p.y += p.vy;

                // Boundaries
                if (p.x < 30) { p.x = 30; p.vx *= -0.5; }
                if (p.x > w - 30) { p.x = w - 30; p.vx *= -0.5; }
                if (p.y < 30) { p.y = 30; p.vy *= -0.5; }
                if (p.y > h - 30) { p.y = h - 30; p.vy *= -0.5; }
            });

            updateStats();
        }

        function updateStats() {
            // Count clusters (connected components of similar neighbors)
            const visited = new Set();
            let clusters = [];

            people.forEach((p, i) => {
                if (visited.has(i)) return;

                const cluster = [];
                const queue = [i];
                visited.add(i);

                while (queue.length > 0) {
                    const idx = queue.shift();
                    cluster.push(idx);

                    people.forEach((other, j) => {
                        if (visited.has(j)) return;
                        const dx = other.x - people[idx].x;
                        const dy = other.y - people[idx].y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        if (dist < params.personalSpace * 3 && similarity(people[idx], other) > params.threshold) {
                            visited.add(j);
                            queue.push(j);
                        }
                    });
                }

                if (cluster.length >= 2) clusters.push(cluster);
            });

            const clusterCount = clusters.length;
            const avgClusterSize = clusters.length > 0 ?
                clusters.reduce((s, c) => s + c.length, 0) / clusters.length : 0;

            // Segregation: how much people cluster by interest
            let segregation = 0;
            clusters.forEach(cluster => {
                const interests = cluster.map(i => people[i].interest);
                const avgInterest = interests.reduce((a, b) => a + b, 0) / interests.length;
                const variance = interests.reduce((s, i) => {
                    let diff = Math.abs(i - avgInterest);
                    if (diff > 180) diff = 360 - diff;
                    return s + diff * diff;
                }, 0) / interests.length;
                segregation += 1 - Math.sqrt(variance) / 180;
            });
            segregation = clusters.length > 0 ? segregation / clusters.length : 0;

            const happyCount = people.filter(p => p.happy).length;
            const conversations = people.filter(p => p.talking).length / 2;

            document.getElementById('timeStep').textContent = timeStep;
            document.getElementById('clusterCount').textContent = clusterCount;
            document.getElementById('avgClusterSize').textContent = avgClusterSize.toFixed(1);
            document.getElementById('segregation').textContent = Math.round(segregation * 100) + '%';
            document.getElementById('happyCount').textContent = Math.round(happyCount / people.length * 100) + '%';
            document.getElementById('conversations').textContent = Math.round(conversations);

            // History
            history.happy.push(happyCount / people.length * 100);
            history.segregation.push(segregation * 100);
            if (history.happy.length > MAX_HISTORY) {
                history.happy.shift();
                history.segregation.shift();
            }
        }

        function draw() {
            drawSimulation();
            drawHappyChart();
            drawInterestChart();
        }

        function drawSimulation() {
            const w = simCanvas.width, h = simCanvas.height;

            // Party background
            simCtx.fillStyle = '#1a1a28';
            simCtx.fillRect(0, 0, w, h);

            // Dance floor pattern
            simCtx.strokeStyle = 'rgba(255,255,255,0.05)';
            simCtx.lineWidth = 1;
            for (let x = 0; x < w; x += 50) {
                simCtx.beginPath();
                simCtx.moveTo(x, 0);
                simCtx.lineTo(x, h);
                simCtx.stroke();
            }
            for (let y = 0; y < h; y += 50) {
                simCtx.beginPath();
                simCtx.moveTo(0, y);
                simCtx.lineTo(w, y);
                simCtx.stroke();
            }

            // Draw conversation lines
            simCtx.strokeStyle = 'rgba(255,255,255,0.2)';
            simCtx.lineWidth = 1;
            people.forEach(p => {
                if (p.talking && p.talkPartner) {
                    simCtx.beginPath();
                    simCtx.moveTo(p.x, p.y);
                    simCtx.lineTo(p.talkPartner.x, p.talkPartner.y);
                    simCtx.stroke();
                }
            });

            // Draw people
            people.forEach(p => {
                const radius = 8 + (1 - p.introversion) * 6; // Extroverts bigger

                // Glow for happy people
                if (p.happy) {
                    simCtx.fillStyle = `hsla(${p.interest}, 70%, 60%, 0.3)`;
                    simCtx.beginPath();
                    simCtx.arc(p.x, p.y, radius + 8, 0, Math.PI * 2);
                    simCtx.fill();
                }

                // Person circle
                simCtx.fillStyle = `hsl(${p.interest}, 70%, ${p.talking ? 70 : 55}%)`;
                simCtx.beginPath();
                simCtx.arc(p.x, p.y, radius, 0, Math.PI * 2);
                simCtx.fill();

                // Border
                simCtx.strokeStyle = p.happy ? '#fff' : 'rgba(255,255,255,0.3)';
                simCtx.lineWidth = p.happy ? 2 : 1;
                simCtx.stroke();
            });
        }

        function drawHappyChart() {
            const w = happyCanvas.width, h = happyCanvas.height;
            happyCtx.fillStyle = 'rgba(0,0,0,0.3)';
            happyCtx.fillRect(0, 0, w, h);

            if (history.happy.length < 2) return;

            // Grid
            happyCtx.strokeStyle = 'rgba(255,255,255,0.1)';
            happyCtx.beginPath();
            happyCtx.moveTo(0, h/2);
            happyCtx.lineTo(w, h/2);
            happyCtx.stroke();

            // Happy line
            happyCtx.strokeStyle = '#ec4899';
            happyCtx.lineWidth = 2;
            happyCtx.beginPath();
            history.happy.forEach((v, i) => {
                const x = (i / MAX_HISTORY) * w;
                const y = h - (v / 100) * h;
                if (i === 0) happyCtx.moveTo(x, y);
                else happyCtx.lineTo(x, y);
            });
            happyCtx.stroke();

            // Segregation line
            happyCtx.strokeStyle = '#8b5cf6';
            happyCtx.lineWidth = 1;
            happyCtx.setLineDash([5, 5]);
            happyCtx.beginPath();
            history.segregation.forEach((v, i) => {
                const x = (i / MAX_HISTORY) * w;
                const y = h - (v / 100) * h;
                if (i === 0) happyCtx.moveTo(x, y);
                else happyCtx.lineTo(x, y);
            });
            happyCtx.stroke();
            happyCtx.setLineDash([]);

            // Labels
            happyCtx.fillStyle = '#666';
            happyCtx.font = '9px sans-serif';
            happyCtx.fillText('100%', 2, 10);
            happyCtx.fillText('0%', 2, h - 2);
        }

        function drawInterestChart() {
            const w = interestCanvas.width, h = interestCanvas.height;
            interestCtx.fillStyle = 'rgba(0,0,0,0.3)';
            interestCtx.fillRect(0, 0, w, h);

            // Build histogram of interests
            const bins = 12;
            const histogram = new Array(bins).fill(0);
            people.forEach(p => {
                const bin = Math.floor(p.interest / 360 * bins) % bins;
                histogram[bin]++;
            });

            const maxCount = Math.max(...histogram, 1);
            const barWidth = w / bins;

            histogram.forEach((count, i) => {
                const hue = (i / bins) * 360;
                const barHeight = (count / maxCount) * (h - 20);

                interestCtx.fillStyle = `hsl(${hue}, 70%, 50%)`;
                interestCtx.fillRect(i * barWidth + 2, h - 10 - barHeight, barWidth - 4, barHeight);
            });

            // Labels
            interestCtx.fillStyle = '#666';
            interestCtx.font = '9px sans-serif';
            interestCtx.fillText('Interest Groups', 5, 12);
        }

        function animate() {
            if (running) update();
            draw();
            requestAnimationFrame(animate);
        }

        init();
    </script>
</body>
</html>
