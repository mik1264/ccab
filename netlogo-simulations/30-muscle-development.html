<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Muscle Development - Cell Differentiation - CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0d1117; color: #e6e6e6; overflow: hidden; }
        #container { display: flex; height: 100vh; }
        #canvas-container { flex: 1; position: relative; }
        canvas { display: block; width: 100%; height: 100%; }
        #controls { width: 300px; background: rgba(0,0,0,0.9); padding: 20px; overflow-y: auto; }
        h1 { font-size: 1.1rem; margin-bottom: 10px; color: #ff6b6b; }
        .description { font-size: 0.75rem; color: #888; margin-bottom: 15px; line-height: 1.5; }
        .control-group { margin-bottom: 12px; }
        label { display: block; font-size: 0.75rem; margin-bottom: 3px; color: #aaa; }
        input[type="range"] { width: 100%; }
        button { width: 100%; padding: 10px; margin-bottom: 8px; background: #ff6b6b; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: #ee5a5a; }
        .stats { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 5px; font-size: 0.75rem; margin-bottom: 15px; }
        .stats div { margin-bottom: 4px; }
        .back-link { position: fixed; top: 10px; left: 10px; padding: 8px 16px; background: rgba(0,0,0,0.8); color: #ff6b6b; text-decoration: none; border-radius: 6px; font-size: 14px; z-index: 999; }
        .legend { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .legend-item { display: flex; align-items: center; gap: 4px; font-size: 0.7rem; }
        .legend-dot { width: 12px; height: 12px; border-radius: 3px; }
        .phase { padding: 8px; background: rgba(255,107,107,0.2); border-radius: 5px; margin-bottom: 10px; font-size: 0.8rem; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back</a>
    <div id="container">
        <div id="canvas-container">
            <canvas id="canvas"></canvas>
        </div>
        <div id="controls">
            <h1>Muscle Development</h1>
            <p class="description">Simulates muscle fiber formation through cell differentiation, signaling cascades, and tissue organization. Stem cells differentiate into myoblasts which fuse to form muscle fibers.</p>

            <div class="phase">Phase: <span id="phase">Proliferation</span></div>

            <div class="legend">
                <div class="legend-item"><div class="legend-dot" style="background:#4ade80"></div>Stem Cell</div>
                <div class="legend-item"><div class="legend-dot" style="background:#60a5fa"></div>Myoblast</div>
                <div class="legend-item"><div class="legend-dot" style="background:#f472b6"></div>Fusing</div>
                <div class="legend-item"><div class="legend-dot" style="background:#ef4444"></div>Muscle Fiber</div>
                <div class="legend-item"><div class="legend-dot" style="background:#fbbf24"></div>Signal</div>
            </div>

            <div class="stats">
                <div>Stem Cells: <span id="stemCount">0</span></div>
                <div>Myoblasts: <span id="myoblastCount">0</span></div>
                <div>Muscle Fibers: <span id="fiberCount">0</span></div>
                <div>Total Cells: <span id="totalCount">0</span></div>
                <div>Time Step: <span id="timeStep">0</span></div>
            </div>

            <div class="control-group">
                <label>Differentiation Rate: <span id="diffRateVal">0.02</span></label>
                <input type="range" id="diffRate" min="0.005" max="0.05" step="0.005" value="0.02">
            </div>

            <div class="control-group">
                <label>Fusion Probability: <span id="fusionProbVal">0.1</span></label>
                <input type="range" id="fusionProb" min="0.02" max="0.3" step="0.02" value="0.1">
            </div>

            <div class="control-group">
                <label>Signal Strength: <span id="signalStrengthVal">0.5</span></label>
                <input type="range" id="signalStrength" min="0.1" max="1.0" step="0.1" value="0.5">
            </div>

            <div class="control-group">
                <label>Proliferation Rate: <span id="prolifRateVal">0.01</span></label>
                <input type="range" id="prolifRate" min="0.005" max="0.03" step="0.005" value="0.01">
            </div>

            <button onclick="reset()">Reset Simulation</button>
            <button onclick="togglePause()">Pause / Resume</button>
            <button onclick="injectSignal()">Inject Growth Signal</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
        }
        resize();
        window.addEventListener('resize', resize);

        // Cell types
        const STEM = 0, MYOBLAST = 1, FUSING = 2, FIBER = 3;
        const COLORS = {
            [STEM]: '#4ade80',
            [MYOBLAST]: '#60a5fa',
            [FUSING]: '#f472b6',
            [FIBER]: '#ef4444'
        };

        let cells = [];
        let signals = [];
        let fibers = [];
        let paused = false;
        let timeStep = 0;

        // Parameters
        let diffRate = 0.02;
        let fusionProb = 0.1;
        let signalStrength = 0.5;
        let prolifRate = 0.01;

        class Cell {
            constructor(x, y, type = STEM) {
                this.x = x;
                this.y = y;
                this.type = type;
                this.vx = (Math.random() - 0.5) * 2;
                this.vy = (Math.random() - 0.5) * 2;
                this.radius = type === FIBER ? 8 : 6;
                this.age = 0;
                this.signalExposure = 0;
                this.fusionPartner = null;
                this.fiberId = null;
            }

            update() {
                this.age++;

                // Movement (except fibers)
                if (this.type !== FIBER) {
                    // Random walk with alignment tendency for myoblasts
                    this.vx += (Math.random() - 0.5) * 0.5;
                    this.vy += (Math.random() - 0.5) * 0.5;

                    // Myoblasts attract to each other
                    if (this.type === MYOBLAST || this.type === FUSING) {
                        cells.forEach(other => {
                            if (other !== this && (other.type === MYOBLAST || other.type === FUSING)) {
                                const dx = other.x - this.x;
                                const dy = other.y - this.y;
                                const dist = Math.sqrt(dx * dx + dy * dy);
                                if (dist > 20 && dist < 100) {
                                    this.vx += dx / dist * 0.1;
                                    this.vy += dy / dist * 0.1;
                                }
                            }
                        });
                    }

                    // Limit speed
                    const speed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
                    if (speed > 3) {
                        this.vx = (this.vx / speed) * 3;
                        this.vy = (this.vy / speed) * 3;
                    }

                    this.x += this.vx;
                    this.y += this.vy;

                    // Boundary collision
                    if (this.x < this.radius) { this.x = this.radius; this.vx *= -0.5; }
                    if (this.x > canvas.width - this.radius) { this.x = canvas.width - this.radius; this.vx *= -0.5; }
                    if (this.y < this.radius) { this.y = this.radius; this.vy *= -0.5; }
                    if (this.y > canvas.height - this.radius) { this.y = canvas.height - this.radius; this.vy *= -0.5; }
                }

                // Signal decay
                this.signalExposure *= 0.99;

                // Differentiation: Stem -> Myoblast
                if (this.type === STEM && this.signalExposure > 0.3) {
                    if (Math.random() < diffRate * this.signalExposure) {
                        this.type = MYOBLAST;
                        this.radius = 6;
                    }
                }

                // Fusion: Myoblast -> Fusing -> Fiber
                if (this.type === MYOBLAST) {
                    // Find nearby myoblasts to fuse with
                    cells.forEach(other => {
                        if (other !== this && other.type === MYOBLAST && !other.fusionPartner) {
                            const dx = other.x - this.x;
                            const dy = other.y - this.y;
                            const dist = Math.sqrt(dx * dx + dy * dy);
                            if (dist < 20 && Math.random() < fusionProb) {
                                this.type = FUSING;
                                other.type = FUSING;
                                this.fusionPartner = other;
                                other.fusionPartner = this;
                            }
                        }
                    });
                }

                // Complete fusion after delay
                if (this.type === FUSING && this.fusionPartner) {
                    if (this.age % 30 === 0) {
                        // Create fiber
                        const midX = (this.x + this.fusionPartner.x) / 2;
                        const midY = (this.y + this.fusionPartner.y) / 2;
                        const angle = Math.atan2(this.fusionPartner.y - this.y, this.fusionPartner.x - this.x);

                        fibers.push({
                            x: midX,
                            y: midY,
                            angle: angle,
                            length: 40,
                            width: 10,
                            nuclei: 2
                        });

                        // Remove fusing cells
                        cells = cells.filter(c => c !== this && c !== this.fusionPartner);
                    }
                }
            }

            draw() {
                ctx.fillStyle = COLORS[this.type];
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fill();

                // Signal exposure indicator
                if (this.signalExposure > 0.1) {
                    ctx.strokeStyle = `rgba(251, 191, 36, ${this.signalExposure})`;
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            }
        }

        class Signal {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.radius = 0;
                this.maxRadius = 150;
                this.strength = signalStrength;
            }

            update() {
                this.radius += 3;
                this.strength *= 0.98;

                // Affect nearby cells
                cells.forEach(cell => {
                    const dx = cell.x - this.x;
                    const dy = cell.y - this.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < this.radius && dist > this.radius - 20) {
                        cell.signalExposure += this.strength * 0.1;
                    }
                });

                return this.radius < this.maxRadius && this.strength > 0.01;
            }

            draw() {
                ctx.strokeStyle = `rgba(251, 191, 36, ${this.strength * 0.5})`;
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.stroke();
            }
        }

        function init() {
            cells = [];
            signals = [];
            fibers = [];
            timeStep = 0;

            // Create initial stem cells
            for (let i = 0; i < 80; i++) {
                cells.push(new Cell(
                    100 + Math.random() * (canvas.width - 200),
                    100 + Math.random() * (canvas.height - 200),
                    STEM
                ));
            }

            // Initial differentiation signals
            for (let i = 0; i < 3; i++) {
                signals.push(new Signal(
                    canvas.width * (0.25 + Math.random() * 0.5),
                    canvas.height * (0.25 + Math.random() * 0.5)
                ));
            }
        }

        function drawFibers() {
            fibers.forEach(fiber => {
                ctx.save();
                ctx.translate(fiber.x, fiber.y);
                ctx.rotate(fiber.angle);

                // Fiber body
                ctx.fillStyle = '#ef4444';
                ctx.beginPath();
                ctx.roundRect(-fiber.length / 2, -fiber.width / 2, fiber.length, fiber.width, 5);
                ctx.fill();

                // Striations
                ctx.strokeStyle = 'rgba(0,0,0,0.3)';
                ctx.lineWidth = 1;
                for (let x = -fiber.length / 2 + 5; x < fiber.length / 2; x += 8) {
                    ctx.beginPath();
                    ctx.moveTo(x, -fiber.width / 2);
                    ctx.lineTo(x, fiber.width / 2);
                    ctx.stroke();
                }

                // Nuclei
                ctx.fillStyle = '#7f1d1d';
                for (let i = 0; i < fiber.nuclei; i++) {
                    const nx = -fiber.length / 4 + (fiber.length / 2) * (i / (fiber.nuclei - 1 || 1));
                    ctx.beginPath();
                    ctx.ellipse(nx, 0, 4, 3, 0, 0, Math.PI * 2);
                    ctx.fill();
                }

                ctx.restore();
            });
        }

        function update() {
            if (paused) return;

            timeStep++;

            // Update signals
            signals = signals.filter(s => s.update());

            // Update cells
            cells.forEach(cell => cell.update());

            // Proliferation
            if (Math.random() < prolifRate && cells.length < 200) {
                const stemCells = cells.filter(c => c.type === STEM);
                if (stemCells.length > 0) {
                    const parent = stemCells[Math.floor(Math.random() * stemCells.length)];
                    const angle = Math.random() * Math.PI * 2;
                    cells.push(new Cell(
                        parent.x + Math.cos(angle) * 15,
                        parent.y + Math.sin(angle) * 15,
                        STEM
                    ));
                }
            }

            // Periodic signals
            if (timeStep % 200 === 0 && timeStep < 1000) {
                signals.push(new Signal(
                    100 + Math.random() * (canvas.width - 200),
                    100 + Math.random() * (canvas.height - 200)
                ));
            }

            // Fiber growth (existing fibers can absorb myoblasts)
            fibers.forEach(fiber => {
                cells.forEach((cell, idx) => {
                    if (cell.type === MYOBLAST) {
                        const dx = cell.x - fiber.x;
                        const dy = cell.y - fiber.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        if (dist < fiber.length / 2 + 10 && Math.random() < 0.02) {
                            fiber.length += 5;
                            fiber.nuclei++;
                            cells.splice(idx, 1);
                        }
                    }
                });
            });

            updateStats();
        }

        function draw() {
            ctx.fillStyle = '#0d1117';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw grid
            ctx.strokeStyle = 'rgba(255,255,255,0.03)';
            ctx.lineWidth = 1;
            for (let x = 0; x < canvas.width; x += 50) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            for (let y = 0; y < canvas.height; y += 50) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }

            // Draw fibers (background)
            drawFibers();

            // Draw signals
            signals.forEach(s => s.draw());

            // Draw cells
            cells.forEach(cell => cell.draw());
        }

        function updateStats() {
            const counts = { [STEM]: 0, [MYOBLAST]: 0, [FUSING]: 0, [FIBER]: 0 };
            cells.forEach(c => counts[c.type]++);

            document.getElementById('stemCount').textContent = counts[STEM];
            document.getElementById('myoblastCount').textContent = counts[MYOBLAST] + counts[FUSING];
            document.getElementById('fiberCount').textContent = fibers.length;
            document.getElementById('totalCount').textContent = cells.length;
            document.getElementById('timeStep').textContent = timeStep;

            // Phase determination
            let phase = 'Proliferation';
            if (counts[MYOBLAST] > counts[STEM]) phase = 'Differentiation';
            if (fibers.length > 5) phase = 'Fusion';
            if (fibers.length > 15) phase = 'Maturation';
            document.getElementById('phase').textContent = phase;
        }

        function reset() {
            init();
        }

        function togglePause() {
            paused = !paused;
        }

        function injectSignal() {
            signals.push(new Signal(
                100 + Math.random() * (canvas.width - 200),
                100 + Math.random() * (canvas.height - 200)
            ));
        }

        // Event listeners
        document.getElementById('diffRate').addEventListener('input', function() {
            diffRate = parseFloat(this.value);
            document.getElementById('diffRateVal').textContent = this.value;
        });

        document.getElementById('fusionProb').addEventListener('input', function() {
            fusionProb = parseFloat(this.value);
            document.getElementById('fusionProbVal').textContent = this.value;
        });

        document.getElementById('signalStrength').addEventListener('input', function() {
            signalStrength = parseFloat(this.value);
            document.getElementById('signalStrengthVal').textContent = this.value;
        });

        document.getElementById('prolifRate').addEventListener('input', function() {
            prolifRate = parseFloat(this.value);
            document.getElementById('prolifRateVal').textContent = this.value;
        });

        function animate() {
            update();
            draw();
            requestAnimationFrame(animate);
        }

        init();
        animate();
    </script>
</body>
</html>
