<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ant Adaptation - Evolutionary Foraging - CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1612; color: #e6e6e6; overflow: hidden; }
        #container { display: flex; height: 100vh; }
        #canvas-container { flex: 1; position: relative; }
        canvas { display: block; width: 100%; height: 100%; }
        #controls { width: 300px; background: rgba(0,0,0,0.9); padding: 20px; overflow-y: auto; }
        h1 { font-size: 1.1rem; margin-bottom: 10px; color: #f59e0b; }
        .description { font-size: 0.75rem; color: #888; margin-bottom: 15px; line-height: 1.5; }
        .control-group { margin-bottom: 12px; }
        label { display: block; font-size: 0.75rem; margin-bottom: 3px; color: #aaa; }
        input[type="range"] { width: 100%; }
        button { width: 100%; padding: 10px; margin-bottom: 8px; background: #f59e0b; color: #000; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: #d97706; }
        .stats { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 5px; font-size: 0.75rem; margin-bottom: 15px; }
        .stats div { margin-bottom: 4px; }
        .back-link { position: fixed; top: 10px; left: 10px; padding: 8px 16px; background: rgba(0,0,0,0.8); color: #f59e0b; text-decoration: none; border-radius: 6px; font-size: 14px; z-index: 999; }
        .genome-display { font-family: monospace; font-size: 0.7rem; background: rgba(0,0,0,0.5); padding: 8px; border-radius: 4px; margin-bottom: 10px; overflow-x: auto; }
        .legend { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .legend-item { display: flex; align-items: center; gap: 4px; font-size: 0.7rem; }
        .legend-dot { width: 12px; height: 12px; border-radius: 50%; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back</a>
    <div id="container">
        <div id="canvas-container">
            <canvas id="canvas"></canvas>
        </div>
        <div id="controls">
            <h1>Ant Adaptation</h1>
            <p class="description">Evolutionary ant foraging where pheromone sensitivity and deposition rates evolve through genetic algorithms based on colony success.</p>

            <div class="legend">
                <div class="legend-item"><div class="legend-dot" style="background:#f59e0b"></div>Ant</div>
                <div class="legend-item"><div class="legend-dot" style="background:#22c55e"></div>Food</div>
                <div class="legend-item"><div class="legend-dot" style="background:#6366f1"></div>Pheromone</div>
                <div class="legend-item"><div class="legend-dot" style="background:#a855f7"></div>Nest</div>
            </div>

            <div class="stats">
                <div>Generation: <span id="generation">1</span></div>
                <div>Food Collected: <span id="foodCollected">0</span></div>
                <div>Active Ants: <span id="antCount">0</span></div>
                <div>Best Fitness: <span id="bestFitness">0</span></div>
                <div>Avg Sensitivity: <span id="avgSens">0.5</span></div>
                <div>Avg Deposition: <span id="avgDep">0.5</span></div>
            </div>

            <div class="genome-display">
                Best Genome:<br>
                <span id="bestGenome">sens: 0.50, dep: 0.50, explore: 0.50</span>
            </div>

            <div class="control-group">
                <label>Mutation Rate: <span id="mutRateVal">0.1</span></label>
                <input type="range" id="mutRate" min="0.01" max="0.3" step="0.01" value="0.1">
            </div>

            <div class="control-group">
                <label>Generation Length: <span id="genLengthVal">500</span> steps</label>
                <input type="range" id="genLength" min="200" max="1000" step="50" value="500">
            </div>

            <div class="control-group">
                <label>Population Size: <span id="popSizeVal">30</span></label>
                <input type="range" id="popSize" min="10" max="60" step="5" value="30">
            </div>

            <div class="control-group">
                <label>Pheromone Evaporation: <span id="evapRateVal">0.995</span></label>
                <input type="range" id="evapRate" min="0.98" max="1.0" step="0.002" value="0.995">
            </div>

            <button onclick="reset()">Reset Evolution</button>
            <button onclick="togglePause()">Pause / Resume</button>
            <button onclick="nextGeneration()">Force Next Generation</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
            initPheromoneGrid();
        }
        resize();
        window.addEventListener('resize', resize);

        // Grid for pheromones
        const CELL_SIZE = 8;
        let gridWidth, gridHeight;
        let pheromones;

        function initPheromoneGrid() {
            gridWidth = Math.ceil(canvas.width / CELL_SIZE);
            gridHeight = Math.ceil(canvas.height / CELL_SIZE);
            pheromones = new Float32Array(gridWidth * gridHeight);
        }

        // State
        let ants = [];
        let foods = [];
        let nest = { x: 0, y: 0 };
        let generation = 1;
        let stepInGeneration = 0;
        let totalFoodCollected = 0;
        let paused = false;

        // Parameters
        let mutRate = 0.1;
        let genLength = 500;
        let popSize = 30;
        let evapRate = 0.995;

        class Genome {
            constructor(sensitivity = null, deposition = null, exploration = null) {
                this.sensitivity = sensitivity ?? Math.random();      // How much ant follows pheromones
                this.deposition = deposition ?? Math.random();        // How much pheromone ant deposits
                this.exploration = exploration ?? Math.random() * 0.5 + 0.1; // Random wandering factor
            }

            mutate(rate) {
                const mutated = new Genome(this.sensitivity, this.deposition, this.exploration);
                if (Math.random() < rate) mutated.sensitivity = Math.max(0, Math.min(1, mutated.sensitivity + (Math.random() - 0.5) * 0.3));
                if (Math.random() < rate) mutated.deposition = Math.max(0, Math.min(1, mutated.deposition + (Math.random() - 0.5) * 0.3));
                if (Math.random() < rate) mutated.exploration = Math.max(0.05, Math.min(0.8, mutated.exploration + (Math.random() - 0.5) * 0.2));
                return mutated;
            }

            crossover(other) {
                return new Genome(
                    Math.random() < 0.5 ? this.sensitivity : other.sensitivity,
                    Math.random() < 0.5 ? this.deposition : other.deposition,
                    Math.random() < 0.5 ? this.exploration : other.exploration
                );
            }
        }

        class Ant {
            constructor(genome, x, y) {
                this.genome = genome;
                this.x = x;
                this.y = y;
                this.angle = Math.random() * Math.PI * 2;
                this.hasFood = false;
                this.foodCollected = 0;
            }

            update() {
                // Determine target direction
                let targetAngle = this.angle;

                if (this.hasFood) {
                    // Go back to nest
                    targetAngle = Math.atan2(nest.y - this.y, nest.x - this.x);

                    // Deposit pheromone
                    const gx = Math.floor(this.x / CELL_SIZE);
                    const gy = Math.floor(this.y / CELL_SIZE);
                    if (gx >= 0 && gx < gridWidth && gy >= 0 && gy < gridHeight) {
                        pheromones[gy * gridWidth + gx] += this.genome.deposition * 2;
                    }
                } else {
                    // Follow pheromones or explore
                    const sensedPheromone = this.sensePheromone();

                    if (sensedPheromone.strength > 0.1 && Math.random() < this.genome.sensitivity) {
                        targetAngle = sensedPheromone.angle;
                    }

                    // Check for food
                    foods.forEach(food => {
                        if (!food.depleted) {
                            const dx = food.x - this.x;
                            const dy = food.y - this.y;
                            const dist = Math.sqrt(dx * dx + dy * dy);
                            if (dist < 15) {
                                this.hasFood = true;
                                this.foodCollected++;
                                totalFoodCollected++;
                                food.amount--;
                                if (food.amount <= 0) food.depleted = true;
                            }
                        }
                    });
                }

                // Add randomness based on exploration gene
                targetAngle += (Math.random() - 0.5) * Math.PI * this.genome.exploration;

                // Smooth turning
                let angleDiff = targetAngle - this.angle;
                while (angleDiff > Math.PI) angleDiff -= Math.PI * 2;
                while (angleDiff < -Math.PI) angleDiff += Math.PI * 2;
                this.angle += angleDiff * 0.3;

                // Move
                const speed = 3;
                this.x += Math.cos(this.angle) * speed;
                this.y += Math.sin(this.angle) * speed;

                // Boundary
                if (this.x < 10) { this.x = 10; this.angle = Math.PI - this.angle; }
                if (this.x > canvas.width - 10) { this.x = canvas.width - 10; this.angle = Math.PI - this.angle; }
                if (this.y < 10) { this.y = 10; this.angle = -this.angle; }
                if (this.y > canvas.height - 10) { this.y = canvas.height - 10; this.angle = -this.angle; }

                // Check if at nest with food
                if (this.hasFood) {
                    const dx = nest.x - this.x;
                    const dy = nest.y - this.y;
                    if (Math.sqrt(dx * dx + dy * dy) < 30) {
                        this.hasFood = false;
                    }
                }
            }

            sensePheromone() {
                let maxStrength = 0;
                let maxAngle = this.angle;

                // Check in front in a cone
                for (let da = -Math.PI / 3; da <= Math.PI / 3; da += Math.PI / 12) {
                    const checkAngle = this.angle + da;
                    const checkDist = 25;
                    const cx = Math.floor((this.x + Math.cos(checkAngle) * checkDist) / CELL_SIZE);
                    const cy = Math.floor((this.y + Math.sin(checkAngle) * checkDist) / CELL_SIZE);

                    if (cx >= 0 && cx < gridWidth && cy >= 0 && cy < gridHeight) {
                        const strength = pheromones[cy * gridWidth + cx];
                        if (strength > maxStrength) {
                            maxStrength = strength;
                            maxAngle = checkAngle;
                        }
                    }
                }

                return { strength: maxStrength, angle: maxAngle };
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle);

                // Body
                ctx.fillStyle = this.hasFood ? '#22c55e' : '#f59e0b';
                ctx.beginPath();
                ctx.ellipse(0, 0, 6, 4, 0, 0, Math.PI * 2);
                ctx.fill();

                // Head
                ctx.beginPath();
                ctx.arc(5, 0, 3, 0, Math.PI * 2);
                ctx.fill();

                // Antennae
                ctx.strokeStyle = this.hasFood ? '#22c55e' : '#f59e0b';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(6, -1);
                ctx.lineTo(10, -4);
                ctx.moveTo(6, 1);
                ctx.lineTo(10, 4);
                ctx.stroke();

                ctx.restore();
            }
        }

        function createFood() {
            return {
                x: 100 + Math.random() * (canvas.width - 200),
                y: 100 + Math.random() * (canvas.height - 200),
                amount: 20 + Math.floor(Math.random() * 30),
                depleted: false
            };
        }

        function init() {
            nest = { x: 80, y: canvas.height / 2 };

            // Create initial food sources
            foods = [];
            for (let i = 0; i < 5; i++) {
                foods.push(createFood());
            }

            // Create initial population with random genomes
            ants = [];
            for (let i = 0; i < popSize; i++) {
                ants.push(new Ant(
                    new Genome(),
                    nest.x + (Math.random() - 0.5) * 40,
                    nest.y + (Math.random() - 0.5) * 40
                ));
            }

            initPheromoneGrid();
            generation = 1;
            stepInGeneration = 0;
            totalFoodCollected = 0;
        }

        function nextGeneration() {
            // Sort by fitness (food collected)
            ants.sort((a, b) => b.foodCollected - a.foodCollected);

            // Update best genome display
            const best = ants[0];
            document.getElementById('bestGenome').textContent =
                `sens: ${best.genome.sensitivity.toFixed(2)}, dep: ${best.genome.deposition.toFixed(2)}, explore: ${best.genome.exploration.toFixed(2)}`;
            document.getElementById('bestFitness').textContent = best.foodCollected;

            // Calculate averages
            const avgSens = ants.reduce((s, a) => s + a.genome.sensitivity, 0) / ants.length;
            const avgDep = ants.reduce((s, a) => s + a.genome.deposition, 0) / ants.length;
            document.getElementById('avgSens').textContent = avgSens.toFixed(3);
            document.getElementById('avgDep').textContent = avgDep.toFixed(3);

            // Create new generation
            const newAnts = [];
            const eliteCount = Math.floor(popSize * 0.2);

            // Keep elite
            for (let i = 0; i < eliteCount; i++) {
                newAnts.push(new Ant(
                    ants[i].genome,
                    nest.x + (Math.random() - 0.5) * 40,
                    nest.y + (Math.random() - 0.5) * 40
                ));
            }

            // Create offspring
            while (newAnts.length < popSize) {
                // Tournament selection
                const tournament = () => {
                    const a = ants[Math.floor(Math.random() * ants.length)];
                    const b = ants[Math.floor(Math.random() * ants.length)];
                    return a.foodCollected > b.foodCollected ? a : b;
                };

                const parent1 = tournament();
                const parent2 = tournament();
                const childGenome = parent1.genome.crossover(parent2.genome).mutate(mutRate);

                newAnts.push(new Ant(
                    childGenome,
                    nest.x + (Math.random() - 0.5) * 40,
                    nest.y + (Math.random() - 0.5) * 40
                ));
            }

            ants = newAnts;

            // Replenish food
            foods = foods.filter(f => !f.depleted);
            while (foods.length < 5) {
                foods.push(createFood());
            }

            // Reset pheromones partially
            for (let i = 0; i < pheromones.length; i++) {
                pheromones[i] *= 0.5;
            }

            generation++;
            stepInGeneration = 0;
        }

        function update() {
            if (paused) return;

            stepInGeneration++;

            // Evaporate pheromones
            for (let i = 0; i < pheromones.length; i++) {
                pheromones[i] *= evapRate;
            }

            // Update ants
            ants.forEach(ant => ant.update());

            // Check for generation end
            if (stepInGeneration >= genLength) {
                nextGeneration();
            }

            updateStats();
        }

        function draw() {
            ctx.fillStyle = '#1a1612';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw pheromones
            for (let y = 0; y < gridHeight; y++) {
                for (let x = 0; x < gridWidth; x++) {
                    const value = pheromones[y * gridWidth + x];
                    if (value > 0.05) {
                        ctx.fillStyle = `rgba(99, 102, 241, ${Math.min(value * 0.3, 0.8)})`;
                        ctx.fillRect(x * CELL_SIZE, y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
                    }
                }
            }

            // Draw nest
            ctx.fillStyle = '#a855f7';
            ctx.beginPath();
            ctx.arc(nest.x, nest.y, 25, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#7c3aed';
            ctx.beginPath();
            ctx.arc(nest.x, nest.y, 15, 0, Math.PI * 2);
            ctx.fill();

            // Draw food
            foods.forEach(food => {
                if (!food.depleted) {
                    const size = 8 + food.amount * 0.3;
                    ctx.fillStyle = '#22c55e';
                    ctx.beginPath();
                    ctx.arc(food.x, food.y, size, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.fillStyle = '#fff';
                    ctx.font = '10px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(food.amount, food.x, food.y + 3);
                }
            });

            // Draw ants
            ants.forEach(ant => ant.draw());
        }

        function updateStats() {
            document.getElementById('generation').textContent = generation;
            document.getElementById('foodCollected').textContent = totalFoodCollected;
            document.getElementById('antCount').textContent = ants.length;
        }

        function reset() {
            init();
        }

        function togglePause() {
            paused = !paused;
        }

        // Event listeners
        document.getElementById('mutRate').addEventListener('input', function() {
            mutRate = parseFloat(this.value);
            document.getElementById('mutRateVal').textContent = this.value;
        });

        document.getElementById('genLength').addEventListener('input', function() {
            genLength = parseInt(this.value);
            document.getElementById('genLengthVal').textContent = this.value;
        });

        document.getElementById('popSize').addEventListener('input', function() {
            popSize = parseInt(this.value);
            document.getElementById('popSizeVal').textContent = this.value;
        });

        document.getElementById('evapRate').addEventListener('input', function() {
            evapRate = parseFloat(this.value);
            document.getElementById('evapRateVal').textContent = this.value;
        });

        function animate() {
            update();
            draw();
            requestAnimationFrame(animate);
        }

        init();
        animate();
    </script>
</body>
</html>
