<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tumor Growth - Cell Division - CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a0a1a; color: #e8e6e1; overflow: hidden; }
        #container { display: flex; height: 100vh; }
        #canvas-container { flex: 1; position: relative; }
        canvas { display: block; width: 100%; height: 100%; }
        #controls { width: 280px; background: rgba(0,0,0,0.9); padding: 20px; overflow-y: auto; }
        h1 { font-size: 1.1rem; margin-bottom: 15px; color: #f472b6; }
        .control-group { margin-bottom: 12px; }
        label { display: block; font-size: 0.75rem; margin-bottom: 3px; color: #aaa; }
        input[type="range"] { width: 100%; }
        button { width: 100%; padding: 8px; margin-bottom: 8px; background: #db2777; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 0.85rem; }
        button:hover { background: #be185d; }
        .stats { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; font-size: 0.75rem; margin-bottom: 15px; }
        .stats div { margin-bottom: 3px; }
        .back-link { position: fixed; top: 10px; left: 10px; padding: 8px 16px; background: rgba(0,0,0,0.7); color: #f472b6; text-decoration: none; border-radius: 6px; font-size: 14px; z-index: 999; }
        .description { font-size: 0.7rem; color: #888; margin-bottom: 12px; line-height: 1.4; }
        .legend { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
        .legend-item { display: flex; align-items: center; gap: 4px; font-size: 0.7rem; }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back</a>
    <div id="container">
        <div id="canvas-container">
            <canvas id="canvas"></canvas>
        </div>
        <div id="controls">
            <h1>Tumor Growth Simulation</h1>
            <p class="description">Model cancer cell division, nutrient competition, and tumor morphology. Cells compete for nutrients; starved cells become necrotic.</p>
            
            <div class="legend">
                <div class="legend-item"><div class="legend-dot" style="background:#22c55e"></div>Healthy</div>
                <div class="legend-item"><div class="legend-dot" style="background:#f472b6"></div>Cancer</div>
                <div class="legend-item"><div class="legend-dot" style="background:#7c3aed"></div>Dividing</div>
                <div class="legend-item"><div class="legend-dot" style="background:#374151"></div>Necrotic</div>
            </div>
            
            <div class="control-group">
                <label>Division Rate: <span id="divisionVal">0.02</span></label>
                <input type="range" id="division" min="0.005" max="0.05" step="0.005" value="0.02">
            </div>
            <div class="control-group">
                <label>Nutrient Diffusion: <span id="nutrientVal">0.3</span></label>
                <input type="range" id="nutrient" min="0.1" max="0.5" step="0.05" value="0.3">
            </div>
            <div class="control-group">
                <label>Mutation Rate: <span id="mutationVal">0.001</span></label>
                <input type="range" id="mutation" min="0" max="0.005" step="0.0005" value="0.001">
            </div>
            <div class="control-group">
                <label>Necrosis Threshold: <span id="necrosisVal">0.1</span></label>
                <input type="range" id="necrosis" min="0.05" max="0.3" step="0.01" value="0.1">
            </div>
            
            <button id="reset">Reset</button>
            <button id="pause">Pause</button>
            <button id="addCancer">Add Cancer Cell</button>
            <button id="treatment">Apply Treatment</button>
            
            <div class="stats">
                <div>Time: <span id="time">0</span></div>
                <div>Healthy Cells: <span id="healthy" style="color:#22c55e">0</span></div>
                <div>Cancer Cells: <span id="cancer" style="color:#f472b6">0</span></div>
                <div>Necrotic Cells: <span id="necrotic" style="color:#666">0</span></div>
                <div>Tumor Radius: <span id="radius">0</span>px</div>
            </div>
            
            <p class="description"><strong>Nutrient Competition:</strong> Cancer cells consume more nutrients. Central cells starve and become necrotic, forming the tumor core.</p>
            
            <p class="description"><strong>Treatment:</strong> Kills rapidly dividing cells but may not eliminate all cancer.</p>
        </div>
    </div>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        let W, H, COLS, ROWS, CELL = 6;
        let grid, nutrients, paused = false, time = 0;
        
        const STATE = { EMPTY: 0, HEALTHY: 1, CANCER: 2, DIVIDING: 3, NECROTIC: 4 };
        const COLORS = ['#1a0a1a', '#22c55e', '#f472b6', '#7c3aed', '#374151'];
        
        let params = {
            divisionRate: 0.02,
            nutrientDiffusion: 0.3,
            mutationRate: 0.001,
            necrosisThreshold: 0.1
        };
        
        function resize() {
            const c = document.getElementById('canvas-container');
            canvas.width = c.clientWidth;
            canvas.height = c.clientHeight;
            W = canvas.width;
            H = canvas.height;
            COLS = Math.floor(W / CELL);
            ROWS = Math.floor(H / CELL);
        }
        
        function init() {
            resize();
            time = 0;
            
            // Initialize grids
            grid = [];
            nutrients = [];
            for (let y = 0; y < ROWS; y++) {
                grid[y] = new Uint8Array(COLS);
                nutrients[y] = new Float32Array(COLS);
                for (let x = 0; x < COLS; x++) {
                    nutrients[y][x] = 1.0; // Full nutrients
                }
            }
            
            // Create tissue with healthy cells in center region
            const cx = Math.floor(COLS / 2);
            const cy = Math.floor(ROWS / 2);
            const tissueRadius = Math.min(COLS, ROWS) * 0.35;
            
            for (let y = 0; y < ROWS; y++) {
                for (let x = 0; x < COLS; x++) {
                    const dist = Math.sqrt((x - cx) ** 2 + (y - cy) ** 2);
                    if (dist < tissueRadius) {
                        grid[y][x] = STATE.HEALTHY;
                    }
                }
            }
            
            // Add initial cancer cell
            grid[cy][cx] = STATE.CANCER;
            
            updateStats();
        }
        
        function step() {
            time++;
            
            // Diffuse nutrients from edges
            const newNutrients = [];
            for (let y = 0; y < ROWS; y++) {
                newNutrients[y] = new Float32Array(COLS);
                for (let x = 0; x < COLS; x++) {
                    let sum = nutrients[y][x];
                    let count = 1;
                    
                    // Average with neighbors
                    for (let dy = -1; dy <= 1; dy++) {
                        for (let dx = -1; dx <= 1; dx++) {
                            const ny = y + dy, nx = x + dx;
                            if (ny >= 0 && ny < ROWS && nx >= 0 && nx < COLS) {
                                sum += nutrients[ny][nx];
                                count++;
                            }
                        }
                    }
                    
                    newNutrients[y][x] = nutrients[y][x] * (1 - params.nutrientDiffusion) + 
                                         (sum / count) * params.nutrientDiffusion;
                    
                    // Nutrient supply from edges
                    if (x === 0 || x === COLS - 1 || y === 0 || y === ROWS - 1) {
                        newNutrients[y][x] = Math.min(1, newNutrients[y][x] + 0.1);
                    }
                    
                    // Cells consume nutrients
                    if (grid[y][x] === STATE.HEALTHY) {
                        newNutrients[y][x] -= 0.01;
                    } else if (grid[y][x] === STATE.CANCER || grid[y][x] === STATE.DIVIDING) {
                        newNutrients[y][x] -= 0.03; // Cancer consumes more
                    }
                    
                    newNutrients[y][x] = Math.max(0, Math.min(1, newNutrients[y][x]));
                }
            }
            nutrients = newNutrients;
            
            // Cell updates
            const newGrid = [];
            for (let y = 0; y < ROWS; y++) {
                newGrid[y] = new Uint8Array(grid[y]);
            }
            
            for (let y = 1; y < ROWS - 1; y++) {
                for (let x = 1; x < COLS - 1; x++) {
                    const cell = grid[y][x];
                    const nutrient = nutrients[y][x];
                    
                    // Necrosis from starvation
                    if ((cell === STATE.HEALTHY || cell === STATE.CANCER) && 
                        nutrient < params.necrosisThreshold) {
                        if (Math.random() < 0.1) {
                            newGrid[y][x] = STATE.NECROTIC;
                            continue;
                        }
                    }
                    
                    // Cancer cell division
                    if (cell === STATE.CANCER && nutrient > 0.3) {
                        if (Math.random() < params.divisionRate) {
                            newGrid[y][x] = STATE.DIVIDING;
                            
                            // Find empty neighbor or push
                            const dirs = [[-1,0], [1,0], [0,-1], [0,1]];
                            dirs.sort(() => Math.random() - 0.5);
                            
                            for (const [dy, dx] of dirs) {
                                const ny = y + dy, nx = x + dx;
                                if (grid[ny][nx] === STATE.EMPTY || grid[ny][nx] === STATE.HEALTHY) {
                                    newGrid[ny][nx] = STATE.CANCER;
                                    break;
                                }
                            }
                        }
                    }
                    
                    // Dividing returns to cancer
                    if (cell === STATE.DIVIDING) {
                        newGrid[y][x] = STATE.CANCER;
                    }
                    
                    // Healthy cell mutation
                    if (cell === STATE.HEALTHY && Math.random() < params.mutationRate) {
                        newGrid[y][x] = STATE.CANCER;
                    }
                }
            }
            
            grid = newGrid;
            updateStats();
        }
        
        function updateStats() {
            let healthy = 0, cancer = 0, necrotic = 0;
            let minX = COLS, maxX = 0, minY = ROWS, maxY = 0;
            
            for (let y = 0; y < ROWS; y++) {
                for (let x = 0; x < COLS; x++) {
                    const cell = grid[y][x];
                    if (cell === STATE.HEALTHY) healthy++;
                    else if (cell === STATE.CANCER || cell === STATE.DIVIDING) {
                        cancer++;
                        minX = Math.min(minX, x);
                        maxX = Math.max(maxX, x);
                        minY = Math.min(minY, y);
                        maxY = Math.max(maxY, y);
                    }
                    else if (cell === STATE.NECROTIC) necrotic++;
                }
            }
            
            const tumorRadius = cancer > 0 ? 
                Math.max(maxX - minX, maxY - minY) * CELL / 2 : 0;
            
            document.getElementById('time').textContent = time;
            document.getElementById('healthy').textContent = healthy;
            document.getElementById('cancer').textContent = cancer;
            document.getElementById('necrotic').textContent = necrotic;
            document.getElementById('radius').textContent = Math.round(tumorRadius);
        }
        
        function draw() {
            ctx.fillStyle = '#1a0a1a';
            ctx.fillRect(0, 0, W, H);
            
            // Draw cells
            for (let y = 0; y < ROWS; y++) {
                for (let x = 0; x < COLS; x++) {
                    const cell = grid[y][x];
                    if (cell === STATE.EMPTY) continue;
                    
                    // Modulate color by nutrients
                    const nutrient = nutrients[y][x];
                    ctx.globalAlpha = 0.5 + nutrient * 0.5;
                    ctx.fillStyle = COLORS[cell];
                    ctx.fillRect(x * CELL, y * CELL, CELL - 1, CELL - 1);
                }
            }
            ctx.globalAlpha = 1;
            
            // Draw nutrient overlay (subtle)
            for (let y = 0; y < ROWS; y += 3) {
                for (let x = 0; x < COLS; x += 3) {
                    const n = nutrients[y][x];
                    if (n < 0.3 && grid[y][x] !== STATE.EMPTY) {
                        ctx.fillStyle = `rgba(255, 0, 0, ${(0.3 - n) * 0.5})`;
                        ctx.fillRect(x * CELL, y * CELL, CELL * 3, CELL * 3);
                    }
                }
            }
            
            requestAnimationFrame(draw);
        }
        
        function applyTreatment() {
            // Kill rapidly dividing cells
            for (let y = 0; y < ROWS; y++) {
                for (let x = 0; x < COLS; x++) {
                    if (grid[y][x] === STATE.CANCER || grid[y][x] === STATE.DIVIDING) {
                        if (Math.random() < 0.7) { // 70% kill rate
                            grid[y][x] = STATE.NECROTIC;
                        }
                    }
                }
            }
        }
        
        let intervalId = null;
        function startSim() {
            if (intervalId) clearInterval(intervalId);
            intervalId = setInterval(() => {
                if (!paused) step();
            }, 50);
        }
        
        // Event listeners
        document.getElementById('division').addEventListener('input', e => {
            params.divisionRate = +e.target.value;
            document.getElementById('divisionVal').textContent = params.divisionRate.toFixed(3);
        });
        document.getElementById('nutrient').addEventListener('input', e => {
            params.nutrientDiffusion = +e.target.value;
            document.getElementById('nutrientVal').textContent = params.nutrientDiffusion.toFixed(2);
        });
        document.getElementById('mutation').addEventListener('input', e => {
            params.mutationRate = +e.target.value;
            document.getElementById('mutationVal').textContent = params.mutationRate.toFixed(4);
        });
        document.getElementById('necrosis').addEventListener('input', e => {
            params.necrosisThreshold = +e.target.value;
            document.getElementById('necrosisVal').textContent = params.necrosisThreshold.toFixed(2);
        });
        
        document.getElementById('reset').addEventListener('click', () => { init(); startSim(); });
        document.getElementById('pause').addEventListener('click', () => {
            paused = !paused;
            document.getElementById('pause').textContent = paused ? 'Resume' : 'Pause';
        });
        document.getElementById('addCancer').addEventListener('click', () => {
            // Add cancer cell at random location in tissue
            for (let i = 0; i < 100; i++) {
                const x = Math.floor(Math.random() * COLS);
                const y = Math.floor(Math.random() * ROWS);
                if (grid[y][x] === STATE.HEALTHY) {
                    grid[y][x] = STATE.CANCER;
                    break;
                }
            }
        });
        document.getElementById('treatment').addEventListener('click', applyTreatment);
        
        window.addEventListener('resize', resize);
        init();
        draw();
        startSim();
    </script>
</body>
</html>
