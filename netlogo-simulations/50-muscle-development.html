<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Muscle Development - NetLogo Simulation</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            min-height: 100vh;
            display: flex;
            color: #e0e0e0;
        }
        .sidebar {
            width: 320px;
            background: rgba(20, 20, 35, 0.95);
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #333;
        }
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }
        h1 {
            font-size: 1.4rem;
            margin-bottom: 8px;
            color: #ef5350;
        }
        .subtitle {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 20px;
            line-height: 1.4;
        }
        .control-group {
            margin-bottom: 15px;
        }
        .control-group label {
            display: block;
            font-size: 0.8rem;
            color: #aaa;
            margin-bottom: 5px;
        }
        .control-group input[type="range"] {
            width: 100%;
            margin-bottom: 3px;
        }
        .buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #ef5350, #e53935);
            color: #fff;
        }
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #fff;
            border: 1px solid #444;
        }
        button:hover { transform: translateY(-2px); }
        .stats {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }
        .stat-label { color: #888; }
        .stat-value {
            color: #ef5350;
            font-weight: bold;
        }
        canvas {
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .back-link {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #ef5350;
            text-decoration: none;
            font-size: 0.9rem;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        .back-link:hover { opacity: 1; }
        .explanation {
            background: rgba(239, 83, 80, 0.1);
            border: 1px solid rgba(239, 83, 80, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 0.8rem;
            line-height: 1.5;
        }
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
        }
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }

        .explain-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            margin-top: 10px;
        }
        .explain-btn:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        }
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
        }
        .modal {
            background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%);
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: #888;
            font-size: 28px;
            cursor: pointer;
            width: auto;
            padding: 0;
            margin: 0;
        }
        .modal-close:hover {
            color: #fff;
            background: none;
        }
        .modal h2 {
            color: #fbbf24;
            margin-bottom: 20px;
            font-size: 1.5rem;
            padding-right: 30px;
        }
        .modal-body {
            color: #ccc;
            line-height: 1.8;
            font-size: 0.95rem;
        }
        .modal-body h3 {
            color: #a5b4fc;
            margin: 20px 0 10px 0;
            font-size: 1.1rem;
        }
        .modal-body p {
            margin-bottom: 15px;
        }
        .modal-body ul {
            margin: 10px 0 15px 20px;
        }
        .modal-body li {
            margin-bottom: 8px;
        }
        .modal-body strong {
            color: #fbbf24;
        }
        .modal-body em {
            color: #a5b4fc;
            font-style: normal;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h1>Muscle Development</h1>
        <p class="subtitle">Cell differentiation and signaling during myogenesis. Stem cells respond to signals to become muscle fibers.</p>

        <div class="explanation">
            <strong>Myogenesis:</strong> Muscle development involves stem cells (myoblasts) differentiating into muscle fibers (myocytes) in response to signaling molecules. Cells align and fuse to form multinucleated muscle fibers.
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #81c784;"></div>
                <span>Stem Cells</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #64b5f6;"></div>
                <span>Myoblasts</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ef5350;"></div>
                <span>Myocytes</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ab47bc;"></div>
                <span>Signal Source</span>
            </div>
        </div>

        <div class="buttons">
            <button class="btn-primary" id="startBtn">Start</button>
            <button class="btn-secondary" id="resetBtn">Reset</button>
            <button id="explainBtn" class="explain-btn">üìö Explain</button>
            <button class="btn-secondary" id="signalBtn">Add Signal</button>
        </div>

        <div class="control-group">
            <label>Initial Cells: <span id="cellsVal">50</span></label>
            <input type="range" id="numCells" min="20" max="150" value="50">
        </div>

        <div class="control-group">
            <label>Signal Strength: <span id="signalVal">0.8</span></label>
            <input type="range" id="signalStrength" min="0.1" max="1" step="0.1" value="0.8">
        </div>

        <div class="control-group">
            <label>Differentiation Rate: <span id="diffRateVal">0.05</span></label>
            <input type="range" id="diffRate" min="0.01" max="0.2" step="0.01" value="0.05">
        </div>

        <div class="control-group">
            <label>Alignment Force: <span id="alignVal">0.3</span></label>
            <input type="range" id="alignForce" min="0" max="1" step="0.1" value="0.3">
        </div>

        <div class="stats">
            <div class="stat-row">
                <span class="stat-label">Stem Cells</span>
                <span class="stat-value" id="stemStat">-</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Myoblasts</span>
                <span class="stat-value" id="myoblastStat">-</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Myocytes</span>
                <span class="stat-value" id="myocyteStat">-</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Muscle Fibers</span>
                <span class="stat-value" id="fiberStat">-</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Signal Sources</span>
                <span class="stat-value" id="signalStat">-</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Time Step</span>
                <span class="stat-value" id="timeStat">0</span>
            </div>
        </div>
    </div>

    <div class="main">
        <a href="index.html" class="back-link">‚Üê Back to Gallery</a>
        <canvas id="simCanvas" width="800" height="600"></canvas>
    </div>

    <div id="explainModal" class="modal-overlay">
        <div class="modal">
            <button class="modal-close">&times;</button>
            <h2>üìö Muscle Development - NetLogo Simulation</h2>
            <div class="modal-body">
                <p>This simulation demonstrates key concepts in complex systems and agent-based modeling.</p>

                <h3>How It Works</h3>
                <p>Agents follow simple local rules that lead to emergent global behavior.</p>

                <h3>Key Concepts</h3>
                <ul>
                    <li><strong>Emergence:</strong> Complex patterns arise from simple rules</li>
                    <li><strong>Self-organization:</strong> Order without central control</li>
                    <li><strong>Feedback loops:</strong> Actions influence future states</li>
                </ul>

                <h3>Try This</h3>
                <ul>
                    <li>Adjust parameters to see different behaviors</li>
                    <li>Watch for patterns that emerge over time</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');

        let running = false;
        let cells = [];
        let signalSources = [];
        let fibers = [];
        let tick = 0;

        const CellType = {
            STEM: 'stem',
            MYOBLAST: 'myoblast',
            MYOCYTE: 'myocyte'
        };

        class Cell {
            constructor(x, y, type = CellType.STEM) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 2;
                this.vy = (Math.random() - 0.5) * 2;
                this.type = type;
                this.signalExposure = 0;
                this.angle = Math.random() * Math.PI * 2;
                this.fiberId = null;
                this.radius = type === CellType.MYOCYTE ? 8 : 6;
            }

            getColor() {
                switch (this.type) {
                    case CellType.STEM: return '#81c784';
                    case CellType.MYOBLAST: return '#64b5f6';
                    case CellType.MYOCYTE: return '#ef5350';
                }
            }

            update() {
                const alignForce = parseFloat(document.getElementById('alignForce').value);

                // Random motion
                this.vx += (Math.random() - 0.5) * 0.3;
                this.vy += (Math.random() - 0.5) * 0.3;

                // Alignment for myocytes
                if (this.type === CellType.MYOCYTE && alignForce > 0) {
                    // Find nearby myocytes and align
                    let avgAngle = this.angle;
                    let count = 1;

                    cells.forEach(other => {
                        if (other !== this && other.type === CellType.MYOCYTE) {
                            const dx = other.x - this.x;
                            const dy = other.y - this.y;
                            const dist = Math.sqrt(dx * dx + dy * dy);

                            if (dist < 50) {
                                avgAngle += other.angle;
                                count++;

                                // Attraction to nearby myocytes
                                if (dist > 15) {
                                    this.vx += dx / dist * 0.1;
                                    this.vy += dy / dist * 0.1;
                                }
                            }
                        }
                    });

                    avgAngle /= count;
                    this.angle += (avgAngle - this.angle) * alignForce * 0.1;
                }

                // Apply velocity with damping
                this.vx *= 0.95;
                this.vy *= 0.95;
                this.x += this.vx;
                this.y += this.vy;

                // Boundary constraints
                const margin = 20;
                if (this.x < margin) { this.x = margin; this.vx = Math.abs(this.vx); }
                if (this.x > canvas.width - margin) { this.x = canvas.width - margin; this.vx = -Math.abs(this.vx); }
                if (this.y < margin) { this.y = margin; this.vy = Math.abs(this.vy); }
                if (this.y > canvas.height - margin) { this.y = canvas.height - margin; this.vy = -Math.abs(this.vy); }

                // Calculate signal exposure
                this.signalExposure = 0;
                signalSources.forEach(source => {
                    const dx = source.x - this.x;
                    const dy = source.y - this.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    const strength = parseFloat(document.getElementById('signalStrength').value);
                    this.signalExposure += (strength * source.strength) / (1 + dist * 0.02);
                });

                // Differentiation
                const diffRate = parseFloat(document.getElementById('diffRate').value);

                if (this.type === CellType.STEM && this.signalExposure > 0.3) {
                    if (Math.random() < diffRate * this.signalExposure) {
                        this.type = CellType.MYOBLAST;
                    }
                } else if (this.type === CellType.MYOBLAST && this.signalExposure > 0.5) {
                    if (Math.random() < diffRate * this.signalExposure * 0.5) {
                        this.type = CellType.MYOCYTE;
                        this.radius = 8;
                    }
                }
            }

            draw() {
                ctx.fillStyle = this.getColor();

                if (this.type === CellType.MYOCYTE) {
                    // Draw elongated cell
                    ctx.save();
                    ctx.translate(this.x, this.y);
                    ctx.rotate(this.angle);
                    ctx.beginPath();
                    ctx.ellipse(0, 0, this.radius * 1.5, this.radius * 0.6, 0, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                } else {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                    ctx.fill();
                }

                // Signal exposure indicator
                if (this.signalExposure > 0.1) {
                    ctx.strokeStyle = `rgba(171, 71, 188, ${Math.min(this.signalExposure, 1) * 0.5})`;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius + 3, 0, Math.PI * 2);
                    ctx.stroke();
                }
            }
        }

        class SignalSource {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.strength = 1;
                this.age = 0;
            }

            update() {
                this.age++;
                this.strength = Math.max(0, 1 - this.age * 0.001);
            }

            draw() {
                const maxRadius = 150;
                const gradient = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, maxRadius);
                gradient.addColorStop(0, `rgba(171, 71, 188, ${0.4 * this.strength})`);
                gradient.addColorStop(0.5, `rgba(171, 71, 188, ${0.15 * this.strength})`);
                gradient.addColorStop(1, 'rgba(171, 71, 188, 0)');

                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(this.x, this.y, maxRadius, 0, Math.PI * 2);
                ctx.fill();

                // Core
                ctx.fillStyle = '#ab47bc';
                ctx.beginPath();
                ctx.arc(this.x, this.y, 8, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function detectFibers() {
            // Group nearby aligned myocytes into fibers
            fibers = [];
            const myocytes = cells.filter(c => c.type === CellType.MYOCYTE);

            myocytes.forEach(c => c.fiberId = null);

            let fiberId = 0;
            myocytes.forEach(cell => {
                if (cell.fiberId !== null) return;

                const fiber = [cell];
                cell.fiberId = fiberId;

                // Find connected myocytes
                let changed = true;
                while (changed) {
                    changed = false;
                    myocytes.forEach(other => {
                        if (other.fiberId !== null) return;

                        fiber.forEach(fiberCell => {
                            const dx = other.x - fiberCell.x;
                            const dy = other.y - fiberCell.y;
                            const dist = Math.sqrt(dx * dx + dy * dy);

                            // Check alignment
                            const angleDiff = Math.abs(other.angle - fiberCell.angle);
                            const normalizedAngle = Math.min(angleDiff, Math.PI - angleDiff);

                            if (dist < 30 && normalizedAngle < 0.5) {
                                other.fiberId = fiberId;
                                fiber.push(other);
                                changed = true;
                            }
                        });
                    });
                }

                if (fiber.length >= 3) {
                    fibers.push(fiber);
                }
                fiberId++;
            });
        }

        function drawFibers() {
            fibers.forEach(fiber => {
                if (fiber.length < 3) return;

                // Sort by position along fiber axis
                const avgAngle = fiber.reduce((s, c) => s + c.angle, 0) / fiber.length;
                fiber.sort((a, b) => {
                    const projA = a.x * Math.cos(avgAngle) + a.y * Math.sin(avgAngle);
                    const projB = b.x * Math.cos(avgAngle) + b.y * Math.sin(avgAngle);
                    return projA - projB;
                });

                ctx.strokeStyle = 'rgba(239, 83, 80, 0.3)';
                ctx.lineWidth = 12;
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(fiber[0].x, fiber[0].y);
                for (let i = 1; i < fiber.length; i++) {
                    ctx.lineTo(fiber[i].x, fiber[i].y);
                }
                ctx.stroke();
            });
        }

        function initSimulation() {
            cells = [];
            signalSources = [];
            fibers = [];
            tick = 0;

            const numCells = parseInt(document.getElementById('numCells').value);

            for (let i = 0; i < numCells; i++) {
                const x = 100 + Math.random() * (canvas.width - 200);
                const y = 100 + Math.random() * (canvas.height - 200);
                cells.push(new Cell(x, y, CellType.STEM));
            }

            // Add initial signal sources
            signalSources.push(new SignalSource(canvas.width / 2, canvas.height / 2));
        }

        function updateStats() {
            const stem = cells.filter(c => c.type === CellType.STEM).length;
            const myoblast = cells.filter(c => c.type === CellType.MYOBLAST).length;
            const myocyte = cells.filter(c => c.type === CellType.MYOCYTE).length;

            document.getElementById('stemStat').textContent = stem;
            document.getElementById('myoblastStat').textContent = myoblast;
            document.getElementById('myocyteStat').textContent = myocyte;
            document.getElementById('fiberStat').textContent = fibers.length;
            document.getElementById('signalStat').textContent = signalSources.length;
            document.getElementById('timeStat').textContent = tick;
        }

        function draw() {
            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw signal fields first
            signalSources.forEach(s => s.draw());

            // Draw fibers
            drawFibers();

            // Draw cells
            cells.forEach(c => c.draw());

            // Title
            ctx.fillStyle = '#ef5350';
            ctx.font = 'bold 18px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Muscle Development - Cell Differentiation & Signaling', canvas.width / 2, 30);
        }

        function update() {
            if (running) {
                tick++;

                cells.forEach(c => c.update());
                signalSources.forEach(s => s.update());

                // Remove depleted signals
                signalSources = signalSources.filter(s => s.strength > 0.1);

                // Detect fiber formation periodically
                if (tick % 30 === 0) {
                    detectFibers();
                }
            }

            updateStats();
            draw();
            requestAnimationFrame(update);
        }

        // Event listeners
        document.getElementById('startBtn').addEventListener('click', () => {
            running = !running;
            document.getElementById('startBtn').textContent = running ? 'Pause' : 'Start';
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            running = false;
            document.getElementById('startBtn').textContent = 'Start';
            initSimulation();
        });

        document.getElementById('signalBtn').addEventListener('click', () => {
            const x = 100 + Math.random() * (canvas.width - 200);
            const y = 100 + Math.random() * (canvas.height - 200);
            signalSources.push(new SignalSource(x, y));
        });

        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            signalSources.push(new SignalSource(x, y));
        });

        document.getElementById('numCells').addEventListener('input', (e) => {
            document.getElementById('cellsVal').textContent = e.target.value;
        });

        document.getElementById('signalStrength').addEventListener('input', (e) => {
            document.getElementById('signalVal').textContent = e.target.value;
        });

        document.getElementById('diffRate').addEventListener('input', (e) => {
            document.getElementById('diffRateVal').textContent = e.target.value;
        });

        document.getElementById('alignForce').addEventListener('input', (e) => {
            document.getElementById('alignVal').textContent = e.target.value;
        });

        // Initialize
        initSimulation();
        update();
    

        // Modal functionality
        const modal = document.getElementById('explainModal');
        document.getElementById('explainBtn').addEventListener('click', () => {
            modal.classList.add('active');
        });
        modal.querySelector('.modal-close').addEventListener('click', () => {
            modal.classList.remove('active');
        });
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.classList.remove('active');
        });</script>
</body>
</html>
