<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Farol Bar Problem - Bounded Rationality</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', system-ui, sans-serif;
            color: #e0e0e0;
        }
        .back-link {
            position: fixed;
            top: 15px;
            left: 15px;
            color: #f39c12;
            text-decoration: none;
            z-index: 100;
        }
        header { text-align: center; padding: 15px; }
        h1 { color: #f39c12; font-size: 1.6rem; }
        .container {
            display: grid;
            grid-template-columns: 1fr 280px;
            gap: 15px;
            padding: 0 15px 15px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .main-area { display: flex; flex-direction: column; gap: 15px; }
        .canvas-wrapper {
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            padding: 15px;
        }
        .canvas-wrapper h3 {
            color: #f39c12;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        #historyCanvas {
            width: 100%;
            height: 200px;
            background: #0a0a15;
            border-radius: 8px;
        }
        #barCanvas {
            width: 100%;
            height: 180px;
            background: #0a0a15;
            border-radius: 8px;
            margin-top: 10px;
        }
        .sidebar {
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            padding: 15px;
        }
        .control-group { margin-bottom: 15px; }
        .control-group label {
            display: block;
            color: #f39c12;
            margin-bottom: 6px;
            font-size: 0.85rem;
        }
        input[type="range"] {
            width: 100%;
            -webkit-appearance: none;
            height: 5px;
            background: #333;
            border-radius: 3px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #f39c12;
            border-radius: 50%;
            cursor: pointer;
        }
        .value-display {
            text-align: right;
            font-size: 0.8rem;
            color: #888;
            margin-top: 4px;
        }
        button {
            width: 100%;
            padding: 10px;
            margin: 4px 0;
            background: #f39c12;
            border: none;
            border-radius: 5px;
            color: #000;
            font-weight: 600;
            cursor: pointer;
        }
        button:hover { background: #e67e22; }
        button.secondary { background: #333; color: #fff; }
        .stats {
            background: rgba(243, 156, 18, 0.1);
            border: 1px solid rgba(243, 156, 18, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 6px 0;
            font-size: 0.8rem;
        }
        .stat-label { color: #888; }
        .stat-value { color: #f39c12; font-family: monospace; }
        .bar-indicator {
            margin-top: 12px;
            padding: 15px;
            background: rgba(243, 156, 18, 0.1);
            border: 1px solid rgba(243, 156, 18, 0.3);
            border-radius: 8px;
            text-align: center;
        }
        .bar-count {
            font-size: 2rem;
            color: #f39c12;
            font-weight: bold;
        }
        .bar-status {
            font-size: 0.9rem;
            margin-top: 5px;
        }
        .bar-status.crowded { color: #e74c3c; }
        .bar-status.ok { color: #2ecc71; }
        .info {
            margin-top: 12px;
            padding: 10px;
            background: rgba(243, 156, 18, 0.1);
            border-radius: 6px;
            font-size: 0.75rem;
            line-height: 1.4;
        }
        .info h4 { color: #f39c12; margin-bottom: 6px; }
        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; }
        }

        .explain-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            margin-top: 10px;
        }
        .explain-btn:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        }
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
        }
        .modal {
            background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%);
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: #888;
            font-size: 28px;
            cursor: pointer;
            width: auto;
            padding: 0;
            margin: 0;
        }
        .modal-close:hover {
            color: #fff;
            background: none;
        }
        .modal h2 {
            color: #fbbf24;
            margin-bottom: 20px;
            font-size: 1.5rem;
            padding-right: 30px;
        }
        .modal-body {
            color: #ccc;
            line-height: 1.8;
            font-size: 0.95rem;
        }
        .modal-body h3 {
            color: #a5b4fc;
            margin: 20px 0 10px 0;
            font-size: 1.1rem;
        }
        .modal-body p {
            margin-bottom: 15px;
        }
        .modal-body ul {
            margin: 10px 0 15px 20px;
        }
        .modal-body li {
            margin-bottom: 8px;
        }
        .modal-body strong {
            color: #fbbf24;
        }
        .modal-body em {
            color: #a5b4fc;
            font-style: normal;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back</a>

    <header>
        <h1>El Farol Bar Problem</h1>
        <p style="color: #888; font-size: 0.9rem;">Bounded Rationality & Strategy Evolution</p>
    </header>

    <div class="container">
        <div class="main-area">
            <div class="canvas-wrapper">
                <h3>Attendance History</h3>
                <canvas id="historyCanvas"></canvas>
                <h3 style="margin-top: 15px;">Bar Visualization</h3>
                <canvas id="barCanvas"></canvas>
            </div>
        </div>

        <div class="sidebar">
            <div class="control-group">
                <label>Population</label>
                <input type="range" id="population" min="50" max="200" value="100">
                <div class="value-display"><span id="popVal">100</span> agents</div>
            </div>

            <div class="control-group">
                <label>Comfort Threshold</label>
                <input type="range" id="threshold" min="30" max="80" value="60">
                <div class="value-display"><span id="threshVal">60</span>%</div>
            </div>

            <div class="control-group">
                <label>Strategies Per Agent</label>
                <input type="range" id="strategies" min="2" max="10" value="5">
                <div class="value-display"><span id="stratVal">5</span></div>
            </div>

            <div class="control-group">
                <label>Simulation Speed</label>
                <input type="range" id="speed" min="1" max="30" value="5">
                <div class="value-display"><span id="speedVal">5</span> weeks/sec</div>
            </div>

            <button id="startBtn">Start</button>
            <button id="stepBtn" class="secondary">Step Week</button>
            <button id="resetBtn" class="secondary">Reset</button>
            <button id="explainBtn" class="explain-btn">üìö Explain</button>

            <div class="bar-indicator">
                <div class="bar-count" id="attendanceCount">0</div>
                <div class="bar-status" id="barStatus">Waiting...</div>
            </div>

            <div class="stats">
                <div class="stat-row">
                    <span class="stat-label">Week:</span>
                    <span class="stat-value" id="weekStat">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Avg Attendance:</span>
                    <span class="stat-value" id="avgStat">0%</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Crowded Weeks:</span>
                    <span class="stat-value" id="crowdedStat">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Comfortable Weeks:</span>
                    <span class="stat-value" id="comfortStat">0</span>
                </div>
            </div>

            <div class="info">
                <h4>The Problem</h4>
                <p>100 people decide weekly whether to visit El Farol bar. It's only fun if fewer than 60% attend.</p>
                <p style="margin-top:8px"><strong>No common knowledge:</strong> Each agent uses different prediction strategies based on past attendance.</p>
                <p style="margin-top:8px"><strong>Self-defeating prophecy:</strong> If everyone predicts it will be empty, everyone goes, making it crowded!</p>
                <p style="margin-top:8px">Demonstrates bounded rationality and emergent equilibrium.</p>
            </div>
        </div>
    </div>

    <div id="explainModal" class="modal-overlay">
        <div class="modal">
            <button class="modal-close">&times;</button>
            <h2>üç∫ El Farol Bar Problem</h2>
            <div class="modal-body">
                <p>The <strong>El Farol Bar Problem</strong>, created by economist Brian Arthur in 1994, demonstrates <em>bounded rationality</em>‚Äîhow people make decisions with limited information and conflicting incentives.</p>

                <h3>The Dilemma</h3>
                <p>100 people decide weekly whether to go to a bar. It's fun if ‚â§60 go, but crowded and miserable if >60 attend. The twist: your best strategy depends on what everyone else does.</p>

                <h3>Key Insights</h3>
                <ul>
                    <li><strong>No perfect predictor:</strong> If everyone uses the same model, it fails</li>
                    <li><strong>Inductive reasoning:</strong> Agents use simple heuristics, not optimal strategies</li>
                    <li><strong>Self-defeating prophecy:</strong> Predicting low attendance causes high attendance</li>
                </ul>

                <h3>Emergent Behavior</h3>
                <ul>
                    <li>Attendance naturally oscillates around the comfort threshold</li>
                    <li>Diversity of strategies leads to stable average</li>
                    <li>System self-organizes without central coordination</li>
                </ul>

                <h3>Real-World Parallels</h3>
                <ul>
                    <li><strong>Stock markets:</strong> Self-fulfilling and self-defeating predictions</li>
                    <li><strong>Traffic:</strong> Route choice based on incomplete info</li>
                    <li><strong>Resource allocation:</strong> Tragedy of the commons</li>
                </ul>
</div>
        </div>
    </div>

    <script>
        const historyCanvas = document.getElementById('historyCanvas');
        const barCanvas = document.getElementById('barCanvas');
        const historyCtx = historyCanvas.getContext('2d');
        const barCtx = barCanvas.getContext('2d');

        let population = 100;
        let threshold = 60;
        let numStrategies = 5;
        let speed = 5;

        let agents = [];
        let history = [];
        let week = 0;
        let running = false;
        let crowdedWeeks = 0;
        let comfortableWeeks = 0;
        let lastTime = 0;

        // Strategy types
        const strategyTypes = [
            { name: 'last_week', predict: (h) => h.length > 0 ? h[h.length - 1] : 50 },
            { name: 'avg_2', predict: (h) => h.length >= 2 ? (h[h.length-1] + h[h.length-2]) / 2 : 50 },
            { name: 'avg_4', predict: (h) => {
                const n = Math.min(4, h.length);
                return n > 0 ? h.slice(-n).reduce((a, b) => a + b, 0) / n : 50;
            }},
            { name: 'trend', predict: (h) => {
                if (h.length < 2) return 50;
                const diff = h[h.length-1] - h[h.length-2];
                return h[h.length-1] + diff;
            }},
            { name: 'inverse', predict: (h) => h.length > 0 ? 100 - h[h.length - 1] : 50 },
            { name: 'cycle_2', predict: (h) => h.length >= 2 ? h[h.length - 2] : 50 },
            { name: 'cycle_4', predict: (h) => h.length >= 4 ? h[h.length - 4] : 50 },
            { name: 'random_guess', predict: () => Math.random() * 100 },
            { name: 'always_low', predict: () => 40 },
            { name: 'always_high', predict: () => 70 },
            { name: 'mirror_avg', predict: (h) => {
                if (h.length < 4) return 50;
                const recent = h.slice(-4).reduce((a, b) => a + b, 0) / 4;
                return 100 - recent;
            }}
        ];

        function resize() {
            historyCanvas.width = historyCanvas.parentElement.clientWidth - 30;
            historyCanvas.height = 200;
            barCanvas.width = barCanvas.parentElement.clientWidth - 30;
            barCanvas.height = 180;
            render();
        }

        function createAgents() {
            agents = [];
            for (let i = 0; i < population; i++) {
                const myStrategies = [];
                const usedIndices = new Set();

                while (myStrategies.length < numStrategies) {
                    const idx = Math.floor(Math.random() * strategyTypes.length);
                    if (!usedIndices.has(idx)) {
                        usedIndices.add(idx);
                        myStrategies.push({
                            ...strategyTypes[idx],
                            score: 0
                        });
                    }
                }

                agents.push({
                    strategies: myStrategies,
                    currentStrategy: 0,
                    attending: false
                });
            }
        }

        function init() {
            history = [];
            week = 0;
            crowdedWeeks = 0;
            comfortableWeeks = 0;
            createAgents();
            updateStats(0);
            render();
        }

        function step() {
            week++;

            // Each agent uses their best-scoring strategy to predict
            let attendance = 0;

            agents.forEach(agent => {
                // Find best strategy
                let bestScore = -Infinity;
                let bestIdx = 0;
                agent.strategies.forEach((s, i) => {
                    if (s.score > bestScore) {
                        bestScore = s.score;
                        bestIdx = i;
                    }
                });
                agent.currentStrategy = bestIdx;

                // Make prediction
                const prediction = agent.strategies[bestIdx].predict(history);
                agent.attending = prediction < threshold;

                if (agent.attending) attendance++;
            });

            // Calculate actual attendance percentage
            const attendancePercent = (attendance / population) * 100;
            history.push(attendancePercent);

            // Keep history manageable
            if (history.length > 100) history.shift();

            // Update strategy scores
            const crowded = attendancePercent >= threshold;
            if (crowded) crowdedWeeks++;
            else comfortableWeeks++;

            agents.forEach(agent => {
                agent.strategies.forEach(strategy => {
                    const prediction = strategy.predict(history.slice(0, -1));
                    const error = Math.abs(prediction - attendancePercent);
                    // Score based on prediction accuracy
                    strategy.score = strategy.score * 0.9 - error;
                });
            });

            updateStats(attendance);
            render();
        }

        function updateStats(attendance) {
            const attendancePercent = population > 0 ? (attendance / population) * 100 : 0;
            const crowded = attendancePercent >= threshold;

            document.getElementById('weekStat').textContent = week;
            document.getElementById('attendanceCount').textContent = attendance;

            const statusEl = document.getElementById('barStatus');
            if (week === 0) {
                statusEl.textContent = 'Waiting...';
                statusEl.className = 'bar-status';
            } else if (crowded) {
                statusEl.textContent = `Too crowded! (${attendancePercent.toFixed(0)}%)`;
                statusEl.className = 'bar-status crowded';
            } else {
                statusEl.textContent = `Comfortable (${attendancePercent.toFixed(0)}%)`;
                statusEl.className = 'bar-status ok';
            }

            const avgAttendance = history.length > 0
                ? history.reduce((a, b) => a + b, 0) / history.length
                : 0;
            document.getElementById('avgStat').textContent = avgAttendance.toFixed(1) + '%';
            document.getElementById('crowdedStat').textContent = crowdedWeeks;
            document.getElementById('comfortStat').textContent = comfortableWeeks;
        }

        function render() {
            renderHistory();
            renderBar();
        }

        function renderHistory() {
            const w = historyCanvas.width;
            const h = historyCanvas.height;

            historyCtx.fillStyle = '#0a0a15';
            historyCtx.fillRect(0, 0, w, h);

            if (history.length < 2) return;

            // Draw threshold line
            const thresholdY = h - (threshold / 100) * h;
            historyCtx.strokeStyle = 'rgba(231, 76, 60, 0.5)';
            historyCtx.lineWidth = 2;
            historyCtx.setLineDash([5, 5]);
            historyCtx.beginPath();
            historyCtx.moveTo(0, thresholdY);
            historyCtx.lineTo(w, thresholdY);
            historyCtx.stroke();
            historyCtx.setLineDash([]);

            // Draw threshold label
            historyCtx.fillStyle = '#e74c3c';
            historyCtx.font = '12px sans-serif';
            historyCtx.fillText(`${threshold}% threshold`, 5, thresholdY - 5);

            // Draw history line
            historyCtx.strokeStyle = '#f39c12';
            historyCtx.lineWidth = 2;
            historyCtx.beginPath();

            const step = w / Math.max(history.length - 1, 1);
            history.forEach((val, i) => {
                const x = i * step;
                const y = h - (val / 100) * h;
                if (i === 0) historyCtx.moveTo(x, y);
                else historyCtx.lineTo(x, y);
            });
            historyCtx.stroke();

            // Draw points
            history.forEach((val, i) => {
                const x = i * step;
                const y = h - (val / 100) * h;
                historyCtx.fillStyle = val >= threshold ? '#e74c3c' : '#2ecc71';
                historyCtx.beginPath();
                historyCtx.arc(x, y, 3, 0, Math.PI * 2);
                historyCtx.fill();
            });
        }

        function renderBar() {
            const w = barCanvas.width;
            const h = barCanvas.height;

            barCtx.fillStyle = '#0a0a15';
            barCtx.fillRect(0, 0, w, h);

            // Draw bar background
            barCtx.fillStyle = '#2c1810';
            barCtx.fillRect(20, 20, w - 40, h - 40);

            // Draw bar counter
            barCtx.fillStyle = '#4a2c1d';
            barCtx.fillRect(30, h - 50, w - 60, 20);

            // Draw people as small circles
            const attendingAgents = agents.filter(a => a.attending);
            const barWidth = w - 60;
            const barHeight = h - 80;

            attendingAgents.forEach((agent, i) => {
                const cols = Math.ceil(Math.sqrt(attendingAgents.length * (barWidth / barHeight)));
                const rows = Math.ceil(attendingAgents.length / cols);
                const cellW = barWidth / cols;
                const cellH = barHeight / rows;

                const col = i % cols;
                const row = Math.floor(i / cols);

                const x = 30 + col * cellW + cellW / 2;
                const y = 30 + row * cellH + cellH / 2;

                const crowded = (attendingAgents.length / population) * 100 >= threshold;
                barCtx.fillStyle = crowded ? '#e74c3c' : '#2ecc71';
                barCtx.beginPath();
                barCtx.arc(x, y, Math.min(cellW, cellH) / 3, 0, Math.PI * 2);
                barCtx.fill();
            });

            // Draw sign
            barCtx.fillStyle = '#f39c12';
            barCtx.font = 'bold 14px sans-serif';
            barCtx.textAlign = 'center';
            barCtx.fillText('EL FAROL BAR', w / 2, 15);
            barCtx.textAlign = 'left';
        }

        function animate(time) {
            if (running && time - lastTime > 1000 / speed) {
                step();
                lastTime = time;
            }
            requestAnimationFrame(animate);
        }

        // Event listeners
        document.getElementById('population').addEventListener('input', (e) => {
            population = parseInt(e.target.value);
            document.getElementById('popVal').textContent = population;
        });

        document.getElementById('threshold').addEventListener('input', (e) => {
            threshold = parseInt(e.target.value);
            document.getElementById('threshVal').textContent = threshold;
        });

        document.getElementById('strategies').addEventListener('input', (e) => {
            numStrategies = parseInt(e.target.value);
            document.getElementById('stratVal').textContent = numStrategies;
        });

        document.getElementById('speed').addEventListener('input', (e) => {
            speed = parseInt(e.target.value);
            document.getElementById('speedVal').textContent = speed;
        });

        document.getElementById('startBtn').addEventListener('click', () => {
            running = !running;
            document.getElementById('startBtn').textContent = running ? 'Pause' : 'Start';
        });

        document.getElementById('stepBtn').addEventListener('click', step);

        document.getElementById('resetBtn').addEventListener('click', () => {
            running = false;
            document.getElementById('startBtn').textContent = 'Start';
            init();
        });

        window.addEventListener('resize', resize);
        resize();

        // Modal functionality
        const modal = document.getElementById('explainModal');
        document.getElementById('explainBtn').addEventListener('click', () => {
            modal.classList.add('active');
        });
        modal.querySelector('.modal-close').addEventListener('click', () => {
            modal.classList.remove('active');
        });
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.classList.remove('active');
        });
        init();
        requestAnimationFrame(animate);
    </script>
</body>
</html>
