<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atmospheric Chemistry - CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0c1222; color: #e8e6e1; overflow: hidden; }
        #container { display: flex; height: 100vh; }
        #canvas-container { flex: 1; position: relative; display: flex; flex-direction: column; }
        #simCanvas { flex: 2; }
        #graphCanvas { flex: 1; border-top: 1px solid #333; }
        #controls { width: 300px; background: rgba(0,0,0,0.9); padding: 20px; overflow-y: auto; }
        h1 { font-size: 1.1rem; margin-bottom: 15px; color: #06b6d4; }
        .control-group { margin-bottom: 12px; }
        label { display: block; font-size: 0.75rem; margin-bottom: 3px; color: #aaa; }
        input[type="range"] { width: 100%; }
        button { width: 100%; padding: 8px; margin-bottom: 8px; background: #0891b2; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 0.85rem; }
        button:hover { background: #0e7490; }
        .stats { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; font-size: 0.75rem; margin-bottom: 15px; }
        .stats div { margin-bottom: 3px; }
        .back-link { position: fixed; top: 10px; left: 10px; padding: 8px 16px; background: rgba(0,0,0,0.7); color: #06b6d4; text-decoration: none; border-radius: 6px; font-size: 14px; z-index: 999; }
        .description { font-size: 0.7rem; color: #888; margin-bottom: 12px; line-height: 1.4; }
        .reaction-list { font-size: 0.65rem; font-family: monospace; background: rgba(6, 182, 212, 0.1); padding: 8px; border-radius: 5px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back</a>
    <div id="container">
        <div id="canvas-container">
            <canvas id="simCanvas"></canvas>
            <canvas id="graphCanvas"></canvas>
        </div>
        <div id="controls">
            <h1>Atmospheric Chemistry</h1>
            <p class="description">Gas-phase reactions with photodissociation and catalytic cycles. Watch ozone formation and destruction.</p>
            
            <div class="reaction-list">
                <strong>Reactions:</strong><br>
                O₂ + hν → 2O<br>
                O + O₂ → O₃<br>
                O₃ + hν → O₂ + O<br>
                O₃ + NO → NO₂ + O₂<br>
                NO₂ + hν → NO + O
            </div>
            
            <div class="control-group">
                <label>UV Intensity: <span id="uvVal">1.0</span></label>
                <input type="range" id="uv" min="0" max="2" step="0.1" value="1">
            </div>
            <div class="control-group">
                <label>Temperature (K): <span id="tempVal">288</span></label>
                <input type="range" id="temp" min="220" max="320" value="288">
            </div>
            <div class="control-group">
                <label>NOx Level: <span id="noxVal">0.1</span></label>
                <input type="range" id="nox" min="0" max="0.5" step="0.02" value="0.1">
            </div>
            <div class="control-group">
                <label>Altitude (km): <span id="altVal">25</span></label>
                <input type="range" id="alt" min="0" max="50" value="25">
            </div>
            
            <button id="reset">Reset</button>
            <button id="pause">Pause</button>
            <button id="sunrise">Trigger Sunrise</button>
            <button id="pollution">Add Pollution</button>
            
            <div class="stats">
                <div>Time: <span id="time">0</span> min</div>
                <div>O₂: <span id="o2Count">0</span></div>
                <div>O (atomic): <span id="oCount">0</span></div>
                <div>O₃ (ozone): <span id="o3Count">0</span></div>
                <div>NO: <span id="noCount">0</span></div>
                <div>NO₂: <span id="no2Count">0</span></div>
            </div>
            
            <p class="description"><strong>Chapman Cycle:</strong> UV breaks O₂, atomic O combines with O₂ to form O₃. Balance determines ozone layer thickness.</p>
        </div>
    </div>
    <script>
        const simCanvas = document.getElementById('simCanvas');
        const graphCanvas = document.getElementById('graphCanvas');
        const sctx = simCanvas.getContext('2d');
        const gctx = graphCanvas.getContext('2d');
        
        let W, H, GW, GH;
        let molecules = [], paused = false;
        let time = 0;
        let history = [];
        let daylight = 1;
        
        const TYPES = {
            O2: { color: '#3b82f6', name: 'O₂', size: 8 },
            O: { color: '#22c55e', name: 'O', size: 5 },
            O3: { color: '#a855f7', name: 'O₃', size: 10 },
            NO: { color: '#f97316', name: 'NO', size: 7 },
            NO2: { color: '#ef4444', name: 'NO₂', size: 9 }
        };
        
        let params = {
            uvIntensity: 1.0,
            temperature: 288,
            noxLevel: 0.1,
            altitude: 25
        };
        
        function resize() {
            const c = document.getElementById('canvas-container');
            simCanvas.width = c.clientWidth;
            simCanvas.height = c.clientHeight * 0.6;
            graphCanvas.width = c.clientWidth;
            graphCanvas.height = c.clientHeight * 0.4;
            W = simCanvas.width;
            H = simCanvas.height;
            GW = graphCanvas.width;
            GH = graphCanvas.height;
        }
        
        function init() {
            resize();
            molecules = [];
            time = 0;
            history = [];
            daylight = 1;
            
            // Initial O2 molecules
            for (let i = 0; i < 150; i++) {
                molecules.push({
                    x: Math.random() * W,
                    y: Math.random() * H,
                    vx: (Math.random() - 0.5) * 2,
                    vy: (Math.random() - 0.5) * 2,
                    type: 'O2'
                });
            }
            
            // Some initial NOx
            const noxCount = Math.floor(params.noxLevel * 30);
            for (let i = 0; i < noxCount; i++) {
                molecules.push({
                    x: Math.random() * W,
                    y: Math.random() * H,
                    vx: (Math.random() - 0.5) * 2,
                    vy: (Math.random() - 0.5) * 2,
                    type: Math.random() < 0.5 ? 'NO' : 'NO2'
                });
            }
            
            updateStats();
        }
        
        function distance(m1, m2) {
            const dx = m1.x - m2.x;
            const dy = m1.y - m2.y;
            return Math.sqrt(dx * dx + dy * dy);
        }
        
        function countType(type) {
            return molecules.filter(m => m.type === type).length;
        }
        
        function step() {
            time++;
            
            // Day/night cycle affects UV
            const effectiveUV = params.uvIntensity * daylight * (1 + params.altitude / 50);
            
            // Move molecules
            const speed = Math.sqrt(params.temperature / 288);
            for (const mol of molecules) {
                mol.x += mol.vx * speed;
                mol.y += mol.vy * speed;
                
                // Boundaries
                if (mol.x < 0 || mol.x > W) mol.vx *= -1;
                if (mol.y < 0 || mol.y > H) mol.vy *= -1;
                mol.x = Math.max(0, Math.min(W, mol.x));
                mol.y = Math.max(0, Math.min(H, mol.y));
                
                // Random velocity change
                mol.vx += (Math.random() - 0.5) * 0.3;
                mol.vy += (Math.random() - 0.5) * 0.3;
                const s = Math.sqrt(mol.vx * mol.vx + mol.vy * mol.vy);
                if (s > 3) {
                    mol.vx = mol.vx / s * 3;
                    mol.vy = mol.vy / s * 3;
                }
            }
            
            // Photodissociation reactions
            for (let i = molecules.length - 1; i >= 0; i--) {
                const mol = molecules[i];
                
                // O2 + hν → 2O (UV photodissociation)
                if (mol.type === 'O2' && Math.random() < effectiveUV * 0.002) {
                    mol.type = 'O';
                    molecules.push({
                        x: mol.x + (Math.random() - 0.5) * 10,
                        y: mol.y + (Math.random() - 0.5) * 10,
                        vx: (Math.random() - 0.5) * 3,
                        vy: (Math.random() - 0.5) * 3,
                        type: 'O'
                    });
                }
                
                // O3 + hν → O2 + O (ozone photolysis)
                if (mol.type === 'O3' && Math.random() < effectiveUV * 0.01) {
                    mol.type = 'O2';
                    molecules.push({
                        x: mol.x,
                        y: mol.y,
                        vx: (Math.random() - 0.5) * 3,
                        vy: (Math.random() - 0.5) * 3,
                        type: 'O'
                    });
                }
                
                // NO2 + hν → NO + O
                if (mol.type === 'NO2' && Math.random() < effectiveUV * 0.02) {
                    mol.type = 'NO';
                    molecules.push({
                        x: mol.x,
                        y: mol.y,
                        vx: (Math.random() - 0.5) * 3,
                        vy: (Math.random() - 0.5) * 3,
                        type: 'O'
                    });
                }
            }
            
            // Collision reactions
            for (let i = 0; i < molecules.length; i++) {
                for (let j = i + 1; j < molecules.length; j++) {
                    const m1 = molecules[i];
                    const m2 = molecules[j];
                    
                    if (distance(m1, m2) < 15) {
                        // O + O2 → O3 (ozone formation)
                        if ((m1.type === 'O' && m2.type === 'O2') ||
                            (m1.type === 'O2' && m2.type === 'O')) {
                            if (Math.random() < 0.3) {
                                const oMol = m1.type === 'O' ? m1 : m2;
                                const o2Mol = m1.type === 'O2' ? m1 : m2;
                                o2Mol.type = 'O3';
                                molecules.splice(molecules.indexOf(oMol), 1);
                                break;
                            }
                        }
                        
                        // O3 + NO → NO2 + O2 (ozone destruction by NOx)
                        if ((m1.type === 'O3' && m2.type === 'NO') ||
                            (m1.type === 'NO' && m2.type === 'O3')) {
                            if (Math.random() < 0.5) {
                                const o3Mol = m1.type === 'O3' ? m1 : m2;
                                const noMol = m1.type === 'NO' ? m1 : m2;
                                o3Mol.type = 'O2';
                                noMol.type = 'NO2';
                            }
                        }
                        
                        // O + O → O2 (recombination)
                        if (m1.type === 'O' && m2.type === 'O') {
                            if (Math.random() < 0.2) {
                                m1.type = 'O2';
                                molecules.splice(j, 1);
                                break;
                            }
                        }
                    }
                }
            }
            
            // Record history
            if (time % 10 === 0) {
                history.push({
                    time: time,
                    O2: countType('O2'),
                    O: countType('O'),
                    O3: countType('O3'),
                    NO: countType('NO'),
                    NO2: countType('NO2')
                });
                if (history.length > 100) history.shift();
            }
            
            updateStats();
        }
        
        function updateStats() {
            document.getElementById('time').textContent = Math.floor(time / 6);
            document.getElementById('o2Count').textContent = countType('O2');
            document.getElementById('oCount').textContent = countType('O');
            document.getElementById('o3Count').textContent = countType('O3');
            document.getElementById('noCount').textContent = countType('NO');
            document.getElementById('no2Count').textContent = countType('NO2');
        }
        
        function drawSim() {
            // Sky gradient based on altitude and time
            const skyDark = daylight < 0.5 ? 0.3 : daylight;
            const gradient = sctx.createLinearGradient(0, 0, 0, H);
            gradient.addColorStop(0, `rgba(${20 * skyDark}, ${50 * skyDark}, ${100 * skyDark}, 1)`);
            gradient.addColorStop(1, `rgba(${50 * skyDark}, ${100 * skyDark}, ${180 * skyDark}, 1)`);
            sctx.fillStyle = gradient;
            sctx.fillRect(0, 0, W, H);
            
            // Sun rays (UV)
            if (daylight > 0.3) {
                const rayCount = Math.floor(params.uvIntensity * 10 * daylight);
                sctx.strokeStyle = `rgba(255, 255, 100, ${0.1 * params.uvIntensity * daylight})`;
                sctx.lineWidth = 2;
                for (let i = 0; i < rayCount; i++) {
                    const x = Math.random() * W;
                    sctx.beginPath();
                    sctx.moveTo(x, 0);
                    sctx.lineTo(x + (Math.random() - 0.5) * 30, H * 0.3);
                    sctx.stroke();
                }
            }
            
            // Draw molecules
            for (const mol of molecules) {
                const type = TYPES[mol.type];
                sctx.fillStyle = type.color;
                sctx.beginPath();
                sctx.arc(mol.x, mol.y, type.size, 0, Math.PI * 2);
                sctx.fill();
                
                // Label for larger molecules
                if (type.size >= 8) {
                    sctx.fillStyle = '#fff';
                    sctx.font = '8px sans-serif';
                    sctx.textAlign = 'center';
                    sctx.fillText(type.name, mol.x, mol.y + 3);
                }
            }
            
            // Info
            sctx.fillStyle = '#fff';
            sctx.font = 'bold 14px sans-serif';
            sctx.textAlign = 'left';
            sctx.fillText(`Atmospheric Chemistry - Alt: ${params.altitude}km`, 10, 20);
            sctx.font = '11px sans-serif';
            sctx.fillText(`UV: ${(params.uvIntensity * daylight).toFixed(1)} | Ozone: ${countType('O3')}`, 10, 38);
        }
        
        function drawGraph() {
            gctx.fillStyle = '#0a0f1a';
            gctx.fillRect(0, 0, GW, GH);
            
            if (history.length < 2) return;
            
            const margin = { left: 50, right: 20, top: 30, bottom: 30 };
            const graphW = GW - margin.left - margin.right;
            const graphH = GH - margin.top - margin.bottom;
            
            gctx.strokeStyle = '#333';
            gctx.beginPath();
            gctx.moveTo(margin.left, margin.top);
            gctx.lineTo(margin.left, GH - margin.bottom);
            gctx.lineTo(GW - margin.right, GH - margin.bottom);
            gctx.stroke();
            
            gctx.fillStyle = '#666';
            gctx.font = '11px sans-serif';
            gctx.fillText('Species Concentrations', margin.left, margin.top - 10);
            
            const minT = history[0].time;
            const maxT = history[history.length - 1].time;
            const maxVal = Math.max(
                ...history.map(h => Math.max(h.O2, h.O3, h.O, h.NO + h.NO2))
            );
            
            // Draw lines for each species
            const species = [
                { key: 'O2', color: '#3b82f6' },
                { key: 'O3', color: '#a855f7' },
                { key: 'O', color: '#22c55e' }
            ];
            
            for (const spec of species) {
                gctx.strokeStyle = spec.color;
                gctx.lineWidth = 2;
                gctx.beginPath();
                for (let i = 0; i < history.length; i++) {
                    const x = margin.left + ((history[i].time - minT) / (maxT - minT)) * graphW;
                    const y = GH - margin.bottom - (history[i][spec.key] / maxVal) * graphH;
                    if (i === 0) gctx.moveTo(x, y);
                    else gctx.lineTo(x, y);
                }
                gctx.stroke();
            }
            
            // Legend
            let legendX = GW - 100;
            for (const spec of species) {
                gctx.fillStyle = spec.color;
                gctx.fillRect(legendX, margin.top, 10, 10);
                gctx.fillStyle = '#888';
                gctx.fillText(spec.key, legendX + 15, margin.top + 9);
                legendX -= 50;
            }
        }
        
        function draw() {
            drawSim();
            drawGraph();
            requestAnimationFrame(draw);
        }
        
        let intervalId = null;
        function startSim() {
            if (intervalId) clearInterval(intervalId);
            intervalId = setInterval(() => {
                if (!paused) {
                    step();
                }
            }, 30);
        }
        
        // Event listeners
        document.getElementById('uv').addEventListener('input', e => {
            params.uvIntensity = +e.target.value;
            document.getElementById('uvVal').textContent = params.uvIntensity.toFixed(1);
        });
        document.getElementById('temp').addEventListener('input', e => {
            params.temperature = +e.target.value;
            document.getElementById('tempVal').textContent = params.temperature;
        });
        document.getElementById('nox').addEventListener('input', e => {
            params.noxLevel = +e.target.value;
            document.getElementById('noxVal').textContent = params.noxLevel.toFixed(2);
        });
        document.getElementById('alt').addEventListener('input', e => {
            params.altitude = +e.target.value;
            document.getElementById('altVal').textContent = params.altitude;
        });
        
        document.getElementById('reset').addEventListener('click', () => { init(); startSim(); });
        document.getElementById('pause').addEventListener('click', () => {
            paused = !paused;
            document.getElementById('pause').textContent = paused ? 'Resume' : 'Pause';
        });
        document.getElementById('sunrise').addEventListener('click', () => {
            daylight = 0;
            let rise = setInterval(() => {
                daylight += 0.02;
                if (daylight >= 1) {
                    daylight = 1;
                    clearInterval(rise);
                }
            }, 50);
        });
        document.getElementById('pollution').addEventListener('click', () => {
            for (let i = 0; i < 20; i++) {
                molecules.push({
                    x: Math.random() * W,
                    y: H - 50 + Math.random() * 50,
                    vx: (Math.random() - 0.5) * 2,
                    vy: -Math.random() * 2,
                    type: Math.random() < 0.5 ? 'NO' : 'NO2'
                });
            }
        });
        
        window.addEventListener('resize', resize);
        init();
        draw();
        startSim();
    </script>
</body>
</html>
