<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dice Stalagmite - Probability Visualization</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', system-ui, sans-serif;
            color: #e0e0e0;
        }
        .back-link {
            position: fixed;
            top: 15px;
            left: 15px;
            color: #f39c12;
            text-decoration: none;
            z-index: 100;
        }
        header { text-align: center; padding: 15px; }
        h1 { color: #f39c12; font-size: 1.6rem; }
        .container {
            display: grid;
            grid-template-columns: 1fr 280px;
            gap: 15px;
            padding: 0 15px 15px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .main-area { display: flex; flex-direction: column; gap: 15px; }
        .canvas-wrapper {
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            padding: 15px;
        }
        .canvas-wrapper h3 {
            color: #f39c12;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        #stalagmiteCanvas {
            width: 100%;
            height: 450px;
            background: #0a0a15;
            border-radius: 8px;
        }
        .dice-display {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            margin-top: 10px;
        }
        .die {
            width: 60px;
            height: 60px;
            background: #fff;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: #333;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .die.rolling {
            animation: shake 0.2s infinite;
        }
        @keyframes shake {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }
        .result-sum {
            text-align: center;
            font-size: 1.5rem;
            color: #f39c12;
            margin-top: 10px;
        }
        .sidebar {
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            padding: 15px;
        }
        .control-group { margin-bottom: 15px; }
        .control-group label {
            display: block;
            color: #f39c12;
            margin-bottom: 6px;
            font-size: 0.85rem;
        }
        input[type="range"] {
            width: 100%;
            -webkit-appearance: none;
            height: 5px;
            background: #333;
            border-radius: 3px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #f39c12;
            border-radius: 50%;
            cursor: pointer;
        }
        .value-display {
            text-align: right;
            font-size: 0.8rem;
            color: #888;
            margin-top: 4px;
        }
        button {
            width: 100%;
            padding: 10px;
            margin: 4px 0;
            background: #f39c12;
            border: none;
            border-radius: 5px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
        }
        button:hover { background: #e67e22; }
        button.secondary { background: #333; }
        button.running { background: #27ae60; }
        .stats {
            background: rgba(243, 156, 18, 0.1);
            border: 1px solid rgba(243, 156, 18, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 6px 0;
            font-size: 0.8rem;
        }
        .stat-label { color: #888; }
        .stat-value { color: #f39c12; font-family: monospace; }
        .info {
            margin-top: 12px;
            padding: 10px;
            background: rgba(243, 156, 18, 0.1);
            border-radius: 6px;
            font-size: 0.75rem;
            line-height: 1.4;
        }
        .info h4 { color: #f39c12; margin-bottom: 6px; }
        .expected-line {
            margin-top: 10px;
            padding: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            font-size: 0.75rem;
        }
        .expected-line span { color: #f39c12; }
        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">&larr; Back</a>

    <header>
        <h1>Dice Stalagmite</h1>
        <p style="color: #888; font-size: 0.9rem;">Probability Distribution Visualization</p>
    </header>

    <div class="container">
        <div class="main-area">
            <div class="canvas-wrapper">
                <h3>Sum Distribution</h3>
                <canvas id="stalagmiteCanvas"></canvas>
                <div class="dice-display" id="diceDisplay"></div>
                <div class="result-sum">Sum: <span id="currentSum">-</span></div>
            </div>
        </div>

        <div class="sidebar">
            <div class="control-group">
                <label>Number of Dice</label>
                <input type="range" id="numDice" min="1" max="6" value="2">
                <div class="value-display"><span id="numDiceVal">2</span> dice</div>
            </div>

            <div class="control-group">
                <label>Sides per Die</label>
                <input type="range" id="numSides" min="4" max="20" value="6">
                <div class="value-display"><span id="numSidesVal">6</span> sides</div>
            </div>

            <div class="control-group">
                <label>Roll Speed</label>
                <input type="range" id="speed" min="1" max="100" value="10">
                <div class="value-display"><span id="speedVal">10</span> rolls/sec</div>
            </div>

            <button id="rollBtn">Roll Once</button>
            <button id="autoBtn" class="secondary">Auto Roll</button>
            <button id="roll100Btn" class="secondary">Roll 100x</button>
            <button id="roll1000Btn" class="secondary">Roll 1000x</button>
            <button id="resetBtn" class="secondary">Reset</button>

            <div class="stats">
                <div class="stat-row">
                    <span class="stat-label">Total Rolls:</span>
                    <span class="stat-value" id="rollsStat">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Mean:</span>
                    <span class="stat-value" id="meanStat">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Expected Mean:</span>
                    <span class="stat-value" id="expectedStat">7.00</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Mode:</span>
                    <span class="stat-value" id="modeStat">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Std Dev:</span>
                    <span class="stat-value" id="stdStat">-</span>
                </div>
            </div>

            <div class="expected-line">
                <strong>Expected:</strong> For <span id="diceDesc">2d6</span>, mean = <span id="expMean">7.00</span>, most likely sum = <span id="expMode">7</span>
            </div>

            <div class="info">
                <h4>Stalagmite Formation</h4>
                <p>Watch as dice rolls form a stalactite-like histogram. With 2 dice, the middle values (7 for 2d6) are most likely due to the many ways to achieve them.</p>
                <p style="margin-top:6px">As rolls increase, the distribution approaches the theoretical probability.</p>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('stalagmiteCanvas');
        const ctx = canvas.getContext('2d');

        let numDice = 2;
        let numSides = 6;
        let rollSpeed = 10;
        let counts = {};
        let totalRolls = 0;
        let sumTotal = 0;
        let running = false;
        let animFrame;
        let lastRollTime = 0;
        let currentDice = [];

        function resize() {
            canvas.width = canvas.parentElement.clientWidth - 30;
            canvas.height = 450;
            render();
        }

        function getMinSum() { return numDice; }
        function getMaxSum() { return numDice * numSides; }

        function expectedMean() {
            return numDice * (numSides + 1) / 2;
        }

        function expectedMode() {
            return Math.round(expectedMean());
        }

        function initCounts() {
            counts = {};
            for (let s = getMinSum(); s <= getMaxSum(); s++) {
                counts[s] = 0;
            }
            totalRolls = 0;
            sumTotal = 0;
            currentDice = new Array(numDice).fill(0);
            updateDiceDisplay();
            updateStats();
            render();
        }

        function rollDice() {
            let sum = 0;
            currentDice = [];
            for (let i = 0; i < numDice; i++) {
                const value = Math.floor(Math.random() * numSides) + 1;
                currentDice.push(value);
                sum += value;
            }
            counts[sum]++;
            totalRolls++;
            sumTotal += sum;
            return sum;
        }

        function updateDiceDisplay() {
            const display = document.getElementById('diceDisplay');
            display.innerHTML = '';
            for (let i = 0; i < numDice; i++) {
                const die = document.createElement('div');
                die.className = 'die';
                die.textContent = currentDice[i] || '?';
                display.appendChild(die);
            }
        }

        function updateStats() {
            document.getElementById('rollsStat').textContent = totalRolls.toLocaleString();

            if (totalRolls > 0) {
                const mean = sumTotal / totalRolls;
                document.getElementById('meanStat').textContent = mean.toFixed(2);

                // Find mode
                let maxCount = 0;
                let mode = getMinSum();
                for (const [sum, count] of Object.entries(counts)) {
                    if (count > maxCount) {
                        maxCount = count;
                        mode = parseInt(sum);
                    }
                }
                document.getElementById('modeStat').textContent = mode;

                // Calculate std dev
                let variance = 0;
                for (const [sum, count] of Object.entries(counts)) {
                    const diff = parseInt(sum) - mean;
                    variance += diff * diff * count;
                }
                variance /= totalRolls;
                document.getElementById('stdStat').textContent = Math.sqrt(variance).toFixed(2);
            } else {
                document.getElementById('meanStat').textContent = '-';
                document.getElementById('modeStat').textContent = '-';
                document.getElementById('stdStat').textContent = '-';
            }

            document.getElementById('expectedStat').textContent = expectedMean().toFixed(2);
            document.getElementById('diceDesc').textContent = `${numDice}d${numSides}`;
            document.getElementById('expMean').textContent = expectedMean().toFixed(2);
            document.getElementById('expMode').textContent = expectedMode();
        }

        function render() {
            const w = canvas.width;
            const h = canvas.height;

            ctx.fillStyle = '#0a0a15';
            ctx.fillRect(0, 0, w, h);

            const minSum = getMinSum();
            const maxSum = getMaxSum();
            const numBuckets = maxSum - minSum + 1;
            const bucketWidth = (w - 60) / numBuckets;
            const maxCount = Math.max(...Object.values(counts), 1);
            const maxHeight = h - 80;

            // Draw stalagmites
            for (let sum = minSum; sum <= maxSum; sum++) {
                const count = counts[sum] || 0;
                const x = 30 + (sum - minSum) * bucketWidth;
                const barHeight = (count / maxCount) * maxHeight;

                // Gradient based on probability
                const distFromCenter = Math.abs(sum - expectedMean());
                const maxDist = (maxSum - minSum) / 2;
                const hue = 30 + 20 * (distFromCenter / maxDist); // Orange to yellow

                ctx.fillStyle = `hsl(${hue}, 80%, 50%)`;
                ctx.fillRect(x + 2, h - 40 - barHeight, bucketWidth - 4, barHeight);

                // Count label on top of bar
                if (count > 0 && barHeight > 15) {
                    ctx.fillStyle = '#fff';
                    ctx.font = '10px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(count, x + bucketWidth / 2, h - 45 - barHeight);
                }

                // Sum label at bottom
                ctx.fillStyle = '#888';
                ctx.font = '11px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(sum, x + bucketWidth / 2, h - 25);
            }

            // Draw expected line
            const expX = 30 + (expectedMean() - minSum) * bucketWidth + bucketWidth / 2;
            ctx.strokeStyle = 'rgba(231, 76, 60, 0.7)';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(expX, 20);
            ctx.lineTo(expX, h - 40);
            ctx.stroke();
            ctx.setLineDash([]);

            ctx.fillStyle = '#e74c3c';
            ctx.font = '11px sans-serif';
            ctx.fillText('Expected', expX, 15);

            // Axis labels
            ctx.fillStyle = '#888';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Sum of Dice', w / 2, h - 5);

            ctx.save();
            ctx.translate(15, h / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Frequency', 0, 0);
            ctx.restore();
        }

        function singleRoll(animate = true) {
            const sum = rollDice();
            if (animate) {
                updateDiceDisplay();
                document.getElementById('currentSum').textContent = sum;
            }
            updateStats();
            render();
        }

        function multiRoll(count) {
            for (let i = 0; i < count; i++) {
                rollDice();
            }
            updateDiceDisplay();
            document.getElementById('currentSum').textContent = currentDice.reduce((a, b) => a + b, 0);
            updateStats();
            render();
        }

        function animate(timestamp) {
            if (!running) return;

            const interval = 1000 / rollSpeed;
            if (timestamp - lastRollTime >= interval) {
                singleRoll();
                lastRollTime = timestamp;
            }

            animFrame = requestAnimationFrame(animate);
        }

        // Event listeners
        document.getElementById('numDice').addEventListener('input', (e) => {
            numDice = parseInt(e.target.value);
            document.getElementById('numDiceVal').textContent = numDice;
            initCounts();
        });

        document.getElementById('numSides').addEventListener('input', (e) => {
            numSides = parseInt(e.target.value);
            document.getElementById('numSidesVal').textContent = numSides;
            initCounts();
        });

        document.getElementById('speed').addEventListener('input', (e) => {
            rollSpeed = parseInt(e.target.value);
            document.getElementById('speedVal').textContent = rollSpeed;
        });

        document.getElementById('rollBtn').addEventListener('click', () => singleRoll(true));

        document.getElementById('autoBtn').addEventListener('click', (e) => {
            running = !running;
            if (running) {
                e.target.textContent = 'Stop';
                e.target.classList.add('running');
                lastRollTime = 0;
                animFrame = requestAnimationFrame(animate);
            } else {
                e.target.textContent = 'Auto Roll';
                e.target.classList.remove('running');
                cancelAnimationFrame(animFrame);
            }
        });

        document.getElementById('roll100Btn').addEventListener('click', () => multiRoll(100));
        document.getElementById('roll1000Btn').addEventListener('click', () => multiRoll(1000));

        document.getElementById('resetBtn').addEventListener('click', () => {
            running = false;
            document.getElementById('autoBtn').textContent = 'Auto Roll';
            document.getElementById('autoBtn').classList.remove('running');
            cancelAnimationFrame(animFrame);
            initCounts();
        });

        window.addEventListener('resize', resize);
        resize();
        initCounts();
    </script>
</body>
</html>
