<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffic 2 Lanes - CCAB</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            font-family: 'Segoe UI', Arial, sans-serif;
            color: white;
        }
        .container { display: flex; height: 100vh; }
        .canvas-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            gap: 10px;
        }
        canvas { border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 8px; }
        .controls {
            width: 320px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.6);
            overflow-y: auto;
        }
        h2 { margin: 0 0 15px 0; color: #ffeaa7; }
        h3 { margin: 15px 0 8px 0; color: #fdcb6e; font-size: 14px; }
        .slider-group { margin: 12px 0; }
        .slider-group label { display: block; margin-bottom: 5px; font-size: 13px; }
        input[type="range"] { width: 100%; }
        .stats {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .stat-row { display: flex; justify-content: space-between; margin: 5px 0; font-size: 13px; }
        .description {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.5;
            margin-top: 15px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: #ffeaa7;
            color: #1a1a2e;
            font-weight: bold;
        }
        button:hover { background: #fdcb6e; }
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            font-size: 12px;
        }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .legend-color { width: 20px; height: 12px; border-radius: 3px; }
    </style>
</head>
<body>
    <a href="index.html" class="organic-back-link" style="position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; align-items: center; gap: 8px; padding: 10px 16px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-radius: 30px; text-decoration: none; color: #606C38; font-family: 'Nunito', sans-serif; font-weight: 600;">
        <span>‚Üê Gallery</span>
    </a>
    <div class="container">
        <div class="canvas-area">
            <canvas id="roadCanvas"></canvas>
            <div class="legend">
                <div class="legend-item"><div class="legend-color" style="background: #74b9ff;"></div> Normal</div>
                <div class="legend-item"><div class="legend-color" style="background: #55efc4;"></div> Fast</div>
                <div class="legend-item"><div class="legend-color" style="background: #fd79a8;"></div> Slow</div>
                <div class="legend-item"><div class="legend-color" style="background: #ffeaa7;"></div> Lane Change</div>
            </div>
            <canvas id="graphCanvas"></canvas>
        </div>
        <div class="controls">
            <h2>üöó Two-Lane Traffic</h2>
            <p style="font-size: 12px; opacity: 0.8;">Highway lane-changing dynamics</p>

            <h3>Number of Cars</h3>
            <div class="slider-group">
                <label>Cars: <span id="carsVal">40</span></label>
                <input type="range" id="cars" min="10" max="80" step="5" value="40">
            </div>

            <h3>Slow Car Ratio</h3>
            <div class="slider-group">
                <label>Ratio: <span id="slowVal">0.2</span></label>
                <input type="range" id="slow" min="0" max="0.5" step="0.05" value="0.2">
            </div>

            <h3>Lane Change Threshold</h3>
            <div class="slider-group">
                <label>Distance: <span id="thresholdVal">3</span> car lengths</label>
                <input type="range" id="threshold" min="1" max="6" step="0.5" value="3">
            </div>

            <h3>Patience</h3>
            <div class="slider-group">
                <label>Patience: <span id="patienceVal">5</span> ticks</label>
                <input type="range" id="patience" min="1" max="15" step="1" value="5">
            </div>

            <h3>Speed</h3>
            <div class="slider-group">
                <label>Delay: <span id="speedVal">30</span>ms</label>
                <input type="range" id="speed" min="10" max="100" step="10" value="30">
            </div>

            <button onclick="reset()">Reset</button>
            <button onclick="togglePause()" id="pauseBtn">Pause</button>
            <button onclick="addSlowCar()">Add Slow Car</button>

            <div class="stats">
                <div class="stat-row"><span>Time:</span><span id="time">0</span></div>
                <div class="stat-row"><span>Lane 1 Cars:</span><span id="lane1">0</span></div>
                <div class="stat-row"><span>Lane 2 Cars:</span><span id="lane2">0</span></div>
                <div class="stat-row"><span>Lane Changes:</span><span id="laneChanges">0</span></div>
                <div class="stat-row"><span>Avg Speed (Lane 1):</span><span id="avgSpeed1">0</span></div>
                <div class="stat-row"><span>Avg Speed (Lane 2):</span><span id="avgSpeed2">0</span></div>
                <div class="stat-row"><span>Throughput:</span><span id="throughput">0</span> cars/100t</div>
            </div>

            <div class="description">
                <strong>Two-Lane Highway:</strong><br>
                Cars change lanes when blocked by slower traffic ahead.<br><br>
                <strong>Lane Change Rules:</strong><br>
                ‚Ä¢ Check if car ahead is too close<br>
                ‚Ä¢ Look for gap in other lane<br>
                ‚Ä¢ Wait patience ticks before changing<br>
                ‚Ä¢ Faster cars more likely to change<br><br>
                <strong>Emergent Behavior:</strong><br>
                ‚Ä¢ Traffic waves and phantom jams<br>
                ‚Ä¢ Optimal lane utilization patterns<br>
                ‚Ä¢ Slow car clustering effects
            </div>
        </div>
    </div>

    <script>
        const roadCanvas = document.getElementById('roadCanvas');
        const roadCtx = roadCanvas.getContext('2d');
        const graphCanvas = document.getElementById('graphCanvas');
        const graphCtx = graphCanvas.getContext('2d');

        const ROAD_LENGTH = 800;
        const LANE_HEIGHT = 50;
        roadCanvas.width = ROAD_LENGTH;
        roadCanvas.height = LANE_HEIGHT * 2 + 40;
        graphCanvas.width = ROAD_LENGTH;
        graphCanvas.height = 120;

        const CAR_LENGTH = 30;
        const CAR_WIDTH = 18;

        let cars = [];
        let numCars = 40;
        let slowRatio = 0.2;
        let laneChangeThreshold = 3;
        let patience = 5;
        let speed = 30;
        let time = 0;
        let paused = false;
        let animationId = null;
        let laneChanges = 0;
        let throughput = 0;
        let passedCars = 0;
        let speedHistory = { lane1: [], lane2: [] };

        function createCars() {
            cars = [];
            const positions = [];

            // Create cars with random positions
            for (let i = 0; i < numCars; i++) {
                let attempts = 0;
                let x, lane;

                do {
                    x = Math.random() * (ROAD_LENGTH - CAR_LENGTH);
                    lane = Math.random() < 0.5 ? 0 : 1;
                    attempts++;
                } while (attempts < 100 && positions.some(p =>
                    p.lane === lane && Math.abs(p.x - x) < CAR_LENGTH * 1.5
                ));

                positions.push({ x, lane });

                const isSlow = Math.random() < slowRatio;
                const maxSpeed = isSlow ? 2 + Math.random() : 4 + Math.random() * 2;

                cars.push({
                    x,
                    lane,
                    speed: maxSpeed * 0.8,
                    maxSpeed,
                    type: isSlow ? 'slow' : (maxSpeed > 5 ? 'fast' : 'normal'),
                    patience: 0,
                    changingLane: false,
                    changeProgress: 0
                });
            }
        }

        function reset() {
            if (animationId) clearTimeout(animationId);
            numCars = parseInt(document.getElementById('cars').value);
            slowRatio = parseFloat(document.getElementById('slow').value);
            laneChangeThreshold = parseFloat(document.getElementById('threshold').value);
            patience = parseInt(document.getElementById('patience').value);
            speed = parseInt(document.getElementById('speed').value);

            time = 0;
            laneChanges = 0;
            passedCars = 0;
            throughput = 0;
            speedHistory = { lane1: [], lane2: [] };
            paused = false;
            document.getElementById('pauseBtn').textContent = 'Pause';

            createCars();
            animate();
        }

        function addSlowCar() {
            const lane = Math.random() < 0.5 ? 0 : 1;
            cars.push({
                x: 0,
                lane,
                speed: 1,
                maxSpeed: 2,
                type: 'slow',
                patience: 0,
                changingLane: false,
                changeProgress: 0
            });
        }

        function getCarAhead(car, lane) {
            let minDist = Infinity;
            let ahead = null;

            for (const other of cars) {
                if (other === car || other.lane !== lane) continue;

                let dist = other.x - car.x;
                if (dist < 0) dist += ROAD_LENGTH; // Wrap around

                if (dist < minDist && dist > 0) {
                    minDist = dist;
                    ahead = other;
                }
            }

            return { car: ahead, distance: minDist };
        }

        function canChangeLane(car, targetLane) {
            for (const other of cars) {
                if (other === car || other.lane !== targetLane) continue;

                const dist = Math.abs(other.x - car.x);
                if (dist < CAR_LENGTH * 2) return false;
            }
            return true;
        }

        function step() {
            for (const car of cars) {
                // Get car ahead in current lane
                const { car: ahead, distance } = getCarAhead(car, car.lane);

                // Adjust speed based on car ahead
                if (ahead && distance < CAR_LENGTH * 4) {
                    // Slow down
                    const targetSpeed = Math.min(car.maxSpeed, ahead.speed * 0.9);
                    car.speed = Math.max(0.5, car.speed * 0.95 + targetSpeed * 0.05);

                    // Consider lane change
                    if (distance < CAR_LENGTH * laneChangeThreshold && car.speed < car.maxSpeed * 0.7) {
                        car.patience++;

                        if (car.patience >= patience && !car.changingLane) {
                            const targetLane = 1 - car.lane;
                            if (canChangeLane(car, targetLane)) {
                                car.changingLane = true;
                                car.targetLane = targetLane;
                                car.changeProgress = 0;
                                laneChanges++;
                            }
                        }
                    }
                } else {
                    // Speed up toward max
                    car.speed = Math.min(car.maxSpeed, car.speed * 1.02 + 0.1);
                    car.patience = Math.max(0, car.patience - 1);
                }

                // Handle lane change animation
                if (car.changingLane) {
                    car.changeProgress += 0.1;
                    if (car.changeProgress >= 1) {
                        car.lane = car.targetLane;
                        car.changingLane = false;
                        car.patience = 0;
                    }
                }

                // Move car
                car.x += car.speed;

                // Wrap around
                if (car.x > ROAD_LENGTH) {
                    car.x -= ROAD_LENGTH;
                    passedCars++;
                }
            }

            time++;

            // Calculate throughput every 100 ticks
            if (time % 100 === 0) {
                throughput = passedCars;
                passedCars = 0;
            }

            // Record speed history
            const lane1Cars = cars.filter(c => c.lane === 0 && !c.changingLane);
            const lane2Cars = cars.filter(c => c.lane === 1 && !c.changingLane);

            const avg1 = lane1Cars.length > 0 ? lane1Cars.reduce((s, c) => s + c.speed, 0) / lane1Cars.length : 0;
            const avg2 = lane2Cars.length > 0 ? lane2Cars.reduce((s, c) => s + c.speed, 0) / lane2Cars.length : 0;

            speedHistory.lane1.push(avg1);
            speedHistory.lane2.push(avg2);

            if (speedHistory.lane1.length > 300) {
                speedHistory.lane1.shift();
                speedHistory.lane2.shift();
            }
        }

        function updateStats() {
            const lane1Cars = cars.filter(c => c.lane === 0 && !c.changingLane);
            const lane2Cars = cars.filter(c => c.lane === 1 && !c.changingLane);

            const avg1 = lane1Cars.length > 0 ? lane1Cars.reduce((s, c) => s + c.speed, 0) / lane1Cars.length : 0;
            const avg2 = lane2Cars.length > 0 ? lane2Cars.reduce((s, c) => s + c.speed, 0) / lane2Cars.length : 0;

            document.getElementById('time').textContent = time;
            document.getElementById('lane1').textContent = lane1Cars.length;
            document.getElementById('lane2').textContent = lane2Cars.length;
            document.getElementById('laneChanges').textContent = laneChanges;
            document.getElementById('avgSpeed1').textContent = avg1.toFixed(1);
            document.getElementById('avgSpeed2').textContent = avg2.toFixed(1);
            document.getElementById('throughput').textContent = throughput;
        }

        function draw() {
            // Road background
            roadCtx.fillStyle = '#2d3436';
            roadCtx.fillRect(0, 0, roadCanvas.width, roadCanvas.height);

            // Lane markings
            roadCtx.strokeStyle = '#ffeaa7';
            roadCtx.lineWidth = 2;
            roadCtx.setLineDash([20, 20]);
            roadCtx.beginPath();
            roadCtx.moveTo(0, 20 + LANE_HEIGHT);
            roadCtx.lineTo(ROAD_LENGTH, 20 + LANE_HEIGHT);
            roadCtx.stroke();
            roadCtx.setLineDash([]);

            // Edge lines
            roadCtx.strokeStyle = 'white';
            roadCtx.lineWidth = 3;
            roadCtx.beginPath();
            roadCtx.moveTo(0, 20);
            roadCtx.lineTo(ROAD_LENGTH, 20);
            roadCtx.moveTo(0, 20 + LANE_HEIGHT * 2);
            roadCtx.lineTo(ROAD_LENGTH, 20 + LANE_HEIGHT * 2);
            roadCtx.stroke();

            // Draw cars
            for (const car of cars) {
                let y;
                if (car.changingLane) {
                    const startY = 20 + car.lane * LANE_HEIGHT + LANE_HEIGHT / 2;
                    const endY = 20 + car.targetLane * LANE_HEIGHT + LANE_HEIGHT / 2;
                    y = startY + (endY - startY) * car.changeProgress;
                } else {
                    y = 20 + car.lane * LANE_HEIGHT + LANE_HEIGHT / 2;
                }

                // Car body color
                let color;
                if (car.changingLane) {
                    color = '#ffeaa7';
                } else if (car.type === 'slow') {
                    color = '#fd79a8';
                } else if (car.type === 'fast') {
                    color = '#55efc4';
                } else {
                    color = '#74b9ff';
                }

                // Car body
                roadCtx.fillStyle = color;
                roadCtx.beginPath();
                roadCtx.roundRect(car.x - CAR_LENGTH / 2, y - CAR_WIDTH / 2, CAR_LENGTH, CAR_WIDTH, 5);
                roadCtx.fill();

                // Headlights
                roadCtx.fillStyle = '#ffeaa7';
                roadCtx.fillRect(car.x + CAR_LENGTH / 2 - 4, y - CAR_WIDTH / 2 + 2, 3, 4);
                roadCtx.fillRect(car.x + CAR_LENGTH / 2 - 4, y + CAR_WIDTH / 2 - 6, 3, 4);

                // Brake lights (when slowing)
                if (car.speed < car.maxSpeed * 0.5) {
                    roadCtx.fillStyle = '#e17055';
                    roadCtx.fillRect(car.x - CAR_LENGTH / 2 + 1, y - CAR_WIDTH / 2 + 2, 3, 4);
                    roadCtx.fillRect(car.x - CAR_LENGTH / 2 + 1, y + CAR_WIDTH / 2 - 6, 3, 4);
                }
            }

            // Speed graph
            graphCtx.fillStyle = '#1a1a2e';
            graphCtx.fillRect(0, 0, graphCanvas.width, graphCanvas.height);

            if (speedHistory.lane1.length > 1) {
                const maxSpeed = 8;

                // Lane 1
                graphCtx.strokeStyle = '#74b9ff';
                graphCtx.lineWidth = 2;
                graphCtx.beginPath();
                for (let i = 0; i < speedHistory.lane1.length; i++) {
                    const x = (i / (speedHistory.lane1.length - 1)) * graphCanvas.width;
                    const y = graphCanvas.height - 20 - (speedHistory.lane1[i] / maxSpeed) * (graphCanvas.height - 30);
                    if (i === 0) graphCtx.moveTo(x, y);
                    else graphCtx.lineTo(x, y);
                }
                graphCtx.stroke();

                // Lane 2
                graphCtx.strokeStyle = '#55efc4';
                graphCtx.beginPath();
                for (let i = 0; i < speedHistory.lane2.length; i++) {
                    const x = (i / (speedHistory.lane2.length - 1)) * graphCanvas.width;
                    const y = graphCanvas.height - 20 - (speedHistory.lane2[i] / maxSpeed) * (graphCanvas.height - 30);
                    if (i === 0) graphCtx.moveTo(x, y);
                    else graphCtx.lineTo(x, y);
                }
                graphCtx.stroke();
            }

            graphCtx.fillStyle = 'white';
            graphCtx.font = '11px Arial';
            graphCtx.fillText('Average speed over time', 5, 12);
            graphCtx.fillStyle = '#74b9ff';
            graphCtx.fillText('Lane 1', graphCanvas.width - 100, 12);
            graphCtx.fillStyle = '#55efc4';
            graphCtx.fillText('Lane 2', graphCanvas.width - 50, 12);
        }

        function animate() {
            if (!paused) {
                step();
                updateStats();
            }
            draw();
            animationId = setTimeout(animate, speed);
        }

        function togglePause() {
            paused = !paused;
            document.getElementById('pauseBtn').textContent = paused ? 'Resume' : 'Pause';
        }

        // Event listeners
        document.getElementById('cars').oninput = function() {
            document.getElementById('carsVal').textContent = this.value;
        };
        document.getElementById('slow').oninput = function() {
            slowRatio = parseFloat(this.value);
            document.getElementById('slowVal').textContent = slowRatio.toFixed(2);
        };
        document.getElementById('threshold').oninput = function() {
            laneChangeThreshold = parseFloat(this.value);
            document.getElementById('thresholdVal').textContent = laneChangeThreshold;
        };
        document.getElementById('patience').oninput = function() {
            patience = parseInt(this.value);
            document.getElementById('patienceVal').textContent = patience;
        };
        document.getElementById('speed').oninput = function() {
            speed = parseInt(this.value);
            document.getElementById('speedVal').textContent = speed;
        };

        reset();
    </script>
</body>
</html>
