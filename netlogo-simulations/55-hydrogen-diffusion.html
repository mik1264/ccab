<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hydrogen Diffusion - Molecular Transport</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e8e8e8;
            min-height: 100vh;
            display: flex;
        }
        .sidebar {
            width: 300px;
            background: rgba(0,0,0,0.3);
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid rgba(255,255,255,0.1);
        }
        .main { flex: 1; display: flex; flex-direction: column; }
        h1 { font-size: 1.4em; margin-bottom: 5px; color: #81ecec; }
        .subtitle { font-size: 0.85em; color: #888; margin-bottom: 20px; }
        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; font-size: 0.85em; color: #aaa; margin-bottom: 5px; }
        .control-group input[type="range"] { width: 100%; }
        .control-group .value { font-size: 0.8em; color: #81ecec; }
        .buttons { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        button { padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9em; }
        .btn-primary { background: #81ecec; color: #000; }
        .btn-secondary { background: #444; color: #fff; }
        .btn-danger { background: #e74c3c; color: #fff; }
        .stats { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .stats h3 { font-size: 0.9em; color: #81ecec; margin-bottom: 10px; }
        .stat-row { display: flex; justify-content: space-between; font-size: 0.85em; margin-bottom: 5px; }
        .stat-value { color: #81ecec; }
        .canvas-container { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; gap: 15px; }
        canvas { background: #0a0a1a; border-radius: 10px; }
        .back-link { display: inline-block; color: #81ecec; text-decoration: none; margin-bottom: 20px; font-size: 0.9em; }
        .info { font-size: 0.75em; color: #666; line-height: 1.5; margin-top: 10px; }
        .media-select { width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #444; background: #2a2a3e; color: #fff; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <a href="index.html" class="back-link">‚Üê Back to Gallery</a>
        <h1>Hydrogen Diffusion</h1>
        <p class="subtitle">Molecular Transport Visualization</p>

        <div class="buttons">
            <button class="btn-primary" id="startBtn">Start</button>
            <button class="btn-secondary" id="stepBtn">Step</button>
            <button class="btn-danger" id="resetBtn">Reset</button>
        </div>

        <div class="control-group">
            <label>Medium</label>
            <select class="media-select" id="medium">
                <option value="vacuum">Vacuum</option>
                <option value="air" selected>Air</option>
                <option value="water">Water</option>
                <option value="metal">Metal Lattice</option>
            </select>
        </div>

        <div class="control-group">
            <label>H2 Molecules: <span class="value" id="h2Val">100</span></label>
            <input type="range" id="h2Count" min="20" max="200" value="100">
        </div>

        <div class="control-group">
            <label>Temperature: <span class="value" id="tempVal">300</span>K</label>
            <input type="range" id="temperature" min="100" max="800" value="300">
        </div>

        <div class="control-group">
            <label>Concentration Gradient</label>
            <input type="checkbox" id="gradient" checked>
            <span style="font-size: 0.8em; color: #aaa;">Start on left side</span>
        </div>

        <div class="stats">
            <h3>Diffusion Statistics</h3>
            <div class="stat-row"><span>Left Region:</span><span class="stat-value" id="leftCount">0</span></div>
            <div class="stat-row"><span>Right Region:</span><span class="stat-value" id="rightCount">0</span></div>
            <div class="stat-row"><span>Diffusion Coeff:</span><span class="stat-value" id="diffCoeff">0</span></div>
            <div class="stat-row"><span>MSD:</span><span class="stat-value" id="msd">0</span></div>
            <div class="stat-row"><span>Avg Speed:</span><span class="stat-value" id="avgSpeed">0</span></div>
            <div class="stat-row"><span>Time:</span><span class="stat-value" id="time">0</span></div>
        </div>

        <p class="info">
            Hydrogen (H2) is the smallest molecule and diffuses rapidly through many media.
            The diffusion coefficient D relates to MSD via Einstein relation: MSD = 2Dt.
            Temperature increases molecular velocity and diffusion rate.
        </p>
    </div>

    <div class="main">
        <div class="canvas-container">
            <canvas id="canvas"></canvas>
            <canvas id="histCanvas" height="100"></canvas>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const histCanvas = document.getElementById('histCanvas');
        const histCtx = histCanvas.getContext('2d');

        let running = false, molecules = [], time = 0;
        let medium = 'air', temperature = 300;
        const MEDIA_PROPS = {
            vacuum: { friction: 0.001, obstacles: 0 },
            air: { friction: 0.05, obstacles: 0 },
            water: { friction: 0.15, obstacles: 0.1 },
            metal: { friction: 0.02, obstacles: 0.3 }
        };
        let obstacles = [];

        function resizeCanvas() {
            const container = canvas.parentElement;
            const w = Math.min(container.clientWidth - 40, 600);
            canvas.width = w; canvas.height = w * 0.6;
            histCanvas.width = w;
        }

        function createMolecule(forceLeft = false) {
            const props = MEDIA_PROPS[medium];
            const speed = Math.sqrt(temperature / 300) * 3;
            const angle = Math.random() * Math.PI * 2;
            const useGradient = document.getElementById('gradient').checked;
            return {
                x: forceLeft || useGradient ? 20 + Math.random() * canvas.width * 0.2 : 20 + Math.random() * (canvas.width - 40),
                y: 20 + Math.random() * (canvas.height - 40),
                vx: Math.cos(angle) * speed,
                vy: Math.sin(angle) * speed,
                startX: 0, startY: 0 // For MSD calculation
            };
        }

        function createObstacles() {
            obstacles = [];
            const props = MEDIA_PROPS[medium];
            const numObstacles = Math.floor(props.obstacles * canvas.width * canvas.height / 1000);
            for (let i = 0; i < numObstacles; i++) {
                obstacles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    r: 5 + Math.random() * 10
                });
            }
        }

        function init() {
            molecules = [];
            const h2Count = parseInt(document.getElementById('h2Count').value);
            for (let i = 0; i < h2Count; i++) {
                const m = createMolecule();
                m.startX = m.x; m.startY = m.y;
                molecules.push(m);
            }
            createObstacles();
            time = 0;
        }

        function update() {
            time++;
            const props = MEDIA_PROPS[medium];
            const speedFactor = Math.sqrt(temperature / 300);

            for (const m of molecules) {
                // Random thermal motion
                m.vx += (Math.random() - 0.5) * speedFactor * 0.5;
                m.vy += (Math.random() - 0.5) * speedFactor * 0.5;

                // Friction
                m.vx *= (1 - props.friction);
                m.vy *= (1 - props.friction);

                // Speed limit based on temperature
                const speed = Math.sqrt(m.vx * m.vx + m.vy * m.vy);
                const maxSpeed = speedFactor * 5;
                if (speed > maxSpeed) {
                    m.vx *= maxSpeed / speed;
                    m.vy *= maxSpeed / speed;
                }

                m.x += m.vx;
                m.y += m.vy;

                // Wall bounce
                if (m.x < 5) { m.x = 5; m.vx *= -0.9; }
                if (m.x > canvas.width - 5) { m.x = canvas.width - 5; m.vx *= -0.9; }
                if (m.y < 5) { m.y = 5; m.vy *= -0.9; }
                if (m.y > canvas.height - 5) { m.y = canvas.height - 5; m.vy *= -0.9; }

                // Obstacle collision
                for (const obs of obstacles) {
                    const dx = m.x - obs.x;
                    const dy = m.y - obs.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < obs.r + 3) {
                        const nx = dx / dist;
                        const ny = dy / dist;
                        m.x = obs.x + nx * (obs.r + 4);
                        m.y = obs.y + ny * (obs.r + 4);
                        const dot = m.vx * nx + m.vy * ny;
                        m.vx -= 2 * dot * nx;
                        m.vy -= 2 * dot * ny;
                    }
                }
            }
        }

        function draw() {
            ctx.fillStyle = '#0a0a1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw divider
            ctx.strokeStyle = 'rgba(255,255,255,0.2)';
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2, 0);
            ctx.lineTo(canvas.width / 2, canvas.height);
            ctx.stroke();
            ctx.setLineDash([]);

            // Draw obstacles
            for (const obs of obstacles) {
                ctx.beginPath();
                ctx.arc(obs.x, obs.y, obs.r, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(100, 100, 120, 0.5)';
                ctx.fill();
            }

            // Draw H2 molecules
            for (const m of molecules) {
                ctx.beginPath();
                ctx.arc(m.x, m.y, 4, 0, Math.PI * 2);
                ctx.fillStyle = '#81ecec';
                ctx.fill();

                // Trail
                ctx.beginPath();
                ctx.moveTo(m.x, m.y);
                ctx.lineTo(m.x - m.vx * 3, m.y - m.vy * 3);
                ctx.strokeStyle = 'rgba(129, 236, 236, 0.3)';
                ctx.lineWidth = 2;
                ctx.stroke();
            }

            // Labels
            ctx.fillStyle = '#666';
            ctx.font = '12px sans-serif';
            ctx.fillText('Left Region', 10, 15);
            ctx.fillText('Right Region', canvas.width - 80, 15);
        }

        function drawHistogram() {
            histCtx.fillStyle = '#0a0a1a';
            histCtx.fillRect(0, 0, histCanvas.width, histCanvas.height);

            // Calculate position histogram
            const bins = 20;
            const counts = new Array(bins).fill(0);
            for (const m of molecules) {
                const bin = Math.min(bins - 1, Math.floor(m.x / canvas.width * bins));
                counts[bin]++;
            }

            const maxCount = Math.max(...counts, 1);
            const barWidth = histCanvas.width / bins;

            for (let i = 0; i < bins; i++) {
                const height = (counts[i] / maxCount) * (histCanvas.height - 20);
                histCtx.fillStyle = i < bins / 2 ? '#74b9ff' : '#fd79a8';
                histCtx.fillRect(i * barWidth + 1, histCanvas.height - height - 10, barWidth - 2, height);
            }

            histCtx.fillStyle = '#888';
            histCtx.font = '10px sans-serif';
            histCtx.fillText('Position Distribution', 5, 12);
        }

        function updateStats() {
            let leftCount = 0, rightCount = 0;
            let totalSpeed = 0, totalMSD = 0;

            for (const m of molecules) {
                if (m.x < canvas.width / 2) leftCount++;
                else rightCount++;
                totalSpeed += Math.sqrt(m.vx * m.vx + m.vy * m.vy);
                const dx = m.x - m.startX;
                const dy = m.y - m.startY;
                totalMSD += dx * dx + dy * dy;
            }

            const avgMSD = totalMSD / molecules.length;
            const diffCoeff = time > 0 ? (avgMSD / (4 * time)).toFixed(3) : 0;

            document.getElementById('leftCount').textContent = leftCount;
            document.getElementById('rightCount').textContent = rightCount;
            document.getElementById('diffCoeff').textContent = diffCoeff;
            document.getElementById('msd').textContent = avgMSD.toFixed(1);
            document.getElementById('avgSpeed').textContent = (totalSpeed / molecules.length).toFixed(2);
            document.getElementById('time').textContent = time;
        }

        function animate() {
            if (running) update();
            draw();
            drawHistogram();
            updateStats();
            requestAnimationFrame(animate);
        }

        function reset() {
            running = false;
            document.getElementById('startBtn').textContent = 'Start';
            medium = document.getElementById('medium').value;
            temperature = parseInt(document.getElementById('temperature').value);
            resizeCanvas();
            init();
        }

        document.getElementById('startBtn').addEventListener('click', () => {
            running = !running;
            document.getElementById('startBtn').textContent = running ? 'Pause' : 'Start';
        });
        document.getElementById('stepBtn').addEventListener('click', () => { if (!running) update(); });
        document.getElementById('resetBtn').addEventListener('click', reset);
        document.getElementById('medium').addEventListener('change', (e) => { medium = e.target.value; reset(); });
        document.getElementById('h2Count').addEventListener('input', (e) => document.getElementById('h2Val').textContent = e.target.value);
        document.getElementById('temperature').addEventListener('input', (e) => {
            temperature = parseInt(e.target.value);
            document.getElementById('tempVal').textContent = e.target.value;
        });

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        reset();
        animate();
    </script>
</body>
</html>
