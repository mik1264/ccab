<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L-Systems - CCAB</title>
    <link rel="stylesheet" href="../assets/css/navigation.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Spectral:ital,wght@0,400;0,600;1,400&family=Space+Mono:wght@400;700&display=swap');

        :root {
            /* Color scheme matching main index */
            --bg-primary: #0a0e1a;
            --bg-secondary: #111827;
            --text-primary: #e0e0ff;
            --text-secondary: #a0a0c0;
            --text-accent: #fbbf24;
            --theme-color: #667eea;

            /* Spacing */
            --spacing-xs: 0.5rem;
            --spacing-sm: 1rem;
            --spacing-md: 1.5rem;
            --spacing-lg: 2rem;
            --spacing-xl: 3rem;
            --spacing-2xl: 4rem;

            /* Typography */
            --font-display: 'Orbitron', sans-serif;
            --font-heading: 'Spectral', serif;
            --font-mono: 'Space Mono', monospace;
            --font-body: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;

            /* Layout */
            --max-width: 1600px;
            --header-height: 64px;

            /* Transitions */
            --transition-base: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background: linear-gradient(135deg, var(--bg-primary) 0%, #0f172a 50%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            padding: 20px;
            padding-top: calc(var(--header-height) + 20px);
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        h1 {
            font-family: var(--font-display);
            text-align: center;
            margin-bottom: 10px;
            font-size: clamp(2rem, 5vw, 3rem);
            background: linear-gradient(135deg, var(--theme-color) 0%, var(--text-accent) 50%, var(--theme-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tab {
            padding: 12px 24px;
            background: rgba(224, 224, 255, 0.1);
            border: 2px solid rgba(224, 224, 255, 0.2);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
            color: var(--text-primary);
        }

        .tab:hover {
            background: rgba(224, 224, 255, 0.2);
            transform: translateY(-2px);
        }

        .tab.active {
            background: linear-gradient(135deg, var(--theme-color) 0%, var(--text-accent) 100%);
            border-color: var(--theme-color);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .view {
            display: none;
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .view.active {
            display: block;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            justify-content: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        input[type="range"] {
            width: 180px;
        }

        input[type="number"], input[type="text"], textarea {
            padding: 8px;
            background: rgba(224, 224, 255, 0.1);
            border: 1px solid rgba(224, 224, 255, 0.2);
            border-radius: 5px;
            color: var(--text-primary);
            font-size: 1em;
            font-family: var(--font-mono);
        }

        input[type="number"] {
            width: 80px;
        }

        input[type="text"] {
            width: 200px;
        }

        textarea {
            width: 100%;
            max-width: 500px;
            min-height: 100px;
            resize: vertical;
        }

        button {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--theme-color) 0%, var(--text-accent) 100%);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        canvas {
            display: block;
            margin: 20px auto;
            background: #000;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-width: 100%;
        }

        .preset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .preset-card {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .preset-card:hover {
            border-color: var(--theme-color);
            transform: scale(1.05);
        }

        .preset-card h3 {
            text-align: center;
            margin-bottom: 8px;
            font-size: 1.1em;
            color: var(--theme-color);
        }

        .preset-card .description {
            font-size: 0.85em;
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 10px;
        }

        .preset-card canvas {
            margin: 0;
            box-shadow: none;
            border-radius: 4px;
            width: 100%;
            height: 150px;
        }

        .stats-panel {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--theme-color);
        }

        .stat-label {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .info-box {
            background: rgba(102, 126, 234, 0.1);
            border-left: 4px solid var(--theme-color);
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .info-box h3 {
            margin-bottom: 10px;
            color: var(--theme-color);
        }

        .info-box ul {
            margin-left: 20px;
            line-height: 1.8;
        }

        .rule-editor {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .rule-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .rule-item label {
            min-width: 80px;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.8);
        }

        .color-mode-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .color-mode-btn {
            padding: 8px 16px;
            background: rgba(224, 224, 255, 0.1);
            border: 2px solid rgba(224, 224, 255, 0.2);
            border-radius: 5px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .color-mode-btn:hover {
            background: rgba(224, 224, 255, 0.2);
        }

        .color-mode-btn.active {
            background: var(--theme-color);
            border-color: var(--theme-color);
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }

            .tabs {
                font-size: 0.9em;
            }

            .tab {
                padding: 8px 16px;
            }

            .preset-grid {
                grid-template-columns: 1fr;
            }
        }
    
        /* Organic Nature Back Link */
        .organic-back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 10000;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: #BC6C25;
            text-decoration: none;
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 600;
            padding: 0.5rem 1rem;
            background: rgba(254, 250, 224, 0.95);
            border-radius: 20px;
            border: 2px solid rgba(138, 154, 91, 0.3);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(96, 108, 56, 0.15);
        }
        .organic-back-link:hover {
            background: rgba(254, 250, 224, 1);
            transform: translateX(-5px);
            border-color: #DDA15E;
            box-shadow: 0 6px 20px rgba(96, 108, 56, 0.25);
        }

    </style>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>

    <!-- Navigation Header -->
    <nav class="ccab-nav">
        <div class="nav-container">
            <div class="nav-breadcrumb"></div>
        </div>
    </nav>

    <div class="container">
        <h1>L-Systems Explorer</h1>
        <p class="subtitle">Lindenmayer Systems: Fractal Growth Through String Rewriting</p>

        <div class="tabs">
            <div class="tab active" data-view="gallery">Preset Gallery</div>
            <div class="tab" data-view="designer">Rule Designer</div>
            <div class="tab" data-view="animation">Animation</div>
        </div>

        <!-- Preset Gallery View -->
        <div class="view active" id="gallery">
            <div class="info-box">
                <h3>About L-Systems</h3>
                <p>L-Systems (Lindenmayer Systems) were introduced by biologist Aristid Lindenmayer in 1968 to model
                the growth patterns of plants. These parallel rewriting systems use simple rules to generate complex,
                self-similar structures that closely resemble natural forms.</p>
                <ul>
                    <li><strong>String Rewriting:</strong> An axiom is recursively transformed using production rules</li>
                    <li><strong>Turtle Graphics:</strong> The resulting string is interpreted as drawing commands</li>
                    <li><strong>Applications:</strong> Plant modeling, fractals, procedural generation in CGI and games</li>
                    <li><strong>Self-Similarity:</strong> Each iteration reveals increasing detail at finer scales</li>
                </ul>
            </div>

            <div class="preset-grid" id="presetGrid"></div>
        </div>

        <!-- Rule Designer View -->
        <div class="view" id="designer">
            <div class="info-box">
                <h3>Create Custom L-Systems</h3>
                <p>Design your own fractal structures by defining an axiom (starting string) and production rules.
                The turtle graphics interpreter recognizes these commands:</p>
                <ul>
                    <li><strong>F:</strong> Draw forward by segment length</li>
                    <li><strong>+ / -:</strong> Turn right/left by angle</li>
                    <li><strong>[ / ]:</strong> Push/pop turtle state (position and angle)</li>
                    <li><strong>X, Y:</strong> Non-drawing symbols (used for structure only)</li>
                </ul>
            </div>

            <div class="rule-editor">
                <div class="rule-item">
                    <label>Axiom:</label>
                    <input type="text" id="customAxiom" value="F" placeholder="Starting string">
                </div>
                <div class="rule-item">
                    <label>Rules:</label>
                    <textarea id="customRules" placeholder="F=FF+[+F-F-F]-[-F+F+F]&#10;X=F+[[X]-X]-F[-FX]+X">F=FF+[+F-F-F]-[-F+F+F]</textarea>
                </div>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label>Angle: <span id="customAngleVal">22.5</span>Â°</label>
                    <input type="range" id="customAngle" min="0" max="180" value="22.5" step="0.5">
                </div>
                <div class="control-group">
                    <label>Iterations: <span id="customIterVal">4</span></label>
                    <input type="range" id="customIter" min="1" max="8" value="4">
                </div>
                <div class="control-group">
                    <label>Segment Length: <span id="customLenVal">8</span></label>
                    <input type="range" id="customLen" min="1" max="30" value="8">
                </div>
                <div class="control-group">
                    <label>Line Width: <span id="customWidthVal">1.5</span></label>
                    <input type="range" id="customWidth" min="0.5" max="5" value="1.5" step="0.5">
                </div>
                <button onclick="generateCustom()">Generate</button>
                <button onclick="clearDesigner()">Clear Canvas</button>
            </div>

            <div class="color-mode-selector">
                <button class="color-mode-btn active" data-mode="solid" onclick="setColorMode('solid')">Solid Color</button>
                <button class="color-mode-btn" data-mode="age" onclick="setColorMode('age')">Branch Age</button>
                <button class="color-mode-btn" data-mode="depth" onclick="setColorMode('depth')">Depth Gradient</button>
            </div>

            <canvas id="designerCanvas" width="1000" height="800"></canvas>

            <div class="stats-panel">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="designerIter">0</div>
                        <div class="stat-label">Current Iteration</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="designerSegments">0</div>
                        <div class="stat-label">Total Segments</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="designerLength">0</div>
                        <div class="stat-label">String Length</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Animation View -->
        <div class="view" id="animation">
            <div class="info-box">
                <h3>Watch Growth Over Time</h3>
                <p>Observe how L-Systems evolve iteration by iteration. Each generation applies the production rules
                to the current string, revealing the emergent fractal structure step by step.</p>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label>Select Preset:</label>
                    <select id="animPreset" onchange="loadAnimationPreset()">
                        <option value="tree">Tree</option>
                        <option value="fern">Fern</option>
                        <option value="koch">Koch Snowflake</option>
                        <option value="sierpinski">Sierpinski Triangle</option>
                        <option value="dragon">Dragon Curve</option>
                        <option value="plant">Plant</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Speed: <span id="animSpeedVal">500</span>ms</label>
                    <input type="range" id="animSpeed" min="100" max="2000" value="500" step="100">
                </div>
                <button id="animToggle" onclick="toggleAnimation()">Start Animation</button>
                <button onclick="resetAnimation()">Reset</button>
                <button onclick="stepForward()">Step Forward</button>
            </div>

            <canvas id="animCanvas" width="1000" height="800"></canvas>

            <div class="stats-panel">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="animIter">0</div>
                        <div class="stat-label">Current Iteration</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="animSegments">0</div>
                        <div class="stat-label">Segments Drawn</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="animLength">0</div>
                        <div class="stat-label">String Length</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // L-System Core Engine
        class LSystem {
            constructor(axiom, rules, angle) {
                this.axiom = axiom;
                this.rules = rules;
                this.angle = angle;
                this.current = axiom;
                this.generation = 0;
            }

            iterate() {
                let next = '';
                for (let char of this.current) {
                    next += this.rules[char] || char;
                }
                this.current = next;
                this.generation++;
                return this.current;
            }

            reset() {
                this.current = this.axiom;
                this.generation = 0;
            }

            generate(iterations) {
                this.reset();
                for (let i = 0; i < iterations; i++) {
                    this.iterate();
                }
                return this.current;
            }
        }

        // Turtle Graphics Renderer
        class TurtleRenderer {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.ctx.imageSmoothingEnabled = true;
                this.ctx.imageSmoothingQuality = 'high';
                this.colorMode = 'solid';
            }

            render(lsystem, segmentLength, lineWidth, startX, startY, startAngle = -90) {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.fillStyle = '#000';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                const instructions = lsystem.current;
                const angle = lsystem.angle * Math.PI / 180;

                let x = startX;
                let y = startY;
                let heading = startAngle * Math.PI / 180;
                let stack = [];
                let segmentCount = 0;

                this.ctx.lineWidth = lineWidth;
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';

                for (let i = 0; i < instructions.length; i++) {
                    const char = instructions[i];

                    switch (char) {
                        case 'F':
                        case 'G':
                            const newX = x + Math.cos(heading) * segmentLength;
                            const newY = y + Math.sin(heading) * segmentLength;

                            this.ctx.beginPath();
                            this.ctx.moveTo(x, y);
                            this.ctx.lineTo(newX, newY);

                            // Color based on mode
                            if (this.colorMode === 'solid') {
                                this.ctx.strokeStyle = '#667eea';
                            } else if (this.colorMode === 'age') {
                                const hue = (i / instructions.length) * 120 + 200;
                                this.ctx.strokeStyle = `hsl(${hue}, 70%, 60%)`;
                            } else if (this.colorMode === 'depth') {
                                const depth = stack.length;
                                const hue = 240 - (depth * 20);
                                this.ctx.strokeStyle = `hsl(${hue}, 70%, 60%)`;
                            }

                            this.ctx.stroke();

                            x = newX;
                            y = newY;
                            segmentCount++;
                            break;

                        case '+':
                            heading += angle;
                            break;

                        case '-':
                            heading -= angle;
                            break;

                        case '[':
                            stack.push({ x, y, heading });
                            break;

                        case ']':
                            if (stack.length > 0) {
                                const state = stack.pop();
                                x = state.x;
                                y = state.y;
                                heading = state.heading;
                            }
                            break;
                    }
                }

                return segmentCount;
            }

            setColorMode(mode) {
                this.colorMode = mode;
            }
        }

        // Preset Definitions
        const presets = {
            tree: {
                name: 'Tree',
                description: 'Binary branching tree with alternating angles',
                axiom: 'F',
                rules: { F: 'FF+[+F-F-F]-[-F+F+F]' },
                angle: 22.5,
                iterations: 4,
                segmentLength: 6,
                startY: 0.9
            },
            fern: {
                name: 'Barnsley Fern',
                description: 'Realistic fern-like fractal structure',
                axiom: 'X',
                rules: { X: 'F+[[X]-X]-F[-FX]+X', F: 'FF' },
                angle: 25,
                iterations: 5,
                segmentLength: 4,
                startY: 0.95
            },
            koch: {
                name: 'Koch Snowflake',
                description: 'Classic Koch curve forming snowflake',
                axiom: 'F--F--F',
                rules: { F: 'F+F--F+F' },
                angle: 60,
                iterations: 4,
                segmentLength: 5,
                startY: 0.6
            },
            sierpinski: {
                name: 'Sierpinski Triangle',
                description: 'Sierpinski arrowhead curve',
                axiom: 'F-G-G',
                rules: { F: 'F-G+F+G-F', G: 'GG' },
                angle: 120,
                iterations: 5,
                segmentLength: 4,
                startY: 0.8
            },
            dragon: {
                name: 'Dragon Curve',
                description: 'Heighway dragon fractal',
                axiom: 'FX',
                rules: { X: 'X+YF+', Y: '-FX-Y' },
                angle: 90,
                iterations: 10,
                segmentLength: 6,
                startY: 0.5
            },
            plant: {
                name: 'Plant',
                description: 'Organic plant with multiple branches',
                axiom: 'X',
                rules: { X: 'F-[[X]+X]+F[+FX]-X', F: 'FF' },
                angle: 22.5,
                iterations: 5,
                segmentLength: 4,
                startY: 0.95
            }
        };

        // Global state
        let currentRenderer;
        let animationInterval;
        let animationRunning = false;
        let currentAnimationPreset = 'tree';
        let currentAnimationIter = 0;
        let currentColorMode = 'solid';

        // Initialize
        function init() {
            setupTabs();
            setupControls();
            generatePresetGallery();
            currentRenderer = new TurtleRenderer(document.getElementById('designerCanvas'));
            generateCustom();
        }

        // Tab system
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.view).classList.add('active');
                });
            });
        }

        // Controls setup
        function setupControls() {
            document.getElementById('customAngle').addEventListener('input', (e) => {
                document.getElementById('customAngleVal').textContent = e.target.value;
            });

            document.getElementById('customIter').addEventListener('input', (e) => {
                document.getElementById('customIterVal').textContent = e.target.value;
            });

            document.getElementById('customLen').addEventListener('input', (e) => {
                document.getElementById('customLenVal').textContent = e.target.value;
            });

            document.getElementById('customWidth').addEventListener('input', (e) => {
                document.getElementById('customWidthVal').textContent = e.target.value;
            });

            document.getElementById('animSpeed').addEventListener('input', (e) => {
                document.getElementById('animSpeedVal').textContent = e.target.value;
                if (animationRunning) {
                    stopAnimation();
                    startAnimation();
                }
            });
        }

        // Preset Gallery
        function generatePresetGallery() {
            const grid = document.getElementById('presetGrid');
            grid.innerHTML = '';

            Object.entries(presets).forEach(([key, preset]) => {
                const card = document.createElement('div');
                card.className = 'preset-card';

                const title = document.createElement('h3');
                title.textContent = preset.name;
                card.appendChild(title);

                const desc = document.createElement('div');
                desc.className = 'description';
                desc.textContent = preset.description;
                card.appendChild(desc);

                const canvas = document.createElement('canvas');
                canvas.width = 200;
                canvas.height = 200;
                card.appendChild(canvas);

                // Generate preview
                const lsystem = new LSystem(preset.axiom, preset.rules, preset.angle);
                lsystem.generate(preset.iterations);

                const renderer = new TurtleRenderer(canvas);
                const startY = canvas.height * (preset.startY || 0.8);
                renderer.render(lsystem, preset.segmentLength * 0.8, 1, canvas.width / 2, startY);

                card.addEventListener('click', () => {
                    loadPreset(key);
                    document.querySelector('[data-view="designer"]').click();
                });

                grid.appendChild(card);
            });
        }

        // Load preset into designer
        function loadPreset(key) {
            const preset = presets[key];
            document.getElementById('customAxiom').value = preset.axiom;

            // Convert rules object to text format
            const rulesText = Object.entries(preset.rules)
                .map(([k, v]) => `${k}=${v}`)
                .join('\n');
            document.getElementById('customRules').value = rulesText;

            document.getElementById('customAngle').value = preset.angle;
            document.getElementById('customAngleVal').textContent = preset.angle;

            document.getElementById('customIter').value = preset.iterations;
            document.getElementById('customIterVal').textContent = preset.iterations;

            document.getElementById('customLen').value = preset.segmentLength;
            document.getElementById('customLenVal').textContent = preset.segmentLength;

            generateCustom();
        }

        // Generate custom L-system
        function generateCustom() {
            const axiom = document.getElementById('customAxiom').value || 'F';
            const rulesText = document.getElementById('customRules').value;
            const angle = parseFloat(document.getElementById('customAngle').value);
            const iterations = parseInt(document.getElementById('customIter').value);
            const segmentLength = parseFloat(document.getElementById('customLen').value);
            const lineWidth = parseFloat(document.getElementById('customWidth').value);

            // Parse rules from text
            const rules = {};
            rulesText.split('\n').forEach(line => {
                const [key, value] = line.split('=').map(s => s.trim());
                if (key && value) {
                    rules[key] = value;
                }
            });

            const lsystem = new LSystem(axiom, rules, angle);
            lsystem.generate(iterations);

            const canvas = document.getElementById('designerCanvas');
            const startY = canvas.height * 0.8;
            const segmentCount = currentRenderer.render(lsystem, segmentLength, lineWidth, canvas.width / 2, startY);

            // Update stats
            document.getElementById('designerIter').textContent = iterations;
            document.getElementById('designerSegments').textContent = segmentCount;
            document.getElementById('designerLength').textContent = lsystem.current.length;
        }

        // Clear designer canvas
        function clearDesigner() {
            const canvas = document.getElementById('designerCanvas');
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        // Color mode
        function setColorMode(mode) {
            currentColorMode = mode;
            currentRenderer.setColorMode(mode);
            document.querySelectorAll('.color-mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            generateCustom();
        }

        // Animation
        function loadAnimationPreset() {
            currentAnimationPreset = document.getElementById('animPreset').value;
            resetAnimation();
        }

        function toggleAnimation() {
            if (animationRunning) {
                stopAnimation();
            } else {
                startAnimation();
            }
        }

        function startAnimation() {
            animationRunning = true;
            document.getElementById('animToggle').textContent = 'Stop Animation';

            const speed = parseInt(document.getElementById('animSpeed').value);
            const preset = presets[currentAnimationPreset];

            animationInterval = setInterval(() => {
                if (currentAnimationIter >= 8) {
                    stopAnimation();
                    return;
                }

                stepForward();
            }, speed);
        }

        function stopAnimation() {
            animationRunning = false;
            clearInterval(animationInterval);
            document.getElementById('animToggle').textContent = 'Start Animation';
        }

        function resetAnimation() {
            stopAnimation();
            currentAnimationIter = 0;
            renderAnimation();
        }

        function stepForward() {
            currentAnimationIter++;
            if (currentAnimationIter > 8) {
                currentAnimationIter = 8;
                stopAnimation();
            }
            renderAnimation();
        }

        function renderAnimation() {
            const preset = presets[currentAnimationPreset];
            const lsystem = new LSystem(preset.axiom, preset.rules, preset.angle);
            lsystem.generate(currentAnimationIter);

            const canvas = document.getElementById('animCanvas');
            const renderer = new TurtleRenderer(canvas);
            renderer.setColorMode('depth');

            const startY = canvas.height * (preset.startY || 0.8);
            const segmentCount = renderer.render(lsystem, preset.segmentLength, 1.5, canvas.width / 2, startY);

            // Update stats
            document.getElementById('animIter').textContent = currentAnimationIter;
            document.getElementById('animSegments').textContent = segmentCount;
            document.getElementById('animLength').textContent = lsystem.current.length;
        }

        // Initialize on load
        window.addEventListener('load', init);
    </script>
    <script src="../assets/js/navigation.js"></script>
</body>
</html>
