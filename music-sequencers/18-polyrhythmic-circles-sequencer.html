<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polyrhythmic Circles Sequencer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0a0a0f;
            min-height: 100vh;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
        }
        canvas { display: block; }
        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
        }
        button {
            background: rgba(255,180,0,0.15);
            border: 1px solid rgba(255,180,0,0.5);
            color: #fb4;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
        }
        button:hover { background: rgba(255,180,0,0.25); }
        .info {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255,180,0,0.8);
            font-size: 14px;
        }
        a.back { position: fixed; top: 20px; left: 20px; color: #fb4; text-decoration: none; }
    </style>
</head>
<body>
    <a class="back" href="index.html">← Back</a>
    <div class="info">Each ring rotates at different speeds creating polyrhythms</div>
    <canvas id="canvas"></canvas>
    <div class="controls">
        <button id="playBtn">▶ Play</button>
        <button id="presetBtn">Preset: 3:4:5</button>
        <button id="resetBtn">Reset</button>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let width = canvas.width = window.innerWidth;
        let height = canvas.height = window.innerHeight;

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        let isPlaying = false;
        let centerX, centerY;
        let startTime = 0;

        const rings = [];
        const presets = {
            '3:4:5': [3, 4, 5],
            '2:3:4': [2, 3, 4],
            '5:7:9': [5, 7, 9],
            '3:4:5:7': [3, 4, 5, 7],
            '4:5:6:7': [4, 5, 6, 7]
        };
        let currentPreset = '3:4:5';

        const notes = [261.63, 329.63, 392.00, 493.88, 523.25, 659.25, 783.99];
        const ringColors = ['#ff6b6b', '#feca57', '#48dbfb', '#ff9ff3', '#54a0ff', '#00d2d3'];

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            centerX = width / 2;
            centerY = height / 2;
            initRings();
        }

        function initRings() {
            rings.length = 0;
            const divisions = presets[currentPreset];
            const maxRadius = Math.min(width, height) * 0.35;
            const ringSpacing = maxRadius / (divisions.length + 1);

            divisions.forEach((beats, i) => {
                rings.push({
                    radius: (i + 1) * ringSpacing + 50,
                    beats: beats,
                    angle: 0,
                    speed: 1 / beats,
                    color: ringColors[i % ringColors.length],
                    noteIndex: i,
                    nodes: [],
                    lastBeat: -1
                });

                // Create nodes
                for (let b = 0; b < beats; b++) {
                    rings[i].nodes.push({
                        angle: (b / beats) * Math.PI * 2,
                        triggered: false,
                        glow: 0
                    });
                }
            });
        }

        function playNote(ringIndex) {
            const ring = rings[ringIndex];
            const freq = notes[ringIndex % notes.length];

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            const filter = audioCtx.createBiquadFilter();

            osc.type = ringIndex % 2 === 0 ? 'sine' : 'triangle';
            osc.frequency.value = freq;

            filter.type = 'lowpass';
            filter.frequency.value = 2000;

            gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);

            osc.connect(filter);
            filter.connect(gain);
            gain.connect(audioCtx.destination);

            osc.start();
            osc.stop(audioCtx.currentTime + 0.3);
        }

        function draw(timestamp) {
            ctx.fillStyle = 'rgba(10, 10, 15, 0.15)';
            ctx.fillRect(0, 0, width, height);

            // Draw trigger line
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(centerX + Math.min(width, height) * 0.4, centerY);
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 2;
            ctx.stroke();

            // Center point
            ctx.beginPath();
            ctx.arc(centerX, centerY, 8, 0, Math.PI * 2);
            ctx.fillStyle = '#fff';
            ctx.fill();

            rings.forEach((ring, ringIndex) => {
                if (isPlaying) {
                    // Update angle based on time
                    const elapsed = (timestamp - startTime) / 1000;
                    const cycleTime = 4; // seconds for slowest ring
                    ring.angle = (elapsed * ring.speed / cycleTime * Math.PI * 2) % (Math.PI * 2);
                }

                // Draw ring
                ctx.beginPath();
                ctx.arc(centerX, centerY, ring.radius, 0, Math.PI * 2);
                ctx.strokeStyle = ring.color + '40';
                ctx.lineWidth = 3;
                ctx.stroke();

                // Draw and check nodes
                ring.nodes.forEach((node, nodeIndex) => {
                    const nodeAngle = node.angle + ring.angle;
                    const x = centerX + Math.cos(nodeAngle) * ring.radius;
                    const y = centerY + Math.sin(nodeAngle) * ring.radius;

                    // Check trigger
                    const angleTolerance = 0.05;
                    const normalizedAngle = ((nodeAngle % (Math.PI * 2)) + Math.PI * 2) % (Math.PI * 2);

                    if (isPlaying && normalizedAngle < angleTolerance && !node.triggered) {
                        playNote(ringIndex);
                        node.glow = 1;
                        node.triggered = true;
                    } else if (normalizedAngle > 0.1) {
                        node.triggered = false;
                    }

                    // Draw node
                    if (node.glow > 0) {
                        ctx.shadowColor = ring.color;
                        ctx.shadowBlur = 20 * node.glow;
                        node.glow -= 0.02;
                    }

                    ctx.beginPath();
                    ctx.arc(x, y, 12, 0, Math.PI * 2);
                    ctx.fillStyle = ring.color;
                    ctx.fill();
                    ctx.shadowBlur = 0;
                });

                // Draw rotating marker
                const markerAngle = ring.angle;
                const mx = centerX + Math.cos(markerAngle) * ring.radius;
                const my = centerY + Math.sin(markerAngle) * ring.radius;

                ctx.beginPath();
                ctx.arc(mx, my, 6, 0, Math.PI * 2);
                ctx.fillStyle = '#fff';
                ctx.fill();

                // Label
                ctx.font = '14px Segoe UI';
                ctx.fillStyle = ring.color;
                ctx.textAlign = 'center';
                ctx.fillText(`${ring.beats}`, centerX, centerY - ring.radius - 20);
            });

            requestAnimationFrame(draw);
        }

        document.getElementById('playBtn').addEventListener('click', function() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            isPlaying = !isPlaying;
            if (isPlaying) startTime = performance.now();
            this.textContent = isPlaying ? '⏸ Pause' : '▶ Play';
        });

        const presetKeys = Object.keys(presets);
        let presetIndex = 0;

        document.getElementById('presetBtn').addEventListener('click', function() {
            presetIndex = (presetIndex + 1) % presetKeys.length;
            currentPreset = presetKeys[presetIndex];
            this.textContent = `Preset: ${currentPreset}`;
            initRings();
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            isPlaying = false;
            document.getElementById('playBtn').textContent = '▶ Play';
            rings.forEach(ring => {
                ring.angle = 0;
                ring.nodes.forEach(n => {
                    n.triggered = false;
                    n.glow = 0;
                });
            });
        });

        window.addEventListener('resize', resize);
        resize();
        requestAnimationFrame(draw);
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
