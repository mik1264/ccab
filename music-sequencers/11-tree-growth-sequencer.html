<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tree Growth Sequencer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(180deg, #0a1628 0%, #1a2f4a 50%, #2d4a3e 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
        }
        canvas { display: block; }
        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
        }
        button {
            background: rgba(76,175,80,0.2);
            border: 1px solid rgba(76,175,80,0.6);
            color: #4CAF50;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
        }
        button:hover { background: rgba(76,175,80,0.3); }
        .info {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(76,175,80,0.8);
            font-size: 14px;
        }
        a.back { position: fixed; top: 20px; left: 20px; color: #4CAF50; text-decoration: none; }
    </style>
</head>
<body>
    <a class="back" href="index.html">← Back</a>
    <div class="info">L-System trees grow and create musical patterns • Click to plant</div>
    <canvas id="canvas"></canvas>
    <div class="controls">
        <button id="playBtn">▶ Grow</button>
        <button id="clearBtn">Clear</button>
        <button id="seasonBtn">Season: Spring</button>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let width = canvas.width = window.innerWidth;
        let height = canvas.height = window.innerHeight;

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        const trees = [];
        let isGrowing = false;
        let season = 'spring';

        const seasonColors = {
            spring: { leaf: '#4CAF50', bark: '#5D4037' },
            summer: { leaf: '#2E7D32', bark: '#4E342E' },
            autumn: { leaf: '#FF9800', bark: '#5D4037' },
            winter: { leaf: '#90CAF9', bark: '#757575' }
        };

        // Pentatonic scale
        const scale = [130.81, 146.83, 164.81, 196.00, 220.00, 261.63, 293.66, 329.63, 392.00, 440.00];

        class Branch {
            constructor(x, y, angle, length, depth, tree) {
                this.x = x;
                this.y = y;
                this.angle = angle;
                this.length = length;
                this.targetLength = length;
                this.currentLength = 0;
                this.depth = depth;
                this.tree = tree;
                this.grown = false;
                this.hasPlayedNote = false;
                this.children = [];
                this.growProgress = 0;
            }

            grow() {
                if (this.growProgress < 1) {
                    this.growProgress += 0.02;
                    this.currentLength = this.targetLength * this.growProgress;

                    // Play note when growth completes
                    if (this.growProgress >= 1 && !this.hasPlayedNote) {
                        this.playNote();
                        this.hasPlayedNote = true;
                        this.grown = true;

                        // Spawn children
                        if (this.depth < 6) {
                            const branchCount = this.depth < 3 ? 2 : (Math.random() < 0.7 ? 2 : 1);
                            for (let i = 0; i < branchCount; i++) {
                                const angleOffset = (Math.random() - 0.5) * 0.8 + (i === 0 ? -0.4 : 0.4);
                                const newLength = this.targetLength * (0.65 + Math.random() * 0.15);
                                const newAngle = this.angle + angleOffset;

                                const endX = this.x + Math.cos(this.angle) * this.currentLength;
                                const endY = this.y + Math.sin(this.angle) * this.currentLength;

                                const child = new Branch(endX, endY, newAngle, newLength, this.depth + 1, this.tree);
                                this.children.push(child);
                            }
                        }
                    }
                }

                // Grow children
                this.children.forEach(child => child.grow());
            }

            playNote() {
                const noteIndex = Math.min(this.depth, scale.length - 1);
                const freq = scale[noteIndex];

                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();

                osc.type = this.depth < 3 ? 'triangle' : 'sine';
                osc.frequency.value = freq * (1 + (Math.random() - 0.5) * 0.05);

                const volume = 0.15 * (1 - this.depth * 0.1);
                gain.gain.setValueAtTime(volume, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);

                osc.connect(gain);
                gain.connect(audioCtx.destination);

                osc.start();
                osc.stop(audioCtx.currentTime + 0.5);
            }

            draw() {
                const endX = this.x + Math.cos(this.angle) * this.currentLength;
                const endY = this.y + Math.sin(this.angle) * this.currentLength;

                const colors = seasonColors[season];
                const thickness = Math.max(1, (6 - this.depth) * 1.5);

                ctx.beginPath();
                ctx.moveTo(this.x, this.y);
                ctx.lineTo(endX, endY);
                ctx.strokeStyle = this.depth > 4 ? colors.leaf : colors.bark;
                ctx.lineWidth = thickness;
                ctx.lineCap = 'round';
                ctx.stroke();

                // Draw leaves at tips
                if (this.depth >= 4 && this.grown && season !== 'winter') {
                    ctx.beginPath();
                    ctx.arc(endX, endY, 4 + Math.random() * 3, 0, Math.PI * 2);
                    ctx.fillStyle = colors.leaf;
                    ctx.fill();
                }

                // Growing glow effect
                if (this.growProgress > 0 && this.growProgress < 1) {
                    ctx.beginPath();
                    ctx.arc(endX, endY, 8, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(255, 255, 200, 0.5)';
                    ctx.fill();
                }

                // Draw children
                this.children.forEach(child => child.draw());
            }
        }

        class Tree {
            constructor(x) {
                this.x = x;
                this.trunk = new Branch(x, height, -Math.PI / 2, 80 + Math.random() * 40, 0, this);
            }

            grow() {
                this.trunk.grow();
            }

            draw() {
                this.trunk.draw();
            }
        }

        function draw() {
            // Subtle fade for trail effect
            ctx.fillStyle = 'rgba(10, 22, 40, 0.05)';
            ctx.fillRect(0, 0, width, height);

            // Draw ground
            ctx.fillStyle = '#2d4a3e';
            ctx.fillRect(0, height - 30, width, 30);

            // Update and draw trees
            trees.forEach(tree => {
                if (isGrowing) tree.grow();
                tree.draw();
            });

            requestAnimationFrame(draw);
        }

        canvas.addEventListener('click', (e) => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            trees.push(new Tree(e.clientX));
            if (!isGrowing) {
                isGrowing = true;
                document.getElementById('playBtn').textContent = '⏸ Pause';
            }
        });

        document.getElementById('playBtn').addEventListener('click', function() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            isGrowing = !isGrowing;
            this.textContent = isGrowing ? '⏸ Pause' : '▶ Grow';
        });

        document.getElementById('clearBtn').addEventListener('click', () => {
            trees.length = 0;
            ctx.fillStyle = 'rgba(10, 22, 40, 1)';
            ctx.fillRect(0, 0, width, height);
        });

        document.getElementById('seasonBtn').addEventListener('click', function() {
            const seasons = ['spring', 'summer', 'autumn', 'winter'];
            const idx = (seasons.indexOf(season) + 1) % seasons.length;
            season = seasons[idx];
            this.textContent = `Season: ${season.charAt(0).toUpperCase() + season.slice(1)}`;
        });

        window.addEventListener('resize', () => {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        });

        draw();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
