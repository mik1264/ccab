<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Euclidean Rhythm Sequencer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #1a0a2e 0%, #2d1b4e 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: 'Segoe UI', sans-serif;
            padding: 20px;
        }
        canvas { display: block; margin-top: 60px; }
        .controls {
            position: fixed;
            bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        button {
            background: rgba(255,100,200,0.2);
            border: 1px solid rgba(255,100,200,0.5);
            color: #f8c;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
        }
        button:hover { background: rgba(255,100,200,0.3); }
        .info {
            position: fixed;
            top: 20px;
            color: rgba(255,100,200,0.8);
            font-size: 14px;
            text-align: center;
        }
        a.back { position: fixed; top: 20px; left: 20px; color: #f8c; text-decoration: none; }
        .rings-info {
            position: fixed;
            right: 20px;
            top: 100px;
            color: rgba(255,255,255,0.6);
            font-size: 12px;
        }
    </style>
</head>
<body>
    <a class="back" href="index.html">← Back</a>
    <div class="info">Euclidean algorithm distributes beats evenly • Click rings to adjust</div>
    <div class="rings-info" id="ringsInfo"></div>
    <canvas id="canvas"></canvas>
    <div class="controls">
        <button id="playBtn">▶ Play</button>
        <button id="tempoBtn">120 BPM</button>
        <button id="presetBtn">Preset: World</button>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const size = Math.min(window.innerWidth - 40, window.innerHeight - 200, 500);
        canvas.width = canvas.height = size;

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        let isPlaying = false;
        let currentStep = 0;
        let lastStepTime = 0;
        let bpm = 120;

        // Euclidean rhythm generator
        function euclidean(beats, steps) {
            if (beats >= steps) return Array(steps).fill(true);
            if (beats === 0) return Array(steps).fill(false);

            const pattern = [];
            let counts = Array(beats).fill(Math.floor(steps / beats));
            const remainder = steps % beats;

            for (let i = 0; i < remainder; i++) {
                counts[i]++;
            }

            // Build pattern using Bjorklund algorithm
            let level = 0;
            const build = (count, array) => {
                if (count === 0) return;
                if (level === 0) {
                    array.push(true);
                    count--;
                    level = 1;
                }
                while (count > 0) {
                    array.push(false);
                    count--;
                }
            };

            for (let i = 0; i < beats; i++) {
                pattern.push(true);
                for (let j = 1; j < counts[i]; j++) {
                    pattern.push(false);
                }
            }

            return pattern;
        }

        const rings = [
            { beats: 3, steps: 8, rotation: 0, color: '#ff6b6b', note: 200, type: 'kick' },
            { beats: 5, steps: 8, rotation: 0, color: '#feca57', note: 400, type: 'snare' },
            { beats: 7, steps: 16, rotation: 0, color: '#48dbfb', note: 800, type: 'hihat' },
            { beats: 3, steps: 4, rotation: 0, color: '#ff9ff3', note: 150, type: 'bass' }
        ];

        const presets = {
            'World': [[3, 8], [5, 8], [7, 16], [3, 4]],
            'Techno': [[4, 16], [2, 8], [8, 16], [1, 4]],
            'Jazz': [[5, 12], [7, 12], [9, 16], [3, 8]],
            'Funk': [[4, 16], [3, 8], [5, 8], [2, 4]],
            'Afro': [[5, 12], [7, 16], [11, 16], [3, 8]]
        };
        let currentPreset = 'World';

        function updateRingsInfo() {
            const info = rings.map((r, i) =>
                `Ring ${i + 1}: E(${r.beats},${r.steps})`
            ).join('<br>');
            document.getElementById('ringsInfo').innerHTML = info;
        }

        function playSound(ring) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            switch (ring.type) {
                case 'kick':
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(ring.note, audioCtx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.1);
                    gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                    break;
                case 'snare':
                    osc.type = 'triangle';
                    osc.frequency.value = ring.note;
                    gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                    break;
                case 'hihat':
                    osc.type = 'square';
                    osc.frequency.value = ring.note;
                    gain.gain.setValueAtTime(0.08, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
                    break;
                case 'bass':
                    osc.type = 'sine';
                    osc.frequency.value = ring.note;
                    gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                    break;
            }

            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.3);
        }

        function draw(timestamp) {
            const center = size / 2;

            ctx.fillStyle = 'rgba(26, 10, 46, 0.2)';
            ctx.fillRect(0, 0, size, size);

            const stepInterval = 60000 / bpm / 4; // 16th notes

            if (isPlaying && timestamp - lastStepTime > stepInterval) {
                currentStep++;
                lastStepTime = timestamp;
            }

            rings.forEach((ring, ringIndex) => {
                const radius = 60 + ringIndex * 50;
                const pattern = euclidean(ring.beats, ring.steps);
                const angleStep = (Math.PI * 2) / ring.steps;
                const currentRingStep = currentStep % ring.steps;

                // Draw ring
                ctx.beginPath();
                ctx.arc(center, center, radius, 0, Math.PI * 2);
                ctx.strokeStyle = ring.color + '40';
                ctx.lineWidth = 3;
                ctx.stroke();

                // Draw steps
                pattern.forEach((active, step) => {
                    const angle = step * angleStep - Math.PI / 2 + ring.rotation;
                    const x = center + Math.cos(angle) * radius;
                    const y = center + Math.sin(angle) * radius;

                    const isCurrent = step === currentRingStep && isPlaying;

                    if (isCurrent && active) {
                        playSound(ring);
                        ctx.shadowColor = ring.color;
                        ctx.shadowBlur = 20;
                    }

                    ctx.beginPath();
                    ctx.arc(x, y, active ? 12 : 6, 0, Math.PI * 2);
                    ctx.fillStyle = active ? ring.color : ring.color + '30';
                    ctx.fill();
                    ctx.shadowBlur = 0;

                    // Current step indicator
                    if (isCurrent) {
                        ctx.beginPath();
                        ctx.arc(x, y, 18, 0, Math.PI * 2);
                        ctx.strokeStyle = '#fff';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    }
                });

                // Ring label
                ctx.font = '12px Segoe UI';
                ctx.fillStyle = ring.color;
                ctx.textAlign = 'center';
                ctx.fillText(`E(${ring.beats},${ring.steps})`, center, center - radius - 15);
            });

            // Center
            ctx.beginPath();
            ctx.arc(center, center, 20, 0, Math.PI * 2);
            ctx.fillStyle = isPlaying ? '#fff' : '#666';
            ctx.fill();

            requestAnimationFrame(draw);
        }

        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left - size / 2;
            const y = e.clientY - rect.top - size / 2;
            const dist = Math.hypot(x, y);

            // Find which ring was clicked
            rings.forEach((ring, i) => {
                const radius = 60 + i * 50;
                if (Math.abs(dist - radius) < 25) {
                    // Adjust beats (left half decreases, right half increases)
                    if (x < 0) {
                        ring.beats = Math.max(1, ring.beats - 1);
                    } else {
                        ring.beats = Math.min(ring.steps - 1, ring.beats + 1);
                    }
                    updateRingsInfo();
                }
            });
        });

        document.getElementById('playBtn').addEventListener('click', function() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            isPlaying = !isPlaying;
            if (isPlaying) {
                currentStep = 0;
                lastStepTime = performance.now();
            }
            this.textContent = isPlaying ? '⏸ Pause' : '▶ Play';
        });

        document.getElementById('tempoBtn').addEventListener('click', function() {
            bpm = bpm === 120 ? 140 : bpm === 140 ? 90 : bpm === 90 ? 160 : 120;
            this.textContent = `${bpm} BPM`;
        });

        const presetNames = Object.keys(presets);
        let presetIndex = 0;

        document.getElementById('presetBtn').addEventListener('click', function() {
            presetIndex = (presetIndex + 1) % presetNames.length;
            currentPreset = presetNames[presetIndex];
            const preset = presets[currentPreset];
            preset.forEach((p, i) => {
                if (rings[i]) {
                    rings[i].beats = p[0];
                    rings[i].steps = p[1];
                }
            });
            this.textContent = `Preset: ${currentPreset}`;
            updateRingsInfo();
        });

        updateRingsInfo();
        requestAnimationFrame(draw);
    </script>
</body>
</html>
