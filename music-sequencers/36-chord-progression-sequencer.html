<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chord Progression Sequencer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: linear-gradient(135deg, #1a1520 0%, #2a2030 100%); min-height: 100vh; font-family: 'Segoe UI', sans-serif; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        canvas { display: block; cursor: pointer; }
        .controls { margin-top: 20px; display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; }
        button { background: rgba(200,150,255,0.15); border: 1px solid rgba(200,150,255,0.5); color: #c9f; padding: 10px 20px; border-radius: 20px; cursor: pointer; }
        button:hover { background: rgba(200,150,255,0.25); }
        .info { position: fixed; top: 20px; color: rgba(200,150,255,0.7); font-size: 14px; }
        a.back { position: fixed; top: 20px; left: 20px; color: #c9f; text-decoration: none; }
    </style>
</head>
<body>
    <a class="back" href="index.html">← Back</a>
    <div class="info">Click chords to build progressions • Common progressions create harmonic movement</div>
    <canvas id="canvas"></canvas>
    <div class="controls">
        <button id="playBtn">▶ Play</button>
        <button id="presetBtn">I-V-vi-IV</button>
        <button id="clearBtn">Clear</button>
    </div>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 700;
        canvas.height = 400;
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        const chords = [
            { name: 'I', notes: [261.63, 329.63, 392], color: '#ff6b6b' },
            { name: 'ii', notes: [293.66, 349.23, 440], color: '#feca57' },
            { name: 'iii', notes: [329.63, 392, 493.88], color: '#48dbfb' },
            { name: 'IV', notes: [349.23, 440, 523.25], color: '#ff9ff3' },
            { name: 'V', notes: [392, 493.88, 587.33], color: '#54a0ff' },
            { name: 'vi', notes: [440, 523.25, 659.25], color: '#5f27cd' },
            { name: 'vii°', notes: [493.88, 587.33, 698.46], color: '#00d2d3' }
        ];

        const progression = [];
        const maxChords = 8;
        let isPlaying = false;
        let currentIndex = 0;
        let lastStepTime = 0;
        const glows = Array(maxChords).fill(0);

        function playChord(chordIndex) {
            const chord = chords[chordIndex];
            chord.notes.forEach((freq, i) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = i === 0 ? 'sine' : 'triangle';
                osc.frequency.value = freq;
                gain.gain.setValueAtTime(0.12, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.8);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.8);
            });
        }

        function draw(timestamp) {
            ctx.fillStyle = 'rgba(26, 21, 32, 0.2)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Chord palette
            const paletteY = 50;
            chords.forEach((chord, i) => {
                const x = 50 + i * 90;
                ctx.fillStyle = chord.color + '40';
                ctx.fillRect(x, paletteY, 80, 60);
                ctx.strokeStyle = chord.color;
                ctx.lineWidth = 2;
                ctx.strokeRect(x, paletteY, 80, 60);
                ctx.font = 'bold 20px Segoe UI';
                ctx.fillStyle = chord.color;
                ctx.textAlign = 'center';
                ctx.fillText(chord.name, x + 40, paletteY + 38);
            });

            // Progression slots
            const slotY = 200;
            for (let i = 0; i < maxChords; i++) {
                const x = 50 + i * 80;

                if (glows[i] > 0) {
                    ctx.shadowColor = progression[i] !== undefined ? chords[progression[i]].color : '#fff';
                    ctx.shadowBlur = 20 * glows[i];
                    glows[i] -= 0.02;
                }

                ctx.fillStyle = progression[i] !== undefined ? chords[progression[i]].color + '60' : 'rgba(255,255,255,0.1)';
                ctx.fillRect(x, slotY, 70, 100);

                if (i === currentIndex && isPlaying) {
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 3;
                    ctx.strokeRect(x, slotY, 70, 100);
                }

                ctx.shadowBlur = 0;

                if (progression[i] !== undefined) {
                    ctx.font = 'bold 24px Segoe UI';
                    ctx.fillStyle = '#fff';
                    ctx.textAlign = 'center';
                    ctx.fillText(chords[progression[i]].name, x + 35, slotY + 58);
                }

                ctx.font = '12px Segoe UI';
                ctx.fillStyle = 'rgba(255,255,255,0.4)';
                ctx.fillText(`${i + 1}`, x + 35, slotY + 90);
            }

            // Playback
            if (isPlaying && progression.length > 0 && timestamp - lastStepTime > 600) {
                playChord(progression[currentIndex]);
                glows[currentIndex] = 1;
                currentIndex = (currentIndex + 1) % progression.length;
                lastStepTime = timestamp;
            }

            requestAnimationFrame(draw);
        }

        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // Check chord palette
            if (y >= 50 && y <= 110) {
                const chordIdx = Math.floor((x - 50) / 90);
                if (chordIdx >= 0 && chordIdx < chords.length && progression.length < maxChords) {
                    if (audioCtx.state === 'suspended') audioCtx.resume();
                    progression.push(chordIdx);
                    playChord(chordIdx);
                }
            }

            // Check slots to remove
            if (y >= 200 && y <= 300) {
                const slotIdx = Math.floor((x - 50) / 80);
                if (slotIdx >= 0 && slotIdx < progression.length) {
                    progression.splice(slotIdx, 1);
                    if (currentIndex >= progression.length) currentIndex = 0;
                }
            }
        });

        document.getElementById('playBtn').addEventListener('click', function() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            isPlaying = !isPlaying;
            currentIndex = 0;
            this.textContent = isPlaying ? '⏸ Pause' : '▶ Play';
        });

        const presets = { 'I-V-vi-IV': [0,4,5,3], 'ii-V-I': [1,4,0], 'I-IV-V-I': [0,3,4,0], 'vi-IV-I-V': [5,3,0,4] };
        let presetIdx = 0;
        const presetNames = Object.keys(presets);

        document.getElementById('presetBtn').addEventListener('click', function() {
            progression.length = 0;
            progression.push(...presets[presetNames[presetIdx]]);
            presetIdx = (presetIdx + 1) % presetNames.length;
            this.textContent = presetNames[presetIdx];
        });

        document.getElementById('clearBtn').addEventListener('click', () => {
            progression.length = 0;
            currentIndex = 0;
        });

        requestAnimationFrame(draw);
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
