<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Breathing Sequencer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0a1015; min-height: 100vh; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        canvas { display: block; }
        .controls { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; }
        button { background: rgba(100,180,200,0.2); border: 1px solid rgba(100,180,200,0.5); color: #6bd; padding: 10px 20px; border-radius: 20px; cursor: pointer; }
        button:hover { background: rgba(100,180,200,0.3); }
        .info { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); color: rgba(100,180,200,0.7); font-size: 14px; text-align: center; }
        a.back { position: fixed; top: 20px; left: 20px; color: #6bd; text-decoration: none; }
        .breath-guide { position: fixed; top: 60px; left: 50%; transform: translateX(-50%); color: rgba(100,180,200,0.9); font-size: 24px; }
    </style>
</head>
<body>
    <a class="back" href="index.html">← Back</a>
    <div class="info">Breathe with the circle • Tones follow breath rhythm</div>
    <div class="breath-guide" id="breathGuide">Breathe In</div>
    <canvas id="canvas"></canvas>
    <div class="controls">
        <button id="playBtn">▶ Play</button>
        <button id="fastBtn">Fast</button>
        <button id="slowBtn">Slow</button>
    </div>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let width = canvas.width = window.innerWidth;
        let height = canvas.height = window.innerHeight;
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        let isPlaying = false;
        let breathPhase = 0;
        let breathSpeed = 0.008; // Full cycle ~12 seconds
        let breathDirection = 1;
        let lastPhase = 0;

        // Ambient drone
        let droneOsc = null;
        let droneGain = null;
        let droneFilter = null;

        // Breath-related notes (calm, meditative)
        const inhaleNotes = [220, 277.18, 329.63, 440]; // A minor
        const exhaleNotes = [196, 246.94, 293.66, 392]; // G major
        const particles = [];

        function startDrone() {
            droneOsc = audioCtx.createOscillator();
            droneGain = audioCtx.createGain();
            droneFilter = audioCtx.createBiquadFilter();

            droneOsc.type = 'sine';
            droneOsc.frequency.value = 110;

            droneFilter.type = 'lowpass';
            droneFilter.frequency.value = 200;

            droneGain.gain.value = 0;

            droneOsc.connect(droneFilter);
            droneFilter.connect(droneGain);
            droneGain.connect(audioCtx.destination);

            droneOsc.start();
        }

        function playBreathNote(notes, phase) {
            const noteIndex = Math.floor(phase * notes.length);
            const freq = notes[noteIndex];

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc.type = 'sine';
            osc.frequency.value = freq;

            gain.gain.setValueAtTime(0.08, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1);

            osc.connect(gain);
            gain.connect(audioCtx.destination);

            osc.start();
            osc.stop(audioCtx.currentTime + 1);

            // Add particle
            const angle = Math.random() * Math.PI * 2;
            particles.push({
                x: width / 2,
                y: height / 2,
                vx: Math.cos(angle) * (breathDirection > 0 ? -2 : 2),
                vy: Math.sin(angle) * (breathDirection > 0 ? -2 : 2),
                life: 1,
                hue: breathDirection > 0 ? 200 : 180
            });
        }

        function draw() {
            ctx.fillStyle = 'rgba(10, 16, 21, 0.05)';
            ctx.fillRect(0, 0, width, height);

            const centerX = width / 2;
            const centerY = height / 2;

            if (isPlaying) {
                breathPhase += breathSpeed * breathDirection;

                // Reverse at limits
                if (breathPhase >= 1) {
                    breathDirection = -1;
                    document.getElementById('breathGuide').textContent = 'Breathe Out';
                } else if (breathPhase <= 0) {
                    breathDirection = 1;
                    document.getElementById('breathGuide').textContent = 'Breathe In';
                }

                // Play notes at intervals
                const noteInterval = 0.25;
                const currentStep = Math.floor(breathPhase / noteInterval);
                const lastStep = Math.floor(lastPhase / noteInterval);

                if (currentStep !== lastStep) {
                    const notes = breathDirection > 0 ? inhaleNotes : exhaleNotes;
                    playBreathNote(notes, breathPhase);
                }

                lastPhase = breathPhase;

                // Update drone
                if (droneGain) {
                    droneGain.gain.setTargetAtTime(0.05 + breathPhase * 0.05, audioCtx.currentTime, 0.1);
                    droneFilter.frequency.setTargetAtTime(150 + breathPhase * 300, audioCtx.currentTime, 0.1);
                }
            }

            // Draw breathing circle
            const minRadius = 50;
            const maxRadius = 200;
            const radius = minRadius + (maxRadius - minRadius) * breathPhase;

            // Outer glow
            const gradient = ctx.createRadialGradient(centerX, centerY, radius * 0.5, centerX, centerY, radius * 2);
            gradient.addColorStop(0, `rgba(100,180,200,${0.1 + breathPhase * 0.2})`);
            gradient.addColorStop(1, 'rgba(100,180,200,0)');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, height);

            // Main circle
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
            ctx.strokeStyle = `rgba(100,180,200,${0.5 + breathPhase * 0.5})`;
            ctx.lineWidth = 3;
            ctx.stroke();

            // Inner circles
            for (let i = 1; i <= 3; i++) {
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius * (1 - i * 0.2), 0, Math.PI * 2);
                ctx.strokeStyle = `rgba(100,180,200,${0.2 * (1 - i * 0.25)})`;
                ctx.stroke();
            }

            // Draw particles
            particles.forEach((p, i) => {
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.01;

                if (breathDirection > 0) {
                    // Inhale: particles move inward
                    p.vx *= 0.98;
                    p.vy *= 0.98;
                } else {
                    // Exhale: particles move outward
                    p.vx *= 1.01;
                    p.vy *= 1.01;
                }

                ctx.beginPath();
                ctx.arc(p.x, p.y, 4 * p.life, 0, Math.PI * 2);
                ctx.fillStyle = `hsla(${p.hue},70%,60%,${p.life})`;
                ctx.fill();
            });

            // Remove dead particles
            for (let i = particles.length - 1; i >= 0; i--) {
                if (particles[i].life <= 0) particles.splice(i, 1);
            }

            // Draw breath phase indicator
            ctx.beginPath();
            ctx.arc(centerX, centerY + maxRadius + 50, 30, -Math.PI / 2, -Math.PI / 2 + breathPhase * Math.PI * 2);
            ctx.strokeStyle = 'rgba(100,180,200,0.5)';
            ctx.lineWidth = 5;
            ctx.stroke();

            requestAnimationFrame(draw);
        }

        document.getElementById('playBtn').addEventListener('click', function() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            isPlaying = !isPlaying;
            this.textContent = isPlaying ? '⏸ Pause' : '▶ Play';

            if (isPlaying && !droneOsc) {
                startDrone();
            }

            if (droneGain) {
                droneGain.gain.setTargetAtTime(isPlaying ? 0.05 : 0, audioCtx.currentTime, 0.5);
            }
        });

        document.getElementById('fastBtn').addEventListener('click', () => {
            breathSpeed = 0.015; // ~7 second cycle
        });

        document.getElementById('slowBtn').addEventListener('click', () => {
            breathSpeed = 0.005; // ~20 second cycle
        });

        window.addEventListener('resize', () => {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        });

        draw();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
