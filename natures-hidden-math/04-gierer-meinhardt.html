<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gierer-Meinhardt - Activator-Inhibitor Model</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0a0e1a; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        canvas { display: block; }
        .back-link {
            position: fixed; top: 18px; left: 18px; z-index: 100;
            color: #8A9A5B; text-decoration: none; font-size: 14px; font-weight: 600;
            background: rgba(10,14,26,0.8); padding: 8px 18px; border-radius: 25px;
            border: 2px solid #8A9A5B; transition: all 0.3s ease;
        }
        .back-link:hover { background: #8A9A5B; color: #0a0e1a; }
        .controls {
            position: fixed; top: 18px; right: 18px; z-index: 100;
            background: rgba(10,14,26,0.85); backdrop-filter: blur(10px);
            border-radius: 10px; padding: 18px; color: #c8d0e0;
            min-width: 270px; border: 1px solid rgba(138,154,91,0.3);
            max-height: calc(100vh - 40px); overflow-y: auto;
        }
        .controls h2 { color: #DDA15E; font-size: 16px; margin-bottom: 4px; }
        .controls p.desc { font-size: 11px; color: #8899aa; margin-bottom: 12px; line-height: 1.4; }
        .control-row { margin-bottom: 10px; }
        .control-row label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 3px; color: #a0b0c0; }
        .control-row label span { color: #DDA15E; font-family: monospace; }
        input[type="range"] {
            width: 100%; height: 4px; -webkit-appearance: none; appearance: none;
            background: #1a2035; border-radius: 2px; outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 14px; height: 14px; border-radius: 50%;
            background: #8A9A5B; cursor: pointer;
        }
        .btn {
            background: rgba(138,154,91,0.2); color: #8A9A5B; border: 1px solid rgba(138,154,91,0.4);
            padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px;
            transition: all 0.2s;
        }
        .btn:hover { background: rgba(138,154,91,0.4); }
        .btn.active { background: rgba(138,154,91,0.5); border-color: #8A9A5B; }
        .btn-row { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
        .section-label { font-size: 11px; color: #667; margin-top: 10px; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">&larr; Nature's Hidden Math</a>
    <div class="controls">
        <h2>Gierer-Meinhardt</h2>
        <p class="desc">Activator-inhibitor model: short-range activation competes with long-range inhibition, creating self-organized peaks that arrange into regular patterns. Click to add perturbation.</p>
        <div class="control-row">
            <label>Da (activator diffusion) <span id="daVal">0.01</span></label>
            <input type="range" id="daSlider" min="0.001" max="0.05" step="0.001" value="0.01">
        </div>
        <div class="control-row">
            <label>Dh (inhibitor diffusion) <span id="dhVal">0.40</span></label>
            <input type="range" id="dhSlider" min="0.05" max="1.5" step="0.01" value="0.40">
        </div>
        <div class="control-row">
            <label>Activator decay (mu_a) <span id="muaVal">0.04</span></label>
            <input type="range" id="muaSlider" min="0.01" max="0.15" step="0.005" value="0.04">
        </div>
        <div class="control-row">
            <label>Inhibitor decay (mu_h) <span id="muhVal">0.06</span></label>
            <input type="range" id="muhSlider" min="0.01" max="0.15" step="0.005" value="0.06">
        </div>
        <div class="control-row">
            <label>Steps/frame <span id="stepsVal">5</span></label>
            <input type="range" id="stepsSlider" min="1" max="20" step="1" value="5">
        </div>
        <div class="section-label">Display</div>
        <div class="btn-row">
            <button class="btn active" id="showActivator">Activator</button>
            <button class="btn" id="showBoth">Both</button>
        </div>
        <div class="btn-row" style="margin-top: 12px;">
            <button class="btn" onclick="window.reset()">Reset</button>
        </div>
    </div>
    <canvas id="canvas"></canvas>

    <script>
    (function() {
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        const W = 200;
        const H = 200;

        // Gierer-Meinhardt parameters
        let Da = 0.01;   // activator diffusion (small)
        let Dh = 0.40;   // inhibitor diffusion (large)
        let muA = 0.04;  // activator decay
        let muH = 0.06;  // inhibitor decay
        let rhoA = 0.005; // activator base production
        let rhoH = 0.0;  // inhibitor base production
        let stepsPerFrame = 5;
        const dt = 0.2;

        let showMode = 'activator'; // 'activator' or 'both'

        let a0 = new Float32Array(W * H);
        let h0 = new Float32Array(W * H);
        let a1 = new Float32Array(W * H);
        let h1 = new Float32Array(W * H);

        let imageData;

        function initGrid() {
            for (let i = 0; i < W * H; i++) {
                a0[i] = 0.01 + Math.random() * 0.02;
                h0[i] = 0.5 + Math.random() * 0.1;
            }
            // Seed a few activator bumps
            for (let s = 0; s < 8; s++) {
                const cx = Math.floor(Math.random() * W);
                const cy = Math.floor(Math.random() * H);
                const r = 3;
                for (let dy = -r; dy <= r; dy++) {
                    for (let dx = -r; dx <= r; dx++) {
                        if (dx*dx + dy*dy > r*r) continue;
                        const x = ((cx + dx) + W) % W;
                        const y = ((cy + dy) + H) % H;
                        a0[y * W + x] = 1.0 + Math.random() * 0.5;
                    }
                }
            }
        }

        function simStep() {
            for (let y = 0; y < H; y++) {
                for (let x = 0; x < W; x++) {
                    const idx = y * W + x;
                    const xm = ((x - 1) + W) % W;
                    const xp = (x + 1) % W;
                    const ym = ((y - 1) + H) % H;
                    const yp = (y + 1) % H;

                    const lapA = a0[ym * W + x] + a0[yp * W + x]
                               + a0[y * W + xm] + a0[y * W + xp]
                               - 4.0 * a0[idx];

                    const lapH = h0[ym * W + x] + h0[yp * W + x]
                               + h0[y * W + xm] + h0[y * W + xp]
                               - 4.0 * h0[idx];

                    const ai = a0[idx];
                    const hi = h0[idx];
                    const hSafe = Math.max(hi, 0.0001);

                    // Gierer-Meinhardt equations:
                    // da/dt = Da * lap(a) + a^2/h - muA*a + rhoA
                    // dh/dt = Dh * lap(h) + a^2 - muH*h + rhoH
                    a1[idx] = ai + dt * (Da * lapA + (ai * ai) / hSafe - muA * ai + rhoA);
                    h1[idx] = hi + dt * (Dh * lapH + ai * ai - muH * hi + rhoH);

                    if (a1[idx] < 0) a1[idx] = 0;
                    if (h1[idx] < 0) h1[idx] = 0;
                    // Soft cap
                    if (a1[idx] > 20) a1[idx] = 20;
                    if (h1[idx] > 100) h1[idx] = 100;
                }
            }
            const tmpA = a0; a0 = a1; a1 = tmpA;
            const tmpH = h0; h0 = h1; h1 = tmpH;
        }

        function activatorColor(val) {
            // Normalize: activator typically ranges 0-5 at steady state
            const t = Math.min(val / 3.0, 1.0);
            let r, g, b;
            if (t < 0.25) {
                const s = t / 0.25;
                r = Math.floor(10 + s * 30);
                g = Math.floor(8 + s * 10);
                b = Math.floor(25 + s * 20);
            } else if (t < 0.5) {
                const s = (t - 0.25) / 0.25;
                r = Math.floor(40 + s * 160);
                g = Math.floor(18 + s * 50);
                b = Math.floor(45 - s * 10);
            } else if (t < 0.75) {
                const s = (t - 0.5) / 0.25;
                r = Math.floor(200 + s * 45);
                g = Math.floor(68 + s * 80);
                b = Math.floor(35 + s * 15);
            } else {
                const s = (t - 0.75) / 0.25;
                r = Math.floor(245 + s * 10);
                g = Math.floor(148 + s * 80);
                b = Math.floor(50 + s * 60);
            }
            return [r, g, b];
        }

        function bothColor(aVal, hVal) {
            const ta = Math.min(aVal / 3.0, 1.0);
            const th = Math.min(hVal / 10.0, 1.0);
            // Activator in red/orange channel, inhibitor in blue channel
            return [
                Math.floor(15 + ta * 240),
                Math.floor(10 + ta * 100 - th * 50),
                Math.floor(20 + th * 200)
            ];
        }

        function render() {
            if (!imageData || imageData.width !== W || imageData.height !== H) {
                imageData = ctx.createImageData(W, H);
            }
            const data = imageData.data;

            for (let i = 0; i < W * H; i++) {
                let r, g, b;
                if (showMode === 'both') {
                    [r, g, b] = bothColor(a0[i], h0[i]);
                } else {
                    [r, g, b] = activatorColor(a0[i]);
                }
                const p = i * 4;
                data[p] = r;
                data[p + 1] = g;
                data[p + 2] = b;
                data[p + 3] = 255;
            }

            ctx.imageSmoothingEnabled = false;
            const tmpCanvas = document.createElement('canvas');
            tmpCanvas.width = W;
            tmpCanvas.height = H;
            tmpCanvas.getContext('2d').putImageData(imageData, 0, 0);
            ctx.drawImage(tmpCanvas, 0, 0, canvas.width, canvas.height);
        }

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        // Interaction - click to add activator
        function addActivator(clientX, clientY) {
            const rect = canvas.getBoundingClientRect();
            const mx = (clientX - rect.left) / rect.width;
            const my = (clientY - rect.top) / rect.height;
            const gx = Math.floor(mx * W);
            const gy = Math.floor(my * H);
            const radius = 4;
            for (let dy = -radius; dy <= radius; dy++) {
                for (let dx = -radius; dx <= radius; dx++) {
                    if (dx * dx + dy * dy > radius * radius) continue;
                    const x = ((gx + dx) + W) % W;
                    const y = ((gy + dy) + H) % H;
                    a0[y * W + x] += 2.0;
                }
            }
        }

        let isMouseDown = false;
        canvas.addEventListener('mousedown', (e) => { isMouseDown = true; addActivator(e.clientX, e.clientY); });
        canvas.addEventListener('mousemove', (e) => { if (isMouseDown) addActivator(e.clientX, e.clientY); });
        window.addEventListener('mouseup', () => { isMouseDown = false; });
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); addActivator(e.touches[0].clientX, e.touches[0].clientY); }, { passive: false });
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); addActivator(e.touches[0].clientX, e.touches[0].clientY); }, { passive: false });

        // Controls
        document.getElementById('daSlider').addEventListener('input', function() { Da = parseFloat(this.value); document.getElementById('daVal').textContent = Da.toFixed(3); });
        document.getElementById('dhSlider').addEventListener('input', function() { Dh = parseFloat(this.value); document.getElementById('dhVal').textContent = Dh.toFixed(2); });
        document.getElementById('muaSlider').addEventListener('input', function() { muA = parseFloat(this.value); document.getElementById('muaVal').textContent = muA.toFixed(3); });
        document.getElementById('muhSlider').addEventListener('input', function() { muH = parseFloat(this.value); document.getElementById('muhVal').textContent = muH.toFixed(3); });
        document.getElementById('stepsSlider').addEventListener('input', function() { stepsPerFrame = parseInt(this.value); document.getElementById('stepsVal').textContent = stepsPerFrame; });

        // Show mode
        document.getElementById('showActivator').addEventListener('click', function() {
            showMode = 'activator';
            this.classList.add('active');
            document.getElementById('showBoth').classList.remove('active');
        });
        document.getElementById('showBoth').addEventListener('click', function() {
            showMode = 'both';
            this.classList.add('active');
            document.getElementById('showActivator').classList.remove('active');
        });

        // Reset
        window.reset = function() {
            initGrid();
        };

        window.addEventListener('resize', resizeCanvas);

        resizeCanvas();
        initGrid();

        function animate() {
            for (let i = 0; i < stepsPerFrame; i++) {
                simStep();
            }
            render();
            requestAnimationFrame(animate);
        }
        animate();
    })();
    </script>
    <script src="../assets/js/enhance.js"></script>
</body>
</html>
