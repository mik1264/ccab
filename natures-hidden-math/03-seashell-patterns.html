<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seashell Patterns - 1D Reaction-Diffusion</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0a0e1a; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        canvas { display: block; }
        .back-link {
            position: fixed; top: 18px; left: 18px; z-index: 100;
            color: #8A9A5B; text-decoration: none; font-size: 14px; font-weight: 600;
            background: rgba(10,14,26,0.8); padding: 8px 18px; border-radius: 25px;
            border: 2px solid #8A9A5B; transition: all 0.3s ease;
        }
        .back-link:hover { background: #8A9A5B; color: #0a0e1a; }
        .controls {
            position: fixed; top: 18px; right: 18px; z-index: 100;
            background: rgba(10,14,26,0.85); backdrop-filter: blur(10px);
            border-radius: 10px; padding: 18px; color: #c8d0e0;
            min-width: 260px; border: 1px solid rgba(138,154,91,0.3);
        }
        .controls h2 { color: #DDA15E; font-size: 16px; margin-bottom: 4px; }
        .controls p.desc { font-size: 11px; color: #8899aa; margin-bottom: 12px; line-height: 1.4; }
        .control-row { margin-bottom: 10px; }
        .control-row label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 3px; color: #a0b0c0; }
        .control-row label span { color: #DDA15E; font-family: monospace; }
        input[type="range"] {
            width: 100%; height: 4px; -webkit-appearance: none; appearance: none;
            background: #1a2035; border-radius: 2px; outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 14px; height: 14px; border-radius: 50%;
            background: #8A9A5B; cursor: pointer;
        }
        .btn {
            background: rgba(138,154,91,0.2); color: #8A9A5B; border: 1px solid rgba(138,154,91,0.4);
            padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px;
            transition: all 0.2s;
        }
        .btn:hover { background: rgba(138,154,91,0.4); }
        .btn.active { background: rgba(138,154,91,0.5); border-color: #8A9A5B; }
        .btn-row { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
        .section-label { font-size: 11px; color: #667; margin-top: 10px; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">&larr; Nature's Hidden Math</a>
    <div class="controls">
        <h2>Seashell Patterns</h2>
        <p class="desc">1D activator-inhibitor system painted row by row, mimicking how pigment patterns form on growing cone snail shells. Each row is one time step.</p>
        <div class="control-row">
            <label>Activator strength <span id="muAVal">0.08</span></label>
            <input type="range" id="muA" min="0.01" max="0.20" step="0.005" value="0.08">
        </div>
        <div class="control-row">
            <label>Inhibitor strength <span id="muHVal">0.10</span></label>
            <input type="range" id="muH" min="0.01" max="0.25" step="0.005" value="0.10">
        </div>
        <div class="control-row">
            <label>Diffusion ratio <span id="diffVal">12.0</span></label>
            <input type="range" id="diffRatio" min="2" max="30" step="0.5" value="12">
        </div>
        <div class="control-row">
            <label>Speed <span id="speedVal">3</span></label>
            <input type="range" id="speed" min="1" max="10" step="1" value="3">
        </div>
        <div class="section-label">Shell Presets</div>
        <div class="btn-row">
            <button class="btn active" id="presetTextile">Conus textile</button>
            <button class="btn" id="presetZigzag">Zigzag</button>
            <button class="btn" id="presetTent">Tent</button>
            <button class="btn" id="presetWaves">Waves</button>
        </div>
        <div class="btn-row" style="margin-top: 12px;">
            <button class="btn" onclick="window.reset()">Reset</button>
        </div>
    </div>
    <canvas id="canvas"></canvas>

    <script>
    (function() {
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // Simulation parameters
        const N = 512; // 1D grid width
        let Da = 0.02; // activator diffusion
        let Dh_ratio = 12.0; // Dh = Da * ratio
        let muA = 0.08; // activator decay
        let muH = 0.10; // inhibitor decay
        let rhoA = 0.01; // activator base production
        let rhoH = 0.0; // inhibitor base production
        let speed = 3; // rows per frame
        const dt = 0.5;

        // 1D arrays
        let a = new Float32Array(N);
        let h = new Float32Array(N);
        let aNew = new Float32Array(N);
        let hNew = new Float32Array(N);

        // 2D history for rendering (scrolling rows)
        let historyRows = [];
        let maxRows;

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            maxRows = canvas.height;
        }

        function initSim() {
            historyRows = [];
            // Initialize with small random perturbations
            for (let i = 0; i < N; i++) {
                a[i] = 0.01 + Math.random() * 0.02;
                h[i] = 0.01 + Math.random() * 0.01;
            }
            // Add a few random spikes to seed pattern formation
            for (let s = 0; s < 5; s++) {
                const pos = Math.floor(Math.random() * N);
                a[pos] = 1.0 + Math.random();
            }
        }

        function simStep() {
            const Dh = Da * Dh_ratio;

            for (let i = 0; i < N; i++) {
                const im = (i - 1 + N) % N;
                const ip = (i + 1) % N;

                const lapA = a[im] + a[ip] - 2.0 * a[i];
                const lapH = h[im] + h[ip] - 2.0 * h[i];

                const ai = a[i];
                const hi = h[i];

                // Gierer-Meinhardt 1D: da/dt = Da*lap(a) + a^2/h - muA*a + rhoA
                //                      dh/dt = Dh*lap(h) + a^2 - muH*h + rhoH
                const hSafe = Math.max(hi, 0.001);
                aNew[i] = ai + dt * (Da * lapA + (ai * ai) / hSafe - muA * ai + rhoA);
                hNew[i] = hi + dt * (Dh * lapH + ai * ai - muH * hi + rhoH);

                if (aNew[i] < 0) aNew[i] = 0;
                if (hNew[i] < 0) hNew[i] = 0;
                // Soft cap to prevent blowup
                if (aNew[i] > 10) aNew[i] = 10;
                if (hNew[i] > 50) hNew[i] = 50;
            }

            // Swap
            const tmpA = a; a = aNew; aNew = tmpA;
            const tmpH = h; h = hNew; hNew = tmpH;

            // Store row snapshot
            const row = new Float32Array(N);
            for (let i = 0; i < N; i++) {
                row[i] = a[i];
            }
            historyRows.push(row);

            // Limit history
            if (historyRows.length > maxRows + 100) {
                historyRows = historyRows.slice(historyRows.length - maxRows);
            }
        }

        // Shell-like colors: cream background with brown/orange pattern
        function shellColor(val) {
            // Normalize val - typical activator range is 0-5
            const t = Math.min(val / 2.5, 1.0);
            // Light background (cream) to dark pattern (brown/chocolate)
            const r = Math.floor(250 - t * 170);
            const g = Math.floor(240 - t * 185);
            const b = Math.floor(220 - t * 185);
            return [r, g, b];
        }

        function render() {
            ctx.fillStyle = '#f5efe0';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const rows = historyRows;
            const numRows = Math.min(rows.length, canvas.height);
            const startRow = rows.length - numRows;

            // Create image data sized to canvas
            const imgData = ctx.createImageData(canvas.width, numRows);
            const data = imgData.data;
            const cw = canvas.width;

            for (let r = 0; r < numRows; r++) {
                const row = rows[startRow + r];
                for (let px = 0; px < cw; px++) {
                    // Map canvas pixel to simulation cell
                    const simIdx = Math.floor((px / cw) * N);
                    const val = row[Math.min(simIdx, N - 1)];
                    const [cr, cg, cb] = shellColor(val);
                    const p = (r * cw + px) * 4;
                    data[p] = cr;
                    data[p + 1] = cg;
                    data[p + 2] = cb;
                    data[p + 3] = 255;
                }
            }

            ctx.putImageData(imgData, 0, canvas.height - numRows);
        }

        // Controls
        const muASlider = document.getElementById('muA');
        const muHSlider = document.getElementById('muH');
        const diffSlider = document.getElementById('diffRatio');
        const speedSlider = document.getElementById('speed');

        muASlider.addEventListener('input', () => { muA = parseFloat(muASlider.value); document.getElementById('muAVal').textContent = muA.toFixed(3); });
        muHSlider.addEventListener('input', () => { muH = parseFloat(muHSlider.value); document.getElementById('muHVal').textContent = muH.toFixed(3); });
        diffSlider.addEventListener('input', () => { Dh_ratio = parseFloat(diffSlider.value); document.getElementById('diffVal').textContent = Dh_ratio.toFixed(1); });
        speedSlider.addEventListener('input', () => { speed = parseInt(speedSlider.value); document.getElementById('speedVal').textContent = speed; });

        // Presets
        function setPreset(name) {
            const presets = {
                textile:  { muA: 0.08,  muH: 0.10,  diff: 12, Da: 0.02, rhoA: 0.01 },
                zigzag:   { muA: 0.05,  muH: 0.08,  diff: 18, Da: 0.015, rhoA: 0.008 },
                tent:     { muA: 0.12,  muH: 0.15,  diff: 8,  Da: 0.03, rhoA: 0.015 },
                waves:    { muA: 0.03,  muH: 0.06,  diff: 25, Da: 0.01, rhoA: 0.005 },
            };
            const p = presets[name];
            if (!p) return;
            muA = p.muA; muH = p.muH; Dh_ratio = p.diff; Da = p.Da; rhoA = p.rhoA;
            muASlider.value = muA; muHSlider.value = muH; diffSlider.value = Dh_ratio;
            document.getElementById('muAVal').textContent = muA.toFixed(3);
            document.getElementById('muHVal').textContent = muH.toFixed(3);
            document.getElementById('diffVal').textContent = Dh_ratio.toFixed(1);
            document.querySelectorAll('#presetTextile,#presetZigzag,#presetTent,#presetWaves').forEach(b => b.classList.remove('active'));
            const id = 'preset' + name.charAt(0).toUpperCase() + name.slice(1);
            document.getElementById(id).classList.add('active');
            initSim();
        }

        document.getElementById('presetTextile').addEventListener('click', () => setPreset('textile'));
        document.getElementById('presetZigzag').addEventListener('click', () => setPreset('zigzag'));
        document.getElementById('presetTent').addEventListener('click', () => setPreset('tent'));
        document.getElementById('presetWaves').addEventListener('click', () => setPreset('waves'));

        window.reset = function() {
            initSim();
        };

        window.addEventListener('resize', () => {
            resizeCanvas();
        });

        resizeCanvas();
        initSim();

        function animate() {
            for (let i = 0; i < speed; i++) {
                simStep();
            }
            render();
            requestAnimationFrame(animate);
        }
        animate();
    })();
    </script>
    <script src="../assets/js/enhance.js"></script>
</body>
</html>
