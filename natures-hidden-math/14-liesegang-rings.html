<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liesegang Rings - Periodic Precipitation</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0a0e1a; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        canvas { display: block; }
        .back-link {
            position: fixed; top: 18px; left: 18px; z-index: 100;
            color: #8A9A5B; text-decoration: none; font-size: 14px; font-weight: 600;
            background: rgba(10,14,26,0.8); padding: 10px 20px; border-radius: 25px;
            border: 2px solid #8A9A5B; transition: all 0.3s ease;
        }
        .back-link:hover { background: #8A9A5B; color: #0a0e1a; }
        .controls {
            position: fixed; top: 18px; right: 18px; z-index: 100;
            background: rgba(10,14,26,0.85); backdrop-filter: blur(10px);
            border-radius: 10px; padding: 20px; color: #c8d0e0;
            max-width: 300px; border: 1px solid rgba(138,154,91,0.3);
        }
        .controls h2 { color: #DDA15E; font-size: 16px; margin-bottom: 4px; }
        .controls p.desc { font-size: 11px; color: #8899aa; margin-bottom: 12px; line-height: 1.4; }
        .control-row { margin-bottom: 10px; }
        .control-row label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 3px; color: #a0b0c0; }
        .control-row label span { color: #DDA15E; font-family: monospace; }
        input[type="range"] {
            width: 100%; height: 4px; -webkit-appearance: none; appearance: none;
            background: #1a2035; border-radius: 2px; outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 14px; height: 14px; border-radius: 50%;
            background: #8A9A5B; cursor: pointer;
        }
        .btn {
            background: rgba(138,154,91,0.2); color: #8A9A5B; border: 1px solid rgba(138,154,91,0.4);
            padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;
            transition: all 0.2s;
        }
        .btn:hover { background: rgba(138,154,91,0.4); }
        .btn-row { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
        .stat-line { font-size: 11px; color: #6688aa; margin-top: 8px; font-family: monospace; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">&larr; Nature's Hidden Math</a>
    <div class="controls">
        <h2>Liesegang Rings</h2>
        <p class="desc">Periodic precipitation bands form when two reagents diffuse and react in a gel. The outer reagent (A) diffuses inward, meeting inner reagent (B). Where A*B exceeds a threshold, precipitate forms in rhythmic bands following a geometric spacing law.</p>
        <div class="control-row">
            <label>Concentration A <span id="concAVal">1.00</span></label>
            <input type="range" id="concA" min="0.3" max="3.0" step="0.05" value="1.00">
        </div>
        <div class="control-row">
            <label>Concentration B <span id="concBVal">0.40</span></label>
            <input type="range" id="concB" min="0.1" max="1.0" step="0.02" value="0.40">
        </div>
        <div class="control-row">
            <label>Precip. threshold <span id="precipVal">0.15</span></label>
            <input type="range" id="precip" min="0.02" max="0.5" step="0.01" value="0.15">
        </div>
        <div class="control-row">
            <label>Diffusion rate <span id="diffVal">0.40</span></label>
            <input type="range" id="diffRate" min="0.1" max="0.9" step="0.05" value="0.40">
        </div>
        <div class="btn-row">
            <button class="btn" onclick="window.reset()">Reset</button>
        </div>
        <div class="stat-line" id="stats">Rings: 0 | Step: 0</div>
    </div>
    <canvas id="canvas"></canvas>

    <script>
    (function() {
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // 1D radial simulation
        const N = 800; // radial resolution
        let A, B, P; // concentrations: reagent A, reagent B, precipitate
        let running = true;
        let stepCount = 0;
        let ringCount = 0;

        let concA0 = 1.0;   // boundary concentration of A
        let concB0 = 0.40;  // initial uniform concentration of B
        let precipThreshold = 0.15;
        let diffusionRate = 0.40;

        function init() {
            A = new Float64Array(N);
            B = new Float64Array(N);
            P = new Float64Array(N);
            stepCount = 0;
            ringCount = 0;

            // A starts at 0 everywhere except outer boundary
            A.fill(0);
            A[N - 1] = concA0;

            // B starts uniform
            B.fill(concB0);

            // No precipitate initially
            P.fill(0);
        }

        function step() {
            const DA = diffusionRate * 0.5;  // diffusion coefficient for A
            const DB = DA * 0.3;             // B diffuses slower (in gel)

            const newA = new Float64Array(N);
            const newB = new Float64Array(N);

            // Diffusion in 1D radial coordinates with radial correction
            for (let i = 1; i < N - 1; i++) {
                const r = i + 1; // radial position (avoid r=0 singularity)
                // Laplacian in cylindrical coords: d2f/dr2 + (1/r)*df/dr
                const lapA = (A[i + 1] - 2 * A[i] + A[i - 1]) + (A[i + 1] - A[i - 1]) / (2 * r);
                const lapB = (B[i + 1] - 2 * B[i] + B[i - 1]) + (B[i + 1] - B[i - 1]) / (2 * r);

                newA[i] = A[i] + DA * lapA;
                newB[i] = B[i] + DB * lapB;
            }

            // Boundary conditions
            newA[0] = newA[1];       // reflective at center
            newB[0] = newB[1];
            newA[N - 1] = concA0;    // fixed concentration at outer edge
            newB[N - 1] = 0;         // no B at outer edge

            // Precipitation reaction
            let prevP = ringCount;
            for (let i = 0; i < N; i++) {
                if (P[i] > 0) continue; // already precipitated

                const product = newA[i] * newB[i];
                if (product > precipThreshold) {
                    // Precipitate forms, consuming both reagents
                    const consumed = Math.min(newA[i], newB[i]) * 0.8;
                    P[i] = consumed;
                    newA[i] -= consumed;
                    newB[i] -= consumed;
                }
            }

            // Count rings (connected precipitate regions)
            ringCount = 0;
            let inRing = false;
            for (let i = N - 1; i >= 0; i--) {
                if (P[i] > 0 && !inRing) {
                    ringCount++;
                    inRing = true;
                } else if (P[i] === 0) {
                    inRing = false;
                }
            }

            A = newA;
            B = newB;
            stepCount++;
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        function draw() {
            const W = canvas.width;
            const H = canvas.height;

            // Dark background
            ctx.fillStyle = '#0a0e1a';
            ctx.fillRect(0, 0, W, H);

            const cx = W / 2;
            const cy = H / 2;
            const dishRadius = Math.min(W, H) * 0.42;

            // Draw petri dish background (cream/warm tone)
            const dishGrad = ctx.createRadialGradient(cx, cy, 0, cx, cy, dishRadius);
            dishGrad.addColorStop(0, '#FEFAE0');
            dishGrad.addColorStop(0.85, '#F5EDD0');
            dishGrad.addColorStop(1, '#E8DCC0');
            ctx.beginPath();
            ctx.arc(cx, cy, dishRadius, 0, Math.PI * 2);
            ctx.fillStyle = dishGrad;
            ctx.fill();

            // Draw dish border (glass rim effect)
            ctx.beginPath();
            ctx.arc(cx, cy, dishRadius, 0, Math.PI * 2);
            ctx.strokeStyle = 'rgba(180, 170, 150, 0.6)';
            ctx.lineWidth = 3;
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(cx, cy, dishRadius + 2, 0, Math.PI * 2);
            ctx.strokeStyle = 'rgba(120, 110, 100, 0.3)';
            ctx.lineWidth = 1;
            ctx.stroke();

            // Map radial simulation to 2D dish
            // Index 0 = center, N-1 = edge
            // Draw concentric rings using the simulation data
            for (let i = N - 1; i >= 0; i--) {
                const rFrac = i / (N - 1);
                const r = rFrac * dishRadius;

                if (P[i] > 0) {
                    // Precipitate: dark amber/brown bands
                    const intensity = Math.min(P[i] * 3, 1);
                    const rd = Math.floor(140 * intensity + 60);
                    const gd = Math.floor(80 * intensity + 40);
                    const bd = Math.floor(20 * intensity + 15);
                    ctx.beginPath();
                    ctx.arc(cx, cy, r, 0, Math.PI * 2);
                    ctx.strokeStyle = 'rgba(' + rd + ',' + gd + ',' + bd + ',' + (0.6 + 0.4 * intensity) + ')';
                    ctx.lineWidth = Math.max(2, dishRadius / N * 1.5);
                    ctx.stroke();
                } else {
                    // Show reagent A diffusion front as very subtle blue tint
                    if (A[i] > 0.01) {
                        const aInt = Math.min(A[i] / concA0, 1);
                        ctx.beginPath();
                        ctx.arc(cx, cy, r, 0, Math.PI * 2);
                        ctx.strokeStyle = 'rgba(100, 130, 180,' + (aInt * 0.08) + ')';
                        ctx.lineWidth = Math.max(1, dishRadius / N);
                        ctx.stroke();
                    }
                }
            }

            // Outer reagent source glow
            ctx.beginPath();
            ctx.arc(cx, cy, dishRadius - 2, 0, Math.PI * 2);
            ctx.strokeStyle = 'rgba(100, 140, 200, 0.3)';
            ctx.lineWidth = 4;
            ctx.stroke();

            // Subtle shadow under dish
            const shadowGrad = ctx.createRadialGradient(cx, cy + 8, dishRadius * 0.9, cx, cy + 8, dishRadius * 1.1);
            shadowGrad.addColorStop(0, 'rgba(0,0,0,0.15)');
            shadowGrad.addColorStop(1, 'rgba(0,0,0,0)');
            ctx.fillStyle = shadowGrad;
            ctx.fillRect(0, 0, W, H);

            document.getElementById('stats').textContent = 'Rings: ' + ringCount + ' | Step: ' + stepCount;
        }

        // Controls
        document.getElementById('concA').addEventListener('input', function() {
            concA0 = parseFloat(this.value);
            document.getElementById('concAVal').textContent = concA0.toFixed(2);
        });
        document.getElementById('concB').addEventListener('input', function() {
            concB0 = parseFloat(this.value);
            document.getElementById('concBVal').textContent = concB0.toFixed(2);
        });
        document.getElementById('precip').addEventListener('input', function() {
            precipThreshold = parseFloat(this.value);
            document.getElementById('precipVal').textContent = precipThreshold.toFixed(2);
        });
        document.getElementById('diffRate').addEventListener('input', function() {
            diffusionRate = parseFloat(this.value);
            document.getElementById('diffVal').textContent = diffusionRate.toFixed(2);
        });

        window.reset = function() {
            init();
        };

        function animate() {
            if (running) {
                // Run multiple steps per frame for visible progress
                for (let i = 0; i < 10; i++) {
                    step();
                }
                draw();
            }
            requestAnimationFrame(animate);
        }

        window.addEventListener('resize', function() {
            resize();
            draw();
        });

        resize();
        init();
        animate();
    })();
    </script>
    <script src="../assets/js/enhance.js"></script>
</body>
</html>
