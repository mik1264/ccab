<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Romanesco Fractal - Nature's Hidden Math</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0a0e1a; overflow: hidden; font-family: 'Segoe UI', system-ui, sans-serif; }
        canvas { display: block; cursor: grab; }
        canvas:active { cursor: grabbing; }

        .back-link {
            position: fixed; top: 20px; left: 20px; z-index: 100;
            color: #8A9A5B; text-decoration: none; font-weight: 600;
            background: rgba(10,14,26,0.8); border: 2px solid #8A9A5B;
            padding: 10px 20px; border-radius: 25px; font-size: 14px;
            transition: all 0.3s ease;
        }
        .back-link:hover { background: #8A9A5B; color: #0a0e1a; }

        .controls {
            position: fixed; top: 20px; right: 20px; z-index: 100;
            background: rgba(10,14,26,0.85); backdrop-filter: blur(10px);
            border-radius: 10px; padding: 20px; min-width: 280px;
            border: 1px solid rgba(138,154,91,0.3); color: #c8d0b8;
        }
        .controls h2 { color: #8A9A5B; font-size: 18px; margin-bottom: 4px; }
        .controls .desc { font-size: 12px; color: #7a8a6a; margin-bottom: 14px; line-height: 1.4; }
        .control-group { margin-bottom: 12px; }
        .control-group label {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 13px; margin-bottom: 4px; color: #a0b090;
        }
        .control-group label span { color: #DDA15E; font-weight: 600; font-family: monospace; }
        input[type="range"] {
            width: 100%; height: 6px; -webkit-appearance: none; appearance: none;
            background: rgba(138,154,91,0.3); border-radius: 3px; outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 16px; height: 16px;
            background: #8A9A5B; border-radius: 50%; cursor: pointer;
        }
        .info-row {
            display: flex; justify-content: space-between; font-size: 12px;
            padding: 6px 0; border-top: 1px solid rgba(138,154,91,0.2); color: #7a8a6a;
        }
        .info-row .val { color: #DDA15E; font-weight: 600; }
        button {
            width: 100%; padding: 8px; margin-top: 8px;
            background: rgba(138,154,91,0.3); color: #8A9A5B;
            border: 1px solid rgba(138,154,91,0.5); border-radius: 6px;
            cursor: pointer; font-size: 13px; font-weight: 600;
            transition: all 0.3s ease;
        }
        button:hover { background: #8A9A5B; color: #0a0e1a; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">&larr; Nature's Hidden Math</a>

    <div class="controls">
        <h2>Romanesco Fractal</h2>
        <p class="desc">Self-similar spiral cones arranged at the golden angle. Each bud is a miniature copy of the whole.</p>

        <div class="control-group">
            <label>Recursion Depth <span id="depthVal">3</span></label>
            <input type="range" id="depth" min="1" max="4" step="1" value="3">
        </div>
        <div class="control-group">
            <label>Buds per Spiral <span id="budsVal">12</span></label>
            <input type="range" id="buds" min="5" max="25" step="1" value="12">
        </div>
        <div class="control-group">
            <label>Tilt Angle <span id="tiltVal">35</span>&deg;</label>
            <input type="range" id="tilt" min="10" max="70" step="1" value="35">
        </div>
        <div class="control-group">
            <label>Zoom <span id="zoomVal">1.0</span></label>
            <input type="range" id="zoom" min="0.3" max="3" step="0.1" value="1">
        </div>

        <div class="info-row">
            <span>Total Elements</span>
            <span class="val" id="totalVal">0</span>
        </div>
        <div class="info-row">
            <span>Golden Angle</span>
            <span class="val">137.508&deg;</span>
        </div>

        <button id="resetBtn">Reset View</button>
    </div>

    <canvas id="canvas"></canvas>

    <script>
    (function() {
        var canvas = document.getElementById('canvas');
        var ctx = canvas.getContext('2d');

        var depthSlider = document.getElementById('depth');
        var budsSlider = document.getElementById('buds');
        var tiltSlider = document.getElementById('tilt');
        var zoomSlider = document.getElementById('zoom');
        var depthVal = document.getElementById('depthVal');
        var budsVal = document.getElementById('budsVal');
        var tiltVal = document.getElementById('tiltVal');
        var zoomVal = document.getElementById('zoomVal');
        var totalVal = document.getElementById('totalVal');

        var rotX = 0;
        var rotY = 0;
        var dragging = false;
        var lastMX = 0, lastMY = 0;
        var animId;
        var time = 0;
        var totalElements = 0;

        var GOLDEN_ANGLE = 137.508 * Math.PI / 180;

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resize();
        window.addEventListener('resize', resize);

        // Mouse drag for rotation
        canvas.addEventListener('mousedown', function(e) {
            dragging = true; lastMX = e.clientX; lastMY = e.clientY;
        });
        window.addEventListener('mousemove', function(e) {
            if (!dragging) return;
            rotY += (e.clientX - lastMX) * 0.005;
            rotX += (e.clientY - lastMY) * 0.005;
            rotX = Math.max(-1.2, Math.min(1.2, rotX));
            lastMX = e.clientX; lastMY = e.clientY;
        });
        window.addEventListener('mouseup', function() { dragging = false; });

        // Touch support
        canvas.addEventListener('touchstart', function(e) {
            if (e.touches.length === 1) {
                dragging = true;
                lastMX = e.touches[0].clientX;
                lastMY = e.touches[0].clientY;
            }
        });
        canvas.addEventListener('touchmove', function(e) {
            if (!dragging || e.touches.length !== 1) return;
            e.preventDefault();
            rotY += (e.touches[0].clientX - lastMX) * 0.005;
            rotX += (e.touches[0].clientY - lastMY) * 0.005;
            rotX = Math.max(-1.2, Math.min(1.2, rotX));
            lastMX = e.touches[0].clientX;
            lastMY = e.touches[0].clientY;
        }, { passive: false });
        canvas.addEventListener('touchend', function() { dragging = false; });

        function project(x, y, z, cx, cy, zoom) {
            // Apply rotations
            var cosX = Math.cos(rotX), sinX = Math.sin(rotX);
            var cosY = Math.cos(rotY), sinY = Math.sin(rotY);

            // Rotate around Y axis
            var x1 = x * cosY - z * sinY;
            var z1 = x * sinY + z * cosY;

            // Rotate around X axis
            var y1 = y * cosX - z1 * sinX;
            var z2 = y * sinX + z1 * cosX;

            // Perspective
            var fov = 600;
            var scale = fov / (fov + z2) * zoom;

            return {
                x: cx + x1 * scale,
                y: cy + y1 * scale,
                z: z2,
                scale: scale
            };
        }

        function budColor(depth, maxDepth, index, total) {
            var t = maxDepth > 0 ? depth / maxDepth : 0;
            var r = Math.round(40 + 80 * t);
            var g = Math.round(100 + 80 * (1 - t * 0.5));
            var b = Math.round(30 + 30 * t);
            return { r: r, g: g, b: b };
        }

        function generateBuds(cx, cy, cz, radius, depth, maxDepth, tiltAngle, numBuds, buds) {
            if (depth > maxDepth || radius < 1.5) return;

            var tilt = tiltAngle * Math.PI / 180;

            for (var i = 0; i < numBuds; i++) {
                var t = (i + 1) / numBuds;
                var angle = i * GOLDEN_ANGLE + time * 0.15;
                var r = radius * t * 0.85;
                var budRadius = radius * (1 - t * 0.6) * 0.35;

                // Position on a cone surface
                var spiralX = r * Math.cos(angle);
                var spiralY = r * Math.sin(angle);
                // Height increases toward center (cone shape)
                var height = radius * (1 - t) * 0.6 * Math.cos(tilt);

                // Apply tilt
                var bx = cx + spiralX;
                var by = cy - height;
                var bz = cz + spiralY;

                var col = budColor(depth, maxDepth, i, numBuds);
                var shade = 0.5 + 0.5 * (1 - t);
                buds.push({
                    x: bx, y: by, z: bz,
                    radius: budRadius,
                    r: Math.round(col.r * shade),
                    g: Math.round(col.g * shade),
                    b: Math.round(col.b * shade),
                    depth: depth
                });

                // Recurse
                if (depth < maxDepth && budRadius > 3) {
                    generateBuds(bx, by, bz, budRadius, depth + 1, maxDepth, tiltAngle * 0.8, Math.max(5, Math.floor(numBuds * 0.7)), buds);
                }
            }
        }

        function drawBackground() {
            var grad = ctx.createRadialGradient(
                canvas.width / 2, canvas.height / 2, 0,
                canvas.width / 2, canvas.height / 2, canvas.width * 0.6
            );
            grad.addColorStop(0, '#111a28');
            grad.addColorStop(0.5, '#0c1220');
            grad.addColorStop(1, '#0a0e1a');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        function draw() {
            time += 0.008;

            var maxDepth = parseInt(depthSlider.value);
            var numBuds = parseInt(budsSlider.value);
            var tiltAngle = parseFloat(tiltSlider.value);
            var zoom = parseFloat(zoomSlider.value);

            var cx = canvas.width / 2;
            var cy = canvas.height / 2;
            var baseRadius = Math.min(canvas.width, canvas.height) * 0.25;

            drawBackground();

            // Generate all buds
            var buds = [];

            // Central bud
            buds.push({
                x: 0, y: -baseRadius * 0.1, z: 0,
                radius: baseRadius * 0.15,
                r: 80, g: 140, b: 50,
                depth: 0
            });

            generateBuds(0, 0, 0, baseRadius, 1, maxDepth, tiltAngle, numBuds, buds);

            totalElements = buds.length;
            totalVal.textContent = totalElements;

            // Project and sort by z
            var projected = [];
            for (var i = 0; i < buds.length; i++) {
                var b = buds[i];
                var p = project(b.x, b.y, b.z, cx, cy, zoom);
                projected.push({
                    px: p.x, py: p.y, pz: p.z,
                    radius: b.radius * p.scale,
                    r: b.r, g: b.g, b: b.b,
                    scale: p.scale, depth: b.depth
                });
            }

            // Sort back to front
            projected.sort(function(a, b) { return b.pz - a.pz; });

            // Draw buds
            for (var i = 0; i < projected.length; i++) {
                var p = projected[i];
                if (p.radius < 0.5) continue;

                var r = Math.max(1, p.radius);

                // Main bud circle
                ctx.beginPath();
                ctx.arc(p.px, p.py, r, 0, Math.PI * 2);
                ctx.fillStyle = 'rgb(' + p.r + ',' + p.g + ',' + p.b + ')';
                ctx.fill();

                // Highlight
                if (r > 3) {
                    var hlGrad = ctx.createRadialGradient(
                        p.px - r * 0.25, p.py - r * 0.25, 0,
                        p.px, p.py, r
                    );
                    hlGrad.addColorStop(0, 'rgba(200,255,150,0.25)');
                    hlGrad.addColorStop(0.5, 'rgba(200,255,150,0.05)');
                    hlGrad.addColorStop(1, 'rgba(0,0,0,0.2)');
                    ctx.beginPath();
                    ctx.arc(p.px, p.py, r, 0, Math.PI * 2);
                    ctx.fillStyle = hlGrad;
                    ctx.fill();
                }

                // Outline
                ctx.beginPath();
                ctx.arc(p.px, p.py, r, 0, Math.PI * 2);
                ctx.strokeStyle = 'rgba(30,60,20,0.4)';
                ctx.lineWidth = Math.max(0.5, r * 0.08);
                ctx.stroke();
            }

            animId = requestAnimationFrame(draw);
        }

        depthSlider.addEventListener('input', function() { depthVal.textContent = this.value; });
        budsSlider.addEventListener('input', function() { budsVal.textContent = this.value; });
        tiltSlider.addEventListener('input', function() { tiltVal.textContent = this.value; });
        zoomSlider.addEventListener('input', function() { zoomVal.textContent = parseFloat(this.value).toFixed(1); });

        function reset() {
            rotX = 0;
            rotY = 0;
            time = 0;
            zoomSlider.value = 1;
            zoomVal.textContent = '1.0';
        }

        window.reset = reset;
        document.getElementById('resetBtn').addEventListener('click', reset);

        draw();
    })();
    </script>
    <script src="../assets/js/enhance.js"></script>
</body>
</html>