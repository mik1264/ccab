<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L-System Trees - Nature's Hidden Math</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0a0e1a; overflow: hidden; font-family: 'Segoe UI', system-ui, sans-serif; }
        canvas { display: block; }

        .back-link {
            position: fixed; top: 20px; left: 20px; z-index: 100;
            color: #8A9A5B; text-decoration: none; font-weight: 600;
            background: rgba(10,14,26,0.8); border: 2px solid #8A9A5B;
            padding: 10px 20px; border-radius: 25px; font-size: 14px;
            transition: all 0.3s ease;
        }
        .back-link:hover { background: #8A9A5B; color: #0a0e1a; }

        .controls {
            position: fixed; top: 20px; right: 20px; z-index: 100;
            background: rgba(10,14,26,0.85); backdrop-filter: blur(10px);
            border-radius: 10px; padding: 20px; min-width: 280px;
            border: 1px solid rgba(138,154,91,0.3); color: #c8d0b8;
            max-height: calc(100vh - 40px); overflow-y: auto;
        }
        .controls h2 { color: #8A9A5B; font-size: 18px; margin-bottom: 4px; }
        .controls .desc { font-size: 12px; color: #7a8a6a; margin-bottom: 14px; line-height: 1.4; }
        .control-group { margin-bottom: 12px; }
        .control-group label {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 13px; margin-bottom: 4px; color: #a0b090;
        }
        .control-group label span { color: #DDA15E; font-weight: 600; font-family: monospace; }
        input[type="range"] {
            width: 100%; height: 6px; -webkit-appearance: none; appearance: none;
            background: rgba(138,154,91,0.3); border-radius: 3px; outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 16px; height: 16px;
            background: #8A9A5B; border-radius: 50%; cursor: pointer;
        }
        select {
            width: 100%; padding: 6px 10px; background: rgba(138,154,91,0.2);
            color: #c8d0b8; border: 1px solid rgba(138,154,91,0.4);
            border-radius: 6px; font-size: 13px; outline: none; cursor: pointer;
        }
        select option { background: #0a0e1a; }
        button {
            width: 100%; padding: 8px; margin-top: 8px;
            background: rgba(138,154,91,0.3); color: #8A9A5B;
            border: 1px solid rgba(138,154,91,0.5); border-radius: 6px;
            cursor: pointer; font-size: 13px; font-weight: 600;
            transition: all 0.3s ease;
        }
        button:hover { background: #8A9A5B; color: #0a0e1a; }
        .info-row {
            display: flex; justify-content: space-between; font-size: 12px;
            padding: 6px 0; border-top: 1px solid rgba(138,154,91,0.2); color: #7a8a6a;
        }
        .info-row .val { color: #DDA15E; font-weight: 600; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">&larr; Nature's Hidden Math</a>

    <div class="controls">
        <h2>L-System Trees</h2>
        <p class="desc">Fractal trees from simple string rewriting rules. F=forward, +=right, -=left, []=branch.</p>

        <div class="control-group">
            <label>Preset</label>
            <select id="preset">
                <option value="oak">Oak</option>
                <option value="willow">Willow</option>
                <option value="bush">Bush</option>
                <option value="fractal" selected>Fractal</option>
            </select>
        </div>
        <div class="control-group">
            <label>Branch Angle <span id="angleVal">25</span>&deg;</label>
            <input type="range" id="angle" min="10" max="45" step="0.5" value="25">
        </div>
        <div class="control-group">
            <label>Recursion Depth <span id="depthVal">5</span></label>
            <input type="range" id="depth" min="2" max="7" step="1" value="5">
        </div>
        <div class="control-group">
            <label>Branch Length <span id="lengthVal">8</span></label>
            <input type="range" id="length" min="3" max="20" step="0.5" value="8">
        </div>
        <div class="control-group">
            <label>Wind Strength <span id="windVal">0.5</span></label>
            <input type="range" id="wind" min="0" max="3" step="0.1" value="0.5">
        </div>

        <div class="info-row">
            <span>Segments</span>
            <span class="val" id="segVal">0</span>
        </div>

        <button id="resetBtn">Regenerate Tree</button>
    </div>

    <canvas id="canvas"></canvas>

    <script>
    (function() {
        var canvas = document.getElementById('canvas');
        var ctx = canvas.getContext('2d');

        var presetSelect = document.getElementById('preset');
        var angleSlider = document.getElementById('angle');
        var depthSlider = document.getElementById('depth');
        var lengthSlider = document.getElementById('length');
        var windSlider = document.getElementById('wind');
        var angleVal = document.getElementById('angleVal');
        var depthVal = document.getElementById('depthVal');
        var lengthVal = document.getElementById('lengthVal');
        var windVal = document.getElementById('windVal');
        var segVal = document.getElementById('segVal');

        var presets = {
            oak: { axiom: 'F', rules: { F: 'FF+[+F-F-F]-[-F+F+F]' }, angle: 22.5 },
            willow: { axiom: 'F', rules: { F: 'FF-[-F+F+F]+[+F-F-F]' }, angle: 25 },
            bush: { axiom: 'F', rules: { F: 'F[+F]F[-F]F' }, angle: 25.7 },
            fractal: { axiom: 'X', rules: { X: 'F+[[X]-X]-F[-FX]+X', F: 'FF' }, angle: 25 }
        };

        var segments = [];
        var drawIndex = 0;
        var animId;
        var time = 0;

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            generate();
        }

        function lSystem(axiom, rules, depth) {
            var str = axiom;
            for (var i = 0; i < depth; i++) {
                var next = '';
                for (var j = 0; j < str.length; j++) {
                    var ch = str[j];
                    next += rules[ch] || ch;
                }
                str = next;
            }
            return str;
        }

        function buildSegments(str, branchLen, baseAngle) {
            var segs = [];
            var stack = [];
            var x = canvas.width / 2;
            var y = canvas.height - 40;
            var currentAngle = -90;
            var depthLevel = 0;
            var maxDepth = 0;

            var angleRad = baseAngle * Math.PI / 180;

            for (var i = 0; i < str.length; i++) {
                var ch = str[i];
                if (ch === 'F') {
                    var nx = x + branchLen * Math.cos(currentAngle * Math.PI / 180);
                    var ny = y + branchLen * Math.sin(currentAngle * Math.PI / 180);
                    segs.push({ x1: x, y1: y, x2: nx, y2: ny, depth: depthLevel });
                    if (depthLevel > maxDepth) maxDepth = depthLevel;
                    x = nx;
                    y = ny;
                } else if (ch === '+') {
                    currentAngle += baseAngle;
                } else if (ch === '-') {
                    currentAngle -= baseAngle;
                } else if (ch === '[') {
                    stack.push({ x: x, y: y, angle: currentAngle, depth: depthLevel });
                    depthLevel++;
                } else if (ch === ']') {
                    var state = stack.pop();
                    if (state) {
                        x = state.x;
                        y = state.y;
                        currentAngle = state.angle;
                        depthLevel = state.depth;
                    }
                }
            }

            for (var i = 0; i < segs.length; i++) {
                segs[i].maxDepth = maxDepth;
            }
            return segs;
        }

        function generate() {
            var presetName = presetSelect.value;
            var preset = presets[presetName];
            var depth = parseInt(depthSlider.value);
            var branchLen = parseFloat(lengthSlider.value);
            var angle = parseFloat(angleSlider.value);

            var str = lSystem(preset.axiom, preset.rules, depth);
            segments = buildSegments(str, branchLen, angle);
            drawIndex = 0;
            segVal.textContent = segments.length;
        }

        function segColor(seg) {
            var t = seg.maxDepth > 0 ? seg.depth / seg.maxDepth : 0;
            var r = Math.round(80 + (60 - 80) * t);
            var g = Math.round(50 + (140 - 50) * t);
            var b = Math.round(30 + (50 - 30) * t);
            return 'rgb(' + r + ',' + g + ',' + b + ')';
        }

        function segWidth(seg) {
            var t = seg.maxDepth > 0 ? seg.depth / seg.maxDepth : 0;
            return Math.max(0.5, 4 * (1 - t));
        }

        function drawBackground() {
            var grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
            grad.addColorStop(0, '#0a0e1a');
            grad.addColorStop(0.7, '#0c1220');
            grad.addColorStop(1, '#101820');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Subtle ground
            ctx.fillStyle = 'rgba(60,50,30,0.3)';
            ctx.fillRect(0, canvas.height - 30, canvas.width, 30);
        }

        function animate() {
            var windStr = parseFloat(windSlider.value);
            time += 0.015;

            drawBackground();

            var drawSpeed = Math.max(1, Math.floor(segments.length / 180));
            drawIndex = Math.min(drawIndex + drawSpeed, segments.length);

            for (var i = 0; i < drawIndex; i++) {
                var s = segments[i];
                var windOffset = 0;
                if (windStr > 0) {
                    var heightRatio = 1 - (s.y1 / canvas.height);
                    windOffset = Math.sin(time * 2 + s.y1 * 0.01) * windStr * heightRatio * 3;
                }

                ctx.beginPath();
                ctx.moveTo(s.x1 + windOffset * 0.5, s.y1);
                ctx.lineTo(s.x2 + windOffset, s.y2);
                ctx.strokeStyle = segColor(s);
                ctx.lineWidth = segWidth(s);
                ctx.lineCap = 'round';
                ctx.stroke();

                // Leaves at tips
                if (s.depth === s.maxDepth && windStr >= 0) {
                    ctx.beginPath();
                    ctx.arc(s.x2 + windOffset, s.y2, 2, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(100,160,60,0.6)';
                    ctx.fill();
                }
            }

            animId = requestAnimationFrame(animate);
        }

        presetSelect.addEventListener('change', function() {
            var p = presets[this.value];
            angleSlider.value = p.angle;
            angleVal.textContent = p.angle;
            generate();
        });

        angleSlider.addEventListener('input', function() { angleVal.textContent = parseFloat(this.value).toFixed(1); generate(); });
        depthSlider.addEventListener('input', function() { depthVal.textContent = this.value; generate(); });
        lengthSlider.addEventListener('input', function() { lengthVal.textContent = parseFloat(this.value).toFixed(1); generate(); });
        windSlider.addEventListener('input', function() { windVal.textContent = parseFloat(this.value).toFixed(1); });

        function reset() {
            generate();
        }

        window.reset = reset;
        document.getElementById('resetBtn').addEventListener('click', reset);

        resize();
        window.addEventListener('resize', resize);
        animate();
    })();
    </script>
    <script src="../assets/js/enhance.js"></script>
</body>
</html>