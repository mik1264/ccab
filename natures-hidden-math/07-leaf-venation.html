<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaf Venation - Nature's Hidden Math</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0a0e1a; overflow: hidden; font-family: 'Segoe UI', system-ui, sans-serif; }
        canvas { display: block; }

        .back-link {
            position: fixed; top: 20px; left: 20px; z-index: 100;
            color: #8A9A5B; text-decoration: none; font-weight: 600;
            background: rgba(10,14,26,0.8); border: 2px solid #8A9A5B;
            padding: 10px 20px; border-radius: 25px; font-size: 14px;
            transition: all 0.3s ease;
        }
        .back-link:hover { background: #8A9A5B; color: #0a0e1a; }

        .controls {
            position: fixed; top: 20px; right: 20px; z-index: 100;
            background: rgba(10,14,26,0.85); backdrop-filter: blur(10px);
            border-radius: 10px; padding: 20px; min-width: 280px;
            border: 1px solid rgba(138,154,91,0.3); color: #c8d0b8;
        }
        .controls h2 { color: #8A9A5B; font-size: 18px; margin-bottom: 4px; }
        .controls .desc { font-size: 12px; color: #7a8a6a; margin-bottom: 14px; line-height: 1.4; }
        .control-group { margin-bottom: 12px; }
        .control-group label {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 13px; margin-bottom: 4px; color: #a0b090;
        }
        .control-group label span { color: #DDA15E; font-weight: 600; font-family: monospace; }
        input[type="range"] {
            width: 100%; height: 6px; -webkit-appearance: none; appearance: none;
            background: rgba(138,154,91,0.3); border-radius: 3px; outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 16px; height: 16px;
            background: #8A9A5B; border-radius: 50%; cursor: pointer;
        }
        .info-row {
            display: flex; justify-content: space-between; font-size: 12px;
            padding: 6px 0; border-top: 1px solid rgba(138,154,91,0.2); color: #7a8a6a;
        }
        .info-row .val { color: #DDA15E; font-weight: 600; }
        button {
            width: 100%; padding: 8px; margin-top: 8px;
            background: rgba(138,154,91,0.3); color: #8A9A5B;
            border: 1px solid rgba(138,154,91,0.5); border-radius: 6px;
            cursor: pointer; font-size: 13px; font-weight: 600;
            transition: all 0.3s ease;
        }
        button:hover { background: #8A9A5B; color: #0a0e1a; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">&larr; Nature's Hidden Math</a>

    <div class="controls">
        <h2>Leaf Venation</h2>
        <p class="desc">Space colonization algorithm: auxin sources guide vein growth, creating realistic branching patterns.</p>

        <div class="control-group">
            <label>Auxin Sources <span id="auxinVal">500</span></label>
            <input type="range" id="auxin" min="100" max="1000" step="10" value="500">
        </div>
        <div class="control-group">
            <label>Influence Distance <span id="influenceVal">80</span></label>
            <input type="range" id="influence" min="30" max="200" step="5" value="80">
        </div>
        <div class="control-group">
            <label>Kill Distance <span id="killVal">10</span></label>
            <input type="range" id="kill" min="3" max="40" step="1" value="10">
        </div>
        <div class="control-group">
            <label>Growth Speed <span id="speedVal">3</span></label>
            <input type="range" id="speed" min="1" max="10" step="1" value="3">
        </div>

        <div class="info-row">
            <span>Vein Nodes</span>
            <span class="val" id="nodesVal">0</span>
        </div>
        <div class="info-row">
            <span>Remaining Auxin</span>
            <span class="val" id="remainVal">0</span>
        </div>

        <button id="resetBtn">New Leaf</button>
    </div>

    <canvas id="canvas"></canvas>

    <script>
    (function() {
        var canvas = document.getElementById('canvas');
        var ctx = canvas.getContext('2d');

        var auxinSlider = document.getElementById('auxin');
        var influenceSlider = document.getElementById('influence');
        var killSlider = document.getElementById('kill');
        var speedSlider = document.getElementById('speed');
        var auxinVal = document.getElementById('auxinVal');
        var influenceVal = document.getElementById('influenceVal');
        var killVal = document.getElementById('killVal');
        var speedVal = document.getElementById('speedVal');
        var nodesVal = document.getElementById('nodesVal');
        var remainVal = document.getElementById('remainVal');

        var veins = [];
        var auxins = [];
        var animId;
        var growing = true;
        var leafCx, leafCy, leafScale;

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            initLeaf();
        }

        function isInsideLeaf(x, y) {
            // Leaf shape: parametric heart-like curve
            var dx = (x - leafCx) / (leafScale * 0.9);
            var dy = (y - leafCy) / (leafScale * 1.3);
            // Shift so base is at bottom
            dy += 0.15;
            // Heart/leaf equation: (x^2 + y^2 - 1)^3 - x^2*y^3 < 0
            var x2 = dx * dx;
            var y2 = dy * dy;
            var val = Math.pow(x2 + y2 - 1, 3) - x2 * dy * dy * dy;
            return val < 0;
        }

        function drawLeafOutline() {
            ctx.beginPath();
            var steps = 200;
            var first = true;
            for (var t = 0; t <= Math.PI * 2; t += Math.PI * 2 / steps) {
                // Parametric heart curve
                var hx = 16 * Math.pow(Math.sin(t), 3);
                var hy = -(13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t));
                var px = leafCx + hx * leafScale / 17;
                var py = leafCy + hy * leafScale / 17;
                if (first) { ctx.moveTo(px, py); first = false; }
                else ctx.lineTo(px, py);
            }
            ctx.closePath();
            ctx.fillStyle = 'rgba(30,60,25,0.3)';
            ctx.fill();
            ctx.strokeStyle = 'rgba(80,130,50,0.5)';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        function initLeaf() {
            leafCx = canvas.width / 2;
            leafCy = canvas.height / 2;
            leafScale = Math.min(canvas.width, canvas.height) * 0.35;

            veins = [];
            auxins = [];
            growing = true;

            // Root vein node at bottom of leaf
            veins.push({
                x: leafCx,
                y: leafCy + leafScale * 0.7,
                parent: -1,
                depth: 0
            });

            // Scatter auxin sources inside leaf
            var numAuxin = parseInt(auxinSlider.value);
            var attempts = 0;
            while (auxins.length < numAuxin && attempts < numAuxin * 20) {
                var ax = leafCx + (Math.random() - 0.5) * leafScale * 2;
                var ay = leafCy + (Math.random() - 0.5) * leafScale * 2.6;
                if (isInsideLeaf(ax, ay)) {
                    auxins.push({ x: ax, y: ay });
                }
                attempts++;
            }
        }

        function growStep() {
            var influenceDist = parseFloat(influenceSlider.value);
            var killDist = parseFloat(killSlider.value);
            var segLen = 5;

            // For each vein node, collect influencing auxin directions
            var influences = {};
            for (var i = 0; i < auxins.length; i++) {
                var a = auxins[i];
                var closestDist = Infinity;
                var closestIdx = -1;

                for (var j = 0; j < veins.length; j++) {
                    var v = veins[j];
                    var dx = a.x - v.x;
                    var dy = a.y - v.y;
                    var d = Math.sqrt(dx * dx + dy * dy);
                    if (d < influenceDist && d < closestDist) {
                        closestDist = d;
                        closestIdx = j;
                    }
                }

                if (closestIdx >= 0) {
                    if (!influences[closestIdx]) {
                        influences[closestIdx] = { dx: 0, dy: 0, count: 0 };
                    }
                    var v = veins[closestIdx];
                    var dx = a.x - v.x;
                    var dy = a.y - v.y;
                    var d = Math.sqrt(dx * dx + dy * dy);
                    influences[closestIdx].dx += dx / d;
                    influences[closestIdx].dy += dy / d;
                    influences[closestIdx].count++;
                }
            }

            // Grow new vein nodes
            var newNodes = [];
            var keys = Object.keys(influences);
            for (var k = 0; k < keys.length; k++) {
                var idx = parseInt(keys[k]);
                var inf = influences[idx];
                var dx = inf.dx / inf.count;
                var dy = inf.dy / inf.count;
                var d = Math.sqrt(dx * dx + dy * dy);
                if (d > 0) {
                    var nx = veins[idx].x + (dx / d) * segLen;
                    var ny = veins[idx].y + (dy / d) * segLen;
                    if (isInsideLeaf(nx, ny)) {
                        newNodes.push({
                            x: nx, y: ny,
                            parent: idx,
                            depth: veins[idx].depth + 1
                        });
                    }
                }
            }

            for (var i = 0; i < newNodes.length; i++) {
                veins.push(newNodes[i]);
            }

            // Remove auxin sources near vein nodes
            var remaining = [];
            for (var i = 0; i < auxins.length; i++) {
                var a = auxins[i];
                var tooClose = false;
                for (var j = 0; j < veins.length; j++) {
                    var dx = a.x - veins[j].x;
                    var dy = a.y - veins[j].y;
                    if (dx * dx + dy * dy < killDist * killDist) {
                        tooClose = true;
                        break;
                    }
                }
                if (!tooClose) remaining.push(a);
            }
            auxins = remaining;

            if (newNodes.length === 0) growing = false;
        }

        function getVeinThickness(node) {
            // Thicker near root
            var maxD = 0;
            for (var i = 0; i < veins.length; i++) {
                if (veins[i].depth > maxD) maxD = veins[i].depth;
            }
            if (maxD === 0) return 3;
            var t = node.depth / maxD;
            return Math.max(0.5, 3.5 * (1 - t * 0.85));
        }

        function drawBackground() {
            ctx.fillStyle = '#0a0e1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Subtle radial glow behind leaf
            var grad = ctx.createRadialGradient(leafCx, leafCy, 0, leafCx, leafCy, leafScale * 1.5);
            grad.addColorStop(0, 'rgba(30,60,25,0.15)');
            grad.addColorStop(1, 'rgba(10,14,26,0)');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        function draw() {
            var speed = parseInt(speedSlider.value);

            if (growing) {
                for (var s = 0; s < speed; s++) {
                    growStep();
                    if (!growing) break;
                }
            }

            drawBackground();
            drawLeafOutline();

            // Draw veins
            for (var i = 1; i < veins.length; i++) {
                var v = veins[i];
                var p = veins[v.parent];
                if (!p) continue;

                var thick = getVeinThickness(v);
                var t = veins.length > 1 ? v.depth / veins[veins.length - 1].depth : 0;
                var r = Math.round(40 + 50 * t);
                var g = Math.round(90 + 70 * (1 - t));
                var b = Math.round(30 + 20 * t);

                ctx.beginPath();
                ctx.moveTo(p.x, p.y);
                ctx.lineTo(v.x, v.y);
                ctx.strokeStyle = 'rgb(' + r + ',' + g + ',' + b + ')';
                ctx.lineWidth = thick;
                ctx.lineCap = 'round';
                ctx.stroke();
            }

            // Draw auxin sources as tiny dots
            ctx.fillStyle = 'rgba(180,220,100,0.25)';
            for (var i = 0; i < auxins.length; i++) {
                ctx.beginPath();
                ctx.arc(auxins[i].x, auxins[i].y, 1.5, 0, Math.PI * 2);
                ctx.fill();
            }

            nodesVal.textContent = veins.length;
            remainVal.textContent = auxins.length;

            animId = requestAnimationFrame(draw);
        }

        function reset() {
            initLeaf();
        }

        window.reset = reset;
        document.getElementById('resetBtn').addEventListener('click', reset);

        auxinSlider.addEventListener('input', function() { auxinVal.textContent = this.value; });
        influenceSlider.addEventListener('input', function() { influenceVal.textContent = this.value; });
        killSlider.addEventListener('input', function() { killVal.textContent = this.value; });
        speedSlider.addEventListener('input', function() { speedVal.textContent = this.value; });

        resize();
        window.addEventListener('resize', function() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            initLeaf();
        });

        draw();
    })();
    </script>
    <script src="../assets/js/enhance.js"></script>
</body>
</html>