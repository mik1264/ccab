<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pandemic Waves & Variants</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
canvas { display: block; }
#title-overlay { position: fixed; top: 18px; left: 50%; transform: translateX(-50%); color: #fbbf24; font-size: 22px; font-weight: 700; text-shadow: 0 2px 10px rgba(0,0,0,0.7); z-index: 10; pointer-events: none; }
#legend { position: fixed; top: 60px; right: 20px; background: rgba(0,0,0,0.85); padding: 14px 18px; border-radius: 10px; color: #e0e0e0; font-size: 13px; z-index: 10; border: 1px solid rgba(251,191,36,0.2); }
.legend-item { display: flex; align-items: center; gap: 8px; margin: 5px 0; }
.legend-dot { width: 12px; height: 12px; border-radius: 50%; }
#controls { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); padding: 16px 24px; border-radius: 14px; color: #e0e0e0; z-index: 10; display: flex; gap: 20px; align-items: center; border: 1px solid rgba(251,191,36,0.3); font-size: 13px; }
#controls button { padding: 8px 18px; background: #fbbf24; color: #0a0e1a; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 13px; }
#controls button:hover { background: #f59e0b; }
#controls input[type=range] { width: 110px; accent-color: #fbbf24; }
#controls .val { color: #fbbf24; font-weight: 700; }
#stats { position: fixed; top: 60px; left: 20px; background: rgba(0,0,0,0.85); padding: 14px 18px; border-radius: 10px; color: #e0e0e0; font-size: 13px; z-index: 10; border: 1px solid rgba(251,191,36,0.2); }
#wave-info { position: fixed; top: 200px; left: 20px; background: rgba(0,0,0,0.85); padding: 14px 18px; border-radius: 10px; color: #e0e0e0; font-size: 13px; z-index: 10; border: 1px solid rgba(251,191,36,0.2); max-width: 180px; }
</style>
</head>
<body>
<a href="../index.html" style="position:fixed;top:10px;left:10px;padding:8px 16px;background:rgba(0,0,0,0.7);color:#fbbf24;text-decoration:none;border-radius:6px;font-size:14px;z-index:999;font-family:sans-serif;">&#8592; Back to Gallery</a>
<div id="title-overlay">Pandemic Waves & Variants</div>
<div id="legend">
    <div class="legend-item"><div class="legend-dot" style="background:#4a9eff;"></div> Susceptible</div>
    <div class="legend-item"><div class="legend-dot" style="background:#ff4a4a;"></div> Infected (Original)</div>
    <div class="legend-item"><div class="legend-dot" style="background:#ff6ec7;"></div> Infected (Variant)</div>
    <div class="legend-item"><div class="legend-dot" style="background:#4aff88;"></div> Recovered</div>
    <div class="legend-item"><div class="legend-dot" style="background:#666;"></div> Waned Immunity</div>
</div>
<div id="stats">
    <div>Day: <span id="dayNum" style="color:#fbbf24;">0</span></div>
    <div>Wave: <span id="waveNum" style="color:#fbbf24;">1</span></div>
    <div>Active Cases: <span id="activeCases" style="color:#ff4a4a;">0</span></div>
    <div>Total Recovered: <span id="totalRec" style="color:#4aff88;">0</span></div>
    <div>Peak Cases: <span id="peakCases" style="color:#ff6ec7;">0</span></div>
</div>
<div id="wave-info">Immunity wanes over time. New variants can reinfect recovered individuals with reduced immunity.</div>
<div id="controls">
    <label>Immunity Duration <input type="range" id="immuneDur" min="200" max="1500" value="700"><span class="val" id="immuneVal">700</span></label>
    <label>Variant Interval <input type="range" id="variantInt" min="300" max="2000" value="900"><span class="val" id="variantVal">900</span></label>
    <button id="resetBtn">Reset</button>
</div>
<canvas id="canvas"></canvas>
<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let W, H, simH;

const N = 500;
const RADIUS = 3;
const SPEED = 1.0;
const INFECTION_DIST = 14;
const RECOVERY_TIME = 250;
const BASE_TRANS = 0.12;

const SUSCEPTIBLE = 0, INFECTED_ORIG = 1, INFECTED_VAR = 2, RECOVERED = 3, WANED = 4;
const COLORS = ['#4a9eff', '#ff4a4a', '#ff6ec7', '#4aff88', '#666666'];

let agents = [], history = [], frame = 0, peakCases = 0, currentWave = 1, variantCount = 0;

function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
    simH = H * 0.55;
}

function init() {
    agents = [];
    history = [];
    frame = 0;
    peakCases = 0;
    currentWave = 1;
    variantCount = 0;
    for (let i = 0; i < N; i++) {
        agents.push({
            x: 30 + Math.random() * (W - 60),
            y: 70 + Math.random() * (simH - 40),
            vx: (Math.random() - 0.5) * SPEED * 2,
            vy: (Math.random() - 0.5) * SPEED * 2,
            state: i < 5 ? INFECTED_ORIG : SUSCEPTIBLE,
            infectedTime: 0,
            recoveredTime: 0,
            timesInfected: 0,
            variant: i < 5 ? 0 : -1
        });
    }
}

function update() {
    const immuneDur = parseInt(document.getElementById('immuneDur').value);
    const variantInt = parseInt(document.getElementById('variantInt').value);

    // Introduce new variant periodically
    if (frame > 0 && frame % variantInt === 0) {
        variantCount++;
        // Find a susceptible or waned agent to be patient zero
        let candidates = agents.filter(a => a.state === SUSCEPTIBLE || a.state === WANED || a.state === RECOVERED);
        if (candidates.length > 0) {
            let a = candidates[Math.floor(Math.random() * candidates.length)];
            a.state = INFECTED_VAR;
            a.infectedTime = 0;
            a.variant = variantCount;
            a.timesInfected++;
            currentWave++;
        }
    }

    for (let a of agents) {
        // Movement
        a.x += a.vx;
        a.y += a.vy;
        if (a.x < 20 || a.x > W - 20) a.vx *= -1;
        if (a.y < 60 || a.y > simH + 20) a.vy *= -1;
        a.x = Math.max(20, Math.min(W - 20, a.x));
        a.y = Math.max(60, Math.min(simH + 20, a.y));

        // Random direction changes
        if (Math.random() < 0.02) {
            a.vx += (Math.random() - 0.5) * 0.5;
            a.vy += (Math.random() - 0.5) * 0.5;
            const sp = Math.sqrt(a.vx * a.vx + a.vy * a.vy);
            if (sp > SPEED) { a.vx = (a.vx / sp) * SPEED; a.vy = (a.vy / sp) * SPEED; }
        }

        // Infected -> Recovered
        if (a.state === INFECTED_ORIG || a.state === INFECTED_VAR) {
            a.infectedTime++;
            if (a.infectedTime > RECOVERY_TIME) {
                a.state = RECOVERED;
                a.recoveredTime = 0;
            }
        }

        // Immunity waning
        if (a.state === RECOVERED) {
            a.recoveredTime++;
            if (a.recoveredTime > immuneDur) {
                a.state = WANED;
            }
        }
    }

    // Infection spread
    for (let i = 0; i < agents.length; i++) {
        const ai = agents[i];
        if (ai.state !== INFECTED_ORIG && ai.state !== INFECTED_VAR) continue;
        for (let j = 0; j < agents.length; j++) {
            const aj = agents[j];
            if (aj.state !== SUSCEPTIBLE && aj.state !== WANED) continue;
            const dx = ai.x - aj.x, dy = ai.y - aj.y;
            if (dx * dx + dy * dy < INFECTION_DIST * INFECTION_DIST) {
                let prob = BASE_TRANS;
                if (aj.state === WANED) prob *= 0.7; // Partial immunity
                if (ai.state === INFECTED_VAR) prob *= 1.3; // Variant more transmissible
                if (Math.random() < prob) {
                    aj.state = ai.state;
                    aj.infectedTime = 0;
                    aj.variant = ai.variant;
                    aj.timesInfected++;
                }
            }
        }
    }

    // Track history
    if (frame % 2 === 0) {
        let counts = [0, 0, 0, 0, 0];
        for (let a of agents) counts[a.state]++;
        history.push(counts);
        const active = counts[1] + counts[2];
        if (active > peakCases) peakCases = active;
    }
    frame++;
}

function draw() {
    ctx.fillStyle = '#0a0e1a';
    ctx.fillRect(0, 0, W, H);

    // Simulation border
    ctx.strokeStyle = 'rgba(251,191,36,0.12)';
    ctx.strokeRect(10, 55, W - 20, simH - 25);

    // Draw agents
    for (let a of agents) {
        ctx.beginPath();
        ctx.arc(a.x, a.y, RADIUS, 0, Math.PI * 2);
        ctx.fillStyle = COLORS[a.state];
        if (a.state === INFECTED_ORIG || a.state === INFECTED_VAR) {
            ctx.shadowBlur = 10;
            ctx.shadowColor = COLORS[a.state];
        } else {
            ctx.shadowBlur = 0;
        }
        ctx.fill();
    }
    ctx.shadowBlur = 0;

    // Graph area
    const gx = 40, gy = simH + 40, gw = W - 80, gh = H - simH - 100;
    ctx.fillStyle = 'rgba(0,0,0,0.4)';
    ctx.fillRect(gx - 5, gy - 5, gw + 10, gh + 10);
    ctx.strokeStyle = 'rgba(251,191,36,0.2)';
    ctx.strokeRect(gx - 5, gy - 5, gw + 10, gh + 10);

    ctx.fillStyle = '#aaa';
    ctx.font = '12px sans-serif';
    ctx.fillText('Infection Waves Over Time', gx + gw / 2 - 70, gy - 12);

    if (history.length > 1) {
        const maxPoints = Math.min(history.length, gw);
        const step = Math.max(1, Math.floor(history.length / maxPoints));

        // Draw infection curves (original + variant stacked)
        const drawLine = (stateIdx, color) => {
            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            for (let i = 0; i < history.length; i += step) {
                const x = gx + (i / Math.max(history.length - 1, 1)) * gw;
                const y = gy + gh - (history[i][stateIdx] / N) * gh;
                if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            }
            ctx.stroke();
            // Fill under
            ctx.lineTo(gx + gw, gy + gh);
            ctx.lineTo(gx, gy + gh);
            ctx.closePath();
            ctx.fillStyle = color + '22';
            ctx.fill();
        };

        drawLine(1, '#ff4a4a');
        drawLine(2, '#ff6ec7');
        drawLine(4, '#666666');

        // Variant introduction markers
        const variantInt = parseInt(document.getElementById('variantInt').value);
        for (let v = 1; v <= variantCount; v++) {
            const vFrame = v * variantInt;
            const dataIdx = Math.floor(vFrame / 2);
            if (dataIdx < history.length) {
                const x = gx + (dataIdx / Math.max(history.length - 1, 1)) * gw;
                ctx.strokeStyle = 'rgba(255,110,199,0.5)';
                ctx.lineWidth = 1;
                ctx.setLineDash([4, 4]);
                ctx.beginPath();
                ctx.moveTo(x, gy);
                ctx.lineTo(x, gy + gh);
                ctx.stroke();
                ctx.setLineDash([]);
                ctx.fillStyle = '#ff6ec7';
                ctx.font = '10px sans-serif';
                ctx.fillText('V' + v, x - 5, gy - 3);
            }
        }
    }

    // Update UI stats
    let counts = [0, 0, 0, 0, 0];
    for (let a of agents) counts[a.state]++;
    document.getElementById('dayNum').textContent = Math.floor(frame / 60);
    document.getElementById('waveNum').textContent = currentWave;
    document.getElementById('activeCases').textContent = counts[1] + counts[2];
    document.getElementById('totalRec').textContent = counts[3];
    document.getElementById('peakCases').textContent = peakCases;
}

document.getElementById('immuneDur').oninput = function() { document.getElementById('immuneVal').textContent = this.value; };
document.getElementById('variantInt').oninput = function() { document.getElementById('variantVal').textContent = this.value; };
document.getElementById('resetBtn').onclick = init;
window.addEventListener('resize', () => { resize(); init(); });

function animate() { update(); draw(); requestAnimationFrame(animate); }
resize();
init();
animate();
</script>
</body>
</html>
