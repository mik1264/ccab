<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N-Body Gravity - Educational Demo</title>
    <link rel="stylesheet" href="../assets/css/edu-panel.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #000510;
            color: #fff;
            font-family: 'Segoe UI', system-ui, sans-serif;
            overflow: hidden;
        }
        #canvas {
            display: block;
            cursor: crosshair;
        }
        .controls {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.85);
            padding: 15px;
            border-radius: 10px;
            z-index: 100;
            min-width: 200px;
        }
        .controls h3 {
            margin-bottom: 10px;
            color: #3498db;
        }
        .control-group {
            margin-bottom: 10px;
        }
        .control-group label {
            display: block;
            font-size: 11px;
            margin-bottom: 3px;
            color: #aaa;
        }
        .control-group input[type="range"] {
            width: 100%;
        }
        .control-group select {
            width: 100%;
            padding: 5px;
            background: #333;
            color: #fff;
            border: 1px solid #555;
            border-radius: 4px;
        }
        .buttons {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        .buttons button {
            flex: 1;
            padding: 6px;
            background: #3498db;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }
        .buttons button:hover { background: #2980b9; }
        .stats {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #333;
            font-size: 10px;
            color: #888;
        }
        .back-link {
            position: fixed;
            top: 20px;
            right: 20px;
            color: #3498db;
            text-decoration: none;
            background: rgba(0,0,0,0.8);
            padding: 10px 15px;
            border-radius: 5px;
            z-index: 100;
        }
        .back-link:hover { background: rgba(52,152,219,0.3); }
        .hint {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 12px;
            color: #888;
        }
        /* Edu panel dark theme overrides */
        .edu-panel { background: rgba(0,5,20,0.95); }
        .edu-tab { background: #0a1a2e; color: #aaa; }
        .edu-tab.active { background: #3498db; color: #fff; }
        .edu-tab:hover:not(.active) { background: #1a2a4e; }
        .edu-content { color: #ccc; }
        .edu-content h4 { color: #3498db; }
        .concept-card { background: rgba(52,152,219,0.1); border-color: #3498db; }
        .step-number { background: #3498db; }
        code { background: rgba(52,152,219,0.2); }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <a href="index.html" class="back-link">‚Üê Back</a>

    <div class="controls">
        <h3>N-Body Gravity</h3>

        <div class="control-group">
            <label>Preset System</label>
            <select id="preset">
                <option value="solar">Solar System</option>
                <option value="binary">Binary Star</option>
                <option value="figure8">Figure-8 (3-body)</option>
                <option value="random">Random (10 bodies)</option>
                <option value="cluster">Star Cluster</option>
            </select>
        </div>

        <div class="control-group">
            <label>Time Scale: <span id="timeVal">1</span>x</label>
            <input type="range" id="timeScale" min="0.1" max="5" step="0.1" value="1">
        </div>

        <div class="control-group">
            <label>Gravity: <span id="gVal">1.0</span></label>
            <input type="range" id="gravity" min="0.1" max="5" step="0.1" value="1">
        </div>

        <div class="control-group">
            <label>Trail Length: <span id="trailVal">200</span></label>
            <input type="range" id="trail" min="0" max="500" step="10" value="200">
        </div>

        <div class="control-group">
            <label>
                <input type="checkbox" id="showVectors"> Show velocity vectors
            </label>
        </div>

        <div class="buttons">
            <button onclick="reset()">Reset</button>
            <button id="pauseBtn" onclick="togglePause()">Pause</button>
        </div>

        <div class="stats">
            <div>Bodies: <span id="bodyCount">0</span></div>
            <div>Total Energy: <span id="energy">0</span></div>
            <div>Simulation Time: <span id="simTime">0</span>s</div>
        </div>
    </div>

    <div class="hint">Click to add a new body</div>

    <div id="edu-panel"></div>

    <script src="../assets/js/edu-panel.js"></script>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let width, height;
        let bodies = [];
        let G = 500; // Gravitational constant (scaled for visualization)
        let timeScale = 1;
        let trailLength = 200;
        let showVectors = false;
        let paused = false;
        let simTime = 0;
        let dt = 0.016;

        class Body {
            constructor(x, y, vx, vy, mass, color) {
                this.x = x;
                this.y = y;
                this.vx = vx;
                this.vy = vy;
                this.ax = 0;
                this.ay = 0;
                this.mass = mass;
                this.radius = Math.max(2, Math.pow(mass, 0.333) * 2);
                this.color = color;
                this.trail = [];
            }

            update(dt) {
                // Velocity Verlet integration
                this.x += this.vx * dt + 0.5 * this.ax * dt * dt;
                this.y += this.vy * dt + 0.5 * this.ay * dt * dt;

                // Store old acceleration for Verlet
                const oldAx = this.ax;
                const oldAy = this.ay;

                // Reset acceleration (will be computed by computeForces)
                this.ax = 0;
                this.ay = 0;

                return { oldAx, oldAy };
            }

            finishUpdate(dt, oldAx, oldAy) {
                // Complete Velocity Verlet
                this.vx += 0.5 * (oldAx + this.ax) * dt;
                this.vy += 0.5 * (oldAy + this.ay) * dt;

                // Update trail
                this.trail.push({ x: this.x, y: this.y });
                if (this.trail.length > trailLength) this.trail.shift();
            }

            draw() {
                // Draw trail
                if (this.trail.length > 1) {
                    ctx.strokeStyle = this.color;
                    ctx.lineWidth = 1;
                    ctx.globalAlpha = 0.3;
                    ctx.beginPath();
                    ctx.moveTo(this.trail[0].x, this.trail[0].y);
                    for (let i = 1; i < this.trail.length; i++) {
                        ctx.lineTo(this.trail[i].x, this.trail[i].y);
                    }
                    ctx.stroke();
                    ctx.globalAlpha = 1;
                }

                // Draw body
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fill();

                // Glow effect for stars
                if (this.mass > 100) {
                    const gradient = ctx.createRadialGradient(
                        this.x, this.y, 0,
                        this.x, this.y, this.radius * 3
                    );
                    gradient.addColorStop(0, this.color);
                    gradient.addColorStop(1, 'transparent');
                    ctx.fillStyle = gradient;
                    ctx.globalAlpha = 0.3;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius * 3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.globalAlpha = 1;
                }

                // Velocity vector
                if (showVectors) {
                    const scale = 5;
                    ctx.strokeStyle = '#2ecc71';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(this.x, this.y);
                    ctx.lineTo(this.x + this.vx * scale, this.y + this.vy * scale);
                    ctx.stroke();
                }
            }
        }

        function computeForces() {
            for (let i = 0; i < bodies.length; i++) {
                for (let j = i + 1; j < bodies.length; j++) {
                    const dx = bodies[j].x - bodies[i].x;
                    const dy = bodies[j].y - bodies[i].y;
                    const distSq = dx * dx + dy * dy;
                    const dist = Math.sqrt(distSq);

                    // Softening to prevent singularities
                    const softening = 10;
                    const force = G * bodies[i].mass * bodies[j].mass / (distSq + softening * softening);

                    const fx = force * dx / dist;
                    const fy = force * dy / dist;

                    bodies[i].ax += fx / bodies[i].mass;
                    bodies[i].ay += fy / bodies[i].mass;
                    bodies[j].ax -= fx / bodies[j].mass;
                    bodies[j].ay -= fy / bodies[j].mass;
                }
            }
        }

        function computeEnergy() {
            let ke = 0, pe = 0;

            for (let i = 0; i < bodies.length; i++) {
                const v2 = bodies[i].vx * bodies[i].vx + bodies[i].vy * bodies[i].vy;
                ke += 0.5 * bodies[i].mass * v2;

                for (let j = i + 1; j < bodies.length; j++) {
                    const dx = bodies[j].x - bodies[i].x;
                    const dy = bodies[j].y - bodies[i].y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    pe -= G * bodies[i].mass * bodies[j].mass / dist;
                }
            }

            return ke + pe;
        }

        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
        }

        function initPreset(name) {
            bodies = [];
            const cx = width / 2;
            const cy = height / 2;

            switch (name) {
                case 'solar':
                    // Sun
                    bodies.push(new Body(cx, cy, 0, 0, 1000, '#ffcc00'));
                    // Planets
                    const planets = [
                        { r: 80, m: 1, color: '#888' },   // Mercury
                        { r: 120, m: 2, color: '#dda' },  // Venus
                        { r: 170, m: 3, color: '#36f' },  // Earth
                        { r: 230, m: 1.5, color: '#c44' },// Mars
                        { r: 320, m: 20, color: '#fa3' }  // Jupiter
                    ];
                    for (const p of planets) {
                        const angle = Math.random() * Math.PI * 2;
                        const v = Math.sqrt(G * 1000 / p.r);
                        bodies.push(new Body(
                            cx + Math.cos(angle) * p.r,
                            cy + Math.sin(angle) * p.r,
                            -Math.sin(angle) * v,
                            Math.cos(angle) * v,
                            p.m, p.color
                        ));
                    }
                    break;

                case 'binary':
                    const sep = 100;
                    const vBinary = Math.sqrt(G * 500 / sep);
                    bodies.push(new Body(cx - sep, cy, 0, vBinary * 0.5, 500, '#ffaa00'));
                    bodies.push(new Body(cx + sep, cy, 0, -vBinary * 0.5, 500, '#ff6600'));
                    // Orbiting planet
                    const orbitR = 250;
                    const vPlanet = Math.sqrt(G * 1000 / orbitR);
                    bodies.push(new Body(cx + orbitR, cy, 0, vPlanet, 5, '#88f'));
                    break;

                case 'figure8':
                    // Famous figure-8 three-body solution
                    const scale = 150;
                    const v = 0.3;
                    bodies.push(new Body(cx - scale * 0.97, cy, v * 0.466 * 10, v * 0.432 * 10, 100, '#e74c3c'));
                    bodies.push(new Body(cx + scale * 0.97, cy, v * 0.466 * 10, v * 0.432 * 10, 100, '#2ecc71'));
                    bodies.push(new Body(cx, cy, -v * 0.932 * 10, -v * 0.864 * 10, 100, '#3498db'));
                    break;

                case 'random':
                    for (let i = 0; i < 10; i++) {
                        const angle = Math.random() * Math.PI * 2;
                        const r = 50 + Math.random() * 200;
                        bodies.push(new Body(
                            cx + Math.cos(angle) * r,
                            cy + Math.sin(angle) * r,
                            (Math.random() - 0.5) * 4,
                            (Math.random() - 0.5) * 4,
                            10 + Math.random() * 90,
                            `hsl(${Math.random() * 360}, 70%, 60%)`
                        ));
                    }
                    break;

                case 'cluster':
                    for (let i = 0; i < 20; i++) {
                        const angle = Math.random() * Math.PI * 2;
                        const r = Math.random() * 150;
                        const v = Math.sqrt(G * 500 / (r + 50)) * (0.3 + Math.random() * 0.4);
                        bodies.push(new Body(
                            cx + Math.cos(angle) * r,
                            cy + Math.sin(angle) * r,
                            -Math.sin(angle) * v + (Math.random() - 0.5) * 2,
                            Math.cos(angle) * v + (Math.random() - 0.5) * 2,
                            5 + Math.random() * 20,
                            `hsl(${200 + Math.random() * 60}, 70%, 70%)`
                        ));
                    }
                    break;
            }

            simTime = 0;
        }

        function reset() {
            initPreset(document.getElementById('preset').value);
        }

        function togglePause() {
            paused = !paused;
            document.getElementById('pauseBtn').textContent = paused ? 'Play' : 'Pause';
        }

        function animate() {
            ctx.fillStyle = 'rgba(0, 5, 16, 0.2)';
            ctx.fillRect(0, 0, width, height);

            if (!paused) {
                const steps = Math.ceil(timeScale * 2);
                const stepDt = dt * timeScale / steps;

                for (let s = 0; s < steps; s++) {
                    // Velocity Verlet step 1: update positions
                    const oldAccs = bodies.map(b => b.update(stepDt));

                    // Compute new forces/accelerations
                    computeForces();

                    // Velocity Verlet step 2: update velocities
                    bodies.forEach((b, i) => b.finishUpdate(stepDt, oldAccs[i].oldAx, oldAccs[i].oldAy));
                }

                simTime += dt * timeScale;
            }

            // Draw bodies
            for (const body of bodies) {
                body.draw();
            }

            // Update stats
            document.getElementById('bodyCount').textContent = bodies.length;
            document.getElementById('energy').textContent = computeEnergy().toFixed(0);
            document.getElementById('simTime').textContent = simTime.toFixed(1);

            requestAnimationFrame(animate);
        }

        // Event handlers
        canvas.addEventListener('click', (e) => {
            bodies.push(new Body(
                e.clientX, e.clientY,
                (Math.random() - 0.5) * 4,
                (Math.random() - 0.5) * 4,
                20 + Math.random() * 30,
                `hsl(${Math.random() * 360}, 70%, 60%)`
            ));
        });

        document.getElementById('preset').addEventListener('change', (e) => {
            initPreset(e.target.value);
        });

        document.getElementById('timeScale').addEventListener('input', (e) => {
            timeScale = parseFloat(e.target.value);
            document.getElementById('timeVal').textContent = timeScale.toFixed(1);
        });

        document.getElementById('gravity').addEventListener('input', (e) => {
            G = parseFloat(e.target.value) * 500;
            document.getElementById('gVal').textContent = e.target.value;
        });

        document.getElementById('trail').addEventListener('input', (e) => {
            trailLength = parseInt(e.target.value);
            document.getElementById('trailVal').textContent = trailLength;
        });

        document.getElementById('showVectors').addEventListener('change', (e) => {
            showVectors = e.target.checked;
        });

        window.addEventListener('resize', resize);

        // Initialize
        resize();
        initPreset('solar');
        animate();

        // Educational Panel
        new EduPanel('#edu-panel', {
            title: 'N-Body Gravity',
            startOpen: false,
            tabs: [
                {
                    id: 'theory',
                    label: 'Theory',
                    content: `
                        <h4>What is the N-Body Problem?</h4>
                        <p>The N-body problem asks: given N masses and their initial positions and velocities, predict their motion under mutual gravitational attraction.</p>

                        <div class="concept-card">
                            <h5>Newton's Law of Gravitation</h5>
                            <code>F = G¬∑m‚ÇÅ¬∑m‚ÇÇ / r¬≤</code>
                            <p>Force is proportional to masses and inversely proportional to distance squared.</p>
                        </div>

                        <div class="concept-card">
                            <h5>Newton's Second Law</h5>
                            <code>F = m¬∑a</code>
                            <p>Force equals mass times acceleration. Combined with gravity, we get equations of motion.</p>
                        </div>

                        <div class="concept-card">
                            <h5>No General Solution</h5>
                            <p>For N ‚â• 3, there's no closed-form solution! The system can be chaotic. We must simulate numerically.</p>
                        </div>

                        <h4>Conservation Laws</h4>

                        <div class="concept-card">
                            <h5>Energy Conservation</h5>
                            <code>E = KE + PE = constant</code>
                            <p>Kinetic (¬Ωmv¬≤) + Potential (-Gm‚ÇÅm‚ÇÇ/r) stays constant. Watch the "Total Energy" stat - good integrators keep it stable.</p>
                        </div>

                        <div class="concept-card">
                            <h5>Momentum Conservation</h5>
                            <p>Total momentum is conserved. Center of mass moves at constant velocity (or stays fixed if initially zero).</p>
                        </div>

                        <div class="concept-card">
                            <h5>Angular Momentum</h5>
                            <p>Total angular momentum about center of mass is conserved. This is why orbits stay in planes.</p>
                        </div>
                    `
                },
                {
                    id: 'algorithm',
                    label: 'Algorithm',
                    content: `
                        <h4>Velocity Verlet Integration</h4>
                        <p>A symplectic integrator that conserves energy better than Euler.</p>

                        <div class="steps">
                            <div class="step">
                                <span class="step-number">1</span>
                                <div>
                                    <strong>Update Positions</strong>
                                    <p>x += v¬∑dt + ¬Ω¬∑a¬∑dt¬≤</p>
                                </div>
                            </div>
                            <div class="step">
                                <span class="step-number">2</span>
                                <div>
                                    <strong>Compute New Forces</strong>
                                    <p>Calculate gravitational acceleration from new positions</p>
                                </div>
                            </div>
                            <div class="step">
                                <span class="step-number">3</span>
                                <div>
                                    <strong>Update Velocities</strong>
                                    <p>v += ¬Ω¬∑(a_old + a_new)¬∑dt</p>
                                </div>
                            </div>
                        </div>

                        <h4>Force Calculation</h4>
                        <pre><code>for each pair (i, j):
    dx = x[j] - x[i]
    dy = y[j] - y[i]
    r¬≤ = dx¬≤ + dy¬≤ + Œµ¬≤  // Œµ = softening
    r = sqrt(r¬≤)

    F = G¬∑m[i]¬∑m[j] / r¬≤

    a[i] += F¬∑(dx,dy) / (m[i]¬∑r)
    a[j] -= F¬∑(dx,dy) / (m[j]¬∑r)</code></pre>

                        <div class="concept-card">
                            <h5>Softening</h5>
                            <p>Adding Œµ¬≤ to r¬≤ prevents infinite forces at r=0. Essential for numerical stability when bodies get close.</p>
                        </div>

                        <div class="concept-card">
                            <h5>Complexity</h5>
                            <p>Naive: O(N¬≤) per timestep. Barnes-Hut tree: O(N log N). Fast Multipole: O(N). For large N (galaxies), optimization is crucial.</p>
                        </div>
                    `
                },
                {
                    id: 'applications',
                    label: 'Applications',
                    content: `
                        <h4>Real-World Applications</h4>

                        <div class="application">
                            <h5>üöÄ Space Missions</h5>
                            <p>Trajectory planning, gravity assists, orbital mechanics. Every spacecraft trajectory is an N-body problem!</p>
                        </div>

                        <div class="application">
                            <h5>üåå Galaxy Simulations</h5>
                            <p>Simulating billions of stars to understand galaxy formation, collisions, and dark matter distribution.</p>
                        </div>

                        <div class="application">
                            <h5>‚òÑÔ∏è Asteroid Tracking</h5>
                            <p>Predicting near-Earth object trajectories, assessing impact risks, planning deflection missions.</p>
                        </div>

                        <div class="application">
                            <h5>ü™ê Exoplanet Stability</h5>
                            <p>Determining if discovered planetary systems are dynamically stable over billions of years.</p>
                        </div>

                        <div class="application">
                            <h5>üî¨ Molecular Dynamics</h5>
                            <p>Same math applies to atoms in materials and proteins. Used in drug discovery and materials science.</p>
                        </div>

                        <div class="concept-card">
                            <h5>Famous Problems</h5>
                            <ul>
                                <li><strong>3-body problem</strong>: No general solution (Poincar√©, 1887)</li>
                                <li><strong>Figure-8 orbit</strong>: Beautiful 3-body solution discovered 1993</li>
                                <li><strong>Lagrange points</strong>: Stable positions in 3-body systems</li>
                            </ul>
                        </div>
                    `
                },
                {
                    id: 'explore',
                    label: 'Explore',
                    content: `
                        <h4>Interactive Experiments</h4>

                        <div class="tutorial">
                            <h5>1. Solar System</h5>
                            <p>Select "Solar System". Watch planets orbit the sun. Notice:</p>
                            <ul>
                                <li>Inner planets orbit faster (Kepler's 3rd law)</li>
                                <li>Orbits are stable ellipses</li>
                                <li>Energy stays nearly constant</li>
                            </ul>
                        </div>

                        <div class="tutorial">
                            <h5>2. Figure-8 Orbit</h5>
                            <p>Select "Figure-8". This remarkable solution has three equal masses tracing a figure-8 path. Discovered in 1993!</p>
                            <p><strong>Note:</strong> It's unstable - small perturbations grow</p>
                        </div>

                        <div class="tutorial">
                            <h5>3. Binary Star</h5>
                            <p>Two stars orbit their common center of mass. A planet orbits both. This is like the Tatooine system!</p>
                        </div>

                        <div class="tutorial">
                            <h5>4. Add Bodies</h5>
                            <p>Click anywhere to add a random body. Watch how it perturbs the system. Even one addition can cause chaos!</p>
                        </div>

                        <div class="tutorial">
                            <h5>5. Energy Conservation</h5>
                            <p>Watch "Total Energy" in stats. A good simulation keeps this nearly constant. Energy drift indicates numerical error.</p>
                        </div>

                        <div class="concept-card">
                            <h5>Challenge</h5>
                            <p>Can you create:</p>
                            <ul>
                                <li>A stable binary star with two planets?</li>
                                <li>A system where bodies escape to infinity?</li>
                                <li>A collision between two bodies?</li>
                            </ul>
                        </div>
                    `
                },
                {
                    id: 'references',
                    label: 'References',
                    content: `
                        <h4>Learn More</h4>

                        <div class="reference-list">
                            <a href="https://en.wikipedia.org/wiki/N-body_problem" target="_blank">Wikipedia: N-body Problem</a>
                            <a href="https://www.youtube.com/watch?v=D89ngRr4uZg" target="_blank">3Blue1Brown: Orbits</a>
                            <a href="https://solarsystem.nasa.gov/basics/chapter4-1/" target="_blank">NASA: Orbital Mechanics</a>
                            <a href="https://ssd.jpl.nasa.gov/horizons/" target="_blank">JPL Horizons: Real Ephemeris Data</a>
                        </div>

                        <h4>Key Figures</h4>
                        <ul>
                            <li><strong>Kepler</strong> (1609) - Laws of planetary motion</li>
                            <li><strong>Newton</strong> (1687) - Universal gravitation</li>
                            <li><strong>Lagrange</strong> (1772) - Stability points, special solutions</li>
                            <li><strong>Poincar√©</strong> (1890) - Proved no general solution exists</li>
                        </ul>

                        <h4>Related Topics</h4>
                        <ul>
                            <li>Celestial Mechanics</li>
                            <li>Orbital Dynamics</li>
                            <li>Chaos Theory</li>
                            <li>Symplectic Integrators</li>
                            <li>Gravitational Waves</li>
                        </ul>
                    `
                }
            ]
        });
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
