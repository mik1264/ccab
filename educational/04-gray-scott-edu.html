<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gray-Scott Reaction-Diffusion - Educational Demo</title>
    <link rel="stylesheet" href="../assets/css/edu-panel.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #1a1a2e;
            color: #fff;
            font-family: 'Segoe UI', system-ui, sans-serif;
            overflow: hidden;
        }
        #canvas {
            display: block;
            cursor: crosshair;
        }
        .controls {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.85);
            padding: 15px;
            border-radius: 10px;
            z-index: 100;
            min-width: 220px;
        }
        .controls h3 {
            margin-bottom: 10px;
            color: #e74c3c;
        }
        .control-group {
            margin-bottom: 10px;
        }
        .control-group label {
            display: block;
            font-size: 11px;
            margin-bottom: 3px;
            color: #aaa;
        }
        .control-group input[type="range"] {
            width: 100%;
        }
        .presets {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #333;
        }
        .presets label {
            display: block;
            font-size: 11px;
            color: #aaa;
            margin-bottom: 5px;
        }
        .presets select {
            width: 100%;
            padding: 5px;
            background: #333;
            color: #fff;
            border: 1px solid #555;
            border-radius: 4px;
        }
        .buttons {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        .buttons button {
            flex: 1;
            padding: 6px;
            background: #e74c3c;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }
        .buttons button:hover { background: #c0392b; }
        .back-link {
            position: fixed;
            top: 20px;
            right: 20px;
            color: #e74c3c;
            text-decoration: none;
            background: rgba(0,0,0,0.8);
            padding: 10px 15px;
            border-radius: 5px;
            z-index: 100;
        }
        .back-link:hover { background: rgba(231,76,60,0.3); }
        .hint {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 12px;
            color: #888;
        }
        /* Edu panel dark theme overrides */
        .edu-panel { background: rgba(20,20,30,0.95); }
        .edu-tab { background: #1a1a2e; color: #aaa; }
        .edu-tab.active { background: #e74c3c; color: #fff; }
        .edu-tab:hover:not(.active) { background: #2a2a4e; }
        .edu-content { color: #ccc; }
        .edu-content h4 { color: #e74c3c; }
        .concept-card { background: rgba(231,76,60,0.1); border-color: #e74c3c; }
        .step-number { background: #e74c3c; }
        code { background: rgba(231,76,60,0.2); }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <a href="index.html" class="back-link">‚Üê Back</a>

    <div class="controls">
        <h3>Gray-Scott Model</h3>

        <div class="control-group">
            <label>Feed Rate (F): <span id="fVal">0.055</span></label>
            <input type="range" id="feedRate" min="0.01" max="0.1" step="0.001" value="0.055">
        </div>

        <div class="control-group">
            <label>Kill Rate (k): <span id="kVal">0.062</span></label>
            <input type="range" id="killRate" min="0.04" max="0.07" step="0.001" value="0.062">
        </div>

        <div class="control-group">
            <label>Diffusion A (D_A): <span id="daVal">1.0</span></label>
            <input type="range" id="diffA" min="0.1" max="2" step="0.1" value="1.0">
        </div>

        <div class="control-group">
            <label>Diffusion B (D_B): <span id="dbVal">0.5</span></label>
            <input type="range" id="diffB" min="0.1" max="1" step="0.05" value="0.5">
        </div>

        <div class="presets">
            <label>Preset Patterns</label>
            <select id="preset">
                <option value="mitosis">Mitosis (Cell Division)</option>
                <option value="coral">Coral Growth</option>
                <option value="spots">Spots</option>
                <option value="stripes">Stripes/Worms</option>
                <option value="spirals">Spirals</option>
                <option value="solitons">Solitons</option>
                <option value="maze">Maze</option>
                <option value="chaos">Chaos</option>
            </select>
        </div>

        <div class="buttons">
            <button onclick="resetGrid()">Reset</button>
            <button onclick="seedCenter()">Seed</button>
        </div>
    </div>

    <div class="hint">Click and drag to add chemical B</div>

    <div id="edu-panel"></div>

    <script src="../assets/js/edu-panel.js"></script>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        const SCALE = 2;
        let width, height;
        let gridWidth, gridHeight;

        // Chemical concentrations (double buffered)
        let gridA, gridB;
        let nextA, nextB;

        // Parameters
        let params = {
            F: 0.055,    // Feed rate
            k: 0.062,    // Kill rate
            dA: 1.0,     // Diffusion rate A
            dB: 0.5,     // Diffusion rate B
            dt: 1.0      // Time step
        };

        // Presets for different patterns
        const presets = {
            mitosis: { F: 0.0367, k: 0.0649 },
            coral: { F: 0.0545, k: 0.062 },
            spots: { F: 0.030, k: 0.062 },
            stripes: { F: 0.040, k: 0.060 },
            spirals: { F: 0.014, k: 0.045 },
            solitons: { F: 0.030, k: 0.057 },
            maze: { F: 0.029, k: 0.057 },
            chaos: { F: 0.026, k: 0.051 }
        };

        function init() {
            width = Math.floor(window.innerWidth / SCALE);
            height = Math.floor(window.innerHeight / SCALE);
            gridWidth = width;
            gridHeight = height;

            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            ctx.imageSmoothingEnabled = false;

            resetGrid();
        }

        function resetGrid() {
            const size = gridWidth * gridHeight;
            gridA = new Float32Array(size).fill(1);
            gridB = new Float32Array(size).fill(0);
            nextA = new Float32Array(size);
            nextB = new Float32Array(size);

            seedCenter();
        }

        function seedCenter() {
            const cx = Math.floor(gridWidth / 2);
            const cy = Math.floor(gridHeight / 2);
            const radius = 10;

            for (let dy = -radius; dy <= radius; dy++) {
                for (let dx = -radius; dx <= radius; dx++) {
                    if (dx*dx + dy*dy <= radius*radius) {
                        const x = cx + dx;
                        const y = cy + dy;
                        if (x >= 0 && x < gridWidth && y >= 0 && y < gridHeight) {
                            const idx = y * gridWidth + x;
                            gridB[idx] = 1;
                        }
                    }
                }
            }
        }

        function addChemicalB(px, py) {
            const x = Math.floor(px / SCALE);
            const y = Math.floor(py / SCALE);
            const radius = 5;

            for (let dy = -radius; dy <= radius; dy++) {
                for (let dx = -radius; dx <= radius; dx++) {
                    const nx = x + dx;
                    const ny = y + dy;
                    if (nx >= 0 && nx < gridWidth && ny >= 0 && ny < gridHeight) {
                        if (dx*dx + dy*dy <= radius*radius) {
                            const idx = ny * gridWidth + nx;
                            gridB[idx] = 1;
                        }
                    }
                }
            }
        }

        function laplacian(grid, x, y) {
            // 5-point stencil Laplacian
            const idx = y * gridWidth + x;
            const left = x > 0 ? grid[idx - 1] : grid[idx];
            const right = x < gridWidth - 1 ? grid[idx + 1] : grid[idx];
            const up = y > 0 ? grid[idx - gridWidth] : grid[idx];
            const down = y < gridHeight - 1 ? grid[idx + gridWidth] : grid[idx];

            return left + right + up + down - 4 * grid[idx];
        }

        function update() {
            const { F, k, dA, dB, dt } = params;

            for (let y = 0; y < gridHeight; y++) {
                for (let x = 0; x < gridWidth; x++) {
                    const idx = y * gridWidth + x;
                    const a = gridA[idx];
                    const b = gridB[idx];

                    const lapA = laplacian(gridA, x, y);
                    const lapB = laplacian(gridB, x, y);

                    const reaction = a * b * b;

                    // Gray-Scott equations
                    nextA[idx] = a + (dA * lapA - reaction + F * (1 - a)) * dt;
                    nextB[idx] = b + (dB * lapB + reaction - (k + F) * b) * dt;

                    // Clamp values
                    nextA[idx] = Math.max(0, Math.min(1, nextA[idx]));
                    nextB[idx] = Math.max(0, Math.min(1, nextB[idx]));
                }
            }

            // Swap buffers
            [gridA, nextA] = [nextA, gridA];
            [gridB, nextB] = [nextB, gridB];
        }

        function render() {
            const imageData = ctx.createImageData(gridWidth, gridHeight);
            const data = imageData.data;

            for (let i = 0; i < gridWidth * gridHeight; i++) {
                const a = gridA[i];
                const b = gridB[i];

                // Color mapping: B concentration creates patterns
                const c = Math.floor((1 - b) * 255);
                const idx = i * 4;

                // Custom colormap
                data[idx] = Math.floor(255 - b * 200);
                data[idx + 1] = Math.floor(100 + (1 - b) * 100 - a * 50);
                data[idx + 2] = Math.floor(50 + b * 200);
                data[idx + 3] = 255;
            }

            // Scale up
            ctx.save();
            ctx.scale(SCALE, SCALE);
            ctx.putImageData(imageData, 0, 0);
            ctx.restore();
        }

        function animate() {
            // Multiple simulation steps per frame
            for (let i = 0; i < 8; i++) {
                update();
            }
            render();
            requestAnimationFrame(animate);
        }

        // Event handlers
        let isDrawing = false;

        canvas.addEventListener('mousedown', () => { isDrawing = true; });
        canvas.addEventListener('mouseup', () => { isDrawing = false; });
        canvas.addEventListener('mouseleave', () => { isDrawing = false; });

        canvas.addEventListener('mousemove', (e) => {
            if (isDrawing) {
                addChemicalB(e.clientX, e.clientY);
            }
        });

        canvas.addEventListener('click', (e) => {
            addChemicalB(e.clientX, e.clientY);
        });

        // Controls
        document.getElementById('feedRate').addEventListener('input', (e) => {
            params.F = parseFloat(e.target.value);
            document.getElementById('fVal').textContent = params.F.toFixed(3);
        });

        document.getElementById('killRate').addEventListener('input', (e) => {
            params.k = parseFloat(e.target.value);
            document.getElementById('kVal').textContent = params.k.toFixed(3);
        });

        document.getElementById('diffA').addEventListener('input', (e) => {
            params.dA = parseFloat(e.target.value);
            document.getElementById('daVal').textContent = params.dA.toFixed(1);
        });

        document.getElementById('diffB').addEventListener('input', (e) => {
            params.dB = parseFloat(e.target.value);
            document.getElementById('dbVal').textContent = params.dB.toFixed(2);
        });

        document.getElementById('preset').addEventListener('change', (e) => {
            const preset = presets[e.target.value];
            if (preset) {
                params.F = preset.F;
                params.k = preset.k;
                document.getElementById('feedRate').value = params.F;
                document.getElementById('killRate').value = params.k;
                document.getElementById('fVal').textContent = params.F.toFixed(3);
                document.getElementById('kVal').textContent = params.k.toFixed(3);
                resetGrid();
            }
        });

        window.addEventListener('resize', init);

        // Initialize
        init();
        animate();

        // Educational Panel
        new EduPanel('#edu-panel', {
            title: 'Gray-Scott Reaction-Diffusion',
            startOpen: false,
            tabs: [
                {
                    id: 'theory',
                    label: 'Theory',
                    content: `
                        <h4>What is Reaction-Diffusion?</h4>
                        <p>Reaction-diffusion systems model two processes: chemical reactions between substances and diffusion spreading them through space. The Gray-Scott model produces stunning patterns from simple rules.</p>

                        <div class="concept-card">
                            <h5>The Two Chemicals</h5>
                            <ul>
                                <li><strong>Chemical A</strong>: The "food" - constantly replenished</li>
                                <li><strong>Chemical B</strong>: The "catalyst" - consumes A, reproduces</li>
                            </ul>
                            <p>A feeds B, B converts A to more B, but B also decays.</p>
                        </div>

                        <h4>The Equations</h4>

                        <div class="concept-card">
                            <h5>Chemical A</h5>
                            <code>‚àÇA/‚àÇt = D_A‚àá¬≤A - AB¬≤ + F(1-A)</code>
                            <p>Diffusion ‚àí Reaction + Feed</p>
                        </div>

                        <div class="concept-card">
                            <h5>Chemical B</h5>
                            <code>‚àÇB/‚àÇt = D_B‚àá¬≤B + AB¬≤ - (k+F)B</code>
                            <p>Diffusion + Reaction ‚àí Kill/Drain</p>
                        </div>

                        <div class="concept-card">
                            <h5>Key Parameters</h5>
                            <ul>
                                <li><strong>F (Feed)</strong>: Rate A is replenished</li>
                                <li><strong>k (Kill)</strong>: Rate B decays/drains</li>
                                <li><strong>D_A, D_B</strong>: Diffusion rates (D_A > D_B typically)</li>
                            </ul>
                        </div>

                        <div class="concept-card">
                            <h5>Turing Patterns</h5>
                            <p>Alan Turing (1952) showed that diffusion + reaction can create stable patterns. The key insight: different diffusion rates create local activation + long-range inhibition.</p>
                        </div>
                    `
                },
                {
                    id: 'algorithm',
                    label: 'Algorithm',
                    content: `
                        <h4>Simulation Algorithm</h4>

                        <div class="steps">
                            <div class="step">
                                <span class="step-number">1</span>
                                <div>
                                    <strong>Initialize Grid</strong>
                                    <p>A = 1 everywhere, B = 0 except seed region</p>
                                </div>
                            </div>
                            <div class="step">
                                <span class="step-number">2</span>
                                <div>
                                    <strong>Compute Laplacian</strong>
                                    <p>‚àá¬≤u = u_left + u_right + u_up + u_down - 4u</p>
                                </div>
                            </div>
                            <div class="step">
                                <span class="step-number">3</span>
                                <div>
                                    <strong>Apply Equations</strong>
                                    <p>Update A and B using Gray-Scott PDEs</p>
                                </div>
                            </div>
                            <div class="step">
                                <span class="step-number">4</span>
                                <div>
                                    <strong>Clamp Values</strong>
                                    <p>Keep concentrations in [0, 1] range</p>
                                </div>
                            </div>
                            <div class="step">
                                <span class="step-number">5</span>
                                <div>
                                    <strong>Render</strong>
                                    <p>Map B concentration to color</p>
                                </div>
                            </div>
                        </div>

                        <h4>Pseudocode</h4>
                        <pre><code>for each cell (x, y):
    a = A[x, y]
    b = B[x, y]

    # Laplacian (diffusion term)
    lapA = A[x-1,y] + A[x+1,y]
         + A[x,y-1] + A[x,y+1] - 4a
    lapB = B[x-1,y] + B[x+1,y]
         + B[x,y-1] + B[x,y+1] - 4b

    # Reaction term
    reaction = a * b * b

    # Update
    A'[x,y] = a + (D_A*lapA - reaction
                   + F*(1-a)) * dt
    B'[x,y] = b + (D_B*lapB + reaction
                   - (k+F)*b) * dt</code></pre>

                        <div class="concept-card">
                            <h5>Double Buffering</h5>
                            <p>Use two grids: read from old, write to new, then swap. This ensures all cells update based on the same timestep.</p>
                        </div>
                    `
                },
                {
                    id: 'applications',
                    label: 'Applications',
                    content: `
                        <h4>Real-World Applications</h4>

                        <div class="application">
                            <h5>üêÜ Animal Coat Patterns</h5>
                            <p>Leopard spots, zebra stripes, giraffe patches, and fish markings are believed to form through reaction-diffusion during embryo development.</p>
                        </div>

                        <div class="application">
                            <h5>üåø Plant Patterns</h5>
                            <p>Phyllotaxis (leaf arrangement), flower pigmentation patterns, and seed distributions show reaction-diffusion signatures.</p>
                        </div>

                        <div class="application">
                            <h5>üß¨ Morphogenesis</h5>
                            <p>Limb formation, finger separation, and organ patterning in embryos involve reaction-diffusion of morphogens (signaling molecules).</p>
                        </div>

                        <div class="application">
                            <h5>üíä Medical Imaging</h5>
                            <p>Reaction-diffusion equations model drug diffusion in tissue and tumor growth patterns.</p>
                        </div>

                        <div class="application">
                            <h5>üî¨ Chemistry</h5>
                            <p>Belousov-Zhabotinsky reaction creates real chemical waves. Used to study self-organization and non-equilibrium thermodynamics.</p>
                        </div>

                        <div class="concept-card">
                            <h5>Pattern Types</h5>
                            <ul>
                                <li><strong>Spots</strong>: Isolated activator peaks</li>
                                <li><strong>Stripes</strong>: Connected activator regions</li>
                                <li><strong>Spirals</strong>: Rotating wave patterns</li>
                                <li><strong>Chaos</strong>: Unstable, ever-changing</li>
                            </ul>
                        </div>
                    `
                },
                {
                    id: 'explore',
                    label: 'Explore',
                    content: `
                        <h4>Pattern Exploration</h4>

                        <div class="tutorial">
                            <h5>1. Mitosis Pattern</h5>
                            <p>Select "Mitosis" preset. Watch spots grow, divide, and spread like cells dividing - hence the name!</p>
                            <p><strong>Parameters:</strong> F=0.0367, k=0.0649</p>
                        </div>

                        <div class="tutorial">
                            <h5>2. Coral Growth</h5>
                            <p>Select "Coral" preset. Patterns branch and grow outward like coral formations.</p>
                            <p><strong>Try:</strong> Click to add more seeds and watch them merge</p>
                        </div>

                        <div class="tutorial">
                            <h5>3. Spots vs Stripes</h5>
                            <p>Compare "Spots" and "Stripes" presets. The difference is subtle parameter changes!</p>
                            <p><strong>Key insight:</strong> Pattern type depends on parameter ratios</p>
                        </div>

                        <div class="tutorial">
                            <h5>4. Parameter Space</h5>
                            <p>Slowly vary F and k to explore the parameter space. Notice transitions between pattern types.</p>
                            <p><strong>Map:</strong> Low k ‚Üí spots, High k ‚Üí stripes, Very high k ‚Üí extinction</p>
                        </div>

                        <div class="tutorial">
                            <h5>5. Diffusion Ratio</h5>
                            <p>Change D_B while keeping D_A constant. Lower D_B creates sharper patterns.</p>
                            <p><strong>Rule:</strong> D_A > D_B is required for pattern formation</p>
                        </div>

                        <div class="concept-card">
                            <h5>Pattern Phase Diagram</h5>
                            <p>The F-k parameter space contains distinct regions:</p>
                            <ul>
                                <li>F ‚âà 0.03, k ‚âà 0.06 ‚Üí Spots</li>
                                <li>F ‚âà 0.04, k ‚âà 0.06 ‚Üí Stripes</li>
                                <li>F ‚âà 0.05, k ‚âà 0.065 ‚Üí Coral</li>
                                <li>Boundaries ‚Üí Interesting dynamics</li>
                            </ul>
                        </div>
                    `
                },
                {
                    id: 'references',
                    label: 'References',
                    content: `
                        <h4>Learn More</h4>

                        <div class="reference-list">
                            <a href="https://groups.csail.mit.edu/mac/projects/amorphous/GrayScott/" target="_blank">Karl Sims: Gray-Scott Reaction-Diffusion</a>
                            <a href="https://en.wikipedia.org/wiki/Reaction%E2%80%93diffusion_system" target="_blank">Wikipedia: Reaction-Diffusion</a>
                            <a href="https://www.karlsims.com/rd.html" target="_blank">Sims: Interactive RD</a>
                            <a href="https://mrob.com/pub/comp/xmorphia/" target="_blank">Xmorphia: Parameter Space Explorer</a>
                        </div>

                        <h4>Key Papers</h4>
                        <ul>
                            <li>Turing, A.M. (1952) - "The Chemical Basis of Morphogenesis"</li>
                            <li>Gray, P. & Scott, S.K. (1983) - Original Gray-Scott paper</li>
                            <li>Pearson, J.E. (1993) - "Complex Patterns in a Simple System"</li>
                        </ul>

                        <h4>Related Topics</h4>
                        <ul>
                            <li>Partial Differential Equations</li>
                            <li>Pattern Formation</li>
                            <li>Self-Organization</li>
                            <li>Morphogenesis</li>
                            <li>Belousov-Zhabotinsky Reaction</li>
                        </ul>
                    `
                }
            ]
        });
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
