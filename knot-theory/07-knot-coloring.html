<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Knot Coloring - Fox n-Colorability</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #e0e0e0; }
canvas { display: block; cursor: pointer; }
a.back { position: fixed; top: 20px; left: 20px; color: #8af; text-decoration: none; z-index: 100; font-size: 1.2em; }
a.back:hover { color: #adf; }

#panel {
    position: fixed; top: 20px; right: 20px; width: 310px;
    background: rgba(10, 14, 30, 0.85); backdrop-filter: blur(10px);
    border: 1px solid rgba(100, 140, 255, 0.2); border-radius: 16px;
    padding: 20px; z-index: 100; max-height: calc(100vh - 40px); overflow-y: auto;
}
#panel h2 { color: #8af; font-size: 1.2em; margin-bottom: 6px; }
#panel p { font-size: 0.82em; line-height: 1.5; color: #aab; margin-bottom: 10px; }
.knot-btns { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
.knot-btn {
    padding: 8px 14px; border-radius: 8px; border: 1px solid rgba(100,140,255,0.3);
    background: rgba(40,60,120,0.3); color: #cdf; cursor: pointer; font-size: 0.85em; transition: all 0.3s;
}
.knot-btn:hover { background: rgba(60,90,180,0.4); }
.knot-btn.active { background: rgba(80,130,255,0.35); border-color: #8af; }

.color-legend { display: flex; gap: 10px; margin: 10px 0; align-items: center; }
.color-swatch {
    width: 24px; height: 24px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.3);
}
.color-label { font-size: 0.8em; color: #aab; }

#validity {
    padding: 12px; border-radius: 10px; text-align: center; font-weight: 700; font-size: 1em;
    margin: 10px 0; transition: all 0.3s;
}
#validity.valid { background: rgba(80,220,120,0.15); border: 1px solid rgba(80,220,120,0.4); color: #6e6; }
#validity.invalid { background: rgba(220,80,80,0.15); border: 1px solid rgba(220,80,80,0.4); color: #e66; }
#validity.partial { background: rgba(220,180,60,0.15); border: 1px solid rgba(220,180,60,0.4); color: #da6; }

.rule-box {
    padding: 10px; background: rgba(200,160,80,0.08); border-left: 3px solid #da5;
    border-radius: 0 8px 8px 0; font-size: 0.78em; line-height: 1.5; color: #cb8; margin-top: 10px;
}
.info { font-size: 0.78em; color: #88a; margin-top: 8px; line-height: 1.4; }
#score { margin-top: 8px; text-align: center; font-size: 0.85em; color: #8af; }
</style>
</head>
<body>
<a href="index.html" class="back">&larr; Back</a>
<canvas id="canvas"></canvas>

<div id="panel">
    <h2>Knot 3-Coloring</h2>
    <p>Click on arcs to cycle their color. A valid coloring requires: at each crossing, all three arcs are either the SAME color or ALL DIFFERENT.</p>

    <div class="knot-btns">
        <button class="knot-btn active" onclick="selectKnot(0)">Unknot</button>
        <button class="knot-btn" onclick="selectKnot(1)">Trefoil</button>
        <button class="knot-btn" onclick="selectKnot(2)">Figure-8</button>
        <button class="knot-btn" onclick="selectKnot(3)">5&#8321;</button>
    </div>

    <div class="color-legend">
        <div class="color-swatch" style="background:#ff4466"></div><span class="color-label">Red</span>
        <div class="color-swatch" style="background:#44aaff"></div><span class="color-label">Blue</span>
        <div class="color-swatch" style="background:#44ff88"></div><span class="color-label">Green</span>
    </div>

    <div id="validity" class="partial">Click arcs to color them</div>

    <div class="rule-box">
        <strong>Coloring Rule:</strong> At each crossing where arcs a, b, c meet: either a = b = c (all same) or a, b, c all different. A "trivial" coloring uses only one color.
    </div>

    <div class="info">
        3-colorability is a knot INVARIANT: it does not change under Reidemeister moves. If a knot is 3-colorable, it is NOT the unknot!
    </div>
    <div id="score">Completed: 0 / 4</div>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let W, H;

function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
}
resize();
window.addEventListener('resize', resize);

const COLORS = ['#ff4466', '#44aaff', '#44ff88'];
const COLOR_NAMES = ['Red', 'Blue', 'Green'];
const BORDER_COLORS = ['#aa1133', '#1166aa', '#11aa55'];

let currentKnot = 0;
let completed = [false, false, false, false];

// Knot definitions: each knot has arcs and crossings
// Arc: array of control points for a bezier/catmull curve
// Crossing: { over: arcIdx, under: arcIdx, witness: arcIdx } (the three arcs meeting)

function getKnotData(idx) {
    const cx = W * 0.38, cy = H * 0.5;
    const s = Math.min(W, H) * 0.18;

    if (idx === 0) {
        // Unknot - single arc circle
        return {
            name: 'Unknot',
            arcs: [generateCirclePoints(cx, cy, s, 60)],
            crossings: [],
            colors: [0],
            colorable: false,
            info: 'Only 1 arc = only trivial coloring possible.'
        };
    } else if (idx === 1) {
        // Trefoil - 3 arcs, 3 crossings
        const arcs = [];
        const r = s;
        for (let i = 0; i < 3; i++) {
            const a1 = (i * 2 * Math.PI / 3) - Math.PI / 6;
            const a2 = ((i + 1) * 2 * Math.PI / 3) - Math.PI / 6;
            const pts = [];
            const steps = 30;
            for (let j = 0; j <= steps; j++) {
                const t = j / steps;
                const angle = a1 + (a2 - a1) * t;
                const wobble = Math.sin(t * Math.PI) * 0.4;
                const rr = r * (1 + wobble);
                pts.push([cx + Math.cos(angle) * rr, cy + Math.sin(angle) * rr]);
            }
            arcs.push(pts);
        }
        return {
            name: 'Trefoil',
            arcs: arcs,
            crossings: [
                { arcs: [0, 1, 2] },
                { arcs: [1, 2, 0] },
                { arcs: [2, 0, 1] }
            ],
            colors: [0, 0, 0],
            colorable: true,
            solution: [0, 1, 2],
            info: 'The trefoil IS 3-colorable! Use all 3 different colors.'
        };
    } else if (idx === 2) {
        // Figure-eight - 4 arcs, 4 crossings
        const arcs = [];
        const r = s * 0.8;
        for (let i = 0; i < 4; i++) {
            const a1 = (i * Math.PI / 2) + Math.PI / 4;
            const a2 = ((i + 1) * Math.PI / 2) + Math.PI / 4;
            const pts = [];
            const steps = 30;
            for (let j = 0; j <= steps; j++) {
                const t = j / steps;
                const angle = a1 + (a2 - a1) * t;
                // Figure-eight lemniscate-ish shape
                const px = cx + Math.cos(angle) * r * (1 + 0.3 * Math.cos(2 * angle));
                const py = cy + Math.sin(angle) * r * (1 + 0.3 * Math.sin(2 * angle));
                pts.push([px, py]);
            }
            arcs.push(pts);
        }
        return {
            name: 'Figure-Eight',
            arcs: arcs,
            crossings: [
                { arcs: [0, 1, 2] },
                { arcs: [1, 2, 3] },
                { arcs: [2, 3, 0] },
                { arcs: [3, 0, 1] }
            ],
            colors: [0, 0, 0, 0],
            colorable: false,
            info: 'The figure-eight is NOT 3-colorable. No valid non-trivial coloring exists!'
        };
    } else {
        // 5_1 knot - 5 arcs, 5 crossings
        const arcs = [];
        const r = s;
        for (let i = 0; i < 5; i++) {
            const a1 = (i * 2 * Math.PI / 5) - Math.PI / 2;
            const a2 = ((i + 1) * 2 * Math.PI / 5) - Math.PI / 2;
            const pts = [];
            const steps = 30;
            for (let j = 0; j <= steps; j++) {
                const t = j / steps;
                const angle = a1 + (a2 - a1) * t;
                const wobble = Math.sin(t * Math.PI) * 0.35;
                pts.push([cx + Math.cos(angle) * r * (1 + wobble), cy + Math.sin(angle) * r * (1 + wobble)]);
            }
            arcs.push(pts);
        }
        return {
            name: '5\u2081 (Cinquefoil)',
            arcs: arcs,
            crossings: [
                { arcs: [0, 1, 2] },
                { arcs: [1, 2, 3] },
                { arcs: [2, 3, 4] },
                { arcs: [3, 4, 0] },
                { arcs: [4, 0, 1] }
            ],
            colors: [0, 0, 0, 0, 0],
            colorable: true,
            solution: [0, 1, 2, 0, 1],
            info: '5\u2081 IS 3-colorable! It uses all three colors.'
        };
    }
}

function generateCirclePoints(cx, cy, r, n) {
    const pts = [];
    for (let i = 0; i <= n; i++) {
        const a = (i / n) * Math.PI * 2;
        pts.push([cx + Math.cos(a) * r, cy + Math.sin(a) * r]);
    }
    return pts;
}

let knot = null;

function selectKnot(idx) {
    currentKnot = idx;
    knot = getKnotData(idx);
    document.querySelectorAll('.knot-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
    updateValidity();
}

function checkValidity() {
    if (!knot || knot.crossings.length === 0) return { valid: false, trivial: true, msg: 'Single arc - only trivial coloring' };

    // Check if all colors the same (trivial)
    const allSame = knot.colors.every(c => c === knot.colors[0]);

    let allValid = true;
    for (const crossing of knot.crossings) {
        const cs = crossing.arcs.map(i => knot.colors[i]);
        const same = cs[0] === cs[1] && cs[1] === cs[2];
        const allDiff = cs[0] !== cs[1] && cs[1] !== cs[2] && cs[0] !== cs[2];
        if (!same && !allDiff) { allValid = false; break; }
    }

    if (allValid && !allSame) return { valid: true, trivial: false, msg: 'Valid non-trivial 3-coloring! This knot is 3-colorable!' };
    if (allValid && allSame) return { valid: true, trivial: true, msg: 'Valid but trivial (all same color). Try using all 3 colors!' };
    return { valid: false, trivial: false, msg: 'Invalid coloring at some crossings.' };
}

function updateValidity() {
    const result = checkValidity();
    const el = document.getElementById('validity');
    el.className = result.valid && !result.trivial ? 'valid' : result.valid ? 'partial' : 'invalid';
    el.textContent = result.msg;

    if (result.valid && !result.trivial) {
        completed[currentKnot] = true;
    }
    document.getElementById('score').textContent = 'Completed: ' + completed.filter(Boolean).length + ' / 4';
}

// Hit testing for arcs
function pointNearArc(px, py, arc, threshold) {
    for (let i = 0; i < arc.length; i++) {
        const dx = arc[i][0] - px;
        const dy = arc[i][1] - py;
        if (dx * dx + dy * dy < threshold * threshold) return true;
    }
    return false;
}

canvas.addEventListener('click', (e) => {
    if (!knot) return;
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;

    for (let i = 0; i < knot.arcs.length; i++) {
        if (pointNearArc(mx, my, knot.arcs[i], 20)) {
            knot.colors[i] = (knot.colors[i] + 1) % 3;
            updateValidity();
            break;
        }
    }
});

// Draw background grid
function drawGrid() {
    ctx.strokeStyle = 'rgba(60, 80, 140, 0.06)';
    ctx.lineWidth = 1;
    const gs = 50;
    for (let x = 0; x < W; x += gs) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke(); }
    for (let y = 0; y < H; y += gs) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke(); }
}

function drawStrand(points, color, borderColor, lw) {
    if (points.length < 2) return;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.beginPath();
    ctx.moveTo(points[0][0], points[0][1]);
    for (let i = 1; i < points.length; i++) ctx.lineTo(points[i][0], points[i][1]);
    ctx.strokeStyle = borderColor || '#000';
    ctx.lineWidth = (lw || 8) + 4;
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(points[0][0], points[0][1]);
    for (let i = 1; i < points.length; i++) ctx.lineTo(points[i][0], points[i][1]);
    ctx.strokeStyle = color;
    ctx.lineWidth = lw || 8;
    ctx.stroke();
}

let time = 0;

function animate() {
    ctx.clearRect(0, 0, W, H);
    drawGrid();
    time += 0.01;

    if (!knot) { requestAnimationFrame(animate); return; }

    // Draw subtle pulsing glow around the knot
    const cx = W * 0.38, cy = H * 0.5;
    const gr = ctx.createRadialGradient(cx, cy, 0, cx, cy, 300);
    gr.addColorStop(0, `rgba(80,120,255,${0.03 + 0.01 * Math.sin(time * 2)})`);
    gr.addColorStop(1, 'transparent');
    ctx.fillStyle = gr;
    ctx.beginPath();
    ctx.arc(cx, cy, 300, 0, Math.PI * 2);
    ctx.fill();

    // Title
    ctx.font = 'bold 28px "Segoe UI", sans-serif';
    ctx.fillStyle = '#8af';
    ctx.textAlign = 'center';
    ctx.fillText(knot.name, cx, 50);

    ctx.font = '16px "Segoe UI", sans-serif';
    ctx.fillStyle = '#88a';
    ctx.fillText(knot.info, cx, 78);

    // Draw arcs
    for (let i = 0; i < knot.arcs.length; i++) {
        const col = COLORS[knot.colors[i]];
        const border = BORDER_COLORS[knot.colors[i]];
        const arc = knot.arcs[i];

        // Subtle pulse on hover-like effect
        const pulse = 1 + 0.05 * Math.sin(time * 3 + i);
        const lw = 7 * pulse;

        drawStrand(arc, col, border, lw);

        // Draw arc number label at midpoint
        const mid = arc[Math.floor(arc.length / 2)];
        ctx.font = 'bold 14px "Segoe UI", sans-serif';
        ctx.fillStyle = '#fff';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText((i + 1).toString(), mid[0], mid[1] - 16);
    }

    // Draw crossing validity markers
    for (let c = 0; c < knot.crossings.length; c++) {
        const crossing = knot.crossings[c];
        const cs = crossing.arcs.map(i => knot.colors[i]);
        const same = cs[0] === cs[1] && cs[1] === cs[2];
        const allDiff = cs[0] !== cs[1] && cs[1] !== cs[2] && cs[0] !== cs[2];
        const valid = same || allDiff;

        // Find crossing center (average of midpoints of involved arcs)
        let px = 0, py = 0;
        for (const ai of crossing.arcs) {
            const arc = knot.arcs[ai];
            const m = arc[Math.floor(arc.length * 0.3)];
            px += m[0]; py += m[1];
        }
        px /= crossing.arcs.length;
        py /= crossing.arcs.length;

        // Draw check or X
        ctx.font = 'bold 20px "Segoe UI", sans-serif';
        ctx.fillStyle = valid ? '#4f4' : '#f44';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(valid ? '\u2713' : '\u2717', px + 20, py + 20);
    }

    // Instruction at bottom
    ctx.font = '14px "Segoe UI", sans-serif';
    ctx.fillStyle = 'rgba(150,170,200,0.5)';
    ctx.textAlign = 'center';
    ctx.fillText('Click on arcs to cycle their color (Red \u2192 Blue \u2192 Green)', cx, H - 30);

    requestAnimationFrame(animate);
}

window.reset = function() {
    currentKnot = 0;
    completed = [false, false, false, false];
    selectKnot(0);
};

selectKnot(0);
animate();
</script>
<script src="../assets/js/enhance.js"></script>
</body>
</html>
