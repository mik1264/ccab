<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Torus Knots</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; overflow: hidden; font-family: 'Segoe UI', Tahoma, sans-serif; }
canvas { display: block; }

#controls {
    position: fixed; bottom: 20px; right: 20px; z-index: 100;
    background: rgba(10, 14, 30, 0.8); backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(138, 170, 255, 0.2); border-radius: 12px;
    padding: 18px 22px; color: #c8d8ff; min-width: 260px;
}
#controls h3 { margin-bottom: 12px; color: #8af; font-size: 0.95em; text-transform: uppercase; letter-spacing: 1px; }
.ctrl-row { margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; font-size: 0.85em; }
.ctrl-row label { flex: 1; }
.ctrl-row input[type=range] { width: 100px; accent-color: #8af; }
.ctrl-row .val { color: #ffda6e; font-weight: bold; min-width: 22px; text-align: right; }
.ctrl-row input[type=checkbox] { accent-color: #8af; }
.ctrl-row button {
    background: rgba(138,170,255,0.15); color: #8af; border: 1px solid rgba(138,170,255,0.3);
    border-radius: 6px; padding: 4px 12px; cursor: pointer; font-size: 0.85em;
}
.ctrl-row button:hover { background: rgba(138,170,255,0.3); }

#info {
    position: fixed; top: 70px; right: 20px; z-index: 100;
    background: rgba(10, 14, 30, 0.8); backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(138, 170, 255, 0.2); border-radius: 12px;
    padding: 16px 20px; color: #c8d8ff; max-width: 280px;
}
#info h2 { color: #8af; font-size: 1.05em; margin-bottom: 6px; }
#info p { font-size: 0.82em; line-height: 1.5; opacity: 0.85; margin-bottom: 4px; }
.stat { color: #ffda6e; font-weight: bold; }
.link-warn { color: #ff6e8a; font-weight: bold; }
</style>
</head>
<body>
<a href="index.html" style="position:fixed;top:20px;left:20px;color:#8af;text-decoration:none;z-index:100;font-size:1.2em">&#8592; Back</a>
<canvas id="c"></canvas>

<div id="info">
    <h2>Torus Knots</h2>
    <p>A <span class="stat">(p,q)-torus knot</span> winds <span class="stat">p</span> times around the torus hole and <span class="stat">q</span> times through it.</p>
    <p id="knotLabel">(p,q) = (2,3) - Trefoil knot</p>
    <p>Crossing number: <span class="stat" id="crossNum">3</span></p>
    <p id="linkWarn" style="display:none" class="link-warn">gcd(p,q) &ne; 1 - This is a LINK, not a knot!</p>
</div>

<div id="controls">
    <h3>Torus Knot Parameters</h3>
    <div class="ctrl-row"><label>p (around hole)</label><input type="range" id="pSlider" min="1" max="7" value="2"><span class="val" id="pVal">2</span></div>
    <div class="ctrl-row"><label>q (through hole)</label><input type="range" id="qSlider" min="1" max="7" value="3"><span class="val" id="qVal">3</span></div>
    <div class="ctrl-row"><label>Tube Thickness</label><input type="range" id="tubeW" min="2" max="20" value="8"></div>
    <div class="ctrl-row"><label>Show Torus</label><input type="checkbox" id="showTorus" checked></div>
    <div class="ctrl-row"><label>Show Knot</label><input type="checkbox" id="showKnot" checked></div>
    <div class="ctrl-row"><label>Rotation Speed</label><input type="range" id="rotSpeed" min="0" max="100" value="25"></div>
    <div class="ctrl-row"><button onclick="window.reset()">Reset</button></div>
</div>

<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let W, H;
function resize() { W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; }
resize();
window.addEventListener('resize', resize);

const pSlider = document.getElementById('pSlider');
const qSlider = document.getElementById('qSlider');
const pVal = document.getElementById('pVal');
const qVal = document.getElementById('qVal');
const tubeWSlider = document.getElementById('tubeW');
const showTorusCheck = document.getElementById('showTorus');
const showKnotCheck = document.getElementById('showKnot');
const rotSpeedSlider = document.getElementById('rotSpeed');

let autoRot = 0;
let userRotY = 0, userRotX = 0.35;
let dragging = false, lastMX = 0, lastMY = 0;
const FOV = 600;

function gcd(a, b) { return b === 0 ? a : gcd(b, a % b); }

function updateLabel() {
    const p = parseInt(pSlider.value);
    const q = parseInt(qSlider.value);
    pVal.textContent = p;
    qVal.textContent = q;
    const g = gcd(p, q);
    const linkWarn = document.getElementById('linkWarn');
    const label = document.getElementById('knotLabel');
    const crossNum = document.getElementById('crossNum');

    if (g > 1) {
        linkWarn.style.display = 'block';
        label.textContent = `(${p},${q}) = ${g} component link`;
        crossNum.textContent = '---';
    } else {
        linkWarn.style.display = 'none';
        const cn = Math.min(p, q) * (Math.max(p, q) - 1);
        crossNum.textContent = cn;
        let name = '';
        if (p === 1 || q === 1) name = 'Unknot';
        else if ((p === 2 && q === 3) || (p === 3 && q === 2)) name = 'Trefoil knot';
        else if ((p === 2 && q === 5) || (p === 5 && q === 2)) name = 'Cinquefoil knot';
        else if ((p === 2 && q === 7) || (p === 7 && q === 2)) name = 'Septafoil knot';
        else if ((p === 3 && q === 4) || (p === 4 && q === 3)) name = '(3,4)-torus knot';
        else name = `(${p},${q})-torus knot`;
        label.textContent = `(${p},${q}) = ${name}`;
    }
}

pSlider.addEventListener('input', updateLabel);
qSlider.addEventListener('input', updateLabel);
updateLabel();

canvas.addEventListener('mousedown', e => { dragging = true; lastMX = e.clientX; lastMY = e.clientY; });
canvas.addEventListener('mousemove', e => {
    if (!dragging) return;
    userRotY += (e.clientX - lastMX) * 0.005;
    userRotX += (e.clientY - lastMY) * 0.005;
    userRotX = Math.max(-1.3, Math.min(1.3, userRotX));
    lastMX = e.clientX; lastMY = e.clientY;
});
canvas.addEventListener('mouseup', () => dragging = false);
canvas.addEventListener('mouseleave', () => dragging = false);
canvas.addEventListener('touchstart', e => {
    if (e.target !== canvas) return;
    dragging = true; lastMX = e.touches[0].clientX; lastMY = e.touches[0].clientY;
}, { passive: true });
canvas.addEventListener('touchmove', e => {
    if (!dragging) return;
    userRotY += (e.touches[0].clientX - lastMX) * 0.005;
    userRotX += (e.touches[0].clientY - lastMY) * 0.005;
    userRotX = Math.max(-1.3, Math.min(1.3, userRotX));
    lastMX = e.touches[0].clientX; lastMY = e.touches[0].clientY;
}, { passive: true });
canvas.addEventListener('touchend', () => dragging = false);

function rotY3(x, y, z, a) { return { x: x * Math.cos(a) + z * Math.sin(a), y, z: -x * Math.sin(a) + z * Math.cos(a) }; }
function rotX3(x, y, z, a) { return { x, y: y * Math.cos(a) - z * Math.sin(a), z: y * Math.sin(a) + z * Math.cos(a) }; }
function proj(x, y, z) {
    const s = FOV / (FOV + z);
    return { sx: W / 2 + x * s, sy: H / 2 + y * s, depth: z, scale: s };
}

function torusKnotPoint(t, p, q, R, r) {
    return {
        x: (R + r * Math.cos(q * t)) * Math.cos(p * t),
        y: (R + r * Math.cos(q * t)) * Math.sin(p * t),
        z: r * Math.sin(q * t)
    };
}

function torusPoint(u, v, R, r) {
    return {
        x: (R + r * Math.cos(v)) * Math.cos(u),
        y: (R + r * Math.cos(v)) * Math.sin(u),
        z: r * Math.sin(v)
    };
}

function draw() {
    ctx.fillStyle = '#0a0e1a';
    ctx.fillRect(0, 0, W, H);

    autoRot += parseFloat(rotSpeedSlider.value) / 3000;
    const ry = autoRot + userRotY;
    const rx = userRotX;

    const p = parseInt(pSlider.value);
    const q = parseInt(qSlider.value);
    const g = gcd(p, q);
    const R = 130, r = 55;
    const tubeThick = parseFloat(tubeWSlider.value);

    // Draw torus wireframe
    if (showTorusCheck.checked) {
        const torusSegs = [];
        const NU = 40, NV = 20;
        for (let i = 0; i < NU; i++) {
            for (let j = 0; j < NV; j++) {
                const u0 = (i / NU) * Math.PI * 2;
                const u1 = ((i + 1) / NU) * Math.PI * 2;
                const v0 = (j / NV) * Math.PI * 2;
                const v1 = ((j + 1) / NV) * Math.PI * 2;

                // Horizontal rings
                const pa = torusPoint(u0, v0, R, r);
                const pb = torusPoint(u0, v1, R, r);
                let ra = rotY3(pa.x, pa.y, pa.z, ry); ra = rotX3(ra.x, ra.y, ra.z, rx);
                let rb = rotY3(pb.x, pb.y, pb.z, ry); rb = rotX3(rb.x, rb.y, rb.z, rx);
                const sa = proj(ra.x, ra.y, ra.z);
                const sb = proj(rb.x, rb.y, rb.z);
                torusSegs.push({ s0: sa, s1: sb, avgZ: (ra.z + rb.z) / 2, type: 'torus' });

                // Vertical rings
                const pc = torusPoint(u0, v0, R, r);
                const pd = torusPoint(u1, v0, R, r);
                let rc = rotY3(pc.x, pc.y, pc.z, ry); rc = rotX3(rc.x, rc.y, rc.z, rx);
                let rd = rotY3(pd.x, pd.y, pd.z, ry); rd = rotX3(rd.x, rd.y, rd.z, rx);
                const sc = proj(rc.x, rc.y, rc.z);
                const sd = proj(rd.x, rd.y, rd.z);
                torusSegs.push({ s0: sc, s1: sd, avgZ: (rc.z + rd.z) / 2, type: 'torus' });
            }
        }

        torusSegs.sort((a, b) => b.avgZ - a.avgZ);
        for (const seg of torusSegs) {
            const depthF = 0.02 + 0.06 * ((seg.avgZ + 200) / 400);
            ctx.strokeStyle = `rgba(100, 140, 200, ${depthF})`;
            ctx.lineWidth = 0.5;
            ctx.beginPath();
            ctx.moveTo(seg.s0.sx, seg.s0.sy);
            ctx.lineTo(seg.s1.sx, seg.s1.sy);
            ctx.stroke();
        }
    }

    // Draw knot(s)
    if (showKnotCheck.checked) {
        const numComponents = g;
        const allSegs = [];

        for (let c = 0; c < numComponents; c++) {
            const offset = (c / numComponents) * Math.PI * 2 / p;
            const N = 400;
            const hueBase = (c / numComponents) * 360;

            for (let i = 0; i < N; i++) {
                const t0 = offset + (i / N) * Math.PI * 2;
                const t1 = offset + ((i + 1) / N) * Math.PI * 2;
                const pt0 = torusKnotPoint(t0, p, q, R, r);
                const pt1 = torusKnotPoint(t1, p, q, R, r);

                let r0 = rotY3(pt0.x, pt0.y, pt0.z, ry); r0 = rotX3(r0.x, r0.y, r0.z, rx);
                let r1 = rotY3(pt1.x, pt1.y, pt1.z, ry); r1 = rotX3(r1.x, r1.y, r1.z, rx);

                const s0 = proj(r0.x, r0.y, r0.z);
                const s1 = proj(r1.x, r1.y, r1.z);
                const avgZ = (r0.z + r1.z) / 2;

                allSegs.push({ s0, s1, avgZ, norm: i / N, hueBase, component: c });
            }
        }

        allSegs.sort((a, b) => b.avgZ - a.avgZ);

        for (const seg of allSegs) {
            const { s0, s1, avgZ, norm, hueBase } = seg;
            const depthF = 0.45 + 0.55 * ((avgZ + 200) / 400);
            const hue = (hueBase + norm * 120) % 360;
            const color = `hsl(${hue}, 80%, ${depthF * 55}%)`;
            const w = tubeThick * ((s0.scale + s1.scale) / 2);

            // Glow
            ctx.save();
            ctx.shadowBlur = 12;
            ctx.shadowColor = color;
            ctx.strokeStyle = color;
            ctx.lineWidth = w + 3;
            ctx.globalAlpha = 0.2;
            ctx.beginPath(); ctx.moveTo(s0.sx, s0.sy); ctx.lineTo(s1.sx, s1.sy); ctx.stroke();
            ctx.restore();

            ctx.strokeStyle = '#050810';
            ctx.lineWidth = w + 3;
            ctx.lineCap = 'round';
            ctx.beginPath(); ctx.moveTo(s0.sx, s0.sy); ctx.lineTo(s1.sx, s1.sy); ctx.stroke();

            ctx.strokeStyle = color;
            ctx.lineWidth = w;
            ctx.lineCap = 'round';
            ctx.beginPath(); ctx.moveTo(s0.sx, s0.sy); ctx.lineTo(s1.sx, s1.sy); ctx.stroke();

            ctx.strokeStyle = 'rgba(255,255,255,0.1)';
            ctx.lineWidth = w * 0.25;
            ctx.beginPath();
            ctx.moveTo(s0.sx - w * 0.1, s0.sy - w * 0.1);
            ctx.lineTo(s1.sx - w * 0.1, s1.sy - w * 0.1);
            ctx.stroke();
        }
    }

    requestAnimationFrame(draw);
}

window.reset = function() {
    autoRot = 0;
    userRotY = 0;
    userRotX = 0.35;
    pSlider.value = 2;
    qSlider.value = 3;
    tubeWSlider.value = 8;
    rotSpeedSlider.value = 25;
    showTorusCheck.checked = true;
    showKnotCheck.checked = true;
    updateLabel();
};

requestAnimationFrame(draw);
</script>
<script src="../assets/js/enhance.js"></script>
</body>
</html>
