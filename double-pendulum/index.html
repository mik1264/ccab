<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Double Pendulum Chaos - CCAB</title>
    <link rel="stylesheet" href="../assets/css/navigation.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Spectral:ital,wght@0,400;0,600;1,400&family=Space+Mono:wght@400;700&display=swap');

        :root {
            /* Color scheme matching main index */
            --bg-primary: #0a0e1a;
            --bg-secondary: #111827;
            --text-primary: #e0e0ff;
            --text-secondary: #a0a0c0;
            --text-accent: #fbbf24;
            --theme-color: #667eea;

            /* Spacing */
            --spacing-xs: 0.5rem;
            --spacing-sm: 1rem;
            --spacing-md: 1.5rem;
            --spacing-lg: 2rem;
            --spacing-xl: 3rem;
            --spacing-2xl: 4rem;

            /* Typography */
            --font-display: 'Orbitron', sans-serif;
            --font-heading: 'Spectral', serif;
            --font-mono: 'Space Mono', monospace;
            --font-body: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;

            /* Layout */
            --max-width: 1600px;
            --header-height: 64px;

            /* Transitions */
            --transition-base: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background: linear-gradient(135deg, var(--bg-primary) 0%, #0f172a 50%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            padding: 20px;
            padding-top: calc(var(--header-height) + 20px);
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        h1 {
            font-family: var(--font-display);
            text-align: center;
            margin-bottom: 10px;
            font-size: clamp(2rem, 5vw, 3rem);
            background: linear-gradient(135deg, var(--theme-color) 0%, var(--text-accent) 50%, var(--theme-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tab {
            padding: 12px 24px;
            background: rgba(224, 224, 255, 0.1);
            border: 2px solid rgba(224, 224, 255, 0.2);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
            color: var(--text-primary);
        }

        .tab:hover {
            background: rgba(224, 224, 255, 0.2);
            transform: translateY(-2px);
        }

        .tab.active {
            background: linear-gradient(135deg, var(--theme-color) 0%, var(--text-accent) 100%);
            border-color: var(--theme-color);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .view {
            display: none;
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .view.active {
            display: block;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            justify-content: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        input[type="range"] {
            width: 150px;
        }

        input[type="number"] {
            width: 80px;
            padding: 8px;
            background: rgba(224, 224, 255, 0.1);
            border: 1px solid rgba(224, 224, 255, 0.2);
            border-radius: 5px;
            color: var(--text-primary);
            font-size: 1em;
        }

        button {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--theme-color) 0%, var(--text-accent) 100%);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        canvas {
            display: block;
            margin: 20px auto;
            background: #000;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-width: 100%;
        }

        .stats-panel {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--theme-color);
            font-family: var(--font-mono);
        }

        .stat-label {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .info-box {
            background: rgba(102, 126, 234, 0.1);
            border-left: 4px solid var(--theme-color);
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .info-box h3 {
            margin-bottom: 10px;
            color: var(--theme-color);
        }

        .info-box ul {
            margin-left: 20px;
            line-height: 1.8;
        }

        .energy-bars {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }

        .energy-bar-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .energy-label {
            width: 100px;
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .energy-bar {
            flex: 1;
            height: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .energy-fill {
            height: 100%;
            transition: width 0.1s linear;
            border-radius: 10px;
        }

        .energy-kinetic { background: linear-gradient(90deg, #f43f5e, #fb923c); }
        .energy-potential { background: linear-gradient(90deg, #3b82f6, #8b5cf6); }
        .energy-total { background: linear-gradient(90deg, #10b981, #14b8a6); }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.8);
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }

            .tabs {
                font-size: 0.9em;
            }

            .tab {
                padding: 8px 16px;
            }

            .control-group label {
                font-size: 0.8em;
            }
        }
    
        /* Organic Nature Back Link */
        .organic-back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 10000;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: #BC6C25;
            text-decoration: none;
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 600;
            padding: 0.5rem 1rem;
            background: rgba(254, 250, 224, 0.95);
            border-radius: 20px;
            border: 2px solid rgba(138, 154, 91, 0.3);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(96, 108, 56, 0.15);
        }
        .organic-back-link:hover {
            background: rgba(254, 250, 224, 1);
            transform: translateX(-5px);
            border-color: #DDA15E;
            box-shadow: 0 6px 20px rgba(96, 108, 56, 0.25);
        }

    </style>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>

    <!-- Navigation Header -->
    <nav class="ccab-nav">
        <div class="nav-container">
            <div class="nav-breadcrumb"></div>
        </div>
    </nav>

    <div class="container">
        <h1>Double Pendulum Chaos</h1>
        <p class="subtitle">Exploring Deterministic Chaos and Sensitivity to Initial Conditions</p>

        <div class="tabs">
            <div class="tab active" data-view="single">Single Pendulum</div>
            <div class="tab" data-view="double">Double Pendulum</div>
            <div class="tab" data-view="sensitivity">Sensitivity Demo</div>
            <div class="tab" data-view="phase">Phase Space</div>
        </div>

        <!-- Single Pendulum View -->
        <div class="view active" id="single">
            <div class="info-box">
                <h3>Simple Harmonic Motion</h3>
                <p>A single pendulum exhibits predictable, periodic motion. The equation of motion for small angles is:</p>
                <p style="text-align: center; margin: 10px 0; font-family: var(--font-mono);">d²θ/dt² + (g/L)sin(θ) = 0</p>
                <p>This serves as a baseline to understand the dramatic difference when we add a second pendulum.</p>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label>Initial Angle: <span id="singleAngleVal">45</span>°</label>
                    <input type="range" id="singleAngle" min="0" max="180" value="45">
                </div>
                <div class="control-group">
                    <label>Length: <span id="singleLengthVal">200</span>px</label>
                    <input type="range" id="singleLength" min="100" max="300" value="200">
                </div>
                <div class="control-group">
                    <label>Gravity: <span id="singleGravityVal">9.81</span></label>
                    <input type="range" id="singleGravity" min="1" max="20" step="0.1" value="9.81">
                </div>
                <button onclick="resetSingle()">Reset</button>
                <button onclick="toggleSingle()">Start</button>
            </div>

            <canvas id="singleCanvas" width="800" height="600"></canvas>

            <div class="stats-panel">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="singleTheta">45.0°</div>
                        <div class="stat-label">Angle (θ)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="singleOmega">0.00</div>
                        <div class="stat-label">Angular Velocity (ω)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="singleEnergy">100%</div>
                        <div class="stat-label">Total Energy</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Double Pendulum View -->
        <div class="view" id="double">
            <div class="info-box">
                <h3>Chaotic Motion</h3>
                <p>The double pendulum is a classic example of deterministic chaos. Despite having simple, deterministic equations of motion, its behavior is:</p>
                <ul>
                    <li><strong>Unpredictable:</strong> Long-term behavior cannot be predicted</li>
                    <li><strong>Sensitive:</strong> Tiny changes in initial conditions lead to vastly different outcomes</li>
                    <li><strong>Non-periodic:</strong> Motion never exactly repeats</li>
                    <li><strong>Deterministic:</strong> No randomness - same initial conditions always give same result</li>
                </ul>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label>θ1: <span id="doubleTheta1Val">90</span>°</label>
                    <input type="range" id="doubleTheta1" min="0" max="180" value="90">
                </div>
                <div class="control-group">
                    <label>θ2: <span id="doubleTheta2Val">90</span>°</label>
                    <input type="range" id="doubleTheta2" min="0" max="180" value="90">
                </div>
                <div class="control-group">
                    <label>m1/m2: <span id="massRatioVal">1.0</span></label>
                    <input type="range" id="massRatio" min="0.5" max="3" step="0.1" value="1">
                </div>
                <div class="control-group">
                    <label>L1/L2: <span id="lengthRatioVal">1.0</span></label>
                    <input type="range" id="lengthRatio" min="0.5" max="2" step="0.1" value="1">
                </div>
                <div class="control-group">
                    <label>Trail: <span id="trailLengthVal">100</span></label>
                    <input type="range" id="trailLength" min="0" max="500" value="100">
                </div>
                <div class="control-group">
                    <label>Damping: <span id="dampingVal">0.00</span></label>
                    <input type="range" id="damping" min="0" max="0.01" step="0.001" value="0">
                </div>
                <button onclick="resetDouble()">Reset</button>
                <button onclick="toggleDouble()">Start</button>
            </div>

            <canvas id="doubleCanvas" width="800" height="600"></canvas>

            <div class="energy-bars">
                <div class="energy-bar-container">
                    <div class="energy-label">Kinetic</div>
                    <div class="energy-bar">
                        <div class="energy-fill energy-kinetic" id="kineticBar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="energy-bar-container">
                    <div class="energy-label">Potential</div>
                    <div class="energy-bar">
                        <div class="energy-fill energy-potential" id="potentialBar" style="width: 100%"></div>
                    </div>
                </div>
                <div class="energy-bar-container">
                    <div class="energy-label">Total</div>
                    <div class="energy-bar">
                        <div class="energy-fill energy-total" id="totalBar" style="width: 100%"></div>
                    </div>
                </div>
            </div>

            <div class="stats-panel">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="doubleTheta1Stat">90.0°</div>
                        <div class="stat-label">θ1</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="doubleTheta2Stat">90.0°</div>
                        <div class="stat-label">θ2</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="doubleOmega1">0.00</div>
                        <div class="stat-label">ω1</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="doubleOmega2">0.00</div>
                        <div class="stat-label">ω2</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sensitivity Demo View -->
        <div class="view" id="sensitivity">
            <div class="info-box">
                <h3>Butterfly Effect</h3>
                <p>Watch 8 double pendulums with nearly identical initial conditions diverge dramatically over time.
                Each pendulum starts with θ1 differing by only 0.0001 radians (0.0057°) - smaller than a human can perceive.</p>
                <p>This demonstrates the <strong>Lyapunov exponent</strong> - a measure of how quickly nearby trajectories diverge.
                For a chaotic system, this exponent is positive, meaning small differences grow exponentially.</p>
                <p>This is why weather prediction is limited to ~10 days despite deterministic physics!</p>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label>Base θ1: <span id="sensitivityTheta1Val">90</span>°</label>
                    <input type="range" id="sensitivityTheta1" min="30" max="150" value="90">
                </div>
                <div class="control-group">
                    <label>θ2: <span id="sensitivityTheta2Val">90</span>°</label>
                    <input type="range" id="sensitivityTheta2" min="30" max="150" value="90">
                </div>
                <div class="control-group">
                    <label>Perturbation: <span id="perturbationVal">0.0001</span> rad</label>
                    <input type="range" id="perturbation" min="0.00001" max="0.001" step="0.00001" value="0.0001">
                </div>
                <button onclick="resetSensitivity()">Reset</button>
                <button onclick="toggleSensitivity()">Start</button>
            </div>

            <canvas id="sensitivityCanvas" width="800" height="600"></canvas>

            <div class="stats-panel">
                <div class="stat-item">
                    <div class="stat-value" id="maxDivergence">0.0</div>
                    <div class="stat-label">Max Divergence (pixels)</div>
                </div>
            </div>
        </div>

        <!-- Phase Space View -->
        <div class="view" id="phase">
            <div class="info-box">
                <h3>Phase Space Portrait</h3>
                <p>Phase space plots position (θ) vs velocity (ω) for each pendulum. Each point represents the system's state at one moment.</p>
                <ul>
                    <li><strong>Simple pendulum:</strong> Closed elliptical orbits (periodic)</li>
                    <li><strong>Double pendulum:</strong> Complex, never-repeating trajectories (chaotic)</li>
                    <li><strong>Poincaré section:</strong> Intersection points reveal hidden structure</li>
                </ul>
                <p>Chaotic systems fill the available phase space densely but never exactly repeat.</p>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label>θ1: <span id="phaseTheta1Val">90</span>°</label>
                    <input type="range" id="phaseTheta1" min="0" max="180" value="90">
                </div>
                <div class="control-group">
                    <label>θ2: <span id="phaseTheta2Val">90</span>°</label>
                    <input type="range" id="phaseTheta2" min="0" max="180" value="90">
                </div>
                <div class="control-group">
                    <label>History: <span id="phaseHistoryVal">1000</span></label>
                    <input type="range" id="phaseHistory" min="100" max="5000" value="1000">
                </div>
                <button onclick="resetPhase()">Reset</button>
                <button onclick="togglePhase()">Start</button>
            </div>

            <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                <div>
                    <h3 style="text-align: center; margin-bottom: 10px; color: var(--theme-color);">Pendulum 1 (θ1 vs ω1)</h3>
                    <canvas id="phase1Canvas" width="400" height="400"></canvas>
                </div>
                <div>
                    <h3 style="text-align: center; margin-bottom: 10px; color: var(--text-accent);">Pendulum 2 (θ2 vs ω2)</h3>
                    <canvas id="phase2Canvas" width="400" height="400"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Physics Constants
        const G = 9.81; // m/s^2

        // Double Pendulum Class with RK4 Integration
        class DoublePendulum {
            constructor(theta1, theta2, m1, m2, L1, L2, g = G, damping = 0) {
                this.theta1 = theta1;
                this.theta2 = theta2;
                this.omega1 = 0;
                this.omega2 = 0;
                this.m1 = m1;
                this.m2 = m2;
                this.L1 = L1;
                this.L2 = L2;
                this.g = g;
                this.damping = damping;
                this.trail = [];
            }

            derivatives(state) {
                const [theta1, omega1, theta2, omega2] = state;
                const { m1, m2, L1, L2, g, damping } = this;

                const delta = theta2 - theta1;
                const den1 = (m1 + m2) * L1 - m2 * L1 * Math.cos(delta) * Math.cos(delta);
                const den2 = (L2 / L1) * den1;

                // Equations of motion derived from Lagrangian mechanics
                const dtheta1 = omega1;
                const domega1 = (
                    m2 * L1 * omega1 * omega1 * Math.sin(delta) * Math.cos(delta) +
                    m2 * g * Math.sin(theta2) * Math.cos(delta) +
                    m2 * L2 * omega2 * omega2 * Math.sin(delta) -
                    (m1 + m2) * g * Math.sin(theta1)
                ) / den1 - damping * omega1;

                const dtheta2 = omega2;
                const domega2 = (
                    -m2 * L2 * omega2 * omega2 * Math.sin(delta) * Math.cos(delta) +
                    (m1 + m2) * g * Math.sin(theta1) * Math.cos(delta) -
                    (m1 + m2) * L1 * omega1 * omega1 * Math.sin(delta) -
                    (m1 + m2) * g * Math.sin(theta2)
                ) / den2 - damping * omega2;

                return [dtheta1, domega1, dtheta2, domega2];
            }

            rk4Step(dt) {
                const state = [this.theta1, this.omega1, this.theta2, this.omega2];

                const k1 = this.derivatives(state);
                const k2 = this.derivatives(state.map((s, i) => s + dt/2 * k1[i]));
                const k3 = this.derivatives(state.map((s, i) => s + dt/2 * k2[i]));
                const k4 = this.derivatives(state.map((s, i) => s + dt * k3[i]));

                for (let i = 0; i < 4; i++) {
                    state[i] += dt/6 * (k1[i] + 2*k2[i] + 2*k3[i] + k4[i]);
                }

                [this.theta1, this.omega1, this.theta2, this.omega2] = state;
            }

            step(dt, substeps = 4) {
                const subdt = dt / substeps;
                for (let i = 0; i < substeps; i++) {
                    this.rk4Step(subdt);
                }
            }

            getPositions(originX, originY) {
                const x1 = originX + this.L1 * Math.sin(this.theta1);
                const y1 = originY + this.L1 * Math.cos(this.theta1);
                const x2 = x1 + this.L2 * Math.sin(this.theta2);
                const y2 = y1 + this.L2 * Math.cos(this.theta2);
                return { x1, y1, x2, y2 };
            }

            getEnergy() {
                const { m1, m2, L1, L2, g, omega1, omega2, theta1, theta2 } = this;

                // Kinetic energy
                const v1_sq = L1 * L1 * omega1 * omega1;
                const v2_sq = L2 * L2 * omega2 * omega2 +
                             L1 * L1 * omega1 * omega1 +
                             2 * L1 * L2 * omega1 * omega2 * Math.cos(theta1 - theta2);
                const KE = 0.5 * m1 * v1_sq + 0.5 * m2 * v2_sq;

                // Potential energy (relative to pivot)
                const y1 = -L1 * Math.cos(theta1);
                const y2 = y1 - L2 * Math.cos(theta2);
                const PE = m1 * g * y1 + m2 * g * y2;

                return { kinetic: KE, potential: PE, total: KE + PE };
            }

            addTrailPoint(x, y, maxLength) {
                this.trail.push({ x, y });
                if (this.trail.length > maxLength) {
                    this.trail.shift();
                }
            }
        }

        // Single Pendulum Class
        class SinglePendulum {
            constructor(theta, L, g = G) {
                this.theta = theta;
                this.omega = 0;
                this.L = L;
                this.g = g;
            }

            step(dt) {
                const alpha = -(this.g / this.L) * Math.sin(this.theta);
                this.omega += alpha * dt;
                this.theta += this.omega * dt;
            }

            getPosition(originX, originY) {
                const x = originX + this.L * Math.sin(this.theta);
                const y = originY + this.L * Math.cos(this.theta);
                return { x, y };
            }

            getEnergy() {
                const KE = 0.5 * this.L * this.L * this.omega * this.omega;
                const PE = -this.g * this.L * Math.cos(this.theta);
                return { kinetic: KE, potential: PE, total: KE + PE };
            }
        }

        // Global state
        let singlePendulum;
        let singleRunning = false;
        let singleAnimationId;

        let doublePendulum;
        let doubleRunning = false;
        let doubleAnimationId;
        let initialEnergy = 0;

        let sensitivityPendulums = [];
        let sensitivityRunning = false;
        let sensitivityAnimationId;

        let phasePendulum;
        let phaseRunning = false;
        let phaseAnimationId;
        let phaseHistory1 = [];
        let phaseHistory2 = [];

        // Tab system
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.view).classList.add('active');
            });
        });

        // Setup controls
        function setupControls() {
            // Single pendulum controls
            document.getElementById('singleAngle').addEventListener('input', (e) => {
                document.getElementById('singleAngleVal').textContent = e.target.value;
            });
            document.getElementById('singleLength').addEventListener('input', (e) => {
                document.getElementById('singleLengthVal').textContent = e.target.value;
            });
            document.getElementById('singleGravity').addEventListener('input', (e) => {
                document.getElementById('singleGravityVal').textContent = parseFloat(e.target.value).toFixed(2);
            });

            // Double pendulum controls
            document.getElementById('doubleTheta1').addEventListener('input', (e) => {
                document.getElementById('doubleTheta1Val').textContent = e.target.value;
            });
            document.getElementById('doubleTheta2').addEventListener('input', (e) => {
                document.getElementById('doubleTheta2Val').textContent = e.target.value;
            });
            document.getElementById('massRatio').addEventListener('input', (e) => {
                document.getElementById('massRatioVal').textContent = parseFloat(e.target.value).toFixed(1);
            });
            document.getElementById('lengthRatio').addEventListener('input', (e) => {
                document.getElementById('lengthRatioVal').textContent = parseFloat(e.target.value).toFixed(1);
            });
            document.getElementById('trailLength').addEventListener('input', (e) => {
                document.getElementById('trailLengthVal').textContent = e.target.value;
            });
            document.getElementById('damping').addEventListener('input', (e) => {
                document.getElementById('dampingVal').textContent = parseFloat(e.target.value).toFixed(3);
            });

            // Sensitivity controls
            document.getElementById('sensitivityTheta1').addEventListener('input', (e) => {
                document.getElementById('sensitivityTheta1Val').textContent = e.target.value;
            });
            document.getElementById('sensitivityTheta2').addEventListener('input', (e) => {
                document.getElementById('sensitivityTheta2Val').textContent = e.target.value;
            });
            document.getElementById('perturbation').addEventListener('input', (e) => {
                document.getElementById('perturbationVal').textContent = parseFloat(e.target.value).toFixed(6);
            });

            // Phase space controls
            document.getElementById('phaseTheta1').addEventListener('input', (e) => {
                document.getElementById('phaseTheta1Val').textContent = e.target.value;
            });
            document.getElementById('phaseTheta2').addEventListener('input', (e) => {
                document.getElementById('phaseTheta2Val').textContent = e.target.value;
            });
            document.getElementById('phaseHistory').addEventListener('input', (e) => {
                document.getElementById('phaseHistoryVal').textContent = e.target.value;
            });
        }

        // ===== SINGLE PENDULUM =====
        function resetSingle() {
            const angle = parseFloat(document.getElementById('singleAngle').value) * Math.PI / 180;
            const length = parseFloat(document.getElementById('singleLength').value);
            const gravity = parseFloat(document.getElementById('singleGravity').value);

            singlePendulum = new SinglePendulum(angle, length, gravity);

            if (singleRunning) {
                cancelAnimationFrame(singleAnimationId);
                singleRunning = false;
            }

            drawSingle();
        }

        function toggleSingle() {
            if (singleRunning) {
                cancelAnimationFrame(singleAnimationId);
                singleRunning = false;
                event.target.textContent = 'Start';
            } else {
                singleRunning = true;
                event.target.textContent = 'Stop';
                animateSingle();
            }
        }

        function drawSingle() {
            const canvas = document.getElementById('singleCanvas');
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = 100;

            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const pos = singlePendulum.getPosition(centerX, centerY);

            // Draw rod
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();

            // Draw pivot
            ctx.fillStyle = '#fbbf24';
            ctx.beginPath();
            ctx.arc(centerX, centerY, 8, 0, Math.PI * 2);
            ctx.fill();

            // Draw bob
            ctx.fillStyle = '#667eea';
            ctx.beginPath();
            ctx.arc(pos.x, pos.y, 15, 0, Math.PI * 2);
            ctx.fill();

            // Update stats
            const thetaDeg = (singlePendulum.theta * 180 / Math.PI).toFixed(1);
            document.getElementById('singleTheta').textContent = thetaDeg + '°';
            document.getElementById('singleOmega').textContent = singlePendulum.omega.toFixed(2);

            const energy = singlePendulum.getEnergy();
            const energyPercent = ((energy.total / Math.abs(energy.potential + energy.kinetic)) * 100).toFixed(0);
            document.getElementById('singleEnergy').textContent = '100%'; // Conservation
        }

        function animateSingle() {
            singlePendulum.step(0.016); // ~60 fps
            drawSingle();

            if (singleRunning) {
                singleAnimationId = requestAnimationFrame(animateSingle);
            }
        }

        // ===== DOUBLE PENDULUM =====
        function resetDouble() {
            const theta1 = parseFloat(document.getElementById('doubleTheta1').value) * Math.PI / 180;
            const theta2 = parseFloat(document.getElementById('doubleTheta2').value) * Math.PI / 180;
            const massRatio = parseFloat(document.getElementById('massRatio').value);
            const lengthRatio = parseFloat(document.getElementById('lengthRatio').value);
            const damping = parseFloat(document.getElementById('damping').value);

            const m1 = 1;
            const m2 = m1 * massRatio;
            const L1 = 150;
            const L2 = L1 * lengthRatio;

            doublePendulum = new DoublePendulum(theta1, theta2, m1, m2, L1, L2, G, damping);
            doublePendulum.trail = [];

            const energy = doublePendulum.getEnergy();
            initialEnergy = energy.total;

            if (doubleRunning) {
                cancelAnimationFrame(doubleAnimationId);
                doubleRunning = false;
            }

            drawDouble();
        }

        function toggleDouble() {
            if (doubleRunning) {
                cancelAnimationFrame(doubleAnimationId);
                doubleRunning = false;
                event.target.textContent = 'Start';
            } else {
                doubleRunning = true;
                event.target.textContent = 'Stop';
                animateDouble();
            }
        }

        function drawDouble() {
            const canvas = document.getElementById('doubleCanvas');
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = 150;

            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const pos = doublePendulum.getPositions(centerX, centerY);
            const trailLength = parseInt(document.getElementById('trailLength').value);

            // Draw trail with gradient
            if (doublePendulum.trail.length > 1) {
                for (let i = 1; i < doublePendulum.trail.length; i++) {
                    const prev = doublePendulum.trail[i - 1];
                    const curr = doublePendulum.trail[i];
                    const alpha = i / doublePendulum.trail.length;
                    const hue = (i / doublePendulum.trail.length) * 360;

                    ctx.strokeStyle = `hsla(${hue}, 80%, 60%, ${alpha * 0.8})`;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(prev.x, prev.y);
                    ctx.lineTo(curr.x, curr.y);
                    ctx.stroke();
                }
            }

            // Draw rods
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(pos.x1, pos.y1);
            ctx.stroke();

            ctx.strokeStyle = '#fbbf24';
            ctx.beginPath();
            ctx.moveTo(pos.x1, pos.y1);
            ctx.lineTo(pos.x2, pos.y2);
            ctx.stroke();

            // Draw pivot
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(centerX, centerY, 8, 0, Math.PI * 2);
            ctx.fill();

            // Draw bobs
            ctx.fillStyle = '#667eea';
            ctx.beginPath();
            ctx.arc(pos.x1, pos.y1, 12, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = '#fbbf24';
            ctx.beginPath();
            ctx.arc(pos.x2, pos.y2, 12, 0, Math.PI * 2);
            ctx.fill();

            // Update trail
            if (trailLength > 0) {
                doublePendulum.addTrailPoint(pos.x2, pos.y2, trailLength);
            }

            // Update stats
            const theta1Deg = (doublePendulum.theta1 * 180 / Math.PI).toFixed(1);
            const theta2Deg = (doublePendulum.theta2 * 180 / Math.PI).toFixed(1);
            document.getElementById('doubleTheta1Stat').textContent = theta1Deg + '°';
            document.getElementById('doubleTheta2Stat').textContent = theta2Deg + '°';
            document.getElementById('doubleOmega1').textContent = doublePendulum.omega1.toFixed(2);
            document.getElementById('doubleOmega2').textContent = doublePendulum.omega2.toFixed(2);

            // Update energy bars
            const energy = doublePendulum.getEnergy();
            const maxEnergy = Math.abs(initialEnergy) * 1.2;

            const kineticPercent = Math.min(100, (energy.kinetic / maxEnergy) * 100);
            const potentialPercent = Math.min(100, ((energy.potential + maxEnergy) / (maxEnergy * 2)) * 100);
            const totalPercent = Math.min(100, ((energy.total + maxEnergy) / (maxEnergy * 2)) * 100);

            document.getElementById('kineticBar').style.width = kineticPercent + '%';
            document.getElementById('potentialBar').style.width = potentialPercent + '%';
            document.getElementById('totalBar').style.width = totalPercent + '%';
        }

        function animateDouble() {
            doublePendulum.step(0.016);
            drawDouble();

            if (doubleRunning) {
                doubleAnimationId = requestAnimationFrame(animateDouble);
            }
        }

        // ===== SENSITIVITY DEMO =====
        function resetSensitivity() {
            const baseTheta1 = parseFloat(document.getElementById('sensitivityTheta1').value) * Math.PI / 180;
            const theta2 = parseFloat(document.getElementById('sensitivityTheta2').value) * Math.PI / 180;
            const perturbation = parseFloat(document.getElementById('perturbation').value);

            sensitivityPendulums = [];
            const colors = ['#ff0000', '#ff7f00', '#ffff00', '#00ff00', '#00ffff', '#0000ff', '#8b00ff', '#ff00ff'];

            for (let i = 0; i < 8; i++) {
                const theta1 = baseTheta1 + i * perturbation;
                const pendulum = new DoublePendulum(theta1, theta2, 1, 1, 100, 100, G, 0);
                pendulum.color = colors[i];
                pendulum.trail = [];
                sensitivityPendulums.push(pendulum);
            }

            if (sensitivityRunning) {
                cancelAnimationFrame(sensitivityAnimationId);
                sensitivityRunning = false;
            }

            drawSensitivity();
        }

        function toggleSensitivity() {
            if (sensitivityRunning) {
                cancelAnimationFrame(sensitivityAnimationId);
                sensitivityRunning = false;
                event.target.textContent = 'Start';
            } else {
                sensitivityRunning = true;
                event.target.textContent = 'Stop';
                animateSensitivity();
            }
        }

        function drawSensitivity() {
            const canvas = document.getElementById('sensitivityCanvas');
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = 150;

            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            let maxDist = 0;

            sensitivityPendulums.forEach((pendulum, i) => {
                const pos = pendulum.getPositions(centerX, centerY);

                // Draw trail
                if (pendulum.trail.length > 1) {
                    ctx.strokeStyle = pendulum.color;
                    ctx.globalAlpha = 0.3;
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(pendulum.trail[0].x, pendulum.trail[0].y);
                    for (let j = 1; j < pendulum.trail.length; j++) {
                        ctx.lineTo(pendulum.trail[j].x, pendulum.trail[j].y);
                    }
                    ctx.stroke();
                    ctx.globalAlpha = 1;
                }

                // Draw current pendulum (simplified)
                ctx.strokeStyle = pendulum.color;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(pos.x1, pos.y1);
                ctx.lineTo(pos.x2, pos.y2);
                ctx.stroke();

                ctx.fillStyle = pendulum.color;
                ctx.beginPath();
                ctx.arc(pos.x2, pos.y2, 5, 0, Math.PI * 2);
                ctx.fill();

                pendulum.addTrailPoint(pos.x2, pos.y2, 300);

                // Calculate divergence
                if (i > 0) {
                    const pos0 = sensitivityPendulums[0].getPositions(centerX, centerY);
                    const dist = Math.sqrt((pos.x2 - pos0.x2)**2 + (pos.y2 - pos0.y2)**2);
                    maxDist = Math.max(maxDist, dist);
                }
            });

            document.getElementById('maxDivergence').textContent = maxDist.toFixed(1);
        }

        function animateSensitivity() {
            sensitivityPendulums.forEach(p => p.step(0.016));
            drawSensitivity();

            if (sensitivityRunning) {
                sensitivityAnimationId = requestAnimationFrame(animateSensitivity);
            }
        }

        // ===== PHASE SPACE =====
        function resetPhase() {
            const theta1 = parseFloat(document.getElementById('phaseTheta1').value) * Math.PI / 180;
            const theta2 = parseFloat(document.getElementById('phaseTheta2').value) * Math.PI / 180;

            phasePendulum = new DoublePendulum(theta1, theta2, 1, 1, 150, 150, G, 0);
            phaseHistory1 = [];
            phaseHistory2 = [];

            if (phaseRunning) {
                cancelAnimationFrame(phaseAnimationId);
                phaseRunning = false;
            }

            drawPhase();
        }

        function togglePhase() {
            if (phaseRunning) {
                cancelAnimationFrame(phaseAnimationId);
                phaseRunning = false;
                event.target.textContent = 'Start';
            } else {
                phaseRunning = true;
                event.target.textContent = 'Stop';
                animatePhase();
            }
        }

        function drawPhase() {
            const canvas1 = document.getElementById('phase1Canvas');
            const canvas2 = document.getElementById('phase2Canvas');
            const ctx1 = canvas1.getContext('2d');
            const ctx2 = canvas2.getContext('2d');

            const maxHistory = parseInt(document.getElementById('phaseHistory').value);

            // Clear canvases
            ctx1.fillStyle = '#000';
            ctx1.fillRect(0, 0, canvas1.width, canvas1.height);
            ctx2.fillStyle = '#000';
            ctx2.fillRect(0, 0, canvas2.width, canvas2.height);

            // Draw axes
            const drawAxes = (ctx) => {
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
                ctx.lineWidth = 1;

                // Center lines
                ctx.beginPath();
                ctx.moveTo(200, 0);
                ctx.lineTo(200, 400);
                ctx.moveTo(0, 200);
                ctx.lineTo(400, 200);
                ctx.stroke();

                // Grid
                for (let i = 0; i < 400; i += 50) {
                    ctx.beginPath();
                    ctx.moveTo(i, 0);
                    ctx.lineTo(i, 400);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(0, i);
                    ctx.lineTo(400, i);
                    ctx.stroke();
                }
            };

            drawAxes(ctx1);
            drawAxes(ctx2);

            // Plot phase space for pendulum 1
            if (phaseHistory1.length > 1) {
                for (let i = 1; i < phaseHistory1.length; i++) {
                    const prev = phaseHistory1[i - 1];
                    const curr = phaseHistory1[i];
                    const alpha = i / phaseHistory1.length;
                    const hue = 250; // Blue-purple

                    ctx1.strokeStyle = `hsla(${hue}, 80%, 60%, ${alpha * 0.8})`;
                    ctx1.lineWidth = 2;
                    ctx1.beginPath();
                    ctx1.moveTo(prev.x, prev.y);
                    ctx1.lineTo(curr.x, curr.y);
                    ctx1.stroke();
                }
            }

            // Plot phase space for pendulum 2
            if (phaseHistory2.length > 1) {
                for (let i = 1; i < phaseHistory2.length; i++) {
                    const prev = phaseHistory2[i - 1];
                    const curr = phaseHistory2[i];
                    const alpha = i / phaseHistory2.length;
                    const hue = 45; // Yellow-orange

                    ctx2.strokeStyle = `hsla(${hue}, 80%, 60%, ${alpha * 0.8})`;
                    ctx2.lineWidth = 2;
                    ctx2.beginPath();
                    ctx2.moveTo(prev.x, prev.y);
                    ctx2.lineTo(curr.x, curr.y);
                    ctx2.stroke();
                }
            }

            // Add current point
            const x1 = 200 + phasePendulum.theta1 * 100;
            const y1 = 200 - phasePendulum.omega1 * 20;
            const x2 = 200 + phasePendulum.theta2 * 100;
            const y2 = 200 - phasePendulum.omega2 * 20;

            phaseHistory1.push({ x: x1, y: y1 });
            phaseHistory2.push({ x: x2, y: y2 });

            if (phaseHistory1.length > maxHistory) phaseHistory1.shift();
            if (phaseHistory2.length > maxHistory) phaseHistory2.shift();
        }

        function animatePhase() {
            phasePendulum.step(0.016);
            drawPhase();

            if (phaseRunning) {
                phaseAnimationId = requestAnimationFrame(animatePhase);
            }
        }

        // Initialize
        function init() {
            setupControls();
            resetSingle();
            resetDouble();
            resetSensitivity();
            resetPhase();
        }

        window.addEventListener('load', init);
    </script>
    <script src="../assets/js/navigation.js"></script>
</body>
</html>
