<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physarum Slime Mold Simulation - CCAB</title>
    <meta name="description" content="GPU-accelerated Physarum polycephalum multi-species simulation with bioluminescent glow, bloom post-processing, and interactive food/repellor placement.">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #000;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #c8e6ff;
            user-select: none;
        }
        canvas { display: block; position: fixed; top: 0; left: 0; }

        .back-link {
            position: fixed; top: 15px; left: 15px;
            padding: 10px 18px;
            background: rgba(0,0,0,0.5);
            color: #8ecae6; text-decoration: none;
            border-radius: 10px; font-size: 14px; z-index: 1000;
            backdrop-filter: blur(12px);
            border: 1px solid rgba(142,202,230,0.25);
            transition: all 0.3s ease;
        }
        .back-link:hover {
            background: rgba(142,202,230,0.15);
            transform: translateX(-3px);
        }

        #panel {
            position: fixed; top: 15px; right: 15px;
            width: 280px; max-height: calc(100vh - 30px);
            overflow-y: auto; overflow-x: hidden;
            background: rgba(8,12,20,0.65);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(100,180,255,0.15);
            border-radius: 16px;
            padding: 18px 16px;
            z-index: 1000;
            scrollbar-width: thin;
            scrollbar-color: rgba(100,180,255,0.3) transparent;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        #panel.hidden { transform: translateX(320px); opacity: 0; pointer-events: none; }
        #panel::-webkit-scrollbar { width: 4px; }
        #panel::-webkit-scrollbar-thumb { background: rgba(100,180,255,0.3); border-radius: 2px; }

        #panel h2 {
            font-size: 15px; font-weight: 600;
            margin-bottom: 4px;
            background: linear-gradient(90deg, #00e5ff, #e040fb, #ffd740);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .panel-stats {
            font-size: 11px; color: rgba(200,230,255,0.6);
            margin-bottom: 14px;
        }
        .panel-stats span { color: #00e5ff; font-weight: 600; }

        .section-label {
            font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px;
            color: rgba(200,230,255,0.4); margin: 14px 0 8px; font-weight: 600;
        }

        .slider-row {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 6px;
        }
        .slider-row label {
            font-size: 11px; color: rgba(200,230,255,0.7); flex: 0 0 auto; width: 90px;
        }
        .slider-row input[type="range"] {
            flex: 1; margin: 0 8px; height: 3px;
            -webkit-appearance: none; appearance: none;
            background: rgba(100,180,255,0.15); border-radius: 2px; outline: none;
        }
        .slider-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 12px; height: 12px;
            background: #00e5ff; border-radius: 50%; cursor: pointer;
            box-shadow: 0 0 6px rgba(0,229,255,0.5);
        }
        .slider-row .val {
            font-size: 10px; color: #00e5ff; width: 38px; text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .preset-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 6px;
        }
        .preset-btn {
            background: rgba(100,180,255,0.08);
            border: 1px solid rgba(100,180,255,0.2);
            color: #8ecae6; padding: 7px 0;
            border-radius: 8px; cursor: pointer;
            font-size: 11px; font-weight: 500;
            transition: all 0.2s;
        }
        .preset-btn:hover {
            background: rgba(100,180,255,0.2);
            border-color: rgba(100,180,255,0.4);
        }
        .preset-btn.active {
            background: rgba(0,229,255,0.15);
            border-color: rgba(0,229,255,0.5);
            color: #00e5ff;
        }

        .action-row { display: flex; gap: 6px; margin-top: 8px; }
        .action-btn {
            flex: 1; padding: 8px 0;
            background: rgba(100,180,255,0.08);
            border: 1px solid rgba(100,180,255,0.2);
            color: #8ecae6; border-radius: 8px;
            cursor: pointer; font-size: 11px; font-weight: 500;
            transition: all 0.2s;
        }
        .action-btn:hover { background: rgba(100,180,255,0.2); }
        .action-btn.danger { border-color: rgba(255,100,100,0.3); color: #ff8a8a; }
        .action-btn.danger:hover { background: rgba(255,100,100,0.15); }

        .toggle-row {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 6px;
        }
        .toggle-row label { font-size: 11px; color: rgba(200,230,255,0.7); }
        .toggle {
            width: 36px; height: 18px; border-radius: 9px;
            background: rgba(100,180,255,0.15); cursor: pointer;
            position: relative; transition: background 0.2s;
            border: 1px solid rgba(100,180,255,0.2);
        }
        .toggle.on { background: rgba(0,229,255,0.3); border-color: rgba(0,229,255,0.5); }
        .toggle::after {
            content: ''; position: absolute;
            width: 14px; height: 14px; border-radius: 50%;
            background: #8ecae6; top: 1px; left: 1px;
            transition: transform 0.2s;
        }
        .toggle.on::after { transform: translateX(18px); background: #00e5ff; }

        #toggle-btn {
            position: fixed; top: 15px; right: 305px;
            width: 36px; height: 36px;
            background: rgba(8,12,20,0.65);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(100,180,255,0.15);
            border-radius: 10px; cursor: pointer;
            color: #8ecae6; font-size: 16px; z-index: 1000;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s;
        }
        #toggle-btn:hover { background: rgba(100,180,255,0.15); }

        .help-hint {
            font-size: 10px; color: rgba(200,230,255,0.35);
            margin-top: 10px; line-height: 1.6;
        }
        .help-hint kbd {
            display: inline-block; padding: 1px 5px;
            background: rgba(100,180,255,0.1);
            border: 1px solid rgba(100,180,255,0.2);
            border-radius: 3px; font-family: inherit;
            font-size: 9px; color: rgba(200,230,255,0.5);
        }

        #loading {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%,-50%);
            z-index: 2000; text-align: center;
        }
        .spinner {
            width: 48px; height: 48px;
            border: 2px solid rgba(0,229,255,0.15);
            border-top-color: #00e5ff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 14px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        #loading p { color: #8ecae6; font-size: 14px; }

        #error {
            display: none; position: fixed; top: 50%; left: 50%;
            transform: translate(-50%,-50%);
            background: rgba(180,40,40,0.9);
            color: #fff; padding: 30px; border-radius: 16px;
            text-align: center; z-index: 3000; max-width: 80vw;
        }
    </style>
</head>
<body>
    <a href="../index.html" class="back-link">&#8592; Back to Gallery</a>

    <div id="loading">
        <div class="spinner"></div>
        <p>Initializing Physarum...</p>
    </div>

    <div id="error">
        <h2>WebGL2 Required</h2>
        <p id="error-msg">This simulation requires WebGL2 with float texture support.</p>
    </div>

    <button id="toggle-btn" title="Toggle panel (H)">&#9776;</button>

    <div id="panel">
        <h2>Physarum Polycephalum</h2>
        <div class="panel-stats">
            Agents: <span id="agent-count">0</span> &nbsp;|&nbsp; FPS: <span id="fps">0</span>
        </div>

        <div class="section-label">Presets</div>
        <div class="preset-grid">
            <button class="preset-btn active" data-preset="classic">Classic Slime</button>
            <button class="preset-btn" data-preset="neural">Neural Net</button>
            <button class="preset-btn" data-preset="vascular">Vascular</button>
            <button class="preset-btn" data-preset="maze">Maze Solver</button>
        </div>

        <div class="section-label">Agents</div>
        <div class="slider-row">
            <label>Count</label>
            <input type="range" id="s-count" min="5000" max="200000" step="5000" value="80000">
            <div class="val" id="v-count">80K</div>
        </div>
        <div class="slider-row">
            <label>Sensor Angle</label>
            <input type="range" id="s-sa" min="2" max="90" step="0.5" value="22.5">
            <div class="val" id="v-sa">22.5</div>
        </div>
        <div class="slider-row">
            <label>Sensor Dist</label>
            <input type="range" id="s-sd" min="1" max="60" step="1" value="9">
            <div class="val" id="v-sd">9</div>
        </div>
        <div class="slider-row">
            <label>Turn Speed</label>
            <input type="range" id="s-ra" min="2" max="90" step="0.5" value="45">
            <div class="val" id="v-ra">45</div>
        </div>
        <div class="slider-row">
            <label>Step Size</label>
            <input type="range" id="s-ss" min="0.3" max="4" step="0.1" value="1.0">
            <div class="val" id="v-ss">1.0</div>
        </div>

        <div class="section-label">Trail</div>
        <div class="slider-row">
            <label>Deposit</label>
            <input type="range" id="s-dep" min="0.5" max="20" step="0.5" value="5">
            <div class="val" id="v-dep">5.0</div>
        </div>
        <div class="slider-row">
            <label>Decay Rate</label>
            <input type="range" id="s-decay" min="0.85" max="0.999" step="0.001" value="0.960">
            <div class="val" id="v-decay">0.960</div>
        </div>
        <div class="slider-row">
            <label>Diffusion</label>
            <input type="range" id="s-diff" min="0" max="1" step="0.05" value="1.0">
            <div class="val" id="v-diff">1.00</div>
        </div>

        <div class="section-label">Multi-Species</div>
        <div class="toggle-row">
            <label>Enable 3 Species</label>
            <div class="toggle" id="t-multi"></div>
        </div>

        <div class="section-label">Visual</div>
        <div class="slider-row">
            <label>Bloom</label>
            <input type="range" id="s-bloom" min="0" max="2" step="0.05" value="0.8">
            <div class="val" id="v-bloom">0.80</div>
        </div>

        <div class="action-row">
            <button class="action-btn" id="btn-reset">Reset</button>
            <button class="action-btn" id="btn-clear">Clear Trail</button>
            <button class="action-btn danger" id="btn-pause">Pause</button>
        </div>

        <div class="help-hint">
            <kbd>H</kbd> toggle panel &nbsp; <kbd>Space</kbd> pause &nbsp; <kbd>R</kbd> reset<br>
            <kbd>1-4</kbd> presets &nbsp; <kbd>M</kbd> multi-species &nbsp; <kbd>C</kbd> clear<br>
            Click: food &nbsp; Right-click: repellor &nbsp; Move: trail
        </div>
    </div>

    <canvas id="canvas"></canvas>

    <script>
    (function() {
    'use strict';

    var canvas = document.getElementById('canvas');
    var gl = canvas.getContext('webgl2', { antialias: false, alpha: false, preserveDrawingBuffer: false });

    if (!gl) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        throw new Error('WebGL2 not supported');
    }

    var extFloat = gl.getExtension('EXT_color_buffer_float');
    if (!extFloat) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('error-msg').textContent = 'EXT_color_buffer_float extension required.';
        throw new Error('EXT_color_buffer_float not available');
    }
    gl.getExtension('OES_texture_float_linear');

    var config = {
        numAgents: 80000, sensorAngle: 22.5, sensorDistance: 9,
        rotationAngle: 45, stepSize: 1.0, depositAmount: 5.0,
        decayRate: 0.96, diffuseRate: 1.0, multiSpecies: false,
        bloomStrength: 0.8, paused: false
    };

    var presets = {
        classic:  { sensorAngle: 22.5, sensorDistance: 9,  rotationAngle: 45, stepSize: 1.0, depositAmount: 5,  decayRate: 0.96,  diffuseRate: 1.0 },
        neural:   { sensorAngle: 67,   sensorDistance: 40, rotationAngle: 15, stepSize: 1.5, depositAmount: 3,  decayRate: 0.975, diffuseRate: 0.6 },
        vascular: { sensorAngle: 15,   sensorDistance: 18, rotationAngle: 60, stepSize: 1.2, depositAmount: 8,  decayRate: 0.94,  diffuseRate: 1.0 },
        maze:     { sensorAngle: 30,   sensorDistance: 12, rotationAngle: 30, stepSize: 0.8, depositAmount: 12, decayRate: 0.985, diffuseRate: 0.4 }
    };

    var speciesOffsets = [
        { saOff: 0, sdOff: 0, raOff: 0 },
        { saOff: 15, sdOff: 5, raOff: -10 },
        { saOff: -10, sdOff: -3, raOff: 20 }
    ];

    var width, height, trailW, trailH;

    function resize() {
        var dpr = Math.min(window.devicePixelRatio, 2);
        width = Math.floor(window.innerWidth * dpr);
        height = Math.floor(window.innerHeight * dpr);
        trailW = Math.floor(width * 0.75);
        trailH = Math.floor(height * 0.75);
        canvas.width = width;
        canvas.height = height;
        canvas.style.width = window.innerWidth + 'px';
        canvas.style.height = window.innerHeight + 'px';
    }

    function compileShader(type, src) {
        var s = gl.createShader(type);
        gl.shaderSource(s, src);
        gl.compileShader(s);
        if (!gl.getShaderParameter(s, gl.COMPILE_STATUS)) {
            console.error('Shader error:', gl.getShaderInfoLog(s));
            throw new Error('Shader compile failed');
        }
        return s;
    }

    function linkProg(vs, fs) {
        var p = gl.createProgram();
        gl.attachShader(p, compileShader(gl.VERTEX_SHADER, vs));
        gl.attachShader(p, compileShader(gl.FRAGMENT_SHADER, fs));
        gl.linkProgram(p);
        if (!gl.getProgramParameter(p, gl.LINK_STATUS)) {
            console.error('Link error:', gl.getProgramInfoLog(p));
            throw new Error('Program link failed');
        }
        return p;
    }

    function getU(prog, names) {
        var u = {};
        for (var i = 0; i < names.length; i++) u[names[i]] = gl.getUniformLocation(prog, names[i]);
        return u;
    }

    var quadVAO, quadBuf;
    function initQuad() {
        quadBuf = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, quadBuf);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1,-1,1,-1,-1,1,1,1]), gl.STATIC_DRAW);
        quadVAO = gl.createVertexArray();
        gl.bindVertexArray(quadVAO);
        gl.bindBuffer(gl.ARRAY_BUFFER, quadBuf);
        gl.enableVertexAttribArray(0);
        gl.vertexAttribPointer(0, 2, gl.FLOAT, false, 0, 0);
        gl.bindVertexArray(null);
    }
    function drawQuad() {
        gl.bindVertexArray(quadVAO);
        gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
        gl.bindVertexArray(null);
    }

    function createFBTex(w, h, intFmt, fmt, type, filter) {
        var tex = gl.createTexture();
        gl.bindTexture(gl.TEXTURE_2D, tex);
        gl.texImage2D(gl.TEXTURE_2D, 0, intFmt, w, h, 0, fmt, type, null);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, filter);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, filter);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
        var fb = gl.createFramebuffer();
        gl.bindFramebuffer(gl.FRAMEBUFFER, fb);
        gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, tex, 0);
        gl.bindFramebuffer(gl.FRAMEBUFFER, null);
        return { tex: tex, fb: fb };
    }

    // ---- GLSL ----

    var depositVS = '#version 300 es\nuniform vec2 u_resolution;\nin vec2 a_pos;\nin float a_species;\nflat out float v_species;\nvoid main(){\n  v_species=a_species;\n  vec2 ndc=(a_pos/u_resolution)*2.0-1.0;\n  gl_Position=vec4(ndc,0,1);\n  gl_PointSize=1.0;\n}\n';

    var depositFS = '#version 300 es\nprecision highp float;\nuniform float u_deposit;\nuniform bool u_multi;\nflat in float v_species;\nout vec4 o;\nvoid main(){\n  float d=u_deposit/255.0;\n  if(!u_multi){o=vec4(d,d,d,1);}\n  else{int s=int(v_species+0.5);\n  if(s==0)o=vec4(d,0,0,1);\n  else if(s==1)o=vec4(0,d,0,1);\n  else o=vec4(0,0,d,1);}\n}\n';

    var qVS = '#version 300 es\nlayout(location=0)in vec2 a_pos;\nout vec2 v_uv;\nvoid main(){\n  v_uv=a_pos*0.5+0.5;\n  gl_Position=vec4(a_pos,0,1);\n}\n';

    var diffFS = '#version 300 es\nprecision highp float;\nuniform sampler2D u_trail;\nuniform vec2 u_texel;\nuniform float u_decay;\nuniform float u_diffuse;\nin vec2 v_uv;\nout vec4 o;\nvoid main(){\n  vec3 sum=vec3(0);\n  for(int dy=-1;dy<=1;dy++)for(int dx=-1;dx<=1;dx++)\n    sum+=texture(u_trail,v_uv+vec2(float(dx),float(dy))*u_texel).rgb;\n  vec3 orig=texture(u_trail,v_uv).rgb;\n  o=vec4(mix(orig,sum/9.0,u_diffuse)*u_decay,1);\n}\n';

    var bThFS = '#version 300 es\nprecision highp float;\nuniform sampler2D u_tex;\nin vec2 v_uv;\nout vec4 o;\nvoid main(){\n  vec3 c=texture(u_tex,v_uv).rgb;\n  float br=dot(c,vec3(0.299,0.587,0.114));\n  o=vec4(c*smoothstep(0.15,0.6,br),1);\n}\n';

    var blFS = '#version 300 es\nprecision highp float;\nuniform sampler2D u_tex;\nuniform vec2 u_dir;\nin vec2 v_uv;\nout vec4 o;\nvoid main(){\n  vec3 r=vec3(0);\n  float w[5]=float[](0.227027,0.1945946,0.1216216,0.054054,0.016216);\n  r+=texture(u_tex,v_uv).rgb*w[0];\n  for(int i=1;i<5;i++){vec2 off=u_dir*float(i);\n  r+=texture(u_tex,v_uv+off).rgb*w[i];\n  r+=texture(u_tex,v_uv-off).rgb*w[i];}\n  o=vec4(r,1);\n}\n';

    var compFS = '#version 300 es\nprecision highp float;\nuniform sampler2D u_trail;\nuniform sampler2D u_bloom;\nuniform float u_bloomStr;\nuniform bool u_multi;\nin vec2 v_uv;\nout vec4 o;\nvoid main(){\n  vec3 raw=texture(u_trail,v_uv).rgb;\n  vec3 blm=texture(u_bloom,v_uv).rgb;\n  vec3 color;\n  if(!u_multi){\n    float t=raw.r;\n    vec3 c0=vec3(0.01,0.015,0.04);\n    vec3 c1=vec3(0,0.25,0.45);\n    vec3 c2=vec3(0,0.85,0.95);\n    vec3 c3=vec3(0.7,1,1);\n    if(t<0.15)color=mix(c0,c1,t/0.15);\n    else if(t<0.5)color=mix(c1,c2,(t-0.15)/0.35);\n    else color=mix(c2,c3,min((t-0.5)/0.5,1.0));\n  }else{\n    color=raw.r*vec3(0,0.9,1)+raw.g*vec3(1,0.15,0.7)+raw.b*vec3(1,0.85,0.15);\n    color+=vec3(0.01,0.015,0.04)*(1.0-min(dot(color,vec3(0.3))*3.0,1.0));\n  }\n  color+=blm*u_bloomStr;\n  vec2 vig=v_uv*(1.0-v_uv);\n  float v=pow(vig.x*vig.y*16.0,0.3);\n  color*=mix(0.4,1.0,v);\n  color=color/(color+0.8);\n  color=pow(color,vec3(0.9));\n  o=vec4(color,1);\n}\n';

    var stFS = '#version 300 es\nprecision highp float;\nuniform vec2 u_pos;\nuniform vec2 u_res;\nuniform float u_radius;\nuniform float u_strength;\nuniform sampler2D u_trail;\nin vec2 v_uv;\nout vec4 o;\nvoid main(){\n  vec3 e=texture(u_trail,v_uv).rgb;\n  float d=length(v_uv*u_res-u_pos);\n  float f=1.0-smoothstep(0.0,u_radius,d);\n  o=vec4(max(e+vec3(u_strength*f),vec3(0)),1);\n}\n';

    var progDep, progDiff, progBTh, progBl, progComp, progSt;
    var uDep, uDiff, uBTh, uBl, uComp, uSt;

    function initPrograms() {
        progDep = linkProg(depositVS, depositFS);
        uDep = getU(progDep, ['u_resolution','u_deposit','u_multi']);
        progDiff = linkProg(qVS, diffFS);
        uDiff = getU(progDiff, ['u_trail','u_texel','u_decay','u_diffuse']);
        progBTh = linkProg(qVS, bThFS);
        uBTh = getU(progBTh, ['u_tex']);
        progBl = linkProg(qVS, blFS);
        uBl = getU(progBl, ['u_tex','u_dir']);
        progComp = linkProg(qVS, compFS);
        uComp = getU(progComp, ['u_trail','u_bloom','u_bloomStr','u_multi']);
        progSt = linkProg(qVS, stFS);
        uSt = getU(progSt, ['u_pos','u_res','u_radius','u_strength','u_trail']);
    }

    var trailFBO = [null, null], currentTrail = 0;
    var bloomFBO = [null, null], bloomW, bloomH;

    function createTrailFBOs() {
        var i;
        for (i = 0; i < 2; i++) {
            if (trailFBO[i]) { gl.deleteTexture(trailFBO[i].tex); gl.deleteFramebuffer(trailFBO[i].fb); }
            trailFBO[i] = createFBTex(trailW, trailH, gl.RGBA16F, gl.RGBA, gl.FLOAT, gl.LINEAR);
        }
        for (i = 0; i < 2; i++) {
            gl.bindFramebuffer(gl.FRAMEBUFFER, trailFBO[i].fb);
            gl.clearColor(0,0,0,1); gl.clear(gl.COLOR_BUFFER_BIT);
        }
        bloomW = Math.max(1, Math.floor(trailW / 4));
        bloomH = Math.max(1, Math.floor(trailH / 4));
        for (i = 0; i < 2; i++) {
            if (bloomFBO[i]) { gl.deleteTexture(bloomFBO[i].tex); gl.deleteFramebuffer(bloomFBO[i].fb); }
            bloomFBO[i] = createFBTex(bloomW, bloomH, gl.RGBA16F, gl.RGBA, gl.FLOAT, gl.LINEAR);
        }
        gl.bindFramebuffer(gl.FRAMEBUFFER, null);
    }

    var agentX, agentY, agentAngle, agentSpecies;
    var agentPosBuf, agentSpeciesBuf, depositVAO;

    function initAgents(count) {
        config.numAgents = count;
        agentX = new Float32Array(count);
        agentY = new Float32Array(count);
        agentAngle = new Float32Array(count);
        agentSpecies = new Float32Array(count);
        var cx = trailW * 0.5, cy = trailH * 0.5;
        var radius = Math.min(trailW, trailH) * 0.35;
        for (var i = 0; i < count; i++) {
            var a = Math.random() * 6.2831853;
            var r = Math.sqrt(Math.random()) * radius;
            agentX[i] = cx + Math.cos(a) * r;
            agentY[i] = cy + Math.sin(a) * r;
            agentAngle[i] = Math.atan2(cy - agentY[i], cx - agentX[i]) + (Math.random() - 0.5) * 0.5;
            agentSpecies[i] = config.multiSpecies ? (i % 3) : 0;
        }
        if (agentPosBuf) gl.deleteBuffer(agentPosBuf);
        if (agentSpeciesBuf) gl.deleteBuffer(agentSpeciesBuf);
        agentPosBuf = gl.createBuffer();
        agentSpeciesBuf = gl.createBuffer();
        if (depositVAO) gl.deleteVertexArray(depositVAO);
        depositVAO = gl.createVertexArray();
        gl.bindVertexArray(depositVAO);
        gl.bindBuffer(gl.ARRAY_BUFFER, agentPosBuf);
        gl.bufferData(gl.ARRAY_BUFFER, count * 8, gl.DYNAMIC_DRAW);
        var posLoc = gl.getAttribLocation(progDep, 'a_pos');
        gl.enableVertexAttribArray(posLoc);
        gl.vertexAttribPointer(posLoc, 2, gl.FLOAT, false, 0, 0);
        gl.bindBuffer(gl.ARRAY_BUFFER, agentSpeciesBuf);
        gl.bufferData(gl.ARRAY_BUFFER, count * 4, gl.DYNAMIC_DRAW);
        var specLoc = gl.getAttribLocation(progDep, 'a_species');
        gl.enableVertexAttribArray(specLoc);
        gl.vertexAttribPointer(specLoc, 1, gl.FLOAT, false, 0, 0);
        gl.bindVertexArray(null);
    }

    var trailData = null;
    function readTrailData() {
        if (!trailData || trailData.length !== trailW * trailH * 4)
            trailData = new Float32Array(trailW * trailH * 4);
        gl.bindFramebuffer(gl.FRAMEBUFFER, trailFBO[currentTrail].fb);
        gl.readPixels(0, 0, trailW, trailH, gl.RGBA, gl.FLOAT, trailData);
        gl.bindFramebuffer(gl.FRAMEBUFFER, null);
    }
    function sampleTrail(x, y, ch) {
        var ix = ((x | 0) % trailW + trailW) % trailW;
        var iy = ((y | 0) % trailH + trailH) % trailH;
        return trailData[(iy * trailW + ix) * 4 + ch];
    }

    var uploadPos = null;
    function updateAgents() {
        var n = config.numAgents;
        var sa = config.sensorAngle * 0.0174533, sd = config.sensorDistance;
        var ra = config.rotationAngle * 0.0174533, ss = config.stepSize;
        var multi = config.multiSpecies, tw = trailW, th = trailH;
        if (!uploadPos || uploadPos.length !== n * 2) uploadPos = new Float32Array(n * 2);
        readTrailData();
        for (var i = 0; i < n; i++) {
            var px = agentX[i], py = agentY[i], ang = agentAngle[i];
            var sp = agentSpecies[i] | 0;
            var saA = sa, sdA = sd, raA = ra;
            if (multi && sp < 3) {
                saA = (config.sensorAngle + speciesOffsets[sp].saOff) * 0.0174533;
                sdA = Math.max(1, sd + speciesOffsets[sp].sdOff);
                raA = Math.max(0.02, (config.rotationAngle + speciesOffsets[sp].raOff) * 0.0174533);
            }
            var ch = multi ? sp : 0;
            var cosL = Math.cos(ang + saA), sinL = Math.sin(ang + saA);
            var cosF = Math.cos(ang), sinF = Math.sin(ang);
            var cosR = Math.cos(ang - saA), sinR = Math.sin(ang - saA);
            var sL = sampleTrail(px + cosL * sdA, py + sinL * sdA, ch);
            var sF = sampleTrail(px + cosF * sdA, py + sinF * sdA, ch);
            var sR = sampleTrail(px + cosR * sdA, py + sinR * sdA, ch);
            if (multi) {
                for (var oc = 0; oc < 3; oc++) {
                    if (oc === ch) continue;
                    sL -= sampleTrail(px + cosL * sdA, py + sinL * sdA, oc) * 0.5;
                    sF -= sampleTrail(px + cosF * sdA, py + sinF * sdA, oc) * 0.5;
                    sR -= sampleTrail(px + cosR * sdA, py + sinR * sdA, oc) * 0.5;
                }
            }
            if (sF > sL && sF > sR) { /* straight */ }
            else if (sF < sL && sF < sR) { ang += (Math.random() < 0.5 ? raA : -raA); }
            else if (sL < sR) { ang -= raA; }
            else if (sR < sL) { ang += raA; }
            else { ang += (Math.random() - 0.5) * raA * 0.3; }
            px += Math.cos(ang) * ss;
            py += Math.sin(ang) * ss;
            if (px < 0) { px = 0; ang = 3.14159265 - ang; }
            else if (px >= tw) { px = tw - 1; ang = 3.14159265 - ang; }
            if (py < 0) { py = 0; ang = -ang; }
            else if (py >= th) { py = th - 1; ang = -ang; }
            agentX[i] = px; agentY[i] = py; agentAngle[i] = ang;
            uploadPos[i * 2] = px; uploadPos[i * 2 + 1] = py;
        }
        gl.bindBuffer(gl.ARRAY_BUFFER, agentPosBuf);
        gl.bufferSubData(gl.ARRAY_BUFFER, 0, uploadPos);
        if (multi) {
            gl.bindBuffer(gl.ARRAY_BUFFER, agentSpeciesBuf);
            gl.bufferSubData(gl.ARRAY_BUFFER, 0, agentSpecies);
        }
    }

    function depositPass() {
        gl.bindFramebuffer(gl.FRAMEBUFFER, trailFBO[currentTrail].fb);
        gl.viewport(0, 0, trailW, trailH);
        gl.useProgram(progDep);
        gl.uniform2f(uDep.u_resolution, trailW, trailH);
        gl.uniform1f(uDep.u_deposit, config.depositAmount);
        gl.uniform1i(uDep.u_multi, config.multiSpecies ? 1 : 0);
        gl.enable(gl.BLEND); gl.blendFunc(gl.ONE, gl.ONE);
        gl.bindVertexArray(depositVAO);
        gl.drawArrays(gl.POINTS, 0, config.numAgents);
        gl.bindVertexArray(null);
        gl.disable(gl.BLEND);
    }

    function diffuseDecayPass() {
        var next = 1 - currentTrail;
        gl.bindFramebuffer(gl.FRAMEBUFFER, trailFBO[next].fb);
        gl.viewport(0, 0, trailW, trailH);
        gl.useProgram(progDiff);
        gl.activeTexture(gl.TEXTURE0);
        gl.bindTexture(gl.TEXTURE_2D, trailFBO[currentTrail].tex);
        gl.uniform1i(uDiff.u_trail, 0);
        gl.uniform2f(uDiff.u_texel, 1.0 / trailW, 1.0 / trailH);
        gl.uniform1f(uDiff.u_decay, config.decayRate);
        gl.uniform1f(uDiff.u_diffuse, config.diffuseRate);
        drawQuad();
        currentTrail = next;
    }

    function bloomPass() {
        gl.bindFramebuffer(gl.FRAMEBUFFER, bloomFBO[0].fb);
        gl.viewport(0, 0, bloomW, bloomH);
        gl.useProgram(progBTh);
        gl.activeTexture(gl.TEXTURE0);
        gl.bindTexture(gl.TEXTURE_2D, trailFBO[currentTrail].tex);
        gl.uniform1i(uBTh.u_tex, 0);
        drawQuad();
        gl.useProgram(progBl);
        gl.bindFramebuffer(gl.FRAMEBUFFER, bloomFBO[1].fb);
        gl.activeTexture(gl.TEXTURE0);
        gl.bindTexture(gl.TEXTURE_2D, bloomFBO[0].tex);
        gl.uniform1i(uBl.u_tex, 0);
        gl.uniform2f(uBl.u_dir, 1.0 / bloomW, 0);
        drawQuad();
        gl.bindFramebuffer(gl.FRAMEBUFFER, bloomFBO[0].fb);
        gl.bindTexture(gl.TEXTURE_2D, bloomFBO[1].tex);
        gl.uniform2f(uBl.u_dir, 0, 1.0 / bloomH);
        drawQuad();
        gl.bindFramebuffer(gl.FRAMEBUFFER, bloomFBO[1].fb);
        gl.bindTexture(gl.TEXTURE_2D, bloomFBO[0].tex);
        gl.uniform2f(uBl.u_dir, 2.0 / bloomW, 0);
        drawQuad();
        gl.bindFramebuffer(gl.FRAMEBUFFER, bloomFBO[0].fb);
        gl.bindTexture(gl.TEXTURE_2D, bloomFBO[1].tex);
        gl.uniform2f(uBl.u_dir, 0, 2.0 / bloomH);
        drawQuad();
    }

    function compositePass() {
        gl.bindFramebuffer(gl.FRAMEBUFFER, null);
        gl.viewport(0, 0, width, height);
        gl.useProgram(progComp);
        gl.activeTexture(gl.TEXTURE0);
        gl.bindTexture(gl.TEXTURE_2D, trailFBO[currentTrail].tex);
        gl.uniform1i(uComp.u_trail, 0);
        gl.activeTexture(gl.TEXTURE1);
        gl.bindTexture(gl.TEXTURE_2D, bloomFBO[0].tex);
        gl.uniform1i(uComp.u_bloom, 1);
        gl.uniform1f(uComp.u_bloomStr, config.bloomStrength);
        gl.uniform1i(uComp.u_multi, config.multiSpecies ? 1 : 0);
        drawQuad();
    }

    function stampTrail(px, py, radius, strength) {
        var next = 1 - currentTrail;
        gl.bindFramebuffer(gl.FRAMEBUFFER, trailFBO[next].fb);
        gl.viewport(0, 0, trailW, trailH);
        gl.useProgram(progSt);
        gl.activeTexture(gl.TEXTURE0);
        gl.bindTexture(gl.TEXTURE_2D, trailFBO[currentTrail].tex);
        gl.uniform1i(uSt.u_trail, 0);
        gl.uniform2f(uSt.u_pos, px, py);
        gl.uniform2f(uSt.u_res, trailW, trailH);
        gl.uniform1f(uSt.u_radius, radius);
        gl.uniform1f(uSt.u_strength, strength);
        drawQuad();
        currentTrail = next;
    }

    var mouseTrailX = -1, mouseTrailY = -1;
    function canvasToTrail(cx, cy) {
        return [cx * trailW / window.innerWidth, (window.innerHeight - cy) * trailH / window.innerHeight];
    }
    canvas.addEventListener('contextmenu', function(e) { e.preventDefault(); });
    canvas.addEventListener('click', function(e) {
        if (e.button !== 0) return;
        var p = canvasToTrail(e.clientX, e.clientY);
        stampTrail(p[0], p[1], 40, 0.8);
    });
    canvas.addEventListener('mousedown', function(e) {
        if (e.button === 2) { e.preventDefault(); var p = canvasToTrail(e.clientX, e.clientY); stampTrail(p[0], p[1], 50, -0.6); }
    });
    canvas.addEventListener('mousemove', function(e) {
        var p = canvasToTrail(e.clientX, e.clientY);
        mouseTrailX = p[0]; mouseTrailY = p[1];
    });
    canvas.addEventListener('mouseleave', function() { mouseTrailX = -1; mouseTrailY = -1; });

    function $(id) { return document.getElementById(id); }
    function wireSlider(id, valId, key, fmt) {
        var el = $(id), ve = $(valId);
        el.addEventListener('input', function() { var v = parseFloat(el.value); config[key] = v; ve.textContent = fmt ? fmt(v) : v; });
    }
    function syncUI() {
        $('s-count').value = config.numAgents;
        $('v-count').textContent = (config.numAgents / 1000).toFixed(0) + 'K';
        $('s-sa').value = config.sensorAngle; $('v-sa').textContent = config.sensorAngle.toFixed(1);
        $('s-sd').value = config.sensorDistance; $('v-sd').textContent = config.sensorDistance.toFixed(0);
        $('s-ra').value = config.rotationAngle; $('v-ra').textContent = config.rotationAngle.toFixed(1);
        $('s-ss').value = config.stepSize; $('v-ss').textContent = config.stepSize.toFixed(1);
        $('s-dep').value = config.depositAmount; $('v-dep').textContent = config.depositAmount.toFixed(1);
        $('s-decay').value = config.decayRate; $('v-decay').textContent = config.decayRate.toFixed(3);
        $('s-diff').value = config.diffuseRate; $('v-diff').textContent = config.diffuseRate.toFixed(2);
        $('s-bloom').value = config.bloomStrength; $('v-bloom').textContent = config.bloomStrength.toFixed(2);
        var mt = $('t-multi');
        if (config.multiSpecies) mt.classList.add('on'); else mt.classList.remove('on');
    }
    function setupUI() {
        wireSlider('s-sa','v-sa','sensorAngle',function(v){return v.toFixed(1);});
        wireSlider('s-sd','v-sd','sensorDistance',function(v){return v.toFixed(0);});
        wireSlider('s-ra','v-ra','rotationAngle',function(v){return v.toFixed(1);});
        wireSlider('s-ss','v-ss','stepSize',function(v){return v.toFixed(1);});
        wireSlider('s-dep','v-dep','depositAmount',function(v){return v.toFixed(1);});
        wireSlider('s-decay','v-decay','decayRate',function(v){return v.toFixed(3);});
        wireSlider('s-diff','v-diff','diffuseRate',function(v){return v.toFixed(2);});
        wireSlider('s-bloom','v-bloom','bloomStrength',function(v){return v.toFixed(2);});
        $('s-count').addEventListener('change', function() {
            var v = parseInt(this.value);
            $('v-count').textContent = (v / 1000).toFixed(0) + 'K';
            initAgents(v); $('agent-count').textContent = v.toLocaleString();
        });
        $('s-count').addEventListener('input', function() {
            $('v-count').textContent = (parseInt(this.value) / 1000).toFixed(0) + 'K';
        });
        $('t-multi').addEventListener('click', function() {
            config.multiSpecies = !config.multiSpecies;
            this.classList.toggle('on');
            for (var i = 0; i < config.numAgents; i++) agentSpecies[i] = config.multiSpecies ? (i % 3) : 0;
            clearTrails();
        });
        var presetBtns = document.querySelectorAll('.preset-btn');
        presetBtns.forEach(function(btn) {
            btn.addEventListener('click', function() {
                applyPreset(this.getAttribute('data-preset'));
                presetBtns.forEach(function(b) { b.classList.remove('active'); });
                this.classList.add('active');
            });
        });
        $('btn-reset').addEventListener('click', resetSim);
        $('btn-clear').addEventListener('click', clearTrails);
        $('btn-pause').addEventListener('click', function() {
            config.paused = !config.paused;
            this.textContent = config.paused ? 'Resume' : 'Pause';
        });
        $('toggle-btn').addEventListener('click', function() { $('panel').classList.toggle('hidden'); });
        syncUI();
    }
    function applyPreset(name) {
        var p = presets[name]; if (!p) return;
        for (var k in p) config[k] = p[k]; syncUI();
    }
    function clearTrails() {
        for (var i = 0; i < 2; i++) {
            gl.bindFramebuffer(gl.FRAMEBUFFER, trailFBO[i].fb);
            gl.clearColor(0,0,0,1); gl.clear(gl.COLOR_BUFFER_BIT);
        }
        gl.bindFramebuffer(gl.FRAMEBUFFER, null);
    }
    function resetSim() {
        clearTrails(); initAgents(config.numAgents);
        $('agent-count').textContent = config.numAgents.toLocaleString();
    }

    document.addEventListener('keydown', function(e) {
        if (e.target.tagName === 'INPUT') return;
        var key = e.key.toLowerCase();
        if (key === 'h') $('panel').classList.toggle('hidden');
        else if (key === ' ') { e.preventDefault(); config.paused = !config.paused; $('btn-pause').textContent = config.paused ? 'Resume' : 'Pause'; }
        else if (key === 'r') resetSim();
        else if (key === 'c') clearTrails();
        else if (key === 'm') $('t-multi').click();
        else if (key === '1') document.querySelector('[data-preset="classic"]').click();
        else if (key === '2') document.querySelector('[data-preset="neural"]').click();
        else if (key === '3') document.querySelector('[data-preset="vascular"]').click();
        else if (key === '4') document.querySelector('[data-preset="maze"]').click();
    });

    var frameCount = 0, fpsTime = 0;
    function frame(time) {
        requestAnimationFrame(frame);
        frameCount++;
        if (time - fpsTime >= 1000) { $('fps').textContent = frameCount; frameCount = 0; fpsTime = time; }
        if (config.paused) return;
        if (mouseTrailX >= 0 && mouseTrailY >= 0) stampTrail(mouseTrailX, mouseTrailY, 15, 0.15);
        updateAgents();
        depositPass();
        diffuseDecayPass();
        bloomPass();
        compositePass();
    }

    function init() {
        resize(); initQuad(); initPrograms(); createTrailFBOs();
        initAgents(config.numAgents); setupUI();
        $('agent-count').textContent = config.numAgents.toLocaleString();
        $('loading').style.display = 'none';
        requestAnimationFrame(frame);
    }
    window.addEventListener('resize', function() { resize(); createTrailFBOs(); initAgents(config.numAgents); });
    try { init(); } catch(e) {
        $('loading').style.display = 'none';
        $('error').style.display = 'block';
        $('error-msg').textContent = e.message;
        console.error(e);
    }
    })();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>