<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Belousov-Zhabotinsky Reaction - Oregonator Model</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Space+Mono:wght@400;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #06080f;
            --bg-secondary: #0c1120;
            --glass-border: rgba(100, 130, 255, 0.15);
            --glass-bg: rgba(15, 22, 45, 0.65);
            --text-primary: #d8ddf0;
            --text-secondary: #8090b8;
            --text-accent: #fbbf24;
            --theme-color: #667eea;
            --theme-glow: rgba(102, 126, 234, 0.3);
            --font-display: 'Orbitron', sans-serif;
            --font-mono: 'Space Mono', monospace;
            --font-body: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-body); background: var(--bg-primary); color: var(--text-primary); overflow-x: hidden; min-height: 100vh; }
        .back-link { position: fixed; top: 16px; left: 16px; z-index: 10000; display: inline-flex; align-items: center; gap: 0.4rem; color: var(--text-secondary); text-decoration: none; font-family: var(--font-body); font-weight: 500; font-size: 0.85rem; padding: 0.45rem 0.9rem; background: var(--glass-bg); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border-radius: 12px; border: 1px solid var(--glass-border); transition: all 0.3s ease; }
        .back-link:hover { color: var(--text-primary); transform: translateX(-3px); border-color: var(--theme-color); box-shadow: 0 0 20px var(--theme-glow); }
        .header { text-align: center; padding: 20px 20px 10px; }
        .header h1 { font-family: var(--font-display); font-size: clamp(1.4rem, 3vw, 2.2rem); font-weight: 700; background: linear-gradient(135deg, #667eea 0%, #fbbf24 50%, #667eea 100%); background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: shimmer 4s ease-in-out infinite; }
        @keyframes shimmer { 0%, 100% { background-position: 0% center; } 50% { background-position: 200% center; } }
        .header .subtitle { color: var(--text-secondary); font-size: 0.9rem; margin-top: 4px; font-weight: 300; }
        .main-layout { display: flex; height: calc(100vh - 90px); gap: 0; }
        .control-panel { width: 310px; min-width: 310px; height: 100%; overflow-y: auto; padding: 14px; background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-right: 1px solid var(--glass-border); scrollbar-width: thin; scrollbar-color: rgba(102,126,234,0.3) transparent; }
        .control-panel::-webkit-scrollbar { width: 5px; }
        .control-panel::-webkit-scrollbar-track { background: transparent; }
        .control-panel::-webkit-scrollbar-thumb { background: rgba(102,126,234,0.3); border-radius: 3px; }
        .panel-section { margin-bottom: 16px; padding: 12px; background: rgba(10, 15, 30, 0.5); border-radius: 12px; border: 1px solid rgba(100, 130, 255, 0.08); }
        .panel-section h3 { font-family: var(--font-display); font-size: 0.65rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--theme-color); margin-bottom: 10px; padding-bottom: 6px; border-bottom: 1px solid rgba(100, 130, 255, 0.1); }
        .control-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .control-row label { font-size: 0.75rem; color: var(--text-secondary); font-weight: 400; flex-shrink: 0; }
        .control-row .val { font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-accent); min-width: 45px; text-align: right; }
        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 4px; background: rgba(100, 130, 255, 0.15); border-radius: 2px; outline: none; margin: 4px 0; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 14px; height: 14px; border-radius: 50%; background: var(--theme-color); cursor: pointer; box-shadow: 0 0 8px var(--theme-glow); }
        input[type="range"]::-moz-range-thumb { width: 14px; height: 14px; border-radius: 50%; background: var(--theme-color); cursor: pointer; border: none; }
        select { width: 100%; padding: 6px 8px; background: rgba(10, 15, 30, 0.8); border: 1px solid rgba(100, 130, 255, 0.15); border-radius: 6px; color: var(--text-primary); font-family: var(--font-body); font-size: 0.8rem; cursor: pointer; outline: none; }
        select:focus { border-color: var(--theme-color); }
        select option { background: #0c1120; }
        .btn-row { display: flex; gap: 6px; flex-wrap: wrap; }
        .btn { flex: 1; min-width: 60px; padding: 7px 10px; border: 1px solid rgba(100, 130, 255, 0.2); border-radius: 8px; background: rgba(102, 126, 234, 0.1); color: var(--text-primary); font-family: var(--font-body); font-size: 0.75rem; font-weight: 500; cursor: pointer; transition: all 0.2s; text-align: center; }
        .btn:hover { background: rgba(102, 126, 234, 0.25); border-color: var(--theme-color); box-shadow: 0 0 12px var(--theme-glow); }
        .btn.active { background: linear-gradient(135deg, rgba(102,126,234,0.4), rgba(251,191,36,0.2)); border-color: var(--theme-color); }
        .btn-preset { font-size: 0.7rem; padding: 5px 8px; }
        .preset-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .color-btn-row { display: flex; gap: 4px; }
        .color-btn { flex: 1; padding: 4px; border: 1px solid rgba(100, 130, 255, 0.15); border-radius: 6px; background: transparent; cursor: pointer; transition: all 0.2s; height: 24px; }
        .color-btn.active { border-color: #fff; box-shadow: 0 0 8px rgba(255,255,255,0.3); }
        .color-btn.chemical { background: linear-gradient(90deg, #0a1628, #1a5276, #f39c12, #c0392b); }
        .color-btn.neon { background: linear-gradient(90deg, #000, #0ff, #f0f, #ff0); }
        .color-btn.thermal { background: linear-gradient(90deg, #000, #300080, #ff0000, #ffff00, #fff); }
        .color-btn.ocean { background: linear-gradient(90deg, #001428, #006994, #00b4d8, #90e0ef, #caf0f8); }
        .kbd { display: inline-block; padding: 1px 5px; font-family: var(--font-mono); font-size: 0.6rem; color: var(--text-secondary); background: rgba(100, 130, 255, 0.08); border: 1px solid rgba(100, 130, 255, 0.15); border-radius: 3px; margin-left: 4px; }
        .canvas-area { flex: 1; display: flex; flex-direction: column; min-width: 0; position: relative; }
        .canvas-wrapper { flex: 1; display: flex; align-items: center; justify-content: center; padding: 8px; position: relative; min-height: 0; }
        #simCanvas { background: #000; border-radius: 6px; box-shadow: 0 0 40px rgba(0, 0, 0, 0.8); cursor: crosshair; image-rendering: pixelated; }
        .graphs-bar { height: 140px; min-height: 140px; display: flex; gap: 1px; background: rgba(0, 0, 0, 0.4); border-top: 1px solid var(--glass-border); }
        .graph-container { flex: 1; position: relative; overflow: hidden; }
        .graph-container canvas { width: 100%; height: 100%; }
        .graph-label { position: absolute; top: 4px; left: 8px; font-family: var(--font-mono); font-size: 0.6rem; color: var(--text-secondary); pointer-events: none; z-index: 2; }
        .stats-overlay { position: absolute; top: 12px; right: 12px; font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-secondary); background: rgba(6, 8, 15, 0.7); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(100, 130, 255, 0.1); line-height: 1.6; pointer-events: none; z-index: 5; }
        .stats-overlay .val { color: var(--text-accent); }
        .probe-marker { position: absolute; width: 10px; height: 10px; border: 2px solid #fff; border-radius: 50%; pointer-events: none; z-index: 10; box-shadow: 0 0 6px rgba(255, 255, 255, 0.5); transform: translate(-50%, -50%); display: none; }
        .slice-line { position: absolute; left: 0; right: 0; height: 1px; background: rgba(255, 255, 255, 0.3); pointer-events: none; z-index: 4; display: none; }
        .help-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px); z-index: 20000; display: none; align-items: center; justify-content: center; }
        .help-overlay.visible { display: flex; }
        .help-content { background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 16px; padding: 30px; max-width: 500px; width: 90%; }
        .help-content h2 { font-family: var(--font-display); font-size: 1rem; color: var(--theme-color); margin-bottom: 16px; }
        .help-content table { width: 100%; border-collapse: collapse; }
        .help-content td { padding: 4px 8px; font-size: 0.85rem; border-bottom: 1px solid rgba(100, 130, 255, 0.05); }
        .help-content td:first-child { font-family: var(--font-mono); color: var(--text-accent); width: 100px; }
        @media (max-width: 900px) { .main-layout { flex-direction: column; height: auto; } .control-panel { width: 100%; min-width: unset; height: auto; max-height: 300px; border-right: none; border-bottom: 1px solid var(--glass-border); } .canvas-wrapper { min-height: 50vh; } .graphs-bar { height: 120px; min-height: 120px; } }
    </style>
</head>
<body>
<a href="../index.html" class="back-link"><span>&#8592;</span><span>Gallery</span></a>
<div class="header">
    <h1>Belousov-Zhabotinsky Reaction</h1>
    <p class="subtitle">Oregonator Model &mdash; Reaction-Diffusion PDE Simulation &nbsp;|&nbsp; Press <strong>H</strong> for help</p>
</div>
<div class="main-layout">
    <div class="control-panel">
        <div class="panel-section">
            <h3>Simulation</h3>
            <div class="btn-row" style="margin-bottom:8px;">
                <button class="btn" id="btnPlay" onclick="togglePause()">&#9654; Play <span class="kbd">Space</span></button>
                <button class="btn" id="btnReset" onclick="resetSim()">Reset <span class="kbd">R</span></button>
            </div>
            <div class="control-row"><label>Steps / frame</label><span class="val" id="valSteps">4</span></div>
            <input type="range" id="sliderSteps" min="1" max="20" step="1" value="4">
        </div>
        <div class="panel-section">
            <h3>Presets</h3>
            <div class="preset-grid">
                <button class="btn btn-preset" onclick="applyPreset('spirals')">Spirals <span class="kbd">1</span></button>
                <button class="btn btn-preset" onclick="applyPreset('target')">Target <span class="kbd">2</span></button>
                <button class="btn btn-preset" onclick="applyPreset('turbulent')">Turbulent <span class="kbd">3</span></button>
                <button class="btn btn-preset" onclick="applyPreset('scroll')">Scroll <span class="kbd">4</span></button>
            </div>
        </div>
        <div class="panel-section">
            <h3>Oregonator Parameters</h3>
            <div class="control-row"><label>&epsilon; (timescale)</label><span class="val" id="valEps">0.030</span></div>
            <input type="range" id="sliderEps" min="0.005" max="0.12" step="0.001" value="0.03">
            <div class="control-row"><label>f (stoichiometry)</label><span class="val" id="valF">1.400</span></div>
            <input type="range" id="sliderF" min="0.5" max="3.5" step="0.01" value="1.4">
            <div class="control-row"><label>q (scaling)</label><span class="val" id="valQ">0.002</span></div>
            <input type="range" id="sliderQ" min="0.0005" max="0.02" step="0.0001" value="0.002">
        </div>
        <div class="panel-section">
            <h3>Diffusion</h3>
            <div class="control-row"><label>D<sub>u</sub> (HBrO&#8322;)</label><span class="val" id="valDu">1.000</span></div>
            <input type="range" id="sliderDu" min="0.1" max="3.0" step="0.01" value="1.0">
            <div class="control-row"><label>D<sub>v</sub> (Br&#8315;)</label><span class="val" id="valDv">0.600</span></div>
            <input type="range" id="sliderDv" min="0.0" max="2.0" step="0.01" value="0.6">
            <div class="control-row"><label>D<sub>w</sub> (Ce&#8308;&#8314;)</label><span class="val" id="valDw">0.000</span></div>
            <input type="range" id="sliderDw" min="0.0" max="1.0" step="0.01" value="0.0">
            <div class="control-row"><label>dt</label><span class="val" id="valDt">0.020</span></div>
            <input type="range" id="sliderDt" min="0.005" max="0.06" step="0.001" value="0.02">
        </div>
        <div class="panel-section">
            <h3>Grid</h3>
            <div class="control-row"><label>Resolution</label></div>
            <select id="selGrid" onchange="changeGrid()">
                <option value="128">128 x 128</option>
                <option value="200" selected>200 x 200</option>
                <option value="256">256 x 256</option>
                <option value="300">300 x 300</option>
                <option value="400">400 x 400 (heavy)</option>
            </select>
        </div>
        <div class="panel-section">
            <h3>Color Scheme <span class="kbd">C</span></h3>
            <div class="color-btn-row">
                <button class="color-btn chemical active" onclick="setColorScheme(0)" title="Chemical"></button>
                <button class="color-btn neon" onclick="setColorScheme(1)" title="Neon"></button>
                <button class="color-btn thermal" onclick="setColorScheme(2)" title="Thermal"></button>
                <button class="color-btn ocean" onclick="setColorScheme(3)" title="Ocean"></button>
            </div>
            <div class="control-row" style="margin-top:8px;"><label>Display variable</label></div>
            <select id="selDisplay">
                <option value="u">u (HBrO2)</option>
                <option value="v">v (Br-)</option>
                <option value="w" selected>w (Ce4+)</option>
                <option value="composite">Composite</option>
            </select>
        </div>
        <div class="panel-section">
            <h3>Interaction</h3>
            <div style="font-size:0.72rem; color:var(--text-secondary); line-height:1.5;">
                <strong>Left-click / drag:</strong> nucleate wave<br>
                <strong>Right-click:</strong> place barrier<br>
                <strong>Middle-click:</strong> set probe point<br>
                <strong>Shift+click:</strong> clear barriers
            </div>
            <div class="control-row" style="margin-top:8px;"><label>Brush size</label><span class="val" id="valBrush">8</span></div>
            <input type="range" id="sliderBrush" min="2" max="30" step="1" value="8">
        </div>
        <div class="panel-section">
            <h3>Analysis</h3>
            <div class="control-row"><label>Cross-section Y</label><span class="val" id="valSlice">50%</span></div>
            <input type="range" id="sliderSlice" min="0" max="100" step="1" value="50">
        </div>
    </div>
    <div class="canvas-area">
        <div class="canvas-wrapper" id="canvasWrapper">
            <canvas id="simCanvas"></canvas>
            <div class="stats-overlay" id="statsOverlay">
                FPS: <span class="val" id="statFps">0</span><br>
                Frame: <span class="val" id="statFrame">0</span><br>
                Avg u: <span class="val" id="statAvgU">0</span>
            </div>
            <div class="probe-marker" id="probeMarker"></div>
            <div class="slice-line" id="sliceLine"></div>
        </div>
        <div class="graphs-bar">
            <div class="graph-container">
                <span class="graph-label">Cross-Section Concentrations</span>
                <canvas id="graphCross"></canvas>
            </div>
            <div class="graph-container">
                <span class="graph-label">Probe Time Series</span>
                <canvas id="graphTime"></canvas>
            </div>
        </div>
    </div>
</div>
<div class="help-overlay" id="helpOverlay" onclick="this.classList.remove('visible')">
    <div class="help-content" onclick="event.stopPropagation()">
        <h2>Keyboard Shortcuts</h2>
        <table>
            <tr><td>Space</td><td>Pause / Resume</td></tr>
            <tr><td>R</td><td>Reset simulation</td></tr>
            <tr><td>1</td><td>Preset: Classic Spirals</td></tr>
            <tr><td>2</td><td>Preset: Target Waves</td></tr>
            <tr><td>3</td><td>Preset: Turbulent</td></tr>
            <tr><td>4</td><td>Preset: Scroll Waves</td></tr>
            <tr><td>C</td><td>Cycle color scheme</td></tr>
            <tr><td>H</td><td>Toggle this help</td></tr>
        </table>
        <h2 style="margin-top:16px;">Mouse</h2>
        <table>
            <tr><td>Left-click</td><td>Nucleate spiral wave</td></tr>
            <tr><td>Drag</td><td>Paint perturbations</td></tr>
            <tr><td>Right-click</td><td>Place barrier (blocks diffusion)</td></tr>
            <tr><td>Shift+click</td><td>Remove barriers in area</td></tr>
            <tr><td>Middle-click</td><td>Place probe for time series</td></tr>
        </table>
        <p style="margin-top:16px; font-size:0.8rem; color:var(--text-secondary);">Click outside to close.</p>
    </div>
</div>
<script>
/* ===== GLOBALS ===== */
var N = 200, paused = true, frameCount = 0, colorSchemeIdx = 0, animId = null;
var eps = 0.03, fParam = 1.4, qParam = 0.002;
var Du = 1.0, Dv = 0.6, Dw = 0.0, dt = 0.02;
var stepsPerFrame = 4, brushSize = 8, sliceFrac = 0.5;
var u, v, w, uNext, vNext, wNext, barrier;
var probeX = -1, probeY = -1, probeHistory = [], PROBE_MAX = 300;
var fpsFrames = 0, fpsLast = performance.now(), fpsVal = 0;
var simCanvas, simCtx, simImageData, crossCanvas, crossCtx, timeCanvas, timeCtx;
var colorLUT = new Uint8Array(256 * 3);

/* ===== GRID MANAGEMENT ===== */
function initGrids() {
    var t = N * N;
    u = new Float32Array(t); v = new Float32Array(t); w = new Float32Array(t);
    uNext = new Float32Array(t); vNext = new Float32Array(t); wNext = new Float32Array(t);
    barrier = new Uint8Array(t); probeHistory = [];
}
function clearGrids() {
    u.fill(0); v.fill(0); w.fill(0); barrier.fill(0);
    probeHistory = []; frameCount = 0;
}

/* ===== OREGONATOR 3-VARIABLE PDE ===== */
function stepSimulation() {
    var n = N, invEps = 1.0 / eps, _f = fParam, _q = qParam;
    var _Du = Du, _Dv = Dv, _Dw = Dw, _dt = dt, n2 = n * n;
    for (var idx = 0; idx < n2; idx++) {
        if (barrier[idx]) { uNext[idx] = 0; vNext[idx] = 0; wNext[idx] = 0; continue; }
        var i = (idx / n) | 0, j = idx - i * n;
        var iP = i + 1 < n ? i + 1 : 0, iM = i > 0 ? i - 1 : n - 1;
        var jP = j + 1 < n ? j + 1 : 0, jM = j > 0 ? j - 1 : n - 1;
        var idxUp = iM * n + j, idxDn = iP * n + j, idxLt = i * n + jM, idxRt = i * n + jP;
        var uC = u[idx], vC = v[idx], wC = w[idx];
        var bUp = barrier[idxUp], bDn = barrier[idxDn], bLt = barrier[idxLt], bRt = barrier[idxRt];
        var lapU = (bUp ? uC : u[idxUp]) + (bDn ? uC : u[idxDn]) + (bLt ? uC : u[idxLt]) + (bRt ? uC : u[idxRt]) - 4.0 * uC;
        var lapV = (bUp ? vC : v[idxUp]) + (bDn ? vC : v[idxDn]) + (bLt ? vC : v[idxLt]) + (bRt ? vC : v[idxRt]) - 4.0 * vC;
        var lapW = (bUp ? wC : w[idxUp]) + (bDn ? wC : w[idxDn]) + (bLt ? wC : w[idxLt]) + (bRt ? wC : w[idxRt]) - 4.0 * wC;
        var uq = uC + _q;
        var ru = invEps * (uC - uC * uC - _f * wC * (uC - _q) / (uq > 1e-12 ? uq : 1e-12));
        var rv = uC - vC;
        var rw = invEps * (uC - wC);
        uNext[idx] = uC + _dt * (ru + _Du * lapU);
        vNext[idx] = vC + _dt * (rv + _Dv * lapV);
        wNext[idx] = wC + _dt * (rw + _Dw * lapW);
        if (uNext[idx] < 0) uNext[idx] = 0; if (uNext[idx] > 1) uNext[idx] = 1;
        if (vNext[idx] < 0) vNext[idx] = 0; if (vNext[idx] > 1) vNext[idx] = 1;
        if (wNext[idx] < 0) wNext[idx] = 0; if (wNext[idx] > 1) wNext[idx] = 1;
    }
    var tmp;
    tmp = u; u = uNext; uNext = tmp;
    tmp = v; v = vNext; vNext = tmp;
    tmp = w; w = wNext; wNext = tmp;
}

/* ===== COLOR SCHEMES ===== */
function buildColorLUT(scheme) {
    for (var i = 0; i < 256; i++) {
        var t = i / 255.0, r, g, b, s;
        if (scheme === 0) {
            if (t < 0.2)      { s = t / 0.2;          r = 10 + s * 16;  g = 22 + s * 50;  b = 40 + s * 78; }
            else if (t < 0.45) { s = (t - 0.2) / 0.25; r = 26 + s * 14;  g = 72 + s * 78;  b = 118 + s * 22; }
            else if (t < 0.65) { s = (t - 0.45) / 0.2;  r = 40 + s * 203; g = 150 + s * 6;   b = 140 - s * 100; }
            else if (t < 0.85) { s = (t - 0.65) / 0.2;  r = 243 - s * 51; g = 156 - s * 96;  b = 40 - s * 20; }
            else               { s = (t - 0.85) / 0.15; r = 192 - s * 72; g = 60 - s * 30;   b = 20 + s * 10; }
        } else if (scheme === 1) {
            if (t < 0.25)      { s = t / 0.25;          r = 0;   g = s * 255; b = s * 255; }
            else if (t < 0.5)  { s = (t - 0.25) / 0.25; r = s * 255; g = 255 - s * 255; b = 255; }
            else if (t < 0.75) { s = (t - 0.5) / 0.25;  r = 255; g = s * 255; b = 255 - s * 255; }
            else               { s = (t - 0.75) / 0.25; r = 255; g = 255; b = s * 255; }
        } else if (scheme === 2) {
            if (t < 0.2)       { s = t / 0.2;           r = s * 48;  g = 0;       b = s * 128; }
            else if (t < 0.5)  { s = (t - 0.2) / 0.3;  r = 48 + s * 207; g = 0;  b = 128 - s * 128; }
            else if (t < 0.75) { s = (t - 0.5) / 0.25;  r = 255; g = s * 255; b = 0; }
            else               { s = (t - 0.75) / 0.25; r = 255; g = 255; b = s * 255; }
        } else {
            if (t < 0.25)      { s = t / 0.25;          r = s * 8;      g = 20 + s * 80;  b = 40 + s * 108; }
            else if (t < 0.5)  { s = (t - 0.25) / 0.25; r = 8 + s * 2;  g = 100 + s * 80; b = 148 + s * 64; }
            else if (t < 0.75) { s = (t - 0.5) / 0.25;  r = 10 + s * 134; g = 180 + s * 44; b = 212 + s * 18; }
            else               { s = (t - 0.75) / 0.25; r = 144 + s * 58; g = 224 + s * 16; b = 230 + s * 18; }
        }
        var off = i * 3;
        colorLUT[off] = Math.max(0, Math.min(255, r | 0));
        colorLUT[off + 1] = Math.max(0, Math.min(255, g | 0));
        colorLUT[off + 2] = Math.max(0, Math.min(255, b | 0));
    }
}
function setColorScheme(idx) {
    colorSchemeIdx = idx; buildColorLUT(idx);
    var btns = document.querySelectorAll('.color-btn');
    btns.forEach(function(b, i) { b.classList.toggle('active', i === idx); });
}

/* ===== RENDERING ===== */
function render() {
    var dispVar = document.getElementById('selDisplay').value;
    var data = simImageData.data, n2 = N * N;
    if (dispVar === 'composite') {
        for (var idx = 0; idx < n2; idx++) {
            var off = idx << 2;
            if (barrier[idx]) { data[off] = 60; data[off+1] = 50; data[off+2] = 40; data[off+3] = 255; }
            else { data[off] = (u[idx] * 255) | 0; data[off+1] = (w[idx] * 255) | 0; data[off+2] = (v[idx] * 200) | 0; data[off+3] = 255; }
        }
    } else {
        var src = dispVar === 'u' ? u : (dispVar === 'v' ? v : w);
        for (var idx = 0; idx < n2; idx++) {
            var off = idx << 2;
            if (barrier[idx]) { data[off] = 60; data[off+1] = 50; data[off+2] = 40; data[off+3] = 255; }
            else {
                var ci = (src[idx] * 255) | 0; if (ci < 0) ci = 0; if (ci > 255) ci = 255;
                var coff = ci * 3;
                data[off] = colorLUT[coff]; data[off+1] = colorLUT[coff+1]; data[off+2] = colorLUT[coff+2]; data[off+3] = 255;
            }
        }
    }
    simCtx.putImageData(simImageData, 0, 0);
}

/* ===== CROSS-SECTION GRAPH ===== */
function drawCrossSection() {
    var cw = crossCanvas.width, ch = crossCanvas.height;
    crossCtx.fillStyle = 'rgba(6,8,15,0.95)'; crossCtx.fillRect(0, 0, cw, ch);
    var row = (sliceFrac * (N - 1)) | 0; if (row < 0) row = 0; if (row >= N) row = N - 1;
    var offset = row * N, xScale = cw / N, pad = 12, plotH = ch - pad * 2;
    crossCtx.strokeStyle = 'rgba(100,130,255,0.06)'; crossCtx.lineWidth = 1;
    for (var g = 0; g <= 4; g++) { var gy = pad + plotH * (1 - g / 4); crossCtx.beginPath(); crossCtx.moveTo(0, gy); crossCtx.lineTo(cw, gy); crossCtx.stroke(); }
    var colors = ['#e74c3c', '#2ecc71', '#3498db'], arrs = [u, v, w];
    for (var c = 0; c < 3; c++) {
        crossCtx.strokeStyle = colors[c]; crossCtx.lineWidth = 1.5; crossCtx.beginPath();
        for (var j = 0; j < N; j++) { var x = j * xScale, y = pad + plotH * (1 - arrs[c][offset + j]); j === 0 ? crossCtx.moveTo(x, y) : crossCtx.lineTo(x, y); }
        crossCtx.stroke();
    }
    crossCtx.font = '10px "Space Mono",monospace';
    var labels = [{text:'u (HBrO2)',color:'#e74c3c',x:cw-200},{text:'v (Br-)',color:'#2ecc71',x:cw-130},{text:'w (Ce4+)',color:'#3498db',x:cw-60}];
    for (var li = 0; li < labels.length; li++) { crossCtx.fillStyle = labels[li].color; crossCtx.fillRect(labels[li].x, 6, 10, 3); crossCtx.fillText(labels[li].text, labels[li].x + 14, 12); }
}

/* ===== PROBE TIME SERIES ===== */
function updateProbeHistory() {
    if (probeX < 0 || probeY < 0) return;
    var idx = probeY * N + probeX; if (idx < 0 || idx >= N * N) return;
    probeHistory.push({ u: u[idx], v: v[idx], w: w[idx] });
    if (probeHistory.length > PROBE_MAX) probeHistory.shift();
}
function drawTimeSeries() {
    var cw = timeCanvas.width, ch = timeCanvas.height;
    timeCtx.fillStyle = 'rgba(6,8,15,0.95)'; timeCtx.fillRect(0, 0, cw, ch);
    if (probeHistory.length < 2) {
        timeCtx.fillStyle = 'rgba(128,144,184,0.4)'; timeCtx.font = '11px Inter,sans-serif';
        timeCtx.textAlign = 'center'; timeCtx.fillText('Middle-click canvas to place probe', cw / 2, ch / 2); timeCtx.textAlign = 'start'; return;
    }
    var pad = 12, plotH = ch - pad * 2, len = probeHistory.length, xScale = cw / (PROBE_MAX - 1);
    timeCtx.strokeStyle = 'rgba(100,130,255,0.06)'; timeCtx.lineWidth = 1;
    for (var g = 0; g <= 4; g++) { var gy = pad + plotH * (1 - g / 4); timeCtx.beginPath(); timeCtx.moveTo(0, gy); timeCtx.lineTo(cw, gy); timeCtx.stroke(); }
    var startX = (PROBE_MAX - len) * xScale;
    var colors = ['#e74c3c', '#2ecc71', '#3498db'], keys = ['u', 'v', 'w'];
    for (var c = 0; c < 3; c++) {
        timeCtx.strokeStyle = colors[c]; timeCtx.lineWidth = 1.5; timeCtx.beginPath();
        for (var k = 0; k < len; k++) { var x = startX + k * xScale, y = pad + plotH * (1 - probeHistory[k][keys[c]]); k === 0 ? timeCtx.moveTo(x, y) : timeCtx.lineTo(x, y); }
        timeCtx.stroke();
    }
}

/* ===== PERTURBATION & BARRIERS ===== */
function addPerturbation(gx, gy, radius) {
    var r = radius || brushSize;
    for (var di = -r; di <= r; di++) { for (var dj = -r; dj <= r; dj++) {
        var dist = Math.sqrt(di * di + dj * dj); if (dist > r) continue;
        var ni = (gy + di + N) % N, nj = (gx + dj + N) % N, idx = ni * N + nj;
        if (barrier[idx]) continue; var strength = 1.0 - dist / r;
        u[idx] = Math.min(1.0, u[idx] + 0.9 * strength); w[idx] = Math.max(0.0, w[idx] - 0.2 * strength);
    }}
}
function addBarrier(gx, gy, radius) {
    var r = radius || brushSize;
    for (var di = -r; di <= r; di++) { for (var dj = -r; dj <= r; dj++) {
        if (di * di + dj * dj > r * r) continue;
        barrier[((gy + di + N) % N) * N + ((gx + dj + N) % N)] = 1;
    }}
}
function removeBarrier(gx, gy, radius) {
    var r = (radius || brushSize) + 4;
    for (var di = -r; di <= r; di++) { for (var dj = -r; dj <= r; dj++) {
        if (di * di + dj * dj > r * r) continue;
        barrier[((gy + di + N) % N) * N + ((gx + dj + N) % N)] = 0;
    }}
}

/* ===== PRESETS ===== */
var presets = {
    spirals:   { eps: 0.03, f: 1.4, q: 0.002, Du: 1.0, Dv: 0.6, Dw: 0.0, dt: 0.02,  steps: 4 },
    target:    { eps: 0.05, f: 1.0, q: 0.002, Du: 1.0, Dv: 0.5, Dw: 0.0, dt: 0.02,  steps: 4 },
    turbulent: { eps: 0.01, f: 2.5, q: 0.001, Du: 1.0, Dv: 0.4, Dw: 0.0, dt: 0.015, steps: 6 },
    scroll:    { eps: 0.04, f: 1.2, q: 0.003, Du: 1.2, Dv: 0.8, Dw: 0.1, dt: 0.018, steps: 5 }
};
function applyPreset(name) {
    var p = presets[name]; if (!p) return;
    eps = p.eps; fParam = p.f; qParam = p.q; Du = p.Du; Dv = p.Dv; Dw = p.Dw; dt = p.dt; stepsPerFrame = p.steps;
    document.getElementById('sliderEps').value = eps;   document.getElementById('valEps').textContent = eps.toFixed(3);
    document.getElementById('sliderF').value = fParam;  document.getElementById('valF').textContent = fParam.toFixed(3);
    document.getElementById('sliderQ').value = qParam;  document.getElementById('valQ').textContent = qParam.toFixed(3);
    document.getElementById('sliderDu').value = Du;     document.getElementById('valDu').textContent = Du.toFixed(3);
    document.getElementById('sliderDv').value = Dv;     document.getElementById('valDv').textContent = Dv.toFixed(3);
    document.getElementById('sliderDw').value = Dw;     document.getElementById('valDw').textContent = Dw.toFixed(3);
    document.getElementById('sliderDt').value = dt;     document.getElementById('valDt').textContent = dt.toFixed(3);
    document.getElementById('sliderSteps').value = stepsPerFrame; document.getElementById('valSteps').textContent = stepsPerFrame;
    resetSim(); initPresetPattern(name);
    if (paused) { render(); drawCrossSection(); drawTimeSeries(); }
}
function initPresetPattern(name) {
    var n = N, cx = n >> 1, cy = n >> 1;
    if (name === 'spirals') {
        var ns = 2 + ((Math.random() * 2) | 0);
        for (var s = 0; s < ns; s++) {
            var sx = (Math.random() * n * 0.6 + n * 0.2) | 0, sy = (Math.random() * n * 0.6 + n * 0.2) | 0, rad = (n * 0.08) | 0;
            for (var di = -rad; di <= rad; di++) { for (var dj = -rad; dj <= rad; dj++) {
                var dist = Math.sqrt(di * di + dj * dj); if (dist > rad) continue;
                var angle = Math.atan2(dj, di), phase = (angle / (2 * Math.PI) + 0.5);
                var ni = (sy + di + n) % n, nj = (sx + dj + n) % n, idx = ni * n + nj;
                u[idx] = phase; v[idx] = 0.5 * (1 - phase); w[idx] = 1 - phase;
            }}
        }
        for (var i = 0; i < n * n; i++) { u[i] += (Math.random() - 0.5) * 0.02; if (u[i] < 0) u[i] = 0; if (u[i] > 1) u[i] = 1; }
    } else if (name === 'target') {
        var rad = (n * 0.04) | 0;
        for (var di = -rad; di <= rad; di++) { for (var dj = -rad; dj <= rad; dj++) {
            if (Math.sqrt(di * di + dj * dj) > rad) continue;
            var ni = (cy + di + n) % n, nj = (cx + dj + n) % n; u[ni * n + nj] = 0.9; w[ni * n + nj] = 0.1;
        }}
        var ox = cx + ((n * 0.25) | 0), oy = cy - ((n * 0.15) | 0), rad2 = (n * 0.03) | 0;
        for (var di = -rad2; di <= rad2; di++) { for (var dj = -rad2; dj <= rad2; dj++) {
            if (Math.sqrt(di * di + dj * dj) > rad2) continue;
            var ni = (oy + di + n) % n, nj = (ox + dj + n) % n; u[ni * n + nj] = 0.85; w[ni * n + nj] = 0.15;
        }}
    } else if (name === 'turbulent') {
        var np = 20 + ((Math.random() * 15) | 0);
        for (var p = 0; p < np; p++) {
            var px = (Math.random() * n) | 0, py = (Math.random() * n) | 0, pr = 3 + ((Math.random() * 6) | 0);
            for (var di = -pr; di <= pr; di++) { for (var dj = -pr; dj <= pr; dj++) {
                if (di * di + dj * dj > pr * pr) continue;
                var ni = (py + di + n) % n, nj = (px + dj + n) % n, idx = ni * n + nj;
                u[idx] = 0.5 + Math.random() * 0.5; v[idx] = Math.random() * 0.3; w[idx] = Math.random() * 0.5;
            }}
        }
        for (var i = 0; i < n * n; i++) { u[i] += (Math.random() - 0.5) * 0.15; w[i] += (Math.random() - 0.5) * 0.1; if (u[i] < 0) u[i] = 0; if (u[i] > 1) u[i] = 1; if (w[i] < 0) w[i] = 0; if (w[i] > 1) w[i] = 1; }
    } else if (name === 'scroll') {
        for (var i = 0; i < n; i++) { for (var j = 0; j < n; j++) {
            var idx = i * n + j, dx = j - cx, dy = i - cy;
            var dist = Math.sqrt(dx * dx + dy * dy), angle = Math.atan2(dy, dx);
            var rp = (dist / (n * 0.12)) % 1.0;
            if (angle > 0 && angle < Math.PI * 0.5 && dist < n * 0.35) { u[idx] = rp; w[idx] = 1 - rp; }
            else { u[idx] = Math.max(0, rp * 0.1 + (Math.random() - 0.5) * 0.02); w[idx] = Math.max(0, (1 - rp) * 0.1); }
        }}
    }
}

/* ===== RESET / SIZING ===== */
function resetSim() {
    initGrids(); clearGrids();
    simImageData = simCtx.createImageData(N, N);
    frameCount = 0; probeHistory = []; updateSliceLine();
}
function fitCanvas() {
    var wr = document.getElementById('canvasWrapper');
    var ww = wr.clientWidth - 16, wh = wr.clientHeight - 16, sz = Math.min(ww, wh);
    if (sz < 100) sz = 100;
    simCanvas.style.width = sz + 'px'; simCanvas.style.height = sz + 'px';
    simCanvas.width = N; simCanvas.height = N;
    simImageData = simCtx.createImageData(N, N);
}
function fitGraphCanvases() {
    var containers = document.querySelectorAll('.graph-container');
    containers.forEach(function(c) {
        var cv = c.querySelector('canvas'); if (!cv) return;
        var dpr = window.devicePixelRatio || 1;
        cv.width = c.clientWidth * dpr; cv.height = c.clientHeight * dpr;
        cv.style.width = c.clientWidth + 'px'; cv.style.height = c.clientHeight + 'px';
        cv.getContext('2d').scale(dpr, dpr);
    });
}
function updateSliceLine() {
    var wr = document.getElementById('canvasWrapper'), line = document.getElementById('sliceLine');
    var rect = simCanvas.getBoundingClientRect(), wrapRect = wr.getBoundingClientRect();
    line.style.display = 'block';
    line.style.top = (rect.top - wrapRect.top + sliceFrac * rect.height) + 'px';
    line.style.left = (rect.left - wrapRect.left) + 'px'; line.style.width = rect.width + 'px';
}

/* ===== MOUSE ===== */
var mouseDown = false, mouseButton = 0;
function getGridCoords(e) {
    var r = simCanvas.getBoundingClientRect();
    return { gx: (((e.clientX - r.left) / r.width) * N) | 0, gy: (((e.clientY - r.top) / r.height) * N) | 0 };
}
function onMouseDown(e) {
    e.preventDefault(); mouseDown = true; mouseButton = e.button;
    var c = getGridCoords(e);
    if (e.button === 1) { probeX = c.gx; probeY = c.gy; probeHistory = []; updateProbeMarker(); return; }
    if (e.shiftKey) removeBarrier(c.gx, c.gy, brushSize);
    else if (e.button === 2) addBarrier(c.gx, c.gy, brushSize);
    else if (e.button === 0) addPerturbation(c.gx, c.gy, brushSize);
    if (paused) render();
}
function onMouseMove(e) {
    if (!mouseDown) return; var c = getGridCoords(e);
    if (e.shiftKey) removeBarrier(c.gx, c.gy, brushSize);
    else if (mouseButton === 2) addBarrier(c.gx, c.gy, brushSize);
    else if (mouseButton === 0) addPerturbation(c.gx, c.gy, brushSize);
    if (paused) render();
}
function onMouseUp() { mouseDown = false; }
function updateProbeMarker() {
    var m = document.getElementById('probeMarker');
    if (probeX < 0 || probeY < 0) { m.style.display = 'none'; return; }
    var r = simCanvas.getBoundingClientRect(), wr = document.getElementById('canvasWrapper').getBoundingClientRect();
    m.style.display = 'block';
    m.style.left = (r.left - wr.left + (probeX / N) * r.width) + 'px';
    m.style.top = (r.top - wr.top + (probeY / N) * r.height) + 'px';
}

/* ===== KEYBOARD ===== */
function onKeyDown(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
    switch (e.key) {
        case ' ': e.preventDefault(); togglePause(); break;
        case 'r': case 'R': resetSim(); if (paused) { render(); drawCrossSection(); drawTimeSeries(); } break;
        case '1': applyPreset('spirals'); break;   case '2': applyPreset('target'); break;
        case '3': applyPreset('turbulent'); break; case '4': applyPreset('scroll'); break;
        case 'c': case 'C': setColorScheme((colorSchemeIdx + 1) % 4); if (paused) render(); break;
        case 'h': case 'H': document.getElementById('helpOverlay').classList.toggle('visible'); break;
    }
}

/* ===== PLAY/PAUSE, GRID CHANGE ===== */
function togglePause() {
    paused = !paused; var btn = document.getElementById('btnPlay');
    btn.innerHTML = paused ? '&#9654; Play <span class="kbd">Space</span>' : '&#9646;&#9646; Pause <span class="kbd">Space</span>';
    btn.classList.toggle('active', !paused);
}
function changeGrid() {
    N = parseInt(document.getElementById('selGrid').value);
    resetSim(); fitCanvas(); fitGraphCanvases();
    if (paused) { render(); drawCrossSection(); drawTimeSeries(); }
}

/* ===== SLIDER BINDING ===== */
function bindSlider(sid, vid, setter, fmt) {
    var sl = document.getElementById(sid), vl = document.getElementById(vid);
    sl.addEventListener('input', function() { var val = parseFloat(sl.value); setter(val); vl.textContent = fmt ? fmt(val) : val; });
}

/* ===== STATS ===== */
function updateStats() {
    fpsFrames++; var now = performance.now();
    if (now - fpsLast >= 500) { fpsVal = (fpsFrames / ((now - fpsLast) / 1000)) | 0; fpsFrames = 0; fpsLast = now; }
    document.getElementById('statFps').textContent = fpsVal;
    document.getElementById('statFrame').textContent = frameCount;
    if (frameCount % 10 === 0) { var sum = 0, n2 = N * N; for (var i = 0; i < n2; i++) sum += u[i]; document.getElementById('statAvgU').textContent = (sum / n2).toFixed(4); }
}

/* ===== MAIN LOOP ===== */
function mainLoop() {
    animId = requestAnimationFrame(mainLoop);
    if (!paused) {
        for (var s = 0; s < stepsPerFrame; s++) stepSimulation();
        frameCount += stepsPerFrame; updateProbeHistory();
        render(); drawCrossSection(); drawTimeSeries(); updateStats();
    }
}

/* ===== SETUP ===== */
function setup() {
    simCanvas = document.getElementById('simCanvas'); simCtx = simCanvas.getContext('2d');
    crossCanvas = document.getElementById('graphCross'); crossCtx = crossCanvas.getContext('2d');
    timeCanvas = document.getElementById('graphTime'); timeCtx = timeCanvas.getContext('2d');
    simCtx.imageSmoothingEnabled = false;
    initGrids(); clearGrids(); fitCanvas(); fitGraphCanvases();
    simImageData = simCtx.createImageData(N, N); buildColorLUT(0);

    bindSlider('sliderEps',   'valEps',   function(v) { eps = v; },          function(v) { return v.toFixed(3); });
    bindSlider('sliderF',     'valF',     function(v) { fParam = v; },       function(v) { return v.toFixed(3); });
    bindSlider('sliderQ',     'valQ',     function(v) { qParam = v; },       function(v) { return v.toFixed(3); });
    bindSlider('sliderDu',    'valDu',    function(v) { Du = v; },           function(v) { return v.toFixed(3); });
    bindSlider('sliderDv',    'valDv',    function(v) { Dv = v; },           function(v) { return v.toFixed(3); });
    bindSlider('sliderDw',    'valDw',    function(v) { Dw = v; },           function(v) { return v.toFixed(3); });
    bindSlider('sliderDt',    'valDt',    function(v) { dt = v; },           function(v) { return v.toFixed(3); });
    bindSlider('sliderSteps', 'valSteps', function(v) { stepsPerFrame = v | 0; }, function(v) { return (v | 0).toString(); });
    bindSlider('sliderBrush', 'valBrush', function(v) { brushSize = v | 0; },     function(v) { return (v | 0).toString(); });
    bindSlider('sliderSlice', 'valSlice', function(v) { sliceFrac = v / 100; updateSliceLine(); }, function(v) { return (v | 0) + '%'; });

    simCanvas.addEventListener('mousedown', onMouseDown);
    simCanvas.addEventListener('mousemove', onMouseMove);
    window.addEventListener('mouseup', onMouseUp);
    simCanvas.addEventListener('contextmenu', function(e) { e.preventDefault(); });
    window.addEventListener('keydown', onKeyDown);
    window.addEventListener('resize', function() { fitCanvas(); fitGraphCanvases(); updateSliceLine(); updateProbeMarker(); if (paused) { render(); drawCrossSection(); drawTimeSeries(); } });

    applyPreset('spirals');
    paused = true; togglePause(); /* auto-play */
    mainLoop();
    setTimeout(function() { updateSliceLine(); }, 100);
}
// Expose for enhance.js keyboard shortcuts
window.reset = resetSim;
window.init = setup;

window.addEventListener('load', setup);
</script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
