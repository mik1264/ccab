<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Macro ABM - Basic Economy</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            text-align: center;
            margin-bottom: 30px;
            opacity: 0.9;
            font-size: 1.1em;
        }

        .controls {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-item label {
            font-size: 0.9em;
            font-weight: 600;
        }

        .control-item input[type="range"] {
            width: 100%;
            cursor: pointer;
        }

        .control-item .value-display {
            font-size: 0.85em;
            opacity: 0.8;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button.shock {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .metric-card h3 {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .metric-card .value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .metric-card .change {
            font-size: 0.9em;
            opacity: 0.7;
        }

        .change.positive {
            color: #4ade80;
        }

        .change.negative {
            color: #f87171;
        }

        .charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .chart-container h3 {
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        canvas {
            width: 100%;
            height: 250px;
            border-radius: 8px;
        }

        .info {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .info h3 {
            margin-bottom: 10px;
        }

        .info p {
            line-height: 1.6;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèõÔ∏è Simple Macro ABM</h1>
        <p class="subtitle">Basic Agent-Based Macroeconomic Model: 100 Households, 10 Firms, 1 Bank</p>

        <div class="controls">
            <div class="control-grid">
                <div class="control-item">
                    <label>Policy Rate (%): <span class="value-display" id="rate-display">2.0%</span></label>
                    <input type="range" id="policy-rate" min="0" max="10" step="0.5" value="2">
                </div>
                <div class="control-item">
                    <label>Tax Rate (%): <span class="value-display" id="tax-display">20%</span></label>
                    <input type="range" id="tax-rate" min="0" max="50" step="5" value="20">
                </div>
                <div class="control-item">
                    <label>Gov Spending: <span class="value-display" id="gov-display">15%</span></label>
                    <input type="range" id="gov-spending" min="0" max="30" step="5" value="15">
                </div>
                <div class="control-item">
                    <label>Avg Propensity to Consume: <span class="value-display" id="ptc-display">0.85</span></label>
                    <input type="range" id="ptc-mean" min="0.5" max="0.95" step="0.05" value="0.85">
                </div>
            </div>

            <div class="button-group">
                <button id="start-btn">‚ñ∂ Start</button>
                <button id="pause-btn">‚è∏ Pause</button>
                <button id="reset-btn">üîÑ Reset</button>
                <button class="shock" id="demand-shock-btn">üìà Demand Shock</button>
                <button class="shock" id="supply-shock-btn">‚ö†Ô∏è Supply Shock</button>
            </div>
        </div>

        <div class="dashboard">
            <div class="metric-card">
                <h3>GDP (Quarterly)</h3>
                <div class="value" id="gdp-value">1000</div>
                <div class="change" id="gdp-change">+0.0%</div>
            </div>
            <div class="metric-card">
                <h3>Unemployment Rate</h3>
                <div class="value" id="unemployment-value">5.0%</div>
                <div class="change" id="unemployment-change">0.0pp</div>
            </div>
            <div class="metric-card">
                <h3>Inflation (Annual)</h3>
                <div class="value" id="inflation-value">2.0%</div>
                <div class="change" id="inflation-change">0.0pp</div>
            </div>
            <div class="metric-card">
                <h3>Avg Firm Inventory</h3>
                <div class="value" id="inventory-value">50</div>
                <div class="change" id="inventory-change">0</div>
            </div>
        </div>

        <div class="charts">
            <div class="chart-container">
                <h3>GDP Over Time</h3>
                <canvas id="gdp-chart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Unemployment Rate</h3>
                <canvas id="unemployment-chart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Inflation Rate</h3>
                <canvas id="inflation-chart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Price Level Index</h3>
                <canvas id="price-chart"></canvas>
            </div>
        </div>

        <div class="info">
            <h3>About This Model</h3>
            <p>
                This is a simplified agent-based macroeconomic model featuring 100 heterogeneous households,
                10 firms with adaptive pricing, and 1 bank providing credit. The model demonstrates how
                macroeconomic variables like GDP, unemployment, and inflation emerge from decentralized
                decisions of individual agents. Adjust policy parameters and inject shocks to observe
                the economy's response.
            </p>
        </div>
    </div>

    <script>
        // ===== MODEL PARAMETERS =====
        const N_HOUSEHOLDS = 100;
        const N_FIRMS = 10;
        const TICKS_PER_QUARTER = 3; // 3 months = 1 quarter

        // ===== AGENT CLASSES =====
        class Household {
            constructor(id) {
                this.id = id;
                this.ptc = 0.85 + (Math.random() - 0.5) * 0.2; // Propensity to consume
                this.wealth = 1000 + Math.random() * 2000;
                this.income = 0;
                this.employed = true;
                this.employer = null;
            }

            consume(firms, avgPrice) {
                const consumption = this.ptc * this.income + 0.02 * this.wealth;
                const quantity = Math.min(consumption / avgPrice, this.wealth / avgPrice);

                // Buy from random firms
                const quantity_per_firm = quantity / N_FIRMS;
                firms.forEach(firm => {
                    const bought = firm.sell(quantity_per_firm);
                    this.wealth -= bought * firm.price;
                });

                return quantity;
            }
        }

        class Firm {
            constructor(id) {
                this.id = id;
                this.price = 10 + Math.random() * 5;
                this.wage = 30 + Math.random() * 10;
                this.inventory = 50 + Math.random() * 50;
                this.targetInventory = 100;
                this.cash = 5000;
                this.debt = 0;
                this.expectedDemand = 10;
                this.actualSales = 0;
                this.markup = 0.12;
                this.employees = [];
            }

            planProduction() {
                // Adaptive expectations
                this.expectedDemand = 0.7 * this.expectedDemand + 0.3 * this.actualSales + (Math.random() - 0.5) * 2;

                // Adjust price based on inventory
                const inventoryGap = (this.targetInventory - this.inventory) / this.targetInventory;
                this.price *= (1 + 0.1 * inventoryGap + (Math.random() - 0.5) * 0.02);
                this.price = Math.max(5, this.price);

                // Target production
                return Math.max(0, this.expectedDemand + (this.targetInventory - this.inventory) * 0.3);
            }

            hire(household) {
                this.employees.push(household);
                household.employed = true;
                household.employer = this;
            }

            fire(household) {
                const idx = this.employees.indexOf(household);
                if (idx > -1) {
                    this.employees.splice(idx, 1);
                    household.employed = false;
                    household.employer = null;
                }
            }

            payWages(taxRate) {
                this.employees.forEach(emp => {
                    const netWage = this.wage * (1 - taxRate);
                    emp.income = netWage;
                    emp.wealth += netWage;
                    this.cash -= this.wage;
                });
            }

            produce(targetProduction, productivityShock = 1) {
                const laborNeeded = targetProduction / 10; // 1 worker produces 10 units
                const production = Math.min(targetProduction, this.employees.length * 10 * productivityShock);
                this.inventory += production;
                return production;
            }

            sell(quantity) {
                const sold = Math.min(quantity, this.inventory);
                this.inventory -= sold;
                this.actualSales = sold;
                this.cash += sold * this.price;
                return sold;
            }
        }

        class Bank {
            constructor() {
                this.loans = 0;
                this.deposits = 0;
                this.equity = 10000;
            }

            lend(firm, amount, policyRate) {
                const interestRate = policyRate / 100 + 0.02;
                const canLend = this.equity > this.loans * 0.1; // Simple capital ratio

                if (canLend && firm.cash < 0) {
                    const loan = Math.min(amount, Math.abs(firm.cash) * 1.5);
                    firm.cash += loan;
                    firm.debt += loan * (1 + interestRate);
                    this.loans += loan;
                }
            }
        }

        // ===== SIMULATION STATE =====
        let households = [];
        let firms = [];
        let bank;
        let tick = 0;
        let running = false;
        let supplyShock = 1.0;

        // Time series data
        let gdpHistory = [];
        let unemploymentHistory = [];
        let inflationHistory = [];
        let priceHistory = [];
        let previousGDP = 0;
        let previousPrice = 10;

        // ===== INITIALIZATION =====
        function init() {
            households = [];
            firms = [];
            tick = 0;
            previousGDP = 0;
            previousPrice = 10;
            supplyShock = 1.0;

            // Clear histories
            gdpHistory = [];
            unemploymentHistory = [];
            inflationHistory = [];
            priceHistory = [];

            // Create agents
            for (let i = 0; i < N_HOUSEHOLDS; i++) {
                households.push(new Household(i));
            }

            for (let i = 0; i < N_FIRMS; i++) {
                firms.push(new Firm(i));
            }

            bank = new Bank();

            // Initial employment: 90% employed
            households.forEach((h, i) => {
                if (Math.random() < 0.90) {
                    const firm = firms[i % N_FIRMS];
                    firm.hire(h);
                }
            });

            updateDashboard();
            updateCharts();
        }

        // ===== SIMULATION STEP =====
        function step() {
            tick++;

            const policyRate = parseFloat(document.getElementById('policy-rate').value);
            const taxRate = parseFloat(document.getElementById('tax-rate').value) / 100;
            const govSpending = parseFloat(document.getElementById('gov-spending').value) / 100;
            const ptcMean = parseFloat(document.getElementById('ptc-mean').value);

            // Update household PTC based on slider
            households.forEach(h => {
                h.ptc = ptcMean + (Math.random() - 0.5) * 0.2;
                h.ptc = Math.max(0.5, Math.min(0.95, h.ptc));
            });

            // 1. FIRMS PLAN PRODUCTION
            firms.forEach(firm => {
                const targetProduction = firm.planProduction();

                // Labor adjustment
                const laborNeeded = Math.ceil(targetProduction / 10);
                while (firm.employees.length < laborNeeded && firm.employees.length < N_HOUSEHOLDS / N_FIRMS) {
                    const unemployed = households.find(h => !h.employed);
                    if (unemployed) firm.hire(unemployed);
                    else break;
                }

                // Random separations
                if (firm.employees.length > 0 && Math.random() < 0.02) {
                    const emp = firm.employees[Math.floor(Math.random() * firm.employees.length)];
                    firm.fire(emp);
                }
            });

            // 2. CREDIT
            firms.forEach(firm => {
                if (firm.cash < firm.wage * firm.employees.length) {
                    bank.lend(firm, firm.wage * firm.employees.length * 2, policyRate);
                }
            });

            // 3. PAY WAGES
            firms.forEach(firm => firm.payWages(taxRate));

            // Unemployment benefits
            const unemployed = households.filter(h => !h.employed);
            unemployed.forEach(h => {
                h.income = 20; // Basic benefit
                h.wealth += h.income;
            });

            // 4. PRODUCTION
            firms.forEach(firm => {
                const targetProduction = firm.expectedDemand * 1.2;
                firm.produce(targetProduction, supplyShock);
            });

            // Supply shock decay
            if (supplyShock < 1.0) {
                supplyShock += 0.1;
                if (supplyShock > 1.0) supplyShock = 1.0;
            }

            // 5. CONSUMPTION
            const avgPrice = firms.reduce((sum, f) => sum + f.price, 0) / N_FIRMS;
            households.forEach(h => h.consume(firms, avgPrice));

            // 6. GOVERNMENT SPENDING
            const gdp = computeGDP();
            const govBuy = gdp * govSpending;
            firms.forEach(firm => {
                firm.sell(govBuy / N_FIRMS / avgPrice);
            });

            // 7. METRICS
            const unemployment = unemployed.length / N_HOUSEHOLDS;
            const inflation = ((avgPrice - previousPrice) / previousPrice) * 100 * 12; // Annualized

            // Record quarterly (every 3 ticks)
            if (tick % TICKS_PER_QUARTER === 0) {
                gdpHistory.push(gdp);
                unemploymentHistory.push(unemployment * 100);
                inflationHistory.push(inflation);
                priceHistory.push(avgPrice);

                // Keep last 40 quarters (10 years)
                if (gdpHistory.length > 40) {
                    gdpHistory.shift();
                    unemploymentHistory.shift();
                    inflationHistory.shift();
                    priceHistory.shift();
                }
            }

            previousPrice = avgPrice;
            previousGDP = gdp;

            updateDashboard();
            updateCharts();
        }

        function computeGDP() {
            const sales = firms.reduce((sum, f) => sum + f.actualSales * f.price, 0);
            const govSpending = parseFloat(document.getElementById('gov-spending').value) / 100 * sales;
            return sales + govSpending;
        }

        // ===== UI UPDATES =====
        function updateDashboard() {
            const gdp = computeGDP();
            const unemployed = households.filter(h => !h.employed);
            const unemployment = (unemployed.length / N_HOUSEHOLDS) * 100;
            const avgPrice = firms.reduce((sum, f) => sum + f.price, 0) / N_FIRMS;
            const avgInventory = firms.reduce((sum, f) => sum + f.inventory, 0) / N_FIRMS;
            const inflation = ((avgPrice - previousPrice) / previousPrice) * 100 * 12;

            document.getElementById('gdp-value').textContent = gdp.toFixed(0);
            document.getElementById('unemployment-value').textContent = unemployment.toFixed(1) + '%';
            document.getElementById('inflation-value').textContent = inflation.toFixed(1) + '%';
            document.getElementById('inventory-value').textContent = avgInventory.toFixed(0);

            // Changes
            const gdpChange = previousGDP ? ((gdp - previousGDP) / previousGDP * 100) : 0;
            const gdpChangeEl = document.getElementById('gdp-change');
            gdpChangeEl.textContent = (gdpChange >= 0 ? '+' : '') + gdpChange.toFixed(1) + '%';
            gdpChangeEl.className = 'change ' + (gdpChange >= 0 ? 'positive' : 'negative');
        }

        // ===== CHARTS =====
        function updateCharts() {
            drawLineChart('gdp-chart', gdpHistory, '#4ade80', 'GDP');
            drawLineChart('unemployment-chart', unemploymentHistory, '#f87171', 'Unemployment %');
            drawLineChart('inflation-chart', inflationHistory, '#fbbf24', 'Inflation %');
            drawLineChart('price-chart', priceHistory, '#60a5fa', 'Price Index');
        }

        function drawLineChart(canvasId, data, color, label) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth;
            const height = canvas.height = canvas.offsetHeight;

            ctx.clearRect(0, 0, width, height);

            if (data.length < 2) return;

            const padding = 40;
            const graphWidth = width - padding * 2;
            const graphHeight = height - padding * 2;

            const minVal = Math.min(...data);
            const maxVal = Math.max(...data);
            const range = maxVal - minVal || 1;

            // Draw axes
            ctx.strokeStyle = 'rgba(255,255,255,0.3)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();

            // Draw grid
            for (let i = 0; i <= 5; i++) {
                const y = padding + (graphHeight / 5) * i;
                ctx.strokeStyle = 'rgba(255,255,255,0.1)';
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();

                // Y-axis labels
                const val = maxVal - (range / 5) * i;
                ctx.fillStyle = 'rgba(255,255,255,0.6)';
                ctx.font = '10px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(val.toFixed(0), padding - 5, y + 4);
            }

            // Draw line
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.beginPath();

            data.forEach((val, i) => {
                const x = padding + (graphWidth / (data.length - 1)) * i;
                const y = height - padding - ((val - minVal) / range) * graphHeight;

                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });

            ctx.stroke();

            // Draw points
            ctx.fillStyle = color;
            data.forEach((val, i) => {
                const x = padding + (graphWidth / (data.length - 1)) * i;
                const y = height - padding - ((val - minVal) / range) * graphHeight;
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        // ===== EVENT HANDLERS =====
        document.getElementById('start-btn').addEventListener('click', () => {
            running = true;
        });

        document.getElementById('pause-btn').addEventListener('click', () => {
            running = false;
        });

        document.getElementById('reset-btn').addEventListener('click', () => {
            running = false;
            init();
        });

        document.getElementById('demand-shock-btn').addEventListener('click', () => {
            // Increase household wealth by 20%
            households.forEach(h => h.wealth *= 1.2);
        });

        document.getElementById('supply-shock-btn').addEventListener('click', () => {
            // Decrease productivity by 30%
            supplyShock = 0.7;
        });

        // Update slider displays
        document.getElementById('policy-rate').addEventListener('input', (e) => {
            document.getElementById('rate-display').textContent = e.target.value + '%';
        });

        document.getElementById('tax-rate').addEventListener('input', (e) => {
            document.getElementById('tax-display').textContent = e.target.value + '%';
        });

        document.getElementById('gov-spending').addEventListener('input', (e) => {
            document.getElementById('gov-display').textContent = e.target.value + '%';
        });

        document.getElementById('ptc-mean').addEventListener('input', (e) => {
            document.getElementById('ptc-display').textContent = e.target.value;
        });

        // ===== ANIMATION LOOP =====
        function animate() {
            if (running) {
                step();
            }
            requestAnimationFrame(animate);
        }

        // ===== START =====
        init();
        animate();
    </script>
</body>
</html>
