<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intermediate Policy Lab - ABM Economics</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.8em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .subtitle {
            text-align: center;
            margin-bottom: 25px;
            opacity: 0.9;
            font-size: 1.1em;
        }

        .controls {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .control-section {
            margin-bottom: 20px;
        }

        .control-section h3 {
            font-size: 1.1em;
            margin-bottom: 15px;
            color: #60a5fa;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-item label {
            font-size: 0.85em;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
        }

        .control-item input[type="range"] {
            width: 100%;
            cursor: pointer;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button.shock {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        button.policy {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-card h3 {
            font-size: 0.8em;
            opacity: 0.7;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .metric-card .value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .metric-card .change {
            font-size: 0.85em;
            opacity: 0.8;
        }

        .change.positive { color: #4ade80; }
        .change.negative { color: #f87171; }
        .change.neutral { color: #fbbf24; }

        .charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .chart-container.large {
            grid-column: span 2;
        }

        .chart-container h3 {
            margin-bottom: 15px;
            font-size: 1.1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-info {
            font-size: 0.75em;
            opacity: 0.6;
            font-weight: normal;
        }

        canvas {
            width: 100%;
            border-radius: 8px;
        }

        .scatter-chart {
            height: 300px;
        }

        .time-chart {
            height: 200px;
        }

        .info {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .info h3 {
            margin-bottom: 15px;
            color: #60a5fa;
        }

        .info p {
            line-height: 1.6;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .info ul {
            margin-left: 20px;
            line-height: 1.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Intermediate Policy Lab</h1>
        <p class="subtitle">Agent-Based Macro with Taylor Rule, Credit Rationing & Distribution Dynamics | 1000 HH, 50 Firms, 3 Banks</p>

        <div class="controls">
            <div class="control-section">
                <h3>üí∞ Monetary Policy (Taylor Rule)</h3>
                <div class="control-grid">
                    <div class="control-item">
                        <label>Inflation Target: <span id="pi-target-display">2.0%</span></label>
                        <input type="range" id="pi-target" min="0" max="5" step="0.5" value="2">
                    </div>
                    <div class="control-item">
                        <label>Taylor œÜ_œÄ: <span id="phi-pi-display">1.5</span></label>
                        <input type="range" id="phi-pi" min="0.5" max="3" step="0.1" value="1.5">
                    </div>
                    <div class="control-item">
                        <label>Taylor œÜ_y: <span id="phi-y-display">0.5</span></label>
                        <input type="range" id="phi-y" min="0" max="1.5" step="0.1" value="0.5">
                    </div>
                    <div class="control-item">
                        <label>Natural Rate: <span id="natural-rate-display">2.0%</span></label>
                        <input type="range" id="natural-rate" min="0" max="5" step="0.5" value="2">
                    </div>
                </div>
            </div>

            <div class="control-section">
                <h3>üèõÔ∏è Fiscal Policy</h3>
                <div class="control-grid">
                    <div class="control-item">
                        <label>Tax Rate: <span id="tax-display">22%</span></label>
                        <input type="range" id="tax-rate" min="0" max="50" step="2" value="22">
                    </div>
                    <div class="control-item">
                        <label>Gov Spending: <span id="gov-display">18%</span></label>
                        <input type="range" id="gov-spending" min="0" max="40" step="2" value="18">
                    </div>
                    <div class="control-item">
                        <label>Benefit Rate: <span id="benefit-display">50%</span></label>
                        <input type="range" id="benefit-rate" min="0" max="100" step="5" value="50">
                    </div>
                </div>
            </div>

            <div class="control-section">
                <h3>üè¶ Credit & Market Parameters</h3>
                <div class="control-grid">
                    <div class="control-item">
                        <label>Bank Min CAR: <span id="car-display">10%</span></label>
                        <input type="range" id="min-car" min="5" max="20" step="1" value="10">
                    </div>
                    <div class="control-item">
                        <label>Risk Limit: <span id="risk-display">3%</span></label>
                        <input type="range" id="risk-limit" min="1" max="10" step="0.5" value="3">
                    </div>
                    <div class="control-item">
                        <label>Markup Base: <span id="markup-display">12%</span></label>
                        <input type="range" id="markup-base" min="5" max="25" step="1" value="12">
                    </div>
                    <div class="control-item">
                        <label>Separation Rate: <span id="sep-display">2%</span></label>
                        <input type="range" id="sep-rate" min="0" max="8" step="0.5" value="2">
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button id="start-btn">‚ñ∂ Start</button>
                <button id="pause-btn">‚è∏ Pause</button>
                <button id="reset-btn">üîÑ Reset</button>
                <button class="shock" id="demand-shock-btn">üìà Demand Shock (+20%)</button>
                <button class="shock" id="supply-shock-btn">‚ö†Ô∏è Supply Shock (-30%)</button>
                <button class="shock" id="credit-shock-btn">üí≥ Credit Crunch</button>
                <button class="policy" id="rate-hike-btn">üìä Rate Hike (+2pp)</button>
                <button class="policy" id="rate-cut-btn">üìâ Rate Cut (-2pp)</button>
            </div>
        </div>

        <div class="dashboard">
            <div class="metric-card">
                <h3>Real GDP</h3>
                <div class="value" id="gdp-value">10000</div>
                <div class="change" id="gdp-change">+0.0%</div>
            </div>
            <div class="metric-card">
                <h3>Unemployment</h3>
                <div class="value" id="unemployment-value">5.0%</div>
                <div class="change" id="unemployment-change">0.0pp</div>
            </div>
            <div class="metric-card">
                <h3>Inflation (Annual)</h3>
                <div class="value" id="inflation-value">2.0%</div>
                <div class="change" id="inflation-change">0.0pp</div>
            </div>
            <div class="metric-card">
                <h3>Policy Rate</h3>
                <div class="value" id="policy-rate-value">2.0%</div>
                <div class="change" id="policy-rate-change">0.0pp</div>
            </div>
            <div class="metric-card">
                <h3>Avg Bank CAR</h3>
                <div class="value" id="car-value">12.0%</div>
                <div class="change" id="car-change">0.0pp</div>
            </div>
            <div class="metric-card">
                <h3>Gini (Wealth)</h3>
                <div class="value" id="gini-value">0.45</div>
                <div class="change" id="gini-change">0.00</div>
            </div>
        </div>

        <div class="charts">
            <div class="chart-container">
                <h3>GDP Growth <span class="chart-info">(Quarterly)</span></h3>
                <canvas id="gdp-chart" class="time-chart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Unemployment Rate <span class="chart-info">(Monthly)</span></h3>
                <canvas id="unemployment-chart" class="time-chart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Inflation Rate <span class="chart-info">(Annual %)</span></h3>
                <canvas id="inflation-chart" class="time-chart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Policy Rate <span class="chart-info">(Taylor Rule)</span></h3>
                <canvas id="rate-chart" class="time-chart"></canvas>
            </div>
            <div class="chart-container large">
                <h3>Phillips Curve <span class="chart-info">(Inflation vs Unemployment)</span></h3>
                <canvas id="phillips-chart" class="scatter-chart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Wealth Distribution <span class="chart-info">(Histogram)</span></h3>
                <canvas id="wealth-chart" class="scatter-chart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Firm Size Distribution <span class="chart-info">(Employees)</span></h3>
                <canvas id="firm-size-chart" class="scatter-chart"></canvas>
            </div>
        </div>

        <div class="info">
            <h3>About This Model</h3>
            <p>
                This intermediate policy laboratory features 1000 heterogeneous households, 50 firms with inventory-based pricing,
                and 3 banks providing credit subject to capital adequacy ratios. The model implements:
            </p>
            <ul>
                <li><strong>Taylor Rule Monetary Policy:</strong> Central bank sets rates responding to inflation gap and output gap</li>
                <li><strong>Credit Rationing:</strong> Banks constrained by capital ratios; firms face financing constraints</li>
                <li><strong>Adaptive Expectations:</strong> Firms update demand forecasts; wage/price stickiness with indexation</li>
                <li><strong>Emergent Distributions:</strong> Realistic wealth inequality (Gini), fat-tailed firm sizes</li>
                <li><strong>Phillips Curve:</strong> Observe trade-off between inflation and unemployment</li>
            </ul>
            <p>
                Experiment with different policy rules, inject shocks, and observe how macro variables co-evolve.
                The model demonstrates path-dependent dynamics and out-of-equilibrium behavior characteristic of agent-based approaches.
            </p>
        </div>
    </div>

    <script>
        // ===== MODEL PARAMETERS =====
        const N_HOUSEHOLDS = 1000;
        const N_FIRMS = 50;
        const N_BANKS = 3;
        const TICKS_PER_MONTH = 1;

        // ===== UTILITY FUNCTIONS =====
        function normalRandom(mean = 0, std = 1) {
            let u = 0, v = 0;
            while(u === 0) u = Math.random();
            while(v === 0) v = Math.random();
            return mean + std * Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
        }

        function computeGini(values) {
            const sorted = [...values].sort((a, b) => a - b);
            const n = sorted.length;
            let sum = 0;
            let weightedSum = 0;
            for (let i = 0; i < n; i++) {
                sum += sorted[i];
                weightedSum += (i + 1) * sorted[i];
            }
            if (sum === 0) return 0;
            return (2 * weightedSum) / (n * sum) - (n + 1) / n;
        }

        // ===== AGENT CLASSES =====
        class Household {
            constructor(id) {
                this.id = id;
                this.ptc = Math.max(0.5, Math.min(0.95, normalRandom(0.85, 0.10)));
                this.wealth = Math.max(100, Math.exp(normalRandom(7.5, 1.2))); // Lognormal
                this.income = 0;
                this.employed = false;
                this.employer = null;
                this.lambda = 0.02; // Wealth effect
            }

            consume(firms) {
                const totalWealth = this.wealth;
                const consumption = this.ptc * this.income + this.lambda * totalWealth;
                const spendable = Math.min(consumption, this.wealth);

                if (spendable <= 0) return 0;

                // Distribute spending across firms (weighted by inverse price)
                const totalPriceInv = firms.reduce((sum, f) => sum + 1 / f.price, 0);
                let totalSpent = 0;

                firms.forEach(f => {
                    const share = (1 / f.price) / totalPriceInv;
                    const spend = spendable * share;
                    const qty = spend / f.price;
                    const bought = f.sell(qty);
                    const actualSpend = bought * f.price;
                    this.wealth -= actualSpend;
                    totalSpent += actualSpend;
                });

                return totalSpent;
            }
        }

        class Firm {
            constructor(id) {
                this.id = id;
                this.price = normalRandom(10, 2);
                this.price = Math.max(5, this.price);
                this.wage = normalRandom(35, 5);
                this.inventory = Math.max(0, normalRandom(100, 30));
                this.targetInventory = 100;
                this.cash = 10000;
                this.debt = 0;
                this.expectedDemand = 20;
                this.actualSales = 0;
                this.lastSales = 0;
                this.employees = [];
                this.productivity = 10; // units per worker
            }

            planProduction() {
                // Adaptive expectations with noise
                this.expectedDemand = 0.7 * this.expectedDemand + 0.3 * this.actualSales + normalRandom(0, 2);
                this.expectedDemand = Math.max(1, this.expectedDemand);

                // Inventory rule for pricing
                const inventoryGap = (this.targetInventory - this.inventory) / Math.max(1, this.targetInventory);
                const markupBase = parseFloat(document.getElementById('markup-base').value) / 100;

                // Price adjustment
                const priceChange = 0.15 * inventoryGap + normalRandom(0, 0.01);
                this.price *= (1 + priceChange);
                this.price = Math.max(5, this.price);

                // Wage adjustment (sticky, indexed to inflation)
                const inflation = model.recentInflation || 0;
                const unemployment = model.unemployment || 0.05;
                const wageChange = 0.5 * (inflation / 100) - 0.1 * (unemployment - 0.05);
                this.wage *= (1 + wageChange * 0.5); // Dampened
                this.wage = Math.max(20, this.wage);

                // Target production
                const desiredInventory = Math.max(0, this.targetInventory - this.inventory);
                return Math.max(0, this.expectedDemand + desiredInventory * 0.3);
            }

            hire(household) {
                if (!household.employed) {
                    this.employees.push(household);
                    household.employed = true;
                    household.employer = this;
                }
            }

            fire(household) {
                const idx = this.employees.indexOf(household);
                if (idx > -1) {
                    this.employees.splice(idx, 1);
                    household.employed = false;
                    household.employer = null;
                }
            }

            payWages(taxRate) {
                const totalWageBill = this.wage * this.employees.length;
                this.employees.forEach(emp => {
                    const netWage = this.wage * (1 - taxRate);
                    emp.income = netWage;
                    emp.wealth += netWage;
                });
                this.cash -= totalWageBill;
            }

            produce(targetProduction, productivityShock = 1) {
                const capacity = this.employees.length * this.productivity * productivityShock;
                const production = Math.min(targetProduction, capacity);
                this.inventory += production;
                return production;
            }

            sell(quantity) {
                const sold = Math.min(quantity, this.inventory);
                this.inventory = Math.max(0, this.inventory - sold);
                this.actualSales += sold;
                this.cash += sold * this.price;
                return sold;
            }

            resetSales() {
                this.lastSales = this.actualSales;
                this.actualSales = 0;
            }
        }

        class Bank {
            constructor(id) {
                this.id = id;
                this.loans = 0;
                this.deposits = 100000;
                this.equity = 15000;
            }

            getCAR() {
                if (this.loans === 0) return 1.0;
                return this.equity / this.loans;
            }

            lend(firm, amount, policyRate, minCAR, riskLimit) {
                const currentCAR = this.getCAR();
                const interestRate = policyRate / 100 + 0.025;

                // Probability of default (simplified)
                const pd = Math.max(0.01, Math.min(0.15, -firm.cash / 10000));
                const lgd = 0.5; // Loss given default
                const expectedLoss = pd * lgd;

                // Check capital constraint and risk limit
                if (currentCAR < minCAR / 100) return false;
                if (expectedLoss > riskLimit / 100) return false;

                const loan = Math.min(amount, this.deposits * 0.5);
                if (loan > 0) {
                    firm.cash += loan;
                    firm.debt += loan * (1 + interestRate / 12); // Monthly
                    this.loans += loan;
                    this.deposits -= loan;
                    return true;
                }
                return false;
            }

            collectDebt(firm) {
                const payment = Math.min(firm.debt * 0.05, firm.cash * 0.3);
                firm.cash -= payment;
                firm.debt -= payment;
                this.deposits += payment;
                this.equity += payment * 0.1;
            }
        }

        // ===== SIMULATION STATE =====
        let households = [];
        let firms = [];
        let banks = [];
        let tick = 0;
        let running = false;
        let supplyShock = 1.0;
        let creditShockActive = false;

        // Model state
        let model = {
            gdp: 0,
            unemployment: 0.05,
            inflation: 0.02,
            policyRate: 2.0,
            recentInflation: 2.0,
            potentialGDP: 10000
        };

        // Time series data
        let gdpHistory = [];
        let unemploymentHistory = [];
        let inflationHistory = [];
        let rateHistory = [];
        let phillipsData = [];

        // ===== INITIALIZATION =====
        function init() {
            households = [];
            firms = [];
            banks = [];
            tick = 0;
            supplyShock = 1.0;
            creditShockActive = false;

            gdpHistory = [];
            unemploymentHistory = [];
            inflationHistory = [];
            rateHistory = [];
            phillipsData = [];

            // Create agents
            for (let i = 0; i < N_HOUSEHOLDS; i++) {
                households.push(new Household(i));
            }

            for (let i = 0; i < N_FIRMS; i++) {
                firms.push(new Firm(i));
            }

            for (let i = 0; i < N_BANKS; i++) {
                banks.push(new Bank(i));
            }

            // Initial employment
            households.forEach((h, i) => {
                if (Math.random() < 0.93) {
                    const firm = firms[i % N_FIRMS];
                    firm.hire(h);
                }
            });

            model.potentialGDP = computeGDP();

            updateDashboard();
            updateCharts();
        }

        // ===== SIMULATION STEP =====
        function step() {
            tick++;

            // Get policy parameters
            const piTarget = parseFloat(document.getElementById('pi-target').value);
            const phiPi = parseFloat(document.getElementById('phi-pi').value);
            const phiY = parseFloat(document.getElementById('phi-y').value);
            const naturalRate = parseFloat(document.getElementById('natural-rate').value);
            const taxRate = parseFloat(document.getElementById('tax-rate').value) / 100;
            const govSpending = parseFloat(document.getElementById('gov-spending').value) / 100;
            const benefitRate = parseFloat(document.getElementById('benefit-rate').value) / 100;
            const minCAR = parseFloat(document.getElementById('min-car').value);
            const riskLimit = parseFloat(document.getElementById('risk-limit').value);
            const separationRate = parseFloat(document.getElementById('sep-rate').value) / 100;

            // 1. MONETARY POLICY (Taylor Rule)
            const outputGap = (model.gdp - model.potentialGDP) / model.potentialGDP;
            const inflationGap = model.recentInflation - piTarget;
            model.policyRate = naturalRate + phiPi * inflationGap + phiY * outputGap;
            model.policyRate = Math.max(0, Math.min(15, model.policyRate));

            // 2. FIRMS PLAN
            firms.forEach(firm => {
                const targetProduction = firm.planProduction();
                const laborNeeded = Math.ceil(targetProduction / firm.productivity);

                // Adjust employment
                while (firm.employees.length < laborNeeded) {
                    const unemployed = households.find(h => !h.employed);
                    if (!unemployed) break;
                    firm.hire(unemployed);
                }

                // Random separations
                firm.employees.forEach(emp => {
                    if (Math.random() < separationRate) {
                        firm.fire(emp);
                    }
                });
            });

            // 3. CREDIT MARKET
            firms.forEach(firm => {
                const wageBill = firm.wage * firm.employees.length;
                if (firm.cash < wageBill * 1.5) {
                    const bank = banks[firm.id % N_BANKS];
                    const additionalCAR = creditShockActive ? 3 : 0;
                    const additionalRisk = creditShockActive ? -2 : 0;
                    bank.lend(firm, wageBill * 2, model.policyRate, minCAR + additionalCAR, riskLimit + additionalRisk);
                }
            });

            // 4. PAY WAGES
            firms.forEach(firm => firm.payWages(taxRate));

            // Unemployment benefits
            const avgWage = firms.reduce((sum, f) => sum + f.wage, 0) / N_FIRMS;
            households.filter(h => !h.employed).forEach(h => {
                h.income = avgWage * benefitRate;
                h.wealth += h.income;
            });

            // 5. PRODUCTION
            firms.forEach(firm => {
                firm.resetSales();
                const targetProduction = firm.expectedDemand * 1.3;
                firm.produce(targetProduction, supplyShock);
            });

            // Supply shock decay
            if (supplyShock < 1.0) {
                supplyShock = Math.min(1.0, supplyShock + 0.05);
            }

            // Credit shock decay
            if (creditShockActive && tick % 12 === 0) {
                creditShockActive = false;
            }

            // 6. CONSUMPTION
            households.forEach(h => h.consume(firms));

            // 7. GOVERNMENT SPENDING
            const gdp = computeGDP();
            const govBuy = gdp * govSpending;
            const qtyPerFirm = govBuy / firms.length / 10;
            firms.forEach(firm => firm.sell(qtyPerFirm));

            // 8. DEBT SERVICE
            banks.forEach(bank => {
                firms.forEach(firm => {
                    if (firm.debt > 0) {
                        bank.collectDebt(firm);
                    }
                });
            });

            // 9. COMPUTE METRICS
            const unemployed = households.filter(h => !h.employed).length;
            model.unemployment = unemployed / N_HOUSEHOLDS;
            model.gdp = gdp;

            const avgPrice = firms.reduce((sum, f) => sum + f.price, 0) / N_FIRMS;
            const prevAvgPrice = inflationHistory.length > 0 ?
                firms.reduce((sum, f) => sum + f.price, 0) / N_FIRMS : avgPrice;
            model.inflation = ((avgPrice - prevAvgPrice) / prevAvgPrice) * 100 * 12; // Annualized
            model.recentInflation = model.inflation;

            // Record data
            if (tick % TICKS_PER_MONTH === 0) {
                gdpHistory.push(model.gdp);
                unemploymentHistory.push(model.unemployment * 100);
                inflationHistory.push(model.inflation);
                rateHistory.push(model.policyRate);
                phillipsData.push({ inflation: model.inflation, unemployment: model.unemployment * 100 });

                // Keep last 60 months
                if (gdpHistory.length > 60) {
                    gdpHistory.shift();
                    unemploymentHistory.shift();
                    inflationHistory.shift();
                    rateHistory.shift();
                }
                if (phillipsData.length > 200) {
                    phillipsData.shift();
                }
            }

            updateDashboard();
            updateCharts();
        }

        function computeGDP() {
            const sales = firms.reduce((sum, f) => sum + f.lastSales * f.price, 0);
            const govSpending = parseFloat(document.getElementById('gov-spending').value) / 100;
            return sales * (1 + govSpending);
        }

        // ===== UI UPDATES =====
        function updateDashboard() {
            document.getElementById('gdp-value').textContent = model.gdp.toFixed(0);
            document.getElementById('unemployment-value').textContent = (model.unemployment * 100).toFixed(1) + '%';
            document.getElementById('inflation-value').textContent = model.inflation.toFixed(1) + '%';
            document.getElementById('policy-rate-value').textContent = model.policyRate.toFixed(1) + '%';

            const avgCAR = banks.reduce((sum, b) => sum + b.getCAR(), 0) / N_BANKS;
            document.getElementById('car-value').textContent = (avgCAR * 100).toFixed(1) + '%';

            const wealthValues = households.map(h => h.wealth);
            const gini = computeGini(wealthValues);
            document.getElementById('gini-value').textContent = gini.toFixed(2);
        }

        // ===== CHARTS =====
        function updateCharts() {
            drawLineChart('gdp-chart', gdpHistory, '#4ade80');
            drawLineChart('unemployment-chart', unemploymentHistory, '#f87171');
            drawLineChart('inflation-chart', inflationHistory, '#fbbf24');
            drawLineChart('rate-chart', rateHistory, '#60a5fa');
            drawPhillipsCurve();
            drawHistogram('wealth-chart', households.map(h => h.wealth), 20, '#a78bfa');
            drawHistogram('firm-size-chart', firms.map(f => f.employees.length), 15, '#34d399');
        }

        function drawLineChart(canvasId, data, color) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth;
            const height = canvas.height = canvas.offsetHeight;

            ctx.clearRect(0, 0, width, height);
            if (data.length < 2) return;

            const padding = 40;
            const graphWidth = width - padding * 2;
            const graphHeight = height - padding * 2;
            const minVal = Math.min(...data) * 0.95;
            const maxVal = Math.max(...data) * 1.05;
            const range = maxVal - minVal || 1;

            // Axes
            ctx.strokeStyle = 'rgba(255,255,255,0.2)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();

            // Grid & labels
            for (let i = 0; i <= 4; i++) {
                const y = padding + (graphHeight / 4) * i;
                ctx.strokeStyle = 'rgba(255,255,255,0.05)';
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();

                const val = maxVal - (range / 4) * i;
                ctx.fillStyle = 'rgba(255,255,255,0.5)';
                ctx.font = '10px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(val.toFixed(1), padding - 5, y + 4);
            }

            // Line
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.beginPath();
            data.forEach((val, i) => {
                const x = padding + (graphWidth / Math.max(1, data.length - 1)) * i;
                const y = height - padding - ((val - minVal) / range) * graphHeight;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
        }

        function drawPhillipsCurve() {
            const canvas = document.getElementById('phillips-chart');
            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth;
            const height = canvas.height = canvas.offsetHeight;

            ctx.clearRect(0, 0, width, height);
            if (phillipsData.length < 2) return;

            const padding = 50;
            const graphWidth = width - padding * 2;
            const graphHeight = height - padding * 2;

            const uVals = phillipsData.map(d => d.unemployment);
            const iVals = phillipsData.map(d => d.inflation);
            const minU = Math.min(...uVals) * 0.9;
            const maxU = Math.max(...uVals) * 1.1;
            const minI = Math.min(...iVals) - 1;
            const maxI = Math.max(...iVals) + 1;
            const rangeU = maxU - minU || 1;
            const rangeI = maxI - minI || 1;

            // Axes
            ctx.strokeStyle = 'rgba(255,255,255,0.3)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();

            // Labels
            ctx.fillStyle = 'rgba(255,255,255,0.7)';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Unemployment (%)', width / 2, height - 10);
            ctx.save();
            ctx.translate(15, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Inflation (%)', 0, 0);
            ctx.restore();

            // Points
            phillipsData.forEach((d, i) => {
                const x = padding + ((d.unemployment - minU) / rangeU) * graphWidth;
                const y = height - padding - ((d.inflation - minI) / rangeI) * graphHeight;

                const alpha = Math.min(1, 0.3 + (i / phillipsData.length) * 0.7);
                ctx.fillStyle = `rgba(96, 165, 250, ${alpha})`;
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        function drawHistogram(canvasId, data, bins, color) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth;
            const height = canvas.height = canvas.offsetHeight;

            ctx.clearRect(0, 0, width, height);
            if (data.length === 0) return;

            const padding = 40;
            const graphWidth = width - padding * 2;
            const graphHeight = height - padding * 2;

            const minVal = Math.min(...data);
            const maxVal = Math.max(...data);
            const binWidth = (maxVal - minVal) / bins;
            const histogram = new Array(bins).fill(0);

            data.forEach(val => {
                const binIndex = Math.min(bins - 1, Math.floor((val - minVal) / binWidth));
                histogram[binIndex]++;
            });

            const maxCount = Math.max(...histogram);

            // Axes
            ctx.strokeStyle = 'rgba(255,255,255,0.2)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();

            // Bars
            const barWidth = graphWidth / bins;
            histogram.forEach((count, i) => {
                const barHeight = (count / maxCount) * graphHeight;
                const x = padding + i * barWidth;
                const y = height - padding - barHeight;

                ctx.fillStyle = color;
                ctx.fillRect(x, y, barWidth - 2, barHeight);
            });
        }

        // ===== EVENT HANDLERS =====
        document.getElementById('start-btn').addEventListener('click', () => running = true);
        document.getElementById('pause-btn').addEventListener('click', () => running = false);
        document.getElementById('reset-btn').addEventListener('click', () => {
            running = false;
            init();
        });

        document.getElementById('demand-shock-btn').addEventListener('click', () => {
            households.forEach(h => h.wealth *= 1.2);
        });

        document.getElementById('supply-shock-btn').addEventListener('click', () => {
            supplyShock = 0.7;
        });

        document.getElementById('credit-shock-btn').addEventListener('click', () => {
            creditShockActive = true;
        });

        document.getElementById('rate-hike-btn').addEventListener('click', () => {
            const current = parseFloat(document.getElementById('natural-rate').value);
            document.getElementById('natural-rate').value = Math.min(5, current + 2);
            document.getElementById('natural-rate-display').textContent = document.getElementById('natural-rate').value + '%';
        });

        document.getElementById('rate-cut-btn').addEventListener('click', () => {
            const current = parseFloat(document.getElementById('natural-rate').value);
            document.getElementById('natural-rate').value = Math.max(0, current - 2);
            document.getElementById('natural-rate-display').textContent = document.getElementById('natural-rate').value + '%';
        });

        // Slider updates
        ['pi-target', 'phi-pi', 'phi-y', 'natural-rate', 'tax-rate', 'gov-spending', 'benefit-rate',
         'min-car', 'risk-limit', 'markup-base', 'sep-rate'].forEach(id => {
            const slider = document.getElementById(id);
            const display = document.getElementById(id + '-display');
            slider.addEventListener('input', (e) => {
                let val = e.target.value;
                if (id.includes('rate') || id.includes('target') || id.includes('car') ||
                    id.includes('spending') || id.includes('benefit') || id.includes('risk') ||
                    id.includes('markup') || id.includes('sep')) {
                    val += '%';
                }
                display.textContent = val;
            });
        });

        // ===== ANIMATION LOOP =====
        function animate() {
            if (running) step();
            requestAnimationFrame(animate);
        }

        // ===== START =====
        // Expose for enhance.js keyboard shortcuts
        window.reset = init;
        window.init = init;

        init();
        animate();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
