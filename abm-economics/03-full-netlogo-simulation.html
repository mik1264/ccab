<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Full NetLogo-Style ABM Economy</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #2a3555 100%);
            color: #fff;
            padding: 15px;
            min-height: 100vh;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 8px;
            font-size: 2.8em;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.6);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            margin-bottom: 20px;
            opacity: 0.85;
            font-size: 1em;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .controls {
            background: rgba(255, 255, 255, 0.06);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            max-height: 85vh;
            overflow-y: auto;
        }

        .controls::-webkit-scrollbar {
            width: 8px;
        }

        .controls::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
        }

        .controls::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
        }

        .control-section {
            margin-bottom: 18px;
        }

        .control-section h3 {
            font-size: 0.95em;
            margin-bottom: 12px;
            color: #60a5fa;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(96, 165, 250, 0.3);
            padding-bottom: 5px;
        }

        .control-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .control-item label {
            font-size: 0.8em;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
        }

        .control-item input[type="range"] {
            width: 100%;
            cursor: pointer;
            height: 6px;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 15px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            width: 100%;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        button.shock {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        button.policy {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        button.export {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .world-container {
            background: rgba(255, 255, 255, 0.06);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }

        .world-canvas {
            width: 100%;
            height: 600px;
            border-radius: 8px;
            background: #1a1f3a;
            cursor: crosshair;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.06);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-3px);
        }

        .metric-card h3 {
            font-size: 0.75em;
            opacity: 0.7;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .metric-card .value {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .metric-card .change {
            font-size: 0.8em;
            opacity: 0.8;
        }

        .change.positive { color: #4ade80; }
        .change.negative { color: #f87171; }
        .change.neutral { color: #fbbf24; }

        .charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 15px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.06);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }

        .chart-container.wide {
            grid-column: span 2;
        }

        .chart-container h3 {
            margin-bottom: 12px;
            font-size: 1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-info {
            font-size: 0.7em;
            opacity: 0.5;
            font-weight: normal;
        }

        canvas.chart {
            width: 100%;
            border-radius: 6px;
        }

        .time-chart { height: 180px; }
        .scatter-chart { height: 250px; }

        .legend {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 10px;
            font-size: 0.75em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .info {
            background: rgba(255, 255, 255, 0.06);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }

        .info h3 {
            margin-bottom: 12px;
            color: #60a5fa;
        }

        .info p {
            line-height: 1.6;
            opacity: 0.9;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .info ul {
            margin-left: 20px;
            line-height: 1.7;
            font-size: 0.9em;
        }

        .stat-table {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .stat-item {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 6px;
        }

        .stat-item strong {
            display: block;
            color: #60a5fa;
            font-size: 0.8em;
            margin-bottom: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåê Full NetLogo-Style ABM Economy</h1>
        <p class="subtitle">Complete Agent-Based Macroeconomic Laboratory with Spatial Dynamics | 5000 HH, 200 Firms, 5 Banks | ODD Protocol</p>

        <div class="main-grid">
            <div class="controls">
                <div class="control-section">
                    <h3>‚èØÔ∏è Simulation</h3>
                    <div class="button-group">
                        <button id="start-btn">‚ñ∂ Start</button>
                        <button id="pause-btn">‚è∏ Pause</button>
                        <button id="reset-btn">üîÑ Reset</button>
                        <button id="step-btn">‚è≠ Step</button>
                    </div>
                </div>

                <div class="control-section">
                    <h3>üí∞ Monetary Policy</h3>
                    <div class="control-grid">
                        <div class="control-item">
                            <label>œÄ* Target: <span id="pi-target-display">2.0%</span></label>
                            <input type="range" id="pi-target" min="0" max="5" step="0.5" value="2">
                        </div>
                        <div class="control-item">
                            <label>œÜ_œÄ: <span id="phi-pi-display">1.5</span></label>
                            <input type="range" id="phi-pi" min="0.5" max="3" step="0.1" value="1.5">
                        </div>
                        <div class="control-item">
                            <label>œÜ_y: <span id="phi-y-display">0.5</span></label>
                            <input type="range" id="phi-y" min="0" max="1.5" step="0.1" value="0.5">
                        </div>
                        <div class="control-item">
                            <label>i* Natural: <span id="natural-rate-display">2.0%</span></label>
                            <input type="range" id="natural-rate" min="0" max="8" step="0.5" value="2">
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>üèõÔ∏è Fiscal Policy</h3>
                    <div class="control-grid">
                        <div class="control-item">
                            <label>Tax Rate œÑ: <span id="tax-display">22%</span></label>
                            <input type="range" id="tax-rate" min="0" max="50" step="2" value="22">
                        </div>
                        <div class="control-item">
                            <label>Gov Spending G: <span id="gov-display">18%</span></label>
                            <input type="range" id="gov-spending" min="0" max="40" step="2" value="18">
                        </div>
                        <div class="control-item">
                            <label>Benefit Rate: <span id="benefit-display">50%</span></label>
                            <input type="range" id="benefit-rate" min="0" max="100" step="5" value="50">
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>üè¶ Banking & Credit</h3>
                    <div class="control-grid">
                        <div class="control-item">
                            <label>Min CAR: <span id="car-display">10%</span></label>
                            <input type="range" id="min-car" min="5" max="20" step="1" value="10">
                        </div>
                        <div class="control-item">
                            <label>Risk Limit: <span id="risk-display">3%</span></label>
                            <input type="range" id="risk-limit" min="1" max="10" step="0.5" value="3">
                        </div>
                        <div class="control-item">
                            <label>LGD: <span id="lgd-display">50%</span></label>
                            <input type="range" id="lgd" min="20" max="80" step="5" value="50">
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>üè≠ Firm Behavior</h3>
                    <div class="control-grid">
                        <div class="control-item">
                            <label>Markup Œº: <span id="markup-display">12%</span></label>
                            <input type="range" id="markup-base" min="5" max="30" step="1" value="12">
                        </div>
                        <div class="control-item">
                            <label>Price Adjust Œ≤: <span id="price-adjust-display">0.20</span></label>
                            <input type="range" id="price-adjust" min="0.05" max="0.5" step="0.05" value="0.20">
                        </div>
                        <div class="control-item">
                            <label>Wage Sticky Œ∏: <span id="wage-sticky-display">0.50</span></label>
                            <input type="range" id="wage-sticky" min="0" max="1" step="0.1" value="0.50">
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>üë• Household & Labor</h3>
                    <div class="control-grid">
                        <div class="control-item">
                            <label>PTC Mean: <span id="ptc-display">0.85</span></label>
                            <input type="range" id="ptc-mean" min="0.5" max="0.95" step="0.05" value="0.85">
                        </div>
                        <div class="control-item">
                            <label>PTC Std: <span id="ptc-std-display">0.10</span></label>
                            <input type="range" id="ptc-std" min="0" max="0.25" step="0.05" value="0.10">
                        </div>
                        <div class="control-item">
                            <label>Separation s: <span id="sep-display">2%</span></label>
                            <input type="range" id="sep-rate" min="0" max="8" step="0.5" value="2">
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>‚ö° Shocks & Interventions</h3>
                    <div class="button-group">
                        <button class="shock" id="demand-shock-btn">üìà Demand Shock (+20%)</button>
                        <button class="shock" id="supply-shock-btn">‚ö†Ô∏è Supply Shock (-30%)</button>
                        <button class="shock" id="credit-shock-btn">üí≥ Credit Crunch</button>
                        <button class="shock" id="fiscal-shock-btn">üíµ Fiscal Stimulus</button>
                        <button class="policy" id="rate-hike-btn">üìä Rate Hike (+2pp)</button>
                        <button class="policy" id="rate-cut-btn">üìâ Rate Cut (-2pp)</button>
                    </div>
                </div>

                <div class="control-section">
                    <h3>üíæ Data Export</h3>
                    <div class="button-group">
                        <button class="export" id="export-csv-btn">üìä Export Time Series CSV</button>
                        <button class="export" id="export-micro-btn">üìã Export Microdata CSV</button>
                    </div>
                </div>
            </div>

            <div class="world-container">
                <h3 style="margin-bottom: 10px;">üó∫Ô∏è Spatial Economy World</h3>
                <canvas id="world-canvas" class="world-canvas"></canvas>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #60a5fa;"></div>
                        <span>Households (employed)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f87171;"></div>
                        <span>Households (unemployed)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #fbbf24;"></div>
                        <span>Firms</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4ade80;"></div>
                        <span>Banks</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard">
            <div class="metric-card">
                <h3>Real GDP</h3>
                <div class="value" id="gdp-value">50000</div>
                <div class="change" id="gdp-change">+0.0%</div>
            </div>
            <div class="metric-card">
                <h3>Unemployment</h3>
                <div class="value" id="unemployment-value">5.0%</div>
                <div class="change" id="unemployment-change">0.0pp</div>
            </div>
            <div class="metric-card">
                <h3>Inflation (œÄ)</h3>
                <div class="value" id="inflation-value">2.0%</div>
                <div class="change" id="inflation-change">0.0pp</div>
            </div>
            <div class="metric-card">
                <h3>Policy Rate (i)</h3>
                <div class="value" id="policy-rate-value">2.0%</div>
                <div class="change" id="policy-rate-change">0.0pp</div>
            </div>
            <div class="metric-card">
                <h3>Avg Bank CAR</h3>
                <div class="value" id="car-value">12.0%</div>
                <div class="change" id="car-change">0.0pp</div>
            </div>
            <div class="metric-card">
                <h3>Default Rate</h3>
                <div class="value" id="default-value">0.5%</div>
                <div class="change" id="default-change">0.0pp</div>
            </div>
            <div class="metric-card">
                <h3>Gini (Wealth)</h3>
                <div class="value" id="gini-value">0.45</div>
                <div class="change" id="gini-change">0.00</div>
            </div>
            <div class="metric-card">
                <h3>Avg Firm Size</h3>
                <div class="value" id="firm-size-value">25</div>
                <div class="change" id="firm-size-change">0</div>
            </div>
        </div>

        <div class="charts">
            <div class="chart-container">
                <h3>GDP <span class="chart-info">(Real, Quarterly)</span></h3>
                <canvas id="gdp-chart" class="chart time-chart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Unemployment <span class="chart-info">(%)</span></h3>
                <canvas id="unemployment-chart" class="chart time-chart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Inflation <span class="chart-info">(Annual %)</span></h3>
                <canvas id="inflation-chart" class="chart time-chart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Policy Rate <span class="chart-info">(Taylor Rule)</span></h3>
                <canvas id="rate-chart" class="chart time-chart"></canvas>
            </div>
            <div class="chart-container wide">
                <h3>Phillips Curve <span class="chart-info">(œÄ vs u - Stylized Fact)</span></h3>
                <canvas id="phillips-chart" class="chart scatter-chart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Okun's Law <span class="chart-info">(ŒîY vs Œîu)</span></h3>
                <canvas id="okun-chart" class="chart scatter-chart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Wealth Distribution <span class="chart-info">(Households)</span></h3>
                <canvas id="wealth-chart" class="chart scatter-chart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Firm Size (Log-Log) <span class="chart-info">(Zipf Check)</span></h3>
                <canvas id="firm-size-chart" class="chart scatter-chart"></canvas>
            </div>
        </div>

        <div class="info">
            <h3>üìñ Model Documentation (ODD Protocol)</h3>
            <p>
                <strong>Purpose:</strong> Study how monetary/fiscal policy and credit frictions shape GDP, inflation, unemployment,
                defaults, bank leverage, and inequality through emergent, decentralized agent behavior.
            </p>
            <p>
                <strong>Agents:</strong> 5000 heterogeneous households (wealth, propensity to consume, employment status),
                200 firms (pricing, wages, inventory, debt, adaptive expectations), 5 banks (loans, deposits, equity, CAR).
            </p>
            <p>
                <strong>Key Mechanisms:</strong>
            </p>
            <ul>
                <li><strong>Taylor Rule:</strong> i = i* + œÜ_œÄ(œÄ - œÄ*) + œÜ_y¬∑gap</li>
                <li><strong>Inventory Pricing:</strong> Firms adjust prices based on inventory gaps and markup over costs</li>
                <li><strong>Credit Rationing:</strong> Banks lend if PD√óLGD ‚â§ risk_limit and post-loan CAR ‚â• minCAR</li>
                <li><strong>Adaptive Expectations:</strong> DÃÇ_t+1 = (1-Œ±)DÃÇ_t + Œ±D_t + Œµ</li>
                <li><strong>Labor Matching:</strong> Random matching with separation shocks</li>
            </ul>
            <p>
                <strong>Stylized Facts Targeted:</strong>
            </p>
            <div class="stat-table">
                <div class="stat-item"><strong>Phillips Curve</strong>Negative œÄ-u slope</div>
                <div class="stat-item"><strong>Okun's Law</strong>Negative ŒîY-Œîu relation</div>
                <div class="stat-item"><strong>Firm Sizes</strong>Zipf tail (Œ± ‚âà 1)</div>
                <div class="stat-item"><strong>Price Changes</strong>Leptokurtic (fat tails)</div>
                <div class="stat-item"><strong>Bank Leverage</strong>Pro-cyclical</div>
                <div class="stat-item"><strong>Wealth Inequality</strong>Gini ‚âà 0.35-0.55</div>
            </div>
            <p style="margin-top: 15px;">
                <strong>Reproducibility:</strong> All runs are seeded. Export CSV time series and microdata for external analysis.
                Batch experiments can sweep parameter grids to map policy trade-offs.
            </p>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        const CONFIG = {
            N_HOUSEHOLDS: 5000,
            N_FIRMS: 200,
            N_BANKS: 5,
            WORLD_SIZE: 100,
            DISPLAY_SAMPLE: 500, // Show subset for performance
            TICKS_PER_QUARTER: 3
        };

        // ===== UTILITY FUNCTIONS =====
        function normalRandom(mean = 0, std = 1) {
            let u = 0, v = 0;
            while(u === 0) u = Math.random();
            while(v === 0) v = Math.random();
            return mean + std * Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
        }

        function computeGini(values) {
            if (values.length === 0) return 0;
            const sorted = [...values].sort((a, b) => a - b);
            const n = sorted.length;
            let sum = 0, weightedSum = 0;
            for (let i = 0; i < n; i++) {
                sum += sorted[i];
                weightedSum += (i + 1) * sorted[i];
            }
            return sum === 0 ? 0 : (2 * weightedSum) / (n * sum) - (n + 1) / n;
        }

        // ===== AGENT CLASSES =====
        class Household {
            constructor(id) {
                this.id = id;
                const ptcMean = parseFloat(document.getElementById('ptc-mean').value);
                const ptcStd = parseFloat(document.getElementById('ptc-std').value);
                this.ptc = Math.max(0.5, Math.min(0.95, normalRandom(ptcMean, ptcStd)));
                this.wealth = Math.max(100, Math.exp(normalRandom(7.5, 1.3)));
                this.income = 0;
                this.employed = false;
                this.employer = null;
                this.x = Math.random() * CONFIG.WORLD_SIZE;
                this.y = Math.random() * CONFIG.WORLD_SIZE;
            }

            consume(firms) {
                const consumption = this.ptc * this.income + 0.02 * this.wealth;
                const spendable = Math.min(consumption, this.wealth * 0.8);
                if (spendable <= 0) return;

                // Buy from nearby firms (spatial locality)
                const nearby = firms.slice().sort((a, b) => {
                    const da = Math.hypot(a.x - this.x, a.y - this.y);
                    const db = Math.hypot(b.x - this.x, b.y - this.y);
                    return da - db;
                }).slice(0, 10);

                const totalPriceInv = nearby.reduce((sum, f) => sum + 1/f.price, 0);
                nearby.forEach(f => {
                    const share = (1/f.price) / totalPriceInv;
                    const spend = spendable * share;
                    const bought = f.sell(spend / f.price);
                    this.wealth -= bought * f.price;
                });
            }
        }

        class Firm {
            constructor(id) {
                this.id = id;
                this.price = Math.max(5, normalRandom(10, 2));
                this.wage = Math.max(20, normalRandom(35, 5));
                this.inventory = Math.max(0, normalRandom(100, 30));
                this.targetInventory = 100;
                this.cash = 10000;
                this.debt = 0;
                this.expectedDemand = 20;
                this.actualSales = 0;
                this.lastSales = 0;
                this.employees = [];
                this.productivity = 10;
                this.x = Math.random() * CONFIG.WORLD_SIZE;
                this.y = Math.random() * CONFIG.WORLD_SIZE;
                this.defaulted = false;
            }

            planProduction() {
                const alpha = 0.3;
                this.expectedDemand = (1 - alpha) * this.expectedDemand + alpha * this.actualSales + normalRandom(0, 2);
                this.expectedDemand = Math.max(1, this.expectedDemand);

                // Inventory-based pricing
                const invGap = (this.targetInventory - this.inventory) / Math.max(1, this.targetInventory);
                const beta = parseFloat(document.getElementById('price-adjust').value);
                this.price *= (1 + beta * invGap + normalRandom(0, 0.01));
                this.price = Math.max(5, this.price);

                // Wage adjustment
                const inflation = model.recentInflation || 0;
                const unemployment = model.unemployment || 0.05;
                const theta = parseFloat(document.getElementById('wage-sticky').value);
                const wageChange = theta * (inflation / 100) - 0.1 * (unemployment - 0.05);
                this.wage *= (1 + wageChange * 0.3);
                this.wage = Math.max(20, this.wage);

                return Math.max(0, this.expectedDemand + (this.targetInventory - this.inventory) * 0.3);
            }

            hire(household) {
                if (!household.employed) {
                    this.employees.push(household);
                    household.employed = true;
                    household.employer = this;
                }
            }

            fire(household) {
                const idx = this.employees.indexOf(household);
                if (idx > -1) {
                    this.employees.splice(idx, 1);
                    household.employed = false;
                    household.employer = null;
                }
            }

            payWages(taxRate) {
                this.employees.forEach(emp => {
                    const netWage = this.wage * (1 - taxRate);
                    emp.income = netWage;
                    emp.wealth += netWage;
                });
                this.cash -= this.wage * this.employees.length;
            }

            produce(targetProduction, shock = 1) {
                const capacity = this.employees.length * this.productivity * shock;
                const production = Math.min(targetProduction, capacity);
                this.inventory += production;
                return production;
            }

            sell(quantity) {
                const sold = Math.min(quantity, this.inventory);
                this.inventory = Math.max(0, this.inventory - sold);
                this.actualSales += sold;
                this.cash += sold * this.price;
                return sold;
            }

            resetSales() {
                this.lastSales = this.actualSales;
                this.actualSales = 0;
            }

            checkDefault() {
                if (this.cash < -this.wage * this.employees.length * 3 && this.debt > this.cash * -2) {
                    this.defaulted = true;
                    return true;
                }
                return false;
            }
        }

        class Bank {
            constructor(id) {
                this.id = id;
                this.loans = 0;
                this.deposits = 500000;
                this.equity = 60000;
                this.x = Math.random() * CONFIG.WORLD_SIZE;
                this.y = Math.random() * CONFIG.WORLD_SIZE;
            }

            getCAR() {
                return this.loans === 0 ? 1.0 : this.equity / this.loans;
            }

            lend(firm, amount, policyRate, minCAR, riskLimit, lgd) {
                const currentCAR = this.getCAR();
                const interestRate = policyRate / 100 + 0.025;
                const pd = Math.max(0.01, Math.min(0.20, Math.abs(firm.cash < 0 ? firm.cash / 20000 : 0.01)));
                const expectedLoss = pd * (lgd / 100);

                if (currentCAR < minCAR / 100) return false;
                if (expectedLoss > riskLimit / 100) return false;

                const loan = Math.min(amount, this.deposits * 0.3);
                if (loan > 0) {
                    firm.cash += loan;
                    firm.debt += loan * (1 + interestRate / 12);
                    this.loans += loan;
                    this.deposits -= loan;
                    return true;
                }
                return false;
            }

            collectDebt(firm) {
                const payment = Math.min(firm.debt * 0.05, Math.max(0, firm.cash * 0.2));
                if (payment > 0) {
                    firm.cash -= payment;
                    firm.debt -= payment;
                    this.deposits += payment;
                    this.equity += payment * 0.05;
                }
            }

            handleDefault(firm) {
                const lgd = parseFloat(document.getElementById('lgd').value) / 100;
                const loss = firm.debt * lgd;
                this.loans -= firm.debt;
                this.equity -= loss;
                firm.debt = 0;
            }
        }

        // ===== SIMULATION STATE =====
        let households = [];
        let firms = [];
        let banks = [];
        let tick = 0;
        let running = false;
        let shocks = { supply: 1.0, credit: false, fiscal: 0 };

        let model = {
            gdp: 0,
            unemployment: 0.05,
            inflation: 0.02,
            policyRate: 2.0,
            recentInflation: 2.0,
            potentialGDP: 50000,
            defaults: 0
        };

        let history = {
            gdp: [],
            unemployment: [],
            inflation: [],
            rate: [],
            phillips: [],
            okun: [],
            defaults: []
        };

        // ===== INITIALIZATION =====
        function init() {
            console.log('Initializing simulation...');
            households = [];
            firms = [];
            banks = [];
            tick = 0;
            shocks = { supply: 1.0, credit: false, fiscal: 0 };

            Object.keys(history).forEach(k => history[k] = []);

            for (let i = 0; i < CONFIG.N_HOUSEHOLDS; i++) {
                households.push(new Household(i));
            }

            for (let i = 0; i < CONFIG.N_FIRMS; i++) {
                firms.push(new Firm(i));
            }

            for (let i = 0; i < CONFIG.N_BANKS; i++) {
                banks.push(new Bank(i));
            }

            // Initial employment: 95%
            households.forEach((h, i) => {
                if (Math.random() < 0.95) {
                    const firm = firms[i % CONFIG.N_FIRMS];
                    firm.hire(h);
                }
            });

            model.potentialGDP = computeGDP();
            console.log('Initialization complete. Potential GDP:', model.potentialGDP);

            updateDashboard();
            updateCharts();
            drawWorld();
        }

        // ===== SIMULATION STEP =====
        function step() {
            tick++;

            // Get parameters
            const piTarget = parseFloat(document.getElementById('pi-target').value);
            const phiPi = parseFloat(document.getElementById('phi-pi').value);
            const phiY = parseFloat(document.getElementById('phi-y').value);
            const naturalRate = parseFloat(document.getElementById('natural-rate').value);
            const taxRate = parseFloat(document.getElementById('tax-rate').value) / 100;
            const govSpending = (parseFloat(document.getElementById('gov-spending').value) + shocks.fiscal) / 100;
            const benefitRate = parseFloat(document.getElementById('benefit-rate').value) / 100;
            const minCAR = parseFloat(document.getElementById('min-car').value);
            const riskLimit = parseFloat(document.getElementById('risk-limit').value);
            const lgd = parseFloat(document.getElementById('lgd').value);
            const separationRate = parseFloat(document.getElementById('sep-rate').value) / 100;

            // 1. TAYLOR RULE
            const outputGap = (model.gdp - model.potentialGDP) / model.potentialGDP;
            const inflationGap = model.recentInflation - piTarget;
            model.policyRate = naturalRate + phiPi * inflationGap + phiY * outputGap;
            model.policyRate = Math.max(0, Math.min(15, model.policyRate));

            // 2. FIRMS PLAN
            firms.forEach(firm => {
                if (firm.defaulted) return;
                const targetProduction = firm.planProduction();
                const laborNeeded = Math.ceil(targetProduction / firm.productivity);

                while (firm.employees.length < laborNeeded) {
                    const unemployed = households.find(h => !h.employed);
                    if (!unemployed) break;
                    firm.hire(unemployed);
                }

                firm.employees.forEach(emp => {
                    if (Math.random() < separationRate) firm.fire(emp);
                });
            });

            // 3. CREDIT
            const carAdj = shocks.credit ? 3 : 0;
            const riskAdj = shocks.credit ? -2 : 0;
            firms.forEach(firm => {
                if (firm.defaulted) return;
                const wageBill = firm.wage * firm.employees.length;
                if (firm.cash < wageBill * 1.5) {
                    const bank = banks[firm.id % CONFIG.N_BANKS];
                    bank.lend(firm, wageBill * 2, model.policyRate, minCAR + carAdj, riskLimit + riskAdj, lgd);
                }
            });

            // 4. PAY WAGES
            firms.forEach(firm => {
                if (!firm.defaulted) firm.payWages(taxRate);
            });

            const avgWage = firms.filter(f => !f.defaulted).reduce((sum, f) => sum + f.wage, 0) / firms.length;
            households.filter(h => !h.employed).forEach(h => {
                h.income = avgWage * benefitRate;
                h.wealth += h.income;
            });

            // 5. PRODUCTION
            firms.forEach(firm => {
                if (firm.defaulted) return;
                firm.resetSales();
                const targetProduction = firm.expectedDemand * 1.3;
                firm.produce(targetProduction, shocks.supply);
            });

            if (shocks.supply < 1.0) {
                shocks.supply = Math.min(1.0, shocks.supply + 0.05);
            }
            if (shocks.fiscal > 0) {
                shocks.fiscal = Math.max(0, shocks.fiscal - 1);
            }
            if (shocks.credit && tick % 12 === 0) {
                shocks.credit = false;
            }

            // 6. CONSUMPTION
            households.forEach(h => h.consume(firms.filter(f => !f.defaulted)));

            // 7. GOVERNMENT
            const gdp = computeGDP();
            const govBuy = gdp * govSpending;
            const qtyPerFirm = govBuy / firms.length / 10;
            firms.forEach(firm => {
                if (!firm.defaulted) firm.sell(qtyPerFirm);
            });

            // 8. DEBT SERVICE
            banks.forEach(bank => {
                firms.forEach(firm => {
                    if (!firm.defaulted && firm.debt > 0) {
                        bank.collectDebt(firm);
                    }
                });
            });

            // 9. DEFAULTS
            let defaults = 0;
            firms.forEach(firm => {
                if (!firm.defaulted && firm.checkDefault()) {
                    defaults++;
                    const bank = banks[firm.id % CONFIG.N_BANKS];
                    bank.handleDefault(firm);
                }
            });
            model.defaults = defaults;

            // 10. METRICS
            const unemployed = households.filter(h => !h.employed).length;
            model.unemployment = unemployed / CONFIG.N_HOUSEHOLDS;
            model.gdp = gdp;

            const avgPrice = firms.filter(f => !f.defaulted).reduce((sum, f) => sum + f.price, 0) / firms.length;
            const prevPrice = history.inflation.length > 0 ? avgPrice * (1 - history.inflation[history.inflation.length-1]/1200) : avgPrice;
            model.inflation = ((avgPrice - prevPrice) / prevPrice) * 100 * 12;
            model.recentInflation = model.inflation;

            // RECORD
            if (tick % CONFIG.TICKS_PER_QUARTER === 0) {
                history.gdp.push(model.gdp);
                history.unemployment.push(model.unemployment * 100);
                history.inflation.push(model.inflation);
                history.rate.push(model.policyRate);
                history.defaults.push((defaults / CONFIG.N_FIRMS) * 100);
                history.phillips.push({ u: model.unemployment * 100, pi: model.inflation });

                if (history.gdp.length > 1) {
                    const dgdp = (history.gdp[history.gdp.length-1] - history.gdp[history.gdp.length-2]) / history.gdp[history.gdp.length-2] * 100;
                    const du = history.unemployment[history.unemployment.length-1] - history.unemployment[history.unemployment.length-2];
                    history.okun.push({ dgdp, du });
                }

                if (history.gdp.length > 80) {
                    Object.keys(history).forEach(k => {
                        if (Array.isArray(history[k])) history[k].shift();
                    });
                }
            }

            updateDashboard();
            if (tick % 3 === 0) {
                updateCharts();
                drawWorld();
            }
        }

        function computeGDP() {
            const sales = firms.filter(f => !f.defaulted).reduce((sum, f) => sum + f.lastSales * f.price, 0);
            const govSpending = (parseFloat(document.getElementById('gov-spending').value) + shocks.fiscal) / 100;
            return sales * (1 + govSpending);
        }

        // ===== UI UPDATES =====
        function updateDashboard() {
            document.getElementById('gdp-value').textContent = model.gdp.toFixed(0);
            document.getElementById('unemployment-value').textContent = (model.unemployment * 100).toFixed(1) + '%';
            document.getElementById('inflation-value').textContent = model.inflation.toFixed(1) + '%';
            document.getElementById('policy-rate-value').textContent = model.policyRate.toFixed(1) + '%';

            const avgCAR = banks.reduce((sum, b) => sum + b.getCAR(), 0) / CONFIG.N_BANKS;
            document.getElementById('car-value').textContent = (avgCAR * 100).toFixed(1) + '%';

            const defaultRate = (firms.filter(f => f.defaulted).length / CONFIG.N_FIRMS) * 100;
            document.getElementById('default-value').textContent = defaultRate.toFixed(1) + '%';

            const gini = computeGini(households.map(h => h.wealth));
            document.getElementById('gini-value').textContent = gini.toFixed(2);

            const avgFirmSize = firms.filter(f => !f.defaulted).reduce((sum, f) => sum + f.employees.length, 0) / firms.length;
            document.getElementById('firm-size-value').textContent = avgFirmSize.toFixed(0);
        }

        // ===== WORLD VISUALIZATION =====
        function drawWorld() {
            const canvas = document.getElementById('world-canvas');
            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth;
            const height = canvas.height = canvas.offsetHeight;

            ctx.fillStyle = '#1a1f3a';
            ctx.fillRect(0, 0, width, height);

            const scale = Math.min(width, height) / CONFIG.WORLD_SIZE;

            // Draw sample of households
            const sampleHH = households.filter((_, i) => i % 10 === 0);
            sampleHH.forEach(h => {
                ctx.fillStyle = h.employed ? 'rgba(96, 165, 250, 0.6)' : 'rgba(248, 113, 113, 0.8)';
                ctx.beginPath();
                ctx.arc(h.x * scale, h.y * scale, 2, 0, Math.PI * 2);
                ctx.fill();
            });

            // Draw firms
            firms.filter(f => !f.defaulted).forEach(f => {
                const size = Math.sqrt(f.employees.length) * 0.5 + 2;
                ctx.fillStyle = 'rgba(251, 191, 36, 0.8)';
                ctx.beginPath();
                ctx.arc(f.x * scale, f.y * scale, size, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = 'rgba(251, 191, 36, 1)';
                ctx.lineWidth = 1;
                ctx.stroke();
            });

            // Draw banks
            banks.forEach(b => {
                ctx.fillStyle = 'rgba(74, 222, 128, 0.9)';
                ctx.fillRect(b.x * scale - 4, b.y * scale - 4, 8, 8);
                ctx.strokeStyle = 'rgba(74, 222, 128, 1)';
                ctx.lineWidth = 2;
                ctx.strokeRect(b.x * scale - 4, b.y * scale - 4, 8, 8);
            });
        }

        // ===== CHARTS =====
        function updateCharts() {
            drawLineChart('gdp-chart', history.gdp, '#4ade80');
            drawLineChart('unemployment-chart', history.unemployment, '#f87171');
            drawLineChart('inflation-chart', history.inflation, '#fbbf24');
            drawLineChart('rate-chart', history.rate, '#60a5fa');
            drawPhillipsCurve();
            drawOkunLaw();
            drawWealthDistribution();
            drawFirmSizeDistribution();
        }

        function drawLineChart(canvasId, data, color) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth;
            const height = canvas.height = canvas.offsetHeight;

            ctx.clearRect(0, 0, width, height);
            if (data.length < 2) return;

            const padding = 35;
            const graphWidth = width - padding * 2;
            const graphHeight = height - padding * 2;
            const minVal = Math.min(...data) * 0.95;
            const maxVal = Math.max(...data) * 1.05;
            const range = maxVal - minVal || 1;

            ctx.strokeStyle = 'rgba(255,255,255,0.15)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();

            for (let i = 0; i <= 4; i++) {
                const y = padding + (graphHeight / 4) * i;
                ctx.strokeStyle = 'rgba(255,255,255,0.05)';
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();

                const val = maxVal - (range / 4) * i;
                ctx.fillStyle = 'rgba(255,255,255,0.4)';
                ctx.font = '9px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(val.toFixed(0), padding - 5, y + 3);
            }

            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.beginPath();
            data.forEach((val, i) => {
                const x = padding + (graphWidth / Math.max(1, data.length - 1)) * i;
                const y = height - padding - ((val - minVal) / range) * graphHeight;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
        }

        function drawPhillipsCurve() {
            const canvas = document.getElementById('phillips-chart');
            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth;
            const height = canvas.height = canvas.offsetHeight;

            ctx.clearRect(0, 0, width, height);
            if (history.phillips.length < 2) return;

            const padding = 50;
            const graphWidth = width - padding * 2;
            const graphHeight = height - padding * 2;

            const uVals = history.phillips.map(d => d.u);
            const piVals = history.phillips.map(d => d.pi);
            const minU = Math.min(...uVals) * 0.9;
            const maxU = Math.max(...uVals) * 1.1;
            const minPi = Math.min(...piVals) - 1;
            const maxPi = Math.max(...piVals) + 1;
            const rangeU = maxU - minU || 1;
            const rangePi = maxPi - minPi || 1;

            ctx.strokeStyle = 'rgba(255,255,255,0.2)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();

            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            ctx.font = '11px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Unemployment (%)', width / 2, height - 10);

            history.phillips.forEach((d, i) => {
                const x = padding + ((d.u - minU) / rangeU) * graphWidth;
                const y = height - padding - ((d.pi - minPi) / rangePi) * graphHeight;
                const alpha = 0.2 + (i / history.phillips.length) * 0.6;
                ctx.fillStyle = `rgba(96, 165, 250, ${alpha})`;
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        function drawOkunLaw() {
            const canvas = document.getElementById('okun-chart');
            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth;
            const height = canvas.height = canvas.offsetHeight;

            ctx.clearRect(0, 0, width, height);
            if (history.okun.length < 2) return;

            const padding = 50;
            const graphWidth = width - padding * 2;
            const graphHeight = height - padding * 2;

            const duVals = history.okun.map(d => d.du);
            const dgdpVals = history.okun.map(d => d.dgdp);
            const minDu = Math.min(...duVals);
            const maxDu = Math.max(...duVals);
            const minDgdp = Math.min(...dgdpVals);
            const maxDgdp = Math.max(...dgdpVals);
            const rangeDu = maxDu - minDu || 1;
            const rangeDgdp = maxDgdp - minDgdp || 1;

            ctx.strokeStyle = 'rgba(255,255,255,0.2)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();

            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            ctx.font = '11px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Œîu (pp)', width / 2, height - 10);

            history.okun.forEach((d, i) => {
                const x = padding + ((d.du - minDu) / rangeDu) * graphWidth;
                const y = height - padding - ((d.dgdp - minDgdp) / rangeDgdp) * graphHeight;
                const alpha = 0.3 + (i / history.okun.length) * 0.5;
                ctx.fillStyle = `rgba(251, 191, 36, ${alpha})`;
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        function drawWealthDistribution() {
            const canvas = document.getElementById('wealth-chart');
            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth;
            const height = canvas.height = canvas.offsetHeight;

            ctx.clearRect(0, 0, width, height);

            const wealthVals = households.map(h => Math.log10(h.wealth + 1));
            const bins = 30;
            const minVal = Math.min(...wealthVals);
            const maxVal = Math.max(...wealthVals);
            const binWidth = (maxVal - minVal) / bins;
            const histogram = new Array(bins).fill(0);

            wealthVals.forEach(val => {
                const binIndex = Math.min(bins - 1, Math.floor((val - minVal) / binWidth));
                histogram[binIndex]++;
            });

            const maxCount = Math.max(...histogram);
            const padding = 40;
            const graphWidth = width - padding * 2;
            const graphHeight = height - padding * 2;
            const barWidth = graphWidth / bins;

            ctx.strokeStyle = 'rgba(255,255,255,0.2)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();

            histogram.forEach((count, i) => {
                const barHeight = (count / maxCount) * graphHeight;
                const x = padding + i * barWidth;
                const y = height - padding - barHeight;
                ctx.fillStyle = 'rgba(167, 139, 250, 0.7)';
                ctx.fillRect(x, y, barWidth - 1, barHeight);
            });

            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Log10(Wealth)', width / 2, height - 5);
        }

        function drawFirmSizeDistribution() {
            const canvas = document.getElementById('firm-size-chart');
            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth;
            const height = canvas.height = canvas.offsetHeight;

            ctx.clearRect(0, 0, width, height);

            const sizes = firms.filter(f => !f.defaulted && f.employees.length > 0).map(f => f.employees.length);
            if (sizes.length === 0) return;

            const sorted = [...sizes].sort((a, b) => b - a);
            const logSizes = sorted.map(s => Math.log10(s));
            const logRanks = sorted.map((_, i) => Math.log10(i + 1));

            const padding = 50;
            const graphWidth = width - padding * 2;
            const graphHeight = height - padding * 2;

            const minX = 0;
            const maxX = Math.max(...logRanks);
            const minY = Math.min(...logSizes);
            const maxY = Math.max(...logSizes);
            const rangeX = maxX - minX || 1;
            const rangeY = maxY - minY || 1;

            ctx.strokeStyle = 'rgba(255,255,255,0.2)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();

            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Log10(Rank)', width / 2, height - 5);

            logRanks.forEach((logRank, i) => {
                const x = padding + ((logRank - minX) / rangeX) * graphWidth;
                const y = height - padding - ((logSizes[i] - minY) / rangeY) * graphHeight;
                ctx.fillStyle = 'rgba(52, 211, 153, 0.7)';
                ctx.beginPath();
                ctx.arc(x, y, 2, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        // ===== EVENT HANDLERS =====
        document.getElementById('start-btn').addEventListener('click', () => running = true);
        document.getElementById('pause-btn').addEventListener('click', () => running = false);
        document.getElementById('reset-btn').addEventListener('click', () => {
            running = false;
            init();
        });
        document.getElementById('step-btn').addEventListener('click', () => {
            running = false;
            step();
        });

        document.getElementById('demand-shock-btn').addEventListener('click', () => {
            households.forEach(h => h.wealth *= 1.2);
        });

        document.getElementById('supply-shock-btn').addEventListener('click', () => {
            shocks.supply = 0.7;
        });

        document.getElementById('credit-shock-btn').addEventListener('click', () => {
            shocks.credit = true;
        });

        document.getElementById('fiscal-shock-btn').addEventListener('click', () => {
            shocks.fiscal += 10;
        });

        document.getElementById('rate-hike-btn').addEventListener('click', () => {
            const current = parseFloat(document.getElementById('natural-rate').value);
            document.getElementById('natural-rate').value = Math.min(8, current + 2);
            document.getElementById('natural-rate-display').textContent = document.getElementById('natural-rate').value + '%';
        });

        document.getElementById('rate-cut-btn').addEventListener('click', () => {
            const current = parseFloat(document.getElementById('natural-rate').value);
            document.getElementById('natural-rate').value = Math.max(0, current - 2);
            document.getElementById('natural-rate-display').textContent = document.getElementById('natural-rate').value + '%';
        });

        document.getElementById('export-csv-btn').addEventListener('click', () => {
            let csv = 'Quarter,GDP,Unemployment,Inflation,PolicyRate,DefaultRate\n';
            for (let i = 0; i < history.gdp.length; i++) {
                csv += `${i},${history.gdp[i]},${history.unemployment[i]},${history.inflation[i]},${history.rate[i]},${history.defaults[i] || 0}\n`;
            }
            downloadCSV(csv, 'abm_timeseries.csv');
        });

        document.getElementById('export-micro-btn').addEventListener('click', () => {
            let csv = 'AgentType,ID,Wealth,Income,Employed,EmployeeCount,Price,Wage,Inventory,Debt\n';
            households.slice(0, 1000).forEach(h => {
                csv += `Household,${h.id},${h.wealth},${h.income},${h.employed},,,,, \n`;
            });
            firms.slice(0, 200).forEach(f => {
                csv += `Firm,${f.id},,,${f.employees.length},${f.price},${f.wage},${f.inventory},${f.debt}\n`;
            });
            downloadCSV(csv, 'abm_microdata.csv');
        });

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Slider updates
        const sliderIds = ['pi-target', 'phi-pi', 'phi-y', 'natural-rate', 'tax-rate', 'gov-spending',
                           'benefit-rate', 'min-car', 'risk-limit', 'lgd', 'markup-base', 'price-adjust',
                           'wage-sticky', 'ptc-mean', 'ptc-std', 'sep-rate'];

        sliderIds.forEach(id => {
            const slider = document.getElementById(id);
            const display = document.getElementById(id + '-display');
            if (slider && display) {
                slider.addEventListener('input', (e) => {
                    let val = e.target.value;
                    if (id.includes('rate') || id.includes('target') || id.includes('car') ||
                        id.includes('spending') || id.includes('benefit') || id.includes('risk') ||
                        id.includes('markup') || id.includes('lgd') || id.includes('sep') ||
                        id.includes('tax')) {
                        val += '%';
                    }
                    display.textContent = val;
                });
            }
        });

        // ===== ANIMATION LOOP =====
        function animate() {
            if (running) step();
            requestAnimationFrame(animate);
        }

        // ===== START =====
        console.log('Starting Full NetLogo-style ABM...');
        // Expose for enhance.js keyboard shortcuts
        window.reset = init;
        window.init = init;

        init();
        animate();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
