<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2D Diffusion Equation</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; overflow: hidden; font-family: sans-serif; }
canvas { display: block; cursor: crosshair; }
.title-overlay {
    position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
    color: #fbbf24; font-size: 20px; font-weight: bold; z-index: 999;
    text-shadow: 0 0 10px rgba(0,0,0,0.8); pointer-events: none;
}
.controls {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
    display: flex; gap: 20px; align-items: center; z-index: 999;
    background: rgba(0,0,0,0.7); padding: 12px 20px; border-radius: 10px;
    flex-wrap: wrap; justify-content: center;
}
.controls label { color: #ccc; font-size: 13px; }
.controls input[type=range] { width: 100px; cursor: pointer; }
.controls span { color: #fbbf24; font-size: 13px; min-width: 40px; }
.controls button {
    padding: 6px 14px; background: #fbbf24; color: #0a0e1a; border: none;
    border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: bold;
}
.color-btn {
    width: 28px; height: 28px; border-radius: 50%; border: 2px solid #fff;
    cursor: pointer; transition: transform 0.2s;
}
.color-btn:hover { transform: scale(1.2); }
.color-btn.active { border: 3px solid #fbbf24; transform: scale(1.2); }
.info {
    position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
    color: rgba(255,255,255,0.5); font-size: 12px; z-index: 999;
    pointer-events: none; text-align: center;
}
</style>
</head>
<body>
<a href="../index.html" style="position:fixed;top:10px;left:10px;padding:8px 16px;background:rgba(0,0,0,0.7);color:#fbbf24;text-decoration:none;border-radius:6px;font-size:14px;z-index:999;font-family:sans-serif;">‚Üê Back to Gallery</a>
<div class="title-overlay">2D Diffusion Equation</div>
<div class="info">Click or drag to place dye sources. Select color below.</div>
<div class="controls">
    <label>Diffusion</label>
    <input type="range" id="diffSlider" min="1" max="50" value="20" step="1">
    <span id="diffVal">0.20</span>
    <div class="color-btn active" id="c0" style="background: #ff3366;" onclick="selectColor(0)"></div>
    <div class="color-btn" id="c1" style="background: #33ff66;" onclick="selectColor(1)"></div>
    <div class="color-btn" id="c2" style="background: #3366ff;" onclick="selectColor(2)"></div>
    <div class="color-btn" id="c3" style="background: #ffcc00;" onclick="selectColor(3)"></div>
    <div class="color-btn" id="c4" style="background: #cc33ff;" onclick="selectColor(4)"></div>
    <button id="resetBtn">Clear</button>
</div>
<canvas id="canvas"></canvas>
<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const SCALE = 2;
let W, H, NX, NY;
let concentrations = []; // One grid per color channel
const NUM_COLORS = 5;
const COLORS = [
    [1.0, 0.2, 0.4],   // Pink/Red
    [0.2, 1.0, 0.4],   // Green
    [0.2, 0.4, 1.0],   // Blue
    [1.0, 0.8, 0.0],   // Yellow
    [0.8, 0.2, 1.0],   // Purple
];

let selectedColor = 0;
let mouseDown = false;
let mouseX = 0, mouseY = 0;

function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
    NX = Math.floor(W / SCALE);
    NY = Math.floor(H / SCALE);
    init();
}

function init() {
    concentrations = [];
    for (let c = 0; c < NUM_COLORS; c++) {
        concentrations.push(new Float32Array(NX * NY));
    }
}

function selectColor(idx) {
    selectedColor = idx;
    for (let i = 0; i < NUM_COLORS; i++) {
        document.getElementById('c' + i).classList.toggle('active', i === idx);
    }
}

function addDye(px, py, colorIdx, radius) {
    const gx = Math.floor(px / SCALE);
    const gy = Math.floor(py / SCALE);
    const r = Math.floor(radius / SCALE);
    const grid = concentrations[colorIdx];

    for (let dy = -r; dy <= r; dy++) {
        for (let dx = -r; dx <= r; dx++) {
            const x = gx + dx;
            const y = gy + dy;
            if (x >= 0 && x < NX && y >= 0 && y < NY) {
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist < r) {
                    const strength = Math.max(0, 1 - dist / r);
                    grid[y * NX + x] = Math.min(1, grid[y * NX + x] + strength * 0.5);
                }
            }
        }
    }
}

function step() {
    const D = parseInt(document.getElementById('diffSlider').value) * 0.01;
    const dt = 0.25; // Stability: dt <= 1/(4*D)

    for (let c = 0; c < NUM_COLORS; c++) {
        const grid = concentrations[c];
        const newGrid = new Float32Array(NX * NY);

        for (let y = 1; y < NY - 1; y++) {
            for (let x = 1; x < NX - 1; x++) {
                const n = y * NX + x;
                const laplacian = grid[n - 1] + grid[n + 1] + grid[n - NX] + grid[n + NX] - 4 * grid[n];
                newGrid[n] = grid[n] + D * dt * laplacian;
                // Slight decay to prevent saturation
                newGrid[n] *= 0.9999;
            }
        }
        concentrations[c] = newGrid;
    }
}

let imageData;
function render() {
    if (!imageData || imageData.width !== NX || imageData.height !== NY) {
        imageData = ctx.createImageData(NX, NY);
    }
    const data = imageData.data;

    for (let y = 0; y < NY; y++) {
        for (let x = 0; x < NX; x++) {
            const n = y * NX + x;
            const p = n * 4;
            let r = 10, g = 14, b = 26; // Background color #0a0e1a

            for (let c = 0; c < NUM_COLORS; c++) {
                const val = concentrations[c][n];
                if (val > 0.001) {
                    r += val * COLORS[c][0] * 255;
                    g += val * COLORS[c][1] * 255;
                    b += val * COLORS[c][2] * 255;
                }
            }

            data[p] = Math.min(255, r);
            data[p+1] = Math.min(255, g);
            data[p+2] = Math.min(255, b);
            data[p+3] = 255;
        }
    }

    const off = document.createElement('canvas');
    off.width = NX; off.height = NY;
    off.getContext('2d').putImageData(imageData, 0, 0);
    ctx.imageSmoothingEnabled = true;
    ctx.drawImage(off, 0, 0, W, H);
}

// Mouse events
canvas.addEventListener('mousedown', (e) => {
    mouseDown = true;
    mouseX = e.clientX;
    mouseY = e.clientY;
    addDye(mouseX, mouseY, selectedColor, 30);
});
canvas.addEventListener('mousemove', (e) => {
    mouseX = e.clientX;
    mouseY = e.clientY;
    if (mouseDown) addDye(mouseX, mouseY, selectedColor, 20);
});
canvas.addEventListener('mouseup', () => mouseDown = false);
canvas.addEventListener('mouseleave', () => mouseDown = false);

// Touch events
canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    const t = e.touches[0];
    mouseDown = true;
    addDye(t.clientX, t.clientY, selectedColor, 30);
});
canvas.addEventListener('touchmove', (e) => {
    e.preventDefault();
    const t = e.touches[0];
    if (mouseDown) addDye(t.clientX, t.clientY, selectedColor, 20);
});
canvas.addEventListener('touchend', () => mouseDown = false);

document.getElementById('diffSlider').addEventListener('input', function() {
    document.getElementById('diffVal').textContent = (this.value / 100).toFixed(2);
});
document.getElementById('resetBtn').addEventListener('click', init);

// Start with some initial dye blobs
function addInitialBlobs() {
    const cx = W / 2, cy = H / 2;
    addDye(cx - 100, cy - 50, 0, 50);
    addDye(cx + 100, cy - 50, 1, 50);
    addDye(cx, cy + 80, 2, 50);
    addDye(cx - 80, cy + 30, 3, 40);
    addDye(cx + 80, cy + 30, 4, 40);
}

function animate() {
    for (let i = 0; i < 5; i++) step();
    render();
    requestAnimationFrame(animate);
}

window.addEventListener('resize', resize);
resize();
addInitialBlobs();
animate();
</script>
</body>
</html>
