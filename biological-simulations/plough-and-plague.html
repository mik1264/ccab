<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plough & Plague - Medieval Economics ABM</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #4a3520 0%, #2d1f12 100%);
            color: white;
            overflow-x: hidden;
        }

        .container {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 20px;
            padding: 20px;
            max-width: 1800px;
            margin: 0 auto;
        }

        .panel {
            background: rgba(0, 0, 0, 0.6);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        h1 {
            text-align: center;
            grid-column: 1 / -1;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .subtitle {
            text-align: center;
            grid-column: 1 / -1;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 20px;
            font-size: 1.1rem;
        }

        canvas {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            background: #1a1410;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group h3 {
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #d4af37;
            border-bottom: 1px solid rgba(212, 175, 55, 0.3);
            padding-bottom: 5px;
        }

        .control {
            margin-bottom: 12px;
        }

        label {
            display: block;
            font-size: 0.9rem;
            margin-bottom: 4px;
            color: rgba(255, 255, 255, 0.9);
        }

        input[type="range"] {
            width: 100%;
            accent-color: #d4af37;
        }

        .value-display {
            float: right;
            font-weight: bold;
            color: #d4af37;
        }

        button {
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #d4af37 0%, #aa8c2a 100%);
            border: none;
            border-radius: 5px;
            color: #2d1f12;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.4);
        }

        button.secondary {
            background: linear-gradient(135deg, #666 0%, #444 100%);
            color: white;
        }

        .switch {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .switch input {
            width: 40px;
            height: 20px;
        }

        .monitor {
            background: rgba(0, 0, 0, 0.4);
            padding: 8px;
            border-radius: 5px;
            margin-bottom: 8px;
            border-left: 3px solid #d4af37;
        }

        .monitor-label {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .monitor-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #d4af37;
        }

        .chart {
            width: 100%;
            height: 150px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 5px;
            margin-bottom: 15px;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chart-title {
            position: absolute;
            top: 5px;
            left: 8px;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .scenario-buttons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }

        .legend {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 15px;
            font-size: 0.85rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .info-text {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.4;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <a href="index.html" class="organic-back-link" style="position: fixed; top: 20px; left: 20px; z-index: 1000; display: flex; align-items: center; gap: 8px; padding: 10px 16px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-radius: 30px; text-decoration: none; color: #606C38; font-family: 'Nunito', sans-serif; font-weight: 600; box-shadow: 0 2px 10px rgba(0,0,0,0.1); transition: all 0.3s ease;">
        <span class="back-arrow">‚Üê</span>
        <span class="back-text">Gallery</span>
    </a>
    <div class="container">
        <h1>‚öîÔ∏è Plough & Plague ‚öîÔ∏è</h1>
        <p class="subtitle">Agent-Based Medieval Economics Simulation (13th-15th Century)</p>

        <!-- Left Panel: Controls -->
        <div class="panel">
            <div class="control-group">
                <h3>‚èØÔ∏è Simulation Control</h3>
                <button id="startBtn">‚ñ∂Ô∏è Start Simulation</button>
                <button id="pauseBtn" class="secondary">‚è∏Ô∏è Pause</button>
                <button id="resetBtn" class="secondary">üîÑ Reset</button>
            </div>

            <div class="control-group">
                <h3>üè∞ Scenario Presets</h3>
                <div class="scenario-buttons">
                    <button onclick="loadScenario('baseline')">Baseline (1300)</button>
                    <button onclick="loadScenario('famine')">Great Famine (1315)</button>
                    <button onclick="loadScenario('plague')">Black Death (1348)</button>
                    <button onclick="loadScenario('littleice')">Little Ice Age</button>
                </div>
            </div>

            <div class="control-group">
                <h3>üë• Population & Land</h3>
                <div class="control">
                    <label>Households: <span class="value-display" id="householdsVal">500</span></label>
                    <input type="range" id="households" min="100" max="1000" value="500" step="50">
                </div>
                <div class="control">
                    <label>Land per Household: <span class="value-display" id="landVal">3.0</span></label>
                    <input type="range" id="landPerHousehold" min="1" max="8" value="3" step="0.5">
                </div>
            </div>

            <div class="control-group">
                <h3>üåæ Production & Yields</h3>
                <div class="control">
                    <label>Base Yield Ratio: <span class="value-display" id="yieldVal">4.5</span></label>
                    <input type="range" id="baseYield" min="2" max="8" value="4.5" step="0.5">
                </div>
                <div class="control">
                    <label>Weather Variance: <span class="value-display" id="weatherVal">0.20</span></label>
                    <input type="range" id="weatherVar" min="0.05" max="0.40" value="0.20" step="0.05">
                </div>
            </div>

            <div class="control-group">
                <h3>‚õ™ Institutions</h3>
                <div class="control">
                    <label>Tithe Rate: <span class="value-display" id="titheVal">10%</span></label>
                    <input type="range" id="titheRate" min="0" max="20" value="10" step="1">
                </div>
                <div class="control">
                    <label>Initial Commutation: <span class="value-display" id="commutVal">30%</span></label>
                    <input type="range" id="commutation" min="0" max="100" value="30" step="5">
                </div>
                <div class="control">
                    <label>Guild Power: <span class="value-display" id="guildVal">0.50</span></label>
                    <input type="range" id="guildPower" min="0" max="1" value="0.5" step="0.1">
                </div>
            </div>
        </div>

        <!-- Center Panel: Visualization -->
        <div>
            <canvas id="canvas" width="800" height="600"></canvas>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #8b4513;"></div>
                    <span>Low Fertility</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #228b22;"></div>
                    <span>High Fertility</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #4169e1;"></div>
                    <span>Households</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #dc143c;"></div>
                    <span>Lords</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffd700;"></div>
                    <span>Towns/Markets</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #800080;"></div>
                    <span>Infected (Plague)</span>
                </div>
            </div>

            <p class="info-text">
                This simulation reproduces core medieval economic dynamics: Malthusian population pressure,
                harvest risk, manorial obligations, wage-rent dynamics, and catastrophic shocks (famine, plague).
                Watch how real wages rise and rents fall after the Black Death of 1348-1351.
            </p>
        </div>

        <!-- Right Panel: Monitors & Charts -->
        <div class="panel">
            <div class="control-group">
                <h3>‚ö° Shock Events</h3>
                <div class="switch">
                    <label>Great Famine (1315-17)</label>
                    <input type="checkbox" id="enableFamine">
                </div>
                <div class="switch">
                    <label>Black Death (1348-51)</label>
                    <input type="checkbox" id="enablePlague">
                </div>
                <div class="switch">
                    <label>Little Ice Age Drift</label>
                    <input type="checkbox" id="enableLIA">
                </div>
                <div class="switch">
                    <label>Guild Restrictions</label>
                    <input type="checkbox" id="enableGuilds" checked>
                </div>
            </div>

            <div class="control-group">
                <h3>üìä Current State (Year <span id="yearDisplay">1300</span>)</h3>
                <div class="monitor">
                    <div class="monitor-label">Population</div>
                    <div class="monitor-value" id="popMonitor">0</div>
                </div>
                <div class="monitor">
                    <div class="monitor-label">Real Wage (grain/day)</div>
                    <div class="monitor-value" id="wageMonitor">0.0</div>
                </div>
                <div class="monitor">
                    <div class="monitor-label">Grain Price (silver/unit)</div>
                    <div class="monitor-value" id="priceMonitor">0.0</div>
                </div>
                <div class="monitor">
                    <div class="monitor-label">Average Yield Ratio</div>
                    <div class="monitor-value" id="yieldMonitor">0.0</div>
                </div>
                <div class="monitor">
                    <div class="monitor-label">Land Rent (silver/acre)</div>
                    <div class="monitor-value" id="rentMonitor">0.0</div>
                </div>
                <div class="monitor">
                    <div class="monitor-label">Commutation Rate</div>
                    <div class="monitor-value" id="commutMonitor">0%</div>
                </div>
            </div>

            <div class="control-group">
                <h3>üìà Time Series</h3>
                <canvas id="popChart" class="chart"></canvas>
                <div class="chart-title">Population Over Time</div>

                <canvas id="wageChart" class="chart"></canvas>
                <div class="chart-title">Real Wages</div>

                <canvas id="priceChart" class="chart"></canvas>
                <div class="chart-title">Grain Prices</div>
            </div>
        </div>
    </div>

    <script src="../assets/js/demo-utils.js"></script>
    <script>
        // ============================================================================
        // GLOBAL CONFIGURATION & STATE
        // ============================================================================

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // Initialize demo utilities
        const fps = new FPSCounter({ position: 'top-right' });
        const errorMgr = new ErrorManager();
        setupGlobalErrorHandler((msg, details) => errorMgr.show(msg, details));
        fps.start();

        const config = {
            gridWidth: 40,
            gridHeight: 30,
            cellSize: 20,
            ticksPerYear: 4, // Seasonal ticks

            // Economic parameters (defaults from PRD)
            baseYieldRatio: 4.5,
            weatherSD: 0.20,
            titheRate: 0.10,
            subsidenceNeed: 1.0, // Normalized grain need per adult per year

            // Demographics
            baseMortality: 0.02, // 2% per year
            baseFertility: 0.03, // 3% per year

            // Institutional
            initialCommutation: 0.30,
            guildPower: 0.5,

            // Shocks
            enableFamine: false,
            enablePlague: false,
            enableLIA: false,
            enableGuilds: true,

            // Plague parameters (Black Death)
            plagueIFR: 0.40, // 40% mortality
            plagueBeta: 0.3, // Transmission rate
            plagueGamma: 0.25, // Recovery rate (4-day infection period)
        };

        let state = {
            running: false,
            tick: 0,
            year: 1300,
            season: 0, // 0=spring, 1=summer, 2=fall, 3=winter

            patches: [],
            households: [],
            lords: [],
            artisans: [],

            // Market state
            grainPrice: 1.0,
            wages: 0.1, // Daily wage in silver
            landRent: 0.5, // Rent per acre in silver

            // Aggregate stats
            totalPopulation: 0,
            totalGrain: 0,
            totalSilver: 0,
            avgYield: 0,
            realWage: 0,
            commutationShare: 0.30,

            // Weather state (AR(1) process)
            weatherMean: 1.0,
            weatherCurrent: 1.0,
            weatherAR: 0.7, // Autocorrelation

            // Plague SIR state
            plagueActive: false,
            plagueStartTick: -1,
            susceptible: 0,
            infected: 0,
            recovered: 0,

            // Time series data
            history: {
                population: [],
                realWage: [],
                grainPrice: [],
                landRent: [],
                avgYield: [],
                commutation: [],
            }
        };

        // ============================================================================
        // PATCH CLASS - Land Tiles
        // ============================================================================

        class Patch {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.fertility = 0.7 + Math.random() * 0.3; // 0.7 to 1.0
                this.landType = 'arable'; // arable, pasture, town
                this.owner = null; // Reference to lord
                this.rainfall = 1.0;
                this.fallow = false;
                this.yearsSinceFallow = 0;
            }

            regenerate() {
                // 3-field rotation: fallow recovers fertility
                if (this.fallow) {
                    this.fertility = Math.min(1.0, this.fertility + 0.1);
                    this.yearsSinceFallow = 0;
                } else {
                    this.fertility = Math.max(0.3, this.fertility - 0.05);
                    this.yearsSinceFallow++;
                }
            }

            getColor() {
                if (this.landType === 'town') return '#ffd700';
                if (this.landType === 'pasture') return '#90EE90';

                // Arable: color by fertility (brown to green)
                const f = this.fertility;
                const r = Math.floor(139 * (1 - f) + 34 * f);
                const g = Math.floor(69 * (1 - f) + 139 * f);
                const b = Math.floor(19 * (1 - f) + 34 * f);
                return `rgb(${r}, ${g}, ${b})`;
            }
        }

        // ============================================================================
        // HOUSEHOLD CLASS - Peasant Agents
        // ============================================================================

        class Household {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.members = 4; // Adults + children (avg household)
                this.adults = 2;
                this.grain = 5.0; // Stock
                this.seed = 2.0;
                this.silver = 1.0;
                this.livestock = 1.0; // Normalized composite
                this.plots = []; // Assigned patches
                this.health = 100;
                this.diseaseState = 'S'; // S, I, R
                this.infectionTime = 0;
            }

            plant(patches) {
                // Spring planting: allocate seed to plots
                let seedPerPlot = this.seed / this.plots.length;
                this.seedPlanted = seedPerPlot * this.plots.length;
                this.seed = 0; // All seed planted
            }

            harvest(weather) {
                // Fall harvest: calculate yield
                let totalHarvest = 0;
                for (let patch of this.plots) {
                    if (patch.fallow) continue;

                    const baseYield = config.baseYieldRatio;
                    const weatherMult = weather;
                    const fertilityMult = patch.fertility;
                    const livestockBonus = 1 + 0.1 * this.livestock;

                    const seedPerPlot = this.seedPlanted / this.plots.length;
                    const harvest = seedPerPlot * baseYield * weatherMult * fertilityMult * livestockBonus;
                    totalHarvest += harvest;
                }

                this.grain += totalHarvest;
                return totalHarvest;
            }

            payObligations(titheRate, rentShare, cashRent) {
                // Pay tithe (10% of grain)
                const tithe = this.grain * titheRate;
                this.grain -= tithe;

                // Pay rent (mix of labor/kind/cash based on commutation)
                const rentGrain = this.grain * rentShare * (1 - state.commutationShare);
                const rentCash = cashRent * state.commutationShare;

                this.grain -= rentGrain;
                this.silver -= rentCash;

                return { tithe, rentGrain, rentCash };
            }

            consume() {
                // Winter consumption: need subsistence
                const need = config.subsidenceNeed * this.adults / config.ticksPerYear;
                const consumed = Math.min(this.grain, need);
                this.grain -= consumed;

                // Malnutrition if shortfall
                const shortfall = Math.max(0, need - consumed);
                if (shortfall > 0) {
                    this.health -= shortfall * 20;
                }

                // Health regenerates slowly
                this.health = Math.min(100, this.health + 1);

                return consumed;
            }

            trade(market) {
                // Simple trading: sell excess grain, buy if deficit
                const excess = this.grain - 2.0; // Keep reserve
                if (excess > 1.0 && state.grainPrice > 0) {
                    this.silver += excess * state.grainPrice * 0.9; // Sell at 90% market
                    this.grain -= excess;
                } else if (this.grain < 1.0 && this.silver > state.grainPrice) {
                    const toBuy = Math.min(2.0, this.silver / state.grainPrice);
                    this.grain += toBuy;
                    this.silver -= toBuy * state.grainPrice;
                }
            }

            updateDisease(beta, gamma) {
                if (this.diseaseState === 'S' && state.infected > 0) {
                    // Susceptible: check infection
                    const infectionProb = beta * state.infected / state.totalPopulation;
                    if (Math.random() < infectionProb / config.ticksPerYear) {
                        this.diseaseState = 'I';
                        this.infectionTime = 0;
                    }
                } else if (this.diseaseState === 'I') {
                    this.infectionTime++;
                    // Infection lasts ~4 ticks (1 year), then recover or die
                    if (this.infectionTime > 4) {
                        if (Math.random() < config.plagueIFR) {
                            this.health = 0; // Dies
                        } else {
                            this.diseaseState = 'R';
                        }
                    }
                }
            }

            isDead() {
                // Mortality check
                if (this.health <= 0) return true;

                // Baseline mortality
                const mortalityProb = config.baseMortality / config.ticksPerYear;
                return Math.random() < mortalityProb;
            }

            reproduce() {
                // Birth: depends on real income (simplified)
                const fertilityRate = config.baseFertility * (this.grain > 3 ? 1.2 : 0.8);
                const birthProb = fertilityRate / config.ticksPerYear;

                if (Math.random() < birthProb && this.members < 8) {
                    this.members += 1;
                    if (this.members > 4) this.adults += 0.5;
                }
            }
        }

        // ============================================================================
        // LORD CLASS - Manorial Lords
        // ============================================================================

        class Lord {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.demesne = []; // Own plots
                this.tenants = []; // Peasant households
                this.cashRent = 0;
                this.grainRent = 0;
                this.postedWage = 0.1;
            }

            collectRents() {
                this.cashRent = 0;
                this.grainRent = 0;
                for (let tenant of this.tenants) {
                    this.cashRent += tenant.silver * 0.1; // Simple rent
                    this.grainRent += tenant.grain * 0.05;
                }
            }

            adjustWages() {
                // Post-plague: labor scarce, wages rise
                const laborSupply = this.tenants.length;
                const laborDemand = this.demesne.length * 2; // Simplified

                const excessDemand = laborDemand - laborSupply;
                const adjustment = 0.01 * excessDemand / Math.max(1, laborSupply);

                this.postedWage = Math.max(0.05, Math.min(0.3, this.postedWage + adjustment));
                state.wages = this.postedWage;
            }
        }

        // ============================================================================
        // ARTISAN CLASS - Urban Craftspeople
        // ============================================================================

        class Artisan {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.capacity = 10;
                this.stock = 5;
                this.price = 1.5;
                this.guild = config.enableGuilds;
            }

            produce() {
                if (this.guild && Math.random() > 0.7) return; // Guild limits output
                this.stock += this.capacity * 0.1;
            }

            adjustPrice() {
                // Simple supply-demand
                if (this.stock > 20) this.price *= 0.95;
                else if (this.stock < 5) this.price *= 1.05;
            }
        }

        // ============================================================================
        // INITIALIZATION
        // ============================================================================

        function initSimulation() {
            state.patches = [];
            state.households = [];
            state.lords = [];
            state.artisans = [];
            state.tick = 0;
            state.year = 1300;
            state.season = 0;
            state.totalPopulation = 0;
            state.plagueActive = false;
            state.infected = 0;
            state.susceptible = 0;
            state.recovered = 0;

            // Reset history
            for (let key in state.history) {
                state.history[key] = [];
            }

            // Create patches (grid)
            for (let y = 0; y < config.gridHeight; y++) {
                for (let x = 0; x < config.gridWidth; x++) {
                    const patch = new Patch(x, y);

                    // Some patches are towns (markets)
                    if (Math.random() < 0.05) {
                        patch.landType = 'town';
                    }

                    state.patches.push(patch);
                }
            }

            // Create lords (sparse)
            const numLords = 10;
            for (let i = 0; i < numLords; i++) {
                const x = Math.floor(Math.random() * config.gridWidth);
                const y = Math.floor(Math.random() * config.gridHeight);
                const lord = new Lord(x, y);

                // Assign demesne (nearby plots)
                lord.demesne = state.patches.filter(p =>
                    p.landType === 'arable' &&
                    Math.hypot(p.x - x, p.y - y) < 3 &&
                    !p.owner
                ).slice(0, 10);

                lord.demesne.forEach(p => p.owner = lord);
                state.lords.push(lord);
            }

            // Create households
            const numHouseholds = parseInt(document.getElementById('households').value);
            const landsPerHousehold = parseFloat(document.getElementById('landPerHousehold').value);

            for (let i = 0; i < numHouseholds; i++) {
                const x = Math.floor(Math.random() * config.gridWidth);
                const y = Math.floor(Math.random() * config.gridHeight);
                const household = new Household(x, y);

                // Assign plots
                const availablePlots = state.patches.filter(p =>
                    p.landType === 'arable' && !p.owner &&
                    Math.hypot(p.x - x, p.y - y) < 5
                );

                household.plots = availablePlots.slice(0, Math.floor(landsPerHousehold));
                household.plots.forEach(p => p.owner = household);

                // Assign to nearest lord
                let nearestLord = state.lords[0];
                let minDist = Infinity;
                for (let lord of state.lords) {
                    const dist = Math.hypot(lord.x - x, lord.y - y);
                    if (dist < minDist) {
                        minDist = dist;
                        nearestLord = lord;
                    }
                }
                nearestLord.tenants.push(household);

                state.households.push(household);
            }

            // Create artisans in towns
            const townPatches = state.patches.filter(p => p.landType === 'town');
            for (let town of townPatches) {
                const artisan = new Artisan(town.x, town.y);
                state.artisans.push(artisan);
            }

            updateStats();
            draw();
        }

        // ============================================================================
        // SIMULATION TICK
        // ============================================================================

        function tick() {
            state.tick++;
            state.season = state.tick % config.ticksPerYear;

            if (state.season === 0) {
                state.year++;
            }

            // Weather update (AR(1) with potential Little Ice Age drift)
            const weatherShock = (Math.random() - 0.5) * 2 * config.weatherSD;
            state.weatherCurrent = state.weatherAR * state.weatherCurrent + (1 - state.weatherAR) * state.weatherMean + weatherShock;
            state.weatherCurrent = Math.max(0.5, Math.min(1.5, state.weatherCurrent));

            // Little Ice Age: gradual cooling, more variance
            if (config.enableLIA && state.year > 1310) {
                state.weatherMean = Math.max(0.85, state.weatherMean - 0.001);
            }

            // Great Famine shock (1315-1317)
            if (config.enableFamine && state.year >= 1315 && state.year <= 1317 && state.season === 2) {
                state.weatherCurrent = Math.max(0.3, state.weatherCurrent - 0.5);
            }

            // Black Death plague event (1348-1351)
            if (config.enablePlague && state.year >= 1348 && state.year <= 1351 && !state.plagueActive) {
                triggerPlague();
            }

            // Seasonal activities
            switch(state.season) {
                case 0: // Spring: planting
                    for (let h of state.households) {
                        h.plant(h.plots);
                    }
                    break;

                case 1: // Summer: growth
                    for (let p of state.patches) {
                        p.rainfall = state.weatherCurrent;
                    }
                    break;

                case 2: // Fall: harvest
                    let totalHarvest = 0;
                    let totalPlots = 0;
                    for (let h of state.households) {
                        const harvest = h.harvest(state.weatherCurrent);
                        totalHarvest += harvest;
                        totalPlots += h.plots.length;
                    }
                    state.avgYield = totalPlots > 0 ? totalHarvest / (totalPlots * config.baseYieldRatio) : 0;

                    // Obligations
                    for (let h of state.households) {
                        h.payObligations(config.titheRate, 0.15, state.landRent);
                    }

                    // Market phase
                    updateMarket();

                    for (let h of state.households) {
                        h.trade(null);
                    }
                    break;

                case 3: // Winter: consumption, demographics
                    for (let h of state.households) {
                        h.consume();
                        h.reproduce();

                        // Plague dynamics
                        if (state.plagueActive) {
                            h.updateDisease(config.plagueBeta, config.plagueGamma);
                        }
                    }

                    // Remove dead
                    state.households = state.households.filter(h => !h.isDead());

                    // Fallow rotation
                    for (let p of state.patches) {
                        if (state.tick % 3 === 0) {
                            p.fallow = !p.fallow;
                        }
                        p.regenerate();
                    }

                    // Institutional updates
                    for (let lord of state.lords) {
                        lord.adjustWages();
                    }

                    // Commutation gradually increases with monetization
                    state.commutationShare = Math.min(0.8, state.commutationShare + 0.005);

                    break;
            }

            // Update aggregate stats
            updateStats();

            // Record history (yearly)
            if (state.season === 3) {
                state.history.population.push(state.totalPopulation);
                state.history.realWage.push(state.realWage);
                state.history.grainPrice.push(state.grainPrice);
                state.history.landRent.push(state.landRent);
                state.history.avgYield.push(state.avgYield);
                state.history.commutation.push(state.commutationShare);
            }

            // Draw
            draw();
            drawCharts();
        }

        // ============================================================================
        // MARKET & PRICE FORMATION
        // ============================================================================

        function updateMarket() {
            // Simple aggregate market clearing
            let totalSupply = 0;
            let totalDemand = 0;

            for (let h of state.households) {
                const excess = Math.max(0, h.grain - 2.0);
                const deficit = Math.max(0, 2.0 - h.grain);
                totalSupply += excess;
                totalDemand += deficit;
            }

            // Price adjustment
            const excessDemand = totalDemand - totalSupply;
            const priceChange = 0.05 * excessDemand / Math.max(1, totalSupply);
            state.grainPrice = Math.max(0.1, Math.min(3.0, state.grainPrice + priceChange));

            // Land rent follows grain prices inversely with population pressure
            const landPressure = state.households.length / (state.patches.filter(p => p.landType === 'arable').length + 1);
            state.landRent = state.grainPrice * landPressure * 0.3;
        }

        // ============================================================================
        // PLAGUE TRIGGER & SIR DYNAMICS
        // ============================================================================

        function triggerPlague() {
            state.plagueActive = true;
            state.plagueStartTick = state.tick;

            // Infect initial 5%
            const numInfected = Math.floor(state.households.length * 0.05);
            for (let i = 0; i < numInfected; i++) {
                const h = state.households[Math.floor(Math.random() * state.households.length)];
                h.diseaseState = 'I';
                h.infectionTime = 0;
            }
        }

        // ============================================================================
        // STATISTICS UPDATE
        // ============================================================================

        function updateStats() {
            state.totalPopulation = state.households.reduce((sum, h) => sum + h.members, 0);
            state.totalGrain = state.households.reduce((sum, h) => sum + h.grain, 0);
            state.totalSilver = state.households.reduce((sum, h) => sum + h.silver, 0);

            // Disease counts
            state.susceptible = state.households.filter(h => h.diseaseState === 'S').length;
            state.infected = state.households.filter(h => h.diseaseState === 'I').length;
            state.recovered = state.households.filter(h => h.diseaseState === 'R').length;

            // Real wage (grain-deflated)
            state.realWage = state.wages / Math.max(0.1, state.grainPrice);

            // Update monitors
            document.getElementById('yearDisplay').textContent = state.year;
            document.getElementById('popMonitor').textContent = state.totalPopulation.toLocaleString();
            document.getElementById('wageMonitor').textContent = state.realWage.toFixed(2);
            document.getElementById('priceMonitor').textContent = state.grainPrice.toFixed(2);
            document.getElementById('yieldMonitor').textContent = state.avgYield.toFixed(2);
            document.getElementById('rentMonitor').textContent = state.landRent.toFixed(2);
            document.getElementById('commutMonitor').textContent = (state.commutationShare * 100).toFixed(0) + '%';
        }

        // ============================================================================
        // RENDERING
        // ============================================================================

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw patches
            for (let patch of state.patches) {
                ctx.fillStyle = patch.getColor();
                ctx.fillRect(
                    patch.x * config.cellSize,
                    patch.y * config.cellSize,
                    config.cellSize,
                    config.cellSize
                );
            }

            // Draw households
            for (let h of state.households) {
                let color = '#4169e1'; // Blue
                if (h.diseaseState === 'I') color = '#800080'; // Purple if infected

                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(
                    h.x * config.cellSize + config.cellSize / 2,
                    h.y * config.cellSize + config.cellSize / 2,
                    3,
                    0,
                    Math.PI * 2
                );
                ctx.fill();
            }

            // Draw lords
            for (let lord of state.lords) {
                ctx.fillStyle = '#dc143c';
                ctx.fillRect(
                    lord.x * config.cellSize,
                    lord.y * config.cellSize,
                    config.cellSize * 0.8,
                    config.cellSize * 0.8
                );
            }
        }

        function drawCharts() {
            drawLineChart('popChart', state.history.population, '#4169e1', 'Population');
            drawLineChart('wageChart', state.history.realWage, '#d4af37', 'Real Wage');
            drawLineChart('priceChart', state.history.grainPrice, '#ff6347', 'Grain Price');
        }

        function drawLineChart(canvasId, data, color, label) {
            const chartCanvas = document.getElementById(canvasId);
            const chartCtx = chartCanvas.getContext('2d');
            const w = chartCanvas.width;
            const h = chartCanvas.height;

            chartCtx.clearRect(0, 0, w, h);

            if (data.length < 2) return;

            const maxVal = Math.max(...data, 1);
            const minVal = Math.min(...data, 0);
            const range = maxVal - minVal || 1;

            chartCtx.strokeStyle = color;
            chartCtx.lineWidth = 2;
            chartCtx.beginPath();

            for (let i = 0; i < data.length; i++) {
                const x = (i / Math.max(1, data.length - 1)) * (w - 20) + 10;
                const y = h - 10 - ((data[i] - minVal) / range) * (h - 30);

                if (i === 0) chartCtx.moveTo(x, y);
                else chartCtx.lineTo(x, y);
            }

            chartCtx.stroke();

            // Draw axis
            chartCtx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            chartCtx.lineWidth = 1;
            chartCtx.strokeRect(10, 10, w - 20, h - 20);
        }

        // ============================================================================
        // SCENARIO PRESETS
        // ============================================================================

        function loadScenario(name) {
            switch(name) {
                case 'baseline':
                    config.enableFamine = false;
                    config.enablePlague = false;
                    config.enableLIA = false;
                    state.year = 1300;
                    document.getElementById('enableFamine').checked = false;
                    document.getElementById('enablePlague').checked = false;
                    document.getElementById('enableLIA').checked = false;
                    break;

                case 'famine':
                    config.enableFamine = true;
                    config.enablePlague = false;
                    config.enableLIA = true;
                    state.year = 1310;
                    document.getElementById('enableFamine').checked = true;
                    document.getElementById('enablePlague').checked = false;
                    document.getElementById('enableLIA').checked = true;
                    break;

                case 'plague':
                    config.enableFamine = false;
                    config.enablePlague = true;
                    config.enableLIA = true;
                    state.year = 1345;
                    document.getElementById('enableFamine').checked = false;
                    document.getElementById('enablePlague').checked = true;
                    document.getElementById('enableLIA').checked = true;
                    break;

                case 'littleice':
                    config.enableFamine = true;
                    config.enablePlague = false;
                    config.enableLIA = true;
                    state.year = 1300;
                    document.getElementById('enableFamine').checked = false;
                    document.getElementById('enablePlague').checked = false;
                    document.getElementById('enableLIA').checked = true;
                    break;
            }

            initSimulation();
        }

        // ============================================================================
        // UI EVENT HANDLERS
        // ============================================================================

        document.getElementById('startBtn').addEventListener('click', () => {
            state.running = true;
        });

        document.getElementById('pauseBtn').addEventListener('click', () => {
            state.running = false;
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            state.running = false;
            initSimulation();
        });

        // Parameter sliders
        document.getElementById('households').addEventListener('input', (e) => {
            document.getElementById('householdsVal').textContent = e.target.value;
        });

        document.getElementById('landPerHousehold').addEventListener('input', (e) => {
            document.getElementById('landVal').textContent = parseFloat(e.target.value).toFixed(1);
        });

        document.getElementById('baseYield').addEventListener('input', (e) => {
            config.baseYieldRatio = parseFloat(e.target.value);
            document.getElementById('yieldVal').textContent = config.baseYieldRatio.toFixed(1);
        });

        document.getElementById('weatherVar').addEventListener('input', (e) => {
            config.weatherSD = parseFloat(e.target.value);
            document.getElementById('weatherVal').textContent = config.weatherSD.toFixed(2);
        });

        document.getElementById('titheRate').addEventListener('input', (e) => {
            config.titheRate = parseInt(e.target.value) / 100;
            document.getElementById('titheVal').textContent = e.target.value + '%';
        });

        document.getElementById('commutation').addEventListener('input', (e) => {
            state.commutationShare = parseInt(e.target.value) / 100;
            document.getElementById('commutVal').textContent = e.target.value + '%';
        });

        document.getElementById('guildPower').addEventListener('input', (e) => {
            config.guildPower = parseFloat(e.target.value);
            document.getElementById('guildVal').textContent = config.guildPower.toFixed(2);
        });

        // Shock toggles
        document.getElementById('enableFamine').addEventListener('change', (e) => {
            config.enableFamine = e.target.checked;
        });

        document.getElementById('enablePlague').addEventListener('change', (e) => {
            config.enablePlague = e.target.checked;
        });

        document.getElementById('enableLIA').addEventListener('change', (e) => {
            config.enableLIA = e.target.checked;
        });

        document.getElementById('enableGuilds').addEventListener('change', (e) => {
            config.enableGuilds = e.target.checked;
        });

        // ============================================================================
        // MAIN LOOP
        // ============================================================================

        function mainLoop() {
            fps.update();
            if (state.running) {
                tick();
            }
            requestAnimationFrame(mainLoop);
        }

        // Initialize and start
        initSimulation();
        mainLoop();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
