<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hodgkin-Huxley Neuron Model</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0a0a0f;
            color: #fff;
            font-family: 'Segoe UI', system-ui, sans-serif;
            overflow: hidden;
            display: flex;
        }
        .sidebar {
            width: 320px;
            background: rgba(0,0,0,0.9);
            padding: 20px;
            height: 100vh;
            overflow-y: auto;
        }
        h1 {
            font-size: 1.3em;
            margin-bottom: 5px;
            color: #9b59b6;
        }
        .subtitle {
            font-size: 0.85em;
            color: #888;
            margin-bottom: 15px;
        }
        .canvas-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        canvas {
            display: block;
        }
        .slider-group {
            margin-bottom: 12px;
        }
        .slider-group label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 0.85em;
            color: #aaa;
        }
        .slider-group input[type="range"] {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: #333;
            border-radius: 3px;
            outline: none;
        }
        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #9b59b6;
            border-radius: 50%;
            cursor: pointer;
        }
        .section-title {
            color: #9b59b6;
            font-size: 0.9em;
            margin: 15px 0 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
            font-size: 0.8em;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .legend-color {
            width: 20px;
            height: 3px;
            border-radius: 2px;
        }
        .button-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            background: #9b59b6;
            color: #fff;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        button:hover { background: #8e44ad; }
        button.active { background: #27ae60; }
        .stats {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #333;
            font-size: 0.85em;
            color: #888;
        }
        .stats-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .stats-row .value { color: #fff; }
        .back-link {
            position: fixed;
            top: 20px;
            right: 20px;
            color: #9b59b6;
            text-decoration: none;
            font-size: 0.9em;
            z-index: 100;
        }
        .equation {
            background: #111;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: 'Times New Roman', serif;
            font-size: 0.85em;
            color: #aaa;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h1>Hodgkin-Huxley</h1>
        <p class="subtitle">Nobel Prize-Winning Neuron Model</p>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #3498db;"></div>
                <span>V (mV)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #e74c3c;"></div>
                <span>m (Na act)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #f39c12;"></div>
                <span>h (Na inact)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #27ae60;"></div>
                <span>n (K act)</span>
            </div>
        </div>

        <div class="section-title">Stimulus</div>
        <div class="slider-group">
            <label>Current (I) <span id="currentVal">10</span> μA/cm²</label>
            <input type="range" id="current" min="0" max="30" step="0.5" value="10">
        </div>

        <div class="slider-group">
            <label>Pulse Duration <span id="durationVal">1</span> ms</label>
            <input type="range" id="duration" min="0.5" max="5" step="0.5" value="1">
        </div>

        <div class="section-title">Conductances</div>
        <div class="slider-group">
            <label>gNa <span id="gNaVal">120</span> mS/cm²</label>
            <input type="range" id="gNa" min="50" max="200" step="5" value="120">
        </div>

        <div class="slider-group">
            <label>gK <span id="gKVal">36</span> mS/cm²</label>
            <input type="range" id="gK" min="10" max="60" step="2" value="36">
        </div>

        <div class="slider-group">
            <label>gL <span id="gLVal">0.3</span> mS/cm²</label>
            <input type="range" id="gL" min="0.1" max="1" step="0.05" value="0.3">
        </div>

        <div class="button-row">
            <button id="stimBtn">Stimulate</button>
            <button id="resetBtn">Reset</button>
        </div>

        <div class="button-row">
            <button id="autoBtn">Auto Mode</button>
            <button id="clearBtn">Clear</button>
        </div>

        <div class="stats">
            <div class="stats-row">
                <span>Membrane Potential:</span>
                <span class="value" id="voltage">-65 mV</span>
            </div>
            <div class="stats-row">
                <span>Spike Count:</span>
                <span class="value" id="spikes">0</span>
            </div>
            <div class="stats-row">
                <span>Time:</span>
                <span class="value" id="time">0 ms</span>
            </div>
        </div>

        <div class="equation">
            C dV/dt = I - gNa·m³h(V-ENa) - gK·n⁴(V-EK) - gL(V-EL)
        </div>
    </div>

    <div class="canvas-area">
        <canvas id="mainCanvas"></canvas>
        <canvas id="gatingCanvas" height="150"></canvas>
    </div>

    <a href="index.html" class="back-link">← Back to Gallery</a>

    <script>
        const mainCanvas = document.getElementById('mainCanvas');
        const mainCtx = mainCanvas.getContext('2d');
        const gatingCanvas = document.getElementById('gatingCanvas');
        const gatingCtx = gatingCanvas.getContext('2d');

        // Hodgkin-Huxley parameters
        let C = 1.0;           // Membrane capacitance (μF/cm²)
        let gNa = 120.0;       // Sodium conductance (mS/cm²)
        let gK = 36.0;         // Potassium conductance (mS/cm²)
        let gL = 0.3;          // Leak conductance (mS/cm²)
        const ENa = 50.0;      // Sodium reversal potential (mV)
        const EK = -77.0;      // Potassium reversal potential (mV)
        const EL = -54.387;    // Leak reversal potential (mV)

        // State variables
        let V = -65.0;         // Membrane potential (mV)
        let m = 0.05;          // Sodium activation
        let h = 0.6;           // Sodium inactivation
        let n = 0.32;          // Potassium activation

        // Stimulus
        let I_stim = 10;
        let stimDuration = 1;
        let stimulating = false;
        let stimStart = 0;
        let autoMode = false;
        let autoInterval = 50;

        // Recording
        let history = { V: [], m: [], h: [], n: [], t: [] };
        const MAX_POINTS = 1000;
        let time = 0;
        let spikeCount = 0;
        let lastV = V;

        function resize() {
            const area = document.querySelector('.canvas-area');
            mainCanvas.width = area.clientWidth;
            mainCanvas.height = area.clientHeight - 150;
            gatingCanvas.width = area.clientWidth;
        }

        function alphaM(V) {
            if (Math.abs(V + 40) < 0.001) return 1.0;
            return 0.1 * (V + 40) / (1 - Math.exp(-(V + 40) / 10));
        }

        function betaM(V) {
            return 4.0 * Math.exp(-(V + 65) / 18);
        }

        function alphaH(V) {
            return 0.07 * Math.exp(-(V + 65) / 20);
        }

        function betaH(V) {
            return 1 / (1 + Math.exp(-(V + 35) / 10));
        }

        function alphaN(V) {
            if (Math.abs(V + 55) < 0.001) return 0.1;
            return 0.01 * (V + 55) / (1 - Math.exp(-(V + 55) / 10));
        }

        function betaN(V) {
            return 0.125 * Math.exp(-(V + 65) / 80);
        }

        function step(dt) {
            // Current stimulus
            let I = 0;
            if (stimulating && time - stimStart < stimDuration) {
                I = I_stim;
            } else if (stimulating) {
                stimulating = false;
            }

            if (autoMode && !stimulating && time % autoInterval < dt) {
                stimulating = true;
                stimStart = time;
            }

            // Ionic currents
            const INa = gNa * Math.pow(m, 3) * h * (V - ENa);
            const IK = gK * Math.pow(n, 4) * (V - EK);
            const IL = gL * (V - EL);

            // Membrane potential
            const dV = (I - INa - IK - IL) / C;

            // Gating variables
            const dm = alphaM(V) * (1 - m) - betaM(V) * m;
            const dh = alphaH(V) * (1 - h) - betaH(V) * h;
            const dn = alphaN(V) * (1 - n) - betaN(V) * n;

            // Euler integration
            V += dV * dt;
            m += dm * dt;
            h += dh * dt;
            n += dn * dt;

            // Clamp gating variables
            m = Math.max(0, Math.min(1, m));
            h = Math.max(0, Math.min(1, h));
            n = Math.max(0, Math.min(1, n));

            time += dt;

            // Detect spikes (crossing 0 mV upward)
            if (lastV < 0 && V >= 0) {
                spikeCount++;
            }
            lastV = V;

            // Record history
            history.V.push(V);
            history.m.push(m);
            history.h.push(h);
            history.n.push(n);
            history.t.push(time);

            if (history.V.length > MAX_POINTS) {
                history.V.shift();
                history.m.shift();
                history.h.shift();
                history.n.shift();
                history.t.shift();
            }
        }

        function draw() {
            // Main voltage trace
            mainCtx.fillStyle = '#0a0a0f';
            mainCtx.fillRect(0, 0, mainCanvas.width, mainCanvas.height);

            const w = mainCanvas.width;
            const h = mainCanvas.height;
            const padding = 40;

            // Draw grid
            mainCtx.strokeStyle = '#222';
            mainCtx.lineWidth = 1;
            for (let y = 0; y <= 4; y++) {
                const yPos = padding + (h - 2 * padding) * y / 4;
                mainCtx.beginPath();
                mainCtx.moveTo(padding, yPos);
                mainCtx.lineTo(w - padding, yPos);
                mainCtx.stroke();
            }

            // Draw voltage trace
            if (history.V.length > 1) {
                mainCtx.beginPath();
                mainCtx.strokeStyle = '#3498db';
                mainCtx.lineWidth = 2;

                for (let i = 0; i < history.V.length; i++) {
                    const x = padding + (w - 2 * padding) * i / MAX_POINTS;
                    const y = h - padding - (history.V[i] + 80) / 160 * (h - 2 * padding);

                    if (i === 0) mainCtx.moveTo(x, y);
                    else mainCtx.lineTo(x, y);
                }
                mainCtx.stroke();
            }

            // Labels
            mainCtx.fillStyle = '#888';
            mainCtx.font = '12px sans-serif';
            mainCtx.fillText('+80 mV', 5, padding + 10);
            mainCtx.fillText('-80 mV', 5, h - padding);
            mainCtx.fillText('Membrane Potential', w / 2 - 60, 20);

            // Gating variables
            gatingCtx.fillStyle = '#0a0a0f';
            gatingCtx.fillRect(0, 0, gatingCanvas.width, gatingCanvas.height);

            const gh = gatingCanvas.height;
            const gw = gatingCanvas.width;

            if (history.m.length > 1) {
                const colors = ['#e74c3c', '#f39c12', '#27ae60'];
                const vars = [history.m, history.h, history.n];
                const labels = ['m', 'h', 'n'];

                for (let v = 0; v < 3; v++) {
                    gatingCtx.beginPath();
                    gatingCtx.strokeStyle = colors[v];
                    gatingCtx.lineWidth = 2;

                    for (let i = 0; i < vars[v].length; i++) {
                        const x = padding + (gw - 2 * padding) * i / MAX_POINTS;
                        const y = gh - 20 - vars[v][i] * (gh - 40);

                        if (i === 0) gatingCtx.moveTo(x, y);
                        else gatingCtx.lineTo(x, y);
                    }
                    gatingCtx.stroke();
                }

                // Legend
                gatingCtx.font = '11px sans-serif';
                for (let v = 0; v < 3; v++) {
                    gatingCtx.fillStyle = colors[v];
                    gatingCtx.fillText(labels[v], gw - 80 + v * 25, 15);
                }
            }

            gatingCtx.fillStyle = '#888';
            gatingCtx.fillText('1.0', 5, 15);
            gatingCtx.fillText('0.0', 5, gh - 5);
            gatingCtx.fillText('Gating Variables', gw / 2 - 50, gh - 5);

            // Update stats
            document.getElementById('voltage').textContent = V.toFixed(1) + ' mV';
            document.getElementById('spikes').textContent = spikeCount;
            document.getElementById('time').textContent = time.toFixed(1) + ' ms';
        }

        function reset() {
            V = -65.0;
            m = 0.05;
            h = 0.6;
            n = 0.32;
            time = 0;
            spikeCount = 0;
            lastV = V;
            history = { V: [], m: [], h: [], n: [], t: [] };
            stimulating = false;
        }

        function clear() {
            history = { V: [], m: [], h: [], n: [], t: [] };
        }

        // UI
        document.getElementById('current').addEventListener('input', (e) => {
            I_stim = parseFloat(e.target.value);
            document.getElementById('currentVal').textContent = I_stim;
        });

        document.getElementById('duration').addEventListener('input', (e) => {
            stimDuration = parseFloat(e.target.value);
            document.getElementById('durationVal').textContent = stimDuration;
        });

        document.getElementById('gNa').addEventListener('input', (e) => {
            gNa = parseFloat(e.target.value);
            document.getElementById('gNaVal').textContent = gNa;
        });

        document.getElementById('gK').addEventListener('input', (e) => {
            gK = parseFloat(e.target.value);
            document.getElementById('gKVal').textContent = gK;
        });

        document.getElementById('gL').addEventListener('input', (e) => {
            gL = parseFloat(e.target.value);
            document.getElementById('gLVal').textContent = gL;
        });

        document.getElementById('stimBtn').addEventListener('click', () => {
            stimulating = true;
            stimStart = time;
        });

        document.getElementById('resetBtn').addEventListener('click', reset);
        document.getElementById('clearBtn').addEventListener('click', clear);

        document.getElementById('autoBtn').addEventListener('click', function() {
            autoMode = !autoMode;
            this.classList.toggle('active', autoMode);
            this.textContent = autoMode ? 'Auto: ON' : 'Auto Mode';
        });

        window.addEventListener('resize', resize);

        function animate() {
            for (let i = 0; i < 10; i++) {
                step(0.01); // 0.01 ms timestep
            }
            draw();
            requestAnimationFrame(animate);
        }

        resize();
        animate();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
