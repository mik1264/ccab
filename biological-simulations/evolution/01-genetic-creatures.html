<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genetic Creatures Evolution</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: Arial, sans-serif;
        }
        canvas {
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        .info {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            max-width: 300px;
        }
        .stats {
            font-size: 14px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <a href="../index.html" class="organic-back-link" style="position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; align-items: center; gap: 8px; padding: 10px 16px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-radius: 30px; text-decoration: none; color: #606C38; font-family: 'Nunito', sans-serif; font-weight: 600; box-shadow: 0 2px 10px rgba(0,0,0,0.1); transition: all 0.3s ease;">
        <span class="back-arrow">‚Üê</span>
        <span class="back-text">Gallery</span>
    </a>
    <div class="info">
        <h3>Genetic Creatures Evolution</h3>
        <div class="stats" id="stats"></div>
    </div>
    <canvas id="canvas"></canvas>
    <script src="../../assets/js/demo-utils.js"></script>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 1200;
        canvas.height = 800;

        // Initialize demo utilities
        const fps = new FPSCounter({ position: 'top-right' });
        const errorMgr = new ErrorManager();
        setupGlobalErrorHandler((msg, details) => errorMgr.show(msg, details));
        fps.start();

        const foods = [];
        let generation = 1;
        let maxFitness = 0;

        class Creature {
            constructor(x, y, dna) {
                this.position = { x, y };
                this.velocity = { x: 0, y: 0 };
                this.acceleration = { x: 0, y: 0 };
                this.health = 100;
                this.dna = dna || {
                    speed: Math.random() * 3 + 1,
                    size: Math.random() * 15 + 5,
                    perception: Math.random() * 150 + 50,
                    r: Math.random() * 255,
                    g: Math.random() * 255,
                    b: Math.random() * 255
                };
                this.fitness = 0;
            }

            applyForce(force) {
                this.acceleration.x += force.x;
                this.acceleration.y += force.y;
            }

            seek(target) {
                let desired = {
                    x: target.x - this.position.x,
                    y: target.y - this.position.y
                };
                let mag = Math.hypot(desired.x, desired.y);
                if (mag > 0) {
                    desired.x = (desired.x / mag) * this.dna.speed;
                    desired.y = (desired.y / mag) * this.dna.speed;
                }
                let steer = {
                    x: desired.x - this.velocity.x,
                    y: desired.y - this.velocity.y
                };
                mag = Math.hypot(steer.x, steer.y);
                if (mag > 0.3) {
                    steer.x = (steer.x / mag) * 0.3;
                    steer.y = (steer.y / mag) * 0.3;
                }
                this.applyForce(steer);
            }

            findFood() {
                let closest = null;
                let closestDist = Infinity;

                for (let food of foods) {
                    let d = Math.hypot(
                        food.x - this.position.x,
                        food.y - this.position.y
                    );
                    if (d < this.dna.perception && d < closestDist) {
                        closest = food;
                        closestDist = d;
                    }
                }

                if (closest) {
                    this.seek(closest);
                    if (closestDist < this.dna.size) {
                        this.health += 20;
                        this.fitness++;
                        foods.splice(foods.indexOf(closest), 1);
                    }
                }
            }

            update() {
                this.findFood();

                this.velocity.x += this.acceleration.x;
                this.velocity.y += this.acceleration.y;
                this.position.x += this.velocity.x;
                this.position.y += this.velocity.y;

                this.acceleration.x = 0;
                this.acceleration.y = 0;

                // Health decreases over time (metabolism)
                this.health -= 0.1 * (this.dna.size / 10);

                // Boundary
                if (this.position.x > canvas.width) this.position.x = 0;
                else if (this.position.x < 0) this.position.x = canvas.width;
                if (this.position.y > canvas.height) this.position.y = 0;
                else if (this.position.y < 0) this.position.y = canvas.height;
            }

            show() {
                ctx.save();
                ctx.translate(this.position.x, this.position.y);

                // Perception radius (faint)
                ctx.strokeStyle = `rgba(${this.dna.r}, ${this.dna.g}, ${this.dna.b}, 0.1)`;
                ctx.beginPath();
                ctx.arc(0, 0, this.dna.perception, 0, Math.PI * 2);
                ctx.stroke();

                // Body
                const alpha = this.health / 100;
                ctx.fillStyle = `rgba(${this.dna.r}, ${this.dna.g}, ${this.dna.b}, ${alpha})`;
                ctx.beginPath();
                ctx.arc(0, 0, this.dna.size, 0, Math.PI * 2);
                ctx.fill();

                // Health bar
                ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.fillRect(-this.dna.size, -this.dna.size - 5, this.dna.size * 2, 3);
                ctx.fillStyle = `rgba(0, 255, 0, ${alpha})`;
                ctx.fillRect(-this.dna.size, -this.dna.size - 5, this.dna.size * 2 * (this.health / 100), 3);

                ctx.restore();
            }

            isDead() {
                return this.health <= 0;
            }

            reproduce() {
                if (Math.random() < 0.001 && this.health > 80) {
                    const newDna = {
                        speed: this.dna.speed + (Math.random() * 0.4 - 0.2),
                        size: this.dna.size + (Math.random() * 2 - 1),
                        perception: this.dna.perception + (Math.random() * 20 - 10),
                        r: this.dna.r + (Math.random() * 20 - 10),
                        g: this.dna.g + (Math.random() * 20 - 10),
                        b: this.dna.b + (Math.random() * 20 - 10)
                    };

                    // Clamp values
                    newDna.speed = Math.max(0.5, Math.min(5, newDna.speed));
                    newDna.size = Math.max(3, Math.min(25, newDna.size));
                    newDna.perception = Math.max(30, Math.min(250, newDna.perception));
                    newDna.r = Math.max(0, Math.min(255, newDna.r));
                    newDna.g = Math.max(0, Math.min(255, newDna.g));
                    newDna.b = Math.max(0, Math.min(255, newDna.b));

                    this.health -= 30;
                    return new Creature(this.position.x, this.position.y, newDna);
                }
                return null;
            }
        }

        const creatures = [];
        for (let i = 0; i < 30; i++) {
            creatures.push(new Creature(
                Math.random() * canvas.width,
                Math.random() * canvas.height
            ));
        }

        function animate() {
            fps.update();
            ctx.fillStyle = 'rgba(44, 62, 80, 0.3)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Add food
            if (Math.random() < 0.3 && foods.length < 100) {
                foods.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height
                });
            }

            // Draw food
            ctx.fillStyle = '#27ae60';
            for (let food of foods) {
                ctx.beginPath();
                ctx.arc(food.x, food.y, 3, 0, Math.PI * 2);
                ctx.fill();
            }

            // Update creatures
            for (let i = creatures.length - 1; i >= 0; i--) {
                creatures[i].update();
                creatures[i].show();

                if (creatures[i].isDead()) {
                    creatures.splice(i, 1);
                    continue;
                }

                const baby = creatures[i].reproduce();
                if (baby) {
                    creatures.push(baby);
                    generation++;
                }

                if (creatures[i].fitness > maxFitness) {
                    maxFitness = creatures[i].fitness;
                }
            }

            // Stats
            const avgSpeed = creatures.reduce((sum, c) => sum + c.dna.speed, 0) / creatures.length;
            const avgSize = creatures.reduce((sum, c) => sum + c.dna.size, 0) / creatures.length;
            const avgPerception = creatures.reduce((sum, c) => sum + c.dna.perception, 0) / creatures.length;

            document.getElementById('stats').innerHTML = `
                Population: ${creatures.length}<br>
                Food: ${foods.length}<br>
                Generation: ${generation}<br>
                Max Fitness: ${maxFitness}<br>
                Avg Speed: ${avgSpeed.toFixed(2)}<br>
                Avg Size: ${avgSize.toFixed(2)}<br>
                Avg Perception: ${avgPerception.toFixed(2)}
            `;

            requestAnimationFrame(animate);
        }

        animate();
    </script>
    <script src="../../assets/js/enhance.js" defer></script>
</body>
</html>
