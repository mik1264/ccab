<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hardy-Weinberg Equilibrium</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            font-family: 'Segoe UI', Arial, sans-serif;
            color: white;
        }
        .container {
            display: flex;
            height: 100vh;
        }
        .canvas-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 20px;
        }
        canvas {
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
        }
        .controls {
            width: 380px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.6);
            overflow-y: auto;
        }
        h2 { margin: 0 0 10px 0; color: #a29bfe; }
        h3 { margin: 15px 0 8px 0; color: #74b9ff; font-size: 14px; }
        .slider-group { margin: 10px 0; }
        .slider-group label { display: block; margin-bottom: 5px; font-size: 12px; }
        input[type="range"] { width: 100%; }
        .genotype-display {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }
        .genotype {
            text-align: center;
            padding: 10px;
        }
        .genotype-symbol {
            font-size: 24px;
            font-weight: bold;
        }
        .AA { color: #e74c3c; }
        .Aa { color: #9b59b6; }
        .aa { color: #3498db; }
        .stat { margin: 5px 0; font-size: 13px; }
        .equilibrium { color: #2ecc71; }
        .deviation { color: #e74c3c; }
        .formula {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            text-align: center;
            margin: 10px 0;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: #6c5ce7;
            color: white;
            font-weight: bold;
        }
        button:hover { background: #5b4cdb; }
        .toggle-group {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin: 10px 0;
        }
        .toggle-group button {
            padding: 8px 12px;
            font-size: 11px;
            background: rgba(255,255,255,0.1);
        }
        .toggle-group button.active {
            background: #e74c3c;
        }
    </style>
</head>
<body>
    <a href="../index.html" class="organic-back-link" style="position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; align-items: center; gap: 8px; padding: 10px 16px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-radius: 30px; text-decoration: none; color: #606C38; font-family: 'Nunito', sans-serif; font-weight: 600; box-shadow: 0 2px 10px rgba(0,0,0,0.1); transition: all 0.3s ease;">
        <span class="back-arrow">‚Üê</span>
        <span class="back-text">Gallery</span>
    </a>
    <div class="container">
        <div class="canvas-area">
            <canvas id="populationCanvas"></canvas>
            <canvas id="graphCanvas"></canvas>
        </div>
        <div class="controls">
            <h2>üß¨ Hardy-Weinberg Equilibrium</h2>

            <div class="formula">
                p¬≤ + 2pq + q¬≤ = 1<br>
                <small style="opacity: 0.7">AA + Aa + aa = 100%</small>
            </div>

            <h3>Allele Frequency</h3>
            <div class="slider-group">
                <label>p (A allele): <span id="pVal">0.5</span></label>
                <input type="range" id="pFreq" min="0.01" max="0.99" step="0.01" value="0.5">
            </div>
            <div class="stat">q (a allele): <span id="qVal">0.5</span></div>

            <div class="genotype-display">
                <div class="genotype AA">
                    <div class="genotype-symbol">AA</div>
                    <div id="AAfreq">25%</div>
                </div>
                <div class="genotype Aa">
                    <div class="genotype-symbol">Aa</div>
                    <div id="Aafreq">50%</div>
                </div>
                <div class="genotype aa">
                    <div class="genotype-symbol">aa</div>
                    <div id="aafreq">25%</div>
                </div>
            </div>

            <h3>Population Size</h3>
            <div class="slider-group">
                <label>N = <span id="popSizeVal">100</span></label>
                <input type="range" id="popSize" min="10" max="500" step="10" value="100">
            </div>

            <h3>Evolutionary Forces (Violate HW)</h3>
            <div class="toggle-group">
                <button id="btnDrift" onclick="toggleForce('drift')">Genetic Drift</button>
                <button id="btnSelection" onclick="toggleForce('selection')">Selection</button>
                <button id="btnMutation" onclick="toggleForce('mutation')">Mutation</button>
                <button id="btnMigration" onclick="toggleForce('migration')">Migration</button>
            </div>

            <div class="slider-group" id="selectionControl" style="display: none;">
                <label>Selection against aa: <span id="selectionVal">0.1</span></label>
                <input type="range" id="selectionCoef" min="0" max="1" step="0.05" value="0.1">
            </div>

            <button onclick="resetSimulation()">Reset</button>
            <button onclick="togglePause()">Pause/Play</button>
            <button onclick="stepGeneration()">Step</button>

            <h3>Statistics</h3>
            <div class="stat">Generation: <span id="generation">0</span></div>
            <div class="stat">Observed p: <span id="observedP">0.5</span></div>
            <div class="stat">Equilibrium: <span id="equilibriumStatus" class="equilibrium">Yes</span></div>
            <div class="stat">œá¬≤ deviation: <span id="chiSquare">0.00</span></div>
        </div>
    </div>

    <script>
        const popCanvas = document.getElementById('populationCanvas');
        const popCtx = popCanvas.getContext('2d');
        const graphCanvas = document.getElementById('graphCanvas');
        const graphCtx = graphCanvas.getContext('2d');

        popCanvas.width = 700;
        popCanvas.height = 350;
        graphCanvas.width = 700;
        graphCanvas.height = 200;

        let p = 0.5; // Frequency of A allele
        let popSize = 100;
        let generation = 0;
        let paused = false;
        let organisms = [];
        let history = { p: [], AA: [], Aa: [], aa: [] };

        let forces = {
            drift: false,
            selection: false,
            mutation: false,
            migration: false
        };

        let selectionCoef = 0.1;

        class Organism {
            constructor(genotype) {
                this.genotype = genotype; // 'AA', 'Aa', or 'aa'
                this.x = Math.random() * popCanvas.width;
                this.y = Math.random() * popCanvas.height;
                this.vx = (Math.random() - 0.5) * 1.5;
                this.vy = (Math.random() - 0.5) * 1.5;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;

                if (this.x < 0 || this.x > popCanvas.width) this.vx *= -1;
                if (this.y < 0 || this.y > popCanvas.height) this.vy *= -1;

                this.x = Math.max(5, Math.min(popCanvas.width - 5, this.x));
                this.y = Math.max(5, Math.min(popCanvas.height - 5, this.y));
            }

            draw() {
                let color;
                switch(this.genotype) {
                    case 'AA': color = '#e74c3c'; break;
                    case 'Aa': color = '#9b59b6'; break;
                    case 'aa': color = '#3498db'; break;
                }

                popCtx.beginPath();
                popCtx.arc(this.x, this.y, 6, 0, Math.PI * 2);
                popCtx.fillStyle = color;
                popCtx.fill();
                popCtx.strokeStyle = 'rgba(255,255,255,0.3)';
                popCtx.stroke();
            }
        }

        function generatePopulation() {
            organisms = [];
            const q = 1 - p;

            // Expected genotype frequencies under HW equilibrium
            const AAfreq = p * p;
            const Aafreq = 2 * p * q;
            const aafreq = q * q;

            for (let i = 0; i < popSize; i++) {
                const r = Math.random();
                let genotype;
                if (r < AAfreq) genotype = 'AA';
                else if (r < AAfreq + Aafreq) genotype = 'Aa';
                else genotype = 'aa';

                organisms.push(new Organism(genotype));
            }
        }

        function toggleForce(force) {
            forces[force] = !forces[force];
            document.getElementById('btn' + force.charAt(0).toUpperCase() + force.slice(1))
                .classList.toggle('active');

            if (force === 'selection') {
                document.getElementById('selectionControl').style.display =
                    forces.selection ? 'block' : 'none';
            }
        }

        function stepGeneration() {
            // Count current genotypes
            let counts = { AA: 0, Aa: 0, aa: 0 };
            organisms.forEach(o => counts[o.genotype]++);

            // Calculate allele frequencies
            const totalAlleles = organisms.length * 2;
            let A_count = counts.AA * 2 + counts.Aa;
            let a_count = counts.aa * 2 + counts.Aa;

            let newP = A_count / totalAlleles;
            let newQ = a_count / totalAlleles;

            // Apply evolutionary forces
            if (forces.selection) {
                // Selection against aa genotype
                const fitness = { AA: 1, Aa: 1, aa: 1 - selectionCoef };
                const meanFitness = counts.AA * fitness.AA + counts.Aa * fitness.Aa + counts.aa * fitness.aa;

                // Adjust genotype frequencies
                const adjAA = counts.AA * fitness.AA / meanFitness;
                const adjAa = counts.Aa * fitness.Aa / meanFitness;
                const adjaa = counts.aa * fitness.aa / meanFitness;

                A_count = adjAA * 2 + adjAa;
                a_count = adjaa * 2 + adjAa;
                newP = A_count / (A_count + a_count);
                newQ = 1 - newP;
            }

            if (forces.mutation) {
                // Small mutation rate
                const mu = 0.001;
                newP = newP * (1 - mu) + newQ * mu;
                newQ = 1 - newP;
            }

            if (forces.migration) {
                // Migration from a population with p = 0.5
                const m = 0.05;
                newP = newP * (1 - m) + 0.5 * m;
                newQ = 1 - newP;
            }

            if (forces.drift) {
                // Genetic drift - sample from binomial
                let A_sampled = 0;
                for (let i = 0; i < popSize * 2; i++) {
                    if (Math.random() < newP) A_sampled++;
                }
                newP = A_sampled / (popSize * 2);
                newQ = 1 - newP;
            }

            // Clamp frequencies
            newP = Math.max(0.001, Math.min(0.999, newP));
            newQ = 1 - newP;

            // Create new generation
            organisms = [];
            const newAAfreq = newP * newP;
            const newAafreq = 2 * newP * newQ;

            for (let i = 0; i < popSize; i++) {
                const r = Math.random();
                let genotype;
                if (r < newAAfreq) genotype = 'AA';
                else if (r < newAAfreq + newAafreq) genotype = 'Aa';
                else genotype = 'aa';

                organisms.push(new Organism(genotype));
            }

            generation++;
            updateStats();
        }

        function updateStats() {
            // Count genotypes
            let counts = { AA: 0, Aa: 0, aa: 0 };
            organisms.forEach(o => counts[o.genotype]++);

            const total = organisms.length;
            const AAfreq = counts.AA / total;
            const Aafreq = counts.Aa / total;
            const aafreq = counts.aa / total;

            // Calculate observed p
            const observedP = (counts.AA * 2 + counts.Aa) / (total * 2);
            const observedQ = 1 - observedP;

            // Expected under HW
            const expAA = observedP * observedP;
            const expAa = 2 * observedP * observedQ;
            const expaa = observedQ * observedQ;

            // Chi-square test
            const chiSquare = total * (
                Math.pow(AAfreq - expAA, 2) / expAA +
                Math.pow(Aafreq - expAa, 2) / expAa +
                Math.pow(aafreq - expaa, 2) / expaa
            );

            // Update display
            document.getElementById('AAfreq').textContent = (AAfreq * 100).toFixed(1) + '%';
            document.getElementById('Aafreq').textContent = (Aafreq * 100).toFixed(1) + '%';
            document.getElementById('aafreq').textContent = (aafreq * 100).toFixed(1) + '%';
            document.getElementById('generation').textContent = generation;
            document.getElementById('observedP').textContent = observedP.toFixed(3);
            document.getElementById('chiSquare').textContent = chiSquare.toFixed(2);

            const inEquilibrium = chiSquare < 3.84 && !Object.values(forces).some(f => f);
            const statusEl = document.getElementById('equilibriumStatus');
            statusEl.textContent = inEquilibrium ? 'Yes' : 'No';
            statusEl.className = inEquilibrium ? 'equilibrium' : 'deviation';

            // Record history
            history.p.push(observedP);
            history.AA.push(AAfreq);
            history.Aa.push(Aafreq);
            history.aa.push(aafreq);
        }

        function resetSimulation() {
            p = parseFloat(document.getElementById('pFreq').value);
            popSize = parseInt(document.getElementById('popSize').value);
            generation = 0;
            history = { p: [], AA: [], Aa: [], aa: [] };
            generatePopulation();
            updateStats();
        }

        function togglePause() {
            paused = !paused;
        }

        function drawPopulation() {
            popCtx.fillStyle = 'rgba(26, 26, 46, 0.2)';
            popCtx.fillRect(0, 0, popCanvas.width, popCanvas.height);

            organisms.forEach(o => {
                o.update();
                o.draw();
            });
        }

        function drawGraph() {
            graphCtx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            graphCtx.fillRect(0, 0, graphCanvas.width, graphCanvas.height);

            if (history.p.length < 2) return;

            const maxPoints = 200;
            const startIdx = Math.max(0, history.p.length - maxPoints);

            // Draw p frequency line
            graphCtx.strokeStyle = '#fff';
            graphCtx.lineWidth = 2;
            graphCtx.beginPath();

            for (let i = startIdx; i < history.p.length; i++) {
                const x = ((i - startIdx) / maxPoints) * graphCanvas.width;
                const y = graphCanvas.height - history.p[i] * graphCanvas.height;

                if (i === startIdx) graphCtx.moveTo(x, y);
                else graphCtx.lineTo(x, y);
            }
            graphCtx.stroke();

            // Draw genotype frequencies
            const colors = { AA: '#e74c3c', Aa: '#9b59b6', aa: '#3498db' };
            ['AA', 'Aa', 'aa'].forEach(genotype => {
                graphCtx.strokeStyle = colors[genotype];
                graphCtx.lineWidth = 1;
                graphCtx.beginPath();

                for (let i = startIdx; i < history[genotype].length; i++) {
                    const x = ((i - startIdx) / maxPoints) * graphCanvas.width;
                    const y = graphCanvas.height - history[genotype][i] * graphCanvas.height;

                    if (i === startIdx) graphCtx.moveTo(x, y);
                    else graphCtx.lineTo(x, y);
                }
                graphCtx.stroke();
            });

            // Legend
            graphCtx.fillStyle = '#fff';
            graphCtx.fillText('p (A freq)', 10, 15);
            graphCtx.fillStyle = '#e74c3c';
            graphCtx.fillText('AA', 100, 15);
            graphCtx.fillStyle = '#9b59b6';
            graphCtx.fillText('Aa', 130, 15);
            graphCtx.fillStyle = '#3498db';
            graphCtx.fillText('aa', 160, 15);
        }

        // Event listeners
        document.getElementById('pFreq').oninput = function() {
            p = parseFloat(this.value);
            document.getElementById('pVal').textContent = p.toFixed(2);
            document.getElementById('qVal').textContent = (1 - p).toFixed(2);

            // Update expected frequencies
            const q = 1 - p;
            document.getElementById('AAfreq').textContent = (p * p * 100).toFixed(1) + '%';
            document.getElementById('Aafreq').textContent = (2 * p * q * 100).toFixed(1) + '%';
            document.getElementById('aafreq').textContent = (q * q * 100).toFixed(1) + '%';
        };

        document.getElementById('popSize').oninput = function() {
            popSize = parseInt(this.value);
            document.getElementById('popSizeVal').textContent = popSize;
        };

        document.getElementById('selectionCoef').oninput = function() {
            selectionCoef = parseFloat(this.value);
            document.getElementById('selectionVal').textContent = selectionCoef.toFixed(2);
        };

        generatePopulation();
        updateStats();

        let frameCount = 0;
        function animate() {
            drawPopulation();
            drawGraph();

            frameCount++;
            if (!paused && frameCount % 30 === 0) {
                stepGeneration();
            }

            requestAnimationFrame(animate);
        }

        animate();
    </script>
    <script src="../../assets/js/enhance.js" defer></script>
</body>
</html>
