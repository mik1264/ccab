<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mushroom Billiard - Mixed Dynamics</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0a0e1a; overflow: hidden; font-family: 'Segoe UI', system-ui, sans-serif; }
        canvas { display: block; }
        a.back { position: fixed; top: 20px; left: 20px; color: #8af; text-decoration: none; z-index: 100; font-size: 1.2em; }
        a.back:hover { color: #bdf; }
        #controls {
            position: fixed; top: 20px; right: 20px; z-index: 100;
            background: rgba(10, 14, 26, 0.75); backdrop-filter: blur(10px);
            border: 1px solid rgba(138, 170, 255, 0.15); border-radius: 12px;
            padding: 16px; color: #cde; font-size: 13px; width: 220px;
        }
        #controls h3 { color: #8af; margin-bottom: 10px; font-size: 14px; }
        .ctrl-row { margin-bottom: 8px; }
        .ctrl-row label { display: block; margin-bottom: 2px; color: #9ab; font-size: 11px; }
        .ctrl-row input[type=range] { width: 100%; accent-color: #8af; }
        .ctrl-row button {
            width: 100%; padding: 5px 8px; background: rgba(138,170,255,0.1);
            border: 1px solid rgba(138,170,255,0.25); border-radius: 6px;
            color: #cde; font-size: 12px; cursor: pointer; margin-top: 2px;
        }
        .ctrl-row button:hover { background: rgba(138,170,255,0.2); }
        .legend { margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(138,170,255,0.1); }
        .legend-item { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; font-size: 11px; color: #9ab; }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; }
        #info {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(10,14,26,0.8); backdrop-filter: blur(10px);
            border: 1px solid rgba(138,170,255,0.15); border-radius: 10px;
            padding: 10px 18px; color: #9ab; font-size: 12px; max-width: 620px;
            text-align: center; z-index: 100;
        }
    </style>
</head>
<body>
<a href="index.html" class="back">&larr; Back</a>
<canvas id="c"></canvas>
<div id="controls">
    <h3>Mushroom Billiard</h3>
    <div class="ctrl-row">
        <label>Cap Radius: <span id="vCap">160</span></label>
        <input type="range" id="capR" min="80" max="250" step="5" value="160">
    </div>
    <div class="ctrl-row">
        <label>Stem Width: <span id="vStem">0.40</span></label>
        <input type="range" id="stemW" min="0.15" max="0.95" step="0.05" value="0.40">
    </div>
    <div class="ctrl-row">
        <label>Stem Height: <span id="vStemH">200</span></label>
        <input type="range" id="stemH" min="80" max="350" step="10" value="200">
    </div>
    <div class="ctrl-row">
        <label>Ball Speed: <span id="vSpeed">3</span></label>
        <input type="range" id="speed" min="1" max="8" step="0.5" value="3">
    </div>
    <div class="ctrl-row">
        <label>Trail Length: <span id="vTrail">1500</span></label>
        <input type="range" id="trail" min="200" max="4000" step="100" value="1500">
    </div>
    <div class="ctrl-row">
        <button id="addRegular">Add Regular Orbit Ball</button>
    </div>
    <div class="ctrl-row">
        <button id="addChaotic">Add Chaotic Orbit Ball</button>
    </div>
    <div class="ctrl-row">
        <button id="resetBtn">Reset All</button>
    </div>
    <div class="legend">
        <div class="legend-item"><div class="legend-dot" style="background:#4488ff"></div> Regular (stays in cap)</div>
        <div class="legend-item"><div class="legend-dot" style="background:#ff4466"></div> Chaotic (enters stem)</div>
    </div>
</div>
<div id="info">
    The mushroom billiard is the simplest known system with a sharply divided phase space.
    Orbits staying in the semicircular cap are regular; those entering the stem become chaotic.
</div>

<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let W, H;

function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
}

function getCapR() { return parseInt(document.getElementById('capR').value); }
function getStemW() { return parseFloat(document.getElementById('stemW').value); }
function getStemH() { return parseInt(document.getElementById('stemH').value); }
function getSpeed() { return parseFloat(document.getElementById('speed').value); }
function getTrail() { return parseInt(document.getElementById('trail').value); }

// Mushroom: semicircle cap on top of rectangular stem
// Cap center at (cx, capY), stem from capY to capY + stemH
function getGeometry() {
    const capR = getCapR();
    const stemRatio = getStemW();
    const stemH = getStemH();
    const cx = W / 2;
    const capY = H / 2 - stemH * 0.2;
    const stemW = capR * 2 * stemRatio;
    const stemLeft = cx - stemW / 2;
    const stemRight = cx + stemW / 2;
    const stemBottom = capY + stemH;
    return { cx, capY, capR, stemW, stemH, stemLeft, stemRight, stemBottom };
}

class Ball {
    constructor(x, y, vx, vy) {
        this.x = x; this.y = y;
        this.vx = vx; this.vy = vy;
        this.trail = [];
        this.chaotic = false;
        this.enteredStem = false;
    }
    get color() { return this.enteredStem ? '#ff4466' : '#4488ff'; }
}

let balls = [];

function addBall(chaotic) {
    const g = getGeometry();
    const spd = getSpeed();
    let x, y, angle;
    if (chaotic) {
        // Start in the stem
        x = g.stemLeft + 10 + Math.random() * (g.stemW - 20);
        y = g.capY + 20 + Math.random() * (g.stemH - 40);
        angle = Math.random() * Math.PI * 2;
    } else {
        // Start in cap, aimed to stay in cap (tangential)
        const a = Math.random() * Math.PI;
        const r = g.capR * 0.4 + Math.random() * g.capR * 0.3;
        x = g.cx + Math.cos(a) * r;
        y = g.capY - Math.sin(a) * r;
        // Tangential direction (perpendicular to radius from cap center)
        const dx = x - g.cx, dy = y - g.capY;
        const len = Math.sqrt(dx*dx + dy*dy);
        angle = Math.atan2(-dx/len, dy/len) + (Math.random()-0.5)*0.3;
    }
    const b = new Ball(x, y, Math.cos(angle)*spd, Math.sin(angle)*spd);
    b.enteredStem = chaotic;
    balls.push(b);
}

function initBalls() {
    balls = [];
    addBall(false);
    addBall(true);
}

function collideMushroom(ball) {
    const g = getGeometry();

    // Cap: semicircle, center (cx, capY), radius capR, top half (y <= capY)
    // Stem: rectangle from (stemLeft, capY) to (stemRight, stemBottom)

    // Determine if ball is in cap region or stem region
    const inCapRegion = ball.y <= g.capY;
    const inStemX = ball.x >= g.stemLeft && ball.x <= g.stemRight;

    if (!inCapRegion && inStemX) {
        ball.enteredStem = true;
    }

    // Cap semicircle boundary (top)
    if (inCapRegion) {
        const dx = ball.x - g.cx, dy = ball.y - g.capY;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (dist >= g.capR - 1) {
            const nx = dx / dist, ny = dy / dist;
            const dot = ball.vx * nx + ball.vy * ny;
            if (dot > 0) {
                ball.vx -= 2 * dot * nx;
                ball.vy -= 2 * dot * ny;
                ball.x = g.cx + nx * (g.capR - 2);
                ball.y = g.capY + ny * (g.capR - 2);
            }
        }
        // Flat bottom of cap (y = capY) - only outside stem opening
        if (ball.y >= g.capY - 1 && ball.vy > 0) {
            if (ball.x < g.stemLeft || ball.x > g.stemRight) {
                ball.y = g.capY - 2;
                ball.vy = -Math.abs(ball.vy);
            }
        }
    }

    // Stem walls
    if (!inCapRegion && ball.y > g.capY) {
        // Left wall
        if (ball.x <= g.stemLeft + 1 && ball.vx < 0) {
            ball.x = g.stemLeft + 2;
            ball.vx = Math.abs(ball.vx);
        }
        // Right wall
        if (ball.x >= g.stemRight - 1 && ball.vx > 0) {
            ball.x = g.stemRight - 2;
            ball.vx = -Math.abs(ball.vx);
        }
        // Bottom wall
        if (ball.y >= g.stemBottom - 1 && ball.vy > 0) {
            ball.y = g.stemBottom - 2;
            ball.vy = -Math.abs(ball.vy);
        }
    }
}

function isInsideMushroom(x, y) {
    const g = getGeometry();
    if (y <= g.capY) {
        const dx = x - g.cx, dy = y - g.capY;
        return dx*dx + dy*dy < g.capR*g.capR;
    }
    return x >= g.stemLeft && x <= g.stemRight && y <= g.stemBottom;
}

function drawMushroom() {
    const g = getGeometry();

    ctx.beginPath();
    // Semicircle cap
    ctx.arc(g.cx, g.capY, g.capR, Math.PI, 0);
    // Down right side of stem
    ctx.lineTo(g.stemRight, g.capY);
    ctx.lineTo(g.stemRight, g.stemBottom);
    ctx.lineTo(g.stemLeft, g.stemBottom);
    ctx.lineTo(g.stemLeft, g.capY);
    ctx.closePath();
    ctx.strokeStyle = 'rgba(138,170,255,0.35)';
    ctx.lineWidth = 2;
    ctx.stroke();

    // Dividing line showing stem opening
    ctx.setLineDash([4, 4]);
    ctx.beginPath();
    ctx.moveTo(g.stemLeft, g.capY);
    ctx.lineTo(g.stemRight, g.capY);
    ctx.strokeStyle = 'rgba(138,170,255,0.15)';
    ctx.lineWidth = 1;
    ctx.stroke();
    ctx.setLineDash([]);

    // Labels
    ctx.fillStyle = 'rgba(68,136,255,0.3)';
    ctx.font = '11px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('Regular Region', g.cx, g.capY - g.capR * 0.5);
    ctx.fillStyle = 'rgba(255,68,102,0.3)';
    ctx.fillText('Chaotic Region', g.cx, g.capY + g.stemH * 0.5);
    ctx.textAlign = 'left';
}

function step() {
    const spd = getSpeed();
    const trailLen = getTrail();
    const substeps = Math.ceil(spd * 3);

    for (const ball of balls) {
        for (let s = 0; s < substeps; s++) {
            const dt = 1 / substeps;
            ball.x += ball.vx * dt;
            ball.y += ball.vy * dt;
            collideMushroom(ball);
        }
        ball.trail.push({ x: ball.x, y: ball.y, c: ball.enteredStem });
        if (ball.trail.length > trailLen) ball.trail.shift();
    }
}

function draw() {
    ctx.fillStyle = '#0a0e1a';
    ctx.fillRect(0, 0, W, H);

    drawMushroom();

    for (const ball of balls) {
        if (ball.trail.length < 2) continue;
        const len = ball.trail.length;
        for (let i = 1; i < len; i++) {
            const alpha = (i / len) * 0.55 + 0.05;
            const pt = ball.trail[i];
            const r = pt.c ? 255 : 68;
            const g = pt.c ? 68 : 136;
            const b = pt.c ? 102 : 255;
            ctx.beginPath();
            ctx.moveTo(ball.trail[i-1].x, ball.trail[i-1].y);
            ctx.lineTo(pt.x, pt.y);
            ctx.strokeStyle = `rgba(${r},${g},${b},${alpha})`;
            ctx.lineWidth = 1.3;
            ctx.stroke();
        }

        // Ball glow
        const cr = ball.enteredStem ? 255 : 68;
        const cg = ball.enteredStem ? 68 : 136;
        const cb = ball.enteredStem ? 102 : 255;
        const grd = ctx.createRadialGradient(ball.x, ball.y, 0, ball.x, ball.y, 12);
        grd.addColorStop(0, `rgba(${cr},${cg},${cb},0.9)`);
        grd.addColorStop(0.4, `rgba(${cr},${cg},${cb},0.3)`);
        grd.addColorStop(1, `rgba(${cr},${cg},${cb},0)`);
        ctx.fillStyle = grd;
        ctx.beginPath();
        ctx.arc(ball.x, ball.y, 12, 0, Math.PI * 2);
        ctx.fill();
    }

    // Stats
    const regular = balls.filter(b => !b.enteredStem).length;
    const chaotic = balls.filter(b => b.enteredStem).length;
    ctx.fillStyle = '#5a7a9a';
    ctx.font = '12px monospace';
    ctx.fillText(`Balls: ${balls.length}  Regular: ${regular}  Chaotic: ${chaotic}`, 20, H - 20);
}

let running = true;

function animate() {
    if (running) { step(); draw(); }
    requestAnimationFrame(animate);
}

// Click to place ball
canvas.addEventListener('click', e => {
    if (isInsideMushroom(e.clientX, e.clientY)) {
        const spd = getSpeed();
        const angle = Math.random() * Math.PI * 2;
        const b = new Ball(e.clientX, e.clientY, Math.cos(angle)*spd, Math.sin(angle)*spd);
        const g = getGeometry();
        if (e.clientY > g.capY) b.enteredStem = true;
        balls.push(b);
    }
});

// Controls
document.getElementById('capR').addEventListener('input', e => {
    document.getElementById('vCap').textContent = e.target.value;
});
document.getElementById('stemW').addEventListener('input', e => {
    document.getElementById('vStem').textContent = parseFloat(e.target.value).toFixed(2);
});
document.getElementById('stemH').addEventListener('input', e => {
    document.getElementById('vStemH').textContent = e.target.value;
});
document.getElementById('speed').addEventListener('input', e => {
    document.getElementById('vSpeed').textContent = e.target.value;
    const spd = parseFloat(e.target.value);
    for (const b of balls) {
        const mag = Math.sqrt(b.vx*b.vx + b.vy*b.vy);
        if (mag > 0) { b.vx = b.vx/mag*spd; b.vy = b.vy/mag*spd; }
    }
});
document.getElementById('trail').addEventListener('input', e => {
    document.getElementById('vTrail').textContent = e.target.value;
});
document.getElementById('addRegular').addEventListener('click', () => addBall(false));
document.getElementById('addChaotic').addEventListener('click', () => addBall(true));
document.getElementById('resetBtn').addEventListener('click', () => initBalls());

window.addEventListener('resize', () => { resize(); initBalls(); });

window.reset = function() { initBalls(); };

resize();
initBalls();
animate();
</script>
<script src="../assets/js/enhance.js"></script>
</body>
</html>
