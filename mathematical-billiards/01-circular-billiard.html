<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Circular Billiard - Star Polygons & Caustics</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; overflow: hidden; font-family: 'Segoe UI', Arial, sans-serif; color: #c8d8e8; }
canvas { display: block; }
a { position: fixed; top: 20px; left: 20px; color: #8af; text-decoration: none; z-index: 100; font-size: 1.2em; }
a:hover { color: #bdf; }
#controls {
  position: fixed; top: 20px; right: 20px; z-index: 100;
  background: rgba(10, 14, 30, 0.75); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(120, 160, 255, 0.15); border-radius: 12px;
  padding: 16px 20px; min-width: 220px;
}
#controls h3 { color: #8af; margin-bottom: 10px; font-size: 0.95em; text-transform: uppercase; letter-spacing: 1px; }
.ctrl-row { margin-bottom: 10px; }
.ctrl-row label { display: block; font-size: 0.8em; color: #8ab; margin-bottom: 3px; }
.ctrl-row input[type=range] { width: 100%; accent-color: #6af; }
.ctrl-row .val { float: right; font-size: 0.8em; color: #adf; }
.btn { background: rgba(100,160,255,0.15); border: 1px solid rgba(100,160,255,0.3); color: #8af; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 0.8em; margin: 2px; }
.btn:hover { background: rgba(100,160,255,0.3); }
.btn.active { background: rgba(100,200,150,0.25); border-color: rgba(100,200,150,0.5); color: #8fa; }
#stats { position: fixed; bottom: 20px; left: 20px; z-index: 100; font-size: 0.85em; color: #6a8; background: rgba(10,14,30,0.6); backdrop-filter: blur(10px); padding: 8px 14px; border-radius: 8px; }
</style>
</head>
<body>
<a href="index.html">&larr; Back</a>
<canvas id="c"></canvas>
<div id="controls">
  <h3>Circular Billiard</h3>
  <div class="ctrl-row">
    <label>Initial Angle <span class="val" id="vAngle">0.38</span></label>
    <input type="range" id="sAngle" min="0.01" max="0.99" step="0.001" value="0.38">
  </div>
  <div class="ctrl-row">
    <label>Trail Length <span class="val" id="vTrail">2000</span></label>
    <input type="range" id="sTrail" min="50" max="10000" step="50" value="2000">
  </div>
  <div class="ctrl-row">
    <label>Ball Speed <span class="val" id="vSpeed">4</span></label>
    <input type="range" id="sSpeed" min="1" max="12" step="0.5" value="4">
  </div>
  <div style="margin-top:10px;">
    <button class="btn active" id="bCaustic">Caustic</button>
    <button class="btn" id="bPresets">Star Presets</button>
  </div>
  <div id="presets" style="display:none; margin-top:8px;">
    <button class="btn" onclick="setAngle(1/3)">3-star</button>
    <button class="btn" onclick="setAngle(2/5)">5-star</button>
    <button class="btn" onclick="setAngle(2/7)">7-star</button>
    <button class="btn" onclick="setAngle(3/8)">8-star</button>
    <button class="btn" onclick="setAngle(1/Math.PI)">Dense</button>
  </div>
</div>
<div id="stats">Bounces: <span id="bounceCount">0</span></div>
<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let W, H, cx, cy, R;
let ball = { x: 0, y: 0, vx: 0, vy: 0 };
let trail = [];
let maxTrail = 2000;
let speed = 4;
let bounces = 0;
let showCaustic = true;
let causticRadius = 0;
let angleParam = 0.38;
let paused = false;
let dragging = false;
let dragStart = null;

function resize() {
  W = canvas.width = window.innerWidth;
  H = canvas.height = window.innerHeight;
  cx = W / 2;
  cy = H / 2;
  R = Math.min(W, H) * 0.38;
}
resize();

function initBall(fromAngle) {
  trail = [];
  bounces = 0;
  const startAngle = Math.PI * 0.5;
  ball.x = cx + R * Math.cos(startAngle);
  ball.y = cy + R * Math.sin(startAngle);
  const reflAngle = Math.PI * fromAngle;
  const tangent = { x: -Math.sin(startAngle), y: Math.cos(startAngle) };
  const normal = { x: Math.cos(startAngle), y: Math.sin(startAngle) };
  const dir = {
    x: -normal.x * Math.cos(reflAngle) + tangent.x * Math.sin(reflAngle),
    y: -normal.y * Math.cos(reflAngle) + tangent.y * Math.sin(reflAngle)
  };
  ball.vx = dir.x;
  ball.vy = dir.y;
  causticRadius = R * Math.cos(reflAngle);
  if (causticRadius < 0) causticRadius = -causticRadius;
  trail.push({ x: ball.x, y: ball.y });
}

function setAngle(v) {
  angleParam = v;
  document.getElementById('sAngle').value = v;
  document.getElementById('vAngle').textContent = v.toFixed(3);
  initBall(v);
}

initBall(angleParam);

function update() {
  if (paused) return;
  for (let i = 0; i < speed * 2; i++) {
    const step = 2;
    ball.x += ball.vx * step;
    ball.y += ball.vy * step;
    const dx = ball.x - cx;
    const dy = ball.y - cy;
    const dist = Math.sqrt(dx * dx + dy * dy);
    if (dist >= R) {
      const nx = dx / dist;
      const ny = dy / dist;
      const dot = ball.vx * nx + ball.vy * ny;
      ball.vx -= 2 * dot * nx;
      ball.vy -= 2 * dot * ny;
      ball.x = cx + nx * (R - 1);
      ball.y = cy + ny * (R - 1);
      bounces++;
    }
    trail.push({ x: ball.x, y: ball.y });
    if (trail.length > maxTrail) trail.shift();
  }
  document.getElementById('bounceCount').textContent = bounces;
}

function draw() {
  ctx.fillStyle = 'rgba(10, 14, 30, 0.15)';
  ctx.fillRect(0, 0, W, H);
  // Table circle
  ctx.beginPath();
  ctx.arc(cx, cy, R, 0, Math.PI * 2);
  ctx.strokeStyle = 'rgba(100, 160, 255, 0.3)';
  ctx.lineWidth = 2;
  ctx.stroke();
  // Glow on table edge
  ctx.shadowColor = '#4488ff';
  ctx.shadowBlur = 15;
  ctx.beginPath();
  ctx.arc(cx, cy, R, 0, Math.PI * 2);
  ctx.strokeStyle = 'rgba(80, 140, 255, 0.12)';
  ctx.lineWidth = 4;
  ctx.stroke();
  ctx.shadowBlur = 0;
  // Caustic
  if (showCaustic && causticRadius > 5) {
    ctx.beginPath();
    ctx.arc(cx, cy, causticRadius, 0, Math.PI * 2);
    ctx.strokeStyle = 'rgba(255, 160, 80, 0.4)';
    ctx.lineWidth = 1.5;
    ctx.setLineDash([4, 4]);
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.shadowColor = '#ff8844';
    ctx.shadowBlur = 10;
    ctx.beginPath();
    ctx.arc(cx, cy, causticRadius, 0, Math.PI * 2);
    ctx.strokeStyle = 'rgba(255, 140, 60, 0.15)';
    ctx.lineWidth = 6;
    ctx.stroke();
    ctx.shadowBlur = 0;
  }
  // Trail
  if (trail.length > 1) {
    const len = trail.length;
    for (let i = 1; i < len; i++) {
      const alpha = (i / len);
      const hue = 200 + (i / len) * 60;
      ctx.beginPath();
      ctx.moveTo(trail[i - 1].x, trail[i - 1].y);
      ctx.lineTo(trail[i].x, trail[i].y);
      ctx.strokeStyle = `hsla(${hue}, 80%, 65%, ${alpha * 0.7})`;
      ctx.lineWidth = 1 + alpha * 1.5;
      ctx.stroke();
    }
  }
  // Ball glow
  ctx.shadowColor = '#88ccff';
  ctx.shadowBlur = 20;
  ctx.beginPath();
  ctx.arc(ball.x, ball.y, 4, 0, Math.PI * 2);
  ctx.fillStyle = '#bbddff';
  ctx.fill();
  ctx.shadowBlur = 0;
  // Drag indicator
  if (dragging && dragStart) {
    ctx.beginPath();
    ctx.moveTo(dragStart.x, dragStart.y);
    ctx.lineTo(ball.x, ball.y);
    ctx.strokeStyle = 'rgba(255,255,255,0.3)';
    ctx.lineWidth = 1;
    ctx.setLineDash([3, 3]);
    ctx.stroke();
    ctx.setLineDash([]);
  }
}

function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}

// Controls
document.getElementById('sAngle').addEventListener('input', function() {
  angleParam = parseFloat(this.value);
  document.getElementById('vAngle').textContent = angleParam.toFixed(3);
  initBall(angleParam);
});
document.getElementById('sTrail').addEventListener('input', function() {
  maxTrail = parseInt(this.value);
  document.getElementById('vTrail').textContent = maxTrail;
});
document.getElementById('sSpeed').addEventListener('input', function() {
  speed = parseFloat(this.value);
  document.getElementById('vSpeed').textContent = speed;
});
document.getElementById('bCaustic').addEventListener('click', function() {
  showCaustic = !showCaustic;
  this.classList.toggle('active');
});
document.getElementById('bPresets').addEventListener('click', function() {
  const p = document.getElementById('presets');
  p.style.display = p.style.display === 'none' ? 'block' : 'none';
  this.classList.toggle('active');
});

// Click to set position/direction
canvas.addEventListener('mousedown', function(e) {
  const dx = e.clientX - cx;
  const dy = e.clientY - cy;
  if (Math.sqrt(dx * dx + dy * dy) < R) {
    dragging = true;
    dragStart = { x: e.clientX, y: e.clientY };
  }
});
canvas.addEventListener('mouseup', function(e) {
  if (dragging && dragStart) {
    const dx = e.clientX - dragStart.x;
    const dy = e.clientY - dragStart.y;
    const len = Math.sqrt(dx * dx + dy * dy);
    if (len > 5) {
      trail = [];
      bounces = 0;
      ball.x = dragStart.x;
      ball.y = dragStart.y;
      ball.vx = dx / len;
      ball.vy = dy / len;
      // Estimate caustic radius from the trajectory
      const px = dragStart.x - cx, py = dragStart.y - cy;
      const cross = Math.abs(px * ball.vy - py * ball.vx);
      causticRadius = cross;
    }
    dragging = false;
    dragStart = null;
  }
});
canvas.addEventListener('mousemove', function(e) {
  if (dragging) {
    // Visual feedback handled in draw
  }
});

window.addEventListener('resize', resize);
window.addEventListener('keydown', function(e) {
  if (e.code === 'Space') { e.preventDefault(); paused = !paused; }
});

window.reset = function() {
  initBall(angleParam);
  ctx.clearRect(0, 0, W, H);
};

requestAnimationFrame(loop);
</script>
<script src="../assets/js/enhance.js"></script>
</body>
</html>