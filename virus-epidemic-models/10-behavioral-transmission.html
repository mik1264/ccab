<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Behavioral Transmission Model</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            overflow: hidden;
        }
        #canvas {
            display: block;
            background: #000;
        }
        .info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            max-width: 350px;
        }
        h1 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #333;
        }
        .description {
            font-size: 12px;
            color: #666;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        .param {
            margin-bottom: 12px;
        }
        label {
            display: block;
            font-size: 12px;
            margin-bottom: 4px;
            color: #666;
        }
        input[type="range"] {
            width: 100%;
        }
        .value {
            font-weight: bold;
            color: #333;
        }
        .stats {
            font-size: 12px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            padding: 4px;
            background: #f5f5f5;
            border-radius: 3px;
        }
        .single { color: #64748b; }
        .coupled { color: #3b82f6; }
        .infected { color: #ef4444; }
        .known { color: #9333ea; }
        button {
            width: 100%;
            padding: 8px;
            margin-top: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #5568d3;
        }
        .legend {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
            font-size: 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <div class="info-panel">
        <h1>Behavioral Transmission</h1>
        <p class="description">
            Simulates sexual contact networks with coupling dynamics, condom use, and testing. Lines connect couples.
        </p>

        <div class="param">
            <label>Coupling Tendency: <span class="value" id="couplingVal">25</span>%</label>
            <input type="range" id="coupling" min="5" max="60" value="25">
        </div>

        <div class="param">
            <label>Condom Use: <span class="value" id="condomVal">40</span>%</label>
            <input type="range" id="condom" min="0" max="100" value="40">
        </div>

        <div class="param">
            <label>Testing Rate: <span class="value" id="testVal">5</span>%/year</label>
            <input type="range" id="testing" min="0" max="30" value="5">
        </div>

        <button id="reset">Reset Simulation</button>

        <div class="stats">
            <div class="stat-row">
                <span class="single">Single:</span>
                <span id="singleCount" class="single">0</span>
            </div>
            <div class="stat-row">
                <span class="coupled">Coupled:</span>
                <span id="coupledCount" class="coupled">0</span>
            </div>
            <div class="stat-row">
                <span class="infected">Infected:</span>
                <span id="infectedCount" class="infected">0</span>
            </div>
            <div class="stat-row">
                <span class="known">Known Status:</span>
                <span id="knownCount" class="known">0</span>
            </div>
            <div class="stat-row">
                <span>Time:</span>
                <span id="time">0</span>
            </div>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-dot" style="background: #64748b;"></div>
                <span>Single/Clean</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #3b82f6;"></div>
                <span>Coupled/Clean</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #ef4444;"></div>
                <span>Infected (unknown)</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #9333ea;"></div>
                <span>Infected (known)</span>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let params = {
            coupling: 25,
            condom: 40,
            testing: 5
        };

        let agents = [];
        let couples = [];
        let time = 0;

        class Agent {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 1.5;
                this.vy = (Math.random() - 0.5) * 1.5;
                this.partner = null;
                this.infected = false;
                this.knowsStatus = false;
                this.timeSinceTest = Math.random() * 52; // weeks
                this.commitmentTime = 0;
                this.maxCommitment = 50 + Math.random() * 100; // weeks
                this.condomUse = Math.random() * 100;
                this.radius = 5;
            }

            update() {
                if (!this.partner) {
                    // Single agents move randomly
                    this.x += this.vx;
                    this.y += this.vy;

                    if (this.x < this.radius || this.x > canvas.width - this.radius) this.vx *= -1;
                    if (this.y < this.radius || this.y > canvas.height - this.radius) this.vy *= -1;

                    this.x = Math.max(this.radius, Math.min(canvas.width - this.radius, this.x));
                    this.y = Math.max(this.radius, Math.min(canvas.height - this.radius, this.y));
                } else {
                    // Coupled agents stay together
                    this.commitmentTime++;
                    if (this.commitmentTime >= this.maxCommitment) {
                        this.breakup();
                    }
                }

                // Testing
                this.timeSinceTest++;
                const weeksPerYear = 52;
                const testProbPerWeek = params.testing / 100 / weeksPerYear;
                if (Math.random() < testProbPerWeek || (this.infected && this.timeSinceTest > 200)) {
                    if (this.infected) {
                        this.knowsStatus = true;
                    }
                    this.timeSinceTest = 0;
                }
            }

            breakup() {
                if (this.partner) {
                    this.partner.partner = null;
                    this.partner.commitmentTime = 0;
                    this.partner = null;
                    this.commitmentTime = 0;
                }
            }

            draw() {
                let color;
                if (this.infected && this.knowsStatus) {
                    color = '#9333ea'; // Purple - known infected
                } else if (this.infected) {
                    color = '#ef4444'; // Red - unknown infected
                } else if (this.partner) {
                    color = '#3b82f6'; // Blue - coupled
                } else {
                    color = '#64748b'; // Gray - single
                }

                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fill();

                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 1;
                ctx.stroke();
            }
        }

        function init() {
            agents = [];
            couples = [];
            time = 0;

            for (let i = 0; i < 150; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const agent = new Agent(x, y);
                if (i < 3) agent.infected = true; // Initial infections
                agents.push(agent);
            }
        }

        function formCouples() {
            const singles = agents.filter(a => !a.partner);

            for (let agent of singles) {
                if (agent.partner) continue;

                if (Math.random() * 100 < params.coupling) {
                    // Find nearby single
                    const nearby = singles.filter(a =>
                        !a.partner &&
                        a !== agent &&
                        Math.hypot(a.x - agent.x, a.y - agent.y) < 100
                    );

                    if (nearby.length > 0) {
                        const partner = nearby[Math.floor(Math.random() * nearby.length)];
                        agent.partner = partner;
                        partner.partner = agent;

                        // Position together
                        const midX = (agent.x + partner.x) / 2;
                        const midY = (agent.y + partner.y) / 2;
                        agent.x = midX + (Math.random() - 0.5) * 10;
                        agent.y = midY + (Math.random() - 0.5) * 10;
                        partner.x = midX + (Math.random() - 0.5) * 10;
                        partner.y = midY + (Math.random() - 0.5) * 10;
                    }
                }
            }
        }

        function transmit() {
            for (let agent of agents) {
                if (!agent.partner || !agent.infected) continue;

                const partner = agent.partner;
                if (partner.infected) continue;

                // Transmission probability
                const baseTransmission = 5; // 5% per contact
                let transmission = baseTransmission;

                // Condom use reduces transmission
                const useCondom = agent.knowsStatus || partner.knowsStatus ||
                                  (Math.random() * 100 < agent.condomUse && Math.random() * 100 < partner.condomUse);

                if (useCondom) {
                    transmission *= 0.1; // 90% reduction
                }

                // Apply transmission probability weekly
                if (Math.random() * 100 < transmission) {
                    partner.infected = true;
                }
            }
        }

        function drawCouples() {
            ctx.strokeStyle = 'rgba(59, 130, 246, 0.3)';
            ctx.lineWidth = 2;

            for (let agent of agents) {
                if (agent.partner && agent.id < agent.partner.id) { // Draw each couple once
                    ctx.beginPath();
                    ctx.moveTo(agent.x, agent.y);
                    ctx.lineTo(agent.partner.x, agent.partner.y);
                    ctx.stroke();
                }
            }
        }

        function updateStats() {
            let single = 0, coupled = 0, infected = 0, known = 0;

            agents.forEach(agent => {
                if (!agent.partner) single++;
                else coupled++;
                if (agent.infected) infected++;
                if (agent.infected && agent.knowsStatus) known++;
            });

            document.getElementById('singleCount').textContent = single;
            document.getElementById('coupledCount').textContent = coupled;
            document.getElementById('infectedCount').textContent = infected;
            document.getElementById('knownCount').textContent = known;
            document.getElementById('time').textContent = time;
        }

        function animate() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            agents.forEach(a => a.update());
            formCouples();
            transmit();

            drawCouples();
            agents.forEach(a => a.draw());

            time++;
            if (time % 5 === 0) updateStats();

            requestAnimationFrame(animate);
        }

        // Event listeners
        document.getElementById('coupling').addEventListener('input', (e) => {
            params.coupling = parseInt(e.target.value);
            document.getElementById('couplingVal').textContent = params.coupling;
        });

        document.getElementById('condom').addEventListener('input', (e) => {
            params.condom = parseInt(e.target.value);
            document.getElementById('condomVal').textContent = params.condom;
            agents.forEach(a => a.condomUse = params.condom);
        });

        document.getElementById('testing').addEventListener('input', (e) => {
            params.testing = parseInt(e.target.value);
            document.getElementById('testVal').textContent = params.testing;
        });

        document.getElementById('reset').addEventListener('click', () => {
            init();
        });

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        // Assign unique IDs for couple drawing
        let nextId = 0;
        Agent.prototype.id = 0;
        const originalAgent = Agent;
        Agent = function(...args) {
            const instance = new originalAgent(...args);
            instance.id = nextId++;
            return instance;
        };

        init();
        animate();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
