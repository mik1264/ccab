<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pollution Dispersion - Climate/Environment Simulations</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; color: #e2e8f0; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { text-align: center; margin-bottom: 30px; }
        .back-link { display: inline-flex; align-items: center; gap: 8px; color: #22c55e; text-decoration: none; font-size: 0.9rem; margin-bottom: 20px; }
        h1 { font-size: 2.5rem; font-weight: 700; color: #22c55e; margin-bottom: 10px; }
        .subtitle { color: #94a3b8; font-size: 1.1rem; }
        .simulation-container { display: grid; grid-template-columns: 1fr 320px; gap: 20px; margin-bottom: 30px; }
        .canvas-wrapper { background: rgba(0, 0, 0, 0.3); border-radius: 16px; padding: 20px; border: 1px solid rgba(34, 197, 94, 0.2); }
        canvas { display: block; width: 100%; height: 500px; border-radius: 8px; background: linear-gradient(180deg, #87CEEB 0%, #E0E0E0 100%); cursor: crosshair; }
        .controls-panel { background: rgba(0, 0, 0, 0.3); border-radius: 16px; padding: 20px; border: 1px solid rgba(34, 197, 94, 0.2); }
        .control-section { margin-bottom: 20px; }
        .control-section h3 { color: #22c55e; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; }
        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; color: #94a3b8; font-size: 0.85rem; margin-bottom: 6px; }
        .control-group input[type="range"] { width: 100%; height: 6px; border-radius: 3px; background: #1e293b; outline: none; -webkit-appearance: none; }
        .control-group input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: #22c55e; cursor: pointer; }
        .control-value { text-align: right; color: #22c55e; font-size: 0.85rem; font-weight: 600; }
        .aqi-display { text-align: center; padding: 20px; border-radius: 12px; margin-bottom: 15px; }
        .aqi-value { font-size: 3rem; font-weight: 700; }
        .aqi-label { font-size: 0.9rem; margin-top: 5px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-item { background: rgba(34, 197, 94, 0.1); padding: 12px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 1.4rem; font-weight: 700; color: #22c55e; }
        .stat-label { font-size: 0.75rem; color: #94a3b8; margin-top: 4px; }
        .btn-row { display: flex; gap: 10px; margin-top: 15px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .btn-primary { background: #22c55e; color: #1a1a2e; }
        .btn-secondary { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .info-box { background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 12px; padding: 20px; }
        .info-box h3 { color: #22c55e; margin-bottom: 10px; }
        .info-box p { color: #94a3b8; font-size: 0.9rem; line-height: 1.6; }
        @media (max-width: 900px) { .simulation-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="index.html" class="back-link"><span>←</span><span>Back to Climate/Environment</span></a>
            <h1>Pollution Dispersion</h1>
            <p class="subtitle">Atmospheric pollutant spreading simulation</p>
        </header>

        <div class="simulation-container">
            <div class="canvas-wrapper">
                <canvas id="simCanvas"></canvas>
            </div>

            <div class="controls-panel">
                <div class="aqi-display" id="aqiBox" style="background: rgba(34, 197, 94, 0.2);">
                    <div class="aqi-value" id="aqi">25</div>
                    <div class="aqi-label" id="aqiLabel">Good Air Quality</div>
                </div>

                <div class="control-section">
                    <h3>Atmospheric Conditions</h3>
                    <div class="control-group">
                        <label>Wind Speed</label>
                        <input type="range" id="windSpeed" min="0" max="20" value="5">
                        <div class="control-value"><span id="windSpeedVal">5</span> m/s</div>
                    </div>
                    <div class="control-group">
                        <label>Wind Direction</label>
                        <input type="range" id="windDir" min="0" max="360" value="90">
                        <div class="control-value"><span id="windDirVal">90</span>°</div>
                    </div>
                    <div class="control-group">
                        <label>Atmospheric Stability</label>
                        <input type="range" id="stability" min="1" max="6" value="3">
                        <div class="control-value">Class <span id="stabilityVal">C</span></div>
                    </div>
                    <div class="control-group">
                        <label>Mixing Height</label>
                        <input type="range" id="mixingHeight" min="100" max="2000" value="1000">
                        <div class="control-value"><span id="mixingHeightVal">1000</span>m</div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Emission Source</h3>
                    <div class="control-group">
                        <label>Emission Rate</label>
                        <input type="range" id="emission" min="0" max="100" value="50">
                        <div class="control-value"><span id="emissionVal">50</span> kg/hr</div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="particles">0</div>
                            <div class="stat-label">Particles</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="maxConc">0</div>
                            <div class="stat-label">Max μg/m³</div>
                        </div>
                    </div>
                </div>

                <div class="btn-row">
                    <button class="btn btn-primary" id="resetBtn">Clear Air</button>
                    <button class="btn btn-secondary" id="pauseBtn">Pause</button>
                </div>
            </div>
        </div>

        <div class="info-box">
            <h3>Gaussian Plume Dispersion</h3>
            <p>
                Click to place pollution sources. Pollutants disperse according to the Gaussian plume model,
                affected by wind, atmospheric stability (A=unstable, F=stable), and mixing layer height.
                Unstable conditions promote vertical mixing and faster dispersion.
            </p>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');

        function resizeCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * window.devicePixelRatio;
            canvas.height = rect.height * window.devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        let paused = false;
        let particles = [];
        let sources = [];

        const params = {
            windSpeed: 5,
            windDir: 90,
            stability: 3,
            mixingHeight: 1000,
            emission: 50
        };

        const stabilityClasses = ['A', 'B', 'C', 'D', 'E', 'F'];

        class PollutionSource {
            constructor(x, y) {
                this.x = x;
                this.y = y;
            }

            emit() {
                if (Math.random() < params.emission / 500) {
                    particles.push(new Particle(this.x, this.y));
                }
            }

            draw(ctx) {
                // Chimney
                ctx.fillStyle = '#4b5563';
                ctx.fillRect(this.x - 8, this.y, 16, 40);

                // Smoke animation
                ctx.fillStyle = '#6b7280';
                const t = Date.now() / 500;
                for (let i = 0; i < 3; i++) {
                    const offset = Math.sin(t + i) * 5;
                    ctx.beginPath();
                    ctx.arc(this.x + offset, this.y - 5 - i * 8, 8 - i * 2, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
        }

        class Particle {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.age = 0;
                this.concentration = 100;
            }

            update() {
                // Wind advection
                const windRad = params.windDir * Math.PI / 180;
                this.x += Math.cos(windRad) * params.windSpeed * 0.5;
                this.y += Math.sin(windRad) * params.windSpeed * 0.3;

                // Dispersion based on stability
                const dispersionRate = (7 - params.stability) / 3;
                this.x += (Math.random() - 0.5) * dispersionRate * 3;
                this.y += (Math.random() - 0.5) * dispersionRate * 2;

                // Mixing height boundary
                const groundY = canvas.height / window.devicePixelRatio - 50;
                const maxHeight = groundY - params.mixingHeight / 5;
                if (this.y < maxHeight) {
                    this.y = maxHeight + Math.random() * 10;
                }
                if (this.y > groundY) {
                    this.y = groundY - 5;
                }

                // Concentration decay
                this.concentration *= 0.995;
                this.age++;

                return this.concentration > 1 && this.x > 0 && this.x < canvas.width / window.devicePixelRatio;
            }

            draw(ctx) {
                const alpha = this.concentration / 150;
                const size = 3 + (100 - this.concentration) / 20;

                ctx.fillStyle = `rgba(120, 120, 120, ${alpha})`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function calculateAQI() {
            const width = canvas.width / window.devicePixelRatio;
            const height = canvas.height / window.devicePixelRatio;

            // Sample center area concentration
            const centerParticles = particles.filter(p =>
                p.x > width * 0.3 && p.x < width * 0.7 &&
                p.y > height * 0.3 && p.y < height * 0.7
            );

            const totalConc = centerParticles.reduce((sum, p) => sum + p.concentration, 0);
            const avgConc = centerParticles.length > 0 ? totalConc / centerParticles.length : 0;

            return Math.min(500, Math.round(avgConc * 2));
        }

        function getAQIColor(aqi) {
            if (aqi <= 50) return { bg: 'rgba(34, 197, 94, 0.2)', color: '#22c55e', label: 'Good' };
            if (aqi <= 100) return { bg: 'rgba(250, 204, 21, 0.2)', color: '#facc15', label: 'Moderate' };
            if (aqi <= 150) return { bg: 'rgba(249, 115, 22, 0.2)', color: '#f97316', label: 'Unhealthy for Sensitive' };
            if (aqi <= 200) return { bg: 'rgba(239, 68, 68, 0.2)', color: '#ef4444', label: 'Unhealthy' };
            if (aqi <= 300) return { bg: 'rgba(168, 85, 247, 0.2)', color: '#a855f7', label: 'Very Unhealthy' };
            return { bg: 'rgba(127, 29, 29, 0.2)', color: '#7f1d1d', label: 'Hazardous' };
        }

        function drawScene() {
            const width = canvas.width / window.devicePixelRatio;
            const height = canvas.height / window.devicePixelRatio;

            // Sky gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, height);
            gradient.addColorStop(0, '#87CEEB');
            gradient.addColorStop(1, '#E0E7E9');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, height);

            // Ground
            ctx.fillStyle = '#228B22';
            ctx.fillRect(0, height - 50, width, 50);

            // Mixing height indicator
            const mixingY = height - 50 - params.mixingHeight / 5;
            ctx.strokeStyle = 'rgba(100, 100, 255, 0.3)';
            ctx.setLineDash([10, 5]);
            ctx.beginPath();
            ctx.moveTo(0, mixingY);
            ctx.lineTo(width, mixingY);
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.fillStyle = 'rgba(100, 100, 255, 0.5)';
            ctx.font = '10px system-ui';
            ctx.fillText('Mixing Layer', 5, mixingY - 5);

            // Wind indicator
            ctx.save();
            ctx.translate(width - 50, 50);
            ctx.rotate(params.windDir * Math.PI / 180);
            ctx.fillStyle = '#3b82f6';
            ctx.beginPath();
            ctx.moveTo(20, 0);
            ctx.lineTo(-10, -8);
            ctx.lineTo(-10, 8);
            ctx.closePath();
            ctx.fill();
            ctx.restore();
            ctx.fillStyle = '#3b82f6';
            ctx.font = '12px system-ui';
            ctx.textAlign = 'center';
            ctx.fillText(`${params.windSpeed} m/s`, width - 50, 80);

            // Draw particles
            particles.forEach(p => p.draw(ctx));

            // Draw sources
            sources.forEach(s => s.draw(ctx));
        }

        function updateStats() {
            const aqi = calculateAQI();
            const aqiInfo = getAQIColor(aqi);

            document.getElementById('aqi').textContent = aqi;
            document.getElementById('aqiLabel').textContent = aqiInfo.label;
            document.getElementById('aqiBox').style.background = aqiInfo.bg;
            document.getElementById('aqi').style.color = aqiInfo.color;

            document.getElementById('particles').textContent = particles.length;
            const maxConc = particles.length > 0 ?
                Math.round(Math.max(...particles.map(p => p.concentration))) : 0;
            document.getElementById('maxConc').textContent = maxConc;
        }

        function animate() {
            if (!paused) {
                drawScene();

                // Emit from sources
                sources.forEach(s => s.emit());

                // Update particles
                particles = particles.filter(p => p.update());

                // Limit particles
                if (particles.length > 2000) {
                    particles = particles.slice(-1500);
                }

                updateStats();
            }
            requestAnimationFrame(animate);
        }

        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const height = canvas.height / window.devicePixelRatio;

            if (y < height - 90) {
                sources.push(new PollutionSource(x, height - 90));
            }
        });

        document.getElementById('windSpeed').addEventListener('input', (e) => {
            params.windSpeed = parseInt(e.target.value);
            document.getElementById('windSpeedVal').textContent = params.windSpeed;
        });

        document.getElementById('windDir').addEventListener('input', (e) => {
            params.windDir = parseInt(e.target.value);
            document.getElementById('windDirVal').textContent = params.windDir;
        });

        document.getElementById('stability').addEventListener('input', (e) => {
            params.stability = parseInt(e.target.value);
            document.getElementById('stabilityVal').textContent = stabilityClasses[params.stability - 1];
        });

        document.getElementById('mixingHeight').addEventListener('input', (e) => {
            params.mixingHeight = parseInt(e.target.value);
            document.getElementById('mixingHeightVal').textContent = params.mixingHeight;
        });

        document.getElementById('emission').addEventListener('input', (e) => {
            params.emission = parseInt(e.target.value);
            document.getElementById('emissionVal').textContent = params.emission;
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            particles = [];
            sources = [];
        });

        document.getElementById('pauseBtn').addEventListener('click', () => {
            paused = !paused;
            document.getElementById('pauseBtn').textContent = paused ? 'Resume' : 'Pause';
        });

        // Add initial source
        sources.push(new PollutionSource(100, canvas.height / window.devicePixelRatio - 90));

        animate();
    </script>
</body>
</html>
