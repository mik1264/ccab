<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Double Pendulum Challenge - CCAB</title>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&family=Nunito:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Nunito', sans-serif;
            background: #1a1a2e;
            color: white;
            overflow: hidden;
        }
        canvas {
            display: block;
            position: fixed;
            top: 0;
            left: 0;
        }
        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            color: #8A9A5B;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            background: rgba(0,0,0,0.7);
            border-radius: 20px;
        }
        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 15px;
            z-index: 100;
            width: 300px;
        }
        .controls h3 {
            font-family: 'Lora', serif;
            color: #8A9A5B;
            margin-bottom: 15px;
        }
        .control-group {
            margin-bottom: 12px;
        }
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #ccc;
        }
        .control-group input[type="range"] {
            width: 100%;
            accent-color: #BC6C25;
        }
        .value-display {
            text-align: right;
            font-size: 0.8rem;
            color: #8A9A5B;
        }
        .btn {
            background: linear-gradient(135deg, #606C38, #8A9A5B);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            margin: 5px 3px;
        }
        .btn:hover { transform: scale(1.02); }
        .btn.secondary {
            background: linear-gradient(135deg, #BC6C25, #DDA15E);
        }
        .stats {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #444;
        }
        .stats div {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.85rem;
        }
        .stats .label { color: #888; }
        .stats .value { color: #8A9A5B; font-weight: bold; }
        .challenge-status {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #444;
        }
        .challenge-item {
            margin-bottom: 8px;
            font-size: 0.8rem;
        }
        .challenge-item.completed { color: #4CAF50; }
        .challenge-item.pending { color: #888; }
        .info-box {
            background: rgba(138, 154, 91, 0.2);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Challenges</a>

    <canvas id="canvas"></canvas>

    <div class="controls">
        <h3>üîÑ Double Pendulum</h3>

        <div class="info-box">
            Adjust initial angles to explore chaos. Tiny changes lead to vastly different trajectories!
        </div>

        <div class="control-group">
            <label>Angle 1 (¬∞) <span class="value-display" id="a1Val">90</span></label>
            <input type="range" id="angle1" min="0" max="180" value="90">
        </div>

        <div class="control-group">
            <label>Angle 2 (¬∞) <span class="value-display" id="a2Val">90</span></label>
            <input type="range" id="angle2" min="0" max="180" value="90">
        </div>

        <div class="control-group">
            <label>Length 1 <span class="value-display" id="l1Val">150</span></label>
            <input type="range" id="length1" min="50" max="200" value="150">
        </div>

        <div class="control-group">
            <label>Length 2 <span class="value-display" id="l2Val">150</span></label>
            <input type="range" id="length2" min="50" max="200" value="150">
        </div>

        <div class="control-group">
            <label>Gravity <span class="value-display" id="gVal">1.0</span></label>
            <input type="range" id="gravity" min="0.1" max="2" step="0.1" value="1">
        </div>

        <div>
            <button class="btn" onclick="reset()">Reset</button>
            <button class="btn secondary" onclick="addSecond()">Add Comparison</button>
            <button class="btn" onclick="toggleTrail()">Toggle Trail</button>
        </div>

        <div class="stats">
            <div><span class="label">Time:</span> <span class="value" id="time">0</span>s</div>
            <div><span class="label">Outer Revolutions:</span> <span class="value" id="revolutions">0</span></div>
            <div><span class="label">Max Velocity:</span> <span class="value" id="maxVel">0</span></div>
            <div><span class="label">Energy:</span> <span class="value" id="energy">0</span></div>
        </div>

        <div class="challenge-status">
            <div class="challenge-item pending" id="ch1">‚≠ï Outer pendulum full revolution</div>
            <div class="challenge-item pending" id="ch2">‚≠ï Both pendulums do 360¬∞</div>
            <div class="challenge-item pending" id="ch3">‚≠ï Chaos divergence (add comparison)</div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let width, height, originX, originY;
        let showTrail = true;
        let completedChallenges = new Set();

        class DoublePendulum {
            constructor(a1, a2, l1, l2, color, offset = 0) {
                this.a1 = a1 * Math.PI / 180;
                this.a2 = a2 * Math.PI / 180;
                this.a1_v = 0;
                this.a2_v = 0;
                this.l1 = l1;
                this.l2 = l2;
                this.m1 = 10;
                this.m2 = 10;
                this.g = 1;
                this.color = color;
                this.trail = [];
                this.revolutions1 = 0;
                this.revolutions2 = 0;
                this.lastA1 = this.a1;
                this.lastA2 = this.a2;
                this.totalAngle2 = 0;
                this.maxVelocity = 0;
                this.offset = offset;
            }

            update() {
                const g = this.g;
                const m1 = this.m1, m2 = this.m2;
                const l1 = this.l1, l2 = this.l2;
                const a1 = this.a1, a2 = this.a2;
                const a1_v = this.a1_v, a2_v = this.a2_v;

                // Angular accelerations using Lagrangian mechanics
                const num1 = -g * (2 * m1 + m2) * Math.sin(a1);
                const num2 = -m2 * g * Math.sin(a1 - 2 * a2);
                const num3 = -2 * Math.sin(a1 - a2) * m2;
                const num4 = a2_v * a2_v * l2 + a1_v * a1_v * l1 * Math.cos(a1 - a2);
                const den = l1 * (2 * m1 + m2 - m2 * Math.cos(2 * a1 - 2 * a2));
                const a1_a = (num1 + num2 + num3 * num4) / den;

                const num5 = 2 * Math.sin(a1 - a2);
                const num6 = a1_v * a1_v * l1 * (m1 + m2);
                const num7 = g * (m1 + m2) * Math.cos(a1);
                const num8 = a2_v * a2_v * l2 * m2 * Math.cos(a1 - a2);
                const den2 = l2 * (2 * m1 + m2 - m2 * Math.cos(2 * a1 - 2 * a2));
                const a2_a = (num5 * (num6 + num7 + num8)) / den2;

                this.a1_v += a1_a;
                this.a2_v += a2_a;
                this.a1 += this.a1_v;
                this.a2 += this.a2_v;

                // Damping
                this.a1_v *= 0.9999;
                this.a2_v *= 0.9999;

                // Track revolutions
                let da1 = this.a1 - this.lastA1;
                let da2 = this.a2 - this.lastA2;
                if (da1 > Math.PI) da1 -= 2 * Math.PI;
                if (da1 < -Math.PI) da1 += 2 * Math.PI;
                if (da2 > Math.PI) da2 -= 2 * Math.PI;
                if (da2 < -Math.PI) da2 += 2 * Math.PI;

                this.totalAngle2 += da2;
                this.revolutions2 = Math.floor(Math.abs(this.totalAngle2) / (2 * Math.PI));

                this.lastA1 = this.a1;
                this.lastA2 = this.a2;

                // Track max velocity
                const v = Math.sqrt(this.a1_v ** 2 + this.a2_v ** 2);
                if (v > this.maxVelocity) this.maxVelocity = v;

                // Calculate positions
                const x1 = originX + this.offset + this.l1 * Math.sin(this.a1);
                const y1 = originY + this.l1 * Math.cos(this.a1);
                const x2 = x1 + this.l2 * Math.sin(this.a2);
                const y2 = y1 + this.l2 * Math.cos(this.a2);

                // Add to trail
                this.trail.push({ x: x2, y: y2 });
                if (this.trail.length > 1000) this.trail.shift();

                return { x1, y1, x2, y2 };
            }

            getEnergy() {
                const y1 = -this.l1 * Math.cos(this.a1);
                const y2 = y1 - this.l2 * Math.cos(this.a2);
                const v1 = this.l1 * this.a1_v;
                const v2x = this.l1 * this.a1_v * Math.cos(this.a1) + this.l2 * this.a2_v * Math.cos(this.a2);
                const v2y = this.l1 * this.a1_v * Math.sin(this.a1) + this.l2 * this.a2_v * Math.sin(this.a2);
                const v2 = Math.sqrt(v2x ** 2 + v2y ** 2);

                const KE = 0.5 * this.m1 * v1 ** 2 + 0.5 * this.m2 * v2 ** 2;
                const PE = this.m1 * this.g * y1 + this.m2 * this.g * y2;

                return KE + PE;
            }

            draw(pos) {
                const ox = originX + this.offset;

                // Trail
                if (showTrail && this.trail.length > 1) {
                    ctx.beginPath();
                    ctx.moveTo(this.trail[0].x, this.trail[0].y);
                    for (let i = 1; i < this.trail.length; i++) {
                        ctx.lineTo(this.trail[i].x, this.trail[i].y);
                    }
                    ctx.strokeStyle = this.color + '80';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }

                // Rods
                ctx.beginPath();
                ctx.moveTo(ox, originY);
                ctx.lineTo(pos.x1, pos.y1);
                ctx.lineTo(pos.x2, pos.y2);
                ctx.strokeStyle = this.color;
                ctx.lineWidth = 3;
                ctx.stroke();

                // Pivot
                ctx.beginPath();
                ctx.arc(ox, originY, 8, 0, Math.PI * 2);
                ctx.fillStyle = '#444';
                ctx.fill();

                // Mass 1
                ctx.beginPath();
                ctx.arc(pos.x1, pos.y1, 15, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();

                // Mass 2
                ctx.beginPath();
                ctx.arc(pos.x2, pos.y2, 15, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
            }
        }

        let pendulums = [];
        let time = 0;
        let params = {
            angle1: 90,
            angle2: 90,
            length1: 150,
            length2: 150,
            gravity: 1
        };

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            originX = width / 2;
            originY = height / 3;
        }

        function reset() {
            pendulums = [
                new DoublePendulum(params.angle1, params.angle2, params.length1, params.length2, '#8A9A5B')
            ];
            pendulums[0].g = params.gravity;
            time = 0;
        }

        function addSecond() {
            // Add pendulum with tiny angle difference to show chaos
            const p = new DoublePendulum(
                params.angle1 + 0.1,
                params.angle2,
                params.length1,
                params.length2,
                '#BC6C25',
                0
            );
            p.g = params.gravity;
            pendulums.push(p);
        }

        function toggleTrail() {
            showTrail = !showTrail;
        }

        function updateStats() {
            if (pendulums.length === 0) return;
            const p = pendulums[0];
            document.getElementById('time').textContent = time.toFixed(1);
            document.getElementById('revolutions').textContent = p.revolutions2;
            document.getElementById('maxVel').textContent = p.maxVelocity.toFixed(2);
            document.getElementById('energy').textContent = p.getEnergy().toFixed(1);
        }

        function checkChallenges() {
            if (pendulums.length === 0) return;
            const p = pendulums[0];

            // Challenge 1: Outer pendulum full revolution
            if (!completedChallenges.has('ch1') && p.revolutions2 >= 1) {
                completedChallenges.add('ch1');
                markComplete('ch1', 45);
            }

            // Challenge 2: Both pendulums do 360
            if (!completedChallenges.has('ch2')) {
                let innerRev = Math.floor(Math.abs(p.a1) / (2 * Math.PI));
                if (innerRev >= 1 && p.revolutions2 >= 1) {
                    completedChallenges.add('ch2');
                    markComplete('ch2', 75);
                }
            }

            // Challenge 3: Chaos divergence (show two pendulums diverging)
            if (!completedChallenges.has('ch3') && pendulums.length >= 2) {
                const p1 = pendulums[0];
                const p2 = pendulums[1];
                const angleDiff = Math.abs(p1.a2 - p2.a2);
                if (angleDiff > Math.PI / 2 && time > 5) {
                    completedChallenges.add('ch3');
                    markComplete('ch3', 100);
                }
            }
        }

        function markComplete(id, xp) {
            const el = document.getElementById(id);
            el.className = 'challenge-item completed';
            el.textContent = '‚úÖ ' + el.textContent.substring(2);
            showNotification(xp);

            try {
                const data = JSON.parse(localStorage.getItem('ccab-challenges')) || { completed: [], xp: 0 };
                if (!data.completed.includes('pendulum-' + id)) {
                    data.completed.push('pendulum-' + id);
                    data.xp += xp;
                    localStorage.setItem('ccab-challenges', JSON.stringify(data));
                }
            } catch (e) {}
        }

        function showNotification(xp) {
            const notification = document.createElement('div');
            notification.innerHTML = `<div style="font-size: 2rem;">üèÜ</div><div>Challenge Complete!</div><div>+${xp} XP</div>`;
            notification.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #606C38, #8A9A5B); color: white;
                padding: 2rem 3rem; border-radius: 20px; text-align: center; z-index: 10000;
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 2500);
        }

        function animate() {
            ctx.fillStyle = 'rgba(26, 26, 46, 0.1)';
            ctx.fillRect(0, 0, width, height);

            time += 0.016;

            for (let p of pendulums) {
                const pos = p.update();
                p.draw(pos);
            }

            updateStats();
            checkChallenges();

            requestAnimationFrame(animate);
        }

        // Control bindings
        document.getElementById('angle1').oninput = (e) => {
            params.angle1 = parseInt(e.target.value);
            document.getElementById('a1Val').textContent = params.angle1;
        };
        document.getElementById('angle2').oninput = (e) => {
            params.angle2 = parseInt(e.target.value);
            document.getElementById('a2Val').textContent = params.angle2;
        };
        document.getElementById('length1').oninput = (e) => {
            params.length1 = parseInt(e.target.value);
            document.getElementById('l1Val').textContent = params.length1;
        };
        document.getElementById('length2').oninput = (e) => {
            params.length2 = parseInt(e.target.value);
            document.getElementById('l2Val').textContent = params.length2;
        };
        document.getElementById('gravity').oninput = (e) => {
            params.gravity = parseFloat(e.target.value);
            document.getElementById('gVal').textContent = params.gravity.toFixed(1);
        };

        window.addEventListener('resize', resize);
        resize();
        reset();
        animate();
    </script>
</body>
</html>
