<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voronoi Challenge - CCAB</title>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&family=Nunito:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3-delaunay.v6.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Nunito', sans-serif;
            background: #1a1a2e;
            color: white;
            overflow: hidden;
        }
        canvas {
            display: block;
            position: fixed;
            top: 0;
            left: 0;
        }
        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            color: #8A9A5B;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            background: rgba(0,0,0,0.7);
            border-radius: 20px;
        }
        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 15px;
            z-index: 100;
            width: 280px;
        }
        .controls h3 {
            font-family: 'Lora', serif;
            color: #8A9A5B;
            margin-bottom: 15px;
        }
        .info-box {
            background: rgba(138, 154, 91, 0.2);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 0.85rem;
        }
        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .btn {
            background: linear-gradient(135deg, #606C38, #8A9A5B);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            flex: 1;
            min-width: 80px;
        }
        .btn:hover { transform: scale(1.02); }
        .btn.secondary {
            background: linear-gradient(135deg, #BC6C25, #DDA15E);
        }
        .checkbox-group {
            margin: 10px 0;
        }
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #ccc;
            cursor: pointer;
            margin-bottom: 5px;
        }
        .checkbox-group input {
            accent-color: #8A9A5B;
        }
        .stats {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #444;
        }
        .stats div {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.85rem;
        }
        .stats .label { color: #888; }
        .stats .value { color: #8A9A5B; font-weight: bold; }
        .challenge-status {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #444;
        }
        .challenge-item {
            margin-bottom: 8px;
            font-size: 0.8rem;
        }
        .challenge-item.completed { color: #4CAF50; }
        .challenge-item.pending { color: #888; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Challenges</a>

    <canvas id="canvas"></canvas>

    <div class="controls">
        <h3>‚óá Voronoi Diagram</h3>

        <div class="info-box">
            Click to add points. Each region contains all points closest to its seed.
        </div>

        <div class="btn-group">
            <button class="btn" onclick="addRandomPoints(10)">Add 10</button>
            <button class="btn" onclick="addRandomPoints(50)">Add 50</button>
            <button class="btn secondary" onclick="clearPoints()">Clear</button>
        </div>

        <div class="btn-group">
            <button class="btn" onclick="relaxStep()">Relax (Lloyd)</button>
            <button class="btn" id="autoRelaxBtn" onclick="toggleAutoRelax()">Auto Relax</button>
        </div>

        <div class="checkbox-group">
            <label><input type="checkbox" id="showVoronoi" checked onchange="draw()"> Voronoi Cells</label>
            <label><input type="checkbox" id="showDelaunay" onchange="draw()"> Delaunay Triangulation</label>
            <label><input type="checkbox" id="showPoints" checked onchange="draw()"> Seed Points</label>
            <label><input type="checkbox" id="colorCells" checked onchange="draw()"> Color Cells</label>
        </div>

        <div class="stats">
            <div><span class="label">Points:</span> <span class="value" id="pointCount">0</span></div>
            <div><span class="label">Relaxation Steps:</span> <span class="value" id="relaxSteps">0</span></div>
            <div><span class="label">Cell Uniformity:</span> <span class="value" id="uniformity">0%</span></div>
        </div>

        <div class="challenge-status">
            <div class="challenge-item pending" id="ch1">‚≠ï Create 100 points</div>
            <div class="challenge-item pending" id="ch2">‚≠ï Apply Lloyd relaxation 20x</div>
            <div class="challenge-item pending" id="ch3">‚≠ï Achieve 90% uniformity</div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let width, height;
        let points = [];
        let voronoi = null;
        let delaunay = null;
        let relaxSteps = 0;
        let autoRelax = false;
        let completedChallenges = new Set();

        // Expose for challenge system
        window.voronoiPoints = () => points.length;

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            updateVoronoi();
            draw();
        }

        function updateVoronoi() {
            if (points.length < 3) {
                voronoi = null;
                delaunay = null;
                return;
            }

            try {
                delaunay = d3.Delaunay.from(points);
                voronoi = delaunay.voronoi([0, 0, width, height]);
            } catch (e) {
                voronoi = null;
                delaunay = null;
            }
        }

        function addPoint(x, y) {
            points.push([x, y]);
            updateVoronoi();
            draw();
            updateStats();
            checkChallenges();
        }

        function addRandomPoints(n) {
            for (let i = 0; i < n; i++) {
                points.push([
                    Math.random() * width,
                    Math.random() * height
                ]);
            }
            updateVoronoi();
            draw();
            updateStats();
            checkChallenges();
        }

        function clearPoints() {
            points = [];
            relaxSteps = 0;
            updateVoronoi();
            draw();
            updateStats();
        }

        function relaxStep() {
            if (!voronoi || points.length < 3) return;

            // Lloyd relaxation: move each point to its cell's centroid
            const newPoints = [];
            for (let i = 0; i < points.length; i++) {
                const cell = voronoi.cellPolygon(i);
                if (cell) {
                    const centroid = getCentroid(cell);
                    newPoints.push(centroid);
                } else {
                    newPoints.push(points[i]);
                }
            }

            points = newPoints;
            relaxSteps++;
            updateVoronoi();
            draw();
            updateStats();
            checkChallenges();
        }

        function getCentroid(polygon) {
            let cx = 0, cy = 0, area = 0;

            for (let i = 0; i < polygon.length - 1; i++) {
                const x0 = polygon[i][0];
                const y0 = polygon[i][1];
                const x1 = polygon[i + 1][0];
                const y1 = polygon[i + 1][1];

                const a = x0 * y1 - x1 * y0;
                area += a;
                cx += (x0 + x1) * a;
                cy += (y0 + y1) * a;
            }

            area *= 0.5;
            if (Math.abs(area) < 0.001) {
                return [polygon[0][0], polygon[0][1]];
            }

            cx /= (6 * area);
            cy /= (6 * area);

            return [cx, cy];
        }

        function getPolygonArea(polygon) {
            let area = 0;
            for (let i = 0; i < polygon.length - 1; i++) {
                area += polygon[i][0] * polygon[i + 1][1];
                area -= polygon[i + 1][0] * polygon[i][1];
            }
            return Math.abs(area / 2);
        }

        function calculateUniformity() {
            if (!voronoi || points.length < 3) return 0;

            const areas = [];
            for (let i = 0; i < points.length; i++) {
                const cell = voronoi.cellPolygon(i);
                if (cell) {
                    areas.push(getPolygonArea(cell));
                }
            }

            if (areas.length === 0) return 0;

            const avgArea = areas.reduce((a, b) => a + b, 0) / areas.length;
            const variance = areas.reduce((sum, a) => sum + Math.pow(a - avgArea, 2), 0) / areas.length;
            const stdDev = Math.sqrt(variance);
            const cv = stdDev / avgArea; // Coefficient of variation

            // Convert to uniformity percentage (lower CV = more uniform)
            const uniformity = Math.max(0, 100 - cv * 100);
            return uniformity;
        }

        function toggleAutoRelax() {
            autoRelax = !autoRelax;
            document.getElementById('autoRelaxBtn').classList.toggle('secondary', autoRelax);
            document.getElementById('autoRelaxBtn').textContent = autoRelax ? 'Stop Relax' : 'Auto Relax';
        }

        function draw() {
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, width, height);

            const showVoronoi = document.getElementById('showVoronoi').checked;
            const showDelaunay = document.getElementById('showDelaunay').checked;
            const showPoints = document.getElementById('showPoints').checked;
            const colorCells = document.getElementById('colorCells').checked;

            if (voronoi && showVoronoi) {
                // Draw cells
                for (let i = 0; i < points.length; i++) {
                    const cell = voronoi.cellPolygon(i);
                    if (!cell) continue;

                    ctx.beginPath();
                    ctx.moveTo(cell[0][0], cell[0][1]);
                    for (let j = 1; j < cell.length; j++) {
                        ctx.lineTo(cell[j][0], cell[j][1]);
                    }
                    ctx.closePath();

                    if (colorCells) {
                        const hue = (i * 137.5) % 360;
                        ctx.fillStyle = `hsla(${hue}, 60%, 40%, 0.5)`;
                        ctx.fill();
                    }

                    ctx.strokeStyle = '#8A9A5B';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                }
            }

            if (delaunay && showDelaunay) {
                // Draw Delaunay triangulation
                ctx.strokeStyle = 'rgba(188, 108, 37, 0.5)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                delaunay.render(ctx);
                ctx.stroke();
            }

            if (showPoints) {
                // Draw seed points
                for (let i = 0; i < points.length; i++) {
                    ctx.beginPath();
                    ctx.arc(points[i][0], points[i][1], 4, 0, Math.PI * 2);
                    ctx.fillStyle = '#fff';
                    ctx.fill();
                }
            }
        }

        function updateStats() {
            document.getElementById('pointCount').textContent = points.length;
            document.getElementById('relaxSteps').textContent = relaxSteps;
            document.getElementById('uniformity').textContent = calculateUniformity().toFixed(1) + '%';
        }

        function checkChallenges() {
            // Challenge 1: 100 points
            if (!completedChallenges.has('ch1') && points.length >= 100) {
                completedChallenges.add('ch1');
                markComplete('ch1', 25);
            }

            // Challenge 2: 20 relaxation steps
            if (!completedChallenges.has('ch2') && relaxSteps >= 20) {
                completedChallenges.add('ch2');
                markComplete('ch2', 40);
            }

            // Challenge 3: 90% uniformity
            if (!completedChallenges.has('ch3') && calculateUniformity() >= 90) {
                completedChallenges.add('ch3');
                markComplete('ch3', 60);
            }
        }

        function markComplete(id, xp) {
            const el = document.getElementById(id);
            el.className = 'challenge-item completed';
            el.textContent = '‚úÖ ' + el.textContent.substring(2);
            showNotification(xp);

            try {
                const data = JSON.parse(localStorage.getItem('ccab-challenges')) || { completed: [], xp: 0 };
                if (!data.completed.includes('voronoi-' + id)) {
                    data.completed.push('voronoi-' + id);
                    data.xp += xp;
                    localStorage.setItem('ccab-challenges', JSON.stringify(data));
                }
            } catch (e) {}
        }

        function showNotification(xp) {
            const notification = document.createElement('div');
            notification.innerHTML = `<div style="font-size: 2rem;">üèÜ</div><div>Challenge Complete!</div><div>+${xp} XP</div>`;
            notification.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #606C38, #8A9A5B); color: white;
                padding: 2rem 3rem; border-radius: 20px; text-align: center; z-index: 10000;
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 2500);
        }

        function animate() {
            if (autoRelax && points.length >= 3) {
                relaxStep();
            }
            requestAnimationFrame(animate);
        }

        canvas.addEventListener('click', (e) => {
            addPoint(e.clientX, e.clientY);
        });

        window.addEventListener('resize', resize);
        resize();
        animate();
    </script>
</body>
</html>
