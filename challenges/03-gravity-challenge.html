<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orbital Mechanics Challenge - CCAB</title>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&family=Nunito:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Nunito', sans-serif;
            background: #0a0a1a;
            color: white;
            overflow: hidden;
        }
        canvas {
            display: block;
            position: fixed;
            top: 0;
            left: 0;
        }
        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            color: #8A9A5B;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            background: rgba(0,0,0,0.7);
            border-radius: 20px;
            transition: all 0.3s;
        }
        .back-link:hover {
            background: rgba(138, 154, 91, 0.3);
        }
        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 15px;
            z-index: 100;
            width: 300px;
        }
        .controls h3 {
            font-family: 'Lora', serif;
            color: #8A9A5B;
            margin-bottom: 15px;
        }
        .control-group {
            margin-bottom: 12px;
        }
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #ccc;
        }
        .control-group input[type="range"] {
            width: 100%;
            accent-color: #BC6C25;
        }
        .btn {
            background: linear-gradient(135deg, #606C38, #8A9A5B);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            margin: 5px 3px;
            transition: transform 0.2s;
        }
        .btn:hover { transform: scale(1.02); }
        .btn.secondary {
            background: linear-gradient(135deg, #BC6C25, #DDA15E);
        }
        .instructions {
            background: rgba(138, 154, 91, 0.2);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 0.85rem;
            line-height: 1.5;
        }
        .stats {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #444;
        }
        .stats div {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.85rem;
        }
        .stats .label { color: #888; }
        .stats .value { color: #8A9A5B; font-weight: bold; }
        .challenge-status {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #444;
        }
        .challenge-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 0.8rem;
        }
        .challenge-item.completed { color: #4CAF50; }
        .challenge-item.pending { color: #888; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Challenges</a>

    <canvas id="canvas"></canvas>

    <div class="controls">
        <h3>üåç Orbital Mechanics</h3>

        <div class="instructions">
            <strong>Drag</strong> from the planet to launch a satellite.<br>
            Drag length = velocity, direction = launch angle.
        </div>

        <div class="control-group">
            <label>Planet Mass</label>
            <input type="range" id="mass" min="1000" max="50000" value="20000">
        </div>

        <div class="control-group">
            <label>Time Scale</label>
            <input type="range" id="timeScale" min="0.1" max="3" step="0.1" value="1">
        </div>

        <div>
            <button class="btn" onclick="reset()">Reset</button>
            <button class="btn" onclick="addMoon()">Add Moon</button>
            <button class="btn secondary" onclick="clearSatellites()">Clear</button>
        </div>

        <div class="stats">
            <div><span class="label">Satellites:</span> <span class="value" id="satCount">0</span></div>
            <div><span class="label">Stable Orbits:</span> <span class="value" id="stableCount">0</span></div>
            <div><span class="label">Completed Orbits:</span> <span class="value" id="orbitCount">0</span></div>
            <div><span class="label">Time:</span> <span class="value" id="time">0</span>s</div>
        </div>

        <div class="challenge-status">
            <div class="challenge-item pending" id="ch1">‚≠ï Achieve circular orbit</div>
            <div class="challenge-item pending" id="ch2">‚≠ï Complete 5 full orbits</div>
            <div class="challenge-item pending" id="ch3">‚≠ï Create elliptical orbit (e > 0.5)</div>
            <div class="challenge-item pending" id="ch4">‚≠ï 3 stable satellites at once</div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let width, height;
        let planet = { x: 0, y: 0, mass: 20000, radius: 40 };
        let satellites = [];
        let trails = [];
        let isDragging = false;
        let dragStart = null;
        let dragEnd = null;
        let timeScale = 1;
        let totalTime = 0;
        let completedChallenges = new Set();

        const G = 1;

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            planet.x = width / 2;
            planet.y = height / 2;
        }

        class Satellite {
            constructor(x, y, vx, vy) {
                this.x = x;
                this.y = y;
                this.vx = vx;
                this.vy = vy;
                this.trail = [];
                this.orbits = 0;
                this.lastAngle = null;
                this.totalAngle = 0;
                this.initialDist = Math.sqrt((x - planet.x) ** 2 + (y - planet.y) ** 2);
                this.periapsis = this.initialDist;
                this.apoapsis = this.initialDist;
                this.alive = true;
                this.hue = Math.random() * 360;
                this.orbitStartTime = totalTime;
            }

            update(dt) {
                if (!this.alive) return;

                const dx = planet.x - this.x;
                const dy = planet.y - this.y;
                const dist = Math.sqrt(dx * dx + dy * dy);

                // Collision with planet
                if (dist < planet.radius) {
                    this.alive = false;
                    return;
                }

                // Escape (too far)
                if (dist > Math.max(width, height)) {
                    this.alive = false;
                    return;
                }

                // Gravity
                const force = (G * planet.mass) / (dist * dist);
                const ax = (dx / dist) * force;
                const ay = (dy / dist) * force;

                this.vx += ax * dt;
                this.vy += ay * dt;
                this.x += this.vx * dt;
                this.y += this.vy * dt;

                // Track orbital parameters
                this.periapsis = Math.min(this.periapsis, dist);
                this.apoapsis = Math.max(this.apoapsis, dist);

                // Track orbits
                const angle = Math.atan2(this.y - planet.y, this.x - planet.x);
                if (this.lastAngle !== null) {
                    let da = angle - this.lastAngle;
                    if (da > Math.PI) da -= 2 * Math.PI;
                    if (da < -Math.PI) da += 2 * Math.PI;
                    this.totalAngle += da;
                    this.orbits = Math.floor(Math.abs(this.totalAngle) / (2 * Math.PI));
                }
                this.lastAngle = angle;

                // Trail
                this.trail.push({ x: this.x, y: this.y });
                if (this.trail.length > 500) this.trail.shift();
            }

            getEccentricity() {
                if (this.apoapsis + this.periapsis === 0) return 0;
                return (this.apoapsis - this.periapsis) / (this.apoapsis + this.periapsis);
            }

            isStable() {
                // Stable if survived for a while and completed at least 0.5 orbits
                return this.alive && this.orbits >= 0.5 && (totalTime - this.orbitStartTime) > 5;
            }

            isCircular() {
                return this.getEccentricity() < 0.15 && this.orbits >= 1;
            }

            draw() {
                if (!this.alive) return;

                // Trail
                if (this.trail.length > 1) {
                    ctx.beginPath();
                    ctx.moveTo(this.trail[0].x, this.trail[0].y);
                    for (let i = 1; i < this.trail.length; i++) {
                        ctx.lineTo(this.trail[i].x, this.trail[i].y);
                    }
                    ctx.strokeStyle = `hsla(${this.hue}, 70%, 60%, 0.5)`;
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }

                // Satellite
                ctx.beginPath();
                ctx.arc(this.x, this.y, 6, 0, Math.PI * 2);
                ctx.fillStyle = `hsl(${this.hue}, 70%, 60%)`;
                ctx.fill();
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 1;
                ctx.stroke();
            }
        }

        function addMoon() {
            // Add a pre-configured stable moon
            const dist = 150;
            const speed = Math.sqrt(G * planet.mass / dist);
            satellites.push(new Satellite(
                planet.x + dist,
                planet.y,
                0,
                speed
            ));
        }

        function reset() {
            satellites = [];
            totalTime = 0;
        }

        function clearSatellites() {
            satellites = [];
        }

        function updateStats() {
            const alive = satellites.filter(s => s.alive);
            const stable = alive.filter(s => s.isStable());
            const totalOrbits = alive.reduce((s, sat) => s + sat.orbits, 0);

            document.getElementById('satCount').textContent = alive.length;
            document.getElementById('stableCount').textContent = stable.length;
            document.getElementById('orbitCount').textContent = totalOrbits;
            document.getElementById('time').textContent = totalTime.toFixed(1);
        }

        function checkChallenges() {
            const alive = satellites.filter(s => s.alive);
            const stable = alive.filter(s => s.isStable());

            // Challenge 1: Circular orbit
            if (!completedChallenges.has('ch1')) {
                if (alive.some(s => s.isCircular())) {
                    completedChallenges.add('ch1');
                    markComplete('ch1', 30);
                }
            }

            // Challenge 2: 5 full orbits
            if (!completedChallenges.has('ch2')) {
                if (alive.some(s => s.orbits >= 5)) {
                    completedChallenges.add('ch2');
                    markComplete('ch2', 40);
                }
            }

            // Challenge 3: Elliptical orbit with e > 0.5
            if (!completedChallenges.has('ch3')) {
                if (alive.some(s => s.getEccentricity() > 0.5 && s.orbits >= 1)) {
                    completedChallenges.add('ch3');
                    markComplete('ch3', 50);
                }
            }

            // Challenge 4: 3 stable satellites
            if (!completedChallenges.has('ch4')) {
                if (stable.length >= 3) {
                    completedChallenges.add('ch4');
                    markComplete('ch4', 75);
                }
            }
        }

        function markComplete(id, xp) {
            const el = document.getElementById(id);
            el.className = 'challenge-item completed';
            el.textContent = '‚úÖ ' + el.textContent.substring(2);
            showNotification(xp);

            try {
                const data = JSON.parse(localStorage.getItem('ccab-challenges')) || { completed: [], xp: 0 };
                if (!data.completed.includes('gravity-' + id)) {
                    data.completed.push('gravity-' + id);
                    data.xp += xp;
                    localStorage.setItem('ccab-challenges', JSON.stringify(data));
                }
            } catch (e) {}
        }

        function showNotification(xp) {
            const notification = document.createElement('div');
            notification.innerHTML = `<div style="font-size: 2rem;">üèÜ</div><div>Challenge Complete!</div><div>+${xp} XP</div>`;
            notification.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #606C38, #8A9A5B); color: white;
                padding: 2rem 3rem; border-radius: 20px; text-align: center; z-index: 10000;
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 2500);
        }

        function drawPlanet() {
            // Glow
            const gradient = ctx.createRadialGradient(planet.x, planet.y, planet.radius, planet.x, planet.y, planet.radius * 3);
            gradient.addColorStop(0, 'rgba(100, 150, 255, 0.3)');
            gradient.addColorStop(1, 'rgba(100, 150, 255, 0)');
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(planet.x, planet.y, planet.radius * 3, 0, Math.PI * 2);
            ctx.fill();

            // Planet
            const planetGrad = ctx.createRadialGradient(
                planet.x - planet.radius * 0.3, planet.y - planet.radius * 0.3,
                0, planet.x, planet.y, planet.radius
            );
            planetGrad.addColorStop(0, '#6699ff');
            planetGrad.addColorStop(1, '#3355aa');
            ctx.fillStyle = planetGrad;
            ctx.beginPath();
            ctx.arc(planet.x, planet.y, planet.radius, 0, Math.PI * 2);
            ctx.fill();
        }

        function animate() {
            ctx.fillStyle = 'rgba(10, 10, 26, 0.3)';
            ctx.fillRect(0, 0, width, height);

            // Stars
            if (Math.random() < 0.02) {
                ctx.fillStyle = `rgba(255, 255, 255, ${Math.random() * 0.5 + 0.5})`;
                ctx.beginPath();
                ctx.arc(Math.random() * width, Math.random() * height, Math.random() * 1.5, 0, Math.PI * 2);
                ctx.fill();
            }

            const dt = 0.16 * timeScale;
            totalTime += dt * 0.1;

            for (let sat of satellites) {
                sat.update(dt);
                sat.draw();
            }

            // Remove dead satellites
            satellites = satellites.filter(s => s.alive);

            drawPlanet();

            // Draw launch preview
            if (isDragging && dragStart && dragEnd) {
                ctx.beginPath();
                ctx.moveTo(dragStart.x, dragStart.y);
                ctx.lineTo(dragEnd.x, dragEnd.y);
                ctx.strokeStyle = '#BC6C25';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.stroke();
                ctx.setLineDash([]);

                // Arrow head
                const angle = Math.atan2(dragEnd.y - dragStart.y, dragEnd.x - dragStart.x);
                ctx.beginPath();
                ctx.moveTo(dragEnd.x, dragEnd.y);
                ctx.lineTo(dragEnd.x - 15 * Math.cos(angle - 0.3), dragEnd.y - 15 * Math.sin(angle - 0.3));
                ctx.lineTo(dragEnd.x - 15 * Math.cos(angle + 0.3), dragEnd.y - 15 * Math.sin(angle + 0.3));
                ctx.closePath();
                ctx.fillStyle = '#BC6C25';
                ctx.fill();
            }

            updateStats();
            checkChallenges();

            requestAnimationFrame(animate);
        }

        // Controls
        document.getElementById('mass').oninput = (e) => {
            planet.mass = parseInt(e.target.value);
        };
        document.getElementById('timeScale').oninput = (e) => {
            timeScale = parseFloat(e.target.value);
        };

        // Mouse events for launching
        canvas.addEventListener('mousedown', (e) => {
            const dist = Math.sqrt((e.clientX - planet.x) ** 2 + (e.clientY - planet.y) ** 2);
            if (dist > planet.radius + 20) {
                isDragging = true;
                dragStart = { x: e.clientX, y: e.clientY };
                dragEnd = { x: e.clientX, y: e.clientY };
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            if (isDragging) {
                dragEnd = { x: e.clientX, y: e.clientY };
            }
        });

        canvas.addEventListener('mouseup', (e) => {
            if (isDragging && dragStart) {
                const dx = dragEnd.x - dragStart.x;
                const dy = dragEnd.y - dragStart.y;
                const speed = Math.sqrt(dx * dx + dy * dy) * 0.05;
                const angle = Math.atan2(dy, dx);

                satellites.push(new Satellite(
                    dragStart.x,
                    dragStart.y,
                    Math.cos(angle) * speed,
                    Math.sin(angle) * speed
                ));
            }
            isDragging = false;
            dragStart = null;
            dragEnd = null;
        });

        window.addEventListener('resize', resize);
        resize();
        animate();
    </script>
</body>
</html>
