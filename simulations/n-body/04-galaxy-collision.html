<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galaxy Collision - N-Body Simulation</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(to bottom, #000000, #0d1b2a);
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            margin: 0 0 10px 0;
            font-size: 2em;
            text-align: center;
            background: linear-gradient(45deg, #1e88e5, #8e24aa, #d81b60);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .description {
            max-width: 900px;
            text-align: center;
            margin-bottom: 20px;
            color: #cccccc;
            line-height: 1.6;
        }

        .container {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(30, 136, 229, 0.3);
        }

        canvas {
            display: block;
            background: radial-gradient(circle at center, #0d1b2a, #000000);
            border-radius: 10px;
            box-shadow: 0 0 50px rgba(30, 136, 229, 0.2) inset;
            cursor: grab;
        }

        canvas:active {
            cursor: grabbing;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
            max-width: 900px;
        }

        .control-group {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(30, 136, 229, 0.3);
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            color: #1e88e5;
            font-weight: 600;
            font-size: 0.9em;
        }

        input[type="range"] {
            width: 100%;
            margin: 5px 0;
        }

        input[type="checkbox"] {
            margin-right: 8px;
        }

        button {
            background: linear-gradient(45deg, #1e88e5, #1565c0);
            border: none;
            color: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: transform 0.2s;
            margin: 5px;
        }

        button:hover {
            transform: scale(1.05);
        }

        button:active {
            transform: scale(0.95);
        }

        button.preset {
            background: linear-gradient(45deg, #8e24aa, #d81b60);
            width: 100%;
            margin: 3px 0;
            padding: 8px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .stat {
            background: rgba(30, 136, 229, 0.1);
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.3em;
            color: #1e88e5;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.8em;
            color: #cccccc;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <h1>ðŸŒŒ Galaxy Collision Simulation</h1>
    <div class="description">
        <p>
            <strong>Galactic Scale N-Body Simulation</strong> - Watch two spiral galaxies collide over billions of years.
            Uses Barnes-Hut algorithm (O(N log N)) to efficiently compute gravitational interactions between hundreds of stars.
            Observe tidal tails, star formation bursts (bright spots), and eventual merger into an elliptical galaxy.
            Each frame represents ~10 million years. Based on observations of Antennae Galaxies and future Milky Way-Andromeda collision.
        </p>
    </div>

    <div class="container">
        <canvas id="canvas" width="900" height="900"></canvas>

        <div class="controls">
            <div class="control-group">
                <label>Stars per Galaxy: <span id="starsValue">100</span></label>
                <input type="range" id="starsPerGalaxy" min="50" max="200" step="10" value="100">

                <label>Approach Speed: <span id="speedValue">0.5</span></label>
                <input type="range" id="approachSpeed" min="0.1" max="2" step="0.1" value="0.5">

                <label>Approach Angle: <span id="angleValue">45</span>Â°</label>
                <input type="range" id="approachAngle" min="0" max="90" step="5" value="45">
            </div>

            <div class="control-group">
                <label>Time Scale: <span id="timeScaleValue">1.0</span>x</label>
                <input type="range" id="timeScale" min="0.1" max="5" step="0.1" value="1">

                <label>Zoom: <span id="zoomValue">1.0</span>x</label>
                <input type="range" id="zoom" min="0.3" max="2" step="0.1" value="1">

                <label><input type="checkbox" id="showTrails"> Show Star Trails</label>
                <label><input type="checkbox" id="showFormation" checked> Star Formation</label>
            </div>

            <div class="control-group">
                <button id="pauseBtn">Pause</button>
                <button id="resetBtn">Reset</button>

                <button class="preset" id="headOn">Head-On Collision</button>
                <button class="preset" id="glancing">Glancing Blow</button>
                <button class="preset" id="merger">Slow Merger</button>
            </div>
        </div>

        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="fps">60</div>
                <div class="stat-label">FPS</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="simTime">0</div>
                <div class="stat-label">Million Years</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="starCount">0</div>
                <div class="stat-label">Total Stars</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="interactions">0</div>
                <div class="stat-label">Interactions/Frame</div>
            </div>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #4da6ff;"></div>
                <span>Young Stars (Blue)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ffd700;"></div>
                <span>Old Stars (Yellow)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ff6b6b;"></div>
                <span>Red Giants</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ffffff;"></div>
                <span>Star Formation (White)</span>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // Physics constants
        const G = 50;
        const SOFTENING = 5;
        const DT = 0.02;
        const THETA = 0.5; // Barnes-Hut opening angle

        // Simulation state
        let bodies = [];
        let paused = false;
        let timeScale = 1.0;
        let zoom = 1.0;
        let offsetX = 0;
        let offsetY = 0;
        let showTrails = false;
        let showFormation = true;
        let starsPerGalaxy = 100;
        let approachSpeed = 0.5;
        let approachAngle = 45;
        let simTime = 0;
        let frameCount = 0;
        let lastFpsUpdate = Date.now();
        let fps = 60;
        let interactionCount = 0;

        // Mouse interaction
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let dragStartOffsetX = 0;
        let dragStartOffsetY = 0;

        class Body {
            constructor(x, y, vx, vy, mass, type) {
                this.x = x;
                this.y = y;
                this.vx = vx;
                this.vy = vy;
                this.mass = mass;
                this.type = type; // 'blue', 'yellow', 'red'
                this.ax = 0;
                this.ay = 0;
                this.trail = [];
                this.brightness = 1;
                this.formationTime = 0;
            }

            get color() {
                if (this.formationTime > 0) {
                    const fade = this.formationTime / 20;
                    return `rgba(255, 255, 255, ${fade})`;
                }

                switch (this.type) {
                    case 'blue': return '#4da6ff';
                    case 'yellow': return '#ffd700';
                    case 'red': return '#ff6b6b';
                    default: return '#ffffff';
                }
            }

            get radius() {
                return this.formationTime > 0 ? 3 : 2;
            }

            addTrailPoint() {
                this.trail.push({ x: this.x, y: this.y });
                if (this.trail.length > 50) {
                    this.trail.shift();
                }
            }

            draw() {
                const screenX = canvas.width / 2 + (this.x + offsetX) * zoom;
                const screenY = canvas.height / 2 + (this.y + offsetY) * zoom;

                // Check if on screen
                if (screenX < -50 || screenX > canvas.width + 50 ||
                    screenY < -50 || screenY > canvas.height + 50) {
                    return;
                }

                // Draw trail
                if (showTrails && this.trail.length > 1) {
                    ctx.strokeStyle = this.color;
                    ctx.lineWidth = 1;
                    ctx.globalAlpha = 0.3;

                    ctx.beginPath();
                    for (let i = 0; i < this.trail.length; i++) {
                        const tx = canvas.width / 2 + (this.trail[i].x + offsetX) * zoom;
                        const ty = canvas.height / 2 + (this.trail[i].y + offsetY) * zoom;

                        if (i === 0) ctx.moveTo(tx, ty);
                        else ctx.lineTo(tx, ty);
                    }
                    ctx.stroke();
                    ctx.globalAlpha = 1;
                }

                // Draw glow
                const r = this.radius * zoom;
                const gradient = ctx.createRadialGradient(screenX, screenY, 0, screenX, screenY, r * 2);
                gradient.addColorStop(0, this.color);
                gradient.addColorStop(0.5, this.color + '88');
                gradient.addColorStop(1, this.color + '00');

                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(screenX, screenY, r * 2, 0, Math.PI * 2);
                ctx.fill();

                // Draw core
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(screenX, screenY, r, 0, Math.PI * 2);
                ctx.fill();

                if (this.formationTime > 0) {
                    this.formationTime--;
                }
            }

            updateVelocityVerlet(dt) {
                const vx_half = this.vx + this.ax * dt / 2;
                const vy_half = this.vy + this.ay * dt / 2;

                this.x += vx_half * dt;
                this.y += vy_half * dt;

                this.vx = vx_half + this.ax * dt / 2;
                this.vy = vy_half + this.ay * dt / 2;
            }
        }

        // Barnes-Hut Quadtree Node
        class QuadNode {
            constructor(x, y, size) {
                this.x = x; // Center x
                this.y = y; // Center y
                this.size = size; // Half-width
                this.mass = 0;
                this.cx = 0; // Center of mass x
                this.cy = 0; // Center of mass y
                this.body = null;
                this.children = null; // [NW, NE, SW, SE]
            }

            isLeaf() {
                return this.children === null;
            }

            subdivide() {
                const half = this.size / 2;
                const quarter = half / 2;

                this.children = [
                    new QuadNode(this.x - quarter, this.y - quarter, quarter), // NW
                    new QuadNode(this.x + quarter, this.y - quarter, quarter), // NE
                    new QuadNode(this.x - quarter, this.y + quarter, quarter), // SW
                    new QuadNode(this.x + quarter, this.y + quarter, quarter)  // SE
                ];
            }

            getQuadrant(body) {
                const west = body.x < this.x;
                const north = body.y < this.y;

                if (north) return west ? 0 : 1;
                else return west ? 2 : 3;
            }

            insert(body) {
                if (this.body === null && this.isLeaf()) {
                    // Empty leaf - place body here
                    this.body = body;
                    this.mass = body.mass;
                    this.cx = body.x;
                    this.cy = body.y;
                } else {
                    // Need to subdivide or add to existing subdivision
                    if (this.isLeaf()) {
                        this.subdivide();

                        // Move existing body to child
                        if (this.body) {
                            const quad = this.getQuadrant(this.body);
                            this.children[quad].insert(this.body);
                            this.body = null;
                        }
                    }

                    // Add new body to appropriate child
                    const quad = this.getQuadrant(body);
                    this.children[quad].insert(body);

                    // Update center of mass
                    const totalMass = this.mass + body.mass;
                    this.cx = (this.cx * this.mass + body.x * body.mass) / totalMass;
                    this.cy = (this.cy * this.mass + body.y * body.mass) / totalMass;
                    this.mass = totalMass;
                }
            }

            computeForce(body) {
                if (this.mass === 0 || (this.body === body)) {
                    return { fx: 0, fy: 0 };
                }

                const dx = this.cx - body.x;
                const dy = this.cy - body.y;
                const r2 = dx * dx + dy * dy + SOFTENING * SOFTENING;
                const r = Math.sqrt(r2);

                // Barnes-Hut criterion: s/d < Î¸
                if (this.isLeaf() || (this.size * 2 / r < THETA)) {
                    // Treat as single body
                    const f = G * this.mass / r2;
                    interactionCount++;
                    return { fx: f * dx / r, fy: f * dy / r };
                } else {
                    // Recurse to children
                    let fx = 0, fy = 0;
                    for (let child of this.children) {
                        const force = child.computeForce(body);
                        fx += force.fx;
                        fy += force.fy;
                    }
                    return { fx, fy };
                }
            }
        }

        function createGalaxy(centerX, centerY, vx, vy, numStars, rotationDir) {
            const galaxy = [];
            const coreRadius = 30;
            const diskRadius = 150;

            for (let i = 0; i < numStars; i++) {
                // Exponential disk profile
                const r = coreRadius + Math.random() ** 2 * diskRadius;
                const theta = Math.random() * Math.PI * 2;

                const x = centerX + r * Math.cos(theta);
                const y = centerY + r * Math.sin(theta);

                // Circular velocity (Keplerian-like)
                const v = Math.sqrt(G * 100 * r / (r * r + coreRadius * coreRadius)) * rotationDir;
                const velX = vx - Math.sin(theta) * v;
                const velY = vy + Math.cos(theta) * v;

                // Star type based on position (younger stars in outer disk)
                let type;
                if (r < diskRadius * 0.3) {
                    type = 'red'; // Old core
                } else if (r < diskRadius * 0.7) {
                    type = 'yellow';
                } else {
                    type = 'blue'; // Young outer disk
                }

                galaxy.push(new Body(x, y, velX, velY, 1, type));
            }

            return galaxy;
        }

        function initGalaxies() {
            bodies = [];
            simTime = 0;
            frameCount = 0;

            const angleRad = approachAngle * Math.PI / 180;
            const separation = 400;

            const vx1 = Math.cos(angleRad) * approachSpeed;
            const vy1 = Math.sin(angleRad) * approachSpeed;

            // Galaxy 1 (approaching from left)
            bodies.push(...createGalaxy(-separation, 0, vx1, vy1, starsPerGalaxy, 1));

            // Galaxy 2 (approaching from right)
            bodies.push(...createGalaxy(separation, 0, -vx1, -vy1, starsPerGalaxy, -1));

            document.getElementById('starCount').textContent = bodies.length;
        }

        function checkStarFormation() {
            if (!showFormation) return;

            // Check for close encounters that trigger star formation
            for (let i = 0; i < bodies.length; i++) {
                for (let j = i + 1; j < bodies.length; j++) {
                    const dx = bodies[j].x - bodies[i].x;
                    const dy = bodies[j].y - bodies[i].y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist < 10 && Math.random() < 0.01) {
                        bodies[i].formationTime = 20;
                        bodies[j].formationTime = 20;
                    }
                }
            }
        }

        function update() {
            if (paused) return;

            const dt = DT * timeScale;
            interactionCount = 0;

            // Build Barnes-Hut tree
            const tree = new QuadNode(0, 0, 600);
            for (let body of bodies) {
                tree.insert(body);
            }

            // Compute accelerations using tree
            for (let body of bodies) {
                const force = tree.computeForce(body);
                body.ax = force.fx;
                body.ay = force.fy;
            }

            // Update positions
            for (let body of bodies) {
                body.updateVelocityVerlet(dt);

                if (frameCount % 5 === 0 && showTrails) {
                    body.addTrailPoint();
                }
            }

            // Check for star formation
            if (frameCount % 10 === 0) {
                checkStarFormation();
            }

            simTime += dt * 10; // Each time unit = 10 million years
        }

        function draw() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw all bodies
            for (let body of bodies) {
                body.draw();
            }

            // Update stats
            frameCount++;
            if (frameCount % 30 === 0) {
                const now = Date.now();
                fps = Math.round(30000 / (now - lastFpsUpdate));
                lastFpsUpdate = now;

                document.getElementById('fps').textContent = fps;
                document.getElementById('simTime').textContent = Math.round(simTime);
                document.getElementById('interactions').textContent = interactionCount;
            }
        }

        function animate() {
            update();
            draw();
            requestAnimationFrame(animate);
        }

        // Mouse interactions
        canvas.addEventListener('mousedown', (e) => {
            isDragging = true;
            dragStartX = e.clientX;
            dragStartY = e.clientY;
            dragStartOffsetX = offsetX;
            dragStartOffsetY = offsetY;
        });

        canvas.addEventListener('mousemove', (e) => {
            if (isDragging) {
                const dx = (e.clientX - dragStartX) / zoom;
                const dy = (e.clientY - dragStartY) / zoom;
                offsetX = dragStartOffsetX + dx;
                offsetY = dragStartOffsetY + dy;
            }
        });

        canvas.addEventListener('mouseup', () => {
            isDragging = false;
        });

        canvas.addEventListener('mouseleave', () => {
            isDragging = false;
        });

        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            zoom = Math.max(0.3, Math.min(2, zoom * delta));
            document.getElementById('zoom').value = zoom;
            document.getElementById('zoomValue').textContent = zoom.toFixed(1);
        });

        // Event listeners
        document.getElementById('starsPerGalaxy').addEventListener('input', (e) => {
            starsPerGalaxy = parseInt(e.target.value);
            document.getElementById('starsValue').textContent = starsPerGalaxy;
        });

        document.getElementById('approachSpeed').addEventListener('input', (e) => {
            approachSpeed = parseFloat(e.target.value);
            document.getElementById('speedValue').textContent = approachSpeed.toFixed(1);
        });

        document.getElementById('approachAngle').addEventListener('input', (e) => {
            approachAngle = parseInt(e.target.value);
            document.getElementById('angleValue').textContent = approachAngle;
        });

        document.getElementById('timeScale').addEventListener('input', (e) => {
            timeScale = parseFloat(e.target.value);
            document.getElementById('timeScaleValue').textContent = timeScale.toFixed(1);
        });

        document.getElementById('zoom').addEventListener('input', (e) => {
            zoom = parseFloat(e.target.value);
            document.getElementById('zoomValue').textContent = zoom.toFixed(1);
        });

        document.getElementById('showTrails').addEventListener('change', (e) => {
            showTrails = e.target.checked;
        });

        document.getElementById('showFormation').addEventListener('change', (e) => {
            showFormation = e.target.checked;
        });

        document.getElementById('pauseBtn').addEventListener('click', () => {
            paused = !paused;
            document.getElementById('pauseBtn').textContent = paused ? 'Resume' : 'Pause';
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            offsetX = 0;
            offsetY = 0;
            initGalaxies();
        });

        // Presets
        document.getElementById('headOn').addEventListener('click', () => {
            approachAngle = 0;
            approachSpeed = 1.5;
            document.getElementById('approachAngle').value = 0;
            document.getElementById('approachSpeed').value = 1.5;
            document.getElementById('angleValue').textContent = '0';
            document.getElementById('speedValue').textContent = '1.5';
            offsetX = 0;
            offsetY = 0;
            initGalaxies();
        });

        document.getElementById('glancing').addEventListener('click', () => {
            approachAngle = 60;
            approachSpeed = 0.8;
            document.getElementById('approachAngle').value = 60;
            document.getElementById('approachSpeed').value = 0.8;
            document.getElementById('angleValue').textContent = '60';
            document.getElementById('speedValue').textContent = '0.8';
            offsetX = 0;
            offsetY = 0;
            initGalaxies();
        });

        document.getElementById('merger').addEventListener('click', () => {
            approachAngle = 20;
            approachSpeed = 0.3;
            document.getElementById('approachAngle').value = 20;
            document.getElementById('approachSpeed').value = 0.3;
            document.getElementById('angleValue').textContent = '20';
            document.getElementById('speedValue').textContent = '0.3';
            offsetX = 0;
            offsetY = 0;
            initGalaxies();
        });

        // Initialize
        initGalaxies();
        animate();
    </script>
</body>
</html>
