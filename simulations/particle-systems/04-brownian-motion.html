<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brownian Motion Demonstration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: rgba(20, 20, 40, 0.8);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            max-width: 1400px;
        }

        h1 {
            text-align: center;
            background: linear-gradient(90deg, #00d2ff 0%, #3a47d5 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .description {
            text-align: center;
            color: #b0b0b0;
            margin-bottom: 20px;
            line-height: 1.6;
            font-size: 0.95em;
        }

        .main-content {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .canvas-container {
            display: flex;
            gap: 10px;
            flex-direction: column;
        }

        canvas {
            border: 2px solid #3a47d5;
            border-radius: 10px;
            background: #000;
        }

        #mainCanvas {
            box-shadow: 0 0 30px rgba(58, 71, 213, 0.4);
        }

        #graphCanvas {
            height: 150px;
            box-shadow: 0 0 20px rgba(58, 71, 213, 0.2);
        }

        .controls {
            background: rgba(30, 30, 50, 0.8);
            padding: 20px;
            border-radius: 10px;
            min-width: 280px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #6dd5fa;
            font-size: 0.9em;
            font-weight: 600;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #333;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00d2ff, #3a47d5);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(58, 71, 213, 0.5);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00d2ff, #3a47d5);
            cursor: pointer;
            border: none;
        }

        .value-display {
            color: #fff;
            font-size: 0.85em;
            text-align: right;
            margin-top: 2px;
        }

        button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00d2ff 0%, #3a47d5 100%);
            color: #fff;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(58, 71, 213, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: #fff;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(240, 147, 251, 0.4);
        }

        .toggle-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .toggle-btn {
            flex: 1;
            padding: 8px;
            font-size: 0.85em;
            background: rgba(100, 100, 100, 0.3);
        }

        .toggle-btn.active {
            background: linear-gradient(135deg, #00d2ff 0%, #3a47d5 100%);
        }

        .stats {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 0.9em;
        }

        .stat-label {
            color: #6dd5fa;
        }

        .stat-value {
            color: #fff;
            font-weight: 600;
        }

        .info-box {
            background: rgba(0, 210, 255, 0.1);
            border-left: 3px solid #00d2ff;
            padding: 12px;
            margin-top: 15px;
            border-radius: 5px;
            font-size: 0.85em;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Brownian Motion Demonstration</h1>
        <p class="description">
            Random motion of particles suspended in a fluid, demonstrating Einstein's theory of diffusion.
            Smaller particles diffuse faster, and mean square displacement grows linearly with time.
        </p>

        <div class="main-content">
            <div class="canvas-container">
                <canvas id="mainCanvas" width="800" height="800"></canvas>
                <canvas id="graphCanvas" width="800" height="150"></canvas>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label for="particleCount">Particle Count</label>
                    <input type="range" id="particleCount" min="50" max="500" step="50" value="200">
                    <div class="value-display"><span id="particleCountValue">200</span></div>
                </div>

                <div class="control-group">
                    <label for="trailLength">Trail Length</label>
                    <input type="range" id="trailLength" min="0" max="200" step="10" value="100">
                    <div class="value-display"><span id="trailLengthValue">100</span></div>
                </div>

                <div class="control-group">
                    <label for="diffusionRate">Diffusion Rate</label>
                    <input type="range" id="diffusionRate" min="0.5" max="5" step="0.5" value="2">
                    <div class="value-display"><span id="diffusionRateValue">2.0</span></div>
                </div>

                <div class="control-group">
                    <label>Display Mode</label>
                    <div class="toggle-group">
                        <button class="toggle-btn active" id="trailsBtn">Trails</button>
                        <button class="toggle-btn" id="heatmapBtn">Heatmap</button>
                    </div>
                </div>

                <button class="btn-primary" id="pauseBtn">Pause</button>
                <button class="btn-secondary" id="resetBtn">Reset</button>

                <div class="stats">
                    <div class="stat-row">
                        <span class="stat-label">Active Particles:</span>
                        <span class="stat-value" id="activeParticles">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Mean Displacement:</span>
                        <span class="stat-value" id="meanDisplacement">0</span> px
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Time Elapsed:</span>
                        <span class="stat-value" id="timeElapsed">0.0</span> s
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Diffusion Coeff:</span>
                        <span class="stat-value" id="diffusionCoeff">--</span>
                    </div>
                </div>

                <div class="info-box">
                    <strong>Einstein's Diffusion:</strong><br>
                    Mean Square Displacement: &lt;rÂ²&gt; = 4Dt<br>
                    Where D is the diffusion coefficient and t is time.
                    The graph shows this linear relationship.
                </div>
            </div>
        </div>
    </div>

    <script>
        const mainCanvas = document.getElementById('mainCanvas');
        const mainCtx = mainCanvas.getContext('2d');
        const graphCanvas = document.getElementById('graphCanvas');
        const graphCtx = graphCanvas.getContext('2d');

        let isPaused = false;
        let particles = [];
        let heatmapData = [];
        let showTrails = true;
        let startTime = Date.now();
        let msdHistory = []; // Mean square displacement history

        // Parameters
        let numParticles = 200;
        let trailLength = 100;
        let diffusionRate = 2;

        class Particle {
            constructor() {
                this.x = mainCanvas.width / 2;
                this.y = mainCanvas.height / 2;
                this.startX = this.x;
                this.startY = this.y;
                this.trail = [];
                this.size = 1 + Math.random() * 3; // Variable sizes
                this.speed = diffusionRate / this.size; // Smaller = faster diffusion
                this.hue = Math.random() * 60 + 180; // Blue-cyan range
                this.age = 0;
            }

            update() {
                // Random walk
                const angle = Math.random() * Math.PI * 2;
                const step = this.speed * (0.5 + Math.random() * 0.5);
                this.x += Math.cos(angle) * step;
                this.y += Math.sin(angle) * step;

                // Wrap around edges
                if (this.x < 0) this.x = mainCanvas.width;
                if (this.x > mainCanvas.width) this.x = 0;
                if (this.y < 0) this.y = mainCanvas.height;
                if (this.y > mainCanvas.height) this.y = 0;

                // Update trail
                this.trail.push({ x: this.x, y: this.y });
                if (this.trail.length > trailLength) {
                    this.trail.shift();
                }

                this.age++;
            }

            getDisplacement() {
                const dx = this.x - this.startX;
                const dy = this.y - this.startY;
                return Math.sqrt(dx * dx + dy * dy);
            }

            draw() {
                if (showTrails && this.trail.length > 1) {
                    // Draw trail
                    mainCtx.strokeStyle = `hsla(${this.hue}, 80%, 60%, 0.3)`;
                    mainCtx.lineWidth = this.size * 0.5;
                    mainCtx.beginPath();
                    mainCtx.moveTo(this.trail[0].x, this.trail[0].y);
                    for (let i = 1; i < this.trail.length; i++) {
                        mainCtx.lineTo(this.trail[i].x, this.trail[i].y);
                    }
                    mainCtx.stroke();
                }

                // Draw particle
                mainCtx.shadowBlur = 10;
                mainCtx.shadowColor = `hsla(${this.hue}, 80%, 60%, 0.8)`;
                mainCtx.fillStyle = `hsl(${this.hue}, 80%, 60%)`;
                mainCtx.beginPath();
                mainCtx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                mainCtx.fill();
            }
        }

        function init() {
            particles = [];
            heatmapData = [];
            startTime = Date.now();
            msdHistory = [];

            // Create grid for heatmap
            const gridSize = 20;
            for (let i = 0; i < mainCanvas.width / gridSize; i++) {
                heatmapData[i] = [];
                for (let j = 0; j < mainCanvas.height / gridSize; j++) {
                    heatmapData[i][j] = 0;
                }
            }

            // Create particles
            for (let i = 0; i < numParticles; i++) {
                particles.push(new Particle());
            }
        }

        function updateHeatmap() {
            // Decay heatmap
            for (let i = 0; i < heatmapData.length; i++) {
                for (let j = 0; j < heatmapData[i].length; j++) {
                    heatmapData[i][j] *= 0.95;
                }
            }

            // Add particles to heatmap
            const gridSize = 20;
            particles.forEach(p => {
                const i = Math.floor(p.x / gridSize);
                const j = Math.floor(p.y / gridSize);
                if (i >= 0 && i < heatmapData.length && j >= 0 && j < heatmapData[0].length) {
                    heatmapData[i][j] += 1;
                }
            });
        }

        function drawHeatmap() {
            const gridSize = 20;
            const maxValue = Math.max(...heatmapData.flat());

            for (let i = 0; i < heatmapData.length; i++) {
                for (let j = 0; j < heatmapData[i].length; j++) {
                    const value = heatmapData[i][j];
                    if (value > 0) {
                        const intensity = value / maxValue;
                        const alpha = intensity * 0.6;
                        const hue = 240 - intensity * 60; // Blue to cyan
                        mainCtx.fillStyle = `hsla(${hue}, 80%, 50%, ${alpha})`;
                        mainCtx.fillRect(i * gridSize, j * gridSize, gridSize, gridSize);
                    }
                }
            }
        }

        function calculateMSD() {
            let sumSquaredDisplacement = 0;
            particles.forEach(p => {
                const displacement = p.getDisplacement();
                sumSquaredDisplacement += displacement * displacement;
            });
            return sumSquaredDisplacement / particles.length;
        }

        function drawGraph() {
            graphCtx.fillStyle = '#000';
            graphCtx.fillRect(0, 0, graphCanvas.width, graphCanvas.height);

            if (msdHistory.length < 2) return;

            // Draw grid
            graphCtx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            graphCtx.lineWidth = 1;
            for (let i = 0; i < 5; i++) {
                const y = (i / 4) * graphCanvas.height;
                graphCtx.beginPath();
                graphCtx.moveTo(0, y);
                graphCtx.lineTo(graphCanvas.width, y);
                graphCtx.stroke();
            }

            // Draw MSD curve
            const maxMSD = Math.max(...msdHistory.map(d => d.msd));
            const maxTime = msdHistory[msdHistory.length - 1].time;

            graphCtx.strokeStyle = '#00d2ff';
            graphCtx.lineWidth = 2;
            graphCtx.beginPath();

            msdHistory.forEach((data, i) => {
                const x = (data.time / maxTime) * graphCanvas.width;
                const y = graphCanvas.height - (data.msd / maxMSD) * graphCanvas.height * 0.9;
                if (i === 0) {
                    graphCtx.moveTo(x, y);
                } else {
                    graphCtx.lineTo(x, y);
                }
            });

            graphCtx.stroke();

            // Labels
            graphCtx.fillStyle = '#6dd5fa';
            graphCtx.font = '12px sans-serif';
            graphCtx.fillText('Mean Square Displacement vs Time', 10, 20);
            graphCtx.fillText(`MSD: ${maxMSD.toFixed(0)}`, 10, graphCanvas.height - 10);
            graphCtx.fillText(`Time: ${maxTime.toFixed(1)}s`, graphCanvas.width - 80, graphCanvas.height - 10);
        }

        function updateStats() {
            const timeElapsed = (Date.now() - startTime) / 1000;
            const msd = calculateMSD();
            const meanDisplacement = Math.sqrt(msd);

            document.getElementById('activeParticles').textContent = particles.length;
            document.getElementById('meanDisplacement').textContent = Math.round(meanDisplacement);
            document.getElementById('timeElapsed').textContent = timeElapsed.toFixed(1);

            // Calculate diffusion coefficient: D = MSD / (4 * t)
            if (timeElapsed > 0.5) {
                const D = msd / (4 * timeElapsed);
                document.getElementById('diffusionCoeff').textContent = D.toFixed(2);
            }

            // Update MSD history
            if (msdHistory.length === 0 || timeElapsed - msdHistory[msdHistory.length - 1].time > 0.1) {
                msdHistory.push({ time: timeElapsed, msd });
                if (msdHistory.length > 200) {
                    msdHistory.shift();
                }
            }
        }

        function animate() {
            if (!isPaused) {
                // Fade out main canvas
                if (showTrails) {
                    mainCtx.fillStyle = 'rgba(0, 0, 0, 0.05)';
                } else {
                    mainCtx.fillStyle = 'rgba(0, 0, 0, 0.1)';
                }
                mainCtx.fillRect(0, 0, mainCanvas.width, mainCanvas.height);

                // Update particles
                particles.forEach(p => p.update());

                // Update heatmap
                if (!showTrails) {
                    updateHeatmap();
                    drawHeatmap();
                }

                // Draw particles
                mainCtx.shadowBlur = 0;
                particles.forEach(p => p.draw());
                mainCtx.shadowBlur = 0;

                // Update stats and graph
                updateStats();
                drawGraph();
            }

            requestAnimationFrame(animate);
        }

        // Event listeners
        document.getElementById('particleCount').addEventListener('input', (e) => {
            numParticles = parseInt(e.target.value);
            document.getElementById('particleCountValue').textContent = numParticles;
        });

        document.getElementById('trailLength').addEventListener('input', (e) => {
            trailLength = parseInt(e.target.value);
            document.getElementById('trailLengthValue').textContent = trailLength;
        });

        document.getElementById('diffusionRate').addEventListener('input', (e) => {
            diffusionRate = parseFloat(e.target.value);
            document.getElementById('diffusionRateValue').textContent = diffusionRate.toFixed(1);
            particles.forEach(p => p.speed = diffusionRate / p.size);
        });

        document.getElementById('trailsBtn').addEventListener('click', () => {
            showTrails = true;
            document.getElementById('trailsBtn').classList.add('active');
            document.getElementById('heatmapBtn').classList.remove('active');
        });

        document.getElementById('heatmapBtn').addEventListener('click', () => {
            showTrails = false;
            document.getElementById('heatmapBtn').classList.remove('active');
            document.getElementById('trailsBtn').classList.add('active');
            document.getElementById('heatmapBtn').classList.add('active');
            document.getElementById('trailsBtn').classList.remove('active');
        });

        document.getElementById('pauseBtn').addEventListener('click', () => {
            isPaused = !isPaused;
            document.getElementById('pauseBtn').textContent = isPaused ? 'Resume' : 'Pause';
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            init();
        });

        // Initialize
        init();
        animate();
    </script>
</body>
</html>