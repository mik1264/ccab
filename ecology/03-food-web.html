<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecosystem Food Web | Ecology</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a2e1a 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            overflow: hidden;
        }
        #canvas { display: block; }
        .controls {
            position: fixed;
            top: 20px; right: 20px;
            background: rgba(0,0,0,0.85);
            padding: 20px; border-radius: 15px;
            min-width: 280px;
            border: 1px solid rgba(100, 200, 100, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }
        h1 { color: #64c896; font-size: 1.3em; margin-bottom: 15px; }
        .control-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; color: #aaa; font-size: 0.9em; }
        input[type="range"], select { width: 100%; }
        select { padding: 8px; border-radius: 5px; background: #333; color: #fff; border: none; }
        .value { float: right; color: #64c896; }
        button {
            width: 100%; padding: 10px; margin: 5px 0;
            border: none; border-radius: 8px;
            background: #64c896; color: #1a2e1a;
            font-weight: bold; cursor: pointer;
        }
        button:hover { background: #88d8b0; }
        .trophic-level {
            padding: 8px; margin: 5px 0;
            border-radius: 8px; font-size: 0.85em;
        }
        .producers { background: rgba(100, 200, 100, 0.2); border-left: 3px solid #64c864; }
        .herbivores { background: rgba(100, 150, 255, 0.2); border-left: 3px solid #6496ff; }
        .carnivores { background: rgba(255, 150, 100, 0.2); border-left: 3px solid #ff9664; }
        .apex { background: rgba(255, 100, 100, 0.2); border-left: 3px solid #ff6464; }
        .info { font-size: 0.8em; color: #666; margin-top: 15px; line-height: 1.5; }
        a.back-link {
            position: fixed; top: 20px; left: 20px;
            color: #64c896; text-decoration: none;
            background: rgba(0,0,0,0.8); padding: 10px 20px;
            border-radius: 25px; font-size: 0.9em;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <a href="index.html" class="back-link">‚Üê Back to Ecology</a>

    <div class="controls">
        <h1>Ecosystem Food Web</h1>
        <p style="font-size:0.85em; color:#888; margin-bottom:15px;">Energy flow through trophic levels</p>

        <div class="control-group">
            <label>Energy Input (Sun): <span class="value" id="sunValue">100</span></label>
            <input type="range" id="sunEnergy" min="20" max="200" value="100">
        </div>

        <div class="control-group">
            <label>Transfer Efficiency: <span class="value" id="effValue">10%</span></label>
            <input type="range" id="efficiency" min="5" max="25" value="10">
        </div>

        <div class="control-group">
            <label>Scenario:</label>
            <select id="scenario">
                <option value="normal">Normal</option>
                <option value="remove_apex">Remove Apex Predator</option>
                <option value="remove_herbivore">Remove Herbivore</option>
                <option value="pollution">Pollution Event</option>
            </select>
        </div>

        <button id="runBtn">Run Simulation</button>
        <button id="resetBtn" style="background:#444;color:#fff">Reset</button>

        <div class="trophic-level apex">
            <strong>Apex Predators</strong> - Eagles, Wolves<br>
            <span id="apexPop">0</span> individuals
        </div>

        <div class="trophic-level carnivores">
            <strong>Carnivores</strong> - Foxes, Snakes<br>
            <span id="carnPop">0</span> individuals
        </div>

        <div class="trophic-level herbivores">
            <strong>Herbivores</strong> - Rabbits, Deer<br>
            <span id="herbPop">0</span> individuals
        </div>

        <div class="trophic-level producers">
            <strong>Producers</strong> - Plants, Algae<br>
            <span id="prodPop">0</span> units
        </div>

        <div class="info">
            <strong>10% Rule:</strong> Only ~10% of energy transfers between trophic levels.<br>
            Click on species to see their connections.
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resize();
        window.onresize = resize;

        // Species data
        const species = [
            // Producers (level 0)
            { name: 'Grass', level: 0, x: 0, y: 0, pop: 1000, color: '#64c864', eats: [] },
            { name: 'Trees', level: 0, x: 0, y: 0, pop: 500, color: '#2d8a2d', eats: [] },
            { name: 'Algae', level: 0, x: 0, y: 0, pop: 800, color: '#88ff88', eats: [] },

            // Herbivores (level 1)
            { name: 'Rabbit', level: 1, x: 0, y: 0, pop: 200, color: '#6496ff', eats: [0, 1] },
            { name: 'Deer', level: 1, x: 0, y: 0, pop: 100, color: '#4477dd', eats: [0, 1] },
            { name: 'Fish', level: 1, x: 0, y: 0, pop: 300, color: '#88aaff', eats: [2] },
            { name: 'Insects', level: 1, x: 0, y: 0, pop: 500, color: '#aaccff', eats: [0, 1] },

            // Carnivores (level 2)
            { name: 'Fox', level: 2, x: 0, y: 0, pop: 40, color: '#ff9664', eats: [3, 6] },
            { name: 'Snake', level: 2, x: 0, y: 0, pop: 60, color: '#cc7744', eats: [3, 6] },
            { name: 'Heron', level: 2, x: 0, y: 0, pop: 30, color: '#ffaa88', eats: [5] },

            // Apex predators (level 3)
            { name: 'Eagle', level: 3, x: 0, y: 0, pop: 10, color: '#ff6464', eats: [3, 7, 8] },
            { name: 'Wolf', level: 3, x: 0, y: 0, pop: 15, color: '#dd4444', eats: [4, 7] }
        ];

        let sunEnergy = 100;
        let efficiency = 0.1;
        let running = false;
        let selectedSpecies = null;
        let scenario = 'normal';
        let time = 0;

        function positionSpecies() {
            const levels = [[], [], [], []];
            species.forEach((s, i) => levels[s.level].push(i));

            const plotWidth = canvas.width - 400;
            const plotHeight = canvas.height - 100;

            levels.forEach((level, l) => {
                const y = 100 + (3 - l) * (plotHeight / 4);
                level.forEach((idx, i) => {
                    species[idx].x = 100 + (i + 0.5) * ((plotWidth - 100) / level.length);
                    species[idx].y = y;
                });
            });
        }

        function update() {
            if (!running) return;

            time += 0.016;

            // Calculate energy available at each level
            const baseEnergy = sunEnergy;

            // Update producer populations
            for (let i = 0; i < 3; i++) {
                const s = species[i];
                const growth = baseEnergy * 0.1 - s.pop * 0.001;
                s.pop = Math.max(10, Math.min(2000, s.pop + growth));
            }

            // Apply scenario effects
            if (scenario === 'remove_apex') {
                species[10].pop = 0;
                species[11].pop = 0;
            } else if (scenario === 'pollution') {
                for (const s of species) {
                    s.pop *= 0.999;
                }
            }

            // Update herbivore populations
            for (let i = 3; i < 7; i++) {
                const s = species[i];
                if (scenario === 'remove_herbivore' && i === 3) {
                    s.pop = 0;
                    continue;
                }

                let foodAvailable = 0;
                for (const prey of s.eats) {
                    foodAvailable += species[prey].pop * efficiency;
                }

                // Predation pressure
                let predation = 0;
                for (let j = 7; j < species.length; j++) {
                    if (species[j].eats.includes(i)) {
                        predation += species[j].pop * 0.5;
                    }
                }

                const growth = foodAvailable * 0.01 - s.pop * 0.005 - predation * 0.01;
                s.pop = Math.max(0, Math.min(1000, s.pop + growth));
            }

            // Update carnivore populations
            for (let i = 7; i < 10; i++) {
                const s = species[i];
                let foodAvailable = 0;
                for (const prey of s.eats) {
                    foodAvailable += species[prey].pop * efficiency;
                }

                // Apex predation pressure
                let predation = 0;
                for (let j = 10; j < species.length; j++) {
                    if (species[j].eats.includes(i)) {
                        predation += species[j].pop * 0.3;
                    }
                }

                const growth = foodAvailable * 0.005 - s.pop * 0.02 - predation * 0.02;
                s.pop = Math.max(0, Math.min(200, s.pop + growth));
            }

            // Update apex predator populations
            for (let i = 10; i < 12; i++) {
                const s = species[i];
                if (scenario === 'remove_apex') continue;

                let foodAvailable = 0;
                for (const prey of s.eats) {
                    foodAvailable += species[prey].pop * efficiency;
                }

                const growth = foodAvailable * 0.002 - s.pop * 0.03;
                s.pop = Math.max(0, Math.min(50, s.pop + growth));
            }

            updateStats();
        }

        function updateStats() {
            let prodTotal = 0, herbTotal = 0, carnTotal = 0, apexTotal = 0;
            for (const s of species) {
                switch (s.level) {
                    case 0: prodTotal += s.pop; break;
                    case 1: herbTotal += s.pop; break;
                    case 2: carnTotal += s.pop; break;
                    case 3: apexTotal += s.pop; break;
                }
            }

            document.getElementById('prodPop').textContent = Math.floor(prodTotal);
            document.getElementById('herbPop').textContent = Math.floor(herbTotal);
            document.getElementById('carnPop').textContent = Math.floor(carnTotal);
            document.getElementById('apexPop').textContent = Math.floor(apexTotal);
        }

        function drawEnergyFlow() {
            // Draw energy flow lines
            for (const s of species) {
                for (const preyIdx of s.eats) {
                    const prey = species[preyIdx];
                    const flow = Math.min(s.pop, prey.pop) * efficiency;
                    const alpha = Math.min(0.8, flow / 50);

                    ctx.beginPath();
                    ctx.strokeStyle = `rgba(255, 215, 0, ${alpha})`;
                    ctx.lineWidth = 1 + flow / 30;

                    // Curved line
                    const midX = (s.x + prey.x) / 2;
                    const midY = (s.y + prey.y) / 2 - 20;
                    ctx.moveTo(prey.x, prey.y);
                    ctx.quadraticCurveTo(midX, midY, s.x, s.y);
                    ctx.stroke();

                    // Energy particles
                    if (running && Math.random() < flow / 100) {
                        const t = (time * 2) % 1;
                        const px = prey.x + (s.x - prey.x) * t;
                        const py = prey.y + (s.y - prey.y) * t - 20 * Math.sin(t * Math.PI);
                        ctx.beginPath();
                        ctx.arc(px, py, 3, 0, Math.PI * 2);
                        ctx.fillStyle = '#ffd700';
                        ctx.fill();
                    }
                }
            }
        }

        function drawSpecies() {
            for (let i = 0; i < species.length; i++) {
                const s = species[i];
                const radius = 15 + Math.sqrt(s.pop) * 0.5;

                // Glow for selected
                if (selectedSpecies === i) {
                    ctx.beginPath();
                    ctx.arc(s.x, s.y, radius + 10, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
                    ctx.fill();
                }

                ctx.beginPath();
                ctx.arc(s.x, s.y, radius, 0, Math.PI * 2);
                ctx.fillStyle = s.color;
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Label
                ctx.fillStyle = '#fff';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(s.name, s.x, s.y + radius + 15);
                ctx.fillText(Math.floor(s.pop), s.x, s.y + 4);
            }
        }

        function drawTrophicLevels() {
            const labels = ['Producers', 'Herbivores', 'Carnivores', 'Apex Predators'];
            const colors = ['#64c864', '#6496ff', '#ff9664', '#ff6464'];

            for (let l = 0; l < 4; l++) {
                const y = 100 + (3 - l) * ((canvas.height - 100) / 4);

                ctx.fillStyle = colors[l] + '22';
                ctx.fillRect(50, y - 40, canvas.width - 400, 80);

                ctx.fillStyle = colors[l];
                ctx.font = 'bold 14px sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText(labels[l], 60, y - 25);
            }
        }

        function drawEnergyPyramid() {
            const px = canvas.width - 350;
            const py = canvas.height - 250;
            const maxWidth = 200;
            const levelHeight = 40;

            ctx.fillStyle = 'rgba(0,0,0,0.5)';
            ctx.fillRect(px - 20, py - 30, 240, 220);

            ctx.fillStyle = '#fff';
            ctx.font = 'bold 14px sans-serif';
            ctx.fillText('Energy Pyramid', px, py - 10);

            const levels = [0, 0, 0, 0];
            for (const s of species) {
                levels[s.level] += s.pop;
            }

            const maxLevel = Math.max(...levels);
            const colors = ['#64c864', '#6496ff', '#ff9664', '#ff6464'];

            for (let l = 0; l < 4; l++) {
                const width = (levels[l] / maxLevel) * maxWidth;
                const x = px + (maxWidth - width) / 2;
                const y = py + (3 - l) * levelHeight + 20;

                ctx.fillStyle = colors[l];
                ctx.fillRect(x, y, width, levelHeight - 5);

                ctx.fillStyle = '#fff';
                ctx.font = '11px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(Math.floor(levels[l]), px + maxWidth / 2, y + 25);
            }
        }

        function drawSunEnergy() {
            // Draw sun
            ctx.beginPath();
            ctx.arc(100, 50, 30, 0, Math.PI * 2);
            ctx.fillStyle = '#ffd700';
            ctx.fill();

            // Rays
            for (let i = 0; i < 8; i++) {
                const angle = (i / 8) * Math.PI * 2;
                ctx.beginPath();
                ctx.moveTo(100 + Math.cos(angle) * 35, 50 + Math.sin(angle) * 35);
                ctx.lineTo(100 + Math.cos(angle) * 50, 50 + Math.sin(angle) * 50);
                ctx.strokeStyle = '#ffd700';
                ctx.lineWidth = 3;
                ctx.stroke();
            }

            ctx.fillStyle = '#fff';
            ctx.font = '14px sans-serif';
            ctx.fillText('Energy: ' + sunEnergy, 70, 95);
        }

        function draw() {
            ctx.fillStyle = '#1a2e1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            positionSpecies();
            update();

            drawSunEnergy();
            drawTrophicLevels();
            drawEnergyFlow();
            drawSpecies();
            drawEnergyPyramid();

            requestAnimationFrame(draw);
        }

        // Event listeners
        document.getElementById('sunEnergy').oninput = (e) => {
            sunEnergy = parseInt(e.target.value);
            document.getElementById('sunValue').textContent = sunEnergy;
        };

        document.getElementById('efficiency').oninput = (e) => {
            efficiency = parseInt(e.target.value) / 100;
            document.getElementById('effValue').textContent = (efficiency * 100).toFixed(0) + '%';
        };

        document.getElementById('scenario').onchange = (e) => {
            scenario = e.target.value;
        };

        document.getElementById('runBtn').onclick = () => {
            running = !running;
            document.getElementById('runBtn').textContent = running ? 'Pause' : 'Run Simulation';
        };

        document.getElementById('resetBtn').onclick = () => {
            // Reset populations
            species[0].pop = 1000;
            species[1].pop = 500;
            species[2].pop = 800;
            species[3].pop = 200;
            species[4].pop = 100;
            species[5].pop = 300;
            species[6].pop = 500;
            species[7].pop = 40;
            species[8].pop = 60;
            species[9].pop = 30;
            species[10].pop = 10;
            species[11].pop = 15;
            scenario = 'normal';
            document.getElementById('scenario').value = 'normal';
            time = 0;
            updateStats();
        };

        canvas.onclick = (e) => {
            const rect = canvas.getBoundingClientRect();
            const mx = e.clientX - rect.left;
            const my = e.clientY - rect.top;

            selectedSpecies = null;
            for (let i = 0; i < species.length; i++) {
                const s = species[i];
                const dx = mx - s.x;
                const dy = my - s.y;
                if (dx * dx + dy * dy < 900) {
                    selectedSpecies = i;
                    break;
                }
            }
        };

        // Initialize
        positionSpecies();
        updateStats();
        draw();
    </script>
</body>
</html>
