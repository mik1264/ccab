<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circle of Fifths | Music Theory</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e2e8f0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        .back-link {
            display: inline-block;
            color: #f59e0b;
            text-decoration: none;
            margin-bottom: 20px;
            padding: 8px 16px;
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 20px;
            transition: all 0.3s;
        }

        .back-link:hover {
            background: rgba(245, 158, 11, 0.1);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: #94a3b8;
            font-size: 1.1rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
        }

        .circle-area {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(245, 158, 11, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #circleCanvas {
            max-width: 100%;
        }

        .info-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .key-display {
            background: rgba(245, 158, 11, 0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .key-display .key-name {
            font-size: 3rem;
            font-weight: bold;
            color: #f59e0b;
        }

        .key-display .key-type {
            color: #94a3b8;
            margin-top: 5px;
        }

        .key-info {
            margin: 20px 0;
        }

        .key-info h3 {
            color: #f59e0b;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .key-info p {
            color: #94a3b8;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .scale-notes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
        }

        .scale-note {
            padding: 8px 15px;
            background: rgba(245, 158, 11, 0.2);
            border-radius: 8px;
            font-weight: 600;
            color: #f59e0b;
        }

        .relationships {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .relationship-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(245, 158, 11, 0.1);
        }

        .relationship-item:last-child {
            border-bottom: none;
        }

        .relationship-item .label {
            color: #94a3b8;
        }

        .relationship-item .value {
            color: #f59e0b;
            font-weight: 600;
            cursor: pointer;
        }

        .relationship-item .value:hover {
            text-decoration: underline;
        }

        .btn {
            width: 100%;
            padding: 15px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: #1a1a2e;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(245, 158, 11, 0.4);
        }

        .legend {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .legend h4 {
            color: #f59e0b;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
            font-size: 0.85rem;
            color: #94a3b8;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .legend-color.major { background: #f59e0b; }
        .legend-color.minor { background: #3b82f6; }

        .accidentals {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
            text-align: center;
        }

        .accidental-group h5 {
            color: #94a3b8;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }

        .accidental-count {
            font-size: 1.5rem;
            font-weight: bold;
            color: #f59e0b;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="index.html" class="back-link">← Back to Music Theory</a>
            <h1>Circle of Fifths</h1>
            <p class="subtitle">Navigate key relationships and understand musical structure</p>
        </header>

        <div class="main-content">
            <div class="circle-area">
                <canvas id="circleCanvas" width="600" height="600"></canvas>
            </div>

            <div class="info-panel">
                <div class="key-display">
                    <div class="key-name" id="keyName">C</div>
                    <div class="key-type" id="keyType">Major</div>
                </div>

                <div class="accidentals">
                    <div class="accidental-group">
                        <h5>Sharps</h5>
                        <div class="accidental-count" id="sharpsCount">0</div>
                    </div>
                    <div class="accidental-group">
                        <h5>Flats</h5>
                        <div class="accidental-count" id="flatsCount">0</div>
                    </div>
                </div>

                <div class="key-info">
                    <h3>Scale Notes</h3>
                    <div class="scale-notes" id="scaleNotes"></div>
                </div>

                <div class="relationships">
                    <div class="relationship-item">
                        <span class="label">Relative Minor</span>
                        <span class="value" id="relativeMinor" onclick="selectKey(this.textContent, 'minor')">Am</span>
                    </div>
                    <div class="relationship-item">
                        <span class="label">Fifth Above (+7 semitones)</span>
                        <span class="value" id="fifthAbove" onclick="selectKey(this.textContent, 'major')">G</span>
                    </div>
                    <div class="relationship-item">
                        <span class="label">Fifth Below (-7 semitones)</span>
                        <span class="value" id="fifthBelow" onclick="selectKey(this.textContent, 'major')">F</span>
                    </div>
                    <div class="relationship-item">
                        <span class="label">Parallel Minor</span>
                        <span class="value" id="parallelMinor" onclick="selectKey(this.textContent, 'minor')">Cm</span>
                    </div>
                </div>

                <button class="btn btn-primary" id="playScaleBtn">▶ Play Scale</button>
                <button class="btn btn-primary" id="playChordBtn">▶ Play I Chord</button>

                <div class="legend">
                    <h4>Legend</h4>
                    <div class="legend-item">
                        <div class="legend-color major"></div>
                        <span>Major Keys (outer ring)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color minor"></div>
                        <span>Minor Keys (inner ring)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let audioContext;
        const canvas = document.getElementById('circleCanvas');
        const ctx = canvas.getContext('2d');

        const majorKeys = ['C', 'G', 'D', 'A', 'E', 'B', 'F#/Gb', 'Db', 'Ab', 'Eb', 'Bb', 'F'];
        const minorKeys = ['Am', 'Em', 'Bm', 'F#m', 'C#m', 'G#m', 'D#m/Ebm', 'Bbm', 'Fm', 'Cm', 'Gm', 'Dm'];
        const sharpsFlats = [0, 1, 2, 3, 4, 5, 6, 5, 4, 3, 2, 1]; // sharps positive, then flats

        const majorScales = {
            'C': ['C', 'D', 'E', 'F', 'G', 'A', 'B'],
            'G': ['G', 'A', 'B', 'C', 'D', 'E', 'F#'],
            'D': ['D', 'E', 'F#', 'G', 'A', 'B', 'C#'],
            'A': ['A', 'B', 'C#', 'D', 'E', 'F#', 'G#'],
            'E': ['E', 'F#', 'G#', 'A', 'B', 'C#', 'D#'],
            'B': ['B', 'C#', 'D#', 'E', 'F#', 'G#', 'A#'],
            'F#/Gb': ['F#', 'G#', 'A#', 'B', 'C#', 'D#', 'E#'],
            'Db': ['Db', 'Eb', 'F', 'Gb', 'Ab', 'Bb', 'C'],
            'Ab': ['Ab', 'Bb', 'C', 'Db', 'Eb', 'F', 'G'],
            'Eb': ['Eb', 'F', 'G', 'Ab', 'Bb', 'C', 'D'],
            'Bb': ['Bb', 'C', 'D', 'Eb', 'F', 'G', 'A'],
            'F': ['F', 'G', 'A', 'Bb', 'C', 'D', 'E']
        };

        let selectedKey = 0;
        let isMinor = false;

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function noteToFreq(note, octave = 4) {
            const notes = {'C': 0, 'C#': 1, 'Db': 1, 'D': 2, 'D#': 3, 'Eb': 3, 'E': 4, 'E#': 5, 'F': 5, 'F#': 6, 'Gb': 6, 'G': 7, 'G#': 8, 'Ab': 8, 'A': 9, 'A#': 10, 'Bb': 10, 'B': 11};
            const baseNote = note.replace('m', '');
            const semitone = notes[baseNote] || 0;
            const midi = (octave + 1) * 12 + semitone;
            return 440 * Math.pow(2, (midi - 69) / 12);
        }

        function playNote(note, duration = 0.4, delay = 0, octave = 4) {
            initAudio();
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();

            osc.type = 'triangle';
            osc.frequency.value = noteToFreq(note, octave);

            gain.gain.setValueAtTime(0, audioContext.currentTime + delay);
            gain.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + delay + 0.02);
            gain.gain.linearRampToValueAtTime(0, audioContext.currentTime + delay + duration);

            osc.connect(gain);
            gain.connect(audioContext.destination);

            osc.start(audioContext.currentTime + delay);
            osc.stop(audioContext.currentTime + delay + duration);
        }

        function drawCircle() {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const outerRadius = 250;
            const innerRadius = 170;
            const textRadius = 210;
            const innerTextRadius = 130;

            ctx.fillStyle = '#0a0a14';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw segments
            for (let i = 0; i < 12; i++) {
                const startAngle = (i * 30 - 105) * Math.PI / 180;
                const endAngle = ((i + 1) * 30 - 105) * Math.PI / 180;

                // Outer ring (Major keys)
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, outerRadius, startAngle, endAngle);
                ctx.closePath();

                if (i === selectedKey && !isMinor) {
                    ctx.fillStyle = 'rgba(245, 158, 11, 0.4)';
                } else {
                    ctx.fillStyle = 'rgba(245, 158, 11, 0.1)';
                }
                ctx.fill();
                ctx.strokeStyle = 'rgba(245, 158, 11, 0.5)';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Inner ring (Minor keys)
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, innerRadius, startAngle, endAngle);
                ctx.closePath();

                if (i === selectedKey && isMinor) {
                    ctx.fillStyle = 'rgba(59, 130, 246, 0.4)';
                } else {
                    ctx.fillStyle = 'rgba(59, 130, 246, 0.1)';
                }
                ctx.fill();
                ctx.strokeStyle = 'rgba(59, 130, 246, 0.5)';
                ctx.stroke();

                // Major key labels
                const angle = (i * 30 - 90) * Math.PI / 180;
                const textX = centerX + Math.cos(angle) * textRadius;
                const textY = centerY + Math.sin(angle) * textRadius;

                ctx.fillStyle = i === selectedKey && !isMinor ? '#f59e0b' : '#e2e8f0';
                ctx.font = i === selectedKey && !isMinor ? 'bold 18px sans-serif' : '16px sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(majorKeys[i], textX, textY);

                // Minor key labels
                const innerTextX = centerX + Math.cos(angle) * innerTextRadius;
                const innerTextY = centerY + Math.sin(angle) * innerTextRadius;

                ctx.fillStyle = i === selectedKey && isMinor ? '#3b82f6' : '#94a3b8';
                ctx.font = i === selectedKey && isMinor ? 'bold 14px sans-serif' : '12px sans-serif';
                ctx.fillText(minorKeys[i], innerTextX, innerTextY);
            }

            // Center circle
            ctx.beginPath();
            ctx.arc(centerX, centerY, 60, 0, Math.PI * 2);
            ctx.fillStyle = '#1a1a2e';
            ctx.fill();
            ctx.strokeStyle = 'rgba(148, 163, 184, 0.3)';
            ctx.stroke();

            ctx.fillStyle = '#94a3b8';
            ctx.font = '12px sans-serif';
            ctx.fillText('Circle of', centerX, centerY - 10);
            ctx.fillText('Fifths', centerX, centerY + 10);
        }

        function updateInfo() {
            const key = isMinor ? minorKeys[selectedKey] : majorKeys[selectedKey];
            const keyName = key.replace('m', '');

            document.getElementById('keyName').textContent = keyName;
            document.getElementById('keyType').textContent = isMinor ? 'Minor' : 'Major';

            // Sharps and flats
            const accidentals = sharpsFlats[selectedKey];
            if (selectedKey <= 6) {
                document.getElementById('sharpsCount').textContent = accidentals;
                document.getElementById('flatsCount').textContent = 0;
            } else {
                document.getElementById('sharpsCount').textContent = 0;
                document.getElementById('flatsCount').textContent = 7 - accidentals;
            }

            // Scale notes
            let scaleNotes;
            if (isMinor) {
                const majorKeyIndex = (selectedKey + 9) % 12;
                const majorScale = majorScales[majorKeys[majorKeyIndex]];
                scaleNotes = [...majorScale.slice(5), ...majorScale.slice(0, 5)];
            } else {
                scaleNotes = majorScales[majorKeys[selectedKey]] || ['?'];
            }

            document.getElementById('scaleNotes').innerHTML = scaleNotes
                .map(note => `<span class="scale-note">${note}</span>`)
                .join('');

            // Relationships
            document.getElementById('relativeMinor').textContent = minorKeys[selectedKey];
            document.getElementById('fifthAbove').textContent = majorKeys[(selectedKey + 1) % 12];
            document.getElementById('fifthBelow').textContent = majorKeys[(selectedKey + 11) % 12];
            document.getElementById('parallelMinor').textContent = majorKeys[selectedKey].replace('/', '') + 'm';
        }

        function selectKey(keyName, type) {
            const cleanKey = keyName.replace('m', '').trim();
            const index = majorKeys.findIndex(k => k.includes(cleanKey) || k === cleanKey);
            if (index >= 0) {
                selectedKey = index;
                isMinor = type === 'minor';
                drawCircle();
                updateInfo();
            }
        }

        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);

            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const dx = x - centerX;
            const dy = y - centerY;
            const distance = Math.sqrt(dx * dx + dy * dy);

            if (distance < 60) return; // Center circle
            if (distance > 260) return; // Outside

            let angle = Math.atan2(dy, dx) * 180 / Math.PI + 90;
            if (angle < 0) angle += 360;

            const segment = Math.floor(angle / 30) % 12;

            selectedKey = segment;
            isMinor = distance < 170;

            drawCircle();
            updateInfo();
        });

        document.getElementById('playScaleBtn').addEventListener('click', () => {
            let scaleNotes;
            if (isMinor) {
                const majorKeyIndex = (selectedKey + 9) % 12;
                const majorScale = majorScales[majorKeys[majorKeyIndex]];
                scaleNotes = [...majorScale.slice(5), ...majorScale.slice(0, 5)];
            } else {
                scaleNotes = majorScales[majorKeys[selectedKey]] || [];
            }

            scaleNotes.forEach((note, i) => {
                playNote(note, 0.4, i * 0.3, 4);
            });
            playNote(scaleNotes[0], 0.6, scaleNotes.length * 0.3, 5);
        });

        document.getElementById('playChordBtn').addEventListener('click', () => {
            let scaleNotes;
            if (isMinor) {
                const majorKeyIndex = (selectedKey + 9) % 12;
                const majorScale = majorScales[majorKeys[majorKeyIndex]];
                scaleNotes = [...majorScale.slice(5), ...majorScale.slice(0, 5)];
            } else {
                scaleNotes = majorScales[majorKeys[selectedKey]] || [];
            }

            if (scaleNotes.length >= 5) {
                playNote(scaleNotes[0], 1, 0, 3);
                playNote(scaleNotes[2], 1, 0, 4);
                playNote(scaleNotes[4], 1, 0, 4);
            }
        });

        window.selectKey = selectKey;

        drawCircle();
        updateInfo();
    </script>
</body>
</html>
