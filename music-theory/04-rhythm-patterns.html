<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rhythm Patterns | Music Theory</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e2e8f0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        .back-link {
            display: inline-block;
            color: #ef4444;
            text-decoration: none;
            margin-bottom: 20px;
            padding: 8px 16px;
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 20px;
            transition: all 0.3s;
        }

        .back-link:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: #94a3b8;
            font-size: 1.1rem;
        }

        .sequencer-area {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .controls-bar {
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            color: #ef4444;
            font-weight: 600;
        }

        .control-group select,
        .control-group input {
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
        }

        .control-group select option {
            background: #1a1a2e;
        }

        .btn {
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-play {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }

        .btn-stop {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .grid-container {
            overflow-x: auto;
            padding: 10px 0;
        }

        .sequencer-grid {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: fit-content;
        }

        .track-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .track-label {
            width: 80px;
            padding: 10px;
            background: rgba(239, 68, 68, 0.2);
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .track-steps {
            display: flex;
            gap: 3px;
        }

        .step {
            width: 35px;
            height: 35px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .step:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .step.active {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .step.playing {
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.8);
            transform: scale(1.1);
        }

        .step.beat-marker {
            border-bottom: 3px solid rgba(239, 68, 68, 0.5);
        }

        .beat-numbers {
            display: flex;
            gap: 3px;
            margin-left: 90px;
            margin-bottom: 10px;
        }

        .beat-number {
            width: 35px;
            text-align: center;
            font-size: 0.75rem;
            color: #64748b;
        }

        .beat-number.main {
            color: #ef4444;
            font-weight: bold;
        }

        .presets-bar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 30px;
        }

        .preset-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 20px;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .preset-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border-color: #ef4444;
        }

        .visualizer {
            height: 60px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-top: 20px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 3px;
            padding: 10px;
        }

        .viz-bar {
            width: 8px;
            background: linear-gradient(180deg, #ef4444, #dc2626);
            border-radius: 3px 3px 0 0;
            transition: height 0.1s;
        }

        @media (max-width: 768px) {
            .step {
                width: 28px;
                height: 28px;
            }
            .beat-number {
                width: 28px;
            }
            .track-label {
                width: 60px;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="index.html" class="back-link">← Back to Music Theory</a>
            <h1>Rhythm Patterns</h1>
            <p class="subtitle">Create drum patterns with a step sequencer</p>
        </header>

        <div class="sequencer-area">
            <div class="controls-bar">
                <button class="btn btn-play" id="playBtn">▶ Play</button>
                <button class="btn btn-stop" id="stopBtn">⏹ Stop</button>

                <div class="control-group">
                    <label>BPM:</label>
                    <input type="number" id="bpm" value="120" min="60" max="200" style="width: 70px;">
                </div>

                <div class="control-group">
                    <label>Time:</label>
                    <select id="timeSignature">
                        <option value="4">4/4</option>
                        <option value="3">3/4</option>
                        <option value="6">6/8</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Steps:</label>
                    <select id="steps">
                        <option value="8">8</option>
                        <option value="16" selected>16</option>
                        <option value="32">32</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Swing:</label>
                    <input type="range" id="swing" min="0" max="100" value="0" style="width: 80px;">
                </div>
            </div>

            <div class="grid-container">
                <div class="beat-numbers" id="beatNumbers"></div>
                <div class="sequencer-grid" id="sequencerGrid"></div>
            </div>

            <div class="visualizer" id="visualizer"></div>

            <div class="presets-bar">
                <button class="preset-btn" data-preset="basic">Basic Rock</button>
                <button class="preset-btn" data-preset="disco">Disco</button>
                <button class="preset-btn" data-preset="hiphop">Hip Hop</button>
                <button class="preset-btn" data-preset="latin">Latin</button>
                <button class="preset-btn" data-preset="clear">Clear All</button>
            </div>
        </div>
    </div>

    <script>
        let audioContext;
        let isPlaying = false;
        let currentStep = 0;
        let intervalId;

        const tracks = [
            { name: 'Kick', freq: 60, decay: 0.5 },
            { name: 'Snare', freq: 200, decay: 0.2, noise: true },
            { name: 'Hi-Hat', freq: 800, decay: 0.05, noise: true },
            { name: 'Open HH', freq: 800, decay: 0.3, noise: true },
            { name: 'Clap', freq: 1200, decay: 0.15, noise: true },
            { name: 'Tom', freq: 150, decay: 0.3 }
        ];

        let pattern = tracks.map(() => new Array(16).fill(false));

        const presets = {
            basic: [
                [1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],
                [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],
                [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],
            disco: [
                [1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],
                [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],
                [0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],
                [0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],
                [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],
            hiphop: [
                [1,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0],
                [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],
                [1,0,0,1,0,0,1,0,0,1,0,0,1,0,1,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0]
            ],
            latin: [
                [1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0],
                [0,0,0,0,1,0,0,1,0,0,1,0,0,0,1,0],
                [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1],
                [0,0,1,0,0,0,1,0,0,1,0,0,0,1,0,0]
            ],
            clear: tracks.map(() => new Array(16).fill(false))
        };

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playSound(track) {
            initAudio();

            if (track.noise) {
                // Noise-based sound (snare, hi-hat)
                const bufferSize = audioContext.sampleRate * track.decay;
                const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
                const data = buffer.getChannelData(0);

                for (let i = 0; i < bufferSize; i++) {
                    data[i] = Math.random() * 2 - 1;
                }

                const noise = audioContext.createBufferSource();
                noise.buffer = buffer;

                const filter = audioContext.createBiquadFilter();
                filter.type = 'highpass';
                filter.frequency.value = track.freq;

                const gain = audioContext.createGain();
                gain.gain.setValueAtTime(0.5, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + track.decay);

                noise.connect(filter);
                filter.connect(gain);
                gain.connect(audioContext.destination);

                noise.start();
                noise.stop(audioContext.currentTime + track.decay);
            } else {
                // Oscillator-based sound (kick, tom)
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();

                osc.type = 'sine';
                osc.frequency.setValueAtTime(track.freq * 2, audioContext.currentTime);
                osc.frequency.exponentialRampToValueAtTime(track.freq, audioContext.currentTime + 0.05);

                gain.gain.setValueAtTime(1, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + track.decay);

                osc.connect(gain);
                gain.connect(audioContext.destination);

                osc.start();
                osc.stop(audioContext.currentTime + track.decay);
            }
        }

        function createGrid() {
            const numSteps = parseInt(document.getElementById('steps').value);
            const beatsPerBar = parseInt(document.getElementById('timeSignature').value);
            const stepsPerBeat = numSteps / beatsPerBar;

            // Update pattern size
            pattern = pattern.map(row => {
                if (row.length < numSteps) {
                    return [...row, ...new Array(numSteps - row.length).fill(false)];
                }
                return row.slice(0, numSteps);
            });

            // Beat numbers
            const beatNumbers = document.getElementById('beatNumbers');
            beatNumbers.innerHTML = Array.from({ length: numSteps }, (_, i) => {
                const isMain = i % stepsPerBeat === 0;
                return `<div class="beat-number ${isMain ? 'main' : ''}">${isMain ? (i / stepsPerBeat + 1) : ''}</div>`;
            }).join('');

            // Grid
            const grid = document.getElementById('sequencerGrid');
            grid.innerHTML = tracks.map((track, trackIndex) => `
                <div class="track-row">
                    <div class="track-label">${track.name}</div>
                    <div class="track-steps">
                        ${Array.from({ length: numSteps }, (_, stepIndex) => {
                            const isActive = pattern[trackIndex][stepIndex];
                            const isBeatMarker = stepIndex % stepsPerBeat === 0;
                            return `<div class="step ${isActive ? 'active' : ''} ${isBeatMarker ? 'beat-marker' : ''}"
                                        data-track="${trackIndex}" data-step="${stepIndex}"></div>`;
                        }).join('')}
                    </div>
                </div>
            `).join('');

            // Visualizer
            const visualizer = document.getElementById('visualizer');
            visualizer.innerHTML = Array.from({ length: numSteps }, () => '<div class="viz-bar" style="height: 5px;"></div>').join('');
        }

        function toggleStep(trackIndex, stepIndex) {
            pattern[trackIndex][stepIndex] = !pattern[trackIndex][stepIndex];
            const step = document.querySelector(`.step[data-track="${trackIndex}"][data-step="${stepIndex}"]`);
            step.classList.toggle('active');

            if (pattern[trackIndex][stepIndex]) {
                playSound(tracks[trackIndex]);
            }
        }

        function play() {
            if (isPlaying) return;
            isPlaying = true;
            initAudio();

            const bpm = parseInt(document.getElementById('bpm').value);
            const numSteps = parseInt(document.getElementById('steps').value);
            const swing = parseInt(document.getElementById('swing').value) / 100;

            const stepDuration = (60 / bpm) / (numSteps / 4) * 1000;

            function step() {
                // Clear previous step highlight
                document.querySelectorAll('.step.playing').forEach(s => s.classList.remove('playing'));

                // Highlight current step
                document.querySelectorAll(`.step[data-step="${currentStep}"]`).forEach(s => s.classList.add('playing'));

                // Play sounds
                let totalVolume = 0;
                tracks.forEach((track, i) => {
                    if (pattern[i][currentStep]) {
                        playSound(track);
                        totalVolume += 1;
                    }
                });

                // Update visualizer
                const vizBars = document.querySelectorAll('.viz-bar');
                vizBars.forEach((bar, i) => {
                    if (i === currentStep) {
                        bar.style.height = (totalVolume * 15 + 10) + 'px';
                    } else {
                        const current = parseFloat(bar.style.height) || 5;
                        bar.style.height = Math.max(5, current * 0.8) + 'px';
                    }
                });

                currentStep = (currentStep + 1) % numSteps;

                // Apply swing to off-beats
                const nextDelay = currentStep % 2 === 1 ? stepDuration * (1 + swing * 0.3) : stepDuration * (1 - swing * 0.15);
                intervalId = setTimeout(step, nextDelay);
            }

            step();
        }

        function stop() {
            isPlaying = false;
            clearTimeout(intervalId);
            currentStep = 0;
            document.querySelectorAll('.step.playing').forEach(s => s.classList.remove('playing'));
        }

        function applyPreset(name) {
            const preset = presets[name];
            if (!preset) return;

            const numSteps = parseInt(document.getElementById('steps').value);
            pattern = preset.map(row => {
                if (row.length < numSteps) {
                    return [...row, ...new Array(numSteps - row.length).fill(false)];
                }
                return row.slice(0, numSteps).map(v => v === 1);
            });

            createGrid();
        }

        // Event listeners
        document.getElementById('playBtn').addEventListener('click', play);
        document.getElementById('stopBtn').addEventListener('click', stop);

        document.getElementById('steps').addEventListener('change', () => {
            stop();
            createGrid();
        });

        document.getElementById('timeSignature').addEventListener('change', createGrid);

        document.getElementById('sequencerGrid').addEventListener('click', (e) => {
            const step = e.target.closest('.step');
            if (step) {
                toggleStep(parseInt(step.dataset.track), parseInt(step.dataset.step));
            }
        });

        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                applyPreset(btn.dataset.preset);
            });
        });

        createGrid();
        applyPreset('basic');
    </script>
</body>
</html>
