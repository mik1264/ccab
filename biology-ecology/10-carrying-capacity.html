<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrying Capacity - Biology & Ecology</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: linear-gradient(135deg, #1a2e1a 0%, #163e16 100%); color: #eee; min-height: 100vh; padding: 20px; }
        .back-link { position: fixed; top: 20px; left: 20px; color: #4ade80; text-decoration: none; font-weight: 600; padding: 8px 16px; background: rgba(0,0,0,0.3); border-radius: 20px; z-index: 100; }
        h1 { text-align: center; margin: 40px 0 10px; font-size: 2.2em; color: #4ade80; }
        .subtitle { text-align: center; opacity: 0.8; margin-bottom: 20px; }
        .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        .panel { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 25px; }
        .info-box { background: rgba(74, 222, 128, 0.1); border: 1px solid rgba(74, 222, 128, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px; font-size: 0.85em; line-height: 1.6; }
        h3 { color: #4ade80; margin-bottom: 15px; }
        canvas { width: 100%; border-radius: 8px; }
        .control-group { margin: 15px 0; }
        .control-group label { display: block; margin-bottom: 5px; }
        .control-group input, .control-group select { width: 100%; }
        .value-display { color: #4ade80; font-family: monospace; }
        button { width: 100%; padding: 12px; margin: 8px 0; border: none; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; }
        .btn-primary { background: #4ade80; color: #1a2e1a; }
        .btn-danger { background: #f87171; color: #fff; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; }
        .capacity-bar { height: 20px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; margin: 15px 0; position: relative; }
        .capacity-fill { height: 100%; transition: width 0.3s, background 0.3s; }
        .capacity-marker { position: absolute; top: 0; bottom: 0; width: 3px; background: #fff; }
        .equation { font-family: 'Times New Roman', serif; font-size: 1.1em; text-align: center; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px; margin: 15px 0; }
        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back</a>
    <h1>Carrying Capacity</h1>
    <p class="subtitle">Logistic growth and environmental limits</p>

    <div class="container">
        <div class="panel">
            <canvas id="envCanvas" width="800" height="300"></canvas>
            <canvas id="chartCanvas" width="800" height="200" style="margin-top: 15px;"></canvas>
        </div>

        <div class="panel">
            <div class="info-box">
                <strong>Logistic Growth:</strong>
                Populations grow exponentially at first, but slow as they approach
                the environment's <em>carrying capacity</em> (K) - the maximum population
                the habitat can sustain.
            </div>

            <div class="equation">
                dN/dt = rN(1 - N/K)
            </div>

            <h3>Population vs Carrying Capacity</h3>
            <div class="capacity-bar">
                <div class="capacity-fill" id="popBar" style="width: 10%; background: #4ade80;"></div>
                <div class="capacity-marker" id="kMarker" style="left: 80%;"></div>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 0.8em;">
                <span>N = <span id="popNum">10</span></span>
                <span>K = <span id="kNum">100</span></span>
            </div>

            <div class="control-group">
                <label>Carrying Capacity (K): <span class="value-display" id="kVal">100</span></label>
                <input type="range" id="kSlider" min="50" max="300" value="100" oninput="updateParams()">
            </div>

            <div class="control-group">
                <label>Growth Rate (r): <span class="value-display" id="rVal">0.1</span></label>
                <input type="range" id="rSlider" min="1" max="50" value="10" oninput="updateParams()">
            </div>

            <div class="control-group">
                <label>Initial Population: <span class="value-display" id="n0Val">10</span></label>
                <input type="range" id="n0Slider" min="5" max="50" value="10" oninput="updateParams()">
            </div>

            <div class="control-group">
                <label>Environment Type:</label>
                <select id="envSelect" onchange="changeEnv()">
                    <option value="stable">Stable Environment</option>
                    <option value="seasonal">Seasonal Fluctuation</option>
                    <option value="degrading">Habitat Degradation</option>
                    <option value="improving">Habitat Restoration</option>
                </select>
            </div>

            <button class="btn-primary" onclick="toggleSim()">Start/Stop</button>
            <button class="btn-danger" onclick="disaster()">Natural Disaster</button>
            <button class="btn-secondary" onclick="resetSim()">Reset</button>

            <h3 style="margin-top: 15px;">Statistics</h3>
            <div style="font-size: 0.9em;">
                <div style="display: flex; justify-content: space-between; padding: 3px 0;">
                    <span>Time:</span><span class="value-display" id="timeVal">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 3px 0;">
                    <span>Population:</span><span class="value-display" id="nVal">10</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 3px 0;">
                    <span>Growth Rate:</span><span class="value-display" id="growthVal">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 3px 0;">
                    <span>% of K:</span><span class="value-display" id="pctVal">10%</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 3px 0;">
                    <span>Phase:</span><span class="value-display" id="phaseVal">Lag</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const envCanvas = document.getElementById('envCanvas');
        const ectx = envCanvas.getContext('2d');
        const chartCanvas = document.getElementById('chartCanvas');
        const cctx = chartCanvas.getContext('2d');

        let population = 10;
        let carryingCapacity = 100;
        let growthRate = 0.1;
        let initialPop = 10;
        let time = 0;
        let running = false;
        let history = [];
        let kHistory = [];
        let envType = 'stable';
        let organisms = [];

        function updateParams() {
            carryingCapacity = parseInt(document.getElementById('kSlider').value);
            growthRate = parseInt(document.getElementById('rSlider').value) / 100;
            initialPop = parseInt(document.getElementById('n0Slider').value);

            document.getElementById('kVal').textContent = carryingCapacity;
            document.getElementById('rVal').textContent = growthRate.toFixed(2);
            document.getElementById('n0Val').textContent = initialPop;
        }

        function changeEnv() {
            envType = document.getElementById('envSelect').value;
        }

        function initOrganisms() {
            organisms = [];
            for (let i = 0; i < Math.min(population, 200); i++) {
                organisms.push({
                    x: Math.random() * envCanvas.width,
                    y: Math.random() * envCanvas.height,
                    vx: (Math.random() - 0.5) * 2,
                    vy: (Math.random() - 0.5) * 2
                });
            }
        }

        function updatePopulation() {
            time++;

            // Update carrying capacity based on environment type
            let effectiveK = carryingCapacity;
            if (envType === 'seasonal') {
                effectiveK = carryingCapacity * (0.7 + 0.3 * Math.sin(time / 50));
            } else if (envType === 'degrading') {
                effectiveK = carryingCapacity * Math.max(0.3, 1 - time / 500);
            } else if (envType === 'improving') {
                effectiveK = carryingCapacity * Math.min(1.5, 0.5 + time / 300);
            }

            // Logistic growth equation: dN/dt = rN(1 - N/K)
            const dN = growthRate * population * (1 - population / effectiveK);
            population += dN;
            population = Math.max(1, population);

            // Record history
            history.push({ t: time, n: population, dn: dN });
            kHistory.push({ t: time, k: effectiveK });
            if (history.length > 300) {
                history.shift();
                kHistory.shift();
            }

            // Sync visual organisms
            while (organisms.length < Math.min(Math.round(population), 200)) {
                organisms.push({
                    x: Math.random() * envCanvas.width,
                    y: Math.random() * envCanvas.height,
                    vx: (Math.random() - 0.5) * 2,
                    vy: (Math.random() - 0.5) * 2
                });
            }
            while (organisms.length > Math.min(Math.round(population), 200)) {
                organisms.pop();
            }

            updateDisplay(effectiveK);
        }

        function updateDisplay(effectiveK) {
            const pct = (population / carryingCapacity) * 100;
            const kPct = (effectiveK / (carryingCapacity * 1.5)) * 100;

            document.getElementById('popBar').style.width = Math.min(pct, 150) + '%';
            document.getElementById('popBar').style.background =
                population > effectiveK ? '#f87171' :
                population > effectiveK * 0.8 ? '#facc15' : '#4ade80';

            document.getElementById('kMarker').style.left = kPct + '%';

            document.getElementById('timeVal').textContent = time;
            document.getElementById('nVal').textContent = Math.round(population);
            document.getElementById('popNum').textContent = Math.round(population);
            document.getElementById('kNum').textContent = Math.round(effectiveK);

            const currentGrowth = history.length > 0 ? history[history.length - 1].dn : 0;
            document.getElementById('growthVal').textContent = currentGrowth.toFixed(2);
            document.getElementById('pctVal').textContent = Math.round(pct) + '%';

            // Phase determination
            let phase = 'Equilibrium';
            if (pct < 20) phase = 'Lag Phase';
            else if (pct < 50 && currentGrowth > 0.5) phase = 'Exponential Growth';
            else if (pct < 90) phase = 'Deceleration';
            else if (population > effectiveK * 1.05) phase = 'Overshoot';
            document.getElementById('phaseVal').textContent = phase;
        }

        function disaster() {
            population *= 0.3;
            organisms = organisms.slice(0, Math.floor(organisms.length * 0.3));
        }

        function drawEnvironment() {
            // Sky
            const skyGrad = ectx.createLinearGradient(0, 0, 0, envCanvas.height);
            if (envType === 'degrading') {
                skyGrad.addColorStop(0, '#8b4513');
                skyGrad.addColorStop(1, '#d2691e');
            } else if (envType === 'improving') {
                skyGrad.addColorStop(0, '#1e90ff');
                skyGrad.addColorStop(1, '#87ceeb');
            } else {
                skyGrad.addColorStop(0, '#2d5a27');
                skyGrad.addColorStop(1, '#4a7c41');
            }
            ectx.fillStyle = skyGrad;
            ectx.fillRect(0, 0, envCanvas.width, envCanvas.height);

            // Ground
            ectx.fillStyle = envType === 'degrading' ? '#8b7355' : '#2d5a27';
            ectx.fillRect(0, envCanvas.height - 50, envCanvas.width, 50);

            // Resources based on K
            const effectiveK = kHistory.length > 0 ? kHistory[kHistory.length - 1].k : carryingCapacity;
            const resourceDensity = effectiveK / carryingCapacity;

            // Trees/resources
            ectx.fillStyle = 'rgba(34, 139, 34, ' + resourceDensity + ')';
            for (let i = 0; i < 20 * resourceDensity; i++) {
                const x = (i * 47 + time * 0.1) % envCanvas.width;
                ectx.beginPath();
                ectx.moveTo(x, envCanvas.height - 50);
                ectx.lineTo(x - 15, envCanvas.height - 90);
                ectx.lineTo(x + 15, envCanvas.height - 90);
                ectx.fill();
            }

            // Draw organisms
            for (const org of organisms) {
                // Movement
                org.x += org.vx;
                org.y += org.vy;

                // Bounce
                if (org.x < 10 || org.x > envCanvas.width - 10) org.vx *= -1;
                if (org.y < 10 || org.y > envCanvas.height - 60) org.vy *= -1;

                org.x = Math.max(10, Math.min(envCanvas.width - 10, org.x));
                org.y = Math.max(10, Math.min(envCanvas.height - 60, org.y));

                // Random movement
                if (Math.random() < 0.02) {
                    org.vx = (Math.random() - 0.5) * 2;
                    org.vy = (Math.random() - 0.5) * 2;
                }

                // Crowding effect - slow down when near K
                const crowding = population / effectiveK;
                if (crowding > 0.8) {
                    org.vx *= 0.95;
                    org.vy *= 0.95;
                }

                // Draw
                ectx.fillStyle = population > effectiveK ? '#f87171' : '#4ade80';
                ectx.beginPath();
                ectx.arc(org.x, org.y, 5, 0, Math.PI * 2);
                ectx.fill();
            }

            // Info overlay
            ectx.fillStyle = 'rgba(0,0,0,0.5)';
            ectx.fillRect(10, 10, 200, 60);
            ectx.fillStyle = '#fff';
            ectx.font = '14px sans-serif';
            ectx.fillText(`Population: ${Math.round(population)}`, 20, 30);
            ectx.fillText(`Carrying Capacity: ${Math.round(effectiveK)}`, 20, 50);

            // K line indicator
            ectx.strokeStyle = '#facc15';
            ectx.setLineDash([5, 5]);
            ectx.beginPath();
            ectx.moveTo(0, envCanvas.height - 60 - (effectiveK / 3));
            ectx.lineTo(envCanvas.width, envCanvas.height - 60 - (effectiveK / 3));
            ectx.stroke();
            ectx.setLineDash([]);
        }

        function drawChart() {
            cctx.fillStyle = '#0a150a';
            cctx.fillRect(0, 0, chartCanvas.width, chartCanvas.height);

            if (history.length < 2) return;

            const maxPop = Math.max(carryingCapacity * 1.5, ...history.map(h => h.n));
            const scaleX = (chartCanvas.width - 60) / 300;
            const scaleY = (chartCanvas.height - 40) / maxPop;

            // Draw K line
            cctx.strokeStyle = 'rgba(250, 204, 21, 0.5)';
            cctx.setLineDash([5, 5]);
            cctx.beginPath();
            const kY = chartCanvas.height - 25 - carryingCapacity * scaleY;
            cctx.moveTo(50, kY);
            cctx.lineTo(chartCanvas.width - 10, kY);
            cctx.stroke();
            cctx.setLineDash([]);

            // Draw effective K if variable
            if (envType !== 'stable' && kHistory.length > 1) {
                cctx.strokeStyle = 'rgba(250, 204, 21, 0.3)';
                cctx.lineWidth = 2;
                cctx.beginPath();
                kHistory.forEach((h, i) => {
                    const x = 50 + (history[0] ? h.t - history[0].t : i) * scaleX;
                    const y = chartCanvas.height - 25 - h.k * scaleY;
                    if (i === 0) cctx.moveTo(x, y);
                    else cctx.lineTo(x, y);
                });
                cctx.stroke();
            }

            // Population curve
            cctx.strokeStyle = '#4ade80';
            cctx.lineWidth = 2;
            cctx.beginPath();
            history.forEach((h, i) => {
                const x = 50 + (h.t - history[0].t) * scaleX;
                const y = chartCanvas.height - 25 - h.n * scaleY;
                if (i === 0) cctx.moveTo(x, y);
                else cctx.lineTo(x, y);
            });
            cctx.stroke();

            // Axes
            cctx.strokeStyle = 'rgba(255,255,255,0.3)';
            cctx.lineWidth = 1;
            cctx.beginPath();
            cctx.moveTo(50, 15);
            cctx.lineTo(50, chartCanvas.height - 25);
            cctx.lineTo(chartCanvas.width - 10, chartCanvas.height - 25);
            cctx.stroke();

            // Labels
            cctx.fillStyle = '#fff';
            cctx.font = '11px sans-serif';
            cctx.textAlign = 'right';
            cctx.fillText('N', 45, 20);
            cctx.fillText('K', 45, kY + 4);

            cctx.textAlign = 'center';
            cctx.fillText('Time', chartCanvas.width / 2, chartCanvas.height - 5);

            // Legend
            cctx.fillStyle = '#4ade80';
            cctx.fillRect(chartCanvas.width - 120, 10, 12, 12);
            cctx.fillStyle = '#fff';
            cctx.textAlign = 'left';
            cctx.fillText('Population', chartCanvas.width - 105, 20);

            cctx.fillStyle = '#facc15';
            cctx.fillRect(chartCanvas.width - 120, 28, 12, 12);
            cctx.fillStyle = '#fff';
            cctx.fillText('Carrying Cap.', chartCanvas.width - 105, 38);
        }

        function toggleSim() {
            running = !running;
            if (running) animate();
        }

        function resetSim() {
            running = false;
            time = 0;
            population = initialPop;
            history = [];
            kHistory = [];
            initOrganisms();
            updateDisplay(carryingCapacity);
            drawEnvironment();
            drawChart();
        }

        function animate() {
            if (!running) return;
            updatePopulation();
            drawEnvironment();
            drawChart();
            requestAnimationFrame(animate);
        }

        updateParams();
        resetSim();
    </script>
</body>
</html>
