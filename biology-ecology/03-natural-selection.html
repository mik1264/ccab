<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Natural Selection - Biology & Ecology</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: linear-gradient(135deg, #1a2e1a 0%, #163e16 100%); color: #eee; min-height: 100vh; padding: 20px; }
        .back-link { position: fixed; top: 20px; left: 20px; color: #4ade80; text-decoration: none; font-weight: 600; padding: 8px 16px; background: rgba(0,0,0,0.3); border-radius: 20px; z-index: 100; }
        h1 { text-align: center; margin: 40px 0 10px; font-size: 2.2em; color: #4ade80; }
        .subtitle { text-align: center; opacity: 0.8; margin-bottom: 20px; }
        .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        .panel { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 25px; }
        .info-box { background: rgba(74, 222, 128, 0.1); border: 1px solid rgba(74, 222, 128, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px; font-size: 0.85em; line-height: 1.6; }
        h3 { color: #4ade80; margin-bottom: 15px; }
        canvas { width: 100%; border-radius: 8px; background: #0a150a; }
        .control-group { margin: 15px 0; }
        .control-group label { display: block; margin-bottom: 5px; }
        .control-group input, .control-group select { width: 100%; }
        .value-display { color: #4ade80; font-family: monospace; }
        button { width: 100%; padding: 12px; margin: 8px 0; border: none; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; }
        .btn-primary { background: #4ade80; color: #1a2e1a; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; }
        .stats-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .stats-row:last-child { border-bottom: none; }
        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back</a>
    <h1>Natural Selection</h1>
    <p class="subtitle">Evolution through differential survival</p>

    <div class="container">
        <div class="panel">
            <canvas id="canvas" width="800" height="400"></canvas>
            <canvas id="chartCanvas" width="800" height="120" style="margin-top: 15px;"></canvas>
        </div>

        <div class="panel">
            <div class="info-box">
                <strong>Natural Selection:</strong>
                Organisms with traits better suited to their environment survive
                and reproduce more successfully. Over generations, these advantageous
                traits become more common in the population.
            </div>

            <h3>Environment</h3>
            <div class="control-group">
                <label>Background Color:</label>
                <select id="envSelect" onchange="changeEnvironment()">
                    <option value="dark">Dark (forest floor)</option>
                    <option value="light">Light (sandy beach)</option>
                    <option value="green">Green (grassland)</option>
                </select>
            </div>

            <div class="control-group">
                <label>Predation Pressure: <span class="value-display" id="predVal">50%</span></label>
                <input type="range" id="predSlider" min="10" max="90" value="50" oninput="updatePred()">
            </div>

            <div class="control-group">
                <label>Mutation Rate: <span class="value-display" id="mutVal">5%</span></label>
                <input type="range" id="mutSlider" min="0" max="20" value="5" oninput="updateMut()">
            </div>

            <button class="btn-primary" onclick="runGeneration()">Next Generation</button>
            <button class="btn-secondary" onclick="runMany()">Run 20 Generations</button>
            <button class="btn-secondary" onclick="resetSim()">Reset</button>

            <h3 style="margin-top: 15px;">Statistics</h3>
            <div class="stats-row">
                <span>Generation:</span>
                <span class="value-display" id="genNum">0</span>
            </div>
            <div class="stats-row">
                <span>Population:</span>
                <span class="value-display" id="popSize">100</span>
            </div>
            <div class="stats-row">
                <span>Avg Fitness:</span>
                <span class="value-display" id="avgFit">0.50</span>
            </div>
            <div class="stats-row">
                <span>Best Camouflage:</span>
                <span class="value-display" id="bestCamo">-</span>
            </div>

            <h3 style="margin-top: 15px;">Color Distribution</h3>
            <canvas id="histCanvas" width="260" height="60"></canvas>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const chartCanvas = document.getElementById('chartCanvas');
        const cctx = chartCanvas.getContext('2d');
        const histCanvas = document.getElementById('histCanvas');
        const hctx = histCanvas.getContext('2d');

        let organisms = [];
        let generation = 0;
        let predationPressure = 0.5;
        let mutationRate = 0.05;
        let environment = { r: 30, g: 30, b: 30 }; // Dark
        let history = [];

        function updatePred() {
            predationPressure = parseInt(document.getElementById('predSlider').value) / 100;
            document.getElementById('predVal').textContent = Math.round(predationPressure * 100) + '%';
        }

        function updateMut() {
            mutationRate = parseInt(document.getElementById('mutSlider').value) / 100;
            document.getElementById('mutVal').textContent = Math.round(mutationRate * 100) + '%';
        }

        function changeEnvironment() {
            const env = document.getElementById('envSelect').value;
            if (env === 'dark') {
                environment = { r: 30, g: 30, b: 30 };
            } else if (env === 'light') {
                environment = { r: 220, g: 200, b: 160 };
            } else {
                environment = { r: 60, g: 120, b: 60 };
            }
            draw();
        }

        function initPopulation() {
            organisms = [];
            for (let i = 0; i < 100; i++) {
                organisms.push({
                    r: Math.floor(Math.random() * 256),
                    g: Math.floor(Math.random() * 256),
                    b: Math.floor(Math.random() * 256),
                    x: Math.random() * (canvas.width - 40) + 20,
                    y: Math.random() * (canvas.height - 40) + 20
                });
            }
        }

        function calculateFitness(org) {
            // Fitness based on how similar color is to environment
            const dr = Math.abs(org.r - environment.r);
            const dg = Math.abs(org.g - environment.g);
            const db = Math.abs(org.b - environment.b);
            const distance = Math.sqrt(dr * dr + dg * dg + db * db);
            // Max distance is ~441 (sqrt(255^2 * 3))
            return 1 - (distance / 441);
        }

        function runGeneration() {
            generation++;

            // Selection: better camouflage = higher survival
            const survivors = organisms.filter(org => {
                const fitness = calculateFitness(org);
                const survivalChance = fitness * (1 - predationPressure) + (1 - predationPressure) * 0.5;
                return Math.random() < survivalChance;
            });

            if (survivors.length === 0) {
                // Extinction! Reset with some survivors
                survivors.push(...organisms.slice(0, 5));
            }

            // Reproduction
            const newOrganisms = [];
            const targetPop = 100;

            while (newOrganisms.length < targetPop) {
                // Tournament selection
                const parent1 = survivors[Math.floor(Math.random() * survivors.length)];
                const parent2 = survivors[Math.floor(Math.random() * survivors.length)];

                // Crossover and mutation
                let child = {
                    r: Math.random() < 0.5 ? parent1.r : parent2.r,
                    g: Math.random() < 0.5 ? parent1.g : parent2.g,
                    b: Math.random() < 0.5 ? parent1.b : parent2.b,
                    x: Math.random() * (canvas.width - 40) + 20,
                    y: Math.random() * (canvas.height - 40) + 20
                };

                // Mutation
                if (Math.random() < mutationRate) {
                    child.r = Math.max(0, Math.min(255, child.r + Math.floor((Math.random() - 0.5) * 50)));
                }
                if (Math.random() < mutationRate) {
                    child.g = Math.max(0, Math.min(255, child.g + Math.floor((Math.random() - 0.5) * 50)));
                }
                if (Math.random() < mutationRate) {
                    child.b = Math.max(0, Math.min(255, child.b + Math.floor((Math.random() - 0.5) * 50)));
                }

                newOrganisms.push(child);
            }

            organisms = newOrganisms;

            // Record history
            const avgFitness = organisms.reduce((sum, org) => sum + calculateFitness(org), 0) / organisms.length;
            history.push({ gen: generation, avgFitness });
            if (history.length > 100) history.shift();

            updateStats();
            draw();
            drawChart();
            drawHistogram();
        }

        function runMany() {
            for (let i = 0; i < 20; i++) {
                runGeneration();
            }
        }

        function resetSim() {
            generation = 0;
            history = [];
            initPopulation();
            updateStats();
            draw();
            drawChart();
            drawHistogram();
        }

        function updateStats() {
            const avgFitness = organisms.reduce((sum, org) => sum + calculateFitness(org), 0) / organisms.length;
            const bestOrg = organisms.reduce((best, org) =>
                calculateFitness(org) > calculateFitness(best) ? org : best, organisms[0]);

            document.getElementById('genNum').textContent = generation;
            document.getElementById('popSize').textContent = organisms.length;
            document.getElementById('avgFit').textContent = avgFitness.toFixed(3);
            document.getElementById('bestCamo').textContent =
                `rgb(${bestOrg.r}, ${bestOrg.g}, ${bestOrg.b})`;
            document.getElementById('bestCamo').style.color =
                `rgb(${bestOrg.r}, ${bestOrg.g}, ${bestOrg.b})`;
        }

        function draw() {
            // Draw environment
            ctx.fillStyle = `rgb(${environment.r}, ${environment.g}, ${environment.b})`;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Add some texture
            ctx.fillStyle = `rgba(${environment.r * 0.8}, ${environment.g * 0.8}, ${environment.b * 0.8}, 0.3)`;
            for (let i = 0; i < 200; i++) {
                ctx.beginPath();
                ctx.arc(Math.random() * canvas.width, Math.random() * canvas.height, Math.random() * 10 + 2, 0, Math.PI * 2);
                ctx.fill();
            }

            // Draw organisms
            for (const org of organisms) {
                ctx.fillStyle = `rgb(${org.r}, ${org.g}, ${org.b})`;
                ctx.beginPath();
                ctx.arc(org.x, org.y, 8, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = 'rgba(0,0,0,0.3)';
                ctx.lineWidth = 1;
                ctx.stroke();
            }

            // Info
            ctx.fillStyle = environment.r + environment.g + environment.b > 400 ? '#000' : '#fff';
            ctx.font = 'bold 14px sans-serif';
            ctx.fillText(`Generation: ${generation}`, 20, 30);
        }

        function drawChart() {
            cctx.fillStyle = '#0a150a';
            cctx.fillRect(0, 0, chartCanvas.width, chartCanvas.height);

            // Axes
            cctx.strokeStyle = 'rgba(255,255,255,0.2)';
            cctx.lineWidth = 1;
            cctx.beginPath();
            cctx.moveTo(50, chartCanvas.height - 25);
            cctx.lineTo(chartCanvas.width - 20, chartCanvas.height - 25);
            cctx.moveTo(50, 10);
            cctx.lineTo(50, chartCanvas.height - 25);
            cctx.stroke();

            cctx.fillStyle = '#fff';
            cctx.font = '11px sans-serif';
            cctx.fillText('Average Fitness Over Time', 50, 20);
            cctx.fillText('Generation', chartCanvas.width / 2, chartCanvas.height - 5);

            if (history.length < 2) return;

            const scaleX = (chartCanvas.width - 70) / Math.max(history.length, 20);
            const scaleY = chartCanvas.height - 45;

            cctx.strokeStyle = '#4ade80';
            cctx.lineWidth = 2;
            cctx.beginPath();
            history.forEach((h, i) => {
                const x = 50 + i * scaleX;
                const y = chartCanvas.height - 25 - h.avgFitness * scaleY;
                if (i === 0) cctx.moveTo(x, y);
                else cctx.lineTo(x, y);
            });
            cctx.stroke();
        }

        function drawHistogram() {
            hctx.fillStyle = '#0a150a';
            hctx.fillRect(0, 0, histCanvas.width, histCanvas.height);

            // Create histogram of brightness (as proxy for color)
            const bins = 20;
            const counts = new Array(bins).fill(0);

            for (const org of organisms) {
                const brightness = (org.r + org.g + org.b) / 3;
                const bin = Math.min(Math.floor(brightness / 256 * bins), bins - 1);
                counts[bin]++;
            }

            const maxCount = Math.max(...counts, 1);
            const barWidth = histCanvas.width / bins;

            for (let i = 0; i < bins; i++) {
                const brightness = (i / bins) * 255;
                hctx.fillStyle = `rgb(${brightness}, ${brightness}, ${brightness})`;
                const height = (counts[i] / maxCount) * (histCanvas.height - 10);
                hctx.fillRect(i * barWidth + 1, histCanvas.height - height, barWidth - 2, height);
            }
        }

        updatePred();
        updateMut();
        changeEnvironment();
        resetSim();
    </script>
</body>
</html>
