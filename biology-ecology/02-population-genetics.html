<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Population Genetics - Biology & Ecology</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: linear-gradient(135deg, #1a2e1a 0%, #163e16 100%); color: #eee; min-height: 100vh; padding: 20px; }
        .back-link { position: fixed; top: 20px; left: 20px; color: #4ade80; text-decoration: none; font-weight: 600; padding: 8px 16px; background: rgba(0,0,0,0.3); border-radius: 20px; z-index: 100; }
        h1 { text-align: center; margin: 40px 0 10px; font-size: 2.2em; color: #4ade80; }
        .subtitle { text-align: center; opacity: 0.8; margin-bottom: 20px; }
        .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        .panel { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 25px; }
        .info-box { background: rgba(74, 222, 128, 0.1); border: 1px solid rgba(74, 222, 128, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px; font-size: 0.85em; line-height: 1.6; }
        h3 { color: #4ade80; margin-bottom: 15px; }
        canvas { width: 100%; border-radius: 8px; background: #0a150a; }
        .control-group { margin: 15px 0; }
        .control-group label { display: block; margin-bottom: 5px; }
        .control-group input { width: 100%; }
        .value-display { color: #4ade80; font-family: monospace; }
        button { width: 100%; padding: 12px; margin: 8px 0; border: none; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; }
        .btn-primary { background: #4ade80; color: #1a2e1a; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; }
        .genotype-display { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; }
        .geno-box { background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px; text-align: center; }
        .geno-value { font-size: 1.3em; font-weight: bold; }
        .allele-display { display: flex; gap: 10px; margin: 15px 0; }
        .allele-box { flex: 1; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px; text-align: center; }
        .hw-equation { background: rgba(0,0,0,0.2); border-radius: 8px; padding: 15px; font-family: monospace; text-align: center; margin: 15px 0; }
        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back</a>
    <h1>Population Genetics</h1>
    <p class="subtitle">Hardy-Weinberg equilibrium</p>

    <div class="container">
        <div class="panel">
            <canvas id="canvas" width="800" height="300"></canvas>
            <canvas id="histCanvas" width="800" height="150" style="margin-top: 15px;"></canvas>
        </div>

        <div class="panel">
            <div class="info-box">
                <strong>Hardy-Weinberg Principle:</strong>
                In a large, randomly mating population without selection, mutation,
                or migration, allele frequencies remain constant.
                Genotype frequencies: p² + 2pq + q² = 1
            </div>

            <div class="hw-equation">
                p² (AA) + 2pq (Aa) + q² (aa) = 1
            </div>

            <h3>Allele Frequencies</h3>
            <div class="allele-display">
                <div class="allele-box">
                    <div class="geno-value" style="color: #60a5fa;" id="pFreq">0.50</div>
                    <div>p (A allele)</div>
                </div>
                <div class="allele-box">
                    <div class="geno-value" style="color: #facc15;" id="qFreq">0.50</div>
                    <div>q (a allele)</div>
                </div>
            </div>

            <h3>Genotype Frequencies</h3>
            <div class="genotype-display">
                <div class="geno-box">
                    <div class="geno-value" style="color: #60a5fa;" id="AAfreq">25%</div>
                    <div>AA (p²)</div>
                </div>
                <div class="geno-box">
                    <div class="geno-value" style="color: #4ade80;" id="Aafreq">50%</div>
                    <div>Aa (2pq)</div>
                </div>
                <div class="geno-box">
                    <div class="geno-value" style="color: #facc15;" id="aafreq">25%</div>
                    <div>aa (q²)</div>
                </div>
            </div>

            <div class="control-group">
                <label>Initial p frequency: <span class="value-display" id="initP">0.50</span></label>
                <input type="range" id="pSlider" min="1" max="99" value="50" oninput="updateP()">
            </div>

            <div class="control-group">
                <label>Population Size: <span class="value-display" id="popVal">500</span></label>
                <input type="range" id="popSlider" min="20" max="2000" value="500" oninput="updatePop()">
            </div>

            <div class="control-group">
                <label>Selection (fitness of aa): <span class="value-display" id="selVal">1.00</span></label>
                <input type="range" id="selSlider" min="0" max="100" value="100" oninput="updateSel()">
            </div>

            <button class="btn-primary" onclick="runGeneration()">Next Generation</button>
            <button class="btn-secondary" onclick="runMany()">Run 50 Generations</button>
            <button class="btn-secondary" onclick="resetSim()">Reset</button>

            <div style="margin-top: 15px; font-size: 0.9em;">
                Generation: <span class="value-display" id="genCount">0</span>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const histCanvas = document.getElementById('histCanvas');
        const hctx = histCanvas.getContext('2d');

        let p = 0.5; // Frequency of A allele
        let q = 0.5; // Frequency of a allele
        let popSize = 500;
        let selection = 1.0; // Fitness of aa genotype
        let generation = 0;
        let history = [];
        let individuals = [];

        function updateP() {
            p = parseInt(document.getElementById('pSlider').value) / 100;
            q = 1 - p;
            document.getElementById('initP').textContent = p.toFixed(2);
            resetSim();
        }

        function updatePop() {
            popSize = parseInt(document.getElementById('popSlider').value);
            document.getElementById('popVal').textContent = popSize;
            resetSim();
        }

        function updateSel() {
            selection = parseInt(document.getElementById('selSlider').value) / 100;
            document.getElementById('selVal').textContent = selection.toFixed(2);
        }

        function initPopulation() {
            individuals = [];
            for (let i = 0; i < popSize; i++) {
                // Generate individual based on HW frequencies
                const r = Math.random();
                let genotype;
                if (r < p * p) genotype = 'AA';
                else if (r < p * p + 2 * p * q) genotype = 'Aa';
                else genotype = 'aa';

                individuals.push({
                    genotype: genotype,
                    x: Math.random() * (canvas.width - 40) + 20,
                    y: Math.random() * (canvas.height - 40) + 20
                });
            }
        }

        function calculateFrequencies() {
            let countAA = 0, countAa = 0, countaa = 0;

            for (const ind of individuals) {
                if (ind.genotype === 'AA') countAA++;
                else if (ind.genotype === 'Aa') countAa++;
                else countaa++;
            }

            const total = individuals.length;
            const freqAA = countAA / total;
            const freqAa = countAa / total;
            const freqaa = countaa / total;

            // Calculate allele frequencies from genotypes
            p = freqAA + freqAa / 2;
            q = 1 - p;

            return { freqAA, freqAa, freqaa };
        }

        function runGeneration() {
            generation++;

            // Selection: reduce fitness of aa individuals
            if (selection < 1) {
                individuals = individuals.filter(ind => {
                    if (ind.genotype === 'aa') {
                        return Math.random() < selection;
                    }
                    return true;
                });
            }

            // Calculate current frequencies after selection
            const freqs = calculateFrequencies();

            // Create new generation through random mating
            const newIndividuals = [];
            const targetSize = popSize;

            while (newIndividuals.length < targetSize) {
                // Pick two random parents
                const parent1 = individuals[Math.floor(Math.random() * individuals.length)];
                const parent2 = individuals[Math.floor(Math.random() * individuals.length)];

                // Get allele from each parent
                const allele1 = getRandomAllele(parent1.genotype);
                const allele2 = getRandomAllele(parent2.genotype);

                // Combine to form offspring genotype
                let genotype;
                if (allele1 === 'A' && allele2 === 'A') genotype = 'AA';
                else if (allele1 === 'a' && allele2 === 'a') genotype = 'aa';
                else genotype = 'Aa';

                newIndividuals.push({
                    genotype: genotype,
                    x: Math.random() * (canvas.width - 40) + 20,
                    y: Math.random() * (canvas.height - 40) + 20
                });
            }

            individuals = newIndividuals;

            // Record history
            const newFreqs = calculateFrequencies();
            history.push({ p: p, q: q, ...newFreqs, gen: generation });
            if (history.length > 100) history.shift();

            updateDisplay();
            draw();
            drawHistory();
        }

        function getRandomAllele(genotype) {
            if (genotype === 'AA') return 'A';
            if (genotype === 'aa') return 'a';
            return Math.random() < 0.5 ? 'A' : 'a';
        }

        function runMany() {
            for (let i = 0; i < 50; i++) {
                runGeneration();
            }
        }

        function resetSim() {
            generation = 0;
            history = [];
            q = 1 - p;
            initPopulation();
            calculateFrequencies();
            updateDisplay();
            draw();
            drawHistory();
        }

        function updateDisplay() {
            document.getElementById('pFreq').textContent = p.toFixed(3);
            document.getElementById('qFreq').textContent = q.toFixed(3);
            document.getElementById('AAfreq').textContent = (p * p * 100).toFixed(1) + '%';
            document.getElementById('Aafreq').textContent = (2 * p * q * 100).toFixed(1) + '%';
            document.getElementById('aafreq').textContent = (q * q * 100).toFixed(1) + '%';
            document.getElementById('genCount').textContent = generation;
        }

        function draw() {
            ctx.fillStyle = '#0a150a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw individuals
            for (const ind of individuals) {
                let color;
                if (ind.genotype === 'AA') color = '#60a5fa';
                else if (ind.genotype === 'Aa') color = '#4ade80';
                else color = '#facc15';

                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(ind.x, ind.y, 4, 0, Math.PI * 2);
                ctx.fill();
            }

            // Legend
            ctx.font = '12px sans-serif';
            ctx.fillStyle = '#60a5fa';
            ctx.fillRect(20, 20, 15, 15);
            ctx.fillStyle = '#fff';
            ctx.fillText('AA', 40, 32);

            ctx.fillStyle = '#4ade80';
            ctx.fillRect(80, 20, 15, 15);
            ctx.fillStyle = '#fff';
            ctx.fillText('Aa', 100, 32);

            ctx.fillStyle = '#facc15';
            ctx.fillRect(140, 20, 15, 15);
            ctx.fillStyle = '#fff';
            ctx.fillText('aa', 160, 32);

            ctx.fillText(`Generation: ${generation}`, canvas.width - 120, 32);
        }

        function drawHistory() {
            hctx.fillStyle = '#0a150a';
            hctx.fillRect(0, 0, histCanvas.width, histCanvas.height);

            // Axes
            hctx.strokeStyle = 'rgba(255,255,255,0.2)';
            hctx.lineWidth = 1;
            hctx.beginPath();
            hctx.moveTo(50, histCanvas.height - 30);
            hctx.lineTo(histCanvas.width - 20, histCanvas.height - 30);
            hctx.moveTo(50, 10);
            hctx.lineTo(50, histCanvas.height - 30);
            hctx.stroke();

            hctx.fillStyle = '#fff';
            hctx.font = '11px sans-serif';
            hctx.fillText('Generation', histCanvas.width / 2, histCanvas.height - 10);
            hctx.fillText('Freq', 10, 20);
            hctx.fillText('1.0', 25, 20);
            hctx.fillText('0', 35, histCanvas.height - 35);

            if (history.length < 2) return;

            const scaleX = (histCanvas.width - 70) / Math.max(history.length, 50);
            const scaleY = histCanvas.height - 50;

            // Draw p (A allele frequency)
            hctx.strokeStyle = '#60a5fa';
            hctx.lineWidth = 2;
            hctx.beginPath();
            history.forEach((h, i) => {
                const x = 50 + i * scaleX;
                const y = histCanvas.height - 30 - h.p * scaleY;
                if (i === 0) hctx.moveTo(x, y);
                else hctx.lineTo(x, y);
            });
            hctx.stroke();

            // Draw q (a allele frequency)
            hctx.strokeStyle = '#facc15';
            hctx.lineWidth = 2;
            hctx.beginPath();
            history.forEach((h, i) => {
                const x = 50 + i * scaleX;
                const y = histCanvas.height - 30 - h.q * scaleY;
                if (i === 0) hctx.moveTo(x, y);
                else hctx.lineTo(x, y);
            });
            hctx.stroke();

            // Legend
            hctx.fillStyle = '#60a5fa';
            hctx.fillText('p (A)', histCanvas.width - 80, 20);
            hctx.fillStyle = '#facc15';
            hctx.fillText('q (a)', histCanvas.width - 80, 35);
        }

        updateP();
        updatePop();
        updateSel();
        resetSim();
    </script>
</body>
</html>
