<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speciation Simulator - Biology & Ecology</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: linear-gradient(135deg, #1a2e1a 0%, #163e16 100%); color: #eee; min-height: 100vh; padding: 20px; }
        .back-link { position: fixed; top: 20px; left: 20px; color: #4ade80; text-decoration: none; font-weight: 600; padding: 8px 16px; background: rgba(0,0,0,0.3); border-radius: 20px; z-index: 100; }
        h1 { text-align: center; margin: 40px 0 10px; font-size: 2.2em; color: #4ade80; }
        .subtitle { text-align: center; opacity: 0.8; margin-bottom: 20px; }
        .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        .panel { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 25px; }
        .info-box { background: rgba(74, 222, 128, 0.1); border: 1px solid rgba(74, 222, 128, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px; font-size: 0.85em; line-height: 1.6; }
        h3 { color: #4ade80; margin-bottom: 15px; }
        canvas { width: 100%; border-radius: 8px; }
        .control-group { margin: 15px 0; }
        .control-group label { display: block; margin-bottom: 5px; }
        .control-group input, .control-group select { width: 100%; }
        .value-display { color: #4ade80; font-family: monospace; }
        button { width: 100%; padding: 12px; margin: 8px 0; border: none; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; }
        .btn-primary { background: #4ade80; color: #1a2e1a; }
        .btn-danger { background: #f87171; color: #fff; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; }
        .species-list { max-height: 120px; overflow-y: auto; font-size: 0.85em; }
        .species-item { display: flex; align-items: center; gap: 8px; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .species-color { width: 16px; height: 16px; border-radius: 50%; }
        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back</a>
    <h1>Speciation Simulator</h1>
    <p class="subtitle">Geographic isolation and reproductive barriers</p>

    <div class="container">
        <div class="panel">
            <canvas id="canvas" width="800" height="500"></canvas>
        </div>

        <div class="panel">
            <div class="info-box">
                <strong>Allopatric Speciation:</strong>
                Geographic barriers (mountains, rivers) isolate populations.
                Over time, genetic drift and different selection pressures
                cause populations to diverge. When they can no longer interbreed,
                they become separate species.
            </div>

            <div class="control-group">
                <label>Mutation Rate: <span class="value-display" id="mutVal">2%</span></label>
                <input type="range" id="mutSlider" min="1" max="10" value="2" oninput="updateParams()">
            </div>

            <div class="control-group">
                <label>Barrier Strength: <span class="value-display" id="barrierVal">80%</span></label>
                <input type="range" id="barrierSlider" min="0" max="100" value="80" oninput="updateParams()">
            </div>

            <div class="control-group">
                <label>Mating Preference: <span class="value-display" id="prefVal">70%</span></label>
                <input type="range" id="prefSlider" min="0" max="100" value="70" oninput="updateParams()">
            </div>

            <div class="control-group">
                <label>Environment:</label>
                <select id="envSelect" onchange="changeEnvironment()">
                    <option value="island">Island Archipelago</option>
                    <option value="mountain">Mountain Range</option>
                    <option value="river">River Barrier</option>
                </select>
            </div>

            <button class="btn-danger" onclick="addBarrier()">Add Barrier</button>
            <button class="btn-primary" onclick="toggleSim()">Start/Stop</button>
            <button class="btn-secondary" onclick="resetSim()">Reset</button>

            <h3 style="margin-top: 15px;">Statistics</h3>
            <div style="font-size: 0.9em;">
                <div style="display: flex; justify-content: space-between; padding: 3px 0;">
                    <span>Generation:</span><span class="value-display" id="genVal">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 3px 0;">
                    <span>Species Count:</span><span class="value-display" id="speciesVal">1</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 3px 0;">
                    <span>Population:</span><span class="value-display" id="popVal">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 3px 0;">
                    <span>Genetic Diversity:</span><span class="value-display" id="divVal">0%</span>
                </div>
            </div>

            <h3 style="margin-top: 15px;">Species</h3>
            <div class="species-list" id="speciesList"></div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let organisms = [];
        let barriers = [];
        let mutationRate = 0.02;
        let barrierStrength = 0.8;
        let matingPreference = 0.7;
        let generation = 0;
        let running = false;
        let environment = 'island';

        // Genetic traits: [trait1, trait2, trait3] each 0-255
        // Species are defined by genetic distance threshold

        function updateParams() {
            mutationRate = parseInt(document.getElementById('mutSlider').value) / 100;
            barrierStrength = parseInt(document.getElementById('barrierSlider').value) / 100;
            matingPreference = parseInt(document.getElementById('prefSlider').value) / 100;

            document.getElementById('mutVal').textContent = Math.round(mutationRate * 100) + '%';
            document.getElementById('barrierVal').textContent = Math.round(barrierStrength * 100) + '%';
            document.getElementById('prefVal').textContent = Math.round(matingPreference * 100) + '%';
        }

        function changeEnvironment() {
            environment = document.getElementById('envSelect').value;
            resetSim();
        }

        function hslToRgb(h, s, l) {
            h /= 360; s /= 100; l /= 100;
            let r, g, b;
            if (s === 0) {
                r = g = b = l;
            } else {
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1/6) return p + (q - p) * 6 * t;
                    if (t < 1/2) return q;
                    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                };
                const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                const p = 2 * l - q;
                r = hue2rgb(p, q, h + 1/3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1/3);
            }
            return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
        }

        function geneticDistance(a, b) {
            const d1 = Math.abs(a.genes[0] - b.genes[0]);
            const d2 = Math.abs(a.genes[1] - b.genes[1]);
            const d3 = Math.abs(a.genes[2] - b.genes[2]);
            return Math.sqrt(d1*d1 + d2*d2 + d3*d3) / 441.67; // Normalize to 0-1
        }

        function canInterbreed(a, b) {
            const dist = geneticDistance(a, b);
            // Higher mating preference = more selective
            const threshold = 0.3 * (1 - matingPreference) + 0.1;
            return dist < threshold;
        }

        function initPopulation() {
            organisms = [];
            const startGenes = [128, 128, 128];

            for (let i = 0; i < 80; i++) {
                organisms.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    vx: (Math.random() - 0.5) * 2,
                    vy: (Math.random() - 0.5) * 2,
                    genes: [...startGenes],
                    age: 0,
                    energy: 100
                });
            }
        }

        function initBarriers() {
            barriers = [];
            if (environment === 'island') {
                // Create islands
                barriers.push({ type: 'water', x: 0, y: 0, w: canvas.width, h: canvas.height });
                // Land masses
            } else if (environment === 'mountain') {
                barriers.push({ type: 'mountain', x: canvas.width/2 - 30, y: 0, w: 60, h: canvas.height });
            } else if (environment === 'river') {
                barriers.push({ type: 'river', x: 0, y: canvas.height/2 - 20, w: canvas.width, h: 40 });
            }
        }

        function addBarrier() {
            const x = canvas.width / 2 - 25 + (Math.random() - 0.5) * 200;
            barriers.push({
                type: 'mountain',
                x: x,
                y: 0,
                w: 50,
                h: canvas.height
            });
        }

        function isBlocked(x, y) {
            for (const b of barriers) {
                if (b.type === 'mountain' || b.type === 'river') {
                    if (x >= b.x && x <= b.x + b.w && y >= b.y && y <= b.y + b.h) {
                        return Math.random() < barrierStrength;
                    }
                }
            }
            return false;
        }

        function updateOrganisms() {
            generation++;

            // Move organisms
            for (const org of organisms) {
                const newX = org.x + org.vx;
                const newY = org.y + org.vy;

                if (!isBlocked(newX, newY)) {
                    org.x = newX;
                    org.y = newY;
                } else {
                    org.vx *= -1;
                    org.vy *= -1;
                }

                // Bounce off edges
                if (org.x < 10 || org.x > canvas.width - 10) org.vx *= -1;
                if (org.y < 10 || org.y > canvas.height - 10) org.vy *= -1;

                org.x = Math.max(10, Math.min(canvas.width - 10, org.x));
                org.y = Math.max(10, Math.min(canvas.height - 10, org.y));

                // Random movement
                if (Math.random() < 0.05) {
                    org.vx = (Math.random() - 0.5) * 2;
                    org.vy = (Math.random() - 0.5) * 2;
                }

                org.age++;
                org.energy -= 0.1;

                // Mutation
                if (Math.random() < mutationRate) {
                    const geneIdx = Math.floor(Math.random() * 3);
                    org.genes[geneIdx] += (Math.random() - 0.5) * 20;
                    org.genes[geneIdx] = Math.max(0, Math.min(255, org.genes[geneIdx]));
                }
            }

            // Reproduction
            const newOrganisms = [];
            for (const org of organisms) {
                if (org.energy > 50 && organisms.length + newOrganisms.length < 150) {
                    // Find nearby mate
                    for (const mate of organisms) {
                        if (mate === org) continue;
                        const dx = org.x - mate.x;
                        const dy = org.y - mate.y;
                        const dist = Math.sqrt(dx*dx + dy*dy);

                        if (dist < 30 && canInterbreed(org, mate) && Math.random() < 0.05) {
                            // Offspring
                            const child = {
                                x: org.x + (Math.random() - 0.5) * 20,
                                y: org.y + (Math.random() - 0.5) * 20,
                                vx: (Math.random() - 0.5) * 2,
                                vy: (Math.random() - 0.5) * 2,
                                genes: [
                                    Math.random() < 0.5 ? org.genes[0] : mate.genes[0],
                                    Math.random() < 0.5 ? org.genes[1] : mate.genes[1],
                                    Math.random() < 0.5 ? org.genes[2] : mate.genes[2]
                                ],
                                age: 0,
                                energy: 100
                            };
                            newOrganisms.push(child);
                            org.energy -= 30;
                            break;
                        }
                    }
                }
            }

            organisms.push(...newOrganisms);

            // Death
            organisms = organisms.filter(org => org.energy > 0 && org.age < 500);

            // Maintain minimum population
            while (organisms.length < 20) {
                const parent = organisms[Math.floor(Math.random() * organisms.length)];
                if (parent) {
                    organisms.push({
                        x: parent.x + (Math.random() - 0.5) * 50,
                        y: parent.y + (Math.random() - 0.5) * 50,
                        vx: (Math.random() - 0.5) * 2,
                        vy: (Math.random() - 0.5) * 2,
                        genes: [...parent.genes],
                        age: 0,
                        energy: 100
                    });
                }
            }

            updateStats();
        }

        function identifySpecies() {
            // Cluster organisms by genetic similarity
            const species = [];
            const assigned = new Set();

            for (let i = 0; i < organisms.length; i++) {
                if (assigned.has(i)) continue;

                const cluster = [organisms[i]];
                assigned.add(i);

                for (let j = i + 1; j < organisms.length; j++) {
                    if (assigned.has(j)) continue;

                    // Check if can interbreed with any in cluster
                    let compatible = false;
                    for (const member of cluster) {
                        if (canInterbreed(organisms[j], member)) {
                            compatible = true;
                            break;
                        }
                    }

                    if (compatible) {
                        cluster.push(organisms[j]);
                        assigned.add(j);
                    }
                }

                species.push(cluster);
            }

            return species;
        }

        function updateStats() {
            const species = identifySpecies();

            document.getElementById('genVal').textContent = generation;
            document.getElementById('speciesVal').textContent = species.length;
            document.getElementById('popVal').textContent = organisms.length;

            // Genetic diversity
            let totalDist = 0;
            let pairs = 0;
            for (let i = 0; i < Math.min(organisms.length, 50); i++) {
                for (let j = i + 1; j < Math.min(organisms.length, 50); j++) {
                    totalDist += geneticDistance(organisms[i], organisms[j]);
                    pairs++;
                }
            }
            const avgDiv = pairs > 0 ? totalDist / pairs : 0;
            document.getElementById('divVal').textContent = Math.round(avgDiv * 100) + '%';

            // Species list
            const listEl = document.getElementById('speciesList');
            listEl.innerHTML = '';
            species.forEach((sp, idx) => {
                const avgGenes = [
                    sp.reduce((s, o) => s + o.genes[0], 0) / sp.length,
                    sp.reduce((s, o) => s + o.genes[1], 0) / sp.length,
                    sp.reduce((s, o) => s + o.genes[2], 0) / sp.length
                ];
                const rgb = avgGenes.map(g => Math.round(g));
                const color = `rgb(${rgb[0]}, ${rgb[1]}, ${rgb[2]})`;

                const item = document.createElement('div');
                item.className = 'species-item';
                item.innerHTML = `
                    <div class="species-color" style="background: ${color}"></div>
                    <span>Species ${idx + 1}: ${sp.length} individuals</span>
                `;
                listEl.appendChild(item);
            });
        }

        function draw() {
            // Background
            ctx.fillStyle = '#1a3a1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw barriers
            for (const b of barriers) {
                if (b.type === 'mountain') {
                    ctx.fillStyle = '#4a3a2a';
                    ctx.fillRect(b.x, b.y, b.w, b.h);
                    // Snow caps
                    ctx.fillStyle = '#ddd';
                    for (let i = 0; i < b.w; i += 20) {
                        ctx.beginPath();
                        ctx.moveTo(b.x + i, 0);
                        ctx.lineTo(b.x + i + 10, 30);
                        ctx.lineTo(b.x + i + 20, 0);
                        ctx.fill();
                    }
                } else if (b.type === 'river') {
                    ctx.fillStyle = '#2a5a8a';
                    ctx.fillRect(b.x, b.y, b.w, b.h);
                }
            }

            // Draw organisms
            const species = identifySpecies();
            const speciesColors = new Map();
            species.forEach((sp, idx) => {
                sp.forEach(org => speciesColors.set(org, idx));
            });

            for (const org of organisms) {
                const r = org.genes[0];
                const g = org.genes[1];
                const b = org.genes[2];

                ctx.fillStyle = `rgb(${Math.round(r)}, ${Math.round(g)}, ${Math.round(b)})`;
                ctx.beginPath();
                ctx.arc(org.x, org.y, 6, 0, Math.PI * 2);
                ctx.fill();

                ctx.strokeStyle = 'rgba(255,255,255,0.3)';
                ctx.lineWidth = 1;
                ctx.stroke();
            }

            // Info
            ctx.fillStyle = '#4ade80';
            ctx.font = '14px sans-serif';
            ctx.fillText(`Generation: ${generation}  |  Species: ${species.length}  |  Pop: ${organisms.length}`, 15, 25);
        }

        function toggleSim() {
            running = !running;
            if (running) animate();
        }

        function resetSim() {
            running = false;
            generation = 0;
            initPopulation();
            initBarriers();
            updateStats();
            draw();
        }

        function animate() {
            if (!running) return;
            updateOrganisms();
            draw();
            requestAnimationFrame(animate);
        }

        updateParams();
        resetSim();
    </script>
</body>
</html>
