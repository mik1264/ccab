<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genetic Drift - Biology & Ecology</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: linear-gradient(135deg, #1a2e1a 0%, #163e16 100%); color: #eee; min-height: 100vh; padding: 20px; }
        .back-link { position: fixed; top: 20px; left: 20px; color: #4ade80; text-decoration: none; font-weight: 600; padding: 8px 16px; background: rgba(0,0,0,0.3); border-radius: 20px; z-index: 100; }
        h1 { text-align: center; margin: 40px 0 10px; font-size: 2.2em; color: #4ade80; }
        .subtitle { text-align: center; opacity: 0.8; margin-bottom: 20px; }
        .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        .panel { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 25px; }
        .info-box { background: rgba(74, 222, 128, 0.1); border: 1px solid rgba(74, 222, 128, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px; font-size: 0.85em; line-height: 1.6; }
        h3 { color: #4ade80; margin-bottom: 15px; }
        canvas { width: 100%; border-radius: 8px; background: #0a150a; }
        .control-group { margin: 15px 0; }
        .control-group label { display: block; margin-bottom: 5px; }
        .control-group input, .control-group select { width: 100%; }
        .value-display { color: #4ade80; font-family: monospace; }
        button { width: 100%; padding: 12px; margin: 8px 0; border: none; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; }
        .btn-primary { background: #4ade80; color: #1a2e1a; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; }
        .allele-bar { display: flex; height: 30px; border-radius: 8px; overflow: hidden; margin: 15px 0; }
        .allele-a { background: #60a5fa; transition: width 0.3s; display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .allele-b { background: #f87171; transition: width 0.3s; display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .legend { display: flex; gap: 15px; margin: 10px 0; font-size: 0.85em; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .legend-dot { width: 12px; height: 12px; border-radius: 50%; }
        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back</a>
    <h1>Genetic Drift</h1>
    <p class="subtitle">Random allele frequency changes in finite populations</p>

    <div class="container">
        <div class="panel">
            <canvas id="canvas" width="800" height="400"></canvas>
            <canvas id="historyCanvas" width="800" height="150" style="margin-top: 15px;"></canvas>
        </div>

        <div class="panel">
            <div class="info-box">
                <strong>Genetic Drift:</strong>
                Random sampling of alleles in reproduction causes allele frequencies
                to fluctuate, especially in small populations. This can lead to
                <em>fixation</em> (100%) or <em>loss</em> (0%) of alleles by chance alone.
            </div>

            <h3>Allele Frequencies</h3>
            <div class="allele-bar">
                <div class="allele-a" id="aBar" style="width: 50%;">A</div>
                <div class="allele-b" id="bBar" style="width: 50%;">B</div>
            </div>

            <div class="legend">
                <div class="legend-item"><div class="legend-dot" style="background: #60a5fa;"></div> Allele A</div>
                <div class="legend-item"><div class="legend-dot" style="background: #f87171;"></div> Allele B</div>
            </div>

            <div class="control-group">
                <label>Population Size: <span class="value-display" id="popVal">20</span></label>
                <input type="range" id="popSlider" min="10" max="200" value="20" oninput="updateParams()">
            </div>

            <div class="control-group">
                <label>Initial A Frequency: <span class="value-display" id="freqVal">50%</span></label>
                <input type="range" id="freqSlider" min="10" max="90" value="50" oninput="updateParams()">
            </div>

            <div class="control-group">
                <label>Simulation Speed: <span class="value-display" id="speedVal">5</span> gen/sec</label>
                <input type="range" id="speedSlider" min="1" max="20" value="5" oninput="updateParams()">
            </div>

            <button class="btn-primary" onclick="toggleSim()">Start/Stop</button>
            <button class="btn-secondary" onclick="resetSim()">Reset</button>
            <button class="btn-secondary" onclick="runMultiple()">Run 10 Trials</button>

            <h3 style="margin-top: 15px;">Statistics</h3>
            <div style="font-size: 0.9em;">
                <div style="display: flex; justify-content: space-between; padding: 3px 0;">
                    <span>Generation:</span><span class="value-display" id="genVal">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 3px 0;">
                    <span>A Frequency:</span><span class="value-display" id="freqAVal">50%</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 3px 0;">
                    <span>Status:</span><span class="value-display" id="statusVal">Drifting</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 3px 0;">
                    <span>Trials Fixed A:</span><span class="value-display" id="fixedAVal">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 3px 0;">
                    <span>Trials Fixed B:</span><span class="value-display" id="fixedBVal">0</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const histCanvas = document.getElementById('historyCanvas');
        const hctx = histCanvas.getContext('2d');

        let population = [];
        let popSize = 20;
        let initialFreqA = 0.5;
        let speed = 5;
        let generation = 0;
        let running = false;
        let history = [];
        let allTrials = [];
        let fixedA = 0, fixedB = 0;
        let lastUpdate = 0;

        function updateParams() {
            popSize = parseInt(document.getElementById('popSlider').value);
            initialFreqA = parseInt(document.getElementById('freqSlider').value) / 100;
            speed = parseInt(document.getElementById('speedSlider').value);

            document.getElementById('popVal').textContent = popSize;
            document.getElementById('freqVal').textContent = Math.round(initialFreqA * 100) + '%';
            document.getElementById('speedVal').textContent = speed;
        }

        function initPopulation() {
            population = [];
            const numA = Math.round(popSize * initialFreqA);

            for (let i = 0; i < popSize; i++) {
                population.push({
                    allele: i < numA ? 'A' : 'B',
                    x: Math.random() * (canvas.width - 40) + 20,
                    y: Math.random() * (canvas.height - 40) + 20,
                    vx: (Math.random() - 0.5) * 2,
                    vy: (Math.random() - 0.5) * 2
                });
            }
            // Shuffle
            for (let i = population.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [population[i].allele, population[j].allele] = [population[j].allele, population[i].allele];
            }
        }

        function nextGeneration() {
            // Sample with replacement (Wright-Fisher model)
            const freqA = population.filter(p => p.allele === 'A').length / population.length;

            for (const individual of population) {
                individual.allele = Math.random() < freqA ? 'A' : 'B';
            }

            generation++;

            // Record history
            const currentFreq = population.filter(p => p.allele === 'A').length / population.length;
            history.push(currentFreq);
            if (history.length > 200) history.shift();

            updateDisplay();

            // Check for fixation
            if (currentFreq === 0 || currentFreq === 1) {
                running = false;
                document.getElementById('statusVal').textContent = currentFreq === 1 ? 'Fixed A!' : 'Fixed B!';
            }
        }

        function updateDisplay() {
            const freqA = population.filter(p => p.allele === 'A').length / population.length;
            const freqB = 1 - freqA;

            document.getElementById('aBar').style.width = (freqA * 100) + '%';
            document.getElementById('bBar').style.width = (freqB * 100) + '%';
            document.getElementById('genVal').textContent = generation;
            document.getElementById('freqAVal').textContent = Math.round(freqA * 100) + '%';
            document.getElementById('fixedAVal').textContent = fixedA;
            document.getElementById('fixedBVal').textContent = fixedB;

            if (freqA > 0 && freqA < 1) {
                document.getElementById('statusVal').textContent = 'Drifting';
            }
        }

        function draw() {
            ctx.fillStyle = '#0a150a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw population
            for (const ind of population) {
                // Move randomly
                ind.x += ind.vx;
                ind.y += ind.vy;

                // Bounce
                if (ind.x < 15 || ind.x > canvas.width - 15) ind.vx *= -1;
                if (ind.y < 15 || ind.y > canvas.height - 15) ind.vy *= -1;

                ind.x = Math.max(15, Math.min(canvas.width - 15, ind.x));
                ind.y = Math.max(15, Math.min(canvas.height - 15, ind.y));

                // Random movement changes
                if (Math.random() < 0.02) {
                    ind.vx = (Math.random() - 0.5) * 2;
                    ind.vy = (Math.random() - 0.5) * 2;
                }

                // Draw
                ctx.fillStyle = ind.allele === 'A' ? '#60a5fa' : '#f87171';
                ctx.beginPath();
                ctx.arc(ind.x, ind.y, 8, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = '#fff';
                ctx.font = 'bold 10px sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(ind.allele, ind.x, ind.y);
            }

            // Population info
            ctx.fillStyle = '#4ade80';
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText(`N = ${popSize}  |  Generation: ${generation}`, 15, 25);
        }

        function drawHistory() {
            hctx.fillStyle = '#0a150a';
            hctx.fillRect(0, 0, histCanvas.width, histCanvas.height);

            if (history.length < 2 && allTrials.length === 0) return;

            const scaleX = (histCanvas.width - 60) / Math.max(history.length, 50);
            const scaleY = histCanvas.height - 40;

            // Draw previous trials
            for (const trial of allTrials) {
                hctx.strokeStyle = 'rgba(74, 222, 128, 0.2)';
                hctx.lineWidth = 1;
                hctx.beginPath();
                trial.forEach((freq, i) => {
                    const x = 50 + i * scaleX;
                    const y = 20 + (1 - freq) * scaleY;
                    if (i === 0) hctx.moveTo(x, y);
                    else hctx.lineTo(x, y);
                });
                hctx.stroke();
            }

            // Draw current trial
            if (history.length >= 2) {
                hctx.strokeStyle = '#60a5fa';
                hctx.lineWidth = 2;
                hctx.beginPath();
                history.forEach((freq, i) => {
                    const x = 50 + i * scaleX;
                    const y = 20 + (1 - freq) * scaleY;
                    if (i === 0) hctx.moveTo(x, y);
                    else hctx.lineTo(x, y);
                });
                hctx.stroke();
            }

            // Axes
            hctx.strokeStyle = 'rgba(255,255,255,0.3)';
            hctx.lineWidth = 1;
            hctx.beginPath();
            hctx.moveTo(50, 20);
            hctx.lineTo(50, histCanvas.height - 20);
            hctx.lineTo(histCanvas.width - 10, histCanvas.height - 20);
            hctx.stroke();

            // Labels
            hctx.fillStyle = '#fff';
            hctx.font = '11px sans-serif';
            hctx.textAlign = 'right';
            hctx.fillText('100%', 45, 25);
            hctx.fillText('50%', 45, histCanvas.height / 2);
            hctx.fillText('0%', 45, histCanvas.height - 20);

            hctx.textAlign = 'center';
            hctx.fillText('Generations', histCanvas.width / 2, histCanvas.height - 5);

            // Fixation lines
            hctx.strokeStyle = 'rgba(74, 222, 128, 0.3)';
            hctx.setLineDash([5, 5]);
            hctx.beginPath();
            hctx.moveTo(50, 20 + scaleY * 0.5);
            hctx.lineTo(histCanvas.width - 10, 20 + scaleY * 0.5);
            hctx.stroke();
            hctx.setLineDash([]);
        }

        function toggleSim() {
            running = !running;
            if (running) animate();
        }

        function resetSim() {
            running = false;
            generation = 0;
            history = [];
            initPopulation();
            updateDisplay();
            draw();
            drawHistory();
        }

        function runMultiple() {
            running = false;
            allTrials = [];
            fixedA = 0;
            fixedB = 0;

            for (let trial = 0; trial < 10; trial++) {
                initPopulation();
                const trialHistory = [initialFreqA];
                let freq = initialFreqA;

                while (freq > 0 && freq < 1 && trialHistory.length < 500) {
                    // Wright-Fisher sampling
                    let countA = 0;
                    for (let i = 0; i < popSize; i++) {
                        if (Math.random() < freq) countA++;
                    }
                    freq = countA / popSize;
                    trialHistory.push(freq);
                }

                if (freq === 1) fixedA++;
                else if (freq === 0) fixedB++;

                allTrials.push(trialHistory);
            }

            // Reset to show final state
            generation = 0;
            history = [];
            initPopulation();
            updateDisplay();
            draw();
            drawHistory();

            document.getElementById('statusVal').textContent = '10 trials complete';
        }

        function animate(timestamp) {
            if (!running) return;

            const interval = 1000 / speed;
            if (timestamp - lastUpdate >= interval) {
                nextGeneration();
                lastUpdate = timestamp;
            }

            draw();
            drawHistory();
            requestAnimationFrame(animate);
        }

        updateParams();
        resetSim();
    </script>
</body>
</html>
