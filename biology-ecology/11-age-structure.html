<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Age-Structured Population - Biology & Ecology</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: linear-gradient(135deg, #1a2e1a 0%, #163e16 100%); color: #eee; min-height: 100vh; padding: 20px; }
        .back-link { position: fixed; top: 20px; left: 20px; color: #4ade80; text-decoration: none; font-weight: 600; padding: 8px 16px; background: rgba(0,0,0,0.3); border-radius: 20px; z-index: 100; }
        h1 { text-align: center; margin: 40px 0 10px; font-size: 2.2em; color: #4ade80; }
        .subtitle { text-align: center; opacity: 0.8; margin-bottom: 20px; }
        .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        .panel { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 25px; }
        .info-box { background: rgba(74, 222, 128, 0.1); border: 1px solid rgba(74, 222, 128, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px; font-size: 0.85em; line-height: 1.6; }
        h3 { color: #4ade80; margin-bottom: 15px; }
        canvas { width: 100%; border-radius: 8px; }
        .control-group { margin: 15px 0; }
        .control-group label { display: block; margin-bottom: 5px; }
        .control-group input, .control-group select { width: 100%; }
        .value-display { color: #4ade80; font-family: monospace; }
        button { width: 100%; padding: 12px; margin: 8px 0; border: none; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; }
        .btn-primary { background: #4ade80; color: #1a2e1a; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; }
        .pyramid-label { font-size: 0.75em; padding: 2px 5px; }
        .matrix-display { font-family: monospace; font-size: 0.75em; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; overflow-x: auto; }
        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back</a>
    <h1>Age-Structured Population</h1>
    <p class="subtitle">Leslie matrix and demographic modeling</p>

    <div class="container">
        <div class="panel">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <canvas id="pyramidCanvas" width="350" height="400"></canvas>
                <canvas id="chartCanvas" width="350" height="400"></canvas>
            </div>
        </div>

        <div class="panel">
            <div class="info-box">
                <strong>Leslie Matrix:</strong>
                A mathematical model tracking population by age classes.
                The first row contains <em>fecundity</em> (birth rates),
                and the sub-diagonal contains <em>survival</em> rates.
                Population pyramids reveal growth patterns.
            </div>

            <div class="control-group">
                <label>Population Type:</label>
                <select id="typeSelect" onchange="changeType()">
                    <option value="growing">Growing (Expansive)</option>
                    <option value="stable">Stable (Stationary)</option>
                    <option value="declining">Declining (Constrictive)</option>
                    <option value="custom">Custom Parameters</option>
                </select>
            </div>

            <div class="control-group">
                <label>Juvenile Survival: <span class="value-display" id="s1Val">80%</span></label>
                <input type="range" id="s1Slider" min="30" max="99" value="80" oninput="updateParams()">
            </div>

            <div class="control-group">
                <label>Adult Survival: <span class="value-display" id="s2Val">70%</span></label>
                <input type="range" id="s2Slider" min="30" max="99" value="70" oninput="updateParams()">
            </div>

            <div class="control-group">
                <label>Senior Survival: <span class="value-display" id="s3Val">40%</span></label>
                <input type="range" id="s3Slider" min="10" max="80" value="40" oninput="updateParams()">
            </div>

            <div class="control-group">
                <label>Adult Fecundity: <span class="value-display" id="f2Val">1.5</span></label>
                <input type="range" id="f2Slider" min="0" max="40" value="15" oninput="updateParams()">
            </div>

            <div class="control-group">
                <label>Senior Fecundity: <span class="value-display" id="f3Val">0.5</span></label>
                <input type="range" id="f3Slider" min="0" max="20" value="5" oninput="updateParams()">
            </div>

            <button class="btn-primary" onclick="toggleSim()">Start/Stop</button>
            <button class="btn-secondary" onclick="resetSim()">Reset</button>

            <h3 style="margin-top: 15px;">Leslie Matrix</h3>
            <div class="matrix-display" id="matrixDisplay">
                [0.0, 1.5, 0.5]<br>
                [0.8, 0.0, 0.0]<br>
                [0.0, 0.7, 0.4]
            </div>

            <h3 style="margin-top: 15px;">Statistics</h3>
            <div style="font-size: 0.9em;">
                <div style="display: flex; justify-content: space-between; padding: 3px 0;">
                    <span>Generation:</span><span class="value-display" id="genVal">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 3px 0;">
                    <span>Total Population:</span><span class="value-display" id="totalVal">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 3px 0;">
                    <span>Growth Rate (λ):</span><span class="value-display" id="lambdaVal">1.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 3px 0;">
                    <span>Doubling Time:</span><span class="value-display" id="doublingVal">∞</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 3px 0;">
                    <span>Dependency Ratio:</span><span class="value-display" id="depVal">0%</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const pyramidCanvas = document.getElementById('pyramidCanvas');
        const pctx = pyramidCanvas.getContext('2d');
        const chartCanvas = document.getElementById('chartCanvas');
        const cctx = chartCanvas.getContext('2d');

        // Age classes: Juvenile (0-14), Young Adult (15-34), Adult (35-54), Senior (55+)
        const ageClasses = ['0-14', '15-34', '35-54', '55+'];
        const classColors = ['#60a5fa', '#4ade80', '#facc15', '#f87171'];

        let population = [100, 80, 60, 30]; // Initial population by age class
        let survival = [0.8, 0.7, 0.6, 0.4]; // Survival rates
        let fecundity = [0, 1.5, 0.8, 0.2]; // Birth rates
        let generation = 0;
        let running = false;
        let history = [];

        function updateParams() {
            survival[0] = parseInt(document.getElementById('s1Slider').value) / 100;
            survival[1] = parseInt(document.getElementById('s2Slider').value) / 100;
            survival[2] = parseInt(document.getElementById('s3Slider').value) / 100;
            fecundity[1] = parseInt(document.getElementById('f2Slider').value) / 10;
            fecundity[2] = parseInt(document.getElementById('f3Slider').value) / 10;

            document.getElementById('s1Val').textContent = Math.round(survival[0] * 100) + '%';
            document.getElementById('s2Val').textContent = Math.round(survival[1] * 100) + '%';
            document.getElementById('s3Val').textContent = Math.round(survival[2] * 100) + '%';
            document.getElementById('f2Val').textContent = fecundity[1].toFixed(1);
            document.getElementById('f3Val').textContent = fecundity[2].toFixed(1);

            updateMatrixDisplay();
        }

        function changeType() {
            const type = document.getElementById('typeSelect').value;

            if (type === 'growing') {
                survival = [0.9, 0.85, 0.7, 0.4];
                fecundity = [0, 2.5, 1.2, 0.3];
                population = [150, 100, 60, 20];
            } else if (type === 'stable') {
                survival = [0.75, 0.7, 0.6, 0.4];
                fecundity = [0, 1.2, 0.6, 0.1];
                population = [80, 80, 70, 50];
            } else if (type === 'declining') {
                survival = [0.6, 0.65, 0.6, 0.5];
                fecundity = [0, 0.8, 0.4, 0.1];
                population = [40, 60, 80, 100];
            }

            // Update sliders
            document.getElementById('s1Slider').value = survival[0] * 100;
            document.getElementById('s2Slider').value = survival[1] * 100;
            document.getElementById('s3Slider').value = survival[2] * 100;
            document.getElementById('f2Slider').value = fecundity[1] * 10;
            document.getElementById('f3Slider').value = fecundity[2] * 10;

            updateParams();
            generation = 0;
            history = [];
            updateStats();
            draw();
        }

        function updateMatrixDisplay() {
            const matrix = `[${fecundity[0].toFixed(1)}, ${fecundity[1].toFixed(1)}, ${fecundity[2].toFixed(1)}, ${fecundity[3] ? fecundity[3].toFixed(1) : '0.0'}]<br>` +
                          `[${survival[0].toFixed(1)}, 0.0, 0.0, 0.0]<br>` +
                          `[0.0, ${survival[1].toFixed(1)}, 0.0, 0.0]<br>` +
                          `[0.0, 0.0, ${survival[2].toFixed(1)}, ${survival[3].toFixed(1)}]`;
            document.getElementById('matrixDisplay').innerHTML = matrix;
        }

        function applyLeslieMatrix() {
            const newPop = new Array(4).fill(0);

            // Births (from all reproductive age classes)
            newPop[0] = fecundity[1] * population[1] + fecundity[2] * population[2] + (fecundity[3] || 0) * population[3];

            // Aging with survival
            newPop[1] = survival[0] * population[0];
            newPop[2] = survival[1] * population[1];
            newPop[3] = survival[2] * population[2] + survival[3] * population[3];

            population = newPop;
            generation++;

            // Record history
            const total = population.reduce((a, b) => a + b, 0);
            history.push({
                gen: generation,
                pop: [...population],
                total: total
            });
            if (history.length > 100) history.shift();

            updateStats();
        }

        function updateStats() {
            const total = population.reduce((a, b) => a + b, 0);

            // Calculate growth rate (lambda) from recent history
            let lambda = 1;
            if (history.length >= 2) {
                const recent = history.slice(-10);
                if (recent.length >= 2) {
                    lambda = Math.pow(recent[recent.length-1].total / recent[0].total, 1 / recent.length);
                }
            }

            // Doubling time
            const doublingTime = lambda > 1 ? Math.log(2) / Math.log(lambda) : Infinity;

            // Dependency ratio (young + old) / working age
            const dependents = population[0] + population[3];
            const working = population[1] + population[2];
            const depRatio = working > 0 ? (dependents / working) * 100 : 0;

            document.getElementById('genVal').textContent = generation;
            document.getElementById('totalVal').textContent = Math.round(total);
            document.getElementById('lambdaVal').textContent = lambda.toFixed(3);
            document.getElementById('doublingVal').textContent = doublingTime === Infinity ? '∞' : doublingTime.toFixed(1) + ' gen';
            document.getElementById('depVal').textContent = depRatio.toFixed(0) + '%';
        }

        function drawPyramid() {
            pctx.fillStyle = '#0a150a';
            pctx.fillRect(0, 0, pyramidCanvas.width, pyramidCanvas.height);

            const total = Math.max(1, population.reduce((a, b) => a + b, 0));
            const maxBar = pyramidCanvas.width * 0.35;
            const barHeight = 60;
            const centerX = pyramidCanvas.width / 2;
            const startY = 80;

            // Title
            pctx.fillStyle = '#4ade80';
            pctx.font = 'bold 16px sans-serif';
            pctx.textAlign = 'center';
            pctx.fillText('Population Pyramid', centerX, 30);
            pctx.font = '12px sans-serif';
            pctx.fillStyle = '#aaa';
            pctx.fillText(`Gen ${generation}  |  Total: ${Math.round(total)}`, centerX, 50);

            // Draw bars
            for (let i = ageClasses.length - 1; i >= 0; i--) {
                const y = startY + (3 - i) * (barHeight + 10);
                const pct = population[i] / total;
                const barWidth = pct * maxBar * 4; // Scale for visibility

                // Bar
                pctx.fillStyle = classColors[i];
                pctx.fillRect(centerX - barWidth / 2, y, barWidth, barHeight);

                // Border
                pctx.strokeStyle = 'rgba(255,255,255,0.3)';
                pctx.strokeRect(centerX - barWidth / 2, y, barWidth, barHeight);

                // Label
                pctx.fillStyle = '#fff';
                pctx.font = '12px sans-serif';
                pctx.textAlign = 'right';
                pctx.fillText(ageClasses[i], centerX - maxBar - 10, y + barHeight / 2 + 4);

                // Count
                pctx.textAlign = 'left';
                pctx.fillText(Math.round(population[i]), centerX + maxBar + 10, y + barHeight / 2 + 4);

                // Percentage
                pctx.textAlign = 'center';
                pctx.fillStyle = 'rgba(0,0,0,0.7)';
                if (barWidth > 30) {
                    pctx.fillText((pct * 100).toFixed(1) + '%', centerX, y + barHeight / 2 + 4);
                }
            }

            // Axis
            pctx.strokeStyle = 'rgba(255,255,255,0.3)';
            pctx.beginPath();
            pctx.moveTo(centerX, startY - 10);
            pctx.lineTo(centerX, startY + 4 * (barHeight + 10));
            pctx.stroke();
        }

        function drawChart() {
            cctx.fillStyle = '#0a150a';
            cctx.fillRect(0, 0, chartCanvas.width, chartCanvas.height);

            // Title
            cctx.fillStyle = '#4ade80';
            cctx.font = 'bold 16px sans-serif';
            cctx.textAlign = 'center';
            cctx.fillText('Population Over Time', chartCanvas.width / 2, 30);

            if (history.length < 2) {
                cctx.fillStyle = '#666';
                cctx.font = '14px sans-serif';
                cctx.fillText('Start simulation to see history', chartCanvas.width / 2, chartCanvas.height / 2);
                return;
            }

            const maxPop = Math.max(...history.map(h => h.total)) * 1.1;
            const scaleX = (chartCanvas.width - 70) / Math.max(history.length, 20);
            const scaleY = (chartCanvas.height - 100) / maxPop;
            const startX = 50;
            const startY = chartCanvas.height - 50;

            // Stacked area chart
            for (let classIdx = 3; classIdx >= 0; classIdx--) {
                cctx.fillStyle = classColors[classIdx] + '80';
                cctx.beginPath();
                cctx.moveTo(startX, startY);

                history.forEach((h, i) => {
                    const x = startX + i * scaleX;
                    let cumulative = 0;
                    for (let j = 0; j <= classIdx; j++) {
                        cumulative += h.pop[j];
                    }
                    const y = startY - cumulative * scaleY;
                    cctx.lineTo(x, y);
                });

                // Close path
                cctx.lineTo(startX + (history.length - 1) * scaleX, startY);
                cctx.closePath();
                cctx.fill();
            }

            // Total population line
            cctx.strokeStyle = '#fff';
            cctx.lineWidth = 2;
            cctx.beginPath();
            history.forEach((h, i) => {
                const x = startX + i * scaleX;
                const y = startY - h.total * scaleY;
                if (i === 0) cctx.moveTo(x, y);
                else cctx.lineTo(x, y);
            });
            cctx.stroke();

            // Axes
            cctx.strokeStyle = 'rgba(255,255,255,0.3)';
            cctx.lineWidth = 1;
            cctx.beginPath();
            cctx.moveTo(startX, 50);
            cctx.lineTo(startX, startY);
            cctx.lineTo(chartCanvas.width - 20, startY);
            cctx.stroke();

            // Labels
            cctx.fillStyle = '#aaa';
            cctx.font = '11px sans-serif';
            cctx.textAlign = 'center';
            cctx.fillText('Generation', chartCanvas.width / 2, chartCanvas.height - 10);

            cctx.save();
            cctx.translate(15, chartCanvas.height / 2);
            cctx.rotate(-Math.PI / 2);
            cctx.fillText('Population', 0, 0);
            cctx.restore();

            // Legend
            const legendY = 55;
            for (let i = 0; i < 4; i++) {
                cctx.fillStyle = classColors[i];
                cctx.fillRect(startX + i * 70, legendY, 12, 12);
                cctx.fillStyle = '#fff';
                cctx.font = '10px sans-serif';
                cctx.textAlign = 'left';
                cctx.fillText(ageClasses[i], startX + i * 70 + 15, legendY + 10);
            }
        }

        function draw() {
            drawPyramid();
            drawChart();
        }

        function toggleSim() {
            running = !running;
            if (running) animate();
        }

        function resetSim() {
            running = false;
            generation = 0;
            history = [];
            changeType();
        }

        let lastUpdate = 0;
        function animate(timestamp) {
            if (!running) return;

            if (timestamp - lastUpdate > 500) {
                applyLeslieMatrix();
                draw();
                lastUpdate = timestamp;
            }

            requestAnimationFrame(animate);
        }

        updateParams();
        changeType();
    </script>
</body>
</html>
