<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quaternions - CCAB</title>
    <link rel="stylesheet" href="../assets/css/gallery-standard.css">
    <style>
        body {
            background: #111;
            color: #ddd;
            font-family: system-ui;
            padding: 2rem;
            text-align: center;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        
        .view {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        canvas {
            background: #000;
            border: 1px solid #333;
            border-radius: 8px;
        }
        
        .controls {
            background: #222;
            padding: 20px;
            border-radius: 8px;
            text-align: left;
        }
        
        .quat-input {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }
        
        input {
            width: 100%;
            background: #333;
            border: 1px solid #555;
            color: white;
            padding: 5px;
            text-align: center;
        }
        
        .math-disp {
            font-family: monospace;
            font-size: 1.2rem;
            color: #fcd34d;
            margin-top: 10px;
        }
        
    </style>
</head>
<body>

<div class="container">
    <a href="../index.html" class="gallery-back">‚Üê Back to Gallery</a>
    <h1>Quaternion Rotation</h1>
    <p>Avoiding Gimbal Lock. \( q = w + xi + yj + zk \). Rotation by angle \(\theta\) around axis \( \mathbf{u} \): \( q = \cos(\theta/2) + \mathbf{u} \sin(\theta/2) \)</p>
    
    <div class="view">
        <div>
            <h3>3D Object (Rotate via Q)</h3>
            <canvas id="canvas-obj" width="400" height="400"></canvas>
        </div>
        <div>
            <h3>Quaternion Space (4D projected)</h3>
            <canvas id="canvas-q" width="400" height="400"></canvas>
        </div>
    </div>
    
    <div class="controls">
        <label>Current Quaternion (Normalized):</label>
        <div class="quat-input">
            <div>w: <span id="w-val">1.00</span></div>
            <div>x: <span id="x-val">0.00</span></div>
            <div>y: <span id="y-val">0.00</span></div>
            <div>z: <span id="z-val">0.00</span></div>
        </div>
        
        <button onclick="rotate('x', 0.1)">Rotate X +</button>
        <button onclick="rotate('y', 0.1)">Rotate Y +</button>
        <button onclick="rotate('z', 0.1)">Rotate Z +</button>
        <button onclick="reset()">Reset</button>
        
        <div class="math-disp" id="formula"></div>
    </div>
</div>

<script>
    const cvsObj = document.getElementById('canvas-obj');
    const ctxObj = cvsObj.getContext('2d');
    const cvsQ = document.getElementById('canvas-q');
    const ctxQ = cvsQ.getContext('2d');
    
    // Quaternion
    let q = { w: 1, x: 0, y: 0, z: 0 };
    
    // Cube Vertices
    const cube = [
        {x:-1, y:-1, z:-1}, {x:1, y:-1, z:-1}, {x:1, y:1, z:-1}, {x:-1, y:1, z:-1},
        {x:-1, y:-1, z:1}, {x:1, y:-1, z:1}, {x:1, y:1, z:1}, {x:-1, y:1, z:1}
    ];
    
    // Edges
    const edges = [
        [0,1], [1,2], [2,3], [3,0],
        [4,5], [5,6], [6,7], [7,4],
        [0,4], [1,5], [2,6], [3,7]
    ];
    
    function reset() {
        q = { w: 1, x: 0, y: 0, z: 0 };
        draw();
    }
    
    function rotate(axis, angle) {
        // Create rotation quaternion dq
        const half = angle / 2;
        const sin = Math.sin(half);
        const dq = {
            w: Math.cos(half),
            x: axis === 'x' ? sin : 0,
            y: axis === 'y' ? sin : 0,
            z: axis === 'z' ? sin : 0
        };
        
        // Multiply: q_new = q * dq (local) or dq * q (global)
        q = multiply(q, dq); // Local rotation
        normalize(q);
        
        draw();
    }
    
    function multiply(a, b) {
        return {
            w: a.w*b.w - a.x*b.x - a.y*b.y - a.z*b.z,
            x: a.w*b.x + a.x*b.w + a.y*b.z - a.z*b.y,
            y: a.w*b.y - a.x*b.z + a.y*b.w + a.z*b.x,
            z: a.w*b.z + a.x*b.y - a.y*b.x + a.z*b.w
        };
    }
    
    function normalize(q) {
        const len = Math.sqrt(q.w*q.w + q.x*q.x + q.y*q.y + q.z*q.z);
        q.w /= len; q.x /= len; q.y /= len; q.z /= len;
    }
    
    function rotatePoint(p, q) {
        // v' = q * v * q_conj
        // Vector v as pure quaternion (0, x, y, z)
        const v = { w: 0, x: p.x, y: p.y, z: p.z };
        const q_conj = { w: q.w, x: -q.x, y: -q.y, z: -q.z };
        
        const prime = multiply(multiply(q, v), q_conj);
        return { x: prime.x, y: prime.y, z: prime.z };
    }
    
    function draw() {
        // Update UI
        document.getElementById('w-val').textContent = q.w.toFixed(2);
        document.getElementById('x-val').textContent = q.x.toFixed(2);
        document.getElementById('y-val').textContent = q.y.toFixed(2);
        document.getElementById('z-val').textContent = q.z.toFixed(2);
        
        // 1. Draw Object
        ctxObj.clearRect(0, 0, 400, 400);
        ctxObj.strokeStyle = '#3b82f6';
        ctxObj.lineWidth = 2;
        
        const projCube = cube.map(v => {
            const rot = rotatePoint(v, q);
            const scale = 300 / (4 + rot.z);
            return {
                x: 200 + rot.x * scale * 100,
                y: 200 - rot.y * scale * 100
            };
        });
        
        ctxObj.beginPath();
        edges.forEach(e => {
            ctxObj.moveTo(projCube[e[0]].x, projCube[e[0]].y);
            ctxObj.lineTo(projCube[e[1]].x, projCube[e[1]].y);
        });
        ctxObj.stroke();
        
        // 2. Draw Quaternion Hypersphere (Projected)
        // 4D sphere projected to 3D ball, then 2D
        // Just visualize (x,y,z) vector with length = 1-w?
        // Or simple: Draw the vector (x,y,z) scaled by 100.
        // Color depends on w.
        
        ctxQ.clearRect(0, 0, 400, 400);
        
        // Axes
        ctxQ.strokeStyle = '#555';
        ctxQ.beginPath(); 
        ctxQ.moveTo(200, 200); ctxQ.lineTo(300, 200); // X
        ctxQ.moveTo(200, 200); ctxQ.lineTo(200, 100); // Y
        ctxQ.moveTo(200, 200); ctxQ.lineTo(150, 250); // Z
        ctxQ.stroke();
        
        ctxQ.fillStyle = `rgba(255, 255, 255, ${Math.abs(q.w)})`;
        ctxQ.beginPath();
        
        // Simple projection of (x,y,z) part
        const qx = 200 + q.x * 100 - q.z * 50;
        const qy = 200 - q.y * 100 + q.z * 50;
        
        ctxQ.arc(qx, qy, 10, 0, Math.PI*2);
        ctxQ.fill();
        ctxQ.fillStyle = '#fff';
        ctxQ.fillText(`Vector Part (x,y,z)`, qx+15, qy);
    }
    
    // Auto rotate
    let auto = true;
    function loop() {
        if (auto) rotate('x', 0.01);
        rotate('y', 0.01);
        requestAnimationFrame(loop);
    }
    loop();

</script>
</body>
</html>