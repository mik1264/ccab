<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stadium Mexican Wave</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0a0e1a; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        canvas { display: block; }
        .back-link {
            position: fixed; top: 20px; left: 20px; z-index: 100;
            color: #8A9A5B; background: rgba(10,14,26,0.8); border-radius: 25px;
            border: 2px solid #8A9A5B; padding: 10px 20px; text-decoration: none;
            font-size: 14px; transition: all 0.3s ease;
        }
        .back-link:hover { background: rgba(138,154,91,0.3); }
        .controls {
            position: fixed; top: 20px; right: 20px; z-index: 100;
            background: rgba(10,14,26,0.85); backdrop-filter: blur(10px);
            border-radius: 10px; padding: 20px; max-width: 300px;
            color: #c0c8e0; font-size: 13px;
        }
        .controls h3 { color: #8A9A5B; margin-bottom: 12px; font-size: 15px; }
        .control-group { margin-bottom: 10px; }
        .control-group label { display: block; margin-bottom: 4px; color: #9aa0b8; }
        .control-group input[type="range"] { width: 100%; accent-color: #8A9A5B; }
        .control-group .value { float: right; color: #8A9A5B; font-weight: bold; }
        .metric { margin-top: 8px; padding: 8px; background: rgba(138,154,91,0.1); border-radius: 6px; }
        .metric .label { color: #9aa0b8; font-size: 11px; }
        .metric .val { color: #DDA15E; font-size: 18px; font-weight: bold; }
        .btn { background: rgba(138,154,91,0.2); color: #8A9A5B; border: 1px solid #8A9A5B;
            padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 12px; margin-top: 8px; }
        .btn:hover { background: rgba(138,154,91,0.4); }
        .hint { color: #666; font-size: 11px; margin-top: 8px; font-style: italic; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">&#8592; Collective Intelligence</a>
    <div class="controls">
        <h3>Stadium Wave</h3>
        <div class="control-group">
            <label>Excitability <span class="value" id="exciteVal">0.3</span></label>
            <input type="range" id="exciteSlider" min="0.1" max="0.8" value="0.3" step="0.05">
        </div>
        <div class="control-group">
            <label>Recovery Time <span class="value" id="recoveryVal">1.5</span>s</label>
            <input type="range" id="recoverySlider" min="0.5" max="4.0" value="1.5" step="0.1">
        </div>
        <div class="control-group">
            <label>Stand Duration <span class="value" id="standVal">0.5</span>s</label>
            <input type="range" id="standSlider" min="0.2" max="1.5" value="0.5" step="0.1">
        </div>
        <div class="control-group">
            <label>Rows <span class="value" id="rowsVal">20</span></label>
            <input type="range" id="rowsSlider" min="8" max="35" value="20" step="1">
        </div>
        <button class="btn" id="resetBtn">Reset</button>
        <button class="btn" id="triggerBtn">Trigger Wave</button>
        <div class="metric">
            <div class="label">Active Waves</div>
            <div class="val" id="waveCount">0</div>
        </div>
        <div class="metric">
            <div class="label">Wave Speed</div>
            <div class="val" id="waveSpeed">--</div>
        </div>
        <p class="hint">Click on the stadium to trigger a wave</p>
    </div>
    <canvas id="canvas"></canvas>

    <script>
    (function() {
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let W, H;

        function resize() {
            W = canvas.width = window.innerWidth;
            H = canvas.height = window.innerHeight;
            buildStadium();
        }
        resize();
        window.addEventListener('resize', resize);

        const exciteSlider = document.getElementById('exciteSlider');
        const recoverySlider = document.getElementById('recoverySlider');
        const standSlider = document.getElementById('standSlider');
        const rowsSlider = document.getElementById('rowsSlider');

        let excitability = +exciteSlider.value;
        let recoveryTime = +recoverySlider.value;
        let standDuration = +standSlider.value;
        let numRows = +rowsSlider.value;

        exciteSlider.oninput = function() { document.getElementById('exciteVal').textContent = this.value; excitability = +this.value; };
        recoverySlider.oninput = function() { document.getElementById('recoveryVal').textContent = this.value; recoveryTime = +this.value; };
        standSlider.oninput = function() { document.getElementById('standVal').textContent = this.value; standDuration = +this.value; };
        rowsSlider.oninput = function() { document.getElementById('rowsVal').textContent = this.value; numRows = +this.value; buildStadium(); };

        // State: 0=sitting, 1=standing, 2=recovering
        let spectators = [];
        let cx, cy, radiusX, radiusY;

        function buildStadium() {
            spectators = [];
            cx = W / 2;
            cy = H / 2;
            radiusX = Math.min(W, H) * 0.35;
            radiusY = Math.min(W, H) * 0.25;

            const seatsPerRow = Math.floor(radiusX * 2 * Math.PI / 6);

            for (let row = 0; row < numRows; row++) {
                const rowFrac = row / numRows;
                const rx = radiusX + 20 + row * (Math.min(W, H) * 0.15 / numRows);
                const ry = radiusY + 15 + row * (Math.min(W, H) * 0.15 / numRows);
                const circumference = Math.PI * (3 * (rx + ry) - Math.sqrt((3 * rx + ry) * (rx + 3 * ry)));
                const count = Math.max(40, Math.floor(circumference / 7));

                for (let s = 0; s < count; s++) {
                    const angle = (s / count) * Math.PI * 2;
                    const x = cx + Math.cos(angle) * rx;
                    const y = cy + Math.sin(angle) * ry;
                    spectators.push({
                        x: x, y: y,
                        angle: angle,
                        row: row,
                        state: 0, // sitting
                        timer: 0,
                        idx: spectators.length
                    });
                }
            }
        }

        buildStadium();

        function triggerWaveAt(angle) {
            // Excite spectators near this angle
            for (let i = 0; i < spectators.length; i++) {
                const s = spectators[i];
                if (s.state !== 0) continue;
                let da = s.angle - angle;
                while (da > Math.PI) da -= Math.PI * 2;
                while (da < -Math.PI) da += Math.PI * 2;
                if (Math.abs(da) < 0.15) {
                    s.state = 1;
                    s.timer = standDuration;
                }
            }
        }

        function init() {
            for (let i = 0; i < spectators.length; i++) {
                spectators[i].state = 0;
                spectators[i].timer = 0;
            }
        }

        document.getElementById('resetBtn').onclick = function() { buildStadium(); };
        window.reset = function() { buildStadium(); };

        document.getElementById('triggerBtn').onclick = function() {
            triggerWaveAt(0);
        };

        canvas.addEventListener('click', function(e) {
            const dx = e.clientX - cx;
            const dy = e.clientY - cy;
            const dist = Math.sqrt((dx / radiusX) * (dx / radiusX) + (dy / radiusY) * (dy / radiusY));
            if (dist > 0.5) {
                const angle = Math.atan2(dy, dx);
                triggerWaveAt(angle);
            }
        });

        let lastTime = 0;

        function animate(time) {
            requestAnimationFrame(animate);
            const dt = Math.min((time - lastTime) / 1000, 0.05);
            lastTime = time;

            // Dark background
            ctx.fillStyle = '#0a0e1a';
            ctx.fillRect(0, 0, W, H);

            // Draw pitch (green oval in center)
            ctx.save();
            ctx.beginPath();
            ctx.ellipse(cx, cy, radiusX * 0.85, radiusY * 0.85, 0, 0, Math.PI * 2);
            ctx.fillStyle = '#0d2810';
            ctx.fill();
            ctx.strokeStyle = '#1a4a20';
            ctx.lineWidth = 2;
            ctx.stroke();

            // Pitch lines
            ctx.beginPath();
            ctx.ellipse(cx, cy, radiusX * 0.3, radiusY * 0.3, 0, 0, Math.PI * 2);
            ctx.strokeStyle = 'rgba(255,255,255,0.1)';
            ctx.lineWidth = 1;
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(cx, cy - radiusY * 0.85);
            ctx.lineTo(cx, cy + radiusY * 0.85);
            ctx.stroke();
            ctx.restore();

            // Update spectators
            let standingCount = 0;
            let activeWaves = 0;
            let lastStandAngle = -999;

            for (let i = 0; i < spectators.length; i++) {
                const s = spectators[i];
                s.timer -= dt;

                if (s.state === 1) { // Standing
                    standingCount++;
                    if (s.timer <= 0) {
                        s.state = 2; // Start recovering
                        s.timer = recoveryTime;
                    }
                } else if (s.state === 2) { // Recovering
                    if (s.timer <= 0) {
                        s.state = 0; // Back to sitting
                    }
                } else if (s.state === 0) { // Sitting - check if neighbors are standing
                    // Look at neighbors "to the left" (slightly lower angle)
                    let standingNeighbors = 0;
                    let totalNeighbors = 0;
                    for (let j = 0; j < spectators.length; j++) {
                        if (i === j) continue;
                        const o = spectators[j];
                        if (Math.abs(o.row - s.row) > 2) continue;
                        let da = s.angle - o.angle;
                        while (da > Math.PI) da -= Math.PI * 2;
                        while (da < -Math.PI) da += Math.PI * 2;
                        // Neighbor is slightly behind (lower angle = to the right in wave direction)
                        if (da > 0 && da < 0.2) {
                            totalNeighbors++;
                            if (o.state === 1) standingNeighbors++;
                        }
                    }
                    if (totalNeighbors > 0 && (standingNeighbors / totalNeighbors) > (1 - excitability)) {
                        s.state = 1;
                        s.timer = standDuration;
                    }
                }
            }

            // Count wave fronts (transitions from standing to not-standing around the ring)
            // Sample first row
            let transitions = 0;
            let prevStanding = false;
            const firstRowSpecs = spectators.filter(s => s.row === 0);
            firstRowSpecs.sort((a, b) => a.angle - b.angle);
            for (let i = 0; i < firstRowSpecs.length; i++) {
                const isStanding = firstRowSpecs[i].state === 1;
                if (isStanding && !prevStanding) transitions++;
                prevStanding = isStanding;
            }

            document.getElementById('waveCount').textContent = transitions;
            document.getElementById('waveSpeed').textContent = standingCount > 0 ? (transitions > 0 ? 'Active' : 'Spreading') : '--';

            // Draw spectators
            for (let i = 0; i < spectators.length; i++) {
                const s = spectators[i];
                let color, h;

                if (s.state === 0) {
                    // Sitting - dark
                    color = 'rgb(30, 35, 50)';
                    h = 3;
                } else if (s.state === 1) {
                    // Standing - bright
                    const brightness = Math.min(1, s.timer / standDuration);
                    const r = Math.floor(220 + 35 * brightness);
                    const g = Math.floor(160 + 80 * brightness);
                    const b = Math.floor(40 + 20 * brightness);
                    color = 'rgb(' + r + ',' + g + ',' + b + ')';
                    h = 6;
                } else {
                    // Recovering - dim
                    const recFrac = s.timer / recoveryTime;
                    const v = Math.floor(40 + 30 * recFrac);
                    color = 'rgb(' + v + ',' + (v + 5) + ',' + (v + 20) + ')';
                    h = 3 + recFrac * 2;
                }

                ctx.fillStyle = color;
                ctx.fillRect(s.x - 2, s.y - h, 4, h);

                // Glow for standing spectators
                if (s.state === 1) {
                    ctx.save();
                    ctx.globalAlpha = 0.15;
                    ctx.fillStyle = '#FFD700';
                    ctx.beginPath();
                    ctx.arc(s.x, s.y - h / 2, 8, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                }
            }

            // Stadium outline glow
            ctx.save();
            ctx.beginPath();
            const outerRx = radiusX + 20 + numRows * (Math.min(W, H) * 0.15 / numRows) + 10;
            const outerRy = radiusY + 15 + numRows * (Math.min(W, H) * 0.15 / numRows) + 10;
            ctx.ellipse(cx, cy, outerRx, outerRy, 0, 0, Math.PI * 2);
            ctx.strokeStyle = 'rgba(138, 154, 91, 0.2)';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.restore();
        }

        requestAnimationFrame(animate);
    })();
    </script>
    <script src="../assets/js/enhance.js"></script>
</body>
</html>