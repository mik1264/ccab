<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bacterial Quorum Sensing</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0a0e1a; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        canvas { display: block; }
        .back-link {
            position: fixed; top: 20px; left: 20px; z-index: 100;
            color: #8A9A5B; background: rgba(10,14,26,0.8); border-radius: 25px;
            border: 2px solid #8A9A5B; padding: 10px 20px; text-decoration: none;
            font-size: 14px; transition: all 0.3s ease;
        }
        .back-link:hover { background: rgba(138,154,91,0.3); }
        .controls {
            position: fixed; top: 20px; right: 20px; z-index: 100;
            background: rgba(10,14,26,0.85); backdrop-filter: blur(10px);
            border-radius: 10px; padding: 20px; max-width: 300px;
            color: #c0c8e0; font-size: 13px;
        }
        .controls h3 { color: #8A9A5B; margin-bottom: 12px; font-size: 15px; }
        .control-group { margin-bottom: 10px; }
        .control-group label { display: block; margin-bottom: 4px; color: #9aa0b8; }
        .control-group input[type="range"] { width: 100%; accent-color: #8A9A5B; }
        .control-group .value { float: right; color: #8A9A5B; font-weight: bold; }
        .metric { margin-top: 8px; padding: 8px; background: rgba(138,154,91,0.1); border-radius: 6px; }
        .metric .label { color: #9aa0b8; font-size: 11px; }
        .metric .val { color: #DDA15E; font-size: 18px; font-weight: bold; }
        .btn { background: rgba(138,154,91,0.2); color: #8A9A5B; border: 1px solid #8A9A5B;
            padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 12px; margin-top: 8px; }
        .btn:hover { background: rgba(138,154,91,0.4); }
        .hint { color: #666; font-size: 11px; margin-top: 8px; font-style: italic; }
        .phase-bar { margin-top: 6px; height: 12px; background: rgba(255,255,255,0.05); border-radius: 6px; overflow: hidden; display: flex; }
        .phase-planktonic { background: #4488cc; height: 100%; transition: width 0.3s; }
        .phase-biofilm { background: #44cc66; height: 100%; transition: width 0.3s; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">&#8592; Collective Intelligence</a>
    <div class="controls">
        <h3>Quorum Sensing</h3>
        <div class="control-group">
            <label>Initial Bacteria <span class="value" id="initVal">30</span></label>
            <input type="range" id="initSlider" min="5" max="100" value="30" step="5">
        </div>
        <div class="control-group">
            <label>Signal Production <span class="value" id="prodVal">1.0</span></label>
            <input type="range" id="prodSlider" min="0.2" max="3.0" value="1.0" step="0.1">
        </div>
        <div class="control-group">
            <label>Detection Threshold <span class="value" id="threshVal">0.4</span></label>
            <input type="range" id="threshSlider" min="0.1" max="1.0" value="0.4" step="0.05">
        </div>
        <div class="control-group">
            <label>Diffusion Rate <span class="value" id="diffVal">0.15</span></label>
            <input type="range" id="diffSlider" min="0.05" max="0.5" value="0.15" step="0.01">
        </div>
        <div class="control-group">
            <label>Growth Rate <span class="value" id="growthVal">1.0</span>x</label>
            <input type="range" id="growthSlider" min="0.2" max="3.0" value="1.0" step="0.1">
        </div>
        <button class="btn" id="resetBtn">Reset</button>
        <div class="metric">
            <div class="label">Population</div>
            <div class="val" id="popVal">0</div>
        </div>
        <div class="metric">
            <div class="label">Biofilm Mode</div>
            <div class="val" id="bioVal">0%</div>
            <div class="phase-bar">
                <div class="phase-planktonic" id="planBar" style="width:100%"></div>
                <div class="phase-biofilm" id="bioBar" style="width:0%"></div>
            </div>
        </div>
        <div class="metric">
            <div class="label">Peak Signal Concentration</div>
            <div class="val" id="concVal">0.00</div>
        </div>
        <p class="hint">Watch bacteria reach quorum and switch to biofilm</p>
    </div>
    <canvas id="canvas"></canvas>

    <script>
    (function() {
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let W, H;

        function resize() {
            W = canvas.width = window.innerWidth;
            H = canvas.height = window.innerHeight;
            initConcentrationGrid();
        }

        // Controls
        const initSlider = document.getElementById('initSlider');
        const prodSlider = document.getElementById('prodSlider');
        const threshSlider = document.getElementById('threshSlider');
        const diffSlider = document.getElementById('diffSlider');
        const growthSlider = document.getElementById('growthSlider');

        let initialCount = +initSlider.value;
        let production = +prodSlider.value;
        let threshold = +threshSlider.value;
        let diffusion = +diffSlider.value;
        let growthRate = +growthSlider.value;

        initSlider.oninput = function() { document.getElementById('initVal').textContent = this.value; initialCount = +this.value; };
        prodSlider.oninput = function() { document.getElementById('prodVal').textContent = this.value; production = +this.value; };
        threshSlider.oninput = function() { document.getElementById('threshVal').textContent = this.value; threshold = +this.value; };
        diffSlider.oninput = function() { document.getElementById('diffVal').textContent = this.value; diffusion = +this.value; };
        growthSlider.oninput = function() { document.getElementById('growthVal').textContent = this.value; growthRate = +this.value; };

        // Petri dish
        let dishCx, dishCy, dishR;
        let bacteria = [];
        let maxBacteria = 2000;

        // Concentration grid (coarse)
        let gridSize = 8;
        let gridW, gridH;
        let concGrid, concGrid2;

        function initConcentrationGrid() {
            dishCx = W / 2;
            dishCy = H / 2;
            dishR = Math.min(W, H) * 0.38;
            gridW = Math.ceil(W / gridSize);
            gridH = Math.ceil(H / gridSize);
            concGrid = new Float32Array(gridW * gridH);
            concGrid2 = new Float32Array(gridW * gridH);
        }

        function isInDish(x, y) {
            const dx = x - dishCx;
            const dy = y - dishCy;
            return dx * dx + dy * dy < dishR * dishR;
        }

        function init() {
            bacteria = [];
            for (let i = 0; i < initialCount; i++) {
                let x, y;
                do {
                    x = dishCx + (Math.random() - 0.5) * dishR * 1.6;
                    y = dishCy + (Math.random() - 0.5) * dishR * 1.6;
                } while (!isInDish(x, y));
                bacteria.push({
                    x: x, y: y,
                    vx: (Math.random() - 0.5) * 2,
                    vy: (Math.random() - 0.5) * 2,
                    biofilm: false,
                    switchTimer: 0,
                    divideTimer: 15 + Math.random() * 20,
                    size: 2 + Math.random()
                });
            }
            if (concGrid) concGrid.fill(0);
            if (concGrid2) concGrid2.fill(0);
        }

        resize();
        init();
        window.addEventListener('resize', resize);

        document.getElementById('resetBtn').onclick = init;
        window.reset = init;

        let lastTime = 0;
        let simTime = 0;

        function animate(time) {
            requestAnimationFrame(animate);
            const dt = Math.min((time - lastTime) / 1000, 0.05);
            lastTime = time;
            simTime += dt * growthRate;

            // Background
            ctx.fillStyle = '#0a0e1a';
            ctx.fillRect(0, 0, W, H);

            // Petri dish outline
            ctx.save();
            ctx.beginPath();
            ctx.arc(dishCx, dishCy, dishR + 3, 0, Math.PI * 2);
            ctx.strokeStyle = 'rgba(180, 190, 200, 0.3)';
            ctx.lineWidth = 3;
            ctx.stroke();

            // Dish background
            ctx.beginPath();
            ctx.arc(dishCx, dishCy, dishR, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(15, 20, 30, 0.8)';
            ctx.fill();
            ctx.clip();

            // Bacteria produce signal into the grid
            for (let i = 0; i < bacteria.length; i++) {
                const b = bacteria[i];
                const gx = Math.floor(b.x / gridSize);
                const gy = Math.floor(b.y / gridSize);
                if (gx >= 0 && gx < gridW && gy >= 0 && gy < gridH) {
                    concGrid[gy * gridW + gx] += production * dt * 0.5;
                }
            }

            // Diffuse concentration
            const diffFactor = diffusion * dt * 60;
            for (let y = 1; y < gridH - 1; y++) {
                for (let x = 1; x < gridW - 1; x++) {
                    const idx = y * gridW + x;
                    const cx2 = x * gridSize + gridSize / 2;
                    const cy2 = y * gridSize + gridSize / 2;
                    if (!isInDish(cx2, cy2)) { concGrid2[idx] = 0; continue; }

                    const neighbors = concGrid[idx - 1] + concGrid[idx + 1] +
                                     concGrid[idx - gridW] + concGrid[idx + gridW];
                    concGrid2[idx] = concGrid[idx] + diffFactor * (neighbors / 4 - concGrid[idx]);
                    // Decay
                    concGrid2[idx] *= (1 - 0.02 * dt * 60);
                    if (concGrid2[idx] < 0) concGrid2[idx] = 0;
                }
            }
            // Swap
            const tmp = concGrid;
            concGrid = concGrid2;
            concGrid2 = tmp;

            // Draw concentration map as subtle glow
            let maxConc = 0;
            for (let y = 0; y < gridH; y++) {
                for (let x = 0; x < gridW; x++) {
                    const val = concGrid[y * gridW + x];
                    if (val > maxConc) maxConc = val;
                }
            }

            if (maxConc > 0.001) {
                for (let y = 0; y < gridH; y++) {
                    for (let x = 0; x < gridW; x++) {
                        const val = concGrid[y * gridW + x];
                        if (val < 0.01) continue;
                        const norm = Math.min(1, val / Math.max(maxConc, threshold * 2));
                        const alpha = norm * 0.25;
                        if (alpha < 0.01) continue;
                        // Color: below threshold = blue tint, above = green/yellow
                        const aboveThresh = val > threshold;
                        if (aboveThresh) {
                            ctx.fillStyle = 'rgba(50, 200, 80, ' + alpha + ')';
                        } else {
                            ctx.fillStyle = 'rgba(40, 100, 180, ' + alpha + ')';
                        }
                        ctx.fillRect(x * gridSize, y * gridSize, gridSize, gridSize);
                    }
                }
            }

            // Update bacteria
            let biofilmCount = 0;

            for (let i = bacteria.length - 1; i >= 0; i--) {
                const b = bacteria[i];

                // Check local concentration
                const gx = Math.floor(b.x / gridSize);
                const gy = Math.floor(b.y / gridSize);
                let localConc = 0;
                if (gx >= 0 && gx < gridW && gy >= 0 && gy < gridH) {
                    localConc = concGrid[gy * gridW + gx];
                }

                // Quorum switch
                if (!b.biofilm && localConc > threshold) {
                    b.switchTimer += dt * growthRate;
                    if (b.switchTimer > 0.5) {
                        b.biofilm = true;
                    }
                } else if (!b.biofilm) {
                    b.switchTimer = Math.max(0, b.switchTimer - dt);
                }

                if (b.biofilm) biofilmCount++;

                // Movement
                if (!b.biofilm) {
                    // Planktonic: swim freely
                    b.vx += (Math.random() - 0.5) * 4 * dt;
                    b.vy += (Math.random() - 0.5) * 4 * dt;
                    b.vx *= 0.95;
                    b.vy *= 0.95;
                    b.x += b.vx;
                    b.y += b.vy;
                } else {
                    // Biofilm: slow drift, mostly stationary
                    b.vx *= 0.9;
                    b.vy *= 0.9;
                    b.x += b.vx * 0.1;
                    b.y += b.vy * 0.1;
                }

                // Constrain to dish
                const dx = b.x - dishCx;
                const dy = b.y - dishCy;
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist > dishR - 5) {
                    const angle = Math.atan2(dy, dx);
                    b.x = dishCx + Math.cos(angle) * (dishR - 6);
                    b.y = dishCy + Math.sin(angle) * (dishR - 6);
                    b.vx *= -0.5;
                    b.vy *= -0.5;
                }

                // Division
                b.divideTimer -= dt * growthRate;
                if (b.divideTimer <= 0 && bacteria.length < maxBacteria) {
                    b.divideTimer = 12 + Math.random() * 16;
                    const newB = {
                        x: b.x + (Math.random() - 0.5) * 4,
                        y: b.y + (Math.random() - 0.5) * 4,
                        vx: (Math.random() - 0.5) * 2,
                        vy: (Math.random() - 0.5) * 2,
                        biofilm: false,
                        switchTimer: 0,
                        divideTimer: 12 + Math.random() * 16,
                        size: 2 + Math.random()
                    };
                    // Inherit biofilm state if parent is biofilm (cooperative)
                    if (b.biofilm && localConc > threshold) {
                        newB.biofilm = true;
                    }
                    bacteria.push(newB);
                }
            }

            // Draw bacteria
            for (let i = 0; i < bacteria.length; i++) {
                const b = bacteria[i];

                if (b.biofilm) {
                    // Green glowing biofilm cell
                    const grd = ctx.createRadialGradient(b.x, b.y, 0, b.x, b.y, b.size * 3);
                    grd.addColorStop(0, 'rgba(80, 230, 100, 0.5)');
                    grd.addColorStop(1, 'rgba(40, 180, 60, 0)');
                    ctx.fillStyle = grd;
                    ctx.beginPath();
                    ctx.arc(b.x, b.y, b.size * 3, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.fillStyle = '#50e664';
                    ctx.beginPath();
                    ctx.arc(b.x, b.y, b.size, 0, Math.PI * 2);
                    ctx.fill();
                } else {
                    // Blue planktonic cell
                    ctx.fillStyle = 'rgba(80, 140, 220, 0.8)';
                    ctx.beginPath();
                    ctx.arc(b.x, b.y, b.size * 0.8, 0, Math.PI * 2);
                    ctx.fill();

                    // Flagellum trail
                    ctx.strokeStyle = 'rgba(80, 140, 220, 0.2)';
                    ctx.lineWidth = 0.5;
                    ctx.beginPath();
                    ctx.moveTo(b.x, b.y);
                    ctx.lineTo(b.x - b.vx * 3, b.y - b.vy * 3);
                    ctx.stroke();
                }
            }

            ctx.restore();

            // Dish rim highlight
            ctx.beginPath();
            ctx.arc(dishCx, dishCy, dishR, 0, Math.PI * 2);
            ctx.strokeStyle = 'rgba(200, 210, 220, 0.15)';
            ctx.lineWidth = 6;
            ctx.stroke();

            // Glass reflection
            ctx.beginPath();
            ctx.arc(dishCx - dishR * 0.3, dishCy - dishR * 0.35, dishR * 0.15, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(255, 255, 255, 0.03)';
            ctx.fill();

            // Update metrics
            const bioPercent = bacteria.length > 0 ? Math.round(biofilmCount / bacteria.length * 100) : 0;
            document.getElementById('popVal').textContent = bacteria.length;
            document.getElementById('bioVal').textContent = bioPercent + '%';
            document.getElementById('planBar').style.width = (100 - bioPercent) + '%';
            document.getElementById('bioBar').style.width = bioPercent + '%';
            document.getElementById('concVal').textContent = maxConc.toFixed(3);
        }

        requestAnimationFrame(animate);
    })();
    </script>
    <script src="../assets/js/enhance.js"></script>
</body>
</html>