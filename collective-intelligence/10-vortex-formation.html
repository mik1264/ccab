<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Active Matter Vortices - Collective Intelligence - CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0a0e1a;
            color: #e0e0e0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            height: 100vh;
        }
        canvas { display: block; }
        .back-link {
            position: fixed; top: 15px; left: 15px; z-index: 100;
            color: #8A9A5B; text-decoration: none;
            background: rgba(10,14,26,0.8); border: 2px solid #8A9A5B;
            border-radius: 25px; padding: 10px 20px;
            font-size: 14px; font-weight: 500;
            transition: background 0.3s;
        }
        .back-link:hover { background: rgba(138,154,91,0.3); }
        .controls {
            position: fixed; top: 15px; right: 15px; z-index: 100;
            background: rgba(10,14,26,0.85); backdrop-filter: blur(10px);
            border-radius: 10px; padding: 20px; max-width: 300px;
            border: 1px solid rgba(138,154,91,0.3);
        }
        .controls h3 {
            font-size: 14px; color: #8A9A5B; margin-bottom: 12px;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .control-group { margin-bottom: 12px; }
        .control-group label {
            display: block; font-size: 12px; color: #999; margin-bottom: 4px;
        }
        .control-group input[type="range"] {
            width: 100%; accent-color: #8A9A5B;
        }
        .control-group .value {
            float: right; color: #8A9A5B; font-size: 12px; font-weight: 600;
        }
        .phase-diagram {
            margin-top: 10px; margin-bottom: 10px;
            background: rgba(0,0,0,0.3); border-radius: 8px;
            padding: 10px; height: 80px; position: relative;
            border: 1px solid rgba(138,154,91,0.15);
        }
        .phase-diagram .phase-label {
            font-size: 9px; color: #666; position: absolute;
        }
        .phase-marker {
            width: 10px; height: 10px; border-radius: 50%;
            background: #DDA15E; border: 2px solid #fff;
            position: absolute; transition: left 0.3s, bottom 0.3s;
            z-index: 2;
        }
        .metrics {
            margin-top: 12px; padding-top: 10px;
            border-top: 1px solid rgba(138,154,91,0.2);
        }
        .metric {
            display: flex; justify-content: space-between;
            font-size: 12px; margin-bottom: 5px;
        }
        .metric-label { color: #888; }
        .metric-value { color: #DDA15E; font-weight: 600; }
        .btn {
            width: 100%; padding: 8px; margin-top: 8px;
            background: rgba(138,154,91,0.3); border: 1px solid #8A9A5B;
            color: #8A9A5B; border-radius: 6px; cursor: pointer;
            font-size: 12px; font-weight: 600;
            transition: background 0.3s;
        }
        .btn:hover { background: rgba(138,154,91,0.5); }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">&larr; Collective Intelligence</a>
    <div class="controls">
        <h3>Active Matter Vortices</h3>
        <div class="control-group">
            <label>Noise Level <span class="value" id="noiseVal">0.30</span></label>
            <input type="range" id="noise" min="1" max="100" value="30">
        </div>
        <div class="control-group">
            <label>Alignment Radius <span class="value" id="radiusVal">30</span></label>
            <input type="range" id="alignRadius" min="10" max="80" value="30">
        </div>
        <div class="control-group">
            <label>Particle Count <span class="value" id="countVal">1000</span></label>
            <input type="range" id="particleCount" min="200" max="2000" value="1000" step="50">
        </div>
        <div class="control-group">
            <label>Particle Speed <span class="value" id="speedVal">2.0</span></label>
            <input type="range" id="particleSpeed" min="5" max="40" value="20">
        </div>
        <div class="phase-diagram" id="phaseDiag">
            <canvas id="phaseCanvas" width="260" height="60"></canvas>
            <div class="phase-marker" id="phaseMarker"></div>
            <span class="phase-label" style="bottom:2px;left:5px;">Low Noise</span>
            <span class="phase-label" style="bottom:2px;right:5px;">High Noise</span>
            <span class="phase-label" style="top:2px;left:5px;">Ordered</span>
            <span class="phase-label" style="top:2px;right:5px;">Disordered</span>
        </div>
        <div class="metrics">
            <div class="metric">
                <span class="metric-label">Order Parameter</span>
                <span class="metric-value" id="orderParam">0.00</span>
            </div>
            <div class="metric">
                <span class="metric-label">Phase</span>
                <span class="metric-value" id="phaseState">-</span>
            </div>
        </div>
        <button class="btn" id="resetBtn">Reset</button>
    </div>
    <canvas id="canvas"></canvas>

    <script>
    (function() {
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let W, H;
        let particles = [];
        let animId;
        let paused = false;

        function resize() {
            W = canvas.width = window.innerWidth;
            H = canvas.height = window.innerHeight;
        }
        resize();
        window.addEventListener('resize', resize);

        function getParams() {
            return {
                noise: parseInt(document.getElementById('noise').value) / 100,
                alignRadius: parseInt(document.getElementById('alignRadius').value),
                count: parseInt(document.getElementById('particleCount').value),
                speed: parseInt(document.getElementById('particleSpeed').value) / 10
            };
        }

        function initParticles() {
            const p = getParams();
            particles = [];
            for (let i = 0; i < p.count; i++) {
                particles.push({
                    x: Math.random() * W,
                    y: Math.random() * H,
                    theta: Math.random() * Math.PI * 2
                });
            }
        }

        // Spatial hashing for performance
        function buildGrid(radius) {
            const cellSize = radius;
            const cols = Math.ceil(W / cellSize);
            const rows = Math.ceil(H / cellSize);
            const grid = new Array(cols * rows);
            for (let i = 0; i < grid.length; i++) grid[i] = [];
            for (let i = 0; i < particles.length; i++) {
                const p = particles[i];
                const gx = Math.min(Math.floor(p.x / cellSize), cols - 1);
                const gy = Math.min(Math.floor(p.y / cellSize), rows - 1);
                if (gx >= 0 && gy >= 0) {
                    grid[gy * cols + gx].push(i);
                }
            }
            return { grid, cols, rows, cellSize };
        }

        function update() {
            const p = getParams();
            const radius = p.alignRadius;
            const r2 = radius * radius;
            const spatial = buildGrid(radius);
            const { grid, cols, rows, cellSize } = spatial;

            // Vicsek model: align heading with neighbors + noise
            const newTheta = new Float64Array(particles.length);

            for (let i = 0; i < particles.length; i++) {
                const pi = particles[i];
                const gx = Math.floor(pi.x / cellSize);
                const gy = Math.floor(pi.y / cellSize);

                let sinSum = Math.sin(pi.theta);
                let cosSum = Math.cos(pi.theta);
                let count = 1;

                for (let dy = -1; dy <= 1; dy++) {
                    for (let dx = -1; dx <= 1; dx++) {
                        const nx = (gx + dx + cols) % cols;
                        const ny = (gy + dy + rows) % rows;
                        const cell = grid[ny * cols + nx];
                        for (let k = 0; k < cell.length; k++) {
                            const j = cell[k];
                            if (j === i) continue;
                            const pj = particles[j];
                            let ddx = pi.x - pj.x;
                            let ddy = pi.y - pj.y;
                            // Handle wrapping
                            if (ddx > W / 2) ddx -= W;
                            if (ddx < -W / 2) ddx += W;
                            if (ddy > H / 2) ddy -= H;
                            if (ddy < -H / 2) ddy += H;
                            if (ddx * ddx + ddy * ddy <= r2) {
                                sinSum += Math.sin(pj.theta);
                                cosSum += Math.cos(pj.theta);
                                count++;
                            }
                        }
                    }
                }

                const avgTheta = Math.atan2(sinSum / count, cosSum / count);
                newTheta[i] = avgTheta + (Math.random() - 0.5) * p.noise * Math.PI * 2;
            }

            // Update positions
            let sinTotal = 0, cosTotal = 0;
            for (let i = 0; i < particles.length; i++) {
                const pi = particles[i];
                pi.theta = newTheta[i];
                pi.x += Math.cos(pi.theta) * p.speed;
                pi.y += Math.sin(pi.theta) * p.speed;

                // Periodic boundaries
                if (pi.x < 0) pi.x += W;
                if (pi.x >= W) pi.x -= W;
                if (pi.y < 0) pi.y += H;
                if (pi.y >= H) pi.y -= H;

                sinTotal += Math.sin(pi.theta);
                cosTotal += Math.cos(pi.theta);
            }

            // Order parameter (|average velocity direction|)
            const n = particles.length;
            const order = Math.sqrt(sinTotal * sinTotal + cosTotal * cosTotal) / n;
            document.getElementById('orderParam').textContent = order.toFixed(3);

            // Phase state
            let phase;
            if (order > 0.7) phase = 'Ordered';
            else if (order > 0.3) phase = 'Vortex';
            else phase = 'Disordered';
            document.getElementById('phaseState').textContent = phase;

            // Update phase diagram marker
            const marker = document.getElementById('phaseMarker');
            const diagW = 260;
            const diagH = 60;
            const mx = 5 + (p.noise) * (diagW - 20);
            const my = (1 - order) * (diagH - 15) + 5;
            marker.style.left = mx + 'px';
            marker.style.bottom = (diagH - my) + 'px';
        }

        function headingToColor(theta) {
            // Map angle to hue
            const hue = ((theta % (Math.PI * 2)) + Math.PI * 2) % (Math.PI * 2);
            const h = hue / (Math.PI * 2) * 360;
            return 'hsl(' + h + ',80%,60%)';
        }

        function draw() {
            // Fade for trail effect
            ctx.fillStyle = 'rgba(10, 14, 26, 0.12)';
            ctx.fillRect(0, 0, W, H);

            const p = getParams();

            for (let i = 0; i < particles.length; i++) {
                const pi = particles[i];
                const color = headingToColor(pi.theta);

                // Draw as small arrow/dot
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(pi.x, pi.y, 1.8, 0, Math.PI * 2);
                ctx.fill();

                // Tiny direction indicator
                const dx = Math.cos(pi.theta) * 3;
                const dy = Math.sin(pi.theta) * 3;
                ctx.beginPath();
                ctx.moveTo(pi.x, pi.y);
                ctx.lineTo(pi.x + dx, pi.y + dy);
                ctx.strokeStyle = color;
                ctx.lineWidth = 0.8;
                ctx.stroke();
            }
        }

        // Draw phase diagram background
        function drawPhaseDiagramBg() {
            const pc = document.getElementById('phaseCanvas');
            const pctx = pc.getContext('2d');
            pctx.clearRect(0, 0, 260, 60);

            // Gradient background showing phase regions
            for (let x = 0; x < 260; x++) {
                for (let y = 0; y < 60; y++) {
                    const noise = x / 260;
                    const order = 1 - y / 60;
                    // Approximate phase boundary
                    const expectedOrder = Math.max(0, 1 - noise * 2.5);
                    const nearBoundary = Math.abs(order - expectedOrder) < 0.2;
                    let r, g, b, a;
                    if (order > 0.7 && noise < 0.3) {
                        // Ordered region
                        r = 50; g = 120; b = 200; a = 0.15;
                    } else if (order > 0.3 && noise > 0.15 && noise < 0.6) {
                        // Vortex region
                        r = 200; g = 100; b = 50; a = 0.15;
                    } else {
                        // Disordered
                        r = 100; g = 100; b = 100; a = 0.08;
                    }
                    pctx.fillStyle = 'rgba(' + r + ',' + g + ',' + b + ',' + a + ')';
                    pctx.fillRect(x, y, 1, 1);
                }
            }

            // Labels
            pctx.font = '8px sans-serif';
            pctx.fillStyle = '#4488ff55';
            pctx.fillText('Ordered', 10, 15);
            pctx.fillStyle = '#ff884455';
            pctx.fillText('Vortex', 110, 30);
            pctx.fillStyle = '#88888855';
            pctx.fillText('Gas', 220, 50);
        }

        function animate() {
            if (!paused) update();
            draw();
            animId = requestAnimationFrame(animate);
        }

        function reset() {
            cancelAnimationFrame(animId);
            ctx.fillStyle = '#0a0e1a';
            ctx.fillRect(0, 0, W, H);
            initParticles();
            drawPhaseDiagramBg();
            animate();
        }
        window.reset = reset;

        // UI bindings
        document.getElementById('noise').oninput = function() {
            document.getElementById('noiseVal').textContent = (this.value / 100).toFixed(2);
        };
        document.getElementById('alignRadius').oninput = function() {
            document.getElementById('radiusVal').textContent = this.value;
        };
        document.getElementById('particleCount').oninput = function() {
            document.getElementById('countVal').textContent = this.value;
        };
        document.getElementById('particleSpeed').oninput = function() {
            document.getElementById('speedVal').textContent = (this.value / 10).toFixed(1);
        };
        document.getElementById('resetBtn').onclick = reset;
        document.getElementById('particleCount').onchange = reset;

        initParticles();
        drawPhaseDiagramBg();
        animate();
    })();
    </script>
    <script src="../assets/js/enhance.js"></script>
</body>
</html>
