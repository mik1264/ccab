<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Division of Labor - Ant Colony Task Allocation - CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0a0e1a;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            color: #ccc;
        }
        canvas { display: block; }
        .back-link {
            position: fixed; top: 15px; left: 15px; z-index: 100;
            color: #8A9A5B; background: rgba(10,14,26,0.8);
            border-radius: 25px; border: 2px solid #8A9A5B;
            padding: 10px 20px; text-decoration: none; font-size: 14px;
            transition: all 0.3s ease;
        }
        .back-link:hover { background: rgba(138,154,91,0.2); transform: translateX(-4px); }
        #controls {
            position: fixed; top: 15px; right: 15px; z-index: 100;
            background: rgba(10,14,26,0.85); backdrop-filter: blur(10px);
            border-radius: 10px; padding: 20px; max-width: 300px;
            border: 1px solid rgba(138,154,91,0.3);
        }
        #controls h3 { color: #fff; margin-bottom: 12px; font-size: 15px; }
        .control-row { margin: 8px 0; }
        .control-row label { display: block; font-size: 11px; color: #8A9A5B; margin-bottom: 3px; }
        .control-row input[type="range"] { width: 100%; accent-color: #8A9A5B; }
        .control-row .val { float: right; color: #aaa; font-size: 11px; }
        .stat { margin: 4px 0; font-size: 12px; }
        .stat-label { color: #888; font-size: 11px; }
        .stat-value { color: #8A9A5B; font-weight: bold; }
        button {
            background: rgba(138,154,91,0.15); border: 1px solid rgba(138,154,91,0.4);
            color: #8A9A5B; padding: 6px 14px; border-radius: 6px; cursor: pointer;
            font-size: 12px; margin-top: 4px; margin-right: 4px; transition: all 0.3s;
        }
        button:hover { background: rgba(138,154,91,0.3); }
        .event-btn { font-size: 11px; padding: 5px 10px; }
        hr { border: none; border-top: 1px solid rgba(138,154,91,0.2); margin: 10px 0; }
        .demand-bar { height: 8px; border-radius: 4px; margin: 3px 0; background: rgba(255,255,255,0.1); }
        .demand-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Collective Intelligence</a>
    <canvas id="canvas"></canvas>
    <div id="controls">
        <h3>Ant Colony Task Allocation</h3>
        <div class="control-row">
            <label>Ant Count <span class="val" id="antVal">120</span></label>
            <input type="range" id="antCount" min="30" max="250" value="120">
        </div>
        <div class="control-row">
            <label>Demand Fluctuation <span class="val" id="demandVal">5</span></label>
            <input type="range" id="demandSpeed" min="1" max="15" value="5">
        </div>
        <div class="control-row">
            <label>Threshold Variability <span class="val" id="threshVal">50</span></label>
            <input type="range" id="threshVar" min="10" max="100" value="50">
        </div>
        <hr>
        <div style="font-size:11px;color:#8A9A5B;margin-bottom:6px;">Trigger Events:</div>
        <button class="event-btn" id="attackBtn">Enemy Attack</button>
        <button class="event-btn" id="foodBtn">Food Bonanza</button>
        <button class="event-btn" id="stormBtn">Storm</button>
        <hr>
        <div class="stat"><span class="stat-label">Foragers:</span> <span class="stat-value" id="foragerCount">0</span></div>
        <div class="stat"><span class="stat-label">Builders:</span> <span class="stat-value" id="builderCount">0</span></div>
        <div class="stat"><span class="stat-label">Defenders:</span> <span class="stat-value" id="defenderCount">0</span></div>
        <div class="stat"><span class="stat-label">Idle:</span> <span class="stat-value" id="idleCount">0</span></div>
        <hr>
        <div style="font-size:11px;color:#888;margin-bottom:4px;">Forage Demand:</div>
        <div class="demand-bar"><div class="demand-fill" id="forageFill" style="width:50%;background:#4CAF50;"></div></div>
        <div style="font-size:11px;color:#888;margin-bottom:4px;margin-top:6px;">Build Demand:</div>
        <div class="demand-bar"><div class="demand-fill" id="buildFill" style="width:50%;background:#8B6914;"></div></div>
        <div style="font-size:11px;color:#888;margin-bottom:4px;margin-top:6px;">Defend Demand:</div>
        <div class="demand-bar"><div class="demand-fill" id="defendFill" style="width:50%;background:#dc5050;"></div></div>
        <button id="resetBtn" style="margin-top:10px;">Reset</button>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let W, H;
        function resize() { W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; }
        resize();
        window.addEventListener('resize', resize);

        const FORAGE = 0, BUILD = 1, DEFEND = 2, IDLE = 3;
        const taskColors = ['#4CAF50', '#8B6914', '#dc5050', '#555'];
        const taskNames = ['Forage', 'Build', 'Defend', 'Idle'];

        let ants = [], demands = [50, 50, 50], time = 0;

        function init() {
            const n = parseInt(document.getElementById('antCount').value);
            const threshVar = parseInt(document.getElementById('threshVar').value) / 100;
            ants = [];
            demands = [50, 50, 50];

            for (let i = 0; i < n; i++) {
                ants.push({
                    x: W / 2 + (Math.random() - 0.5) * 60,
                    y: H / 2 + (Math.random() - 0.5) * 60,
                    vx: 0, vy: 0,
                    task: IDLE,
                    thresholds: [
                        20 + Math.random() * 80 * threshVar,
                        20 + Math.random() * 80 * threshVar,
                        20 + Math.random() * 80 * threshVar
                    ],
                    targetX: W / 2, targetY: H / 2
                });
            }
            time = 0;
        }

        // Task zone centers (computed from canvas size)
        function getZones() {
            const cx = W / 2, cy = H / 2;
            const r = Math.min(W, H) * 0.32;
            return [
                { x: cx - r * 0.9, y: cy + r * 0.3, color: '#4CAF50', label: 'FORAGE', angle: Math.PI * 0.8 },
                { x: cx, y: cy - r * 0.85, color: '#8B6914', label: 'BUILD', angle: -Math.PI / 2 },
                { x: cx + r * 0.9, y: cy + r * 0.3, color: '#dc5050', label: 'DEFEND', angle: -Math.PI * 0.2 }
            ];
        }

        function update() {
            const demandSpd = parseInt(document.getElementById('demandSpeed').value);
            time += 0.01 * demandSpd;

            // Natural demand fluctuation
            demands[FORAGE] = 40 + 35 * Math.sin(time * 0.7) + 15 * Math.sin(time * 1.3);
            demands[BUILD] = 40 + 30 * Math.sin(time * 0.5 + 2) + 20 * Math.cos(time * 0.9);
            demands[DEFEND] = 35 + 35 * Math.sin(time * 0.6 + 4) + 15 * Math.cos(time * 1.1);

            // Clamp demands
            demands = demands.map(d => Math.max(5, Math.min(100, d)));

            // Update UI
            document.getElementById('forageFill').style.width = demands[FORAGE] + '%';
            document.getElementById('buildFill').style.width = demands[BUILD] + '%';
            document.getElementById('defendFill').style.width = demands[DEFEND] + '%';

            const zones = getZones();
            const counts = [0, 0, 0, 0];

            ants.forEach(ant => {
                // Response threshold model
                // Each ant checks: if demand for a task > its threshold, it responds
                let bestTask = IDLE;
                let bestUrgency = 0;
                for (let t = 0; t < 3; t++) {
                    const urgency = demands[t] - ant.thresholds[t];
                    if (urgency > bestUrgency) {
                        bestUrgency = urgency;
                        bestTask = t;
                    }
                }

                // Stochastic switching (some chance to switch)
                if (bestTask !== ant.task && Math.random() < 0.02 * Math.max(0, bestUrgency / 20)) {
                    ant.task = bestTask;
                }
                // Chance to go idle if no demand exceeds threshold
                if (bestUrgency <= 0 && ant.task !== IDLE && Math.random() < 0.005) {
                    ant.task = IDLE;
                }

                counts[ant.task]++;

                // Movement toward zone
                if (ant.task < 3) {
                    const zone = zones[ant.task];
                    const spread = 50 + demands[ant.task] * 0.8;
                    ant.targetX = zone.x + (Math.random() - 0.5) * spread;
                    ant.targetY = zone.y + (Math.random() - 0.5) * spread;
                } else {
                    ant.targetX = W / 2 + (Math.random() - 0.5) * 80;
                    ant.targetY = H / 2 + (Math.random() - 0.5) * 80;
                }

                // Smooth movement
                const dx = ant.targetX - ant.x;
                const dy = ant.targetY - ant.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist > 2) {
                    ant.vx += (dx / dist) * 0.3;
                    ant.vy += (dy / dist) * 0.3;
                }
                ant.vx *= 0.92;
                ant.vy *= 0.92;
                // Add wander
                ant.vx += (Math.random() - 0.5) * 0.5;
                ant.vy += (Math.random() - 0.5) * 0.5;
                ant.x += ant.vx;
                ant.y += ant.vy;

                // Keep in bounds
                ant.x = Math.max(10, Math.min(W - 10, ant.x));
                ant.y = Math.max(10, Math.min(H - 10, ant.y));
            });

            document.getElementById('foragerCount').textContent = counts[FORAGE];
            document.getElementById('builderCount').textContent = counts[BUILD];
            document.getElementById('defenderCount').textContent = counts[DEFEND];
            document.getElementById('idleCount').textContent = counts[IDLE];
        }

        function draw() {
            ctx.fillStyle = '#0a0e1a';
            ctx.fillRect(0, 0, W, H);

            const zones = getZones();

            // Draw zones
            zones.forEach((zone, i) => {
                const r = 60 + demands[i] * 1.2;
                const grad = ctx.createRadialGradient(zone.x, zone.y, 0, zone.x, zone.y, r);
                grad.addColorStop(0, zone.color + '30');
                grad.addColorStop(0.7, zone.color + '15');
                grad.addColorStop(1, 'transparent');
                ctx.fillStyle = grad;
                ctx.beginPath();
                ctx.arc(zone.x, zone.y, r, 0, Math.PI * 2);
                ctx.fill();

                // Zone border
                ctx.beginPath();
                ctx.arc(zone.x, zone.y, r, 0, Math.PI * 2);
                ctx.strokeStyle = zone.color + '40';
                ctx.lineWidth = 1.5;
                ctx.setLineDash([5, 5]);
                ctx.stroke();
                ctx.setLineDash([]);

                // Label
                ctx.fillStyle = zone.color;
                ctx.font = 'bold 14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(zone.label, zone.x, zone.y - r - 10);

                // Demand meter
                ctx.fillStyle = 'rgba(255,255,255,0.1)';
                ctx.fillRect(zone.x - 30, zone.y + r + 8, 60, 6);
                ctx.fillStyle = zone.color;
                ctx.fillRect(zone.x - 30, zone.y + r + 8, 60 * demands[i] / 100, 6);
            });

            // Colony center
            const cx = W / 2, cy = H / 2;
            const colGrad = ctx.createRadialGradient(cx, cy, 0, cx, cy, 40);
            colGrad.addColorStop(0, 'rgba(138,154,91,0.3)');
            colGrad.addColorStop(1, 'transparent');
            ctx.fillStyle = colGrad;
            ctx.beginPath();
            ctx.arc(cx, cy, 40, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#8A9A5B';
            ctx.font = '11px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('COLONY', cx, cy + 4);

            // Draw ants
            ants.forEach(ant => {
                ctx.beginPath();
                ctx.arc(ant.x, ant.y, 3, 0, Math.PI * 2);
                ctx.fillStyle = taskColors[ant.task];
                ctx.fill();
            });
        }

        let paused = false;
        function animate() {
            if (!paused) update();
            draw();
            requestAnimationFrame(animate);
        }

        // Event buttons
        document.getElementById('attackBtn').addEventListener('click', () => { demands[DEFEND] = 95; });
        document.getElementById('foodBtn').addEventListener('click', () => { demands[FORAGE] = 95; });
        document.getElementById('stormBtn').addEventListener('click', () => { demands[BUILD] = 95; });

        function reset() { init(); }
        window.reset = reset;
        document.getElementById('resetBtn').addEventListener('click', reset);
        document.getElementById('antCount').oninput = function() {
            document.getElementById('antVal').textContent = this.value;
        };
        document.getElementById('demandSpeed').oninput = function() {
            document.getElementById('demandVal').textContent = this.value;
        };
        document.getElementById('threshVar').oninput = function() {
            document.getElementById('threshVal').textContent = this.value;
        };
        document.getElementById('antCount').addEventListener('change', reset);
        document.getElementById('threshVar').addEventListener('change', reset);

        init();
        animate();
    </script>
    <script src="../assets/js/enhance.js"></script>
</body>
</html>
