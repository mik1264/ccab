<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bounded Confidence Model - Collective Intelligence - CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0a0e1a;
            color: #e0e0e0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            height: 100vh;
        }
        canvas { display: block; }
        .back-link {
            position: fixed; top: 15px; left: 15px; z-index: 100;
            color: #8A9A5B; text-decoration: none;
            background: rgba(10,14,26,0.8); border: 2px solid #8A9A5B;
            border-radius: 25px; padding: 10px 20px;
            font-size: 14px; font-weight: 500;
            transition: background 0.3s;
        }
        .back-link:hover { background: rgba(138,154,91,0.3); }
        .controls {
            position: fixed; top: 15px; right: 15px; z-index: 100;
            background: rgba(10,14,26,0.85); backdrop-filter: blur(10px);
            border-radius: 10px; padding: 20px; max-width: 300px;
            border: 1px solid rgba(138,154,91,0.3);
        }
        .controls h3 {
            font-size: 14px; color: #8A9A5B; margin-bottom: 12px;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .control-group { margin-bottom: 12px; }
        .control-group label {
            display: block; font-size: 12px; color: #999; margin-bottom: 4px;
        }
        .control-group input[type="range"] {
            width: 100%; accent-color: #8A9A5B;
        }
        .control-group .value {
            float: right; color: #8A9A5B; font-size: 12px; font-weight: 600;
        }
        .presets { margin-bottom: 12px; }
        .presets label {
            display: block; font-size: 12px; color: #999; margin-bottom: 6px;
        }
        .preset-btns { display: flex; gap: 6px; }
        .preset-btn {
            flex: 1; padding: 6px 4px;
            background: rgba(138,154,91,0.2); border: 1px solid rgba(138,154,91,0.4);
            color: #8A9A5B; border-radius: 6px; cursor: pointer;
            font-size: 11px; font-weight: 600;
            transition: background 0.3s;
        }
        .preset-btn:hover { background: rgba(138,154,91,0.4); }
        .preset-btn.active { background: rgba(138,154,91,0.5); border-color: #8A9A5B; }
        .metrics {
            margin-top: 12px; padding-top: 10px;
            border-top: 1px solid rgba(138,154,91,0.2);
        }
        .metric {
            display: flex; justify-content: space-between;
            font-size: 12px; margin-bottom: 5px;
        }
        .metric-label { color: #888; }
        .metric-value { color: #DDA15E; font-weight: 600; }
        .btn {
            width: 100%; padding: 8px; margin-top: 8px;
            background: rgba(138,154,91,0.3); border: 1px solid #8A9A5B;
            color: #8A9A5B; border-radius: 6px; cursor: pointer;
            font-size: 12px; font-weight: 600;
            transition: background 0.3s;
        }
        .btn:hover { background: rgba(138,154,91,0.5); }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">&larr; Collective Intelligence</a>
    <div class="controls">
        <h3>Opinion Dynamics</h3>
        <div class="presets">
            <label>Presets</label>
            <div class="preset-btns">
                <button class="preset-btn" id="preConsensus">Consensus</button>
                <button class="preset-btn" id="prePolar">Polarize</button>
                <button class="preset-btn" id="preFragment">Fragment</button>
            </div>
        </div>
        <div class="control-group">
            <label>Tolerance (epsilon) <span class="value" id="epsilonVal">0.25</span></label>
            <input type="range" id="epsilon" min="5" max="50" value="25">
        </div>
        <div class="control-group">
            <label>Interaction Strength <span class="value" id="strengthVal">0.10</span></label>
            <input type="range" id="strength" min="1" max="30" value="10">
        </div>
        <div class="control-group">
            <label>Agent Count <span class="value" id="agentCountVal">250</span></label>
            <input type="range" id="agentCount" min="50" max="500" value="250" step="25">
        </div>
        <div class="control-group">
            <label>Drift Speed <span class="value" id="driftVal">0.5</span></label>
            <input type="range" id="drift" min="1" max="20" value="5">
        </div>
        <div class="metrics">
            <div class="metric">
                <span class="metric-label">Opinion Clusters</span>
                <span class="metric-value" id="clusterCount">-</span>
            </div>
            <div class="metric">
                <span class="metric-label">Convergence</span>
                <span class="metric-value" id="convergence">0%</span>
            </div>
        </div>
        <button class="btn" id="resetBtn">Reset</button>
    </div>
    <canvas id="canvas"></canvas>

    <script>
    (function() {
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let W, H;
        let agents = [];
        let animId;
        let paused = false;

        function resize() {
            W = canvas.width = window.innerWidth;
            H = canvas.height = window.innerHeight;
        }
        resize();
        window.addEventListener('resize', resize);

        function getParams() {
            return {
                epsilon: parseInt(document.getElementById('epsilon').value) / 100,
                strength: parseInt(document.getElementById('strength').value) / 100,
                count: parseInt(document.getElementById('agentCount').value),
                drift: parseInt(document.getElementById('drift').value) / 10
            };
        }

        function opinionColor(op) {
            // Red (0) through purple (0.5) to blue (1)
            const r = Math.floor(255 * Math.max(0, 1 - op * 2));
            const g = Math.floor(80 * (1 - Math.abs(op - 0.5) * 2));
            const b = Math.floor(255 * Math.max(0, op * 2 - 1));
            // Add some warmth
            return 'rgb(' + (r + 30) + ',' + (g + 40) + ',' + (b + 50) + ')';
        }

        function initAgents() {
            const p = getParams();
            agents = [];
            const histArea = 80; // reserve bottom for histogram
            for (let i = 0; i < p.count; i++) {
                agents.push({
                    x: 50 + Math.random() * (W - 100),
                    y: 50 + Math.random() * (H - 100 - histArea),
                    opinion: Math.random(),
                    vx: 0, vy: 0
                });
            }
        }

        function update() {
            const p = getParams();
            const interactRadius = 50;
            const histArea = 80;

            // Random walk drift
            for (let i = 0; i < agents.length; i++) {
                const a = agents[i];
                a.vx += (Math.random() - 0.5) * p.drift * 0.5;
                a.vy += (Math.random() - 0.5) * p.drift * 0.5;
                a.vx *= 0.9;
                a.vy *= 0.9;
                a.x += a.vx;
                a.y += a.vy;

                // Boundary bounce
                if (a.x < 30) { a.x = 30; a.vx = Math.abs(a.vx); }
                if (a.x > W - 30) { a.x = W - 30; a.vx = -Math.abs(a.vx); }
                if (a.y < 30) { a.y = 30; a.vy = Math.abs(a.vy); }
                if (a.y > H - histArea - 30) { a.y = H - histArea - 30; a.vy = -Math.abs(a.vy); }
            }

            // Opinion interaction
            for (let i = 0; i < agents.length; i++) {
                const a = agents[i];
                for (let j = i + 1; j < agents.length; j++) {
                    const b = agents[j];
                    const dx = a.x - b.x;
                    const dy = a.y - b.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < interactRadius) {
                        const opDiff = Math.abs(a.opinion - b.opinion);
                        if (opDiff < p.epsilon) {
                            // Move opinions toward each other
                            const delta = (b.opinion - a.opinion) * p.strength;
                            a.opinion += delta;
                            b.opinion -= delta;
                            a.opinion = Math.max(0, Math.min(1, a.opinion));
                            b.opinion = Math.max(0, Math.min(1, b.opinion));
                        }
                    }
                }
            }
        }

        function countClusters() {
            // Bin opinions and count distinct peaks
            const bins = new Array(20).fill(0);
            for (let i = 0; i < agents.length; i++) {
                const bin = Math.min(19, Math.floor(agents[i].opinion * 20));
                bins[bin]++;
            }
            let clusters = 0;
            let inCluster = false;
            const threshold = agents.length * 0.02;
            for (let i = 0; i < bins.length; i++) {
                if (bins[i] > threshold && !inCluster) {
                    clusters++;
                    inCluster = true;
                } else if (bins[i] <= threshold) {
                    inCluster = false;
                }
            }
            return { clusters, bins };
        }

        function draw() {
            ctx.fillStyle = '#0a0e1a';
            ctx.fillRect(0, 0, W, H);

            const histArea = 80;
            const p = getParams();

            // Draw interaction lines (subtle)
            const interactRadius = 50;
            ctx.lineWidth = 0.5;
            for (let i = 0; i < agents.length; i++) {
                const a = agents[i];
                for (let j = i + 1; j < agents.length; j++) {
                    const b = agents[j];
                    const dx = a.x - b.x;
                    const dy = a.y - b.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < interactRadius) {
                        const opDiff = Math.abs(a.opinion - b.opinion);
                        if (opDiff < p.epsilon) {
                            ctx.beginPath();
                            ctx.moveTo(a.x, a.y);
                            ctx.lineTo(b.x, b.y);
                            ctx.strokeStyle = 'rgba(255,255,255,' + (0.03 * (1 - dist / interactRadius)) + ')';
                            ctx.stroke();
                        }
                    }
                }
            }

            // Draw agents
            for (let i = 0; i < agents.length; i++) {
                const a = agents[i];
                const color = opinionColor(a.opinion);

                // Glow
                ctx.beginPath();
                ctx.arc(a.x, a.y, 8, 0, Math.PI * 2);
                ctx.fillStyle = color.replace('rgb', 'rgba').replace(')', ',0.15)');
                ctx.fill();

                // Body
                ctx.beginPath();
                ctx.arc(a.x, a.y, 4, 0, Math.PI * 2);
                ctx.fillStyle = color;
                ctx.fill();
            }

            // Histogram at bottom
            const { clusters, bins } = countClusters();
            const histY = H - histArea;
            const histH = histArea - 15;
            const barW = (W - 80) / bins.length;
            const maxBin = Math.max(...bins, 1);

            // Histogram background
            ctx.fillStyle = 'rgba(10, 14, 26, 0.7)';
            ctx.fillRect(0, histY - 5, W, histArea + 5);
            ctx.strokeStyle = 'rgba(138,154,91,0.2)';
            ctx.beginPath();
            ctx.moveTo(0, histY - 5);
            ctx.lineTo(W, histY - 5);
            ctx.stroke();

            // Labels
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillStyle = '#ff666699';
            ctx.fillText('Opinion 0.0', 50, H - 3);
            ctx.fillStyle = '#6666ff99';
            ctx.fillText('Opinion 1.0', W - 50, H - 3);
            ctx.fillStyle = '#88888888';
            ctx.fillText('Opinion Distribution', W / 2, H - 3);

            for (let i = 0; i < bins.length; i++) {
                const barH = (bins[i] / maxBin) * histH;
                const op = (i + 0.5) / bins.length;
                const color = opinionColor(op);
                ctx.fillStyle = color;
                ctx.globalAlpha = 0.7;
                ctx.fillRect(40 + i * barW, histY + histH - barH, barW - 2, barH);
                ctx.globalAlpha = 1;
            }

            // Update metrics
            document.getElementById('clusterCount').textContent = clusters;
            // Convergence: inverse of opinion variance
            let mean = 0;
            for (let i = 0; i < agents.length; i++) mean += agents[i].opinion;
            mean /= agents.length;
            let variance = 0;
            for (let i = 0; i < agents.length; i++) {
                const d = agents[i].opinion - mean;
                variance += d * d;
            }
            variance /= agents.length;
            const conv = Math.max(0, 100 * (1 - variance * 4));
            document.getElementById('convergence').textContent = conv.toFixed(0) + '%';
        }

        function animate() {
            if (!paused) update();
            draw();
            animId = requestAnimationFrame(animate);
        }

        function reset() {
            cancelAnimationFrame(animId);
            initAgents();
            animate();
        }
        window.reset = reset;

        // Presets
        function setPreset(eps) {
            document.getElementById('epsilon').value = Math.round(eps * 100);
            document.getElementById('epsilonVal').textContent = eps.toFixed(2);
            reset();
        }
        document.getElementById('preConsensus').onclick = function() { setPreset(0.40); };
        document.getElementById('prePolar').onclick = function() { setPreset(0.20); };
        document.getElementById('preFragment').onclick = function() { setPreset(0.08); };

        // UI bindings
        document.getElementById('epsilon').oninput = function() {
            document.getElementById('epsilonVal').textContent = (this.value / 100).toFixed(2);
        };
        document.getElementById('strength').oninput = function() {
            document.getElementById('strengthVal').textContent = (this.value / 100).toFixed(2);
        };
        document.getElementById('agentCount').oninput = function() {
            document.getElementById('agentCountVal').textContent = this.value;
        };
        document.getElementById('drift').oninput = function() {
            document.getElementById('driftVal').textContent = (this.value / 10).toFixed(1);
        };
        document.getElementById('resetBtn').onclick = reset;
        document.getElementById('agentCount').onchange = reset;

        initAgents();
        animate();
    })();
    </script>
    <script src="../assets/js/enhance.js"></script>
</body>
</html>
