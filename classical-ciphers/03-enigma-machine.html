<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enigma Machine Simulator - Rotor Visualization - CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            font-family: 'Courier New', monospace;
            color: #e8e8f0;
        }
        .back-link {
            position: fixed; top: 15px; left: 15px;
            padding: 10px 18px; background: rgba(0,0,0,0.6);
            color: #ffaa00; text-decoration: none; border-radius: 8px;
            font-size: 14px; z-index: 1000; border: 1px solid rgba(255,170,0,0.3);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 70px 20px 40px;
        }
        h1 { font-size: 1.8rem; color: #ffaa00; margin-bottom: 10px; text-align: center; }
        .desc { text-align: center; color: #888; margin-bottom: 30px; }
        .enigma-machine {
            background: linear-gradient(145deg, #2a2a3a, #1a1a2a);
            border-radius: 20px;
            padding: 30px;
            border: 3px solid #444;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5), inset 0 2px 10px rgba(255,255,255,0.1);
        }
        .rotors-section {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 30px;
        }
        .rotor {
            width: 80px;
            text-align: center;
        }
        .rotor-label {
            color: #ffaa00;
            font-size: 0.8rem;
            margin-bottom: 10px;
        }
        .rotor-display {
            width: 70px;
            height: 100px;
            background: linear-gradient(145deg, #333, #222);
            border: 2px solid #555;
            border-radius: 10px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        .rotor-window {
            font-size: 2rem;
            font-weight: bold;
            color: #ffaa00;
            text-shadow: 0 0 10px rgba(255,170,0,0.5);
        }
        .rotor-btn {
            width: 30px; height: 25px;
            background: #444;
            border: 1px solid #666;
            color: #fff;
            cursor: pointer;
            margin: 5px 0;
            border-radius: 4px;
        }
        .rotor-btn:hover { background: #555; }
        .lampboard {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            max-width: 600px;
            margin: 0 auto 30px;
        }
        .lamp {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #444, #222);
            border: 2px solid #555;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #666;
            transition: all 0.1s;
        }
        .lamp.lit {
            background: radial-gradient(circle at 30% 30%, #ffee00, #ffaa00);
            color: #000;
            box-shadow: 0 0 20px rgba(255,200,0,0.8);
        }
        .keyboard {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            max-width: 600px;
            margin: 0 auto 20px;
        }
        .key {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: linear-gradient(145deg, #3a3a4a, #2a2a3a);
            border: 2px solid #555;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #ccc;
            cursor: pointer;
            transition: all 0.1s;
        }
        .key:hover { background: linear-gradient(145deg, #4a4a5a, #3a3a4a); }
        .key:active, .key.pressed {
            transform: translateY(2px);
            background: linear-gradient(145deg, #2a2a3a, #1a1a2a);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
        }
        .output-section {
            text-align: center;
            margin-top: 20px;
        }
        .output-label { color: #888; font-size: 0.8rem; margin-bottom: 10px; }
        .output-text {
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,170,0,0.3);
            border-radius: 8px;
            padding: 15px;
            min-height: 50px;
            font-size: 1.2rem;
            letter-spacing: 4px;
            color: #ffaa00;
        }
        .wiring-diagram {
            margin-top: 30px;
            text-align: center;
        }
        #wiringCanvas {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            border: 1px solid rgba(255,170,0,0.2);
        }
        .info-box {
            background: rgba(255,170,0,0.1);
            border: 1px solid rgba(255,170,0,0.2);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-size: 0.8rem;
            line-height: 1.6;
            color: #aaa;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        .btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #ffaa00, #cc8800);
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Courier New', monospace;
        }
        .btn:hover { transform: translateY(-2px); }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back</a>

    <div class="container">
        <h1>Enigma Machine Simulator</h1>
        <p class="desc">The famous WWII encryption device. Watch signals flow through rotors, reflector, and plugboard.</p>

        <div class="enigma-machine">
            <div class="rotors-section">
                <div class="rotor">
                    <div class="rotor-label">Rotor I</div>
                    <div class="rotor-display">
                        <button class="rotor-btn" onclick="rotorStep(0, 1)">+</button>
                        <div class="rotor-window" id="rotor0">A</div>
                        <button class="rotor-btn" onclick="rotorStep(0, -1)">-</button>
                    </div>
                </div>
                <div class="rotor">
                    <div class="rotor-label">Rotor II</div>
                    <div class="rotor-display">
                        <button class="rotor-btn" onclick="rotorStep(1, 1)">+</button>
                        <div class="rotor-window" id="rotor1">A</div>
                        <button class="rotor-btn" onclick="rotorStep(1, -1)">-</button>
                    </div>
                </div>
                <div class="rotor">
                    <div class="rotor-label">Rotor III</div>
                    <div class="rotor-display">
                        <button class="rotor-btn" onclick="rotorStep(2, 1)">+</button>
                        <div class="rotor-window" id="rotor2">A</div>
                        <button class="rotor-btn" onclick="rotorStep(2, -1)">-</button>
                    </div>
                </div>
            </div>

            <div class="lampboard" id="lampboard"></div>

            <div class="keyboard" id="keyboard"></div>

            <div class="output-section">
                <div class="output-label">Encrypted Output</div>
                <div class="output-text" id="output"></div>
            </div>

            <div class="controls">
                <button class="btn" onclick="resetMachine()">Reset</button>
                <button class="btn" onclick="clearOutput()">Clear Output</button>
            </div>
        </div>

        <div class="wiring-diagram">
            <canvas id="wiringCanvas" width="800" height="200"></canvas>
        </div>

        <div class="info-box">
            <strong>How it works:</strong> Each keypress first advances the rightmost rotor. The signal then passes through the rotors, reflects off the reflector, and returns through the rotors again. The rotor wiring scrambles the signal at each step. With 3 rotors × 26 positions × plugboard settings, the Enigma had approximately 158,962,555,217,826,360,000 possible combinations!
        </div>
    </div>

    <script>
        const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';

        // Simplified rotor wirings (historical approximation)
        const rotorWirings = [
            'EKMFLGDQVZNTOWYHXUSPAIBRCJ', // Rotor I
            'AJDKSIRUXBLHWTMCQGZNPYFVOE', // Rotor II
            'BDFHJLCPRTXVZNYEIWGAKMUSQO'  // Rotor III
        ];
        const reflector = 'YRUHQSLDPXNGOKMIEBFZCWVJAT'; // Reflector B

        let rotorPositions = [0, 0, 0];
        let lastEncryptedChar = '';
        let signalPath = [];

        function initKeyboard() {
            const keyboard = document.getElementById('keyboard');
            const lampboard = document.getElementById('lampboard');

            for (let char of alphabet) {
                // Lamp
                const lamp = document.createElement('div');
                lamp.className = 'lamp';
                lamp.id = 'lamp-' + char;
                lamp.textContent = char;
                lampboard.appendChild(lamp);

                // Key
                const key = document.createElement('div');
                key.className = 'key';
                key.textContent = char;
                key.addEventListener('mousedown', () => pressKey(char));
                key.addEventListener('mouseup', () => releaseKey(char));
                key.addEventListener('mouseleave', () => releaseKey(char));
                keyboard.appendChild(key);
            }
        }

        function rotorStep(rotor, direction) {
            rotorPositions[rotor] = (rotorPositions[rotor] + direction + 26) % 26;
            updateRotorDisplay();
        }

        function updateRotorDisplay() {
            for (let i = 0; i < 3; i++) {
                document.getElementById('rotor' + i).textContent = alphabet[rotorPositions[i]];
            }
        }

        function advanceRotors() {
            // Rightmost rotor always advances
            rotorPositions[2] = (rotorPositions[2] + 1) % 26;

            // Notch positions (simplified)
            if (rotorPositions[2] === 17) { // Q notch for rotor III
                rotorPositions[1] = (rotorPositions[1] + 1) % 26;
            }
            if (rotorPositions[1] === 5) { // E notch for rotor II
                rotorPositions[0] = (rotorPositions[0] + 1) % 26;
            }

            updateRotorDisplay();
        }

        function encryptChar(char) {
            signalPath = [];
            let charIndex = alphabet.indexOf(char);
            signalPath.push({ stage: 'input', char: char, index: charIndex });

            // Through rotors (right to left)
            for (let r = 2; r >= 0; r--) {
                const shifted = (charIndex + rotorPositions[r]) % 26;
                charIndex = alphabet.indexOf(rotorWirings[r][shifted]);
                charIndex = (charIndex - rotorPositions[r] + 26) % 26;
                signalPath.push({ stage: 'rotor' + (3-r), char: alphabet[charIndex], index: charIndex });
            }

            // Through reflector
            charIndex = alphabet.indexOf(reflector[charIndex]);
            signalPath.push({ stage: 'reflector', char: alphabet[charIndex], index: charIndex });

            // Back through rotors (left to right)
            for (let r = 0; r < 3; r++) {
                const shifted = (charIndex + rotorPositions[r]) % 26;
                const rotorReverse = Array(26).fill(0);
                for (let i = 0; i < 26; i++) {
                    rotorReverse[alphabet.indexOf(rotorWirings[r][i])] = i;
                }
                charIndex = rotorReverse[shifted];
                charIndex = (charIndex - rotorPositions[r] + 26) % 26;
                signalPath.push({ stage: 'rotor' + (3-r) + '-back', char: alphabet[charIndex], index: charIndex });
            }

            signalPath.push({ stage: 'output', char: alphabet[charIndex], index: charIndex });

            return alphabet[charIndex];
        }

        function pressKey(char) {
            // Advance rotors first
            advanceRotors();

            // Encrypt
            const encrypted = encryptChar(char);
            lastEncryptedChar = encrypted;

            // Light lamp
            document.getElementById('lamp-' + encrypted).classList.add('lit');

            // Add to output
            document.getElementById('output').textContent += encrypted;

            // Draw signal path
            drawWiring();
        }

        function releaseKey(char) {
            // Turn off lamp
            if (lastEncryptedChar) {
                document.getElementById('lamp-' + lastEncryptedChar).classList.remove('lit');
            }
        }

        function drawWiring() {
            const canvas = document.getElementById('wiringCanvas');
            const ctx = canvas.getContext('2d');
            const w = canvas.width;
            const h = canvas.height;

            ctx.clearRect(0, 0, w, h);

            if (signalPath.length === 0) return;

            const stages = ['input', 'rotor3', 'rotor2', 'rotor1', 'reflector', 'rotor1-back', 'rotor2-back', 'rotor3-back', 'output'];
            const stageX = stages.map((_, i) => 50 + (i / (stages.length - 1)) * (w - 100));

            // Draw stage labels
            ctx.font = '10px Courier New';
            ctx.fillStyle = '#666';
            ctx.textAlign = 'center';
            const labels = ['IN', 'R3', 'R2', 'R1', 'REF', 'R1', 'R2', 'R3', 'OUT'];
            labels.forEach((label, i) => {
                ctx.fillText(label, stageX[i], h - 10);
            });

            // Draw signal path
            ctx.beginPath();
            ctx.strokeStyle = '#ffaa00';
            ctx.lineWidth = 3;
            ctx.shadowBlur = 10;
            ctx.shadowColor = '#ffaa00';

            for (let i = 0; i < signalPath.length; i++) {
                const x = stageX[i];
                const y = 30 + (signalPath[i].index / 25) * (h - 70);

                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }

                // Draw point
                ctx.fillStyle = '#ffaa00';
                ctx.beginPath();
                ctx.arc(x, y, 5, 0, Math.PI * 2);
                ctx.fill();

                // Draw letter
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 12px Courier New';
                ctx.fillText(signalPath[i].char, x, y - 12);
            }

            ctx.stroke();
        }

        function resetMachine() {
            rotorPositions = [0, 0, 0];
            updateRotorDisplay();
            clearOutput();
        }

        function clearOutput() {
            document.getElementById('output').textContent = '';
            signalPath = [];
            const ctx = document.getElementById('wiringCanvas').getContext('2d');
            ctx.clearRect(0, 0, 800, 200);
        }

        // Keyboard support
        document.addEventListener('keydown', (e) => {
            const char = e.key.toUpperCase();
            if (alphabet.includes(char)) {
                pressKey(char);
            }
        });

        document.addEventListener('keyup', (e) => {
            const char = e.key.toUpperCase();
            if (alphabet.includes(char)) {
                releaseKey(char);
            }
        });

        // Expose for enhance.js keyboard shortcuts
        window.reset = resetMachine;
        window.init = function() { resetMachine(); initKeyboard(); };

        initKeyboard();
        updateRotorDisplay();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
