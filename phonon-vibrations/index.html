<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Phonon / Crystal Lattice Vibrations</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; overflow: hidden; font-family: sans-serif; }
canvas { display: block; }
#title {
    position: fixed; top: 50px; left: 50%; transform: translateX(-50%);
    color: #38bdf8; font-size: 20px; font-weight: bold; z-index: 10;
    text-shadow: 0 0 20px rgba(56,189,248,0.5);
    pointer-events: none;
}
#controls {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
    display: flex; gap: 15px; align-items: center; z-index: 10;
    background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 10px;
    flex-wrap: wrap; justify-content: center; max-width: 90%;
}
#controls label { color: #38bdf8; font-size: 13px; white-space: nowrap; }
#controls input[type=range] { width: 80px; cursor: pointer; }
#controls button {
    background: rgba(56,189,248,0.2); color: #38bdf8; border: 1px solid #38bdf8;
    padding: 5px 12px; border-radius: 5px; cursor: pointer; font-size: 13px;
}
#controls button:hover { background: rgba(56,189,248,0.4); }
#controls button.active { background: rgba(56,189,248,0.5); }
#info {
    position: fixed; top: 80px; left: 20px; color: #94a3b8; font-size: 12px;
    z-index: 10; line-height: 1.6;
    background: rgba(0,0,0,0.5); padding: 8px 12px; border-radius: 8px;
}
</style>
</head>
<body>
<a href="../index.html" style="position:fixed;top:10px;left:10px;padding:8px 16px;background:rgba(0,0,0,0.7);color:#fbbf24;text-decoration:none;border-radius:6px;font-size:14px;z-index:999;font-family:sans-serif;">&#8592; Back to Gallery</a>
<div id="title">Phonon / Crystal Lattice Vibrations</div>
<div id="info">
    Click on any atom to perturb it<br>
    Mode: <span id="modeDisplay" style="color:#38bdf8">Acoustic</span>
</div>
<div id="controls">
    <label>Spring K: <input type="range" id="springK" min="1" max="20" value="8" step="1"></label>
    <label>Mass: <input type="range" id="mass" min="1" max="10" value="3" step="1"></label>
    <label>Damping: <input type="range" id="damping" min="0" max="10" value="1" step="1"></label>
    <button id="acousticBtn" class="active" onclick="setMode('acoustic')">Acoustic</button>
    <button id="opticalBtn" onclick="setMode('optical')">Optical</button>
    <button id="pulseBtn" onclick="pulse()">Pulse Center</button>
    <button id="waveBtn" onclick="startWave()">Standing Wave</button>
    <button id="resetBtn" onclick="resetLattice()">Reset</button>
</div>
<canvas id="canvas"></canvas>
<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let W, H;
let springK = 8;
let atomMass = 3;
let damping = 0.001;
let mode = 'acoustic';

const ROWS = 20;
const COLS = 28;
let atoms = [];
let spacing;

function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
    spacing = Math.min((W - 100) / COLS, (H - 200) / ROWS);
}

function initLattice() {
    atoms = [];
    const offsetX = (W - (COLS - 1) * spacing) / 2;
    const offsetY = (H - (ROWS - 1) * spacing) / 2 + 20;

    for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
            const isHeavy = (mode === 'optical') && ((r + c) % 2 === 1);
            atoms.push({
                restX: offsetX + c * spacing,
                restY: offsetY + r * spacing,
                x: offsetX + c * spacing,
                y: offsetY + r * spacing,
                vx: 0, vy: 0,
                row: r, col: c,
                mass: isHeavy ? atomMass * 2.5 : atomMass,
                isHeavy: isHeavy
            });
        }
    }
}

function getAtom(r, c) {
    if (r < 0 || r >= ROWS || c < 0 || c >= COLS) return null;
    return atoms[r * COLS + c];
}

function updatePhysics(dt) {
    const k = springK * 0.5;
    const damp = 1 - damping * 0.01;

    for (const atom of atoms) {
        let fx = 0, fy = 0;

        // Spring forces from neighbors
        const neighbors = [
            getAtom(atom.row - 1, atom.col),
            getAtom(atom.row + 1, atom.col),
            getAtom(atom.row, atom.col - 1),
            getAtom(atom.row, atom.col + 1)
        ];

        for (const n of neighbors) {
            if (!n) continue;
            // Displacement from rest positions
            const dxRest = n.restX - atom.restX;
            const dyRest = n.restY - atom.restY;
            const restDist = Math.sqrt(dxRest * dxRest + dyRest * dyRest);

            const dx = n.x - atom.x;
            const dy = n.y - atom.y;
            const dist = Math.sqrt(dx * dx + dy * dy);

            if (dist > 0) {
                const stretch = dist - restDist;
                fx += k * stretch * (dx / dist);
                fy += k * stretch * (dy / dist);
            }
        }

        // Restoring force to rest position
        fx += (atom.restX - atom.x) * k * 0.02;
        fy += (atom.restY - atom.y) * k * 0.02;

        // Acceleration
        atom.vx += (fx / atom.mass) * dt;
        atom.vy += (fy / atom.mass) * dt;

        // Damping
        atom.vx *= damp;
        atom.vy *= damp;
    }

    // Update positions
    for (const atom of atoms) {
        atom.x += atom.vx * dt;
        atom.y += atom.vy * dt;
    }
}

function draw() {
    ctx.fillStyle = '#0a0e1a';
    ctx.fillRect(0, 0, W, H);

    // Draw springs (bonds)
    for (const atom of atoms) {
        const neighbors = [
            getAtom(atom.row, atom.col + 1),
            getAtom(atom.row + 1, atom.col)
        ];

        for (const n of neighbors) {
            if (!n) continue;
            const dx = n.x - atom.x;
            const dy = n.y - atom.y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            const stretch = Math.abs(dist - spacing);
            const intensity = Math.min(stretch / (spacing * 0.3), 1);

            ctx.strokeStyle = `rgba(56,189,248,${0.15 + intensity * 0.4})`;
            ctx.lineWidth = 1 + intensity;
            ctx.beginPath();
            ctx.moveTo(atom.x, atom.y);
            ctx.lineTo(n.x, n.y);
            ctx.stroke();
        }
    }

    // Draw atoms
    for (const atom of atoms) {
        const dx = atom.x - atom.restX;
        const dy = atom.y - atom.restY;
        const displacement = Math.sqrt(dx * dx + dy * dy);
        const intensity = Math.min(displacement / 15, 1);

        const radius = atom.isHeavy ? spacing * 0.22 : spacing * 0.15;

        // Glow
        if (intensity > 0.05) {
            const glow = ctx.createRadialGradient(atom.x, atom.y, 0, atom.x, atom.y, radius * 3);
            glow.addColorStop(0, `rgba(56,189,248,${intensity * 0.3})`);
            glow.addColorStop(1, 'rgba(56,189,248,0)');
            ctx.fillStyle = glow;
            ctx.beginPath();
            ctx.arc(atom.x, atom.y, radius * 3, 0, Math.PI * 2);
            ctx.fill();
        }

        // Atom body
        ctx.beginPath();
        ctx.arc(atom.x, atom.y, radius, 0, Math.PI * 2);

        if (atom.isHeavy) {
            const r = Math.floor(100 + intensity * 155);
            const g = Math.floor(50 + intensity * 100);
            const b = Math.floor(50);
            ctx.fillStyle = `rgb(${r},${g},${b})`;
        } else {
            const r = Math.floor(40 + intensity * 200);
            const g = Math.floor(120 + intensity * 80);
            const b = Math.floor(200 + intensity * 55);
            ctx.fillStyle = `rgb(${r},${g},${b})`;
        }
        ctx.fill();

        // Highlight
        ctx.beginPath();
        ctx.arc(atom.x - radius * 0.2, atom.y - radius * 0.2, radius * 0.4, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(255,255,255,0.15)';
        ctx.fill();
    }

    // Draw velocity vectors (optional, subtle)
    for (const atom of atoms) {
        const speed = Math.sqrt(atom.vx * atom.vx + atom.vy * atom.vy);
        if (speed > 0.5) {
            const scale = Math.min(speed * 2, 15);
            const nx = atom.vx / speed;
            const ny = atom.vy / speed;
            ctx.strokeStyle = 'rgba(251,191,36,0.3)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(atom.x, atom.y);
            ctx.lineTo(atom.x + nx * scale, atom.y + ny * scale);
            ctx.stroke();
        }
    }
}

function pulse() {
    const centerR = Math.floor(ROWS / 2);
    const centerC = Math.floor(COLS / 2);
    const atom = getAtom(centerR, centerC);
    if (atom) {
        atom.vy = -60;
        atom.vx = 0;
    }
    // Also perturb neighbors slightly
    const neighbors = [
        getAtom(centerR - 1, centerC),
        getAtom(centerR + 1, centerC),
        getAtom(centerR, centerC - 1),
        getAtom(centerR, centerC + 1)
    ];
    for (const n of neighbors) {
        if (n) {
            n.vy = -30;
        }
    }
}

function startWave() {
    // Create a standing wave pattern
    for (const atom of atoms) {
        const phase = (atom.col / COLS) * Math.PI * 4;
        atom.vy = Math.sin(phase) * 20;
        if (mode === 'optical' && atom.isHeavy) {
            atom.vy *= -0.5; // Opposite phase for optical
        }
    }
}

function resetLattice() {
    initLattice();
}

function setMode(m) {
    mode = m;
    document.querySelectorAll('#controls button').forEach(b => b.classList.remove('active'));
    const btn = document.getElementById(m + 'Btn');
    if (btn) btn.classList.add('active');
    document.getElementById('modeDisplay').textContent = m.charAt(0).toUpperCase() + m.slice(1);
    initLattice();
}

canvas.addEventListener('mousedown', (e) => {
    const mx = e.clientX;
    const my = e.clientY;
    let closest = null;
    let closestDist = Infinity;

    for (const atom of atoms) {
        const dx = mx - atom.x;
        const dy = my - atom.y;
        const d = dx * dx + dy * dy;
        if (d < closestDist) {
            closestDist = d;
            closest = atom;
        }
    }

    if (closest && closestDist < spacing * spacing) {
        closest.vy = -80;
        closest.vx = (Math.random() - 0.5) * 40;
    }
});

canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    const touch = e.touches[0];
    const mx = touch.clientX;
    const my = touch.clientY;
    let closest = null;
    let closestDist = Infinity;

    for (const atom of atoms) {
        const dx = mx - atom.x;
        const dy = my - atom.y;
        const d = dx * dx + dy * dy;
        if (d < closestDist) {
            closestDist = d;
            closest = atom;
        }
    }

    if (closest && closestDist < spacing * spacing) {
        closest.vy = -80;
    }
});

document.getElementById('springK').addEventListener('input', (e) => {
    springK = parseInt(e.target.value);
});
document.getElementById('mass').addEventListener('input', (e) => {
    atomMass = parseInt(e.target.value);
    // Update masses
    for (const atom of atoms) {
        atom.mass = atom.isHeavy ? atomMass * 2.5 : atomMass;
    }
});
document.getElementById('damping').addEventListener('input', (e) => {
    damping = parseInt(e.target.value);
});

window.setMode = setMode;
window.pulse = pulse;
window.startWave = startWave;
window.resetLattice = resetLattice;

window.addEventListener('resize', () => { resize(); initLattice(); });

function animate() {
    updatePhysics(0.8);
    draw();
    requestAnimationFrame(animate);
}

resize();
initLattice();
animate();
</script>
</body>
</html>
