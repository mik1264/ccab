<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aircraft Maintenance Probability Engine | CCAB</title>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&family=Nunito:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --sage: #8A9A5B;
            --moss: #606C38;
            --earth: #DDA15E;
            --cream: #FEFAE0;
            --terracotta: #BC6C25;
            --dark-moss: #3d4423;
            --panel-bg: rgba(255,255,255,0.75);
            --card-bg: rgba(255,255,255,0.6);
            --danger: #c0392b;
            --warning: #e67e22;
            --success: #27ae60;
            --info: #2980b9;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #FEFAE0 0%, #F4F1DE 50%, #EDE8D5 100%);
            color: var(--dark-moss);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .organic-shape {
            position: fixed;
            z-index: 0;
            opacity: 0.08;
            pointer-events: none;
        }
        .shape-1 {
            width: 600px; height: 600px;
            background: var(--sage);
            top: -200px; right: -150px;
            border-radius: 63% 37% 54% 46% / 55% 48% 52% 45%;
            animation: morph 30s infinite ease-in-out;
        }
        .shape-2 {
            width: 500px; height: 500px;
            background: var(--earth);
            bottom: -100px; left: -150px;
            border-radius: 40% 60% 70% 30% / 40% 40% 60% 60%;
            animation: morph 30s infinite ease-in-out reverse;
        }
        @keyframes morph {
            0%, 100% { border-radius: 63% 37% 54% 46% / 55% 48% 52% 45%; }
            25% { border-radius: 40% 60% 70% 30% / 40% 40% 60% 60%; }
            50% { border-radius: 50% 50% 33% 67% / 55% 27% 73% 45%; }
            75% { border-radius: 70% 30% 50% 50% / 30% 65% 35% 70%; }
        }

        .organic-back-link {
            position: fixed;
            top: 20px; left: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(10px);
            border-radius: 50px;
            text-decoration: none;
            color: var(--moss);
            font-weight: 600;
            font-size: 0.9rem;
            border: 1px solid rgba(138,154,91,0.3);
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        .organic-back-link:hover {
            background: rgba(255,255,255,0.95);
            transform: translateX(-3px);
            border-color: var(--earth);
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px 60px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-top: 50px;
        }
        header h1 {
            font-family: 'Lora', serif;
            font-size: 2.2rem;
            color: var(--dark-moss);
            margin-bottom: 8px;
        }
        header p {
            color: var(--moss);
            font-size: 1.05rem;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Layout */
        .app-layout {
            display: grid;
            grid-template-columns: 360px 1fr;
            gap: 24px;
            align-items: start;
        }
        @media (max-width: 1000px) {
            .app-layout { grid-template-columns: 1fr; }
        }

        /* Panels */
        .panel {
            background: var(--panel-bg);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            border: 1px solid rgba(138,154,91,0.2);
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        .panel h2 {
            font-family: 'Lora', serif;
            font-size: 1.25rem;
            color: var(--dark-moss);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .panel h3 {
            font-family: 'Lora', serif;
            font-size: 1.05rem;
            color: var(--moss);
            margin: 16px 0 10px;
        }

        /* Form elements */
        label {
            display: block;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--moss);
            margin-bottom: 4px;
        }
        select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid rgba(138,154,91,0.3);
            border-radius: 12px;
            background: rgba(255,255,255,0.8);
            font-family: 'Nunito', sans-serif;
            font-size: 0.95rem;
            color: var(--dark-moss);
            transition: border-color 0.2s;
            outline: none;
        }
        select:focus, input:focus {
            border-color: var(--earth);
            box-shadow: 0 0 0 3px rgba(221,161,94,0.15);
        }
        .form-row {
            margin-bottom: 14px;
        }
        .form-row-inline {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 20px;
            border: none;
            border-radius: 12px;
            font-family: 'Nunito', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-primary {
            background: var(--moss);
            color: white;
        }
        .btn-primary:hover { background: var(--dark-moss); transform: translateY(-1px); }
        .btn-secondary {
            background: var(--earth);
            color: white;
        }
        .btn-secondary:hover { background: var(--terracotta); transform: translateY(-1px); }
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        .btn-danger:hover { background: #a93226; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        .btn-block { width: 100%; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        /* Fleet table */
        .fleet-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.85rem;
            margin-top: 10px;
        }
        .fleet-table th {
            background: rgba(96,108,56,0.1);
            padding: 8px 10px;
            text-align: left;
            font-weight: 700;
            color: var(--moss);
            border-bottom: 2px solid rgba(138,154,91,0.3);
        }
        .fleet-table th:first-child { border-radius: 10px 0 0 0; }
        .fleet-table th:last-child { border-radius: 0 10px 0 0; }
        .fleet-table td {
            padding: 6px 10px;
            border-bottom: 1px solid rgba(138,154,91,0.1);
            vertical-align: middle;
        }
        .fleet-table tr:hover td { background: rgba(138,154,91,0.05); }

        .status-badge {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        .status-op { background: rgba(39,174,96,0.15); color: var(--success); }
        .status-aog { background: rgba(192,57,43,0.15); color: var(--danger); }

        .days-input {
            width: 60px;
            padding: 4px 8px;
            border-radius: 8px;
            text-align: center;
        }

        .remove-btn {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 1.1rem;
            padding: 2px 6px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .remove-btn:hover { background: rgba(192,57,43,0.1); }

        /* Status toggle */
        .status-toggle {
            display: flex;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(138,154,91,0.3);
        }
        .status-toggle button {
            flex: 1;
            padding: 4px 8px;
            border: none;
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Nunito', sans-serif;
            background: rgba(255,255,255,0.5);
            color: var(--dark-moss);
        }
        .status-toggle button.active-op { background: var(--success); color: white; }
        .status-toggle button.active-aog { background: var(--danger); color: white; }

        /* Right column */
        .results-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Stats cards */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }
        .stat-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
            border: 1px solid rgba(138,154,91,0.15);
        }
        .stat-card .stat-value {
            font-family: 'Lora', serif;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--dark-moss);
        }
        .stat-card .stat-label {
            font-size: 0.8rem;
            color: var(--moss);
            font-weight: 600;
            margin-top: 2px;
        }
        .stat-card.stat-green .stat-value { color: var(--success); }
        .stat-card.stat-red .stat-value { color: var(--danger); }
        .stat-card.stat-orange .stat-value { color: var(--warning); }
        .stat-card.stat-blue .stat-value { color: var(--info); }

        /* Chart container */
        .chart-panel {
            background: var(--panel-bg);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            border: 1px solid rgba(138,154,91,0.2);
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        .chart-panel h2 {
            font-family: 'Lora', serif;
            font-size: 1.15rem;
            color: var(--dark-moss);
            margin-bottom: 12px;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 320px;
            background: rgba(255,255,255,0.4);
            border-radius: 14px;
            overflow: hidden;
        }
        .chart-container canvas {
            width: 100%;
            height: 100%;
        }

        /* Tabs */
        .tab-bar {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
            background: rgba(138,154,91,0.08);
            border-radius: 12px;
            padding: 4px;
        }
        .tab-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 10px;
            font-family: 'Nunito', sans-serif;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            background: transparent;
            color: var(--moss);
            transition: all 0.2s;
        }
        .tab-btn.active {
            background: white;
            color: var(--dark-moss);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Scenario panel */
        .scenario-card {
            background: rgba(255,255,255,0.5);
            border-radius: 14px;
            padding: 16px;
            margin-top: 12px;
            border: 1px solid rgba(138,154,91,0.15);
        }
        .scenario-card h4 {
            font-family: 'Lora', serif;
            font-size: 0.95rem;
            color: var(--dark-moss);
            margin-bottom: 8px;
        }
        .scenario-label {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 700;
            margin-right: 6px;
        }
        .scenario-a { background: rgba(41,128,185,0.15); color: var(--info); }
        .scenario-b { background: rgba(192,57,43,0.15); color: var(--danger); }

        /* Comparison table */
        .compare-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.85rem;
            margin-top: 10px;
        }
        .compare-table th {
            padding: 8px 12px;
            background: rgba(96,108,56,0.08);
            text-align: left;
            font-weight: 700;
            color: var(--moss);
        }
        .compare-table td {
            padding: 8px 12px;
            border-bottom: 1px solid rgba(138,154,91,0.1);
        }
        .compare-table .better { color: var(--success); font-weight: 700; }
        .compare-table .worse { color: var(--danger); font-weight: 700; }

        /* Progress bar for simulation */
        .sim-progress {
            width: 100%;
            height: 6px;
            background: rgba(138,154,91,0.15);
            border-radius: 3px;
            margin: 10px 0;
            overflow: hidden;
            display: none;
        }
        .sim-progress .bar {
            height: 100%;
            background: linear-gradient(90deg, var(--sage), var(--earth));
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s;
        }

        /* Export panel */
        .export-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        /* Tooltip */
        .info-tip {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px; height: 18px;
            border-radius: 50%;
            background: rgba(138,154,91,0.15);
            color: var(--moss);
            font-size: 0.7rem;
            font-weight: 700;
            cursor: help;
            position: relative;
        }
        .info-tip:hover::after {
            content: attr(data-tip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark-moss);
            color: white;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 400;
            white-space: nowrap;
            z-index: 100;
            margin-bottom: 4px;
        }

        /* Confidence interval legend */
        .ci-legend {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-top: 10px;
            font-size: 0.8rem;
        }
        .ci-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .ci-swatch {
            width: 24px;
            height: 12px;
            border-radius: 3px;
        }

        /* Preset buttons */
        .preset-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 14px;
        }
        .preset-btn {
            padding: 8px 10px;
            border: 1px solid rgba(138,154,91,0.25);
            border-radius: 10px;
            background: rgba(255,255,255,0.6);
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            font-family: 'Nunito', sans-serif;
        }
        .preset-btn:hover {
            border-color: var(--earth);
            background: rgba(255,255,255,0.9);
            transform: translateY(-1px);
        }
        .preset-btn .preset-name {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--dark-moss);
        }
        .preset-btn .preset-desc {
            font-size: 0.7rem;
            color: var(--moss);
        }

        /* Scrollable left panel */
        .left-panel {
            max-height: calc(100vh - 160px);
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--sage) transparent;
        }
        .left-panel::-webkit-scrollbar { width: 6px; }
        .left-panel::-webkit-scrollbar-thumb { background: var(--sage); border-radius: 3px; }

        /* Animated distribution bars */
        @keyframes barGrow {
            from { transform: scaleY(0); }
            to { transform: scaleY(1); }
        }

        /* Print styles */
        @media print {
            .organic-shape, .organic-back-link { display: none; }
            .panel, .chart-panel { break-inside: avoid; box-shadow: none; border: 1px solid #ccc; }
            body { background: white; }
        }
    </style>
</head>
<body>
    <div class="organic-shape shape-1"></div>
    <div class="organic-shape shape-2"></div>

    <a href="../index.html" class="organic-back-link">
        <span>←</span>
        <span>Gallery</span>
    </a>

    <div class="container">
        <header>
            <h1>Aircraft Maintenance Probability Engine</h1>
            <p>Monte Carlo simulation for fleet availability forecasting. Configure your fleet, run simulations, compare scenarios, and export reports.</p>
        </header>

        <div class="app-layout">
            <!-- Left Panel: Configuration -->
            <div class="left-panel">
                <div class="panel" style="margin-bottom: 20px;">
                    <h2>&#9992; Fleet Configuration</h2>

                    <div class="form-row">
                        <label>Aircraft Model Preset</label>
                        <div class="preset-grid" id="presetGrid">
                            <button class="preset-btn" data-preset="narrowbody">
                                <div class="preset-name">A320 / B737</div>
                                <div class="preset-desc">Narrowbody, MTBF 800h</div>
                            </button>
                            <button class="preset-btn" data-preset="widebody">
                                <div class="preset-name">A330 / B777</div>
                                <div class="preset-desc">Widebody, MTBF 600h</div>
                            </button>
                            <button class="preset-btn" data-preset="regional">
                                <div class="preset-name">E190 / CRJ</div>
                                <div class="preset-desc">Regional, MTBF 500h</div>
                            </button>
                            <button class="preset-btn" data-preset="cargo">
                                <div class="preset-name">B747F / A330F</div>
                                <div class="preset-desc">Cargo, MTBF 550h</div>
                            </button>
                        </div>
                    </div>

                    <div class="form-row">
                        <label>Custom Model Name</label>
                        <input type="text" id="modelName" value="A320neo" placeholder="e.g. A320neo">
                    </div>

                    <div class="form-row-inline">
                        <div class="form-row">
                            <label>MTBF (hours) <span class="info-tip" data-tip="Mean Time Between Failures in flight hours">?</span></label>
                            <input type="number" id="mtbf" value="800" min="50" max="5000" step="50">
                        </div>
                        <div class="form-row">
                            <label>MTTR (days) <span class="info-tip" data-tip="Mean Time To Repair in calendar days">?</span></label>
                            <input type="number" id="mttr" value="3" min="0.5" max="60" step="0.5">
                        </div>
                    </div>

                    <div class="form-row-inline">
                        <div class="form-row">
                            <label>Daily Utilization (hrs) <span class="info-tip" data-tip="Average flight hours per aircraft per day">?</span></label>
                            <input type="number" id="dailyHours" value="10" min="1" max="24" step="0.5">
                        </div>
                        <div class="form-row">
                            <label>Scheduled Mx Rate <span class="info-tip" data-tip="Probability of entering scheduled maintenance on any given day">?</span></label>
                            <input type="number" id="schedRate" value="0.02" min="0" max="0.5" step="0.005">
                        </div>
                    </div>

                    <div class="form-row-inline">
                        <div class="form-row">
                            <label>Sched. Mx Duration (days)</label>
                            <input type="number" id="schedDuration" value="5" min="1" max="90" step="1">
                        </div>
                        <div class="form-row">
                            <label>Forecast Horizon (days)</label>
                            <input type="number" id="horizon" value="30" min="1" max="180" step="1">
                        </div>
                    </div>

                    <h3>Fleet State</h3>
                    <table class="fleet-table" id="fleetTable">
                        <thead>
                            <tr>
                                <th>Tail #</th>
                                <th>Status</th>
                                <th>Days Down</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="fleetBody"></tbody>
                    </table>

                    <div class="btn-group">
                        <button class="btn btn-sm btn-primary" id="addAircraftBtn">+ Add Aircraft</button>
                        <button class="btn btn-sm btn-secondary" id="addMultipleBtn">+ Add 5</button>
                    </div>
                </div>

                <div class="panel" style="margin-bottom: 20px;">
                    <h2>&#9881; Simulation Settings</h2>
                    <div class="form-row">
                        <label>Monte Carlo Iterations</label>
                        <select id="simIterations">
                            <option value="1000">1,000 (Fast)</option>
                            <option value="5000" selected>5,000 (Balanced)</option>
                            <option value="10000">10,000 (Accurate)</option>
                            <option value="25000">25,000 (High Precision)</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label>Confidence Intervals</label>
                        <select id="ciLevel">
                            <option value="0.90">90% CI</option>
                            <option value="0.95" selected>95% CI</option>
                            <option value="0.99">99% CI</option>
                        </select>
                    </div>

                    <div class="sim-progress" id="simProgress">
                        <div class="bar" id="simBar"></div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary btn-block" id="runSimBtn">&#9654; Run Simulation</button>
                    </div>
                </div>

                <div class="panel">
                    <h2>&#128202; Scenario Comparison</h2>
                    <p style="font-size: 0.82rem; color: var(--moss); margin-bottom: 10px;">
                        Compare current fleet state (Scenario A) against a hypothetical scenario (Scenario B).
                    </p>
                    <div class="form-row">
                        <label>Scenario B: Additional AOG Aircraft</label>
                        <input type="number" id="scenarioAogCount" value="2" min="0" max="50" step="1">
                    </div>
                    <div class="form-row">
                        <label>Scenario B: Days Already Down</label>
                        <input type="number" id="scenarioAogDays" value="0" min="0" max="90" step="1">
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-secondary btn-block" id="runCompareBtn">&#8644; Compare Scenarios</button>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Results -->
            <div class="results-area">
                <div class="stats-row" id="statsRow">
                    <div class="stat-card stat-green">
                        <div class="stat-value" id="statOperational">--</div>
                        <div class="stat-label">Operational Now</div>
                    </div>
                    <div class="stat-card stat-red">
                        <div class="stat-value" id="statAOG">--</div>
                        <div class="stat-label">AOG / In Mx</div>
                    </div>
                    <div class="stat-card stat-blue">
                        <div class="stat-value" id="statFleetSize">--</div>
                        <div class="stat-label">Fleet Size</div>
                    </div>
                    <div class="stat-card stat-orange">
                        <div class="stat-value" id="statAvailRate">--</div>
                        <div class="stat-label">Availability</div>
                    </div>
                </div>

                <!-- Tab navigation for charts -->
                <div class="chart-panel">
                    <div class="tab-bar">
                        <button class="tab-btn active" data-tab="dist">Availability Distribution</button>
                        <button class="tab-btn" data-tab="timeline">Timeline Forecast</button>
                        <button class="tab-btn" data-tab="compare">Scenario Compare</button>
                    </div>

                    <!-- Distribution Tab -->
                    <div class="tab-content active" id="tab-dist">
                        <h2>Probability Distribution of Available Aircraft</h2>
                        <div class="chart-container">
                            <canvas id="distChart"></canvas>
                        </div>
                        <div class="ci-legend" id="ciLegend">
                            <div class="ci-legend-item">
                                <div class="ci-swatch" style="background: rgba(96,108,56,0.7)"></div>
                                <span>Mean</span>
                            </div>
                            <div class="ci-legend-item">
                                <div class="ci-swatch" style="background: rgba(138,154,91,0.4)"></div>
                                <span>95% CI</span>
                            </div>
                            <div class="ci-legend-item">
                                <div class="ci-swatch" style="background: rgba(221,161,94,0.3)"></div>
                                <span>Full Range</span>
                            </div>
                        </div>
                    </div>

                    <!-- Timeline Tab -->
                    <div class="tab-content" id="tab-timeline">
                        <h2>Fleet Availability Over Time</h2>
                        <div class="chart-container">
                            <canvas id="timelineChart"></canvas>
                        </div>
                        <div class="ci-legend">
                            <div class="ci-legend-item">
                                <div class="ci-swatch" style="background: rgba(96,108,56,0.9)"></div>
                                <span>Mean Availability</span>
                            </div>
                            <div class="ci-legend-item">
                                <div class="ci-swatch" style="background: rgba(138,154,91,0.25)"></div>
                                <span>Confidence Band</span>
                            </div>
                            <div class="ci-legend-item">
                                <div class="ci-swatch" style="background: rgba(188,108,37,0.4); border: 1px dashed var(--terracotta);"></div>
                                <span>Min Operational Target</span>
                            </div>
                        </div>
                    </div>

                    <!-- Compare Tab -->
                    <div class="tab-content" id="tab-compare">
                        <h2>Scenario Comparison</h2>
                        <div class="chart-container">
                            <canvas id="compareChart"></canvas>
                        </div>
                        <div class="scenario-card" id="compareResults" style="display: none;">
                            <h4>Comparison Summary</h4>
                            <table class="compare-table" id="compareTable">
                                <thead>
                                    <tr>
                                        <th>Metric</th>
                                        <th><span class="scenario-label scenario-a">A</span> Current</th>
                                        <th><span class="scenario-label scenario-b">B</span> What-If</th>
                                        <th>Delta</th>
                                    </tr>
                                </thead>
                                <tbody id="compareBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Day-by-day detail panel -->
                <div class="chart-panel">
                    <h2>Day-by-Day Forecast Detail</h2>
                    <div style="max-height: 300px; overflow-y: auto; border-radius: 12px;">
                        <table class="compare-table" id="forecastTable">
                            <thead>
                                <tr>
                                    <th>Day</th>
                                    <th>Mean Avail.</th>
                                    <th>CI Low</th>
                                    <th>CI High</th>
                                    <th>P(All Op)</th>
                                    <th>P(&le;50% Op)</th>
                                </tr>
                            </thead>
                            <tbody id="forecastBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Export -->
                <div class="chart-panel">
                    <h2>&#128195; Export Report</h2>
                    <p style="font-size: 0.82rem; color: var(--moss); margin-bottom: 8px;">
                        Generate formatted reports for ops meetings.
                    </p>
                    <div class="export-options">
                        <button class="btn btn-primary" id="exportCSV">&#128196; Export CSV</button>
                        <button class="btn btn-secondary" id="exportJSON">&#128196; Export JSON</button>
                        <button class="btn btn-primary" id="exportSummary">&#128203; Text Summary</button>
                        <button class="btn btn-secondary" id="printReport">&#128424; Print Report</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    (function() {
        'use strict';

        // ==========================================
        // Aircraft Model Database
        // ==========================================
        const PRESETS = {
            narrowbody: {
                name: 'A320neo', mtbf: 800, mttr: 3, dailyHours: 10,
                schedRate: 0.02, schedDuration: 5,
                fleet: [
                    { tail: 'N301NB', status: 'operational', daysDown: 0 },
                    { tail: 'N302NB', status: 'operational', daysDown: 0 },
                    { tail: 'N303NB', status: 'operational', daysDown: 0 },
                    { tail: 'N304NB', status: 'operational', daysDown: 0 },
                    { tail: 'N305NB', status: 'aog', daysDown: 1 },
                    { tail: 'N306NB', status: 'operational', daysDown: 0 },
                    { tail: 'N307NB', status: 'operational', daysDown: 0 },
                    { tail: 'N308NB', status: 'aog', daysDown: 4 },
                ]
            },
            widebody: {
                name: 'A330-300', mtbf: 600, mttr: 4, dailyHours: 12,
                schedRate: 0.025, schedDuration: 7,
                fleet: [
                    { tail: 'N501WB', status: 'operational', daysDown: 0 },
                    { tail: 'N502WB', status: 'operational', daysDown: 0 },
                    { tail: 'N503WB', status: 'aog', daysDown: 2 },
                    { tail: 'N504WB', status: 'operational', daysDown: 0 },
                    { tail: 'N505WB', status: 'operational', daysDown: 0 },
                    { tail: 'N506WB', status: 'aog', daysDown: 6 },
                ]
            },
            regional: {
                name: 'E190-E2', mtbf: 500, mttr: 2.5, dailyHours: 8,
                schedRate: 0.03, schedDuration: 4,
                fleet: [
                    { tail: 'N101RJ', status: 'operational', daysDown: 0 },
                    { tail: 'N102RJ', status: 'operational', daysDown: 0 },
                    { tail: 'N103RJ', status: 'operational', daysDown: 0 },
                    { tail: 'N104RJ', status: 'aog', daysDown: 1 },
                    { tail: 'N105RJ', status: 'operational', daysDown: 0 },
                    { tail: 'N106RJ', status: 'operational', daysDown: 0 },
                    { tail: 'N107RJ', status: 'aog', daysDown: 3 },
                    { tail: 'N108RJ', status: 'operational', daysDown: 0 },
                    { tail: 'N109RJ', status: 'operational', daysDown: 0 },
                    { tail: 'N110RJ', status: 'operational', daysDown: 0 },
                ]
            },
            cargo: {
                name: 'B747-8F', mtbf: 550, mttr: 5, dailyHours: 14,
                schedRate: 0.02, schedDuration: 8,
                fleet: [
                    { tail: 'N701CF', status: 'operational', daysDown: 0 },
                    { tail: 'N702CF', status: 'operational', daysDown: 0 },
                    { tail: 'N703CF', status: 'aog', daysDown: 3 },
                    { tail: 'N704CF', status: 'operational', daysDown: 0 },
                    { tail: 'N705CF', status: 'operational', daysDown: 0 },
                ]
            }
        };

        // ==========================================
        // State
        // ==========================================
        let fleet = [];
        let tailCounter = 1;
        let simResults = null;
        let scenarioAResults = null;
        let scenarioBResults = null;
        let animationFrameId = null;

        // ==========================================
        // DOM References
        // ==========================================
        const $ = id => document.getElementById(id);
        const fleetBody = $('fleetBody');
        const distCanvas = $('distChart');
        const timelineCanvas = $('timelineChart');
        const compareCanvas = $('compareChart');

        // ==========================================
        // Fleet Management
        // ==========================================
        function addAircraft(tail, status, daysDown) {
            fleet.push({
                tail: tail || `N${String(tailCounter).padStart(3,'0')}`,
                status: status || 'operational',
                daysDown: daysDown || 0
            });
            tailCounter++;
            renderFleet();
            updateStats();
        }

        function removeAircraft(index) {
            fleet.splice(index, 1);
            renderFleet();
            updateStats();
        }

        function toggleStatus(index) {
            const ac = fleet[index];
            if (ac.status === 'operational') {
                ac.status = 'aog';
                ac.daysDown = 1;
            } else {
                ac.status = 'operational';
                ac.daysDown = 0;
            }
            renderFleet();
            updateStats();
        }

        function updateDaysDown(index, val) {
            fleet[index].daysDown = Math.max(0, parseInt(val) || 0);
        }

        function renderFleet() {
            fleetBody.innerHTML = '';
            fleet.forEach((ac, i) => {
                const tr = document.createElement('tr');
                const isAOG = ac.status === 'aog';
                tr.innerHTML = `
                    <td style="font-weight:700; font-size:0.82rem;">${ac.tail}</td>
                    <td>
                        <div class="status-toggle">
                            <button class="${!isAOG ? 'active-op' : ''}" onclick="window._toggleStatus(${i})">OP</button>
                            <button class="${isAOG ? 'active-aog' : ''}" onclick="window._toggleStatus(${i})">AOG</button>
                        </div>
                    </td>
                    <td>
                        ${isAOG
                            ? `<input type="number" class="days-input" value="${ac.daysDown}" min="0" max="999"
                                onchange="window._updateDays(${i}, this.value)">`
                            : '<span style="color:#aaa; font-size:0.8rem;">—</span>'
                        }
                    </td>
                    <td><button class="remove-btn" onclick="window._removeAC(${i})" title="Remove">✕</button></td>
                `;
                fleetBody.appendChild(tr);
            });
        }

        // Expose to inline handlers
        window._toggleStatus = toggleStatus;
        window._updateDays = updateDaysDown;
        window._removeAC = removeAircraft;

        function updateStats() {
            const total = fleet.length;
            const operational = fleet.filter(a => a.status === 'operational').length;
            const aog = total - operational;
            $('statFleetSize').textContent = total;
            $('statOperational').textContent = operational;
            $('statAOG').textContent = aog;
            $('statAvailRate').textContent = total > 0
                ? (operational / total * 100).toFixed(1) + '%'
                : '--';
        }

        // ==========================================
        // Probability Engine (Monte Carlo)
        // ==========================================

        // Exponential random variate
        function randExp(rate) {
            return -Math.log(1 - Math.random()) / rate;
        }

        // Simulate one path of fleet over horizon days
        function simulatePath(fleetState, params) {
            const { mtbf, mttr, dailyHours, schedRate, schedDuration, horizon } = params;
            const failureRatePerDay = dailyHours / mtbf; // Prob of failure per day (approx)
            const repairRatePerDay = 1 / mttr;

            const n = fleetState.length;
            // Track state: for each aircraft, remaining days of downtime (0 = operational)
            const downDays = fleetState.map(ac => {
                if (ac.status === 'aog') {
                    // Remaining repair time from current state
                    const elapsed = ac.daysDown;
                    const totalRepair = mttr + randExp(1 / mttr) * 0.5; // Some variability
                    return Math.max(0, Math.ceil(totalRepair - elapsed + Math.random() * mttr * 0.3));
                }
                return 0;
            });

            const dailyAvailable = new Array(horizon);

            for (let day = 0; day < horizon; day++) {
                let available = 0;
                for (let i = 0; i < n; i++) {
                    if (downDays[i] > 0) {
                        downDays[i]--;
                    } else {
                        // Check for unscheduled failure
                        if (Math.random() < failureRatePerDay) {
                            // Unscheduled maintenance event
                            downDays[i] = Math.max(1, Math.round(randExp(repairRatePerDay) + 0.5));
                        }
                        // Check for scheduled maintenance
                        else if (Math.random() < schedRate) {
                            downDays[i] = schedDuration + Math.round((Math.random() - 0.5) * 2);
                            downDays[i] = Math.max(1, downDays[i]);
                        }
                    }
                    if (downDays[i] <= 0) available++;
                }
                dailyAvailable[day] = available;
            }

            return dailyAvailable;
        }

        function runMonteCarlo(fleetState, params, iterations, progressCb) {
            const horizon = params.horizon;
            const n = fleetState.length;

            // Results storage
            const allPaths = [];
            const dailySums = new Float64Array(horizon);
            const dailySumsOfSquares = new Float64Array(horizon);

            // Distribution at day 7, 14, 30 (end of each week/month)
            const snapshotDays = [
                Math.min(6, horizon - 1),
                Math.min(13, horizon - 1),
                Math.min(horizon - 1, horizon - 1)
            ];

            // Histogram: for the final day
            const endDayHist = new Array(n + 1).fill(0);

            const batchSize = Math.min(500, iterations);
            let completed = 0;

            return new Promise(resolve => {
                function processBatch() {
                    const batchEnd = Math.min(completed + batchSize, iterations);

                    for (let iter = completed; iter < batchEnd; iter++) {
                        const path = simulatePath(fleetState, params);
                        allPaths.push(path);

                        for (let d = 0; d < horizon; d++) {
                            dailySums[d] += path[d];
                            dailySumsOfSquares[d] += path[d] * path[d];
                        }

                        endDayHist[path[horizon - 1]]++;
                    }

                    completed = batchEnd;
                    if (progressCb) progressCb(completed / iterations);

                    if (completed < iterations) {
                        setTimeout(processBatch, 0);
                    } else {
                        // Compute statistics
                        const ciLevel = parseFloat($('ciLevel').value);
                        const alpha = (1 - ciLevel) / 2;

                        const dailyMean = new Float64Array(horizon);
                        const dailyStd = new Float64Array(horizon);
                        const dailyCILow = new Float64Array(horizon);
                        const dailyCIHigh = new Float64Array(horizon);
                        const dailyMin = new Float64Array(horizon);
                        const dailyMax = new Float64Array(horizon);
                        const dailyPAllOp = new Float64Array(horizon);
                        const dailyPHalfDown = new Float64Array(horizon);

                        for (let d = 0; d < horizon; d++) {
                            dailyMean[d] = dailySums[d] / iterations;
                            const variance = dailySumsOfSquares[d] / iterations - dailyMean[d] * dailyMean[d];
                            dailyStd[d] = Math.sqrt(Math.max(0, variance));

                            // Get sorted values for CI
                            const vals = allPaths.map(p => p[d]).sort((a, b) => a - b);
                            const lowIdx = Math.floor(alpha * iterations);
                            const highIdx = Math.min(Math.ceil((1 - alpha) * iterations) - 1, iterations - 1);
                            dailyCILow[d] = vals[lowIdx];
                            dailyCIHigh[d] = vals[highIdx];
                            dailyMin[d] = vals[0];
                            dailyMax[d] = vals[iterations - 1];

                            // P(all operational)
                            dailyPAllOp[d] = vals.filter(v => v >= n).length / iterations;
                            // P(≤50% operational)
                            dailyPHalfDown[d] = vals.filter(v => v <= n / 2).length / iterations;
                        }

                        resolve({
                            dailyMean, dailyStd, dailyCILow, dailyCIHigh,
                            dailyMin, dailyMax, dailyPAllOp, dailyPHalfDown,
                            endDayHist, iterations, horizon, fleetSize: n,
                            params: { ...params }
                        });
                    }
                }

                processBatch();
            });
        }

        // ==========================================
        // Charting (Canvas 2D)
        // ==========================================

        function setupCanvas(canvas) {
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            const ctx = canvas.getContext('2d');
            ctx.scale(dpr, dpr);
            return { ctx, w: rect.width, h: rect.height };
        }

        // Animated bar chart for distribution
        function drawDistributionChart(results, animate) {
            const { ctx, w, h } = setupCanvas(distCanvas);
            const hist = results.endDayHist;
            const n = results.fleetSize;
            const maxProb = Math.max(...hist) / results.iterations;

            const pad = { top: 30, right: 20, bottom: 50, left: 55 };
            const cw = w - pad.left - pad.right;
            const ch = h - pad.top - pad.bottom;
            const barW = Math.max(8, Math.min(50, cw / (n + 1) - 4));

            let progress = animate ? 0 : 1;
            const startTime = performance.now();
            const duration = 800;

            function draw() {
                if (animate) {
                    progress = Math.min(1, (performance.now() - startTime) / duration);
                    progress = 1 - Math.pow(1 - progress, 3); // ease-out
                }

                ctx.clearRect(0, 0, w, h);

                // Grid lines
                ctx.strokeStyle = 'rgba(138,154,91,0.15)';
                ctx.lineWidth = 1;
                for (let i = 0; i <= 5; i++) {
                    const y = pad.top + ch - (i / 5) * ch;
                    ctx.beginPath();
                    ctx.moveTo(pad.left, y);
                    ctx.lineTo(w - pad.right, y);
                    ctx.stroke();

                    ctx.fillStyle = 'rgba(96,108,56,0.5)';
                    ctx.font = '11px Nunito';
                    ctx.textAlign = 'right';
                    ctx.fillText((maxProb * i / 5 * 100).toFixed(1) + '%', pad.left - 8, y + 4);
                }

                // Bars
                for (let i = 0; i <= n; i++) {
                    const prob = hist[i] / results.iterations;
                    const barH = maxProb > 0 ? (prob / maxProb) * ch * progress : 0;
                    const x = pad.left + (i / (n + 1)) * cw + (cw / (n + 1) - barW) / 2;
                    const y = pad.top + ch - barH;

                    // Color based on availability
                    const ratio = i / n;
                    let color;
                    if (ratio >= 0.8) color = 'rgba(39,174,96,0.7)';
                    else if (ratio >= 0.6) color = 'rgba(221,161,94,0.7)';
                    else color = 'rgba(192,57,43,0.7)';

                    ctx.fillStyle = color;
                    ctx.beginPath();
                    const r = Math.min(4, barW / 4);
                    ctx.moveTo(x + r, y);
                    ctx.lineTo(x + barW - r, y);
                    ctx.quadraticCurveTo(x + barW, y, x + barW, y + r);
                    ctx.lineTo(x + barW, pad.top + ch);
                    ctx.lineTo(x, pad.top + ch);
                    ctx.lineTo(x, y + r);
                    ctx.quadraticCurveTo(x, y, x + r, y);
                    ctx.fill();

                    // Label
                    ctx.fillStyle = 'var(--dark-moss)';
                    ctx.font = '600 11px Nunito';
                    ctx.textAlign = 'center';
                    ctx.fillText(i, x + barW / 2, pad.top + ch + 18);

                    // Prob value on top of bar
                    if (prob > 0.01 && progress > 0.8) {
                        ctx.fillStyle = 'rgba(61,68,35,0.8)';
                        ctx.font = '600 10px Nunito';
                        ctx.fillText((prob * 100).toFixed(1) + '%', x + barW / 2, y - 6);
                    }
                }

                // X-axis label
                ctx.fillStyle = 'var(--moss)';
                ctx.font = '600 12px Nunito';
                ctx.textAlign = 'center';
                ctx.fillText('Number of Available Aircraft (Day ' + results.horizon + ')', w / 2, h - 4);

                // Y-axis label
                ctx.save();
                ctx.translate(14, pad.top + ch / 2);
                ctx.rotate(-Math.PI / 2);
                ctx.fillText('Probability', 0, 0);
                ctx.restore();

                // Mean line
                const meanX = pad.left + (results.dailyMean[results.horizon - 1] / (n + 1)) * cw
                    + (cw / (n + 1)) / 2;
                ctx.strokeStyle = 'rgba(96,108,56,0.8)';
                ctx.lineWidth = 2;
                ctx.setLineDash([6, 4]);
                ctx.beginPath();
                ctx.moveTo(meanX, pad.top);
                ctx.lineTo(meanX, pad.top + ch);
                ctx.stroke();
                ctx.setLineDash([]);

                ctx.fillStyle = 'rgba(96,108,56,0.9)';
                ctx.font = '600 11px Nunito';
                ctx.textAlign = 'center';
                ctx.fillText('μ=' + results.dailyMean[results.horizon - 1].toFixed(1), meanX, pad.top - 6);

                if (animate && progress < 1) {
                    animationFrameId = requestAnimationFrame(draw);
                }
            }

            draw();
        }

        // Timeline chart with confidence bands
        function drawTimelineChart(results) {
            const { ctx, w, h } = setupCanvas(timelineCanvas);
            const n = results.fleetSize;
            const horizon = results.horizon;

            const pad = { top: 20, right: 20, bottom: 50, left: 55 };
            const cw = w - pad.left - pad.right;
            const ch = h - pad.top - pad.bottom;

            ctx.clearRect(0, 0, w, h);

            // Grid
            ctx.strokeStyle = 'rgba(138,154,91,0.12)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= n; i++) {
                const y = pad.top + ch - (i / n) * ch;
                ctx.beginPath();
                ctx.moveTo(pad.left, y);
                ctx.lineTo(w - pad.right, y);
                ctx.stroke();

                if (i % Math.max(1, Math.ceil(n / 8)) === 0) {
                    ctx.fillStyle = 'rgba(96,108,56,0.5)';
                    ctx.font = '11px Nunito';
                    ctx.textAlign = 'right';
                    ctx.fillText(i, pad.left - 8, y + 4);
                }
            }

            function xPos(day) { return pad.left + (day / (horizon - 1)) * cw; }
            function yPos(val) { return pad.top + ch - (val / n) * ch; }

            // Full range band
            ctx.fillStyle = 'rgba(221,161,94,0.12)';
            ctx.beginPath();
            ctx.moveTo(xPos(0), yPos(results.dailyMax[0]));
            for (let d = 0; d < horizon; d++) ctx.lineTo(xPos(d), yPos(results.dailyMax[d]));
            for (let d = horizon - 1; d >= 0; d--) ctx.lineTo(xPos(d), yPos(results.dailyMin[d]));
            ctx.closePath();
            ctx.fill();

            // CI band
            ctx.fillStyle = 'rgba(138,154,91,0.2)';
            ctx.beginPath();
            ctx.moveTo(xPos(0), yPos(results.dailyCIHigh[0]));
            for (let d = 0; d < horizon; d++) ctx.lineTo(xPos(d), yPos(results.dailyCIHigh[d]));
            for (let d = horizon - 1; d >= 0; d--) ctx.lineTo(xPos(d), yPos(results.dailyCILow[d]));
            ctx.closePath();
            ctx.fill();

            // Mean line
            ctx.strokeStyle = 'rgba(96,108,56,0.85)';
            ctx.lineWidth = 2.5;
            ctx.beginPath();
            for (let d = 0; d < horizon; d++) {
                const x = xPos(d);
                const y = yPos(results.dailyMean[d]);
                d === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            }
            ctx.stroke();

            // 50% operational target line
            const halfY = yPos(n * 0.5);
            ctx.strokeStyle = 'rgba(188,108,37,0.5)';
            ctx.lineWidth = 1.5;
            ctx.setLineDash([8, 4]);
            ctx.beginPath();
            ctx.moveTo(pad.left, halfY);
            ctx.lineTo(w - pad.right, halfY);
            ctx.stroke();
            ctx.setLineDash([]);

            ctx.fillStyle = 'rgba(188,108,37,0.6)';
            ctx.font = '600 10px Nunito';
            ctx.textAlign = 'right';
            ctx.fillText('50% target', w - pad.right - 4, halfY - 6);

            // X-axis labels
            ctx.fillStyle = 'rgba(96,108,56,0.6)';
            ctx.font = '11px Nunito';
            ctx.textAlign = 'center';
            const step = Math.max(1, Math.ceil(horizon / 15));
            for (let d = 0; d < horizon; d += step) {
                ctx.fillText('D' + (d + 1), xPos(d), pad.top + ch + 18);
            }

            ctx.fillStyle = 'var(--moss)';
            ctx.font = '600 12px Nunito';
            ctx.fillText('Forecast Day', w / 2, h - 4);

            // Y-axis label
            ctx.save();
            ctx.translate(14, pad.top + ch / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Available Aircraft', 0, 0);
            ctx.restore();
        }

        // Scenario comparison chart
        function drawCompareChart(resA, resB) {
            const { ctx, w, h } = setupCanvas(compareCanvas);
            if (!resA || !resB) {
                ctx.fillStyle = 'rgba(96,108,56,0.4)';
                ctx.font = '14px Nunito';
                ctx.textAlign = 'center';
                ctx.fillText('Run "Compare Scenarios" to see results', w / 2, h / 2);
                return;
            }

            const n = Math.max(resA.fleetSize, resB.fleetSize);
            const horizon = resA.horizon;

            const pad = { top: 20, right: 20, bottom: 50, left: 55 };
            const cw = w - pad.left - pad.right;
            const ch = h - pad.top - pad.bottom;

            ctx.clearRect(0, 0, w, h);

            // Grid
            ctx.strokeStyle = 'rgba(138,154,91,0.12)';
            for (let i = 0; i <= n; i++) {
                const y = pad.top + ch - (i / n) * ch;
                ctx.beginPath();
                ctx.moveTo(pad.left, y);
                ctx.lineTo(w - pad.right, y);
                ctx.stroke();
                if (i % Math.max(1, Math.ceil(n / 8)) === 0) {
                    ctx.fillStyle = 'rgba(96,108,56,0.5)';
                    ctx.font = '11px Nunito';
                    ctx.textAlign = 'right';
                    ctx.fillText(i, pad.left - 8, y + 4);
                }
            }

            function xPos(day) { return pad.left + (day / (horizon - 1)) * cw; }
            function yPos(val) { return pad.top + ch - (val / n) * ch; }

            // Scenario A band
            ctx.fillStyle = 'rgba(41,128,185,0.15)';
            ctx.beginPath();
            ctx.moveTo(xPos(0), yPos(resA.dailyCIHigh[0]));
            for (let d = 0; d < horizon; d++) ctx.lineTo(xPos(d), yPos(resA.dailyCIHigh[d]));
            for (let d = horizon - 1; d >= 0; d--) ctx.lineTo(xPos(d), yPos(resA.dailyCILow[d]));
            ctx.closePath();
            ctx.fill();

            // Scenario B band
            ctx.fillStyle = 'rgba(192,57,43,0.15)';
            ctx.beginPath();
            ctx.moveTo(xPos(0), yPos(resB.dailyCIHigh[0]));
            for (let d = 0; d < horizon; d++) ctx.lineTo(xPos(d), yPos(resB.dailyCIHigh[d]));
            for (let d = horizon - 1; d >= 0; d--) ctx.lineTo(xPos(d), yPos(resB.dailyCILow[d]));
            ctx.closePath();
            ctx.fill();

            // Scenario A mean
            ctx.strokeStyle = 'rgba(41,128,185,0.9)';
            ctx.lineWidth = 2.5;
            ctx.beginPath();
            for (let d = 0; d < horizon; d++) {
                const x = xPos(d);
                const y = yPos(resA.dailyMean[d]);
                d === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            }
            ctx.stroke();

            // Scenario B mean
            ctx.strokeStyle = 'rgba(192,57,43,0.9)';
            ctx.lineWidth = 2.5;
            ctx.setLineDash([6, 3]);
            ctx.beginPath();
            for (let d = 0; d < horizon; d++) {
                const x = xPos(d);
                const y = yPos(resB.dailyMean[d]);
                d === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            }
            ctx.stroke();
            ctx.setLineDash([]);

            // Labels
            ctx.fillStyle = 'rgba(41,128,185,0.9)';
            ctx.font = '700 11px Nunito';
            ctx.textAlign = 'left';
            ctx.fillText('A: Current (' + resA.fleetSize + ' ac)', pad.left + 8, pad.top + 16);

            ctx.fillStyle = 'rgba(192,57,43,0.9)';
            ctx.fillText('B: What-If (' + resB.fleetSize + ' ac)', pad.left + 8, pad.top + 32);

            // X labels
            ctx.fillStyle = 'rgba(96,108,56,0.6)';
            ctx.font = '11px Nunito';
            ctx.textAlign = 'center';
            const step = Math.max(1, Math.ceil(horizon / 15));
            for (let d = 0; d < horizon; d += step) {
                ctx.fillText('D' + (d + 1), xPos(d), pad.top + ch + 18);
            }

            ctx.fillStyle = 'var(--moss)';
            ctx.font = '600 12px Nunito';
            ctx.fillText('Forecast Day', w / 2, h - 4);
        }

        // ==========================================
        // Forecast Table
        // ==========================================
        function populateForecastTable(results) {
            const tbody = $('forecastBody');
            tbody.innerHTML = '';
            const step = Math.max(1, Math.floor(results.horizon / 30));

            for (let d = 0; d < results.horizon; d += step) {
                const tr = document.createElement('tr');
                const mean = results.dailyMean[d];
                const low = results.dailyCILow[d];
                const high = results.dailyCIHigh[d];
                const pAll = results.dailyPAllOp[d];
                const pHalf = results.dailyPHalfDown[d];

                tr.innerHTML = `
                    <td style="font-weight:700;">Day ${d + 1}</td>
                    <td>${mean.toFixed(2)}</td>
                    <td>${low.toFixed(1)}</td>
                    <td>${high.toFixed(1)}</td>
                    <td>${(pAll * 100).toFixed(1)}%</td>
                    <td style="color: ${pHalf > 0.1 ? 'var(--danger)' : 'inherit'}; font-weight: ${pHalf > 0.1 ? '700' : '400'};">
                        ${(pHalf * 100).toFixed(1)}%
                    </td>
                `;
                tbody.appendChild(tr);
            }

            // Always show last day
            if (results.horizon % step !== 0) {
                const d = results.horizon - 1;
                const tr = document.createElement('tr');
                tr.style.fontWeight = '700';
                tr.style.background = 'rgba(138,154,91,0.06)';
                tr.innerHTML = `
                    <td>Day ${d + 1}</td>
                    <td>${results.dailyMean[d].toFixed(2)}</td>
                    <td>${results.dailyCILow[d].toFixed(1)}</td>
                    <td>${results.dailyCIHigh[d].toFixed(1)}</td>
                    <td>${(results.dailyPAllOp[d] * 100).toFixed(1)}%</td>
                    <td style="color: ${results.dailyPHalfDown[d] > 0.1 ? 'var(--danger)' : 'inherit'};">
                        ${(results.dailyPHalfDown[d] * 100).toFixed(1)}%
                    </td>
                `;
                tbody.appendChild(tr);
            }
        }

        // ==========================================
        // Comparison Table
        // ==========================================
        function populateCompareTable(resA, resB) {
            const tbody = $('compareBody');
            tbody.innerHTML = '';
            $('compareResults').style.display = 'block';

            const lastDay = resA.horizon - 1;

            const metrics = [
                {
                    name: 'Mean Available (Day ' + (lastDay + 1) + ')',
                    a: resA.dailyMean[lastDay].toFixed(2),
                    b: resB.dailyMean[lastDay].toFixed(2),
                    aVal: resA.dailyMean[lastDay],
                    bVal: resB.dailyMean[lastDay],
                    higher_better: true
                },
                {
                    name: 'CI Lower Bound',
                    a: resA.dailyCILow[lastDay].toFixed(1),
                    b: resB.dailyCILow[lastDay].toFixed(1),
                    aVal: resA.dailyCILow[lastDay],
                    bVal: resB.dailyCILow[lastDay],
                    higher_better: true
                },
                {
                    name: 'P(All Operational)',
                    a: (resA.dailyPAllOp[lastDay] * 100).toFixed(1) + '%',
                    b: (resB.dailyPAllOp[lastDay] * 100).toFixed(1) + '%',
                    aVal: resA.dailyPAllOp[lastDay],
                    bVal: resB.dailyPAllOp[lastDay],
                    higher_better: true
                },
                {
                    name: 'P(≤50% Operational)',
                    a: (resA.dailyPHalfDown[lastDay] * 100).toFixed(1) + '%',
                    b: (resB.dailyPHalfDown[lastDay] * 100).toFixed(1) + '%',
                    aVal: resA.dailyPHalfDown[lastDay],
                    bVal: resB.dailyPHalfDown[lastDay],
                    higher_better: false
                },
                {
                    name: 'Avg Availability (All Days)',
                    a: (resA.dailyMean.reduce((s, v) => s + v, 0) / resA.horizon).toFixed(2),
                    b: (resB.dailyMean.reduce((s, v) => s + v, 0) / resB.horizon).toFixed(2),
                    aVal: resA.dailyMean.reduce((s, v) => s + v, 0) / resA.horizon,
                    bVal: resB.dailyMean.reduce((s, v) => s + v, 0) / resB.horizon,
                    higher_better: true
                }
            ];

            metrics.forEach(m => {
                const tr = document.createElement('tr');
                const delta = m.bVal - m.aVal;
                const better = m.higher_better ? delta > 0 : delta < 0;
                const deltaStr = (delta >= 0 ? '+' : '') + delta.toFixed(2);
                tr.innerHTML = `
                    <td style="font-weight:600;">${m.name}</td>
                    <td>${m.a}</td>
                    <td>${m.b}</td>
                    <td class="${Math.abs(delta) < 0.01 ? '' : (better ? 'better' : 'worse')}">${deltaStr}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ==========================================
        // Export Functions
        // ==========================================
        function exportCSV() {
            if (!simResults) { alert('Run simulation first.'); return; }
            const r = simResults;
            let csv = 'Day,Mean Available,CI Low,CI High,Min,Max,P(All Op),P(≤50% Op)\n';
            for (let d = 0; d < r.horizon; d++) {
                csv += [
                    d + 1,
                    r.dailyMean[d].toFixed(3),
                    r.dailyCILow[d].toFixed(1),
                    r.dailyCIHigh[d].toFixed(1),
                    r.dailyMin[d],
                    r.dailyMax[d],
                    (r.dailyPAllOp[d] * 100).toFixed(2) + '%',
                    (r.dailyPHalfDown[d] * 100).toFixed(2) + '%'
                ].join(',') + '\n';
            }
            downloadFile(csv, 'fleet-forecast.csv', 'text/csv');
        }

        function exportJSON() {
            if (!simResults) { alert('Run simulation first.'); return; }
            const r = simResults;
            const data = {
                model: $('modelName').value,
                generated: new Date().toISOString(),
                parameters: r.params,
                fleetSize: r.fleetSize,
                iterations: r.iterations,
                forecast: []
            };
            for (let d = 0; d < r.horizon; d++) {
                data.forecast.push({
                    day: d + 1,
                    meanAvailable: +r.dailyMean[d].toFixed(3),
                    ciLow: +r.dailyCILow[d].toFixed(1),
                    ciHigh: +r.dailyCIHigh[d].toFixed(1),
                    min: r.dailyMin[d],
                    max: r.dailyMax[d],
                    pAllOperational: +(r.dailyPAllOp[d] * 100).toFixed(2),
                    pHalfOrLessOperational: +(r.dailyPHalfDown[d] * 100).toFixed(2)
                });
            }
            downloadFile(JSON.stringify(data, null, 2), 'fleet-forecast.json', 'application/json');
        }

        function exportSummary() {
            if (!simResults) { alert('Run simulation first.'); return; }
            const r = simResults;
            const lastDay = r.horizon - 1;
            const operational = fleet.filter(a => a.status === 'operational').length;

            let text = `AIRCRAFT FLEET AVAILABILITY FORECAST\n`;
            text += `${'='.repeat(45)}\n\n`;
            text += `Generated: ${new Date().toLocaleString()}\n`;
            text += `Model: ${$('modelName').value}\n`;
            text += `Fleet Size: ${r.fleetSize} aircraft\n`;
            text += `Currently Operational: ${operational} / ${r.fleetSize}\n`;
            text += `Monte Carlo Iterations: ${r.iterations.toLocaleString()}\n\n`;

            text += `PARAMETERS\n${'-'.repeat(30)}\n`;
            text += `MTBF: ${r.params.mtbf} hours\n`;
            text += `MTTR: ${r.params.mttr} days\n`;
            text += `Daily Utilization: ${r.params.dailyHours} hours\n`;
            text += `Scheduled Mx Rate: ${(r.params.schedRate * 100).toFixed(1)}%/day\n`;
            text += `Scheduled Mx Duration: ${r.params.schedDuration} days\n`;
            text += `Forecast Horizon: ${r.horizon} days\n\n`;

            text += `FORECAST SUMMARY (Day ${r.horizon})\n${'-'.repeat(30)}\n`;
            text += `Mean Available: ${r.dailyMean[lastDay].toFixed(2)} aircraft\n`;
            text += `CI Range: [${r.dailyCILow[lastDay].toFixed(1)}, ${r.dailyCIHigh[lastDay].toFixed(1)}]\n`;
            text += `Full Range: [${r.dailyMin[lastDay]}, ${r.dailyMax[lastDay]}]\n`;
            text += `P(All Operational): ${(r.dailyPAllOp[lastDay] * 100).toFixed(1)}%\n`;
            text += `P(≤50% Operational): ${(r.dailyPHalfDown[lastDay] * 100).toFixed(1)}%\n\n`;

            text += `DAY-BY-DAY FORECAST\n${'-'.repeat(70)}\n`;
            text += `Day  | Mean   | CI Low | CI High | P(All) | P(≤50%)\n`;
            text += `${'-'.repeat(70)}\n`;

            const step = Math.max(1, Math.floor(r.horizon / 30));
            for (let d = 0; d < r.horizon; d += step) {
                text += `${String(d + 1).padStart(4)} | `;
                text += `${r.dailyMean[d].toFixed(2).padStart(6)} | `;
                text += `${r.dailyCILow[d].toFixed(1).padStart(6)} | `;
                text += `${r.dailyCIHigh[d].toFixed(1).padStart(7)} | `;
                text += `${(r.dailyPAllOp[d] * 100).toFixed(1).padStart(5)}% | `;
                text += `${(r.dailyPHalfDown[d] * 100).toFixed(1).padStart(5)}%\n`;
            }

            if (scenarioAResults && scenarioBResults) {
                text += `\nSCENARIO COMPARISON\n${'-'.repeat(30)}\n`;
                text += `Scenario A: Current fleet state\n`;
                text += `Scenario B: +${$('scenarioAogCount').value} additional AOG\n\n`;
                text += `A Mean Available (Day ${r.horizon}): ${scenarioAResults.dailyMean[lastDay].toFixed(2)}\n`;
                text += `B Mean Available (Day ${r.horizon}): ${scenarioBResults.dailyMean[lastDay].toFixed(2)}\n`;
                text += `Delta: ${(scenarioBResults.dailyMean[lastDay] - scenarioAResults.dailyMean[lastDay]).toFixed(2)}\n`;
            }

            downloadFile(text, 'fleet-report.txt', 'text/plain');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ==========================================
        // Event Handlers
        // ==========================================

        // Presets
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const preset = PRESETS[btn.dataset.preset];
                if (!preset) return;

                $('modelName').value = preset.name;
                $('mtbf').value = preset.mtbf;
                $('mttr').value = preset.mttr;
                $('dailyHours').value = preset.dailyHours;
                $('schedRate').value = preset.schedRate;
                $('schedDuration').value = preset.schedDuration;

                fleet = preset.fleet.map(a => ({ ...a }));
                tailCounter = fleet.length + 1;
                renderFleet();
                updateStats();
            });
        });

        // Add aircraft
        $('addAircraftBtn').addEventListener('click', () => addAircraft());
        $('addMultipleBtn').addEventListener('click', () => {
            for (let i = 0; i < 5; i++) addAircraft();
        });

        // Tabs
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                $('tab-' + btn.dataset.tab).classList.add('active');
            });
        });

        // Get current params
        function getParams() {
            return {
                mtbf: parseFloat($('mtbf').value) || 800,
                mttr: parseFloat($('mttr').value) || 3,
                dailyHours: parseFloat($('dailyHours').value) || 10,
                schedRate: parseFloat($('schedRate').value) || 0.02,
                schedDuration: parseInt($('schedDuration').value) || 5,
                horizon: parseInt($('horizon').value) || 30
            };
        }

        // Run simulation
        $('runSimBtn').addEventListener('click', async () => {
            if (fleet.length === 0) {
                alert('Add aircraft to the fleet first.');
                return;
            }

            const btn = $('runSimBtn');
            btn.disabled = true;
            btn.textContent = 'Simulating...';
            const progress = $('simProgress');
            const bar = $('simBar');
            progress.style.display = 'block';

            const iterations = parseInt($('simIterations').value);
            const params = getParams();

            try {
                simResults = await runMonteCarlo(fleet, params, iterations, p => {
                    bar.style.width = (p * 100) + '%';
                });

                drawDistributionChart(simResults, true);
                drawTimelineChart(simResults);
                populateForecastTable(simResults);

                // Also store as scenario A
                scenarioAResults = simResults;

                // Clear compare chart since fleet might have changed
                if (scenarioBResults) {
                    drawCompareChart(scenarioAResults, scenarioBResults);
                }
            } catch (err) {
                alert('Simulation error: ' + err.message);
            }

            btn.disabled = false;
            btn.textContent = '▶ Run Simulation';
            progress.style.display = 'none';
            bar.style.width = '0%';
        });

        // Scenario comparison
        $('runCompareBtn').addEventListener('click', async () => {
            if (fleet.length === 0) {
                alert('Add aircraft and run base simulation first.');
                return;
            }

            const btn = $('runCompareBtn');
            btn.disabled = true;
            btn.textContent = 'Comparing...';

            const iterations = parseInt($('simIterations').value);
            const params = getParams();

            // Scenario A: current fleet
            scenarioAResults = await runMonteCarlo(fleet, params, iterations);

            // Scenario B: additional AOG
            const extraAOG = parseInt($('scenarioAogCount').value) || 2;
            const extraDays = parseInt($('scenarioAogDays').value) || 0;
            const fleetB = fleet.map(a => ({ ...a }));
            for (let i = 0; i < extraAOG; i++) {
                // Convert operational ones to AOG
                const opIdx = fleetB.findIndex(a => a.status === 'operational');
                if (opIdx >= 0) {
                    fleetB[opIdx].status = 'aog';
                    fleetB[opIdx].daysDown = extraDays;
                }
            }

            scenarioBResults = await runMonteCarlo(fleetB, params, iterations);

            // Switch to compare tab
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('[data-tab="compare"]').classList.add('active');
            $('tab-compare').classList.add('active');

            drawCompareChart(scenarioAResults, scenarioBResults);
            populateCompareTable(scenarioAResults, scenarioBResults);

            btn.disabled = false;
            btn.textContent = '⇄ Compare Scenarios';
        });

        // Export buttons
        $('exportCSV').addEventListener('click', exportCSV);
        $('exportJSON').addEventListener('click', exportJSON);
        $('exportSummary').addEventListener('click', exportSummary);
        $('printReport').addEventListener('click', () => window.print());

        // Handle window resize for canvases
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                if (simResults) {
                    drawDistributionChart(simResults, false);
                    drawTimelineChart(simResults);
                }
                if (scenarioAResults && scenarioBResults) {
                    drawCompareChart(scenarioAResults, scenarioBResults);
                }
            }, 200);
        });

        // ==========================================
        // Initialize with default fleet
        // ==========================================
        (function init() {
            // Load narrowbody preset
            const preset = PRESETS.narrowbody;
            $('modelName').value = preset.name;
            $('mtbf').value = preset.mtbf;
            $('mttr').value = preset.mttr;
            $('dailyHours').value = preset.dailyHours;
            $('schedRate').value = preset.schedRate;
            $('schedDuration').value = preset.schedDuration;

            fleet = preset.fleet.map(a => ({ ...a }));
            tailCounter = fleet.length + 1;
            renderFleet();
            updateStats();

            // Draw empty charts
            drawCompareChart(null, null);
        })();

    })();
    </script>
</body>
</html>
