<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diffraction Grating - Optical Phenomena</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0a0e1a; color: #e0e0e0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }
        canvas { display: block; }
        .back-link {
            position: fixed; top: 15px; left: 15px; color: #8ab4f8; text-decoration: none;
            font-size: 14px; z-index: 1000; opacity: 0.8; transition: opacity 0.3s;
        }
        .back-link:hover { opacity: 1; }
        .controls {
            position: fixed; top: 15px; right: 15px; z-index: 1000;
            background: rgba(20,20,40,0.85); backdrop-filter: blur(10px);
            border: 1px solid rgba(100,140,255,0.2); border-radius: 12px;
            padding: 16px; min-width: 260px;
        }
        .controls h3 { color: #8ab4f8; font-size: 14px; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; }
        .control-group { margin-bottom: 10px; }
        .control-group label { display: block; font-size: 12px; color: #aaa; margin-bottom: 4px; }
        .control-group input[type="range"] { width: 100%; accent-color: #8ab4f8; }
        .control-group .value { float: right; color: #8ab4f8; font-size: 12px; font-family: monospace; }
        .toggle-group { margin-bottom: 10px; display: flex; gap: 8px; flex-wrap: wrap; }
        .toggle-btn {
            padding: 4px 10px; border: 1px solid rgba(100,140,255,0.3); border-radius: 6px;
            background: rgba(20,20,40,0.6); color: #aaa; font-size: 11px; cursor: pointer;
        }
        .toggle-btn.active { background: rgba(100,140,255,0.3); color: #8ab4f8; border-color: #8ab4f8; }
        .info-panel {
            position: fixed; bottom: 15px; left: 15px; z-index: 1000;
            background: rgba(20,20,40,0.85); backdrop-filter: blur(10px);
            border: 1px solid rgba(100,140,255,0.2); border-radius: 12px;
            padding: 16px; max-width: 380px;
        }
        .info-panel h3 { color: #8ab4f8; font-size: 14px; margin-bottom: 8px; }
        .info-panel p { font-size: 12px; color: #bbb; line-height: 1.5; margin-bottom: 6px; }
        .formula { font-family: monospace; color: #f0c060; font-size: 13px; padding: 4px 0; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">&larr; Back to Optical Phenomena</a>

    <div class="controls">
        <h3>Diffraction Grating</h3>
        <div class="control-group">
            <label>Number of Slits (N) <span class="value" id="nVal">20</span></label>
            <input type="range" id="numSlits" min="2" max="500" value="20" step="1">
        </div>
        <div class="control-group">
            <label>Grating Spacing <span class="value" id="dVal">3.0 &mu;m</span></label>
            <input type="range" id="spacing" min="1" max="10" value="3" step="0.1">
        </div>
        <div class="control-group">
            <label>Slit Width <span class="value" id="aVal">0.5 &mu;m</span></label>
            <input type="range" id="slitW" min="0.1" max="3" value="0.5" step="0.1">
        </div>
        <div class="toggle-group">
            <div class="toggle-btn active" id="btnWhite" onclick="setMode('white')">White Light</div>
            <div class="toggle-btn" id="btnMono" onclick="setMode('mono')">Monochromatic</div>
        </div>
        <div class="control-group" id="monoGroup" style="display:none">
            <label>Wavelength <span class="value" id="wlVal">550 nm</span></label>
            <input type="range" id="wavelength" min="380" max="780" value="550" step="5">
        </div>
    </div>

    <div class="info-panel">
        <h3>Diffraction Grating</h3>
        <p>A grating with N parallel slits splits light into spectral orders. White light fans into rainbows at specific angles. More slits make sharper spectral lines -- like a CD or DVD surface.</p>
        <div class="formula">d &middot; sin(&theta;) = m&lambda;</div>
        <p>Where d = grating spacing, m = order (0, &plusmn;1, &plusmn;2, ...). The grating equation determines where each wavelength appears.</p>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let W, H;
        let time = 0;
        let animId;
        let mode = 'white';

        const slNumSlits = document.getElementById('numSlits');
        const slSpacing = document.getElementById('spacing');
        const slSlitW = document.getElementById('slitW');
        const slWavelength = document.getElementById('wavelength');

        function resize() {
            W = canvas.width = window.innerWidth;
            H = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        function setMode(m) {
            mode = m;
            document.getElementById('btnWhite').classList.toggle('active', m === 'white');
            document.getElementById('btnMono').classList.toggle('active', m === 'mono');
            document.getElementById('monoGroup').style.display = m === 'mono' ? 'block' : 'none';
        }

        function wavelengthToRGB(nm) {
            let r = 0, g = 0, b = 0;
            if (nm >= 380 && nm < 440) { r = -(nm - 440) / (440 - 380); b = 1; }
            else if (nm >= 440 && nm < 490) { g = (nm - 440) / (490 - 440); b = 1; }
            else if (nm >= 490 && nm < 510) { g = 1; b = -(nm - 510) / (510 - 490); }
            else if (nm >= 510 && nm < 580) { r = (nm - 510) / (580 - 510); g = 1; }
            else if (nm >= 580 && nm < 645) { r = 1; g = -(nm - 645) / (645 - 580); }
            else if (nm >= 645 && nm <= 780) { r = 1; }
            let factor = 1;
            if (nm >= 380 && nm < 420) factor = 0.3 + 0.7 * (nm - 380) / (420 - 380);
            else if (nm > 700) factor = 0.3 + 0.7 * (780 - nm) / (780 - 700);
            return [r * factor, g * factor, b * factor];
        }

        function sinc(x) {
            if (Math.abs(x) < 1e-10) return 1;
            return Math.sin(x) / x;
        }

        function gratingIntensity(theta, N, d, a, lambda) {
            const lambdaM = lambda * 1e-3; // nm to um
            const sinT = Math.sin(theta);
            const alpha = Math.PI * a * sinT / lambdaM;
            const beta = Math.PI * d * sinT / lambdaM;
            const singleSlit = sinc(alpha);
            let multiSlit;
            const denom = Math.sin(beta);
            if (Math.abs(denom) < 1e-10) {
                multiSlit = N;
            } else {
                multiSlit = Math.sin(N * beta) / denom;
            }
            return (singleSlit * singleSlit) * (multiSlit * multiSlit) / (N * N);
        }

        function draw() {
            const N = parseInt(slNumSlits.value);
            const d = parseFloat(slSpacing.value);
            const a = parseFloat(slSlitW.value);
            const lambda = parseFloat(slWavelength.value);

            document.getElementById('nVal').textContent = N;
            document.getElementById('dVal').textContent = d.toFixed(1) + ' \u00b5m';
            document.getElementById('aVal').textContent = a.toFixed(1) + ' \u00b5m';
            document.getElementById('wlVal').textContent = lambda + ' nm';

            ctx.fillStyle = '#0a0e1a';
            ctx.fillRect(0, 0, W, H);

            const gratingX = W * 0.25;
            const screenX = W * 0.7;
            const centerY = H / 2;

            // Draw grating
            ctx.fillStyle = '#1a1e30';
            ctx.fillRect(gratingX - 6, 0, 12, H);

            // Draw slit lines on grating
            const numVisible = Math.min(N, 60);
            const slitSpacing = Math.min(H / (numVisible + 1), 8);
            ctx.strokeStyle = 'rgba(138,180,248,0.4)';
            ctx.lineWidth = 1;
            for (let i = 0; i < numVisible; i++) {
                const y = centerY + (i - numVisible / 2) * slitSpacing;
                ctx.beginPath();
                ctx.moveTo(gratingX - 6, y);
                ctx.lineTo(gratingX + 6, y);
                ctx.stroke();
            }

            // Incoming light (left)
            if (mode === 'white') {
                // White light beam
                const grad = ctx.createLinearGradient(0, centerY - 30, 0, centerY + 30);
                grad.addColorStop(0, 'rgba(255,255,255,0)');
                grad.addColorStop(0.3, 'rgba(255,255,255,0.15)');
                grad.addColorStop(0.5, 'rgba(255,255,255,0.25)');
                grad.addColorStop(0.7, 'rgba(255,255,255,0.15)');
                grad.addColorStop(1, 'rgba(255,255,255,0)');
                ctx.fillStyle = grad;
                ctx.fillRect(0, centerY - 30, gratingX - 6, 60);

                // Animated wave crests
                for (let x = 0; x < gratingX - 6; x += 3) {
                    const phase = (x - time * 30) / 20;
                    const intensity = (Math.sin(phase) * 0.5 + 0.5) * 0.12;
                    ctx.fillStyle = `rgba(255,255,255,${intensity})`;
                    ctx.fillRect(x, centerY - 25, 3, 50);
                }
            } else {
                const [rr, gg, bb] = wavelengthToRGB(lambda);
                for (let x = 0; x < gratingX - 6; x += 3) {
                    const phase = (x - time * 30) / (lambda / 25);
                    const intensity = (Math.sin(phase) * 0.5 + 0.5) * 0.3;
                    ctx.fillStyle = `rgba(${Math.round(rr*255)},${Math.round(gg*255)},${Math.round(bb*255)},${intensity})`;
                    ctx.fillRect(x, centerY - 25, 3, 50);
                }
            }

            // Draw screen
            ctx.fillStyle = '#0d1020';
            ctx.fillRect(screenX, 0, W - screenX, H);

            // Compute and draw diffraction pattern on screen
            const screenH = H;
            const imgData = ctx.createImageData(30, screenH);

            if (mode === 'white') {
                // For white light: sum over wavelengths
                for (let py = 0; py < screenH; py++) {
                    let rSum = 0, gSum = 0, bSum = 0;
                    const y = (py - centerY);
                    const theta = Math.atan2(y, (screenX - gratingX) * 5);

                    for (let wl = 400; wl <= 700; wl += 10) {
                        const I = gratingIntensity(theta, N, d, a, wl);
                        const [rr, gg, bb] = wavelengthToRGB(wl);
                        rSum += rr * I;
                        gSum += gg * I;
                        bSum += bb * I;
                    }

                    const scale = 8;
                    const r = Math.min(255, Math.round(rSum * scale));
                    const g = Math.min(255, Math.round(gSum * scale));
                    const b = Math.min(255, Math.round(bSum * scale));

                    for (let x = 0; x < 30; x++) {
                        const idx = (py * 30 + x) * 4;
                        imgData.data[idx] = r;
                        imgData.data[idx + 1] = g;
                        imgData.data[idx + 2] = b;
                        imgData.data[idx + 3] = 255;
                    }
                }
            } else {
                const [rr, gg, bb] = wavelengthToRGB(lambda);
                for (let py = 0; py < screenH; py++) {
                    const y = (py - centerY);
                    const theta = Math.atan2(y, (screenX - gratingX) * 5);
                    const I = gratingIntensity(theta, N, d, a, lambda);
                    const bright = Math.pow(I, 0.4);

                    const r = Math.min(255, Math.round(rr * bright * 255));
                    const g = Math.min(255, Math.round(gg * bright * 255));
                    const b = Math.min(255, Math.round(bb * bright * 255));

                    for (let x = 0; x < 30; x++) {
                        const idx = (py * 30 + x) * 4;
                        imgData.data[idx] = r;
                        imgData.data[idx + 1] = g;
                        imgData.data[idx + 2] = b;
                        imgData.data[idx + 3] = 255;
                    }
                }
            }
            ctx.putImageData(imgData, screenX, 0);

            // Draw diffracted rays from grating to screen
            if (mode === 'white') {
                for (let wl = 400; wl <= 700; wl += 20) {
                    const [rr, gg, bb] = wavelengthToRGB(wl);
                    for (let m = -2; m <= 2; m++) {
                        const sinTheta = m * (wl * 1e-3) / d;
                        if (Math.abs(sinTheta) >= 1) continue;
                        const theta = Math.asin(sinTheta);
                        const endY = centerY + Math.tan(theta) * (screenX - gratingX);
                        if (endY < 0 || endY > H) continue;

                        ctx.beginPath();
                        ctx.moveTo(gratingX + 6, centerY);
                        ctx.lineTo(screenX, endY);
                        ctx.strokeStyle = `rgba(${Math.round(rr*255)},${Math.round(gg*255)},${Math.round(bb*255)},0.08)`;
                        ctx.lineWidth = 1;
                        ctx.stroke();
                    }
                }
            } else {
                const [rr, gg, bb] = wavelengthToRGB(lambda);
                for (let m = -3; m <= 3; m++) {
                    const sinTheta = m * (lambda * 1e-3) / d;
                    if (Math.abs(sinTheta) >= 1) continue;
                    const theta = Math.asin(sinTheta);
                    const endY = centerY + Math.tan(theta) * (screenX - gratingX);
                    if (endY < 0 || endY > H) continue;

                    ctx.beginPath();
                    ctx.moveTo(gratingX + 6, centerY);
                    ctx.lineTo(screenX, endY);
                    ctx.strokeStyle = `rgba(${Math.round(rr*255)},${Math.round(gg*255)},${Math.round(bb*255)},0.2)`;
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    // Label order
                    ctx.fillStyle = '#aaa';
                    ctx.font = '11px monospace';
                    ctx.fillText('m=' + m, screenX + 34, endY + 4);
                }
            }

            // Draw intensity graph
            const graphX = screenX + 50;
            const graphW = W - graphX - 20;
            const graphTop = 30;
            const graphH = H - 60;

            ctx.strokeStyle = 'rgba(100,140,255,0.2)';
            ctx.lineWidth = 1;
            ctx.setLineDash([3, 3]);
            ctx.beginPath();
            ctx.moveTo(graphX, graphTop);
            ctx.lineTo(graphX, graphTop + graphH);
            ctx.lineTo(graphX + graphW, graphTop + graphH);
            ctx.stroke();
            ctx.setLineDash([]);

            // Plot intensity
            if (mode === 'white') {
                for (let wl = 420; wl <= 680; wl += 40) {
                    const [rr, gg, bb] = wavelengthToRGB(wl);
                    ctx.beginPath();
                    let first = true;
                    for (let py = 0; py < graphH; py++) {
                        const y = ((py / graphH) - 0.5) * H;
                        const theta = Math.atan2(y, (screenX - gratingX) * 5);
                        const I = gratingIntensity(theta, N, d, a, wl);
                        const px = graphX + Math.pow(I, 0.5) * graphW * 0.8;
                        if (first) { ctx.moveTo(px, graphTop + py); first = false; }
                        else ctx.lineTo(px, graphTop + py);
                    }
                    ctx.strokeStyle = `rgba(${Math.round(rr*255)},${Math.round(gg*255)},${Math.round(bb*255)},0.6)`;
                    ctx.lineWidth = 1.5;
                    ctx.stroke();
                }
            } else {
                const [rr, gg, bb] = wavelengthToRGB(lambda);
                ctx.beginPath();
                let first = true;
                for (let py = 0; py < graphH; py++) {
                    const y = ((py / graphH) - 0.5) * H;
                    const theta = Math.atan2(y, (screenX - gratingX) * 5);
                    const I = gratingIntensity(theta, N, d, a, lambda);
                    const px = graphX + Math.pow(I, 0.5) * graphW * 0.8;
                    if (first) { ctx.moveTo(px, graphTop + py); first = false; }
                    else ctx.lineTo(px, graphTop + py);
                }
                ctx.strokeStyle = `rgba(${Math.round(rr*255)},${Math.round(gg*255)},${Math.round(bb*255)},0.9)`;
                ctx.lineWidth = 2;
                ctx.stroke();
            }

            // CD/DVD rainbow effect decoration at bottom-right
            const cdX = W - 100;
            const cdY = H - 100;
            const cdR = 50;
            for (let angle = 0; angle < Math.PI * 2; angle += 0.02) {
                for (let r = 10; r < cdR; r += 1) {
                    const wl = 400 + ((angle + time * 0.3 + r * 0.1) % (Math.PI * 2)) / (Math.PI * 2) * 300;
                    const [rr, gg, bb] = wavelengthToRGB(wl);
                    const x = cdX + Math.cos(angle) * r;
                    const y = cdY + Math.sin(angle) * r;
                    ctx.fillStyle = `rgba(${Math.round(rr*200)},${Math.round(gg*200)},${Math.round(bb*200)},0.15)`;
                    ctx.fillRect(x, y, 1.5, 1.5);
                }
            }
            ctx.beginPath();
            ctx.arc(cdX, cdY, cdR, 0, Math.PI * 2);
            ctx.strokeStyle = 'rgba(138,180,248,0.3)';
            ctx.lineWidth = 1;
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(cdX, cdY, 8, 0, Math.PI * 2);
            ctx.stroke();
            ctx.fillStyle = '#666';
            ctx.font = '10px sans-serif';
            ctx.fillText('CD rainbow', cdX - 25, cdY + cdR + 15);

            ctx.fillStyle = '#fff';
            ctx.font = 'bold 16px Segoe UI, sans-serif';
            ctx.fillText('Diffraction Grating', W / 2 - 80, H - 15);

            time += 0.016;
            animId = requestAnimationFrame(draw);
        }

        window.reset = function() {
            time = 0;
            slNumSlits.value = 20;
            slSpacing.value = 3;
            slSlitW.value = 0.5;
            slWavelength.value = 550;
            setMode('white');
        };

        draw();
    </script>
    <script src="../assets/js/enhance.js"></script>
</body>
</html>
