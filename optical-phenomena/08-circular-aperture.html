<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airy Disk - Circular Aperture Diffraction - Optical Phenomena</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0a0e1a; color: #e0e0e0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }
        canvas { display: block; }
        .back-link {
            position: fixed; top: 15px; left: 15px; color: #8ab4f8; text-decoration: none;
            font-size: 14px; z-index: 1000; opacity: 0.8; transition: opacity 0.3s;
        }
        .back-link:hover { opacity: 1; }
        .controls {
            position: fixed; top: 15px; right: 15px; z-index: 1000;
            background: rgba(20,20,40,0.85); backdrop-filter: blur(10px);
            border: 1px solid rgba(100,140,255,0.2); border-radius: 12px;
            padding: 16px; min-width: 250px;
        }
        .controls h3 { color: #8ab4f8; font-size: 14px; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; }
        .control-group { margin-bottom: 10px; }
        .control-group label { display: block; font-size: 12px; color: #aaa; margin-bottom: 4px; }
        .control-group input[type="range"] { width: 100%; accent-color: #8ab4f8; }
        .control-group .value { float: right; color: #8ab4f8; font-size: 12px; font-family: monospace; }
        .toggle-group { margin-bottom: 10px; display: flex; gap: 8px; }
        .toggle-btn {
            padding: 4px 10px; border: 1px solid rgba(100,140,255,0.3); border-radius: 6px;
            background: rgba(20,20,40,0.6); color: #aaa; font-size: 11px; cursor: pointer; flex: 1; text-align: center;
        }
        .toggle-btn.active { background: rgba(100,140,255,0.3); color: #8ab4f8; border-color: #8ab4f8; }
        .info-panel {
            position: fixed; bottom: 15px; left: 15px; z-index: 1000;
            background: rgba(20,20,40,0.85); backdrop-filter: blur(10px);
            border: 1px solid rgba(100,140,255,0.2); border-radius: 12px;
            padding: 16px; max-width: 380px;
        }
        .info-panel h3 { color: #8ab4f8; font-size: 14px; margin-bottom: 8px; }
        .info-panel p { font-size: 12px; color: #bbb; line-height: 1.5; margin-bottom: 6px; }
        .formula { font-family: monospace; color: #f0c060; font-size: 13px; padding: 4px 0; }
        .status { color: #8ab4f8; font-size: 12px; margin-top: 8px; font-family: monospace; padding: 6px; background: rgba(0,0,0,0.3); border-radius: 6px; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">&larr; Back to Optical Phenomena</a>

    <div class="controls">
        <h3>Airy Disk</h3>
        <div class="control-group">
            <label>Aperture Diameter <span class="value" id="dVal">10.0 &mu;m</span></label>
            <input type="range" id="diameter" min="2" max="30" value="10" step="0.5">
        </div>
        <div class="control-group">
            <label>Wavelength <span class="value" id="wlVal">550 nm</span></label>
            <input type="range" id="wavelength" min="380" max="780" value="550" step="5">
        </div>
        <div class="control-group">
            <label>Source Separation <span class="value" id="sepVal">1.0x Rayleigh</span></label>
            <input type="range" id="separation" min="0" max="3" value="1" step="0.05">
        </div>
        <div class="toggle-group">
            <div class="toggle-btn active" id="btnSingle" onclick="setSourceMode('single')">Single Source</div>
            <div class="toggle-btn" id="btnDouble" onclick="setSourceMode('double')">Two Sources</div>
        </div>
        <div class="control-group">
            <label>Brightness <span class="value" id="brVal">1.0</span></label>
            <input type="range" id="brightness" min="0.3" max="5" value="1" step="0.1">
        </div>
        <div class="status" id="status">Rayleigh limit: 6.71 &mu;rad</div>
    </div>

    <div class="info-panel">
        <h3>Circular Aperture Diffraction (Airy Disk)</h3>
        <p>Light passing through a circular aperture produces a central bright disk surrounded by concentric rings. This is the Airy pattern, discovered by George Biddell Airy in 1835.</p>
        <div class="formula">I(x) = [2J&#8321;(x)/x]&sup2;</div>
        <div class="formula">x = &pi;D&middot;sin(&theta;)/&lambda;</div>
        <p>The Rayleigh criterion: two point sources are just resolved when one's central maximum falls on the other's first minimum.</p>
        <div class="formula">&theta;&#8343; = 1.22&lambda;/D</div>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let W, H;
        let animId;
        let sourceMode = 'single';
        let time = 0;

        // Precompute Bessel J1 using series expansion
        function besselJ1(x) {
            if (Math.abs(x) < 1e-10) return 0;
            if (Math.abs(x) < 8) {
                let sum = 0;
                let term = x / 2;
                sum = term;
                for (let k = 1; k <= 20; k++) {
                    term *= -(x * x) / (4 * k * (k + 1));
                    sum += term;
                    if (Math.abs(term) < 1e-15) break;
                }
                return sum;
            }
            // Asymptotic approximation for large x
            const t = 8 / x;
            const t2 = t * t;
            const p1 = 1 + t2 * (-0.1098628627e-2 + t2 * (0.2734510407e-4 + t2 * (-0.2073370639e-5 + t2 * 0.2093887211e-6)));
            const q1 = -0.1562499995e-1 + t2 * (0.1430488765e-3 + t2 * (-0.6911147651e-5 + t2 * (0.7621095161e-6 + t2 * (-0.934945152e-7))));
            const theta = x - 0.75 * Math.PI;
            return Math.sqrt(0.636619772 / x) * (p1 * Math.cos(theta) - t * q1 * Math.sin(theta));
        }

        function airyIntensity(x) {
            if (Math.abs(x) < 1e-10) return 1;
            const j = besselJ1(x);
            return Math.pow(2 * j / x, 2);
        }

        function wavelengthToRGB(nm) {
            let r = 0, g = 0, b = 0;
            if (nm >= 380 && nm < 440) { r = -(nm - 440) / (440 - 380); b = 1; }
            else if (nm >= 440 && nm < 490) { g = (nm - 440) / (490 - 440); b = 1; }
            else if (nm >= 490 && nm < 510) { g = 1; b = -(nm - 510) / (510 - 490); }
            else if (nm >= 510 && nm < 580) { r = (nm - 510) / (580 - 510); g = 1; }
            else if (nm >= 580 && nm < 645) { r = 1; g = -(nm - 645) / (645 - 580); }
            else if (nm >= 645 && nm <= 780) { r = 1; }
            let factor = 1;
            if (nm >= 380 && nm < 420) factor = 0.3 + 0.7 * (nm - 380) / (420 - 380);
            else if (nm > 700) factor = 0.3 + 0.7 * (780 - nm) / (780 - 700);
            return [r * factor, g * factor, b * factor];
        }

        function resize() {
            W = canvas.width = window.innerWidth;
            H = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        function setSourceMode(m) {
            sourceMode = m;
            document.getElementById('btnSingle').classList.toggle('active', m === 'single');
            document.getElementById('btnDouble').classList.toggle('active', m === 'double');
        }

        function draw() {
            const D = parseFloat(document.getElementById('diameter').value);
            const lambda = parseFloat(document.getElementById('wavelength').value);
            const sepFactor = parseFloat(document.getElementById('separation').value);
            const bright = parseFloat(document.getElementById('brightness').value);

            document.getElementById('dVal').textContent = D.toFixed(1) + ' \u00b5m';
            document.getElementById('wlVal').textContent = lambda + ' nm';
            document.getElementById('sepVal').textContent = sepFactor.toFixed(2) + 'x Rayleigh';
            document.getElementById('brVal').textContent = bright.toFixed(1);

            // Rayleigh limit in microradians
            const rayleigh = 1.22 * lambda * 1e-3 / D; // in radians
            const rayleighUrad = (rayleigh * 1e6).toFixed(2);
            document.getElementById('status').textContent = 'Rayleigh limit: ' + rayleighUrad + ' \u00b5rad';

            ctx.fillStyle = '#0a0e1a';
            ctx.fillRect(0, 0, W, H);

            const [cr, cg, cb] = wavelengthToRGB(lambda);

            // Draw 2D Airy pattern
            const patSize = Math.min(W * 0.45, H * 0.7);
            const patCX = W * 0.3;
            const patCY = H * 0.45;
            const patR = patSize / 2;

            // Scale factor: map pixel distance to x parameter
            const scale = 12 / patR; // show about 4 rings

            const imgData = ctx.createImageData(Math.ceil(patSize), Math.ceil(patSize));
            const halfSep = sourceMode === 'double' ? sepFactor * 3.8317 / 2 : 0;

            for (let py = 0; py < patSize; py++) {
                for (let px = 0; px < patSize; px++) {
                    const dx = (px - patSize / 2) * scale;
                    const dy = (py - patSize / 2) * scale;

                    let I;
                    if (sourceMode === 'single') {
                        const r = Math.sqrt(dx * dx + dy * dy);
                        I = airyIntensity(r);
                    } else {
                        const r1 = Math.sqrt((dx - halfSep) * (dx - halfSep) + dy * dy);
                        const r2 = Math.sqrt((dx + halfSep) * (dx + halfSep) + dy * dy);
                        I = (airyIntensity(r1) + airyIntensity(r2)) / 2;
                    }

                    I = Math.pow(I, 0.6) * bright;

                    const idx = (py * Math.ceil(patSize) + px) * 4;
                    imgData.data[idx] = Math.min(255, Math.round(cr * I * 255));
                    imgData.data[idx + 1] = Math.min(255, Math.round(cg * I * 255));
                    imgData.data[idx + 2] = Math.min(255, Math.round(cb * I * 255));
                    imgData.data[idx + 3] = 255;
                }
            }
            ctx.putImageData(imgData, patCX - patSize / 2, patCY - patSize / 2);

            // Draw circle border around pattern
            ctx.beginPath();
            ctx.arc(patCX, patCY, patR + 2, 0, Math.PI * 2);
            ctx.strokeStyle = 'rgba(138,180,248,0.3)';
            ctx.lineWidth = 1;
            ctx.stroke();

            // Labels
            ctx.fillStyle = '#888';
            ctx.font = '12px sans-serif';
            ctx.fillText('2D Airy Pattern', patCX - 45, patCY + patR + 20);

            // Draw aperture visualization at top-left
            const apX = patCX;
            const apY = patCY - patR - 60;
            ctx.beginPath();
            ctx.arc(apX, apY, 20, 0, Math.PI * 2);
            ctx.strokeStyle = 'rgba(138,180,248,0.5)';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.fillStyle = `rgba(${Math.round(cr*150)},${Math.round(cg*150)},${Math.round(cb*150)},0.15)`;
            ctx.fill();

            // Draw aperture diameter indicator
            ctx.beginPath();
            ctx.moveTo(apX - 20, apY);
            ctx.lineTo(apX + 20, apY);
            ctx.strokeStyle = '#8ab4f8';
            ctx.lineWidth = 1;
            ctx.setLineDash([2, 2]);
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.fillStyle = '#aaa';
            ctx.font = '10px monospace';
            ctx.fillText('D = ' + D.toFixed(1) + '\u00b5m', apX - 30, apY - 25);

            // Draw cross-section intensity plot (right side)
            const graphX = W * 0.6;
            const graphW = W * 0.35 - 20;
            const graphTop = 50;
            const graphH = H - 120;

            // Axes
            ctx.strokeStyle = 'rgba(100,140,255,0.3)';
            ctx.lineWidth = 1;
            ctx.setLineDash([3, 3]);
            ctx.beginPath();
            ctx.moveTo(graphX, graphTop);
            ctx.lineTo(graphX, graphTop + graphH);
            ctx.lineTo(graphX + graphW, graphTop + graphH);
            ctx.stroke();
            ctx.setLineDash([]);

            ctx.fillStyle = '#888';
            ctx.font = '11px monospace';
            ctx.fillText('Cross-section Intensity', graphX + 10, graphTop - 5);
            ctx.fillText('I/I\u2080', graphX - 25, graphTop + 10);
            ctx.fillText('x = \u03c0D sin\u03b8/\u03bb', graphX + graphW / 2 - 40, graphTop + graphH + 18);

            // Plot intensity curve
            const maxX = 15;
            ctx.beginPath();
            let first = true;

            if (sourceMode === 'single') {
                for (let px = 0; px < graphW; px++) {
                    const x = (px / graphW - 0.5) * 2 * maxX;
                    const I = airyIntensity(x);
                    const plotY = graphTop + graphH - I * graphH * 0.9 * bright;
                    if (first) { ctx.moveTo(graphX + px, plotY); first = false; }
                    else ctx.lineTo(graphX + px, plotY);
                }
            } else {
                for (let px = 0; px < graphW; px++) {
                    const x = (px / graphW - 0.5) * 2 * maxX;
                    const r1 = Math.abs(x - halfSep);
                    const r2 = Math.abs(x + halfSep);
                    const I = (airyIntensity(r1) + airyIntensity(r2)) / 2;
                    const plotY = graphTop + graphH - I * graphH * 0.9 * bright;
                    if (first) { ctx.moveTo(graphX + px, plotY); first = false; }
                    else ctx.lineTo(graphX + px, plotY);
                }
            }

            ctx.strokeStyle = `rgba(${Math.round(cr*255)},${Math.round(cg*255)},${Math.round(cb*255)},0.9)`;
            ctx.lineWidth = 2;
            ctx.stroke();

            // Fill under curve
            ctx.lineTo(graphX + graphW, graphTop + graphH);
            ctx.lineTo(graphX, graphTop + graphH);
            ctx.closePath();
            ctx.fillStyle = `rgba(${Math.round(cr*255)},${Math.round(cg*255)},${Math.round(cb*255)},0.08)`;
            ctx.fill();

            // Mark first zero at x = 3.8317 (first zero of J1)
            const zeroX = graphX + (3.8317 / maxX * 0.5 + 0.5) * graphW;
            ctx.beginPath();
            ctx.moveTo(zeroX, graphTop);
            ctx.lineTo(zeroX, graphTop + graphH);
            ctx.strokeStyle = 'rgba(240,192,96,0.3)';
            ctx.lineWidth = 1;
            ctx.setLineDash([4, 4]);
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.fillStyle = '#f0c060';
            ctx.font = '10px monospace';
            ctx.fillText('1st min', zeroX + 3, graphTop + 15);
            ctx.fillText('x=3.83', zeroX + 3, graphTop + 27);

            // If double source, show Rayleigh criterion status
            if (sourceMode === 'double') {
                let statusText, statusColor;
                if (sepFactor < 0.8) {
                    statusText = 'NOT RESOLVED';
                    statusColor = '#ff6060';
                } else if (sepFactor < 1.2) {
                    statusText = 'JUST RESOLVED (Rayleigh)';
                    statusColor = '#f0c060';
                } else {
                    statusText = 'WELL RESOLVED';
                    statusColor = '#60ff60';
                }
                ctx.fillStyle = statusColor;
                ctx.font = 'bold 14px monospace';
                ctx.fillText(statusText, graphX + 10, graphTop + graphH + 40);
            }

            // Pulsing ring animation around pattern
            const pulseR = patR + 10 + Math.sin(time * 2) * 5;
            ctx.beginPath();
            ctx.arc(patCX, patCY, pulseR, 0, Math.PI * 2);
            ctx.strokeStyle = `rgba(${Math.round(cr*200)},${Math.round(cg*200)},${Math.round(cb*200)},${0.1 + Math.sin(time * 2) * 0.05})`;
            ctx.lineWidth = 1;
            ctx.stroke();

            ctx.fillStyle = '#fff';
            ctx.font = 'bold 16px Segoe UI, sans-serif';
            ctx.fillText('Circular Aperture Diffraction (Airy Disk)', W / 2 - 170, H - 15);

            time += 0.016;
            animId = requestAnimationFrame(draw);
        }

        window.reset = function() {
            time = 0;
            document.getElementById('diameter').value = 10;
            document.getElementById('wavelength').value = 550;
            document.getElementById('separation').value = 1;
            document.getElementById('brightness').value = 1;
            setSourceMode('single');
        };

        draw();
    </script>
    <script src="../assets/js/enhance.js"></script>
</body>
</html>
