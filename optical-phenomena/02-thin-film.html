<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thin Film Interference - Optical Phenomena</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0a0e1a;
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }
        canvas { display: block; position: absolute; top: 0; left: 0; }
        .back-link {
            position: fixed; top: 15px; left: 15px; color: #8af;
            text-decoration: none; font-size: 14px; z-index: 100;
            background: rgba(20,20,40,0.85); padding: 6px 14px;
            border-radius: 8px; backdrop-filter: blur(10px);
        }
        .back-link:hover { color: #bdf; }
        #controls {
            position: fixed; top: 15px; right: 15px;
            background: rgba(20,20,40,0.85); backdrop-filter: blur(10px);
            border-radius: 12px; padding: 16px; z-index: 100;
            width: 260px; border: 1px solid rgba(100,140,255,0.15);
        }
        #controls h3 { color: #8af; margin-bottom: 10px; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
        .control-group { margin-bottom: 10px; }
        .control-group label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 3px; color: #aaa; }
        .control-group label span { color: #8af; }
        input[type="range"] {
            width: 100%; height: 4px; -webkit-appearance: none;
            background: rgba(100,140,255,0.2); border-radius: 2px; outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 14px; height: 14px;
            border-radius: 50%; background: #8af; cursor: pointer;
        }
        .btn-row { display: flex; gap: 6px; margin-bottom: 10px; }
        .btn-row button {
            flex: 1; padding: 6px 4px; border: 1px solid rgba(100,140,255,0.3);
            background: rgba(100,140,255,0.1); color: #8af; border-radius: 6px;
            font-size: 11px; cursor: pointer; transition: 0.2s;
        }
        .btn-row button:hover { background: rgba(100,140,255,0.25); }
        .btn-row button.active { background: rgba(100,140,255,0.35); border-color: #8af; }
        #info {
            position: fixed; bottom: 15px; left: 15px;
            background: rgba(20,20,40,0.85); backdrop-filter: blur(10px);
            border-radius: 12px; padding: 14px 18px; z-index: 100;
            max-width: 420px; border: 1px solid rgba(100,140,255,0.15);
            font-size: 12px; line-height: 1.6;
        }
        #info h4 { color: #8af; margin-bottom: 6px; font-size: 13px; }
        #info p { color: #bbb; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">&larr; Back to Gallery</a>
    <canvas id="canvas"></canvas>

    <div id="controls">
        <h3>Thin Film Controls</h3>
        <div class="btn-row">
            <button id="btnBubble" class="active">Soap Bubble</button>
            <button id="btnOil">Oil Film</button>
        </div>
        <div class="control-group">
            <label>Base Thickness <span id="thickVal">300 nm</span></label>
            <input type="range" id="thickness" min="50" max="800" value="300" step="5">
        </div>
        <div class="control-group">
            <label>Refractive Index <span id="riVal">1.33</span></label>
            <input type="range" id="refIndex" min="100" max="200" value="133" step="1">
        </div>
        <div class="control-group">
            <label>Viewing Angle <span id="angleVal">0&deg;</span></label>
            <input type="range" id="viewAngle" min="0" max="70" value="0" step="1">
        </div>
        <div class="control-group">
            <label>Flow Speed <span id="flowVal">1.0</span></label>
            <input type="range" id="flowSpeed" min="0" max="30" value="10" step="1">
        </div>
    </div>

    <div id="info">
        <h4>Thin Film Interference</h4>
        <p>When light hits a thin film (soap bubble, oil slick), it reflects from both
        the top and bottom surfaces. The two reflected rays travel different path lengths
        (2nt cos&theta;), causing wavelength-dependent interference. Some colors are reinforced
        while others cancel, producing vivid rainbow patterns. The colors shift as
        thickness, refractive index, or viewing angle change.</p>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let W, H, time = 0, animId;
        let mode = 'bubble'; // 'bubble' or 'oil'

        function resize() {
            W = canvas.width = window.innerWidth;
            H = canvas.height = window.innerHeight;
        }
        resize();
        window.addEventListener('resize', resize);

        const els = {
            thickness: document.getElementById('thickness'),
            refIndex: document.getElementById('refIndex'),
            viewAngle: document.getElementById('viewAngle'),
            flowSpeed: document.getElementById('flowSpeed'),
            thickVal: document.getElementById('thickVal'),
            riVal: document.getElementById('riVal'),
            angleVal: document.getElementById('angleVal'),
            flowVal: document.getElementById('flowVal'),
            btnBubble: document.getElementById('btnBubble'),
            btnOil: document.getElementById('btnOil')
        };

        els.btnBubble.addEventListener('click', () => {
            mode = 'bubble';
            els.btnBubble.classList.add('active');
            els.btnOil.classList.remove('active');
        });
        els.btnOil.addEventListener('click', () => {
            mode = 'oil';
            els.btnOil.classList.add('active');
            els.btnBubble.classList.remove('active');
        });

        function getParams() {
            return {
                baseThick: +els.thickness.value,
                n: +els.refIndex.value / 100,
                angle: +els.viewAngle.value * Math.PI / 180,
                flowSpeed: +els.flowSpeed.value / 10
            };
        }

        function updateLabels() {
            const p = getParams();
            els.thickVal.textContent = Math.round(p.baseThick) + ' nm';
            els.riVal.textContent = p.n.toFixed(2);
            els.angleVal.textContent = (+els.viewAngle.value) + '\u00B0';
            els.flowVal.textContent = p.flowSpeed.toFixed(1);
        }

        [els.thickness, els.refIndex, els.viewAngle, els.flowSpeed].forEach(e =>
            e.addEventListener('input', updateLabels));
        updateLabels();

        function wavelengthToRGB(wl) {
            let r = 0, g = 0, b = 0;
            if (wl >= 380 && wl < 440) { r = -(wl-440)/(440-380); b = 1; }
            else if (wl >= 440 && wl < 490) { g = (wl-440)/(490-440); b = 1; }
            else if (wl >= 490 && wl < 510) { g = 1; b = -(wl-510)/(510-490); }
            else if (wl >= 510 && wl < 580) { r = (wl-510)/(580-510); g = 1; }
            else if (wl >= 580 && wl < 645) { r = 1; g = -(wl-645)/(645-580); }
            else if (wl >= 645 && wl <= 750) { r = 1; }
            let f;
            if (wl >= 380 && wl < 420) f = 0.3 + 0.7*(wl-380)/(420-380);
            else if (wl >= 420 && wl <= 700) f = 1.0;
            else if (wl > 700 && wl <= 750) f = 0.3 + 0.7*(750-wl)/(750-700);
            else f = 0;
            return [r*f, g*f, b*f];
        }

        function thinFilmColor(thickness, n, cosTheta) {
            // Path difference = 2 * n * t * cosTheta
            // Phase shift of pi at top surface (low-to-high n)
            let rSum = 0, gSum = 0, bSum = 0;
            const numWL = 40;
            for (let i = 0; i < numWL; i++) {
                const wl = 380 + (750 - 380) * i / (numWL - 1);
                const pathDiff = 2 * n * thickness * cosTheta;
                // Phase: path difference / wavelength * 2pi + pi (half-wave shift)
                const phase = (pathDiff / wl) * 2 * Math.PI + Math.PI;
                // Reflectance ~ cos^2(phase/2) for thin film
                const reflectance = Math.pow(Math.cos(phase / 2), 2);
                const [r, g, b] = wavelengthToRGB(wl);
                rSum += r * reflectance;
                gSum += g * reflectance;
                bSum += b * reflectance;
            }
            // Normalize
            const maxC = Math.max(rSum, gSum, bSum, 0.001);
            const scale = 1.0 / maxC;
            return [
                Math.min(255, Math.round(rSum * scale * 255)),
                Math.min(255, Math.round(gSum * scale * 255)),
                Math.min(255, Math.round(bSum * scale * 255))
            ];
        }

        // Use ImageData for fast pixel manipulation
        function draw() {
            const p = getParams();
            const cosTheta = Math.cos(p.angle);

            ctx.fillStyle = '#0a0e1a';
            ctx.fillRect(0, 0, W, H);

            if (mode === 'bubble') {
                drawBubble(p, cosTheta);
            } else {
                drawOilFilm(p, cosTheta);
            }

            time += 0.016 * p.flowSpeed;
        }

        function drawBubble(p, cosTheta) {
            const cx = W / 2;
            const cy = H / 2;
            const radius = Math.min(W, H) * 0.35;

            // Draw bubble using radial sampling
            const step = 3;
            for (let y = cy - radius; y < cy + radius; y += step) {
                for (let x = cx - radius; x < cx + radius; x += step) {
                    const dx = x - cx;
                    const dy = y - cy;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist > radius) continue;

                    // Thickness varies: thinnest at top (gravity draining), thicker at bottom
                    // Also varies with noise for organic look
                    const normalizedDist = dist / radius;
                    const angle = Math.atan2(dy, dx);

                    // Gravity effect: thinner at top, thicker at bottom
                    const gravityFactor = 1 + 0.5 * (dy / radius);
                    // Noise for organic variation
                    const noise1 = Math.sin(angle * 3 + time * 0.5) * 0.15;
                    const noise2 = Math.sin(normalizedDist * 8 + time * 0.3) * 0.1;
                    const noise3 = Math.cos(angle * 5 - time * 0.7) * 0.1;

                    const thickness = p.baseThick * gravityFactor * (1 + noise1 + noise2 + noise3);

                    // Local viewing angle varies across bubble surface
                    const surfaceAngle = Math.asin(Math.min(0.95, normalizedDist));
                    const localCosTheta = Math.cos(surfaceAngle + p.angle * 0.5);

                    const [r, g, b] = thinFilmColor(thickness, p.n, localCosTheta);

                    // Edge darkening (Fresnel effect)
                    const edgeFade = 1 - Math.pow(normalizedDist, 4);
                    const brightness = 0.3 + 0.7 * edgeFade;

                    ctx.fillStyle = `rgb(${Math.round(r*brightness)},${Math.round(g*brightness)},${Math.round(b*brightness)})`;
                    ctx.fillRect(x, y, step, step);
                }
            }

            // Specular highlight
            const hlX = cx - radius * 0.3;
            const hlY = cy - radius * 0.3;
            const hlGrad = ctx.createRadialGradient(hlX, hlY, 0, hlX, hlY, radius * 0.25);
            hlGrad.addColorStop(0, 'rgba(255,255,255,0.5)');
            hlGrad.addColorStop(1, 'rgba(255,255,255,0)');
            ctx.fillStyle = hlGrad;
            ctx.beginPath();
            ctx.arc(hlX, hlY, radius * 0.25, 0, Math.PI * 2);
            ctx.fill();

            // Bubble outline glow
            ctx.strokeStyle = 'rgba(150,200,255,0.15)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(cx, cy, radius, 0, Math.PI * 2);
            ctx.stroke();
        }

        function drawOilFilm(p, cosTheta) {
            const step = 4;
            for (let y = 0; y < H; y += step) {
                for (let x = 0; x < W; x += step) {
                    const nx = x / W;
                    const ny = y / H;

                    // Oil film: thickness varies smoothly with swirling patterns
                    const swirl1 = Math.sin(nx * 4 + time * 0.3) * Math.cos(ny * 3 + time * 0.2);
                    const swirl2 = Math.sin((nx + ny) * 5 - time * 0.4) * 0.5;
                    const swirl3 = Math.cos(nx * 7 - ny * 4 + time * 0.25) * 0.3;
                    const gradient = nx * 0.8 + ny * 0.4; // general gradient across surface

                    const thickness = p.baseThick * (0.5 + gradient * 0.5 + swirl1 * 0.2 + swirl2 * 0.15 + swirl3 * 0.1);

                    const [r, g, b] = thinFilmColor(thickness, p.n, cosTheta);

                    // Darken slightly for oil look
                    const dark = 0.75;
                    ctx.fillStyle = `rgb(${Math.round(r*dark)},${Math.round(g*dark)},${Math.round(b*dark)})`;
                    ctx.fillRect(x, y, step, step);
                }
            }
        }

        function animate() {
            draw();
            animId = requestAnimationFrame(animate);
        }

        window.reset = function() {
            time = 0;
            mode = 'bubble';
            els.btnBubble.classList.add('active');
            els.btnOil.classList.remove('active');
            els.thickness.value = 300;
            els.refIndex.value = 133;
            els.viewAngle.value = 0;
            els.flowSpeed.value = 10;
            updateLabels();
        };

        animate();
    </script>
    <script src="../assets/js/enhance.js"></script>
</body>
</html>
