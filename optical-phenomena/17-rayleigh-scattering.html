<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rayleigh Scattering - Optical Phenomena</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0a0e1a;
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }
        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
        }
        .back-link {
            position: fixed;
            top: 15px;
            left: 15px;
            color: #8af;
            text-decoration: none;
            font-size: 14px;
            z-index: 100;
            background: rgba(20,20,40,0.85);
            padding: 6px 14px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }
        .back-link:hover { color: #bdf; }
        #controls {
            position: fixed;
            top: 15px;
            right: 15px;
            background: rgba(20,20,40,0.85);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 16px;
            z-index: 100;
            width: 260px;
            border: 1px solid rgba(100,140,255,0.15);
        }
        #controls h3 {
            color: #8af;
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .control-group {
            margin-bottom: 10px;
        }
        .control-group label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 3px;
            color: #aaa;
        }
        .control-group label span { color: #8af; }
        input[type="range"] {
            width: 100%;
            height: 4px;
            -webkit-appearance: none;
            background: rgba(100,140,255,0.2);
            border-radius: 2px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #8af;
            cursor: pointer;
        }
        #info {
            position: fixed;
            bottom: 15px;
            left: 15px;
            background: rgba(20,20,40,0.85);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 14px 18px;
            z-index: 100;
            max-width: 380px;
            border: 1px solid rgba(100,140,255,0.15);
            font-size: 12px;
            line-height: 1.6;
            color: #bbb;
        }
        #info h4 { color: #8af; margin-bottom: 6px; font-size: 13px; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">&#8592; Optical Phenomena</a>
    <canvas id="canvas"></canvas>
    <div id="controls">
        <h3>Rayleigh Scattering</h3>
        <div class="control-group">
            <label>Sun Elevation <span id="sunVal">45&#176;</span></label>
            <input type="range" id="sunSlider" min="0" max="90" value="45" step="1">
        </div>
        <div class="control-group">
            <label>Particle Density <span id="densityVal">1.0x</span></label>
            <input type="range" id="densitySlider" min="0.1" max="3" value="1" step="0.1">
        </div>
        <div class="control-group">
            <label>Animation Speed <span id="speedVal">1.0x</span></label>
            <input type="range" id="speedSlider" min="0.2" max="3" value="1" step="0.1">
        </div>
        <div class="control-group">
            <label><input type="checkbox" id="showSpace" style="margin-right:6px;"> Show Space (no atmosphere)</label>
        </div>
    </div>
    <div id="info">
        <h4>Why Is The Sky Blue?</h4>
        <p>Rayleigh scattering intensity is proportional to <strong>1/&lambda;&sup4;</strong>. Blue light (&lambda;&asymp;450nm) scatters ~5.5x more than red (&lambda;&asymp;700nm).</p>
        <p style="margin-top:5px;">At sunset, sunlight travels a longer path through the atmosphere. Most blue is scattered away, leaving warm reds and oranges.</p>
    </div>
    <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    let W, H;
    function resize() {
        W = canvas.width = window.innerWidth;
        H = canvas.height = window.innerHeight;
        initParticles();
    }

    let sunElevation = 45;
    let density = 1;
    let speed = 1;
    let showSpace = false;
    let time = 0;
    let particles = [];
    let photons = [];

    const sunSlider = document.getElementById('sunSlider');
    const densitySlider = document.getElementById('densitySlider');
    const speedSlider = document.getElementById('speedSlider');
    const showSpaceBox = document.getElementById('showSpace');

    sunSlider.oninput = () => {
        sunElevation = +sunSlider.value;
        document.getElementById('sunVal').innerHTML = sunElevation + '&#176;';
    };
    densitySlider.oninput = () => {
        density = +densitySlider.value;
        document.getElementById('densityVal').textContent = density.toFixed(1) + 'x';
        initParticles();
    };
    speedSlider.oninput = () => {
        speed = +speedSlider.value;
        document.getElementById('speedVal').textContent = speed.toFixed(1) + 'x';
    };
    showSpaceBox.onchange = () => { showSpace = showSpaceBox.checked; };

    function initParticles() {
        const count = Math.floor(200 * density);
        particles = [];
        const atmTop = H * 0.15;
        const atmBot = H * 0.75;
        for (let i = 0; i < count; i++) {
            particles.push({
                x: Math.random() * W,
                y: atmTop + Math.random() * (atmBot - atmTop),
                r: 1.5 + Math.random() * 1.5,
                phase: Math.random() * Math.PI * 2,
                speed: 0.3 + Math.random() * 0.7
            });
        }
    }

    function wavelengthToRGB(wl) {
        let r = 0, g = 0, b = 0;
        if (wl >= 380 && wl < 440) { r = -(wl - 440) / 60; b = 1; }
        else if (wl >= 440 && wl < 490) { g = (wl - 440) / 50; b = 1; }
        else if (wl >= 490 && wl < 510) { g = 1; b = -(wl - 510) / 20; }
        else if (wl >= 510 && wl < 580) { r = (wl - 510) / 70; g = 1; }
        else if (wl >= 580 && wl < 645) { r = 1; g = -(wl - 645) / 65; }
        else if (wl >= 645 && wl <= 780) { r = 1; }
        let factor = 0.7;
        if (wl >= 380 && wl < 420) factor = 0.3 + 0.7 * (wl - 380) / 40;
        else if (wl > 700) factor = 0.3 + 0.7 * (780 - wl) / 80;
        else factor = 1;
        return [r * factor * 255, g * factor * 255, b * factor * 255];
    }

    function scatteringStrength(wavelength) {
        const wlNorm = wavelength / 550;
        return 1 / Math.pow(wlNorm, 4);
    }

    function getSkyColor(elevation, d) {
        if (showSpace) return [5, 5, 15];
        const pathLength = elevation <= 0 ? 20 : 1 / Math.sin(elevation * Math.PI / 180);
        const clampedPath = Math.min(pathLength, 20);
        let r = 0, g = 0, b = 0;
        const wavelengths = [450, 480, 510, 550, 580, 620, 680];
        const sunRGB = [[0, 0, 1], [0, 0.3, 1], [0, 0.8, 0.5], [0.3, 1, 0], [0.8, 0.8, 0], [1, 0.4, 0], [1, 0, 0]];
        for (let i = 0; i < wavelengths.length; i++) {
            const scatter = scatteringStrength(wavelengths[i]);
            const transmitted = Math.exp(-scatter * clampedPath * d * 0.15);
            const scattered = (1 - transmitted) * 0.6;
            r += sunRGB[i][0] * scattered;
            g += sunRGB[i][1] * scattered;
            b += sunRGB[i][2] * scattered;
        }
        const bright = 0.7 + 0.3 * Math.min(1, elevation / 45);
        return [
            Math.min(255, r * 255 * bright),
            Math.min(255, g * 255 * bright),
            Math.min(255, b * 255 * bright)
        ];
    }

    function getSunColor(elevation, d) {
        const pathLength = elevation <= 0 ? 20 : 1 / Math.sin(elevation * Math.PI / 180);
        const clampedPath = Math.min(pathLength, 20);
        let r = 255, g = 255, b = 255;
        const wavelengths = [[700, 0], [580, 1], [450, 2]];
        const channels = [r, g, b];
        for (const [wl, ch] of wavelengths) {
            const scatter = scatteringStrength(wl);
            const transmitted = Math.exp(-scatter * clampedPath * d * 0.15);
            channels[ch] = 255 * transmitted;
        }
        return channels;
    }

    function drawSky() {
        const skyC = getSkyColor(sunElevation, density);
        const groundLine = H * 0.75;
        const grad = ctx.createLinearGradient(0, 0, 0, groundLine);
        if (showSpace) {
            grad.addColorStop(0, 'rgb(2,2,8)');
            grad.addColorStop(1, 'rgb(5,5,15)');
        } else {
            const topR = Math.max(5, skyC[0] * 0.3);
            const topG = Math.max(5, skyC[1] * 0.3);
            const topB = Math.max(10, skyC[2] * 0.6);
            grad.addColorStop(0, `rgb(${topR},${topG},${topB})`);
            grad.addColorStop(0.5, `rgb(${skyC[0]},${skyC[1]},${skyC[2]})`);
            const horizR = Math.min(255, skyC[0] * 1.3 + 30);
            const horizG = Math.min(255, skyC[1] * 1.1 + 20);
            const horizB = Math.min(255, skyC[2] * 0.8 + 10);
            grad.addColorStop(1, `rgb(${horizR},${horizG},${horizB})`);
        }
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, W, groundLine);
        ctx.fillStyle = '#1a1510';
        ctx.fillRect(0, groundLine, W, H - groundLine);
        const gGrad = ctx.createLinearGradient(0, groundLine, 0, groundLine + 40);
        gGrad.addColorStop(0, `rgba(${skyC[0] * 0.3},${skyC[1] * 0.3},${skyC[2] * 0.2},0.5)`);
        gGrad.addColorStop(1, 'rgba(0,0,0,0)');
        ctx.fillStyle = gGrad;
        ctx.fillRect(0, groundLine, W, 40);
    }

    function drawSun() {
        const groundLine = H * 0.75;
        const elevRad = sunElevation * Math.PI / 180;
        const sunX = W * 0.5;
        const sunY = groundLine - Math.sin(elevRad) * (groundLine * 0.85);
        const sunC = getSunColor(sunElevation, density);
        const glow = ctx.createRadialGradient(sunX, sunY, 15, sunX, sunY, 120);
        glow.addColorStop(0, `rgba(${sunC[0]},${sunC[1]},${sunC[2]},1)`);
        glow.addColorStop(0.3, `rgba(${sunC[0]},${sunC[1]},${sunC[2]},0.4)`);
        glow.addColorStop(1, `rgba(${sunC[0]},${sunC[1]},${sunC[2]},0)`);
        ctx.fillStyle = glow;
        ctx.beginPath();
        ctx.arc(sunX, sunY, 120, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = `rgb(${sunC[0]},${sunC[1]},${sunC[2]})`;
        ctx.beginPath();
        ctx.arc(sunX, sunY, 20, 0, Math.PI * 2);
        ctx.fill();
        return { x: sunX, y: sunY };
    }

    function drawParticles(t) {
        if (showSpace) return;
        for (const p of particles) {
            const wobble = Math.sin(t * p.speed + p.phase) * 3;
            ctx.fillStyle = 'rgba(180,200,255,0.15)';
            ctx.beginPath();
            ctx.arc(p.x + wobble, p.y, p.r, 0, Math.PI * 2);
            ctx.fill();
        }
    }

    function drawScatteredPhotons(sun, t) {
        if (showSpace) return;
        const groundLine = H * 0.75;
        const numPhotons = Math.floor(40 * density);
        for (let i = 0; i < numPhotons; i++) {
            const seed = i * 137.5;
            const prog = ((t * speed * 0.3 + seed) % 10) / 10;
            const startX = sun.x;
            const startY = sun.y;
            const angle = (seed * 2.3 % 360) * Math.PI / 180;
            const dist = prog * W * 0.6;
            const px = startX + Math.cos(angle) * dist;
            const py = startY + Math.sin(angle) * dist * 0.5;
            if (py < 0 || py > groundLine || px < 0 || px > W) continue;
            const wl = 420 + (seed % 280);
            const scatter = scatteringStrength(wl);
            const alpha = Math.min(0.8, scatter * 0.15 * density) * (1 - prog);
            const rgb = wavelengthToRGB(wl);
            ctx.fillStyle = `rgba(${rgb[0]},${rgb[1]},${rgb[2]},${alpha})`;
            ctx.beginPath();
            ctx.arc(px, py, 2 + scatter * 1.5, 0, Math.PI * 2);
            ctx.fill();
        }
    }

    function drawStars() {
        if (!showSpace) return;
        for (let i = 0; i < 200; i++) {
            const sx = (i * 347.13) % W;
            const sy = (i * 213.77) % (H * 0.75);
            const bright = 0.3 + (i * 0.73 % 0.7);
            ctx.fillStyle = `rgba(255,255,255,${bright})`;
            ctx.beginPath();
            ctx.arc(sx, sy, 0.8 + (i % 3) * 0.3, 0, Math.PI * 2);
            ctx.fill();
        }
    }

    function drawSpectrumBar() {
        const barX = W * 0.3;
        const barW = W * 0.4;
        const barY = H * 0.82;
        const barH = 16;
        ctx.fillStyle = 'rgba(20,20,40,0.7)';
        ctx.fillRect(barX - 10, barY - 25, barW + 20, barH + 45);
        for (let i = 0; i < barW; i++) {
            const wl = 380 + (i / barW) * 400;
            const rgb = wavelengthToRGB(wl);
            const pathLen = sunElevation <= 0 ? 20 : 1 / Math.sin(sunElevation * Math.PI / 180);
            const scatter = scatteringStrength(wl);
            const transmitted = showSpace ? 1 : Math.exp(-scatter * Math.min(pathLen, 20) * density * 0.15);
            ctx.fillStyle = `rgb(${rgb[0] * transmitted},${rgb[1] * transmitted},${rgb[2] * transmitted})`;
            ctx.fillRect(barX + i, barY, 1, barH);
        }
        ctx.fillStyle = '#888';
        ctx.font = '10px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('380nm', barX, barY + barH + 14);
        ctx.fillText('550nm', barX + barW / 2, barY + barH + 14);
        ctx.fillText('780nm', barX + barW, barY + barH + 14);
        ctx.fillStyle = '#aaa';
        ctx.font = '11px sans-serif';
        ctx.fillText(showSpace ? 'Direct Sunlight Spectrum (no scattering)' : 'Transmitted Sunlight Spectrum', barX + barW / 2, barY - 8);
    }

    resize();
    window.addEventListener('resize', resize);

    function animate(ts) {
        time = ts * 0.001;
        ctx.clearRect(0, 0, W, H);
        drawSky();
        drawStars();
        const sun = drawSun();
        drawParticles(time);
        drawScatteredPhotons(sun, time);
        drawSpectrumBar();
        requestAnimationFrame(animate);
    }

    window.reset = function() {
        sunElevation = 45;
        density = 1;
        speed = 1;
        showSpace = false;
        sunSlider.value = 45;
        densitySlider.value = 1;
        speedSlider.value = 1;
        showSpaceBox.checked = false;
        document.getElementById('sunVal').innerHTML = '45&#176;';
        document.getElementById('densityVal').textContent = '1.0x';
        document.getElementById('speedVal').textContent = '1.0x';
        initParticles();
    };

    requestAnimationFrame(animate);
    </script>
    <script src="../assets/js/enhance.js"></script>
</body>
</html>
