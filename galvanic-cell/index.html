<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Galvanic Cell (Battery)</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
canvas { display: block; }
.title-overlay {
    position: fixed; top: 50px; left: 50%; transform: translateX(-50%);
    color: #fbbf24; font-size: 20px; font-weight: 600; z-index: 998;
    text-shadow: 0 0 10px rgba(251,191,36,0.5); pointer-events: none;
}
.controls {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
    display: flex; gap: 16px; align-items: center; z-index: 999;
    background: rgba(0,0,0,0.7); padding: 12px 24px; border-radius: 12px;
    border: 1px solid rgba(251,191,36,0.3); flex-wrap: wrap; justify-content: center;
}
.controls label { color: #ccc; font-size: 13px; white-space: nowrap; }
.controls input[type=range] { width: 110px; accent-color: #fbbf24; }
.controls span { color: #fbbf24; font-size: 13px; }
.controls button {
    background: rgba(251,191,36,0.2); color: #fbbf24; border: 1px solid rgba(251,191,36,0.5);
    padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 13px;
}
.controls button:hover { background: rgba(251,191,36,0.4); }
</style>
</head>
<body>
<a href="../index.html" style="position:fixed;top:10px;left:10px;padding:8px 16px;background:rgba(0,0,0,0.7);color:#fbbf24;text-decoration:none;border-radius:6px;font-size:14px;z-index:999;font-family:sans-serif;">← Back to Gallery</a>
<div class="title-overlay">Galvanic Cell (Electrochemical Battery)</div>
<div class="controls">
    <label>Reaction Rate: <input type="range" id="rateSlider" min="1" max="10" value="5"> <span id="rateVal">5</span></label>
    <button id="resetBtn">Reset</button>
</div>
<canvas id="canvas"></canvas>
<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let W, H;

function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
}
resize();
window.addEventListener('resize', resize);

let reactionRate = 5;
let frame = 0;
let voltage = 1.10;
let electrons = [];
let anodeIons = [];
let cathodeIons = [];
let saltBridgeIons = [];
let anodeAtoms = [];
let cathodeDeposits = [];
let totalElectronsTransferred = 0;

// Cell geometry
function getCellGeometry() {
    const cellTop = 120;
    const cellBottom = H - 130;
    const cellH = cellBottom - cellTop;
    const cellW = Math.min(W - 80, 900);
    const cellLeft = (W - cellW) / 2;

    const anodeLeft = cellLeft;
    const anodeRight = cellLeft + cellW * 0.4;
    const cathodeLeft = cellLeft + cellW * 0.6;
    const cathodeRight = cellLeft + cellW;
    const bridgeLeft = anodeRight;
    const bridgeRight = cathodeLeft;

    const solutionTop = cellTop + cellH * 0.35;
    const electrodeW = 20;
    const anodeElecX = anodeLeft + (anodeRight - anodeLeft) * 0.3;
    const cathodeElecX = cathodeLeft + (cathodeRight - cathodeLeft) * 0.7;

    return { cellTop, cellBottom, cellH, cellW, cellLeft, anodeLeft, anodeRight, cathodeLeft, cathodeRight,
             bridgeLeft, bridgeRight, solutionTop, electrodeW, anodeElecX, cathodeElecX };
}

function init() {
    electrons = [];
    anodeIons = [];
    cathodeIons = [];
    saltBridgeIons = [];
    anodeAtoms = [];
    cathodeDeposits = [];
    totalElectronsTransferred = 0;
    voltage = 1.10;

    const g = getCellGeometry();

    // Initial anode atoms (Zn)
    for (let i = 0; i < 25; i++) {
        anodeAtoms.push({
            x: g.anodeElecX - g.electrodeW / 2 + Math.random() * g.electrodeW,
            y: g.solutionTop + 20 + Math.random() * (g.cellBottom - g.solutionTop - 40),
            r: 4
        });
    }

    // Initial solution ions
    for (let i = 0; i < 15; i++) {
        anodeIons.push(createIon('Zn²⁺', g.anodeLeft + 20, g.anodeRight - 20, g.solutionTop + 10, g.cellBottom - 10));
        anodeIons.push(createIon('SO₄²⁻', g.anodeLeft + 20, g.anodeRight - 20, g.solutionTop + 10, g.cellBottom - 10));
    }
    for (let i = 0; i < 15; i++) {
        cathodeIons.push(createIon('Cu²⁺', g.cathodeLeft + 20, g.cathodeRight - 20, g.solutionTop + 10, g.cellBottom - 10));
        cathodeIons.push(createIon('SO₄²⁻', g.cathodeLeft + 20, g.cathodeRight - 20, g.solutionTop + 10, g.cellBottom - 10));
    }

    // Salt bridge ions (K+ and NO3-)
    for (let i = 0; i < 10; i++) {
        const bridgeCY = g.solutionTop - 15;
        saltBridgeIons.push({
            x: g.bridgeLeft + Math.random() * (g.bridgeRight - g.bridgeLeft),
            y: bridgeCY - 10 + Math.random() * 20,
            vx: (Math.random() - 0.5) * 0.5,
            vy: 0,
            type: Math.random() < 0.5 ? 'K⁺' : 'NO₃⁻',
            r: 3
        });
    }
}

function createIon(type, xMin, xMax, yMin, yMax) {
    return {
        x: xMin + Math.random() * (xMax - xMin),
        y: yMin + Math.random() * (yMax - yMin),
        vx: (Math.random() - 0.5) * 1.5,
        vy: (Math.random() - 0.5) * 1.5,
        type: type,
        r: 4,
        flash: 0
    };
}

init();
window.addEventListener('resize', () => { resize(); init(); });

document.getElementById('rateSlider').addEventListener('input', function() {
    reactionRate = +this.value;
    document.getElementById('rateVal').textContent = this.value;
});
document.getElementById('resetBtn').addEventListener('click', init);

function updateIons(ions, xMin, xMax, yMin, yMax) {
    for (let ion of ions) {
        ion.x += ion.vx;
        ion.y += ion.vy;
        if (ion.flash > 0) ion.flash *= 0.93;
        if (ion.x < xMin + ion.r) { ion.x = xMin + ion.r; ion.vx *= -1; }
        if (ion.x > xMax - ion.r) { ion.x = xMax - ion.r; ion.vx *= -1; }
        if (ion.y < yMin + ion.r) { ion.y = yMin + ion.r; ion.vy *= -1; }
        if (ion.y > yMax - ion.r) { ion.y = yMax - ion.r; ion.vy *= -1; }
    }
}

function update() {
    frame++;
    const g = getCellGeometry();

    // Update solution ions
    updateIons(anodeIons, g.anodeLeft + 5, g.anodeRight - 5, g.solutionTop + 5, g.cellBottom - 5);
    updateIons(cathodeIons, g.cathodeLeft + 5, g.cathodeRight - 5, g.solutionTop + 5, g.cellBottom - 5);

    // Salt bridge ions
    for (let ion of saltBridgeIons) {
        ion.x += ion.vx;
        // Drift: K+ toward cathode, NO3- toward anode
        if (ion.type === 'K⁺') ion.vx += 0.01;
        else ion.vx -= 0.01;
        ion.vx *= 0.99;
        if (ion.x < g.bridgeLeft + 5) { ion.x = g.bridgeLeft + 5; ion.vx *= -0.5; }
        if (ion.x > g.bridgeRight - 5) { ion.x = g.bridgeRight - 5; ion.vx *= -0.5; }
    }

    // Anode reaction: Zn → Zn²⁺ + 2e⁻
    if (frame % Math.max(1, Math.floor(60 / reactionRate)) === 0 && anodeAtoms.length > 0) {
        const atom = anodeAtoms.pop();

        // Create Zn²⁺ ion
        const newIon = createIon('Zn²⁺', atom.x - 10, atom.x + 10, atom.y - 5, atom.y + 5);
        newIon.flash = 1;
        anodeIons.push(newIon);

        // Create 2 electrons
        for (let i = 0; i < 2; i++) {
            electrons.push({
                x: g.anodeElecX,
                y: g.solutionTop - 5,
                targetX: g.cathodeElecX,
                progress: 0,
                speed: 0.003 + Math.random() * 0.002,
                alive: true
            });
        }
    }

    // Update electrons along wire
    for (let e of electrons) {
        e.progress += e.speed * reactionRate;
        if (e.progress >= 1) {
            e.alive = false;
            totalElectronsTransferred++;

            // Cathode reaction: Cu²⁺ + 2e⁻ → Cu
            if (totalElectronsTransferred % 2 === 0) {
                const cuIons = cathodeIons.filter(i => i.type === 'Cu²⁺');
                if (cuIons.length > 0) {
                    const idx = cathodeIons.indexOf(cuIons[0]);
                    cathodeIons.splice(idx, 1);
                    cathodeDeposits.push({
                        x: g.cathodeElecX - g.electrodeW / 2 + Math.random() * g.electrodeW,
                        y: g.solutionTop + 20 + Math.random() * (g.cellBottom - g.solutionTop - 40),
                        r: 4,
                        flash: 1
                    });
                }
            }
        }
    }
    electrons = electrons.filter(e => e.alive);

    // Slowly replenish Cu²⁺ and add salt bridge ions as needed
    if (frame % 120 === 0 && cathodeIons.filter(i => i.type === 'Cu²⁺').length < 5) {
        cathodeIons.push(createIon('Cu²⁺', g.cathodeLeft + 20, g.cathodeRight - 20, g.solutionTop + 10, g.cellBottom - 10));
    }

    // Update voltage (decreases as anode dissolves)
    voltage = 1.10 * (anodeAtoms.length / 25);
    for (let d of cathodeDeposits) {
        if (d.flash > 0) d.flash *= 0.93;
    }
}

function drawCell() {
    const g = getCellGeometry();

    // Container walls
    ctx.strokeStyle = 'rgba(255,255,255,0.3)';
    ctx.lineWidth = 2;

    // Anode beaker
    ctx.beginPath();
    ctx.moveTo(g.anodeLeft, g.cellTop);
    ctx.lineTo(g.anodeLeft, g.cellBottom);
    ctx.lineTo(g.anodeRight, g.cellBottom);
    ctx.lineTo(g.anodeRight, g.cellTop);
    ctx.stroke();

    // Cathode beaker
    ctx.beginPath();
    ctx.moveTo(g.cathodeLeft, g.cellTop);
    ctx.lineTo(g.cathodeLeft, g.cellBottom);
    ctx.lineTo(g.cathodeRight, g.cellBottom);
    ctx.lineTo(g.cathodeRight, g.cellTop);
    ctx.stroke();

    // Solutions
    ctx.fillStyle = 'rgba(74, 158, 255, 0.06)';
    ctx.fillRect(g.anodeLeft + 2, g.solutionTop, g.anodeRight - g.anodeLeft - 4, g.cellBottom - g.solutionTop - 2);
    ctx.fillStyle = 'rgba(34, 197, 94, 0.06)';
    ctx.fillRect(g.cathodeLeft + 2, g.solutionTop, g.cathodeRight - g.cathodeLeft - 4, g.cellBottom - g.solutionTop - 2);

    // Electrodes
    // Anode (Zn - gray/silver)
    const anodeH = g.cellBottom - g.cellTop + 30;
    ctx.fillStyle = '#8a8a8a';
    ctx.fillRect(g.anodeElecX - g.electrodeW / 2, g.cellTop - 30, g.electrodeW, anodeH);
    ctx.strokeStyle = '#aaa';
    ctx.lineWidth = 1;
    ctx.strokeRect(g.anodeElecX - g.electrodeW / 2, g.cellTop - 30, g.electrodeW, anodeH);

    // Anode atoms
    for (let atom of anodeAtoms) {
        ctx.beginPath();
        ctx.arc(atom.x, atom.y, atom.r, 0, Math.PI * 2);
        ctx.fillStyle = '#c0c0c0';
        ctx.fill();
    }

    // Cathode (Cu - copper colored)
    ctx.fillStyle = '#b87333';
    ctx.fillRect(g.cathodeElecX - g.electrodeW / 2, g.cellTop - 30, g.electrodeW, anodeH);
    ctx.strokeStyle = '#d4956b';
    ctx.lineWidth = 1;
    ctx.strokeRect(g.cathodeElecX - g.electrodeW / 2, g.cellTop - 30, g.electrodeW, anodeH);

    // Cathode deposits
    for (let dep of cathodeDeposits) {
        ctx.beginPath();
        ctx.arc(dep.x, dep.y, dep.r, 0, Math.PI * 2);
        ctx.fillStyle = '#d4956b';
        ctx.fill();
        if (dep.flash > 0.1) {
            ctx.beginPath();
            ctx.arc(dep.x, dep.y, dep.r + 8 * dep.flash, 0, Math.PI * 2);
            ctx.strokeStyle = `rgba(212, 149, 107, ${dep.flash * 0.5})`;
            ctx.lineWidth = 2;
            ctx.stroke();
        }
    }

    // Electrode labels
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 12px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('Zn', g.anodeElecX, g.cellTop - 38);
    ctx.fillText('(Anode)', g.anodeElecX, g.cellTop - 50);
    ctx.fillText('Cu', g.cathodeElecX, g.cellTop - 38);
    ctx.fillText('(Cathode)', g.cathodeElecX, g.cellTop - 50);

    // Wire
    const wireY = g.cellTop - 65;
    ctx.strokeStyle = '#fbbf24';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(g.anodeElecX, g.cellTop - 30);
    ctx.lineTo(g.anodeElecX, wireY);
    ctx.lineTo(g.cathodeElecX, wireY);
    ctx.lineTo(g.cathodeElecX, g.cellTop - 30);
    ctx.stroke();

    // Electron flow direction arrow
    const arrowX = (g.anodeElecX + g.cathodeElecX) / 2;
    ctx.fillStyle = '#fbbf24';
    ctx.beginPath();
    ctx.moveTo(arrowX + 15, wireY - 5);
    ctx.lineTo(arrowX + 25, wireY);
    ctx.lineTo(arrowX + 15, wireY + 5);
    ctx.fill();
    ctx.fillStyle = '#fbbf24';
    ctx.font = '10px sans-serif';
    ctx.fillText('e⁻ flow →', arrowX, wireY - 10);

    // Electrons on wire
    for (let e of electrons) {
        const t = e.progress;
        let ex, ey;
        // Path: up from anode, across, down to cathode
        if (t < 0.25) {
            // Going up
            const localT = t / 0.25;
            ex = g.anodeElecX;
            ey = g.cellTop - 30 - localT * (g.cellTop - 30 - wireY);
        } else if (t < 0.75) {
            // Going across
            const localT = (t - 0.25) / 0.5;
            ex = g.anodeElecX + localT * (g.cathodeElecX - g.anodeElecX);
            ey = wireY;
        } else {
            // Going down
            const localT = (t - 0.75) / 0.25;
            ex = g.cathodeElecX;
            ey = wireY + localT * (g.cellTop - 30 - wireY);
        }

        ctx.beginPath();
        ctx.arc(ex, ey, 3, 0, Math.PI * 2);
        ctx.fillStyle = '#fbbf24';
        ctx.fill();

        // Glow
        const grd = ctx.createRadialGradient(ex, ey, 0, ex, ey, 8);
        grd.addColorStop(0, 'rgba(251,191,36,0.5)');
        grd.addColorStop(1, 'transparent');
        ctx.beginPath();
        ctx.arc(ex, ey, 8, 0, Math.PI * 2);
        ctx.fillStyle = grd;
        ctx.fill();
    }

    // Salt bridge
    const bridgeY = g.solutionTop - 30;
    const bridgeH = 30;
    ctx.fillStyle = 'rgba(200, 200, 200, 0.15)';
    ctx.beginPath();
    ctx.moveTo(g.anodeRight - 30, g.solutionTop + 30);
    ctx.quadraticCurveTo(g.anodeRight - 30, bridgeY, (g.bridgeLeft + g.bridgeRight) / 2, bridgeY);
    ctx.quadraticCurveTo(g.cathodeLeft + 30, bridgeY, g.cathodeLeft + 30, g.solutionTop + 30);
    ctx.lineTo(g.cathodeLeft + 40, g.solutionTop + 30);
    ctx.quadraticCurveTo(g.cathodeLeft + 40, bridgeY - 10, (g.bridgeLeft + g.bridgeRight) / 2, bridgeY - 10);
    ctx.quadraticCurveTo(g.anodeRight - 20, bridgeY - 10, g.anodeRight - 20, g.solutionTop + 30);
    ctx.closePath();
    ctx.fill();
    ctx.strokeStyle = 'rgba(255,255,255,0.2)';
    ctx.lineWidth = 1;
    ctx.stroke();

    ctx.fillStyle = 'rgba(255,255,255,0.4)';
    ctx.font = '10px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('Salt Bridge (KNO₃)', (g.bridgeLeft + g.bridgeRight) / 2, bridgeY - 15);

    // Salt bridge ions
    for (let ion of saltBridgeIons) {
        ctx.beginPath();
        ctx.arc(ion.x, ion.y, ion.r, 0, Math.PI * 2);
        ctx.fillStyle = ion.type === 'K⁺' ? 'rgba(168,85,247,0.7)' : 'rgba(255,165,0,0.7)';
        ctx.fill();
    }

    // Solution ions
    const ionColors = {
        'Zn²⁺': '#7cb3ff', 'Cu²⁺': '#22c55e', 'SO₄²⁻': '#ff8c69'
    };
    for (let ion of [...anodeIons, ...cathodeIons]) {
        ctx.beginPath();
        ctx.arc(ion.x, ion.y, ion.r, 0, Math.PI * 2);
        ctx.fillStyle = ionColors[ion.type] || '#aaa';
        ctx.fill();

        if (ion.flash > 0.1) {
            ctx.beginPath();
            ctx.arc(ion.x, ion.y, ion.r + 8 * ion.flash, 0, Math.PI * 2);
            ctx.strokeStyle = `rgba(251,191,36,${ion.flash * 0.5})`;
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        ctx.fillStyle = '#000';
        ctx.font = 'bold 6px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        if (ion.type === 'SO₄²⁻') ctx.fillText('SO₄', ion.x, ion.y);
        else ctx.fillText(ion.type.replace('²⁺', ''), ion.x, ion.y);
    }

    // Solution labels
    ctx.fillStyle = 'rgba(74,158,255,0.5)';
    ctx.font = '12px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('ZnSO₄ (aq)', (g.anodeLeft + g.anodeRight) / 2, g.cellBottom + 18);
    ctx.fillStyle = 'rgba(34,197,94,0.5)';
    ctx.fillText('CuSO₄ (aq)', (g.cathodeLeft + g.cathodeRight) / 2, g.cellBottom + 18);

    // Sign labels
    ctx.font = 'bold 20px sans-serif';
    ctx.fillStyle = '#ff4a6a';
    ctx.fillText('−', g.anodeElecX, wireY - 18);
    ctx.fillStyle = '#22c55e';
    ctx.fillText('+', g.cathodeElecX, wireY - 18);

    // Voltage meter
    const vmX = (g.anodeElecX + g.cathodeElecX) / 2;
    const vmY = wireY - 5;
    const vmR = 28;

    ctx.beginPath();
    ctx.arc(vmX, vmY, vmR, 0, Math.PI * 2);
    ctx.fillStyle = 'rgba(0,0,0,0.8)';
    ctx.fill();
    ctx.strokeStyle = '#fbbf24';
    ctx.lineWidth = 2;
    ctx.stroke();

    ctx.fillStyle = '#fbbf24';
    ctx.font = 'bold 13px sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(voltage.toFixed(2) + 'V', vmX, vmY - 2);
    ctx.fillStyle = '#888';
    ctx.font = '8px sans-serif';
    ctx.fillText('VOLTMETER', vmX, vmY + 12);

    // Reactions
    ctx.fillStyle = 'rgba(0,0,0,0.5)';
    ctx.beginPath();
    ctx.roundRect(20, H - 95, W - 40, 35, 8);
    ctx.fill();
    ctx.font = '12px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillStyle = '#7cb3ff';
    ctx.fillText('Anode: Zn → Zn²⁺ + 2e⁻  (oxidation)', W * 0.3, H - 74);
    ctx.fillStyle = '#22c55e';
    ctx.fillText('Cathode: Cu²⁺ + 2e⁻ → Cu  (reduction)', W * 0.7, H - 74);
}

function draw() {
    ctx.fillStyle = '#0a0e1a';
    ctx.fillRect(0, 0, W, H);

    drawCell();

    // Legend
    const g = getCellGeometry();
    ctx.fillStyle = 'rgba(0,0,0,0.6)';
    ctx.beginPath();
    ctx.roundRect(W - 200, 80, 180, 110, 10);
    ctx.fill();
    ctx.strokeStyle = 'rgba(255,255,255,0.15)';
    ctx.stroke();

    ctx.font = '11px sans-serif';
    ctx.textAlign = 'left';
    ctx.fillStyle = '#7cb3ff'; ctx.fillText('● Zn²⁺', W - 190, 100);
    ctx.fillStyle = '#22c55e'; ctx.fillText('● Cu²⁺', W - 190, 118);
    ctx.fillStyle = '#ff8c69'; ctx.fillText('● SO₄²⁻', W - 190, 136);
    ctx.fillStyle = '#fbbf24'; ctx.fillText('● Electrons', W - 190, 154);
    ctx.fillStyle = '#aaa'; ctx.fillText(`Transferred: ${totalElectronsTransferred}e⁻`, W - 190, 178);
}

function animate() {
    update();
    draw();
    requestAnimationFrame(animate);
}
animate();
</script>
</body>
</html>
