<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mandelbrot Fractal Zoom - Remotion Video Effects</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #050510;
            overflow: hidden;
            font-family: 'Courier New', monospace;
            user-select: none;
        }
        canvas { display: block; }
        #julia-canvas {
            position: fixed;
            bottom: 0;
            right: 0;
            border: 1px solid rgba(100,200,255,0.15);
            border-radius: 4px 0 0 0;
            z-index: 15;
            cursor: pointer;
            transition: opacity 0.3s;
        }
        #julia-canvas.hidden { display: none; }
        a.back-link {
            position: fixed;
            top: 1rem;
            left: 1rem;
            color: rgba(100, 200, 255, 0.6);
            text-decoration: none;
            font-family: monospace;
            font-size: 0.85rem;
            z-index: 20;
            transition: color 0.3s;
        }
        a.back-link:hover { color: rgba(100, 200, 255, 1); }
        .info-overlay {
            position: fixed;
            bottom: 1.5rem;
            left: 1.5rem;
            font-family: monospace;
            font-size: 0.7rem;
            color: rgba(100, 200, 255, 0.5);
            z-index: 20;
            text-align: left;
            line-height: 1.7;
            pointer-events: none;
        }
        .coords-overlay {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            font-family: monospace;
            font-size: 0.65rem;
            color: rgba(100, 200, 255, 0.4);
            z-index: 20;
            text-align: right;
            line-height: 1.6;
            pointer-events: none;
        }
        .vignette {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: radial-gradient(ellipse at center, transparent 50%, rgba(5,5,16,0.6) 100%);
            pointer-events: none;
            z-index: 10;
        }
        .film-grain {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 11;
            opacity: 0.04;
            mix-blend-mode: overlay;
        }
        /* Crosshair */
        .crosshair {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 12;
        }
        .crosshair::before, .crosshair::after {
            content: '';
            position: absolute;
            background: rgba(100, 200, 255, 0.2);
        }
        .crosshair::before {
            width: 1px; height: 30px;
            left: 0; top: -15px;
        }
        .crosshair::after {
            width: 30px; height: 1px;
            left: -15px; top: 0;
        }
        .crosshair.hidden { display: none; }
        /* Minimap */
        #minimap {
            position: fixed;
            top: 4.5rem;
            left: 1rem;
            width: 120px;
            height: 90px;
            border: 1px solid rgba(100,200,255,0.2);
            border-radius: 4px;
            z-index: 20;
            background: #050510;
            cursor: pointer;
        }
        #minimap.hidden { display: none; }
        /* Control panel */
        .controls {
            position: fixed;
            top: 50%;
            right: 1rem;
            transform: translateY(-50%);
            z-index: 25;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .controls button {
            background: rgba(10, 10, 30, 0.7);
            border: 1px solid rgba(100, 200, 255, 0.2);
            color: rgba(100, 200, 255, 0.7);
            font-family: monospace;
            font-size: 0.6rem;
            padding: 5px 8px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            backdrop-filter: blur(10px);
        }
        .controls button:hover {
            background: rgba(30, 30, 80, 0.8);
            border-color: rgba(100, 200, 255, 0.5);
            color: rgba(100, 200, 255, 1);
        }
        .controls button.active {
            background: rgba(60, 60, 120, 0.6);
            border-color: rgba(100, 200, 255, 0.6);
            color: rgba(100, 200, 255, 1);
        }
        .controls .separator {
            height: 1px;
            background: rgba(100, 200, 255, 0.1);
            margin: 2px 0;
        }
        /* Palette presets bar */
        .palette-bar {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 25;
            display: flex;
            gap: 4px;
        }
        .palette-bar button {
            background: rgba(10, 10, 30, 0.7);
            border: 1px solid rgba(100, 200, 255, 0.15);
            color: rgba(100, 200, 255, 0.6);
            font-family: monospace;
            font-size: 0.55rem;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
        }
        .palette-bar button:hover {
            border-color: rgba(100, 200, 255, 0.5);
            color: rgba(100, 200, 255, 1);
        }
        .palette-bar button.active {
            background: rgba(60, 60, 120, 0.5);
            border-color: rgba(100, 200, 255, 0.5);
            color: rgba(100, 200, 255, 1);
        }
        /* Zoom presets */
        .zoom-presets {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 25;
            display: flex;
            gap: 4px;
        }
        .zoom-presets button {
            background: rgba(10, 10, 30, 0.7);
            border: 1px solid rgba(100, 200, 255, 0.15);
            color: rgba(100, 200, 255, 0.5);
            font-family: monospace;
            font-size: 0.55rem;
            padding: 3px 7px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
        }
        .zoom-presets button:hover {
            border-color: rgba(100, 200, 255, 0.5);
            color: rgba(100, 200, 255, 1);
        }
        .zoom-presets button.active {
            background: rgba(60, 60, 120, 0.5);
            border-color: rgba(100, 200, 255, 0.5);
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link" style="position:fixed;top:1rem;left:1rem;color:rgba(100,200,255,0.6);text-decoration:none;font-family:monospace;font-size:0.85rem;z-index:20;transition:color 0.3s">&#8592; Back to Gallery</a>
    <div class="vignette"></div>
    <canvas class="film-grain" id="grain"></canvas>
    <div class="crosshair" id="crosshair"></div>
    <canvas id="canvas"></canvas>
    <canvas id="julia-canvas"></canvas>
    <canvas id="minimap"></canvas>
    <div class="info-overlay" id="info"></div>
    <div class="coords-overlay" id="coords"></div>

    <!-- Zoom presets -->
    <div class="zoom-presets" id="zoom-presets"></div>

    <!-- Right-side controls -->
    <div class="controls" id="controls">
        <button id="btn-julia" title="Toggle Julia set companion">Julia</button>
        <button id="btn-orbit" title="Toggle orbit trap rendering">Orbit</button>
        <button id="btn-distance" title="Toggle distance estimation">Dist</button>
        <button id="btn-crosshair" title="Toggle crosshair">Cross</button>
        <button id="btn-minimap" title="Toggle minimap">Map</button>
        <div class="separator"></div>
        <button id="btn-screenshot" title="Screenshot to clipboard">Snap</button>
        <button id="btn-pause" title="Pause/Resume [Space]">Pause</button>
        <button id="btn-reset" title="Reset [R]">Reset</button>
    </div>

    <!-- Palette bar -->
    <div class="palette-bar" id="palette-bar"></div>

    <script>
    (function() {
        'use strict';

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const info = document.getElementById('info');
        const coordsEl = document.getElementById('coords');
        const juliaCanvas = document.getElementById('julia-canvas');
        const juliaCtx = juliaCanvas.getContext('2d');
        const minimapCanvas = document.getElementById('minimap');
        const minimapCtx = minimapCanvas.getContext('2d');
        const grainCanvas = document.getElementById('grain');
        const grainCtx = grainCanvas.getContext('2d');
        const crosshairEl = document.getElementById('crosshair');

        let W, H;
        let imageData, pixels;

        // --- Zoom targets ---
        const ZOOM_TARGETS = [
            { name: 'Seahorse Valley', cx: -0.7463, cy: 0.1102 },
            { name: 'Elephant Valley', cx: 0.2819, cy: 0.0100 },
            { name: 'Scepter Valley', cx: -0.7436431, cy: 0.1318259 },
            { name: 'Antenna', cx: -1.2567136, cy: 0.3823021 },
            { name: 'Mini Mandelbrot', cx: -1.7497591, cy: 0.0000001 },
            { name: 'Spiral Arms', cx: -0.7498530, cy: 0.0122989 }
        ];

        let targetIdx = 0;
        let target = ZOOM_TARGETS[targetIdx];

        // --- State ---
        let zoomLevel = 1.0;
        let zoomSpeed = 0.004;
        const INITIAL_RADIUS = 2.0;
        const MAX_ZOOM = 1e14;
        let colorOffset = 0;
        let paused = false;
        let showJulia = false;
        let showOrbitTraps = false;
        let showDistanceEst = false;
        let showCrosshair = true;
        let showMinimap = true;
        let mouseX = 0, mouseY = 0;
        let juliaR = -0.7, juliaI = 0.27015;
        let currentPaletteIdx = 0;

        // --- Color Palettes ---
        const PALETTE_SIZE = 2048;
        let palette = new Float64Array(PALETTE_SIZE * 3);

        const PALETTE_DEFS = [
            {
                name: 'Cinematic',
                stops: [
                    { pos: 0.00, r: 0.02, g: 0.01, b: 0.10 },
                    { pos: 0.10, r: 0.05, g: 0.02, b: 0.30 },
                    { pos: 0.22, r: 0.15, g: 0.05, b: 0.60 },
                    { pos: 0.35, r: 0.40, g: 0.10, b: 0.70 },
                    { pos: 0.45, r: 0.60, g: 0.15, b: 0.55 },
                    { pos: 0.55, r: 0.85, g: 0.45, b: 0.15 },
                    { pos: 0.65, r: 1.00, g: 0.75, b: 0.20 },
                    { pos: 0.75, r: 1.00, g: 0.95, b: 0.80 },
                    { pos: 0.85, r: 0.50, g: 0.60, b: 0.90 },
                    { pos: 0.93, r: 0.15, g: 0.15, b: 0.50 },
                    { pos: 1.00, r: 0.02, g: 0.01, b: 0.10 }
                ]
            },
            {
                name: 'Fire',
                stops: [
                    { pos: 0.00, r: 0.0, g: 0.0, b: 0.0 },
                    { pos: 0.15, r: 0.2, g: 0.0, b: 0.0 },
                    { pos: 0.30, r: 0.5, g: 0.0, b: 0.0 },
                    { pos: 0.45, r: 0.8, g: 0.2, b: 0.0 },
                    { pos: 0.58, r: 1.0, g: 0.5, b: 0.0 },
                    { pos: 0.70, r: 1.0, g: 0.8, b: 0.2 },
                    { pos: 0.82, r: 1.0, g: 1.0, b: 0.6 },
                    { pos: 0.92, r: 1.0, g: 1.0, b: 1.0 },
                    { pos: 1.00, r: 0.0, g: 0.0, b: 0.0 }
                ]
            },
            {
                name: 'Ocean',
                stops: [
                    { pos: 0.00, r: 0.0, g: 0.02, b: 0.08 },
                    { pos: 0.12, r: 0.0, g: 0.05, b: 0.2 },
                    { pos: 0.25, r: 0.0, g: 0.15, b: 0.4 },
                    { pos: 0.37, r: 0.0, g: 0.3, b: 0.6 },
                    { pos: 0.50, r: 0.1, g: 0.55, b: 0.8 },
                    { pos: 0.62, r: 0.3, g: 0.75, b: 0.9 },
                    { pos: 0.75, r: 0.6, g: 0.9, b: 1.0 },
                    { pos: 0.87, r: 0.9, g: 1.0, b: 1.0 },
                    { pos: 1.00, r: 0.0, g: 0.02, b: 0.08 }
                ]
            },
            {
                name: 'Psychedelic',
                stops: [
                    { pos: 0.00, r: 1.0, g: 0.0, b: 0.5 },
                    { pos: 0.14, r: 1.0, g: 0.0, b: 1.0 },
                    { pos: 0.28, r: 0.3, g: 0.0, b: 1.0 },
                    { pos: 0.42, r: 0.0, g: 0.5, b: 1.0 },
                    { pos: 0.56, r: 0.0, g: 1.0, b: 0.5 },
                    { pos: 0.70, r: 0.5, g: 1.0, b: 0.0 },
                    { pos: 0.84, r: 1.0, g: 1.0, b: 0.0 },
                    { pos: 1.00, r: 1.0, g: 0.0, b: 0.5 }
                ]
            },
            {
                name: 'Mono',
                stops: [
                    { pos: 0.00, r: 0.0, g: 0.0, b: 0.0 },
                    { pos: 0.25, r: 0.2, g: 0.2, b: 0.22 },
                    { pos: 0.50, r: 0.55, g: 0.55, b: 0.58 },
                    { pos: 0.75, r: 0.9, g: 0.9, b: 0.95 },
                    { pos: 0.90, r: 1.0, g: 1.0, b: 1.0 },
                    { pos: 1.00, r: 0.0, g: 0.0, b: 0.0 }
                ]
            },
            {
                name: 'Neon',
                stops: [
                    { pos: 0.00, r: 0.0, g: 0.0, b: 0.05 },
                    { pos: 0.10, r: 0.0, g: 1.0, b: 0.4 },
                    { pos: 0.25, r: 0.0, g: 0.3, b: 0.1 },
                    { pos: 0.40, r: 1.0, g: 0.0, b: 0.8 },
                    { pos: 0.55, r: 0.2, g: 0.0, b: 0.15 },
                    { pos: 0.65, r: 0.0, g: 0.6, b: 1.0 },
                    { pos: 0.80, r: 0.0, g: 0.1, b: 0.2 },
                    { pos: 0.90, r: 1.0, g: 1.0, b: 0.0 },
                    { pos: 1.00, r: 0.0, g: 0.0, b: 0.05 }
                ]
            }
        ];

        function buildPalette(defIdx) {
            const stops = PALETTE_DEFS[defIdx].stops;
            for (let i = 0; i < PALETTE_SIZE; i++) {
                const t = i / PALETTE_SIZE;
                let s0 = stops[0], s1 = stops[1];
                for (let j = 1; j < stops.length; j++) {
                    if (t <= stops[j].pos) {
                        s0 = stops[j - 1];
                        s1 = stops[j];
                        break;
                    }
                }
                const f = (t - s0.pos) / (s1.pos - s0.pos);
                const sf = f * f * (3 - 2 * f);
                const idx = i * 3;
                palette[idx    ] = s0.r + (s1.r - s0.r) * sf;
                palette[idx + 1] = s0.g + (s1.g - s0.g) * sf;
                palette[idx + 2] = s0.b + (s1.b - s0.b) * sf;
            }
        }

        // --- Film grain ---
        function renderGrain() {
            grainCanvas.width = window.innerWidth;
            grainCanvas.height = window.innerHeight;
            const gd = grainCtx.createImageData(grainCanvas.width, grainCanvas.height);
            const gp = gd.data;
            for (let i = 0; i < gp.length; i += 4) {
                const v = Math.random() * 255;
                gp[i] = gp[i+1] = gp[i+2] = v;
                gp[i+3] = 255;
            }
            grainCtx.putImageData(gd, 0, 0);
        }

        // --- Resize ---
        function resize() {
            W = canvas.width = window.innerWidth;
            H = canvas.height = window.innerHeight;
            imageData = ctx.createImageData(W, H);
            pixels = imageData.data;
            renderGrain();
        }

        function getMaxIterations() {
            const logZoom = Math.log2(zoomLevel + 1);
            return Math.min(Math.floor(200 + logZoom * 40), 4000);
        }

        // --- Pixel coloring from iteration ---
        function colorFromIter(iter, maxIter, zr, zi, zr2, zi2, cr, ci, offset) {
            if (iter === maxIter) {
                return [2, 1, 8];
            }

            if (showDistanceEst) {
                // Distance estimation boundary highlight
                var dzr = 1, dzi = 0;
                var tzr = 0, tzi = 0;
                var tzr2 = 0, tzi2 = 0;
                for (var di = 0; di < iter; di++) {
                    var ndz_r = 2 * (tzr * dzr - tzi * dzi) + 1;
                    var ndz_i = 2 * (tzr * dzi + tzi * dzr);
                    dzr = ndz_r;
                    dzi = ndz_i;
                    tzi = 2 * tzr * tzi + ci;
                    tzr = tzr2 - tzi2 + cr;
                    tzr2 = tzr * tzr;
                    tzi2 = tzi * tzi;
                }
                var mag = Math.sqrt(zr2 + zi2);
                var dmag = Math.sqrt(dzr * dzr + dzi * dzi);
                var dist = 2.0 * mag * Math.log(mag) / dmag;
                var radius = INITIAL_RADIUS / zoomLevel;
                var pixelSize = (2 * radius) / H;
                var normalizedDist = dist / pixelSize;
                if (normalizedDist < 2.0) {
                    var edgeBright = 1.0 - normalizedDist / 2.0;
                    edgeBright = edgeBright * edgeBright;
                    return [
                        Math.min(255, 60 + edgeBright * 195),
                        Math.min(255, 180 + edgeBright * 75),
                        Math.min(255, 255)
                    ];
                }
            }

            if (showOrbitTraps) {
                // Orbit trap: find minimum distance to origin, circle r=0.5, and axes
                var minDist = 1e20;
                var otzr = 0, otzi = 0;
                for (var oi = 0; oi < iter; oi++) {
                    var tmp = otzr * otzr - otzi * otzi + cr;
                    otzi = 2 * otzr * otzi + ci;
                    otzr = tmp;
                    // Cross pattern: distance to axes
                    var dX = Math.abs(otzr);
                    var dY = Math.abs(otzi);
                    var dCross = Math.min(dX, dY);
                    // Circle trap radius 0.5
                    var dCircle = Math.abs(Math.sqrt(otzr * otzr + otzi * otzi) - 0.5);
                    var d = Math.min(dCross, dCircle);
                    if (d < minDist) minDist = d;
                }
                var trap = Math.log(minDist + 0.001) * 0.5 + 0.5;
                trap = Math.max(0, Math.min(1, trap));
                var ti2 = Math.floor(((trap * 800 + offset) % PALETTE_SIZE + PALETTE_SIZE) % PALETTE_SIZE);
                return [
                    (palette[ti2 * 3    ] * 255) | 0,
                    (palette[ti2 * 3 + 1] * 255) | 0,
                    (palette[ti2 * 3 + 2] * 255) | 0
                ];
            }

            // Smooth coloring: normalized iteration count with log smoothing
            var logZn = Math.log(zr2 + zi2) * 0.5;
            var logBailout = Math.log(256);
            var log2 = Math.log(2);
            var smooth = iter + 1 - Math.log(logZn / logBailout) / log2;
            var t = (smooth * 3.5 + offset) % PALETTE_SIZE;
            var tidx = Math.floor(t);
            var tf = t - tidx;
            var idx0 = (((tidx % PALETTE_SIZE) + PALETTE_SIZE) % PALETTE_SIZE) * 3;
            var idx1 = ((((tidx + 1) % PALETTE_SIZE) + PALETTE_SIZE) % PALETTE_SIZE) * 3;
            var r = palette[idx0    ] + (palette[idx1    ] - palette[idx0    ]) * tf;
            var g = palette[idx0 + 1] + (palette[idx1 + 1] - palette[idx0 + 1]) * tf;
            var b = palette[idx0 + 2] + (palette[idx1 + 2] - palette[idx0 + 2]) * tf;
            return [(r * 255) | 0, (g * 255) | 0, (b * 255) | 0];
        }

        // --- Main Mandelbrot render ---
        function renderMandelbrot(targetCanvas, targetCtx, rW, rH, cx, cy, radius, maxIter, offset, asJulia, jcr, jci) {
            var imgData = targetCtx.createImageData(rW, rH);
            var pxls = imgData.data;
            var aspectRatio = rW / rH;
            var xMin = cx - radius * aspectRatio;
            var yMin = cy - radius;
            var dx = (2 * radius * aspectRatio) / rW;
            var dy = (2 * radius) / rH;
            var bailout = 256;

            for (var py = 0; py < rH; py++) {
                var pci = yMin + py * dy;
                for (var px = 0; px < rW; px++) {
                    var pcr = xMin + px * dx;
                    var zr, zi, cr, ci;
                    if (asJulia) {
                        zr = pcr; zi = pci;
                        cr = jcr; ci = jci;
                    } else {
                        zr = 0; zi = 0;
                        cr = pcr; ci = pci;
                    }
                    var zr2 = zr * zr, zi2 = zi * zi;
                    var it = 0;
                    while (zr2 + zi2 <= bailout && it < maxIter) {
                        zi = 2 * zr * zi + ci;
                        zr = zr2 - zi2 + cr;
                        zr2 = zr * zr;
                        zi2 = zi * zi;
                        it++;
                    }
                    var pIdx = (py * rW + px) * 4;
                    var col = colorFromIter(it, maxIter, zr, zi, zr2, zi2, cr, ci, offset);
                    pxls[pIdx    ] = col[0];
                    pxls[pIdx + 1] = col[1];
                    pxls[pIdx + 2] = col[2];
                    pxls[pIdx + 3] = 255;
                }
            }
            targetCtx.putImageData(imgData, 0, 0);
        }

        // --- Progressive rendering ---
        let progressiveStage = 0;
        const PROGRESSIVE_SCALES = [0.125, 0.25, 0.5, 1.0];
        let lastRenderParams = null;
        let isAnimating = true;

        function renderProgressive(cx, cy, radius, maxIter, offset, stage) {
            var scale = PROGRESSIVE_SCALES[Math.min(stage, PROGRESSIVE_SCALES.length - 1)];
            var sw = Math.max(1, Math.floor(W * scale));
            var sh = Math.max(1, Math.floor(H * scale));

            var offscreen = document.createElement('canvas');
            offscreen.width = sw;
            offscreen.height = sh;
            var offCtx = offscreen.getContext('2d');

            renderMandelbrot(offscreen, offCtx, sw, sh, cx, cy, radius, maxIter, offset, false, 0, 0);

            canvas.width = W;
            canvas.height = H;
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.drawImage(offscreen, 0, 0, W, H);
        }

        // --- Julia set rendering ---
        const JULIA_SIZE = 200;
        function renderJulia() {
            if (!showJulia) {
                juliaCanvas.classList.add('hidden');
                return;
            }
            juliaCanvas.classList.remove('hidden');
            juliaCanvas.width = JULIA_SIZE;
            juliaCanvas.height = JULIA_SIZE;
            renderMandelbrot(juliaCanvas, juliaCtx, JULIA_SIZE, JULIA_SIZE, 0, 0, 1.8, 200, colorOffset, true, juliaR, juliaI);
        }

        // --- Minimap rendering ---
        function renderMinimap() {
            if (!showMinimap) {
                minimapCanvas.classList.add('hidden');
                return;
            }
            minimapCanvas.classList.remove('hidden');
            var mW = 120, mH = 90;
            minimapCanvas.width = mW;
            minimapCanvas.height = mH;

            // Render full Mandelbrot overview
            renderMandelbrot(minimapCanvas, minimapCtx, mW, mH, -0.5, 0, 1.8, 80, 0, false, 0, 0);

            // Draw current viewport rectangle
            var overviewCx = -0.5, overviewCy = 0, overviewR = 1.8;
            var aspectRatio = mW / mH;
            var radius = INITIAL_RADIUS / zoomLevel;
            // Map viewport center to minimap coordinates
            var viewCxNorm = (target.cx - (overviewCx - overviewR * aspectRatio)) / (2 * overviewR * aspectRatio);
            var viewCyNorm = (target.cy - (overviewCy - overviewR)) / (2 * overviewR);
            var viewWNorm = (2 * radius * (W/H)) / (2 * overviewR * aspectRatio);
            var viewHNorm = (2 * radius) / (2 * overviewR);

            minimapCtx.strokeStyle = 'rgba(100, 200, 255, 0.8)';
            minimapCtx.lineWidth = 1;
            var rx = viewCxNorm * mW - (viewWNorm * mW) / 2;
            var ry = viewCyNorm * mH - (viewHNorm * mH) / 2;
            var rw = viewWNorm * mW;
            var rh = viewHNorm * mH;
            // Clamp to visible
            if (rw > 1 && rh > 1 && rw < mW * 2 && rh < mH * 2) {
                minimapCtx.strokeRect(rx, ry, rw, rh);
            } else {
                // Draw a dot for deep zooms
                minimapCtx.fillStyle = 'rgba(100, 200, 255, 0.9)';
                minimapCtx.beginPath();
                minimapCtx.arc(viewCxNorm * mW, viewCyNorm * mH, 2, 0, Math.PI * 2);
                minimapCtx.fill();
            }
        }

        // --- Info display ---
        function updateInfo() {
            var mag = zoomLevel.toExponential(2);
            var maxIter = getMaxIterations();
            var mode = showOrbitTraps ? 'orbit' : (showDistanceEst ? 'distance' : 'smooth');
            info.innerHTML =
                target.name + '<br>' +
                'zoom: ' + mag + 'x<br>' +
                'iter: ' + maxIter + '<br>' +
                'palette: ' + PALETTE_DEFS[currentPaletteIdx].name + '<br>' +
                'mode: ' + mode;
        }

        function updateCoords() {
            var aspectRatio = W / H;
            var radius = INITIAL_RADIUS / zoomLevel;
            var cr = target.cx + ((mouseX / W) - 0.5) * 2 * radius * aspectRatio;
            var ci = target.cy + ((mouseY / H) - 0.5) * 2 * radius;
            coordsEl.innerHTML =
                'Re: ' + cr.toExponential(8) + '<br>' +
                'Im: ' + ci.toExponential(8);
        }

        // --- Build UI ---
        function buildZoomPresets() {
            var container = document.getElementById('zoom-presets');
            ZOOM_TARGETS.forEach(function(t, i) {
                var btn = document.createElement('button');
                btn.textContent = t.name;
                if (i === 0) btn.classList.add('active');
                btn.addEventListener('click', function() {
                    targetIdx = i;
                    target = { name: t.name, cx: t.cx, cy: t.cy };
                    zoomLevel = 1.0;
                    container.querySelectorAll('button').forEach(function(b) { b.classList.remove('active'); });
                    btn.classList.add('active');
                });
                container.appendChild(btn);
            });
        }

        function buildPaletteBar() {
            var container = document.getElementById('palette-bar');
            PALETTE_DEFS.forEach(function(p, i) {
                var btn = document.createElement('button');
                btn.textContent = p.name;
                if (i === 0) btn.classList.add('active');
                btn.addEventListener('click', function() {
                    currentPaletteIdx = i;
                    buildPalette(i);
                    container.querySelectorAll('button').forEach(function(b) { b.classList.remove('active'); });
                    btn.classList.add('active');
                });
                container.appendChild(btn);
            });
        }

        function setupControls() {
            var btnJulia = document.getElementById('btn-julia');
            var btnOrbit = document.getElementById('btn-orbit');
            var btnDist = document.getElementById('btn-distance');
            var btnCross = document.getElementById('btn-crosshair');
            var btnMini = document.getElementById('btn-minimap');
            var btnSnap = document.getElementById('btn-screenshot');
            var btnPause = document.getElementById('btn-pause');
            var btnReset = document.getElementById('btn-reset');

            btnJulia.addEventListener('click', function() {
                showJulia = !showJulia;
                btnJulia.classList.toggle('active', showJulia);
                if (!showJulia) juliaCanvas.classList.add('hidden');
            });
            btnOrbit.addEventListener('click', function() {
                showOrbitTraps = !showOrbitTraps;
                showDistanceEst = false;
                btnOrbit.classList.toggle('active', showOrbitTraps);
                btnDist.classList.remove('active');
            });
            btnDist.addEventListener('click', function() {
                showDistanceEst = !showDistanceEst;
                showOrbitTraps = false;
                btnDist.classList.toggle('active', showDistanceEst);
                btnOrbit.classList.remove('active');
            });
            btnCross.addEventListener('click', function() {
                showCrosshair = !showCrosshair;
                btnCross.classList.toggle('active', showCrosshair);
                crosshairEl.classList.toggle('hidden', !showCrosshair);
            });
            btnCross.classList.add('active');
            btnMini.addEventListener('click', function() {
                showMinimap = !showMinimap;
                btnMini.classList.toggle('active', showMinimap);
                if (!showMinimap) minimapCanvas.classList.add('hidden');
            });
            btnMini.classList.add('active');
            btnSnap.addEventListener('click', function() {
                canvas.toBlob(function(blob) {
                    if (blob && navigator.clipboard && navigator.clipboard.write) {
                        navigator.clipboard.write([
                            new ClipboardItem({ 'image/png': blob })
                        ]).then(function() {
                            btnSnap.textContent = 'Done!';
                            setTimeout(function() { btnSnap.textContent = 'Snap'; }, 1200);
                        }).catch(function() {
                            // Fallback: download
                            downloadBlob(blob);
                        });
                    } else {
                        downloadBlob(blob);
                    }
                });
            });
            btnPause.addEventListener('click', function() {
                paused = !paused;
                btnPause.classList.toggle('active', paused);
                btnPause.textContent = paused ? 'Play' : 'Pause';
            });
            btnReset.addEventListener('click', function() {
                window.reset();
                btnPause.classList.remove('active');
                btnPause.textContent = 'Pause';
                // Reset zoom preset highlight
                var presetBtns = document.getElementById('zoom-presets').querySelectorAll('button');
                presetBtns.forEach(function(b, i) { b.classList.toggle('active', i === 0); });
            });
        }

        function downloadBlob(blob) {
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'mandelbrot-' + Date.now() + '.png';
            a.click();
            URL.revokeObjectURL(url);
        }

        // --- Animation loop ---
        let lastTime = 0;
        let animId;
        let grainTimer = 0;

        function animate(timestamp) {
            if (!lastTime) lastTime = timestamp;
            var dt = Math.min(timestamp - lastTime, 50);
            lastTime = timestamp;

            if (!paused) {
                isAnimating = true;
                zoomLevel *= (1 + zoomSpeed * (dt / 16.667));
                colorOffset += dt * 0.02;

                if (zoomLevel > MAX_ZOOM) {
                    zoomLevel = 1.0;
                    targetIdx = (targetIdx + 1) % ZOOM_TARGETS.length;
                    target = ZOOM_TARGETS[targetIdx];
                    // Update preset highlight
                    var presetBtns = document.getElementById('zoom-presets').querySelectorAll('button');
                    presetBtns.forEach(function(b, i) { b.classList.toggle('active', i === targetIdx); });
                }

                var maxIter = getMaxIterations();
                var radius = INITIAL_RADIUS / zoomLevel;

                // Dynamic render scale for real-time zooming
                var logZ = Math.log10(zoomLevel + 1);
                var scale;
                if (logZ < 3) scale = 0.5;
                else if (logZ < 6) scale = 0.4;
                else if (logZ < 9) scale = 0.33;
                else scale = 0.25;

                // Reduce resolution more if orbit traps or distance est is on (expensive)
                if (showOrbitTraps || showDistanceEst) scale *= 0.7;

                var sw = Math.max(1, Math.floor(W * scale));
                var sh = Math.max(1, Math.floor(H * scale));

                var offscreen = document.createElement('canvas');
                offscreen.width = sw;
                offscreen.height = sh;
                var offCtx = offscreen.getContext('2d');
                renderMandelbrot(offscreen, offCtx, sw, sh, target.cx, target.cy, radius, maxIter, colorOffset, false, 0, 0);

                canvas.width = W;
                canvas.height = H;
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                ctx.drawImage(offscreen, 0, 0, W, H);

                updateInfo();
                updateCoords();

                // Refresh grain occasionally
                grainTimer += dt;
                if (grainTimer > 200) {
                    grainTimer = 0;
                    renderGrain();
                }
            }

            // Julia + minimap update less frequently
            if (timestamp % 3 < 1.5) {
                renderJulia();
                renderMinimap();
            }

            animId = requestAnimationFrame(animate);
        }

        // --- Click to re-center ---
        canvas.addEventListener('click', function(e) {
            var rect = canvas.getBoundingClientRect();
            var mx = (e.clientX - rect.left) / rect.width;
            var my = (e.clientY - rect.top) / rect.height;
            var aspectRatio = W / H;
            var radius = INITIAL_RADIUS / zoomLevel;
            var cx = target.cx + (mx - 0.5) * 2 * radius * aspectRatio;
            var cy = target.cy + (my - 0.5) * 2 * radius;
            target = { name: 'Custom', cx: cx, cy: cy };
            // Deselect preset buttons
            document.getElementById('zoom-presets').querySelectorAll('button').forEach(function(b) { b.classList.remove('active'); });
        });

        // --- Mouse tracking for Julia + coordinates ---
        canvas.addEventListener('mousemove', function(e) {
            mouseX = e.clientX;
            mouseY = e.clientY;
            var aspectRatio = W / H;
            var radius = INITIAL_RADIUS / zoomLevel;
            juliaR = target.cx + ((mouseX / W) - 0.5) * 2 * radius * aspectRatio;
            juliaI = target.cy + ((mouseY / H) - 0.5) * 2 * radius;
            updateCoords();
        });

        // --- Keyboard ---
        window.addEventListener('keydown', function(e) {
            if (e.code === 'Space') {
                e.preventDefault();
                paused = !paused;
                var btn = document.getElementById('btn-pause');
                btn.classList.toggle('active', paused);
                btn.textContent = paused ? 'Play' : 'Pause';
            }
            if (e.code === 'KeyJ') {
                showJulia = !showJulia;
                document.getElementById('btn-julia').classList.toggle('active', showJulia);
                if (!showJulia) juliaCanvas.classList.add('hidden');
            }
            if (e.code === 'KeyO') {
                showOrbitTraps = !showOrbitTraps;
                showDistanceEst = false;
                document.getElementById('btn-orbit').classList.toggle('active', showOrbitTraps);
                document.getElementById('btn-distance').classList.remove('active');
            }
            if (e.code === 'KeyD') {
                showDistanceEst = !showDistanceEst;
                showOrbitTraps = false;
                document.getElementById('btn-distance').classList.toggle('active', showDistanceEst);
                document.getElementById('btn-orbit').classList.remove('active');
            }
            // Number keys 1-6 for palettes
            var num = parseInt(e.key);
            if (num >= 1 && num <= PALETTE_DEFS.length) {
                currentPaletteIdx = num - 1;
                buildPalette(num - 1);
                document.getElementById('palette-bar').querySelectorAll('button').forEach(function(b, i) {
                    b.classList.toggle('active', i === num - 1);
                });
            }
        });

        // --- Reset ---
        window.reset = function() {
            zoomLevel = 1.0;
            colorOffset = 0;
            paused = false;
            targetIdx = 0;
            target = ZOOM_TARGETS[0];
            lastTime = 0;
            showOrbitTraps = false;
            showDistanceEst = false;
            currentPaletteIdx = 0;
            buildPalette(0);
            document.getElementById('btn-orbit').classList.remove('active');
            document.getElementById('btn-distance').classList.remove('active');
            document.getElementById('palette-bar').querySelectorAll('button').forEach(function(b, i) {
                b.classList.toggle('active', i === 0);
            });
        };

        // --- Handle resize ---
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                resize();
            }, 150);
        });

        // --- Initialize ---
        buildPalette(0);
        resize();
        buildZoomPresets();
        buildPaletteBar();
        setupControls();
        animId = requestAnimationFrame(animate);
    })();
    </script>
    <script src="../assets/js/enhance.js"></script>
</body>
</html>
