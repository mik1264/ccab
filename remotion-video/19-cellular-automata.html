<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cellular Automata - 1D Wolfram & 2D Worlds</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: #0a0a0f;
            overflow: hidden;
            font-family: 'Courier New', monospace;
            color: #c8c8dc;
        }

        canvas {
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
        }

        .vignette {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(ellipse at center, transparent 50%, rgba(0,0,0,0.7) 100%);
            pointer-events: none;
            z-index: 10;
        }

        .scan-line {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 0, 0, 0.03) 2px,
                rgba(0, 0, 0, 0.03) 4px
            );
            pointer-events: none;
            z-index: 11;
        }

        .film-grain {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 12;
            opacity: 0.04;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='1'/%3E%3C/svg%3E");
            background-size: 256px 256px;
        }

        .back-link {
            position: fixed;
            top: 1rem;
            left: 1rem;
            color: rgba(100, 200, 255, 0.6);
            text-decoration: none;
            font-family: monospace;
            font-size: 0.85rem;
            z-index: 30;
            transition: color 0.3s;
        }

        .back-link:hover {
            color: rgba(100, 200, 255, 1);
        }

        /* --- Control Panel --- */
        .control-panel {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 30;
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            max-height: calc(100vh - 2rem);
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(100,200,255,0.3) transparent;
        }

        .control-panel::-webkit-scrollbar { width: 4px; }
        .control-panel::-webkit-scrollbar-track { background: transparent; }
        .control-panel::-webkit-scrollbar-thumb { background: rgba(100,200,255,0.3); border-radius: 2px; }

        .panel-section {
            background: rgba(10, 10, 20, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(100, 200, 255, 0.15);
            border-radius: 8px;
            padding: 0.5rem 0.7rem;
            min-width: 200px;
        }

        .panel-section h4 {
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: rgba(100, 200, 255, 0.5);
            margin-bottom: 0.35rem;
        }

        .panel-row {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin-bottom: 0.25rem;
        }

        .panel-row label {
            font-size: 0.65rem;
            color: rgba(200, 200, 220, 0.7);
            min-width: 55px;
        }

        select, input[type="range"], input[type="number"] {
            background: rgba(20, 20, 40, 0.8);
            border: 1px solid rgba(100, 200, 255, 0.2);
            color: #c8c8dc;
            font-family: 'Courier New', monospace;
            font-size: 0.65rem;
            border-radius: 4px;
            padding: 2px 4px;
            outline: none;
        }

        select { flex: 1; cursor: pointer; }
        select:focus, input:focus { border-color: rgba(100, 200, 255, 0.5); }

        input[type="range"] {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(100, 200, 255, 0.7);
            cursor: pointer;
        }

        input[type="number"] {
            width: 55px;
            text-align: center;
        }

        .btn {
            background: rgba(100, 200, 255, 0.1);
            border: 1px solid rgba(100, 200, 255, 0.25);
            color: rgba(200, 200, 220, 0.8);
            font-family: 'Courier New', monospace;
            font-size: 0.6rem;
            padding: 3px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn:hover {
            background: rgba(100, 200, 255, 0.2);
            border-color: rgba(100, 200, 255, 0.5);
            color: #fff;
        }

        .btn.active {
            background: rgba(100, 200, 255, 0.25);
            border-color: rgba(100, 200, 255, 0.6);
            color: #fff;
        }

        .btn-row {
            display: flex;
            gap: 0.3rem;
            flex-wrap: wrap;
        }

        /* --- Rule Visualization --- */
        .rule-viz {
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 0.3rem;
        }

        .rule-case {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1px;
        }

        .rule-case .input-cells {
            display: flex;
            gap: 0px;
        }

        .rule-case .cell-box {
            width: 6px;
            height: 6px;
            border: 1px solid rgba(100, 200, 255, 0.2);
        }

        .rule-case .cell-box.on {
            background: rgba(100, 200, 255, 0.7);
        }

        .rule-case .output-cell {
            width: 6px;
            height: 6px;
            border: 1px solid rgba(100, 200, 255, 0.2);
            margin-top: 1px;
        }

        .rule-case .output-cell.on {
            background: rgba(255, 180, 80, 0.8);
        }

        /* --- Bottom Overlay --- */
        .info-overlay {
            position: fixed;
            bottom: 2.5rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 25;
            text-align: center;
            pointer-events: none;
        }

        .rule-number {
            font-size: 2.5rem;
            font-weight: bold;
            letter-spacing: 0.3em;
            transition: opacity 0.6s ease, color 0.6s ease;
        }

        .rule-label {
            font-size: 0.7rem;
            letter-spacing: 0.5em;
            text-transform: uppercase;
            margin-top: 0.2rem;
            opacity: 0.5;
            color: rgba(200, 200, 220, 0.6);
        }

        .rule-description {
            font-size: 0.6rem;
            letter-spacing: 0.15em;
            margin-top: 0.35rem;
            opacity: 0.4;
            color: rgba(200, 200, 220, 0.5);
            max-width: 350px;
        }

        .class-badge {
            display: inline-block;
            font-size: 0.55rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            padding: 2px 8px;
            border-radius: 10px;
            margin-top: 0.4rem;
            border: 1px solid rgba(100, 200, 255, 0.3);
            background: rgba(10, 10, 30, 0.6);
        }

        /* --- Population Graph --- */
        .pop-graph {
            position: fixed;
            bottom: 1rem;
            left: 1rem;
            z-index: 25;
            pointer-events: none;
        }

        .pop-graph canvas {
            position: static;
            width: 160px;
            height: 60px;
            border: 1px solid rgba(100, 200, 255, 0.15);
            border-radius: 4px;
            background: rgba(10, 10, 20, 0.7);
        }

        .pop-graph .label {
            font-size: 0.5rem;
            color: rgba(200, 200, 220, 0.4);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 2px;
        }

        /* --- Entropy Display --- */
        .entropy-display {
            position: fixed;
            bottom: 5.5rem;
            left: 1rem;
            z-index: 25;
            pointer-events: none;
            font-size: 0.6rem;
            color: rgba(200, 200, 220, 0.5);
        }

        .entropy-display .value {
            font-size: 1rem;
            font-weight: bold;
            color: rgba(100, 200, 255, 0.7);
        }

        /* Toggle panel visibility */
        .toggle-panel-btn {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 31;
            background: rgba(10, 10, 20, 0.8);
            border: 1px solid rgba(100, 200, 255, 0.25);
            color: rgba(200, 200, 220, 0.8);
            font-family: 'Courier New', monospace;
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            display: none;
        }

        .control-panel.hidden {
            display: none;
        }

        .control-panel.hidden + .toggle-panel-btn {
            display: block;
        }
    </style>
</head>
<body>

<a href="index.html" class="back-link" style="position:fixed;top:1rem;left:1rem;color:rgba(100,200,255,0.6);text-decoration:none;font-family:monospace;font-size:0.85rem;z-index:30;transition:color 0.3s">&#8592; Back to Gallery</a>

<canvas id="canvas"></canvas>
<div class="vignette"></div>
<div class="scan-line"></div>
<div class="film-grain" id="filmGrain"></div>

<!-- Control Panel -->
<div class="control-panel" id="controlPanel">
    <!-- Mode Selection -->
    <div class="panel-section">
        <h4>Mode</h4>
        <div class="btn-row">
            <button class="btn active" id="btn1D" onclick="setMode('1d')">1D Wolfram</button>
            <button class="btn" id="btn2D" onclick="setMode('2d')">2D Automata</button>
        </div>
    </div>

    <!-- 1D Controls -->
    <div class="panel-section" id="controls1D">
        <h4>Wolfram Rule</h4>
        <div class="panel-row">
            <label>Rule #</label>
            <input type="number" id="ruleInput" min="0" max="255" value="30">
            <button class="btn" onclick="applyRule()">Apply</button>
        </div>
        <div class="panel-row">
            <label>Preset</label>
            <select id="rulePreset" onchange="selectPreset(this.value)">
                <option value="">-- Select --</option>
                <option value="30">30 - Chaos</option>
                <option value="90">90 - Sierpinski</option>
                <option value="110">110 - Universal</option>
                <option value="150">150 - Fractal</option>
                <option value="45">45 - Cascades</option>
                <option value="73">73 - Diamonds</option>
                <option value="184">184 - Traffic</option>
                <option value="105">105 - Crystal</option>
                <option value="225">225 - Inverted</option>
                <option value="135">135 - Waves</option>
                <option value="22">22 - Triangles</option>
                <option value="54">54 - Complex</option>
                <option value="60">60 - Sierpinski Alt</option>
                <option value="126">126 - Fractal II</option>
                <option value="182">182 - Mixed</option>
            </select>
        </div>
        <div class="panel-row">
            <label>Init</label>
            <div class="btn-row">
                <button class="btn" onclick="setInitMode('single')">Single</button>
                <button class="btn" onclick="setInitMode('random')">Random</button>
                <button class="btn" onclick="setInitMode('custom')">Custom</button>
            </div>
        </div>
        <div id="ruleVizContainer">
            <h4 style="margin-top:0.3rem">Rule Pattern</h4>
            <div class="rule-viz" id="ruleViz"></div>
        </div>
    </div>

    <!-- 2D Controls -->
    <div class="panel-section" id="controls2D" style="display:none">
        <h4>2D Automaton</h4>
        <div class="panel-row">
            <label>Type</label>
            <select id="automaton2D" onchange="set2DAutomaton(this.value)">
                <option value="life">Game of Life</option>
                <option value="brian">Brian's Brain</option>
                <option value="wireworld">Wireworld</option>
                <option value="langton">Langton's Ant</option>
            </select>
        </div>
        <div class="panel-row">
            <label>Density</label>
            <input type="range" id="density2D" min="5" max="80" value="30">
        </div>
        <div class="btn-row">
            <button class="btn" onclick="randomize2D()">Randomize</button>
            <button class="btn" onclick="clear2D()">Clear</button>
        </div>
    </div>

    <!-- Appearance -->
    <div class="panel-section">
        <h4>Appearance</h4>
        <div class="panel-row">
            <label>Colors</label>
            <select id="colorScheme" onchange="setColorScheme(this.value)">
                <option value="neon">Neon</option>
                <option value="fire">Fire</option>
                <option value="matrix">Matrix</option>
                <option value="ice">Ice Blue</option>
                <option value="synthwave">Synthwave</option>
            </select>
        </div>
        <div class="panel-row">
            <label>Age Color</label>
            <button class="btn active" id="btnAgeColor" onclick="toggleAgeColor()">On</button>
        </div>
        <div class="panel-row">
            <label>Grid</label>
            <button class="btn" id="btnGrid" onclick="toggleGrid()">Off</button>
        </div>
    </div>

    <!-- Speed -->
    <div class="panel-section">
        <h4>Speed</h4>
        <div class="panel-row">
            <label id="speedLabel">5x</label>
            <input type="range" id="speedSlider" min="1" max="30" value="5" oninput="setSpeed(this.value)">
        </div>
        <div class="btn-row">
            <button class="btn" onclick="stepOnce()">Step</button>
            <button class="btn" id="btnScreenshot" onclick="screenshot()">Export</button>
        </div>
    </div>
</div>

<!-- Info Overlay -->
<div class="info-overlay" id="infoOverlay">
    <div class="rule-number" id="ruleNumber">RULE 30</div>
    <div class="rule-label" id="ruleLabel">Wolfram Elementary Cellular Automaton</div>
    <div class="rule-description" id="ruleDesc">Chaotic aperiodic behavior from simple rules</div>
    <div class="class-badge" id="classBadge">Class III - Chaotic</div>
</div>

<!-- Population Graph -->
<div class="pop-graph">
    <div class="label">Population</div>
    <canvas id="popCanvas" width="160" height="60"></canvas>
</div>

<!-- Entropy Display -->
<div class="entropy-display">
    <div>Shannon Entropy</div>
    <div class="value" id="entropyValue">0.000</div>
</div>

<script>
(function () {
    'use strict';

    // --- DOM ---
    var canvas = document.getElementById('canvas');
    var ctx = canvas.getContext('2d');
    var popCanvas = document.getElementById('popCanvas');
    var popCtx = popCanvas.getContext('2d');
    var ruleNumberEl = document.getElementById('ruleNumber');
    var ruleLabelEl = document.getElementById('ruleLabel');
    var ruleDescEl = document.getElementById('ruleDesc');
    var classBadgeEl = document.getElementById('classBadge');
    var entropyEl = document.getElementById('entropyValue');
    var filmGrainEl = document.getElementById('filmGrain');

    // --- State ---
    var mode = '1d'; // '1d' or '2d'
    var automaton2DType = 'life';
    var CELL_SIZE = 3;
    var paused = false;
    var showGrid = false;
    var useAgeColor = true;
    var speedMultiplier = 5;
    var initMode = 'single'; // 'single', 'random', 'custom'
    var customEditing = false;

    // Color schemes: arrays of [hue, saturation, lightness] or functions
    var colorSchemes = {
        neon:      { base: [180, 85, 55], shift: 40 },
        fire:      { base: [15, 90, 50],  shift: 30 },
        matrix:    { base: [120, 85, 45], shift: 15 },
        ice:       { base: [200, 80, 60], shift: 25 },
        synthwave: { base: [280, 85, 55], shift: 60 }
    };
    var currentScheme = 'neon';

    // 1D Wolfram state
    var ruleNum = 30;
    var ruleTable = [];
    var cols, rows;
    var grid1D = [];
    var ageGrid1D = [];
    var currentRow1D = 0;

    // 2D state
    var grid2D = [];
    var grid2DNext = [];
    var age2D = [];
    var cols2D, rows2D;
    var zoomLevel = 1;
    var panX = 0, panY = 0;
    var langtonAnt = { x: 0, y: 0, dir: 0 }; // direction: 0=up 1=right 2=down 3=left

    // Population history
    var popHistory = [];
    var MAX_POP_HISTORY = 160;

    var animId = null;

    // --- Wolfram Rule Classifications ---
    var wolframClasses = {};
    // Class I: Uniformity
    [0,8,32,40,64,96,128,136,160,168,192,224,234,235,238,239,248,249,250,251,252,253,254,255].forEach(function(r) { wolframClasses[r] = 'I'; });
    // Class II: Periodicity
    [1,2,3,4,5,6,7,9,10,11,12,13,14,15,19,23,24,25,27,28,29,33,34,35,36,37,38,42,43,44,46,50,51,56,57,58,62,72,76,77,78,94,104,108,130,132,133,134,140,142,152,154,156,162,164,170,172,176,178,184,200,204,206,232].forEach(function(r) { wolframClasses[r] = 'II'; });
    // Class III: Chaos
    [18,22,30,45,60,73,75,86,89,90,101,102,105,106,109,118,120,121,122,124,126,129,135,146,149,150,151,153,161,169,181,182,183,195].forEach(function(r) { wolframClasses[r] = 'III'; });
    // Class IV: Complexity
    [41,54,106,110].forEach(function(r) { wolframClasses[r] = 'IV'; });

    function getClassLabel(ruleN) {
        var c = wolframClasses[ruleN] || 'II';
        var labels = {
            'I': 'Class I - Uniform',
            'II': 'Class II - Periodic',
            'III': 'Class III - Chaotic',
            'IV': 'Class IV - Complex'
        };
        return labels[c];
    }

    var classColors = {
        'I': 'rgba(120,120,140,0.5)',
        'II': 'rgba(80,180,120,0.5)',
        'III': 'rgba(255,100,80,0.5)',
        'IV': 'rgba(255,200,50,0.5)'
    };

    function getClassColor(ruleN) {
        return classColors[wolframClasses[ruleN] || 'II'];
    }

    // --- Sizing ---
    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        if (mode === '1d') {
            cols = Math.ceil(canvas.width / CELL_SIZE);
            rows = Math.ceil(canvas.height / CELL_SIZE);
            init1DGrid();
        } else {
            cols2D = Math.ceil(canvas.width / (CELL_SIZE * zoomLevel));
            rows2D = Math.ceil(canvas.height / (CELL_SIZE * zoomLevel));
            init2DGrid();
        }
    }

    // --- 1D Wolfram ---
    function computeRuleTable(num) {
        var t = [];
        for (var i = 0; i < 8; i++) {
            t[i] = (num >> i) & 1;
        }
        return t;
    }

    function init1DGrid() {
        grid1D = [];
        ageGrid1D = [];
        for (var r = 0; r < rows; r++) {
            grid1D[r] = new Uint8Array(cols);
            ageGrid1D[r] = new Uint16Array(cols);
        }
        if (initMode === 'single') {
            grid1D[0][Math.floor(cols / 2)] = 1;
            ageGrid1D[0][Math.floor(cols / 2)] = 1;
        } else if (initMode === 'random') {
            for (var c = 0; c < cols; c++) {
                var v = Math.random() < 0.5 ? 1 : 0;
                grid1D[0][c] = v;
                ageGrid1D[0][c] = v;
            }
        }
        // custom: leave blank, user clicks
        currentRow1D = 1;
        popHistory = [];
    }

    function computeRow1D(row) {
        var prevRow = grid1D[row - 1];
        var newRow = grid1D[row];
        var newAge = ageGrid1D[row];
        for (var c = 0; c < cols; c++) {
            var left = c > 0 ? prevRow[c - 1] : prevRow[cols - 1];
            var center = prevRow[c];
            var right = c < cols - 1 ? prevRow[c + 1] : prevRow[0];
            var index = (left << 2) | (center << 1) | right;
            newRow[c] = ruleTable[index];
            if (newRow[c]) {
                newAge[c] = (prevRow[c] ? ageGrid1D[row - 1][c] : 0) + 1;
            } else {
                newAge[c] = 0;
            }
        }
    }

    function scrollGrid1D() {
        for (var r = 0; r < rows - 1; r++) {
            grid1D[r] = grid1D[r + 1];
            ageGrid1D[r] = ageGrid1D[r + 1];
        }
        grid1D[rows - 1] = new Uint8Array(cols);
        ageGrid1D[rows - 1] = new Uint16Array(cols);
        currentRow1D = rows - 1;
        computeRow1D(currentRow1D);
        currentRow1D = rows;
    }

    // --- 2D Automata ---
    function init2DGrid() {
        cols2D = Math.ceil(canvas.width / (CELL_SIZE * zoomLevel));
        rows2D = Math.ceil(canvas.height / (CELL_SIZE * zoomLevel));
        grid2D = [];
        grid2DNext = [];
        age2D = [];
        for (var r = 0; r < rows2D; r++) {
            grid2D[r] = new Int8Array(cols2D); // 0=dead, 1=alive, 2=dying(brian), wireworld: 0=empty,1=head,2=tail,3=conductor
            grid2DNext[r] = new Int8Array(cols2D);
            age2D[r] = new Uint16Array(cols2D);
        }
        if (automaton2DType === 'langton') {
            langtonAnt.x = Math.floor(cols2D / 2);
            langtonAnt.y = Math.floor(rows2D / 2);
            langtonAnt.dir = 0;
            // Grid starts all 0
        }
        popHistory = [];
    }

    function randomize2D() {
        var density = parseInt(document.getElementById('density2D').value) / 100;
        for (var r = 0; r < rows2D; r++) {
            for (var c = 0; c < cols2D; c++) {
                if (automaton2DType === 'wireworld') {
                    grid2D[r][c] = Math.random() < density ? 3 : 0;
                    if (grid2D[r][c] === 3 && Math.random() < 0.05) grid2D[r][c] = 1;
                } else if (automaton2DType === 'langton') {
                    grid2D[r][c] = 0;
                } else {
                    grid2D[r][c] = Math.random() < density ? 1 : 0;
                }
                age2D[r][c] = grid2D[r][c] > 0 ? 1 : 0;
            }
        }
        if (automaton2DType === 'langton') {
            langtonAnt.x = Math.floor(cols2D / 2);
            langtonAnt.y = Math.floor(rows2D / 2);
            langtonAnt.dir = 0;
        }
    }

    function clear2D() {
        for (var r = 0; r < rows2D; r++) {
            for (var c = 0; c < cols2D; c++) {
                grid2D[r][c] = 0;
                age2D[r][c] = 0;
            }
        }
        if (automaton2DType === 'langton') {
            langtonAnt.x = Math.floor(cols2D / 2);
            langtonAnt.y = Math.floor(rows2D / 2);
            langtonAnt.dir = 0;
        }
        popHistory = [];
    }

    function countNeighbors(r, c) {
        var count = 0;
        for (var dr = -1; dr <= 1; dr++) {
            for (var dc = -1; dc <= 1; dc++) {
                if (dr === 0 && dc === 0) continue;
                var nr = (r + dr + rows2D) % rows2D;
                var nc = (c + dc + cols2D) % cols2D;
                if (grid2D[nr][nc] === 1) count++;
            }
        }
        return count;
    }

    function countNeighborsState(r, c, state) {
        var count = 0;
        for (var dr = -1; dr <= 1; dr++) {
            for (var dc = -1; dc <= 1; dc++) {
                if (dr === 0 && dc === 0) continue;
                var nr = (r + dr + rows2D) % rows2D;
                var nc = (c + dc + cols2D) % cols2D;
                if (grid2D[nr][nc] === state) count++;
            }
        }
        return count;
    }

    function step2D() {
        var r, c, n;

        if (automaton2DType === 'life') {
            for (r = 0; r < rows2D; r++) {
                for (c = 0; c < cols2D; c++) {
                    n = countNeighbors(r, c);
                    if (grid2D[r][c] === 1) {
                        grid2DNext[r][c] = (n === 2 || n === 3) ? 1 : 0;
                    } else {
                        grid2DNext[r][c] = (n === 3) ? 1 : 0;
                    }
                }
            }
        } else if (automaton2DType === 'brian') {
            // Brian's Brain: 0=off, 1=on, 2=dying
            for (r = 0; r < rows2D; r++) {
                for (c = 0; c < cols2D; c++) {
                    if (grid2D[r][c] === 1) {
                        grid2DNext[r][c] = 2; // on -> dying
                    } else if (grid2D[r][c] === 2) {
                        grid2DNext[r][c] = 0; // dying -> off
                    } else {
                        n = countNeighborsState(r, c, 1);
                        grid2DNext[r][c] = (n === 2) ? 1 : 0;
                    }
                }
            }
        } else if (automaton2DType === 'wireworld') {
            // Wireworld: 0=empty, 1=electron head, 2=electron tail, 3=conductor
            for (r = 0; r < rows2D; r++) {
                for (c = 0; c < cols2D; c++) {
                    var s = grid2D[r][c];
                    if (s === 0) {
                        grid2DNext[r][c] = 0;
                    } else if (s === 1) {
                        grid2DNext[r][c] = 2; // head -> tail
                    } else if (s === 2) {
                        grid2DNext[r][c] = 3; // tail -> conductor
                    } else {
                        // conductor: become head if 1 or 2 neighbor heads
                        n = countNeighborsState(r, c, 1);
                        grid2DNext[r][c] = (n === 1 || n === 2) ? 1 : 3;
                    }
                }
            }
        } else if (automaton2DType === 'langton') {
            // Langton's Ant: process multiple steps per frame for speed
            var steps = speedMultiplier * 10;
            for (var i = 0; i < steps; i++) {
                var ax = langtonAnt.x;
                var ay = langtonAnt.y;
                if (ay >= 0 && ay < rows2D && ax >= 0 && ax < cols2D) {
                    if (grid2D[ay][ax] === 0) {
                        // White: turn right, flip, move
                        langtonAnt.dir = (langtonAnt.dir + 1) % 4;
                        grid2D[ay][ax] = 1;
                        age2D[ay][ax] = 1;
                    } else {
                        // Black: turn left, flip, move
                        langtonAnt.dir = (langtonAnt.dir + 3) % 4;
                        grid2D[ay][ax] = 0;
                        age2D[ay][ax] = 0;
                    }
                    // Move
                    var dx = [0, 1, 0, -1];
                    var dy = [-1, 0, 1, 0];
                    langtonAnt.x = (langtonAnt.x + dx[langtonAnt.dir] + cols2D) % cols2D;
                    langtonAnt.y = (langtonAnt.y + dy[langtonAnt.dir] + rows2D) % rows2D;
                }
            }
            return; // Skip the grid copy below
        }

        // Copy next -> current and update ages
        for (r = 0; r < rows2D; r++) {
            for (c = 0; c < cols2D; c++) {
                if (grid2DNext[r][c] > 0) {
                    if (grid2D[r][c] > 0) {
                        age2D[r][c]++;
                    } else {
                        age2D[r][c] = 1;
                    }
                } else {
                    age2D[r][c] = 0;
                }
                grid2D[r][c] = grid2DNext[r][c];
            }
        }
    }

    // --- Color Helpers ---
    function getScheme() {
        return colorSchemes[currentScheme];
    }

    function getCellColor1D(age) {
        if (age === 0) return null;
        var scheme = getScheme();
        var ageFactor = Math.min(age / 60, 1);
        var hue, sat, light;

        if (useAgeColor) {
            hue = (scheme.base[0] + ageFactor * scheme.shift) % 360;
            sat = scheme.base[1] + ageFactor * 10;
            light = scheme.base[2] + ageFactor * 20;
        } else {
            hue = scheme.base[0];
            sat = scheme.base[1];
            light = scheme.base[2];
        }
        var alpha = 0.7 + ageFactor * 0.3;
        return { hue: hue, sat: sat, light: light, alpha: alpha };
    }

    function get2DColor(state, age) {
        var scheme = getScheme();
        var ageFactor = Math.min(age / 80, 1);

        if (automaton2DType === 'brian') {
            if (state === 1) {
                // Active: bright
                return { hue: scheme.base[0], sat: 95, light: 65, alpha: 0.95 };
            } else if (state === 2) {
                // Dying: dim warm
                return { hue: (scheme.base[0] + 40) % 360, sat: 60, light: 35, alpha: 0.6 };
            }
            return null;
        }

        if (automaton2DType === 'wireworld') {
            if (state === 1) return { hue: 50, sat: 95, light: 65, alpha: 0.95 }; // head: yellow
            if (state === 2) return { hue: 15, sat: 90, light: 50, alpha: 0.8 };  // tail: orange
            if (state === 3) return { hue: 200, sat: 40, light: 30, alpha: 0.4 };  // conductor: dark blue
            return null;
        }

        if (automaton2DType === 'langton') {
            if (state === 1) {
                var h = useAgeColor ? (scheme.base[0] + ageFactor * scheme.shift) % 360 : scheme.base[0];
                return { hue: h, sat: scheme.base[1], light: scheme.base[2], alpha: 0.8 };
            }
            return null;
        }

        // Game of Life
        if (state <= 0) return null;
        var hue, sat, light;
        if (useAgeColor) {
            hue = (scheme.base[0] + ageFactor * scheme.shift) % 360;
            sat = scheme.base[1] + ageFactor * 10;
            light = scheme.base[2] + ageFactor * 15;
        } else {
            hue = scheme.base[0];
            sat = scheme.base[1];
            light = scheme.base[2];
        }
        var alpha = 0.6 + ageFactor * 0.4;
        return { hue: hue, sat: sat, light: light, alpha: alpha };
    }

    // --- Rule Visualization ---
    function renderRuleViz() {
        var container = document.getElementById('ruleViz');
        container.innerHTML = '';
        for (var i = 7; i >= 0; i--) {
            var caseDiv = document.createElement('div');
            caseDiv.className = 'rule-case';

            var inputDiv = document.createElement('div');
            inputDiv.className = 'input-cells';
            var bits = [(i >> 2) & 1, (i >> 1) & 1, i & 1];
            bits.forEach(function(b) {
                var cellDiv = document.createElement('div');
                cellDiv.className = 'cell-box' + (b ? ' on' : '');
                inputDiv.appendChild(cellDiv);
            });
            caseDiv.appendChild(inputDiv);

            var outputDiv = document.createElement('div');
            outputDiv.className = 'output-cell' + (ruleTable[i] ? ' on' : '');
            caseDiv.appendChild(outputDiv);

            container.appendChild(caseDiv);
        }
    }

    // --- Entropy ---
    function computeEntropy() {
        var counts = {};
        var total = 0;

        if (mode === '1d') {
            var row = Math.min(currentRow1D - 1, rows - 1);
            if (row < 0) return 0;
            for (var c = 0; c < cols; c++) {
                var v = grid1D[row][c];
                counts[v] = (counts[v] || 0) + 1;
                total++;
            }
        } else {
            for (var r = 0; r < rows2D; r++) {
                for (var c2 = 0; c2 < cols2D; c2++) {
                    var v2 = grid2D[r][c2];
                    counts[v2] = (counts[v2] || 0) + 1;
                    total++;
                }
            }
        }

        var entropy = 0;
        for (var k in counts) {
            if (counts[k] > 0) {
                var p = counts[k] / total;
                entropy -= p * Math.log2(p);
            }
        }
        return entropy;
    }

    // --- Population Count ---
    function countPopulation() {
        var count = 0;
        if (mode === '1d') {
            var row = Math.min(currentRow1D - 1, rows - 1);
            if (row < 0) return 0;
            for (var c = 0; c < cols; c++) {
                if (grid1D[row][c]) count++;
            }
        } else {
            for (var r = 0; r < rows2D; r++) {
                for (var c2 = 0; c2 < cols2D; c2++) {
                    if (grid2D[r][c2] > 0) count++;
                }
            }
        }
        return count;
    }

    function updatePopGraph() {
        var pop = countPopulation();
        popHistory.push(pop);
        if (popHistory.length > MAX_POP_HISTORY) popHistory.shift();

        var w = popCanvas.width;
        var h = popCanvas.height;
        popCtx.clearRect(0, 0, w, h);
        popCtx.fillStyle = 'rgba(10, 10, 20, 0.9)';
        popCtx.fillRect(0, 0, w, h);

        if (popHistory.length < 2) return;

        var maxPop = 1;
        for (var i = 0; i < popHistory.length; i++) {
            if (popHistory[i] > maxPop) maxPop = popHistory[i];
        }

        var scheme = getScheme();
        popCtx.strokeStyle = 'hsla(' + scheme.base[0] + ', 80%, 60%, 0.8)';
        popCtx.lineWidth = 1;
        popCtx.beginPath();
        for (var j = 0; j < popHistory.length; j++) {
            var x = (j / (MAX_POP_HISTORY - 1)) * w;
            var y = h - (popHistory[j] / maxPop) * (h - 4) - 2;
            if (j === 0) popCtx.moveTo(x, y);
            else popCtx.lineTo(x, y);
        }
        popCtx.stroke();

        // Fill under the curve
        popCtx.lineTo((popHistory.length - 1) / (MAX_POP_HISTORY - 1) * w, h);
        popCtx.lineTo(0, h);
        popCtx.closePath();
        popCtx.fillStyle = 'hsla(' + scheme.base[0] + ', 80%, 60%, 0.1)';
        popCtx.fill();
    }

    // --- Main Render ---
    var frameCount = 0;

    function render() {
        frameCount++;

        if (!paused) {
            if (mode === '1d') {
                var rowsPerFrame = speedMultiplier;
                for (var i = 0; i < rowsPerFrame; i++) {
                    if (currentRow1D < rows) {
                        computeRow1D(currentRow1D);
                        currentRow1D++;
                    } else {
                        scrollGrid1D();
                    }
                }
            } else {
                if (automaton2DType !== 'langton') {
                    for (var s = 0; s < speedMultiplier; s++) {
                        step2D();
                    }
                } else {
                    step2D(); // Langton already does multiple internal steps
                }
            }
        }

        // Update stats every 10 frames
        if (frameCount % 10 === 0) {
            var ent = computeEntropy();
            entropyEl.textContent = ent.toFixed(3);
            updatePopGraph();
        }

        // Clear
        ctx.fillStyle = '#0a0a0f';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        if (mode === '1d') {
            render1D();
        } else {
            render2D();
        }

        // Animate film grain
        if (frameCount % 3 === 0) {
            filmGrainEl.style.transform = 'translate(' + (Math.random() * 10 - 5) + 'px,' + (Math.random() * 10 - 5) + 'px)';
        }

        animId = requestAnimationFrame(render);
    }

    function render1D() {
        var scheme = getScheme();

        for (var r = 0; r < Math.min(currentRow1D, rows); r++) {
            for (var c = 0; c < cols; c++) {
                var age = ageGrid1D[r][c];
                if (age === 0) continue;

                var color = getCellColor1D(age);
                if (!color) continue;

                var x = c * CELL_SIZE;
                var y = r * CELL_SIZE;

                ctx.globalAlpha = color.alpha;
                ctx.fillStyle = 'hsl(' + color.hue + ',' + color.sat + '%,' + color.light + '%)';
                ctx.fillRect(x, y, CELL_SIZE, CELL_SIZE);

                // Glow for young cells
                if (age < 15) {
                    var glowIntensity = (1 - age / 15) * 0.3;
                    ctx.globalAlpha = glowIntensity;
                    ctx.fillStyle = 'hsl(' + color.hue + ',100%,80%)';
                    ctx.fillRect(x - 1, y - 1, CELL_SIZE + 2, CELL_SIZE + 2);
                }
            }
        }
        ctx.globalAlpha = 1;

        // Generation line glow
        if (currentRow1D > 0 && currentRow1D <= rows) {
            var genY = (currentRow1D - 1) * CELL_SIZE;
            var gradient = ctx.createLinearGradient(0, genY - 4, 0, genY + CELL_SIZE + 4);
            gradient.addColorStop(0, 'transparent');
            gradient.addColorStop(0.3, 'hsla(' + scheme.base[0] + ',100%,70%,0.08)');
            gradient.addColorStop(0.7, 'hsla(' + scheme.base[0] + ',100%,70%,0.08)');
            gradient.addColorStop(1, 'transparent');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, genY - 4, canvas.width, CELL_SIZE + 8);
        }

        // Grid lines
        if (showGrid) {
            ctx.strokeStyle = 'rgba(100,200,255,0.07)';
            ctx.lineWidth = 0.5;
            for (var gc = 0; gc <= cols; gc++) {
                ctx.beginPath();
                ctx.moveTo(gc * CELL_SIZE, 0);
                ctx.lineTo(gc * CELL_SIZE, canvas.height);
                ctx.stroke();
            }
            for (var gr = 0; gr <= rows; gr++) {
                ctx.beginPath();
                ctx.moveTo(0, gr * CELL_SIZE);
                ctx.lineTo(canvas.width, gr * CELL_SIZE);
                ctx.stroke();
            }
        }

        // Update overlay
        var ruleColor = 'hsla(' + scheme.base[0] + ',80%,65%,0.8)';
        ruleNumberEl.style.color = ruleColor;
        ruleNumberEl.style.textShadow = '0 0 20px hsla(' + scheme.base[0] + ',100%,60%,0.4), 0 0 40px hsla(' + scheme.base[0] + ',100%,50%,0.2)';
    }

    function render2D() {
        var cellW = CELL_SIZE * zoomLevel;
        var cellH = CELL_SIZE * zoomLevel;

        ctx.save();
        ctx.translate(panX, panY);

        for (var r = 0; r < rows2D; r++) {
            for (var c = 0; c < cols2D; c++) {
                var state = grid2D[r][c];
                var age = age2D[r][c];
                var color = get2DColor(state, age);
                if (!color) continue;

                var x = c * cellW;
                var y = r * cellH;

                ctx.globalAlpha = color.alpha;
                ctx.fillStyle = 'hsl(' + color.hue + ',' + color.sat + '%,' + color.light + '%)';
                ctx.fillRect(x, y, cellW, cellH);

                // Glow for young/active cells
                if (age < 8 && state === 1) {
                    ctx.globalAlpha = (1 - age / 8) * 0.25;
                    ctx.fillStyle = 'hsl(' + color.hue + ',100%,80%)';
                    ctx.fillRect(x - 1, y - 1, cellW + 2, cellH + 2);
                }
            }
        }

        // Draw Langton's ant marker
        if (automaton2DType === 'langton') {
            ctx.globalAlpha = 0.9;
            ctx.fillStyle = '#ff3366';
            var ax = langtonAnt.x * cellW;
            var ay = langtonAnt.y * cellH;
            ctx.fillRect(ax, ay, cellW, cellH);
            // Direction arrow glow
            ctx.globalAlpha = 0.5;
            ctx.fillStyle = '#ff3366';
            ctx.fillRect(ax - 2, ay - 2, cellW + 4, cellH + 4);
        }

        ctx.globalAlpha = 1;

        // Grid lines
        if (showGrid) {
            ctx.strokeStyle = 'rgba(100,200,255,0.07)';
            ctx.lineWidth = 0.5;
            for (var gc = 0; gc <= cols2D; gc++) {
                ctx.beginPath();
                ctx.moveTo(gc * cellW, 0);
                ctx.lineTo(gc * cellW, rows2D * cellH);
                ctx.stroke();
            }
            for (var gr = 0; gr <= rows2D; gr++) {
                ctx.beginPath();
                ctx.moveTo(0, gr * cellH);
                ctx.lineTo(cols2D * cellW, gr * cellH);
                ctx.stroke();
            }
        }

        ctx.restore();

        // Update overlay text for 2D
        var scheme = getScheme();
        var ruleColor = 'hsla(' + scheme.base[0] + ',80%,65%,0.8)';
        ruleNumberEl.style.color = ruleColor;
        ruleNumberEl.style.textShadow = '0 0 20px hsla(' + scheme.base[0] + ',100%,60%,0.4), 0 0 40px hsla(' + scheme.base[0] + ',100%,50%,0.2)';
    }

    // --- UI Control Functions ---
    window.setMode = function(m) {
        mode = m;
        document.getElementById('btn1D').classList.toggle('active', m === '1d');
        document.getElementById('btn2D').classList.toggle('active', m === '2d');
        document.getElementById('controls1D').style.display = m === '1d' ? '' : 'none';
        document.getElementById('controls2D').style.display = m === '2d' ? '' : 'none';

        if (m === '1d') {
            ruleNumberEl.textContent = 'RULE ' + ruleNum;
            ruleLabelEl.textContent = 'Wolfram Elementary Cellular Automaton';
            classBadgeEl.textContent = getClassLabel(ruleNum);
            classBadgeEl.style.borderColor = getClassColor(ruleNum);
            cols = Math.ceil(canvas.width / CELL_SIZE);
            rows = Math.ceil(canvas.height / CELL_SIZE);
            init1DGrid();
        } else {
            set2DAutomaton(automaton2DType);
            cols2D = Math.ceil(canvas.width / (CELL_SIZE * zoomLevel));
            rows2D = Math.ceil(canvas.height / (CELL_SIZE * zoomLevel));
            init2DGrid();
            randomize2D();
        }
    };

    window.applyRule = function() {
        var val = parseInt(document.getElementById('ruleInput').value);
        if (isNaN(val) || val < 0 || val > 255) return;
        ruleNum = val;
        ruleTable = computeRuleTable(ruleNum);
        ruleNumberEl.textContent = 'RULE ' + ruleNum;
        classBadgeEl.textContent = getClassLabel(ruleNum);
        classBadgeEl.style.borderColor = getClassColor(ruleNum);
        renderRuleViz();
        init1DGrid();
    };

    window.selectPreset = function(val) {
        if (!val) return;
        document.getElementById('ruleInput').value = val;
        applyRule();
        // Set desc
        var descs = {
            '30': 'Chaotic aperiodic behavior from simple rules',
            '90': 'Sierpinski triangle fractal pattern',
            '110': 'Computationally universal complexity',
            '150': 'Nested triangular fractal structures',
            '45': 'Complex triangular fractal cascades',
            '73': 'Nested diamond-like formations',
            '184': 'Traffic flow model with diagonal waves',
            '105': 'Symmetric crystalline growth patterns',
            '225': 'Inverted fractal nesting',
            '135': 'Complex wave-like interference',
            '22': 'Complex triangular patterns',
            '54': 'Genuinely complex behavior',
            '60': 'Alternative Sierpinski triangle',
            '126': 'Nested fractal structures',
            '182': 'Mixed periodic-chaotic patterns'
        };
        ruleDescEl.textContent = descs[val] || '';
    };

    window.setInitMode = function(m) {
        initMode = m;
        customEditing = (m === 'custom');
        init1DGrid();
    };

    window.set2DAutomaton = function(type) {
        automaton2DType = type;
        var names = {
            'life': "GAME OF LIFE",
            'brian': "BRIAN'S BRAIN",
            'wireworld': "WIREWORLD",
            'langton': "LANGTON'S ANT"
        };
        var descs = {
            'life': 'Birth 3, Survive 2-3 - emergent complexity from simple rules',
            'brian': 'Three-state automaton with self-organizing oscillators',
            'wireworld': 'Electronic circuit simulation with electron heads and tails',
            'langton': 'Turing-complete ant creating emergent highways'
        };
        ruleNumberEl.textContent = names[type] || type.toUpperCase();
        ruleLabelEl.textContent = '2D Cellular Automaton';
        ruleDescEl.textContent = descs[type] || '';
        classBadgeEl.textContent = 'Class IV - Complex';
        classBadgeEl.style.borderColor = classColors['IV'];
    };

    window.randomize2D = randomize2D;
    window.clear2D = clear2D;

    window.setColorScheme = function(scheme) {
        currentScheme = scheme;
    };

    window.toggleAgeColor = function() {
        useAgeColor = !useAgeColor;
        document.getElementById('btnAgeColor').classList.toggle('active', useAgeColor);
        document.getElementById('btnAgeColor').textContent = useAgeColor ? 'On' : 'Off';
    };

    window.toggleGrid = function() {
        showGrid = !showGrid;
        document.getElementById('btnGrid').classList.toggle('active', showGrid);
        document.getElementById('btnGrid').textContent = showGrid ? 'On' : 'Off';
    };

    window.setSpeed = function(val) {
        speedMultiplier = parseInt(val);
        document.getElementById('speedLabel').textContent = val + 'x';
    };

    window.stepOnce = function() {
        paused = true;
        if (mode === '1d') {
            if (currentRow1D < rows) {
                computeRow1D(currentRow1D);
                currentRow1D++;
            } else {
                scrollGrid1D();
            }
        } else {
            step2D();
        }
    };

    window.screenshot = function() {
        try {
            canvas.toBlob(function(blob) {
                if (!blob) return;
                var item = new ClipboardItem({ 'image/png': blob });
                navigator.clipboard.write([item]).then(function() {
                    showToast('Copied to clipboard');
                }).catch(function() {
                    // Fallback: download
                    var url = URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = 'cellular-automata-' + Date.now() + '.png';
                    a.click();
                    URL.revokeObjectURL(url);
                    showToast('Downloaded screenshot');
                });
            });
        } catch (e) {
            showToast('Export failed');
        }
    };

    function showToast(msg) {
        var toast = document.createElement('div');
        toast.textContent = msg;
        toast.style.cssText = 'position:fixed;bottom:8rem;left:50%;transform:translateX(-50%);background:rgba(10,10,30,0.9);color:#c8c8dc;padding:8px 16px;border-radius:6px;font-size:0.7rem;z-index:40;border:1px solid rgba(100,200,255,0.3);pointer-events:none;opacity:0;transition:opacity 0.3s;';
        document.body.appendChild(toast);
        requestAnimationFrame(function() {
            toast.style.opacity = '1';
            setTimeout(function() {
                toast.style.opacity = '0';
                setTimeout(function() { toast.remove(); }, 300);
            }, 1500);
        });
    }

    // --- Canvas Click ---
    canvas.addEventListener('click', function(e) {
        if (e.clientX < 150 && e.clientY < 50) return; // Back link area

        if (mode === '1d' && customEditing) {
            var col = Math.floor(e.clientX / CELL_SIZE);
            if (col >= 0 && col < cols) {
                grid1D[0][col] = grid1D[0][col] ? 0 : 1;
                ageGrid1D[0][col] = grid1D[0][col] ? 1 : 0;
            }
            return;
        }

        if (mode === '2d') {
            var cellW = CELL_SIZE * zoomLevel;
            var cellH = CELL_SIZE * zoomLevel;
            var col2 = Math.floor((e.clientX - panX) / cellW);
            var row2 = Math.floor((e.clientY - panY) / cellH);
            if (row2 >= 0 && row2 < rows2D && col2 >= 0 && col2 < cols2D) {
                if (automaton2DType === 'wireworld') {
                    // Cycle through states: 0 -> 3 -> 1 -> 2 -> 0
                    var s = grid2D[row2][col2];
                    grid2D[row2][col2] = s === 0 ? 3 : s === 3 ? 1 : s === 1 ? 2 : 0;
                } else {
                    grid2D[row2][col2] = grid2D[row2][col2] ? 0 : 1;
                }
                age2D[row2][col2] = grid2D[row2][col2] > 0 ? 1 : 0;
            }
        }
    });

    // --- Mouse Wheel Zoom (2D mode) ---
    canvas.addEventListener('wheel', function(e) {
        if (mode !== '2d') return;
        e.preventDefault();

        var oldZoom = zoomLevel;
        if (e.deltaY < 0) {
            zoomLevel = Math.min(zoomLevel * 1.15, 8);
        } else {
            zoomLevel = Math.max(zoomLevel / 1.15, 0.3);
        }

        // Zoom toward mouse position
        var mx = e.clientX;
        var my = e.clientY;
        panX = mx - (mx - panX) * (zoomLevel / oldZoom);
        panY = my - (my - panY) * (zoomLevel / oldZoom);
    }, { passive: false });

    // --- Pan (drag) for 2D ---
    var dragging = false;
    var dragStartX = 0, dragStartY = 0;
    var dragPanStartX = 0, dragPanStartY = 0;

    canvas.addEventListener('mousedown', function(e) {
        if (mode !== '2d') return;
        if (e.button === 2 || e.shiftKey) {
            dragging = true;
            dragStartX = e.clientX;
            dragStartY = e.clientY;
            dragPanStartX = panX;
            dragPanStartY = panY;
            e.preventDefault();
        }
    });

    window.addEventListener('mousemove', function(e) {
        if (!dragging) return;
        panX = dragPanStartX + (e.clientX - dragStartX);
        panY = dragPanStartY + (e.clientY - dragStartY);
    });

    window.addEventListener('mouseup', function() {
        dragging = false;
    });

    canvas.addEventListener('contextmenu', function(e) {
        if (mode === '2d') e.preventDefault();
    });

    // --- Keyboard ---
    window.addEventListener('keydown', function(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;

        if (e.key === 'g' || e.key === 'G') {
            toggleGrid();
        }
    });

    // --- Reset ---
    function reset() {
        paused = false;
        ruleNum = 30;
        ruleTable = computeRuleTable(30);
        document.getElementById('ruleInput').value = '30';
        ruleNumberEl.textContent = 'RULE 30';
        ruleDescEl.textContent = 'Chaotic aperiodic behavior from simple rules';
        classBadgeEl.textContent = getClassLabel(30);
        classBadgeEl.style.borderColor = getClassColor(30);
        currentScheme = 'neon';
        document.getElementById('colorScheme').value = 'neon';
        useAgeColor = true;
        document.getElementById('btnAgeColor').classList.add('active');
        document.getElementById('btnAgeColor').textContent = 'On';
        showGrid = false;
        document.getElementById('btnGrid').classList.remove('active');
        document.getElementById('btnGrid').textContent = 'Off';
        speedMultiplier = 5;
        document.getElementById('speedSlider').value = 5;
        document.getElementById('speedLabel').textContent = '5x';
        initMode = 'single';
        customEditing = false;
        zoomLevel = 1;
        panX = 0;
        panY = 0;
        mode = '1d';
        document.getElementById('btn1D').classList.add('active');
        document.getElementById('btn2D').classList.remove('active');
        document.getElementById('controls1D').style.display = '';
        document.getElementById('controls2D').style.display = 'none';
        ruleLabelEl.textContent = 'Wolfram Elementary Cellular Automaton';
        popHistory = [];
        renderRuleViz();
        resize();
    }
    window.reset = reset;

    // --- Handle resize ---
    var resizeTimeout;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(resize, 200);
    });

    // --- Init ---
    ruleTable = computeRuleTable(ruleNum);
    resize();
    renderRuleViz();
    classBadgeEl.textContent = getClassLabel(ruleNum);
    classBadgeEl.style.borderColor = getClassColor(ruleNum);
    animId = requestAnimationFrame(render);

})();
</script>
<script src="../assets/js/enhance.js"></script>
</body>
</html>
