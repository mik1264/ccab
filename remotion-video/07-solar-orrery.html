<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Solar System Orrery</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body {
    width: 100%; height: 100%;
    overflow: hidden;
    background: #060810;
    font-family: monospace;
    color: rgba(200, 220, 255, 0.8);
  }
  canvas { display: block; }

  /* SVG film grain filter */
  .svg-filters {
    position: absolute; width: 0; height: 0; overflow: hidden;
  }

  /* Scanline overlay */
  .scanlines {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: repeating-linear-gradient(
      to bottom,
      transparent 0px,
      transparent 2px,
      rgba(0, 0, 0, 0.06) 2px,
      rgba(0, 0, 0, 0.06) 4px
    );
    pointer-events: none; z-index: 6;
  }

  /* Film grain overlay */
  .film-grain {
    position: fixed; top: -50%; left: -50%; width: 200%; height: 200%;
    pointer-events: none; z-index: 7;
    opacity: 0.035;
    filter: url(#grain);
    animation: grainShift 0.5s steps(6) infinite;
  }
  @keyframes grainShift {
    0%   { transform: translate(0, 0); }
    20%  { transform: translate(-2%, -3%); }
    40%  { transform: translate(3%, 1%); }
    60%  { transform: translate(-1%, 3%); }
    80%  { transform: translate(2%, -2%); }
    100% { transform: translate(0, 0); }
  }

  /* Vignette overlay */
  .vignette {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: radial-gradient(ellipse at center, transparent 40%, rgba(0,0,0,0.6) 100%);
    pointer-events: none; z-index: 5;
  }

  /* Back link */
  .back-link {
    position: fixed; top: 1rem; left: 1rem;
    color: rgba(100, 200, 255, 0.6);
    text-decoration: none;
    font-family: monospace; font-size: 0.85rem;
    z-index: 20; transition: color 0.3s;
  }
  .back-link:hover { color: rgba(100, 200, 255, 1); }

  /* Title overlay */
  .title-overlay {
    position: fixed; top: 1.5rem; left: 50%; transform: translateX(-50%);
    font-size: 1.1rem; letter-spacing: 0.3em; text-transform: uppercase;
    color: rgba(160, 200, 255, 0.5);
    text-shadow: 0 0 20px rgba(100, 150, 255, 0.3);
    z-index: 15; pointer-events: none;
    white-space: nowrap;
  }

  /* Controls panel */
  .controls {
    position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%);
    display: flex; gap: 1.2rem; align-items: center;
    background: rgba(10, 15, 30, 0.7);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(100, 150, 255, 0.15);
    border-radius: 12px;
    padding: 0.6rem 1.4rem;
    z-index: 15;
    font-size: 0.75rem;
    flex-wrap: wrap;
    justify-content: center;
    max-width: 95vw;
  }
  .controls label {
    display: flex; align-items: center; gap: 0.4rem;
    color: rgba(160, 200, 255, 0.6);
    white-space: nowrap;
  }
  .controls input[type="range"] {
    width: 80px; cursor: pointer;
    accent-color: rgba(100, 180, 255, 0.7);
  }
  .controls button {
    background: rgba(100, 150, 255, 0.15);
    border: 1px solid rgba(100, 150, 255, 0.3);
    color: rgba(160, 200, 255, 0.8);
    padding: 0.3rem 0.7rem;
    border-radius: 6px;
    cursor: pointer;
    font-family: monospace; font-size: 0.7rem;
    transition: background 0.3s;
  }
  .controls button:hover { background: rgba(100, 150, 255, 0.3); }
  .controls .speed-val {
    color: rgba(100, 200, 255, 0.7);
    font-size: 0.65rem;
    min-width: 2.5em;
    text-align: right;
  }

  /* Info panel */
  .info-panel {
    position: fixed; top: 4rem; right: 1.2rem;
    background: rgba(10, 15, 30, 0.6);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(100, 150, 255, 0.12);
    border-radius: 10px;
    padding: 0.8rem 1rem;
    z-index: 15;
    font-size: 0.65rem;
    line-height: 1.6;
    color: rgba(160, 200, 255, 0.5);
    max-width: 170px;
    transition: opacity 0.4s;
  }
  .info-panel .planet-row {
    display: flex; align-items: center; gap: 0.4rem;
    padding: 0.15rem 0;
  }
  .info-panel .planet-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .info-panel .planet-name { flex: 1; }
  .info-panel .planet-period { text-align: right; opacity: 0.6; }

  /* Hover tooltip */
  .tooltip {
    position: fixed;
    background: rgba(10, 15, 30, 0.85);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(100, 150, 255, 0.25);
    border-radius: 8px;
    padding: 0.5rem 0.7rem;
    font-size: 0.7rem;
    color: rgba(200, 220, 255, 0.9);
    pointer-events: none;
    z-index: 25;
    opacity: 0;
    transition: opacity 0.2s;
    white-space: nowrap;
  }

  /* Zoom hint */
  .zoom-hint {
    position: fixed; bottom: 4.5rem; left: 50%; transform: translateX(-50%);
    font-size: 0.6rem;
    color: rgba(160, 200, 255, 0.25);
    z-index: 15; pointer-events: none;
    white-space: nowrap;
  }
</style>
</head>
<body>

<!-- SVG filters for film grain -->
<svg class="svg-filters">
  <defs>
    <filter id="grain">
      <feTurbulence type="fractalNoise" baseFrequency="0.65" numOctaves="3" stitchTiles="stitch" />
      <feColorMatrix type="saturate" values="0" />
    </filter>
  </defs>
</svg>

<canvas id="orrery"></canvas>
<div class="scanlines"></div>
<div class="film-grain"></div>
<div class="vignette"></div>

<a href="index.html" class="back-link">&larr; Back to Gallery</a>
<div class="title-overlay">Solar System Orrery</div>

<div class="info-panel" id="infoPanel"></div>

<div class="controls">
  <label>Speed <input type="range" id="speedSlider" min="0.1" max="10" step="0.1" value="3"><span class="speed-val" id="speedVal">3.0x</span></label>
  <label>Trails <input type="range" id="trailSlider" min="0" max="1" step="0.01" value="0.6"></label>
  <label><input type="checkbox" id="labelsToggle" checked> Labels</label>
  <button id="toggleOrbits">Orbits: ON</button>
  <button id="resetBtn">Reset</button>
</div>

<div class="zoom-hint">Scroll to zoom &middot; Drag to pan</div>

<div class="tooltip" id="tooltip"></div>

<script>
(function() {
  'use strict';

  // === PLANET DATA (accurate orbital periods in Earth days, distances in AU) ===
  const PLANETS = [
    { name: 'Mercury', period: 87.97,    dist: 0.387, radius: 2439.7,  color: '#B0A090', glowColor: 'rgba(176,160,144,0.4)' },
    { name: 'Venus',   period: 224.70,   dist: 0.723, radius: 6051.8,  color: '#E8C87A', glowColor: 'rgba(232,200,122,0.4)' },
    { name: 'Earth',   period: 365.26,   dist: 1.000, radius: 6371.0,  color: '#5599DD', glowColor: 'rgba(85,153,221,0.5)' },
    { name: 'Mars',    period: 686.98,   dist: 1.524, radius: 3389.5,  color: '#CC6644', glowColor: 'rgba(204,102,68,0.4)' },
    { name: 'Jupiter', period: 4332.82,  dist: 5.203, radius: 69911,   color: '#D4A56A', glowColor: 'rgba(212,165,106,0.4)' },
    { name: 'Saturn',  period: 10755.70, dist: 9.537, radius: 58232,   color: '#E8D5A0', glowColor: 'rgba(232,213,160,0.4)' },
    { name: 'Uranus',  period: 30687.15, dist: 19.19, radius: 25362,   color: '#88CCDD', glowColor: 'rgba(136,204,221,0.4)' },
    { name: 'Neptune', period: 60190.03, dist: 30.07, radius: 24622,   color: '#4466CC', glowColor: 'rgba(68,102,204,0.5)' }
  ];

  // Visual radii (not to scale - adjusted for aesthetics)
  const VISUAL_RADII = [3, 4.5, 5, 4, 12, 10, 7.5, 7];

  // === GALILEAN MOONS OF JUPITER ===
  const GALILEAN_MOONS = [
    { name: 'Io',       period: 1.77,  dist: 18, color: '#E8D060', size: 1.5 },
    { name: 'Europa',   period: 3.55,  dist: 23, color: '#C8C0B0', size: 1.3 },
    { name: 'Ganymede', period: 7.15,  dist: 29, color: '#A09880', size: 2.0 },
    { name: 'Callisto', period: 16.69, dist: 36, color: '#706860', size: 1.8 }
  ];

  // === ASTEROID BELT ===
  const NUM_ASTEROIDS = 400;
  const asteroids = [];
  for (let i = 0; i < NUM_ASTEROIDS; i++) {
    // Asteroid belt between Mars (1.524 AU) and Jupiter (5.203 AU), roughly 2.1-3.3 AU
    const dist = 2.1 + Math.random() * 1.2;
    const angle = Math.random() * Math.PI * 2;
    const speed = 0.5 + Math.random() * 0.3; // relative speed variation
    const size = Math.random() * 1.2 + 0.3;
    const brightness = Math.random() * 0.3 + 0.1;
    const wobble = (Math.random() - 0.5) * 0.02; // slight orbital eccentricity
    asteroids.push({ dist, angle, speed, size, brightness, wobble, phase: Math.random() * Math.PI * 2 });
  }

  // === COMET ===
  const COMET = {
    semiMajor: 18,        // AU - semi-major axis
    eccentricity: 0.92,   // highly elliptical
    period: 7600,          // days (~20.8 years)
    inclination: 0.15,     // slight tilt for visual interest
    tailMaxLength: 60,     // max tail length in pixels
    phase: 0,              // starting orbital phase
    trailHistory: []
  };
  const COMET_TRAIL_LENGTH = 80;

  // === CANVAS SETUP ===
  const canvas = document.getElementById('orrery');
  const ctx = canvas.getContext('2d');
  let W, H, cx, cy, baseScale;

  // === ZOOM AND PAN STATE ===
  let zoomLevel = 1;
  let panX = 0, panY = 0;
  let isDragging = false;
  let dragStartX = 0, dragStartY = 0;
  let panStartX = 0, panStartY = 0;

  function getScale() {
    return baseScale * zoomLevel;
  }

  function getCenterX() {
    return W / 2 + panX;
  }

  function getCenterY() {
    return H / 2 + panY;
  }

  function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
    // Scale so Neptune fits with padding
    baseScale = Math.min(W, H) * 0.42 / 30.07;
  }
  resize();
  window.addEventListener('resize', resize);

  // === STATE ===
  let time = 0;
  let paused = false;
  let speedMultiplier = 3;
  let trailOpacity = 0.6;
  let showOrbits = true;
  let showLabels = true;
  let hoveredPlanet = null;

  // Trail history: store last N positions for each planet
  const TRAIL_LENGTH = 120;
  const trails = PLANETS.map(() => []);

  // Star field
  const NUM_STARS = 700;
  const stars = [];
  for (let i = 0; i < NUM_STARS; i++) {
    stars.push({
      x: Math.random() * 2 - 1,
      y: Math.random() * 2 - 1,
      size: Math.random() * 1.5 + 0.3,
      brightness: Math.random() * 0.6 + 0.2,
      twinkleSpeed: Math.random() * 0.003 + 0.001,
      twinklePhase: Math.random() * Math.PI * 2
    });
  }

  // === CONTROLS ===
  const speedSlider = document.getElementById('speedSlider');
  const speedVal = document.getElementById('speedVal');
  const trailSlider = document.getElementById('trailSlider');
  const labelsToggle = document.getElementById('labelsToggle');
  const toggleOrbitsBtn = document.getElementById('toggleOrbits');
  const resetBtn = document.getElementById('resetBtn');
  const tooltip = document.getElementById('tooltip');
  const infoPanel = document.getElementById('infoPanel');

  speedSlider.addEventListener('input', () => {
    speedMultiplier = parseFloat(speedSlider.value);
    speedVal.textContent = speedMultiplier.toFixed(1) + 'x';
  });
  trailSlider.addEventListener('input', () => { trailOpacity = parseFloat(trailSlider.value); });
  labelsToggle.addEventListener('change', () => { showLabels = labelsToggle.checked; });
  toggleOrbitsBtn.addEventListener('click', () => {
    showOrbits = !showOrbits;
    toggleOrbitsBtn.textContent = 'Orbits: ' + (showOrbits ? 'ON' : 'OFF');
  });

  function resetOrrery() {
    time = 0;
    trails.forEach(t => t.length = 0);
    COMET.trailHistory.length = 0;
    zoomLevel = 1;
    panX = 0;
    panY = 0;
  }
  resetBtn.addEventListener('click', resetOrrery);
  window.reset = resetOrrery;

  // Build info panel
  (function buildInfo() {
    let html = '';
    PLANETS.forEach(function(p) {
      const years = (p.period / 365.26).toFixed(2);
      const periodStr = p.period < 365.26 ? p.period.toFixed(0) + 'd' : years + 'y';
      html += '<div class="planet-row">'
        + '<div class="planet-dot" style="background:' + p.color + ';box-shadow:0 0 4px ' + p.glowColor + '"></div>'
        + '<span class="planet-name">' + p.name + '</span>'
        + '<span class="planet-period">' + periodStr + '</span>'
        + '</div>';
    });
    infoPanel.innerHTML = html;
  })();

  // === MOUSE / ZOOM / PAN INTERACTION ===
  let mouseX = -1000, mouseY = -1000;

  canvas.addEventListener('mousemove', function(e) {
    mouseX = e.clientX;
    mouseY = e.clientY;
    if (isDragging) {
      panX = panStartX + (e.clientX - dragStartX);
      panY = panStartY + (e.clientY - dragStartY);
    }
  });

  canvas.addEventListener('mouseleave', function() {
    mouseX = -1000; mouseY = -1000;
    hoveredPlanet = null;
    tooltip.style.opacity = '0';
    isDragging = false;
  });

  canvas.addEventListener('mousedown', function(e) {
    if (e.button === 0) {
      isDragging = true;
      dragStartX = e.clientX;
      dragStartY = e.clientY;
      panStartX = panX;
      panStartY = panY;
      canvas.style.cursor = 'grabbing';
    }
  });

  window.addEventListener('mouseup', function() {
    isDragging = false;
    canvas.style.cursor = 'grab';
  });

  canvas.style.cursor = 'grab';

  // Zoom with mouse wheel
  canvas.addEventListener('wheel', function(e) {
    e.preventDefault();
    var zoomDelta = e.deltaY > 0 ? 0.9 : 1.1;
    var oldZoom = zoomLevel;
    zoomLevel = Math.max(0.2, Math.min(15, zoomLevel * zoomDelta));

    // Zoom toward mouse position
    var mx = e.clientX - W / 2 - panX;
    var my = e.clientY - H / 2 - panY;
    var zoomRatio = zoomLevel / oldZoom;
    panX -= mx * (zoomRatio - 1);
    panY -= my * (zoomRatio - 1);
  }, { passive: false });

  // Touch support for pan and pinch-zoom
  let lastTouchDist = 0;
  let lastTouchX = 0, lastTouchY = 0;

  canvas.addEventListener('touchstart', function(e) {
    if (e.touches.length === 1) {
      isDragging = true;
      dragStartX = e.touches[0].clientX;
      dragStartY = e.touches[0].clientY;
      panStartX = panX;
      panStartY = panY;
    } else if (e.touches.length === 2) {
      isDragging = false;
      var dx = e.touches[0].clientX - e.touches[1].clientX;
      var dy = e.touches[0].clientY - e.touches[1].clientY;
      lastTouchDist = Math.sqrt(dx * dx + dy * dy);
      lastTouchX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
      lastTouchY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
    }
    e.preventDefault();
  }, { passive: false });

  canvas.addEventListener('touchmove', function(e) {
    if (e.touches.length === 1 && isDragging) {
      panX = panStartX + (e.touches[0].clientX - dragStartX);
      panY = panStartY + (e.touches[0].clientY - dragStartY);
    } else if (e.touches.length === 2) {
      var dx = e.touches[0].clientX - e.touches[1].clientX;
      var dy = e.touches[0].clientY - e.touches[1].clientY;
      var dist = Math.sqrt(dx * dx + dy * dy);
      if (lastTouchDist > 0) {
        var zoomDelta = dist / lastTouchDist;
        var oldZoom = zoomLevel;
        zoomLevel = Math.max(0.2, Math.min(15, zoomLevel * zoomDelta));
        var mx = lastTouchX - W / 2 - panX;
        var my = lastTouchY - H / 2 - panY;
        var zoomRatio = zoomLevel / oldZoom;
        panX -= mx * (zoomRatio - 1);
        panY -= my * (zoomRatio - 1);
      }
      lastTouchDist = dist;
      lastTouchX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
      lastTouchY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
    }
    e.preventDefault();
  }, { passive: false });

  canvas.addEventListener('touchend', function(e) {
    isDragging = false;
    lastTouchDist = 0;
  });

  // === HELPER: compute planet position ===
  function getPlanetPos(planet, t) {
    var angle = (2 * Math.PI * t) / planet.period;
    var orbitRadius = planet.dist * getScale();
    var ccx = getCenterX();
    var ccy = getCenterY();
    return {
      x: ccx + Math.cos(angle) * orbitRadius,
      y: ccy + Math.sin(angle) * orbitRadius
    };
  }

  // === DRAW FUNCTIONS ===

  function drawStars(t) {
    for (var i = 0; i < stars.length; i++) {
      var star = stars[i];
      var sx = (star.x + 1) * 0.5 * W;
      var sy = (star.y + 1) * 0.5 * H;
      var twinkle = 0.5 + 0.5 * Math.sin(t * star.twinkleSpeed + star.twinklePhase);
      var alpha = star.brightness * (0.5 + 0.5 * twinkle);
      ctx.beginPath();
      ctx.arc(sx, sy, star.size, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(200, 220, 255, ' + alpha + ')';
      ctx.fill();
    }
  }

  function drawSun() {
    var ccx = getCenterX();
    var ccy = getCenterY();
    var sunScale = Math.min(2, Math.max(0.5, zoomLevel * 0.5 + 0.5));

    // Outer glow layers
    var gradient3 = ctx.createRadialGradient(ccx, ccy, 0, ccx, ccy, 80 * sunScale);
    gradient3.addColorStop(0, 'rgba(255, 200, 50, 0.08)');
    gradient3.addColorStop(1, 'rgba(255, 200, 50, 0)');
    ctx.beginPath();
    ctx.arc(ccx, ccy, 80 * sunScale, 0, Math.PI * 2);
    ctx.fillStyle = gradient3;
    ctx.fill();

    var gradient2 = ctx.createRadialGradient(ccx, ccy, 0, ccx, ccy, 45 * sunScale);
    gradient2.addColorStop(0, 'rgba(255, 220, 80, 0.15)');
    gradient2.addColorStop(1, 'rgba(255, 200, 50, 0)');
    ctx.beginPath();
    ctx.arc(ccx, ccy, 45 * sunScale, 0, Math.PI * 2);
    ctx.fillStyle = gradient2;
    ctx.fill();

    // Core glow
    var gradient1 = ctx.createRadialGradient(ccx, ccy, 0, ccx, ccy, 22 * sunScale);
    gradient1.addColorStop(0, 'rgba(255, 255, 220, 1)');
    gradient1.addColorStop(0.3, 'rgba(255, 230, 100, 0.9)');
    gradient1.addColorStop(0.7, 'rgba(255, 180, 40, 0.5)');
    gradient1.addColorStop(1, 'rgba(255, 150, 20, 0)');
    ctx.beginPath();
    ctx.arc(ccx, ccy, 22 * sunScale, 0, Math.PI * 2);
    ctx.fillStyle = gradient1;
    ctx.fill();

    // Sun corona rays (subtle)
    ctx.save();
    var rayCount = 12;
    var rayTime = time * 0.0005;
    for (var i = 0; i < rayCount; i++) {
      var angle = (i / rayCount) * Math.PI * 2 + rayTime;
      var length = (35 + 10 * Math.sin(time * 0.002 + i * 1.3)) * sunScale;
      var grad = ctx.createLinearGradient(
        ccx, ccy,
        ccx + Math.cos(angle) * length,
        ccy + Math.sin(angle) * length
      );
      grad.addColorStop(0, 'rgba(255, 220, 100, 0.12)');
      grad.addColorStop(1, 'rgba(255, 180, 50, 0)');
      ctx.beginPath();
      ctx.moveTo(ccx + Math.cos(angle - 0.08) * 15 * sunScale, ccy + Math.sin(angle - 0.08) * 15 * sunScale);
      ctx.lineTo(ccx + Math.cos(angle) * length, ccy + Math.sin(angle) * length);
      ctx.lineTo(ccx + Math.cos(angle + 0.08) * 15 * sunScale, ccy + Math.sin(angle + 0.08) * 15 * sunScale);
      ctx.fillStyle = grad;
      ctx.fill();
    }
    ctx.restore();
  }

  function drawOrbits() {
    if (!showOrbits) return;
    var ccx = getCenterX();
    var ccy = getCenterY();
    var sc = getScale();
    PLANETS.forEach(function(planet) {
      var orbitRadius = planet.dist * sc;
      ctx.beginPath();
      ctx.arc(ccx, ccy, orbitRadius, 0, Math.PI * 2);
      ctx.strokeStyle = 'rgba(100, 150, 255, 0.06)';
      ctx.lineWidth = 0.8;
      ctx.stroke();
    });
  }

  function drawTrails() {
    if (trailOpacity <= 0.01) return;
    PLANETS.forEach(function(planet, i) {
      var trail = trails[i];
      if (trail.length < 2) return;
      var r = parseInt(planet.color.slice(1, 3), 16);
      var g = parseInt(planet.color.slice(3, 5), 16);
      var b = parseInt(planet.color.slice(5, 7), 16);
      for (var j = 1; j < trail.length; j++) {
        var alpha = (j / trail.length) * trailOpacity * 0.5;
        ctx.beginPath();
        ctx.moveTo(trail[j - 1].x, trail[j - 1].y);
        ctx.lineTo(trail[j].x, trail[j].y);
        ctx.strokeStyle = 'rgba(' + r + ',' + g + ',' + b + ',' + alpha + ')';
        ctx.lineWidth = Math.max(1, VISUAL_RADII[i] * 0.5 * (j / trail.length));
        ctx.stroke();
      }
    });
  }

  // === ASTEROID BELT ===
  function drawAsteroidBelt(t) {
    var ccx = getCenterX();
    var ccy = getCenterY();
    var sc = getScale();

    // Draw faint asteroid belt orbit bands
    if (showOrbits) {
      ctx.beginPath();
      ctx.arc(ccx, ccy, 2.1 * sc, 0, Math.PI * 2);
      ctx.strokeStyle = 'rgba(100, 120, 140, 0.03)';
      ctx.lineWidth = 1.2 * sc * 0.04;
      ctx.stroke();
      ctx.beginPath();
      ctx.arc(ccx, ccy, 3.3 * sc, 0, Math.PI * 2);
      ctx.strokeStyle = 'rgba(100, 120, 140, 0.03)';
      ctx.stroke();
    }

    for (var i = 0; i < asteroids.length; i++) {
      var a = asteroids[i];
      // Each asteroid orbits at its own speed based on Kepler's law approximation
      var orbitPeriod = Math.pow(a.dist, 1.5) * 365.26; // Kepler's 3rd law
      var angle = a.angle + (2 * Math.PI * t * a.speed) / orbitPeriod;
      var wobbleDist = a.dist + Math.sin(angle * 3 + a.phase) * a.wobble;
      var px = ccx + Math.cos(angle) * wobbleDist * sc;
      var py = ccy + Math.sin(angle) * wobbleDist * sc;

      // Only draw if on screen (rough check)
      if (px > -20 && px < W + 20 && py > -20 && py < H + 20) {
        ctx.beginPath();
        ctx.arc(px, py, a.size * Math.min(1.5, zoomLevel * 0.3 + 0.5), 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(160, 150, 140, ' + a.brightness + ')';
        ctx.fill();
      }
    }
  }

  // === COMET ===
  function drawComet(t) {
    var ccx = getCenterX();
    var ccy = getCenterY();
    var sc = getScale();

    // Mean anomaly
    var M = (2 * Math.PI * t) / COMET.period + 1.2; // offset so it starts coming in
    // Solve Kepler's equation iteratively: E - e*sin(E) = M
    var E = M;
    for (var iter = 0; iter < 10; iter++) {
      E = M + COMET.eccentricity * Math.sin(E);
    }
    // True anomaly
    var cosV = (Math.cos(E) - COMET.eccentricity) / (1 - COMET.eccentricity * Math.cos(E));
    var sinV = (Math.sqrt(1 - COMET.eccentricity * COMET.eccentricity) * Math.sin(E)) / (1 - COMET.eccentricity * Math.cos(E));
    var trueAnomaly = Math.atan2(sinV, cosV);

    // Distance from sun (in AU)
    var r = COMET.semiMajor * (1 - COMET.eccentricity * COMET.eccentricity) / (1 + COMET.eccentricity * Math.cos(trueAnomaly));

    // Position with slight inclination
    var cx_comet = ccx + Math.cos(trueAnomaly + COMET.inclination) * r * sc;
    var cy_comet = ccy + Math.sin(trueAnomaly + COMET.inclination) * r * sc;

    // Store trail
    COMET.trailHistory.push({ x: cx_comet, y: cy_comet, r: r });
    if (COMET.trailHistory.length > COMET_TRAIL_LENGTH) COMET.trailHistory.shift();

    // Only draw if reasonably visible (comet within ~35 AU)
    if (r > 35) return;

    // Tail direction: always points away from sun
    var dx = cx_comet - ccx;
    var dy = cy_comet - ccy;
    var dist = Math.sqrt(dx * dx + dy * dy);
    if (dist < 1) return;
    var tailDirX = dx / dist;
    var tailDirY = dy / dist;

    // Tail length depends on distance to sun (closer = longer tail)
    var tailIntensity = Math.max(0, 1 - r / 10);
    var tailLength = COMET.tailMaxLength * tailIntensity * Math.min(2, zoomLevel * 0.5 + 0.5);

    // Draw comet trail (ion tail - bluish)
    if (COMET.trailHistory.length > 1 && tailIntensity > 0.05) {
      for (var j = 1; j < COMET.trailHistory.length; j++) {
        var alpha = (j / COMET.trailHistory.length) * 0.3 * tailIntensity;
        ctx.beginPath();
        ctx.moveTo(COMET.trailHistory[j - 1].x, COMET.trailHistory[j - 1].y);
        ctx.lineTo(COMET.trailHistory[j].x, COMET.trailHistory[j].y);
        ctx.strokeStyle = 'rgba(150, 200, 255, ' + alpha + ')';
        ctx.lineWidth = 1.5;
        ctx.stroke();
      }
    }

    // Draw dust tail (wider, yellowish)
    if (tailLength > 2) {
      var tailGrad = ctx.createLinearGradient(
        cx_comet, cy_comet,
        cx_comet + tailDirX * tailLength * 1.5,
        cy_comet + tailDirY * tailLength * 1.5
      );
      tailGrad.addColorStop(0, 'rgba(255, 240, 200, ' + (0.4 * tailIntensity) + ')');
      tailGrad.addColorStop(0.3, 'rgba(200, 220, 255, ' + (0.2 * tailIntensity) + ')');
      tailGrad.addColorStop(1, 'rgba(150, 180, 255, 0)');

      ctx.save();
      ctx.beginPath();
      ctx.moveTo(cx_comet - tailDirY * 2, cy_comet + tailDirX * 2);
      ctx.quadraticCurveTo(
        cx_comet + tailDirX * tailLength * 0.6 + tailDirY * tailLength * 0.15,
        cy_comet + tailDirY * tailLength * 0.6 - tailDirX * tailLength * 0.15,
        cx_comet + tailDirX * tailLength * 1.5,
        cy_comet + tailDirY * tailLength * 1.5
      );
      ctx.quadraticCurveTo(
        cx_comet + tailDirX * tailLength * 0.6 - tailDirY * tailLength * 0.15,
        cy_comet + tailDirY * tailLength * 0.6 + tailDirX * tailLength * 0.15,
        cx_comet + tailDirY * 2, cy_comet - tailDirX * 2
      );
      ctx.fillStyle = tailGrad;
      ctx.fill();
      ctx.restore();

      // Ion tail (narrow, blue, straighter)
      var ionGrad = ctx.createLinearGradient(
        cx_comet, cy_comet,
        cx_comet + tailDirX * tailLength * 2,
        cy_comet + tailDirY * tailLength * 2
      );
      ionGrad.addColorStop(0, 'rgba(100, 160, 255, ' + (0.5 * tailIntensity) + ')');
      ionGrad.addColorStop(1, 'rgba(80, 130, 255, 0)');
      ctx.beginPath();
      ctx.moveTo(cx_comet, cy_comet);
      ctx.lineTo(cx_comet + tailDirX * tailLength * 2, cy_comet + tailDirY * tailLength * 2);
      ctx.strokeStyle = ionGrad;
      ctx.lineWidth = 1.5 * tailIntensity;
      ctx.stroke();
    }

    // Comet coma glow
    var comaSize = (3 + 4 * tailIntensity) * Math.min(2, zoomLevel * 0.3 + 0.7);
    var comaGrad = ctx.createRadialGradient(cx_comet, cy_comet, 0, cx_comet, cy_comet, comaSize * 3);
    comaGrad.addColorStop(0, 'rgba(200, 230, 255, ' + (0.5 * Math.max(0.2, tailIntensity)) + ')');
    comaGrad.addColorStop(0.5, 'rgba(150, 200, 255, ' + (0.15 * Math.max(0.1, tailIntensity)) + ')');
    comaGrad.addColorStop(1, 'rgba(100, 150, 255, 0)');
    ctx.beginPath();
    ctx.arc(cx_comet, cy_comet, comaSize * 3, 0, Math.PI * 2);
    ctx.fillStyle = comaGrad;
    ctx.fill();

    // Comet nucleus
    ctx.beginPath();
    ctx.arc(cx_comet, cy_comet, Math.max(1, comaSize * 0.4), 0, Math.PI * 2);
    ctx.fillStyle = 'rgba(240, 250, 255, ' + Math.max(0.5, tailIntensity) + ')';
    ctx.fill();
  }

  // === GALILEAN MOONS ===
  function drawGalileanMoons(jupiterX, jupiterY, t) {
    for (var i = 0; i < GALILEAN_MOONS.length; i++) {
      var moon = GALILEAN_MOONS[i];
      var moonAngle = (2 * Math.PI * t) / moon.period;
      var moonDist = moon.dist * Math.min(2, zoomLevel * 0.3 + 0.7);
      var mx = jupiterX + Math.cos(moonAngle) * moonDist;
      var my = jupiterY + Math.sin(moonAngle) * moonDist * 0.35; // Slight inclination for 3D effect

      // Moon glow
      var moonGlow = ctx.createRadialGradient(mx, my, 0, mx, my, moon.size * 3);
      moonGlow.addColorStop(0, moon.color.replace(')', ',0.3)').replace('rgb', 'rgba').replace('#', ''));
      moonGlow.addColorStop(1, 'rgba(0,0,0,0)');

      // Convert hex color to rgba for glow
      var mr = parseInt(moon.color.slice(1, 3), 16);
      var mg = parseInt(moon.color.slice(3, 5), 16);
      var mb = parseInt(moon.color.slice(5, 7), 16);

      var mgGrad = ctx.createRadialGradient(mx, my, 0, mx, my, moon.size * 3);
      mgGrad.addColorStop(0, 'rgba(' + mr + ',' + mg + ',' + mb + ',0.2)');
      mgGrad.addColorStop(1, 'rgba(0,0,0,0)');
      ctx.beginPath();
      ctx.arc(mx, my, moon.size * 3, 0, Math.PI * 2);
      ctx.fillStyle = mgGrad;
      ctx.fill();

      // Moon body
      ctx.beginPath();
      ctx.arc(mx, my, moon.size, 0, Math.PI * 2);
      ctx.fillStyle = moon.color;
      ctx.fill();

      // Moon label at higher zoom
      if (showLabels && zoomLevel > 2.5) {
        ctx.font = '7px monospace';
        ctx.fillStyle = 'rgba(200, 220, 255, 0.3)';
        ctx.textAlign = 'center';
        ctx.fillText(moon.name, mx, my + moon.size + 8);
      }
    }
  }

  function drawPlanets(t) {
    hoveredPlanet = null;
    var closestDist = 30; // pixel threshold for hover

    PLANETS.forEach(function(planet, i) {
      var pos = getPlanetPos(planet, t);
      var vr = VISUAL_RADII[i] * Math.min(2, zoomLevel * 0.15 + 0.85);

      // Store trail
      trails[i].push({ x: pos.x, y: pos.y });
      if (trails[i].length > TRAIL_LENGTH) trails[i].shift();

      // Check hover
      var dx = mouseX - pos.x;
      var dy = mouseY - pos.y;
      var dist = Math.sqrt(dx * dx + dy * dy);
      if (dist < closestDist && dist < vr + 15) {
        closestDist = dist;
        hoveredPlanet = { planet: planet, pos: pos, index: i };
      }

      // Outer glow (larger, softer)
      var outerGlow = ctx.createRadialGradient(pos.x, pos.y, vr * 0.5, pos.x, pos.y, vr * 4.5);
      outerGlow.addColorStop(0, planet.glowColor.replace('0.4)', '0.15)').replace('0.5)', '0.2)'));
      outerGlow.addColorStop(1, 'rgba(0,0,0,0)');
      ctx.beginPath();
      ctx.arc(pos.x, pos.y, vr * 4.5, 0, Math.PI * 2);
      ctx.fillStyle = outerGlow;
      ctx.fill();

      // Inner glow
      var glowGrad = ctx.createRadialGradient(pos.x, pos.y, vr * 0.5, pos.x, pos.y, vr * 3);
      glowGrad.addColorStop(0, planet.glowColor);
      glowGrad.addColorStop(1, 'rgba(0,0,0,0)');
      ctx.beginPath();
      ctx.arc(pos.x, pos.y, vr * 3, 0, Math.PI * 2);
      ctx.fillStyle = glowGrad;
      ctx.fill();

      // Planet body
      var bodyGrad = ctx.createRadialGradient(
        pos.x - vr * 0.3, pos.y - vr * 0.3, vr * 0.1,
        pos.x, pos.y, vr
      );
      bodyGrad.addColorStop(0, '#fff');
      bodyGrad.addColorStop(0.3, planet.color);
      bodyGrad.addColorStop(1, shadeColor(planet.color, -40));
      ctx.beginPath();
      ctx.arc(pos.x, pos.y, vr, 0, Math.PI * 2);
      ctx.fillStyle = bodyGrad;
      ctx.fill();

      // Saturn ring
      if (planet.name === 'Saturn') {
        drawSaturnRing(pos.x, pos.y, vr);
      }

      // Earth moon
      if (planet.name === 'Earth') {
        drawMoon(pos.x, pos.y, t, vr);
      }

      // Jupiter Galilean moons
      if (planet.name === 'Jupiter') {
        drawGalileanMoons(pos.x, pos.y, t);
      }

      // Label
      if (showLabels) {
        ctx.font = '9px monospace';
        ctx.fillStyle = 'rgba(200, 220, 255, 0.4)';
        ctx.textAlign = 'center';
        ctx.fillText(planet.name, pos.x, pos.y + vr + 12);
      }
    });

    // Tooltip for hovered planet
    if (hoveredPlanet && !isDragging) {
      var hp = hoveredPlanet;
      var years = (hp.planet.period / 365.26).toFixed(2);
      var au = hp.planet.dist.toFixed(3);
      var radiusKm = hp.planet.radius.toLocaleString();
      tooltip.innerHTML = '<strong style="color:' + hp.planet.color + '">' + hp.planet.name + '</strong><br>'
        + 'Period: ' + hp.planet.period.toFixed(0) + ' days (' + years + ' yr)<br>'
        + 'Distance: ' + au + ' AU<br>'
        + 'Radius: ' + radiusKm + ' km';
      tooltip.style.opacity = '1';
      // Keep tooltip on screen
      var ttx = hp.pos.x + 20;
      var tty = hp.pos.y - 20;
      if (ttx + 180 > W) ttx = hp.pos.x - 200;
      if (tty < 10) tty = 10;
      tooltip.style.left = ttx + 'px';
      tooltip.style.top = tty + 'px';
    } else {
      tooltip.style.opacity = '0';
    }
  }

  function drawSaturnRing(x, y, vr) {
    ctx.save();
    ctx.beginPath();
    ctx.ellipse(x, y, vr * 2.2, vr * 0.6, -0.3, 0, Math.PI * 2);
    ctx.strokeStyle = 'rgba(210, 190, 150, 0.35)';
    ctx.lineWidth = 2.5;
    ctx.stroke();
    ctx.beginPath();
    ctx.ellipse(x, y, vr * 1.8, vr * 0.5, -0.3, 0, Math.PI * 2);
    ctx.strokeStyle = 'rgba(210, 190, 150, 0.2)';
    ctx.lineWidth = 1.5;
    ctx.stroke();
    // Extra outer ring
    ctx.beginPath();
    ctx.ellipse(x, y, vr * 2.6, vr * 0.7, -0.3, 0, Math.PI * 2);
    ctx.strokeStyle = 'rgba(210, 190, 150, 0.1)';
    ctx.lineWidth = 1;
    ctx.stroke();
    ctx.restore();
  }

  function drawMoon(ex, ey, t, parentVr) {
    var moonAngle = (2 * Math.PI * t) / 27.3; // ~27.3 day lunar period
    var moonDist = (parentVr || 5) * 2.5 + 5;
    var mx = ex + Math.cos(moonAngle) * moonDist;
    var my = ey + Math.sin(moonAngle) * moonDist;

    // Moon glow
    var moonGlow = ctx.createRadialGradient(mx, my, 0, mx, my, 5);
    moonGlow.addColorStop(0, 'rgba(200, 200, 220, 0.2)');
    moonGlow.addColorStop(1, 'rgba(0,0,0,0)');
    ctx.beginPath();
    ctx.arc(mx, my, 5, 0, Math.PI * 2);
    ctx.fillStyle = moonGlow;
    ctx.fill();

    ctx.beginPath();
    ctx.arc(mx, my, 1.8, 0, Math.PI * 2);
    ctx.fillStyle = 'rgba(200, 200, 210, 0.8)';
    ctx.fill();

    // Moon label at higher zoom
    if (showLabels && zoomLevel > 3) {
      ctx.font = '7px monospace';
      ctx.fillStyle = 'rgba(200, 220, 255, 0.3)';
      ctx.textAlign = 'center';
      ctx.fillText('Moon', mx, my + 8);
    }
  }

  function shadeColor(hex, percent) {
    var r = parseInt(hex.slice(1, 3), 16);
    var g = parseInt(hex.slice(3, 5), 16);
    var b = parseInt(hex.slice(5, 7), 16);
    r = Math.max(0, Math.min(255, r + percent));
    g = Math.max(0, Math.min(255, g + percent));
    b = Math.max(0, Math.min(255, b + percent));
    return 'rgb(' + r + ',' + g + ',' + b + ')';
  }

  // === AMBIENT PARTICLES (dust motes) ===
  var NUM_PARTICLES = 80;
  var particles = [];
  for (var i = 0; i < NUM_PARTICLES; i++) {
    particles.push({
      angle: Math.random() * Math.PI * 2,
      dist: Math.random() * Math.min(window.innerWidth, window.innerHeight) * 0.5,
      speed: (Math.random() - 0.5) * 0.0003,
      size: Math.random() * 1.2 + 0.2,
      alpha: Math.random() * 0.15 + 0.03
    });
  }

  function drawParticles(t) {
    var ccx = getCenterX();
    var ccy = getCenterY();
    for (var i = 0; i < particles.length; i++) {
      var p = particles[i];
      p.angle += p.speed;
      var px = ccx + Math.cos(p.angle) * p.dist * zoomLevel;
      var py = ccy + Math.sin(p.angle) * p.dist * zoomLevel;
      ctx.beginPath();
      ctx.arc(px, py, p.size, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(150, 180, 255, ' + p.alpha + ')';
      ctx.fill();
    }
  }

  // === ANIMATION LOOP ===
  var lastTime = 0;

  function animate(timestamp) {
    if (!lastTime) lastTime = timestamp;
    var dt = (timestamp - lastTime) / 1000; // seconds
    lastTime = timestamp;

    if (!paused) {
      // 1 unit of time = 1 Earth day. Speed multiplier controls days per second.
      time += dt * speedMultiplier;
    }

    // Clear fully (no ghosting issues with zoom/pan)
    ctx.clearRect(0, 0, W, H);

    // Background
    ctx.fillStyle = '#060810';
    ctx.fillRect(0, 0, W, H);

    // Subtle radial background gradient
    var ccx = getCenterX();
    var ccy = getCenterY();
    var bgGrad = ctx.createRadialGradient(ccx, ccy, 0, ccx, ccy, Math.max(W, H) * 0.6);
    bgGrad.addColorStop(0, 'rgba(15, 18, 40, 0.6)');
    bgGrad.addColorStop(1, 'rgba(0, 0, 0, 0)');
    ctx.fillStyle = bgGrad;
    ctx.fillRect(0, 0, W, H);

    drawStars(timestamp);
    drawParticles(time);
    drawOrbits();
    drawAsteroidBelt(time);
    drawTrails();
    drawSun();
    drawComet(time);
    drawPlanets(time);

    // Time counter
    var earthYears = (time / 365.26).toFixed(2);
    ctx.font = '11px monospace';
    ctx.fillStyle = 'rgba(160, 200, 255, 0.35)';
    ctx.textAlign = 'left';
    ctx.fillText('T = ' + earthYears + ' Earth years', 14, H - 16);

    // Zoom indicator
    if (zoomLevel !== 1) {
      ctx.textAlign = 'right';
      ctx.fillText('Zoom: ' + zoomLevel.toFixed(1) + 'x', W - 14, H - 16);
    }

    requestAnimationFrame(animate);
  }

  // === KEYBOARD: Space to pause ===
  document.addEventListener('keydown', function(e) {
    if (e.code === 'Space') {
      e.preventDefault();
      paused = !paused;
    }
  });

  // === START ===
  requestAnimationFrame(animate);

})();
</script>
<script src="../assets/js/enhance.js"></script>
</body>
</html>
