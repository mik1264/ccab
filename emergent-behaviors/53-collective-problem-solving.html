<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collective Problem Solving - Ant Colony Optimization</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', system-ui, sans-serif;
            color: #c9d1d9;
        }
        .back-link {
            position: fixed;
            top: 15px;
            left: 15px;
            color: #58a6ff;
            text-decoration: none;
            font-size: 14px;
            z-index: 100;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 320px;
            height: 100vh;
            gap: 0;
        }
        .canvas-section {
            display: flex;
            flex-direction: column;
            padding: 20px;
        }
        header {
            text-align: center;
            padding-bottom: 15px;
        }
        h1 {
            font-size: 1.5rem;
            color: #58a6ff;
        }
        .subtitle { color: #8b949e; font-size: 0.9rem; }
        canvas {
            flex: 1;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
        }
        .sidebar {
            background: #161b22;
            border-left: 1px solid #30363d;
            padding: 20px;
            overflow-y: auto;
        }
        .control-group {
            margin-bottom: 20px;
        }
        .control-group label {
            display: block;
            color: #58a6ff;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        .slider-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        input[type="range"] {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            background: #30363d;
            border-radius: 3px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #58a6ff;
            border-radius: 50%;
            cursor: pointer;
        }
        .value { min-width: 40px; text-align: right; font-family: monospace; }
        button {
            width: 100%;
            padding: 12px;
            margin: 5px 0;
            background: #238636;
            border: none;
            border-radius: 6px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover { background: #2ea043; }
        button.secondary {
            background: #30363d;
        }
        button.secondary:hover { background: #484f58; }
        .stats-panel {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        .stats-panel h3 {
            color: #58a6ff;
            font-size: 0.9rem;
            margin-bottom: 10px;
            border-bottom: 1px solid #30363d;
            padding-bottom: 8px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 0.85rem;
        }
        .stat-label { color: #8b949e; }
        .stat-value { color: #7ee787; font-family: monospace; }
        .stat-value.best { color: #ffa657; }
        .progress-bar {
            height: 8px;
            background: #30363d;
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #238636, #7ee787);
            transition: width 0.3s;
        }
        .info-panel {
            margin-top: 15px;
            padding: 12px;
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid rgba(88, 166, 255, 0.3);
            border-radius: 8px;
            font-size: 0.8rem;
            line-height: 1.5;
        }
        .info-panel h4 {
            color: #58a6ff;
            margin-bottom: 8px;
        }
        .legend {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 10px;
            font-size: 0.8rem;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        @media (max-width: 900px) {
            .container { grid-template-columns: 1fr; }
            .sidebar { border-left: none; border-top: 1px solid #30363d; }
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back</a>

    <div class="container">
        <div class="canvas-section">
            <header>
                <h1>Collective Problem Solving</h1>
                <p class="subtitle">Ant Colony Optimization for the Traveling Salesman Problem</p>
            </header>
            <canvas id="canvas"></canvas>
            <div class="legend">
                <div class="legend-item"><div class="legend-dot" style="background:#58a6ff"></div> Cities</div>
                <div class="legend-item"><div class="legend-dot" style="background:#ffa657"></div> Best Path</div>
                <div class="legend-item"><div class="legend-dot" style="background:rgba(126,231,135,0.3)"></div> Pheromone Trails</div>
            </div>
        </div>

        <div class="sidebar">
            <div class="control-group">
                <label>Number of Cities</label>
                <div class="slider-row">
                    <input type="range" id="numCities" min="5" max="50" value="20">
                    <span class="value" id="numCitiesVal">20</span>
                </div>
            </div>

            <div class="control-group">
                <label>Number of Ants</label>
                <div class="slider-row">
                    <input type="range" id="numAnts" min="5" max="100" value="30">
                    <span class="value" id="numAntsVal">30</span>
                </div>
            </div>

            <div class="control-group">
                <label>Pheromone Importance (α)</label>
                <div class="slider-row">
                    <input type="range" id="alpha" min="0" max="50" value="10">
                    <span class="value" id="alphaVal">1.0</span>
                </div>
            </div>

            <div class="control-group">
                <label>Distance Importance (β)</label>
                <div class="slider-row">
                    <input type="range" id="beta" min="10" max="80" value="30">
                    <span class="value" id="betaVal">3.0</span>
                </div>
            </div>

            <div class="control-group">
                <label>Evaporation Rate (ρ)</label>
                <div class="slider-row">
                    <input type="range" id="rho" min="1" max="50" value="10">
                    <span class="value" id="rhoVal">0.10</span>
                </div>
            </div>

            <button id="resetBtn">New Problem</button>
            <button id="startBtn">Start Optimization</button>
            <button id="stepBtn" class="secondary">Single Iteration</button>

            <div class="stats-panel">
                <h3>Optimization Progress</h3>
                <div class="stat-row">
                    <span class="stat-label">Iteration:</span>
                    <span class="stat-value" id="iterationStat">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Current Best:</span>
                    <span class="stat-value best" id="bestStat">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Global Best:</span>
                    <span class="stat-value best" id="globalStat">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Improvement:</span>
                    <span class="stat-value" id="improveStat">-</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>

            <div class="info-panel">
                <h4>How ACO Works</h4>
                <p>
                    Ants explore paths probabilistically, preferring edges with more pheromone (α)
                    and shorter distance (β). After completing tours, ants deposit pheromone
                    inversely proportional to tour length. Pheromone evaporates (ρ) to prevent
                    premature convergence. Over time, the colony converges on near-optimal solutions.
                </p>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // Resize canvas
        function resizeCanvas() {
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Parameters
        let numCities = 20;
        let numAnts = 30;
        let alpha = 1.0;  // Pheromone importance
        let beta = 3.0;   // Distance importance
        let rho = 0.1;    // Evaporation rate
        let Q = 100;      // Pheromone deposit factor

        // State
        let cities = [];
        let distances = [];
        let pheromones = [];
        let bestTour = null;
        let bestLength = Infinity;
        let globalBestTour = null;
        let globalBestLength = Infinity;
        let initialLength = Infinity;
        let iteration = 0;
        let running = false;

        // Initialize cities
        function initCities() {
            cities = [];
            const padding = 50;
            const w = canvas.width - padding * 2;
            const h = canvas.height - padding * 2;

            for (let i = 0; i < numCities; i++) {
                cities.push({
                    x: padding + Math.random() * w,
                    y: padding + Math.random() * h
                });
            }

            // Calculate distances
            distances = Array(numCities).fill().map(() => Array(numCities).fill(0));
            for (let i = 0; i < numCities; i++) {
                for (let j = 0; j < numCities; j++) {
                    const dx = cities[i].x - cities[j].x;
                    const dy = cities[i].y - cities[j].y;
                    distances[i][j] = Math.sqrt(dx * dx + dy * dy);
                }
            }

            // Initialize pheromones
            const initialPheromone = 1.0;
            pheromones = Array(numCities).fill().map(() => Array(numCities).fill(initialPheromone));

            // Reset state
            bestTour = null;
            bestLength = Infinity;
            globalBestTour = null;
            globalBestLength = Infinity;
            iteration = 0;

            // Calculate initial greedy tour length
            const greedyTour = greedyPath();
            initialLength = tourLength(greedyTour);
        }

        // Greedy nearest neighbor path
        function greedyPath() {
            const visited = new Set([0]);
            const tour = [0];
            let current = 0;

            while (visited.size < numCities) {
                let nearest = -1;
                let nearestDist = Infinity;

                for (let i = 0; i < numCities; i++) {
                    if (!visited.has(i) && distances[current][i] < nearestDist) {
                        nearest = i;
                        nearestDist = distances[current][i];
                    }
                }

                tour.push(nearest);
                visited.add(nearest);
                current = nearest;
            }

            return tour;
        }

        // Calculate tour length
        function tourLength(tour) {
            let length = 0;
            for (let i = 0; i < tour.length; i++) {
                const from = tour[i];
                const to = tour[(i + 1) % tour.length];
                length += distances[from][to];
            }
            return length;
        }

        // Run one ant
        function runAnt() {
            const visited = new Set();
            const tour = [];
            let current = Math.floor(Math.random() * numCities);

            visited.add(current);
            tour.push(current);

            while (visited.size < numCities) {
                // Calculate probabilities
                const probs = [];
                let totalProb = 0;

                for (let i = 0; i < numCities; i++) {
                    if (visited.has(i)) {
                        probs.push(0);
                    } else {
                        const tau = Math.pow(pheromones[current][i], alpha);
                        const eta = Math.pow(1 / distances[current][i], beta);
                        const prob = tau * eta;
                        probs.push(prob);
                        totalProb += prob;
                    }
                }

                // Roulette wheel selection
                let rand = Math.random() * totalProb;
                let next = -1;

                for (let i = 0; i < numCities; i++) {
                    rand -= probs[i];
                    if (rand <= 0) {
                        next = i;
                        break;
                    }
                }

                if (next === -1) {
                    // Fallback: pick random unvisited
                    for (let i = 0; i < numCities; i++) {
                        if (!visited.has(i)) {
                            next = i;
                            break;
                        }
                    }
                }

                tour.push(next);
                visited.add(next);
                current = next;
            }

            return tour;
        }

        // Run one iteration
        function runIteration() {
            const tours = [];
            const lengths = [];

            // Run all ants
            for (let a = 0; a < numAnts; a++) {
                const tour = runAnt();
                tours.push(tour);
                lengths.push(tourLength(tour));
            }

            // Find best in this iteration
            let iterBestIdx = 0;
            for (let i = 1; i < lengths.length; i++) {
                if (lengths[i] < lengths[iterBestIdx]) {
                    iterBestIdx = i;
                }
            }

            bestTour = tours[iterBestIdx];
            bestLength = lengths[iterBestIdx];

            if (bestLength < globalBestLength) {
                globalBestTour = [...bestTour];
                globalBestLength = bestLength;
            }

            // Evaporate pheromones
            for (let i = 0; i < numCities; i++) {
                for (let j = 0; j < numCities; j++) {
                    pheromones[i][j] *= (1 - rho);
                    pheromones[i][j] = Math.max(pheromones[i][j], 0.01);
                }
            }

            // Deposit new pheromones
            for (let a = 0; a < numAnts; a++) {
                const deposit = Q / lengths[a];
                const tour = tours[a];

                for (let i = 0; i < tour.length; i++) {
                    const from = tour[i];
                    const to = tour[(i + 1) % tour.length];
                    pheromones[from][to] += deposit;
                    pheromones[to][from] += deposit;
                }
            }

            iteration++;
            updateStats();
        }

        // Update statistics display
        function updateStats() {
            document.getElementById('iterationStat').textContent = iteration;
            document.getElementById('bestStat').textContent = bestLength.toFixed(1);
            document.getElementById('globalStat').textContent = globalBestLength.toFixed(1);

            const improvement = ((initialLength - globalBestLength) / initialLength * 100).toFixed(1);
            document.getElementById('improveStat').textContent = improvement + '%';

            // Progress bar (cap at 100 iterations)
            const progress = Math.min(iteration / 100 * 100, 100);
            document.getElementById('progressFill').style.width = progress + '%';
        }

        // Render
        function render() {
            ctx.fillStyle = '#0d1117';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw pheromone trails
            const maxPheromone = Math.max(...pheromones.flat());
            for (let i = 0; i < numCities; i++) {
                for (let j = i + 1; j < numCities; j++) {
                    const intensity = pheromones[i][j] / maxPheromone;
                    if (intensity > 0.1) {
                        ctx.strokeStyle = `rgba(126, 231, 135, ${intensity * 0.4})`;
                        ctx.lineWidth = intensity * 3;
                        ctx.beginPath();
                        ctx.moveTo(cities[i].x, cities[i].y);
                        ctx.lineTo(cities[j].x, cities[j].y);
                        ctx.stroke();
                    }
                }
            }

            // Draw best tour
            if (globalBestTour) {
                ctx.strokeStyle = '#ffa657';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(cities[globalBestTour[0]].x, cities[globalBestTour[0]].y);
                for (let i = 1; i <= globalBestTour.length; i++) {
                    const city = cities[globalBestTour[i % globalBestTour.length]];
                    ctx.lineTo(city.x, city.y);
                }
                ctx.stroke();
            }

            // Draw cities
            cities.forEach((city, i) => {
                ctx.fillStyle = '#58a6ff';
                ctx.beginPath();
                ctx.arc(city.x, city.y, 8, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = '#fff';
                ctx.font = '10px sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(i, city.x, city.y);
            });
        }

        // Animation loop
        function animate() {
            if (running) {
                runIteration();
            }
            render();
            requestAnimationFrame(animate);
        }

        // Event handlers
        document.getElementById('numCities').addEventListener('input', (e) => {
            numCities = parseInt(e.target.value);
            document.getElementById('numCitiesVal').textContent = numCities;
        });

        document.getElementById('numAnts').addEventListener('input', (e) => {
            numAnts = parseInt(e.target.value);
            document.getElementById('numAntsVal').textContent = numAnts;
        });

        document.getElementById('alpha').addEventListener('input', (e) => {
            alpha = e.target.value / 10;
            document.getElementById('alphaVal').textContent = alpha.toFixed(1);
        });

        document.getElementById('beta').addEventListener('input', (e) => {
            beta = e.target.value / 10;
            document.getElementById('betaVal').textContent = beta.toFixed(1);
        });

        document.getElementById('rho').addEventListener('input', (e) => {
            rho = e.target.value / 100;
            document.getElementById('rhoVal').textContent = rho.toFixed(2);
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            running = false;
            document.getElementById('startBtn').textContent = 'Start Optimization';
            initCities();
        });

        document.getElementById('startBtn').addEventListener('click', () => {
            running = !running;
            document.getElementById('startBtn').textContent = running ? 'Pause' : 'Start Optimization';
        });

        document.getElementById('stepBtn').addEventListener('click', () => {
            if (!running) {
                runIteration();
                render();
            }
        });

        // Initialize
        initCities();
        animate();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
