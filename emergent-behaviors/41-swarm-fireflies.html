<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firefly Synchronization - CCAB</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #e0e0e0;
        }
        h1 {
            font-size: 2em;
            margin-bottom: 10px;
            color: #FFEB3B;
            text-align: center;
        }
        .container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        canvas {
            display: block;
            background: #000000;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        button {
            padding: 10px 20px;
            font-size: 14px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #FFEB3B;
            color: #1a1a2e;
            font-weight: bold;
            transition: background 0.3s;
        }
        button:hover {
            background: #FDD835;
        }
        button.secondary {
            background: #2196F3;
            color: white;
        }
        button.secondary:hover {
            background: #0b7dda;
        }
        .info {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .metric {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #FFEB3B;
        }
        .metric-label {
            font-size: 0.9em;
            color: #aaa;
        }
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        input[type="range"] {
            flex: 1;
            max-width: 200px;
        }
        .slider-label {
            min-width: 120px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link" style="position:fixed;top:15px;left:15px;color:#fff;text-decoration:none;opacity:0.8;z-index:1000;">← Back</a>
    <h1>Firefly Synchronization</h1>

    <div class="container">
        <canvas id="canvas" width="800" height="600"></canvas>

        <div class="controls">
            <button id="pauseBtn">Pause</button>
            <button id="resetBtn" class="secondary">Reset</button>
            <div class="slider-container">
                <span class="slider-label">Coupling Strength:</span>
                <input type="range" id="couplingSlider" min="0" max="100" value="50">
                <span id="couplingValue">0.5</span>
            </div>
        </div>

        <div class="info">
            <strong>Firefly Synchronization (Kuramoto Model)</strong><br>
            Fireflies spontaneously synchronize their flashing through mutual observation and phase adjustment.
            Based on the Kuramoto model, each firefly adjusts its internal rhythm when it sees others flash.
            This emergent synchronization occurs without central coordination, demonstrating self-organization in nature.
        </div>

        <div class="metrics">
            <div class="metric">
                <div class="metric-value" id="fireflyCount">0</div>
                <div class="metric-label">Fireflies</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="syncIndex">0%</div>
                <div class="metric-label">Synchronization</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="avgPhase">0°</div>
                <div class="metric-label">Avg Phase</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="flashRate">0</div>
                <div class="metric-label">Flashes/sec</div>
            </div>
        </div>
    </div>

    <script src="../assets/js/demo-utils.js"></script>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        const fps = new FPSCounter({ position: 'top-right' });
        const errorMgr = new ErrorManager();
        setupGlobalErrorHandler((msg, details) => errorMgr.show(msg, details));
        fps.start();

        let isPaused = false;
        let coupling = 0.5;
        let flashCount = 0;
        let lastFlashTime = Date.now();

        class Firefly {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;

                // Kuramoto model parameters
                this.phase = Math.random() * Math.PI * 2;
                this.naturalFrequency = 0.03 + (Math.random() - 0.5) * 0.01; // Slightly different frequencies

                // Visual parameters
                this.size = 3 + Math.random() * 2;
                this.lastFlash = 0;

                // Movement
                this.vx = (Math.random() - 0.5) * 0.5;
                this.vy = (Math.random() - 0.5) * 0.5;
            }

            update(fireflies) {
                // Kuramoto model update
                let phaseCoupling = 0;

                for (const other of fireflies) {
                    if (other !== this) {
                        const dx = other.x - this.x;
                        const dy = other.y - this.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);

                        // Coupling decays with distance
                        const influence = Math.exp(-distance / 200);
                        phaseCoupling += influence * Math.sin(other.phase - this.phase);
                    }
                }

                // Update phase
                this.phase += this.naturalFrequency + (coupling / fireflies.length) * phaseCoupling;
                this.phase = this.phase % (Math.PI * 2);

                // Move slowly
                this.x += this.vx;
                this.y += this.vy;

                // Bounce off walls
                if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
                if (this.y < 0 || this.y > canvas.height) this.vy *= -1;

                this.x = Math.max(0, Math.min(canvas.width, this.x));
                this.y = Math.max(0, Math.min(canvas.height, this.y));

                // Check if flashing
                const flashThreshold = Math.PI * 1.8;
                if (this.phase > flashThreshold && this.lastFlash < flashThreshold) {
                    flashCount++;
                }
                this.lastFlash = this.phase;
            }

            draw() {
                // Flash intensity based on phase
                const flashThreshold = Math.PI * 1.5;
                let intensity = 0;

                if (this.phase > flashThreshold) {
                    // Flash ramp up and down
                    const flashPhase = (this.phase - flashThreshold) / (Math.PI * 2 - flashThreshold);
                    intensity = Math.sin(flashPhase * Math.PI);
                }

                // Draw glow
                if (intensity > 0) {
                    const glowSize = this.size * 8 * intensity;
                    const gradient = ctx.createRadialGradient(
                        this.x, this.y, 0,
                        this.x, this.y, glowSize
                    );
                    gradient.addColorStop(0, `rgba(255, 255, 150, ${intensity * 0.8})`);
                    gradient.addColorStop(0.3, `rgba(255, 255, 100, ${intensity * 0.4})`);
                    gradient.addColorStop(1, 'rgba(255, 255, 0, 0)');

                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, glowSize, 0, Math.PI * 2);
                    ctx.fill();
                }

                // Draw firefly body
                ctx.fillStyle = intensity > 0.5 ? '#FFFF00' : '#444400';
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();

                // Draw phase indicator (small line)
                if (intensity < 0.5) {
                    ctx.strokeStyle = 'rgba(100, 100, 0, 0.5)';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(this.x, this.y);
                    ctx.lineTo(
                        this.x + Math.cos(this.phase - Math.PI / 2) * this.size * 2,
                        this.y + Math.sin(this.phase - Math.PI / 2) * this.size * 2
                    );
                    ctx.stroke();
                }
            }
        }

        const fireflies = [];
        function initFireflies() {
            fireflies.length = 0;
            flashCount = 0;
            lastFlashTime = Date.now();

            for (let i = 0; i < 80; i++) {
                fireflies.push(new Firefly());
            }
        }

        function calculateSynchronization() {
            // Calculate order parameter (Kuramoto synchronization index)
            let sumSin = 0;
            let sumCos = 0;

            for (const firefly of fireflies) {
                sumSin += Math.sin(firefly.phase);
                sumCos += Math.cos(firefly.phase);
            }

            sumSin /= fireflies.length;
            sumCos /= fireflies.length;

            const orderParameter = Math.sqrt(sumSin * sumSin + sumCos * sumCos);
            return orderParameter;
        }

        function updateMetrics() {
            document.getElementById('fireflyCount').textContent = fireflies.length;

            const syncIndex = calculateSynchronization();
            document.getElementById('syncIndex').textContent = (syncIndex * 100).toFixed(1) + '%';

            // Average phase
            let avgPhase = 0;
            for (const firefly of fireflies) {
                avgPhase += firefly.phase;
            }
            avgPhase = (avgPhase / fireflies.length) * (180 / Math.PI);
            document.getElementById('avgPhase').textContent = avgPhase.toFixed(0) + '°';

            // Flash rate
            const now = Date.now();
            const elapsed = (now - lastFlashTime) / 1000;
            if (elapsed > 1) {
                const flashRate = (flashCount / elapsed).toFixed(1);
                document.getElementById('flashRate').textContent = flashRate;
                flashCount = 0;
                lastFlashTime = now;
            }
        }

        function drawPhaseCircle() {
            const centerX = canvas.width - 80;
            const centerY = 80;
            const radius = 50;

            // Draw circle
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
            ctx.stroke();

            // Draw average phase vector
            let avgSin = 0;
            let avgCos = 0;
            for (const firefly of fireflies) {
                avgSin += Math.sin(firefly.phase);
                avgCos += Math.cos(firefly.phase);
            }
            avgSin /= fireflies.length;
            avgCos /= fireflies.length;

            const magnitude = Math.sqrt(avgSin * avgSin + avgCos * avgCos);

            ctx.strokeStyle = '#FFFF00';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(
                centerX + avgCos * radius * magnitude,
                centerY + avgSin * radius * magnitude
            );
            ctx.stroke();

            // Draw label
            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Phase', centerX, centerY + radius + 20);
            ctx.fillText('Coherence', centerX, centerY + radius + 35);
        }

        function animate() {
            fps.update();
            if (!isPaused) {
                // Fade previous frame for trail effect
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Update all fireflies
                fireflies.forEach(firefly => firefly.update(fireflies));

                // Draw all fireflies
                fireflies.forEach(firefly => firefly.draw());

                // Draw phase coherence indicator
                drawPhaseCircle();

                updateMetrics();
            }

            requestAnimationFrame(animate);
        }

        document.getElementById('pauseBtn').addEventListener('click', function() {
            isPaused = !isPaused;
            this.textContent = isPaused ? 'Resume' : 'Pause';
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            initFireflies();
        });

        document.getElementById('couplingSlider').addEventListener('input', function() {
            coupling = parseInt(this.value) / 100;
            document.getElementById('couplingValue').textContent = coupling.toFixed(2);
        });

        initFireflies();
        animate();
    </script>
<script src="../assets/js/seizure-warning.js"></script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>