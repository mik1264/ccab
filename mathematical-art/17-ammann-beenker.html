<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ammann-Beenker Tiling & Diffraction - CCAB</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #e8e6e1;
            min-height: 100vh;
            overflow: hidden;
        }

        .back-link {
            position: fixed;
            top: 15px;
            left: 15px;
            padding: 10px 18px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: #fbbf24;
            text-decoration: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            transition: all 0.3s ease;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .back-link:hover {
            background: rgba(251, 191, 36, 0.2);
            transform: translateX(-5px);
        }

        .container {
            display: flex;
            height: 100vh;
            padding: 70px 20px 20px;
            gap: 20px;
        }

        .main-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .canvas-row {
            display: flex;
            gap: 15px;
            flex: 1;
        }

        .canvas-container {
            flex: 1;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
        }

        .canvas-container h3 {
            color: #fbbf24;
            font-size: 13px;
            margin-bottom: 8px;
            text-align: center;
        }

        canvas {
            flex: 1;
            width: 100%;
            background: #0a0a15;
            border-radius: 8px;
        }

        .sidebar {
            width: 280px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .controls {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .controls h2 {
            font-size: 15px;
            color: #fbbf24;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .control-group {
            margin-bottom: 12px;
        }

        .control-group label {
            display: block;
            font-size: 11px;
            color: #aaa;
            margin-bottom: 4px;
        }

        .control-group input[type="range"] {
            width: 100%;
            height: 5px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #fbbf24;
            border-radius: 50%;
            cursor: pointer;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 11px;
            color: #ccc;
            margin-bottom: 6px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 14px;
            height: 14px;
            accent-color: #fbbf24;
        }

        button {
            width: 100%;
            padding: 8px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border: none;
            border-radius: 6px;
            color: #1a1a2e;
            font-weight: 600;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            margin-top: 6px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4);
        }

        .info-panel {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            flex: 1;
            overflow-y: auto;
        }

        .info-panel h3 {
            color: #fbbf24;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .info-panel p {
            font-size: 11px;
            color: #aaa;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .tile-legend {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .tile-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            color: #aaa;
        }

        .tile-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-item .label {
            font-size: 9px;
            color: #888;
        }

        .stat-item .value {
            font-size: 12px;
            color: #fbbf24;
            font-family: 'Courier New', monospace;
        }

        @media (max-width: 900px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                flex-direction: row;
                flex-wrap: wrap;
            }

            .controls, .info-panel {
                flex: 1;
                min-width: 200px;
            }
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back to Gallery</a>

    <div class="container">
        <div class="main-view">
            <div class="canvas-row">
                <div class="canvas-container">
                    <h3>Ammann-Beenker Tiling (8-fold Quasicrystal)</h3>
                    <canvas id="tilingCanvas"></canvas>
                </div>
                <div class="canvas-container">
                    <h3>Diffraction Pattern (Fourier Transform)</h3>
                    <canvas id="diffractionCanvas"></canvas>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <div class="controls">
                <h2>Tiling Controls</h2>

                <div class="control-group">
                    <label>Iterations: <span id="iterVal">4</span></label>
                    <input type="range" id="iterations" min="1" max="6" value="4">
                </div>

                <div class="control-group">
                    <label>Tile Size: <span id="sizeVal">40</span></label>
                    <input type="range" id="tileSize" min="10" max="80" value="40">
                </div>

                <div class="control-group">
                    <label>Rotation: <span id="rotVal">0</span>°</label>
                    <input type="range" id="rotation" min="0" max="360" value="0">
                </div>

                <div class="control-group checkbox-group">
                    <label>
                        <input type="checkbox" id="showOutlines" checked>
                        Show Tile Outlines
                    </label>
                    <label>
                        <input type="checkbox" id="showArrows">
                        Show Matching Arrows
                    </label>
                    <label>
                        <input type="checkbox" id="colorByType" checked>
                        Color by Tile Type
                    </label>
                </div>

                <button id="regenerate">Regenerate</button>
            </div>

            <div class="info-panel">
                <h3>About Ammann-Beenker</h3>
                <p>
                    The Ammann-Beenker tiling is a quasiperiodic tiling with 8-fold rotational symmetry.
                    It uses two tile types: <strong>squares</strong> and <strong>45° rhombi</strong>.
                </p>
                <p>
                    The substitution factor is <strong>1 + √2 ≈ 2.414</strong> (the "silver mean").
                    Unlike periodic tilings, it never repeats but still has long-range order.
                </p>
                <p>
                    The diffraction pattern shows the characteristic 8-fold symmetric Bragg peaks
                    that proved quasicrystals exist in nature (Nobel Prize 2011).
                </p>

                <div class="tile-legend">
                    <div class="tile-item">
                        <div class="tile-color" style="background: #4ecdc4;"></div>
                        Square
                    </div>
                    <div class="tile-item">
                        <div class="tile-color" style="background: #ff6b6b;"></div>
                        Rhombus
                    </div>
                </div>

                <div class="stats">
                    <div class="stat-item">
                        <div class="label">Squares</div>
                        <div class="value" id="squareCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">Rhombi</div>
                        <div class="value" id="rhombusCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">Ratio</div>
                        <div class="value" id="tileRatio">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">Silver Mean</div>
                        <div class="value">2.414</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const tilingCanvas = document.getElementById('tilingCanvas');
        const tilingCtx = tilingCanvas.getContext('2d');
        const diffCanvas = document.getElementById('diffractionCanvas');
        const diffCtx = diffCanvas.getContext('2d');

        // State
        let iterations = 4;
        let baseTileSize = 40;
        let rotation = 0;
        let showOutlines = true;
        let showArrows = false;
        let colorByType = true;
        let tiles = [];

        // Constants
        const SILVER = 1 + Math.sqrt(2); // Silver mean
        const ANGLE = Math.PI / 4; // 45 degrees

        // Tile types
        const SQUARE = 'square';
        const RHOMBUS = 'rhombus';

        // Resize canvases
        function resizeCanvases() {
            const dpr = window.devicePixelRatio || 1;

            [tilingCanvas, diffCanvas].forEach(canvas => {
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width * dpr;
                canvas.height = rect.height * dpr;
                canvas.getContext('2d').scale(dpr, dpr);
            });
        }

        window.addEventListener('resize', () => {
            resizeCanvases();
            generateTiling();
        });

        // Generate Ammann-Beenker tiling using substitution rules
        function generateTiling() {
            tiles = [];

            const width = tilingCanvas.width / (window.devicePixelRatio || 1);
            const height = tilingCanvas.height / (window.devicePixelRatio || 1);
            const cx = width / 2;
            const cy = height / 2;

            // Start with initial tiles (8-fold symmetric seed)
            const size = baseTileSize * Math.pow(SILVER, iterations - 1);

            // Create 8 initial rhombi around center
            for (let i = 0; i < 8; i++) {
                const angle = i * Math.PI / 4 + rotation * Math.PI / 180;
                const x = cx;
                const y = cy;
                tiles.push({
                    type: RHOMBUS,
                    x: x,
                    y: y,
                    angle: angle,
                    size: size
                });
            }

            // Apply substitution rules
            for (let iter = 0; iter < iterations; iter++) {
                tiles = subdivideTiles(tiles);
            }

            // Filter tiles to visible area
            const margin = baseTileSize * 2;
            tiles = tiles.filter(t =>
                t.x > -margin && t.x < width + margin &&
                t.y > -margin && t.y < height + margin
            );

            drawTiling();
            drawDiffraction();
            updateStats();
        }

        // Subdivide tiles using Ammann-Beenker substitution
        function subdivideTiles(inputTiles) {
            const newTiles = [];
            const scale = 1 / SILVER;

            inputTiles.forEach(tile => {
                if (tile.type === SQUARE) {
                    // Square subdivides into 1 square + 4 rhombi
                    const newSize = tile.size * scale;
                    const cos = Math.cos(tile.angle);
                    const sin = Math.sin(tile.angle);

                    // Central square
                    newTiles.push({
                        type: SQUARE,
                        x: tile.x,
                        y: tile.y,
                        angle: tile.angle,
                        size: newSize
                    });

                    // 4 corner rhombi
                    for (let i = 0; i < 4; i++) {
                        const cornerAngle = tile.angle + i * Math.PI / 2 + Math.PI / 4;
                        const dist = newSize * (1 + 1 / Math.sqrt(2));
                        newTiles.push({
                            type: RHOMBUS,
                            x: tile.x + Math.cos(cornerAngle) * dist * 0.7,
                            y: tile.y + Math.sin(cornerAngle) * dist * 0.7,
                            angle: cornerAngle - Math.PI / 8,
                            size: newSize
                        });
                    }
                } else {
                    // Rhombus subdivides into 1 square + 2 rhombi
                    const newSize = tile.size * scale;

                    // Central square
                    newTiles.push({
                        type: SQUARE,
                        x: tile.x,
                        y: tile.y,
                        angle: tile.angle + Math.PI / 8,
                        size: newSize * 0.9
                    });

                    // 2 end rhombi
                    for (let i = -1; i <= 1; i += 2) {
                        const dist = newSize * 1.2;
                        const offsetAngle = tile.angle + i * ANGLE / 2;
                        newTiles.push({
                            type: RHOMBUS,
                            x: tile.x + Math.cos(tile.angle) * dist * i * 0.5,
                            y: tile.y + Math.sin(tile.angle) * dist * i * 0.5,
                            angle: offsetAngle,
                            size: newSize
                        });
                    }
                }
            });

            return newTiles;
        }

        // Draw a single tile
        function drawTile(ctx, tile, cx, cy) {
            ctx.save();
            ctx.translate(tile.x, tile.y);
            ctx.rotate(tile.angle);

            const s = tile.size;

            if (tile.type === SQUARE) {
                // Draw square
                ctx.beginPath();
                ctx.rect(-s / 2, -s / 2, s, s);

                if (colorByType) {
                    ctx.fillStyle = 'rgba(78, 205, 196, 0.6)';
                    ctx.fill();
                }

                if (showOutlines) {
                    ctx.strokeStyle = 'rgba(78, 205, 196, 0.9)';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                }
            } else {
                // Draw 45° rhombus
                const h = s * Math.sin(ANGLE);
                const w = s * Math.cos(ANGLE);

                ctx.beginPath();
                ctx.moveTo(0, -h);
                ctx.lineTo(w, 0);
                ctx.lineTo(0, h);
                ctx.lineTo(-w, 0);
                ctx.closePath();

                if (colorByType) {
                    ctx.fillStyle = 'rgba(255, 107, 107, 0.6)';
                    ctx.fill();
                }

                if (showOutlines) {
                    ctx.strokeStyle = 'rgba(255, 107, 107, 0.9)';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                }
            }

            // Draw matching arrows
            if (showArrows) {
                ctx.strokeStyle = '#fbbf24';
                ctx.lineWidth = 1.5;
                const arrowSize = s * 0.2;

                if (tile.type === SQUARE) {
                    // Arrows on square edges
                    for (let i = 0; i < 4; i++) {
                        ctx.save();
                        ctx.rotate(i * Math.PI / 2);
                        ctx.beginPath();
                        ctx.moveTo(0, -s / 2 + arrowSize);
                        ctx.lineTo(0, -s / 2);
                        ctx.lineTo(arrowSize / 2, -s / 2 + arrowSize / 2);
                        ctx.stroke();
                        ctx.restore();
                    }
                }
            }

            ctx.restore();
        }

        // Draw the full tiling
        function drawTiling() {
            const width = tilingCanvas.width / (window.devicePixelRatio || 1);
            const height = tilingCanvas.height / (window.devicePixelRatio || 1);

            tilingCtx.fillStyle = '#0a0a15';
            tilingCtx.fillRect(0, 0, width, height);

            // Draw 8-fold symmetry axes (faint)
            tilingCtx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            tilingCtx.lineWidth = 1;
            const cx = width / 2;
            const cy = height / 2;

            for (let i = 0; i < 8; i++) {
                const angle = i * Math.PI / 8 + rotation * Math.PI / 180;
                tilingCtx.beginPath();
                tilingCtx.moveTo(cx, cy);
                tilingCtx.lineTo(cx + Math.cos(angle) * width, cy + Math.sin(angle) * height);
                tilingCtx.stroke();
            }

            // Draw tiles
            tiles.forEach(tile => drawTile(tilingCtx, tile, cx, cy));

            // Title watermark
            tilingCtx.fillStyle = 'rgba(255, 255, 255, 0.03)';
            tilingCtx.font = 'bold 40px sans-serif';
            tilingCtx.textAlign = 'center';
            tilingCtx.fillText('AMMANN-BEENKER', cx, cy);
        }

        // Compute and draw diffraction pattern
        function drawDiffraction() {
            const width = diffCanvas.width / (window.devicePixelRatio || 1);
            const height = diffCanvas.height / (window.devicePixelRatio || 1);
            const cx = width / 2;
            const cy = height / 2;

            // Create image data
            const imageData = diffCtx.createImageData(width, height);
            const data = imageData.data;

            // Get tile centers as points
            const points = tiles.map(t => ({ x: t.x, y: t.y }));

            if (points.length === 0) {
                diffCtx.fillStyle = '#0a0a15';
                diffCtx.fillRect(0, 0, width, height);
                return;
            }

            // Compute 2D Fourier transform (simplified - just the magnitude)
            const maxFreq = 0.3;
            const freqStep = maxFreq * 2 / Math.min(width, height);

            let maxMag = 0;
            const magnitudes = [];

            for (let py = 0; py < height; py++) {
                for (let px = 0; px < width; px++) {
                    const kx = (px - cx) * freqStep;
                    const ky = (py - cy) * freqStep;

                    // Compute Fourier coefficient
                    let re = 0, im = 0;
                    for (const p of points) {
                        const phase = 2 * Math.PI * (kx * p.x + ky * p.y);
                        re += Math.cos(phase);
                        im += Math.sin(phase);
                    }

                    const mag = Math.sqrt(re * re + im * im);
                    magnitudes.push(mag);
                    maxMag = Math.max(maxMag, mag);
                }
            }

            // Draw with logarithmic scaling
            for (let i = 0; i < magnitudes.length; i++) {
                const mag = magnitudes[i];
                const intensity = Math.log(1 + mag) / Math.log(1 + maxMag);
                const val = Math.floor(intensity * 255);

                data[i * 4] = val;     // R
                data[i * 4 + 1] = Math.floor(val * 0.8 + intensity * 100); // G (golden tint)
                data[i * 4 + 2] = Math.floor(val * 0.3); // B
                data[i * 4 + 3] = 255; // A
            }

            diffCtx.putImageData(imageData, 0, 0);

            // Draw 8-fold symmetry indicators
            diffCtx.strokeStyle = 'rgba(251, 191, 36, 0.3)';
            diffCtx.lineWidth = 1;
            diffCtx.setLineDash([5, 5]);

            for (let i = 0; i < 8; i++) {
                const angle = i * Math.PI / 8;
                diffCtx.beginPath();
                diffCtx.moveTo(cx, cy);
                diffCtx.lineTo(cx + Math.cos(angle) * width / 2, cy + Math.sin(angle) * height / 2);
                diffCtx.stroke();
            }
            diffCtx.setLineDash([]);
        }

        // Update statistics
        function updateStats() {
            const squares = tiles.filter(t => t.type === SQUARE).length;
            const rhombi = tiles.filter(t => t.type === RHOMBUS).length;

            document.getElementById('squareCount').textContent = squares;
            document.getElementById('rhombusCount').textContent = rhombi;
            document.getElementById('tileRatio').textContent =
                rhombi > 0 ? (squares / rhombi).toFixed(3) : '-';
        }

        // Controls
        document.getElementById('iterations').addEventListener('input', (e) => {
            iterations = parseInt(e.target.value);
            document.getElementById('iterVal').textContent = iterations;
            generateTiling();
        });

        document.getElementById('tileSize').addEventListener('input', (e) => {
            baseTileSize = parseInt(e.target.value);
            document.getElementById('sizeVal').textContent = baseTileSize;
            generateTiling();
        });

        document.getElementById('rotation').addEventListener('input', (e) => {
            rotation = parseInt(e.target.value);
            document.getElementById('rotVal').textContent = rotation;
            generateTiling();
        });

        document.getElementById('showOutlines').addEventListener('change', (e) => {
            showOutlines = e.target.checked;
            drawTiling();
        });

        document.getElementById('showArrows').addEventListener('change', (e) => {
            showArrows = e.target.checked;
            drawTiling();
        });

        document.getElementById('colorByType').addEventListener('change', (e) => {
            colorByType = e.target.checked;
            drawTiling();
        });

        document.getElementById('regenerate').addEventListener('click', generateTiling);

        // Initialize
        resizeCanvases();
        generateTiling();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
