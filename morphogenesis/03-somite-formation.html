<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Somite Formation - Morphogenesis</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0a0e1a;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        canvas {
            display: block;
        }

        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #8A9A5B;
            text-decoration: none;
            font-size: 16px;
            font-weight: 600;
            z-index: 100;
            padding: 10px 20px;
            background: rgba(10, 14, 26, 0.8);
            border-radius: 25px;
            border: 2px solid #8A9A5B;
            transition: all 0.3s;
        }

        .back-link:hover {
            background: rgba(138, 154, 91, 0.2);
            transform: translateX(-5px);
        }

        .info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(10, 14, 26, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #ff69b4;
            max-width: 340px;
            z-index: 100;
        }

        .info h3 {
            color: #ff69b4;
            margin-bottom: 10px;
        }

        .description {
            font-size: 13px;
            line-height: 1.5;
            color: #ccc;
            margin-bottom: 15px;
        }

        .stat {
            font-size: 14px;
            color: #4fc3f7;
            margin: 5px 0;
        }

        .legend {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(10, 14, 26, 0.9);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #8A9A5B;
            z-index: 100;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 14px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back to Morphogenesis</a>

    <div class="info">
        <h3>Somite Formation</h3>
        <div class="description">
            The Clock and Wavefront model: A molecular oscillator (clock) combined with
            a signaling gradient (wavefront) creates periodic segments along the body axis.
            Watch as oscillating gene expression synchronizes to form discrete somites.
        </div>
        <div class="stat">Somites formed: <span id="somite-count">0</span></div>
        <div class="stat">Clock period: ~90 min</div>
    </div>

    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(to right, #ff00ff, #00ffff);"></div>
            <span>Clock Gene Expression</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(to right, #ffd700, #ff4500);"></div>
            <span>FGF/Wnt Gradient (Wavefront)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: rgba(138, 154, 91, 0.6);"></div>
            <span>Formed Somite</span>
        </div>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const somiteCountEl = document.getElementById('somite-count');

        class Cell {
            constructor(x, y, row, col) {
                this.x = x;
                this.y = y;
                this.row = row;
                this.col = col;
                this.clockPhase = Math.random() * Math.PI * 2; // Oscillator phase
                this.clockSpeed = 0.05;
                this.isSomite = false;
                this.somiteTime = 0;
                this.somiteId = -1;
            }

            update(time, wavefrontPosition) {
                if (!this.isSomite) {
                    // Update clock oscillation
                    this.clockPhase += this.clockSpeed;

                    // Check if this cell should become a somite
                    // When wavefront passes and clock is at the right phase
                    if (this.col < wavefrontPosition && this.col > wavefrontPosition - 3) {
                        const clockValue = Math.sin(this.clockPhase);
                        if (clockValue > 0.9 && !this.isSomite) {
                            this.isSomite = true;
                            this.somiteTime = time;
                            this.somiteId = Math.floor(wavefrontPosition / 3);
                        }
                    }
                }
            }

            getClockColor(time) {
                const clockValue = (Math.sin(this.clockPhase) + 1) / 2; // 0 to 1
                const r = Math.floor(255 * clockValue);
                const g = 0;
                const b = Math.floor(255 * (1 - clockValue));
                return `rgb(${r}, ${g}, ${b})`;
            }

            getWavefrontColor(wavefrontPosition) {
                // Gradient from tail (high FGF/Wnt) to head (low)
                const distance = this.col - wavefrontPosition;
                const gradientValue = Math.max(0, Math.min(1, 1 - distance / 20));
                const r = Math.floor(255 * gradientValue);
                const g = Math.floor(215 * gradientValue);
                const b = 0;
                return `rgba(${r}, ${g}, ${b}, 0.5)`;
            }

            draw(time, wavefrontPosition) {
                const size = 12;

                if (this.isSomite) {
                    // Draw as formed somite
                    ctx.fillStyle = `rgba(138, 154, 91, ${0.6 + Math.sin(time * 0.02) * 0.2})`;
                    ctx.strokeStyle = '#8A9A5B';
                    ctx.lineWidth = 2;
                } else {
                    // Show clock oscillation
                    ctx.fillStyle = this.getClockColor(time);
                    ctx.strokeStyle = this.getWavefrontColor(wavefrontPosition);
                    ctx.lineWidth = 1;
                }

                ctx.beginPath();
                ctx.rect(this.x - size / 2, this.y - size / 2, size, size);
                ctx.fill();
                ctx.stroke();
            }
        }

        // Create presomitic mesoderm (PSM)
        const cells = [];
        const rows = 20;
        const cols = 50;
        const cellSpacing = 15;
        const startX = 100;
        const startY = canvas.height / 2 - (rows * cellSpacing) / 2;

        for (let row = 0; row < rows; row++) {
            for (let col = 0; col < cols; col++) {
                const x = startX + col * cellSpacing;
                const y = startY + row * cellSpacing;
                cells.push(new Cell(x, y, row, col));
            }
        }

        let time = 0;
        let wavefrontPosition = 45; // Starts at tail, moves forward
        let somiteCount = 0;

        function drawEmbryo() {
            // Draw anterior-posterior axis
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(50, canvas.height / 2);
            ctx.lineTo(canvas.width - 50, canvas.height / 2);
            ctx.stroke();
            ctx.setLineDash([]);

            // Labels
            ctx.fillStyle = '#fff';
            ctx.font = '14px Arial';
            ctx.fillText('← Anterior (Head)', 50, canvas.height / 2 - 180);
            ctx.fillText('Posterior (Tail) →', canvas.width - 200, canvas.height / 2 - 180);

            // Draw wavefront line
            const wavefrontX = startX + wavefrontPosition * cellSpacing;
            ctx.strokeStyle = '#ffd700';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(wavefrontX, startY - 30);
            ctx.lineTo(wavefrontX, startY + rows * cellSpacing + 30);
            ctx.stroke();

            ctx.fillStyle = '#ffd700';
            ctx.font = 'bold 12px Arial';
            ctx.fillText('Determination', wavefrontX - 40, startY - 40);
            ctx.fillText('Front', wavefrontX - 15, startY - 40);

            // Draw cells
            cells.forEach(cell => {
                cell.update(time, wavefrontPosition);
                cell.draw(time, wavefrontPosition);
            });

            // Draw somite boundaries
            const somites = new Set();
            cells.forEach(cell => {
                if (cell.isSomite && cell.somiteId >= 0) {
                    somites.add(cell.somiteId);
                }
            });

            somites.forEach(id => {
                const somiteCells = cells.filter(c => c.somiteId === id);
                if (somiteCells.length > 0) {
                    const minX = Math.min(...somiteCells.map(c => c.x));
                    const maxX = Math.max(...somiteCells.map(c => c.x));

                    ctx.strokeStyle = 'rgba(138, 154, 91, 0.8)';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(maxX + 8, startY - 10);
                    ctx.lineTo(maxX + 8, startY + rows * cellSpacing + 10);
                    ctx.stroke();
                }
            });

            // Draw clock oscillation visualization
            drawClockVisualization();

            // Draw gradient visualization
            drawGradientVisualization();
        }

        function drawClockVisualization() {
            const vizX = canvas.width - 250;
            const vizY = canvas.height - 150;

            ctx.fillStyle = 'rgba(10, 14, 26, 0.8)';
            ctx.fillRect(vizX - 10, vizY - 50, 220, 120);

            ctx.strokeStyle = '#ff00ff';
            ctx.lineWidth = 2;

            ctx.fillStyle = '#ff00ff';
            ctx.font = 'bold 12px Arial';
            ctx.fillText('Segmentation Clock', vizX, vizY - 60);

            // Draw sine wave
            ctx.beginPath();
            for (let i = 0; i < 200; i++) {
                const x = vizX + i;
                const phase = (time * 0.05 + i * 0.1) % (Math.PI * 2);
                const y = vizY + Math.sin(phase) * 30;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();

            // Zero line
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(vizX, vizY);
            ctx.lineTo(vizX + 200, vizY);
            ctx.stroke();
        }

        function drawGradientVisualization() {
            const vizX = canvas.width - 250;
            const vizY = canvas.height - 300;

            ctx.fillStyle = 'rgba(10, 14, 26, 0.8)';
            ctx.fillRect(vizX - 10, vizY - 50, 220, 100);

            ctx.fillStyle = '#ffd700';
            ctx.font = 'bold 12px Arial';
            ctx.fillText('FGF/Wnt Gradient', vizX, vizY - 60);

            // Draw gradient
            const gradient = ctx.createLinearGradient(vizX + 200, vizY, vizX, vizY);
            gradient.addColorStop(0, '#ffd700');
            gradient.addColorStop(0.5, '#ff8c00');
            gradient.addColorStop(1, '#ff4500');

            ctx.fillStyle = gradient;
            ctx.fillRect(vizX, vizY - 20, 200, 40);

            ctx.fillStyle = '#fff';
            ctx.font = '11px Arial';
            ctx.fillText('Tail', vizX + 170, vizY + 35);
            ctx.fillText('Head', vizX + 5, vizY + 35);
        }

        function animate() {
            ctx.fillStyle = '#0a0e1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            drawEmbryo();

            // Move wavefront forward periodically
            if (time % 90 === 0 && wavefrontPosition > 5) {
                wavefrontPosition -= 3;
                somiteCount++;
                somiteCountEl.textContent = somiteCount;
            }

            // Reset simulation
            if (wavefrontPosition <= 5) {
                setTimeout(() => {
                    wavefrontPosition = 45;
                    somiteCount = 0;
                    cells.forEach(cell => {
                        cell.isSomite = false;
                        cell.somiteId = -1;
                        cell.clockPhase = Math.random() * Math.PI * 2;
                    });
                }, 2000);
            }

            time++;
            requestAnimationFrame(animate);
        }

        // Expose for enhance.js
        window.reset = function() { time = 0; wavefrontPosition = 45; somiteCount = 0; };

        animate();

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
