<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epithelial Folding - Morphogenesis</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0a0e1a;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        canvas {
            display: block;
        }

        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #8A9A5B;
            text-decoration: none;
            font-size: 16px;
            font-weight: 600;
            z-index: 100;
            padding: 10px 20px;
            background: rgba(10, 14, 26, 0.8);
            border-radius: 25px;
            border: 2px solid #8A9A5B;
            transition: all 0.3s;
        }

        .back-link:hover {
            background: rgba(138, 154, 91, 0.2);
            transform: translateX(-5px);
        }

        .info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(10, 14, 26, 0.9);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #ff69b4;
            max-width: 360px;
            z-index: 100;
        }

        .info h3 {
            color: #ff69b4;
            margin-bottom: 10px;
        }

        .description {
            font-size: 13px;
            line-height: 1.5;
            color: #ccc;
            margin-bottom: 10px;
        }

        .stage {
            color: #4fc3f7;
            font-weight: bold;
            margin: 5px 0;
        }

        .legend {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(10, 14, 26, 0.9);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #8A9A5B;
            z-index: 100;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 14px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back to Morphogenesis</a>

    <div class="info">
        <h3>Epithelial Folding</h3>
        <div class="description">
            Coordinated cell shape changes bend epithelial sheets into complex 3D
            structures. Apical constriction (cells narrowing at top) causes
            invagination. Witness tissue mechanics transform flat sheets into tubes,
            cups, and folds.
        </div>
        <div class="stage">Type: <span id="fold-type">Invagination</span></div>
    </div>

    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: #4fc3f7;"></div>
            <span>Epithelial Cell (apical)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #ff9800;"></div>
            <span>Constricting Cell</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #e91e63;"></div>
            <span>Myosin II (contractile)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #66bb6a;"></div>
            <span>Basal Surface</span>
        </div>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const foldTypeEl = document.getElementById('fold-type');

        class EpithelialCell {
            constructor(x, index, shouldConstrict = false) {
                this.index = index;
                this.baseX = x;
                this.x = x;
                this.apicalWidth = 20;
                this.basalWidth = 20;
                this.height = 60;
                this.apicalY = 200;
                this.basalY = this.apicalY + this.height;
                this.shouldConstrict = shouldConstrict;
                this.constrictionProgress = 0;
                this.myosinLevel = 0;
            }

            update(time, mode) {
                if (this.shouldConstrict && mode === 0) {
                    // Apical constriction for invagination
                    this.constrictionProgress = Math.min(1, this.constrictionProgress + 0.01);
                    this.myosinLevel = Math.min(1, this.myosinLevel + 0.015);

                    // Apical surface narrows
                    this.apicalWidth = 20 - this.constrictionProgress * 15;

                    // Cell becomes wedge-shaped
                    this.height = 60 + this.constrictionProgress * 20;
                } else if (mode === 1) {
                    // Evagination - reverse wedge
                    if (this.shouldConstrict) {
                        this.constrictionProgress = Math.min(1, this.constrictionProgress + 0.01);
                        this.basalWidth = 20 - this.constrictionProgress * 15;
                        this.height = 60 + this.constrictionProgress * 20;
                    }
                } else if (mode === 2) {
                    // Reset for new mode
                    this.constrictionProgress = Math.max(0, this.constrictionProgress - 0.02);
                    this.myosinLevel = Math.max(0, this.myosinLevel - 0.02);
                    this.apicalWidth = 20 - this.constrictionProgress * 15;
                    this.basalWidth = 20 - this.constrictionProgress * 15;
                    this.height = 60 + this.constrictionProgress * 20;
                }
            }

            draw(centerX, centerY, mode) {
                // Calculate position based on neighbors
                const apicalLeft = this.x - this.apicalWidth / 2;
                const apicalRight = this.x + this.apicalWidth / 2;
                const basalLeft = this.x - this.basalWidth / 2;
                const basalRight = this.x + this.basalWidth / 2;

                const apicalY = centerY - this.height / 2;
                const basalY = centerY + this.height / 2;

                // Draw cell body
                let cellColor;
                if (this.shouldConstrict && this.constrictionProgress > 0) {
                    cellColor = `rgba(255, 152, 0, ${0.3 + this.constrictionProgress * 0.5})`;
                } else {
                    cellColor = 'rgba(79, 195, 247, 0.5)';
                }

                ctx.fillStyle = cellColor;
                ctx.strokeStyle = '#0a0e1a';
                ctx.lineWidth = 2;

                ctx.beginPath();
                ctx.moveTo(apicalLeft, apicalY);
                ctx.lineTo(apicalRight, apicalY);
                ctx.lineTo(basalRight, basalY);
                ctx.lineTo(basalLeft, basalY);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();

                // Draw apical surface (darker)
                ctx.strokeStyle = '#1976d2';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(apicalLeft, apicalY);
                ctx.lineTo(apicalRight, apicalY);
                ctx.stroke();

                // Draw basal surface
                ctx.strokeStyle = '#66bb6a';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(basalLeft, basalY);
                ctx.lineTo(basalRight, basalY);
                ctx.stroke();

                // Draw myosin II accumulation at apical surface
                if (this.myosinLevel > 0.1) {
                    ctx.strokeStyle = `rgba(233, 30, 99, ${this.myosinLevel})`;
                    ctx.lineWidth = 4;
                    ctx.beginPath();
                    ctx.moveTo(apicalLeft, apicalY);
                    ctx.lineTo(apicalRight, apicalY);
                    ctx.stroke();

                    // Contractile fibers
                    for (let i = 0; i < 3; i++) {
                        const y = apicalY + i * 8;
                        ctx.strokeStyle = `rgba(233, 30, 99, ${this.myosinLevel * 0.3})`;
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.moveTo(apicalLeft + 2, y);
                        ctx.lineTo(apicalRight - 2, y);
                        ctx.stroke();
                    }
                }

                // Draw nucleus
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.beginPath();
                ctx.ellipse(this.x, centerY, 6, 8, 0, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // Create epithelial sheet
        let cells = [];
        const numCells = 40;
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;

        function initializeCells(mode) {
            cells = [];
            const cellWidth = 20;

            for (let i = 0; i < numCells; i++) {
                const x = centerX - (numCells * cellWidth) / 2 + i * cellWidth;
                let shouldConstrict = false;

                if (mode === 0) {
                    // Invagination - center cells constrict
                    shouldConstrict = i >= 15 && i <= 25;
                } else if (mode === 1) {
                    // Evagination - center cells
                    shouldConstrict = i >= 15 && i <= 25;
                }

                cells.push(new EpithelialCell(x, i, shouldConstrict));
            }
        }

        let time = 0;
        let mode = 0; // 0 = invagination, 1 = evagination
        let modeTime = 0;

        initializeCells(mode);

        function updateMode() {
            modeTime++;

            if (modeTime > 300) {
                mode = (mode + 1) % 2;
                modeTime = 0;
                initializeCells(mode);

                if (mode === 0) {
                    foldTypeEl.textContent = 'Invagination (inward fold)';
                } else {
                    foldTypeEl.textContent = 'Evagination (outward fold)';
                }
            }
        }

        function drawTissue() {
            // Calculate cell positions based on constriction
            let currentX = centerX - (numCells * 20) / 2;

            cells.forEach((cell, i) => {
                cell.x = currentX + cell.apicalWidth / 2;
                currentX += cell.apicalWidth;

                cell.update(time, mode);
            });

            // Adjust positions to create smooth curvature
            if (mode === 0) {
                // Invagination - push down
                cells.forEach((cell, i) => {
                    if (cell.shouldConstrict) {
                        const relativePos = (i - 20) / 5;
                        const curvature = (1 - relativePos * relativePos) * cell.constrictionProgress;
                        cell.apicalY = 200 + curvature * 100;
                        cell.basalY = cell.apicalY + cell.height;
                    } else {
                        cell.apicalY = 200;
                        cell.basalY = cell.apicalY + cell.height;
                    }
                });
            } else if (mode === 1) {
                // Evagination - push up
                cells.forEach((cell, i) => {
                    if (cell.shouldConstrict) {
                        const relativePos = (i - 20) / 5;
                        const curvature = (1 - relativePos * relativePos) * cell.constrictionProgress;
                        cell.apicalY = 200 - curvature * 100;
                        cell.basalY = cell.apicalY + cell.height;
                    } else {
                        cell.apicalY = 200;
                        cell.basalY = cell.apicalY + cell.height;
                    }
                });
            }

            // Draw cells
            cells.forEach(cell => {
                cell.draw(centerX, (cell.apicalY + cell.basalY) / 2, mode);
            });

            // Draw labels
            drawLabels();
        }

        function drawLabels() {
            ctx.fillStyle = '#fff';
            ctx.font = '14px Arial';

            // Surface labels
            ctx.fillStyle = '#1976d2';
            ctx.fillText('Apical Surface', 50, 180);

            ctx.fillStyle = '#66bb6a';
            ctx.fillText('Basal Surface', 50, 290);

            // Arrows
            if (cells[20] && cells[20].shouldConstrict && cells[20].myosinLevel > 0.3) {
                const cell = cells[20];
                const apicalY = cell.apicalY - cell.height / 2;

                ctx.fillStyle = '#e91e63';
                ctx.font = '12px Arial';
                ctx.fillText('Myosin II', cell.x + 40, apicalY - 20);
                ctx.fillText('contraction →', cell.x + 40, apicalY - 5);

                drawArrow(cell.x + 135, apicalY - 10, cell.x + 15, apicalY, '#e91e63');
            }

            // Process description
            if (modeTime > 50 && modeTime < 250) {
                const descX = canvas.width - 350;
                const descY = canvas.height / 2 - 50;

                ctx.fillStyle = 'rgba(10, 14, 26, 0.9)';
                ctx.fillRect(descX - 20, descY - 40, 330, 180);

                ctx.fillStyle = '#ff9800';
                ctx.font = 'bold 14px Arial';
                ctx.fillText('Mechanism:', descX, descY - 50);

                ctx.fillStyle = '#fff';
                ctx.font = '13px Arial';
                const steps = [
                    '1. Myosin II accumulates at apex',
                    '2. Apical surface contracts',
                    '3. Cell becomes wedge-shaped',
                    '4. Tissue bends inward/outward',
                    '5. Invagination/evagination forms'
                ];

                steps.forEach((step, i) => {
                    ctx.fillText(step, descX, descY + i * 25);
                });
            }
        }

        function drawArrow(x1, y1, x2, y2, color) {
            ctx.strokeStyle = color;
            ctx.fillStyle = color;
            ctx.lineWidth = 2;

            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();

            const angle = Math.atan2(y2 - y1, x2 - x1);
            ctx.beginPath();
            ctx.moveTo(x2, y2);
            ctx.lineTo(x2 - 10 * Math.cos(angle - Math.PI / 6), y2 - 10 * Math.sin(angle - Math.PI / 6));
            ctx.lineTo(x2 - 10 * Math.cos(angle + Math.PI / 6), y2 - 10 * Math.sin(angle + Math.PI / 6));
            ctx.closePath();
            ctx.fill();
        }

        function drawCellShapeDiagram() {
            const diagX = 100;
            const diagY = canvas.height - 180;

            ctx.fillStyle = 'rgba(10, 14, 26, 0.9)';
            ctx.fillRect(diagX - 20, diagY - 40, 300, 160);

            ctx.fillStyle = '#4fc3f7';
            ctx.font = 'bold 14px Arial';
            ctx.fillText('Cell Shape Changes', diagX, diagY - 50);

            // Before
            ctx.fillStyle = '#fff';
            ctx.font = '12px Arial';
            ctx.fillText('Before:', diagX, diagY);

            ctx.fillStyle = 'rgba(79, 195, 247, 0.5)';
            ctx.fillRect(diagX + 60, diagY - 30, 20, 40);
            ctx.strokeStyle = '#1976d2';
            ctx.lineWidth = 2;
            ctx.strokeRect(diagX + 60, diagY - 30, 20, 40);

            // After
            ctx.fillStyle = '#fff';
            ctx.fillText('After (constricted):', diagX, diagY + 70);

            ctx.fillStyle = 'rgba(255, 152, 0, 0.5)';
            ctx.beginPath();
            ctx.moveTo(diagX + 65, diagY + 40);
            ctx.lineTo(diagX + 75, diagY + 40);
            ctx.lineTo(diagX + 80, diagY + 90);
            ctx.lineTo(diagX + 60, diagY + 90);
            ctx.closePath();
            ctx.fill();
            ctx.strokeStyle = '#e65100';
            ctx.lineWidth = 2;
            ctx.stroke();

            // Myosin at apex
            ctx.strokeStyle = '#e91e63';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(diagX + 65, diagY + 40);
            ctx.lineTo(diagX + 75, diagY + 40);
            ctx.stroke();
        }

        function animate() {
            ctx.fillStyle = '#0a0e1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            updateMode();
            drawTissue();
            drawCellShapeDiagram();

            time++;
            requestAnimationFrame(animate);
        }

        animate();

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
