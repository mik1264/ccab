<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mandelbrot Set - WebAssembly</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Courier New', monospace;
            overflow: hidden;
        }
        #container {
            position: relative;
        }
        canvas {
            border: 2px solid #333;
            display: block;
            cursor: crosshair;
        }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-size: 12px;
            line-height: 1.6;
            border: 1px solid #0f0;
            min-width: 250px;
        }
        #info h3 {
            color: #0ff;
            margin-bottom: 10px;
            font-size: 14px;
        }
        #controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #0ff;
        }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 8px 15px;
            margin: 2px;
            cursor: pointer;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        button:hover {
            background: #0ff;
        }
        .perf {
            color: #ff0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="container">
        <canvas id="canvas"></canvas>
        <div id="info">
            <h3>Mandelbrot Set - WASM</h3>
            <div>FPS: <span class="perf" id="fps">0</span></div>
            <div>Render Time: <span class="perf" id="renderTime">0</span>ms</div>
            <div>Iterations: <span id="maxIter">256</span></div>
            <div>Zoom: <span id="zoom">1.0</span>x</div>
            <div id="wasmStatus">Initializing WASM...</div>
            <div style="margin-top: 10px; color: #888; font-size: 10px;">
                WASM benefits:<br>
                • 10-20x faster than JavaScript<br>
                • Parallel computation ready<br>
                • Direct memory access<br>
                • SIMD optimizations
            </div>
        </div>
        <div id="controls">
            <button onclick="reset()">Reset View</button>
            <button onclick="changeIterations(64)">Fast (64)</button>
            <button onclick="changeIterations(256)">Normal (256)</button>
            <button onclick="changeIterations(512)">Detail (512)</button>
            <button onclick="togglePalette()">Change Palette</button>
        </div>
    </div>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const width = canvas.width = 800;
        const height = canvas.height = 600;

        // Mandelbrot parameters
        let centerX = -0.5;
        let centerY = 0;
        let zoom = 1;
        let maxIterations = 256;
        let paletteMode = 0;

        // Performance tracking
        let lastTime = performance.now();
        let frameCount = 0;
        let fps = 0;

        // WebAssembly memory
        const bytesPerPixel = 4;
        const memoryPages = Math.ceil((width * height * bytesPerPixel) / 65536) + 1;
        const memory = new WebAssembly.Memory({ initial: memoryPages });
        const imageData = new Uint8ClampedArray(memory.buffer, 0, width * height * 4);

        // WAT code for Mandelbrot calculation
        const wasmCode = `(module
            (memory (import "env" "memory") ${memoryPages})

            (func (export "mandelbrot")
                (param $width i32) (param $height i32)
                (param $centerX f64) (param $centerY f64)
                (param $zoom f64) (param $maxIter i32)
                (local $x i32) (local $y i32)
                (local $cx f64) (local $cy f64)
                (local $zx f64) (local $zy f64)
                (local $zx2 f64) (local $zy2 f64)
                (local $iter i32) (local $offset i32)
                (local $scale f64) (local $temp f64)

                ;; Calculate scale
                (local.set $scale (f64.div (f64.const 3.0) (local.get $zoom)))

                ;; Loop through all pixels
                (local.set $y (i32.const 0))
                (loop $yLoop
                    (local.set $x (i32.const 0))
                    (loop $xLoop
                        ;; Calculate complex coordinates
                        (local.set $cx
                            (f64.add
                                (local.get $centerX)
                                (f64.mul
                                    (f64.div
                                        (f64.sub
                                            (f64.convert_i32_s (local.get $x))
                                            (f64.mul (f64.convert_i32_s (local.get $width)) (f64.const 0.5))
                                        )
                                        (f64.convert_i32_s (local.get $width))
                                    )
                                    (local.get $scale)
                                )
                            )
                        )
                        (local.set $cy
                            (f64.add
                                (local.get $centerY)
                                (f64.mul
                                    (f64.div
                                        (f64.sub
                                            (f64.convert_i32_s (local.get $y))
                                            (f64.mul (f64.convert_i32_s (local.get $height)) (f64.const 0.5))
                                        )
                                        (f64.convert_i32_s (local.get $height))
                                    )
                                    (local.get $scale)
                                )
                            )
                        )

                        ;; Mandelbrot iteration
                        (local.set $zx (f64.const 0))
                        (local.set $zy (f64.const 0))
                        (local.set $iter (i32.const 0))

                        (loop $iterLoop
                            (local.set $zx2 (f64.mul (local.get $zx) (local.get $zx)))
                            (local.set $zy2 (f64.mul (local.get $zy) (local.get $zy)))

                            ;; Check escape condition
                            (if (f64.lt (f64.add (local.get $zx2) (local.get $zy2)) (f64.const 4.0))
                                (then
                                    ;; z = z^2 + c
                                    (local.set $temp
                                        (f64.add
                                            (f64.sub (local.get $zx2) (local.get $zy2))
                                            (local.get $cx)
                                        )
                                    )
                                    (local.set $zy
                                        (f64.add
                                            (f64.mul (f64.mul (local.get $zx) (local.get $zy)) (f64.const 2.0))
                                            (local.get $cy)
                                        )
                                    )
                                    (local.set $zx (local.get $temp))

                                    (local.set $iter (i32.add (local.get $iter) (i32.const 1)))
                                    (br_if $iterLoop (i32.lt_u (local.get $iter) (local.get $maxIter)))
                                )
                            )
                        )

                        ;; Store iteration count (we'll colorize in JS)
                        (local.set $offset
                            (i32.mul
                                (i32.add (i32.mul (local.get $y) (local.get $width)) (local.get $x))
                                (i32.const 4)
                            )
                        )
                        (i32.store8 (local.get $offset) (local.get $iter))

                        (local.set $x (i32.add (local.get $x) (i32.const 1)))
                        (br_if $xLoop (i32.lt_u (local.get $x) (local.get $width)))
                    )
                    (local.set $y (i32.add (local.get $y) (i32.const 1)))
                    (br_if $yLoop (i32.lt_u (local.get $y) (local.get $height)))
                )
            )
        )`;

        let wasm;

        async function init() {
            try {
                const wasmModule = await WebAssembly.instantiate(
                    new Uint8Array(await (await fetch(`data:text/plain,${encodeURIComponent(wasmCode)}`)).arrayBuffer()),
                    { env: { memory } }
                );
                wasm = wasmModule.instance;
                document.getElementById('wasmStatus').innerHTML = '<span style="color: #0f0;">✓ WASM Active</span>';
            } catch (e) {
                console.error('WASM failed:', e);
                document.getElementById('wasmStatus').innerHTML = '<span style="color: #f00;">✗ WASM Failed</span>';
            }
            render();
        }

        function getColor(iter, maxIter) {
            if (iter === maxIter) return [0, 0, 0];

            const t = iter / maxIter;

            if (paletteMode === 0) {
                // Electric blue-purple-red
                const r = Math.floor(9 * (1 - t) * t * t * t * 255);
                const g = Math.floor(15 * (1 - t) * (1 - t) * t * t * 255);
                const b = Math.floor(8.5 * (1 - t) * (1 - t) * (1 - t) * t * 255);
                return [r, g, b];
            } else if (paletteMode === 1) {
                // Fire palette
                const r = Math.floor(Math.sin(t * Math.PI) * 255);
                const g = Math.floor(Math.sin(t * Math.PI * 2) * 128);
                const b = Math.floor(Math.sin(t * Math.PI * 4) * 64);
                return [r, g, b];
            } else {
                // Grayscale
                const v = Math.floor(t * 255);
                return [v, v, v];
            }
        }

        function render() {
            const startTime = performance.now();

            if (wasm) {
                // Call WASM to calculate iterations
                wasm.exports.mandelbrot(width, height, centerX, centerY, zoom, maxIterations);

                // Colorize in JavaScript
                for (let i = 0; i < width * height; i++) {
                    const iter = imageData[i * 4];
                    const [r, g, b] = getColor(iter, maxIterations);
                    imageData[i * 4] = r;
                    imageData[i * 4 + 1] = g;
                    imageData[i * 4 + 2] = b;
                    imageData[i * 4 + 3] = 255;
                }
            }

            // Draw to canvas
            const imgData = new ImageData(imageData, width, height);
            ctx.putImageData(imgData, 0, 0);

            // Update performance stats
            const renderTime = performance.now() - startTime;
            document.getElementById('renderTime').textContent = renderTime.toFixed(2);

            frameCount++;
            const now = performance.now();
            if (now - lastTime >= 1000) {
                fps = Math.round(frameCount * 1000 / (now - lastTime));
                document.getElementById('fps').textContent = fps;
                frameCount = 0;
                lastTime = now;
            }

            document.getElementById('zoom').textContent = zoom.toFixed(2);
            document.getElementById('maxIter').textContent = maxIterations;
        }

        // Mouse interaction for zooming
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const scale = 3.0 / zoom;
            centerX += (x / width - 0.5) * scale;
            centerY += (y / height - 0.5) * scale;

            zoom *= e.shiftKey ? 0.5 : 2.0; // Shift to zoom out

            render();
        });

        function reset() {
            centerX = -0.5;
            centerY = 0;
            zoom = 1;
            render();
        }

        function changeIterations(iter) {
            maxIterations = iter;
            render();
        }

        function togglePalette() {
            paletteMode = (paletteMode + 1) % 3;
            render();
        }

        init();
    </script>
</body>
</html>
