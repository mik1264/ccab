<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hash Collision Visualization - WebAssembly</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #0a0a0a;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: monospace;
        }
        #container {
            text-align: center;
        }
        canvas {
            border: 2px solid #1a1a1a;
            display: block;
            margin: 20px auto;
        }
        #stats {
            color: #0f0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="container">
        <canvas id="canvas"></canvas>
        <div id="stats"></div>
    </div>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const width = canvas.width = 1200;
        const height = canvas.height = 800;

        const HASH_TABLE_SIZE = 256;
        const hashTable = new Array(HASH_TABLE_SIZE).fill(0).map(() => []);

        // WebAssembly hash functions
        const memory = new WebAssembly.Memory({ initial: 1 });

        const wasmCode = new Uint8Array([
            // Simple WASM module with hash function
            0x00, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00, 0x01, 0x06, 0x01, 0x60,
            0x01, 0x7f, 0x01, 0x7f, 0x03, 0x02, 0x01, 0x00, 0x07, 0x08, 0x01, 0x04,
            0x68, 0x61, 0x73, 0x68, 0x00, 0x00, 0x0a, 0x2a, 0x01, 0x28, 0x01, 0x01,
            0x7f, 0x20, 0x00, 0x41, 0x1f, 0x6c, 0x41, 0xcd, 0x08, 0x6a, 0x21, 0x01,
            0x20, 0x01, 0x20, 0x01, 0x41, 0x10, 0x76, 0x73, 0x21, 0x01, 0x20, 0x01,
            0x41, 0xe1, 0x19, 0x6c, 0x21, 0x01, 0x20, 0x01, 0x20, 0x01, 0x41, 0x0d,
            0x76, 0x73, 0x21, 0x01, 0x20, 0x01, 0x41, 0xff, 0x01, 0x71, 0x0b
        ]);

        let wasm;
        let insertCount = 0;
        let collisions = 0;

        async function init() {
            try {
                const module = await WebAssembly.instantiate(wasmCode);
                wasm = module.instance;
            } catch (e) {
                console.log('WASM fallback');
            }
            animate();
        }

        function hash(key) {
            if (wasm) {
                return wasm.exports.hash(key);
            }
            // JavaScript fallback
            let h = key * 31 + 1101;
            h ^= h >>> 16;
            h *= 7919;
            h ^= h >>> 13;
            return h & 0xFF;
        }

        function insert() {
            const key = Math.floor(Math.random() * 10000);
            const hashValue = hash(key);

            if (hashTable[hashValue].length > 0) {
                collisions++;
            }

            hashTable[hashValue].push(key);
            insertCount++;
        }

        function animate() {
            // Insert items
            for (let i = 0; i < 5; i++) {
                if (insertCount < 1000) {
                    insert();
                }
            }

            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(0, 0, width, height);

            // Draw hash table as bars
            const barWidth = width / HASH_TABLE_SIZE;
            const maxHeight = height - 100;

            let maxChainLength = 1;
            for (let i = 0; i < HASH_TABLE_SIZE; i++) {
                maxChainLength = Math.max(maxChainLength, hashTable[i].length);
            }

            for (let i = 0; i < HASH_TABLE_SIZE; i++) {
                const chainLength = hashTable[i].length;
                const barHeight = (chainLength / maxChainLength) * maxHeight;

                const x = i * barWidth;
                const y = height - 80 - barHeight;

                // Color based on collision intensity
                let color;
                if (chainLength === 0) {
                    color = '#111';
                } else if (chainLength === 1) {
                    color = '#0f0';
                } else if (chainLength === 2) {
                    color = '#ff0';
                } else if (chainLength === 3) {
                    color = '#f80';
                } else {
                    color = '#f00';
                }

                ctx.fillStyle = color;
                ctx.fillRect(x, y, Math.ceil(barWidth) - 1, barHeight);

                // Draw chain length numbers for tall bars
                if (chainLength > 2) {
                    ctx.fillStyle = '#fff';
                    ctx.font = '10px monospace';
                    ctx.fillText(chainLength, x + barWidth / 4, y - 5);
                }
            }

            // Draw distribution curve
            ctx.strokeStyle = 'rgba(0, 255, 255, 0.5)';
            ctx.lineWidth = 2;
            ctx.beginPath();

            for (let i = 0; i < HASH_TABLE_SIZE; i++) {
                const chainLength = hashTable[i].length;
                const barHeight = (chainLength / maxChainLength) * maxHeight;
                const x = i * barWidth + barWidth / 2;
                const y = height - 80 - barHeight;

                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();

            // Stats
            const loadFactor = (insertCount / HASH_TABLE_SIZE).toFixed(2);
            const avgChainLength = (insertCount / HASH_TABLE_SIZE).toFixed(2);
            const collisionRate = ((collisions / insertCount) * 100).toFixed(1);

            const emptyBuckets = hashTable.filter(bucket => bucket.length === 0).length;

            ctx.fillStyle = '#0f0';
            ctx.font = '14px monospace';
            ctx.textAlign = 'left';
            const statsY = height - 50;

            document.getElementById('stats').innerHTML = `
                Insertions: ${insertCount} |
                Collisions: ${collisions} (${collisionRate}%) |
                Load Factor: ${loadFactor} |
                Avg Chain: ${avgChainLength} |
                Empty Buckets: ${emptyBuckets} |
                Max Chain: ${maxChainLength} |
                ${wasm ? 'WASM Hash' : 'JS Hash'}
            `;

            requestAnimationFrame(animate);
        }

        init();
    </script>
    <script src="../../assets/js/enhance.js" defer></script>
</body>
</html>
