<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mandelbrot Set - WebAssembly</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: monospace;
            color: #fff;
        }
        #container {
            text-align: center;
        }
        canvas {
            border: 2px solid #333;
            cursor: crosshair;
        }
        #info {
            margin-top: 10px;
            font-size: 12px;
            color: #aaa;
        }
    </style>
</head>
<body>
    <div id="container">
        <canvas id="canvas"></canvas>
        <div id="info">Click to zoom | WebAssembly-powered Mandelbrot Set</div>
    </div>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const width = canvas.width = 800;
        const height = canvas.height = 600;

        let centerX = -0.5;
        let centerY = 0;
        let zoom = 1.5;

        // WebAssembly module
        const wasmCode = new Uint8Array([
            0x00, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00, 0x01, 0x0d, 0x02, 0x60,
            0x04, 0x7d, 0x7d, 0x7d, 0x7d, 0x01, 0x7f, 0x60, 0x00, 0x00, 0x03, 0x02,
            0x01, 0x00, 0x07, 0x0e, 0x01, 0x0a, 0x6d, 0x61, 0x6e, 0x64, 0x65, 0x6c,
            0x62, 0x72, 0x6f, 0x74, 0x00, 0x00, 0x0a, 0x4e, 0x01, 0x4c, 0x01, 0x05,
            0x7d, 0x43, 0x00, 0x00, 0x00, 0x00, 0x21, 0x04, 0x43, 0x00, 0x00, 0x00,
            0x00, 0x21, 0x05, 0x41, 0x00, 0x21, 0x06, 0x03, 0x40, 0x20, 0x04, 0x20,
            0x04, 0x94, 0x20, 0x05, 0x20, 0x05, 0x94, 0x93, 0x43, 0x00, 0x00, 0x80,
            0x40, 0x5e, 0x04, 0x40, 0x20, 0x06, 0x0f, 0x0b, 0x20, 0x04, 0x20, 0x04,
            0x94, 0x20, 0x05, 0x20, 0x05, 0x94, 0x93, 0x20, 0x00, 0x92, 0x21, 0x07,
            0x43, 0x00, 0x00, 0x00, 0x40, 0x20, 0x04, 0x94, 0x20, 0x05, 0x94, 0x20,
            0x01, 0x92, 0x21, 0x05, 0x20, 0x07, 0x21, 0x04, 0x20, 0x06, 0x41, 0x01,
            0x6a, 0x22, 0x06, 0x20, 0x02, 0x49, 0x0d, 0x00, 0x0b, 0x20, 0x03, 0x0b
        ]);

        let wasmInstance;

        async function initWasm() {
            const wasmModule = await WebAssembly.instantiate(wasmCode);
            wasmInstance = wasmModule.instance;
            render();
        }

        function mandelbrot(x0, y0, maxIter) {
            return wasmInstance.exports.mandelbrot(x0, y0, maxIter, maxIter);
        }

        function hslToRgb(h, s, l) {
            let r, g, b;
            if (s === 0) {
                r = g = b = l;
            } else {
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1/6) return p + (q - p) * 6 * t;
                    if (t < 1/2) return q;
                    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                };
                const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                const p = 2 * l - q;
                r = hue2rgb(p, q, h + 1/3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1/3);
            }
            return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
        }

        function render() {
            const imageData = ctx.createImageData(width, height);
            const maxIter = 256;

            for (let py = 0; py < height; py++) {
                for (let px = 0; px < width; px++) {
                    const x0 = centerX + (px - width / 2) / (width / 4) / zoom;
                    const y0 = centerY + (py - height / 2) / (height / 4) / zoom;

                    const iter = mandelbrot(x0, y0, maxIter);

                    const idx = (py * width + px) * 4;
                    if (iter === maxIter) {
                        imageData.data[idx] = 0;
                        imageData.data[idx + 1] = 0;
                        imageData.data[idx + 2] = 0;
                    } else {
                        const hue = iter / maxIter;
                        const [r, g, b] = hslToRgb(hue, 1, 0.5);
                        imageData.data[idx] = r;
                        imageData.data[idx + 1] = g;
                        imageData.data[idx + 2] = b;
                    }
                    imageData.data[idx + 3] = 255;
                }
            }

            ctx.putImageData(imageData, 0, 0);
        }

        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const px = e.clientX - rect.left;
            const py = e.clientY - rect.top;

            centerX += (px - width / 2) / (width / 4) / zoom;
            centerY += (py - height / 2) / (height / 4) / zoom;
            zoom *= 2;

            render();
        });

        initWasm();
    </script>
</body>
</html>
