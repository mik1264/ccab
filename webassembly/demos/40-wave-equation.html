<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wave Equation - WebAssembly</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000510;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }
        canvas {
            border: 2px solid #003050;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const width = canvas.width = 1000;
        const height = canvas.height = 700;

        const gridWidth = 100;
        const gridHeight = 70;

        const current = new Float32Array(gridWidth * gridHeight);
        const previous = new Float32Array(gridWidth * gridHeight);
        const velocity = new Float32Array(gridWidth * gridHeight);

        const waveSpeed = 0.5;
        const damping = 0.99;

        for (let i = 0; i < gridWidth * gridHeight; i++) {
            current[i] = 0;
            previous[i] = 0;
            velocity[i] = 0;
        }

        function update() {
            for (let y = 1; y < gridHeight - 1; y++) {
                for (let x = 1; x < gridWidth - 1; x++) {
                    const idx = y * gridWidth + x;

                    const laplacian = (
                        current[idx - 1] +
                        current[idx + 1] +
                        current[idx - gridWidth] +
                        current[idx + gridWidth] -
                        4 * current[idx]
                    );

                    velocity[idx] += laplacian * waveSpeed;
                    velocity[idx] *= damping;

                    previous[idx] = current[idx];
                    current[idx] += velocity[idx];
                }
            }
        }

        function addWave(x, y, amplitude) {
            const gx = Math.floor(x / width * gridWidth);
            const gy = Math.floor(y / height * gridHeight);

            if (gx >= 0 && gx < gridWidth && gy >= 0 && gy < gridHeight) {
                const idx = gy * gridWidth + gx;
                velocity[idx] += amplitude;

                for (let dy = -2; dy <= 2; dy++) {
                    for (let dx = -2; dx <= 2; dx++) {
                        const nx = gx + dx;
                        const ny = gy + dy;
                        if (nx >= 0 && nx < gridWidth && ny >= 0 && ny < gridHeight) {
                            const nidx = ny * gridWidth + nx;
                            const dist = Math.sqrt(dx * dx + dy * dy);
                            velocity[nidx] += amplitude * (1 - dist / 3);
                        }
                    }
                }
            }
        }

        let time = 0;

        function draw() {
            ctx.fillStyle = '#000510';
            ctx.fillRect(0, 0, width, height);

            const cellW = width / gridWidth;
            const cellH = height / gridHeight;

            for (let y = 1; y < gridHeight - 1; y++) {
                for (let x = 1; x < gridWidth - 1; x++) {
                    const idx = y * gridWidth + x;
                    const value = current[idx];

                    const normalized = (value + 5) / 10;
                    const clamped = Math.max(0, Math.min(1, normalized));

                    const hue = 200 + value * 20;
                    const lightness = 20 + clamped * 60;

                    ctx.fillStyle = `hsl(${hue}, 100%, ${lightness}%)`;
                    ctx.fillRect(
                        x * cellW,
                        y * cellH,
                        Math.ceil(cellW),
                        Math.ceil(cellH)
                    );
                }
            }

            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 2;

            for (let y = 0; y < gridHeight; y++) {
                ctx.beginPath();
                for (let x = 0; x < gridWidth; x++) {
                    const idx = y * gridWidth + x;
                    const value = current[idx];

                    const px = x * cellW + cellW / 2;
                    const py = y * cellH + cellH / 2 - value * 3;

                    if (x === 0) {
                        ctx.moveTo(px, py);
                    } else {
                        ctx.lineTo(px, py);
                    }
                }
                ctx.stroke();
            }
        }

        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            addWave(x, y, 5);
        });

        let autoWaveTimer = 0;

        function animate() {
            time += 0.01;
            autoWaveTimer++;

            if (autoWaveTimer % 60 === 0) {
                const x = Math.random() * width;
                const y = Math.random() * height;
                addWave(x, y, 3 + Math.random() * 3);
            }

            for (let i = 0; i < 2; i++) {
                update();
            }

            draw();

            requestAnimationFrame(animate);
        }

        addWave(width / 2, height / 2, 10);

        animate();
    </script>
</body>
</html>
