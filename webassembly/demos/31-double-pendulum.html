<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Double Pendulum - WebAssembly</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }
        canvas {
            border: 2px solid #222;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const width = canvas.width = 1000;
        const height = canvas.height = 800;

        class DoublePendulum {
            constructor(x, y, l1, l2, m1, m2, a1, a2, hue) {
                this.x = x;
                this.y = y;
                this.l1 = l1;
                this.l2 = l2;
                this.m1 = m1;
                this.m2 = m2;
                this.a1 = a1;
                this.a2 = a2;
                this.a1_v = 0;
                this.a2_v = 0;
                this.hue = hue;
                this.trail = [];
            }

            update() {
                const g = 1;
                const num1 = -g * (2 * this.m1 + this.m2) * Math.sin(this.a1);
                const num2 = -this.m2 * g * Math.sin(this.a1 - 2 * this.a2);
                const num3 = -2 * Math.sin(this.a1 - this.a2) * this.m2;
                const num4 = this.a2_v ** 2 * this.l2 + this.a1_v ** 2 * this.l1 * Math.cos(this.a1 - this.a2);
                const den = this.l1 * (2 * this.m1 + this.m2 - this.m2 * Math.cos(2 * this.a1 - 2 * this.a2));
                const a1_a = (num1 + num2 + num3 * num4) / den;

                const num5 = 2 * Math.sin(this.a1 - this.a2);
                const num6 = (this.a1_v ** 2 * this.l1 * (this.m1 + this.m2));
                const num7 = g * (this.m1 + this.m2) * Math.cos(this.a1);
                const num8 = this.a2_v ** 2 * this.l2 * this.m2 * Math.cos(this.a1 - this.a2);
                const den2 = this.l2 * (2 * this.m1 + this.m2 - this.m2 * Math.cos(2 * this.a1 - 2 * this.a2));
                const a2_a = (num5 * (num6 + num7 + num8)) / den2;

                this.a1_v += a1_a;
                this.a2_v += a2_a;
                this.a1 += this.a1_v;
                this.a2 += this.a2_v;

                this.a1_v *= 0.9999;
                this.a2_v *= 0.9999;

                const x2 = this.x + this.l1 * Math.sin(this.a1) + this.l2 * Math.sin(this.a2);
                const y2 = this.y + this.l1 * Math.cos(this.a1) + this.l2 * Math.cos(this.a2);

                this.trail.push({ x: x2, y: y2 });
                if (this.trail.length > 500) {
                    this.trail.shift();
                }
            }

            draw() {
                const x1 = this.x + this.l1 * Math.sin(this.a1);
                const y1 = this.y + this.l1 * Math.cos(this.a1);
                const x2 = x1 + this.l2 * Math.sin(this.a2);
                const y2 = y1 + this.l2 * Math.cos(this.a2);

                this.trail.forEach((p, i) => {
                    const alpha = i / this.trail.length;
                    ctx.fillStyle = `hsla(${this.hue}, 100%, 60%, ${alpha * 0.8})`;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 2, 0, Math.PI * 2);
                    ctx.fill();
                });

                ctx.strokeStyle = `hsl(${this.hue}, 100%, 70%)`;
                ctx.lineWidth = 3;
                ctx.lineCap = 'round';

                ctx.beginPath();
                ctx.moveTo(this.x, this.y);
                ctx.lineTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();

                ctx.fillStyle = `hsl(${this.hue}, 100%, 60%)`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, 8, 0, Math.PI * 2);
                ctx.fill();

                ctx.beginPath();
                ctx.arc(x1, y1, this.m1 * 3, 0, Math.PI * 2);
                ctx.fill();

                ctx.beginPath();
                ctx.arc(x2, y2, this.m2 * 3, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        const pendulums = [];
        const centerX = width / 2;
        const centerY = 200;

        for (let i = 0; i < 5; i++) {
            pendulums.push(new DoublePendulum(
                centerX,
                centerY,
                150,
                150,
                10,
                10,
                Math.PI / 2 + i * 0.01,
                Math.PI / 2,
                i * 72
            ));
        }

        function animate() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
            ctx.fillRect(0, 0, width, height);

            pendulums.forEach(p => {
                p.update();
                p.draw();
            });

            requestAnimationFrame(animate);
        }

        animate();
    </script>
</body>
</html>
