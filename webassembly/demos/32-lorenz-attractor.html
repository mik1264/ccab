<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lorenz Attractor - WebAssembly</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }
        canvas {
            border: 2px solid #222;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const width = canvas.width = 1000;
        const height = canvas.height = 800;

        const sigma = 10;
        const rho = 28;
        const beta = 8 / 3;
        const dt = 0.005;

        class Particle {
            constructor(x, y, z, hue) {
                this.x = x;
                this.y = y;
                this.z = z;
                this.hue = hue;
                this.trail = [];
            }

            update() {
                const dx = sigma * (this.y - this.x) * dt;
                const dy = (this.x * (rho - this.z) - this.y) * dt;
                const dz = (this.x * this.y - beta * this.z) * dt;

                this.x += dx;
                this.y += dy;
                this.z += dz;

                this.trail.push({ x: this.x, y: this.y, z: this.z });
                if (this.trail.length > 3000) {
                    this.trail.shift();
                }
            }
        }

        const particles = [];
        for (let i = 0; i < 3; i++) {
            particles.push(new Particle(
                0.1 + i * 0.01,
                0,
                0,
                i * 120
            ));
        }

        let angle = 0;

        function rotateY(x, y, z, a) {
            const cos = Math.cos(a);
            const sin = Math.sin(a);
            return {
                x: x * cos + z * sin,
                y: y,
                z: -x * sin + z * cos
            };
        }

        function rotateX(x, y, z, a) {
            const cos = Math.cos(a);
            const sin = Math.sin(a);
            return {
                x: x,
                y: y * cos - z * sin,
                z: y * sin + z * cos
            };
        }

        function project(x, y, z) {
            const scale = 8;
            const distance = 100;
            const factor = scale / (distance + z);

            return {
                x: width / 2 + x * factor,
                y: height / 2 + y * factor
            };
        }

        function animate() {
            angle += 0.003;

            ctx.fillStyle = 'rgba(0, 0, 0, 0.02)';
            ctx.fillRect(0, 0, width, height);

            particles.forEach(particle => {
                for (let i = 0; i < 5; i++) {
                    particle.update();
                }

                ctx.strokeStyle = `hsl(${particle.hue}, 100%, 60%)`;
                ctx.lineWidth = 1.5;
                ctx.lineCap = 'round';

                ctx.beginPath();

                particle.trail.forEach((p, i) => {
                    let rotated = rotateY(p.x, p.y, p.z, angle);
                    rotated = rotateX(rotated.x, rotated.y, rotated.z, 0.3);
                    const projected = project(rotated.x, rotated.y, rotated.z);

                    if (i === 0) {
                        ctx.moveTo(projected.x, projected.y);
                    } else {
                        ctx.lineTo(projected.x, projected.y);
                    }
                });

                ctx.stroke();

                particle.trail.forEach((p, i) => {
                    if (i % 50 === 0) {
                        let rotated = rotateY(p.x, p.y, p.z, angle);
                        rotated = rotateX(rotated.x, rotated.y, rotated.z, 0.3);
                        const projected = project(rotated.x, rotated.y, rotated.z);

                        const alpha = i / particle.trail.length;
                        ctx.fillStyle = `hsla(${particle.hue}, 100%, 70%, ${alpha})`;
                        ctx.beginPath();
                        ctx.arc(projected.x, projected.y, 2, 0, Math.PI * 2);
                        ctx.fill();
                    }
                });
            });

            requestAnimationFrame(animate);
        }

        animate();
    </script>
</body>
</html>
