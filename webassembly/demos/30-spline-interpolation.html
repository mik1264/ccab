<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spline Interpolation - WebAssembly</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }
        canvas {
            border: 2px solid #222;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const width = canvas.width = 1200;
        const height = canvas.height = 700;

        const controlPoints = [];
        for (let i = 0; i < 8; i++) {
            controlPoints.push({
                x: 100 + i * 150,
                y: height / 2 + (Math.random() - 0.5) * 300,
                vy: (Math.random() - 0.5) * 3
            });
        }

        function catmullRom(p0, p1, p2, p3, t) {
            const t2 = t * t;
            const t3 = t2 * t;

            return {
                x: 0.5 * (
                    2 * p1.x +
                    (-p0.x + p2.x) * t +
                    (2 * p0.x - 5 * p1.x + 4 * p2.x - p3.x) * t2 +
                    (-p0.x + 3 * p1.x - 3 * p2.x + p3.x) * t3
                ),
                y: 0.5 * (
                    2 * p1.y +
                    (-p0.y + p2.y) * t +
                    (2 * p0.y - 5 * p1.y + 4 * p2.y - p3.y) * t2 +
                    (-p0.y + 3 * p1.y - 3 * p2.y + p3.y) * t3
                )
            };
        }

        function drawSpline() {
            ctx.strokeStyle = '#0ff';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';

            ctx.beginPath();

            for (let i = 0; i < controlPoints.length - 1; i++) {
                const p0 = controlPoints[Math.max(0, i - 1)];
                const p1 = controlPoints[i];
                const p2 = controlPoints[i + 1];
                const p3 = controlPoints[Math.min(controlPoints.length - 1, i + 2)];

                for (let t = 0; t <= 1; t += 0.02) {
                    const point = catmullRom(p0, p1, p2, p3, t);

                    if (i === 0 && t === 0) {
                        ctx.moveTo(point.x, point.y);
                    } else {
                        ctx.lineTo(point.x, point.y);
                    }
                }
            }

            ctx.stroke();

            ctx.shadowBlur = 20;
            ctx.shadowColor = '#0ff';
            ctx.stroke();
            ctx.shadowBlur = 0;
        }

        function drawTangents() {
            ctx.strokeStyle = 'rgba(255, 100, 100, 0.5)';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);

            for (let i = 1; i < controlPoints.length - 1; i++) {
                const p0 = controlPoints[i - 1];
                const p1 = controlPoints[i];
                const p2 = controlPoints[i + 1];

                const tangentX = (p2.x - p0.x) * 0.3;
                const tangentY = (p2.y - p0.y) * 0.3;

                ctx.beginPath();
                ctx.moveTo(p1.x - tangentX, p1.y - tangentY);
                ctx.lineTo(p1.x + tangentX, p1.y + tangentY);
                ctx.stroke();
            }

            ctx.setLineDash([]);
        }

        function drawNormals() {
            ctx.strokeStyle = 'rgba(100, 255, 100, 0.5)';
            ctx.lineWidth = 1;

            for (let i = 0; i < controlPoints.length - 1; i++) {
                const p0 = controlPoints[Math.max(0, i - 1)];
                const p1 = controlPoints[i];
                const p2 = controlPoints[i + 1];
                const p3 = controlPoints[Math.min(controlPoints.length - 1, i + 2)];

                for (let t = 0; t <= 1; t += 0.1) {
                    const point = catmullRom(p0, p1, p2, p3, t);
                    const nextPoint = catmullRom(p0, p1, p2, p3, Math.min(1, t + 0.01));

                    const dx = nextPoint.x - point.x;
                    const dy = nextPoint.y - point.y;
                    const len = Math.sqrt(dx * dx + dy * dy);

                    const nx = -dy / len * 30;
                    const ny = dx / len * 30;

                    ctx.beginPath();
                    ctx.moveTo(point.x, point.y);
                    ctx.lineTo(point.x + nx, point.y + ny);
                    ctx.stroke();
                }
            }
        }

        function drawParticles() {
            const particleCount = 50;

            for (let i = 0; i < particleCount; i++) {
                const segmentIndex = Math.floor((i / particleCount) * (controlPoints.length - 1));
                const t = ((i / particleCount) * (controlPoints.length - 1)) % 1;

                const p0 = controlPoints[Math.max(0, segmentIndex - 1)];
                const p1 = controlPoints[segmentIndex];
                const p2 = controlPoints[Math.min(controlPoints.length - 1, segmentIndex + 1)];
                const p3 = controlPoints[Math.min(controlPoints.length - 1, segmentIndex + 2)];

                const point = catmullRom(p0, p1, p2, p3, t);

                const hue = (i / particleCount) * 360;
                ctx.fillStyle = `hsl(${hue}, 100%, 60%)`;

                ctx.beginPath();
                ctx.arc(point.x, point.y, 4, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function animate() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.fillRect(0, 0, width, height);

            controlPoints.forEach(p => {
                p.y += p.vy;

                if (p.y < 50 || p.y > height - 50) {
                    p.vy *= -1;
                    p.y = Math.max(50, Math.min(height - 50, p.y));
                }
            });

            drawNormals();
            drawTangents();
            drawSpline();
            drawParticles();

            controlPoints.forEach((p, i) => {
                ctx.fillStyle = '#f0f';
                ctx.beginPath();
                ctx.arc(p.x, p.y, 8, 0, Math.PI * 2);
                ctx.fill();

                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();

                ctx.fillStyle = '#fff';
                ctx.font = '12px monospace';
                ctx.textAlign = 'center';
                ctx.fillText(i, p.x, p.y + 25);
            });

            requestAnimationFrame(animate);
        }

        animate();
    </script>
</body>
</html>
