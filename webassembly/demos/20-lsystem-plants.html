<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L-System Plants - WebAssembly</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #050510;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }
        canvas {
            border: 2px solid #222;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const width = canvas.width = 1200;
        const height = canvas.height = 800;

        const systems = [
            {
                axiom: 'F',
                rules: { 'F': 'F[+F]F[-F]F' },
                angle: 25,
                iterations: 5,
                x: 200,
                y: height - 100,
                startAngle: -90
            },
            {
                axiom: 'F',
                rules: { 'F': 'FF+[+F-F-F]-[-F+F+F]' },
                angle: 22.5,
                iterations: 4,
                x: 500,
                y: height - 100,
                startAngle: -90
            },
            {
                axiom: 'X',
                rules: { 'X': 'F+[[X]-X]-F[-FX]+X', 'F': 'FF' },
                angle: 25,
                iterations: 6,
                x: 800,
                y: height - 100,
                startAngle: -90
            },
            {
                axiom: 'F',
                rules: { 'F': 'F[+F][--F][++++F][-F]' },
                angle: 20,
                iterations: 4,
                x: 1050,
                y: height - 100,
                startAngle: -90
            }
        ];

        function generateLSystem(axiom, rules, iterations) {
            let current = axiom;

            for (let i = 0; i < iterations; i++) {
                let next = '';
                for (let char of current) {
                    next += rules[char] || char;
                }
                current = next;
            }

            return current;
        }

        function drawLSystem(instructions, x, y, startAngle, angle, length, time) {
            const stack = [];
            let currentX = x;
            let currentY = y;
            let currentAngle = startAngle;

            const windEffect = Math.sin(time) * 2;

            for (let i = 0; i < instructions.length; i++) {
                const char = instructions[i];

                switch (char) {
                    case 'F':
                        const newX = currentX + Math.cos(currentAngle * Math.PI / 180) * length;
                        const newY = currentY + Math.sin(currentAngle * Math.PI / 180) * length;

                        const depth = stack.length;
                        const hue = 120 + depth * 10 + time * 20;
                        const brightness = 30 + depth * 3;

                        ctx.strokeStyle = `hsl(${hue}, 70%, ${brightness}%)`;
                        ctx.lineWidth = Math.max(1, 6 - depth * 0.5);
                        ctx.lineCap = 'round';

                        ctx.beginPath();
                        ctx.moveTo(currentX, currentY);
                        ctx.lineTo(newX, newY);
                        ctx.stroke();

                        currentX = newX;
                        currentY = newY;
                        break;

                    case '+':
                        currentAngle += angle + windEffect;
                        break;

                    case '-':
                        currentAngle -= angle + windEffect;
                        break;

                    case '[':
                        stack.push({ x: currentX, y: currentY, angle: currentAngle });
                        break;

                    case ']':
                        const state = stack.pop();
                        currentX = state.x;
                        currentY = state.y;
                        currentAngle = state.angle;

                        if (stack.length < 3) {
                            ctx.fillStyle = `hsla(${60 + Math.random() * 60}, 80%, 50%, 0.8)`;
                            ctx.beginPath();
                            ctx.arc(currentX, currentY, 2 + Math.random() * 2, 0, Math.PI * 2);
                            ctx.fill();
                        }
                        break;
                }
            }
        }

        let time = 0;

        function animate() {
            time += 0.01;

            ctx.fillStyle = 'rgba(5, 5, 16, 0.2)';
            ctx.fillRect(0, 0, width, height);

            systems.forEach((system, index) => {
                const instructions = generateLSystem(system.axiom, system.rules, system.iterations);
                const baseLength = 8 - system.iterations + Math.sin(time + index) * 0.5;

                drawLSystem(
                    instructions,
                    system.x,
                    system.y,
                    system.startAngle,
                    system.angle,
                    baseLength,
                    time + index
                );
            });

            requestAnimationFrame(animate);
        }

        animate();
    </script>
</body>
</html>
