<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lunar Phases - CCAB</title>
    <link rel="stylesheet" href="../assets/css/gallery-standard.css">
    <style>
        body {
            background: #000;
            color: #ddd;
            font-family: system-ui;
            padding: 2rem;
            text-align: center;
        }
        .container { max-width: 1000px; margin: 0 auto; display: flex; gap: 40px; justify-content: center; }
        
        .view-box {
            width: 400px;
            height: 400px;
            border: 1px solid #333;
            background: #111;
            border-radius: 8px;
            position: relative;
        }
        
        canvas {
            position: absolute;
            top: 0; left: 0;
        }
        
        .controls {
            margin: 20px;
        }
        
        button {
            padding: 10px 20px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .phase-name {
            font-size: 1.5rem;
            margin-top: 10px;
            color: #fcd34d;
        }
        
    </style>
</head>
<body>

<a href="../index.html" class="gallery-back">‚Üê Back to Gallery</a>
<h1>Lunar Phases & Libration</h1>

<div class="container">
    <div>
        <h3>Top-Down View</h3>
        <div class="view-box">
            <canvas id="top-view" width="400" height="400"></canvas>
        </div>
    </div>
    
    <div>
        <h3>Earth View</h3>
        <div class="view-box">
            <canvas id="earth-view" width="400" height="400"></canvas>
        </div>
        <div class="phase-name" id="phase-name">New Moon</div>
    </div>
</div>

<div class="controls">
    <button onclick="running=!running">Pause/Resume</button>
</div>

<script>
    const ctxTop = document.getElementById('top-view').getContext('2d');
    const ctxView = document.getElementById('earth-view').getContext('2d');
    
    let angle = 0;
    let running = true;
    
    // Moon orbit
    // Sun is far to the RIGHT (at x=Infinity)
    // Light comes from Right
    
    function loop() {
        if (running) angle += 0.01;
        
        // 1. Top View
        ctxTop.clearRect(0, 0, 400, 400);
        
        // Sunlight
        ctxTop.fillStyle = 'rgba(255, 255, 0, 0.1)';
        ctxTop.fillRect(200, 0, 200, 400); // Right half lit
        
        // Earth
        ctxTop.fillStyle = '#3b82f6';
        ctxTop.beginPath(); ctxTop.arc(200, 200, 20, 0, Math.PI*2); ctxTop.fill();
        // Earth shadow side
        ctxTop.fillStyle = 'rgba(0,0,0,0.5)';
        ctxTop.beginPath(); ctxTop.arc(200, 200, 20, Math.PI/2, Math.PI*1.5); ctxTop.fill();
        
        // Moon
        const r = 120;
        const mx = 200 + r * Math.cos(angle);
        const my = 200 + r * Math.sin(angle);
        
        ctxTop.fillStyle = '#ccc';
        ctxTop.beginPath(); ctxTop.arc(mx, my, 10, 0, Math.PI*2); ctxTop.fill();
        
        // Moon shadow side (always away from sun)
        // Sun is right. Shadow is left.
        ctxTop.fillStyle = '#000';
        ctxTop.beginPath(); ctxTop.arc(mx, my, 10, Math.PI/2, Math.PI*1.5); ctxTop.fill();
        
        // Libration (Elliptical orbit speed variation vs constant rotation)
        // Simulated by slight wobble in phase view, but top view is standard.
        
        // 2. Earth View
        ctxView.clearRect(0, 0, 400, 400);
        
        // Determine phase 0 to 1
        // Angle 0 = Full Moon (Opposite sun? Wait. Sun is Right.)
        // If Moon is at 0 rad (Right), it's between Earth and Sun -> New Moon.
        // If Moon is at PI (Left), Earth is between Moon and Sun -> Full Moon.
        
        // Phase angle alpha.
        // alpha = angle. 
        // 0 = New. PI = Full.
        
        // Draw Moon Disk
        const cx = 200, cy = 200, mr = 100;
        
        // Draw Dark Side (Base)
        ctxView.fillStyle = '#111';
        ctxView.beginPath(); ctxView.arc(cx, cy, mr, 0, Math.PI*2); ctxView.fill();
        
        // Draw Lit Side
        // Logic:
        // angle 0 (New): Lit side is back. We see dark.
        // angle PI (Full): Lit side is front. We see light.
        
        // Normalized angle 0 to 2PI
        let phaseAng = angle % (Math.PI*2);
        if (phaseAng < 0) phaseAng += Math.PI*2;
        
        let phaseName = "";
        
        ctxView.fillStyle = '#fff'; // '#fcd34d' for harvest moon?
        
        // Terminator curve logic
        // It's a semi-circle + an ellipse
        // Width of lit part varies
        
        // Vector to Sun from Moon relative to Earth-Moon line determines phase.
        // Let's use simple geometric rendering.
        // We see projection of sphere.
        // Lit hemisphere is rotated by 'angle'.
        
        // Start with full circle?
        // Actually easier:
        // If 0 < a < PI (Waxing): Right side lit.
        // If PI < a < 2PI (Waning): Left side lit.
        
        const cosA = Math.cos(phaseAng); // 1 at New, -1 at Full
        
        // New Moon (0): cos=1. Lit part hidden.
        // Full Moon (PI): cos=-1. Lit part full.
        
        // Actually:
        // Angle 0: New Moon. Sun is behind moon.
        // Angle PI: Full Moon. Sun is behind us.
        
        // Draw base circle as lit or dark depending on phase
        // Split vertical.
        
        ctxView.beginPath();
        if (phaseAng < Math.PI) {
            // Waxing (0 to PI). Right side grows.
            // Right semicircle is lit? No, Starts dark.
            // At 0: Dark. At PI/2: Right half lit. At PI: Full.
            // Base: Left is always dark? Right is varying?
            
            // Let's use the terminator ellipse approach
            // Left semicircle: Dark (0 to PI/2), Lit (PI/2 to PI)? 
            // It's tricky.
            
            // Simpler: 
            // Draw Full Moon White.
            // Draw Shadow Ellipse.
            
            // Shadow center shifts.
            
            // Correct approach:
            // 1. Draw Semi-circle (Light or Dark)
            // 2. Draw Ellipse (Light or Dark) to fill the rest
            
            // Shifted phase: 0=Full, PI=New makes math easier usually.
            // Current: 0=New.
            
            const w = mr * Math.cos(phaseAng); // Width of ellipse
            
            if (phaseAng < Math.PI/2) {
                // New -> First Quarter
                // Base: Dark
                ctxView.fillStyle = '#222';
                ctxView.beginPath(); ctxView.arc(cx, cy, mr, 0, Math.PI*2); ctxView.fill();
                // Lit Crescent on Right
                ctxView.fillStyle = '#fff';
                ctxView.beginPath();
                ctxView.arc(cx, cy, mr, -Math.PI/2, Math.PI/2); // Right semi
                ctxView.ellipse(cx, cy, Math.abs(w), mr, 0, Math.PI/2, -Math.PI/2); // Cut out left?
                // Actually need to fill ellipse with Dark to cut right semi?
                // Simpler: Draw Right Semicircle (Light)
                // Draw Ellipse (Dark) over it.
                // Ellipse width w is positive.
                
                // Let's try standard algo
            } 
        }
        
        // Robust rendering:
        // Draw Full Moon (Dark)
        ctxView.fillStyle = '#222';
        ctxView.beginPath(); ctxView.arc(cx, cy, mr, 0, Math.PI*2); ctxView.fill();
        
        // Light
        ctxView.fillStyle = '#fff';
        ctxView.beginPath();
        
        // Lit hemisphere direction?
        // 0: Back (hidden). PI: Front.
        // Angle 0: New.
        // Angle PI/2: First Quarter (Right half lit).
        // Angle PI: Full.
        
        // Semicircle
        if (phaseAng > 0 && phaseAng < Math.PI) {
            // Waxing: Right side is lit edge
            ctxView.arc(cx, cy, mr, -Math.PI/2, Math.PI/2); // Right Semicircle
            
            // Ellipse terminator
            // Moves from Right to Left
            const w = mr * Math.cos(phaseAng); 
            // At 0, w=r. Ellipse covers semicircle (Dark).
            // At PI/2, w=0. Line. Half lit.
            // At PI, w=-r. Ellipse flips, adds to semicircle.
            
            // We need to SUBTRACT ellipse if w>0 (0 to PI/2)
            // ADD ellipse if w<0 (PI/2 to PI)
            
            // Canvas path direction is key.
            // Just use composite operations or careful arcs.
            
            // Let's redraw:
            // 1. Draw Right Semicircle White.
            // 2. If 0<a<PI/2: Draw Ellipse Dark (covering part of white).
            // 3. If PI/2<a<PI: Draw Ellipse White (filling left part).
        } 
        else {
            // Waning: Left side is lit edge
            ctxView.arc(cx, cy, mr, Math.PI/2, -Math.PI/2); // Left Semicircle
            // Ellipse
            // PI to 3PI/2: w goes -r to 0. (Full to Last Q)
            // Add Ellipse White (filling right part).
            // 3PI/2 to 2PI: w goes 0 to r. (Last Q to New)
            // Subtract Ellipse Dark.
        }
        ctxView.fill();
        
        // Terminator Ellipse
        const w = mr * Math.cos(phaseAng);
        ctxView.fillStyle = (phaseAng > Math.PI/2 && phaseAng < 1.5*Math.PI) ? '#fff' : '#222';
        ctxView.beginPath();
        ctxView.ellipse(cx, cy, Math.abs(w), mr, 0, 0, Math.PI*2);
        ctxView.fill();
        
        // Update Name
        const deg = (phaseAng * 180 / Math.PI) % 360;
        if (deg < 5 || deg > 355) phaseName = "New Moon";
        else if (deg < 85) phaseName = "Waxing Crescent";
        else if (deg < 95) phaseName = "First Quarter";
        else if (deg < 175) phaseName = "Waxing Gibbous";
        else if (deg < 185) phaseName = "Full Moon";
        else if (deg < 265) phaseName = "Waning Gibbous";
        else if (deg < 275) phaseName = "Last Quarter";
        else phaseName = "Waning Crescent";
        
        document.getElementById('phase-name').textContent = phaseName;
        
        requestAnimationFrame(loop);
    }
    
    requestAnimationFrame(loop);

</script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
