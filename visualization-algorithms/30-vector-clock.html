<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vector Clock Causality Explorer - CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8e8e8;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { text-align: center; padding: 20px; margin-bottom: 20px; }
        h1 {
            font-size: 2.2rem;
            background: linear-gradient(90deg, #0984e3, #00cec9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subtitle { color: #888; font-size: 1rem; }
        .back-link {
            position: absolute; top: 20px; left: 20px;
            color: #0984e3; text-decoration: none; font-weight: 500;
        }
        .main-content { display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
        .canvas-container {
            background: rgba(255,255,255,0.05);
            border-radius: 16px; padding: 20px;
        }
        canvas { display: block; margin: 0 auto; background: #0a0a1a; border-radius: 8px; }
        .controls { display: flex; flex-direction: column; gap: 15px; }
        .panel {
            background: rgba(255,255,255,0.05);
            border-radius: 12px; padding: 15px;
        }
        .panel h3 {
            color: #0984e3; font-size: 1rem; margin-bottom: 10px;
            border-bottom: 1px solid rgba(9,132,227,0.3); padding-bottom: 5px;
        }
        button {
            padding: 10px 15px; background: rgba(9,132,227,0.2);
            border: 1px solid rgba(9,132,227,0.5); border-radius: 6px;
            color: #0984e3; cursor: pointer; font-size: 0.85rem;
            width: 100%; margin-bottom: 8px; transition: all 0.3s;
        }
        button:hover { background: rgba(9,132,227,0.3); }
        .process-buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .process-buttons button { margin: 0; }
        .info-text { font-size: 0.85rem; color: #aaa; line-height: 1.6; }
        .event-list {
            max-height: 200px; overflow-y: auto;
            background: rgba(0,0,0,0.3); border-radius: 6px; padding: 10px;
            font-family: monospace; font-size: 0.75rem;
        }
        .event-item { padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .legend { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .legend-item { display: flex; align-items: center; gap: 5px; font-size: 0.8rem; }
        .legend-color { width: 14px; height: 14px; border-radius: 50%; }
        select {
            width: 100%; padding: 8px; background: rgba(0,0,0,0.3);
            border: 1px solid rgba(9,132,227,0.3); border-radius: 6px;
            color: #e8e8e8; font-size: 0.85rem; margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back to Gallery</a>
    <div class="container">
        <header>
            <h1>Vector Clock Causality Explorer</h1>
            <p class="subtitle">Visualizing happens-before relationships in distributed systems</p>
        </header>
        <div class="main-content">
            <div class="canvas-container">
                <canvas id="canvas" width="900" height="550"></canvas>
            </div>
            <div class="controls">
                <div class="panel">
                    <h3>Add Local Event</h3>
                    <div class="process-buttons">
                        <button onclick="addLocalEvent(0)" style="background: rgba(231,76,60,0.3);">P0</button>
                        <button onclick="addLocalEvent(1)" style="background: rgba(46,204,113,0.3);">P1</button>
                        <button onclick="addLocalEvent(2)" style="background: rgba(52,152,219,0.3);">P2</button>
                    </div>
                </div>
                <div class="panel">
                    <h3>Send Message</h3>
                    <select id="msg-from">
                        <option value="0">From P0</option>
                        <option value="1">From P1</option>
                        <option value="2">From P2</option>
                    </select>
                    <select id="msg-to">
                        <option value="1">To P1</option>
                        <option value="0">To P0</option>
                        <option value="2">To P2</option>
                    </select>
                    <button onclick="sendMessage()">Send Message</button>
                </div>
                <div class="panel">
                    <h3>Compare Events</h3>
                    <select id="event-a"></select>
                    <select id="event-b"></select>
                    <button onclick="compareEvents()">Check Causality</button>
                    <div id="comparison-result" style="margin-top: 10px; font-size: 0.9rem;"></div>
                </div>
                <div class="panel">
                    <h3>Actions</h3>
                    <button onclick="runScenario()">Run Example Scenario</button>
                    <button onclick="clearAll()">Clear All</button>
                </div>
                <div class="panel">
                    <h3>Legend</h3>
                    <div class="legend">
                        <div class="legend-item"><div class="legend-color" style="background: #e74c3c;"></div>Process 0</div>
                        <div class="legend-item"><div class="legend-color" style="background: #2ecc71;"></div>Process 1</div>
                        <div class="legend-item"><div class="legend-color" style="background: #3498db;"></div>Process 2</div>
                    </div>
                    <p class="info-text" style="margin-top: 10px;">
                        Arrows show message passing. Vector clocks track causality:
                        e1 → e2 (happens-before) iff VC(e1) < VC(e2).
                    </p>
                </div>
                <div class="panel">
                    <h3>Event Log</h3>
                    <div class="event-list" id="event-log"></div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        const NUM_PROCESSES = 3;
        const processColors = ['#e74c3c', '#2ecc71', '#3498db'];
        const processY = [100, 275, 450];

        let vectorClocks = [[0, 0, 0], [0, 0, 0], [0, 0, 0]];
        let events = [];
        let messages = [];
        let timeCounter = 0;

        class Event {
            constructor(process, time, vc, type, label) {
                this.process = process;
                this.time = time;
                this.vc = [...vc];
                this.type = type;
                this.label = label;
                this.id = events.length;
            }
        }

        function addLocalEvent(process) {
            vectorClocks[process][process]++;
            const event = new Event(
                process,
                ++timeCounter,
                vectorClocks[process],
                'local',
                `e${events.length}`
            );
            events.push(event);
            updateEventSelects();
            logEvent(event);
            draw();
        }

        function sendMessage() {
            const from = parseInt(document.getElementById('msg-from').value);
            const to = parseInt(document.getElementById('msg-to').value);
            if (from === to) return;

            // Send event
            vectorClocks[from][from]++;
            const sendEvent = new Event(
                from,
                ++timeCounter,
                vectorClocks[from],
                'send',
                `s${events.length}`
            );
            events.push(sendEvent);

            // Receive event (merge clocks)
            for (let i = 0; i < NUM_PROCESSES; i++) {
                vectorClocks[to][i] = Math.max(vectorClocks[to][i], vectorClocks[from][i]);
            }
            vectorClocks[to][to]++;
            const recvEvent = new Event(
                to,
                ++timeCounter,
                vectorClocks[to],
                'receive',
                `r${events.length}`
            );
            events.push(recvEvent);

            messages.push({ from: sendEvent, to: recvEvent });
            updateEventSelects();
            logEvent(sendEvent);
            logEvent(recvEvent);
            draw();
        }

        function compareVectorClocks(vc1, vc2) {
            let less = false, greater = false;
            for (let i = 0; i < NUM_PROCESSES; i++) {
                if (vc1[i] < vc2[i]) less = true;
                if (vc1[i] > vc2[i]) greater = true;
            }
            if (less && !greater) return -1;  // vc1 < vc2
            if (greater && !less) return 1;   // vc1 > vc2
            if (!less && !greater) return 0;  // equal
            return null;  // concurrent
        }

        function compareEvents() {
            const aIdx = parseInt(document.getElementById('event-a').value);
            const bIdx = parseInt(document.getElementById('event-b').value);
            const resultDiv = document.getElementById('comparison-result');

            if (isNaN(aIdx) || isNaN(bIdx)) {
                resultDiv.innerHTML = '<span style="color: #888;">Select two events</span>';
                return;
            }

            const a = events[aIdx];
            const b = events[bIdx];
            const cmp = compareVectorClocks(a.vc, b.vc);

            let result;
            if (cmp === -1) {
                result = `<span style="color: #2ecc71;">${a.label} → ${b.label}</span><br>(${a.label} happens-before ${b.label})`;
            } else if (cmp === 1) {
                result = `<span style="color: #2ecc71;">${b.label} → ${a.label}</span><br>(${b.label} happens-before ${a.label})`;
            } else if (cmp === 0) {
                result = `<span style="color: #f39c12;">${a.label} = ${b.label}</span><br>(Same event)`;
            } else {
                result = `<span style="color: #e74c3c;">${a.label} || ${b.label}</span><br>(Concurrent - no causal relationship)`;
            }
            resultDiv.innerHTML = result;
        }

        function updateEventSelects() {
            const selectA = document.getElementById('event-a');
            const selectB = document.getElementById('event-b');
            selectA.innerHTML = '';
            selectB.innerHTML = '';
            events.forEach((e, i) => {
                const opt = `<option value="${i}">${e.label} [${e.vc.join(',')}]</option>`;
                selectA.innerHTML += opt;
                selectB.innerHTML += opt;
            });
        }

        function logEvent(event) {
            const log = document.getElementById('event-log');
            const entry = document.createElement('div');
            entry.className = 'event-item';
            entry.style.color = processColors[event.process];
            entry.textContent = `${event.label} @ P${event.process}: [${event.vc.join(', ')}] (${event.type})`;
            log.insertBefore(entry, log.firstChild);
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const padding = 80;
            const timeScale = Math.min(60, (canvas.width - 2 * padding) / Math.max(timeCounter, 10));

            // Draw process lines
            for (let p = 0; p < NUM_PROCESSES; p++) {
                ctx.strokeStyle = processColors[p];
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(padding, processY[p]);
                ctx.lineTo(canvas.width - padding / 2, processY[p]);
                ctx.stroke();

                ctx.fillStyle = processColors[p];
                ctx.font = 'bold 14px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(`P${p}`, padding - 15, processY[p] + 5);
            }

            // Draw messages
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.lineWidth = 2;
            for (const msg of messages) {
                const x1 = padding + msg.from.time * timeScale;
                const y1 = processY[msg.from.process];
                const x2 = padding + msg.to.time * timeScale;
                const y2 = processY[msg.to.process];

                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();

                // Arrow head
                const angle = Math.atan2(y2 - y1, x2 - x1);
                ctx.beginPath();
                ctx.moveTo(x2, y2);
                ctx.lineTo(x2 - 10 * Math.cos(angle - 0.3), y2 - 10 * Math.sin(angle - 0.3));
                ctx.moveTo(x2, y2);
                ctx.lineTo(x2 - 10 * Math.cos(angle + 0.3), y2 - 10 * Math.sin(angle + 0.3));
                ctx.stroke();
            }

            // Draw events
            for (const event of events) {
                const x = padding + event.time * timeScale;
                const y = processY[event.process];

                ctx.fillStyle = processColors[event.process];
                ctx.beginPath();
                ctx.arc(x, y, 10, 0, Math.PI * 2);
                ctx.fill();

                // Event label
                ctx.fillStyle = '#fff';
                ctx.font = '10px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(event.label, x, y - 18);

                // Vector clock
                ctx.fillStyle = '#888';
                ctx.font = '9px monospace';
                ctx.fillText(`[${event.vc.join(',')}]`, x, y + 25);
            }

            // Time axis
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, canvas.height - 30);
            ctx.lineTo(canvas.width - padding / 2, canvas.height - 30);
            ctx.stroke();

            ctx.fillStyle = '#666';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Time →', canvas.width / 2, canvas.height - 10);
        }

        function runScenario() {
            clearAll();
            setTimeout(() => addLocalEvent(0), 100);
            setTimeout(() => {
                document.getElementById('msg-from').value = '0';
                document.getElementById('msg-to').value = '1';
                sendMessage();
            }, 300);
            setTimeout(() => addLocalEvent(2), 500);
            setTimeout(() => addLocalEvent(1), 700);
            setTimeout(() => {
                document.getElementById('msg-from').value = '1';
                document.getElementById('msg-to').value = '2';
                sendMessage();
            }, 900);
            setTimeout(() => {
                document.getElementById('msg-from').value = '2';
                document.getElementById('msg-to').value = '0';
                sendMessage();
            }, 1100);
        }

        function clearAll() {
            vectorClocks = [[0, 0, 0], [0, 0, 0], [0, 0, 0]];
            events = [];
            messages = [];
            timeCounter = 0;
            document.getElementById('event-log').innerHTML = '';
            document.getElementById('comparison-result').innerHTML = '';
            updateEventSelects();
            draw();
        }

        clearAll();
    </script>
</body>
</html>
