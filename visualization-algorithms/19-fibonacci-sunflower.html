<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fibonacci Sunflower - GPU Accelerated</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            overflow: hidden;
            background: #1a0a00;
            font-family: system-ui, -apple-system, sans-serif;
        }

        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            z-index: 1;
        }

        #tech-badge {
            position: absolute;
            bottom: 20px;
            right: 20px;
            color: #667eea;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid #667eea;
        }

        #controls {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            z-index: 1;
        }

        input[type="range"] {
            width: 150px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div id="info">
        <strong>Fibonacci Sunflower Pattern</strong><br>
        Realistic sunflower seed arrangement<br>
        <span id="seedCount">0</span> seeds
    </div>
    <div id="controls">
        <label>Seeds: <span id="seedValue">3000</span></label><br>
        <input type="range" id="seedSlider" min="100" max="8000" value="3000" step="100">
    </div>
    <div id="tech-badge">GPU-Accelerated • Three.js TSL • Mathematical Patterns</div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.169.0/build/three.module.js",
            "three/tsl": "https://unpkg.com/three@0.169.0/build/three.webgpu.js",
            "three/addons/": "https://unpkg.com/three@0.169.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { instanceIndex, float, vec3 } from 'three/tsl';
        import WebGPURenderer from 'three/addons/renderers/webgpu/WebGPURenderer.js';

        // Scene setup
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a0a00);

        const camera = new THREE.OrthographicCamera(
            window.innerWidth / -2, window.innerWidth / 2,
            window.innerHeight / 2, window.innerHeight / -2,
            0.1, 1000
        );
        camera.position.z = 500;

        const renderer = new WebGPURenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        // Constants
        const phi = (1 + Math.sqrt(5)) / 2;
        const goldenAngle = 2 * Math.PI / (phi * phi);
        const maxSeeds = 8000;

        let currentSeedCount = 3000;
        let instancedMesh;

        function createSunflower(numSeeds) {
            // Remove old mesh if exists
            if (instancedMesh) {
                scene.remove(instancedMesh);
                instancedMesh.geometry.dispose();
                instancedMesh.material.dispose();
            }

            // Create seed geometry (more detailed circle)
            const seedGeometry = new THREE.CircleGeometry(1, 32);

            instancedMesh = new THREE.InstancedMesh(
                seedGeometry,
                new THREE.MeshBasicNodeMaterial(),
                numSeeds
            );

            // Generate seed positions
            const matrix = new THREE.Matrix4();
            const scale = 0.5;

            for (let i = 0; i < numSeeds; i++) {
                const angle = i * goldenAngle;
                const radius = scale * Math.sqrt(i) * 10;

                const x = radius * Math.cos(angle);
                const y = radius * Math.sin(angle);

                // Size increases towards edge
                const size = 2 + (i / numSeeds) * 5;

                matrix.makeTranslation(x, y, 0);
                matrix.scale(new THREE.Vector3(size, size, 1));
                instancedMesh.setMatrixAt(i, matrix);
            }

            // TSL material - sunflower colors (yellow-brown gradient)
            const t = instanceIndex.div(numSeeds);

            // Hue: 45 (yellow) to 30 (brown)
            const hue = float(45).sub(t.mul(15));
            const saturation = float(0.8);
            const lightness = float(0.5).sub(t.mul(0.2)); // Darker towards edge

            // HSL to RGB conversion
            const c = saturation.mul(lightness.oneMinus().mul(2).min(1));
            const x = c.mul(hue.div(60).mod(2).sub(1).abs().oneMinus());
            const m = lightness.sub(c.div(2));

            const hueSegment = hue.div(60).floor();
            const r = hueSegment.equal(0).select(c,
                      hueSegment.equal(1).select(x,
                      hueSegment.equal(2).select(0,
                      hueSegment.equal(3).select(0,
                      hueSegment.equal(4).select(x, c))))).add(m);
            const g = hueSegment.equal(0).select(x,
                      hueSegment.equal(1).select(c,
                      hueSegment.equal(2).select(c,
                      hueSegment.equal(3).select(x,
                      hueSegment.equal(4).select(0, 0))))).add(m);
            const b = hueSegment.equal(0).select(0,
                      hueSegment.equal(1).select(0,
                      hueSegment.equal(2).select(x,
                      hueSegment.equal(3).select(c,
                      hueSegment.equal(4).select(c, x))))).add(m);

            instancedMesh.material.colorNode = vec3(r, g, b);

            scene.add(instancedMesh);
            document.getElementById('seedCount').textContent = numSeeds.toLocaleString();
        }

        // Add center disk
        const centerGeometry = new THREE.CircleGeometry(25, 64);
        const centerMaterial = new THREE.MeshBasicMaterial({ color: 0x4a2000 });
        const centerDisk = new THREE.Mesh(centerGeometry, centerMaterial);
        centerDisk.position.z = 1;
        scene.add(centerDisk);

        // Initial sunflower
        createSunflower(currentSeedCount);

        // Controls
        const seedSlider = document.getElementById('seedSlider');
        const seedValue = document.getElementById('seedValue');

        seedSlider.addEventListener('input', (e) => {
            currentSeedCount = parseInt(e.target.value);
            seedValue.textContent = currentSeedCount.toLocaleString();
            createSunflower(currentSeedCount);
        });

        // Animation (gentle rotation)
        let rotation = 0;

        function animate() {
            rotation += 0.0005;
            if (instancedMesh) {
                instancedMesh.rotation.z = rotation;
            }
            centerDisk.rotation.z = rotation;

            renderer.render(scene, camera);
        }

        renderer.setAnimationLoop(animate);

        // Handle window resize
        window.addEventListener('resize', () => {
            camera.left = window.innerWidth / -2;
            camera.right = window.innerWidth / 2;
            camera.top = window.innerHeight / 2;
            camera.bottom = window.innerHeight / -2;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
