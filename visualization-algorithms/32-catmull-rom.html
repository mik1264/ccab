<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catmull-Rom Spline Editor - CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8e8e8;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { text-align: center; padding: 20px; margin-bottom: 20px; }
        h1 {
            font-size: 2.2rem;
            background: linear-gradient(90deg, #9b59b6, #3498db);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subtitle { color: #888; }
        .back-link { position: absolute; top: 20px; left: 20px; color: #9b59b6; text-decoration: none; }
        .main-content { display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
        .canvas-container { background: rgba(255,255,255,0.05); border-radius: 16px; padding: 20px; }
        canvas { display: block; margin: 0 auto; background: #0a0a1a; border-radius: 8px; cursor: crosshair; }
        .controls { display: flex; flex-direction: column; gap: 15px; }
        .panel { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 15px; }
        .panel h3 { color: #9b59b6; font-size: 1rem; margin-bottom: 10px; border-bottom: 1px solid rgba(155,89,182,0.3); padding-bottom: 5px; }
        button {
            padding: 10px 15px; background: rgba(155,89,182,0.2);
            border: 1px solid rgba(155,89,182,0.5); border-radius: 6px;
            color: #9b59b6; cursor: pointer; width: 100%; margin-bottom: 8px;
        }
        button:hover { background: rgba(155,89,182,0.3); }
        .control-group { margin-bottom: 12px; }
        .control-group label { display: block; color: #9b59b6; font-size: 0.85rem; margin-bottom: 5px; }
        input[type="range"] {
            width: 100%; height: 6px; -webkit-appearance: none;
            background: rgba(155,89,182,0.2); border-radius: 3px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 16px; height: 16px;
            background: #9b59b6; border-radius: 50%; cursor: pointer;
        }
        .stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .stat { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; text-align: center; }
        .stat-value { font-size: 1rem; color: #9b59b6; font-weight: bold; }
        .stat-label { font-size: 0.7rem; color: #888; }
        .info-text { font-size: 0.85rem; color: #aaa; line-height: 1.6; }
        .legend { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .legend-item { display: flex; align-items: center; gap: 5px; font-size: 0.8rem; }
        .legend-color { width: 12px; height: 12px; border-radius: 50%; }
        .checkbox-group { display: flex; align-items: center; gap: 10px; margin: 8px 0; }
        .checkbox-group input { width: 18px; height: 18px; accent-color: #9b59b6; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back to Gallery</a>
    <div class="container">
        <header>
            <h1>Catmull-Rom Spline Editor</h1>
            <p class="subtitle">Interactive spline with tension and centripetal parameterization</p>
        </header>
        <div class="main-content">
            <div class="canvas-container">
                <canvas id="canvas" width="900" height="550"></canvas>
            </div>
            <div class="controls">
                <div class="panel">
                    <h3>Add Points</h3>
                    <p class="info-text">Click on canvas to add control points. Drag points to move them.</p>
                    <button onclick="clearPoints()">Clear All Points</button>
                    <button onclick="generatePreset()">Generate Preset</button>
                </div>
                <div class="panel">
                    <h3>Spline Parameters</h3>
                    <div class="control-group">
                        <label>Tension (α): <span id="tension-val">0.5</span></label>
                        <input type="range" id="tension" min="0" max="1" step="0.05" value="0.5">
                    </div>
                    <p class="info-text" style="margin-top: 5px;">
                        α = 0: Uniform<br>
                        α = 0.5: Centripetal (no cusps/loops)<br>
                        α = 1: Chordal
                    </p>
                </div>
                <div class="panel">
                    <h3>Display Options</h3>
                    <div class="checkbox-group">
                        <input type="checkbox" id="show-tangents" checked>
                        <label for="show-tangents">Show Tangents</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="show-control-polygon" checked>
                        <label for="show-control-polygon">Show Control Polygon</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="show-bezier" checked>
                        <label for="show-bezier">Compare with Bezier</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="closed-curve">
                        <label for="closed-curve">Closed Curve</label>
                    </div>
                </div>
                <div class="panel">
                    <h3>Statistics</h3>
                    <div class="stats">
                        <div class="stat">
                            <div class="stat-value" id="point-count">0</div>
                            <div class="stat-label">Control Points</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="segment-count">0</div>
                            <div class="stat-label">Segments</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="curve-length">0</div>
                            <div class="stat-label">Curve Length</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="selected-point">-</div>
                            <div class="stat-label">Selected Point</div>
                        </div>
                    </div>
                </div>
                <div class="panel">
                    <h3>Legend</h3>
                    <div class="legend">
                        <div class="legend-item"><div class="legend-color" style="background: #9b59b6;"></div>Catmull-Rom</div>
                        <div class="legend-item"><div class="legend-color" style="background: #e74c3c;"></div>Bezier (compare)</div>
                        <div class="legend-item"><div class="legend-color" style="background: #3498db;"></div>Control Points</div>
                        <div class="legend-item"><div class="legend-color" style="background: #2ecc71;"></div>Tangents</div>
                    </div>
                </div>
                <div class="panel">
                    <h3>About</h3>
                    <p class="info-text">
                        Catmull-Rom splines interpolate through control points (unlike Bezier).
                        Centripetal parameterization (α=0.5) guarantees no cusps or self-intersections,
                        even with sharp turns in control points.
                    </p>
                </div>
            </div>
        </div>
    </div>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let points = [];
        let selectedPoint = -1;
        let isDragging = false;

        function catmullRomPoint(P0, P1, P2, P3, t, alpha) {
            // Knot sequence based on centripetal parameterization
            function getT(ti, Pi, Pj) {
                const dx = Pj.x - Pi.x;
                const dy = Pj.y - Pi.y;
                return ti + Math.pow(dx * dx + dy * dy, alpha / 2);
            }

            const t0 = 0;
            const t1 = getT(t0, P0, P1);
            const t2 = getT(t1, P1, P2);
            const t3 = getT(t2, P2, P3);

            // Map t from [0,1] to [t1, t2]
            const tMapped = t1 + t * (t2 - t1);

            // De Boor-like interpolation
            function lerp(a, b, w, ti, tj) {
                const denom = tj - ti;
                if (Math.abs(denom) < 0.0001) return a;
                const wt = (w - ti) / denom;
                return { x: a.x + wt * (b.x - a.x), y: a.y + wt * (b.y - a.y) };
            }

            const A1 = lerp(P0, P1, tMapped, t0, t1);
            const A2 = lerp(P1, P2, tMapped, t1, t2);
            const A3 = lerp(P2, P3, tMapped, t2, t3);

            const B1 = lerp(A1, A2, tMapped, t0, t2);
            const B2 = lerp(A2, A3, tMapped, t1, t3);

            const C = lerp(B1, B2, tMapped, t1, t2);

            return C;
        }

        function catmullRomTangent(P0, P1, P2, P3, t, alpha) {
            const epsilon = 0.001;
            const p1 = catmullRomPoint(P0, P1, P2, P3, Math.max(0, t - epsilon), alpha);
            const p2 = catmullRomPoint(P0, P1, P2, P3, Math.min(1, t + epsilon), alpha);
            const dx = p2.x - p1.x;
            const dy = p2.y - p1.y;
            const len = Math.sqrt(dx * dx + dy * dy);
            return { x: dx / len, y: dy / len };
        }

        function bezierPoint(P0, P1, P2, P3, t) {
            const mt = 1 - t;
            return {
                x: mt * mt * mt * P0.x + 3 * mt * mt * t * P1.x + 3 * mt * t * t * P2.x + t * t * t * P3.x,
                y: mt * mt * mt * P0.y + 3 * mt * mt * t * P1.y + 3 * mt * t * t * P2.y + t * t * t * P3.y
            };
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const alpha = parseFloat(document.getElementById('tension').value);
            const showTangents = document.getElementById('show-tangents').checked;
            const showPolygon = document.getElementById('show-control-polygon').checked;
            const showBezier = document.getElementById('show-bezier').checked;
            const closedCurve = document.getElementById('closed-curve').checked;

            if (points.length < 2) {
                ctx.fillStyle = '#666';
                ctx.font = '18px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('Click to add control points (need at least 4 for spline)', canvas.width / 2, canvas.height / 2);
            }

            // Control polygon
            if (showPolygon && points.length >= 2) {
                ctx.strokeStyle = 'rgba(52, 152, 219, 0.4)';
                ctx.lineWidth = 1;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(points[0].x, points[0].y);
                for (let i = 1; i < points.length; i++) {
                    ctx.lineTo(points[i].x, points[i].y);
                }
                if (closedCurve) {
                    ctx.lineTo(points[0].x, points[0].y);
                }
                ctx.stroke();
                ctx.setLineDash([]);
            }

            // Draw Bezier for comparison
            if (showBezier && points.length >= 4) {
                ctx.strokeStyle = 'rgba(231, 76, 60, 0.5)';
                ctx.lineWidth = 2;
                ctx.beginPath();

                for (let i = 0; i + 3 < points.length; i += 3) {
                    for (let t = 0; t <= 1; t += 0.02) {
                        const p = bezierPoint(points[i], points[i + 1], points[i + 2], points[i + 3], t);
                        if (t === 0 && i === 0) ctx.moveTo(p.x, p.y);
                        else ctx.lineTo(p.x, p.y);
                    }
                }
                ctx.stroke();
            }

            // Draw Catmull-Rom spline
            if (points.length >= 4) {
                ctx.strokeStyle = '#9b59b6';
                ctx.lineWidth = 3;
                ctx.beginPath();

                let curveLength = 0;
                let prevPoint = null;

                const n = closedCurve ? points.length : points.length - 3;

                for (let i = 0; i < n; i++) {
                    const idx = (i) => {
                        if (closedCurve) return (i + points.length) % points.length;
                        return i;
                    };

                    let P0, P1, P2, P3;
                    if (closedCurve) {
                        P0 = points[idx(i - 1)];
                        P1 = points[idx(i)];
                        P2 = points[idx(i + 1)];
                        P3 = points[idx(i + 2)];
                    } else {
                        if (i > points.length - 4) continue;
                        P0 = points[i];
                        P1 = points[i + 1];
                        P2 = points[i + 2];
                        P3 = points[i + 3];
                    }

                    for (let t = 0; t <= 1; t += 0.02) {
                        const p = catmullRomPoint(P0, P1, P2, P3, t, alpha);
                        if (i === 0 && t === 0) {
                            ctx.moveTo(p.x, p.y);
                        } else {
                            ctx.lineTo(p.x, p.y);
                        }

                        if (prevPoint) {
                            curveLength += Math.sqrt((p.x - prevPoint.x) ** 2 + (p.y - prevPoint.y) ** 2);
                        }
                        prevPoint = p;
                    }
                }
                ctx.stroke();

                document.getElementById('curve-length').textContent = Math.round(curveLength);

                // Draw tangents at control points
                if (showTangents) {
                    ctx.strokeStyle = '#2ecc71';
                    ctx.lineWidth = 1.5;

                    for (let i = 0; i < n; i++) {
                        let P0, P1, P2, P3;
                        if (closedCurve) {
                            const idx = (j) => (j + points.length) % points.length;
                            P0 = points[idx(i - 1)];
                            P1 = points[idx(i)];
                            P2 = points[idx(i + 1)];
                            P3 = points[idx(i + 2)];
                        } else {
                            if (i > points.length - 4) continue;
                            P0 = points[i];
                            P1 = points[i + 1];
                            P2 = points[i + 2];
                            P3 = points[i + 3];
                        }

                        // Tangent at P1 (start of segment)
                        const tan = catmullRomTangent(P0, P1, P2, P3, 0, alpha);
                        const tangentLength = 40;

                        ctx.beginPath();
                        ctx.moveTo(P1.x - tan.x * tangentLength, P1.y - tan.y * tangentLength);
                        ctx.lineTo(P1.x + tan.x * tangentLength, P1.y + tan.y * tangentLength);
                        ctx.stroke();
                    }
                }
            }

            // Draw control points
            for (let i = 0; i < points.length; i++) {
                const p = points[i];
                ctx.fillStyle = i === selectedPoint ? '#f39c12' : '#3498db';
                ctx.beginPath();
                ctx.arc(p.x, p.y, i === selectedPoint ? 10 : 8, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = '#fff';
                ctx.font = 'bold 10px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(i, p.x, p.y + 3);
            }

            // Update stats
            document.getElementById('point-count').textContent = points.length;
            document.getElementById('segment-count').textContent = closedCurve ? points.length : Math.max(0, points.length - 3);
            document.getElementById('selected-point').textContent = selectedPoint >= 0 ? selectedPoint : '-';
        }

        canvas.addEventListener('mousedown', e => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // Check if clicking on existing point
            for (let i = 0; i < points.length; i++) {
                const dx = points[i].x - x;
                const dy = points[i].y - y;
                if (dx * dx + dy * dy < 144) { // 12px radius
                    selectedPoint = i;
                    isDragging = true;
                    draw();
                    return;
                }
            }

            // Add new point
            points.push({ x, y });
            selectedPoint = points.length - 1;
            draw();
        });

        canvas.addEventListener('mousemove', e => {
            if (!isDragging || selectedPoint < 0) return;

            const rect = canvas.getBoundingClientRect();
            points[selectedPoint].x = e.clientX - rect.left;
            points[selectedPoint].y = e.clientY - rect.top;
            draw();
        });

        canvas.addEventListener('mouseup', () => {
            isDragging = false;
        });

        canvas.addEventListener('dblclick', e => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // Delete point if double-clicked
            for (let i = 0; i < points.length; i++) {
                const dx = points[i].x - x;
                const dy = points[i].y - y;
                if (dx * dx + dy * dy < 144) {
                    points.splice(i, 1);
                    selectedPoint = -1;
                    draw();
                    return;
                }
            }
        });

        function clearPoints() {
            points = [];
            selectedPoint = -1;
            draw();
        }

        function generatePreset() {
            points = [];
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            const n = 6;
            const r = 180;

            for (let i = 0; i < n; i++) {
                const angle = (i / n) * Math.PI * 2 - Math.PI / 2;
                const rr = r + (Math.random() - 0.5) * 60;
                points.push({
                    x: cx + rr * Math.cos(angle),
                    y: cy + rr * Math.sin(angle)
                });
            }

            selectedPoint = -1;
            draw();
        }

        // Event listeners
        document.getElementById('tension').addEventListener('input', e => {
            document.getElementById('tension-val').textContent = e.target.value;
            draw();
        });

        ['show-tangents', 'show-control-polygon', 'show-bezier', 'closed-curve'].forEach(id => {
            document.getElementById(id).addEventListener('change', draw);
        });

        generatePreset();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
