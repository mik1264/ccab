<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Urban Sprawl Cellular Automaton</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; overflow: hidden; font-family: sans-serif; }
canvas { display: block; }
#title { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); color: #fbbf24; font-size: 18px; font-family: sans-serif; z-index: 999; text-shadow: 0 0 10px rgba(251,191,36,0.5); pointer-events: none; }
#ui { position: fixed; top: 10px; right: 10px; z-index: 999; }
.panel { background: rgba(0,0,0,0.75); color: #e0e0e0; padding: 12px 16px; border-radius: 8px; font-size: 13px; min-width: 190px; }
.panel label { display: block; margin: 6px 0 2px; color: #fbbf24; }
.panel input[type=range] { width: 100%; }
.panel button { background: #fbbf24; color: #0a0e1a; border: none; padding: 6px 14px; border-radius: 4px; cursor: pointer; font-size: 13px; margin-top: 6px; width: 100%; }
.panel button:hover { background: #f59e0b; }
#stats { color: #aaa; margin-top: 8px; line-height: 1.6; }
.legend { margin-top: 8px; }
.legend-item { display: flex; align-items: center; gap: 6px; margin: 2px 0; font-size: 11px; }
.legend-dot { width: 12px; height: 12px; border-radius: 2px; display: inline-block; }
</style>
</head>
<body>
<a href="../index.html" style="position:fixed;top:10px;left:10px;padding:8px 16px;background:rgba(0,0,0,0.7);color:#fbbf24;text-decoration:none;border-radius:6px;font-size:14px;z-index:999;font-family:sans-serif;">‚Üê Back to Gallery</a>
<div id="title">Urban Sprawl Cellular Automaton</div>
<div id="ui">
    <div class="panel">
        <label>Speed: <span id="spdVal">5</span> steps/frame</label>
        <input type="range" id="speed" min="1" max="20" value="5">
        <label>Growth Rate: <span id="grVal">50</span>%</label>
        <input type="range" id="growthRate" min="10" max="100" value="50">
        <label>Road Tendency: <span id="rtVal">30</span>%</label>
        <input type="range" id="roadTend" min="5" max="80" value="30">
        <button id="resetBtn">Reset</button>
        <div class="legend">
            <div class="legend-item"><span class="legend-dot" style="background:#1a1a2e;"></span> Empty Land</div>
            <div class="legend-item"><span class="legend-dot" style="background:#555;"></span> Road</div>
            <div class="legend-item"><span class="legend-dot" style="background:#3b82f6;"></span> Residential</div>
            <div class="legend-item"><span class="legend-dot" style="background:#f59e0b;"></span> Commercial</div>
            <div class="legend-item"><span class="legend-dot" style="background:#8b5cf6;"></span> Industrial</div>
            <div class="legend-item"><span class="legend-dot" style="background:#22c55e;"></span> Park</div>
        </div>
        <div id="stats"></div>
    </div>
</div>
<canvas id="canvas"></canvas>
<script>
(function() {
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let W, H, gridW, gridH, cellSize;
    let grid, nextGrid;
    let speed = 5;
    let growthRate = 50;
    let roadTendency = 30;
    let generation = 0;

    // Cell types
    const EMPTY = 0, ROAD = 1, RESIDENTIAL = 2, COMMERCIAL = 3, INDUSTRIAL = 4, PARK = 5;
    const colors = ['#0d1117', '#555555', '#3b82f6', '#f59e0b', '#8b5cf6', '#22c55e'];
    const glowColors = ['', 'rgba(100,100,100,', 'rgba(59,130,246,', 'rgba(245,158,11,', 'rgba(139,92,246,', 'rgba(34,197,94,'];

    document.getElementById('speed').addEventListener('input', function() {
        speed = parseInt(this.value);
        document.getElementById('spdVal').textContent = speed;
    });
    document.getElementById('growthRate').addEventListener('input', function() {
        growthRate = parseInt(this.value);
        document.getElementById('grVal').textContent = growthRate;
    });
    document.getElementById('roadTend').addEventListener('input', function() {
        roadTendency = parseInt(this.value);
        document.getElementById('rtVal').textContent = roadTendency;
    });
    document.getElementById('resetBtn').addEventListener('click', init);

    function resize() {
        W = canvas.width = window.innerWidth;
        H = canvas.height = window.innerHeight;
        cellSize = 4;
        gridW = Math.floor(W / cellSize);
        gridH = Math.floor(H / cellSize);
    }

    function init() {
        resize();
        grid = new Uint8Array(gridW * gridH);
        nextGrid = new Uint8Array(gridW * gridH);
        generation = 0;

        const cx = Math.floor(gridW / 2);
        const cy = Math.floor(gridH / 2);

        // Seed: small town center
        // Central commercial area
        for (let dy = -2; dy <= 2; dy++) {
            for (let dx = -2; dx <= 2; dx++) {
                grid[(cy + dy) * gridW + (cx + dx)] = COMMERCIAL;
            }
        }

        // Initial roads (cross pattern)
        for (let i = -20; i <= 20; i++) {
            grid[cy * gridW + (cx + i)] = ROAD;
            grid[(cy + i) * gridW + cx] = ROAD;
        }

        // Some initial residential
        for (let i = 0; i < 30; i++) {
            const angle = Math.random() * Math.PI * 2;
            const r = 3 + Math.random() * 8;
            const x = Math.floor(cx + Math.cos(angle) * r);
            const y = Math.floor(cy + Math.sin(angle) * r);
            if (x > 0 && x < gridW && y > 0 && y < gridH && grid[y * gridW + x] === EMPTY) {
                grid[y * gridW + x] = RESIDENTIAL;
            }
        }
    }

    function countNeighbors(x, y, type) {
        let count = 0;
        for (let dy = -2; dy <= 2; dy++) {
            for (let dx = -2; dx <= 2; dx++) {
                if (dx === 0 && dy === 0) continue;
                const nx = x + dx, ny = y + dy;
                if (nx >= 0 && nx < gridW && ny >= 0 && ny < gridH) {
                    if (grid[ny * gridW + nx] === type) count++;
                }
            }
        }
        return count;
    }

    function hasNearby(x, y, type, radius) {
        for (let dy = -radius; dy <= radius; dy++) {
            for (let dx = -radius; dx <= radius; dx++) {
                const nx = x + dx, ny = y + dy;
                if (nx >= 0 && nx < gridW && ny >= 0 && ny < gridH) {
                    if (grid[ny * gridW + nx] === type) return true;
                }
            }
        }
        return false;
    }

    function simulate() {
        for (let i = 0; i < grid.length; i++) nextGrid[i] = grid[i];

        for (let y = 1; y < gridH - 1; y++) {
            for (let x = 1; x < gridW - 1; x++) {
                const idx = y * gridW + x;
                const cell = grid[idx];

                if (cell !== EMPTY) continue;
                if (Math.random() * 100 > growthRate) continue;

                const roadN = countNeighbors(x, y, ROAD);
                const resN = countNeighbors(x, y, RESIDENTIAL);
                const comN = countNeighbors(x, y, COMMERCIAL);
                const indN = countNeighbors(x, y, INDUSTRIAL);
                const parkN = countNeighbors(x, y, PARK);
                const totalDev = roadN + resN + comN + indN + parkN;

                if (totalDev === 0) continue; // Must be adjacent to something

                // Road extension
                if (roadN >= 1 && roadN <= 3 && Math.random() * 100 < roadTendency) {
                    // Roads tend to extend in straight lines
                    const above = y > 0 ? grid[(y - 1) * gridW + x] : 0;
                    const below = y < gridH - 1 ? grid[(y + 1) * gridW + x] : 0;
                    const left = x > 0 ? grid[y * gridW + (x - 1)] : 0;
                    const right = x < gridW - 1 ? grid[y * gridW + (x + 1)] : 0;

                    if (above === ROAD || below === ROAD || left === ROAD || right === ROAD) {
                        nextGrid[idx] = ROAD;
                        continue;
                    }
                }

                // Must be near a road for development
                if (!hasNearby(x, y, ROAD, 3)) continue;

                // Residential: grows near roads and other residential, away from industrial
                if (resN >= 1 && indN === 0 && Math.random() < 0.15) {
                    nextGrid[idx] = RESIDENTIAL;
                    continue;
                }

                // Commercial: grows near residential clusters and roads
                if (resN >= 3 && comN < 3 && roadN >= 1 && Math.random() < 0.08) {
                    nextGrid[idx] = COMMERCIAL;
                    continue;
                }

                // Industrial: grows away from residential, near roads
                if (resN === 0 && roadN >= 1 && Math.random() < 0.04) {
                    const cx = gridW / 2, cy2 = gridH / 2;
                    const dist = Math.sqrt((x - cx) ** 2 + (y - cy2) ** 2);
                    if (dist > 15) {
                        nextGrid[idx] = INDUSTRIAL;
                        continue;
                    }
                }

                // Park: occasional, near residential
                if (resN >= 2 && parkN === 0 && Math.random() < 0.02) {
                    nextGrid[idx] = PARK;
                    continue;
                }

                // Spontaneous residential near roads
                if (roadN >= 1 && Math.random() < 0.03) {
                    nextGrid[idx] = RESIDENTIAL;
                }
            }
        }

        const tmp = grid;
        grid = nextGrid;
        nextGrid = tmp;
        generation++;
    }

    function draw() {
        ctx.fillStyle = '#0a0e1a';
        ctx.fillRect(0, 0, W, H);

        let counts = [0, 0, 0, 0, 0, 0];

        // Draw cells with subtle glow effect
        for (let y = 0; y < gridH; y++) {
            for (let x = 0; x < gridW; x++) {
                const cell = grid[y * gridW + x];
                counts[cell]++;
                if (cell === EMPTY) continue;

                ctx.fillStyle = colors[cell];
                ctx.fillRect(x * cellSize, y * cellSize, cellSize, cellSize);
            }
        }

        // Draw glow overlay for developed areas (performance-optimized: sample)
        ctx.globalCompositeOperation = 'lighter';
        for (let y = 0; y < gridH; y += 3) {
            for (let x = 0; x < gridW; x += 3) {
                const cell = grid[y * gridW + x];
                if (cell > 0 && cell !== ROAD) {
                    ctx.fillStyle = glowColors[cell] + '0.03)';
                    ctx.beginPath();
                    ctx.arc(x * cellSize, y * cellSize, cellSize * 3, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
        }
        ctx.globalCompositeOperation = 'source-over';

        // Population estimate
        const population = counts[RESIDENTIAL] * 5 + counts[COMMERCIAL] * 2;

        document.getElementById('stats').innerHTML =
            `Generation: ${generation}<br>` +
            `Population: ~${population.toLocaleString()}<br>` +
            `Roads: ${counts[ROAD].toLocaleString()}<br>` +
            `Residential: ${counts[RESIDENTIAL].toLocaleString()}<br>` +
            `Commercial: ${counts[COMMERCIAL].toLocaleString()}<br>` +
            `Industrial: ${counts[INDUSTRIAL].toLocaleString()}<br>` +
            `Parks: ${counts[PARK].toLocaleString()}`;
    }

    window.addEventListener('resize', function() {
        const oldGrid = grid;
        const oldW = gridW, oldH = gridH;
        resize();
        grid = new Uint8Array(gridW * gridH);
        nextGrid = new Uint8Array(gridW * gridH);
        const cW = Math.min(oldW, gridW);
        const cH = Math.min(oldH, gridH);
        for (let y = 0; y < cH; y++) {
            for (let x = 0; x < cW; x++) {
                grid[y * gridW + x] = oldGrid[y * oldW + x];
            }
        }
    });

    function animate() {
        for (let i = 0; i < speed; i++) simulate();
        draw();
        requestAnimationFrame(animate);
    }

    init();
    animate();
})();
</script>
</body>
</html>
