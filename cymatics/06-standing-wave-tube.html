<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Standing Wave Tube (Kundt's Tube) - Cymatics - CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0a0e1a;
            color: #e0e0e0;
            font-family: 'Segoe UI', system-ui, sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }
        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }
        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            color: #8A9A5B;
            text-decoration: none;
            font-weight: 600;
            background: rgba(10, 14, 26, 0.8);
            border-radius: 25px;
            border: 2px solid #8A9A5B;
            padding: 10px 20px;
            transition: background 0.3s, transform 0.3s;
        }
        .back-link:hover {
            background: rgba(138, 154, 91, 0.2);
            transform: translateX(-3px);
        }
        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(10, 14, 26, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 20px;
            max-width: 300px;
            border: 1px solid rgba(138, 154, 91, 0.3);
        }
        .controls h3 {
            color: #8A9A5B;
            margin-bottom: 15px;
            font-size: 1rem;
        }
        .control-group {
            margin-bottom: 12px;
        }
        .control-group label {
            display: block;
            color: #8A9A5B;
            font-size: 0.8rem;
            margin-bottom: 4px;
        }
        .control-group input[type="range"] {
            width: 100%;
            accent-color: #8A9A5B;
        }
        .control-group .value {
            color: #aaa;
            font-size: 0.75rem;
            text-align: right;
        }
        .toggle-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }
        .toggle-btn {
            padding: 5px 12px;
            background: rgba(138, 154, 91, 0.15);
            border: 1px solid rgba(138, 154, 91, 0.4);
            border-radius: 15px;
            color: #8A9A5B;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        .toggle-btn.active {
            background: rgba(138, 154, 91, 0.4);
            border-color: #8A9A5B;
            color: #fff;
        }
        .toggle-btn:hover {
            background: rgba(138, 154, 91, 0.3);
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">&larr; Cymatics</a>
    <div class="controls">
        <h3>Kundt's Tube</h3>
        <div class="control-group">
            <label>Harmonic: <span id="harmonicVal">1</span></label>
            <input type="range" id="harmonic" min="1" max="8" value="1" step="1">
        </div>
        <div class="control-group">
            <label>Tube Length: <span id="tubeLenVal">80%</span></label>
            <input type="range" id="tubeLen" min="40" max="95" value="80" step="1">
        </div>
        <div class="control-group">
            <label>Amplitude: <span id="ampVal">70%</span></label>
            <input type="range" id="amplitude" min="10" max="100" value="70" step="1">
        </div>
        <div class="toggle-group">
            <button class="toggle-btn active" id="showPressure">Pressure</button>
            <button class="toggle-btn active" id="showDisplacement">Displacement</button>
        </div>
    </div>
    <canvas id="canvas"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let W, H;
        function resize() {
            W = canvas.width = window.innerWidth;
            H = canvas.height = window.innerHeight;
        }
        resize();
        window.addEventListener('resize', resize);

        // Controls
        const harmonicSlider = document.getElementById('harmonic');
        const tubeLenSlider = document.getElementById('tubeLen');
        const ampSlider = document.getElementById('amplitude');
        const pressureBtn = document.getElementById('showPressure');
        const displacementBtn = document.getElementById('showDisplacement');

        let harmonicNum = 1;
        let tubeLenPct = 0.8;
        let amplitude = 0.7;
        let showPressure = true;
        let showDisplacement = true;

        harmonicSlider.addEventListener('input', e => {
            harmonicNum = parseInt(e.target.value);
            document.getElementById('harmonicVal').textContent = harmonicNum;
        });
        tubeLenSlider.addEventListener('input', e => {
            tubeLenPct = parseInt(e.target.value) / 100;
            document.getElementById('tubeLenVal').textContent = e.target.value + '%';
        });
        ampSlider.addEventListener('input', e => {
            amplitude = parseInt(e.target.value) / 100;
            document.getElementById('ampVal').textContent = e.target.value + '%';
        });
        pressureBtn.addEventListener('click', () => {
            showPressure = !showPressure;
            pressureBtn.classList.toggle('active', showPressure);
        });
        displacementBtn.addEventListener('click', () => {
            showDisplacement = !showDisplacement;
            displacementBtn.classList.toggle('active', showDisplacement);
        });

        // Particle system for displacement visualization
        const NUM_PARTICLES = 600;
        let particles = [];
        function initParticles() {
            particles = [];
            for (let i = 0; i < NUM_PARTICLES; i++) {
                particles.push({
                    baseX: Math.random(),
                    y: Math.random()
                });
            }
        }
        initParticles();

        let time = 0;
        let paused = false;

        function animate() {
            requestAnimationFrame(animate);
            if (paused) return;

            time += 0.03;

            ctx.fillStyle = '#0a0e1a';
            ctx.fillRect(0, 0, W, H);

            const tubeW = W * tubeLenPct;
            const tubeH = H * 0.35;
            const tubeX = (W - tubeW) / 2;
            const tubeY = (H - tubeH) / 2;

            // Number of half-wavelengths for closed-closed tube: n
            const n = harmonicNum;
            const freq = n * 2.5; // angular frequency scales with harmonic

            // Draw tube outline
            ctx.strokeStyle = 'rgba(138, 154, 91, 0.5)';
            ctx.lineWidth = 3;
            ctx.strokeRect(tubeX, tubeY, tubeW, tubeH);

            // End caps
            ctx.fillStyle = 'rgba(138, 154, 91, 0.3)';
            ctx.fillRect(tubeX - 8, tubeY, 8, tubeH);
            ctx.fillRect(tubeX + tubeW, tubeY, 8, tubeH);

            // Pressure visualization (color gradient along tube)
            if (showPressure) {
                const pressRes = 400;
                const segW = tubeW / pressRes;
                for (let i = 0; i < pressRes; i++) {
                    const xNorm = i / pressRes; // 0..1 along tube
                    // Pressure in a closed-closed tube: cos(n*pi*x/L) * cos(omega*t)
                    const pressure = Math.cos(n * Math.PI * xNorm) * Math.cos(freq * time);
                    const pAmp = pressure * amplitude;

                    // Map to color: high pressure = warm red, low = cool blue
                    let r, g, b;
                    if (pAmp > 0) {
                        r = Math.floor(80 + 175 * pAmp);
                        g = Math.floor(30 + 40 * pAmp);
                        b = Math.floor(40);
                    } else {
                        const v = -pAmp;
                        r = Math.floor(30);
                        g = Math.floor(40 + 60 * v);
                        b = Math.floor(80 + 175 * v);
                    }
                    ctx.fillStyle = `rgba(${r},${g},${b},0.6)`;
                    ctx.fillRect(tubeX + i * segW, tubeY, segW + 1, tubeH);
                }

                // Pressure label
                ctx.fillStyle = 'rgba(255,255,255,0.5)';
                ctx.font = '12px sans-serif';
                ctx.fillText('Pressure', tubeX, tubeY - 30);

                // Draw pressure wave curve
                ctx.beginPath();
                ctx.strokeStyle = 'rgba(255, 120, 80, 0.8)';
                ctx.lineWidth = 2;
                for (let i = 0; i <= pressRes; i++) {
                    const xNorm = i / pressRes;
                    const pressure = Math.cos(n * Math.PI * xNorm) * Math.cos(freq * time) * amplitude;
                    const px = tubeX + i * segW;
                    const py = tubeY - 20 + pressure * -15;
                    if (i === 0) ctx.moveTo(px, py);
                    else ctx.lineTo(px, py);
                }
                ctx.stroke();
            }

            // Displacement visualization (particles)
            if (showDisplacement) {
                // Displacement in closed-closed tube: sin(n*pi*x/L) * sin(omega*t)
                for (let i = 0; i < particles.length; i++) {
                    const p = particles[i];
                    const xNorm = p.baseX;
                    // Displacement amplitude depends on position
                    const dispAmp = Math.sin(n * Math.PI * xNorm);
                    // Actual displacement oscillates in time
                    const disp = dispAmp * Math.sin(freq * time) * amplitude * 0.04;

                    const px = tubeX + (xNorm + disp) * tubeW;
                    const py = tubeY + p.y * tubeH;

                    // Color based on displacement magnitude
                    const mag = Math.abs(dispAmp);
                    const alpha = 0.3 + 0.7 * mag;
                    const green = Math.floor(150 + 105 * mag);
                    ctx.fillStyle = `rgba(200, ${green}, 80, ${alpha})`;
                    ctx.beginPath();
                    ctx.arc(px, py, 2 + mag * 2, 0, Math.PI * 2);
                    ctx.fill();
                }

                // Displacement wave envelope
                ctx.beginPath();
                ctx.strokeStyle = 'rgba(200, 255, 80, 0.6)';
                ctx.lineWidth = 2;
                const envRes = 200;
                for (let i = 0; i <= envRes; i++) {
                    const xNorm = i / envRes;
                    const env = Math.abs(Math.sin(n * Math.PI * xNorm)) * amplitude;
                    const px = tubeX + xNorm * tubeW;
                    const py = tubeY + tubeH + 30 + env * -20;
                    if (i === 0) ctx.moveTo(px, py);
                    else ctx.lineTo(px, py);
                }
                ctx.stroke();
                ctx.beginPath();
                for (let i = 0; i <= envRes; i++) {
                    const xNorm = i / envRes;
                    const env = Math.abs(Math.sin(n * Math.PI * xNorm)) * amplitude;
                    const px = tubeX + xNorm * tubeW;
                    const py = tubeY + tubeH + 30 + env * 20;
                    if (i === 0) ctx.moveTo(px, py);
                    else ctx.lineTo(px, py);
                }
                ctx.stroke();

                ctx.fillStyle = 'rgba(255,255,255,0.5)';
                ctx.font = '12px sans-serif';
                ctx.fillText('Displacement Envelope', tubeX, tubeY + tubeH + 60);
            }

            // Node and antinode labels
            ctx.font = 'bold 14px sans-serif';
            // For closed-closed tube:
            // Pressure nodes (displacement antinodes) at x = (2k-1)/(2n) for k=1..n
            // Pressure antinodes (displacement nodes) at x = k/n for k=0..n
            for (let k = 0; k <= n; k++) {
                const xNorm = k / n;
                const px = tubeX + xNorm * tubeW;

                // Pressure antinode = displacement node
                ctx.fillStyle = 'rgba(100, 180, 255, 0.8)';
                ctx.fillText('N', px - 4, tubeY + tubeH + 80);

                // Tick mark
                ctx.strokeStyle = 'rgba(100, 180, 255, 0.4)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(px, tubeY + tubeH);
                ctx.lineTo(px, tubeY + tubeH + 70);
                ctx.stroke();
            }
            for (let k = 1; k <= n; k++) {
                const xNorm = (2 * k - 1) / (2 * n);
                const px = tubeX + xNorm * tubeW;

                // Pressure node = displacement antinode
                ctx.fillStyle = 'rgba(255, 160, 80, 0.8)';
                ctx.fillText('A', px - 4, tubeY + tubeH + 80);

                ctx.strokeStyle = 'rgba(255, 160, 80, 0.4)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.setLineDash([4, 4]);
                ctx.moveTo(px, tubeY + tubeH);
                ctx.lineTo(px, tubeY + tubeH + 70);
                ctx.stroke();
                ctx.setLineDash([]);
            }

            // Info text
            ctx.fillStyle = 'rgba(255,255,255,0.6)';
            ctx.font = '13px sans-serif';
            const halfWaves = n;
            ctx.fillText(`Harmonic ${n}: ${halfWaves} half-wavelength${halfWaves > 1 ? 's' : ''} in tube`, tubeX, tubeY - 50);
            ctx.fillText('N = Displacement Node (particles stationary)  A = Displacement Antinode (max motion)', tubeX, tubeY + tubeH + 100);
        }

        animate();

        // Pause/play
        window.addEventListener('keydown', e => {
            if (e.code === 'Space') {
                e.preventDefault();
                paused = !paused;
            }
        });

        window.reset = function() {
            time = 0;
            harmonicNum = 1;
            tubeLenPct = 0.8;
            amplitude = 0.7;
            showPressure = true;
            showDisplacement = true;
            harmonicSlider.value = 1;
            tubeLenSlider.value = 80;
            ampSlider.value = 70;
            document.getElementById('harmonicVal').textContent = '1';
            document.getElementById('tubeLenVal').textContent = '80%';
            document.getElementById('ampVal').textContent = '70%';
            pressureBtn.classList.add('active');
            displacementBtn.classList.add('active');
            initParticles();
        };
    </script>
    <script src="../assets/js/enhance.js"></script>
</body>
</html>