<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harmonic Series / Fourier Synthesis - Cymatics - CCAB</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0a0e1a;
            color: #e0e0e0;
            font-family: 'Segoe UI', system-ui, sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }
        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }
        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            color: #8A9A5B;
            text-decoration: none;
            font-weight: 600;
            background: rgba(10, 14, 26, 0.8);
            border-radius: 25px;
            border: 2px solid #8A9A5B;
            padding: 10px 20px;
            transition: background 0.3s, transform 0.3s;
        }
        .back-link:hover {
            background: rgba(138, 154, 91, 0.2);
            transform: translateX(-3px);
        }
        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(10, 14, 26, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 20px;
            max-width: 300px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            border: 1px solid rgba(138, 154, 91, 0.3);
        }
        .controls h3 {
            color: #8A9A5B;
            margin-bottom: 12px;
            font-size: 1rem;
        }
        .control-group {
            margin-bottom: 10px;
        }
        .control-group label {
            display: block;
            color: #8A9A5B;
            font-size: 0.8rem;
            margin-bottom: 3px;
        }
        .control-group input[type="range"] {
            width: 100%;
            accent-color: #8A9A5B;
        }
        .preset-group {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }
        .preset-btn {
            padding: 5px 10px;
            background: rgba(138, 154, 91, 0.15);
            border: 1px solid rgba(138, 154, 91, 0.4);
            border-radius: 15px;
            color: #8A9A5B;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        .preset-btn.active {
            background: rgba(138, 154, 91, 0.4);
            border-color: #8A9A5B;
            color: #fff;
        }
        .preset-btn:hover {
            background: rgba(138, 154, 91, 0.3);
        }
        .harmonic-toggles {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
            margin-bottom: 10px;
        }
        .h-toggle {
            padding: 4px;
            text-align: center;
            font-size: 0.7rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .h-toggle.on {
            border-color: currentColor;
            font-weight: bold;
        }
        .h-toggle.off {
            opacity: 0.3;
        }
        .section-label {
            color: rgba(138, 154, 91, 0.7);
            font-size: 0.7rem;
            margin: 8px 0 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">&larr; Cymatics</a>
    <div class="controls">
        <h3>Fourier Synthesis</h3>
        <div class="control-group">
            <label>Fundamental: <span id="fundVal">2</span> Hz</label>
            <input type="range" id="fundamental" min="0.5" max="8" value="2" step="0.5">
        </div>
        <div class="control-group">
            <label>Harmonics: <span id="numVal">8</span></label>
            <input type="range" id="numHarmonics" min="1" max="16" value="8" step="1">
        </div>
        <div class="section-label">Presets</div>
        <div class="preset-group">
            <button class="preset-btn active" data-preset="sawtooth">Sawtooth</button>
            <button class="preset-btn" data-preset="square">Square</button>
            <button class="preset-btn" data-preset="triangle">Triangle</button>
            <button class="preset-btn" data-preset="pulse">Pulse</button>
        </div>
        <div class="section-label">Toggle Harmonics</div>
        <div class="harmonic-toggles" id="toggles"></div>
    </div>
    <canvas id="canvas"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let W, H;
        function resize() {
            W = canvas.width = window.innerWidth;
            H = canvas.height = window.innerHeight;
        }
        resize();
        window.addEventListener('resize', resize);

        // Rainbow colors for harmonics
        function harmonicColor(n, total) {
            const hue = (n / total) * 300; // 0 to 300 (red through purple)
            return `hsl(${hue}, 80%, 60%)`;
        }

        // State
        let fundamentalFreq = 2;
        let numHarmonics = 8;
        let activePreset = 'sawtooth';
        let harmonicEnabled = new Array(16).fill(true);
        let harmonicAmplitudes = new Array(16).fill(0);

        function computeAmplitudes() {
            for (let i = 0; i < 16; i++) {
                const n = i + 1;
                switch (activePreset) {
                    case 'sawtooth':
                        // All harmonics, amplitude = 1/n, alternating sign
                        harmonicAmplitudes[i] = (n <= numHarmonics) ? (1 / n) * (n % 2 === 0 ? -1 : 1) : 0;
                        break;
                    case 'square':
                        // Odd harmonics only, amplitude = 1/n
                        harmonicAmplitudes[i] = (n <= numHarmonics && n % 2 === 1) ? (1 / n) : 0;
                        break;
                    case 'triangle':
                        // Odd harmonics only, amplitude = 1/n^2, alternating sign
                        harmonicAmplitudes[i] = (n <= numHarmonics && n % 2 === 1)
                            ? (1 / (n * n)) * ((Math.floor(n / 2) % 2 === 0) ? 1 : -1)
                            : 0;
                        break;
                    case 'pulse':
                        // All harmonics, equal amplitude (sharp pulse)
                        harmonicAmplitudes[i] = (n <= numHarmonics) ? (0.8 / numHarmonics) : 0;
                        break;
                }
            }
        }
        computeAmplitudes();

        // Build toggle buttons
        function buildToggles() {
            const container = document.getElementById('toggles');
            container.innerHTML = '';
            for (let i = 0; i < 16; i++) {
                const btn = document.createElement('div');
                btn.className = 'h-toggle ' + (harmonicEnabled[i] ? 'on' : 'off');
                btn.style.color = harmonicColor(i, 16);
                btn.style.background = harmonicEnabled[i]
                    ? harmonicColor(i, 16).replace('60%)', '15%)')
                    : 'transparent';
                btn.textContent = (i + 1);
                btn.addEventListener('click', () => {
                    harmonicEnabled[i] = !harmonicEnabled[i];
                    btn.className = 'h-toggle ' + (harmonicEnabled[i] ? 'on' : 'off');
                    btn.style.background = harmonicEnabled[i]
                        ? harmonicColor(i, 16).replace('60%)', '15%)')
                        : 'transparent';
                });
                container.appendChild(btn);
            }
        }
        buildToggles();

        // Controls
        document.getElementById('fundamental').addEventListener('input', e => {
            fundamentalFreq = parseFloat(e.target.value);
            document.getElementById('fundVal').textContent = fundamentalFreq;
        });
        document.getElementById('numHarmonics').addEventListener('input', e => {
            numHarmonics = parseInt(e.target.value);
            document.getElementById('numVal').textContent = numHarmonics;
            computeAmplitudes();
        });
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                activePreset = btn.dataset.preset;
                computeAmplitudes();
            });
        });

        let time = 0;
        let paused = false;

        function animate() {
            requestAnimationFrame(animate);
            if (paused) return;

            time += 0.016;

            ctx.fillStyle = '#0a0e1a';
            ctx.fillRect(0, 0, W, H);

            const panelW = 320; // approximate control panel width
            const drawW = W - panelW - 40;
            const leftMargin = 20;

            // Layout: individual harmonics at top, composite at bottom (larger)
            const activeCount = Math.min(numHarmonics, 16);
            const compositeH = H * 0.3;
            const compositeY = H - compositeH - 30;
            const harmonicAreaH = compositeY - 40;
            const rowH = Math.min(harmonicAreaH / activeCount, 50);

            const omega = 2 * Math.PI * fundamentalFreq;
            const scrollSpeed = fundamentalFreq * 80;
            const scrollOffset = time * scrollSpeed;

            // Draw individual harmonics
            for (let i = 0; i < activeCount; i++) {
                const n = i + 1;
                const amp = harmonicAmplitudes[i];
                const enabled = harmonicEnabled[i];
                const y0 = 30 + i * rowH + rowH / 2;
                const color = harmonicColor(i, 16);

                // Label
                ctx.fillStyle = enabled ? color : 'rgba(100,100,100,0.3)';
                ctx.font = '11px sans-serif';
                ctx.fillText(`H${n}`, leftMargin, y0 + 4);

                if (Math.abs(amp) < 0.001 && activePreset !== 'pulse') {
                    // Inactive harmonic (e.g., even harmonics for square wave)
                    ctx.strokeStyle = 'rgba(60,60,60,0.2)';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(leftMargin + 30, y0);
                    ctx.lineTo(leftMargin + drawW, y0);
                    ctx.stroke();
                    continue;
                }

                // Baseline
                ctx.strokeStyle = 'rgba(255,255,255,0.05)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(leftMargin + 30, y0);
                ctx.lineTo(leftMargin + drawW, y0);
                ctx.stroke();

                // Wave
                const alpha = enabled ? 0.8 : 0.15;
                ctx.strokeStyle = color.replace('60%)', `60%, ${alpha})`).replace('hsl(', 'hsla(');
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                const scaleY = (rowH / 2) * 0.8;
                for (let px = 0; px <= drawW - 30; px++) {
                    const t = (px + scrollOffset) / 200;
                    const val = amp * Math.sin(n * omega * t / fundamentalFreq);
                    const x = leftMargin + 30 + px;
                    const yy = y0 - val * scaleY / (Math.abs(amp) || 1) * Math.abs(amp);
                    if (px === 0) ctx.moveTo(x, yy);
                    else ctx.lineTo(x, yy);
                }
                ctx.stroke();
            }

            // Separator line
            ctx.strokeStyle = 'rgba(138, 154, 91, 0.3)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(leftMargin, compositeY - 10);
            ctx.lineTo(leftMargin + drawW, compositeY - 10);
            ctx.stroke();

            // Composite waveform label
            ctx.fillStyle = '#8A9A5B';
            ctx.font = 'bold 13px sans-serif';
            ctx.fillText('Composite Waveform', leftMargin, compositeY + 5);

            // Composite baseline
            const compMidY = compositeY + compositeH / 2 + 10;
            ctx.strokeStyle = 'rgba(255,255,255,0.1)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(leftMargin, compMidY);
            ctx.lineTo(leftMargin + drawW, compMidY);
            ctx.stroke();

            // Draw composite waveform
            const compScaleY = compositeH * 0.4;
            ctx.beginPath();
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.lineWidth = 2.5;

            // Also fill under the curve
            const fillPoints = [];

            for (let px = 0; px <= drawW; px++) {
                const t = (px + scrollOffset) / 200;
                let sum = 0;
                for (let i = 0; i < activeCount; i++) {
                    if (!harmonicEnabled[i]) continue;
                    const n = i + 1;
                    sum += harmonicAmplitudes[i] * Math.sin(n * omega * t / fundamentalFreq);
                }
                const x = leftMargin + px;
                const yy = compMidY - sum * compScaleY;
                fillPoints.push({ x, y: yy });
                if (px === 0) ctx.moveTo(x, yy);
                else ctx.lineTo(x, yy);
            }
            ctx.stroke();

            // Gradient fill under composite
            ctx.beginPath();
            ctx.moveTo(fillPoints[0].x, compMidY);
            for (const pt of fillPoints) {
                ctx.lineTo(pt.x, pt.y);
            }
            ctx.lineTo(fillPoints[fillPoints.length - 1].x, compMidY);
            ctx.closePath();

            const grad = ctx.createLinearGradient(0, compMidY - compScaleY, 0, compMidY + compScaleY);
            grad.addColorStop(0, 'rgba(138, 154, 91, 0.15)');
            grad.addColorStop(0.5, 'rgba(138, 154, 91, 0.02)');
            grad.addColorStop(1, 'rgba(100, 140, 200, 0.15)');
            ctx.fillStyle = grad;
            ctx.fill();

            // Info
            ctx.fillStyle = 'rgba(255,255,255,0.35)';
            ctx.font = '11px sans-serif';
            ctx.fillText(`Preset: ${activePreset} | Fundamental: ${fundamentalFreq} Hz | Active harmonics: ${harmonicEnabled.slice(0, activeCount).filter(Boolean).length}/${activeCount}`, leftMargin, H - 10);
        }

        animate();

        window.addEventListener('keydown', e => {
            if (e.code === 'Space') {
                e.preventDefault();
                paused = !paused;
            }
        });

        window.reset = function() {
            time = 0;
            fundamentalFreq = 2;
            numHarmonics = 8;
            activePreset = 'sawtooth';
            harmonicEnabled.fill(true);
            document.getElementById('fundamental').value = 2;
            document.getElementById('numHarmonics').value = 8;
            document.getElementById('fundVal').textContent = '2';
            document.getElementById('numVal').textContent = '8';
            document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('[data-preset="sawtooth"]').classList.add('active');
            computeAmplitudes();
            buildToggles();
        };
    </script>
    <script src="../assets/js/enhance.js"></script>
</body>
</html>