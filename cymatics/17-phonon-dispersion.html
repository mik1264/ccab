<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crystal Lattice Vibrations - Cymatics</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; overflow: hidden; font-family: 'Segoe UI', system-ui, sans-serif; color: #c8d0e0; }
canvas { display: block; }
.back-link {
    position: fixed; top: 20px; left: 20px; z-index: 100;
    color: #8A9A5B; text-decoration: none; font-size: 14px; font-weight: 600;
    background: rgba(10,14,26,0.8); border-radius: 25px;
    border: 2px solid #8A9A5B; padding: 10px 20px;
    transition: all 0.3s ease;
}
.back-link:hover { background: #8A9A5B; color: #0a0e1a; }
.controls {
    position: fixed; top: 20px; right: 20px; z-index: 100;
    background: rgba(10,14,26,0.85); backdrop-filter: blur(10px);
    border-radius: 10px; padding: 20px; max-width: 300px;
    border: 1px solid rgba(138,154,91,0.3);
}
.controls h3 { color: #8A9A5B; margin-bottom: 12px; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
.control-row { margin-bottom: 10px; }
.control-row label { display: block; font-size: 12px; color: #8a92a8; margin-bottom: 3px; }
.control-row input[type="range"] { width: 100%; accent-color: #8A9A5B; }
.control-row .value { float: right; color: #DDA15E; font-size: 12px; font-weight: 600; }
.control-row button {
    background: rgba(138,154,91,0.2); color: #8A9A5B; border: 1px solid rgba(138,154,91,0.4);
    padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; margin: 2px;
    transition: all 0.2s;
}
.control-row button:hover { background: rgba(138,154,91,0.4); }
.control-row button.active { background: #8A9A5B; color: #0a0e1a; }
</style>
</head>
<body>
<a href="index.html" class="back-link">&larr; Cymatics</a>

<div class="controls">
    <h3>Phonon Dispersion</h3>
    <div class="control-row">
        <label>Wavenumber k <span class="value" id="kVal">1.57</span></label>
        <input type="range" id="kSlider" min="0" max="314" value="157">
    </div>
    <div class="control-row">
        <label>Mass Ratio m2/m1 <span class="value" id="massVal">2.0</span></label>
        <input type="range" id="massSlider" min="10" max="50" value="20">
    </div>
    <div class="control-row">
        <label>Spring Constant <span class="value" id="springVal">1.0</span></label>
        <input type="range" id="springSlider" min="5" max="30" value="10">
    </div>
    <div class="control-row">
        <label>Mode</label>
        <button id="monoBtn" class="active">Monatomic</button>
        <button id="diBtn">Diatomic</button>
    </div>
</div>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let W, H;
let k = 1.57, massRatio = 2.0, springK = 1.0;
let isDiatomic = false;
let time = 0;
let running = true;

const NUM_ATOMS = 60;
const a = 1.0; // lattice constant

function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

// Monatomic dispersion: w = 2*sqrt(K/m)*|sin(ka/2)|
function monoDispersion(kv) {
    return 2 * Math.sqrt(springK) * Math.abs(Math.sin(kv * a / 2));
}

// Diatomic dispersion: two branches
function diDispersion(kv) {
    const m1 = 1.0, m2 = massRatio;
    const mu = 1 / m1 + 1 / m2;
    const prod = m1 * m2;
    const cosKa = Math.cos(kv * a);
    const disc = mu * mu - 4 * (1 - cosKa * cosKa) / (4 * prod);
    const sqrtDisc = Math.sqrt(Math.max(0, mu * mu - 4 * Math.sin(kv * a / 2) * Math.sin(kv * a / 2) / prod));

    const acoustic = Math.sqrt(springK * (mu - sqrtDisc));
    const optical = Math.sqrt(springK * (mu + sqrtDisc));
    return { acoustic, optical };
}

function drawSpring(x1, y1, x2, y2, coils) {
    const dx = x2 - x1, dy = y2 - y1;
    const len = Math.sqrt(dx * dx + dy * dy);
    const nx = -dy / len, ny = dx / len;
    const amp = 4;

    ctx.beginPath();
    ctx.moveTo(x1, y1);
    const steps = coils * 4;
    for (let i = 1; i <= steps; i++) {
        const t = i / steps;
        const px = x1 + dx * t;
        const py = y1 + dy * t;
        const offset = Math.sin(t * coils * Math.PI * 2) * amp;
        ctx.lineTo(px + nx * offset, py + ny * offset);
    }
    ctx.lineTo(x2, y2);
    ctx.strokeStyle = 'rgba(138,154,91,0.4)';
    ctx.lineWidth = 1;
    ctx.stroke();
}

function drawAtomChain() {
    const chainY = H * 0.3;
    const margin = 100;
    const chainW = W - 2 * margin;
    const spacing = chainW / (NUM_ATOMS - 1);
    const amplitude = 30;

    // Get omega for animation
    let omega;
    if (isDiatomic) {
        const disp = diDispersion(k);
        omega = disp.acoustic; // show acoustic branch by default
    } else {
        omega = monoDispersion(k);
    }

    // Calculate atom positions
    const atoms = [];
    for (let i = 0; i < NUM_ATOMS; i++) {
        const baseX = margin + i * spacing;
        const baseY = chainY;

        let displacement;
        if (isDiatomic) {
            const m1 = 1.0, m2 = massRatio;
            if (i % 2 === 0) {
                displacement = amplitude * Math.cos(k * i * a / 2 - omega * time);
            } else {
                // For acoustic branch, both sublattices move in same direction
                const ratio = Math.cos(k * a / 2);
                displacement = amplitude * ratio * Math.cos(k * i * a / 2 - omega * time);
            }
        } else {
            displacement = amplitude * Math.cos(k * i * a - omega * time);
        }

        atoms.push({
            x: baseX,
            y: baseY + displacement,
            displacement: displacement,
            mass: isDiatomic ? (i % 2 === 0 ? 1.0 : massRatio) : 1.0,
            radius: isDiatomic ? (i % 2 === 0 ? 8 : 8 * Math.pow(massRatio, 0.3)) : 8
        });
    }

    // Draw springs
    for (let i = 0; i < atoms.length - 1; i++) {
        drawSpring(atoms[i].x, atoms[i].y, atoms[i + 1].x, atoms[i + 1].y, 6);
    }

    // Draw atoms
    for (let i = 0; i < atoms.length; i++) {
        const atom = atoms[i];
        const disp = atom.displacement / amplitude;

        // Color by displacement: red=up, blue=down
        let r, g, b;
        if (disp > 0) {
            r = Math.floor(100 + disp * 155);
            g = Math.floor(60 + (1 - disp) * 40);
            b = Math.floor(60);
        } else {
            r = Math.floor(60);
            g = Math.floor(60 + (1 + disp) * 40);
            b = Math.floor(100 + (-disp) * 155);
        }

        ctx.beginPath();
        ctx.arc(atom.x, atom.y, atom.radius, 0, Math.PI * 2);
        ctx.fillStyle = `rgb(${r},${g},${b})`;
        ctx.fill();
        ctx.strokeStyle = 'rgba(200,208,224,0.3)';
        ctx.lineWidth = 1;
        ctx.stroke();

        // Draw equilibrium position marker
        ctx.beginPath();
        ctx.arc(atom.x, chainY, 2, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(138,154,91,0.15)';
        ctx.fill();
    }

    // Equilibrium line
    ctx.strokeStyle = 'rgba(138,154,91,0.1)';
    ctx.setLineDash([4, 8]);
    ctx.beginPath();
    ctx.moveTo(margin, chainY);
    ctx.lineTo(W - margin, chainY);
    ctx.stroke();
    ctx.setLineDash([]);

    // Labels
    ctx.fillStyle = '#8a92a8';
    ctx.font = '12px Segoe UI, system-ui, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(isDiatomic ? 'Diatomic Chain (alternating masses)' : 'Monatomic Chain', W / 2, chainY - 60);

    if (isDiatomic) {
        ctx.fillStyle = '#DDA15E';
        ctx.font = '10px Segoe UI, system-ui, sans-serif';
        ctx.fillText('Small = m1, Large = m2', W / 2, chainY - 45);
    }
}

function drawDispersionPlot() {
    const plotX = W * 0.15;
    const plotY = H * 0.52;
    const plotW = W * 0.7;
    const plotH = H * 0.38;

    // Background
    ctx.fillStyle = 'rgba(15,20,40,0.6)';
    ctx.fillRect(plotX, plotY, plotW, plotH);
    ctx.strokeStyle = 'rgba(138,154,91,0.3)';
    ctx.lineWidth = 1;
    ctx.strokeRect(plotX, plotY, plotW, plotH);

    // Axes
    ctx.strokeStyle = 'rgba(138,154,91,0.5)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(plotX, plotY + plotH);
    ctx.lineTo(plotX + plotW, plotY + plotH);
    ctx.moveTo(plotX, plotY + plotH);
    ctx.lineTo(plotX, plotY);
    ctx.stroke();

    // Axis labels
    ctx.fillStyle = '#8a92a8';
    ctx.font = '12px Segoe UI, system-ui, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('Wavenumber k', plotX + plotW / 2, plotY + plotH + 30);
    ctx.save();
    ctx.translate(plotX - 30, plotY + plotH / 2);
    ctx.rotate(-Math.PI / 2);
    ctx.fillText('Frequency \u03C9', 0, 0);
    ctx.restore();

    // k-axis ticks
    ctx.fillStyle = '#5a6278';
    ctx.font = '10px Segoe UI, system-ui, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('0', plotX, plotY + plotH + 15);
    ctx.fillText('\u03C0/a', plotX + plotW, plotY + plotH + 15);

    // Find max omega for scaling
    const kMax = Math.PI / a;
    let omegaMax;
    if (isDiatomic) {
        const disp = diDispersion(kMax * 0.99);
        omegaMax = disp.optical * 1.1;
    } else {
        omegaMax = monoDispersion(kMax) * 1.1;
    }

    // Grid lines
    ctx.strokeStyle = 'rgba(138,154,91,0.1)';
    ctx.setLineDash([2, 6]);
    for (let i = 1; i <= 4; i++) {
        const gy = plotY + plotH - (i / 4) * plotH;
        ctx.beginPath();
        ctx.moveTo(plotX, gy);
        ctx.lineTo(plotX + plotW, gy);
        ctx.stroke();
    }
    ctx.setLineDash([]);

    // Draw dispersion curves
    const steps = 200;
    if (isDiatomic) {
        // Acoustic branch
        ctx.beginPath();
        ctx.strokeStyle = '#4a9eff';
        ctx.lineWidth = 2;
        for (let i = 0; i <= steps; i++) {
            const kv = (i / steps) * kMax;
            const disp = diDispersion(kv);
            const px = plotX + (i / steps) * plotW;
            const py = plotY + plotH - (disp.acoustic / omegaMax) * plotH;
            if (i === 0) ctx.moveTo(px, py);
            else ctx.lineTo(px, py);
        }
        ctx.stroke();

        // Optical branch
        ctx.beginPath();
        ctx.strokeStyle = '#ff6b6b';
        ctx.lineWidth = 2;
        for (let i = 0; i <= steps; i++) {
            const kv = (i / steps) * kMax;
            const disp = diDispersion(kv);
            const px = plotX + (i / steps) * plotW;
            const py = plotY + plotH - (disp.optical / omegaMax) * plotH;
            if (i === 0) ctx.moveTo(px, py);
            else ctx.lineTo(px, py);
        }
        ctx.stroke();

        // Labels
        ctx.fillStyle = '#4a9eff';
        ctx.font = '11px Segoe UI, system-ui, sans-serif';
        ctx.textAlign = 'left';
        ctx.fillText('Acoustic', plotX + plotW - 70, plotY + plotH - 20);
        ctx.fillStyle = '#ff6b6b';
        ctx.fillText('Optical', plotX + plotW - 70, plotY + 30);

        // Band gap shading
        const gapBottom = diDispersion(kMax * 0.99).acoustic;
        const gapTop = diDispersion(kMax * 0.99).optical;
        const gapMinDisp = diDispersion(kMax * 0.5);
        const gapYBottom = plotY + plotH - (gapBottom / omegaMax) * plotH;
        const gapYTop = plotY + plotH - (gapMinDisp.optical / omegaMax) * plotH;
        ctx.fillStyle = 'rgba(221,161,94,0.05)';
        ctx.fillRect(plotX, gapYTop, plotW, gapYBottom - gapYTop);
    } else {
        ctx.beginPath();
        ctx.strokeStyle = '#4a9eff';
        ctx.lineWidth = 2;
        for (let i = 0; i <= steps; i++) {
            const kv = (i / steps) * kMax;
            const omega = monoDispersion(kv);
            const px = plotX + (i / steps) * plotW;
            const py = plotY + plotH - (omega / omegaMax) * plotH;
            if (i === 0) ctx.moveTo(px, py);
            else ctx.lineTo(px, py);
        }
        ctx.stroke();
    }

    // Current k marker
    const kNorm = k / kMax;
    const markerX = plotX + kNorm * plotW;

    if (isDiatomic) {
        const disp = diDispersion(k);
        // Acoustic marker
        const acY = plotY + plotH - (disp.acoustic / omegaMax) * plotH;
        ctx.beginPath();
        ctx.arc(markerX, acY, 6, 0, Math.PI * 2);
        ctx.fillStyle = '#4a9eff';
        ctx.fill();
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.stroke();

        // Optical marker
        const opY = plotY + plotH - (disp.optical / omegaMax) * plotH;
        ctx.beginPath();
        ctx.arc(markerX, opY, 6, 0, Math.PI * 2);
        ctx.fillStyle = '#ff6b6b';
        ctx.fill();
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.stroke();

        // Group velocity arrow on acoustic branch
        const dk = 0.01;
        const dAcoustic = (diDispersion(k + dk).acoustic - diDispersion(Math.max(0, k - dk)).acoustic) / (2 * dk);
        drawGroupVelocityArrow(markerX, acY, dAcoustic, plotW / kMax, '#4a9eff');
    } else {
        const omega = monoDispersion(k);
        const mY = plotY + plotH - (omega / omegaMax) * plotH;
        ctx.beginPath();
        ctx.arc(markerX, mY, 6, 0, Math.PI * 2);
        ctx.fillStyle = '#DDA15E';
        ctx.fill();
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.stroke();

        // Group velocity arrow
        const dk = 0.01;
        const dw = (monoDispersion(k + dk) - monoDispersion(Math.max(0, k - dk))) / (2 * dk);
        drawGroupVelocityArrow(markerX, mY, dw, plotW / kMax, '#DDA15E');
    }

    // Vertical dashed line at current k
    ctx.strokeStyle = 'rgba(221,161,94,0.3)';
    ctx.setLineDash([4, 4]);
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(markerX, plotY);
    ctx.lineTo(markerX, plotY + plotH);
    ctx.stroke();
    ctx.setLineDash([]);

    // Title
    ctx.fillStyle = '#8A9A5B';
    ctx.font = '13px Segoe UI, system-ui, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('Dispersion Relation: \u03C9(k)', plotX + plotW / 2, plotY - 8);
}

function drawGroupVelocityArrow(x, y, vg, scale, color) {
    const arrowLen = vg * scale * 0.15;
    const clampedLen = Math.max(-40, Math.min(40, arrowLen));

    if (Math.abs(clampedLen) < 3) return;

    const endX = x + clampedLen;
    const headSize = 6;

    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(x, y - 14);
    ctx.lineTo(endX, y - 14);
    ctx.stroke();

    // Arrowhead
    const dir = clampedLen > 0 ? 1 : -1;
    ctx.beginPath();
    ctx.moveTo(endX, y - 14);
    ctx.lineTo(endX - dir * headSize, y - 14 - headSize / 2);
    ctx.lineTo(endX - dir * headSize, y - 14 + headSize / 2);
    ctx.closePath();
    ctx.fillStyle = color;
    ctx.fill();

    ctx.fillStyle = color;
    ctx.font = '9px Segoe UI, system-ui, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('v_g', x + clampedLen / 2, y - 20);
}

function animate() {
    if (running) {
        time += 0.05;
    }

    ctx.fillStyle = '#0a0e1a';
    ctx.fillRect(0, 0, W, H);

    drawAtomChain();
    drawDispersionPlot();

    requestAnimationFrame(animate);
}

document.getElementById('kSlider').addEventListener('input', function() {
    k = this.value / 100;
    document.getElementById('kVal').textContent = k.toFixed(2);
});

document.getElementById('massSlider').addEventListener('input', function() {
    massRatio = this.value / 10;
    document.getElementById('massVal').textContent = massRatio.toFixed(1);
});

document.getElementById('springSlider').addEventListener('input', function() {
    springK = this.value / 10;
    document.getElementById('springVal').textContent = springK.toFixed(1);
});

document.getElementById('monoBtn').addEventListener('click', function() {
    isDiatomic = false;
    this.classList.add('active');
    document.getElementById('diBtn').classList.remove('active');
});

document.getElementById('diBtn').addEventListener('click', function() {
    isDiatomic = true;
    this.classList.add('active');
    document.getElementById('monoBtn').classList.remove('active');
});

window.reset = function() {
    k = 1.57; massRatio = 2.0; springK = 1.0; isDiatomic = false; time = 0;
    document.getElementById('kSlider').value = 157;
    document.getElementById('massSlider').value = 20;
    document.getElementById('springSlider').value = 10;
    document.getElementById('kVal').textContent = '1.57';
    document.getElementById('massVal').textContent = '2.0';
    document.getElementById('springVal').textContent = '1.0';
    document.getElementById('monoBtn').classList.add('active');
    document.getElementById('diBtn').classList.remove('active');
    resize();
};

window.togglePause = function() { running = !running; };

animate();
</script>
<script src="../assets/js/enhance.js"></script>
</body>
</html>
