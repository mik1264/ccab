<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rectangular Waveguide Modes - Cymatics</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; overflow: hidden; font-family: 'Segoe UI', system-ui, sans-serif; color: #c8d0e0; }
canvas { display: block; }
.back-link {
    position: fixed; top: 20px; left: 20px; z-index: 100;
    color: #8A9A5B; text-decoration: none; font-size: 14px; font-weight: 600;
    background: rgba(10,14,26,0.8); border-radius: 25px;
    border: 2px solid #8A9A5B; padding: 10px 20px;
    transition: all 0.3s ease;
}
.back-link:hover { background: #8A9A5B; color: #0a0e1a; }
.controls {
    position: fixed; top: 20px; right: 20px; z-index: 100;
    background: rgba(10,14,26,0.85); backdrop-filter: blur(10px);
    border-radius: 10px; padding: 20px; max-width: 300px;
    border: 1px solid rgba(138,154,91,0.3);
}
.controls h3 { color: #8A9A5B; margin-bottom: 12px; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
.control-row { margin-bottom: 10px; }
.control-row label { display: block; font-size: 12px; color: #8a92a8; margin-bottom: 3px; }
.control-row input[type="range"] { width: 100%; accent-color: #8A9A5B; }
.control-row .value { float: right; color: #DDA15E; font-size: 12px; font-weight: 600; }
.control-row select {
    width: 100%; background: rgba(138,154,91,0.15); color: #c8d0e0;
    border: 1px solid rgba(138,154,91,0.4); padding: 5px 8px; border-radius: 5px; font-size: 12px;
}
.info {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100;
    background: rgba(10,14,26,0.85); backdrop-filter: blur(10px);
    border-radius: 10px; padding: 10px 20px;
    border: 1px solid rgba(138,154,91,0.3);
    font-size: 13px; color: #8a92a8; text-align: center;
}
.info span { color: #DDA15E; font-weight: 600; }
</style>
</head>
<body>
<a href="index.html" class="back-link">&larr; Cymatics</a>

<div class="controls">
    <h3>Waveguide Modes</h3>
    <div class="control-row">
        <label>Mode m <span class="value" id="mVal">1</span></label>
        <input type="range" id="mSlider" min="0" max="5" value="1" step="1">
    </div>
    <div class="control-row">
        <label>Mode n <span class="value" id="nVal">0</span></label>
        <input type="range" id="nSlider" min="0" max="5" value="0" step="1">
    </div>
    <div class="control-row">
        <label>Aspect Ratio a/b <span class="value" id="arVal">2.00</span></label>
        <input type="range" id="arSlider" min="50" max="400" value="200">
    </div>
    <div class="control-row">
        <label>Animation Speed <span class="value" id="speedVal">1.0</span></label>
        <input type="range" id="speedSlider" min="1" max="30" value="10">
    </div>
</div>

<div class="info">
    TE<span id="infoM">1</span>,<span id="infoN">0</span> Mode &mdash; f<sub>c</sub> = <span id="infoCutoff">0.50</span> (normalized)
</div>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let W, H;
let mMode = 1, nMode = 0, aspectRatio = 2.0, speed = 1.0;
let time = 0;
let running = true;

const THUMB_COLS = 4;
const THUMB_ROWS = 4;

function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

function teField(x, y, m, n, t) {
    return Math.cos(m * Math.PI * x) * Math.cos(n * Math.PI * y) * Math.cos(t);
}

function cutoffFreq(m, n, ar) {
    return Math.sqrt((m / ar) * (m / ar) + n * n) * 0.5;
}

function colormap(v) {
    // Diverging blue-white-red
    const t = (v + 1) * 0.5; // map [-1,1] to [0,1]
    let r, g, b;
    if (t < 0.5) {
        const s = t * 2;
        r = Math.floor(30 + s * 225);
        g = Math.floor(60 + s * 195);
        b = Math.floor(220 + s * 35);
    } else {
        const s = (t - 0.5) * 2;
        r = Math.floor(255);
        g = Math.floor(255 - s * 195);
        b = Math.floor(255 - s * 220);
    }
    return [r, g, b];
}

function drawMainView() {
    const mainW = Math.min(W * 0.55, H * 0.55 * aspectRatio);
    const mainH = mainW / aspectRatio;
    const mainX = (W - mainW) / 2;
    const mainY = (H - mainH) / 2 - H * 0.08;

    const res = 128;
    const resY = Math.max(2, Math.round(res / aspectRatio));
    const imgData = ctx.createImageData(res, resY);
    const d = imgData.data;

    for (let j = 0; j < resY; j++) {
        for (let i = 0; i < res; i++) {
            const x = i / (res - 1);
            const y = j / (resY - 1);
            const v = teField(x, y, mMode, nMode, time);
            const [r, g, b] = colormap(v);
            const idx = (j * res + i) * 4;
            d[idx] = r; d[idx + 1] = g; d[idx + 2] = b; d[idx + 3] = 255;
        }
    }

    const offCanvas = document.createElement('canvas');
    offCanvas.width = res;
    offCanvas.height = resY;
    offCanvas.getContext('2d').putImageData(imgData, 0, 0);
    ctx.imageSmoothingEnabled = true;
    ctx.drawImage(offCanvas, mainX, mainY, mainW, mainH);

    // Draw contour lines (black lines where field ~ 0)
    ctx.strokeStyle = 'rgba(0,0,0,0.5)';
    ctx.lineWidth = 1;
    const step = 2;
    for (let j = 0; j < resY - step; j += step) {
        for (let i = 0; i < res - step; i += step) {
            const x0 = i / (res - 1), y0 = j / (resY - 1);
            const x1 = (i + step) / (res - 1), y1 = (j + step) / (resY - 1);
            const v00 = teField(x0, y0, mMode, nMode, time);
            const v10 = teField(x1, y0, mMode, nMode, time);
            const v01 = teField(x0, y1, mMode, nMode, time);

            if (v00 * v10 < 0) {
                const frac = Math.abs(v00) / (Math.abs(v00) + Math.abs(v10));
                const px = mainX + (i + frac * step) / (res - 1) * mainW;
                const py = mainY + j / (resY - 1) * mainH;
                ctx.beginPath();
                ctx.arc(px, py, 1, 0, Math.PI * 2);
                ctx.stroke();
            }
            if (v00 * v01 < 0) {
                const frac = Math.abs(v00) / (Math.abs(v00) + Math.abs(v01));
                const px = mainX + i / (res - 1) * mainW;
                const py = mainY + (j + frac * step) / (resY - 1) * mainH;
                ctx.beginPath();
                ctx.arc(px, py, 1, 0, Math.PI * 2);
                ctx.stroke();
            }
        }
    }

    // Border
    ctx.strokeStyle = 'rgba(138,154,91,0.5)';
    ctx.lineWidth = 2;
    ctx.strokeRect(mainX, mainY, mainW, mainH);

    // Label
    ctx.fillStyle = '#8A9A5B';
    ctx.font = '16px Segoe UI, system-ui, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(`TE${mMode},${nMode} Mode`, mainX + mainW / 2, mainY - 12);
}

function drawThumbnails() {
    const thumbArea = W * 0.85;
    const thumbSize = Math.min(60, thumbArea / (THUMB_COLS * 1.3));
    const gap = thumbSize * 0.3;
    const totalW = THUMB_COLS * thumbSize + (THUMB_COLS - 1) * gap;
    const startX = (W - totalW) / 2;
    const startY = H * 0.72;

    ctx.fillStyle = '#8a92a8';
    ctx.font = '11px Segoe UI, system-ui, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('Mode Explorer', W / 2, startY - 10);

    const res = 32;
    let idx = 0;
    for (let row = 0; row < THUMB_ROWS; row++) {
        for (let col = 0; col < THUMB_COLS; col++) {
            const tm = col;
            const tn = row;
            if (tm === 0 && tn === 0) { idx++; continue; } // TE0,0 doesn't exist

            const tx = startX + col * (thumbSize + gap);
            const ty = startY + row * (thumbSize / aspectRatio + gap);
            const th = thumbSize / aspectRatio;

            const imgData = ctx.createImageData(res, Math.max(1, Math.round(res / aspectRatio)));
            const resY2 = imgData.height;
            const d = imgData.data;
            for (let j = 0; j < resY2; j++) {
                for (let i = 0; i < res; i++) {
                    const x = i / (res - 1);
                    const y = j / (resY2 - 1);
                    const v = teField(x, y, tm, tn, time);
                    const [r, g, b] = colormap(v);
                    const pidx = (j * res + i) * 4;
                    d[pidx] = r; d[pidx + 1] = g; d[pidx + 2] = b; d[pidx + 3] = 255;
                }
            }

            const offC = document.createElement('canvas');
            offC.width = res;
            offC.height = resY2;
            offC.getContext('2d').putImageData(imgData, 0, 0);
            ctx.drawImage(offC, tx, ty, thumbSize, th);

            // Highlight current mode
            if (tm === mMode && tn === nMode) {
                ctx.strokeStyle = '#DDA15E';
                ctx.lineWidth = 2;
                ctx.strokeRect(tx - 1, ty - 1, thumbSize + 2, th + 2);
            } else {
                ctx.strokeStyle = 'rgba(138,154,91,0.2)';
                ctx.lineWidth = 1;
                ctx.strokeRect(tx, ty, thumbSize, th);
            }

            // Label
            ctx.fillStyle = (tm === mMode && tn === nMode) ? '#DDA15E' : '#5a6278';
            ctx.font = '9px Segoe UI, system-ui, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(`${tm},${tn}`, tx + thumbSize / 2, ty + th + 11);

            idx++;
        }
    }
}

function animate() {
    if (running) {
        time += 0.03 * speed;
    }

    ctx.fillStyle = '#0a0e1a';
    ctx.fillRect(0, 0, W, H);

    drawMainView();
    drawThumbnails();

    requestAnimationFrame(animate);
}

function updateInfo() {
    document.getElementById('infoM').textContent = mMode;
    document.getElementById('infoN').textContent = nMode;
    const fc = cutoffFreq(mMode, nMode, aspectRatio);
    document.getElementById('infoCutoff').textContent = fc.toFixed(2);
}

document.getElementById('mSlider').addEventListener('input', function() {
    mMode = parseInt(this.value);
    document.getElementById('mVal').textContent = mMode;
    updateInfo();
});

document.getElementById('nSlider').addEventListener('input', function() {
    nMode = parseInt(this.value);
    document.getElementById('nVal').textContent = nMode;
    updateInfo();
});

document.getElementById('arSlider').addEventListener('input', function() {
    aspectRatio = this.value / 100;
    document.getElementById('arVal').textContent = aspectRatio.toFixed(2);
    updateInfo();
});

document.getElementById('speedSlider').addEventListener('input', function() {
    speed = this.value / 10;
    document.getElementById('speedVal').textContent = speed.toFixed(1);
});

window.reset = function() {
    mMode = 1; nMode = 0; aspectRatio = 2.0; speed = 1.0; time = 0;
    document.getElementById('mSlider').value = 1;
    document.getElementById('nSlider').value = 0;
    document.getElementById('arSlider').value = 200;
    document.getElementById('speedSlider').value = 10;
    document.getElementById('mVal').textContent = '1';
    document.getElementById('nVal').textContent = '0';
    document.getElementById('arVal').textContent = '2.00';
    document.getElementById('speedVal').textContent = '1.0';
    updateInfo();
    resize();
};

window.togglePause = function() { running = !running; };

updateInfo();
animate();
</script>
<script src="../assets/js/enhance.js"></script>
</body>
</html>
