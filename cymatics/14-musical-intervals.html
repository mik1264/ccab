<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Musical Intervals as Geometric Patterns - Cymatics</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0a0e1a;
            color: #e0e0e0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }
        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }
        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            color: #8A9A5B;
            background: rgba(10,14,26,0.8);
            border-radius: 25px;
            border: 2px solid #8A9A5B;
            padding: 10px 20px;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            transition: background 0.3s, color 0.3s;
        }
        .back-link:hover {
            background: #8A9A5B;
            color: #0a0e1a;
        }
        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(10,14,26,0.85);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 20px;
            max-width: 300px;
            border: 1px solid rgba(138,154,91,0.3);
        }
        .controls h3 {
            color: #8A9A5B;
            margin-bottom: 12px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .control-group {
            margin-bottom: 10px;
        }
        .control-group label {
            display: block;
            font-size: 11px;
            color: #aaa;
            margin-bottom: 4px;
        }
        .control-group input[type="range"] {
            width: 100%;
            accent-color: #8A9A5B;
        }
        .control-group .value {
            font-size: 11px;
            color: #8A9A5B;
            float: right;
        }
        .control-group select {
            width: 100%;
            padding: 6px;
            background: rgba(30,35,50,0.9);
            color: #e0e0e0;
            border: 1px solid rgba(138,154,91,0.4);
            border-radius: 5px;
            font-size: 12px;
        }
        .control-group button {
            width: 100%;
            padding: 7px;
            background: rgba(138,154,91,0.3);
            color: #8A9A5B;
            border: 1px solid #8A9A5B;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: background 0.3s;
            margin-top: 2px;
        }
        .control-group button:hover {
            background: rgba(138,154,91,0.5);
        }
        .control-group button.active {
            background: #8A9A5B;
            color: #0a0e1a;
        }
        .btn-row {
            display: flex;
            gap: 5px;
        }
        .btn-row button {
            flex: 1;
        }
        .ratio-display {
            text-align: center;
            font-size: 20px;
            color: #DDA15E;
            font-weight: 700;
            margin: 8px 0;
        }
        .info-text {
            font-size: 10px;
            color: #666;
            line-height: 1.5;
            margin-top: 8px;
            border-top: 1px solid rgba(100,100,100,0.3);
            padding-top: 8px;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">&#8592; Cymatics</a>
    <div class="controls">
        <h3>Musical Intervals</h3>
        <div class="control-group">
            <label>Base Frequency <span class="value" id="freqVal">220 Hz</span></label>
            <input type="range" id="baseFreq" min="100" max="440" step="1" value="220">
        </div>
        <div class="control-group">
            <label>Interval</label>
            <select id="interval">
                <option value="1,1">Unison (1:1)</option>
                <option value="16,15">Minor 2nd (16:15)</option>
                <option value="9,8">Major 2nd (9:8)</option>
                <option value="6,5">Minor 3rd (6:5)</option>
                <option value="5,4">Major 3rd (5:4)</option>
                <option value="4,3">Perfect 4th (4:3)</option>
                <option value="45,32">Tritone (45:32)</option>
                <option value="3,2" selected>Perfect 5th (3:2)</option>
                <option value="8,5">Minor 6th (8:5)</option>
                <option value="5,3">Major 6th (5:3)</option>
                <option value="9,5">Minor 7th (9:5)</option>
                <option value="15,8">Major 7th (15:8)</option>
                <option value="2,1">Octave (2:1)</option>
            </select>
        </div>
        <div class="ratio-display" id="ratioDisp">3:2</div>
        <div class="control-group btn-row">
            <button id="waveBtn" class="active">Waveform</button>
            <button id="lissBtn" class="active">Lissajous</button>
        </div>
        <div class="info-text">
            Simple ratios (octave, fifth) create elegant closed Lissajous figures. Complex ratios (tritone, minor 2nd) create dense, space-filling patterns. Click the piano keys below to select notes.
        </div>
    </div>
    <canvas id="canvas"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            canvas.width = window.innerWidth * devicePixelRatio;
            canvas.height = window.innerHeight * devicePixelRatio;
            ctx.scale(devicePixelRatio, devicePixelRatio);
        }
        resize();
        window.addEventListener('resize', resize);

        const W = () => window.innerWidth;
        const H = () => window.innerHeight;

        const baseFreqSlider = document.getElementById('baseFreq');
        const intervalSelect = document.getElementById('interval');
        const waveBtn = document.getElementById('waveBtn');
        const lissBtn = document.getElementById('lissBtn');

        let showWave = true;
        let showLiss = true;

        waveBtn.addEventListener('click', () => {
            showWave = !showWave;
            waveBtn.classList.toggle('active');
        });
        lissBtn.addEventListener('click', () => {
            showLiss = !showLiss;
            lissBtn.classList.toggle('active');
        });

        // Intervals
        const intervals = [
            { name: 'Unison', num: 1, den: 1 },
            { name: 'Minor 2nd', num: 16, den: 15 },
            { name: 'Major 2nd', num: 9, den: 8 },
            { name: 'Minor 3rd', num: 6, den: 5 },
            { name: 'Major 3rd', num: 5, den: 4 },
            { name: 'Perfect 4th', num: 4, den: 3 },
            { name: 'Tritone', num: 45, den: 32 },
            { name: 'Perfect 5th', num: 3, den: 2 },
            { name: 'Minor 6th', num: 8, den: 5 },
            { name: 'Major 6th', num: 5, den: 3 },
            { name: 'Minor 7th', num: 9, den: 5 },
            { name: 'Major 7th', num: 15, den: 8 },
            { name: 'Octave', num: 2, den: 1 },
        ];

        // Piano keyboard state
        const pianoKeys = [];
        // One octave + a bit: C4 to C5 (13 notes)
        const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B', 'C'];
        const isBlack = [false, true, false, true, false, false, true, false, true, false, true, false, false];
        let selectedKey1 = 0; // C
        let selectedKey2 = 7; // G (perfect 5th)

        let t = 0;
        let paused = false;
        let trailPoints = [];
        const maxTrail = 2000;

        function getIntervalRatio() {
            const val = intervalSelect.value.split(',');
            return { num: parseInt(val[0]), den: parseInt(val[1]) };
        }

        let animId;
        function animate() {
            animId = requestAnimationFrame(animate);
            if (paused) return;

            const w = W();
            const h = H();
            ctx.clearRect(0, 0, w, h);

            const baseFreq = parseInt(baseFreqSlider.value);
            const ratio = getIntervalRatio();

            document.getElementById('freqVal').textContent = baseFreq + ' Hz';
            document.getElementById('ratioDisp').textContent = ratio.num + ':' + ratio.den;

            const f1 = 1; // normalized
            const f2 = ratio.num / ratio.den;

            t += 0.02;

            // --- Piano keyboard at bottom ---
            const pianoY = h - 80;
            const pianoH = 60;
            const whiteW = Math.min(50, (w - 100) / 8);
            const pianoStartX = (w - whiteW * 8) / 2;

            // Draw white keys
            let whiteIndex = 0;
            const keyPositions = [];
            for (let i = 0; i < 13; i++) {
                if (!isBlack[i]) {
                    const kx = pianoStartX + whiteIndex * whiteW;
                    keyPositions[i] = { x: kx, w: whiteW, h: pianoH, black: false };
                    const isSelected = i === selectedKey1 || i === selectedKey2;
                    ctx.fillStyle = isSelected ? (i === selectedKey1 ? 'rgba(78,205,196,0.7)' : 'rgba(221,161,94,0.7)') : '#ddd';
                    ctx.fillRect(kx, pianoY, whiteW - 2, pianoH);
                    ctx.strokeStyle = '#666';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(kx, pianoY, whiteW - 2, pianoH);

                    // Note name
                    ctx.fillStyle = isSelected ? '#fff' : '#666';
                    ctx.font = '10px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(noteNames[i], kx + whiteW / 2 - 1, pianoY + pianoH - 8);
                    whiteIndex++;
                }
            }

            // Draw black keys
            whiteIndex = 0;
            for (let i = 0; i < 13; i++) {
                if (!isBlack[i]) {
                    whiteIndex++;
                } else {
                    const kx = pianoStartX + (whiteIndex - 1) * whiteW + whiteW * 0.65;
                    const bw = whiteW * 0.6;
                    const bh = pianoH * 0.6;
                    keyPositions[i] = { x: kx, w: bw, h: bh, black: true };
                    const isSelected = i === selectedKey1 || i === selectedKey2;
                    ctx.fillStyle = isSelected ? (i === selectedKey1 ? 'rgba(78,205,196,0.9)' : 'rgba(221,161,94,0.9)') : '#333';
                    ctx.fillRect(kx, pianoY, bw, bh);
                    ctx.strokeStyle = '#555';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(kx, pianoY, bw, bh);
                }
            }

            // Handle piano clicks
            canvas.onmousedown = (e) => {
                const rect = canvas.getBoundingClientRect();
                const mx = e.clientX - rect.left;
                const my = e.clientY - rect.top;

                if (my >= pianoY && my <= pianoY + pianoH) {
                    // Check black keys first (on top)
                    for (let i = 12; i >= 0; i--) {
                        if (isBlack[i] && keyPositions[i]) {
                            const kp = keyPositions[i];
                            if (mx >= kp.x && mx <= kp.x + kp.w && my <= pianoY + kp.h) {
                                handleKeyClick(i);
                                return;
                            }
                        }
                    }
                    // Check white keys
                    for (let i = 0; i < 13; i++) {
                        if (!isBlack[i] && keyPositions[i]) {
                            const kp = keyPositions[i];
                            if (mx >= kp.x && mx <= kp.x + kp.w) {
                                handleKeyClick(i);
                                return;
                            }
                        }
                    }
                }
            };

            // --- Lissajous figure ---
            if (showLiss) {
                const lissR = Math.min(w * 0.25, h * 0.28);
                const lissCx = showWave ? w * 0.3 : w * 0.5;
                const lissCy = h * 0.42;

                // Border
                ctx.strokeStyle = 'rgba(138,154,91,0.2)';
                ctx.lineWidth = 1;
                ctx.strokeRect(lissCx - lissR - 10, lissCy - lissR - 10, lissR * 2 + 20, lissR * 2 + 20);

                ctx.fillStyle = '#8A9A5B';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('Lissajous Figure', lissCx, lissCy - lissR - 18);

                // Draw Lissajous trail with rainbow coloring
                const trailLen = Math.floor(Math.max(ratio.num, ratio.den) * 200);
                ctx.beginPath();
                let firstPoint = true;
                for (let i = 0; i < trailLen; i++) {
                    const tt = t - i * 0.003;
                    const x = Math.sin(f1 * tt * 4);
                    const y = Math.sin(f2 * tt * 4);
                    const px = lissCx + x * lissR * 0.9;
                    const py = lissCy + y * lissR * 0.9;

                    if (firstPoint) {
                        ctx.moveTo(px, py);
                        firstPoint = false;
                    } else {
                        ctx.lineTo(px, py);
                    }
                }
                // Rainbow stroke
                const lissGrad = ctx.createLinearGradient(lissCx - lissR, lissCy - lissR, lissCx + lissR, lissCy + lissR);
                lissGrad.addColorStop(0, 'rgba(255,100,100,0.8)');
                lissGrad.addColorStop(0.17, 'rgba(255,180,50,0.8)');
                lissGrad.addColorStop(0.33, 'rgba(255,255,80,0.8)');
                lissGrad.addColorStop(0.5, 'rgba(100,255,100,0.8)');
                lissGrad.addColorStop(0.67, 'rgba(80,180,255,0.8)');
                lissGrad.addColorStop(0.83, 'rgba(150,100,255,0.8)');
                lissGrad.addColorStop(1, 'rgba(255,100,200,0.8)');
                ctx.strokeStyle = lissGrad;
                ctx.lineWidth = 1.8;
                ctx.stroke();

                // Glow trail - recent points
                const recentLen = 100;
                for (let i = 0; i < recentLen; i++) {
                    const tt = t - i * 0.003;
                    const x = Math.sin(f1 * tt * 4);
                    const y = Math.sin(f2 * tt * 4);
                    const px = lissCx + x * lissR * 0.9;
                    const py = lissCy + y * lissR * 0.9;
                    const alpha = (1 - i / recentLen) * 0.5;
                    const hue = (i * 3 + t * 50) % 360;

                    ctx.beginPath();
                    ctx.arc(px, py, 2 + (1 - i / recentLen) * 3, 0, Math.PI * 2);
                    ctx.fillStyle = `hsla(${hue}, 80%, 60%, ${alpha})`;
                    ctx.fill();
                }

                // Current point
                const curX = Math.sin(f1 * t * 4);
                const curY = Math.sin(f2 * t * 4);
                ctx.beginPath();
                ctx.arc(lissCx + curX * lissR * 0.9, lissCy + curY * lissR * 0.9, 5, 0, Math.PI * 2);
                ctx.fillStyle = '#fff';
                ctx.fill();

                // Axis labels
                ctx.fillStyle = 'rgba(78,205,196,0.6)';
                ctx.font = '10px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('f\u2081', lissCx, lissCy + lissR + 22);
                ctx.fillText('f\u2082', lissCx - lissR - 15, lissCy);
            }

            // --- Combined waveform ---
            if (showWave) {
                const waveX = showLiss ? w * 0.55 : w * 0.1;
                const waveW = showLiss ? w * 0.38 : w * 0.8;
                const waveH = h * 0.2;

                // Wave 1
                const wave1Y = h * 0.18;
                ctx.strokeStyle = 'rgba(138,154,91,0.2)';
                ctx.lineWidth = 1;
                ctx.strokeRect(waveX, wave1Y - waveH / 2, waveW, waveH);
                ctx.fillStyle = 'rgba(78,205,196,0.7)';
                ctx.font = '11px sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText('f\u2081 = ' + baseFreq + ' Hz', waveX + 5, wave1Y - waveH / 2 - 5);

                ctx.beginPath();
                for (let i = 0; i <= waveW; i++) {
                    const tt = (i / waveW) * Math.PI * 8;
                    const y = Math.sin(f1 * (tt + t * 4));
                    const py = wave1Y + y * waveH * 0.4;
                    if (i === 0) ctx.moveTo(waveX + i, py);
                    else ctx.lineTo(waveX + i, py);
                }
                ctx.strokeStyle = 'rgba(78,205,196,0.8)';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Wave 2
                const wave2Y = h * 0.38;
                ctx.strokeStyle = 'rgba(138,154,91,0.2)';
                ctx.lineWidth = 1;
                ctx.strokeRect(waveX, wave2Y - waveH / 2, waveW, waveH);
                ctx.fillStyle = 'rgba(221,161,94,0.7)';
                ctx.font = '11px sans-serif';
                ctx.fillText('f\u2082 = ' + Math.round(baseFreq * f2) + ' Hz', waveX + 5, wave2Y - waveH / 2 - 5);

                ctx.beginPath();
                for (let i = 0; i <= waveW; i++) {
                    const tt = (i / waveW) * Math.PI * 8;
                    const y = Math.sin(f2 * (tt + t * 4));
                    const py = wave2Y + y * waveH * 0.4;
                    if (i === 0) ctx.moveTo(waveX + i, py);
                    else ctx.lineTo(waveX + i, py);
                }
                ctx.strokeStyle = 'rgba(221,161,94,0.8)';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Combined wave
                const wave3Y = h * 0.6;
                const combH = waveH * 1.2;
                ctx.strokeStyle = 'rgba(138,154,91,0.2)';
                ctx.lineWidth = 1;
                ctx.strokeRect(waveX, wave3Y - combH / 2, waveW, combH);
                ctx.fillStyle = 'rgba(255,255,255,0.5)';
                ctx.font = '11px sans-serif';
                ctx.fillText('Combined (f\u2081 + f\u2082)', waveX + 5, wave3Y - combH / 2 - 5);

                ctx.beginPath();
                for (let i = 0; i <= waveW; i++) {
                    const tt = (i / waveW) * Math.PI * 8;
                    const y = (Math.sin(f1 * (tt + t * 4)) + Math.sin(f2 * (tt + t * 4))) / 2;
                    const py = wave3Y + y * combH * 0.4;
                    if (i === 0) ctx.moveTo(waveX + i, py);
                    else ctx.lineTo(waveX + i, py);
                }
                const combGrad = ctx.createLinearGradient(waveX, wave3Y - combH / 2, waveX + waveW, wave3Y + combH / 2);
                combGrad.addColorStop(0, 'rgba(78,205,196,0.8)');
                combGrad.addColorStop(1, 'rgba(221,161,94,0.8)');
                ctx.strokeStyle = combGrad;
                ctx.lineWidth = 2;
                ctx.stroke();
            }

            // --- Info labels ---
            ctx.fillStyle = '#666';
            ctx.font = '11px sans-serif';
            ctx.textAlign = 'center';
            const complexity = ratio.num + ratio.den;
            const label = complexity <= 4 ? 'Simple ratio \u2192 clean, closed figure' :
                          complexity <= 8 ? 'Moderate ratio \u2192 recognizable pattern' :
                          'Complex ratio \u2192 dense, space-filling figure';
            ctx.fillText(label, w / 2, pianoY - 15);
        }

        function handleKeyClick(keyIndex) {
            // Determine which note to update (cycle: first click = key1, second = key2)
            if (keyIndex === selectedKey1) return; // already selected
            if (keyIndex === selectedKey2) return;

            selectedKey1 = Math.min(keyIndex, selectedKey2);
            selectedKey2 = Math.max(keyIndex, selectedKey1 === keyIndex ? selectedKey2 : keyIndex);
            if (keyIndex > selectedKey1 && keyIndex !== selectedKey2) {
                selectedKey2 = keyIndex;
            }

            // Find closest interval
            const semitones = Math.abs(selectedKey2 - selectedKey1);
            const ratioMap = [
                [1, 1], [16, 15], [9, 8], [6, 5], [5, 4], [4, 3],
                [45, 32], [3, 2], [8, 5], [5, 3], [9, 5], [15, 8], [2, 1]
            ];
            if (semitones < ratioMap.length) {
                const r = ratioMap[semitones];
                intervalSelect.value = r[0] + ',' + r[1];
            }
            trailPoints = [];
        }

        function reset() {
            t = 0;
            trailPoints = [];
            selectedKey1 = 0;
            selectedKey2 = 7;
            intervalSelect.value = '3,2';
        }
        window.reset = reset;

        animate();

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) cancelAnimationFrame(animId);
            else animate();
        });
    </script>
    <script src="../assets/js/enhance.js"></script>
</body>
</html>