<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chladni Figures - Cymatics</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; overflow: hidden; font-family: 'Segoe UI', system-ui, sans-serif; color: #c8d0e0; }
canvas { display: block; }
.back-link {
    position: fixed; top: 20px; left: 20px; z-index: 100;
    color: #8A9A5B; text-decoration: none; font-size: 14px; font-weight: 600;
    background: rgba(10,14,26,0.8); border-radius: 25px;
    border: 2px solid #8A9A5B; padding: 10px 20px;
    transition: all 0.3s ease;
}
.back-link:hover { background: #8A9A5B; color: #0a0e1a; }
.controls {
    position: fixed; top: 20px; right: 20px; z-index: 100;
    background: rgba(10,14,26,0.85); backdrop-filter: blur(10px);
    border-radius: 10px; padding: 20px; max-width: 300px;
    border: 1px solid rgba(138,154,91,0.3);
}
.controls h3 { color: #8A9A5B; margin-bottom: 12px; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
.control-row { margin-bottom: 10px; }
.control-row label { display: block; font-size: 12px; color: #8a92a8; margin-bottom: 3px; }
.control-row input[type="range"] { width: 100%; accent-color: #8A9A5B; }
.control-row .value { float: right; color: #DDA15E; font-size: 12px; font-weight: 600; }
.control-row button {
    background: rgba(138,154,91,0.2); color: #8A9A5B; border: 1px solid rgba(138,154,91,0.4);
    padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; margin: 2px;
    transition: all 0.2s;
}
.control-row button:hover { background: rgba(138,154,91,0.4); }
.control-row button.active { background: #8A9A5B; color: #0a0e1a; }
.info {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100;
    background: rgba(10,14,26,0.85); backdrop-filter: blur(10px);
    border-radius: 10px; padding: 10px 20px;
    border: 1px solid rgba(138,154,91,0.3);
    font-size: 13px; color: #8a92a8; text-align: center;
}
.info span { color: #DDA15E; font-weight: 600; }
</style>
</head>
<body>
<a href="index.html" class="back-link">&larr; Cymatics</a>

<div class="controls">
    <h3>Chladni Figures</h3>
    <div class="control-row">
        <label>Mode n <span class="value" id="nVal">3</span></label>
        <input type="range" id="nSlider" min="1" max="12" value="3" step="1">
    </div>
    <div class="control-row">
        <label>Mode m <span class="value" id="mVal">5</span></label>
        <input type="range" id="mSlider" min="1" max="12" value="5" step="1">
    </div>
    <div class="control-row">
        <label>A/B Ratio <span class="value" id="abVal">1.00</span></label>
        <input type="range" id="abSlider" min="0" max="200" value="100">
    </div>
    <div class="control-row">
        <label>Particles <span class="value" id="partVal">5000</span></label>
        <input type="range" id="partSlider" min="500" max="10000" value="5000" step="500">
    </div>
    <div class="control-row">
        <label>Speed <span class="value" id="speedVal">1.0</span></label>
        <input type="range" id="speedSlider" min="1" max="30" value="10">
    </div>
    <div class="control-row">
        <label>Auto-Animate</label>
        <button id="autoBtn" class="active">ON</button>
        <button id="resetBtn">Reset Particles</button>
    </div>
</div>

<div class="info">
    Chladni Pattern: f(x,y) = A sin(<span id="infoN">3</span>&pi;x/L) sin(<span id="infoM">5</span>&pi;y/L) + B sin(<span id="infoM2">5</span>&pi;x/L) sin(<span id="infoN2">3</span>&pi;y/L)
</div>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let W, H, plateSize, plateX, plateY;
let n = 3, m = 5, abRatio = 1.0, particleCount = 5000, speed = 1.0;
let autoAnimate = true, autoTime = 0;
let particles = [];
let fieldData = null;
let fieldDirty = true;

function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
    plateSize = Math.min(W, H) * 0.75;
    plateX = (W - plateSize) / 2;
    plateY = (H - plateSize) / 2;
    fieldDirty = true;
}
window.addEventListener('resize', resize);
resize();

function chladni(x, y, nn, mm, ratio) {
    const A = ratio;
    const B = 2.0 - ratio;
    const px = Math.PI * x;
    const py = Math.PI * y;
    return A * Math.sin(nn * px) * Math.sin(mm * py) + B * Math.sin(mm * px) * Math.sin(nn * py);
}

function computeField() {
    const res = Math.min(256, Math.floor(plateSize));
    fieldData = { res, values: new Float32Array(res * res), gradX: new Float32Array(res * res), gradY: new Float32Array(res * res) };
    const inv = 1.0 / (res - 1);
    for (let j = 0; j < res; j++) {
        for (let i = 0; i < res; i++) {
            const x = i * inv;
            const y = j * inv;
            fieldData.values[j * res + i] = chladni(x, y, n, m, abRatio);
        }
    }
    const h = inv;
    for (let j = 0; j < res; j++) {
        for (let i = 0; i < res; i++) {
            const idx = j * res + i;
            const left = i > 0 ? fieldData.values[idx - 1] : fieldData.values[idx];
            const right = i < res - 1 ? fieldData.values[idx + 1] : fieldData.values[idx];
            const up = j > 0 ? fieldData.values[idx - res] : fieldData.values[idx];
            const down = j < res - 1 ? fieldData.values[idx + res] : fieldData.values[idx];
            fieldData.gradX[idx] = (right - left) / (2 * h);
            fieldData.gradY[idx] = (down - up) / (2 * h);
        }
    }
    fieldDirty = false;
}

function initParticles() {
    particles = [];
    for (let i = 0; i < particleCount; i++) {
        particles.push({
            x: Math.random(),
            y: Math.random(),
            vx: 0, vy: 0
        });
    }
}
initParticles();

function sampleField(x, y) {
    if (!fieldData) return { val: 0, gx: 0, gy: 0 };
    const res = fieldData.res;
    const fi = x * (res - 1);
    const fj = y * (res - 1);
    const i = Math.min(Math.max(Math.floor(fi), 0), res - 2);
    const j = Math.min(Math.max(Math.floor(fj), 0), res - 2);
    const fx = fi - i;
    const fy = fj - j;
    const idx00 = j * res + i;
    const idx10 = idx00 + 1;
    const idx01 = idx00 + res;
    const idx11 = idx01 + 1;
    const bilerp = (arr) =>
        arr[idx00] * (1 - fx) * (1 - fy) + arr[idx10] * fx * (1 - fy) +
        arr[idx01] * (1 - fx) * fy + arr[idx11] * fx * fy;
    return { val: bilerp(fieldData.values), gx: bilerp(fieldData.gradX), gy: bilerp(fieldData.gradY) };
}

function updateParticles() {
    const dt = 0.002 * speed;
    const noise = 0.0005 * speed;
    const damping = 0.92;
    for (let i = 0; i < particles.length; i++) {
        const p = particles[i];
        const s = sampleField(p.x, p.y);
        const absVal = Math.abs(s.val);
        const gradMag = Math.sqrt(s.gx * s.gx + s.gy * s.gy) + 0.001;
        const force = absVal * 0.5;
        const dirX = -s.val * s.gx / gradMag;
        const dirY = -s.val * s.gy / gradMag;
        p.vx += dirX * force * dt + (Math.random() - 0.5) * noise;
        p.vy += dirY * force * dt + (Math.random() - 0.5) * noise;
        p.vx *= damping;
        p.vy *= damping;
        p.x += p.vx;
        p.y += p.vy;
        if (p.x < 0) { p.x = 0; p.vx *= -0.5; }
        if (p.x > 1) { p.x = 1; p.vx *= -0.5; }
        if (p.y < 0) { p.y = 0; p.vy *= -0.5; }
        if (p.y > 1) { p.y = 1; p.vy *= -0.5; }
    }
}

function drawPlateField() {
    if (!fieldData) return;
    const res = fieldData.res;
    const imgData = ctx.createImageData(res, res);
    const d = imgData.data;
    for (let j = 0; j < res; j++) {
        for (let i = 0; i < res; i++) {
            const idx = j * res + i;
            const v = fieldData.values[idx];
            const absV = Math.abs(v);
            const pidx = idx * 4;
            const glow = Math.min(absV * 0.15, 0.12);
            d[pidx] = Math.floor(15 + glow * 60);
            d[pidx + 1] = Math.floor(20 + glow * 80);
            d[pidx + 2] = Math.floor(50 + glow * 180);
            d[pidx + 3] = 255;
        }
    }
    const offCanvas = document.createElement('canvas');
    offCanvas.width = res;
    offCanvas.height = res;
    offCanvas.getContext('2d').putImageData(imgData, 0, 0);
    ctx.drawImage(offCanvas, plateX, plateY, plateSize, plateSize);
}

function drawParticles() {
    for (let i = 0; i < particles.length; i++) {
        const p = particles[i];
        const px = plateX + p.x * plateSize;
        const py = plateY + p.y * plateSize;
        const s = sampleField(p.x, p.y);
        const dist = Math.abs(s.val);
        const alpha = Math.max(0.3, 1.0 - dist * 2);
        const r = 221 + Math.floor((1 - dist) * 34);
        const g = 161 + Math.floor((1 - dist) * 60);
        const b = 60 + Math.floor(dist * 40);
        ctx.fillStyle = `rgba(${r},${g},${b},${alpha})`;
        ctx.fillRect(px, py, 1.5, 1.5);
    }
}

function drawPlateBorder() {
    ctx.strokeStyle = 'rgba(138,154,91,0.3)';
    ctx.lineWidth = 2;
    ctx.strokeRect(plateX - 1, plateY - 1, plateSize + 2, plateSize + 2);
}

let animId;
let running = true;

function animate() {
    if (!running) { animId = requestAnimationFrame(animate); return; }
    if (fieldDirty) computeField();

    if (autoAnimate) {
        autoTime += 0.003 * speed;
        const cycle = autoTime * 0.1;
        const newN = 1 + Math.floor((Math.sin(cycle) * 0.5 + 0.5) * 11.99);
        const newM = 1 + Math.floor((Math.cos(cycle * 0.7 + 1) * 0.5 + 0.5) * 11.99);
        if (newN !== n || newM !== m) {
            n = newN; m = newM;
            document.getElementById('nSlider').value = n;
            document.getElementById('mSlider').value = m;
            document.getElementById('nVal').textContent = n;
            document.getElementById('mVal').textContent = m;
            document.getElementById('infoN').textContent = n;
            document.getElementById('infoM').textContent = m;
            document.getElementById('infoN2').textContent = n;
            document.getElementById('infoM2').textContent = m;
            fieldDirty = true;
            computeField();
        }
    }

    for (let step = 0; step < 3; step++) updateParticles();

    ctx.fillStyle = '#0a0e1a';
    ctx.fillRect(0, 0, W, H);

    drawPlateField();
    drawParticles();
    drawPlateBorder();

    animId = requestAnimationFrame(animate);
}

function bindSlider(id, valId, cb) {
    const el = document.getElementById(id);
    el.addEventListener('input', () => { cb(el); document.getElementById(valId).textContent = el.value; });
}

bindSlider('nSlider', 'nVal', (el) => {
    n = parseInt(el.value); fieldDirty = true;
    document.getElementById('infoN').textContent = n;
    document.getElementById('infoN2').textContent = n;
});
bindSlider('mSlider', 'mVal', (el) => {
    m = parseInt(el.value); fieldDirty = true;
    document.getElementById('infoM').textContent = m;
    document.getElementById('infoM2').textContent = m;
});
document.getElementById('abSlider').addEventListener('input', function() {
    abRatio = this.value / 100;
    document.getElementById('abVal').textContent = abRatio.toFixed(2);
    fieldDirty = true;
});
document.getElementById('partSlider').addEventListener('input', function() {
    particleCount = parseInt(this.value);
    document.getElementById('partVal').textContent = particleCount;
    initParticles();
});
document.getElementById('speedSlider').addEventListener('input', function() {
    speed = this.value / 10;
    document.getElementById('speedVal').textContent = speed.toFixed(1);
});
document.getElementById('autoBtn').addEventListener('click', function() {
    autoAnimate = !autoAnimate;
    this.textContent = autoAnimate ? 'ON' : 'OFF';
    this.classList.toggle('active', autoAnimate);
});
document.getElementById('resetBtn').addEventListener('click', initParticles);

window.reset = function() {
    n = 3; m = 5; abRatio = 1.0; particleCount = 5000; speed = 1.0; autoAnimate = true; autoTime = 0;
    document.getElementById('nSlider').value = 3;
    document.getElementById('mSlider').value = 5;
    document.getElementById('abSlider').value = 100;
    document.getElementById('partSlider').value = 5000;
    document.getElementById('speedSlider').value = 10;
    document.getElementById('nVal').textContent = '3';
    document.getElementById('mVal').textContent = '5';
    document.getElementById('abVal').textContent = '1.00';
    document.getElementById('partVal').textContent = '5000';
    document.getElementById('speedVal').textContent = '1.0';
    document.getElementById('autoBtn').textContent = 'ON';
    document.getElementById('autoBtn').classList.add('active');
    fieldDirty = true;
    initParticles();
    resize();
};

window.togglePause = function() { running = !running; };

animate();
</script>
<script src="../assets/js/enhance.js"></script>
</body>
</html>
