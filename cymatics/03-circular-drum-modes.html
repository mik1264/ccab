<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Circular Drum Modes - Cymatics</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; overflow: hidden; font-family: 'Segoe UI', system-ui, sans-serif; color: #c8d0e0; }
canvas { display: block; }
.back-link {
    position: fixed; top: 20px; left: 20px; z-index: 100;
    color: #8A9A5B; text-decoration: none; font-size: 14px; font-weight: 600;
    background: rgba(10,14,26,0.8); border-radius: 25px;
    border: 2px solid #8A9A5B; padding: 10px 20px;
    transition: all 0.3s ease;
}
.back-link:hover { background: #8A9A5B; color: #0a0e1a; }
.controls {
    position: fixed; top: 20px; right: 20px; z-index: 100;
    background: rgba(10,14,26,0.85); backdrop-filter: blur(10px);
    border-radius: 10px; padding: 20px; max-width: 300px;
    border: 1px solid rgba(138,154,91,0.3);
}
.controls h3 { color: #8A9A5B; margin-bottom: 12px; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
.control-row { margin-bottom: 10px; }
.control-row label { display: block; font-size: 12px; color: #8a92a8; margin-bottom: 3px; }
.control-row input[type="range"] { width: 100%; accent-color: #8A9A5B; }
.control-row .value { float: right; color: #DDA15E; font-size: 12px; font-weight: 600; }
.control-row button {
    background: rgba(138,154,91,0.2); color: #8A9A5B; border: 1px solid rgba(138,154,91,0.4);
    padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; margin: 2px;
    transition: all 0.2s;
}
.control-row button:hover { background: rgba(138,154,91,0.4); }
.control-row button.active { background: #8A9A5B; color: #0a0e1a; }
.info {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100;
    background: rgba(10,14,26,0.85); backdrop-filter: blur(10px);
    border-radius: 10px; padding: 10px 20px;
    border: 1px solid rgba(138,154,91,0.3);
    font-size: 13px; color: #8a92a8; text-align: center;
}
.info span { color: #DDA15E; font-weight: 600; }
</style>
</head>
<body>
<a href="index.html" class="back-link">&larr; Cymatics</a>

<div class="controls">
    <h3>Drum Modes</h3>
    <div class="control-row">
        <label>Angular Mode m <span class="value" id="mVal">2</span></label>
        <input type="range" id="mSlider" min="0" max="6" value="2" step="1">
    </div>
    <div class="control-row">
        <label>Radial Mode n <span class="value" id="nVal">1</span></label>
        <input type="range" id="nSlider" min="1" max="5" value="1" step="1">
    </div>
    <div class="control-row">
        <label>Animation Speed <span class="value" id="speedVal">1.0</span></label>
        <input type="range" id="speedSlider" min="1" max="30" value="10">
    </div>
    <div class="control-row">
        <label>Show Nodal Lines</label>
        <button id="nodalBtn" class="active">ON</button>
    </div>
</div>

<div class="info">
    f(r,&theta;) = J<sub><span id="infoM">2</span></sub>(&alpha;<sub><span id="infoM2">2</span>,<span id="infoN">1</span></sub> r/R) cos(<span id="infoM3">2</span>&theta;) cos(&omega;t)
</div>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let W, H, cx, cy, radius;
let mMode = 2, nMode = 1, speed = 1.0, showNodal = true;
let time = 0;
let running = true;

// Bessel function zeros: besselZeros[m][n-1] = nth zero of Jm
const besselZeros = [
    [2.4048, 5.5201, 8.6537, 11.7915, 14.9309], // J0
    [3.8317, 7.0156, 10.1735, 13.3237, 16.4706], // J1
    [5.1356, 8.4172, 11.6198, 14.7960, 17.9598], // J2
    [6.3802, 9.7610, 13.0152, 16.2235, 19.4094], // J3
    [7.5883, 11.0647, 14.3725, 17.6160, 20.8269], // J4
    [8.7715, 12.3386, 15.7002, 18.9801, 22.2178], // J5
    [9.9361, 13.5893, 17.0038, 20.3208, 23.5861], // J6
];

// Bessel function J_m(x) via series expansion
function besselJ(m, x) {
    if (Math.abs(x) < 1e-10) return m === 0 ? 1 : 0;
    let sum = 0;
    let term = 1;
    // (x/2)^m / m!
    const halfX = x / 2;
    let pow = 1;
    for (let i = 0; i < m; i++) pow *= halfX;
    let factorial = 1;
    for (let i = 1; i <= m; i++) factorial *= i;
    term = pow / factorial;
    sum = term;
    const x2over4 = -(x * x) / 4;
    for (let k = 1; k <= 30; k++) {
        term *= x2over4 / (k * (k + m));
        sum += term;
        if (Math.abs(term) < 1e-15 * Math.abs(sum)) break;
    }
    return sum;
}

function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
    cx = W / 2;
    cy = H / 2;
    radius = Math.min(W, H) * 0.38;
}
window.addEventListener('resize', resize);
resize();

function getAlpha() {
    return besselZeros[mMode][nMode - 1];
}

function drumValue(r, theta, t) {
    if (r > 1) return 0;
    const alpha = getAlpha();
    return besselJ(mMode, alpha * r) * Math.cos(mMode * theta) * Math.cos(speed * alpha * t);
}

function draw() {
    ctx.fillStyle = '#0a0e1a';
    ctx.fillRect(0, 0, W, H);

    // Draw membrane as pixel field
    const res = Math.min(400, Math.floor(radius * 2));
    const imgData = ctx.createImageData(res, res);
    const d = imgData.data;
    const half = res / 2;
    const inv = 1.0 / half;

    for (let j = 0; j < res; j++) {
        for (let i = 0; i < res; i++) {
            const dx = (i - half) * inv;
            const dy = (j - half) * inv;
            const r = Math.sqrt(dx * dx + dy * dy);
            const pidx = (j * res + i) * 4;

            if (r > 1.0) {
                d[pidx] = 10; d[pidx + 1] = 14; d[pidx + 2] = 26; d[pidx + 3] = 255;
                continue;
            }

            const theta = Math.atan2(dy, dx);
            const v = drumValue(r, theta, time);
            const absV = Math.abs(v);

            // Blue-white-red colormap
            let cr, cg, cb;
            if (v > 0) {
                const t = Math.min(v * 2, 1);
                cr = Math.floor(140 + t * 115);
                cg = Math.floor(60 + (1 - t) * 195);
                cb = Math.floor(60 + (1 - t) * 195);
            } else {
                const t = Math.min(-v * 2, 1);
                cr = Math.floor(60 + (1 - t) * 195);
                cg = Math.floor(60 + (1 - t) * 195);
                cb = Math.floor(140 + t * 115);
            }

            // Nodal line highlighting
            if (showNodal && absV < 0.03) {
                cr = 255; cg = 255; cb = 255;
            }

            // Edge fade
            const edgeFade = r > 0.95 ? (1.0 - r) / 0.05 : 1.0;
            const bgR = 10, bgG = 14, bgB = 26;
            cr = Math.floor(bgR + (cr - bgR) * edgeFade);
            cg = Math.floor(bgG + (cg - bgG) * edgeFade);
            cb = Math.floor(bgB + (cb - bgB) * edgeFade);

            d[pidx] = cr;
            d[pidx + 1] = cg;
            d[pidx + 2] = cb;
            d[pidx + 3] = 255;
        }
    }

    const offCanvas = document.createElement('canvas');
    offCanvas.width = res;
    offCanvas.height = res;
    offCanvas.getContext('2d').putImageData(imgData, 0, 0);
    ctx.drawImage(offCanvas, cx - radius, cy - radius, radius * 2, radius * 2);

    // Draw drum rim
    ctx.beginPath();
    ctx.arc(cx, cy, radius + 2, 0, Math.PI * 2);
    ctx.strokeStyle = 'rgba(138,154,91,0.5)';
    ctx.lineWidth = 3;
    ctx.stroke();

    // Draw nodal pattern overlay (analytical lines)
    if (showNodal) {
        ctx.save();
        ctx.globalAlpha = 0.3;
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 1;

        // Radial nodal lines (from angular modes)
        if (mMode > 0) {
            for (let k = 0; k < mMode; k++) {
                const angle = (k * Math.PI) / mMode + Math.PI / (2 * mMode);
                ctx.beginPath();
                ctx.moveTo(cx - radius * Math.cos(angle), cy - radius * Math.sin(angle));
                ctx.lineTo(cx + radius * Math.cos(angle), cy + radius * Math.sin(angle));
                ctx.stroke();
            }
        }

        // Circular nodal lines (from radial modes)
        const alpha = getAlpha();
        for (let k = 1; k < nMode; k++) {
            // Internal zeros of Bessel function between 0 and alpha
            // Approximate: find zeros of Jm between 0 and alpha
            const innerZero = besselZeros[mMode][k - 1];
            const nodalR = (innerZero / alpha) * radius;
            ctx.beginPath();
            ctx.arc(cx, cy, nodalR, 0, Math.PI * 2);
            ctx.stroke();
        }

        ctx.restore();
    }
}

function animate() {
    if (running) {
        time += 0.016 * speed;
    }
    draw();
    requestAnimationFrame(animate);
}

function updateInfo() {
    document.getElementById('infoM').textContent = mMode;
    document.getElementById('infoM2').textContent = mMode;
    document.getElementById('infoM3').textContent = mMode;
    document.getElementById('infoN').textContent = nMode;
}

document.getElementById('mSlider').addEventListener('input', function() {
    mMode = parseInt(this.value);
    document.getElementById('mVal').textContent = mMode;
    updateInfo();
});

document.getElementById('nSlider').addEventListener('input', function() {
    nMode = parseInt(this.value);
    document.getElementById('nVal').textContent = nMode;
    updateInfo();
});

document.getElementById('speedSlider').addEventListener('input', function() {
    speed = this.value / 10;
    document.getElementById('speedVal').textContent = speed.toFixed(1);
});

document.getElementById('nodalBtn').addEventListener('click', function() {
    showNodal = !showNodal;
    this.textContent = showNodal ? 'ON' : 'OFF';
    this.classList.toggle('active', showNodal);
});

window.reset = function() {
    mMode = 2; nMode = 1; speed = 1.0; showNodal = true; time = 0;
    document.getElementById('mSlider').value = 2;
    document.getElementById('nSlider').value = 1;
    document.getElementById('speedSlider').value = 10;
    document.getElementById('mVal').textContent = '2';
    document.getElementById('nVal').textContent = '1';
    document.getElementById('speedVal').textContent = '1.0';
    document.getElementById('nodalBtn').textContent = 'ON';
    document.getElementById('nodalBtn').classList.add('active');
    updateInfo();
    resize();
};

window.togglePause = function() { running = !running; };

animate();
</script>
<script src="../assets/js/enhance.js"></script>
</body>
</html>
