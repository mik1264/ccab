<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beat Frequencies - Cymatics</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0a0e1a;
            color: #e0e0e0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }
        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }
        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            color: #8A9A5B;
            background: rgba(10,14,26,0.8);
            border-radius: 25px;
            border: 2px solid #8A9A5B;
            padding: 10px 20px;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            transition: background 0.3s, color 0.3s;
        }
        .back-link:hover {
            background: #8A9A5B;
            color: #0a0e1a;
        }
        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(10,14,26,0.85);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 20px;
            max-width: 300px;
            border: 1px solid rgba(138,154,91,0.3);
        }
        .controls h3 {
            color: #8A9A5B;
            margin-bottom: 15px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .control-group {
            margin-bottom: 12px;
        }
        .control-group label {
            display: block;
            font-size: 11px;
            color: #aaa;
            margin-bottom: 4px;
        }
        .control-group input[type="range"] {
            width: 100%;
            accent-color: #8A9A5B;
        }
        .control-group .value {
            font-size: 11px;
            color: #8A9A5B;
            float: right;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #888;
            margin-top: 4px;
        }
        .info-row .val {
            color: #DDA15E;
            font-weight: 600;
        }
        .beat-display {
            text-align: center;
            margin: 10px 0;
            padding: 8px;
            background: rgba(221,161,94,0.1);
            border-radius: 6px;
            border: 1px solid rgba(221,161,94,0.3);
        }
        .beat-display .beat-label {
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .beat-display .beat-value {
            font-size: 22px;
            color: #DDA15E;
            font-weight: 700;
        }
        .beat-display .beat-unit {
            font-size: 11px;
            color: #888;
        }
        .info-text {
            font-size: 10px;
            color: #666;
            line-height: 1.5;
            margin-top: 10px;
            border-top: 1px solid rgba(100,100,100,0.3);
            padding-top: 10px;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">&#8592; Cymatics</a>
    <div class="controls">
        <h3>Beat Frequencies</h3>
        <div class="control-group">
            <label>Frequency 1 <span class="value" id="f1Val">300 Hz</span></label>
            <input type="range" id="freq1" min="200" max="500" step="1" value="300">
        </div>
        <div class="control-group">
            <label>Frequency 2 <span class="value" id="f2Val">304 Hz</span></label>
            <input type="range" id="freq2" min="200" max="500" step="1" value="304">
        </div>
        <div class="control-group">
            <label>Zoom <span class="value" id="zoomVal">1.0x</span></label>
            <input type="range" id="zoom" min="0.5" max="4.0" step="0.1" value="1.0">
        </div>
        <div class="beat-display">
            <div class="beat-label">Beat Frequency</div>
            <div class="beat-value" id="beatFreq">4</div>
            <div class="beat-unit">Hz = |f1 - f2|</div>
        </div>
        <div class="info-row">
            <span>f1:</span>
            <span class="val" style="color:#4ecdc4">300 Hz</span>
        </div>
        <div class="info-row">
            <span>f2:</span>
            <span class="val" style="color:#ff6b6b">304 Hz</span>
        </div>
        <div class="info-row">
            <span>Average:</span>
            <span class="val" id="avgFreq">302 Hz</span>
        </div>
        <div class="info-text">
            When two frequencies are close together, their sum produces a slow amplitude modulation called "beating". The beat frequency equals the difference |f1 - f2|. When f1 = f2, the beat disappears.
        </div>
    </div>
    <canvas id="canvas"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            canvas.width = window.innerWidth * devicePixelRatio;
            canvas.height = window.innerHeight * devicePixelRatio;
            ctx.scale(devicePixelRatio, devicePixelRatio);
        }
        resize();
        window.addEventListener('resize', resize);

        const W = () => window.innerWidth;
        const H = () => window.innerHeight;

        const freq1Slider = document.getElementById('freq1');
        const freq2Slider = document.getElementById('freq2');
        const zoomSlider = document.getElementById('zoom');

        let t = 0;
        let paused = false;

        function reset() {
            t = 0;
        }
        window.reset = reset;

        // Simple DFT for a short buffer
        function simpleDFT(buffer, sampleRate, maxFreq) {
            const result = [];
            const freqStep = 2;
            for (let freq = 0; freq <= maxFreq; freq += freqStep) {
                let real = 0, imag = 0;
                for (let n = 0; n < buffer.length; n++) {
                    const angle = 2 * Math.PI * freq * n / sampleRate;
                    real += buffer[n] * Math.cos(angle);
                    imag -= buffer[n] * Math.sin(angle);
                }
                const mag = Math.sqrt(real * real + imag * imag) / buffer.length;
                result.push({ freq, mag });
            }
            return result;
        }

        let animId;
        function animate() {
            animId = requestAnimationFrame(animate);
            if (paused) return;

            const w = W();
            const h = H();
            ctx.clearRect(0, 0, w, h);

            const f1 = parseInt(freq1Slider.value);
            const f2 = parseInt(freq2Slider.value);
            const zoom = parseFloat(zoomSlider.value);
            const beatF = Math.abs(f1 - f2);
            const avgF = (f1 + f2) / 2;

            document.getElementById('f1Val').textContent = f1 + ' Hz';
            document.getElementById('f2Val').textContent = f2 + ' Hz';
            document.getElementById('zoomVal').textContent = zoom.toFixed(1) + 'x';
            document.getElementById('beatFreq').textContent = beatF;
            document.getElementById('avgFreq').textContent = Math.round(avgF) + ' Hz';

            // Update info rows
            const infoRows = document.querySelectorAll('.info-row .val');
            infoRows[0].textContent = f1 + ' Hz';
            infoRows[1].textContent = f2 + ' Hz';

            t += 1 / 60;

            // Normalized frequencies for visual display
            const displayF1 = f1 / 50 * zoom;
            const displayF2 = f2 / 50 * zoom;
            const scrollSpeed = 2;

            // Layout
            const margin = 80;
            const panelRight = 340;
            const plotX = margin;
            const plotW = w - margin - panelRight;
            const plotH = h * 0.18;

            // --- Wave 1 ---
            const wave1Y = h * 0.14;
            drawWavePlot(plotX, wave1Y, plotW, plotH,
                (x) => Math.sin(2 * Math.PI * displayF1 * (x / plotW * 4 - t * scrollSpeed)),
                'f\u2081 = ' + f1 + ' Hz', '#4ecdc4', 'rgba(78,205,196,');

            // --- Wave 2 ---
            const wave2Y = h * 0.36;
            drawWavePlot(plotX, wave2Y, plotW, plotH,
                (x) => Math.sin(2 * Math.PI * displayF2 * (x / plotW * 4 - t * scrollSpeed)),
                'f\u2082 = ' + f2 + ' Hz', '#ff6b6b', 'rgba(255,107,107,');

            // --- Combined wave with envelope ---
            const wave3Y = h * 0.6;
            const combH = plotH * 1.3;

            // Border and label
            ctx.strokeStyle = 'rgba(138,154,91,0.2)';
            ctx.lineWidth = 1;
            ctx.strokeRect(plotX, wave3Y - combH / 2, plotW, combH);
            ctx.fillStyle = 'rgba(255,255,255,0.6)';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('Combined: f\u2081 + f\u2082  (beat = ' + beatF + ' Hz)', plotX + 5, wave3Y - combH / 2 - 8);

            // Zero line
            ctx.strokeStyle = 'rgba(100,100,100,0.2)';
            ctx.beginPath();
            ctx.moveTo(plotX, wave3Y);
            ctx.lineTo(plotX + plotW, wave3Y);
            ctx.stroke();

            // Envelope
            const displayBeatF = Math.abs(displayF1 - displayF2);
            if (beatF > 0) {
                ctx.beginPath();
                for (let x = 0; x <= plotW; x++) {
                    const tt = x / plotW * 4 - t * scrollSpeed;
                    const env = Math.abs(Math.cos(Math.PI * displayBeatF * tt));
                    const py = wave3Y - env * combH * 0.4;
                    if (x === 0) ctx.moveTo(plotX + x, py);
                    else ctx.lineTo(plotX + x, py);
                }
                ctx.strokeStyle = 'rgba(221,161,94,0.5)';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.stroke();
                ctx.setLineDash([]);

                // Lower envelope
                ctx.beginPath();
                for (let x = 0; x <= plotW; x++) {
                    const tt = x / plotW * 4 - t * scrollSpeed;
                    const env = Math.abs(Math.cos(Math.PI * displayBeatF * tt));
                    const py = wave3Y + env * combH * 0.4;
                    if (x === 0) ctx.moveTo(plotX + x, py);
                    else ctx.lineTo(plotX + x, py);
                }
                ctx.strokeStyle = 'rgba(221,161,94,0.5)';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.stroke();
                ctx.setLineDash([]);
            }

            // Combined waveform
            ctx.beginPath();
            for (let x = 0; x <= plotW; x++) {
                const tt = x / plotW * 4 - t * scrollSpeed;
                const y1 = Math.sin(2 * Math.PI * displayF1 * tt);
                const y2 = Math.sin(2 * Math.PI * displayF2 * tt);
                const combined = (y1 + y2) / 2;
                const py = wave3Y + combined * combH * 0.4;
                if (x === 0) ctx.moveTo(plotX + x, py);
                else ctx.lineTo(plotX + x, py);
            }
            const combGrad = ctx.createLinearGradient(plotX, 0, plotX + plotW, 0);
            combGrad.addColorStop(0, 'rgba(255,255,220,0.9)');
            combGrad.addColorStop(0.5, 'rgba(221,161,94,0.9)');
            combGrad.addColorStop(1, 'rgba(255,255,220,0.9)');
            ctx.strokeStyle = combGrad;
            ctx.lineWidth = 1.8;
            ctx.stroke();

            // Beat period label
            if (beatF > 0 && beatF < 30) {
                const beatPeriod = 1 / (displayBeatF);
                const beatPixels = beatPeriod / 4 * plotW;
                if (beatPixels > 40 && beatPixels < plotW) {
                    const arrowY = wave3Y + combH / 2 + 20;
                    const arrowX1 = plotX + plotW / 2 - beatPixels / 2;
                    const arrowX2 = plotX + plotW / 2 + beatPixels / 2;

                    ctx.strokeStyle = '#DDA15E';
                    ctx.lineWidth = 1.5;
                    ctx.beginPath();
                    ctx.moveTo(arrowX1, arrowY);
                    ctx.lineTo(arrowX2, arrowY);
                    ctx.stroke();

                    // Arrow heads
                    ctx.beginPath();
                    ctx.moveTo(arrowX1, arrowY - 4);
                    ctx.lineTo(arrowX1, arrowY + 4);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(arrowX2, arrowY - 4);
                    ctx.lineTo(arrowX2, arrowY + 4);
                    ctx.stroke();

                    ctx.fillStyle = '#DDA15E';
                    ctx.font = '11px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('Beat period = 1/' + beatF + ' s', (arrowX1 + arrowX2) / 2, arrowY - 8);
                }
            }

            // --- Frequency spectrum ---
            const specY = h * 0.84;
            const specH = h * 0.1;
            const specMaxFreq = 600;

            ctx.strokeStyle = 'rgba(138,154,91,0.2)';
            ctx.lineWidth = 1;
            ctx.strokeRect(plotX, specY - specH / 2, plotW, specH);
            ctx.fillStyle = 'rgba(138,154,91,0.6)';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('Frequency Spectrum', plotX + 5, specY - specH / 2 - 8);

            // X-axis labels
            ctx.fillStyle = '#666';
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'center';
            for (let f = 100; f <= 500; f += 100) {
                const fx = plotX + (f / specMaxFreq) * plotW;
                ctx.fillText(f + ' Hz', fx, specY + specH / 2 + 14);
                ctx.strokeStyle = 'rgba(100,100,100,0.15)';
                ctx.beginPath();
                ctx.moveTo(fx, specY - specH / 2);
                ctx.lineTo(fx, specY + specH / 2);
                ctx.stroke();
            }

            // Draw spectral peaks
            function drawPeak(freq, color, label) {
                const fx = plotX + (freq / specMaxFreq) * plotW;
                const peakH = specH * 0.8;

                // Gaussian peak shape
                ctx.beginPath();
                for (let dx = -40; dx <= 40; dx++) {
                    const amp = Math.exp(-(dx * dx) / 80);
                    const py = specY + specH / 2 - amp * peakH;
                    if (dx === -40) ctx.moveTo(fx + dx, py);
                    else ctx.lineTo(fx + dx, py);
                }
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.stroke();

                // Fill
                ctx.lineTo(fx + 40, specY + specH / 2);
                ctx.lineTo(fx - 40, specY + specH / 2);
                ctx.closePath();
                ctx.fillStyle = color.replace('0.8)', '0.1)');
                ctx.fill();

                // Label
                ctx.fillStyle = color;
                ctx.font = '10px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(label, fx, specY - specH / 2 - 5);
            }

            drawPeak(f1, 'rgba(78,205,196,0.8)', 'f\u2081');
            drawPeak(f2, 'rgba(255,107,107,0.8)', 'f\u2082');

            // Beat frequency annotation
            if (beatF > 0) {
                const fx1 = plotX + (f1 / specMaxFreq) * plotW;
                const fx2 = plotX + (f2 / specMaxFreq) * plotW;
                const braY = specY + specH / 2 + 25;

                ctx.strokeStyle = 'rgba(221,161,94,0.6)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(Math.min(fx1, fx2), braY);
                ctx.lineTo(Math.max(fx1, fx2), braY);
                ctx.stroke();

                ctx.fillStyle = '#DDA15E';
                ctx.font = '10px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('\u0394f = ' + beatF + ' Hz', (fx1 + fx2) / 2, braY + 14);
            }

            // Bottom label
            ctx.fillStyle = '#555';
            ctx.font = '11px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('f1 \u2248 f2: slow beats  |  f1 = f2: no beats  |  f1 far from f2: rapid beats', w / 2 - panelRight / 2 + margin / 2, h - 12);
        }

        function drawWavePlot(x, centerY, w, h, waveFn, label, color, colorBase) {
            // Border
            ctx.strokeStyle = 'rgba(138,154,91,0.2)';
            ctx.lineWidth = 1;
            ctx.strokeRect(x, centerY - h / 2, w, h);

            // Label
            ctx.fillStyle = color;
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText(label, x + 5, centerY - h / 2 - 8);

            // Zero line
            ctx.strokeStyle = 'rgba(100,100,100,0.2)';
            ctx.beginPath();
            ctx.moveTo(x, centerY);
            ctx.lineTo(x + w, centerY);
            ctx.stroke();

            // Waveform
            ctx.beginPath();
            for (let i = 0; i <= w; i++) {
                const val = waveFn(i);
                const py = centerY + val * h * 0.4;
                if (i === 0) ctx.moveTo(x + i, py);
                else ctx.lineTo(x + i, py);
            }
            ctx.strokeStyle = color;
            ctx.lineWidth = 1.8;
            ctx.stroke();

            // Subtle fill
            ctx.lineTo(x + w, centerY);
            ctx.lineTo(x, centerY);
            ctx.closePath();
            ctx.fillStyle = colorBase + '0.03)';
            ctx.fill();
        }

        animate();

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) cancelAnimationFrame(animId);
            else animate();
        });
    </script>
    <script src="../assets/js/enhance.js"></script>
</body>
</html>