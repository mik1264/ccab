<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stucki Dithering Comparison - CCAB</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #151520 0%, #202035 50%, #151520 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .organic-back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 10000;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: #BC6C25;
            text-decoration: none;
            font-weight: 600;
            padding: 0.5rem 1rem;
            background: rgba(254, 250, 224, 0.95);
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        .organic-back-link:hover {
            background: rgba(254, 250, 224, 1);
            transform: translateX(-5px);
        }

        .container { max-width: 1400px; margin: 60px auto 0; }

        h1 { text-align: center; font-size: 2rem; margin-bottom: 0.5rem; color: #88ccff; }
        .subtitle { text-align: center; color: #888; margin-bottom: 1.5rem; }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .canvas-panel {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid rgba(136, 204, 255, 0.2);
            text-align: center;
        }

        .canvas-panel h5 { color: #88ccff; margin-bottom: 8px; font-size: 0.9rem; }

        canvas {
            border: 1px solid rgba(136, 204, 255, 0.3);
            border-radius: 6px;
            width: 100%;
            image-rendering: pixelated;
        }

        .kernel-display {
            font-size: 0.7rem;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            font-family: monospace;
            color: #aaa;
        }

        .panel {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(136, 204, 255, 0.2);
            margin-bottom: 20px;
        }

        .panel h3 { color: #88ccff; margin-bottom: 15px; }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        .control-group { display: flex; flex-direction: column; gap: 5px; }
        .control-group label { color: #aaa; font-size: 0.85rem; }
        .control-group input[type="range"] { width: 100%; cursor: pointer; }
        .control-group span { color: #88ccff; }

        select {
            padding: 8px;
            background: rgba(136, 204, 255, 0.1);
            border: 1px solid rgba(136, 204, 255, 0.3);
            border-radius: 6px;
            color: #e0e0e0;
            font-family: inherit;
        }

        .buttons { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }

        button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #88ccff, #5588cc);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(136, 204, 255, 0.4);
        }

        .info-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
        }

        .info-panel h4 { color: #88ccff; margin-bottom: 10px; }
        .info-panel p { font-size: 0.9rem; line-height: 1.6; color: #aaa; margin-bottom: 10px; }

        @media (max-width: 900px) {
            .comparison-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 500px) {
            .comparison-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <a href="index.html" class="organic-back-link">← Back to Gallery</a>

    <div class="container">
        <h1>Error Diffusion Dithering Comparison</h1>
        <p class="subtitle">Stucki vs Floyd-Steinberg vs Atkinson vs Sierra</p>

        <div class="comparison-grid">
            <div class="canvas-panel">
                <h5>Original</h5>
                <canvas id="sourceCanvas" width="200" height="200"></canvas>
            </div>
            <div class="canvas-panel">
                <h5>Floyd-Steinberg</h5>
                <canvas id="floydCanvas" width="200" height="200"></canvas>
                <div class="kernel-display">
                    * 7/16<br>
                    3/16 5/16 1/16
                </div>
            </div>
            <div class="canvas-panel">
                <h5>Stucki</h5>
                <canvas id="stuckiCanvas" width="200" height="200"></canvas>
                <div class="kernel-display">
                    * 8/42 4/42<br>
                    2/42 4/42 8/42 4/42 2/42<br>
                    1/42 2/42 4/42 2/42 1/42
                </div>
            </div>
            <div class="canvas-panel">
                <h5>Atkinson</h5>
                <canvas id="atkinsonCanvas" width="200" height="200"></canvas>
                <div class="kernel-display">
                    * 1/8 1/8<br>
                    1/8 1/8 1/8<br>
                    &nbsp;&nbsp;&nbsp; 1/8
                </div>
            </div>
        </div>

        <div class="comparison-grid">
            <div class="canvas-panel">
                <h5>Bayer 4×4 (Ordered)</h5>
                <canvas id="bayerCanvas" width="200" height="200"></canvas>
                <div class="kernel-display">
                    Threshold matrix<br>
                    (not error diffusion)
                </div>
            </div>
            <div class="canvas-panel">
                <h5>Sierra</h5>
                <canvas id="sierraCanvas" width="200" height="200"></canvas>
                <div class="kernel-display">
                    * 5/32 3/32<br>
                    2/32 4/32 5/32 4/32 2/32<br>
                    &nbsp;&nbsp;&nbsp; 2/32 3/32 2/32
                </div>
            </div>
            <div class="canvas-panel">
                <h5>Sierra Lite</h5>
                <canvas id="sierraLiteCanvas" width="200" height="200"></canvas>
                <div class="kernel-display">
                    * 2/4<br>
                    1/4 1/4
                </div>
            </div>
            <div class="canvas-panel">
                <h5>Jarvis-Judice-Ninke</h5>
                <canvas id="jarvisCanvas" width="200" height="200"></canvas>
                <div class="kernel-display">
                    * 7/48 5/48<br>
                    3/48 5/48 7/48 5/48 3/48<br>
                    1/48 3/48 5/48 3/48 1/48
                </div>
            </div>
        </div>

        <div class="panel">
            <h3>Controls</h3>
            <div class="controls">
                <div class="control-group">
                    <label>Source Pattern</label>
                    <select id="sourcePattern">
                        <option value="gradient">Gradient</option>
                        <option value="radial">Radial</option>
                        <option value="photo">Photo-like</option>
                        <option value="portrait">Portrait</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Error Multiplier: <span id="errorVal">1.0</span></label>
                    <input type="range" id="errorMult" min="0.5" max="1.5" step="0.1" value="1">
                </div>

                <div class="control-group">
                    <label>Threshold: <span id="threshVal">128</span></label>
                    <input type="range" id="threshold" min="64" max="192" value="128">
                </div>
            </div>

            <div class="buttons">
                <button onclick="applyAllDithering()">Apply All</button>
                <button onclick="generateSource()">New Source</button>
                <button onclick="toggleSerpentine()">Toggle Serpentine</button>
            </div>
        </div>

        <div class="info-panel">
            <h4>Error Diffusion Dithering</h4>
            <p>
                Error diffusion works by quantizing each pixel to black or white, then spreading
                the quantization error to neighboring pixels according to a diffusion kernel.
                This creates smooth gradients and preserves image detail.
            </p>
            <p>
                <strong>Floyd-Steinberg (1976):</strong> Classic algorithm, good balance of quality and speed.<br>
                <strong>Stucki (1981):</strong> Larger kernel, smoother gradients, less dithering noise.<br>
                <strong>Atkinson:</strong> Only diffuses 75% of error, preserving more contrast.<br>
                <strong>Sierra/JJN:</strong> Even larger kernels for maximum smoothness.
            </p>
            <p>
                Serpentine scanning (alternating left-to-right and right-to-left) reduces
                directional artifacts common in error diffusion algorithms.
            </p>
        </div>
    </div>

    <script>
        const canvases = {
            source: document.getElementById('sourceCanvas'),
            floyd: document.getElementById('floydCanvas'),
            stucki: document.getElementById('stuckiCanvas'),
            atkinson: document.getElementById('atkinsonCanvas'),
            bayer: document.getElementById('bayerCanvas'),
            sierra: document.getElementById('sierraCanvas'),
            sierraLite: document.getElementById('sierraLiteCanvas'),
            jarvis: document.getElementById('jarvisCanvas')
        };

        let errorMult = 1.0;
        let threshold = 128;
        let sourcePattern = 'gradient';
        let serpentine = true;

        // Diffusion kernels: [dx, dy, weight]
        const kernels = {
            floydSteinberg: [
                [1, 0, 7/16],
                [-1, 1, 3/16],
                [0, 1, 5/16],
                [1, 1, 1/16]
            ],
            stucki: [
                [1, 0, 8/42], [2, 0, 4/42],
                [-2, 1, 2/42], [-1, 1, 4/42], [0, 1, 8/42], [1, 1, 4/42], [2, 1, 2/42],
                [-2, 2, 1/42], [-1, 2, 2/42], [0, 2, 4/42], [1, 2, 2/42], [2, 2, 1/42]
            ],
            atkinson: [
                [1, 0, 1/8], [2, 0, 1/8],
                [-1, 1, 1/8], [0, 1, 1/8], [1, 1, 1/8],
                [0, 2, 1/8]
            ],
            sierra: [
                [1, 0, 5/32], [2, 0, 3/32],
                [-2, 1, 2/32], [-1, 1, 4/32], [0, 1, 5/32], [1, 1, 4/32], [2, 1, 2/32],
                [-1, 2, 2/32], [0, 2, 3/32], [1, 2, 2/32]
            ],
            sierraLite: [
                [1, 0, 2/4],
                [-1, 1, 1/4], [0, 1, 1/4]
            ],
            jarvis: [
                [1, 0, 7/48], [2, 0, 5/48],
                [-2, 1, 3/48], [-1, 1, 5/48], [0, 1, 7/48], [1, 1, 5/48], [2, 1, 3/48],
                [-2, 2, 1/48], [-1, 2, 3/48], [0, 2, 5/48], [1, 2, 3/48], [2, 2, 1/48]
            ]
        };

        function generateSource() {
            const canvas = canvases.source;
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const imageData = ctx.createImageData(width, height);
            const data = imageData.data;

            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const idx = (y * width + x) * 4;
                    let gray;

                    switch (sourcePattern) {
                        case 'gradient':
                            gray = (x / width) * 255;
                            break;
                        case 'radial':
                            const cx = width / 2, cy = height / 2;
                            const dist = Math.sqrt((x - cx) ** 2 + (y - cy) ** 2);
                            gray = (1 - dist / (Math.sqrt(2) * 100)) * 255;
                            break;
                        case 'photo':
                            // Simulated photo with multiple tones
                            const zone = Math.floor(x / 50);
                            const yZone = Math.floor(y / 50);
                            gray = ((zone + yZone) % 5) * 50 + 25;
                            gray += Math.sin(x * 0.1) * 20 + Math.sin(y * 0.1) * 20;
                            break;
                        case 'portrait':
                            const px = width / 2, py = height / 2;
                            const fd = Math.sqrt((x - px) ** 2 + (y - py) ** 2);
                            if (fd < 80) {
                                gray = 200 - fd * 0.8;
                                const el = Math.sqrt((x - px + 25) ** 2 + (y - py + 15) ** 2);
                                const er = Math.sqrt((x - px - 25) ** 2 + (y - py + 15) ** 2);
                                if (el < 12 || er < 12) gray = 40;
                            } else {
                                gray = 230;
                            }
                            break;
                    }

                    gray = Math.max(0, Math.min(255, gray));
                    data[idx] = data[idx + 1] = data[idx + 2] = gray;
                    data[idx + 3] = 255;
                }
            }

            ctx.putImageData(imageData, 0, 0);
        }

        function errorDiffusion(sourceCanvas, outputCanvas, kernel) {
            const ctx = outputCanvas.getContext('2d');
            const width = outputCanvas.width;
            const height = outputCanvas.height;

            const srcData = sourceCanvas.getContext('2d').getImageData(0, 0, width, height);
            const errors = new Float32Array(width * height);

            // Copy source to errors
            for (let i = 0; i < errors.length; i++) {
                errors[i] = srcData.data[i * 4];
            }

            const outData = ctx.createImageData(width, height);

            for (let y = 0; y < height; y++) {
                const leftToRight = !serpentine || (y % 2 === 0);

                for (let i = 0; i < width; i++) {
                    const x = leftToRight ? i : width - 1 - i;
                    const idx = y * width + x;

                    const oldPixel = errors[idx];
                    const newPixel = oldPixel < threshold ? 0 : 255;
                    const error = (oldPixel - newPixel) * errorMult;

                    outData.data[idx * 4] = newPixel;
                    outData.data[idx * 4 + 1] = newPixel;
                    outData.data[idx * 4 + 2] = newPixel;
                    outData.data[idx * 4 + 3] = 255;

                    // Diffuse error
                    for (const [dx, dy, weight] of kernel) {
                        const nx = x + (leftToRight ? dx : -dx);
                        const ny = y + dy;

                        if (nx >= 0 && nx < width && ny >= 0 && ny < height) {
                            errors[ny * width + nx] += error * weight;
                        }
                    }
                }
            }

            ctx.putImageData(outData, 0, 0);
        }

        function bayerDithering(sourceCanvas, outputCanvas) {
            const ctx = outputCanvas.getContext('2d');
            const width = outputCanvas.width;
            const height = outputCanvas.height;

            const srcData = sourceCanvas.getContext('2d').getImageData(0, 0, width, height);
            const outData = ctx.createImageData(width, height);

            const bayer4x4 = [
                [0, 8, 2, 10],
                [12, 4, 14, 6],
                [3, 11, 1, 9],
                [15, 7, 13, 5]
            ];

            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const idx = (y * width + x) * 4;
                    const gray = srcData.data[idx];
                    const thresh = ((bayer4x4[y % 4][x % 4] + 0.5) / 16) * 255;
                    const newPixel = gray > thresh ? 255 : 0;

                    outData.data[idx] = newPixel;
                    outData.data[idx + 1] = newPixel;
                    outData.data[idx + 2] = newPixel;
                    outData.data[idx + 3] = 255;
                }
            }

            ctx.putImageData(outData, 0, 0);
        }

        function applyAllDithering() {
            errorDiffusion(canvases.source, canvases.floyd, kernels.floydSteinberg);
            errorDiffusion(canvases.source, canvases.stucki, kernels.stucki);
            errorDiffusion(canvases.source, canvases.atkinson, kernels.atkinson);
            errorDiffusion(canvases.source, canvases.sierra, kernels.sierra);
            errorDiffusion(canvases.source, canvases.sierraLite, kernels.sierraLite);
            errorDiffusion(canvases.source, canvases.jarvis, kernels.jarvis);
            bayerDithering(canvases.source, canvases.bayer);
        }

        function toggleSerpentine() {
            serpentine = !serpentine;
            applyAllDithering();
        }

        // Event listeners
        document.getElementById('sourcePattern').addEventListener('change', function() {
            sourcePattern = this.value;
            generateSource();
            applyAllDithering();
        });

        document.getElementById('errorMult').addEventListener('input', function() {
            errorMult = parseFloat(this.value);
            document.getElementById('errorVal').textContent = errorMult.toFixed(1);
            applyAllDithering();
        });

        document.getElementById('threshold').addEventListener('input', function() {
            threshold = parseInt(this.value);
            document.getElementById('threshVal').textContent = threshold;
            applyAllDithering();
        });

        // Initialize
        generateSource();
        applyAllDithering();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
