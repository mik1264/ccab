<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reinhard Tone Mapping Lab - CCAB</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2525 50%, #1a1a1a 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .organic-back-link {
            position: fixed; top: 20px; left: 20px; z-index: 10000;
            display: inline-flex; align-items: center; gap: 0.5rem;
            color: #BC6C25; text-decoration: none; font-weight: 600;
            padding: 0.5rem 1rem; background: rgba(254, 250, 224, 0.95);
            border-radius: 20px; transition: all 0.3s ease;
        }

        .organic-back-link:hover { background: rgba(254, 250, 224, 1); transform: translateX(-5px); }

        .container { max-width: 1200px; margin: 60px auto 0; }

        h1 { text-align: center; font-size: 2rem; margin-bottom: 0.5rem; color: #ffcc66; }
        .subtitle { text-align: center; color: #888; margin-bottom: 1.5rem; }

        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }

        .canvas-panel {
            background: rgba(255, 255, 255, 0.03); border-radius: 12px;
            padding: 15px; border: 1px solid rgba(255, 204, 102, 0.2); text-align: center;
        }

        .canvas-panel h4 { color: #ffcc66; margin-bottom: 10px; }

        canvas { border: 2px solid rgba(255, 204, 102, 0.3); border-radius: 8px; max-width: 100%; }

        .curve-panel { margin-bottom: 20px; }

        .panel {
            background: rgba(255, 255, 255, 0.03); border-radius: 12px;
            padding: 20px; border: 1px solid rgba(255, 204, 102, 0.2); margin-bottom: 20px;
        }

        .panel h3 { color: #ffcc66; margin-bottom: 15px; }

        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }

        .control-group { display: flex; flex-direction: column; gap: 5px; }
        .control-group label { color: #aaa; font-size: 0.85rem; }
        .control-group input[type="range"] { width: 100%; cursor: pointer; }
        .control-group span { color: #ffcc66; }

        select {
            padding: 8px; background: rgba(255, 204, 102, 0.1);
            border: 1px solid rgba(255, 204, 102, 0.3);
            border-radius: 6px; color: #e0e0e0; font-family: inherit;
        }

        .buttons { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }

        button {
            padding: 10px 20px; background: linear-gradient(135deg, #ffcc66, #cc9933);
            border: none; border-radius: 6px; color: #1a1a1a; cursor: pointer;
            font-family: inherit; font-weight: 600; transition: all 0.3s ease;
        }

        button:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(255, 204, 102, 0.4); }

        .equation {
            font-family: 'Times New Roman', serif; font-style: italic;
            color: #ffdd88; text-align: center; padding: 15px;
            background: rgba(0, 0, 0, 0.3); border-radius: 6px; margin: 10px 0;
        }

        .info-panel { background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 15px; }
        .info-panel h4 { color: #ffcc66; margin-bottom: 10px; }
        .info-panel p { font-size: 0.9rem; line-height: 1.6; color: #aaa; margin-bottom: 10px; }

        @media (max-width: 800px) { .main-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <a href="index.html" class="organic-back-link">← Back to Gallery</a>

    <div class="container">
        <h1>Reinhard Tone Mapping Lab</h1>
        <p class="subtitle">HDR to LDR conversion with exposure and tone control</p>

        <div class="main-grid">
            <div class="canvas-panel">
                <h4>HDR Input (Simulated)</h4>
                <canvas id="hdrCanvas" width="350" height="280"></canvas>
            </div>
            <div class="canvas-panel">
                <h4>Tone Mapped Output</h4>
                <canvas id="ldrCanvas" width="350" height="280"></canvas>
            </div>
        </div>

        <div class="canvas-panel curve-panel">
            <h4>Tone Curve Comparison</h4>
            <canvas id="curveCanvas" width="400" height="200"></canvas>
        </div>

        <div class="panel">
            <h3>Tone Mapping Parameters</h3>
            <div class="controls">
                <div class="control-group">
                    <label>Exposure: <span id="exposureVal">1.0</span></label>
                    <input type="range" id="exposure" min="0.1" max="4" step="0.1" value="1">
                </div>

                <div class="control-group">
                    <label>White Point (L<sub>white</sub>): <span id="whiteVal">4.0</span></label>
                    <input type="range" id="whitePoint" min="1" max="10" step="0.5" value="4">
                </div>

                <div class="control-group">
                    <label>Key Value (a): <span id="keyVal">0.18</span></label>
                    <input type="range" id="keyValue" min="0.05" max="0.5" step="0.01" value="0.18">
                </div>

                <div class="control-group">
                    <label>Gamma: <span id="gammaVal">2.2</span></label>
                    <input type="range" id="gamma" min="1" max="3" step="0.1" value="2.2">
                </div>

                <div class="control-group">
                    <label>Tone Map Operator</label>
                    <select id="operator">
                        <option value="reinhard">Reinhard Simple</option>
                        <option value="reinhardExtended" selected>Reinhard Extended</option>
                        <option value="reinhardLocal">Reinhard Local</option>
                        <option value="filmic">Filmic (Uncharted 2)</option>
                        <option value="aces">ACES Filmic</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>HDR Scene</label>
                    <select id="hdrScene">
                        <option value="sunset">Sunset Sky</option>
                        <option value="interior">Interior + Window</option>
                        <option value="neon">Neon Night</option>
                        <option value="studio">Studio Lighting</option>
                    </select>
                </div>
            </div>

            <div class="equation">
                L<sub>d</sub> = L × (1 + L/L<sub>white</sub>²) / (1 + L)
            </div>

            <div class="buttons">
                <button onclick="applyToneMapping()">Apply Tone Mapping</button>
                <button onclick="generateHDR()">New HDR Scene</button>
                <button onclick="compareAll()">Compare All Operators</button>
            </div>
        </div>

        <div class="info-panel">
            <h4>About Tone Mapping</h4>
            <p>
                Tone mapping compresses the dynamic range of HDR (High Dynamic Range) images
                to displayable LDR (Low Dynamic Range) values while preserving visual detail.
                The Reinhard operator (2002) is based on photographic techniques.
            </p>
            <p>
                <strong>Simple Reinhard:</strong> L/(1+L) - gentle compression, may lack contrast<br>
                <strong>Extended Reinhard:</strong> Adds white point parameter for brighter highlights<br>
                <strong>Filmic (Uncharted 2):</strong> S-curve with toe and shoulder regions<br>
                <strong>ACES:</strong> Industry standard for cinematic look
            </p>
            <p>
                The key value (a) represents the target middle-gray luminance, typically 0.18
                (18% gray card). Exposure adjusts the overall brightness before tone mapping.
            </p>
        </div>
    </div>

    <script>
        const hdrCanvas = document.getElementById('hdrCanvas');
        const ldrCanvas = document.getElementById('ldrCanvas');
        const curveCanvas = document.getElementById('curveCanvas');

        const hdrCtx = hdrCanvas.getContext('2d');
        const ldrCtx = ldrCanvas.getContext('2d');
        const curveCtx = curveCanvas.getContext('2d');

        let exposure = 1.0;
        let whitePoint = 4.0;
        let keyValue = 0.18;
        let gamma = 2.2;
        let operator = 'reinhardExtended';
        let hdrScene = 'sunset';

        let hdrData = null;

        // Tone mapping operators
        const operators = {
            reinhard: (L) => L / (1 + L),

            reinhardExtended: (L) => {
                const Lw2 = whitePoint * whitePoint;
                return L * (1 + L / Lw2) / (1 + L);
            },

            reinhardLocal: (L) => {
                // Simplified local adaptation
                const scale = 1 + 0.5 * L;
                return L / scale;
            },

            filmic: (L) => {
                // Uncharted 2 tone map
                const A = 0.15, B = 0.50, C = 0.10, D = 0.20, E = 0.02, F = 0.30;
                const map = x => ((x * (A * x + C * B) + D * E) / (x * (A * x + B) + D * F)) - E / F;
                const W = 11.2;
                return map(L) / map(W);
            },

            aces: (L) => {
                const a = 2.51, b = 0.03, c = 2.43, d = 0.59, e = 0.14;
                return (L * (a * L + b)) / (L * (c * L + d) + e);
            }
        };

        function generateHDR() {
            const width = hdrCanvas.width;
            const height = hdrCanvas.height;

            hdrData = {
                r: new Float32Array(width * height),
                g: new Float32Array(width * height),
                b: new Float32Array(width * height)
            };

            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const idx = y * width + x;
                    let r, g, b;

                    switch (hdrScene) {
                        case 'sunset':
                            // Sky gradient with bright sun
                            const skyT = y / height;
                            r = 0.3 + skyT * 0.5;
                            g = 0.2 + skyT * 0.3;
                            b = 0.5 + skyT * 0.4;

                            // Sun
                            const sunDist = Math.sqrt((x - width * 0.7) ** 2 + (y - height * 0.3) ** 2);
                            if (sunDist < 40) {
                                const sunIntensity = 20 * Math.exp(-sunDist / 15);
                                r += sunIntensity;
                                g += sunIntensity * 0.9;
                                b += sunIntensity * 0.3;
                            }

                            // Horizon glow
                            if (y > height * 0.6) {
                                const horizonT = (y - height * 0.6) / (height * 0.4);
                                r += 2 * Math.exp(-horizonT * 3);
                                g += 0.8 * Math.exp(-horizonT * 3);
                            }
                            break;

                        case 'interior':
                            // Dark room with bright window
                            r = g = b = 0.05;

                            // Window
                            if (x > width * 0.3 && x < width * 0.7 && y > height * 0.1 && y < height * 0.6) {
                                r = 8 + Math.random();
                                g = 10 + Math.random();
                                b = 12 + Math.random();
                            }

                            // Floor reflection
                            if (y > height * 0.7) {
                                const reflT = (y - height * 0.7) / (height * 0.3);
                                if (x > width * 0.35 && x < width * 0.65) {
                                    r = 0.3 * (1 - reflT);
                                    g = 0.4 * (1 - reflT);
                                    b = 0.5 * (1 - reflT);
                                }
                            }
                            break;

                        case 'neon':
                            r = g = b = 0.02;

                            // Neon signs
                            const signs = [
                                { x: 80, y: 60, color: [15, 0.2, 0.5], size: 30 },
                                { x: 200, y: 100, color: [0.3, 0.3, 12], size: 25 },
                                { x: 280, y: 80, color: [0.5, 10, 0.5], size: 20 },
                                { x: 150, y: 200, color: [12, 8, 0.3], size: 35 }
                            ];

                            for (const sign of signs) {
                                const d = Math.sqrt((x - sign.x) ** 2 + (y - sign.y) ** 2);
                                if (d < sign.size) {
                                    const intensity = Math.exp(-d / (sign.size * 0.3));
                                    r += sign.color[0] * intensity;
                                    g += sign.color[1] * intensity;
                                    b += sign.color[2] * intensity;
                                }
                                // Glow
                                const glow = Math.exp(-d / (sign.size * 2));
                                r += sign.color[0] * 0.1 * glow;
                                g += sign.color[1] * 0.1 * glow;
                                b += sign.color[2] * 0.1 * glow;
                            }
                            break;

                        case 'studio':
                            // Gray backdrop
                            r = g = b = 0.3;

                            // Subject (sphere)
                            const cx = width / 2, cy = height / 2;
                            const sphereDist = Math.sqrt((x - cx) ** 2 + (y - cy) ** 2);
                            if (sphereDist < 80) {
                                const nx = (x - cx) / 80;
                                const ny = (y - cy) / 80;
                                const nz = Math.sqrt(Math.max(0, 1 - nx * nx - ny * ny));

                                // Key light
                                const lightDir = [0.5, -0.5, 0.7];
                                const diffuse = Math.max(0, nx * lightDir[0] + ny * lightDir[1] + nz * lightDir[2]);

                                r = 0.8 * diffuse + 0.1;
                                g = 0.7 * diffuse + 0.1;
                                b = 0.6 * diffuse + 0.1;

                                // Specular
                                const specular = Math.pow(Math.max(0, nz), 50);
                                r += 5 * specular;
                                g += 5 * specular;
                                b += 5 * specular;
                            }
                            break;
                    }

                    hdrData.r[idx] = r;
                    hdrData.g[idx] = g;
                    hdrData.b[idx] = b;
                }
            }

            displayHDR();
            applyToneMapping();
        }

        function displayHDR() {
            const width = hdrCanvas.width;
            const height = hdrCanvas.height;
            const imageData = hdrCtx.createImageData(width, height);

            // Simple clamp for display
            for (let i = 0; i < width * height; i++) {
                imageData.data[i * 4] = Math.min(255, hdrData.r[i] * 50);
                imageData.data[i * 4 + 1] = Math.min(255, hdrData.g[i] * 50);
                imageData.data[i * 4 + 2] = Math.min(255, hdrData.b[i] * 50);
                imageData.data[i * 4 + 3] = 255;
            }

            hdrCtx.putImageData(imageData, 0, 0);
        }

        function applyToneMapping() {
            if (!hdrData) return;

            const width = ldrCanvas.width;
            const height = ldrCanvas.height;
            const imageData = ldrCtx.createImageData(width, height);

            const toneMap = operators[operator];

            for (let i = 0; i < width * height; i++) {
                // Apply exposure
                let r = hdrData.r[i] * exposure;
                let g = hdrData.g[i] * exposure;
                let b = hdrData.b[i] * exposure;

                // Compute luminance
                const L = 0.2126 * r + 0.7152 * g + 0.0722 * b;

                // Scale by key value
                const Lscaled = (keyValue / 0.18) * L;

                // Apply tone mapping
                const Ld = L > 0 ? toneMap(Lscaled) : 0;
                const scale = L > 0 ? Ld / L : 0;

                r = r * scale;
                g = g * scale;
                b = b * scale;

                // Gamma correction
                r = Math.pow(Math.max(0, r), 1 / gamma);
                g = Math.pow(Math.max(0, g), 1 / gamma);
                b = Math.pow(Math.max(0, b), 1 / gamma);

                imageData.data[i * 4] = Math.min(255, r * 255);
                imageData.data[i * 4 + 1] = Math.min(255, g * 255);
                imageData.data[i * 4 + 2] = Math.min(255, b * 255);
                imageData.data[i * 4 + 3] = 255;
            }

            ldrCtx.putImageData(imageData, 0, 0);
            drawToneCurves();
        }

        function drawToneCurves() {
            const width = curveCanvas.width;
            const height = curveCanvas.height;

            curveCtx.fillStyle = '#1a1a1a';
            curveCtx.fillRect(0, 0, width, height);

            // Grid
            curveCtx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            curveCtx.lineWidth = 1;
            for (let i = 0; i <= 10; i++) {
                const x = (i / 10) * width;
                const y = (i / 10) * height;
                curveCtx.beginPath();
                curveCtx.moveTo(x, 0);
                curveCtx.lineTo(x, height);
                curveCtx.moveTo(0, y);
                curveCtx.lineTo(width, y);
                curveCtx.stroke();
            }

            // Linear reference
            curveCtx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            curveCtx.beginPath();
            curveCtx.moveTo(0, height);
            curveCtx.lineTo(width, 0);
            curveCtx.stroke();

            // Draw curves for each operator
            const colors = {
                reinhard: '#ff6666',
                reinhardExtended: '#ffcc66',
                filmic: '#66ff66',
                aces: '#6666ff'
            };

            const maxInput = 5;

            for (const [name, func] of Object.entries(operators)) {
                if (name === 'reinhardLocal') continue;

                curveCtx.strokeStyle = name === operator ? colors[name] : colors[name] + '66';
                curveCtx.lineWidth = name === operator ? 3 : 1;
                curveCtx.beginPath();

                for (let i = 0; i <= 100; i++) {
                    const input = (i / 100) * maxInput;
                    const output = func(input);

                    const x = (i / 100) * width;
                    const y = height - output * height;

                    if (i === 0) curveCtx.moveTo(x, y);
                    else curveCtx.lineTo(x, y);
                }

                curveCtx.stroke();
            }

            // Labels
            curveCtx.fillStyle = '#888';
            curveCtx.font = '11px Nunito';
            curveCtx.fillText('Input Luminance →', width - 100, height - 5);
            curveCtx.fillText('Output', 5, 15);
        }

        function compareAll() {
            let current = 0;
            const ops = ['reinhard', 'reinhardExtended', 'filmic', 'aces'];

            const interval = setInterval(() => {
                operator = ops[current];
                document.getElementById('operator').value = operator;
                applyToneMapping();
                current++;
                if (current >= ops.length) clearInterval(interval);
            }, 1000);
        }

        // Event listeners
        document.getElementById('exposure').addEventListener('input', function() {
            exposure = parseFloat(this.value);
            document.getElementById('exposureVal').textContent = exposure.toFixed(1);
            applyToneMapping();
        });

        document.getElementById('whitePoint').addEventListener('input', function() {
            whitePoint = parseFloat(this.value);
            document.getElementById('whiteVal').textContent = whitePoint.toFixed(1);
            applyToneMapping();
        });

        document.getElementById('keyValue').addEventListener('input', function() {
            keyValue = parseFloat(this.value);
            document.getElementById('keyVal').textContent = keyValue.toFixed(2);
            applyToneMapping();
        });

        document.getElementById('gamma').addEventListener('input', function() {
            gamma = parseFloat(this.value);
            document.getElementById('gammaVal').textContent = gamma.toFixed(1);
            applyToneMapping();
        });

        document.getElementById('operator').addEventListener('change', function() {
            operator = this.value;
            applyToneMapping();
        });

        document.getElementById('hdrScene').addEventListener('change', function() {
            hdrScene = this.value;
            generateHDR();
        });

        // Initialize
        generateHDR();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
