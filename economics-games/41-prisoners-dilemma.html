<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prisoner's Dilemma Tournament</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #f0f2f5; font-family: sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .controls { margin-bottom: 20px; display: flex; gap: 10px; }
        button { padding: 10px 20px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; }
        button:hover { background: #1d4ed8; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background: #f8fafc; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Iterated Prisoner's Dilemma</h1>
        <div class="controls">
            <button onclick="runRound()">Run Round</button>
            <button onclick="reset()">Reset</button>
        </div>
        <canvas id="scoreChart"></canvas>
        <table id="leaderboard">
            <thead><tr><th>Strategy</th><th>Score</th><th>Last Move</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        // Strategies
        const strategies = [
            { name: 'Cooperator', score: 0, move: (history) => 'C' },
            { name: 'Defector', score: 0, move: (history) => 'D' },
            { name: 'TitForTat', score: 0, move: (history) => {
                if(history.length === 0) return 'C';
                return history[history.length-1].opponent; // Copy opponent's last move
            }},
            { name: 'Random', score: 0, move: (history) => Math.random() > 0.5 ? 'C' : 'D' },
            { name: 'Grudger', score: 0, move: (history) => {
                if(history.some(h => h.opponent === 'D')) return 'D';
                return 'C';
            }}
        ];

        let history = {}; // Map of "StrategyA-StrategyB": [{me: 'C', opponent: 'D'}]
        let chart;

        function init() {
            strategies.forEach(s => {
                strategies.forEach(opp => {
                    if(s !== opp) history[`${s.name}-${opp.name}`] = [];
                });
            });
            initChart();
            updateTable();
        }

        function runRound() {
            // Round Robin
            for(let i=0; i<strategies.length; i++) {
                for(let j=i+1; j<strategies.length; j++) {
                    const p1 = strategies[i];
                    const p2 = strategies[j];
                    
                    const h1 = history[`${p1.name}-${p2.name}`];
                    const h2 = history[`${p2.name}-${p1.name}`]; // Mirrored history

                    const m1 = p1.move(h1);
                    const m2 = p2.move(h2);

                    // Payoff Matrix
                    // T=5, R=3, P=1, S=0
                    let s1 = 0, s2 = 0;
                    if(m1 === 'C' && m2 === 'C') { s1=3; s2=3; }
                    if(m1 === 'C' && m2 === 'D') { s1=0; s2=5; }
                    if(m1 === 'D' && m2 === 'C') { s1=5; s2=0; }
                    if(m1 === 'D' && m2 === 'D') { s1=1; s2=1; }

                    p1.score += s1;
                    p2.score += s2;

                    h1.push({me: m1, opponent: m2});
                    h2.push({me: m2, opponent: m1});
                }
            }
            updateTable();
            updateChart();
        }

        function updateTable() {
            const tbody = document.querySelector('#leaderboard tbody');
            tbody.innerHTML = strategies.sort((a,b) => b.score - a.score).map(s => `
                <tr>
                    <td>${s.name}</td>
                    <td>${s.score}</td>
                    <td>-</td>
                </tr>
            `).join('');
        }

        function initChart() {
            const ctx = document.getElementById('scoreChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: strategies.map(s => s.name),
                    datasets: [{ label: 'Score', data: strategies.map(s => s.score), backgroundColor: '#3b82f6' }]
                },
                options: { animation: false }
            });
        }

        function updateChart() {
            chart.data.labels = strategies.map(s => s.name);
            chart.data.datasets[0].data = strategies.map(s => s.score);
            chart.update();
        }

        function reset() {
            strategies.forEach(s => s.score = 0);
            init();
        }

        init();
    </script>
</body>
</html>
