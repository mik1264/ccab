<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tragedy of the Commons | Game Theory</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 10px; color: #4fc3f7; }
        .subtitle { text-align: center; color: #888; margin-bottom: 20px; }

        .controls {
            display: flex; gap: 15px; flex-wrap: wrap;
            justify-content: center; margin-bottom: 20px; align-items: center;
        }
        button {
            padding: 10px 20px; border: none; border-radius: 8px;
            background: #4fc3f7; color: #1a1a2e; font-weight: bold;
            cursor: pointer; transition: all 0.3s;
        }
        button:hover { background: #81d4fa; }
        label { display: flex; align-items: center; gap: 8px; }
        input[type="range"] { width: 80px; }
        select { padding: 8px; border-radius: 6px; background: #1a1a2e; color: #e0e0e0; border: 1px solid #4fc3f7; }

        .main-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }

        .panel {
            background: rgba(255,255,255,0.05);
            border-radius: 15px; padding: 20px;
            border: 1px solid rgba(79, 195, 247, 0.2);
        }
        .panel h2 { color: #4fc3f7; margin-bottom: 15px; }

        #commonsCanvas {
            width: 100%; border-radius: 10px;
            background: linear-gradient(135deg, #1b4332, #2d6a4f);
        }

        .resource-bar {
            height: 30px; margin: 15px 0;
            background: rgba(0,0,0,0.3); border-radius: 15px;
            overflow: hidden; position: relative;
        }
        .resource-fill {
            height: 100%; transition: width 0.3s;
            background: linear-gradient(90deg, #40916c, #74c69d);
        }
        .resource-text {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold; color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        .farmers-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px; margin: 15px 0;
        }
        .farmer {
            padding: 10px; border-radius: 10px;
            background: rgba(0,0,0,0.2); text-align: center;
        }
        .farmer-icon { font-size: 2em; }
        .farmer-cattle { font-size: 0.9em; color: #ffd700; }
        .farmer-profit { font-size: 0.8em; color: #4caf50; }

        .stat-row {
            display: flex; justify-content: space-between;
            padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        canvas { width: 100%; border-radius: 10px; background: rgba(0,0,0,0.2); }

        .policy-buttons {
            display: flex; gap: 10px; flex-wrap: wrap;
            margin: 15px 0;
        }
        .policy-btn {
            padding: 8px 15px; font-size: 0.85em;
            background: rgba(79, 195, 247, 0.2);
            border: 1px solid rgba(79, 195, 247, 0.4);
        }
        .policy-btn.active {
            background: rgba(79, 195, 247, 0.4);
            border-color: #4fc3f7;
        }

        .explanation {
            background: rgba(79, 195, 247, 0.1);
            border-radius: 10px; padding: 15px;
            font-size: 0.85em; line-height: 1.6;
            margin-top: 15px;
        }

        a.back-link {
            display: inline-block; margin-bottom: 20px;
            color: #4fc3f7; text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">‚Üê Back to Game Theory</a>
        <h1>Tragedy of the Commons</h1>
        <p class="subtitle">Watch shared resources deplete through individual rational choices</p>

        <div class="controls">
            <button id="startBtn">Start</button>
            <button id="stepBtn">Step</button>
            <button id="resetBtn">Reset</button>
            <label>
                Farmers:
                <select id="numFarmers">
                    <option value="4">4</option>
                    <option value="6" selected>6</option>
                    <option value="8">8</option>
                    <option value="10">10</option>
                </select>
            </label>
            <label>
                Speed:
                <input type="range" id="speed" min="1" max="20" value="5">
            </label>
        </div>

        <div class="main-grid">
            <div class="panel">
                <h2>The Commons (Shared Pasture)</h2>
                <canvas id="commonsCanvas" height="300"></canvas>

                <div class="resource-bar">
                    <div class="resource-fill" id="resourceFill" style="width:100%;"></div>
                    <div class="resource-text" id="resourceText">100%</div>
                </div>

                <h2>Farmers</h2>
                <div class="farmers-grid" id="farmersGrid"></div>

                <h2>Policy Interventions</h2>
                <div class="policy-buttons">
                    <button class="policy-btn active" data-policy="none">No Regulation</button>
                    <button class="policy-btn" data-policy="quota">Quota (Max 3)</button>
                    <button class="policy-btn" data-policy="tax">Grazing Tax</button>
                    <button class="policy-btn" data-policy="privatize">Privatize</button>
                    <button class="policy-btn" data-policy="communicate">Communication</button>
                </div>
            </div>

            <div class="panel">
                <h2>Statistics</h2>
                <div class="stat-row">
                    <span>Year</span>
                    <span id="year">0</span>
                </div>
                <div class="stat-row">
                    <span>Total Cattle</span>
                    <span id="totalCattle">0</span>
                </div>
                <div class="stat-row">
                    <span>Pasture Health</span>
                    <span id="pastureHealth">100%</span>
                </div>
                <div class="stat-row">
                    <span>Sustainable Limit</span>
                    <span id="sustainableLimit">-</span>
                </div>
                <div class="stat-row">
                    <span>Total Profit (Year)</span>
                    <span id="yearProfit">$0</span>
                </div>

                <h2 style="margin-top:20px;">History</h2>
                <canvas id="historyChart" height="200"></canvas>

                <div class="explanation">
                    <strong>The Dilemma:</strong><br>
                    Each farmer benefits by adding more cattle (individual gain).
                    But overgrazing depletes the shared pasture (collective loss).
                    <br><br>
                    <strong>Garrett Hardin (1968):</strong> "Freedom in a commons brings ruin to all."
                    <br><br>
                    <strong>Solutions:</strong> Quotas, taxes, privatization, or communication can prevent tragedy.
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('commonsCanvas');
        const ctx = canvas.getContext('2d');
        const chartCanvas = document.getElementById('historyChart');
        const chartCtx = chartCanvas.getContext('2d');

        let farmers = [];
        let pasture = 100; // 0-100 health
        let year = 0;
        let running = false;
        let policy = 'none';
        let history = { pasture: [], cattle: [], profit: [] };

        const REGEN_RATE = 0.05; // Pasture regeneration per year
        const CARRYING_CAPACITY = 100; // Max sustainable cattle

        class Farmer {
            constructor(id) {
                this.id = id;
                this.cattle = 2;
                this.profit = 0;
                this.totalProfit = 0;
                this.x = Math.random() * 0.8 + 0.1;
                this.y = Math.random() * 0.8 + 0.1;
            }

            decide() {
                if (policy === 'quota') {
                    // Hard limit
                    if (this.cattle < 3 && pasture > 20) {
                        this.cattle++;
                    }
                } else if (policy === 'privatize') {
                    // Each farmer has their own plot - sustainable
                    const myCapacity = CARRYING_CAPACITY / farmers.length;
                    if (this.cattle < myCapacity * 0.8) {
                        this.cattle++;
                    } else if (this.cattle > myCapacity) {
                        this.cattle--;
                    }
                } else if (policy === 'communicate') {
                    // Cooperative - aim for fair share
                    const fairShare = (CARRYING_CAPACITY * 0.8) / farmers.length;
                    if (this.cattle < fairShare && pasture > 30) {
                        this.cattle++;
                    } else if (this.cattle > fairShare + 1) {
                        this.cattle--;
                    }
                } else {
                    // Individual rational: add cattle if profitable
                    // Adding cattle is profitable if pasture health is decent
                    if (pasture > 10 && Math.random() < 0.3 + (pasture / 200)) {
                        this.cattle++;
                    }
                }

                // Remove cattle if starving
                if (pasture < 5 && this.cattle > 1) {
                    this.cattle = Math.max(1, this.cattle - 2);
                }
            }
        }

        function init() {
            const n = parseInt(document.getElementById('numFarmers').value);
            farmers = [];
            for (let i = 0; i < n; i++) {
                farmers.push(new Farmer(i));
            }
            pasture = 100;
            year = 0;
            history = { pasture: [], cattle: [], profit: [] };
            updateDisplay();
            draw();
        }

        function step() {
            year++;

            // Farmers make decisions
            for (const farmer of farmers) {
                farmer.decide();
            }

            // Calculate total cattle
            const totalCattle = farmers.reduce((s, f) => s + f.cattle, 0);

            // Pasture dynamics
            const grazing = totalCattle / CARRYING_CAPACITY;
            const regen = REGEN_RATE * pasture * (1 - pasture / 100);
            const depletion = grazing > 1 ? (grazing - 1) * 20 : grazing * 5;

            pasture = Math.max(0, Math.min(100, pasture + regen - depletion));

            // Calculate profits
            const productivity = pasture / 100; // How much each cow produces
            let totalProfit = 0;

            for (const farmer of farmers) {
                const revenue = farmer.cattle * 10 * productivity;
                let cost = farmer.cattle * 2; // Base cost

                if (policy === 'tax') {
                    cost += farmer.cattle * 3; // Grazing tax
                }

                farmer.profit = Math.max(0, revenue - cost);
                farmer.totalProfit += farmer.profit;
                totalProfit += farmer.profit;
            }

            // Record history
            history.pasture.push(pasture);
            history.cattle.push(totalCattle);
            history.profit.push(totalProfit);
            if (history.pasture.length > 100) {
                history.pasture.shift();
                history.cattle.shift();
                history.profit.shift();
            }

            updateDisplay();
            draw();
        }

        function updateDisplay() {
            const totalCattle = farmers.reduce((s, f) => s + f.cattle, 0);
            const totalProfit = farmers.reduce((s, f) => s + f.profit, 0);

            document.getElementById('year').textContent = year;
            document.getElementById('totalCattle').textContent = totalCattle;
            document.getElementById('pastureHealth').textContent = pasture.toFixed(0) + '%';
            document.getElementById('sustainableLimit').textContent =
                Math.floor(CARRYING_CAPACITY * 0.8) + ' cattle';
            document.getElementById('yearProfit').textContent = '$' + totalProfit.toFixed(0);

            document.getElementById('resourceFill').style.width = pasture + '%';
            document.getElementById('resourceFill').style.background =
                pasture > 50 ? 'linear-gradient(90deg, #40916c, #74c69d)' :
                pasture > 25 ? 'linear-gradient(90deg, #e9c46a, #f4a261)' :
                'linear-gradient(90deg, #e76f51, #d62828)';
            document.getElementById('resourceText').textContent = pasture.toFixed(0) + '%';

            // Farmers grid
            const grid = document.getElementById('farmersGrid');
            grid.innerHTML = '';
            for (const farmer of farmers) {
                const div = document.createElement('div');
                div.className = 'farmer';
                div.innerHTML = `
                    <div class="farmer-icon">üë®‚Äçüåæ</div>
                    <div class="farmer-cattle">üêÑ ${farmer.cattle}</div>
                    <div class="farmer-profit">$${farmer.profit.toFixed(0)}</div>
                `;
                grid.appendChild(div);
            }

            drawChart();
        }

        function draw() {
            const dpr = window.devicePixelRatio || 1;
            canvas.width = canvas.offsetWidth * dpr;
            canvas.height = 300 * dpr;
            ctx.scale(dpr, dpr);

            const w = canvas.offsetWidth;
            const h = 300;

            // Background - grass color based on health
            const grassGreen = Math.floor(100 + (pasture / 100) * 100);
            ctx.fillStyle = `rgb(30, ${grassGreen}, 50)`;
            ctx.fillRect(0, 0, w, h);

            // Draw grass patches
            const grassDensity = Math.floor((pasture / 100) * 200);
            ctx.fillStyle = `rgba(100, ${150 + Math.floor(pasture)}, 100, 0.5)`;
            for (let i = 0; i < grassDensity; i++) {
                const x = Math.random() * w;
                const y = Math.random() * h;
                ctx.beginPath();
                ctx.arc(x, y, 3 + Math.random() * 5, 0, Math.PI * 2);
                ctx.fill();
            }

            // Draw cattle
            for (const farmer of farmers) {
                for (let i = 0; i < farmer.cattle; i++) {
                    const angle = (i / farmer.cattle) * Math.PI * 2 + farmer.id;
                    const radius = 20 + (i % 3) * 15;
                    const cx = farmer.x * w + Math.cos(angle) * radius;
                    const cy = farmer.y * h + Math.sin(angle) * radius;

                    // Cow emoji
                    ctx.font = '16px sans-serif';
                    ctx.fillText('üêÑ', cx, cy);
                }
            }

            // Draw farmers
            ctx.font = '24px sans-serif';
            for (const farmer of farmers) {
                ctx.fillText('üë®‚Äçüåæ', farmer.x * w - 12, farmer.y * h);
            }

            // Warning if overgrazed
            if (pasture < 25) {
                ctx.fillStyle = 'rgba(255, 0, 0, 0.3)';
                ctx.fillRect(0, 0, w, h);
                ctx.fillStyle = '#ff0000';
                ctx.font = 'bold 24px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('‚ö†Ô∏è OVERGRAZING', w/2, h/2);
                ctx.textAlign = 'left';
            }
        }

        function drawChart() {
            const dpr = window.devicePixelRatio || 1;
            chartCanvas.width = chartCanvas.offsetWidth * dpr;
            chartCanvas.height = 200 * dpr;
            chartCtx.scale(dpr, dpr);

            const w = chartCanvas.offsetWidth;
            const h = 200;

            chartCtx.fillStyle = 'rgba(0,0,0,0.2)';
            chartCtx.fillRect(0, 0, w, h);

            if (history.pasture.length < 2) return;

            const n = history.pasture.length;
            const maxCattle = Math.max(...history.cattle, CARRYING_CAPACITY);

            // Pasture health line
            chartCtx.strokeStyle = '#74c69d';
            chartCtx.lineWidth = 2;
            chartCtx.beginPath();
            for (let i = 0; i < n; i++) {
                const x = (i / (n - 1)) * w;
                const y = h - (history.pasture[i] / 100) * (h - 20) - 10;
                if (i === 0) chartCtx.moveTo(x, y);
                else chartCtx.lineTo(x, y);
            }
            chartCtx.stroke();

            // Cattle count line
            chartCtx.strokeStyle = '#ffd700';
            chartCtx.beginPath();
            for (let i = 0; i < n; i++) {
                const x = (i / (n - 1)) * w;
                const y = h - (history.cattle[i] / maxCattle) * (h - 20) - 10;
                if (i === 0) chartCtx.moveTo(x, y);
                else chartCtx.lineTo(x, y);
            }
            chartCtx.stroke();

            // Sustainable limit line
            chartCtx.strokeStyle = 'rgba(255,255,255,0.3)';
            chartCtx.setLineDash([5, 5]);
            chartCtx.beginPath();
            const limitY = h - (CARRYING_CAPACITY * 0.8 / maxCattle) * (h - 20) - 10;
            chartCtx.moveTo(0, limitY);
            chartCtx.lineTo(w, limitY);
            chartCtx.stroke();
            chartCtx.setLineDash([]);

            // Labels
            chartCtx.fillStyle = '#74c69d';
            chartCtx.font = '10px sans-serif';
            chartCtx.fillText('Pasture', 5, 12);
            chartCtx.fillStyle = '#ffd700';
            chartCtx.fillText('Cattle', 55, 12);
        }

        let animationId = null;
        function animate() {
            if (!running) return;
            step();
            const speed = parseInt(document.getElementById('speed').value);
            animationId = setTimeout(animate, 1000 / speed);
        }

        // Event listeners
        document.getElementById('startBtn').onclick = () => {
            running = !running;
            document.getElementById('startBtn').textContent = running ? 'Pause' : 'Start';
            if (running) animate();
        };

        document.getElementById('stepBtn').onclick = () => {
            if (!running) step();
        };

        document.getElementById('resetBtn').onclick = init;
        document.getElementById('numFarmers').onchange = init;

        document.querySelectorAll('.policy-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.policy-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                policy = btn.dataset.policy;
            };
        });

        // Initialize
        init();
    </script>
</body>
</html>
