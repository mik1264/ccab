<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimatum Game | Game Theory</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1100px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 10px; color: #4fc3f7; }
        .subtitle { text-align: center; color: #888; margin-bottom: 20px; }

        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 800px) { .main-grid { grid-template-columns: 1fr; } }

        .panel {
            background: rgba(255,255,255,0.05);
            border-radius: 15px; padding: 20px;
            border: 1px solid rgba(79, 195, 247, 0.2);
        }
        .panel h2 { color: #4fc3f7; margin-bottom: 15px; }

        .game-area {
            text-align: center; padding: 20px;
            background: rgba(0,0,0,0.2); border-radius: 15px;
        }

        .pot {
            width: 120px; height: 120px; margin: 0 auto 20px;
            border-radius: 50%; background: linear-gradient(135deg, #ffd700, #ffaa00);
            display: flex; align-items: center; justify-content: center;
            font-size: 2.5em; font-weight: bold; color: #1a1a2e;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.3);
        }

        .offer-slider-container { margin: 20px 0; }
        .offer-display {
            display: flex; justify-content: space-between;
            margin: 15px 0; font-size: 1.2em;
        }
        .offer-proposer { color: #4fc3f7; }
        .offer-responder { color: #ff9800; }

        input[type="range"] {
            width: 100%; height: 20px;
            -webkit-appearance: none;
            background: linear-gradient(90deg, #4fc3f7, #ff9800);
            border-radius: 10px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 30px; height: 30px;
            background: #fff; border-radius: 50%;
            cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .buttons { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        button {
            padding: 12px 25px; border: none; border-radius: 8px;
            font-weight: bold; cursor: pointer; transition: all 0.3s;
        }
        .btn-accept { background: #4caf50; color: white; }
        .btn-reject { background: #f44336; color: white; }
        .btn-primary { background: #4fc3f7; color: #1a1a2e; }
        button:hover { transform: translateY(-2px); opacity: 0.9; }

        .result-display {
            margin-top: 20px; padding: 15px;
            border-radius: 10px; font-size: 1.1em;
        }
        .result-accept { background: rgba(76, 175, 80, 0.2); border: 1px solid #4caf50; }
        .result-reject { background: rgba(244, 67, 54, 0.2); border: 1px solid #f44336; }

        .stats-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
            margin-bottom: 20px;
        }
        .stat-box {
            background: rgba(0,0,0,0.2); padding: 15px;
            border-radius: 10px; text-align: center;
        }
        .stat-value { font-size: 2em; font-weight: bold; color: #4fc3f7; }
        .stat-label { font-size: 0.85em; color: #888; }

        canvas { width: 100%; border-radius: 10px; background: rgba(0,0,0,0.2); }

        .mode-tabs {
            display: flex; gap: 5px; margin-bottom: 20px;
        }
        .mode-tab {
            flex: 1; padding: 10px; text-align: center;
            background: rgba(79, 195, 247, 0.1);
            border: 1px solid rgba(79, 195, 247, 0.3);
            border-radius: 8px; cursor: pointer;
            transition: all 0.2s;
        }
        .mode-tab.active {
            background: rgba(79, 195, 247, 0.3);
            border-color: #4fc3f7;
        }

        .threshold-display {
            display: flex; align-items: center; gap: 10px;
            margin: 15px 0; justify-content: center;
        }

        a.back-link {
            display: inline-block; margin-bottom: 20px;
            color: #4fc3f7; text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">← Back to Game Theory</a>
        <h1>Ultimatum Game</h1>
        <p class="subtitle">Test fairness norms: Will unfair offers be rejected?</p>

        <div class="main-grid">
            <div class="panel">
                <div class="mode-tabs">
                    <div class="mode-tab active" data-mode="play">Play</div>
                    <div class="mode-tab" data-mode="simulate">Simulate</div>
                    <div class="mode-tab" data-mode="evolve">Evolve</div>
                </div>

                <div id="playMode" class="game-area">
                    <div class="pot" id="potAmount">$100</div>

                    <div id="proposerView">
                        <h3>You are the Proposer</h3>
                        <p style="color:#888; margin:10px 0;">How much will you offer to the Responder?</p>

                        <div class="offer-slider-container">
                            <input type="range" id="offerSlider" min="0" max="100" value="50">
                        </div>

                        <div class="offer-display">
                            <span class="offer-proposer">You keep: $<span id="keepAmount">50</span></span>
                            <span class="offer-responder">Offer: $<span id="offerAmount">50</span></span>
                        </div>

                        <button class="btn-primary" id="makeOffer">Make Offer</button>
                    </div>

                    <div id="responderView" style="display:none;">
                        <h3>You are the Responder</h3>
                        <p style="color:#888; margin:10px 0;">The Proposer offers you:</p>

                        <div class="offer-display" style="justify-content:center; font-size:2em;">
                            <span class="offer-responder">$<span id="receivedOffer">0</span></span>
                        </div>
                        <p style="color:#888;">(Proposer keeps $<span id="proposerKeeps">0</span>)</p>

                        <div class="buttons">
                            <button class="btn-accept" id="acceptBtn">Accept</button>
                            <button class="btn-reject" id="rejectBtn">Reject</button>
                        </div>
                    </div>

                    <div id="resultDisplay" class="result-display" style="display:none;"></div>
                </div>

                <div id="simulateMode" style="display:none;" class="game-area">
                    <h3>AI Simulation</h3>
                    <div class="threshold-display">
                        <span>Responder Threshold:</span>
                        <input type="range" id="threshold" min="0" max="50" value="30" style="width:150px;">
                        <span id="thresholdValue">$30</span>
                    </div>
                    <p style="color:#888; margin:15px 0;">Responder accepts offers ≥ threshold</p>

                    <div class="buttons">
                        <button class="btn-primary" id="runSimulation">Run 1000 Games</button>
                    </div>

                    <div id="simResults" style="margin-top:20px;"></div>
                </div>

                <div id="evolveMode" style="display:none;" class="game-area">
                    <h3>Evolution of Fairness</h3>
                    <p style="color:#888; margin:15px 0;">Watch fairness norms emerge through evolution</p>

                    <div class="buttons">
                        <button class="btn-primary" id="startEvolution">Start Evolution</button>
                        <button class="btn-primary" id="stepEvolution">Step</button>
                        <button class="btn-primary" id="resetEvolution">Reset</button>
                    </div>

                    <div style="margin-top:20px;">
                        <div>Generation: <span id="evoGeneration">0</span></div>
                        <div>Avg Offer: <span id="avgOffer">50</span>%</div>
                        <div>Avg Threshold: <span id="avgThreshold">30</span>%</div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h2>Statistics</h2>

                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="gamesPlayed">0</div>
                        <div class="stat-label">Games Played</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="acceptRate">0%</div>
                        <div class="stat-label">Accept Rate</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="avgOfferStat">$0</div>
                        <div class="stat-label">Avg Offer</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="totalEarnings">$0</div>
                        <div class="stat-label">Your Total</div>
                    </div>
                </div>

                <h2>Offer Distribution</h2>
                <canvas id="offerChart" height="180"></canvas>

                <h2 style="margin-top:20px;">Theory</h2>
                <div style="font-size:0.85em; color:#aaa; line-height:1.6;">
                    <strong>Rational prediction:</strong> Proposer offers $1, Responder accepts (any positive amount beats $0).
                    <br><br>
                    <strong>Reality:</strong> Most offers are 40-50%. Offers below 20% are usually rejected.
                    <br><br>
                    <strong>Why?</strong> Humans have evolved fairness preferences and will punish unfair behavior even at personal cost.
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('offerChart');
        const ctx = canvas.getContext('2d');

        let stats = {
            gamesPlayed: 0,
            accepted: 0,
            offers: [],
            playerTotal: 0
        };

        let currentOffer = 50;
        let isProposer = true;

        // Evolution state
        let evoRunning = false;
        let evoPopulation = [];
        let evoGeneration = 0;

        // Mode switching
        document.querySelectorAll('.mode-tab').forEach(tab => {
            tab.onclick = () => {
                document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                document.getElementById('playMode').style.display = 'none';
                document.getElementById('simulateMode').style.display = 'none';
                document.getElementById('evolveMode').style.display = 'none';

                document.getElementById(tab.dataset.mode + 'Mode').style.display = 'block';
            };
        });

        // Play mode
        const offerSlider = document.getElementById('offerSlider');
        offerSlider.oninput = () => {
            currentOffer = parseInt(offerSlider.value);
            document.getElementById('offerAmount').textContent = currentOffer;
            document.getElementById('keepAmount').textContent = 100 - currentOffer;
        };

        document.getElementById('makeOffer').onclick = () => {
            document.getElementById('proposerView').style.display = 'none';
            document.getElementById('responderView').style.display = 'block';
            document.getElementById('receivedOffer').textContent = currentOffer;
            document.getElementById('proposerKeeps').textContent = 100 - currentOffer;
            document.getElementById('resultDisplay').style.display = 'none';
        };

        function endGame(accepted) {
            const resultDiv = document.getElementById('resultDisplay');
            resultDiv.style.display = 'block';

            stats.gamesPlayed++;
            stats.offers.push(currentOffer);

            if (accepted) {
                stats.accepted++;
                stats.playerTotal += currentOffer; // As responder
                resultDiv.className = 'result-display result-accept';
                resultDiv.innerHTML = `<strong>Accepted!</strong><br>You received $${currentOffer}. Proposer got $${100-currentOffer}.`;
            } else {
                resultDiv.className = 'result-display result-reject';
                resultDiv.innerHTML = `<strong>Rejected!</strong><br>Both players get $0. The offer was deemed unfair.`;
            }

            updateStats();

            // Reset after delay
            setTimeout(() => {
                document.getElementById('proposerView').style.display = 'block';
                document.getElementById('responderView').style.display = 'none';
                currentOffer = 50;
                offerSlider.value = 50;
                document.getElementById('offerAmount').textContent = 50;
                document.getElementById('keepAmount').textContent = 50;
            }, 2000);
        }

        document.getElementById('acceptBtn').onclick = () => endGame(true);
        document.getElementById('rejectBtn').onclick = () => endGame(false);

        // Simulation mode
        document.getElementById('threshold').oninput = (e) => {
            document.getElementById('thresholdValue').textContent = '$' + e.target.value;
        };

        document.getElementById('runSimulation').onclick = () => {
            const threshold = parseInt(document.getElementById('threshold').value);
            let accepted = 0;
            const offers = [];

            for (let i = 0; i < 1000; i++) {
                // Random proposer strategy (somewhat weighted toward fair)
                const offer = Math.floor(Math.random() * 60) + Math.floor(Math.random() * 20);
                offers.push(Math.min(offer, 100));

                if (offer >= threshold) {
                    accepted++;
                    stats.offers.push(offer);
                    stats.accepted++;
                } else {
                    stats.offers.push(offer);
                }
                stats.gamesPlayed++;
            }

            const avgOffer = offers.reduce((a,b) => a+b, 0) / offers.length;
            document.getElementById('simResults').innerHTML = `
                <div style="padding:15px; background:rgba(79,195,247,0.1); border-radius:10px;">
                    <div>Games: 1000</div>
                    <div>Accepted: ${accepted} (${(accepted/10).toFixed(1)}%)</div>
                    <div>Avg Offer: $${avgOffer.toFixed(1)}</div>
                    <div>Total Responder Earnings: $${offers.filter(o => o >= threshold).reduce((a,b)=>a+b,0)}</div>
                </div>
            `;

            updateStats();
        };

        // Evolution mode
        function initEvolution() {
            evoPopulation = [];
            for (let i = 0; i < 100; i++) {
                evoPopulation.push({
                    offerStrategy: Math.random() * 100, // What they offer
                    threshold: Math.random() * 50, // What they accept
                    fitness: 0
                });
            }
            evoGeneration = 0;
            updateEvoDisplay();
        }

        function stepEvolution() {
            const n = evoPopulation.length;

            // Reset fitness
            evoPopulation.forEach(p => p.fitness = 0);

            // Random pairings - each plays as both proposer and responder
            for (let i = 0; i < n; i++) {
                for (let j = 0; j < 5; j++) {
                    const partner = evoPopulation[Math.floor(Math.random() * n)];

                    // i as proposer, partner as responder
                    const offer1 = evoPopulation[i].offerStrategy;
                    if (offer1 >= partner.threshold) {
                        evoPopulation[i].fitness += 100 - offer1;
                        // partner gets offer1 as responder
                    }

                    // partner as proposer, i as responder
                    const offer2 = partner.offerStrategy;
                    if (offer2 >= evoPopulation[i].threshold) {
                        evoPopulation[i].fitness += offer2;
                    }
                }
            }

            // Selection and reproduction
            evoPopulation.sort((a, b) => b.fitness - a.fitness);
            const newPop = [];

            // Top 20% reproduce
            const elite = Math.floor(n * 0.2);
            for (let i = 0; i < n; i++) {
                const parent = evoPopulation[Math.floor(Math.random() * elite)];
                newPop.push({
                    offerStrategy: parent.offerStrategy + (Math.random() - 0.5) * 10,
                    threshold: parent.threshold + (Math.random() - 0.5) * 5,
                    fitness: 0
                });
                newPop[i].offerStrategy = Math.max(0, Math.min(100, newPop[i].offerStrategy));
                newPop[i].threshold = Math.max(0, Math.min(50, newPop[i].threshold));
            }

            evoPopulation = newPop;
            evoGeneration++;
            updateEvoDisplay();
        }

        function updateEvoDisplay() {
            const avgOffer = evoPopulation.reduce((s, p) => s + p.offerStrategy, 0) / evoPopulation.length;
            const avgThreshold = evoPopulation.reduce((s, p) => s + p.threshold, 0) / evoPopulation.length;

            document.getElementById('evoGeneration').textContent = evoGeneration;
            document.getElementById('avgOffer').textContent = avgOffer.toFixed(1);
            document.getElementById('avgThreshold').textContent = avgThreshold.toFixed(1);
        }

        let evoAnimationId = null;
        document.getElementById('startEvolution').onclick = () => {
            evoRunning = !evoRunning;
            document.getElementById('startEvolution').textContent = evoRunning ? 'Pause' : 'Start Evolution';

            if (evoRunning) {
                function evoAnimate() {
                    if (!evoRunning) return;
                    stepEvolution();
                    evoAnimationId = setTimeout(evoAnimate, 100);
                }
                evoAnimate();
            }
        };

        document.getElementById('stepEvolution').onclick = () => {
            if (!evoRunning) stepEvolution();
        };

        document.getElementById('resetEvolution').onclick = () => {
            evoRunning = false;
            document.getElementById('startEvolution').textContent = 'Start Evolution';
            initEvolution();
        };

        function updateStats() {
            document.getElementById('gamesPlayed').textContent = stats.gamesPlayed;
            document.getElementById('acceptRate').textContent =
                stats.gamesPlayed > 0 ? ((stats.accepted / stats.gamesPlayed) * 100).toFixed(0) + '%' : '0%';

            const avgOffer = stats.offers.length > 0 ?
                stats.offers.reduce((a,b) => a+b, 0) / stats.offers.length : 0;
            document.getElementById('avgOfferStat').textContent = '$' + avgOffer.toFixed(0);
            document.getElementById('totalEarnings').textContent = '$' + stats.playerTotal;

            drawChart();
        }

        function drawChart() {
            const dpr = window.devicePixelRatio || 1;
            canvas.width = canvas.offsetWidth * dpr;
            canvas.height = 180 * dpr;
            ctx.scale(dpr, dpr);

            const w = canvas.offsetWidth;
            const h = 180;

            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.fillRect(0, 0, w, h);

            if (stats.offers.length === 0) return;

            // Create histogram
            const bins = new Array(11).fill(0); // 0-10, 11-20, ..., 91-100
            for (const offer of stats.offers) {
                const bin = Math.min(Math.floor(offer / 10), 10);
                bins[bin]++;
            }

            const maxBin = Math.max(...bins, 1);
            const barWidth = (w - 40) / 11;

            for (let i = 0; i < 11; i++) {
                const barHeight = (bins[i] / maxBin) * (h - 40);
                const x = 20 + i * barWidth;
                const y = h - barHeight - 20;

                const gradient = ctx.createLinearGradient(x, y, x, h - 20);
                gradient.addColorStop(0, '#4fc3f7');
                gradient.addColorStop(1, '#0288d1');
                ctx.fillStyle = gradient;
                ctx.fillRect(x + 2, y, barWidth - 4, barHeight);

                // Label
                ctx.fillStyle = '#888';
                ctx.font = '10px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(`${i*10}`, x + barWidth/2, h - 5);
            }
        }

        // Initialize
        initEvolution();
        updateStats();
    </script>
</body>
</html>
