<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minority Game (El Farol Bar) | Game Theory</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 10px; color: #4fc3f7; }
        .subtitle { text-align: center; color: #888; margin-bottom: 20px; }

        .controls {
            display: flex; gap: 15px; flex-wrap: wrap;
            justify-content: center; margin-bottom: 20px; align-items: center;
        }
        button {
            padding: 10px 20px; border: none; border-radius: 8px;
            background: #4fc3f7; color: #1a1a2e; font-weight: bold;
            cursor: pointer; transition: all 0.3s;
        }
        button:hover { background: #81d4fa; }
        label { display: flex; align-items: center; gap: 8px; }
        input[type="range"] { width: 80px; }

        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }

        .panel {
            background: rgba(255,255,255,0.05);
            border-radius: 15px; padding: 20px;
            border: 1px solid rgba(79, 195, 247, 0.2);
        }
        .panel h2 { color: #4fc3f7; margin-bottom: 15px; }

        .bar-scene {
            position: relative; height: 200px;
            background: linear-gradient(180deg, #2d1f3d 0%, #1a1a2e 100%);
            border-radius: 15px; overflow: hidden;
            margin-bottom: 15px;
        }
        .bar-counter {
            position: absolute; bottom: 0; left: 0; right: 0;
            height: 40px; background: #5d4037;
        }
        .bar-sign {
            position: absolute; top: 10px; left: 50%;
            transform: translateX(-50%);
            padding: 5px 20px; background: #ffd700;
            color: #1a1a2e; font-weight: bold;
            border-radius: 5px;
        }
        .person {
            position: absolute; font-size: 20px;
            transition: all 0.3s;
        }

        .attendance-display {
            text-align: center; padding: 15px;
            background: rgba(0,0,0,0.3); border-radius: 10px;
        }
        .attendance-number {
            font-size: 3em; font-weight: bold;
        }
        .attendance-label { color: #888; }
        .crowded { color: #f44336; }
        .comfortable { color: #4caf50; }

        .threshold-bar {
            height: 30px; margin: 15px 0;
            background: rgba(0,0,0,0.3); border-radius: 15px;
            position: relative; overflow: hidden;
        }
        .threshold-fill {
            height: 100%; transition: width 0.3s;
        }
        .threshold-line {
            position: absolute; top: 0; bottom: 0;
            width: 3px; background: #fff;
        }

        canvas { width: 100%; border-radius: 10px; background: rgba(0,0,0,0.2); }

        .stat-row {
            display: flex; justify-content: space-between;
            padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .strategy-list {
            max-height: 200px; overflow-y: auto;
            margin: 10px 0;
        }
        .strategy-item {
            display: flex; justify-content: space-between;
            padding: 5px 10px; margin: 3px 0;
            background: rgba(0,0,0,0.2); border-radius: 5px;
            font-size: 0.85em;
        }
        .strategy-score { color: #4caf50; }

        a.back-link {
            display: inline-block; margin-bottom: 20px;
            color: #4fc3f7; text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">‚Üê Back to Game Theory</a>
        <h1>Minority Game</h1>
        <p class="subtitle">El Farol Bar Problem: Be in the minority to win</p>

        <div class="controls">
            <button id="startBtn">Start</button>
            <button id="stepBtn">Step</button>
            <button id="resetBtn">Reset</button>
            <label>
                Agents:
                <input type="range" id="numAgents" min="51" max="201" step="10" value="101">
                <span id="agentDisplay">101</span>
            </label>
            <label>
                Memory:
                <input type="range" id="memory" min="2" max="10" value="5">
                <span id="memoryDisplay">5</span>
            </label>
            <label>
                Threshold:
                <input type="range" id="threshold" min="30" max="70" value="60">
                <span id="thresholdDisplay">60%</span>
            </label>
        </div>

        <div class="main-grid">
            <div class="panel">
                <h2>El Farol Bar üç∫</h2>
                <div class="bar-scene" id="barScene">
                    <div class="bar-sign">EL FAROL</div>
                    <div class="bar-counter"></div>
                </div>

                <div class="attendance-display">
                    <div class="attendance-number" id="attendance">0</div>
                    <div class="attendance-label">Attendance (<span id="attendancePct">0</span>%)</div>
                </div>

                <div class="threshold-bar">
                    <div class="threshold-fill" id="thresholdFill" style="width:0%;"></div>
                    <div class="threshold-line" id="thresholdLine" style="left:60%;"></div>
                </div>

                <div style="text-align:center; margin:10px 0;">
                    <span id="winnerText">-</span>
                </div>

                <h2>Attendance History</h2>
                <canvas id="historyChart" height="150"></canvas>
            </div>

            <div class="panel">
                <h2>Statistics</h2>
                <div class="stat-row">
                    <span>Week</span>
                    <span id="week">0</span>
                </div>
                <div class="stat-row">
                    <span>Avg Attendance</span>
                    <span id="avgAttendance">0%</span>
                </div>
                <div class="stat-row">
                    <span>Volatility</span>
                    <span id="volatility">0</span>
                </div>
                <div class="stat-row">
                    <span>Efficiency</span>
                    <span id="efficiency">0%</span>
                </div>

                <h2 style="margin-top:20px;">Strategy Performance</h2>
                <div class="strategy-list" id="strategyList"></div>

                <h2 style="margin-top:20px;">Theory</h2>
                <div style="font-size:0.85em; color:#aaa; line-height:1.6;">
                    <strong>The Problem:</strong><br>
                    If too many people predict "go", the bar is crowded and goers lose.
                    If too many predict "stay", the bar is empty and stayers miss out.
                    <br><br>
                    <strong>Key Insight:</strong><br>
                    No perfect prediction strategy exists - if everyone uses it, it becomes self-defeating.
                    The system self-organizes near the threshold.
                    <br><br>
                    <strong>Applications:</strong> Market timing, traffic routing, resource allocation.
                </div>
            </div>
        </div>
    </div>

    <script>
        let agents = [];
        let week = 0;
        let history = [];
        let running = false;

        const historyCanvas = document.getElementById('historyChart');
        const historyCtx = historyCanvas.getContext('2d');

        class Agent {
            constructor(id, memory) {
                this.id = id;
                this.memory = memory;
                this.strategies = [];
                this.scores = [];

                // Each agent has multiple strategies
                for (let i = 0; i < 3; i++) {
                    this.strategies.push(this.generateStrategy());
                    this.scores.push(0);
                }

                this.lastDecision = null;
            }

            generateStrategy() {
                // Strategy maps recent history pattern to decision
                const strategy = {};
                const patterns = Math.pow(2, this.memory);
                for (let i = 0; i < patterns; i++) {
                    strategy[i.toString(2).padStart(this.memory, '0')] = Math.random() < 0.5 ? 1 : 0;
                }
                return strategy;
            }

            getHistoryPattern(history) {
                if (history.length < this.memory) return null;
                const threshold = parseInt(document.getElementById('threshold').value);
                const n = parseInt(document.getElementById('numAgents').value);
                const thresholdCount = Math.floor(n * threshold / 100);

                return history.slice(-this.memory)
                    .map(h => h >= thresholdCount ? '1' : '0')
                    .join('');
            }

            decide(history) {
                const pattern = this.getHistoryPattern(history);
                if (!pattern) {
                    this.lastDecision = Math.random() < 0.5 ? 1 : 0;
                    return this.lastDecision;
                }

                // Use best performing strategy
                let bestIdx = 0;
                for (let i = 1; i < this.strategies.length; i++) {
                    if (this.scores[i] > this.scores[bestIdx]) {
                        bestIdx = i;
                    }
                }

                this.lastDecision = this.strategies[bestIdx][pattern];
                return this.lastDecision;
            }

            updateScores(history, actualAttendance) {
                const pattern = this.getHistoryPattern(history.slice(0, -1));
                if (!pattern) return;

                const threshold = parseInt(document.getElementById('threshold').value);
                const n = parseInt(document.getElementById('numAgents').value);
                const thresholdCount = Math.floor(n * threshold / 100);
                const minority = actualAttendance < thresholdCount ? 1 : 0;

                for (let i = 0; i < this.strategies.length; i++) {
                    if (this.strategies[i][pattern] === minority) {
                        this.scores[i]++;
                    }
                }
            }
        }

        function init() {
            const n = parseInt(document.getElementById('numAgents').value);
            const m = parseInt(document.getElementById('memory').value);

            agents = [];
            for (let i = 0; i < n; i++) {
                agents.push(new Agent(i, m));
            }

            week = 0;
            history = [];
            updateDisplay(0);
            drawChart();
        }

        function step() {
            week++;

            // All agents decide
            let attendance = 0;
            for (const agent of agents) {
                if (agent.decide(history)) {
                    attendance++;
                }
            }

            history.push(attendance);

            // Update strategy scores
            for (const agent of agents) {
                agent.updateScores(history, attendance);
            }

            if (history.length > 200) history.shift();

            updateDisplay(attendance);
            drawChart();
            drawBar(attendance);
        }

        function updateDisplay(attendance) {
            const n = parseInt(document.getElementById('numAgents').value);
            const threshold = parseInt(document.getElementById('threshold').value);
            const thresholdCount = Math.floor(n * threshold / 100);
            const pct = ((attendance / n) * 100).toFixed(0);

            document.getElementById('week').textContent = week;
            document.getElementById('attendance').textContent = attendance;
            document.getElementById('attendancePct').textContent = pct;

            const attDiv = document.getElementById('attendance');
            attDiv.className = 'attendance-number ' + (attendance >= thresholdCount ? 'crowded' : 'comfortable');

            // Threshold bar
            const fill = document.getElementById('thresholdFill');
            fill.style.width = pct + '%';
            fill.style.background = attendance >= thresholdCount ?
                'linear-gradient(90deg, #f44336, #ff5722)' :
                'linear-gradient(90deg, #4caf50, #8bc34a)';

            document.getElementById('thresholdLine').style.left = threshold + '%';

            // Winner text
            const winnerText = document.getElementById('winnerText');
            if (attendance >= thresholdCount) {
                winnerText.innerHTML = 'üè† <strong>Stayers Win!</strong> Bar is crowded';
                winnerText.style.color = '#4caf50';
            } else {
                winnerText.innerHTML = 'üç∫ <strong>Goers Win!</strong> Bar is comfortable';
                winnerText.style.color = '#4fc3f7';
            }

            // Statistics
            if (history.length > 0) {
                const avg = history.reduce((a, b) => a + b, 0) / history.length;
                document.getElementById('avgAttendance').textContent =
                    ((avg / n) * 100).toFixed(1) + '%';

                // Volatility (standard deviation)
                const variance = history.reduce((s, x) => s + Math.pow(x - avg, 2), 0) / history.length;
                document.getElementById('volatility').textContent = Math.sqrt(variance).toFixed(1);

                // Efficiency (how close to threshold on average)
                const avgDist = history.reduce((s, x) => s + Math.abs(x - thresholdCount), 0) / history.length;
                const maxDist = Math.max(thresholdCount, n - thresholdCount);
                document.getElementById('efficiency').textContent =
                    ((1 - avgDist / maxDist) * 100).toFixed(0) + '%';
            }

            // Strategy list
            const stratList = document.getElementById('strategyList');
            const stratScores = {};

            for (const agent of agents) {
                const bestIdx = agent.scores.indexOf(Math.max(...agent.scores));
                const stratKey = JSON.stringify(agent.strategies[bestIdx]);
                if (!stratScores[stratKey]) {
                    stratScores[stratKey] = { count: 0, score: agent.scores[bestIdx] };
                }
                stratScores[stratKey].count++;
            }

            const sorted = Object.entries(stratScores)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 10);

            stratList.innerHTML = sorted.map(([key, data], i) =>
                `<div class="strategy-item">
                    <span>Strategy ${i + 1} (${data.count} agents)</span>
                    <span class="strategy-score">${data.score}</span>
                </div>`
            ).join('');
        }

        function drawBar(attendance) {
            const scene = document.getElementById('barScene');
            // Remove old people
            scene.querySelectorAll('.person').forEach(p => p.remove());

            const n = parseInt(document.getElementById('numAgents').value);

            // Add people
            for (let i = 0; i < Math.min(attendance, 50); i++) {
                const person = document.createElement('div');
                person.className = 'person';
                person.textContent = 'üßë';
                person.style.left = (10 + Math.random() * 80) + '%';
                person.style.bottom = (50 + Math.random() * 80) + 'px';
                scene.appendChild(person);
            }
        }

        function drawChart() {
            const dpr = window.devicePixelRatio || 1;
            historyCanvas.width = historyCanvas.offsetWidth * dpr;
            historyCanvas.height = 150 * dpr;
            historyCtx.scale(dpr, dpr);

            const w = historyCanvas.offsetWidth;
            const h = 150;
            const n = parseInt(document.getElementById('numAgents').value);
            const threshold = parseInt(document.getElementById('threshold').value);
            const thresholdCount = Math.floor(n * threshold / 100);

            historyCtx.fillStyle = 'rgba(0,0,0,0.2)';
            historyCtx.fillRect(0, 0, w, h);

            if (history.length < 2) return;

            // Threshold line
            const threshY = h - (thresholdCount / n) * (h - 20) - 10;
            historyCtx.strokeStyle = 'rgba(255,255,255,0.3)';
            historyCtx.setLineDash([5, 5]);
            historyCtx.beginPath();
            historyCtx.moveTo(0, threshY);
            historyCtx.lineTo(w, threshY);
            historyCtx.stroke();
            historyCtx.setLineDash([]);

            // Attendance line
            historyCtx.strokeStyle = '#4fc3f7';
            historyCtx.lineWidth = 2;
            historyCtx.beginPath();

            for (let i = 0; i < history.length; i++) {
                const x = (i / (history.length - 1)) * w;
                const y = h - (history[i] / n) * (h - 20) - 10;
                if (i === 0) historyCtx.moveTo(x, y);
                else historyCtx.lineTo(x, y);
            }
            historyCtx.stroke();

            // Labels
            historyCtx.fillStyle = '#888';
            historyCtx.font = '10px sans-serif';
            historyCtx.fillText('Threshold: ' + threshold + '%', 5, 12);
        }

        let animationId = null;
        function animate() {
            if (!running) return;
            step();
            animationId = setTimeout(animate, 200);
        }

        // Event listeners
        document.getElementById('startBtn').onclick = () => {
            running = !running;
            document.getElementById('startBtn').textContent = running ? 'Pause' : 'Start';
            if (running) animate();
        };

        document.getElementById('stepBtn').onclick = () => {
            if (!running) step();
        };

        document.getElementById('resetBtn').onclick = init;

        document.getElementById('numAgents').oninput = (e) => {
            document.getElementById('agentDisplay').textContent = e.target.value;
        };

        document.getElementById('memory').oninput = (e) => {
            document.getElementById('memoryDisplay').textContent = e.target.value;
        };

        document.getElementById('threshold').oninput = (e) => {
            document.getElementById('thresholdDisplay').textContent = e.target.value + '%';
        };

        // Initialize
        init();
    </script>
</body>
</html>
