<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Replicator Dynamics | Game Theory</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 10px; color: #4fc3f7; }
        .subtitle { text-align: center; color: #888; margin-bottom: 20px; }

        .game-select {
            display: flex; gap: 10px; justify-content: center;
            flex-wrap: wrap; margin-bottom: 20px;
        }
        .game-btn {
            padding: 10px 20px; border: none; border-radius: 8px;
            background: rgba(79, 195, 247, 0.1);
            border: 1px solid rgba(79, 195, 247, 0.3);
            color: #e0e0e0; cursor: pointer;
        }
        .game-btn.active {
            background: rgba(79, 195, 247, 0.3);
            border-color: #4fc3f7;
        }

        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 800px) { .main-grid { grid-template-columns: 1fr; } }

        .panel {
            background: rgba(255,255,255,0.05);
            border-radius: 15px; padding: 20px;
            border: 1px solid rgba(79, 195, 247, 0.2);
        }
        .panel h2 { color: #4fc3f7; margin-bottom: 15px; }

        .payoff-matrix {
            display: grid; grid-template-columns: auto 1fr 1fr; gap: 3px;
            margin: 15px 0;
        }
        .payoff-cell {
            padding: 12px; text-align: center;
            background: rgba(79, 195, 247, 0.1);
            border-radius: 5px;
        }
        .payoff-cell.header {
            background: rgba(79, 195, 247, 0.25);
            font-weight: bold;
        }

        .controls {
            display: flex; gap: 10px; flex-wrap: wrap;
            justify-content: center; margin: 15px 0;
        }
        button {
            padding: 10px 20px; border: none; border-radius: 8px;
            background: #4fc3f7; color: #1a1a2e; font-weight: bold;
            cursor: pointer;
        }
        button:hover { background: #81d4fa; }

        label { display: flex; align-items: center; gap: 8px; }
        input[type="range"] { width: 100px; }

        canvas { width: 100%; border-radius: 10px; background: rgba(0,0,0,0.2); }

        .phase-container {
            position: relative;
            width: 100%; padding-top: 100%;
        }
        #phaseCanvas {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
        }

        .freq-display {
            display: flex; justify-content: space-around;
            margin: 15px 0; text-align: center;
        }
        .freq-item { }
        .freq-value {
            font-size: 2em; font-weight: bold;
        }
        .freq-a { color: #4caf50; }
        .freq-b { color: #ff9800; }

        .stat-row {
            display: flex; justify-content: space-between;
            padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .equation {
            font-family: 'Times New Roman', serif;
            font-size: 1.1em;
            text-align: center;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            margin: 15px 0;
        }

        a.back-link {
            display: inline-block; margin-bottom: 20px;
            color: #4fc3f7; text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">← Back to Game Theory</a>
        <h1>Replicator Dynamics</h1>
        <p class="subtitle">Mathematical model of evolutionary game theory</p>

        <div class="game-select">
            <button class="game-btn active" data-game="pd">Prisoner's Dilemma</button>
            <button class="game-btn" data-game="hawk-dove">Hawk-Dove</button>
            <button class="game-btn" data-game="stag">Stag Hunt</button>
            <button class="game-btn" data-game="coordination">Coordination</button>
            <button class="game-btn" data-game="custom">Custom</button>
        </div>

        <div class="main-grid">
            <div class="panel">
                <h2>Payoff Matrix</h2>
                <div class="payoff-matrix">
                    <div class="payoff-cell header"></div>
                    <div class="payoff-cell header">Strategy A</div>
                    <div class="payoff-cell header">Strategy B</div>
                    <div class="payoff-cell header">Strategy A</div>
                    <div class="payoff-cell">
                        <input type="number" id="aa" value="3" style="width:50px; background:#1a1a2e; color:#e0e0e0; border:1px solid #4fc3f7; padding:5px; border-radius:4px;">
                    </div>
                    <div class="payoff-cell">
                        <input type="number" id="ab" value="0" style="width:50px; background:#1a1a2e; color:#e0e0e0; border:1px solid #4fc3f7; padding:5px; border-radius:4px;">
                    </div>
                    <div class="payoff-cell header">Strategy B</div>
                    <div class="payoff-cell">
                        <input type="number" id="ba" value="5" style="width:50px; background:#1a1a2e; color:#e0e0e0; border:1px solid #4fc3f7; padding:5px; border-radius:4px;">
                    </div>
                    <div class="payoff-cell">
                        <input type="number" id="bb" value="1" style="width:50px; background:#1a1a2e; color:#e0e0e0; border:1px solid #4fc3f7; padding:5px; border-radius:4px;">
                    </div>
                </div>

                <div class="freq-display">
                    <div class="freq-item">
                        <div class="freq-value freq-a" id="freqA">50%</div>
                        <div>Strategy A</div>
                    </div>
                    <div class="freq-item">
                        <div class="freq-value freq-b" id="freqB">50%</div>
                        <div>Strategy B</div>
                    </div>
                </div>

                <div class="controls">
                    <button id="startBtn">Start</button>
                    <button id="resetBtn">Reset</button>
                    <label>
                        Initial A:
                        <input type="range" id="initialA" min="1" max="99" value="50">
                        <span id="initialAVal">50%</span>
                    </label>
                </div>

                <h2>Population Dynamics</h2>
                <canvas id="dynamicsCanvas" height="200"></canvas>
            </div>

            <div class="panel">
                <h2>Phase Portrait</h2>
                <div class="phase-container">
                    <canvas id="phaseCanvas"></canvas>
                </div>

                <div class="equation">
                    ẋ = x(1-x)[π<sub>A</sub>(x) - π<sub>B</sub>(x)]
                </div>

                <h2>Analysis</h2>
                <div class="stat-row">
                    <span>Generation</span>
                    <span id="generation">0</span>
                </div>
                <div class="stat-row">
                    <span>π<sub>A</sub> (fitness A)</span>
                    <span id="fitnessA">0</span>
                </div>
                <div class="stat-row">
                    <span>π<sub>B</sub> (fitness B)</span>
                    <span id="fitnessB">0</span>
                </div>
                <div class="stat-row">
                    <span>Fixed Points</span>
                    <span id="fixedPoints">-</span>
                </div>
                <div class="stat-row">
                    <span>Stable Equilibrium</span>
                    <span id="stableEq">-</span>
                </div>

                <div style="font-size:0.85em; color:#aaa; line-height:1.6; margin-top:15px;">
                    <strong>Replicator Equation:</strong><br>
                    The rate of change of strategy frequency depends on:
                    <br>• Current frequency x
                    <br>• Fitness advantage over average
                    <br><br>
                    Strategies with above-average fitness grow; below-average shrink.
                </div>
            </div>
        </div>
    </div>

    <script>
        const dynamicsCanvas = document.getElementById('dynamicsCanvas');
        const dynamicsCtx = dynamicsCanvas.getContext('2d');
        const phaseCanvas = document.getElementById('phaseCanvas');
        const phaseCtx = phaseCanvas.getContext('2d');

        const presets = {
            pd: { aa: 3, ab: 0, ba: 5, bb: 1 },      // Prisoner's Dilemma (C/D)
            'hawk-dove': { aa: -1, ab: 2, ba: 0, bb: 1 }, // Hawk-Dove
            stag: { aa: 4, ab: 0, ba: 3, bb: 3 },    // Stag Hunt
            coordination: { aa: 2, ab: 0, ba: 0, bb: 2 }  // Pure Coordination
        };

        let x = 0.5; // Frequency of strategy A
        let generation = 0;
        let history = [];
        let running = false;
        let animationId = null;

        function getPayoffs() {
            return {
                aa: parseFloat(document.getElementById('aa').value) || 0,
                ab: parseFloat(document.getElementById('ab').value) || 0,
                ba: parseFloat(document.getElementById('ba').value) || 0,
                bb: parseFloat(document.getElementById('bb').value) || 0
            };
        }

        function setPreset(name) {
            if (presets[name]) {
                const p = presets[name];
                document.getElementById('aa').value = p.aa;
                document.getElementById('ab').value = p.ab;
                document.getElementById('ba').value = p.ba;
                document.getElementById('bb').value = p.bb;
            }
            reset();
        }

        function calculateFitness(freq) {
            const p = getPayoffs();
            const fitnessA = freq * p.aa + (1 - freq) * p.ab;
            const fitnessB = freq * p.ba + (1 - freq) * p.bb;
            return { fitnessA, fitnessB };
        }

        function step() {
            const { fitnessA, fitnessB } = calculateFitness(x);
            const avgFitness = x * fitnessA + (1 - x) * fitnessB;

            // Replicator dynamics
            const dx = x * (fitnessA - avgFitness) * 0.1;
            x = Math.max(0.001, Math.min(0.999, x + dx));

            generation++;
            history.push(x);
            if (history.length > 300) history.shift();

            updateDisplay();
        }

        function updateDisplay() {
            document.getElementById('freqA').textContent = (x * 100).toFixed(1) + '%';
            document.getElementById('freqB').textContent = ((1 - x) * 100).toFixed(1) + '%';
            document.getElementById('generation').textContent = generation;

            const { fitnessA, fitnessB } = calculateFitness(x);
            document.getElementById('fitnessA').textContent = fitnessA.toFixed(3);
            document.getElementById('fitnessB').textContent = fitnessB.toFixed(3);

            // Find fixed points
            const p = getPayoffs();
            const fixedPoints = ['0', '1'];
            const interior = (p.bb - p.ab) / (p.aa - p.ab - p.ba + p.bb);
            if (interior > 0 && interior < 1 && !isNaN(interior)) {
                fixedPoints.push(interior.toFixed(3));
            }
            document.getElementById('fixedPoints').textContent = fixedPoints.join(', ');

            // Determine stable equilibrium
            let stable = '';
            if (p.aa > p.ba && p.ab > p.bb) stable = 'x=1 (A dominates)';
            else if (p.aa < p.ba && p.ab < p.bb) stable = 'x=0 (B dominates)';
            else if (p.aa > p.ba && p.ab < p.bb) stable = 'x=0 and x=1 (bistable)';
            else if (p.aa < p.ba && p.ab > p.bb) stable = `x=${interior.toFixed(2)} (mixed ESS)`;
            document.getElementById('stableEq').textContent = stable;

            drawDynamics();
            drawPhase();
        }

        function drawDynamics() {
            const dpr = window.devicePixelRatio || 1;
            dynamicsCanvas.width = dynamicsCanvas.offsetWidth * dpr;
            dynamicsCanvas.height = 200 * dpr;
            dynamicsCtx.scale(dpr, dpr);

            const w = dynamicsCanvas.offsetWidth;
            const h = 200;

            dynamicsCtx.fillStyle = 'rgba(0,0,0,0.2)';
            dynamicsCtx.fillRect(0, 0, w, h);

            if (history.length < 2) return;

            // Strategy A line
            dynamicsCtx.strokeStyle = '#4caf50';
            dynamicsCtx.lineWidth = 2;
            dynamicsCtx.beginPath();
            for (let i = 0; i < history.length; i++) {
                const px = (i / (history.length - 1)) * w;
                const py = h - history[i] * (h - 20) - 10;
                if (i === 0) dynamicsCtx.moveTo(px, py);
                else dynamicsCtx.lineTo(px, py);
            }
            dynamicsCtx.stroke();

            // Strategy B line
            dynamicsCtx.strokeStyle = '#ff9800';
            dynamicsCtx.beginPath();
            for (let i = 0; i < history.length; i++) {
                const px = (i / (history.length - 1)) * w;
                const py = h - (1 - history[i]) * (h - 20) - 10;
                if (i === 0) dynamicsCtx.moveTo(px, py);
                else dynamicsCtx.lineTo(px, py);
            }
            dynamicsCtx.stroke();

            // Labels
            dynamicsCtx.fillStyle = '#4caf50';
            dynamicsCtx.font = '10px sans-serif';
            dynamicsCtx.fillText('A', 5, 15);
            dynamicsCtx.fillStyle = '#ff9800';
            dynamicsCtx.fillText('B', 20, 15);
        }

        function drawPhase() {
            const rect = phaseCanvas.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            phaseCanvas.width = rect.width * dpr;
            phaseCanvas.height = rect.height * dpr;
            phaseCtx.scale(dpr, dpr);

            const w = rect.width;
            const h = rect.height;
            const margin = 30;

            phaseCtx.fillStyle = 'rgba(0,0,0,0.2)';
            phaseCtx.fillRect(0, 0, w, h);

            // Draw phase line (1D system, so x-axis is frequency, y-axis is dx/dt)
            const plotW = w - 2 * margin;
            const plotH = h - 2 * margin;

            // Axes
            phaseCtx.strokeStyle = 'rgba(255,255,255,0.3)';
            phaseCtx.lineWidth = 1;
            phaseCtx.beginPath();
            phaseCtx.moveTo(margin, h / 2);
            phaseCtx.lineTo(w - margin, h / 2);
            phaseCtx.moveTo(margin, margin);
            phaseCtx.lineTo(margin, h - margin);
            phaseCtx.stroke();

            // Draw dx/dt curve
            phaseCtx.strokeStyle = '#4fc3f7';
            phaseCtx.lineWidth = 2;
            phaseCtx.beginPath();

            let maxDx = 0;
            for (let i = 0; i <= 100; i++) {
                const freq = i / 100;
                const { fitnessA, fitnessB } = calculateFitness(freq);
                const avgFitness = freq * fitnessA + (1 - freq) * fitnessB;
                const dx = freq * (fitnessA - avgFitness);
                maxDx = Math.max(maxDx, Math.abs(dx));
            }
            maxDx = Math.max(maxDx, 0.1);

            for (let i = 0; i <= 100; i++) {
                const freq = i / 100;
                const { fitnessA, fitnessB } = calculateFitness(freq);
                const avgFitness = freq * fitnessA + (1 - freq) * fitnessB;
                const dx = freq * (fitnessA - avgFitness);

                const px = margin + freq * plotW;
                const py = h / 2 - (dx / maxDx) * (plotH / 2 - 10);

                if (i === 0) phaseCtx.moveTo(px, py);
                else phaseCtx.lineTo(px, py);
            }
            phaseCtx.stroke();

            // Mark current position
            const { fitnessA, fitnessB } = calculateFitness(x);
            const avgFitness = x * fitnessA + (1 - x) * fitnessB;
            const currentDx = x * (fitnessA - avgFitness);
            const currentX = margin + x * plotW;
            const currentY = h / 2 - (currentDx / maxDx) * (plotH / 2 - 10);

            phaseCtx.fillStyle = '#fff';
            phaseCtx.beginPath();
            phaseCtx.arc(currentX, currentY, 6, 0, Math.PI * 2);
            phaseCtx.fill();

            // Labels
            phaseCtx.fillStyle = '#888';
            phaseCtx.font = '10px sans-serif';
            phaseCtx.textAlign = 'center';
            phaseCtx.fillText('x (freq A)', w / 2, h - 5);
            phaseCtx.save();
            phaseCtx.translate(10, h / 2);
            phaseCtx.rotate(-Math.PI / 2);
            phaseCtx.fillText('dx/dt', 0, 0);
            phaseCtx.restore();

            phaseCtx.fillText('0', margin, h - 10);
            phaseCtx.fillText('1', w - margin, h - 10);
        }

        function reset() {
            x = parseInt(document.getElementById('initialA').value) / 100;
            generation = 0;
            history = [x];
            running = false;
            document.getElementById('startBtn').textContent = 'Start';
            updateDisplay();
        }

        function animate() {
            if (!running) return;
            step();
            animationId = setTimeout(animate, 50);
        }

        // Event listeners
        document.querySelectorAll('.game-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.game-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                setPreset(btn.dataset.game);
            };
        });

        document.getElementById('startBtn').onclick = () => {
            running = !running;
            document.getElementById('startBtn').textContent = running ? 'Pause' : 'Start';
            if (running) animate();
        };

        document.getElementById('resetBtn').onclick = reset;

        document.getElementById('initialA').oninput = (e) => {
            document.getElementById('initialAVal').textContent = e.target.value + '%';
        };

        ['aa', 'ab', 'ba', 'bb'].forEach(id => {
            document.getElementById(id).onchange = () => {
                document.querySelectorAll('.game-btn').forEach(b => b.classList.remove('active'));
                document.querySelector('[data-game="custom"]').classList.add('active');
                updateDisplay();
            };
        });

        // Initialize
        reset();
    </script>
</body>
</html>
