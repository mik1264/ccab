<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Public Goods Game | Game Theory</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 10px; color: #4fc3f7; }
        .subtitle { text-align: center; color: #888; margin-bottom: 20px; }

        .controls {
            display: flex; gap: 15px; flex-wrap: wrap;
            justify-content: center; margin-bottom: 20px; align-items: center;
        }
        button {
            padding: 10px 20px; border: none; border-radius: 8px;
            background: #4fc3f7; color: #1a1a2e; font-weight: bold;
            cursor: pointer; transition: all 0.3s;
        }
        button:hover { background: #81d4fa; }
        label { display: flex; align-items: center; gap: 8px; font-size: 0.9em; }
        input[type="range"] { width: 80px; }
        select { padding: 8px; border-radius: 6px; background: #1a1a2e; color: #e0e0e0; border: 1px solid #4fc3f7; }

        .main-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
        }
        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }

        .panel {
            background: rgba(255,255,255,0.05);
            border-radius: 15px; padding: 20px;
            border: 1px solid rgba(79, 195, 247, 0.2);
        }
        .panel h2 { color: #4fc3f7; margin-bottom: 15px; font-size: 1.1em; }

        .agent-grid {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;
            margin-bottom: 20px;
        }
        .agent {
            aspect-ratio: 1; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 0.8em;
            transition: all 0.3s;
            position: relative;
        }
        .agent.cooperator { background: linear-gradient(135deg, #4caf50, #2e7d32); }
        .agent.defector { background: linear-gradient(135deg, #f44336, #c62828); }
        .agent.punisher { background: linear-gradient(135deg, #9c27b0, #6a1b9a); }
        .agent-wealth {
            position: absolute; bottom: -18px;
            font-size: 0.7em; color: #aaa;
        }

        .pool-container {
            text-align: center; margin: 20px 0;
        }
        .pool {
            width: 150px; height: 150px; margin: 0 auto;
            border-radius: 50%; border: 4px solid #4fc3f7;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            background: rgba(79, 195, 247, 0.1);
        }
        .pool-amount { font-size: 2em; font-weight: bold; color: #4fc3f7; }
        .pool-label { font-size: 0.8em; color: #888; }

        .round-info {
            text-align: center; margin: 15px 0;
            padding: 15px; background: rgba(0,0,0,0.2);
            border-radius: 10px;
        }

        canvas { width: 100%; border-radius: 10px; background: rgba(0,0,0,0.2); }

        .stat-row {
            display: flex; justify-content: space-between;
            padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .explanation {
            background: rgba(79, 195, 247, 0.1);
            border-radius: 10px; padding: 15px;
            margin-top: 15px; font-size: 0.85em;
            line-height: 1.6;
        }

        a.back-link {
            display: inline-block; margin-bottom: 20px;
            color: #4fc3f7; text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">‚Üê Back to Game Theory</a>
        <h1>Public Goods Game</h1>
        <p class="subtitle">Explore cooperation in collective action problems</p>

        <div class="controls">
            <button id="playRound">Play Round</button>
            <button id="runMany">Run 100 Rounds</button>
            <button id="resetBtn">Reset</button>
            <label>
                Group Size:
                <select id="groupSize">
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="15">15</option>
                    <option value="20">20</option>
                </select>
            </label>
            <label>
                Multiplier:
                <input type="range" id="multiplier" min="1" max="3" step="0.1" value="1.8">
                <span id="multValue">1.8x</span>
            </label>
            <label>
                <input type="checkbox" id="punishment"> Punishment
            </label>
            <label>
                <input type="checkbox" id="evolution"> Evolution
            </label>
        </div>

        <div class="main-grid">
            <div class="panel">
                <h2>Agents</h2>
                <div class="agent-grid" id="agentGrid"></div>

                <div class="pool-container">
                    <div class="pool">
                        <div class="pool-amount" id="poolAmount">0</div>
                        <div class="pool-label">Public Pool</div>
                    </div>
                </div>

                <div class="round-info">
                    <div><strong>Round:</strong> <span id="roundNum">0</span></div>
                    <div><strong>Contributions:</strong> <span id="contributions">0</span></div>
                    <div><strong>Pool after multiply:</strong> <span id="poolMultiplied">0</span></div>
                    <div><strong>Share per agent:</strong> <span id="sharePerAgent">0</span></div>
                </div>

                <div class="explanation">
                    <strong>How it works:</strong><br>
                    Each agent decides how much to contribute (0-10) to the public pool.
                    The pool is multiplied by the multiplier and divided equally among all agents.
                    <br><br>
                    <strong>The dilemma:</strong> Contributing benefits everyone, but free-riders gain more by keeping their money while receiving the shared benefit.
                </div>
            </div>

            <div class="panel">
                <h2>Statistics</h2>
                <div class="stat-row">
                    <span>Avg Contribution</span>
                    <span id="avgContrib">0</span>
                </div>
                <div class="stat-row">
                    <span>Cooperators</span>
                    <span id="coopCount" style="color:#4caf50;">0</span>
                </div>
                <div class="stat-row">
                    <span>Defectors</span>
                    <span id="defectCount" style="color:#f44336;">0</span>
                </div>
                <div class="stat-row">
                    <span>Total Wealth</span>
                    <span id="totalWealth">0</span>
                </div>
                <div class="stat-row">
                    <span>Social Efficiency</span>
                    <span id="efficiency">0%</span>
                </div>

                <h2 style="margin-top:20px;">Contribution History</h2>
                <canvas id="historyChart" height="200"></canvas>

                <h2 style="margin-top:20px;">Wealth Distribution</h2>
                <canvas id="wealthChart" height="150"></canvas>
            </div>
        </div>
    </div>

    <script>
        let agents = [];
        let round = 0;
        let contributionHistory = [];
        let coopHistory = [];

        const historyCanvas = document.getElementById('historyChart');
        const historyCtx = historyCanvas.getContext('2d');
        const wealthCanvas = document.getElementById('wealthChart');
        const wealthCtx = wealthCanvas.getContext('2d');

        class Agent {
            constructor(id, strategy) {
                this.id = id;
                this.strategy = strategy; // 'cooperator', 'defector', or cooperation probability
                this.wealth = 100;
                this.lastContribution = 0;
            }

            decide(multiplier, groupSize) {
                if (this.strategy === 'cooperator') {
                    this.lastContribution = 10;
                } else if (this.strategy === 'defector') {
                    this.lastContribution = 0;
                } else {
                    // Probabilistic - contribute based on strategy value
                    this.lastContribution = Math.random() < this.strategy ? 10 : 0;
                }
                return this.lastContribution;
            }
        }

        function initAgents() {
            const n = parseInt(document.getElementById('groupSize').value);
            agents = [];

            for (let i = 0; i < n; i++) {
                // Start with mix of cooperators and defectors
                const strategy = Math.random() < 0.5 ? 'cooperator' : 'defector';
                agents.push(new Agent(i, strategy));
            }

            round = 0;
            contributionHistory = [];
            coopHistory = [];
            renderAgents();
            updateStats();
        }

        function playRound() {
            const multiplier = parseFloat(document.getElementById('multiplier').value);
            const usePunishment = document.getElementById('punishment').checked;
            const useEvolution = document.getElementById('evolution').checked;
            const n = agents.length;

            // Collect contributions
            let totalContribution = 0;
            const contributions = [];

            for (const agent of agents) {
                const c = agent.decide(multiplier, n);
                contributions.push(c);
                totalContribution += c;
                agent.wealth -= c;
            }

            // Multiply and distribute
            const pool = totalContribution * multiplier;
            const share = pool / n;

            for (const agent of agents) {
                agent.wealth += share;
            }

            // Optional punishment phase
            if (usePunishment) {
                for (let i = 0; i < n; i++) {
                    if (agents[i].strategy === 'cooperator' && contributions[i] > 5) {
                        // Cooperators punish defectors
                        for (let j = 0; j < n; j++) {
                            if (i !== j && contributions[j] < 3) {
                                agents[i].wealth -= 1; // Cost to punish
                                agents[j].wealth -= 3; // Punishment received
                            }
                        }
                    }
                }
            }

            // Optional evolution
            if (useEvolution && round > 0 && round % 10 === 0) {
                // Sort by wealth
                const sorted = [...agents].sort((a, b) => b.wealth - a.wealth);
                // Bottom half adopt strategy of random top half member
                for (let i = Math.floor(n/2); i < n; i++) {
                    const roleModel = sorted[Math.floor(Math.random() * Math.floor(n/2))];
                    agents[sorted[i].id].strategy = roleModel.strategy;
                    // Small mutation chance
                    if (Math.random() < 0.1) {
                        agents[sorted[i].id].strategy =
                            agents[sorted[i].id].strategy === 'cooperator' ? 'defector' : 'cooperator';
                    }
                }
            }

            round++;

            // Record history
            const avgContrib = totalContribution / n;
            contributionHistory.push(avgContrib);
            const coopRate = agents.filter(a => a.strategy === 'cooperator').length / n;
            coopHistory.push(coopRate);

            if (contributionHistory.length > 100) {
                contributionHistory.shift();
                coopHistory.shift();
            }

            // Update display
            document.getElementById('roundNum').textContent = round;
            document.getElementById('contributions').textContent = totalContribution.toFixed(0);
            document.getElementById('poolMultiplied').textContent = pool.toFixed(1);
            document.getElementById('sharePerAgent').textContent = share.toFixed(1);
            document.getElementById('poolAmount').textContent = pool.toFixed(0);

            renderAgents();
            updateStats();
            drawCharts();
        }

        function renderAgents() {
            const grid = document.getElementById('agentGrid');
            grid.innerHTML = '';

            // Adjust grid columns based on agent count
            const cols = Math.min(5, Math.ceil(Math.sqrt(agents.length)));
            grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

            for (const agent of agents) {
                const div = document.createElement('div');
                div.className = `agent ${agent.strategy}`;
                div.innerHTML = `
                    ${agent.lastContribution}
                    <span class="agent-wealth">${agent.wealth.toFixed(0)}</span>
                `;
                div.title = `Agent ${agent.id}: ${agent.strategy}\nWealth: ${agent.wealth.toFixed(1)}`;
                grid.appendChild(div);
            }
        }

        function updateStats() {
            const n = agents.length;
            const totalContrib = agents.reduce((s, a) => s + a.lastContribution, 0);
            const avgContrib = totalContrib / n;
            const coopCount = agents.filter(a => a.strategy === 'cooperator').length;
            const totalWealth = agents.reduce((s, a) => s + a.wealth, 0);

            // Max efficiency = everyone contributes 10, multiplier applied
            const maxEfficiency = n * 10 * parseFloat(document.getElementById('multiplier').value);
            const actualGain = totalContrib * parseFloat(document.getElementById('multiplier').value);
            const efficiency = maxEfficiency > 0 ? (actualGain / maxEfficiency) * 100 : 0;

            document.getElementById('avgContrib').textContent = avgContrib.toFixed(1);
            document.getElementById('coopCount').textContent = coopCount;
            document.getElementById('defectCount').textContent = n - coopCount;
            document.getElementById('totalWealth').textContent = totalWealth.toFixed(0);
            document.getElementById('efficiency').textContent = efficiency.toFixed(0) + '%';
        }

        function drawCharts() {
            // Contribution history
            const w1 = historyCanvas.width = historyCanvas.offsetWidth * 2;
            const h1 = historyCanvas.height = 200 * 2;
            historyCtx.scale(2, 2);

            const cw1 = historyCanvas.offsetWidth;
            const ch1 = 200;

            historyCtx.fillStyle = 'rgba(0,0,0,0.2)';
            historyCtx.fillRect(0, 0, cw1, ch1);

            if (contributionHistory.length > 1) {
                // Contribution line
                historyCtx.strokeStyle = '#4fc3f7';
                historyCtx.lineWidth = 2;
                historyCtx.beginPath();
                for (let i = 0; i < contributionHistory.length; i++) {
                    const x = (i / (contributionHistory.length - 1)) * cw1;
                    const y = ch1 - (contributionHistory[i] / 10) * (ch1 - 20) - 10;
                    if (i === 0) historyCtx.moveTo(x, y);
                    else historyCtx.lineTo(x, y);
                }
                historyCtx.stroke();

                // Cooperation rate line
                historyCtx.strokeStyle = '#4caf50';
                historyCtx.beginPath();
                for (let i = 0; i < coopHistory.length; i++) {
                    const x = (i / (coopHistory.length - 1)) * cw1;
                    const y = ch1 - coopHistory[i] * (ch1 - 20) - 10;
                    if (i === 0) historyCtx.moveTo(x, y);
                    else historyCtx.lineTo(x, y);
                }
                historyCtx.stroke();
            }

            // Labels
            historyCtx.fillStyle = '#4fc3f7';
            historyCtx.font = '10px sans-serif';
            historyCtx.fillText('Avg Contribution', 5, 12);
            historyCtx.fillStyle = '#4caf50';
            historyCtx.fillText('Coop Rate', 100, 12);

            // Wealth distribution
            const w2 = wealthCanvas.width = wealthCanvas.offsetWidth * 2;
            const h2 = wealthCanvas.height = 150 * 2;
            wealthCtx.scale(2, 2);

            const cw2 = wealthCanvas.offsetWidth;
            const ch2 = 150;

            wealthCtx.fillStyle = 'rgba(0,0,0,0.2)';
            wealthCtx.fillRect(0, 0, cw2, ch2);

            const sorted = [...agents].sort((a, b) => b.wealth - a.wealth);
            const maxWealth = Math.max(...agents.map(a => a.wealth), 1);
            const barWidth = (cw2 - 20) / agents.length;

            sorted.forEach((agent, i) => {
                const barHeight = (agent.wealth / maxWealth) * (ch2 - 30);
                const x = 10 + i * barWidth;
                const y = ch2 - barHeight - 10;

                wealthCtx.fillStyle = agent.strategy === 'cooperator' ? '#4caf50' : '#f44336';
                wealthCtx.fillRect(x, y, barWidth - 2, barHeight);
            });
        }

        async function runMany() {
            for (let i = 0; i < 100; i++) {
                playRound();
                if (i % 10 === 0) {
                    await new Promise(r => setTimeout(r, 50));
                }
            }
        }

        // Event listeners
        document.getElementById('playRound').onclick = playRound;
        document.getElementById('runMany').onclick = runMany;
        document.getElementById('resetBtn').onclick = initAgents;

        document.getElementById('multiplier').oninput = (e) => {
            document.getElementById('multValue').textContent = e.target.value + 'x';
        };

        document.getElementById('groupSize').onchange = initAgents;

        // Initialize
        initAgents();
    </script>
</body>
</html>
