<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Branch-by-Branch Progression - Autumn Leaf Visualizations</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: linear-gradient(180deg, #B0C4DE 0%, #F5DEB3 100%);
            font-family: 'Arial', sans-serif;
        }
        canvas {
            display: block;
        }
        .info {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 40px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        h3 {
            margin: 0 0 10px 0;
            color: #8B4513;
        }
        .progress-text {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
<!--
# Goal
Show how autumn color change progresses branch-by-branch through a tree,
starting from the tips and moving inward toward the trunk.

# Approach
- Single large tree with detailed branch structure
- Color change starts at branch tips (furthest from trunk)
- Progresses inward along each branch toward trunk
- Distance-from-trunk calculation for each leaf
- Visual wave effect showing progression
- Realistic branching pattern
- Clear demonstration of biological progression pattern
- Leaves at tips change first, trunk-adjacent leaves last

# Technical Implementation
- Canvas 2D with fractal tree generation
- Distance calculation from each leaf to trunk
- Progressive coloring based on branch distance
- Wave animation moving from periphery to center
- Detailed branch structure for clear visualization
-->

<canvas id="canvas"></canvas>
<div class="info">
    <h3>Branch-by-Branch Color Progression</h3>
    <p class="progress-text">Autumn begins at branch tips and moves toward the trunk</p>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// Branch class
class Branch {
    constructor(startX, startY, endX, endY, generation, distanceFromTrunk) {
        this.startX = startX;
        this.startY = startY;
        this.endX = endX;
        this.endY = endY;
        this.generation = generation;
        this.distanceFromTrunk = distanceFromTrunk;
        this.children = [];
        this.leaves = [];
    }

    addChild(child) {
        this.children.push(child);
    }

    addLeaf(leaf) {
        this.leaves.push(leaf);
    }

    draw() {
        ctx.strokeStyle = '#3e2723';
        ctx.lineWidth = Math.max(1, 12 - this.generation * 1.5);
        ctx.lineCap = 'round';

        ctx.beginPath();
        ctx.moveTo(this.startX, this.startY);
        ctx.lineTo(this.endX, this.endY);
        ctx.stroke();
    }
}

// Leaf class
class BranchLeaf {
    constructor(x, y, distanceFromTrunk, maxDistance) {
        this.x = x;
        this.y = y;
        this.distanceFromTrunk = distanceFromTrunk;
        this.maxDistance = maxDistance;
        this.size = 5 + Math.random() * 3;

        // Normalized distance (0 = trunk, 1 = tips)
        this.normalizedDistance = distanceFromTrunk / maxDistance;

        this.baseChlorophyll = 80 + Math.random() * 20;
        this.carotene = 50 + Math.random() * 40;
    }

    getColor(progressWave) {
        // Leaves change when the wave reaches their distance from trunk
        // Wave moves from 1 (tips) to 0 (trunk)
        const changeThreshold = 1 - progressWave;

        let autumnProgress = 0;
        if (this.normalizedDistance > changeThreshold) {
            // This leaf has been reached by the autumn wave
            const timeSinceChange = (this.normalizedDistance - changeThreshold) / (1 - changeThreshold);
            autumnProgress = Math.min(1, timeSinceChange * 2);
        }

        // Calculate color based on autumn progress
        const chlorophyll = this.baseChlorophyll * (1 - autumnProgress);
        const anthocyanin = autumnProgress * 100;

        const chloroRatio = chlorophyll / 100;
        const caroteRatio = this.carotene / 100;
        const anthocRatio = anthocyanin / 100;

        if (chloroRatio > 0.5) {
            const intensity = 50 + chloroRatio * 150;
            return `rgb(${intensity * 0.3}, ${intensity}, ${intensity * 0.3})`;
        }

        const yellowInfluence = (1 - chloroRatio) * caroteRatio;
        const redInfluence = anthocRatio;

        let r, g, b;
        if (redInfluence > yellowInfluence + 0.2) {
            r = 180 + redInfluence * 75;
            g = 20 + yellowInfluence * 100;
            b = 20;
        } else if (yellowInfluence > redInfluence + 0.2) {
            r = 200 + yellowInfluence * 55;
            g = 180 + yellowInfluence * 75;
            b = 20;
        } else {
            r = 255;
            g = 100 + yellowInfluence * 100;
            b = 20;
        }

        return `rgb(${Math.floor(r)}, ${Math.floor(g)}, ${Math.floor(b)})`;
    }

    draw(progressWave) {
        ctx.fillStyle = this.getColor(progressWave);
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();

        // Subtle outline
        ctx.strokeStyle = 'rgba(0, 0, 0, 0.2)';
        ctx.lineWidth = 0.5;
        ctx.stroke();
    }
}

// Generate tree
const branches = [];
const allLeaves = [];
let maxDistanceFromTrunk = 0;

function createTree(startX, startY, angle, length, generation, distanceFromTrunk) {
    if (generation > 9 || length < 4) {
        maxDistanceFromTrunk = Math.max(maxDistanceFromTrunk, distanceFromTrunk);
        return null;
    }

    const endX = startX + Math.cos(angle) * length;
    const endY = startY + Math.sin(angle) * length;

    const newDistance = distanceFromTrunk + length;

    const branch = new Branch(startX, startY, endX, endY, generation, newDistance);
    branches.push(branch);

    // Add leaves to terminal and near-terminal branches
    if (generation > 6) {
        const numLeaves = 2 + Math.floor(Math.random() * 3);
        for (let i = 0; i < numLeaves; i++) {
            const leafX = endX + (Math.random() - 0.5) * 10;
            const leafY = endY + (Math.random() - 0.5) * 10;
            const leaf = new BranchLeaf(leafX, leafY, newDistance, 0); // maxDistance set later
            branch.addLeaf(leaf);
            allLeaves.push(leaf);
        }
    }

    // Create child branches
    if (generation < 9) {
        const numChildren = generation < 2 ? 2 : (Math.random() > 0.6 ? 2 : 1);

        for (let i = 0; i < numChildren; i++) {
            const angleVariation = (Math.random() - 0.5) * Math.PI / 2.5;
            const newAngle = angle + angleVariation + (i === 0 ? -Math.PI / 6 : Math.PI / 6);
            const newLength = length * (0.65 + Math.random() * 0.15);

            const childBranch = createTree(endX, endY, newAngle, newLength, generation + 1, newDistance);
            if (childBranch) {
                branch.addChild(childBranch);
            }
        }
    }

    return branch;
}

// Build tree
const trunkX = canvas.width / 2;
const trunkY = canvas.height - 50;
createTree(trunkX, trunkY, -Math.PI / 2, 120, 0, 0);

// Set max distance for all leaves
allLeaves.forEach(leaf => {
    leaf.maxDistance = maxDistanceFromTrunk;
    leaf.normalizedDistance = leaf.distanceFromTrunk / maxDistanceFromTrunk;
});

// Animation state
let progressWave = 0; // 0 to 1

// Visualize progress wave
function drawProgressWave() {
    // Draw rings showing the progression
    const rings = 5;
    for (let i = 0; i < rings; i++) {
        const ringProgress = progressWave - (i * 0.1);
        if (ringProgress >= 0 && ringProgress <= 1) {
            const radius = (1 - ringProgress) * maxDistanceFromTrunk;
            const opacity = 1 - (i * 0.15);

            ctx.strokeStyle = `rgba(255, 100, 0, ${opacity * 0.3})`;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(trunkX, trunkY, radius, 0, Math.PI * 2);
            ctx.stroke();
        }
    }
}

// Animation loop
function animate() {
    // Background
    const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    gradient.addColorStop(0, '#B0C4DE');
    gradient.addColorStop(1, '#F5DEB3');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Ground
    ctx.fillStyle = '#8B7355';
    ctx.fillRect(0, canvas.height - 50, canvas.width, 50);

    // Progress wave visualization
    drawProgressWave();

    // Draw branches
    branches.forEach(branch => branch.draw());

    // Draw leaves
    allLeaves.forEach(leaf => leaf.draw(progressWave));

    // Update progress
    progressWave += 0.002;
    if (progressWave > 1.1) {
        progressWave = 0; // Restart
    }

    // Draw progress indicator
    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
    ctx.font = '18px Arial';
    ctx.textAlign = 'center';
    const progressPercent = Math.round(progressWave * 100);
    ctx.fillText(`Wave Progress: ${Math.min(100, progressPercent)}%`, canvas.width / 2, canvas.height - 20);

    // Draw legend
    ctx.font = '14px Arial';
    ctx.fillText('ðŸ”´ Outer branches (tips) change first', canvas.width / 2, canvas.height - 80);
    ctx.fillText('ðŸŸ¢ Inner branches (near trunk) change last', canvas.width / 2, canvas.height - 60);

    requestAnimationFrame(animate);
}

animate();

window.addEventListener('resize', () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
});
</script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
