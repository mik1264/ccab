<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Van Allen Belt Trapping - Scientific Visualizations</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 100%);
            min-height: 100vh;
            color: #e0e0e0;
            overflow-x: hidden;
        }

        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #64b5f6;
            text-decoration: none;
            font-size: 14px;
            opacity: 0.8;
            z-index: 100;
            background: rgba(0,0,0,0.3);
            padding: 8px 16px;
            border-radius: 20px;
            transition: all 0.3s;
        }

        .back-link:hover {
            opacity: 1;
            background: rgba(0,0,0,0.5);
        }

        header {
            text-align: center;
            padding: 60px 20px 20px;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #64b5f6, #42a5f5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: #90caf9;
            font-size: 1rem;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .panel {
            background: rgba(0,0,0,0.3);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(100, 181, 246, 0.2);
        }

        .main-panel {
            flex: 1;
            min-width: 550px;
        }

        .side-panel {
            width: 350px;
        }

        .panel-title {
            font-size: 1rem;
            color: #64b5f6;
            margin-bottom: 15px;
            text-align: center;
        }

        canvas {
            display: block;
            margin: 0 auto;
            border-radius: 8px;
        }

        .controls {
            width: 320px;
        }

        .control-group {
            margin-bottom: 18px;
        }

        .control-group label {
            display: block;
            font-size: 0.85rem;
            color: #90caf9;
            margin-bottom: 8px;
        }

        .control-group input[type="range"] {
            width: 100%;
            height: 6px;
            background: rgba(100, 181, 246, 0.2);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #64b5f6;
            border-radius: 50%;
            cursor: pointer;
        }

        .stats {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            margin-bottom: 6px;
        }

        .stat-label {
            color: #90caf9;
        }

        .stat-value {
            color: #64b5f6;
            font-weight: 600;
        }

        .stat-value.trapped {
            color: #66bb6a;
        }

        .stat-value.lost {
            color: #ff5252;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 15px;
            font-size: 0.8rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 50%;
        }

        .particle-select {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .particle-btn {
            flex: 1;
            padding: 10px;
            background: rgba(100, 181, 246, 0.1);
            border: 1px solid rgba(100, 181, 246, 0.3);
            color: #90caf9;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .particle-btn.active {
            background: rgba(100, 181, 246, 0.3);
            border-color: #64b5f6;
            color: #fff;
        }

        .info-panel {
            background: rgba(0,0,0,0.3);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(100, 181, 246, 0.2);
            max-width: 1360px;
            margin: 20px auto;
        }

        .info-panel h3 {
            color: #64b5f6;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .info-panel p {
            font-size: 0.9rem;
            line-height: 1.6;
            color: #b0bec5;
            margin-bottom: 10px;
        }

        .motion-types {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .motion-type {
            background: rgba(100, 181, 246, 0.1);
            padding: 10px 15px;
            border-radius: 8px;
            flex: 1;
            min-width: 150px;
        }

        .motion-type h4 {
            color: #64b5f6;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .motion-type p {
            font-size: 0.8rem;
            margin: 0;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                align-items: center;
            }

            .main-panel, .side-panel, .controls {
                width: 100%;
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back to Gallery</a>

    <header>
        <h1>Van Allen Belt Trapping</h1>
        <p class="subtitle">Charged particles spiraling, bouncing, and drifting in Earth's magnetic field</p>
    </header>

    <div class="container">
        <div class="panel main-panel">
            <h3 class="panel-title">Meridional Cross-Section</h3>
            <canvas id="mainCanvas" width="550" height="450"></canvas>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #4fc3f7;"></div>
                    <span>Field lines</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff5252;"></div>
                    <span>Inner belt (protons)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #64b5f6;"></div>
                    <span>Outer belt (electrons)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffeb3b;"></div>
                    <span>Particle</span>
                </div>
            </div>
        </div>

        <div class="panel side-panel">
            <h3 class="panel-title">Pitch Angle & Loss Cone</h3>
            <canvas id="pitchCanvas" width="300" height="250"></canvas>
            <div style="margin-top: 15px;">
                <h3 class="panel-title">Bounce Motion</h3>
                <canvas id="bounceCanvas" width="300" height="120"></canvas>
            </div>
        </div>

        <div class="panel controls">
            <div class="particle-select">
                <button class="particle-btn active" id="electronBtn">Electron</button>
                <button class="particle-btn" id="protonBtn">Proton</button>
            </div>

            <div class="control-group">
                <label>L-Shell (R<sub>eq</sub>/R<sub>E</sub>): <span id="LVal">4</span></label>
                <input type="range" id="LSlider" min="1.5" max="8" value="4" step="0.1">
            </div>

            <div class="control-group">
                <label>Equatorial Pitch Angle α<sub>eq</sub>: <span id="pitchVal">45</span>°</label>
                <input type="range" id="pitchSlider" min="1" max="89" value="45" step="1">
            </div>

            <div class="control-group">
                <label>Particle Energy: <span id="energyVal">1</span> MeV</label>
                <input type="range" id="energySlider" min="0.1" max="10" value="1" step="0.1">
            </div>

            <div class="control-group">
                <label>Animation Speed: <span id="speedVal">1</span>x</label>
                <input type="range" id="speedSlider" min="0.1" max="3" value="1" step="0.1">
            </div>

            <div class="stats">
                <div class="stat-row">
                    <span class="stat-label">Status:</span>
                    <span class="stat-value" id="status">Trapped</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Loss cone angle:</span>
                    <span class="stat-value" id="lossCone">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Mirror latitude:</span>
                    <span class="stat-value" id="mirrorLat">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Gyro period:</span>
                    <span class="stat-value" id="gyroPeriod">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Bounce period:</span>
                    <span class="stat-value" id="bouncePeriod">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Drift period:</span>
                    <span class="stat-value" id="driftPeriod">-</span>
                </div>
            </div>
        </div>
    </div>

    <div class="info-panel">
        <h3>Trapped Particle Dynamics</h3>
        <p>
            Discovered by James Van Allen in 1958, Earth's radiation belts contain energetic charged
            particles trapped by the dipole magnetic field. Particles execute three types of periodic motion,
            each associated with an adiabatic invariant.
        </p>
        <div class="motion-types">
            <div class="motion-type">
                <h4>1. Gyration (μs)</h4>
                <p>Particles spiral around field lines due to the Lorentz force. Gyro-radius ∝ energy/B.</p>
            </div>
            <div class="motion-type">
                <h4>2. Bounce (0.1-1s)</h4>
                <p>Magnetic mirror effect reflects particles at high latitudes. Mirror point depends on pitch angle.</p>
            </div>
            <div class="motion-type">
                <h4>3. Drift (minutes-hours)</h4>
                <p>Gradient and curvature drifts cause azimuthal motion. Electrons drift east, protons west.</p>
            </div>
        </div>
        <p style="margin-top: 15px;">
            <strong>Loss Cone:</strong> Particles with pitch angles smaller than the loss cone angle (~few degrees
            at L=6) will mirror within the atmosphere and be lost through collisions. This creates the auroral
            precipitation that lights up the polar skies.
        </p>
    </div>

    <script>
        const mainCanvas = document.getElementById('mainCanvas');
        const mainCtx = mainCanvas.getContext('2d');
        const pitchCanvas = document.getElementById('pitchCanvas');
        const pitchCtx = pitchCanvas.getContext('2d');
        const bounceCanvas = document.getElementById('bounceCanvas');
        const bounceCtx = bounceCanvas.getContext('2d');

        // Constants
        const RE = 6371; // Earth radius in km
        const B0 = 3.1e-5; // Surface B at equator in Tesla
        const q_e = 1.6e-19; // Elementary charge
        const m_e = 9.1e-31; // Electron mass
        const m_p = 1.67e-27; // Proton mass
        const c = 3e8; // Speed of light

        // Parameters
        let isElectron = true;
        let L = 4; // L-shell
        let pitchAngle = 45; // Degrees
        let energy = 1; // MeV
        let speed = 1;

        let time = 0;

        // Controls
        document.getElementById('electronBtn').addEventListener('click', () => {
            isElectron = true;
            document.getElementById('electronBtn').classList.add('active');
            document.getElementById('protonBtn').classList.remove('active');
            update();
        });

        document.getElementById('protonBtn').addEventListener('click', () => {
            isElectron = false;
            document.getElementById('protonBtn').classList.add('active');
            document.getElementById('electronBtn').classList.remove('active');
            update();
        });

        document.getElementById('LSlider').addEventListener('input', (e) => {
            L = parseFloat(e.target.value);
            document.getElementById('LVal').textContent = L.toFixed(1);
            update();
        });

        document.getElementById('pitchSlider').addEventListener('input', (e) => {
            pitchAngle = parseFloat(e.target.value);
            document.getElementById('pitchVal').textContent = pitchAngle;
            update();
        });

        document.getElementById('energySlider').addEventListener('input', (e) => {
            energy = parseFloat(e.target.value);
            document.getElementById('energyVal').textContent = energy.toFixed(1);
            update();
        });

        document.getElementById('speedSlider').addEventListener('input', (e) => {
            speed = parseFloat(e.target.value);
            document.getElementById('speedVal').textContent = speed.toFixed(1);
        });

        function lossConeAngle(Lval) {
            // sin²(α_loss) = 1 / √(4L⁶ - 3L⁵)
            // Simplified: α_loss ≈ arcsin(1/L^1.5) for L >> 1
            const sinAlpha = Math.pow(L, -1.5);
            return Math.asin(Math.min(1, sinAlpha)) * 180 / Math.PI;
        }

        function mirrorLatitude(alphaEq) {
            // At mirror point: sin²(α_eq) = B_eq/B_m = cos⁶(λ_m) / √(1 + 3sin²(λ_m))
            // Approximate solution
            const sinAlpha = Math.sin(alphaEq * Math.PI / 180);

            // Iterate to find λ_m
            for (let lambda = 0; lambda < 90; lambda += 0.5) {
                const lamRad = lambda * Math.PI / 180;
                const cosLam = Math.cos(lamRad);
                const sinLam = Math.sin(lamRad);
                const ratio = Math.pow(cosLam, 6) / Math.sqrt(1 + 3 * sinLam * sinLam);

                if (ratio <= sinAlpha * sinAlpha) {
                    return lambda;
                }
            }
            return 90;
        }

        function isTrapped() {
            return pitchAngle > lossConeAngle(L);
        }

        function update() {
            const lossCone = lossConeAngle(L);
            const mirrorLat = mirrorLatitude(pitchAngle);
            const trapped = isTrapped();

            // Update stats
            document.getElementById('status').textContent = trapped ? 'Trapped' : 'Lost to atmosphere';
            document.getElementById('status').className = 'stat-value ' + (trapped ? 'trapped' : 'lost');
            document.getElementById('lossCone').textContent = lossCone.toFixed(1) + '°';
            document.getElementById('mirrorLat').textContent = mirrorLat.toFixed(1) + '°';

            // Compute periods
            const mass = isElectron ? m_e : m_p;
            const charge = q_e;
            const B_eq = B0 / Math.pow(L, 3); // Equatorial B field at L-shell

            // Gyro period: T_g = 2πm / (qB)
            const gamma = 1 + energy * 1e6 * q_e / (mass * c * c); // Relativistic factor
            const T_gyro = 2 * Math.PI * gamma * mass / (charge * B_eq);

            // Bounce period (approximate): T_b ≈ L * RE * 4 / v
            const v = c * Math.sqrt(1 - 1 / (gamma * gamma));
            const T_bounce = 4 * L * RE * 1000 / v * (1.3 - 0.56 * Math.sin(pitchAngle * Math.PI / 180));

            // Drift period (approximate): T_d ≈ 2π * L * RE / v_drift
            // v_drift ≈ (3/2) * (E * L) / (q * B0 * RE)
            const E_joules = energy * 1e6 * q_e;
            const v_drift = 3 * E_joules * L / (2 * charge * B0 * RE * 1000);
            const T_drift = 2 * Math.PI * L * RE * 1000 / v_drift;

            document.getElementById('gyroPeriod').textContent =
                T_gyro < 1e-6 ? (T_gyro * 1e9).toFixed(1) + ' ns' :
                T_gyro < 1e-3 ? (T_gyro * 1e6).toFixed(1) + ' μs' :
                (T_gyro * 1e3).toFixed(1) + ' ms';

            document.getElementById('bouncePeriod').textContent =
                T_bounce < 1 ? (T_bounce * 1000).toFixed(0) + ' ms' :
                T_bounce.toFixed(2) + ' s';

            document.getElementById('driftPeriod').textContent =
                T_drift < 60 ? T_drift.toFixed(0) + ' s' :
                T_drift < 3600 ? (T_drift / 60).toFixed(1) + ' min' :
                (T_drift / 3600).toFixed(1) + ' hr';

            drawPitch();
        }

        function drawMain() {
            const ctx = mainCtx;
            const W = mainCanvas.width;
            const H = mainCanvas.height;
            const cx = W / 2;
            const cy = H / 2;
            const scale = 50; // Pixels per Earth radius

            // Clear
            ctx.fillStyle = '#0a0a1a';
            ctx.fillRect(0, 0, W, H);

            // Draw Earth
            const earthGrad = ctx.createRadialGradient(cx, cy, 0, cx, cy, scale);
            earthGrad.addColorStop(0, '#2e7d32');
            earthGrad.addColorStop(0.5, '#1565c0');
            earthGrad.addColorStop(1, '#0d47a1');
            ctx.beginPath();
            ctx.arc(cx, cy, scale, 0, Math.PI * 2);
            ctx.fillStyle = earthGrad;
            ctx.fill();

            // Draw magnetic field lines
            ctx.strokeStyle = 'rgba(79, 195, 247, 0.3)';
            ctx.lineWidth = 1;

            for (let Lval = 2; Lval <= 8; Lval += 1) {
                ctx.beginPath();
                for (let theta = -Math.PI / 2; theta <= Math.PI / 2; theta += 0.02) {
                    const r = Lval * Math.cos(theta) * Math.cos(theta) * scale;
                    const x = cx + r * Math.cos(theta);
                    const y = cy - r * Math.sin(theta);

                    if (r >= scale) { // Only draw outside Earth
                        if (theta === -Math.PI / 2) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    }
                }
                ctx.stroke();

                // Southern hemisphere
                ctx.beginPath();
                for (let theta = Math.PI / 2; theta <= 3 * Math.PI / 2; theta += 0.02) {
                    const adjustedTheta = theta - Math.PI;
                    const r = Lval * Math.cos(adjustedTheta) * Math.cos(adjustedTheta) * scale;
                    const x = cx + r * Math.cos(theta);
                    const y = cy - r * Math.sin(theta);

                    if (r >= scale) {
                        if (theta === Math.PI / 2) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    }
                }
                ctx.stroke();
            }

            // Draw radiation belts (simplified torus cross-sections)
            // Inner belt: L ~ 1.5-2.5
            ctx.fillStyle = 'rgba(255, 82, 82, 0.15)';
            ctx.beginPath();
            ctx.ellipse(cx + 2 * scale, cy, 0.6 * scale, 0.4 * scale, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(cx - 2 * scale, cy, 0.6 * scale, 0.4 * scale, 0, 0, Math.PI * 2);
            ctx.fill();

            // Outer belt: L ~ 3-7
            ctx.fillStyle = 'rgba(100, 181, 246, 0.1)';
            ctx.beginPath();
            ctx.ellipse(cx + 4.5 * scale, cy, 1.5 * scale, 1 * scale, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(cx - 4.5 * scale, cy, 1.5 * scale, 1 * scale, 0, 0, Math.PI * 2);
            ctx.fill();

            // Draw particle trajectory
            const trapped = isTrapped();
            const mirrorLat = mirrorLatitude(pitchAngle) * Math.PI / 180;

            // Bounce motion: particle oscillates between mirror points
            const bouncePhase = (time * speed * 2) % (2 * Math.PI);
            let particleLat = mirrorLat * Math.sin(bouncePhase);

            // Position on field line
            const theta = particleLat;
            const r_fieldline = L * Math.cos(theta) * Math.cos(theta) * scale;
            const particleX = cx + r_fieldline * Math.cos(theta);
            const particleY = cy - r_fieldline * Math.sin(theta);

            // Draw particle path (recent trajectory)
            ctx.strokeStyle = trapped ? 'rgba(255, 235, 59, 0.4)' : 'rgba(255, 82, 82, 0.4)';
            ctx.lineWidth = 2;
            ctx.beginPath();

            for (let t = 0; t <= 2 * Math.PI; t += 0.1) {
                const lat = mirrorLat * Math.sin(t);
                const r = L * Math.cos(lat) * Math.cos(lat) * scale;
                const x = cx + r * Math.cos(lat);
                const y = cy - r * Math.sin(lat);

                if (r >= scale) {
                    if (t === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
            }
            ctx.stroke();

            // Draw mirror points
            const mirrorR = L * Math.cos(mirrorLat) * Math.cos(mirrorLat) * scale;
            const mirrorXN = cx + mirrorR * Math.cos(mirrorLat);
            const mirrorYN = cy - mirrorR * Math.sin(mirrorLat);
            const mirrorXS = cx + mirrorR * Math.cos(-mirrorLat);
            const mirrorYS = cy - mirrorR * Math.sin(-mirrorLat);

            ctx.fillStyle = trapped ? '#66bb6a' : '#ff5252';
            if (mirrorR >= scale) {
                ctx.beginPath();
                ctx.arc(mirrorXN, mirrorYN, 5, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(mirrorXS, mirrorYS, 5, 0, Math.PI * 2);
                ctx.fill();
            }

            // Draw particle
            if (r_fieldline >= scale) {
                // Gyration spiral
                const gyroPhase = time * speed * 50;
                const gyroRadius = 3 + 2 * Math.sin(gyroPhase);

                ctx.beginPath();
                ctx.arc(particleX, particleY, gyroRadius, 0, Math.PI * 2);
                ctx.fillStyle = '#ffeb3b';
                ctx.fill();

                // Glow
                const glowGrad = ctx.createRadialGradient(
                    particleX, particleY, 0,
                    particleX, particleY, 15
                );
                glowGrad.addColorStop(0, 'rgba(255, 235, 59, 0.5)');
                glowGrad.addColorStop(1, 'rgba(255, 235, 59, 0)');
                ctx.beginPath();
                ctx.arc(particleX, particleY, 15, 0, Math.PI * 2);
                ctx.fillStyle = glowGrad;
                ctx.fill();
            }

            // Loss cone visualization (atmospheric loss)
            if (!trapped) {
                ctx.fillStyle = 'rgba(255, 82, 82, 0.3)';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('Particle lost to atmosphere!', cx, H - 20);
            }

            // Labels
            ctx.fillStyle = '#90caf9';
            ctx.font = '11px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('N', cx - 5, 25);
            ctx.fillText('S', cx - 5, H - 15);

            ctx.textAlign = 'center';
            ctx.fillText('L=' + L.toFixed(1), cx + L * scale, cy + 15);
        }

        function drawPitch() {
            const ctx = pitchCtx;
            const W = pitchCanvas.width;
            const H = pitchCanvas.height;
            const cx = W / 2;
            const cy = H / 2 + 20;
            const R = 90;

            ctx.fillStyle = '#0a0a1a';
            ctx.fillRect(0, 0, W, H);

            // Title
            ctx.fillStyle = '#90caf9';
            ctx.font = '11px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Velocity Space', cx, 15);

            // Draw velocity sphere cross-section
            ctx.strokeStyle = 'rgba(144, 202, 249, 0.3)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.arc(cx, cy, R, 0, Math.PI * 2);
            ctx.stroke();

            // Draw field line direction (vertical)
            ctx.strokeStyle = 'rgba(79, 195, 247, 0.5)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(cx, cy - R - 10);
            ctx.lineTo(cx, cy + R + 10);
            ctx.stroke();

            ctx.fillStyle = '#4fc3f7';
            ctx.font = '10px sans-serif';
            ctx.fillText('B', cx + 10, cy - R);

            // Draw loss cone
            const lossCone = lossConeAngle(L) * Math.PI / 180;

            // North loss cone
            ctx.fillStyle = 'rgba(255, 82, 82, 0.3)';
            ctx.beginPath();
            ctx.moveTo(cx, cy);
            ctx.arc(cx, cy, R, -Math.PI / 2 - lossCone, -Math.PI / 2 + lossCone);
            ctx.closePath();
            ctx.fill();

            // South loss cone
            ctx.beginPath();
            ctx.moveTo(cx, cy);
            ctx.arc(cx, cy, R, Math.PI / 2 - lossCone, Math.PI / 2 + lossCone);
            ctx.closePath();
            ctx.fill();

            // Draw trapped region
            ctx.fillStyle = 'rgba(102, 187, 106, 0.15)';
            ctx.beginPath();
            ctx.moveTo(cx, cy);
            ctx.arc(cx, cy, R, -Math.PI / 2 + lossCone, Math.PI / 2 - lossCone);
            ctx.closePath();
            ctx.fill();

            ctx.beginPath();
            ctx.moveTo(cx, cy);
            ctx.arc(cx, cy, R, Math.PI / 2 + lossCone, 3 * Math.PI / 2 - lossCone);
            ctx.closePath();
            ctx.fill();

            // Draw current pitch angle vector
            const pitchRad = pitchAngle * Math.PI / 180;
            const vx = R * Math.sin(pitchRad);
            const vy = -R * Math.cos(pitchRad);

            ctx.strokeStyle = '#ffeb3b';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(cx, cy);
            ctx.lineTo(cx + vx, cy + vy);
            ctx.stroke();

            // Arrow head
            const angle = Math.atan2(vy, vx);
            ctx.beginPath();
            ctx.moveTo(cx + vx, cy + vy);
            ctx.lineTo(cx + vx - 10 * Math.cos(angle - 0.3),
                       cy + vy - 10 * Math.sin(angle - 0.3));
            ctx.lineTo(cx + vx - 10 * Math.cos(angle + 0.3),
                       cy + vy - 10 * Math.sin(angle + 0.3));
            ctx.closePath();
            ctx.fillStyle = '#ffeb3b';
            ctx.fill();

            // Labels
            ctx.font = '10px sans-serif';
            ctx.fillStyle = '#ff5252';
            ctx.fillText('Loss Cone', cx, cy - R - 5);

            ctx.fillStyle = '#66bb6a';
            ctx.fillText('Trapped', cx + R - 20, cy);

            ctx.fillStyle = '#ffeb3b';
            ctx.fillText('α=' + pitchAngle + '°', cx + vx + 15, cy + vy);

            // Perpendicular direction label
            ctx.fillStyle = '#90caf9';
            ctx.fillText('v⊥', cx + R + 10, cy + 4);
            ctx.fillText('v∥', cx + 10, cy - R - 15);
        }

        function drawBounce() {
            const ctx = bounceCtx;
            const W = bounceCanvas.width;
            const H = bounceCanvas.height;

            ctx.fillStyle = '#0a0a1a';
            ctx.fillRect(0, 0, W, H);

            // Draw field line (horizontal representation)
            ctx.strokeStyle = 'rgba(79, 195, 247, 0.3)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(20, H / 2);
            ctx.lineTo(W - 20, H / 2);
            ctx.stroke();

            // Mirror points
            const mirrorLat = mirrorLatitude(pitchAngle);
            const mirrorPos = (mirrorLat / 90) * (W / 2 - 40);

            ctx.fillStyle = '#66bb6a';
            ctx.beginPath();
            ctx.arc(W / 2 - mirrorPos, H / 2, 6, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(W / 2 + mirrorPos, H / 2, 6, 0, Math.PI * 2);
            ctx.fill();

            // Particle position
            const bouncePhase = (time * speed * 2) % (2 * Math.PI);
            const particlePos = mirrorPos * Math.sin(bouncePhase);

            ctx.fillStyle = '#ffeb3b';
            ctx.beginPath();
            ctx.arc(W / 2 + particlePos, H / 2, 8, 0, Math.PI * 2);
            ctx.fill();

            // Labels
            ctx.fillStyle = '#90caf9';
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('North', W / 2 - mirrorPos, H / 2 - 20);
            ctx.fillText('South', W / 2 + mirrorPos, H / 2 - 20);
            ctx.fillText('Equator', W / 2, H - 10);

            // Equator marker
            ctx.strokeStyle = 'rgba(144, 202, 249, 0.5)';
            ctx.lineWidth = 1;
            ctx.setLineDash([3, 3]);
            ctx.beginPath();
            ctx.moveTo(W / 2, H / 2 - 25);
            ctx.lineTo(W / 2, H / 2 + 25);
            ctx.stroke();
            ctx.setLineDash([]);
        }

        function animate() {
            time += 0.016;
            drawMain();
            drawBounce();
            requestAnimationFrame(animate);
        }

        update();
        animate();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
