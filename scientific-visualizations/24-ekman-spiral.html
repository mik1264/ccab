<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ekman Spiral Explorer - Scientific Visualizations</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0a1628 0%, #1a3a5c 100%);
            min-height: 100vh;
            color: #e0e0e0;
            overflow-x: hidden;
        }

        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #4fc3f7;
            text-decoration: none;
            font-size: 14px;
            opacity: 0.8;
            z-index: 100;
            background: rgba(0,0,0,0.3);
            padding: 8px 16px;
            border-radius: 20px;
            transition: all 0.3s;
        }

        .back-link:hover {
            opacity: 1;
            background: rgba(0,0,0,0.5);
        }

        header {
            text-align: center;
            padding: 60px 20px 20px;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #4fc3f7, #81d4fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: #90caf9;
            font-size: 1rem;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .visualization {
            background: rgba(0,0,0,0.3);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(79, 195, 247, 0.2);
        }

        .main-viz {
            flex: 1;
            min-width: 500px;
        }

        .side-viz {
            width: 350px;
        }

        .viz-title {
            font-size: 1rem;
            color: #4fc3f7;
            margin-bottom: 15px;
            text-align: center;
        }

        canvas {
            display: block;
            margin: 0 auto;
            border-radius: 8px;
        }

        .controls {
            background: rgba(0,0,0,0.3);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(79, 195, 247, 0.2);
            width: 320px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            font-size: 0.85rem;
            color: #90caf9;
            margin-bottom: 8px;
        }

        .control-group input[type="range"] {
            width: 100%;
            height: 6px;
            background: rgba(79, 195, 247, 0.2);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #4fc3f7;
            border-radius: 50%;
            cursor: pointer;
        }

        .value-display {
            font-size: 0.8rem;
            color: #81d4fa;
            margin-top: 4px;
        }

        .hemisphere-toggle {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .hemisphere-btn {
            flex: 1;
            padding: 10px;
            background: rgba(79, 195, 247, 0.1);
            border: 1px solid rgba(79, 195, 247, 0.3);
            color: #90caf9;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .hemisphere-btn.active {
            background: rgba(79, 195, 247, 0.3);
            border-color: #4fc3f7;
            color: #fff;
        }

        .hemisphere-btn:hover {
            background: rgba(79, 195, 247, 0.2);
        }

        .stats {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            margin-bottom: 6px;
        }

        .stat-label {
            color: #90caf9;
        }

        .stat-value {
            color: #4fc3f7;
            font-weight: 600;
        }

        .info-panel {
            background: rgba(0,0,0,0.3);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(79, 195, 247, 0.2);
            max-width: 1360px;
            margin: 20px auto;
        }

        .info-panel h3 {
            color: #4fc3f7;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .info-panel p {
            font-size: 0.9rem;
            line-height: 1.6;
            color: #b0bec5;
        }

        .equation {
            font-family: 'Times New Roman', serif;
            font-style: italic;
            background: rgba(79, 195, 247, 0.1);
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            color: #e0e0e0;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                align-items: center;
            }

            .main-viz, .side-viz, .controls {
                width: 100%;
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back to Gallery</a>

    <header>
        <h1>Ekman Spiral Explorer</h1>
        <p class="subtitle">Wind-driven ocean currents deflected by Coriolis force</p>
    </header>

    <div class="container">
        <div class="visualization main-viz">
            <h3 class="viz-title">3D Perspective View</h3>
            <canvas id="mainCanvas" width="500" height="450"></canvas>
        </div>

        <div class="visualization side-viz">
            <h3 class="viz-title">Top View (Plan)</h3>
            <canvas id="topCanvas" width="300" height="300"></canvas>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>Wind Speed: <span id="windVal">10</span> m/s</label>
                <input type="range" id="windSpeed" min="1" max="30" value="10" step="0.5">
            </div>

            <div class="control-group">
                <label>Latitude: <span id="latVal">45</span>°</label>
                <input type="range" id="latitude" min="5" max="85" value="45" step="1">
            </div>

            <div class="control-group">
                <label>Eddy Viscosity (A<sub>z</sub>): <span id="viscVal">0.05</span> m²/s</label>
                <input type="range" id="viscosity" min="0.01" max="0.2" value="0.05" step="0.01">
            </div>

            <div class="control-group">
                <label>View Depth: <span id="depthVal">100</span> m</label>
                <input type="range" id="viewDepth" min="20" max="200" value="100" step="5">
            </div>

            <div class="control-group">
                <label>Hemisphere:</label>
                <div class="hemisphere-toggle">
                    <button class="hemisphere-btn active" id="northBtn">Northern</button>
                    <button class="hemisphere-btn" id="southBtn">Southern</button>
                </div>
            </div>

            <div class="stats">
                <div class="stat-row">
                    <span class="stat-label">Ekman depth (D<sub>E</sub>):</span>
                    <span class="stat-value" id="ekmanDepth">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Surface deflection:</span>
                    <span class="stat-value" id="surfaceAngle">45°</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Coriolis param (f):</span>
                    <span class="stat-value" id="coriolisParam">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Net transport dir:</span>
                    <span class="stat-value" id="transportDir">-</span>
                </div>
            </div>
        </div>
    </div>

    <div class="info-panel">
        <h3>The Ekman Spiral</h3>
        <p>
            Discovered by Fridtjof Nansen (who noticed icebergs drifting at an angle to the wind)
            and explained mathematically by Vagn Walfrid Ekman in 1902. Wind stress on the ocean
            surface creates currents that are deflected by the Coriolis effect—to the right in the
            Northern Hemisphere, left in the Southern. Each deeper layer is deflected further,
            creating a spiral pattern that decays exponentially with depth.
        </p>
        <div class="equation">
            u(z) = V₀ e^(z/D) cos(π/4 + z/D) &nbsp;&nbsp;|&nbsp;&nbsp; v(z) = V₀ e^(z/D) sin(π/4 + z/D)
        </div>
        <p>
            The <strong>Ekman depth</strong> D<sub>E</sub> = π√(2A<sub>z</sub>/f) marks where
            the current is opposite to surface flow and essentially negligible. The <strong>net
            Ekman transport</strong> is perpendicular to the wind (90° right in NH), which drives
            upwelling/downwelling and large-scale ocean gyres.
        </p>
    </div>

    <script>
        const mainCanvas = document.getElementById('mainCanvas');
        const mainCtx = mainCanvas.getContext('2d');
        const topCanvas = document.getElementById('topCanvas');
        const topCtx = topCanvas.getContext('2d');

        // Parameters
        let windSpeed = 10;
        let latitude = 45;
        let viscosity = 0.05;
        let viewDepth = 100;
        let isNorthern = true;

        // Earth's rotation rate
        const OMEGA = 7.2921e-5; // rad/s

        // Controls
        document.getElementById('windSpeed').addEventListener('input', (e) => {
            windSpeed = parseFloat(e.target.value);
            document.getElementById('windVal').textContent = windSpeed.toFixed(1);
            update();
        });

        document.getElementById('latitude').addEventListener('input', (e) => {
            latitude = parseFloat(e.target.value);
            document.getElementById('latVal').textContent = latitude;
            update();
        });

        document.getElementById('viscosity').addEventListener('input', (e) => {
            viscosity = parseFloat(e.target.value);
            document.getElementById('viscVal').textContent = viscosity.toFixed(2);
            update();
        });

        document.getElementById('viewDepth').addEventListener('input', (e) => {
            viewDepth = parseFloat(e.target.value);
            document.getElementById('depthVal').textContent = viewDepth;
            update();
        });

        document.getElementById('northBtn').addEventListener('click', () => {
            isNorthern = true;
            document.getElementById('northBtn').classList.add('active');
            document.getElementById('southBtn').classList.remove('active');
            update();
        });

        document.getElementById('southBtn').addEventListener('click', () => {
            isNorthern = false;
            document.getElementById('southBtn').classList.add('active');
            document.getElementById('northBtn').classList.remove('active');
            update();
        });

        function coriolisParameter(lat) {
            return 2 * OMEGA * Math.sin(lat * Math.PI / 180);
        }

        function ekmanDepth(f, Az) {
            return Math.PI * Math.sqrt(2 * Az / Math.abs(f));
        }

        function ekmanVelocity(z, D, V0, hemisphere) {
            // z is negative (depth below surface)
            // D is Ekman depth
            // V0 is surface velocity magnitude
            const zD = z / D;
            const decay = Math.exp(zD);
            const angle = Math.PI / 4 + zD; // 45 degrees + rotation with depth

            // In Northern Hemisphere, deflection is to the right
            // In Southern Hemisphere, deflection is to the left
            const sign = hemisphere ? 1 : -1;

            return {
                u: V0 * decay * Math.cos(angle),
                v: V0 * decay * Math.sin(angle) * sign
            };
        }

        function update() {
            const f = coriolisParameter(latitude);
            const D = ekmanDepth(f, viscosity);

            // Surface velocity (simplified)
            const V0 = windSpeed * 0.03; // Roughly 3% of wind speed

            // Update stats
            document.getElementById('ekmanDepth').textContent = D.toFixed(1) + ' m';
            document.getElementById('surfaceAngle').textContent = '45° ' + (isNorthern ? 'right' : 'left');
            document.getElementById('coriolisParam').textContent = (f * 1e4).toFixed(2) + '×10⁻⁴ s⁻¹';
            document.getElementById('transportDir').textContent = '90° ' + (isNorthern ? 'right' : 'left');

            drawMain(D, V0);
            drawTop(D, V0);
        }

        function drawMain(D, V0) {
            const ctx = mainCtx;
            const W = mainCanvas.width;
            const H = mainCanvas.height;

            ctx.fillStyle = '#0a1628';
            ctx.fillRect(0, 0, W, H);

            // Draw ocean layers (gradient)
            const gradient = ctx.createLinearGradient(0, 50, 0, H - 50);
            gradient.addColorStop(0, 'rgba(30, 136, 229, 0.3)');
            gradient.addColorStop(1, 'rgba(13, 71, 161, 0.3)');
            ctx.fillStyle = gradient;
            ctx.fillRect(50, 50, W - 100, H - 100);

            // Draw depth scale
            ctx.strokeStyle = 'rgba(144, 202, 249, 0.5)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(50, 50);
            ctx.lineTo(50, H - 50);
            ctx.stroke();

            ctx.fillStyle = '#90caf9';
            ctx.font = '11px sans-serif';
            ctx.textAlign = 'right';

            const numLayers = 10;
            for (let i = 0; i <= numLayers; i++) {
                const depth = (viewDepth / numLayers) * i;
                const y = 50 + (i / numLayers) * (H - 100);
                ctx.fillText(-depth.toFixed(0) + 'm', 45, y + 4);

                ctx.beginPath();
                ctx.moveTo(46, y);
                ctx.lineTo(50, y);
                ctx.stroke();
            }

            // Draw wind arrow at top
            const windCenterX = W / 2;
            const windCenterY = 25;
            ctx.strokeStyle = '#ffb74d';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(windCenterX - 80, windCenterY);
            ctx.lineTo(windCenterX + 80, windCenterY);
            ctx.stroke();

            // Wind arrow head
            ctx.beginPath();
            ctx.moveTo(windCenterX + 80, windCenterY);
            ctx.lineTo(windCenterX + 65, windCenterY - 8);
            ctx.lineTo(windCenterX + 65, windCenterY + 8);
            ctx.closePath();
            ctx.fillStyle = '#ffb74d';
            ctx.fill();

            ctx.font = '12px sans-serif';
            ctx.fillStyle = '#ffb74d';
            ctx.textAlign = 'center';
            ctx.fillText('Wind', windCenterX, 12);

            // Draw velocity vectors at each depth
            const layers = 15;
            const centerX = W / 2;
            const scale = 150 / V0; // Scale factor for visualization

            for (let i = 0; i <= layers; i++) {
                const z = -(viewDepth / layers) * i;
                const y = 50 + (i / layers) * (H - 100);

                const vel = ekmanVelocity(z, D, V0, isNorthern);
                const mag = Math.sqrt(vel.u * vel.u + vel.v * vel.v);

                // vel.u is "forward" (wind direction), vel.v is "right/left"
                // In 3D view: x = forward, perspective shifts with depth
                const arrowLength = mag * scale;
                const angle = Math.atan2(vel.v, vel.u);

                // Perspective projection
                const perspectiveFactor = 1 - (i / layers) * 0.3;
                const projX = centerX + vel.u * scale * perspectiveFactor;
                const projXStart = centerX - 10 * perspectiveFactor;

                // Draw vector
                const alpha = 0.4 + (1 - i / layers) * 0.6;
                ctx.strokeStyle = `rgba(79, 195, 247, ${alpha})`;
                ctx.lineWidth = 2 + (1 - i / layers) * 2;

                // Start from left side, end based on velocity
                ctx.beginPath();
                ctx.moveTo(projXStart, y);

                // Arrow endpoint
                const endX = projXStart + vel.u * scale * perspectiveFactor;
                const endY = y - vel.v * scale * 0.5 * perspectiveFactor; // y inverted, reduced for 3D effect
                ctx.lineTo(endX, endY);
                ctx.stroke();

                // Arrow head
                if (mag > 0.01) {
                    const headSize = 5 + (1 - i / layers) * 5;
                    const dx = endX - projXStart;
                    const dy = endY - y;
                    const len = Math.sqrt(dx * dx + dy * dy);
                    if (len > 0) {
                        const ux = dx / len;
                        const uy = dy / len;

                        ctx.beginPath();
                        ctx.moveTo(endX, endY);
                        ctx.lineTo(endX - ux * headSize - uy * headSize * 0.5,
                                   endY - uy * headSize + ux * headSize * 0.5);
                        ctx.lineTo(endX - ux * headSize + uy * headSize * 0.5,
                                   endY - uy * headSize - ux * headSize * 0.5);
                        ctx.closePath();
                        ctx.fillStyle = `rgba(79, 195, 247, ${alpha})`;
                        ctx.fill();
                    }
                }
            }

            // Draw Ekman depth marker
            if (D < viewDepth) {
                const ekmanY = 50 + (D / viewDepth) * (H - 100);
                ctx.strokeStyle = 'rgba(255, 183, 77, 0.7)';
                ctx.lineWidth = 1;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(50, ekmanY);
                ctx.lineTo(W - 50, ekmanY);
                ctx.stroke();
                ctx.setLineDash([]);

                ctx.fillStyle = '#ffb74d';
                ctx.textAlign = 'left';
                ctx.fillText('Ekman Depth (' + D.toFixed(1) + 'm)', W - 45, ekmanY + 4);
            }

            // Labels
            ctx.fillStyle = '#4fc3f7';
            ctx.textAlign = 'center';
            ctx.fillText('Surface', centerX, 65);
            ctx.fillStyle = '#90caf9';
            ctx.font = '10px sans-serif';
            ctx.fillText(isNorthern ? '(Northern Hemisphere)' : '(Southern Hemisphere)', centerX, H - 30);
        }

        function drawTop(D, V0) {
            const ctx = topCtx;
            const W = topCanvas.width;
            const H = topCanvas.height;
            const cx = W / 2;
            const cy = H / 2;

            ctx.fillStyle = '#0a1628';
            ctx.fillRect(0, 0, W, H);

            // Draw coordinate axes
            ctx.strokeStyle = 'rgba(144, 202, 249, 0.3)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(30, cy);
            ctx.lineTo(W - 30, cy);
            ctx.moveTo(cx, 30);
            ctx.lineTo(cx, H - 30);
            ctx.stroke();

            // Draw wind direction (East, along x-axis)
            ctx.strokeStyle = '#ffb74d';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(cx, cy);
            ctx.lineTo(W - 50, cy);
            ctx.stroke();

            // Wind arrow head
            ctx.beginPath();
            ctx.moveTo(W - 50, cy);
            ctx.lineTo(W - 65, cy - 8);
            ctx.lineTo(W - 65, cy + 8);
            ctx.closePath();
            ctx.fillStyle = '#ffb74d';
            ctx.fill();

            ctx.font = '11px sans-serif';
            ctx.fillStyle = '#ffb74d';
            ctx.textAlign = 'center';
            ctx.fillText('Wind', W - 50, cy - 15);

            // Draw spiral of velocity vectors
            const layers = 20;
            const scale = 80 / V0;

            ctx.beginPath();
            let firstPoint = true;

            for (let i = 0; i <= layers; i++) {
                const z = -(viewDepth / layers) * i;
                const vel = ekmanVelocity(z, D, V0, isNorthern);

                const x = cx + vel.u * scale;
                const y = cy - vel.v * scale; // y inverted for screen coords

                if (firstPoint) {
                    ctx.moveTo(x, y);
                    firstPoint = false;
                } else {
                    ctx.lineTo(x, y);
                }
            }

            ctx.strokeStyle = '#4fc3f7';
            ctx.lineWidth = 2;
            ctx.stroke();

            // Draw points at specific depths
            for (let i = 0; i <= layers; i += 2) {
                const z = -(viewDepth / layers) * i;
                const vel = ekmanVelocity(z, D, V0, isNorthern);

                const x = cx + vel.u * scale;
                const y = cy - vel.v * scale;

                const alpha = 0.3 + (1 - i / layers) * 0.7;
                const size = 3 + (1 - i / layers) * 4;

                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(79, 195, 247, ${alpha})`;
                ctx.fill();
            }

            // Draw surface velocity vector
            const surfVel = ekmanVelocity(0, D, V0, isNorthern);
            const surfEndX = cx + surfVel.u * scale;
            const surfEndY = cy - surfVel.v * scale;

            ctx.strokeStyle = '#81d4fa';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(cx, cy);
            ctx.lineTo(surfEndX, surfEndY);
            ctx.stroke();

            // Surface arrow head
            const dx = surfEndX - cx;
            const dy = surfEndY - cy;
            const len = Math.sqrt(dx * dx + dy * dy);
            if (len > 0) {
                const ux = dx / len;
                const uy = dy / len;
                ctx.beginPath();
                ctx.moveTo(surfEndX, surfEndY);
                ctx.lineTo(surfEndX - ux * 10 - uy * 5, surfEndY - uy * 10 + ux * 5);
                ctx.lineTo(surfEndX - ux * 10 + uy * 5, surfEndY - uy * 10 - ux * 5);
                ctx.closePath();
                ctx.fillStyle = '#81d4fa';
                ctx.fill();
            }

            // Draw net transport direction (90° to wind)
            const transportAngle = isNorthern ? -Math.PI / 2 : Math.PI / 2;
            const transportX = cx + Math.cos(transportAngle) * 60;
            const transportY = cy - Math.sin(transportAngle) * 60;

            ctx.strokeStyle = 'rgba(76, 175, 80, 0.8)';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(cx, cy);
            ctx.lineTo(transportX, transportY);
            ctx.stroke();
            ctx.setLineDash([]);

            // Transport arrow
            const tdx = transportX - cx;
            const tdy = transportY - cy;
            const tlen = Math.sqrt(tdx * tdx + tdy * tdy);
            const tux = tdx / tlen;
            const tuy = tdy / tlen;
            ctx.beginPath();
            ctx.moveTo(transportX, transportY);
            ctx.lineTo(transportX - tux * 10 - tuy * 5, transportY - tuy * 10 + tux * 5);
            ctx.lineTo(transportX - tux * 10 + tuy * 5, transportY - tuy * 10 - tux * 5);
            ctx.closePath();
            ctx.fillStyle = 'rgba(76, 175, 80, 0.8)';
            ctx.fill();

            ctx.fillStyle = '#4caf50';
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Net Transport', transportX + (isNorthern ? 0 : 0), transportY + (isNorthern ? 15 : -10));

            // Labels
            ctx.fillStyle = '#90caf9';
            ctx.font = '11px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('Surface', surfEndX + 10, surfEndY);

            ctx.textAlign = 'center';
            ctx.fillText('E', W - 20, cy + 4);
            ctx.fillText(isNorthern ? 'N' : 'S', cx, 20);

            // Depth legend
            ctx.fillStyle = '#90caf9';
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('Depth indicated by', 10, H - 25);
            ctx.fillText('size & opacity', 10, H - 12);
        }

        // Initial update
        update();
    </script>
</body>
</html>
