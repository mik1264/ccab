<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuramoto Model - Coupled Oscillators | Time & Clocks</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0e1a;
            color: #e0e0e0;
            overflow: hidden;
        }

        #canvas {
            display: block;
            background: #0a0e1a;
        }

        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #f4a261;
            text-decoration: none;
            font-size: 16px;
            font-weight: 600;
            z-index: 100;
            padding: 10px 20px;
            background: rgba(244, 162, 97, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(244, 162, 97, 0.3);
            transition: all 0.3s ease;
        }

        .back-link:hover {
            background: rgba(244, 162, 97, 0.2);
            transform: translateX(-5px);
        }

        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(20, 25, 40, 0.9);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(244, 162, 97, 0.3);
            z-index: 100;
            min-width: 280px;
        }

        .control-group {
            margin-bottom: 18px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #f4a261;
            font-size: 13px;
            font-weight: 600;
        }

        input[type="range"] {
            width: 100%;
            margin-bottom: 5px;
        }

        .value-display {
            color: #e76f51;
            font-size: 14px;
            font-weight: 600;
        }

        button {
            width: 100%;
            padding: 10px;
            background: rgba(244, 162, 97, 0.2);
            border: 1px solid rgba(244, 162, 97, 0.5);
            color: #f4a261;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        button:hover {
            background: rgba(244, 162, 97, 0.3);
        }

        .info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(20, 25, 40, 0.9);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-radius: 10px;
            border: 1px solid rgba(244, 162, 97, 0.3);
            z-index: 100;
        }

        .info-title {
            color: #f4a261;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .info-text {
            color: #e0e0e0;
            font-size: 13px;
            line-height: 1.5;
        }

        .order-param {
            font-size: 24px;
            color: #e76f51;
            font-weight: 700;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back to Time & Clocks</a>

    <canvas id="canvas"></canvas>

    <div class="controls">
        <div class="control-group">
            <label>Coupling Strength (K): <span class="value-display" id="couplingValue">0.50</span></label>
            <input type="range" id="coupling" min="0" max="200" value="50" step="1">
        </div>
        <div class="control-group">
            <label>Number of Oscillators: <span class="value-display" id="numValue">50</span></label>
            <input type="range" id="numOsc" min="10" max="200" value="50" step="1">
        </div>
        <div class="control-group">
            <label>Frequency Spread: <span class="value-display" id="spreadValue">1.00</span></label>
            <input type="range" id="spread" min="0" max="200" value="100" step="1">
        </div>
        <div class="control-group">
            <button id="resetBtn">Reset Phases</button>
        </div>
    </div>

    <div class="info">
        <div class="info-title">Synchronization Order Parameter</div>
        <div class="order-param" id="orderParam">0.00</div>
        <div class="info-text">1.00 = perfect sync, 0.00 = random</div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let width, height;
        let oscillators = [];
        let coupling = 0.5;
        let numOscillators = 50;
        let frequencySpread = 1.0;

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }

        class Oscillator {
            constructor() {
                this.phase = Math.random() * Math.PI * 2;
                // Natural frequency from Gaussian distribution
                this.naturalFreq = this.gaussianRandom() * frequencySpread;
                this.x = 0;
                this.y = 0;
            }

            gaussianRandom() {
                let u = 0, v = 0;
                while(u === 0) u = Math.random();
                while(v === 0) v = Math.random();
                return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
            }

            update(dt, avgSin, avgCos) {
                // Kuramoto model: dθ/dt = ω + K * Σsin(θⱼ - θᵢ)
                const interaction = Math.atan2(avgSin, avgCos) - this.phase;
                const dphase = this.naturalFreq + coupling * Math.sin(interaction);
                this.phase += dphase * dt;

                // Keep phase in [0, 2π]
                while(this.phase > Math.PI * 2) this.phase -= Math.PI * 2;
                while(this.phase < 0) this.phase += Math.PI * 2;
            }
        }

        function initOscillators() {
            oscillators = [];
            for(let i = 0; i < numOscillators; i++) {
                oscillators.push(new Oscillator());
            }
        }

        function calculateOrderParameter() {
            let sumSin = 0, sumCos = 0;
            for(let osc of oscillators) {
                sumSin += Math.sin(osc.phase);
                sumCos += Math.cos(osc.phase);
            }
            sumSin /= oscillators.length;
            sumCos /= oscillators.length;
            return Math.sqrt(sumSin * sumSin + sumCos * sumCos);
        }

        function update(dt) {
            // Calculate mean field
            let sumSin = 0, sumCos = 0;
            for(let osc of oscillators) {
                sumSin += Math.sin(osc.phase);
                sumCos += Math.cos(osc.phase);
            }
            const avgSin = sumSin / oscillators.length;
            const avgCos = sumCos / oscillators.length;

            // Update all oscillators
            for(let osc of oscillators) {
                osc.update(dt, avgSin, avgCos);
            }
        }

        function draw() {
            ctx.fillStyle = '#0a0e1a';
            ctx.fillRect(0, 0, width, height);

            const centerX = width / 2 - 250;
            const centerY = height / 2;
            const radius = Math.min(width, height) * 0.25;

            // Draw phase circle
            ctx.strokeStyle = 'rgba(244, 162, 97, 0.3)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
            ctx.stroke();

            // Draw oscillators as dots on circle
            for(let i = 0; i < oscillators.length; i++) {
                const osc = oscillators[i];
                const x = centerX + Math.cos(osc.phase) * radius;
                const y = centerY + Math.sin(osc.phase) * radius;

                // Color based on frequency
                const hue = 180 + (osc.naturalFreq / frequencySpread) * 60;
                ctx.fillStyle = `hsla(${hue}, 70%, 60%, 0.8)`;
                ctx.beginPath();
                ctx.arc(x, y, 5, 0, Math.PI * 2);
                ctx.fill();

                osc.x = x;
                osc.y = y;
            }

            // Draw order parameter vector
            const orderParam = calculateOrderParameter();
            let avgPhase = 0;
            let sumSin = 0, sumCos = 0;
            for(let osc of oscillators) {
                sumSin += Math.sin(osc.phase);
                sumCos += Math.cos(osc.phase);
            }
            avgPhase = Math.atan2(sumSin, sumCos);

            const arrowLen = orderParam * radius * 0.8;
            const arrowX = centerX + Math.cos(avgPhase) * arrowLen;
            const arrowY = centerY + Math.sin(avgPhase) * arrowLen;

            ctx.strokeStyle = '#e76f51';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(arrowX, arrowY);
            ctx.stroke();

            // Arrow head
            const angle = avgPhase;
            const headLen = 15;
            ctx.beginPath();
            ctx.moveTo(arrowX, arrowY);
            ctx.lineTo(
                arrowX - headLen * Math.cos(angle - Math.PI / 6),
                arrowY - headLen * Math.sin(angle - Math.PI / 6)
            );
            ctx.moveTo(arrowX, arrowY);
            ctx.lineTo(
                arrowX - headLen * Math.cos(angle + Math.PI / 6),
                arrowY - headLen * Math.sin(angle + Math.PI / 6)
            );
            ctx.stroke();

            // Draw oscilloscope traces
            const traceStartX = width / 2 + 100;
            const traceWidth = width - traceStartX - 50;
            const traceHeight = height - 100;
            const traceY = 50;

            // Background
            ctx.fillStyle = 'rgba(20, 25, 40, 0.5)';
            ctx.fillRect(traceStartX, traceY, traceWidth, traceHeight);

            // Grid
            ctx.strokeStyle = 'rgba(244, 162, 97, 0.1)';
            ctx.lineWidth = 1;
            for(let i = 0; i <= 10; i++) {
                const y = traceY + (traceHeight / 10) * i;
                ctx.beginPath();
                ctx.moveTo(traceStartX, y);
                ctx.lineTo(traceStartX + traceWidth, y);
                ctx.stroke();
            }

            // Draw traces
            const numTraces = Math.min(30, oscillators.length);
            for(let i = 0; i < numTraces; i++) {
                const osc = oscillators[i];
                const value = Math.sin(osc.phase);
                const x = traceStartX + (i / numTraces) * traceWidth;
                const y = traceY + traceHeight / 2 - value * traceHeight * 0.4;

                const hue = 180 + (osc.naturalFreq / frequencySpread) * 60;
                ctx.fillStyle = `hsla(${hue}, 70%, 60%, 0.6)`;
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, Math.PI * 2);
                ctx.fill();

                // Vertical line from center
                ctx.strokeStyle = `hsla(${hue}, 70%, 60%, 0.2)`;
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x, traceY + traceHeight / 2);
                ctx.lineTo(x, y);
                ctx.stroke();
            }

            // Center line
            ctx.strokeStyle = 'rgba(244, 162, 97, 0.3)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(traceStartX, traceY + traceHeight / 2);
            ctx.lineTo(traceStartX + traceWidth, traceY + traceHeight / 2);
            ctx.stroke();

            // Labels
            ctx.fillStyle = '#f4a261';
            ctx.font = '14px sans-serif';
            ctx.fillText('Phase Circle', centerX - 40, centerY - radius - 20);
            ctx.fillText('Oscilloscope (sin θ)', traceStartX + 10, traceY + 20);

            // Update order parameter display
            document.getElementById('orderParam').textContent = orderParam.toFixed(2);
        }

        let lastTime = performance.now();
        function animate(currentTime) {
            const dt = Math.min((currentTime - lastTime) / 1000, 0.1);
            lastTime = currentTime;

            update(dt * 2); // Speed up simulation
            draw();

            requestAnimationFrame(animate);
        }

        // Controls
        document.getElementById('coupling').addEventListener('input', (e) => {
            coupling = parseFloat(e.target.value) / 100;
            document.getElementById('couplingValue').textContent = coupling.toFixed(2);
        });

        document.getElementById('numOsc').addEventListener('input', (e) => {
            numOscillators = parseInt(e.target.value);
            document.getElementById('numValue').textContent = numOscillators;
            initOscillators();
        });

        document.getElementById('spread').addEventListener('input', (e) => {
            frequencySpread = parseFloat(e.target.value) / 100;
            document.getElementById('spreadValue').textContent = frequencySpread.toFixed(2);
            initOscillators();
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            initOscillators();
        });

        window.addEventListener('resize', resize);

        // Expose for enhance.js keyboard shortcuts
        window.reset = function() { initOscillators(); };

        resize();
        initOscillators();
        animate(performance.now());
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
