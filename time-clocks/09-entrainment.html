<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrainment - Rhythmic Forcing | Time & Clocks</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0e1a;
            color: #e0e0e0;
            overflow: hidden;
        }

        #canvas {
            display: block;
            background: #0a0e1a;
        }

        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #f4a261;
            text-decoration: none;
            font-size: 16px;
            font-weight: 600;
            z-index: 100;
            padding: 10px 20px;
            background: rgba(244, 162, 97, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(244, 162, 97, 0.3);
            transition: all 0.3s ease;
        }

        .back-link:hover {
            background: rgba(244, 162, 97, 0.2);
            transform: translateX(-5px);
        }

        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(20, 25, 40, 0.9);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(244, 162, 97, 0.3);
            z-index: 100;
            min-width: 300px;
        }

        .control-group {
            margin-bottom: 18px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #f4a261;
            font-size: 13px;
            font-weight: 600;
        }

        input[type="range"] {
            width: 100%;
            margin-bottom: 5px;
        }

        .value-display {
            color: #e76f51;
            font-size: 14px;
            font-weight: 600;
        }

        button {
            width: 100%;
            padding: 10px;
            background: rgba(244, 162, 97, 0.2);
            border: 1px solid rgba(244, 162, 97, 0.5);
            color: #f4a261;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-bottom: 8px;
        }

        button:hover {
            background: rgba(244, 162, 97, 0.3);
        }

        .info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(20, 25, 40, 0.9);
            padding: 15px 20px;
            border-radius: 10px;
            border: 1px solid rgba(244, 162, 97, 0.3);
            z-index: 100;
            max-width: 350px;
        }

        .info-title {
            color: #f4a261;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .info-text {
            color: #e0e0e0;
            font-size: 12px;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .status {
            color: #e76f51;
            font-weight: 600;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Time & Clocks</a>

    <canvas id="canvas"></canvas>

    <div class="controls">
        <div class="control-group">
            <label>External Rhythm (BPM): <span class="value-display" id="externalValue">60</span></label>
            <input type="range" id="externalFreq" min="30" max="120" value="60" step="1">
        </div>
        <div class="control-group">
            <label>Coupling Strength: <span class="value-display" id="couplingValue">0.30</span></label>
            <input type="range" id="coupling" min="0" max="100" value="30" step="1">
        </div>
        <div class="control-group">
            <label>Number of Oscillators: <span class="value-display" id="numValue">8</span></label>
            <input type="range" id="numOscillators" min="3" max="15" value="8" step="1">
        </div>
        <div class="control-group">
            <button id="enableBtn">Enable External Rhythm</button>
            <button id="resetBtn">Reset</button>
        </div>
    </div>

    <div class="info">
        <div class="info-title">Entrainment Status</div>
        <div class="info-text">
            External Rhythm: <span class="status" id="externalStatus">Disabled</span><br>
            Avg Frequency: <span class="status" id="avgFreq">-</span> BPM<br>
            Entrainment: <span class="status" id="entrainStatus">No</span>
        </div>
        <div class="info-text">
            Watch oscillators with different natural frequencies entrain (synchronize) to the
            external rhythm when coupling is strong enough.
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let width, height;
        let oscillators = [];
        let externalPhase = 0;
        let externalFreq = 1.0; // Hz (60 BPM)
        let coupling = 0.3;
        let numOscillators = 8;
        let externalEnabled = false;

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }

        class Oscillator {
            constructor(naturalFreq) {
                this.phase = Math.random() * Math.PI * 2;
                this.naturalFreq = naturalFreq; // Hz
                this.instantFreq = naturalFreq;
            }

            update(dt, externalPhase) {
                const omega = this.naturalFreq * 2 * Math.PI;

                let forcing = 0;
                if(externalEnabled) {
                    // Entrainment through phase coupling
                    forcing = coupling * Math.sin(externalPhase - this.phase);
                }

                const dphase = omega + forcing * 5;
                this.phase += dphase * dt;

                // Track instantaneous frequency
                this.instantFreq = dphase / (2 * Math.PI);

                if(this.phase > Math.PI * 2) this.phase -= Math.PI * 2;
                if(this.phase < 0) this.phase += Math.PI * 2;
            }
        }

        function initOscillators() {
            oscillators = [];
            // Create oscillators with different natural frequencies
            const baseFreq = 0.8; // Hz (48 BPM)
            const freqRange = 0.8; // Hz (48 BPM range)

            for(let i = 0; i < numOscillators; i++) {
                const naturalFreq = baseFreq + (i / (numOscillators - 1)) * freqRange;
                oscillators.push(new Oscillator(naturalFreq));
            }
        }

        function update(dt) {
            // Update external rhythm
            externalPhase += externalFreq * 2 * Math.PI * dt;
            if(externalPhase > Math.PI * 2) externalPhase -= Math.PI * 2;

            // Update all oscillators
            for(let osc of oscillators) {
                osc.update(dt, externalPhase);
            }

            // Calculate average frequency
            let avgFreq = 0;
            for(let osc of oscillators) {
                avgFreq += osc.instantFreq;
            }
            avgFreq /= oscillators.length;
            avgFreq *= 60; // Convert to BPM

            document.getElementById('avgFreq').textContent = avgFreq.toFixed(1);

            // Check entrainment
            const freqDiff = Math.abs(avgFreq - externalFreq * 60);
            const isEntrained = freqDiff < 5 && externalEnabled;
            document.getElementById('entrainStatus').textContent = isEntrained ? 'Yes' : 'No';
            document.getElementById('entrainStatus').style.color = isEntrained ? '#4ade80' : '#e76f51';
        }

        function draw() {
            ctx.fillStyle = '#0a0e1a';
            ctx.fillRect(0, 0, width, height);

            // Draw external rhythm indicator
            drawExternalRhythm(width / 2, 120, 250, 100);

            // Draw oscillators in a row
            drawOscillators(width / 2, height / 2, 700, 250);

            // Draw frequency spectrum
            drawFrequencySpectrum(100, height - 250, 300, 220);

            // Draw phase coherence over time
            drawPhaseCoherence(width / 2 + 100, height - 250, 500, 220);
        }

        function drawExternalRhythm(x, y, w, h) {
            ctx.fillStyle = 'rgba(20, 25, 40, 0.7)';
            ctx.fillRect(x - w / 2, y - h / 2, w, h);

            ctx.strokeStyle = externalEnabled ? 'rgba(244, 162, 97, 0.6)' : 'rgba(100, 100, 100, 0.3)';
            ctx.lineWidth = 3;
            ctx.strokeRect(x - w / 2, y - h / 2, w, h);

            // Draw pulsing circle
            const radius = 40;
            const pulse = Math.sin(externalPhase);
            const pulseSize = radius + pulse * 15;

            if(externalEnabled) {
                // Glow effect
                const gradient = ctx.createRadialGradient(x, y, 0, x, y, pulseSize * 1.5);
                gradient.addColorStop(0, 'rgba(244, 162, 97, 0.4)');
                gradient.addColorStop(1, 'rgba(244, 162, 97, 0)');
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(x, y, pulseSize * 1.5, 0, Math.PI * 2);
                ctx.fill();
            }

            // Circle
            ctx.fillStyle = externalEnabled ? '#f4a261' : '#555555';
            ctx.beginPath();
            ctx.arc(x, y, pulseSize, 0, Math.PI * 2);
            ctx.fill();

            ctx.strokeStyle = externalEnabled ? '#e76f51' : '#666666';
            ctx.lineWidth = 3;
            ctx.stroke();

            // Label
            ctx.fillStyle = externalEnabled ? '#f4a261' : '#888888';
            ctx.font = 'bold 16px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('External Rhythm', x, y - h / 2 - 15);

            ctx.font = '14px sans-serif';
            ctx.fillText(`${(externalFreq * 60).toFixed(0)} BPM`, x, y + h / 2 + 25);
        }

        function drawOscillators(x, y, w, h) {
            const spacing = Math.min(80, w / numOscillators);
            const startX = x - (numOscillators - 1) * spacing / 2;

            for(let i = 0; i < oscillators.length; i++) {
                const osc = oscillators[i];
                const ox = startX + i * spacing;
                const oy = y;

                // Draw oscillator
                const radius = 30;
                const pulse = Math.sin(osc.phase);
                const pulseSize = radius + pulse * 10;

                // Background circle
                ctx.strokeStyle = 'rgba(231, 111, 81, 0.3)';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(ox, oy, radius + 15, 0, Math.PI * 2);
                ctx.stroke();

                // Oscillator
                const hue = 20 + (i / numOscillators) * 40;
                ctx.fillStyle = `hsl(${hue}, 80%, 60%)`;
                ctx.beginPath();
                ctx.arc(ox, oy, pulseSize, 0, Math.PI * 2);
                ctx.fill();

                ctx.strokeStyle = `hsl(${hue}, 80%, 50%)`;
                ctx.lineWidth = 2;
                ctx.stroke();

                // Phase indicator
                const indicatorX = ox + Math.cos(osc.phase - Math.PI / 2) * pulseSize;
                const indicatorY = oy + Math.sin(osc.phase - Math.PI / 2) * pulseSize;

                ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(ox, oy);
                ctx.lineTo(indicatorX, indicatorY);
                ctx.stroke();

                // Natural frequency label
                ctx.fillStyle = '#f4a261';
                ctx.font = '11px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(`${(osc.naturalFreq * 60).toFixed(0)} BPM`, ox, oy + radius + 30);

                // Connection to external rhythm
                if(externalEnabled) {
                    const externalY = 120;
                    ctx.strokeStyle = `rgba(244, 162, 97, ${coupling * 0.3})`;
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.moveTo(ox, externalY + 50);
                    ctx.lineTo(ox, oy - radius - 15);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
            }

            // Label
            ctx.fillStyle = '#f4a261';
            ctx.font = 'bold 16px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Oscillators', x, y - 100);
        }

        function drawFrequencySpectrum(x, y, w, h) {
            ctx.fillStyle = 'rgba(20, 25, 40, 0.7)';
            ctx.fillRect(x, y, w, h);

            ctx.strokeStyle = 'rgba(244, 162, 97, 0.4)';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, w, h);

            // Draw frequency bars
            const barWidth = w / numOscillators;

            for(let i = 0; i < oscillators.length; i++) {
                const osc = oscillators[i];
                const freq = osc.instantFreq * 60; // BPM

                // Map frequency to height
                const minFreq = 40; // BPM
                const maxFreq = 120; // BPM
                const barHeight = ((freq - minFreq) / (maxFreq - minFreq)) * (h - 40);

                const hue = 20 + (i / numOscillators) * 40;
                ctx.fillStyle = `hsl(${hue}, 80%, 60%)`;
                ctx.fillRect(x + i * barWidth + 2, y + h - 20 - barHeight, barWidth - 4, barHeight);
            }

            // Draw external frequency line
            if(externalEnabled) {
                const extFreqBPM = externalFreq * 60;
                const minFreq = 40;
                const maxFreq = 120;
                const lineY = y + h - 20 - ((extFreqBPM - minFreq) / (maxFreq - minFreq)) * (h - 40);

                ctx.strokeStyle = '#f4a261';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(x, lineY);
                ctx.lineTo(x + w, lineY);
                ctx.stroke();
                ctx.setLineDash([]);

                ctx.fillStyle = '#f4a261';
                ctx.font = '10px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText('External', x + w - 5, lineY - 5);
            }

            // Label
            ctx.fillStyle = '#f4a261';
            ctx.font = 'bold 14px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Frequency Spectrum', x + w / 2, y + 15);

            ctx.font = '10px sans-serif';
            ctx.fillText('40 BPM', x + 5, y + h - 5);
            ctx.textAlign = 'right';
            ctx.fillText('120 BPM', x + w - 5, y + h - 5);
        }

        let phaseHistory = [];
        const maxPhaseHistory = 300;

        function drawPhaseCoherence(x, y, w, h) {
            ctx.fillStyle = 'rgba(20, 25, 40, 0.7)';
            ctx.fillRect(x, y, w, h);

            ctx.strokeStyle = 'rgba(244, 162, 97, 0.4)';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, w, h);

            // Calculate phase coherence
            let sumSin = 0, sumCos = 0;
            for(let osc of oscillators) {
                sumSin += Math.sin(osc.phase);
                sumCos += Math.cos(osc.phase);
            }
            const coherence = Math.sqrt(sumSin * sumSin + sumCos * sumCos) / oscillators.length;

            phaseHistory.push(coherence);
            if(phaseHistory.length > maxPhaseHistory) {
                phaseHistory.shift();
            }

            // Draw coherence plot
            if(phaseHistory.length > 1) {
                ctx.strokeStyle = '#e76f51';
                ctx.lineWidth = 3;
                ctx.beginPath();

                for(let i = 0; i < phaseHistory.length; i++) {
                    const px = x + (i / phaseHistory.length) * w;
                    const py = y + h - 20 - phaseHistory[i] * (h - 40);

                    if(i === 0) ctx.moveTo(px, py);
                    else ctx.lineTo(px, py);
                }

                ctx.stroke();

                // Glow
                ctx.strokeStyle = 'rgba(231, 111, 81, 0.3)';
                ctx.lineWidth = 6;
                ctx.stroke();
            }

            // Grid lines
            ctx.strokeStyle = 'rgba(244, 162, 97, 0.1)';
            ctx.lineWidth = 1;
            for(let i = 0; i <= 4; i++) {
                const py = y + 20 + (i / 4) * (h - 40);
                ctx.beginPath();
                ctx.moveTo(x, py);
                ctx.lineTo(x + w, py);
                ctx.stroke();
            }

            // Label
            ctx.fillStyle = '#f4a261';
            ctx.font = 'bold 14px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Phase Coherence Over Time', x + w / 2, y + 15);

            ctx.font = '10px sans-serif';
            ctx.fillText('0.0', x + 5, y + h - 5);
            ctx.fillText('1.0', x + 5, y + 25);

            // Current coherence
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'right';
            ctx.fillText(`Current: ${coherence.toFixed(2)}`, x + w - 10, y + h - 10);
        }

        let lastTime = performance.now();
        function animate(currentTime) {
            const dt = Math.min((currentTime - lastTime) / 1000, 0.05);
            lastTime = currentTime;

            update(dt);
            draw();

            requestAnimationFrame(animate);
        }

        // Controls
        document.getElementById('externalFreq').addEventListener('input', (e) => {
            const bpm = parseInt(e.target.value);
            externalFreq = bpm / 60;
            document.getElementById('externalValue').textContent = bpm;
        });

        document.getElementById('coupling').addEventListener('input', (e) => {
            coupling = parseFloat(e.target.value) / 100;
            document.getElementById('couplingValue').textContent = coupling.toFixed(2);
        });

        document.getElementById('numOscillators').addEventListener('input', (e) => {
            numOscillators = parseInt(e.target.value);
            document.getElementById('numValue').textContent = numOscillators;
            initOscillators();
        });

        const enableBtn = document.getElementById('enableBtn');
        enableBtn.addEventListener('click', () => {
            externalEnabled = !externalEnabled;
            enableBtn.textContent = externalEnabled ? 'Disable External Rhythm' : 'Enable External Rhythm';
            document.getElementById('externalStatus').textContent = externalEnabled ? 'Enabled' : 'Disabled';
            document.getElementById('externalStatus').style.color = externalEnabled ? '#4ade80' : '#e76f51';
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            initOscillators();
            phaseHistory = [];
        });

        window.addEventListener('resize', resize);

        resize();
        initOscillators();
        animate(performance.now());
    </script>
</body>
</html>
