<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circadian Rhythms | Time & Clocks</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0e1a;
            color: #e0e0e0;
            overflow: hidden;
        }

        #canvas {
            display: block;
            background: #0a0e1a;
        }

        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #f4a261;
            text-decoration: none;
            font-size: 16px;
            font-weight: 600;
            z-index: 100;
            padding: 10px 20px;
            background: rgba(244, 162, 97, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(244, 162, 97, 0.3);
            transition: all 0.3s ease;
        }

        .back-link:hover {
            background: rgba(244, 162, 97, 0.2);
            transform: translateX(-5px);
        }

        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(20, 25, 40, 0.9);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(244, 162, 97, 0.3);
            z-index: 100;
            min-width: 300px;
        }

        .control-group {
            margin-bottom: 18px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #f4a261;
            font-size: 13px;
            font-weight: 600;
        }

        input[type="range"] {
            width: 100%;
            margin-bottom: 5px;
        }

        .value-display {
            color: #e76f51;
            font-size: 14px;
            font-weight: 600;
        }

        button {
            width: 100%;
            padding: 10px;
            background: rgba(244, 162, 97, 0.2);
            border: 1px solid rgba(244, 162, 97, 0.5);
            color: #f4a261;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        button:hover {
            background: rgba(244, 162, 97, 0.3);
        }

        .info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(20, 25, 40, 0.9);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-radius: 10px;
            border: 1px solid rgba(244, 162, 97, 0.3);
            z-index: 100;
            max-width: 350px;
        }

        .info-title {
            color: #f4a261;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .info-text {
            color: #e0e0e0;
            font-size: 12px;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .status {
            color: #e76f51;
            font-weight: 600;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Time & Clocks</a>

    <canvas id="canvas"></canvas>

    <div class="controls">
        <div class="control-group">
            <label>Light Intensity: <span class="value-display" id="lightValue">1.0</span></label>
            <input type="range" id="lightIntensity" min="0" max="100" value="100" step="1">
        </div>
        <div class="control-group">
            <label>Entrainment Strength: <span class="value-display" id="entrainValue">0.30</span></label>
            <input type="range" id="entrainment" min="0" max="100" value="30" step="1">
        </div>
        <div class="control-group">
            <label>Day/Night Cycle: <span class="value-display" id="cycleValue">24.0 hrs</span></label>
            <input type="range" id="cyclePeriod" min="200" max="280" value="240" step="1">
        </div>
        <div class="control-group">
            <button id="jetlagBtn">Simulate Jet Lag (8 hrs)</button>
            <button id="resetBtn">Reset Clock</button>
        </div>
    </div>

    <div class="info">
        <div class="info-title">Circadian Clock Status</div>
        <div class="info-text">Internal Time: <span class="status" id="internalTime">12:00</span></div>
        <div class="info-text">External Time: <span class="status" id="externalTime">12:00</span></div>
        <div class="info-text">Phase Difference: <span class="status" id="phaseDiff">0.0 hrs</span></div>
        <div class="info-text">Light Level: <span class="status" id="lightLevel">Day</span></div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let width, height;

        // Circadian oscillator parameters
        let internalPhase = 0; // Internal clock phase (0 to 2œÄ = 24 hours)
        let externalPhase = 0; // External day/night cycle
        let internalPeriod = 24.5; // Natural period slightly longer than 24h
        let externalPeriod = 24.0; // External cycle
        let entrainmentStrength = 0.3;
        let lightIntensity = 1.0;

        let timeHistory = [];
        const maxHistory = 500;

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }

        function getLightLevel(phase) {
            // Day from 6am to 6pm (œÄ/4 to 5œÄ/4)
            const hour = (phase / (Math.PI * 2)) * 24;
            return (hour >= 6 && hour < 18) ? 1.0 : 0.0;
        }

        function update(dt) {
            // External cycle advances
            externalPhase += (2 * Math.PI / (externalPeriod * 3600)) * dt;
            if(externalPhase > 2 * Math.PI) externalPhase -= 2 * Math.PI;

            // Light input
            const lightLevel = getLightLevel(externalPhase) * lightIntensity;

            // Phase response curve (PRC) - light advances or delays the clock
            // Dawn light advances, dusk light delays
            const internalHour = (internalPhase / (Math.PI * 2)) * 24;
            let phaseShift = 0;

            if(lightLevel > 0.5) {
                // Morning light (advance)
                if(internalHour >= 0 && internalHour < 6) {
                    phaseShift = 0.1 * lightLevel * entrainmentStrength;
                }
                // Evening light (delay)
                else if(internalHour >= 18 && internalHour < 24) {
                    phaseShift = -0.1 * lightLevel * entrainmentStrength;
                }
            }

            // Internal oscillator advances at natural rate plus entrainment
            internalPhase += (2 * Math.PI / (internalPeriod * 3600)) * dt + phaseShift * dt;
            if(internalPhase > 2 * Math.PI) internalPhase -= 2 * Math.PI;

            // Store history
            timeHistory.push({
                internal: internalPhase,
                external: externalPhase,
                light: lightLevel
            });
            if(timeHistory.length > maxHistory) {
                timeHistory.shift();
            }
        }

        function phaseToTime(phase) {
            const hours = (phase / (Math.PI * 2)) * 24;
            const h = Math.floor(hours);
            const m = Math.floor((hours - h) * 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        function draw() {
            ctx.fillStyle = '#0a0e1a';
            ctx.fillRect(0, 0, width, height);

            const centerX = width / 2 - 200;
            const centerY = height / 2;
            const clockRadius = Math.min(width, height) * 0.2;

            // Draw external day/night cycle
            drawClock(centerX - 250, centerY, clockRadius, externalPhase, 'External (Environment)', true);

            // Draw internal circadian clock
            drawClock(centerX + 250, centerY, clockRadius, internalPhase, 'Internal (Body)', false);

            // Draw zeitgeber (time-giver) visualization
            const lightLevel = getLightLevel(externalPhase) * lightIntensity;
            drawLightIndicator(width / 2, 100, lightLevel);

            // Draw phase history plot
            drawHistoryPlot(width / 2 + 200, height - 200, 500, 150);

            // Draw hormone levels (melatonin, cortisol)
            drawHormoneLevels(50, height / 2 - 150, 180, 300);

            // Update info display
            document.getElementById('internalTime').textContent = phaseToTime(internalPhase);
            document.getElementById('externalTime').textContent = phaseToTime(externalPhase);

            const phaseDiffHours = ((internalPhase - externalPhase) / (Math.PI * 2)) * 24;
            const normalizedDiff = ((phaseDiffHours + 12) % 24) - 12;
            document.getElementById('phaseDiff').textContent = normalizedDiff.toFixed(1) + ' hrs';
            document.getElementById('lightLevel').textContent = lightLevel > 0.5 ? 'Day ‚òÄÔ∏è' : 'Night üåô';
        }

        function drawClock(x, y, radius, phase, label, isExternal) {
            // Background circle
            ctx.strokeStyle = 'rgba(244, 162, 97, 0.3)';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.stroke();

            // Day/night shading
            if(isExternal) {
                const lightLevel = getLightLevel(phase);
                ctx.fillStyle = lightLevel > 0.5
                    ? 'rgba(255, 200, 100, 0.1)'
                    : 'rgba(50, 50, 100, 0.2)';
                ctx.beginPath();
                ctx.arc(x, y, radius - 5, 0, Math.PI * 2);
                ctx.fill();
            }

            // Hour markers
            for(let i = 0; i < 24; i++) {
                const angle = (i / 24) * Math.PI * 2 - Math.PI / 2;
                const r1 = i % 6 === 0 ? radius - 20 : radius - 10;
                const r2 = radius - 5;

                ctx.strokeStyle = i % 6 === 0 ? '#f4a261' : 'rgba(244, 162, 97, 0.4)';
                ctx.lineWidth = i % 6 === 0 ? 3 : 1;
                ctx.beginPath();
                ctx.moveTo(x + Math.cos(angle) * r1, y + Math.sin(angle) * r1);
                ctx.lineTo(x + Math.cos(angle) * r2, y + Math.sin(angle) * r2);
                ctx.stroke();

                // Hour labels
                if(i % 6 === 0) {
                    ctx.fillStyle = '#f4a261';
                    ctx.font = 'bold 14px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    const labelR = radius - 35;
                    ctx.fillText(i.toString(),
                        x + Math.cos(angle) * labelR,
                        y + Math.sin(angle) * labelR);
                }
            }

            // Clock hand
            const handAngle = phase - Math.PI / 2;
            const handLength = radius - 30;
            const handX = x + Math.cos(handAngle) * handLength;
            const handY = y + Math.sin(handAngle) * handLength;

            ctx.strokeStyle = '#e76f51';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(handX, handY);
            ctx.stroke();

            // Center dot
            ctx.fillStyle = '#e76f51';
            ctx.beginPath();
            ctx.arc(x, y, 8, 0, Math.PI * 2);
            ctx.fill();

            // Label
            ctx.fillStyle = '#f4a261';
            ctx.font = 'bold 16px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(label, x, y + radius + 30);
        }

        function drawLightIndicator(x, y, lightLevel) {
            const width = 200;
            const height = 30;

            ctx.fillStyle = 'rgba(20, 25, 40, 0.8)';
            ctx.fillRect(x - width / 2, y - height / 2, width, height);

            // Light bar
            const barWidth = width * lightLevel;
            const gradient = ctx.createLinearGradient(x - width / 2, y, x + width / 2, y);
            gradient.addColorStop(0, '#1a1a2e');
            gradient.addColorStop(1, '#ffd700');

            ctx.fillStyle = gradient;
            ctx.fillRect(x - width / 2, y - height / 2, barWidth, height);

            ctx.strokeStyle = '#f4a261';
            ctx.lineWidth = 2;
            ctx.strokeRect(x - width / 2, y - height / 2, width, height);

            ctx.fillStyle = '#f4a261';
            ctx.font = 'bold 12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Light Exposure', x, y - height / 2 - 10);
        }

        function drawHistoryPlot(x, y, w, h) {
            ctx.fillStyle = 'rgba(20, 25, 40, 0.5)';
            ctx.fillRect(x - w / 2, y - h / 2, w, h);

            ctx.strokeStyle = 'rgba(244, 162, 97, 0.3)';
            ctx.lineWidth = 1;
            ctx.strokeRect(x - w / 2, y - h / 2, w, h);

            if(timeHistory.length < 2) return;

            // Plot internal and external phases
            ctx.lineWidth = 2;

            // External phase (yellow)
            ctx.strokeStyle = '#ffd700';
            ctx.beginPath();
            for(let i = 0; i < timeHistory.length; i++) {
                const px = x - w / 2 + (i / timeHistory.length) * w;
                const py = y - (timeHistory[i].external / (Math.PI * 2)) * h;
                if(i === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            }
            ctx.stroke();

            // Internal phase (orange)
            ctx.strokeStyle = '#e76f51';
            ctx.beginPath();
            for(let i = 0; i < timeHistory.length; i++) {
                const px = x - w / 2 + (i / timeHistory.length) * w;
                const py = y - (timeHistory[i].internal / (Math.PI * 2)) * h;
                if(i === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            }
            ctx.stroke();

            // Labels
            ctx.fillStyle = '#f4a261';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Phase History', x, y - h / 2 - 10);

            ctx.textAlign = 'left';
            ctx.fillStyle = '#ffd700';
            ctx.fillText('External', x - w / 2 + 10, y - h / 2 + 20);
            ctx.fillStyle = '#e76f51';
            ctx.fillText('Internal', x - w / 2 + 10, y - h / 2 + 35);
        }

        function drawHormoneLevels(x, y, w, h) {
            ctx.fillStyle = 'rgba(20, 25, 40, 0.5)';
            ctx.fillRect(x, y, w, h);

            ctx.strokeStyle = 'rgba(244, 162, 97, 0.3)';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, w, h);

            const internalHour = (internalPhase / (Math.PI * 2)) * 24;

            // Melatonin (peaks at night)
            const melatonin = Math.max(0, Math.cos((internalHour - 3) * Math.PI / 12));
            const melatoninHeight = melatonin * (h / 2 - 20);

            ctx.fillStyle = 'rgba(100, 100, 200, 0.5)';
            ctx.fillRect(x + 30, y + h / 2 - melatoninHeight, 50, melatoninHeight);

            // Cortisol (peaks in morning)
            const cortisol = Math.max(0, -Math.cos((internalHour - 8) * Math.PI / 12));
            const cortisolHeight = cortisol * (h / 2 - 20);

            ctx.fillStyle = 'rgba(200, 100, 100, 0.5)';
            ctx.fillRect(x + 100, y + h / 2 - cortisolHeight, 50, cortisolHeight);

            // Labels
            ctx.fillStyle = '#f4a261';
            ctx.font = 'bold 12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Hormone Levels', x + w / 2, y + 15);

            ctx.font = '11px sans-serif';
            ctx.fillStyle = 'rgba(100, 100, 200, 0.9)';
            ctx.fillText('Melatonin', x + 55, y + h - 10);
            ctx.fillStyle = 'rgba(200, 100, 100, 0.9)';
            ctx.fillText('Cortisol', x + 125, y + h - 10);
        }

        let lastTime = performance.now();
        function animate(currentTime) {
            const dt = Math.min((currentTime - lastTime) / 1000, 0.1);
            lastTime = currentTime;

            // Speed up time (1 second = 1 minute)
            update(dt * 60);
            draw();

            requestAnimationFrame(animate);
        }

        // Controls
        document.getElementById('lightIntensity').addEventListener('input', (e) => {
            lightIntensity = parseFloat(e.target.value) / 100;
            document.getElementById('lightValue').textContent = lightIntensity.toFixed(1);
        });

        document.getElementById('entrainment').addEventListener('input', (e) => {
            entrainmentStrength = parseFloat(e.target.value) / 100;
            document.getElementById('entrainValue').textContent = entrainmentStrength.toFixed(2);
        });

        document.getElementById('cyclePeriod').addEventListener('input', (e) => {
            externalPeriod = parseFloat(e.target.value) / 10;
            document.getElementById('cycleValue').textContent = externalPeriod.toFixed(1) + ' hrs';
        });

        document.getElementById('jetlagBtn').addEventListener('click', () => {
            // Shift external time by 8 hours (simulate flying east)
            externalPhase += (8 / 24) * Math.PI * 2;
            if(externalPhase > 2 * Math.PI) externalPhase -= 2 * Math.PI;
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            internalPhase = 0;
            externalPhase = 0;
            timeHistory = [];
        });

        window.addEventListener('resize', resize);

        resize();
        animate(performance.now());
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
