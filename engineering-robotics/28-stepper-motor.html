<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stepper Motor Physics - CCAB</title>
    <link rel="stylesheet" href="../assets/css/gallery-standard.css">
    <style>
        body {
            background: #e2e8f0;
            color: #333;
            font-family: system-ui;
            padding: 2rem;
            text-align: center;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        
        canvas {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .controls {
            margin-top: 20px;
            display: inline-block;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
        }
        
        button {
            padding: 10px 20px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
        }
        button:hover { background: #2563eb; }
        
        .coil-status {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        .coil-box {
            padding: 10px;
            background: #ccc;
            border-radius: 4px;
            font-weight: bold;
        }
        .coil-box.active { background: #ef4444; color: white; }
        
    </style>
</head>
<body>

<div class="container">
    <a href="../index.html" class="gallery-back">‚Üê Back to Gallery</a>
    <h1>Stepper Motor Visualization</h1>
    <p>Simulating a bipolar stepper motor. Energize coils in sequence to rotate the magnet.</p>
    
    <canvas id="canvas" width="600" height="600"></canvas>
    
    <div class="controls">
        <button onclick="step(1)">Step CW</button>
        <button onclick="step(-1)">Step CCW</button>
        <button onclick="toggleAuto()">Auto Rotate</button>
        
        <div class="coil-status">
            <div id="coil-A" class="coil-box">Coil A</div>
            <div id="coil-B" class="coil-box">Coil B</div>
            <div id="coil-C" class="coil-box">Coil C (A')</div>
            <div id="coil-D" class="coil-box">Coil D (B')</div>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    // Motor State
    let rotorAngle = 0; // Radians
    let currentStep = 0; // 0-3 (Full Step Sequence)
    // Sequence: A, B, A', B' (Single Phase)
    // Or A+B, B+A', A'+B', B'+A (Two Phase)
    // Let's implement Two-Phase on (Full Step)
    
    // Coils: Top, Right, Bottom, Left
    // 0: Top (A), 1: Right (B), 2: Bottom (A'), 3: Left (B')
    
    const sequences = [
        [1, 0, 0, 0], // A
        [0, 1, 0, 0], // B
        [0, 0, 1, 0], // A'
        [0, 0, 0, 1]  // B'
    ];
    // This is Wave Drive.
    
    let activeCoils = sequences[0];
    let targetAngle = 0;
    let autoInterval = null;
    
    function step(dir) {
        currentStep += dir;
        if (currentStep < 0) currentStep = 3;
        if (currentStep > 3) currentStep = 0;
        
        activeCoils = sequences[currentStep];
        
        // Target angle aligns with active coil
        // Top=0deg (actually -90 in canvas, let's say 0 is Right)
        // A (Top) -> -PI/2
        // B (Right) -> 0
        // A' (Bottom) -> PI/2
        // B' (Left) -> PI
        
        if (currentStep === 0) targetAngle = -Math.PI/2;
        if (currentStep === 1) targetAngle = 0;
        if (currentStep === 2) targetAngle = Math.PI/2;
        if (currentStep === 3) targetAngle = Math.PI;
        
        // Handle wrapping for smooth animation
        // If jumping from PI to -PI/2?
        // Normalize
        
        updateUI();
    }
    
    function toggleAuto() {
        if (autoInterval) {
            clearInterval(autoInterval);
            autoInterval = null;
        } else {
            autoInterval = setInterval(() => step(1), 500);
        }
    }
    
    function updateUI() {
        ['A', 'B', 'C', 'D'].forEach((id, i) => {
            const el = document.getElementById(`coil-${id}`);
            el.className = `coil-box ${activeCoils[i] ? 'active' : ''}`;
        });
    }
    
    function loop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Physics Smoothing (Spring-mass-damper towards target)
        // Simple lerp for visual
        let diff = targetAngle - rotorAngle;
        // Normalize diff to -PI to PI
        while (diff > Math.PI) diff -= Math.PI*2;
        while (diff < -Math.PI) diff += Math.PI*2;
        
        rotorAngle += diff * 0.1;
        
        // Draw Stator
        drawCoil(300, 100, activeCoils[0], "A"); // Top
        drawCoil(500, 300, activeCoils[1], "B"); // Right
        drawCoil(300, 500, activeCoils[2], "A'"); // Bottom
        drawCoil(100, 300, activeCoils[3], "B'"); // Left
        
        // Draw Rotor
        ctx.save();
        ctx.translate(300, 300);
        ctx.rotate(rotorAngle);
        
        // Magnet Body
        ctx.fillStyle = '#94a3b8';
        ctx.beginPath(); ctx.arc(0, 0, 80, 0, Math.PI*2); ctx.fill();
        
        // N / S Poles
        ctx.fillStyle = '#ef4444'; // N
        ctx.beginPath(); 
        ctx.arc(60, 0, 15, 0, Math.PI*2); 
        ctx.fill();
        ctx.fillStyle = '#fff'; ctx.fillText("N", 55, 5);
        
        ctx.fillStyle = '#3b82f6'; // S
        ctx.beginPath(); 
        ctx.arc(-60, 0, 15, 0, Math.PI*2); 
        ctx.fill();
        ctx.fillStyle = '#fff'; ctx.fillText("S", -65, 5);
        
        // Field Lines visualization (simple)
        ctx.restore();
        
        // Magnetic Field Vector (Target)
        // Show where the field is pulling
        ctx.save();
        ctx.translate(300, 300);
        ctx.rotate(targetAngle);
        ctx.strokeStyle = 'rgba(239, 68, 68, 0.3)';
        ctx.lineWidth = 10;
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(120, 0); // Arrow
        ctx.stroke();
        ctx.restore();
        
        requestAnimationFrame(loop);
    }
    
    function drawCoil(x, y, active, label) {
        ctx.fillStyle = active ? '#ef4444' : '#64748b';
        ctx.beginPath();
        ctx.arc(x, y, 40, 0, Math.PI*2);
        ctx.fill();
        
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 20px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(label, x, y);
        
        // Wire wrap visual
        ctx.strokeStyle = '#d1d5db';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(x, y, 45, 0, Math.PI*2);
        ctx.stroke();
    }
    
    updateUI();
    step(0); // Init
    requestAnimationFrame(loop);

</script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
