<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PID Controller Tuning - CCAB</title>
    <link rel="stylesheet" href="../assets/css/gallery-standard.css">
    <style>
        body {
            background: #f8fafc;
            color: #333;
            font-family: system-ui;
            padding: 2rem;
            text-align: center;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        
        canvas {
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .controls {
            margin: 20px auto;
            background: #fff;
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            max-width: 800px;
        }
        
        .knob-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        input[type=range] { width: 100%; margin: 10px 0; }
        .val-disp { font-family: monospace; font-weight: bold; color: #3b82f6; }
        
        button {
            grid-column: span 3;
            padding: 10px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover { background: #2563eb; }
        
    </style>
</head>
<body>

<div class="container">
    <a href="../index.html" class="gallery-back">‚Üê Back to Gallery</a>
    <h1>PID Controller Simulator</h1>
    <p>Tune the Proportional, Integral, and Derivative gains to stabilize the system (Blue Line) to the Setpoint (Red Line).</p>
    
    <canvas id="canvas" width="800" height="400"></canvas>
    
    <div class="controls">
        <div class="knob-group">
            <label>Proportional (Kp)</label>
            <input type="range" id="kp" min="0" max="2" step="0.01" value="0.5">
            <span id="kp-val" class="val-disp">0.50</span>
        </div>
        
        <div class="knob-group">
            <label>Integral (Ki)</label>
            <input type="range" id="ki" min="0" max="0.1" step="0.001" value="0.00">
            <span id="ki-val" class="val-disp">0.000</span>
        </div>
        
        <div class="knob-group">
            <label>Derivative (Kd)</label>
            <input type="range" id="kd" min="0" max="50" step="0.1" value="0">
            <span id="kd-val" class="val-disp">0.0</span>
        </div>
        
        <button onclick="disturb()">Add Disturbance</button>
    </div>
</div>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    // System State
    let position = 0; // Current Value
    let velocity = 0;
    let setpoint = 200; // Target Y
    
    // PID State
    let integral = 0;
    let lastError = 0;
    
    // History for Graph
    let history = [];
    const maxHistory = 800;
    
    // Sim Settings
    const dt = 1; // Time step
    const friction = 0.98; // System Damping
    const mass = 20; // System Inertia
    
    function update() {
        const Kp = parseFloat(document.getElementById('kp').value);
        const Ki = parseFloat(document.getElementById('ki').value);
        const Kd = parseFloat(document.getElementById('kd').value);
        
        document.getElementById('kp-val').textContent = Kp.toFixed(2);
        document.getElementById('ki-val').textContent = Ki.toFixed(3);
        document.getElementById('kd-val').textContent = Kd.toFixed(1);
        
        // PID Calculation
        const error = setpoint - position;
        integral += error * dt;
        const derivative = (error - lastError) / dt;
        lastError = error;
        
        const output = (Kp * error) + (Ki * integral) + (Kd * derivative);
        
        // Apply Physics (Force = Output)
        // F = ma -> a = F/m
        const acceleration = output / mass;
        velocity += acceleration * dt;
        velocity *= friction;
        position += velocity * dt;
        
        // Record
        history.push({ pos: position, set: setpoint });
        if (history.length > maxHistory) history.shift();
        
        // Dynamic Setpoint (Step response)
        if (Math.random() < 0.005) {
            setpoint = Math.random() * 300 + 50;
        }
        
        draw();
        requestAnimationFrame(update);
    }
    
    function disturb() {
        velocity += (Math.random() - 0.5) * 50;
    }
    
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Grid
        ctx.strokeStyle = '#eee';
        ctx.beginPath();
        for (let i=0; i<canvas.width; i+=50) { ctx.moveTo(i,0); ctx.lineTo(i,canvas.height); }
        for (let i=0; i<canvas.height; i+=50) { ctx.moveTo(0,i); ctx.lineTo(canvas.width,i); }
        ctx.stroke();
        
        if (history.length < 2) return;
        
        // Draw Setpoint Line (Red)
        ctx.strokeStyle = '#ef4444';
        ctx.lineWidth = 2;
        ctx.beginPath();
        history.forEach((h, i) => {
            if (i===0) ctx.moveTo(i, h.set);
            else ctx.lineTo(i, h.set);
        });
        ctx.stroke();
        
        // Draw Process Variable (Blue)
        ctx.strokeStyle = '#3b82f6';
        ctx.lineWidth = 3;
        ctx.beginPath();
        history.forEach((h, i) => {
            if (i===0) ctx.moveTo(i, h.pos);
            else ctx.lineTo(i, h.pos);
        });
        ctx.stroke();
        
        // Current Value Dot
        ctx.fillStyle = '#3b82f6';
        ctx.beginPath();
        ctx.arc(history.length-1, position, 6, 0, Math.PI*2);
        ctx.fill();
        
        // Text
        ctx.fillStyle = '#333';
        ctx.font = '14px monospace';
        ctx.fillText(`Error: ${(setpoint - position).toFixed(2)}`, 10, 20);
    }
    
    // Expose functions for enhance.js keyboard shortcuts
    window.reset = function() { position = 200; velocity = 0; integral = 0; prevError = 0; };

    // Init
    position = 200;
    requestAnimationFrame(update);

</script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
