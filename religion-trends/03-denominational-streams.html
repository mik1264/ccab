<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Denominational Trajectories - American Religious Trends</title>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&family=Nunito:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --cream: #FEFAE0;
            --earth: #DDA15E;
            --terracotta: #BC6C25;
            --sbc-red: #8B0000;
            --umc-blue: #1e3a5f;
            --catholic-purple: #6a0dad;
            --pcusa-green: #2d5a27;
            --episcopal-gold: #9b7500;
            --nondenom-orange: #d35400;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 50%, #0f1419 100%);
            color: var(--cream);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--earth);
            text-decoration: none;
            font-weight: 600;
            padding: 0.5rem 1rem;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .back-link:hover {
            background: rgba(221, 161, 94, 0.2);
            transform: translateX(-5px);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            padding-top: 80px;
        }

        .header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        h1 {
            font-family: 'Lora', serif;
            font-size: clamp(1.8rem, 4vw, 2.5rem);
            font-weight: 700;
            color: var(--cream);
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 1rem;
            color: var(--earth);
            opacity: 0.9;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.6rem 1.25rem;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            color: var(--cream);
            font-family: 'Nunito', sans-serif;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: rgba(221, 161, 94, 0.2);
            border-color: var(--earth);
        }

        .btn.active {
            background: rgba(221, 161, 94, 0.3);
            border-color: var(--earth);
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        #chart {
            width: 100%;
            height: 450px;
        }

        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .legend-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .legend-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .legend-item.active {
            border-color: var(--earth);
            background: rgba(221, 161, 94, 0.1);
        }

        .legend-item.dimmed {
            opacity: 0.3;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .legend-info {
            flex: 1;
        }

        .legend-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .legend-stats {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 0.25rem;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 0.9rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            max-width: 280px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
        }

        .tooltip-title {
            font-weight: 700;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .tooltip-year {
            color: var(--earth);
            font-weight: 600;
        }

        .insight-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 1.5rem;
            border-left: 4px solid var(--earth);
        }

        .insight-title {
            font-family: 'Lora', serif;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--earth);
        }

        .insight-text {
            font-size: 0.95rem;
            line-height: 1.6;
            opacity: 0.85;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
                padding-top: 70px;
            }

            #chart {
                height: 350px;
            }

            .legend-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Back to Gallery</a>

    <div class="container">
        <header class="header">
            <h1>Denominational Trajectories</h1>
            <p class="subtitle">Divergent fates: Mainline collapse, Evangelical plateau, Catholic churn (1950–2023)</p>
        </header>

        <div class="controls">
            <button class="btn active" data-view="all">All Traditions</button>
            <button class="btn" data-view="mainline">Mainline Collapse</button>
            <button class="btn" data-view="evangelical">Evangelical Rise</button>
            <button class="btn" data-view="catholic">Catholic Stability</button>
            <button class="btn" data-view="nondenom">Nondenominational</button>
        </div>

        <div class="chart-container">
            <div id="chart"></div>
        </div>

        <div class="legend-grid" id="legend">
            <!-- Generated dynamically -->
        </div>

        <div class="insight-panel" id="insight-panel">
            <h3 class="insight-title">Three Stories Within One Decline</h3>
            <p class="insight-text">The aggregate decline in American church membership masks three distinct narratives. The Mainline Protestant denominations have experienced catastrophic losses—the UMC alone dropping from 11 million to 4.2 million members. The Southern Baptist Convention grew through 2006 before entering sustained decline. And the Catholic Church appears stable at ~60 million adherents, though this masks severe retention challenges offset by immigration.</p>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // Denominational data (in millions)
        const denominations = {
            sbc: {
                name: "Southern Baptist Convention",
                short: "SBC",
                color: "#c23b22",
                category: "evangelical",
                data: [
                    { year: 1950, value: 7.08 },
                    { year: 1960, value: 9.73 },
                    { year: 1970, value: 11.63 },
                    { year: 1980, value: 13.70 },
                    { year: 1990, value: 15.04 },
                    { year: 2000, value: 15.96 },
                    { year: 2006, value: 16.31 },
                    { year: 2010, value: 16.14 },
                    { year: 2015, value: 15.29 },
                    { year: 2020, value: 14.09 },
                    { year: 2023, value: 12.98 }
                ],
                insight: "The SBC peaked at 16.3 million in 2006, since losing over 3 million members (20%). Despite being the largest Protestant denomination, it now faces the same demographic headwinds as the Mainline."
            },
            umc: {
                name: "United Methodist Church",
                short: "UMC",
                color: "#3498db",
                category: "mainline",
                data: [
                    { year: 1968, value: 11.00 },
                    { year: 1972, value: 10.30 },
                    { year: 1980, value: 9.50 },
                    { year: 1990, value: 8.85 },
                    { year: 2000, value: 8.30 },
                    { year: 2010, value: 7.60 },
                    { year: 2015, value: 7.00 },
                    { year: 2020, value: 6.20 },
                    { year: 2023, value: 4.20 }
                ],
                insight: "The UMC lost 22% of its membership in 2023 alone due to the schism over sexuality. It has lost 62% of members since formation in 1968—a case study in institutional collapse."
            },
            catholic: {
                name: "Catholic Church",
                short: "Catholic",
                color: "#9b59b6",
                category: "catholic",
                data: [
                    { year: 1950, value: 28.60 },
                    { year: 1960, value: 42.10 },
                    { year: 1970, value: 48.50 },
                    { year: 1980, value: 52.00 },
                    { year: 1990, value: 56.00 },
                    { year: 2000, value: 60.00 },
                    { year: 2010, value: 62.00 },
                    { year: 2020, value: 61.90 },
                    { year: 2024, value: 72.00 }
                ],
                insight: "Catholic numbers appear stable, but this masks severe retention issues: for every convert, 6 leave. Growth is sustained almost entirely by Latino immigration. Marriages dropped 78% since 1970."
            },
            pcusa: {
                name: "Presbyterian Church (USA)",
                short: "PCUSA",
                color: "#27ae60",
                category: "mainline",
                data: [
                    { year: 1965, value: 4.25 },
                    { year: 1970, value: 3.90 },
                    { year: 1983, value: 3.10 },
                    { year: 1990, value: 2.85 },
                    { year: 2000, value: 2.50 },
                    { year: 2010, value: 2.02 },
                    { year: 2015, value: 1.67 },
                    { year: 2020, value: 1.25 },
                    { year: 2023, value: 1.10 }
                ],
                insight: "The PCUSA has lost 74% of peak membership. With 88% white and 33% over age 70, it faces an existential demographic cliff within the next decade."
            },
            episcopal: {
                name: "Episcopal Church",
                short: "Episcopal",
                color: "#d4af37",
                category: "mainline",
                data: [
                    { year: 1965, value: 3.40 },
                    { year: 1970, value: 3.20 },
                    { year: 1980, value: 2.80 },
                    { year: 1990, value: 2.45 },
                    { year: 2002, value: 2.30 },
                    { year: 2010, value: 1.95 },
                    { year: 2015, value: 1.75 },
                    { year: 2020, value: 1.58 },
                    { year: 2022, value: 1.43 }
                ],
                insight: "The Episcopal Church has lost 58% of members since 1965. Once the 'church of presidents,' it now has fewer members than many individual megachurches."
            },
            nondenom: {
                name: "Nondenominational",
                short: "Nondenom",
                color: "#e67e22",
                category: "nondenom",
                data: [
                    { year: 1990, value: 5.00 },
                    { year: 2000, value: 9.00 },
                    { year: 2010, value: 14.00 },
                    { year: 2020, value: 21.10 },
                    { year: 2024, value: 23.00 }
                ],
                insight: "Nondenominational churches are now the second-largest religious body in America after Catholics. This represents a rejection of centralized hierarchy for networked, autonomous Christianity."
            }
        };

        const margin = { top: 30, right: 120, bottom: 50, left: 60 };
        let width, height;
        let selectedDenom = null;

        const svg = d3.select("#chart")
            .append("svg")
            .attr("width", "100%")
            .attr("height", "100%");

        const chartGroup = svg.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        const tooltip = d3.select("#tooltip");

        function updateDimensions() {
            const container = document.getElementById("chart");
            width = container.clientWidth - margin.left - margin.right;
            height = container.clientHeight - margin.top - margin.bottom;
        }

        function getFilteredData(view) {
            if (view === 'all') return denominations;

            const filtered = {};
            Object.entries(denominations).forEach(([key, denom]) => {
                if (denom.category === view || view === 'all') {
                    filtered[key] = denom;
                }
            });
            return filtered;
        }

        function drawChart(view = 'all') {
            chartGroup.selectAll("*").remove();

            const data = getFilteredData(view);

            // Compute scales based on visible data
            let allYears = [];
            let maxValue = 0;

            Object.values(data).forEach(denom => {
                denom.data.forEach(d => {
                    allYears.push(d.year);
                    maxValue = Math.max(maxValue, d.value);
                });
            });

            const xScale = d3.scaleLinear()
                .domain([d3.min(allYears) - 2, d3.max(allYears) + 2])
                .range([0, width]);

            const yScale = d3.scaleLinear()
                .domain([0, maxValue * 1.1])
                .range([height, 0]);

            // Axes
            chartGroup.append("g")
                .attr("class", "x-axis")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(xScale).tickFormat(d3.format("d")))
                .selectAll("text")
                .style("fill", "rgba(255,255,255,0.7)");

            chartGroup.append("g")
                .attr("class", "y-axis")
                .call(d3.axisLeft(yScale).tickFormat(d => d + "M"))
                .selectAll("text")
                .style("fill", "rgba(255,255,255,0.7)");

            chartGroup.selectAll(".x-axis path, .x-axis line, .y-axis path, .y-axis line")
                .style("stroke", "rgba(255,255,255,0.2)");

            // Y-axis label
            chartGroup.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", -45)
                .attr("x", -height / 2)
                .attr("text-anchor", "middle")
                .style("fill", "rgba(255,255,255,0.7)")
                .style("font-size", "13px")
                .text("Membership (millions)");

            // Line generator
            const line = d3.line()
                .x(d => xScale(d.year))
                .y(d => yScale(d.value))
                .curve(d3.curveMonotoneX);

            // Draw lines for each denomination
            Object.entries(data).forEach(([key, denom]) => {
                const isSelected = selectedDenom === null || selectedDenom === key;
                const opacity = isSelected ? 1 : 0.15;

                // Area under line
                const area = d3.area()
                    .x(d => xScale(d.year))
                    .y0(height)
                    .y1(d => yScale(d.value))
                    .curve(d3.curveMonotoneX);

                chartGroup.append("path")
                    .datum(denom.data)
                    .attr("class", `area-${key}`)
                    .attr("fill", denom.color)
                    .attr("fill-opacity", opacity * 0.1)
                    .attr("d", area);

                // Line
                const path = chartGroup.append("path")
                    .datum(denom.data)
                    .attr("class", `line-${key}`)
                    .attr("fill", "none")
                    .attr("stroke", denom.color)
                    .attr("stroke-width", 3)
                    .attr("opacity", opacity)
                    .attr("d", line);

                // Animate line
                const totalLength = path.node().getTotalLength();
                path.attr("stroke-dasharray", totalLength + " " + totalLength)
                    .attr("stroke-dashoffset", totalLength)
                    .transition()
                    .duration(1500)
                    .ease(d3.easeQuadOut)
                    .attr("stroke-dashoffset", 0);

                // Data points
                chartGroup.selectAll(`.point-${key}`)
                    .data(denom.data)
                    .enter()
                    .append("circle")
                    .attr("class", `point-${key}`)
                    .attr("cx", d => xScale(d.year))
                    .attr("cy", d => yScale(d.value))
                    .attr("r", 5)
                    .attr("fill", denom.color)
                    .attr("stroke", "#fff")
                    .attr("stroke-width", 2)
                    .attr("opacity", 0)
                    .transition()
                    .delay((d, i) => i * 100 + 500)
                    .duration(300)
                    .attr("opacity", opacity);

                // End label
                const lastPoint = denom.data[denom.data.length - 1];
                chartGroup.append("text")
                    .attr("class", `label-${key}`)
                    .attr("x", xScale(lastPoint.year) + 10)
                    .attr("y", yScale(lastPoint.value) + 5)
                    .style("fill", denom.color)
                    .style("font-size", "12px")
                    .style("font-weight", "600")
                    .style("opacity", 0)
                    .text(`${denom.short}: ${lastPoint.value}M`)
                    .transition()
                    .delay(1500)
                    .duration(300)
                    .style("opacity", opacity);
            });

            // Interactive hover for points
            Object.entries(data).forEach(([key, denom]) => {
                chartGroup.selectAll(`.point-${key}`)
                    .on("mouseover", function(event, d) {
                        d3.select(this).attr("r", 8);
                        tooltip.style("opacity", 1)
                            .html(`
                                <div class="tooltip-title" style="color: ${denom.color}">${denom.name}</div>
                                <div><span class="tooltip-year">${d.year}</span>: ${d.value.toFixed(2)}M members</div>
                            `)
                            .style("left", (event.pageX + 15) + "px")
                            .style("top", (event.pageY - 30) + "px");
                    })
                    .on("mouseout", function() {
                        d3.select(this).attr("r", 5);
                        tooltip.style("opacity", 0);
                    });
            });
        }

        function buildLegend() {
            const legend = document.getElementById("legend");
            legend.innerHTML = "";

            Object.entries(denominations).forEach(([key, denom]) => {
                const lastValue = denom.data[denom.data.length - 1].value;
                const firstValue = denom.data[0].value;
                const change = ((lastValue - firstValue) / firstValue * 100).toFixed(0);
                const changeSign = change >= 0 ? "+" : "";

                const item = document.createElement("div");
                item.className = "legend-item";
                item.dataset.key = key;
                item.innerHTML = `
                    <div class="legend-color" style="background: ${denom.color}"></div>
                    <div class="legend-info">
                        <div class="legend-name">${denom.name}</div>
                        <div class="legend-stats">${lastValue.toFixed(1)}M (${changeSign}${change}%)</div>
                    </div>
                `;

                item.addEventListener("click", () => {
                    document.querySelectorAll(".legend-item").forEach(el => {
                        el.classList.remove("active", "dimmed");
                    });

                    if (selectedDenom === key) {
                        selectedDenom = null;
                        updateInsight(null);
                    } else {
                        selectedDenom = key;
                        item.classList.add("active");
                        document.querySelectorAll(".legend-item").forEach(el => {
                            if (el.dataset.key !== key) el.classList.add("dimmed");
                        });
                        updateInsight(key);
                    }

                    drawChart(document.querySelector(".btn.active").dataset.view);
                });

                legend.appendChild(item);
            });
        }

        function updateInsight(key) {
            const panel = document.getElementById("insight-panel");
            if (key && denominations[key]) {
                panel.innerHTML = `
                    <h3 class="insight-title" style="color: ${denominations[key].color}">${denominations[key].name}</h3>
                    <p class="insight-text">${denominations[key].insight}</p>
                `;
            } else {
                panel.innerHTML = `
                    <h3 class="insight-title">Three Stories Within One Decline</h3>
                    <p class="insight-text">The aggregate decline in American church membership masks three distinct narratives. The Mainline Protestant denominations have experienced catastrophic losses—the UMC alone dropping from 11 million to 4.2 million members. The Southern Baptist Convention grew through 2006 before entering sustained decline. And the Catholic Church appears stable at ~60 million adherents, though this masks severe retention challenges offset by immigration.</p>
                `;
            }
        }

        // View controls
        document.querySelectorAll(".btn[data-view]").forEach(btn => {
            btn.addEventListener("click", function() {
                document.querySelectorAll(".btn").forEach(b => b.classList.remove("active"));
                this.classList.add("active");
                selectedDenom = null;
                document.querySelectorAll(".legend-item").forEach(el => {
                    el.classList.remove("active", "dimmed");
                });
                updateInsight(null);
                drawChart(this.dataset.view);
            });
        });

        // Initialize
        function init() {
            updateDimensions();
            buildLegend();
            drawChart('all');
        }

        window.addEventListener("resize", () => {
            updateDimensions();
            drawChart(document.querySelector(".btn.active").dataset.view);
        });

        init();
    </script>
</body>
</html>
