<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>pH Buffer System</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
canvas { display: block; }
.title-overlay {
    position: fixed; top: 50px; left: 50%; transform: translateX(-50%);
    color: #fbbf24; font-size: 20px; font-weight: 600; z-index: 998;
    text-shadow: 0 0 10px rgba(251,191,36,0.5); pointer-events: none;
}
.controls {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
    display: flex; gap: 12px; align-items: center; z-index: 999;
    background: rgba(0,0,0,0.7); padding: 12px 24px; border-radius: 12px;
    border: 1px solid rgba(251,191,36,0.3); flex-wrap: wrap; justify-content: center;
}
.controls button {
    background: rgba(251,191,36,0.15); color: #fbbf24; border: 1px solid rgba(251,191,36,0.4);
    padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px;
    transition: all 0.2s;
}
.controls button:hover { background: rgba(251,191,36,0.4); }
.controls button.acid { color: #ff4a6a; border-color: rgba(255,74,106,0.5); background: rgba(255,74,106,0.15); }
.controls button.acid:hover { background: rgba(255,74,106,0.3); }
.controls button.base { color: #4a9eff; border-color: rgba(74,158,255,0.5); background: rgba(74,158,255,0.15); }
.controls button.base:hover { background: rgba(74,158,255,0.3); }
.controls label { color: #ccc; font-size: 13px; }
.controls input[type=range] { width: 100px; accent-color: #fbbf24; }
.controls span { color: #fbbf24; font-size: 13px; }
</style>
</head>
<body>
<a href="../index.html" style="position:fixed;top:10px;left:10px;padding:8px 16px;background:rgba(0,0,0,0.7);color:#fbbf24;text-decoration:none;border-radius:6px;font-size:14px;z-index:999;font-family:sans-serif;">← Back to Gallery</a>
<div class="title-overlay">pH Buffer System Visualization</div>
<div class="controls">
    <button class="acid" id="addAcidBuf">+ Acid (Buffered)</button>
    <button class="base" id="addBaseBuf">+ Base (Buffered)</button>
    <span style="color:#666;">|</span>
    <button class="acid" id="addAcidUnbuf">+ Acid (Unbuffered)</button>
    <button class="base" id="addBaseUnbuf">+ Base (Unbuffered)</button>
    <span style="color:#666;">|</span>
    <label>Buffer Strength: <input type="range" id="bufferSlider" min="1" max="10" value="5"> <span id="bufVal">5</span></label>
    <button id="resetBtn">Reset</button>
</div>
<canvas id="canvas"></canvas>
<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let W, H;

function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
}
resize();
window.addEventListener('resize', resize);

let bufferStrength = 5;

// Two beaker systems
const beakers = {
    buffered: { hPlus: 30, ohMinus: 30, buffer: 40, ph: 7.0, phHistory: [], ions: [] },
    unbuffered: { hPlus: 30, ohMinus: 30, buffer: 0, ph: 7.0, phHistory: [], ions: [] }
};

class Ion {
    constructor(type, bx, by, bw, bh) {
        this.type = type; // 'H+', 'OH-', 'HA', 'A-'
        this.bx = bx; this.by = by; this.bw = bw; this.bh = bh;
        this.x = bx + 20 + Math.random() * (bw - 40);
        this.y = by + 20 + Math.random() * (bh - 40);
        const angle = Math.random() * Math.PI * 2;
        const speed = 0.5 + Math.random() * 1.5;
        this.vx = Math.cos(angle) * speed;
        this.vy = Math.sin(angle) * speed;
        this.r = type === 'HA' ? 5 : 3.5;
        this.alive = true;
    }
    update() {
        this.x += this.vx;
        this.y += this.vy;
        if (this.x < this.bx + this.r + 5) { this.x = this.bx + this.r + 5; this.vx *= -1; }
        if (this.x > this.bx + this.bw - this.r - 5) { this.x = this.bx + this.bw - this.r - 5; this.vx *= -1; }
        if (this.y < this.by + this.r + 5) { this.y = this.by + this.r + 5; this.vy *= -1; }
        if (this.y > this.by + this.bh - this.r - 5) { this.y = this.by + this.bh - this.r - 5; this.vy *= -1; }
    }
    get color() {
        switch (this.type) {
            case 'H+': return '#ff4a6a';
            case 'OH-': return '#4a9eff';
            case 'HA': return '#22c55e';
            case 'A-': return '#86efac';
            default: return '#fff';
        }
    }
}

function calcPH(beaker) {
    const hCount = beaker.ions.filter(i => i.type === 'H+').length;
    const ohCount = beaker.ions.filter(i => i.type === 'OH-').length;
    const diff = hCount - ohCount;
    // Map to pH scale
    beaker.ph = 7 - diff * 0.05;
    beaker.ph = Math.max(0, Math.min(14, beaker.ph));
}

function initBeaker(beaker, hasBuffer, bx, by, bw, bh) {
    beaker.ions = [];
    for (let i = 0; i < 30; i++) beaker.ions.push(new Ion('H+', bx, by, bw, bh));
    for (let i = 0; i < 30; i++) beaker.ions.push(new Ion('OH-', bx, by, bw, bh));
    if (hasBuffer) {
        for (let i = 0; i < bufferStrength * 8; i++) beaker.ions.push(new Ion('HA', bx, by, bw, bh));
        for (let i = 0; i < bufferStrength * 8; i++) beaker.ions.push(new Ion('A-', bx, by, bw, bh));
    }
    beaker.phHistory = [7.0];
    calcPH(beaker);
}

function getBeakerBounds(key) {
    const gap = 60;
    const bw = Math.min((W - gap * 3) / 2, 500);
    const bh = H - 250;
    const bx = key === 'buffered' ? gap : W / 2 + gap / 2;
    const by = 90;
    return { bx, by, bw, bh };
}

function init() {
    const b1 = getBeakerBounds('buffered');
    const b2 = getBeakerBounds('unbuffered');
    initBeaker(beakers.buffered, true, b1.bx, b1.by, b1.bw, b1.bh);
    initBeaker(beakers.unbuffered, false, b2.bx, b2.by, b2.bw, b2.bh);
}
init();
window.addEventListener('resize', () => { resize(); init(); });

function addIons(beakerKey, type, count) {
    const bounds = getBeakerBounds(beakerKey);
    const beaker = beakers[beakerKey];
    for (let i = 0; i < count; i++) {
        beaker.ions.push(new Ion(type, bounds.bx, bounds.by, bounds.bw, bounds.bh));
    }
    // Buffer reaction: if buffered and adding acid, buffer absorbs H+
    if (beakerKey === 'buffered') {
        if (type === 'H+') {
            // A- + H+ -> HA (buffer absorbs acid)
            let absorbed = 0;
            for (let ion of beaker.ions) {
                if (ion.type === 'A-' && absorbed < count * 0.7) {
                    ion.type = 'HA';
                    ion.r = 5;
                    absorbed++;
                }
            }
            // Remove absorbed H+
            let removed = 0;
            beaker.ions = beaker.ions.filter(ion => {
                if (ion.type === 'H+' && removed < absorbed) { removed++; return false; }
                return true;
            });
        } else if (type === 'OH-') {
            // HA + OH- -> A- + H2O (buffer absorbs base)
            let absorbed = 0;
            for (let ion of beaker.ions) {
                if (ion.type === 'HA' && absorbed < count * 0.7) {
                    ion.type = 'A-';
                    ion.r = 3.5;
                    absorbed++;
                }
            }
            let removed = 0;
            beaker.ions = beaker.ions.filter(ion => {
                if (ion.type === 'OH-' && removed < absorbed) { removed++; return false; }
                return true;
            });
        }
    }
    // Neutralization in unbuffered: H+ + OH- -> H2O
    if (beakerKey === 'unbuffered') {
        let hIons = beaker.ions.filter(i => i.type === 'H+');
        let ohIons = beaker.ions.filter(i => i.type === 'OH-');
        let neutralize = Math.min(hIons.length, ohIons.length) - 30;
        if (neutralize > 0) {
            let rem = 0;
            beaker.ions = beaker.ions.filter(ion => {
                if ((ion.type === 'H+' || ion.type === 'OH-') && rem < neutralize * 2) {
                    rem++;
                    return false;
                }
                return true;
            });
        }
    }
}

document.getElementById('addAcidBuf').addEventListener('click', () => addIons('buffered', 'H+', 15));
document.getElementById('addBaseBuf').addEventListener('click', () => addIons('buffered', 'OH-', 15));
document.getElementById('addAcidUnbuf').addEventListener('click', () => addIons('unbuffered', 'H+', 15));
document.getElementById('addBaseUnbuf').addEventListener('click', () => addIons('unbuffered', 'OH-', 15));
document.getElementById('resetBtn').addEventListener('click', init);
document.getElementById('bufferSlider').addEventListener('input', function() {
    bufferStrength = +this.value;
    document.getElementById('bufVal').textContent = this.value;
    init();
});

let frameCount = 0;
function update() {
    frameCount++;
    for (let key of ['buffered', 'unbuffered']) {
        const beaker = beakers[key];
        for (let ion of beaker.ions) ion.update();
        calcPH(beaker);
        if (frameCount % 10 === 0) {
            beaker.phHistory.push(beaker.ph);
            if (beaker.phHistory.length > 200) beaker.phHistory.shift();
        }
    }
}

function phColor(ph) {
    if (ph < 3) return '#ff1a1a';
    if (ph < 5) return '#ff6633';
    if (ph < 6) return '#ffaa00';
    if (ph < 6.5) return '#cccc00';
    if (ph < 7.5) return '#44cc44';
    if (ph < 8) return '#00cccc';
    if (ph < 9) return '#3399ff';
    if (ph < 11) return '#6633ff';
    return '#9900cc';
}

function drawBeaker(key, label) {
    const { bx, by, bw, bh } = getBeakerBounds(key);
    const beaker = beakers[key];

    // Beaker glass
    ctx.strokeStyle = 'rgba(255,255,255,0.3)';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(bx, by);
    ctx.lineTo(bx, by + bh);
    ctx.lineTo(bx + bw, by + bh);
    ctx.lineTo(bx + bw, by);
    ctx.stroke();

    // Solution tint
    const tint = phColor(beaker.ph);
    ctx.fillStyle = tint.replace(')', ', 0.08)').replace('rgb', 'rgba').replace('#', '');
    // Convert hex to rgba
    const r = parseInt(tint.slice(1, 3), 16);
    const g = parseInt(tint.slice(3, 5), 16);
    const b = parseInt(tint.slice(5, 7), 16);
    ctx.fillStyle = `rgba(${r}, ${g}, ${b}, 0.08)`;
    ctx.fillRect(bx + 2, by + 2, bw - 4, bh - 4);

    // Draw ions
    for (let ion of beaker.ions) {
        ctx.beginPath();
        ctx.arc(ion.x, ion.y, ion.r, 0, Math.PI * 2);
        ctx.fillStyle = ion.color;
        ctx.fill();
        // Label
        ctx.fillStyle = '#fff';
        ctx.font = `bold ${ion.r > 4 ? 7 : 6}px sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        if (ion.type === 'H+') ctx.fillText('H⁺', ion.x, ion.y);
        else if (ion.type === 'OH-') ctx.fillText('OH⁻', ion.x, ion.y);
        else if (ion.type === 'HA') { ctx.fillStyle = '#000'; ctx.fillText('HA', ion.x, ion.y); }
        else if (ion.type === 'A-') { ctx.fillStyle = '#000'; ctx.fillText('A⁻', ion.x, ion.y); }
    }

    // Label
    ctx.fillStyle = '#fbbf24';
    ctx.font = 'bold 16px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(label, bx + bw / 2, by - 15);

    // pH meter
    const meterX = bx + bw - 70;
    const meterY = by + 10;
    ctx.fillStyle = 'rgba(0,0,0,0.7)';
    ctx.beginPath();
    ctx.roundRect(meterX, meterY, 60, 50, 8);
    ctx.fill();
    ctx.strokeStyle = 'rgba(255,255,255,0.2)';
    ctx.stroke();
    ctx.fillStyle = '#aaa';
    ctx.font = '10px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('pH', meterX + 30, meterY + 14);
    ctx.fillStyle = phColor(beaker.ph);
    ctx.font = 'bold 20px sans-serif';
    ctx.fillText(beaker.ph.toFixed(1), meterX + 30, meterY + 38);

    // Ion counts
    const hCount = beaker.ions.filter(i => i.type === 'H+').length;
    const ohCount = beaker.ions.filter(i => i.type === 'OH-').length;
    const haCount = beaker.ions.filter(i => i.type === 'HA').length;
    const aCount = beaker.ions.filter(i => i.type === 'A-').length;

    ctx.font = '11px sans-serif';
    ctx.textAlign = 'left';
    const cy = by + bh + 20;
    ctx.fillStyle = '#ff4a6a'; ctx.fillText(`H⁺: ${hCount}`, bx, cy);
    ctx.fillStyle = '#4a9eff'; ctx.fillText(`OH⁻: ${ohCount}`, bx + 60, cy);
    if (key === 'buffered') {
        ctx.fillStyle = '#22c55e'; ctx.fillText(`HA: ${haCount}`, bx + 130, cy);
        ctx.fillStyle = '#86efac'; ctx.fillText(`A⁻: ${aCount}`, bx + 190, cy);
    }

    // pH history graph
    const gx = bx, gy = by + bh + 35, gw = bw, gh = 60;
    ctx.fillStyle = 'rgba(0,0,0,0.4)';
    ctx.fillRect(gx, gy, gw, gh);
    ctx.strokeStyle = 'rgba(255,255,255,0.1)';
    ctx.strokeRect(gx, gy, gw, gh);

    // pH 7 line
    const ph7y = gy + gh / 2;
    ctx.strokeStyle = 'rgba(255,255,255,0.15)';
    ctx.setLineDash([3, 3]);
    ctx.beginPath();
    ctx.moveTo(gx, ph7y);
    ctx.lineTo(gx + gw, ph7y);
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = '#666';
    ctx.font = '9px sans-serif';
    ctx.textAlign = 'right';
    ctx.fillText('pH 7', gx + gw - 3, ph7y - 3);
    ctx.fillText('pH 14', gx + gw - 3, gy + 10);
    ctx.fillText('pH 0', gx + gw - 3, gy + gh - 3);

    // Plot pH
    if (beaker.phHistory.length > 1) {
        ctx.beginPath();
        ctx.strokeStyle = phColor(beaker.ph);
        ctx.lineWidth = 2;
        for (let i = 0; i < beaker.phHistory.length; i++) {
            const x = gx + (i / 200) * gw;
            const y = gy + gh - (beaker.phHistory[i] / 14) * gh;
            if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
        }
        ctx.stroke();
        ctx.lineWidth = 1;
    }
}

function draw() {
    ctx.fillStyle = '#0a0e1a';
    ctx.fillRect(0, 0, W, H);

    drawBeaker('buffered', 'Buffered Solution');
    drawBeaker('unbuffered', 'Unbuffered Solution');

    // Center divider
    ctx.strokeStyle = 'rgba(251,191,36,0.2)';
    ctx.setLineDash([5, 5]);
    ctx.beginPath();
    ctx.moveTo(W / 2, 80);
    ctx.lineTo(W / 2, H - 70);
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = 'rgba(251,191,36,0.4)';
    ctx.font = '11px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('VS', W / 2, H / 2);

    // Legend
    ctx.fillStyle = 'rgba(0,0,0,0.5)';
    ctx.beginPath();
    ctx.roundRect(W / 2 - 100, H - 100, 200, 30, 6);
    ctx.fill();
    ctx.font = '10px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillStyle = '#ff4a6a'; ctx.fillText('● H⁺', W / 2 - 65, H - 82);
    ctx.fillStyle = '#4a9eff'; ctx.fillText('● OH⁻', W / 2 - 20, H - 82);
    ctx.fillStyle = '#22c55e'; ctx.fillText('● HA', W / 2 + 25, H - 82);
    ctx.fillStyle = '#86efac'; ctx.fillText('● A⁻', W / 2 + 65, H - 82);
}

function animate() {
    update();
    draw();
    requestAnimationFrame(animate);
}
animate();
</script>
</body>
</html>
