<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sound Reactive - Jensen Linkage - CCAB</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #0a0a15;
        }
        #canvas { display: block; }
        .back-link {
            position: fixed;
            top: 10px;
            left: 10px;
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.7);
            color: #fbbf24;
            text-decoration: none;
            border-radius: 6px;
            font-size: 14px;
            z-index: 999;
        }
        .start-btn {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 40px;
            background: #fbbf24;
            color: #1a1a2e;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            z-index: 1000;
        }
        .start-btn:hover { background: #f59e0b; }
        .info {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #fff;
            font-family: sans-serif;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 20px;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Gallery</a>
    <button class="start-btn" id="startBtn">Click to Enable Microphone</button>
    <div class="info" id="info" style="display: none;">Linkage responds to audio input</div>
    <canvas id="canvas"></canvas>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const startBtn = document.getElementById('startBtn');
        const info = document.getElementById('info');

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resize();
        window.addEventListener('resize', resize);

        let audioContext, analyser, dataArray;
        let audioActive = false;
        let simulatedBeat = 0;

        const linkage = {
            crankLength: 50,
            upperLeg: 140,
            lowerLeg: 140,
            connectingRod: 115,
            crankPivotX: 38,
            crankPivotY: -22
        };

        let angle = 0;
        let intensity = 0;

        startBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                source.connect(analyser);
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                audioActive = true;
                startBtn.style.display = 'none';
                info.style.display = 'block';
            } catch (e) {
                startBtn.textContent = 'Simulating Audio...';
                audioActive = false;
                setTimeout(() => {
                    startBtn.style.display = 'none';
                    info.textContent = 'Simulated audio response (no mic access)';
                    info.style.display = 'block';
                }, 1000);
            }
        });

        function getAudioIntensity() {
            if (audioActive && analyser) {
                analyser.getByteFrequencyData(dataArray);
                let sum = 0;
                for (let i = 0; i < dataArray.length; i++) {
                    sum += dataArray[i];
                }
                return sum / dataArray.length / 255;
            } else {
                // Simulate audio
                simulatedBeat += 0.05;
                return 0.3 + Math.sin(simulatedBeat) * 0.2 + Math.sin(simulatedBeat * 2.5) * 0.1;
            }
        }

        function solveJensen(angle, scale) {
            const l = linkage;
            const crankX = l.crankPivotX * scale + Math.cos(angle) * l.crankLength * scale;
            const crankY = l.crankPivotY * scale + Math.sin(angle) * l.crankLength * scale;
            const d = Math.sqrt(crankX * crankX + crankY * crankY);

            const upperLeg = l.upperLeg * scale;
            const lowerLeg = l.lowerLeg * scale;
            const connectingRod = l.connectingRod * scale;

            if (d > upperLeg + connectingRod) return null;

            const cosa = (upperLeg * upperLeg + d * d - connectingRod * connectingRod) / (2 * upperLeg * d);
            const kneeAngle = Math.atan2(crankY, crankX) - Math.acos(Math.max(-1, Math.min(1, cosa)));
            const kneeX = Math.cos(kneeAngle) * upperLeg;
            const kneeY = Math.sin(kneeAngle) * upperLeg;
            const legAngle = Math.atan2(kneeY, kneeX);
            const footX = kneeX + Math.cos(legAngle + 0.25) * lowerLeg;
            const footY = kneeY + Math.sin(legAngle + 0.25) * lowerLeg;

            return {
                crankPivot: { x: l.crankPivotX * scale, y: l.crankPivotY * scale },
                crank: { x: crankX, y: crankY },
                knee: { x: kneeX, y: kneeY },
                foot: { x: footX, y: footY }
            };
        }

        function animate() {
            intensity = intensity * 0.9 + getAudioIntensity() * 0.1;

            ctx.fillStyle = `rgba(10, 10, 21, ${0.1 + intensity * 0.2})`;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const scale = 0.8 + intensity * 0.8;
            const hue = (angle * 50) % 360;

            const p = solveJensen(angle, scale);
            if (p) {
                ctx.save();
                ctx.translate(centerX, centerY);

                // Glow based on intensity
                ctx.shadowColor = `hsl(${hue}, 100%, 60%)`;
                ctx.shadowBlur = intensity * 50;

                ctx.lineCap = 'round';

                // Links with dynamic width
                const baseWidth = 6 + intensity * 10;

                ctx.strokeStyle = `hsla(${hue}, 60%, 40%, 0.8)`;
                ctx.lineWidth = baseWidth * 0.6;
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.lineTo(p.crankPivot.x, p.crankPivot.y);
                ctx.lineTo(p.crank.x, p.crank.y);
                ctx.stroke();

                ctx.strokeStyle = `hsla(${hue + 60}, 70%, 50%, 0.9)`;
                ctx.lineWidth = baseWidth * 0.7;
                ctx.beginPath();
                ctx.moveTo(p.crank.x, p.crank.y);
                ctx.lineTo(p.knee.x, p.knee.y);
                ctx.stroke();

                ctx.strokeStyle = `hsl(${hue + 120}, 80%, 60%)`;
                ctx.lineWidth = baseWidth;
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.lineTo(p.knee.x, p.knee.y);
                ctx.lineTo(p.foot.x, p.foot.y);
                ctx.stroke();

                // Pulsing joints
                const jointPulse = 1 + intensity * 0.5;
                [[0, 0, 12], [p.crankPivot.x, p.crankPivot.y, 10], [p.crank.x, p.crank.y, 8],
                 [p.knee.x, p.knee.y, 11], [p.foot.x, p.foot.y, 14]].forEach(([x, y, r], i) => {
                    ctx.beginPath();
                    ctx.arc(x, y, r * jointPulse, 0, Math.PI * 2);
                    ctx.fillStyle = `hsl(${hue + i * 30}, 80%, ${50 + intensity * 30}%)`;
                    ctx.fill();
                });

                ctx.shadowBlur = 0;

                // Audio bars visualization
                if (analyser || !audioActive) {
                    const barCount = 16;
                    const barWidth = 8;
                    for (let i = 0; i < barCount; i++) {
                        const barAngle = (i / barCount) * Math.PI * 2;
                        const barHeight = (audioActive && dataArray ? dataArray[i * 4] / 255 :
                            0.3 + Math.sin(simulatedBeat + i * 0.5) * 0.3) * 80;

                        ctx.save();
                        ctx.rotate(barAngle);
                        ctx.translate(200, 0);

                        ctx.fillStyle = `hsla(${hue + i * 20}, 70%, 50%, 0.5)`;
                        ctx.fillRect(-barWidth / 2, -barHeight / 2, barWidth, barHeight);

                        ctx.restore();
                    }
                }

                ctx.restore();
            }

            angle += 0.02 + intensity * 0.03;
            requestAnimationFrame(animate);
        }

        animate();
    </script>
</body>
</html>
