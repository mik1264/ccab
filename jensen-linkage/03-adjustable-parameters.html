<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adjustable Jensen Linkage - CCAB</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #1a1a2e;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }
        #canvas { display: block; }
        .back-link {
            position: fixed;
            top: 10px;
            left: 10px;
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.7);
            color: #fbbf24;
            text-decoration: none;
            border-radius: 6px;
            font-size: 14px;
            z-index: 999;
        }
        .controls {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 15px;
            color: #fff;
            width: 220px;
        }
        .controls h3 {
            margin: 0 0 15px 0;
            color: #fbbf24;
            font-size: 16px;
        }
        .control-group {
            margin-bottom: 15px;
        }
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            opacity: 0.8;
        }
        .control-group input[type="range"] {
            width: 100%;
            margin: 5px 0;
        }
        .control-group .value {
            font-size: 11px;
            color: #fbbf24;
        }
        button {
            width: 100%;
            padding: 10px;
            background: #fbbf24;
            border: none;
            border-radius: 6px;
            color: #1a1a2e;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover { background: #f59e0b; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Gallery</a>
    <div class="controls">
        <h3>Linkage Parameters</h3>
        <div class="control-group">
            <label>Crank Length: <span class="value" id="v1">50</span></label>
            <input type="range" id="crankLength" min="20" max="80" value="50">
        </div>
        <div class="control-group">
            <label>Upper Leg: <span class="value" id="v2">140</span></label>
            <input type="range" id="upperLeg" min="80" max="200" value="140">
        </div>
        <div class="control-group">
            <label>Lower Leg: <span class="value" id="v3">140</span></label>
            <input type="range" id="lowerLeg" min="80" max="200" value="140">
        </div>
        <div class="control-group">
            <label>Connecting Rod: <span class="value" id="v4">110</span></label>
            <input type="range" id="connectingRod" min="60" max="160" value="110">
        </div>
        <div class="control-group">
            <label>Crank Offset X: <span class="value" id="v5">35</span></label>
            <input type="range" id="crankOffsetX" min="0" max="80" value="35">
        </div>
        <div class="control-group">
            <label>Crank Offset Y: <span class="value" id="v6">-20</span></label>
            <input type="range" id="crankOffsetY" min="-60" max="20" value="-20">
        </div>
        <div class="control-group">
            <label>Speed: <span class="value" id="v7">1.0</span>x</label>
            <input type="range" id="speed" min="0.1" max="3" step="0.1" value="1">
        </div>
        <button onclick="resetParams()">Reset to Default</button>
    </div>
    <canvas id="canvas"></canvas>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resize();
        window.addEventListener('resize', resize);

        const linkage = {
            crankLength: 50,
            upperLeg: 140,
            lowerLeg: 140,
            connectingRod: 110,
            crankPivotX: 35,
            crankPivotY: -20
        };

        let speed = 1;
        let angle = 0;
        const pathPoints = [];

        // Bind controls
        const controls = ['crankLength', 'upperLeg', 'lowerLeg', 'connectingRod'];
        controls.forEach((id, i) => {
            document.getElementById(id).addEventListener('input', (e) => {
                linkage[id] = parseInt(e.target.value);
                document.getElementById('v' + (i + 1)).textContent = e.target.value;
                pathPoints.length = 0;
            });
        });

        document.getElementById('crankOffsetX').addEventListener('input', (e) => {
            linkage.crankPivotX = parseInt(e.target.value);
            document.getElementById('v5').textContent = e.target.value;
            pathPoints.length = 0;
        });

        document.getElementById('crankOffsetY').addEventListener('input', (e) => {
            linkage.crankPivotY = parseInt(e.target.value);
            document.getElementById('v6').textContent = e.target.value;
            pathPoints.length = 0;
        });

        document.getElementById('speed').addEventListener('input', (e) => {
            speed = parseFloat(e.target.value);
            document.getElementById('v7').textContent = speed.toFixed(1);
        });

        function resetParams() {
            linkage.crankLength = 50;
            linkage.upperLeg = 140;
            linkage.lowerLeg = 140;
            linkage.connectingRod = 110;
            linkage.crankPivotX = 35;
            linkage.crankPivotY = -20;
            speed = 1;

            document.getElementById('crankLength').value = 50;
            document.getElementById('upperLeg').value = 140;
            document.getElementById('lowerLeg').value = 140;
            document.getElementById('connectingRod').value = 110;
            document.getElementById('crankOffsetX').value = 35;
            document.getElementById('crankOffsetY').value = -20;
            document.getElementById('speed').value = 1;

            for (let i = 1; i <= 6; i++) {
                const vals = [50, 140, 140, 110, 35, -20];
                document.getElementById('v' + i).textContent = vals[i - 1];
            }
            document.getElementById('v7').textContent = '1.0';
            pathPoints.length = 0;
        }

        function solveJensenLinkage(angle) {
            const l = linkage;

            const crankX = l.crankPivotX + Math.cos(angle) * l.crankLength;
            const crankY = l.crankPivotY + Math.sin(angle) * l.crankLength;

            const dx = crankX;
            const dy = crankY;
            const d = Math.sqrt(dx * dx + dy * dy);

            if (d > l.upperLeg + l.connectingRod || d < Math.abs(l.upperLeg - l.connectingRod)) {
                return null;
            }

            const cosa = (l.upperLeg * l.upperLeg + d * d - l.connectingRod * l.connectingRod) / (2 * l.upperLeg * d);
            const baseAngle = Math.atan2(dy, dx);
            const kneeAngle = baseAngle - Math.acos(Math.max(-1, Math.min(1, cosa)));

            const kneeX = Math.cos(kneeAngle) * l.upperLeg;
            const kneeY = Math.sin(kneeAngle) * l.upperLeg;

            const legAngle = Math.atan2(kneeY, kneeX);
            const footX = kneeX + Math.cos(legAngle + 0.3) * l.lowerLeg;
            const footY = kneeY + Math.sin(legAngle + 0.3) * l.lowerLeg;

            return {
                hip: { x: 0, y: 0 },
                crankPivot: { x: l.crankPivotX, y: l.crankPivotY },
                crank: { x: crankX, y: crankY },
                knee: { x: kneeX, y: kneeY },
                foot: { x: footX, y: footY }
            };
        }

        function animate() {
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const centerX = canvas.width / 2 - 100;
            const centerY = canvas.height / 2 - 30;

            const points = solveJensenLinkage(angle);

            if (points) {
                pathPoints.push({ x: points.foot.x, y: points.foot.y });
                if (pathPoints.length > 400) pathPoints.shift();

                ctx.save();
                ctx.translate(centerX, centerY);

                // Draw path
                if (pathPoints.length > 2) {
                    ctx.beginPath();
                    ctx.moveTo(pathPoints[0].x, pathPoints[0].y);
                    for (let i = 1; i < pathPoints.length; i++) {
                        ctx.lineTo(pathPoints[i].x, pathPoints[i].y);
                    }
                    ctx.strokeStyle = 'rgba(251, 191, 36, 0.6)';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }

                // Draw links
                ctx.lineCap = 'round';

                // Frame
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.lineTo(points.crankPivot.x, points.crankPivot.y);
                ctx.strokeStyle = '#4a5568';
                ctx.lineWidth = 5;
                ctx.stroke();

                // Crank
                ctx.beginPath();
                ctx.moveTo(points.crankPivot.x, points.crankPivot.y);
                ctx.lineTo(points.crank.x, points.crank.y);
                ctx.strokeStyle = '#e53e3e';
                ctx.lineWidth = 7;
                ctx.stroke();

                // Connecting rod
                ctx.beginPath();
                ctx.moveTo(points.crank.x, points.crank.y);
                ctx.lineTo(points.knee.x, points.knee.y);
                ctx.strokeStyle = '#3182ce';
                ctx.lineWidth = 6;
                ctx.stroke();

                // Upper leg
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.lineTo(points.knee.x, points.knee.y);
                ctx.strokeStyle = '#38a169';
                ctx.lineWidth = 9;
                ctx.stroke();

                // Lower leg
                ctx.beginPath();
                ctx.moveTo(points.knee.x, points.knee.y);
                ctx.lineTo(points.foot.x, points.foot.y);
                ctx.strokeStyle = '#805ad5';
                ctx.lineWidth = 9;
                ctx.stroke();

                // Joints
                [[0, 0, 12], [points.crankPivot.x, points.crankPivot.y, 10],
                 [points.crank.x, points.crank.y, 7], [points.knee.x, points.knee.y, 10],
                 [points.foot.x, points.foot.y, 10]].forEach(([x, y, r]) => {
                    ctx.beginPath();
                    ctx.arc(x, y, r, 0, Math.PI * 2);
                    ctx.fillStyle = '#2d3748';
                    ctx.fill();
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                });

                ctx.restore();
            }

            angle += 0.02 * speed;
            requestAnimationFrame(animate);
        }

        animate();
    </script>
</body>
</html>
