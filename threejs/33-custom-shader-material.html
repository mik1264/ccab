<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Shader Material - TSL Enhanced</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        canvas { display: block; }
        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: rgba(76, 201, 240, 0.8);
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-family: Arial;
            z-index: 10;
        }
        .info {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-family: Arial;
            border-radius: 5px;
            font-size: 14px;
            z-index: 10;
        }
        .info div { margin: 5px 0; }
        .tech-badge {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: #4CAF50;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            z-index: 10;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-btn">← Back</a>
    <div class="info">
        <div><strong>TSL Advanced Shading</strong></div>
        <div>Simplex Noise • Fresnel • Rim Lighting</div>
        <div>Mouse: Rotate view</div>
        <div>Scroll: Zoom</div>
    </div>
    <div class="tech-badge">Three.js TSL • Procedural Noise • Advanced Materials</div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/",
            "three/nodes": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/nodes/Nodes.js"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import {
            color,
            positionLocal,
            normalLocal,
            normalView,
            timerLocal,
            cameraPosition,
            mul,
            add,
            sin,
            cos,
            mix,
            smoothstep,
            pow,
            abs,
            dot,
            normalize,
            sub,
            vec3,
            vec4,
            float,
            length
        } from 'three/nodes';
        import { mx_fractal_noise_vec3 } from 'three/nodes';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050510);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 5;

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        // Create high-resolution icosahedron
        const geometry = new THREE.IcosahedronGeometry(2, 128);

        // TSL-based material with advanced effects
        const material = new THREE.MeshStandardNodeMaterial({
            roughness: 0.2,
            metalness: 0.8
        });

        const time = timerLocal();
        const pos = positionLocal;
        const norm = normalLocal;
        const viewNorm = normalView;

        // Multi-octave fractal noise displacement
        const noisePos1 = add(mul(pos, float(2.0)), mul(time, float(0.3)));
        const noisePos2 = add(mul(pos, float(4.0)), mul(time, float(0.2)));
        const noisePos3 = add(mul(pos, float(8.0)), mul(time, float(0.1)));

        const noise1 = mx_fractal_noise_vec3(noisePos1, float(3), float(2.0), float(0.5));
        const noise2 = mx_fractal_noise_vec3(noisePos2, float(2), float(2.0), float(0.5));
        const noise3 = mx_fractal_noise_vec3(noisePos3, float(1), float(2.0), float(0.5));

        // Combine noise octaves
        const noiseValue = add(
            mul(noise1.x, float(0.5)),
            mul(noise2.x, float(0.25)),
            mul(noise3.x, float(0.125))
        );

        // Apply displacement along normals
        const displacement = mul(noiseValue, float(0.5));
        const displacedPos = add(pos, mul(norm, displacement));
        material.positionNode = displacedPos;

        // Dynamic color based on displacement and normal
        const color1 = vec3(float(0.1), float(0.3), float(0.8)); // Blue
        const color2 = vec3(float(0.8), float(0.1), float(0.5)); // Magenta
        const color3 = vec3(float(0.2), float(0.8), float(0.4)); // Green

        // Mix colors based on displacement
        const mixFactor1 = add(mul(noiseValue, float(0.5)), float(0.5));
        const mixFactor2 = add(mul(sin(mul(time, float(0.5))), float(0.5)), float(0.5));

        let baseColor = mix(color1, color2, mixFactor1);
        baseColor = mix(baseColor, color3, mixFactor2);

        // Fresnel effect
        const viewDir = normalize(sub(cameraPosition, pos));
        const fresnel = pow(sub(float(1.0), abs(dot(viewDir, norm))), float(3.0));
        const fresnelColor = vec3(float(0.5), float(0.5), float(1.0));
        const colorWithFresnel = add(baseColor, mul(fresnelColor, fresnel));

        // Rim lighting
        const upVector = vec3(float(0.0), float(0.0), float(1.0));
        const rim = sub(float(1.0), dot(norm, upVector));
        const rimIntensity = smoothstep(float(0.6), float(1.0), rim);
        const rimColor = vec3(float(1.0), float(0.8), float(0.2));
        const finalColor = add(colorWithFresnel, mul(rimColor, rimIntensity, float(0.5)));

        material.colorNode = finalColor;

        // Emissive for extra glow
        const emissiveIntensity = mul(fresnel, float(0.3));
        material.emissiveNode = mul(finalColor, emissiveIntensity);

        const mesh = new THREE.Mesh(geometry, material);
        scene.add(mesh);

        // Add wireframe overlay with same displacement
        const wireframeGeometry = new THREE.IcosahedronGeometry(2, 128);
        const wireframeMaterial = new THREE.MeshBasicNodeMaterial({
            wireframe: true,
            transparent: true,
            opacity: 0.3
        });
        wireframeMaterial.positionNode = displacedPos;
        wireframeMaterial.colorNode = vec3(float(0.0), float(0.0), float(0.0));

        const wireframeMesh = new THREE.Mesh(wireframeGeometry, wireframeMaterial);
        scene.add(wireframeMesh);

        // Add lighting
        const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
        scene.add(ambientLight);

        const pointLight1 = new THREE.PointLight(0x4080ff, 2, 100);
        pointLight1.position.set(5, 3, 5);
        scene.add(pointLight1);

        const pointLight2 = new THREE.PointLight(0xff4080, 1.5, 100);
        pointLight2.position.set(-5, -3, 3);
        scene.add(pointLight2);

        // Animation
        function animate() {
            requestAnimationFrame(animate);

            mesh.rotation.y += 0.002;
            wireframeMesh.rotation.y += 0.002;

            // Orbit lights
            const angle = Date.now() * 0.0005;
            pointLight1.position.x = Math.cos(angle) * 7;
            pointLight1.position.z = Math.sin(angle) * 7;
            pointLight2.position.x = Math.cos(angle + Math.PI) * 7;
            pointLight2.position.z = Math.sin(angle + Math.PI) * 7;

            controls.update();
            renderer.render(scene, camera);
        }

        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
