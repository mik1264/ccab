<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barnsley Fern - IFS Fractal - CCAB</title>
    <meta name="description" content="Interactive Barnsley Fern fractal using Iterated Function Systems (IFS). Watch the fern grow point by point or explore mutant variants.">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #0a1a0a 0%, #0f1f0f 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }

        canvas {
            display: block;
        }

        .back-link {
            position: fixed;
            top: 15px;
            left: 15px;
            padding: 10px 18px;
            background: rgba(0, 0, 0, 0.6);
            color: #4caf50;
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(76, 175, 80, 0.3);
            transition: all 0.3s ease;
        }

        .back-link:hover {
            background: rgba(76, 175, 80, 0.2);
            transform: translateX(-4px);
        }

        #info {
            position: fixed;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.85);
            padding: 15px 20px;
            border-radius: 12px;
            color: #4caf50;
            font-size: 13px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(76, 175, 80, 0.2);
            z-index: 1000;
            max-width: 280px;
        }

        #info h3 {
            margin-bottom: 10px;
            color: #81c784;
        }

        #info .stat {
            margin: 5px 0;
        }

        #info .stat-label {
            color: #888;
            font-size: 11px;
        }

        #info .stat-value {
            color: #4caf50;
            font-weight: bold;
        }

        #info p {
            font-size: 11px;
            opacity: 0.8;
            line-height: 1.5;
            margin-top: 10px;
            color: #aaa;
        }

        #presets {
            position: fixed;
            top: 200px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1000;
        }

        button {
            background: rgba(76, 175, 80, 0.15);
            border: 1px solid rgba(76, 175, 80, 0.4);
            color: #4caf50;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        button:hover {
            background: rgba(76, 175, 80, 0.3);
        }

        button.active {
            background: rgba(76, 175, 80, 0.4);
            border-color: #4caf50;
        }

        #controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            z-index: 1000;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-group {
            background: rgba(0, 0, 0, 0.7);
            padding: 12px 16px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(76, 175, 80, 0.2);
        }

        .control-group label {
            color: #4caf50;
            font-size: 11px;
            display: block;
            margin-bottom: 5px;
        }

        .control-group input[type="range"] {
            width: 100px;
            accent-color: #4caf50;
        }

        .control-group span {
            color: #fff;
            font-size: 10px;
            margin-left: 6px;
        }

        #fps-display {
            position: fixed;
            bottom: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 12px;
            border-radius: 6px;
            color: #4caf50;
            font-size: 12px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <a href="../index.html" class="back-link">← Back to Gallery</a>

    <canvas id="canvas"></canvas>

    <div id="info">
        <h3>Barnsley Fern</h3>
        <div class="stat">
            <span class="stat-label">Points</span>
            <span class="stat-value" id="points">0</span>
        </div>
        <div class="stat">
            <span class="stat-label">Iterations/sec</span>
            <span class="stat-value" id="ips">0</span>
        </div>
        <div class="stat">
            <span class="stat-label">Variant</span>
            <span class="stat-value" id="variant">Classic</span>
        </div>
        <p>Iterated Function System (IFS) fractal discovered by Michael Barnsley. Each point is generated by randomly applying one of four affine transformations.</p>
    </div>

    <div id="presets">
        <button class="active" data-preset="classic">Classic Fern</button>
        <button data-preset="thelypteris">Thelypteris</button>
        <button data-preset="fishbone">Fishbone</button>
        <button data-preset="culcita">Culcita</button>
        <button data-preset="cyclosorus">Cyclosorus</button>
        <button data-preset="random">Random Mutant</button>
    </div>

    <div id="controls">
        <div class="control-group">
            <label>Speed: <span id="speed-val">10000</span>/frame</label>
            <input type="range" id="speed" min="1000" max="50000" step="1000" value="10000">
        </div>
        <div class="control-group">
            <label>Point Size: <span id="size-val">1</span>px</label>
            <input type="range" id="size" min="1" max="3" step="0.5" value="1">
        </div>
        <div class="control-group">
            <label>Color Mode: <span id="color-val">Gradient</span></label>
            <input type="range" id="color-mode" min="0" max="2" step="1" value="0">
        </div>
        <div class="control-group">
            <button id="reset">Reset</button>
        </div>
    </div>

    <div id="fps-display">FPS: <span id="fps">0</span></div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resize();
        window.addEventListener('resize', () => {
            resize();
            reset();
        });

        // DOM elements
        const pointsDisplay = document.getElementById('points');
        const ipsDisplay = document.getElementById('ips');
        const variantDisplay = document.getElementById('variant');
        const fpsDisplay = document.getElementById('fps');

        // Fern presets - each transform is [a, b, c, d, e, f, probability]
        // Transform: x' = ax + by + e, y' = cx + dy + f
        const presets = {
            classic: {
                name: 'Classic',
                transforms: [
                    { a: 0.00, b: 0.00, c: 0.00, d: 0.16, e: 0.00, f: 0.00, p: 0.01 },  // Stem
                    { a: 0.85, b: 0.04, c: -0.04, d: 0.85, e: 0.00, f: 1.60, p: 0.85 }, // Main leaflets
                    { a: 0.20, b: -0.26, c: 0.23, d: 0.22, e: 0.00, f: 1.60, p: 0.07 }, // Left leaflet
                    { a: -0.15, b: 0.28, c: 0.26, d: 0.24, e: 0.00, f: 0.44, p: 0.07 }  // Right leaflet
                ]
            },
            thelypteris: {
                name: 'Thelypteris',
                transforms: [
                    { a: 0.00, b: 0.00, c: 0.00, d: 0.25, e: 0.00, f: -0.14, p: 0.02 },
                    { a: 0.85, b: 0.02, c: -0.02, d: 0.83, e: 0.00, f: 1.00, p: 0.84 },
                    { a: 0.09, b: -0.28, c: 0.30, d: 0.11, e: 0.00, f: 0.60, p: 0.07 },
                    { a: -0.09, b: 0.28, c: 0.30, d: 0.09, e: 0.00, f: 0.70, p: 0.07 }
                ]
            },
            fishbone: {
                name: 'Fishbone',
                transforms: [
                    { a: 0.00, b: 0.00, c: 0.00, d: 0.25, e: 0.00, f: -0.4, p: 0.02 },
                    { a: 0.95, b: 0.002, c: -0.002, d: 0.93, e: -0.002, f: 0.5, p: 0.84 },
                    { a: 0.035, b: -0.11, c: 0.27, d: 0.01, e: -0.05, f: 0.005, p: 0.07 },
                    { a: -0.04, b: 0.11, c: 0.27, d: 0.01, e: 0.047, f: 0.06, p: 0.07 }
                ]
            },
            culcita: {
                name: 'Culcita',
                transforms: [
                    { a: 0.00, b: 0.00, c: 0.00, d: 0.25, e: 0.00, f: -0.14, p: 0.02 },
                    { a: 0.85, b: 0.02, c: -0.02, d: 0.83, e: 0.00, f: 1.00, p: 0.84 },
                    { a: 0.09, b: -0.28, c: 0.30, d: 0.11, e: 0.00, f: 0.60, p: 0.07 },
                    { a: -0.09, b: 0.28, c: 0.30, d: 0.09, e: 0.00, f: 0.70, p: 0.07 }
                ]
            },
            cyclosorus: {
                name: 'Cyclosorus',
                transforms: [
                    { a: 0.00, b: 0.00, c: 0.00, d: 0.25, e: 0.00, f: -0.4, p: 0.02 },
                    { a: 0.95, b: 0.005, c: -0.005, d: 0.93, e: -0.002, f: 0.5, p: 0.84 },
                    { a: 0.035, b: -0.2, c: 0.16, d: 0.04, e: -0.09, f: 0.02, p: 0.07 },
                    { a: -0.04, b: 0.2, c: 0.16, d: 0.04, e: 0.083, f: 0.12, p: 0.07 }
                ]
            }
        };

        // Generate random mutant fern
        function generateMutant() {
            return {
                name: 'Mutant',
                transforms: [
                    { a: 0.00, b: 0.00, c: 0.00, d: 0.1 + Math.random() * 0.2, e: 0.00, f: Math.random() * 0.1, p: 0.02 },
                    { a: 0.8 + Math.random() * 0.15, b: (Math.random() - 0.5) * 0.1, c: (Math.random() - 0.5) * 0.1, d: 0.8 + Math.random() * 0.15, e: 0.00, f: 1.0 + Math.random() * 1.0, p: 0.84 },
                    { a: 0.1 + Math.random() * 0.2, b: -0.2 - Math.random() * 0.2, c: 0.2 + Math.random() * 0.2, d: 0.1 + Math.random() * 0.2, e: 0.00, f: 0.5 + Math.random() * 1.0, p: 0.07 },
                    { a: -0.1 - Math.random() * 0.2, b: 0.2 + Math.random() * 0.2, c: 0.2 + Math.random() * 0.2, d: 0.1 + Math.random() * 0.2, e: 0.00, f: 0.3 + Math.random() * 0.5, p: 0.07 }
                ]
            };
        }

        // State
        let currentPreset = presets.classic;
        let x = 0, y = 0;
        let pointCount = 0;
        let iterationsPerFrame = 10000;
        let pointSize = 1;
        let colorMode = 0;
        let iterationsSinceLastSecond = 0;
        let ips = 0;

        // Apply a transform
        function applyTransform(t) {
            const newX = t.a * x + t.b * y + t.e;
            const newY = t.c * x + t.d * y + t.f;
            x = newX;
            y = newY;
        }

        // Choose a transform based on probabilities
        function chooseTransform() {
            const r = Math.random();
            let cumulative = 0;
            for (const t of currentPreset.transforms) {
                cumulative += t.p;
                if (r < cumulative) return t;
            }
            return currentPreset.transforms[currentPreset.transforms.length - 1];
        }

        // Get color based on mode and position
        function getColor(px, py, transformIndex) {
            switch (colorMode) {
                case 0: // Gradient based on height
                    const h = 100 + (py / canvas.height) * 40;
                    const s = 60 + (px / canvas.width) * 30;
                    return `hsl(${h}, ${s}%, 45%)`;

                case 1: // Transform-based coloring
                    const colors = ['#2e7d32', '#388e3c', '#43a047', '#4caf50'];
                    return colors[transformIndex % colors.length];

                case 2: // Monochrome
                    const brightness = 30 + (py / canvas.height) * 50;
                    return `hsl(120, 50%, ${brightness}%)`;

                default:
                    return '#4caf50';
            }
        }

        // Reset the fern
        function reset() {
            ctx.fillStyle = 'rgba(10, 26, 10, 1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            x = 0;
            y = 0;
            pointCount = 0;
        }

        // Draw iteration
        function draw() {
            for (let i = 0; i < iterationsPerFrame; i++) {
                // Choose and apply transform
                const t = chooseTransform();
                const transformIndex = currentPreset.transforms.indexOf(t);
                applyTransform(t);

                // Map coordinates to canvas
                // Fern coordinates: x ∈ [-2.182, 2.6558], y ∈ [0, 9.9983]
                const scale = canvas.height / 11;
                const px = canvas.width / 2 + x * scale;
                const py = canvas.height - (y + 0.5) * scale;

                // Draw point
                ctx.fillStyle = getColor(px, py, transformIndex);
                ctx.fillRect(px, py, pointSize, pointSize);

                pointCount++;
                iterationsSinceLastSecond++;
            }

            pointsDisplay.textContent = pointCount.toLocaleString();
        }

        // Animation loop
        let lastTime = 0;
        let frameCount = 0;
        let fps = 0;
        let lastIpsTime = 0;

        function animate(currentTime) {
            requestAnimationFrame(animate);

            // FPS calculation
            frameCount++;
            if (currentTime - lastTime >= 1000) {
                fps = frameCount;
                frameCount = 0;
                lastTime = currentTime;
                fpsDisplay.textContent = fps;

                // IPS calculation
                ips = iterationsSinceLastSecond;
                iterationsSinceLastSecond = 0;
                ipsDisplay.textContent = ips.toLocaleString();
            }

            draw();
        }

        // Event listeners
        document.getElementById('speed').addEventListener('input', (e) => {
            iterationsPerFrame = parseInt(e.target.value);
            document.getElementById('speed-val').textContent = iterationsPerFrame.toLocaleString();
        });

        document.getElementById('size').addEventListener('input', (e) => {
            pointSize = parseFloat(e.target.value);
            document.getElementById('size-val').textContent = pointSize;
        });

        const colorModes = ['Gradient', 'Transform', 'Mono'];
        document.getElementById('color-mode').addEventListener('input', (e) => {
            colorMode = parseInt(e.target.value);
            document.getElementById('color-val').textContent = colorModes[colorMode];
            reset();
        });

        document.getElementById('reset').addEventListener('click', reset);

        // Preset buttons
        document.querySelectorAll('#presets button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('#presets button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const presetName = btn.dataset.preset;
                if (presetName === 'random') {
                    currentPreset = generateMutant();
                } else {
                    currentPreset = presets[presetName];
                }

                variantDisplay.textContent = currentPreset.name;
                reset();
            });
        });

        // Expose for enhance.js keyboard shortcuts
        window.reset = reset;
        window.init = reset;

        // Initialize
        reset();
        requestAnimationFrame(animate);
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
