<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Thermal Energy Storage</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
canvas { display: block; }
#title {
    position: fixed; top: 50px; left: 50%; transform: translateX(-50%);
    color: #fbbf24; font-size: 22px; font-weight: 600;
    text-shadow: 0 0 20px rgba(251,191,36,0.5); z-index: 10;
    pointer-events: none; text-align: center;
}
#controls {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
    background: rgba(0,0,0,0.85); border: 1px solid rgba(251,191,36,0.3);
    border-radius: 12px; padding: 14px 20px; display: flex; gap: 20px;
    align-items: center; z-index: 10; flex-wrap: wrap; justify-content: center;
}
.control-group { display: flex; flex-direction: column; align-items: center; gap: 4px; }
label { color: #fbbf24; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; }
input[type="range"] { width: 120px; accent-color: #fbbf24; }
.value-display { color: #fff; font-size: 13px; font-weight: bold; }
button {
    background: rgba(251,191,36,0.2); color: #fbbf24; border: 1px solid #fbbf24;
    padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px;
    font-weight: bold; transition: background 0.2s;
}
button:hover { background: rgba(251,191,36,0.4); }
</style>
</head>
<body>
<a href="../index.html" style="position:fixed;top:10px;left:10px;padding:8px 16px;background:rgba(0,0,0,0.7);color:#fbbf24;text-decoration:none;border-radius:6px;font-size:14px;z-index:999;font-family:sans-serif;">&#8592; Back to Gallery</a>
<div id="title">Thermal Energy Storage</div>
<canvas id="canvas"></canvas>
<div id="controls">
    <div class="control-group">
        <label>Insulation Quality</label>
        <input type="range" id="insulationSlider" min="1" max="100" value="80">
        <span class="value-display" id="insVal">80%</span>
    </div>
    <div class="control-group">
        <label>Solar Collector Size</label>
        <input type="range" id="collectorSlider" min="10" max="100" value="50">
        <span class="value-display" id="colVal">50%</span>
    </div>
    <div class="control-group">
        <label>Steam Demand</label>
        <input type="range" id="demandSlider" min="0" max="100" value="40">
        <span class="value-display" id="demVal">40%</span>
    </div>
    <div class="control-group">
        <label>Speed</label>
        <input type="range" id="speedSlider" min="1" max="30" value="8">
        <span class="value-display" id="spdVal">8x</span>
    </div>
    <button onclick="resetSim()">Reset</button>
</div>
<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let W, H;
function resize() { W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; }
resize();
window.addEventListener('resize', resize);

let insulation = 80, collectorSize = 50, steamDemand = 40, simSpeed = 8;
let timeOfDay = 8;
let tankTemp = 300;
let ambientTemp = 25;
let efficiency = 0;
let tempHistory = [];
let effHistory = [];
let powerInHistory = [];
let powerOutHistory = [];
let heatParticles = [];
let steamParticles = [];
let dayCount = 0;

document.getElementById('insulationSlider').addEventListener('input', e => { insulation = +e.target.value; document.getElementById('insVal').textContent = insulation + '%'; });
document.getElementById('collectorSlider').addEventListener('input', e => { collectorSize = +e.target.value; document.getElementById('colVal').textContent = collectorSize + '%'; });
document.getElementById('demandSlider').addEventListener('input', e => { steamDemand = +e.target.value; document.getElementById('demVal').textContent = steamDemand + '%'; });
document.getElementById('speedSlider').addEventListener('input', e => { simSpeed = +e.target.value; document.getElementById('spdVal').textContent = simSpeed + 'x'; });

function resetSim() {
    tankTemp = 300;
    tempHistory = [];
    effHistory = [];
    powerInHistory = [];
    powerOutHistory = [];
    timeOfDay = 8;
    dayCount = 0;
}
window.resetSim = resetSim;

function isDaytime() { const h = timeOfDay % 24; return h > 6 && h < 18; }
function getSolarIntensity() {
    const h = timeOfDay % 24;
    if (h < 6 || h > 18) return 0;
    return Math.sin((h - 6) * Math.PI / 12);
}

function tempToColor(t) {
    const norm = Math.min(1, Math.max(0, (t - ambientTemp) / (600 - ambientTemp)));
    const r = Math.floor(50 + norm * 205);
    const g = Math.floor(30 + (1 - Math.abs(norm - 0.5) * 2) * 120);
    const b = Math.floor(200 - norm * 180);
    return `rgb(${r},${g},${b})`;
}

function drawSky() {
    const solar = getSolarIntensity();
    const skyGrad = ctx.createLinearGradient(0, 0, 0, H * 0.4);
    if (isDaytime()) {
        skyGrad.addColorStop(0, `rgba(${30 + solar * 80}, ${50 + solar * 120}, ${120 + solar * 80}, 1)`);
        skyGrad.addColorStop(1, `rgba(${40 + solar * 100}, ${60 + solar * 100}, ${100 + solar * 50}, 1)`);
    } else {
        skyGrad.addColorStop(0, '#0a0e1a');
        skyGrad.addColorStop(1, '#121830');
    }
    ctx.fillStyle = skyGrad;
    ctx.fillRect(0, 0, W, H * 0.4);

    if (isDaytime()) {
        const sunAngle = ((timeOfDay % 24) - 6) / 12 * Math.PI;
        const sx = W * 0.15 + Math.cos(Math.PI - sunAngle) * W * 0.3;
        const sy = H * 0.35 - Math.sin(sunAngle) * H * 0.25;
        const glow = ctx.createRadialGradient(sx, sy, 0, sx, sy, 50);
        glow.addColorStop(0, `rgba(255, 230, 80, ${solar})`);
        glow.addColorStop(0.5, `rgba(255, 200, 50, ${solar * 0.3})`);
        glow.addColorStop(1, 'rgba(255, 200, 50, 0)');
        ctx.fillStyle = glow;
        ctx.beginPath();
        ctx.arc(sx, sy, 50, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(sx, sy, 15, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(255, 240, 100, ${solar})`;
        ctx.fill();
    }
}

function drawTank(x, y, w, h) {
    const insulW = 8 + insulation * 0.12;
    ctx.fillStyle = '#334';
    ctx.beginPath();
    ctx.roundRect(x - insulW, y - insulW, w + insulW * 2, h + insulW * 2, 12);
    ctx.fill();
    ctx.strokeStyle = '#556';
    ctx.lineWidth = 2;
    ctx.stroke();
    for (let i = 0; i < 5; i++) {
        ctx.strokeStyle = `rgba(100,100,120,${0.1 + insulation * 0.003})`;
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.roundRect(x - insulW + i * 2, y - insulW + i * 2, w + (insulW - i * 2) * 2, h + (insulW - i * 2) * 2, 12 - i);
        ctx.stroke();
    }

    const tankGrad = ctx.createLinearGradient(x, y, x, y + h);
    const tc = tempToColor(tankTemp);
    tankGrad.addColorStop(0, tc);
    const tc2 = tempToColor(tankTemp * 0.85);
    tankGrad.addColorStop(1, tc2);
    ctx.fillStyle = tankGrad;
    ctx.beginPath();
    ctx.roundRect(x, y, w, h, 6);
    ctx.fill();

    ctx.fillStyle = 'rgba(0,0,0,0.5)';
    ctx.font = 'bold 11px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('Molten Salt Tank', x + w / 2, y - insulW - 8);

    ctx.fillStyle = '#fff';
    ctx.font = 'bold 22px sans-serif';
    ctx.fillText(tankTemp.toFixed(0) + '\u00b0C', x + w / 2, y + h / 2 + 8);
    ctx.font = '10px sans-serif';
    ctx.fillStyle = '#ddd';
    ctx.fillText('Insulation: ' + insulation + '%', x + w / 2, y + h / 2 + 24);

    const t = Date.now() / 1000;
    for (let i = 0; i < 10; i++) {
        const norm = (tankTemp - ambientTemp) / 575;
        if (Math.random() > norm) continue;
        const bx = x + 5 + Math.random() * (w - 10);
        const by = y + 5 + Math.random() * (h - 10);
        const wobble = Math.sin(t * 2 + i * 1.7) * 3;
        ctx.beginPath();
        ctx.arc(bx + wobble, by, 2, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(255,200,80,${0.1 + norm * 0.3})`;
        ctx.fill();
    }
}

function drawSolarCollector(x, y, w, h) {
    const solar = getSolarIntensity();
    ctx.fillStyle = solar > 0 ? `rgba(40,60,120,${0.5 + solar * 0.4})` : 'rgba(30,30,50,0.6)';
    ctx.fillRect(x, y, w, h);
    ctx.strokeStyle = solar > 0 ? '#4488cc' : '#334';
    ctx.lineWidth = 2;
    ctx.strokeRect(x, y, w, h);
    for (let i = 1; i < 5; i++) {
        ctx.beginPath();
        ctx.moveTo(x, y + i * h / 5);
        ctx.lineTo(x + w, y + i * h / 5);
        ctx.strokeStyle = 'rgba(100,150,200,0.2)';
        ctx.lineWidth = 1;
        ctx.stroke();
    }
    ctx.strokeStyle = '#555';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(x + w / 2, y + h);
    ctx.lineTo(x + w / 2, y + h + 20);
    ctx.stroke();
    ctx.fillStyle = solar > 0 ? '#fbbf24' : '#555';
    ctx.font = '10px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('Solar Collector', x + w / 2, y - 6);
    if (solar > 0.1) {
        ctx.fillStyle = `rgba(255,200,50,${solar * 0.3})`;
        ctx.fillRect(x + 2, y + 2, w - 4, h - 4);
    }
}

function drawSteamGenerator(x, y) {
    ctx.fillStyle = '#2a3a4a';
    ctx.beginPath();
    ctx.roundRect(x - 25, y - 20, 50, 40, 6);
    ctx.fill();
    ctx.strokeStyle = '#4a6a8a';
    ctx.lineWidth = 2;
    ctx.stroke();
    ctx.fillStyle = '#8af';
    ctx.font = 'bold 9px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('Steam', x, y - 2);
    ctx.fillText('Gen', x, y + 10);

    if (steamDemand > 10 && tankTemp > 150) {
        for (let i = 0; i < 4; i++) {
            const t = (Date.now() / 600 + i * 0.4) % 2;
            if (t < 1) {
                const sx = x + (Math.random() - 0.5) * 15;
                const sy = y - 20 - t * 40;
                ctx.beginPath();
                ctx.arc(sx, sy, 3 + t * 4, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(200,220,255,${0.3 * (1 - t)})`;
                ctx.fill();
            }
        }
    }
}

function drawPipes(tankX, tankY, tankW, tankH, colX, colY, colW, colH, genX, genY) {
    const solar = getSolarIntensity();
    ctx.strokeStyle = solar > 0 ? '#cc6622' : '#443';
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.moveTo(colX + colW / 2, colY + colH + 20);
    ctx.lineTo(colX + colW / 2, tankY + tankH / 2);
    ctx.lineTo(tankX, tankY + tankH / 2);
    ctx.stroke();

    if (solar > 0.1) {
        for (let i = 0; i < 4; i++) {
            const t = (Date.now() / 800 + i * 0.25) % 1;
            const path = [
                { x: colX + colW / 2, y: colY + colH + 20 },
                { x: colX + colW / 2, y: tankY + tankH / 2 },
                { x: tankX, y: tankY + tankH / 2 }
            ];
            let dist = t * 2;
            let px, py;
            if (dist < 1) {
                px = path[0].x + (path[1].x - path[0].x) * dist;
                py = path[0].y + (path[1].y - path[0].y) * dist;
            } else {
                dist -= 1;
                px = path[1].x + (path[2].x - path[1].x) * dist;
                py = path[1].y + (path[2].y - path[1].y) * dist;
            }
            ctx.beginPath();
            ctx.arc(px, py, 3, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(255,150,50,${solar * 0.8})`;
            ctx.fill();
        }
    }

    ctx.strokeStyle = steamDemand > 10 && tankTemp > 150 ? '#4488aa' : '#334';
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.moveTo(tankX + tankW, tankY + tankH / 2);
    ctx.lineTo(genX - 25, genY);
    ctx.stroke();

    if (steamDemand > 10 && tankTemp > 150) {
        for (let i = 0; i < 4; i++) {
            const t = (Date.now() / 700 + i * 0.25) % 1;
            const px = (tankX + tankW) + ((genX - 25) - (tankX + tankW)) * t;
            const py = (tankY + tankH / 2) + (genY - (tankY + tankH / 2)) * t;
            ctx.beginPath();
            ctx.arc(px, py, 3, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(80,150,200,${0.6 * (1 - t * 0.5)})`;
            ctx.fill();
        }
    }
}

function drawGraph(data, x, y, w, h, label, color, minV, maxV) {
    ctx.fillStyle = 'rgba(0,0,0,0.65)';
    ctx.strokeStyle = 'rgba(251,191,36,0.2)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.roundRect(x, y, w, h, 8);
    ctx.fill();
    ctx.stroke();
    ctx.fillStyle = '#fbbf24';
    ctx.font = 'bold 10px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(label, x + w / 2, y + 13);
    if (data.length < 2) return;
    const gx = x + 8, gy = y + 18, gw = w - 16, gh = h - 26;
    ctx.beginPath();
    ctx.strokeStyle = color;
    ctx.lineWidth = 1.5;
    const start = Math.max(0, data.length - gw);
    for (let i = start; i < data.length; i++) {
        const px = gx + gw - (data.length - 1 - i);
        const py = gy + gh - ((data[i] - minV) / (maxV - minV)) * gh;
        if (i === start) ctx.moveTo(px, py);
        else ctx.lineTo(px, py);
    }
    ctx.stroke();
}

function drawStats(x, y) {
    ctx.fillStyle = 'rgba(0,0,0,0.75)';
    ctx.strokeStyle = 'rgba(251,191,36,0.2)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.roundRect(x, y, 190, 155, 10);
    ctx.fill();
    ctx.stroke();
    const h = timeOfDay % 24;
    const hh = Math.floor(h).toString().padStart(2, '0');
    const mm = Math.floor((h % 1) * 60).toString().padStart(2, '0');
    const solar = getSolarIntensity();
    const powerIn = solar * collectorSize * 0.5;
    const powerOut = steamDemand * 0.3 * (tankTemp > 150 ? 1 : 0);
    const heatLoss = (tankTemp - ambientTemp) * (1 - insulation / 100) * 0.01;
    efficiency = powerIn > 0.01 ? ((powerIn - heatLoss) / powerIn * 100) : 0;
    const lines = [
        ['Time', hh + ':' + mm + (isDaytime() ? ' (Day)' : ' (Night)'), '#fbbf24'],
        ['Day', (dayCount + 1).toString(), '#fbbf24'],
        ['Tank Temp', tankTemp.toFixed(1) + '\u00b0C', tempToColor(tankTemp)],
        ['Power In', powerIn.toFixed(1) + ' MW', '#f84'],
        ['Power Out', powerOut.toFixed(1) + ' MW', '#4af'],
        ['Heat Loss', heatLoss.toFixed(2) + ' MW', '#f44'],
        ['Efficiency', efficiency.toFixed(1) + '%', efficiency > 80 ? '#4f8' : '#fb4']
    ];
    ctx.fillStyle = '#fbbf24';
    ctx.font = 'bold 13px sans-serif';
    ctx.textAlign = 'left';
    ctx.fillText('System Status', x + 12, y + 22);
    lines.forEach((l, i) => {
        ctx.fillStyle = '#888';
        ctx.font = '11px sans-serif';
        ctx.textAlign = 'left';
        ctx.fillText(l[0], x + 12, y + 42 + i * 16);
        ctx.fillStyle = l[2];
        ctx.textAlign = 'right';
        ctx.fillText(l[1], x + 178, y + 42 + i * 16);
    });
}

function drawHeatLossIndicator(tankX, tankY, tankW, tankH) {
    const lossRate = (tankTemp - ambientTemp) * (1 - insulation / 100) * 0.005;
    if (lossRate < 0.1) return;
    const t = Date.now() / 1000;
    const count = Math.floor(lossRate * 3);
    for (let i = 0; i < count; i++) {
        const side = i % 4;
        let x, y, dx, dy;
        const offset = (t * 0.5 + i * 0.7) % 1;
        if (side === 0) { x = tankX - 15; y = tankY + Math.random() * tankH; dx = -1; dy = 0; }
        else if (side === 1) { x = tankX + tankW + 15; y = tankY + Math.random() * tankH; dx = 1; dy = 0; }
        else if (side === 2) { x = tankX + Math.random() * tankW; y = tankY - 15; dx = 0; dy = -1; }
        else { x = tankX + Math.random() * tankW; y = tankY + tankH + 15; dx = 0; dy = 1; }
        const wave = Math.sin(t * 3 + i) * 3;
        ctx.beginPath();
        ctx.arc(x + dx * offset * 20 + wave, y + dy * offset * 20, 2, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(255,100,50,${0.3 * (1 - offset)})`;
        ctx.fill();
    }
}

let lastTime = performance.now();
let histTimer = 0;
function animate(now) {
    const dt = (now - lastTime) / 1000;
    lastTime = now;

    const prevHour = Math.floor(timeOfDay % 24);
    timeOfDay += dt * simSpeed * 0.15;
    const curHour = Math.floor(timeOfDay % 24);
    if (curHour < prevHour) dayCount++;

    const solar = getSolarIntensity();
    const heatIn = solar * collectorSize * 0.5 * dt * simSpeed * 0.15;
    const heatOut = steamDemand * 0.3 * (tankTemp > 150 ? 1 : 0) * dt * simSpeed * 0.15;
    const heatLoss = (tankTemp - ambientTemp) * (1 - insulation / 100) * 0.001 * dt * simSpeed * 0.15;
    tankTemp += (heatIn - heatOut - heatLoss) * 2;
    tankTemp = Math.max(ambientTemp, Math.min(600, tankTemp));

    histTimer += dt;
    if (histTimer > 0.1) {
        histTimer = 0;
        tempHistory.push(tankTemp);
        effHistory.push(efficiency);
        powerInHistory.push(solar * collectorSize * 0.5);
        powerOutHistory.push(steamDemand * 0.3 * (tankTemp > 150 ? 1 : 0));
        if (tempHistory.length > 400) { tempHistory.shift(); effHistory.shift(); powerInHistory.shift(); powerOutHistory.shift(); }
    }

    ctx.clearRect(0, 0, W, H);
    drawSky();
    ctx.fillStyle = '#1a1a1a';
    ctx.fillRect(0, H * 0.4, W, H * 0.6);

    const tankW = Math.min(160, W * 0.14);
    const tankH = Math.min(140, H * 0.2);
    const tankX = W * 0.38 - tankW / 2;
    const tankY = H * 0.42;
    const colW = Math.min(100, W * 0.1) * (collectorSize / 50);
    const colH = 15;
    const colX = W * 0.12;
    const colY = H * 0.35;
    const genX = W * 0.6;
    const genY = tankY + tankH / 2;

    drawPipes(tankX, tankY, tankW, tankH, colX, colY, colW, colH, genX, genY);
    drawSolarCollector(colX, colY, colW, colH);
    drawTank(tankX, tankY, tankW, tankH);
    drawHeatLossIndicator(tankX, tankY, tankW, tankH);
    drawSteamGenerator(genX, genY);

    const rightX = W * 0.68;
    drawStats(rightX, 80);
    const gw = Math.min(250, W * 0.27);
    drawGraph(tempHistory, rightX, 250, gw, 90, 'Tank Temperature (\u00b0C)', '#f84', 0, 600);
    drawGraph(powerInHistory, rightX, 355, gw, 80, 'Power In/Out (MW)', '#4af', 0, 30);
    if (powerOutHistory.length > 1) {
        const gx2 = rightX + 8, gy2 = 355 + 18, gw2 = gw - 16, gh2 = 80 - 26;
        ctx.beginPath();
        ctx.strokeStyle = '#f84';
        ctx.lineWidth = 1.5;
        const start = Math.max(0, powerOutHistory.length - gw2);
        for (let i = start; i < powerOutHistory.length; i++) {
            const px = gx2 + gw2 - (powerOutHistory.length - 1 - i);
            const py = gy2 + gh2 - (powerOutHistory[i] / 30) * gh2;
            if (i === start) ctx.moveTo(px, py);
            else ctx.lineTo(px, py);
        }
        ctx.stroke();
    }

    requestAnimationFrame(animate);
}
requestAnimationFrame(animate);
</script>
</body>
</html>
