<!DOCTYPE html><html><head><meta charset="UTF-8"><title>WebGPU Particle Collision System</title><style>body{margin:0;background:#0f0f23;display:flex;justify-content:center;align-items:center}canvas{display:block}</style></head><body><canvas id="c" width="800" height="800"></canvas><script>async function init(){if(!navigator.gpu){alert('WebGPU not supported');return}const adapter=await navigator.gpu.requestAdapter();const device=await adapter.requestDevice();const canvas=document.getElementById('c');const context=canvas.getContext('webgpu');const format=navigator.gpu.getPreferredCanvasFormat();context.configure({device,format});const NUM=2000;const shader=`struct Particle{pos:vec2<f32>,vel:vec2<f32>,color:vec3<f32>,radius:f32,}@group(0)@binding(0)var<storage,read_write>particles:array<Particle>;@group(0)@binding(1)var<uniform>dt:f32;@compute @workgroup_size(64)fn main(@builtin(global_invocation_id)id:vec3<u32>){let idx=id.x;if(idx>=${NUM}u){return;}var p=particles[idx];p.vel+=vec2<f32>(0.0,500.0)*dt;p.pos+=p.vel*dt;if(p.pos.x<p.radius||p.pos.x>800.0-p.radius){p.vel.x*=-0.8;p.pos.x=clamp(p.pos.x,p.radius,800.0-p.radius);}if(p.pos.y<p.radius||p.pos.y>800.0-p.radius){p.vel.y*=-0.8;p.pos.y=clamp(p.pos.y,p.radius,800.0-p.radius);}for(var i=0u;i<${NUM}u;i++){if(i==idx){continue;}let other=particles[i];let delta=other.pos-p.pos;let dist=length(delta);let minDist=p.radius+other.radius;if(dist<minDist&&dist>0.0){let n=delta/dist;let relVel=other.vel-p.vel;let velAlongNormal=dot(relVel,n);if(velAlongNormal<0.0){continue;}let impulse=n*velAlongNormal;p.vel+=impulse*0.5;let overlap=(minDist-dist)*0.5;p.pos-=n*overlap;}}particles[idx]=p;}`;const renderShader=`struct Particle{pos:vec2<f32>,vel:vec2<f32>,color:vec3<f32>,radius:f32,}@group(0)@binding(0)var<storage,read>particles:array<Particle>;@vertex fn vs(@builtin(vertex_index)vi:u32,@builtin(instance_index)ii:u32)->@builtin(position)vec4<f32>{let p=particles[ii];let r=p.radius;let angles=array(0.0,1.047,2.094,3.141,4.188,5.235);let offset=vec2<f32>(cos(angles[vi]),sin(angles[vi]))*r;let pos=p.pos+offset;return vec4<f32>(pos.x/400.0-1.0,-(pos.y/400.0-1.0),0.0,1.0);}@fragment fn fs(@builtin(position)pos:vec4<f32>)->@location(0)vec4<f32>{return vec4<f32>(0.5,0.7,1.0,1.0);}`;const particleData=new Float32Array(NUM*8);for(let i=0;i<NUM;i++){const offset=i*8;particleData[offset+0]=Math.random()*800;particleData[offset+1]=Math.random()*400;particleData[offset+2]=(Math.random()-0.5)*200;particleData[offset+3]=(Math.random()-0.5)*200;particleData[offset+4]=Math.random();particleData[offset+5]=Math.random();particleData[offset+6]=Math.random();particleData[offset+7]=5+Math.random()*5;}const particleBuffer=device.createBuffer({size:particleData.byteLength,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST});device.queue.writeBuffer(particleBuffer,0,particleData);const dtBuffer=device.createBuffer({size:4,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});const computePipeline=device.createComputePipeline({layout:'auto',compute:{module:device.createShaderModule({code:shader}),entryPoint:'main'}});const renderPipeline=device.createRenderPipeline({layout:'auto',vertex:{module:device.createShaderModule({code:renderShader}),entryPoint:'vs'},fragment:{module:device.createShaderModule({code:renderShader}),entryPoint:'fs',targets:[{format}]},primitive:{topology:'triangle-list'}});function frame(){device.queue.writeBuffer(dtBuffer,0,new Float32Array([0.016]));const computeBG=device.createBindGroup({layout:computePipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:particleBuffer}},{binding:1,resource:{buffer:dtBuffer}}]});const renderBG=device.createBindGroup({layout:renderPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:particleBuffer}}]});const encoder=device.createCommandEncoder();const compute=encoder.beginComputePass();compute.setPipeline(computePipeline);compute.setBindGroup(0,computeBG);compute.dispatchWorkgroups(Math.ceil(NUM/64));compute.end();const render=encoder.beginRenderPass({colorAttachments:[{view:context.getCurrentTexture().createView(),loadOp:'clear',clearValue:{r:0.06,g:0.06,b:0.14,a:1},storeOp:'store'}]});render.setPipeline(renderPipeline);render.setBindGroup(0,renderBG);render.draw(6,NUM);render.end();device.queue.submit([encoder.finish()]);requestAnimationFrame(frame);}frame();}init();</script></body></html>
