<!DOCTYPE html><html><head><meta charset="UTF-8"><title>WebGPU Cloth Simulation</title><style>body{margin:0;background:#1a1a2e;display:flex;justify-content:center;align-items:center}canvas{display:block}</style></head><body><canvas id="c" width="800" height="800"></canvas><script>async function init(){if(!navigator.gpu){alert('WebGPU not supported');return}const adapter=await navigator.gpu.requestAdapter();const device=await adapter.requestDevice();const canvas=document.getElementById('c');const context=canvas.getContext('webgpu');const format=navigator.gpu.getPreferredCanvasFormat();context.configure({device,format});const GRID=32;const NUM_PARTICLES=GRID*GRID;const shader=`struct Particle{pos:vec2<f32>,oldPos:vec2<f32>,}@group(0)@binding(0)var<storage,read_write>particles:array<Particle>;@group(0)@binding(1)var<uniform>params:vec4<f32>;@compute @workgroup_size(256)fn main(@builtin(global_invocation_id)id:vec3<u32>){let idx=id.x;if(idx>=${NUM_PARTICLES}u){return;}var p=particles[idx];let vel=p.pos-p.oldPos;p.oldPos=p.pos;p.pos+=vel*0.99+vec2<f32>(0.0,0.5)*params.y;if(p.pos.y>800.0){p.pos.y=800.0;p.oldPos.y=800.0;}if(p.pos.x<0.0){p.pos.x=0.0;}if(p.pos.x>800.0){p.pos.x=800.0;}particles[idx]=p;}`;const constraintShader=`struct Particle{pos:vec2<f32>,oldPos:vec2<f32>,}@group(0)@binding(0)var<storage,read_write>particles:array<Particle>;@compute @workgroup_size(256)fn main(@builtin(global_invocation_id)id:vec3<u32>){let idx=id.x;if(idx>=${NUM_PARTICLES}u){return;}let x=idx%${GRID}u;let y=idx/${GRID}u;if(x<${GRID-1}u){let idx2=idx+1u;var p1=particles[idx];var p2=particles[idx2];let delta=p2.pos-p1.pos;let dist=length(delta);let restDist=25.0;let diff=(dist-restDist)/dist*0.5;p1.pos+=delta*diff;p2.pos-=delta*diff;particles[idx]=p1;particles[idx2]=p2;}if(y<${GRID-1}u){let idx2=idx+${GRID}u;var p1=particles[idx];var p2=particles[idx2];let delta=p2.pos-p1.pos;let dist=length(delta);let restDist=25.0;let diff=(dist-restDist)/dist*0.5;p1.pos+=delta*diff;p2.pos-=delta*diff;particles[idx]=p1;particles[idx2]=p2;}}`;const renderShader=`struct Particle{pos:vec2<f32>,oldPos:vec2<f32>,}@group(0)@binding(0)var<storage,read>particles:array<Particle>;@vertex fn vs(@builtin(vertex_index)vi:u32,@builtin(instance_index)ii:u32)->@builtin(position)vec4<f32>{let p=particles[ii];return vec4<f32>((p.pos.x/400.0-1.0),-(p.pos.y/400.0-1.0),0.0,1.0);}@fragment fn fs()->@location(0)vec4<f32>{return vec4<f32>(0.9,0.5,0.7,1.0);}`;const particleData=new Float32Array(NUM_PARTICLES*4);for(let y=0;y<GRID;y++){for(let x=0;x<GRID;x++){const idx=(y*GRID+x)*4;particleData[idx+0]=x*25+100;particleData[idx+1]=y*25+100;particleData[idx+2]=particleData[idx+0];particleData[idx+3]=particleData[idx+1];}}const particleBuffer=device.createBuffer({size:particleData.byteLength,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST});device.queue.writeBuffer(particleBuffer,0,particleData);const paramsBuffer=device.createBuffer({size:16,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});const computePipeline=device.createComputePipeline({layout:'auto',compute:{module:device.createShaderModule({code:shader}),entryPoint:'main'}});const constraintPipeline=device.createComputePipeline({layout:'auto',compute:{module:device.createShaderModule({code:constraintShader}),entryPoint:'main'}});const renderPipeline=device.createRenderPipeline({layout:'auto',vertex:{module:device.createShaderModule({code:renderShader}),entryPoint:'vs'},fragment:{module:device.createShaderModule({code:renderShader}),entryPoint:'fs',targets:[{format}]},primitive:{topology:'point-list'}});function frame(){device.queue.writeBuffer(paramsBuffer,0,new Float32Array([0,0.3,0,0]));const computeBG=device.createBindGroup({layout:computePipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:particleBuffer}},{binding:1,resource:{buffer:paramsBuffer}}]});const constraintBG=device.createBindGroup({layout:constraintPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:particleBuffer}}]});const renderBG=device.createBindGroup({layout:renderPipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:particleBuffer}}]});const encoder=device.createCommandEncoder();const compute=encoder.beginComputePass();compute.setPipeline(computePipeline);compute.setBindGroup(0,computeBG);compute.dispatchWorkgroups(Math.ceil(NUM_PARTICLES/256));compute.end();for(let i=0;i<3;i++){const constraint=encoder.beginComputePass();constraint.setPipeline(constraintPipeline);constraint.setBindGroup(0,constraintBG);constraint.dispatchWorkgroups(Math.ceil(NUM_PARTICLES/256));constraint.end();}const render=encoder.beginRenderPass({colorAttachments:[{view:context.getCurrentTexture().createView(),loadOp:'clear',clearValue:{r:0.1,g:0.1,b:0.18,a:1},storeOp:'store'}]});render.setPipeline(renderPipeline);render.setBindGroup(0,renderBG);render.draw(1,NUM_PARTICLES);render.end();device.queue.submit([encoder.finish()]);requestAnimationFrame(frame);}frame();}init();</script></body></html>
