<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Rodari Machine — Interactive Story Grammar</title>
    <meta name="description" content="An interactive story generator inspired by Gianni Rodari's Grammar of Fantasy. Create stories using the binomial of fantasy, fantastic hypotheses, creative errors, and fairy tale salads.">
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=Nunito:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --sage: #8A9A5B;
            --moss: #606C38;
            --earth: #DDA15E;
            --cream: #FEFAE0;
            --terracotta: #BC6C25;
            --dark-moss: #3d4423;
            --parchment: #FDF8E8;
            --ink: #2C1810;
            --story-blue: #4A6FA5;
            --story-purple: #7B5EA7;
            --story-rose: #C4737A;
            --story-gold: #D4A843;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, #F4F1DE 50%, #EDE8D5 100%);
            color: var(--ink);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Organic background shapes */
        .organic-shape {
            position: fixed;
            border-radius: 50%;
            opacity: 0.08;
            z-index: 0;
            pointer-events: none;
        }
        .shape-1 {
            width: 600px; height: 600px;
            background: radial-gradient(circle, var(--sage), transparent);
            top: -200px; right: -100px;
            animation: morph1 30s ease-in-out infinite;
        }
        .shape-2 {
            width: 500px; height: 500px;
            background: radial-gradient(circle, var(--earth), transparent);
            bottom: -150px; left: -100px;
            animation: morph2 25s ease-in-out infinite;
        }
        .shape-3 {
            width: 350px; height: 350px;
            background: radial-gradient(circle, var(--story-purple), transparent);
            top: 40%; left: 50%;
            animation: morph3 20s ease-in-out infinite;
        }
        @keyframes morph1 {
            0%, 100% { border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%; }
            50% { border-radius: 30% 60% 70% 40% / 50% 60% 30% 60%; }
        }
        @keyframes morph2 {
            0%, 100% { border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%; }
            50% { border-radius: 70% 30% 40% 60% / 60% 40% 50% 60%; }
        }
        @keyframes morph3 {
            0%, 100% { border-radius: 50% 50% 40% 60% / 60% 40% 50% 50%; }
            50% { border-radius: 40% 60% 60% 40% / 50% 60% 40% 60%; }
        }

        /* Back link */
        .organic-back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 0.5rem 1rem;
            background: rgba(254, 250, 224, 0.95);
            border: 2px solid rgba(138, 154, 91, 0.3);
            border-radius: 20px;
            color: var(--terracotta);
            text-decoration: none;
            font-family: 'Nunito', sans-serif;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        .organic-back-link:hover {
            transform: translateX(-5px);
            border-color: var(--earth);
            background: rgba(254, 250, 224, 1);
        }

        /* Main layout */
        .app-container {
            position: relative;
            z-index: 1;
            max-width: 1100px;
            margin: 0 auto;
            padding: 80px 24px 40px;
        }

        /* Header */
        .app-header {
            text-align: center;
            margin-bottom: 36px;
        }
        .app-header h1 {
            font-family: 'Lora', serif;
            font-size: 2.4rem;
            color: var(--dark-moss);
            margin-bottom: 8px;
            line-height: 1.2;
        }
        .app-header .subtitle {
            font-size: 1.05rem;
            color: var(--moss);
            font-weight: 400;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.5;
        }
        .app-header .attribution {
            font-family: 'Lora', serif;
            font-style: italic;
            font-size: 0.9rem;
            color: var(--terracotta);
            margin-top: 6px;
        }

        /* Technique tabs */
        .technique-tabs {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 28px;
        }
        .tab-btn {
            padding: 10px 20px;
            border: 2px solid rgba(138, 154, 91, 0.3);
            border-radius: 24px;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(8px);
            font-family: 'Nunito', sans-serif;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--moss);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .tab-btn:hover {
            transform: translateY(-2px);
            border-color: var(--earth);
            background: rgba(255, 255, 255, 0.8);
        }
        .tab-btn.active {
            background: var(--moss);
            color: var(--cream);
            border-color: var(--moss);
            box-shadow: 0 4px 15px rgba(96, 108, 56, 0.3);
        }
        .tab-icon {
            margin-right: 6px;
        }

        /* Panels */
        .technique-panel {
            display: none;
            animation: fadeIn 0.4s ease;
        }
        .technique-panel.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(138, 154, 91, 0.2);
            border-radius: 20px;
            padding: 28px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        .card:hover {
            box-shadow: 0 8px 32px rgba(96, 108, 56, 0.1);
        }
        .card h2 {
            font-family: 'Lora', serif;
            font-size: 1.4rem;
            color: var(--dark-moss);
            margin-bottom: 6px;
        }
        .card .card-desc {
            font-size: 0.92rem;
            color: var(--moss);
            margin-bottom: 18px;
            line-height: 1.5;
        }
        .card .card-quote {
            font-family: 'Lora', serif;
            font-style: italic;
            font-size: 0.88rem;
            color: var(--terracotta);
            border-left: 3px solid var(--earth);
            padding-left: 14px;
            margin-bottom: 18px;
            line-height: 1.6;
        }

        /* Input groups */
        .input-row {
            display: flex;
            gap: 14px;
            align-items: flex-end;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        .input-group {
            flex: 1;
            min-width: 180px;
        }
        .input-group label {
            display: block;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--moss);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid rgba(138, 154, 91, 0.25);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.7);
            font-family: 'Nunito', sans-serif;
            font-size: 1rem;
            color: var(--ink);
            transition: all 0.3s ease;
        }
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: var(--sage);
            box-shadow: 0 0 0 3px rgba(138, 154, 91, 0.15);
            background: rgba(255, 255, 255, 0.9);
        }
        .input-group textarea {
            min-height: 80px;
            resize: vertical;
            line-height: 1.5;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 22px;
            border: none;
            border-radius: 14px;
            font-family: 'Nunito', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn:active { transform: scale(0.97); }
        .btn-primary {
            background: linear-gradient(135deg, var(--moss), var(--sage));
            color: var(--cream);
            box-shadow: 0 4px 15px rgba(96, 108, 56, 0.3);
        }
        .btn-primary:hover {
            box-shadow: 0 6px 20px rgba(96, 108, 56, 0.4);
            transform: translateY(-2px);
        }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.6);
            color: var(--moss);
            border: 2px solid rgba(138, 154, 91, 0.3);
        }
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.9);
            border-color: var(--sage);
        }
        .btn-accent {
            background: linear-gradient(135deg, var(--terracotta), var(--earth));
            color: white;
            box-shadow: 0 4px 15px rgba(188, 108, 37, 0.3);
        }
        .btn-accent:hover {
            box-shadow: 0 6px 20px rgba(188, 108, 37, 0.4);
            transform: translateY(-2px);
        }
        .btn-small {
            padding: 6px 14px;
            font-size: 0.85rem;
            border-radius: 10px;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        /* Story output */
        .story-output {
            background: var(--parchment);
            border: 2px solid rgba(221, 161, 94, 0.25);
            border-radius: 16px;
            padding: 24px 28px;
            margin-top: 20px;
            min-height: 120px;
            position: relative;
            overflow: hidden;
        }
        .story-output::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--earth), var(--terracotta), var(--story-gold));
        }
        .story-output .story-label {
            font-family: 'Lora', serif;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--terracotta);
            margin-bottom: 12px;
        }
        .story-output .story-text {
            font-family: 'Lora', serif;
            font-size: 1.08rem;
            line-height: 1.8;
            color: var(--ink);
        }
        .story-output .story-text .highlight {
            background: linear-gradient(180deg, transparent 60%, rgba(221, 161, 94, 0.25) 60%);
            font-weight: 600;
        }
        .story-output .story-placeholder {
            font-family: 'Lora', serif;
            font-style: italic;
            color: rgba(44, 24, 16, 0.35);
            font-size: 1rem;
        }
        .story-seed {
            font-family: 'Lora', serif;
            font-size: 1.15rem;
            color: var(--story-purple);
            font-weight: 600;
            text-align: center;
            padding: 14px;
            background: rgba(123, 94, 167, 0.08);
            border-radius: 12px;
            margin-bottom: 14px;
            line-height: 1.5;
        }

        /* Story branches */
        .branches-container {
            margin-top: 20px;
        }
        .branch-option {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 14px 18px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.5);
            border: 2px solid rgba(138, 154, 91, 0.15);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .branch-option:hover {
            background: rgba(255, 255, 255, 0.8);
            border-color: var(--sage);
            transform: translateX(6px);
        }
        .branch-option.selected {
            background: rgba(138, 154, 91, 0.1);
            border-color: var(--sage);
        }
        .branch-letter {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--moss);
            color: var(--cream);
            font-family: 'Lora', serif;
            font-weight: 700;
            font-size: 0.85rem;
            flex-shrink: 0;
            margin-top: 2px;
        }
        .branch-text {
            font-family: 'Lora', serif;
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--ink);
        }

        /* Story history / breadcrumb */
        .story-history {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            margin-bottom: 14px;
        }
        .history-crumb {
            font-size: 0.8rem;
            padding: 4px 10px;
            border-radius: 10px;
            background: rgba(138, 154, 91, 0.12);
            color: var(--moss);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .history-crumb:hover {
            background: rgba(138, 154, 91, 0.25);
        }
        .history-crumb.current {
            background: var(--moss);
            color: var(--cream);
        }
        .history-arrow {
            color: var(--sage);
            font-size: 0.75rem;
        }

        /* Word chips */
        .word-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 12px 0;
        }
        .word-chip {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.88rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s ease;
            border: 2px solid transparent;
        }
        .word-chip:hover { transform: scale(1.05); }
        .chip-noun {
            background: rgba(74, 111, 165, 0.12);
            color: var(--story-blue);
            border-color: rgba(74, 111, 165, 0.2);
        }
        .chip-adj {
            background: rgba(123, 94, 167, 0.12);
            color: var(--story-purple);
            border-color: rgba(123, 94, 167, 0.2);
        }
        .chip-verb {
            background: rgba(196, 115, 122, 0.12);
            color: var(--story-rose);
            border-color: rgba(196, 115, 122, 0.2);
        }
        .chip-place {
            background: rgba(212, 168, 67, 0.12);
            color: var(--story-gold);
            border-color: rgba(212, 168, 67, 0.2);
        }

        /* Fairy tale selector grid */
        .tales-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            margin: 14px 0;
        }
        .tale-option {
            padding: 10px 12px;
            border: 2px solid rgba(138, 154, 91, 0.2);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.5);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.88rem;
        }
        .tale-option:hover {
            border-color: var(--sage);
            background: rgba(255, 255, 255, 0.8);
            transform: translateY(-2px);
        }
        .tale-option.selected {
            border-color: var(--moss);
            background: rgba(138, 154, 91, 0.12);
        }
        .tale-emoji {
            font-size: 1.5rem;
            display: block;
            margin-bottom: 4px;
        }
        .tale-name {
            font-weight: 600;
            color: var(--dark-moss);
        }

        /* Remix panel */
        .remix-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 14px;
            padding-top: 14px;
            border-top: 1px solid rgba(138, 154, 91, 0.15);
        }

        /* Export panel */
        .export-panel {
            background: rgba(255, 255, 255, 0.4);
            border: 1px dashed rgba(138, 154, 91, 0.3);
            border-radius: 14px;
            padding: 16px;
            margin-top: 14px;
            text-align: center;
        }
        .export-panel p {
            font-size: 0.85rem;
            color: var(--moss);
            margin-bottom: 10px;
        }

        /* Animation for story generation */
        .generating {
            position: relative;
            overflow: hidden;
        }
        .generating::after {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(221, 161, 94, 0.1), transparent);
            animation: shimmer 1.5s ease-in-out infinite;
        }
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Typewriter effect */
        .typewriter {
            border-right: 2px solid var(--terracotta);
            animation: blink 0.8s step-end infinite;
        }
        @keyframes blink {
            50% { border-color: transparent; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-container { padding: 70px 16px 30px; }
            .app-header h1 { font-size: 1.8rem; }
            .input-row { flex-direction: column; }
            .input-group { min-width: 100%; }
            .card { padding: 20px; }
            .tales-grid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); }
        }

        /* Scroll to top on story generation */
        html { scroll-behavior: smooth; }

        /* Info tooltip */
        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: rgba(138, 154, 91, 0.2);
            color: var(--moss);
            font-size: 0.7rem;
            font-weight: 700;
            cursor: help;
            margin-left: 6px;
            position: relative;
        }
        .info-icon:hover::after {
            content: attr(data-tip);
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark-moss);
            color: var(--cream);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.78rem;
            font-weight: 400;
            white-space: nowrap;
            max-width: 260px;
            white-space: normal;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Story tree visualization */
        .story-tree {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255,255,255,0.4);
            border-radius: 16px;
            border: 1px solid rgba(138, 154, 91, 0.15);
        }
        .tree-node {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 8px 0;
        }
        .tree-connector {
            width: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-shrink: 0;
        }
        .tree-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--sage);
        }
        .tree-dot.active {
            background: var(--terracotta);
            box-shadow: 0 0 8px rgba(188, 108, 37, 0.4);
        }
        .tree-line {
            width: 2px;
            flex: 1;
            background: rgba(138, 154, 91, 0.3);
            min-height: 20px;
        }
        .tree-content {
            font-family: 'Lora', serif;
            font-size: 0.9rem;
            line-height: 1.5;
            color: var(--ink);
            padding: 6px 12px;
            background: rgba(255,255,255,0.5);
            border-radius: 10px;
            flex: 1;
        }
        .tree-content.current {
            background: rgba(221, 161, 94, 0.12);
            border: 1px solid rgba(221, 161, 94, 0.3);
        }
    </style>
</head>
<body>
    <div class="organic-shape shape-1"></div>
    <div class="organic-shape shape-2"></div>
    <div class="organic-shape shape-3"></div>

    <a href="../index.html" class="organic-back-link">
        <span class="back-arrow">&larr;</span>
        <span class="back-text">Gallery</span>
    </a>

    <div class="app-container">
        <header class="app-header">
            <h1>The Rodari Machine</h1>
            <p class="subtitle">An interactive story grammar inspired by Gianni Rodari's <em>The Grammar of Fantasy</em>. Pick a technique, supply some words, and watch stories grow.</p>
            <p class="attribution">"Creativity is nothing but the mind having fun." &mdash; Gianni Rodari</p>
        </header>

        <!-- Technique Tabs -->
        <nav class="technique-tabs" role="tablist">
            <button class="tab-btn active" data-tab="binomial" role="tab" aria-selected="true">
                <span class="tab-icon">&#9830;</span>Binomial of Fantasy
            </button>
            <button class="tab-btn" data-tab="hypothesis" role="tab" aria-selected="false">
                <span class="tab-icon">&#9733;</span>Fantastic Hypothesis
            </button>
            <button class="tab-btn" data-tab="error" role="tab" aria-selected="false">
                <span class="tab-icon">&#9788;</span>Creative Error
            </button>
            <button class="tab-btn" data-tab="salad" role="tab" aria-selected="false">
                <span class="tab-icon">&#9827;</span>Salad of Fairy Tales
            </button>
            <button class="tab-btn" data-tab="storybook" role="tab" aria-selected="false">
                <span class="tab-icon">&#9998;</span>My Storybook
            </button>
        </nav>

        <!-- ========== BINOMIAL OF FANTASY ========== -->
        <div class="technique-panel active" id="panel-binomial" role="tabpanel">
            <div class="card">
                <h2>The Binomial of Fantasy</h2>
                <p class="card-quote">"A word on its own only 'acts' when it meets a second word that provokes and forces it to leave the track of habit, to discover new capacities of meaning."</p>
                <p class="card-desc">Enter two unrelated words. The farther apart they are in meaning, the more creative the story seed. Rodari believed that imagination sparks in the collision between distant concepts.</p>

                <div class="input-row">
                    <div class="input-group">
                        <label>First Word <span class="info-icon" data-tip="A concrete noun works best, e.g. 'umbrella', 'whale', 'clock'">?</span></label>
                        <input type="text" id="word1" placeholder="e.g. umbrella" autocomplete="off">
                    </div>
                    <div class="input-group">
                        <label>Second Word</label>
                        <input type="text" id="word2" placeholder="e.g. volcano" autocomplete="off">
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="generateBinomial()">Generate Story Seed</button>
                    <button class="btn btn-secondary" onclick="randomizeWords()">Random Words</button>
                </div>

                <div class="word-chips" id="suggestedWords">
                    <!-- filled by JS -->
                </div>
            </div>

            <div id="binomial-output"></div>
        </div>

        <!-- ========== FANTASTIC HYPOTHESIS ========== -->
        <div class="technique-panel" id="panel-hypothesis" role="tabpanel">
            <div class="card">
                <h2>The Fantastic Hypothesis</h2>
                <p class="card-quote">"What would happen if... The technique of the fantastic hypothesis is extremely simple. Its form is the question: 'What would happen if...?'"</p>
                <p class="card-desc">Combine a subject with an unexpected predicate. The stranger the pairing, the richer the story possibilities. Rodari's method turns "what if" into narrative fuel.</p>

                <div class="input-row">
                    <div class="input-group">
                        <label>What if...</label>
                        <select id="hyp-subject">
                            <option value="">Choose a subject...</option>
                            <option value="your city">your city</option>
                            <option value="all the cats in the world">all the cats in the world</option>
                            <option value="a child">a child</option>
                            <option value="the moon">the moon</option>
                            <option value="every clock">every clock</option>
                            <option value="the ocean">the ocean</option>
                            <option value="shoes">shoes</option>
                            <option value="trees">trees</option>
                            <option value="books">books</option>
                            <option value="a grandmother">a grandmother</option>
                            <option value="custom">...type your own</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>...suddenly</label>
                        <select id="hyp-predicate">
                            <option value="">Choose what happens...</option>
                            <option value="could fly">could fly</option>
                            <option value="turned into ice cream">turned into ice cream</option>
                            <option value="started talking">started talking</option>
                            <option value="disappeared completely">disappeared completely</option>
                            <option value="grew to enormous size">grew to enormous size</option>
                            <option value="began to sing">began to sing</option>
                            <option value="swapped places with the sun">swapped places with the sun</option>
                            <option value="forgot everything">forgot everything</option>
                            <option value="became invisible">became invisible</option>
                            <option value="learned to read minds">learned to read minds</option>
                            <option value="custom">...type your own</option>
                        </select>
                    </div>
                </div>

                <div id="hyp-custom-subject" style="display:none;" class="input-row">
                    <div class="input-group">
                        <label>Your subject</label>
                        <input type="text" id="hyp-subject-custom" placeholder="Type your subject...">
                    </div>
                </div>
                <div id="hyp-custom-predicate" style="display:none;" class="input-row">
                    <div class="input-group">
                        <label>Your predicate</label>
                        <input type="text" id="hyp-predicate-custom" placeholder="Type what happens...">
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="generateHypothesis()">Explore This Hypothesis</button>
                    <button class="btn btn-secondary" onclick="randomHypothesis()">Surprise Me</button>
                </div>
            </div>

            <div id="hypothesis-output"></div>
        </div>

        <!-- ========== CREATIVE ERROR ========== -->
        <div class="technique-panel" id="panel-error" role="tabpanel">
            <div class="card">
                <h2>The Creative Error</h2>
                <p class="card-quote">"A misspelling can lead to a creative story. A child who writes 'gass' instead of 'glass' has involuntarily opened the door to a new world."</p>
                <p class="card-desc">Type a word and watch it transform through deliberate "errors" &mdash; letter swaps, sounds gone wrong, meanings misheard. Each mistake becomes a doorway to a new story world.</p>

                <div class="input-row">
                    <div class="input-group">
                        <label>Start with a word</label>
                        <input type="text" id="error-word" placeholder="e.g. telephone" autocomplete="off">
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="generateCreativeError()">Make Creative Errors</button>
                    <button class="btn btn-secondary" onclick="randomErrorWord()">Random Word</button>
                </div>
            </div>

            <div id="error-output"></div>
        </div>

        <!-- ========== SALAD OF FAIRY TALES ========== -->
        <div class="technique-panel" id="panel-salad" role="tabpanel">
            <div class="card">
                <h2>Salad of Fairy Tales</h2>
                <p class="card-quote">"What happens if Cinderella meets Pinocchio? If Little Red Riding Hood encounters Hansel and Gretel in the dark forest?"</p>
                <p class="card-desc">Select two or more fairy tales to mix together. Characters, settings, and plots will collide, creating an entirely new story from familiar ingredients.</p>

                <div class="tales-grid" id="tales-grid">
                    <!-- filled by JS -->
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="generateSalad()">Mix These Tales</button>
                    <button class="btn btn-secondary" onclick="clearTaleSelection()">Clear Selection</button>
                </div>
            </div>

            <div id="salad-output"></div>
        </div>

        <!-- ========== MY STORYBOOK ========== -->
        <div class="technique-panel" id="panel-storybook" role="tabpanel">
            <div class="card">
                <h2>My Storybook</h2>
                <p class="card-desc">All the stories you've generated in this session are collected here. Review them, continue branching, or export your favorites.</p>

                <div id="storybook-list">
                    <p class="story-placeholder">Your generated stories will appear here. Try any technique to get started!</p>
                </div>

                <div class="export-panel" id="export-panel" style="display:none;">
                    <p>Export your storybook to share or keep</p>
                    <div class="btn-group" style="justify-content:center;">
                        <button class="btn btn-accent" onclick="exportStorybook()">Copy All Stories</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ============================================================
    //  THE RODARI MACHINE — Interactive Story Grammar Engine
    // ============================================================

    // --- Word Banks ---
    const NOUNS = [
        'umbrella','whale','clock','volcano','piano','lighthouse','dragon','teapot',
        'bridge','forest','diamond','cloud','bicycle','castle','feather','telescope',
        'mirror','river','balloon','ladder','candle','mountain','compass','garden',
        'lantern','anchor','rainbow','doorknob','carousel','chimney','iceberg',
        'hammock','acorn','snowflake','labyrinth','pocket watch','windmill','seashell',
        'typewriter','treehouse','kite','puzzle','train','island','notebook','crystal',
        'scarecrow','fountain','keyhole','cobweb','violin','treasure','blanket','attic'
    ];

    const ADJECTIVES = [
        'invisible','singing','enormous','tiny','backwards','upside-down','glass',
        'flying','underwater','ancient','forgotten','enchanted','paper','golden',
        'whispering','magnetic','floating','frozen','luminous','velvet','hollow',
        'clockwork','spiral','secret','crystalline','wild','sleepy','wandering'
    ];

    const VERBS = [
        'discovered','swallowed','transformed','whispered to','juggled','painted',
        'dreamed about','traded','hid inside','launched','dissolved','wove',
        'invented','befriended','outran','unlocked','planted','composed','mapped'
    ];

    const PLACES = [
        'under the sea','on a cloud','in a library at midnight','inside a giant shoe',
        'at the edge of the world','in a city of mirrors','beneath a talking tree',
        'on the back of a flying whale','inside an enormous clock','in a land where it rains colors',
        'at a crossroads between three kingdoms','on a bridge between yesterday and tomorrow'
    ];

    // --- Fairy Tales ---
    const FAIRY_TALES = [
        { name:'Little Red Riding Hood', emoji:'\uD83E\uDDE3', char:'Red Riding Hood', villain:'the Wolf', setting:'the dark forest', object:'a basket of food', quest:'visit grandmother' },
        { name:'Cinderella', emoji:'\uD83D\uDC60', char:'Cinderella', villain:'the stepmother', setting:'the grand palace', object:'a glass slipper', quest:'attend the ball' },
        { name:'Pinocchio', emoji:'\uD83E\uDEB5', char:'Pinocchio', villain:'the Fox and Cat', setting:'the puppet theatre', object:'a wooden nose', quest:'become a real boy' },
        { name:'Hansel & Gretel', emoji:'\uD83C\uDFE0', char:'Hansel and Gretel', villain:'the Witch', setting:'a house made of candy', object:'breadcrumbs', quest:'find the way home' },
        { name:'Jack & Beanstalk', emoji:'\uD83C\uDF31', char:'Jack', villain:'the Giant', setting:'a castle in the clouds', object:'magic beans', quest:'find fortune above the clouds' },
        { name:'Sleeping Beauty', emoji:'\uD83C\uDF39', char:'the sleeping princess', villain:'the dark fairy', setting:'an enchanted castle', object:'a spinning wheel', quest:'break the hundred-year spell' },
        { name:'Three Little Pigs', emoji:'\uD83D\uDC37', char:'the Three Pigs', villain:'the Big Bad Wolf', setting:'three little houses', object:'bricks and straw', quest:'build an unbreakable home' },
        { name:'Snow White', emoji:'\uD83C\uDF4E', char:'Snow White', villain:'the Evil Queen', setting:'a cottage in the woods', object:'a poisoned apple', quest:'escape the queen\'s jealousy' },
        { name:'Rapunzel', emoji:'\uD83E\uDDD1\u200D\uD83E\uDDB1', char:'Rapunzel', villain:'the sorceress', setting:'a tall tower', object:'a long braid of hair', quest:'see the world beyond the tower' },
        { name:'Puss in Boots', emoji:'\uD83D\uDC31', char:'Puss in Boots', villain:'the Ogre', setting:'the king\'s road', object:'a pair of fine boots', quest:'win a fortune for his master' },
        { name:'The Ugly Duckling', emoji:'\uD83E\uDD86', char:'the little duckling', villain:'the barnyard bullies', setting:'a quiet pond', object:'ruffled feathers', quest:'discover its true self' },
        { name:'Aladdin', emoji:'\uD83E\uDDDE', char:'Aladdin', villain:'the sorcerer', setting:'an ancient cave of wonders', object:'a magic lamp', quest:'win freedom and love' }
    ];

    // --- Story Templates ---
    const BINOMIAL_TEMPLATES = [
        (w1, w2) => `Once upon a time there was a <span class="highlight">${w1}</span> that dreamed of becoming a <span class="highlight">${w2}</span>. Every night, when the world was asleep, it would practice in secret, stretching itself into new shapes, whispering "${w2}, ${w2}, ${w2}" until the word felt like its own name.`,
        (w1, w2) => `In a country where <span class="highlight">${w1}s</span> grew on trees and <span class="highlight">${w2}s</span> fell like rain, a child set out to collect one of each. The trouble was: every time you picked a ${w1}, a ${w2} would vanish, and every time you caught a ${w2}, a ${w1} would sprout somewhere unexpected.`,
        (w1, w2) => `A <span class="highlight">${w1}</span> and a <span class="highlight">${w2}</span> were placed on a table side by side. At first, nothing happened. Then the ${w1} leaned slightly toward the ${w2}, and the ${w2} began to hum. By morning, they had built something entirely new between them &mdash; something that was neither ${w1} nor ${w2}, but couldn't exist without both.`,
        (w1, w2) => `"What on earth is a <span class="highlight">${w1}</span> doing inside a <span class="highlight">${w2}</span>?" asked the professor, adjusting her glasses. Nobody had an answer. But the ${w1} seemed perfectly comfortable there, and the ${w2} didn't seem to mind at all. In fact, it was smiling.`,
        (w1, w2) => `The recipe was simple: take one <span class="highlight">${w1}</span>, add a generous helping of <span class="highlight">${w2}</span>, stir three times counterclockwise, and wait for the story to rise. The baker had been making stories this way for forty years, and not once had the same tale come out twice.`,
        (w1, w2) => `In the land of lost things, the <span class="highlight">${w1}</span> and the <span class="highlight">${w2}</span> found each other at the bottom of a drawer nobody had opened in a hundred years. "I've been waiting for you," said the ${w1}. "Together, we can finally remember what we were meant to be."`,
        (w1, w2) => `Every child in the village knew the rule: never put a <span class="highlight">${w1}</span> next to a <span class="highlight">${w2}</span>. The elders said it caused "imagination storms" &mdash; wild gusts of stories that blew through town, rearranging everything in their path. Naturally, one curious child decided to try it anyway.`,
        (w1, w2) => `The <span class="highlight">${w1}</span> arrived by mail on a Tuesday. The <span class="highlight">${w2}</span> arrived on a Wednesday. By Thursday, they had written a letter together, addressed to nobody in particular, that began: "Dear World, we have an idea..."`,
    ];

    const HYPOTHESIS_STORIES = [
        (subj, pred) => `<strong>What if ${subj} ${pred}?</strong>\n\nThe morning it happened, nobody believed it at first. ${capitalize(subj)} had always been so predictable, so ordinary. But there it was &mdash; ${subj}, ${pred.replace(/^could |^started |^began to |^turned |^grew |^swapped |^forgot |^became |^learned to /,'now ')}. The scientists called emergency meetings. The children just laughed and said, "We always knew this could happen." And maybe they were right.`,
        (subj, pred) => `<strong>What if ${subj} ${pred}?</strong>\n\nIt started on the quietest day of the year. ${capitalize(subj)} simply ${pred}, as if it were the most natural thing. The first person to notice was a baker, who dropped her bread in astonishment. Then a teacher, who rewrote all her lessons. Then a poet, who finally found the perfect rhyme. Within a week, the whole world had rearranged itself around this one impossible fact.`,
        (subj, pred) => `<strong>What if ${subj} ${pred}?</strong>\n\nThe newspapers couldn't decide if it was a miracle or a catastrophe. ${capitalize(subj)} had ${pred}, and nothing &mdash; absolutely nothing &mdash; was the same. Some people built museums to remember how things used to be. Others threw parties to celebrate how things were now. A few quiet ones simply sat by their windows and watched, wondering what would change next.`,
    ];

    // --- State ---
    let storybook = [];
    let currentStoryTree = null;
    let currentBranchPath = [];

    // --- Tab Navigation ---
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('active'); b.setAttribute('aria-selected','false'); });
            document.querySelectorAll('.technique-panel').forEach(p => p.classList.remove('active'));
            btn.classList.add('active');
            btn.setAttribute('aria-selected','true');
            document.getElementById('panel-' + btn.dataset.tab).classList.add('active');
        });
    });

    // --- Custom select reveal ---
    document.getElementById('hyp-subject').addEventListener('change', function() {
        document.getElementById('hyp-custom-subject').style.display = this.value === 'custom' ? 'flex' : 'none';
    });
    document.getElementById('hyp-predicate').addEventListener('change', function() {
        document.getElementById('hyp-custom-predicate').style.display = this.value === 'custom' ? 'flex' : 'none';
    });

    // --- Utility ---
    function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
    function pickN(arr, n) {
        const shuffled = [...arr].sort(() => Math.random() - 0.5);
        return shuffled.slice(0, n);
    }
    function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }

    function typewriterEffect(el, html, speed) {
        speed = speed || 20;
        // Parse HTML and type text content while preserving tags
        el.innerHTML = '';
        let i = 0;
        let inTag = false;
        let buffer = '';

        function step() {
            if (i >= html.length) {
                el.innerHTML = html;
                el.classList.remove('typewriter');
                return;
            }
            if (html[i] === '<') inTag = true;
            if (inTag) {
                buffer += html[i];
                if (html[i] === '>') {
                    inTag = false;
                }
                i++;
                step();
                return;
            }
            buffer += html[i];
            el.innerHTML = buffer;
            el.classList.add('typewriter');
            i++;
            setTimeout(step, speed);
        }
        step();
    }

    // --- Suggested word chips ---
    function renderSuggestedWords() {
        const container = document.getElementById('suggestedWords');
        const nouns = pickN(NOUNS, 5);
        const adjs = pickN(ADJECTIVES, 3);
        container.innerHTML = '<span style="font-size:0.8rem;color:var(--moss);margin-right:4px;font-weight:600;">Try:</span>' +
            nouns.map(w => `<span class="word-chip chip-noun" onclick="fillWord('${w}')">${w}</span>`).join('') +
            adjs.map(w => `<span class="word-chip chip-adj" onclick="fillWord('${w}')">${w}</span>`).join('');
    }
    renderSuggestedWords();

    function fillWord(word) {
        const w1 = document.getElementById('word1');
        const w2 = document.getElementById('word2');
        if (!w1.value) { w1.value = word; w1.focus(); }
        else if (!w2.value) { w2.value = word; w2.focus(); }
        else { w1.value = w2.value; w2.value = word; }
    }

    function randomizeWords() {
        document.getElementById('word1').value = pick(NOUNS);
        document.getElementById('word2').value = pick(NOUNS.concat(ADJECTIVES));
        renderSuggestedWords();
    }

    // ========== BINOMIAL OF FANTASY ==========
    function generateBinomial() {
        const w1 = document.getElementById('word1').value.trim().toLowerCase();
        const w2 = document.getElementById('word2').value.trim().toLowerCase();
        if (!w1 || !w2) { alert('Please enter two words to create a binomial of fantasy.'); return; }

        const template = pick(BINOMIAL_TEMPLATES);
        const storyText = template(w1, w2);
        const seed = `${w1} + ${w2}`;

        // Generate branch options
        const branches = generateBinomialBranches(w1, w2);

        currentStoryTree = {
            technique: 'Binomial of Fantasy',
            seed: seed,
            nodes: [{ text: storyText, branches: branches, chosenBranch: null }]
        };
        currentBranchPath = [0];

        renderBinomialOutput(storyText, branches, seed);
        addToStorybook('Binomial of Fantasy', seed, storyText);
        renderSuggestedWords();
    }

    function generateBinomialBranches(w1, w2) {
        return [
            { label: 'A', text: `The ${w1} decided to go on a journey to find the origin of all ${w2}s. Along the way, it met a wandering ${pick(NOUNS)} who claimed to know a shortcut through ${pick(PLACES)}.` },
            { label: 'B', text: `But then a ${pick(ADJECTIVES)} stranger appeared, carrying a ${pick(NOUNS)} that glowed whenever it came near a ${w2}. "I've been looking for that ${w1}," the stranger said. "It's the key to everything."` },
            { label: 'C', text: `Meanwhile, ${pick(PLACES)}, someone else had discovered the same secret about ${w1}s and ${w2}s. A race began &mdash; not to own the secret, but to understand it first. Because understanding, the old stories say, is the only real magic.` }
        ];
    }

    function renderBinomialOutput(storyText, branches, seed) {
        const out = document.getElementById('binomial-output');
        out.innerHTML = `
            <div class="story-output">
                <div class="story-label">Story Seed</div>
                <div class="story-seed">${seed}</div>
                <div class="story-text" id="binomial-story"></div>

                <div class="branches-container">
                    <div class="story-label" style="margin-top:18px;">Where does the story go next?</div>
                    ${branches.map((b, i) => `
                        <div class="branch-option" onclick="chooseBranch('binomial', ${i})">
                            <span class="branch-letter">${b.label}</span>
                            <span class="branch-text">${b.text}</span>
                        </div>
                    `).join('')}
                </div>

                <div class="remix-actions">
                    <button class="btn btn-small btn-secondary" onclick="regenerateBinomial()">Regenerate</button>
                    <button class="btn btn-small btn-secondary" onclick="twistStory('binomial')">Add a Twist</button>
                    <button class="btn btn-small btn-accent" onclick="copyStory('binomial-story')">Copy Story</button>
                </div>
            </div>
        `;
        typewriterEffect(document.getElementById('binomial-story'), storyText, 15);
    }

    function regenerateBinomial() {
        generateBinomial();
    }

    function chooseBranch(technique, branchIndex) {
        if (!currentStoryTree) return;
        const currentNode = currentStoryTree.nodes[currentStoryTree.nodes.length - 1];
        const branch = currentNode.branches[branchIndex];
        currentNode.chosenBranch = branchIndex;

        const w1 = document.getElementById('word1').value.trim().toLowerCase();
        const w2 = document.getElementById('word2').value.trim().toLowerCase();

        // Generate new branches from the chosen path
        const newBranches = [
            { label: 'A', text: `And so began a chapter no one expected. ${pick(PLACES)}, the ${pick(ADJECTIVES)} ${pick(NOUNS)} had been waiting for exactly this moment. "It's about time," it said, ${pick(VERBS)} a ${pick(NOUNS)} with peculiar grace.` },
            { label: 'B', text: `But the path twisted. Where there should have been answers, there were only more questions &mdash; and a ${pick(ADJECTIVES)} ${pick(NOUNS)} that seemed to know more than it was saying. The ${w1} and the ${w2} would have to work together now.` },
            { label: 'C', text: `The story paused, as stories sometimes do, to catch its breath. In that silence, a small voice said: "What if we've been reading this backwards all along?" And with that, everything rearranged itself into something wonderful and strange.` }
        ];

        currentStoryTree.nodes.push({ text: branch.text, branches: newBranches, chosenBranch: null });
        currentBranchPath.push(branchIndex);

        // Render updated story with history
        renderBranchedStory('binomial', newBranches);
        addToStorybook('Binomial (continued)', currentStoryTree.seed, branch.text);
    }

    function renderBranchedStory(technique, newBranches) {
        const outId = technique + '-output';
        const out = document.getElementById(outId);

        let historyHtml = '<div class="story-history">';
        currentStoryTree.nodes.forEach((node, i) => {
            if (i > 0) historyHtml += '<span class="history-arrow">&#9654;</span>';
            const isCurrent = i === currentStoryTree.nodes.length - 1;
            historyHtml += `<span class="history-crumb ${isCurrent ? 'current' : ''}" onclick="rewindTo(${i}, '${technique}')">${i === 0 ? 'Start' : 'Part ' + (i + 1)}</span>`;
        });
        historyHtml += '</div>';

        const currentNode = currentStoryTree.nodes[currentStoryTree.nodes.length - 1];

        out.innerHTML = `
            <div class="story-output">
                <div class="story-label">Story &mdash; Part ${currentStoryTree.nodes.length}</div>
                ${historyHtml}
                <div class="story-text" id="${technique}-story">${currentNode.text}</div>

                <div class="branches-container">
                    <div class="story-label" style="margin-top:18px;">What happens next?</div>
                    ${newBranches.map((b, i) => `
                        <div class="branch-option" onclick="chooseBranch('${technique}', ${i})">
                            <span class="branch-letter">${b.label}</span>
                            <span class="branch-text">${b.text}</span>
                        </div>
                    `).join('')}
                </div>

                <div class="remix-actions">
                    <button class="btn btn-small btn-secondary" onclick="twistStory('${technique}')">Add a Twist</button>
                    <button class="btn btn-small btn-secondary" onclick="rewindTo(0, '${technique}')">Start Over</button>
                    <button class="btn btn-small btn-accent" onclick="copyFullStory()">Copy Full Story</button>
                </div>
            </div>
        `;
    }

    function rewindTo(nodeIndex, technique) {
        if (!currentStoryTree) return;
        currentStoryTree.nodes = currentStoryTree.nodes.slice(0, nodeIndex + 1);
        currentBranchPath = currentBranchPath.slice(0, nodeIndex);
        const node = currentStoryTree.nodes[nodeIndex];
        if (nodeIndex === 0) {
            renderBinomialOutput(node.text, node.branches, currentStoryTree.seed);
        } else {
            renderBranchedStory(technique, node.branches);
        }
    }

    function twistStory(technique) {
        const twists = [
            `Suddenly, everything went dark. When the lights returned, the story was upside down &mdash; literally. The sky was below, the ground above, and all the characters had to relearn how to walk.`,
            `A letter arrived from the future. It read: "Dear Past, you're doing it wrong. But beautifully so. Carry on." It was signed by ${pick(NOUNS)}.`,
            `At that exact moment, ${pick(PLACES)}, a ${pick(ADJECTIVES)} ${pick(NOUNS)} sneezed, and the sneeze was so powerful it rewrote the last paragraph of this story entirely.`,
            `"Wait," said a character who hadn't been introduced yet. "I think you've all forgotten the most important thing: the ${pick(ADJECTIVES)} ${pick(NOUNS)} hidden in the very first sentence."`,
            `The narrator lost the page. When it was found again, the story had quietly rewritten itself. The characters were the same, but their motivations had shifted. What was fear became curiosity. What was greed became generosity.`,
            `An old ${pick(NOUNS)} in the corner of the room began to ${pick(VERBS).replace('ed','').replace('d','')} a forgotten tune, and everyone who heard it remembered a story they had never been told.`
        ];

        const twist = pick(twists);
        const newBranches = [
            { label: 'A', text: `After the twist, the story settled into something calmer &mdash; a conversation between two unexpected friends, ${pick(PLACES)}, about what truly matters.` },
            { label: 'B', text: `The twist changed everything. Now the quest was not to find something, but to return something &mdash; a ${pick(ADJECTIVES)} ${pick(NOUNS)} that had been borrowed from the beginning of time.` },
            { label: 'C', text: `"Plot twist!" shouted a voice from outside the story. The characters looked up, confused. Were they inside a book? And if so, who was reading them?` }
        ];

        currentStoryTree.nodes.push({ text: twist, branches: newBranches, chosenBranch: null });
        currentBranchPath.push(-1);

        renderBranchedStory(technique, newBranches);
        addToStorybook('Twist!', 'Story twist', twist);
    }

    // ========== FANTASTIC HYPOTHESIS ==========
    function generateHypothesis() {
        let subj = document.getElementById('hyp-subject').value;
        let pred = document.getElementById('hyp-predicate').value;

        if (subj === 'custom') subj = document.getElementById('hyp-subject-custom').value.trim();
        if (pred === 'custom') pred = document.getElementById('hyp-predicate-custom').value.trim();

        if (!subj || !pred) { alert('Please choose both a subject and what happens to it.'); return; }

        const template = pick(HYPOTHESIS_STORIES);
        const rawText = template(subj, pred);
        const storyText = rawText.replace(/\n/g, '<br>');

        const branches = [
            { label: 'A', text: `The first people to adapt were the children. They had always suspected that ${subj} might ${pred}, and they had been preparing in secret &mdash; building new games, new words, new ways of seeing.` },
            { label: 'B', text: `But one person refused to accept the change. An old ${pick(NOUNS)}-keeper who lived ${pick(PLACES)} declared: "I will find a way to reverse this." And so began the most peculiar quest in the history of quests.` },
            { label: 'C', text: `The philosopher asked: "But what if this isn't the first time ${subj} has ${pred}? What if it happens every thousand years, and we simply forget each time?" The librarian checked the oldest book in the oldest library, and found a single illustration that changed everything.` }
        ];

        currentStoryTree = {
            technique: 'Fantastic Hypothesis',
            seed: `What if ${subj} ${pred}?`,
            nodes: [{ text: storyText, branches: branches, chosenBranch: null }]
        };
        currentBranchPath = [0];

        const out = document.getElementById('hypothesis-output');
        out.innerHTML = `
            <div class="story-output">
                <div class="story-label">Hypothesis Explored</div>
                <div class="story-text" id="hypothesis-story"></div>

                <div class="branches-container">
                    <div class="story-label" style="margin-top:18px;">How does the world respond?</div>
                    ${branches.map((b, i) => `
                        <div class="branch-option" onclick="chooseBranchHyp(${i})">
                            <span class="branch-letter">${b.label}</span>
                            <span class="branch-text">${b.text}</span>
                        </div>
                    `).join('')}
                </div>

                <div class="remix-actions">
                    <button class="btn btn-small btn-secondary" onclick="generateHypothesis()">Regenerate</button>
                    <button class="btn btn-small btn-secondary" onclick="twistStory('hypothesis')">Add a Twist</button>
                    <button class="btn btn-small btn-accent" onclick="copyStory('hypothesis-story')">Copy Story</button>
                </div>
            </div>
        `;
        typewriterEffect(document.getElementById('hypothesis-story'), storyText, 12);
        addToStorybook('Fantastic Hypothesis', `What if ${subj} ${pred}?`, storyText);
    }

    function chooseBranchHyp(branchIndex) {
        // Reuse binomial branching logic
        const currentNode = currentStoryTree.nodes[currentStoryTree.nodes.length - 1];
        const branch = currentNode.branches[branchIndex];
        currentNode.chosenBranch = branchIndex;

        const newBranches = [
            { label: 'A', text: `And this led to the most unexpected discovery of all: ${pick(PLACES)}, a ${pick(ADJECTIVES)} ${pick(NOUNS)} had been recording everything, waiting for someone brave enough to ask the right question.` },
            { label: 'B', text: `The journey took a turn when they realized the hypothesis wasn't just a "what if" &mdash; it was a memory. Something that had already happened, long ago, in a story that had been forgotten on purpose.` },
            { label: 'C', text: `"Enough exploring," said the youngest member of the expedition. "It's time to make something new." And with nothing but a ${pick(NOUNS)} and an idea, they began to build.` }
        ];

        currentStoryTree.nodes.push({ text: branch.text, branches: newBranches, chosenBranch: null });
        currentBranchPath.push(branchIndex);

        renderBranchedStory('hypothesis', newBranches);
        addToStorybook('Hypothesis (continued)', currentStoryTree.seed, branch.text);
    }

    function randomHypothesis() {
        const subjects = ['your city','all the cats in the world','a child','the moon','every clock','the ocean','shoes','trees','books','a grandmother'];
        const predicates = ['could fly','turned into ice cream','started talking','disappeared completely','grew to enormous size','began to sing','swapped places with the sun','forgot everything','became invisible','learned to read minds'];
        document.getElementById('hyp-subject').value = pick(subjects);
        document.getElementById('hyp-predicate').value = pick(predicates);
        document.getElementById('hyp-custom-subject').style.display = 'none';
        document.getElementById('hyp-custom-predicate').style.display = 'none';
        generateHypothesis();
    }

    // ========== CREATIVE ERROR ==========
    function generateCreativeErrors(word) {
        const errors = [];
        const w = word.toLowerCase();

        // Letter swap
        if (w.length > 3) {
            const i = Math.floor(Math.random() * (w.length - 1));
            const swapped = w.slice(0, i) + w[i + 1] + w[i] + w.slice(i + 2);
            if (swapped !== w) {
                errors.push({ type: 'Letter Swap', word: swapped, desc: `Swapped letters ${i + 1} and ${i + 2}` });
            }
        }

        // Letter replacement
        const replacements = { 'a':'o', 'e':'i', 'i':'a', 'o':'u', 'u':'e', 'b':'p', 'c':'k', 'd':'t', 'f':'v', 'g':'j', 'h':'w', 'k':'c', 'l':'r', 'm':'n', 'n':'m', 'p':'b', 'r':'l', 's':'z', 't':'d', 'v':'f', 'w':'h', 'z':'s' };
        const ri = Math.floor(Math.random() * w.length);
        if (replacements[w[ri]]) {
            const replaced = w.slice(0, ri) + replacements[w[ri]] + w.slice(ri + 1);
            errors.push({ type: 'Sound Shift', word: replaced, desc: `Changed '${w[ri]}' to '${replacements[w[ri]]}'` });
        }

        // Prefix/suffix play
        const prefixes = ['un','re','super','mini','mega','anti','pre','post','mis','over'];
        const suffixes = ['ling','ster','oid','ness','arium','scape','tron','ify','opia','istan'];
        errors.push({ type: 'Prefix Added', word: pick(prefixes) + w, desc: `Added a playful prefix` });
        errors.push({ type: 'Suffix Added', word: w + pick(suffixes), desc: `Added an imaginative suffix` });

        // Portmanteau with random noun
        const other = pick(NOUNS.filter(n => n !== word));
        const splitPoint1 = Math.ceil(w.length / 2);
        const splitPoint2 = Math.floor(other.length / 2);
        errors.push({ type: 'Portmanteau', word: w.slice(0, splitPoint1) + other.slice(splitPoint2), desc: `Blended with "${other}"` });

        // Anagram (partial)
        if (w.length > 4) {
            const letters = w.split('');
            for (let k = letters.length - 1; k > 0; k--) {
                const j = Math.floor(Math.random() * (k + 1));
                [letters[k], letters[j]] = [letters[j], letters[k]];
            }
            const anagram = letters.join('');
            if (anagram !== w) {
                errors.push({ type: 'Scramble', word: anagram, desc: `Letters rearranged into something new` });
            }
        }

        return errors;
    }

    function generateCreativeError() {
        const word = document.getElementById('error-word').value.trim();
        if (!word) { alert('Please enter a word to transform through creative errors.'); return; }

        const errors = generateCreativeErrors(word);
        const out = document.getElementById('error-output');

        // Generate stories for each error
        const errorStoryTemplates = [
            (orig, err) => `In a school where spelling was an adventure, a child wrote "<span class="highlight">${err}</span>" instead of "${orig}." The teacher smiled, because in that classroom, every mistake opened a door. Behind this particular door was a world where ${pick(ADJECTIVES)} ${pick(NOUNS)}s ${pick(VERBS)} ${pick(PLACES)}.`,
            (orig, err) => `The word "${orig}" got lost on its way to a sentence and accidentally became "<span class="highlight">${err}</span>." It was confused at first, but then realized it quite liked its new identity. As a ${err}, it could do things a plain old ${orig} never could &mdash; like ${pick(VERBS).replace('ed', 'ing')} through ${pick(PLACES)}.`,
            (orig, err) => `"<span class="highlight">${capitalize(err)}</span>!" exclaimed the inventor, reading the label on her latest creation. She had meant to write "${orig}" on the box, but this was much better. A ${err} was exactly what the world needed. She just had to figure out what it did.`,
        ];

        let errorsHtml = errors.map((e, i) => `
            <div class="branch-option" onclick="expandError(${i}, '${word}', '${e.word.replace(/'/g, "\\'")}')">
                <span class="branch-letter" style="font-size:0.7rem;">${e.type.charAt(0)}</span>
                <div>
                    <span class="branch-text"><strong>${e.word}</strong></span>
                    <span style="font-size:0.8rem;color:var(--moss);display:block;">${e.desc}</span>
                </div>
            </div>
        `).join('');

        out.innerHTML = `
            <div class="story-output">
                <div class="story-label">Creative Errors for "${word}"</div>
                <p style="font-family:'Lora',serif;font-size:0.95rem;color:var(--ink);margin-bottom:14px;">Click any error below to generate a story from it:</p>
                ${errorsHtml}
                <div id="error-story-container"></div>

                <div class="remix-actions">
                    <button class="btn btn-small btn-secondary" onclick="generateCreativeError()">New Errors</button>
                    <button class="btn btn-small btn-accent" onclick="copyStory('error-expanded-story')">Copy Story</button>
                </div>
            </div>
        `;

        // Auto-expand first error
        expandError(0, word, errors[0].word);
    }

    function expandError(index, original, errorWord) {
        const templates = [
            (orig, err) => `In a school where spelling was an adventure, a child wrote "<span class="highlight">${err}</span>" instead of "${orig}." The teacher smiled, because in that classroom, every mistake opened a door. Behind this particular door was a world where ${pick(ADJECTIVES)} ${pick(NOUNS)}s ${pick(VERBS)} ${pick(PLACES)}.`,
            (orig, err) => `The word "${orig}" got lost on its way to a sentence and accidentally became "<span class="highlight">${err}</span>." It was confused at first, but then realized it quite liked its new identity. As a ${err}, it could do things a plain old ${orig} never could &mdash; like finding ${pick(ADJECTIVES)} treasures ${pick(PLACES)}.`,
            (orig, err) => `"<span class="highlight">${capitalize(err)}</span>!" exclaimed the inventor, reading the label on her latest creation. She had meant to write "${orig}" on the box, but this was much better. A ${err} was exactly what the world needed &mdash; something between a ${pick(NOUNS)} and a dream.`,
        ];

        const story = pick(templates)(original, errorWord);
        const container = document.getElementById('error-story-container');
        container.innerHTML = `
            <div style="margin-top:16px;padding-top:16px;border-top:1px solid rgba(138,154,91,0.15);">
                <div class="story-label">Story from "${errorWord}"</div>
                <div class="story-text" id="error-expanded-story"></div>
            </div>
        `;
        typewriterEffect(document.getElementById('error-expanded-story'), story, 15);

        currentStoryTree = {
            technique: 'Creative Error',
            seed: `${original} → ${errorWord}`,
            nodes: [{ text: story, branches: [], chosenBranch: null }]
        };
        addToStorybook('Creative Error', `${original} → ${errorWord}`, story);
    }

    function randomErrorWord() {
        document.getElementById('error-word').value = pick(NOUNS);
    }

    // ========== SALAD OF FAIRY TALES ==========
    let selectedTales = new Set();

    function renderTalesGrid() {
        const grid = document.getElementById('tales-grid');
        grid.innerHTML = FAIRY_TALES.map((t, i) => `
            <div class="tale-option ${selectedTales.has(i) ? 'selected' : ''}" onclick="toggleTale(${i})">
                <span class="tale-emoji">${t.emoji}</span>
                <span class="tale-name">${t.name}</span>
            </div>
        `).join('');
    }
    renderTalesGrid();

    function toggleTale(index) {
        if (selectedTales.has(index)) selectedTales.delete(index);
        else selectedTales.add(index);
        renderTalesGrid();
    }

    function clearTaleSelection() {
        selectedTales.clear();
        renderTalesGrid();
        document.getElementById('salad-output').innerHTML = '';
    }

    function generateSalad() {
        if (selectedTales.size < 2) { alert('Please select at least two fairy tales to mix together.'); return; }

        const tales = [...selectedTales].map(i => FAIRY_TALES[i]);

        const saladTemplates = [
            (t) => {
                const [a, b] = t;
                return `<strong>${a.name} meets ${b.name}</strong><br><br>` +
                    `It all began when <span class="highlight">${a.char}</span> took a wrong turn in ${a.setting} and ended up in ${b.setting}. ` +
                    `There, instead of ${b.char}, stood ${a.villain}, holding ${b.object} with a most peculiar expression.<br><br>` +
                    `"I was trying to ${a.quest}," ${a.char} explained. "But now I seem to be in the wrong story entirely."<br><br>` +
                    `"Wrong story?" replied ${a.villain}. "There are no wrong stories &mdash; only unexpected ones. And this one needs someone who can ${b.quest}. Are you up for it?"<br><br>` +
                    `And so ${a.char} set off on a quest that belonged to someone else, carrying ${a.object} in one hand and ${b.object} in the other, wondering what Rodari would think of all this.`;
            },
            (t) => {
                const [a, b] = t;
                return `<strong>The ${a.name}/${b.name} Mix-Up</strong><br><br>` +
                    `One morning, ${a.char} woke up in ${b.setting}. ${capitalize(b.char)} woke up in ${a.setting}. Someone had shuffled the fairy tales overnight.<br><br>` +
                    `${capitalize(a.char)}, now face to face with ${b.villain}, had no idea how to ${b.quest}. But ${a.object} &mdash; still in hand from the original story &mdash; turned out to be surprisingly useful. ` +
                    `Meanwhile, ${b.char}, confronting ${a.villain}, discovered that ${a.object} was exactly what was needed to ${a.quest}.<br><br>` +
                    `Both stories resolved at the same moment, with both heroes standing in the middle, right where the two tales overlapped, holding a new ${pick(NOUNS)} that hadn't existed in either story before.`;
            },
            (t) => {
                const tales = t.length > 2 ? t : [...t, FAIRY_TALES.find(ft => !t.includes(ft))];
                return `<strong>A Grand Salad of ${tales.map(x => x.name).join(', ')}</strong><br><br>` +
                    `The Grand Librarian of Fairy Tales had a problem. The stories were leaking into each other. ${tales[0].char} had wandered into ${tales[1].setting}, ` +
                    `carrying ${tales[0].object}. ${capitalize(tales[1].char)} was spotted ${pick(PLACES)}, trying to ${tales[0].quest} with nothing but ${tales[1].object}. ` +
                    `And ${tales.length > 2 ? tales[2].char + ' was' : 'everyone was'} very confused indeed.<br><br>` +
                    `"This is a salad!" cried the Librarian, trying to sort the characters back into their proper pages. But the characters rather liked their new arrangements. ` +
                    `${capitalize(tales[0].char)} had discovered that ${tales[1].setting} was a far more interesting place to ${tales[0].quest}. ` +
                    `And ${tales[1].char} had realized that ${tales[0].object} made the quest to ${tales[1].quest} almost enjoyable.<br><br>` +
                    `The Librarian sighed, closed the book, and wrote a new title on the cover: "The Story That Wrote Itself."`;
            }
        ];

        const template = tales.length > 2 ? saladTemplates[2] : pick(saladTemplates.slice(0, 2));
        const storyText = template(tales);

        const branches = [
            { label: 'A', text: `${capitalize(tales[0].char)} decided to stay in the new story permanently. "My old tale was getting predictable," they said. "Here, at least, I never know what's going to happen next." ${capitalize(tales[1].villain)} reluctantly agreed to become an unlikely ally.` },
            { label: 'B', text: `A third fairy tale character &mdash; ${pick(FAIRY_TALES.filter(t => !tales.includes(t))).char} &mdash; stumbled into the scene, making the salad even richer. "Room for one more?" they asked, clutching a ${pick(ADJECTIVES)} ${pick(NOUNS)}.` },
            { label: 'C', text: `The tales began to unmix, each character drifting back toward their original story. But something had changed. Each character brought back a souvenir &mdash; a word, an object, a memory &mdash; from the tale they'd visited. And their own stories were never quite the same again.` }
        ];

        currentStoryTree = {
            technique: 'Salad of Fairy Tales',
            seed: tales.map(t => t.name).join(' + '),
            nodes: [{ text: storyText, branches: branches, chosenBranch: null }]
        };
        currentBranchPath = [0];

        const out = document.getElementById('salad-output');
        out.innerHTML = `
            <div class="story-output">
                <div class="story-label">Fairy Tale Salad</div>
                <div class="story-text" id="salad-story"></div>

                <div class="branches-container">
                    <div class="story-label" style="margin-top:18px;">How does this mixed-up tale continue?</div>
                    ${branches.map((b, i) => `
                        <div class="branch-option" onclick="chooseBranchSalad(${i})">
                            <span class="branch-letter">${b.label}</span>
                            <span class="branch-text">${b.text}</span>
                        </div>
                    `).join('')}
                </div>

                <div class="remix-actions">
                    <button class="btn btn-small btn-secondary" onclick="generateSalad()">Remix Salad</button>
                    <button class="btn btn-small btn-secondary" onclick="twistStory('salad')">Add a Twist</button>
                    <button class="btn btn-small btn-accent" onclick="copyStory('salad-story')">Copy Story</button>
                </div>
            </div>
        `;
        typewriterEffect(document.getElementById('salad-story'), storyText, 12);
        addToStorybook('Salad of Fairy Tales', tales.map(t => t.name).join(' + '), storyText);
    }

    function chooseBranchSalad(branchIndex) {
        const currentNode = currentStoryTree.nodes[currentStoryTree.nodes.length - 1];
        const branch = currentNode.branches[branchIndex];
        currentNode.chosenBranch = branchIndex;

        const newBranches = [
            { label: 'A', text: `The fairy tale salad had become something no one had ever tasted before. It was ${pick(ADJECTIVES)}, ${pick(ADJECTIVES)}, and completely unforgettable. The characters sat down together ${pick(PLACES)} and agreed on one thing: mixed-up stories are the best kind.` },
            { label: 'B', text: `But then the Big Book of Fairy Tales itself spoke. Its pages rustled with a voice like wind through old libraries: "You think you're mixing stories? Stories have been mixing themselves since the very first 'Once upon a time.'"` },
            { label: 'C', text: `And in the end, the greatest fairy tale was the one the characters wrote together &mdash; a story where every chapter was a surprise, every page was a door, and every ending was really a beginning in disguise.` }
        ];

        currentStoryTree.nodes.push({ text: branch.text, branches: newBranches, chosenBranch: null });
        currentBranchPath.push(branchIndex);

        renderBranchedStory('salad', newBranches);
        addToStorybook('Salad (continued)', currentStoryTree.seed, branch.text);
    }

    // ========== STORYBOOK ==========
    function addToStorybook(technique, seed, text) {
        // Strip HTML for storybook display
        const plainText = text.replace(/<[^>]*>/g, '').replace(/&mdash;/g, '\u2014').replace(/&nbsp;/g, ' ').replace(/<br>/g, '\n');
        storybook.push({
            technique: technique,
            seed: seed,
            text: plainText,
            timestamp: new Date().toLocaleTimeString()
        });
        renderStorybook();
    }

    function renderStorybook() {
        const list = document.getElementById('storybook-list');
        const exportPanel = document.getElementById('export-panel');

        if (storybook.length === 0) {
            list.innerHTML = '<p class="story-placeholder">Your generated stories will appear here. Try any technique to get started!</p>';
            exportPanel.style.display = 'none';
            return;
        }

        exportPanel.style.display = 'block';

        list.innerHTML = storybook.map((entry, i) => `
            <div class="card" style="padding:18px;margin-bottom:12px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                    <span style="font-family:'Lora',serif;font-weight:600;color:var(--terracotta);font-size:0.85rem;">${entry.technique}</span>
                    <span style="font-size:0.75rem;color:var(--sage);">${entry.timestamp}</span>
                </div>
                <div style="font-size:0.8rem;color:var(--moss);margin-bottom:6px;font-weight:600;">Seed: ${entry.seed}</div>
                <div style="font-family:'Lora',serif;font-size:0.9rem;line-height:1.6;color:var(--ink);">
                    ${entry.text.length > 200 ? entry.text.substring(0, 200) + '...' : entry.text}
                </div>
            </div>
        `).join('');
    }

    function exportStorybook() {
        const text = storybook.map((entry, i) => {
            return `--- Story ${i + 1}: ${entry.technique} ---\nSeed: ${entry.seed}\nTime: ${entry.timestamp}\n\n${entry.text}\n`;
        }).join('\n\n');

        const header = `THE RODARI MACHINE \u2014 My Storybook\nGenerated on ${new Date().toLocaleDateString()}\nInspired by Gianni Rodari's "The Grammar of Fantasy"\n${'='.repeat(50)}\n\n`;

        navigator.clipboard.writeText(header + text).then(() => {
            const btn = document.querySelector('#export-panel .btn-accent');
            const original = btn.textContent;
            btn.textContent = 'Copied!';
            setTimeout(() => { btn.textContent = original; }, 2000);
        }).catch(() => {
            // Fallback: create a temporary textarea
            const ta = document.createElement('textarea');
            ta.value = header + text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
        });
    }

    function copyStory(elementId) {
        const el = document.getElementById(elementId);
        if (!el) return;
        const text = el.innerText || el.textContent;
        navigator.clipboard.writeText(text).catch(() => {
            const ta = document.createElement('textarea');
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
        });
    }

    function copyFullStory() {
        if (!currentStoryTree) return;
        const fullText = currentStoryTree.nodes.map((n, i) => {
            const plain = n.text.replace(/<[^>]*>/g, '').replace(/&mdash;/g, '\u2014').replace(/<br>/g, '\n');
            return `[Part ${i + 1}]\n${plain}`;
        }).join('\n\n');
        navigator.clipboard.writeText(fullText).catch(() => {
            const ta = document.createElement('textarea');
            ta.value = fullText;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
        });
    }

    // --- Keyboard shortcut: Enter to generate ---
    document.getElementById('word1').addEventListener('keydown', e => { if (e.key === 'Enter') generateBinomial(); });
    document.getElementById('word2').addEventListener('keydown', e => { if (e.key === 'Enter') generateBinomial(); });
    document.getElementById('error-word').addEventListener('keydown', e => { if (e.key === 'Enter') generateCreativeError(); });

    </script>
</body>
</html>
