<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tissot's Indicatrix</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0e1a; overflow: hidden; font-family: 'Segoe UI', Arial, sans-serif; }
canvas { display: block; }
a { position: fixed; top: 20px; left: 20px; color: #8af; text-decoration: none; z-index: 100; font-size: 1.2em; }
a:hover { color: #bdf; }
#controls {
  position: fixed; top: 20px; right: 20px; background: rgba(10,14,30,0.75);
  backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(138,170,255,0.15); border-radius: 12px;
  padding: 18px; color: #cde; z-index: 100; min-width: 230px;
}
#controls h3 { margin-bottom: 10px; color: #8af; font-size: 1em; }
.btn {
  display: block; width: 100%; margin: 4px 0; padding: 7px 12px;
  background: rgba(138,170,255,0.1); border: 1px solid rgba(138,170,255,0.25);
  border-radius: 6px; color: #cde; cursor: pointer; font-size: 0.85em; text-align: left;
}
.btn:hover { background: rgba(138,170,255,0.2); }
.btn.active { background: rgba(138,170,255,0.3); border-color: #8af; color: #fff; }
label { display: block; margin-top: 10px; font-size: 0.8em; color: #89a; }
input[type=range] { width: 100%; margin-top: 4px; accent-color: #8af; }
.info-box {
  position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
  background: rgba(10,14,30,0.8); backdrop-filter: blur(10px);
  border: 1px solid rgba(138,170,255,0.15); border-radius: 10px;
  padding: 12px 22px; color: #89a; font-size: 0.8em; text-align: center; z-index: 100;
  max-width: 650px; line-height: 1.4;
}
.info-box strong { color: #8af; }
</style>
</head>
<body>
<a href="index.html">&#8592; Back</a>
<canvas id="c"></canvas>
<div id="controls">
  <h3>Tissot's Indicatrix</h3>
  <button class="btn active" data-proj="mercator">Mercator (Conformal)</button>
  <button class="btn" data-proj="equalarea">Equal-Area (Cylindrical)</button>
  <button class="btn" data-proj="equirect">Equirectangular</button>
  <button class="btn" data-proj="sinusoidal">Sinusoidal (Equal-Area)</button>
  <label>Circle Spacing: <span id="spacingVal">30</span>&deg;</label>
  <input type="range" id="spacing" min="15" max="45" value="30" step="15">
  <label>Circle Radius: <span id="radiusVal">10</span>&deg;</label>
  <input type="range" id="radius" min="5" max="20" value="10" step="1">
  <label style="margin-top:8px">
    <input type="checkbox" id="animateCenter"> Animate center longitude
  </label>
</div>
<div class="info-box">
  <strong>Tissot's Indicatrix:</strong> Equal-size circles on the globe reveal how a map projection distorts area and shape.
  On Mercator, circles near the poles become enormous &mdash; making Greenland appear as large as Africa!
</div>
<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let W, H;

function resize() {
  W = canvas.width = innerWidth;
  H = canvas.height = innerHeight;
}
resize();
window.addEventListener('resize', resize);

let currentProj = 'mercator';
let spacing = 30;
let circleRadius = 10;
let animateCenter = false;
let centerLon = 0;
let time = 0;

// Continent outlines (simplified, lon/lat degrees)
const continents = [
  [[-10,70],[-20,60],[-30,55],[-50,55],[-65,45],[-80,30],[-95,30],[-105,25],[-120,35],[-125,50],[-140,60],[-165,65],[-165,72],[-100,72],[-80,70],[-60,65],[-55,70],[-10,70]],
  [[-35,-5],[-40,-20],[-50,-25],[-55,-20],[-70,-15],[-80,-5],[-75,5],[-60,10],[-55,5],[-35,-5]],
  [[0,40],[5,45],[10,50],[15,55],[25,60],[30,70],[20,70],[5,60],[-5,50],[0,45],[0,40]],
  [[10,35],[15,30],[35,30],[50,12],[50,0],[40,-15],[30,-25],[20,-35],[15,-30],[5,-10],[-15,5],[-15,15],[0,30],[10,35]],
  [[30,70],[40,60],[50,50],[60,40],[70,30],[80,20],[90,25],[100,20],[110,22],[120,30],[130,35],[140,45],[155,55],[175,65],[180,68],[170,70],[140,55],[120,55],[105,50],[80,55],[60,60],[40,65],[30,70]],
  [[115,-15],[130,-12],[145,-15],[153,-25],[150,-35],[140,-38],[130,-35],[115,-25],[115,-15]]
];

function projMercator(lon, lat) {
  const lonR = (lon - centerLon) * Math.PI / 180;
  const latR = Math.max(-85, Math.min(85, lat)) * Math.PI / 180;
  return [lonR / Math.PI, Math.log(Math.tan(Math.PI/4 + latR/2)) / Math.PI];
}

function projEqualArea(lon, lat) {
  const lonR = (lon - centerLon) * Math.PI / 180;
  const latR = lat * Math.PI / 180;
  return [lonR / Math.PI, Math.sin(latR)];
}

function projEquirect(lon, lat) {
  const lonR = (lon - centerLon) * Math.PI / 180;
  const latR = lat * Math.PI / 180;
  return [lonR / Math.PI, latR / (Math.PI/2)];
}

function projSinusoidal(lon, lat) {
  const lonR = (lon - centerLon) * Math.PI / 180;
  const latR = lat * Math.PI / 180;
  return [lonR * Math.cos(latR) / Math.PI, latR / (Math.PI/2)];
}

function getProj(lon, lat) {
  switch(currentProj) {
    case 'mercator': return projMercator(lon, lat);
    case 'equalarea': return projEqualArea(lon, lat);
    case 'equirect': return projEquirect(lon, lat);
    case 'sinusoidal': return projSinusoidal(lon, lat);
  }
}

function toScreen(nx, ny) {
  const scale = Math.min(W, H) * 0.38;
  return [W/2 + nx * scale, H/2 - ny * scale];
}

function getAreaDistortion(lat) {
  const latR = lat * Math.PI / 180;
  switch(currentProj) {
    case 'mercator': {
      const sec = 1 / Math.cos(latR);
      return sec * sec; // area scale factor
    }
    case 'equalarea': return 1; // equal area
    case 'equirect': return 1 / Math.cos(latR);
    case 'sinusoidal': return 1;
  }
}

function distortionColor(distortion) {
  const d = Math.min(1, Math.max(0, (distortion - 1) / 8));
  const r = Math.round(40 + d * 215);
  const g = Math.round(200 * (1 - d * 0.8));
  const b = Math.round(80 * (1 - d));
  return { r, g, b };
}

function draw(ts) {
  const dt = 1/60;
  time += dt;

  if (animateCenter) {
    centerLon = Math.sin(time * 0.3) * 180;
  }

  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = '#0a0e1a';
  ctx.fillRect(0, 0, W, H);

  // Draw graticule
  ctx.lineWidth = 0.8;

  // Latitude lines
  for (let lat = -80; lat <= 80; lat += 20) {
    ctx.strokeStyle = lat === 0 ? 'rgba(138,170,255,0.3)' : 'rgba(138,170,255,0.08)';
    ctx.beginPath();
    let started = false;
    for (let lon = -180; lon <= 180; lon += 3) {
      const p = getProj(lon, lat);
      if (!p) { started = false; continue; }
      const [sx, sy] = toScreen(p[0], p[1]);
      if (!started) { ctx.moveTo(sx, sy); started = true; }
      else ctx.lineTo(sx, sy);
    }
    ctx.stroke();
  }

  // Longitude lines
  for (let lon = -180; lon <= 180; lon += 30) {
    ctx.strokeStyle = lon === 0 ? 'rgba(138,170,255,0.3)' : 'rgba(138,170,255,0.08)';
    ctx.beginPath();
    let started = false;
    for (let lat = -85; lat <= 85; lat += 2) {
      const p = getProj(lon, lat);
      if (!p) { started = false; continue; }
      const [sx, sy] = toScreen(p[0], p[1]);
      if (!started) { ctx.moveTo(sx, sy); started = true; }
      else ctx.lineTo(sx, sy);
    }
    ctx.stroke();
  }

  // Draw continents
  for (const cont of continents) {
    ctx.strokeStyle = 'rgba(100,200,150,0.5)';
    ctx.fillStyle = 'rgba(40,100,70,0.15)';
    ctx.lineWidth = 1.2;
    ctx.beginPath();
    let started = false;
    for (const [lon, lat] of cont) {
      const p = getProj(lon, lat);
      if (!p) { started = false; continue; }
      const [sx, sy] = toScreen(p[0], p[1]);
      if (!started) { ctx.moveTo(sx, sy); started = true; }
      else ctx.lineTo(sx, sy);
    }
    ctx.closePath();
    ctx.fill();
    ctx.stroke();
  }

  // Draw Tissot indicatrices
  for (let lat = -90 + spacing; lat < 90; lat += spacing) {
    for (let lon = -180 + spacing/2; lon < 180; lon += spacing) {
      // Draw a circle of given radius centered at (lon, lat) on the sphere
      // Project each point of the circle
      const cLatR = lat * Math.PI / 180;
      const cLonR = lon * Math.PI / 180;
      const rR = circleRadius * Math.PI / 180;

      const pts = [];
      const N = 36;
      let valid = true;
      for (let i = 0; i <= N; i++) {
        const angle = (i / N) * 2 * Math.PI;
        // Point on the sphere at distance rR from center
        const pLat = lat + circleRadius * Math.cos(angle);
        const pLon = lon + circleRadius * Math.sin(angle) / Math.max(0.1, Math.cos(cLatR));
        const p = getProj(pLon, pLat);
        if (!p) { valid = false; break; }
        pts.push(toScreen(p[0], p[1]));
      }

      if (!valid || pts.length < 3) continue;

      const dist = getAreaDistortion(lat);
      const col = distortionColor(dist);

      // Fill
      ctx.fillStyle = `rgba(${col.r},${col.g},${col.b},0.25)`;
      ctx.strokeStyle = `rgba(${col.r},${col.g},${col.b},0.7)`;
      ctx.lineWidth = 1.5;
      ctx.beginPath();
      ctx.moveTo(pts[0][0], pts[0][1]);
      for (let i = 1; i < pts.length; i++) ctx.lineTo(pts[i][0], pts[i][1]);
      ctx.closePath();
      ctx.fill();
      ctx.stroke();
    }
  }

  requestAnimationFrame(draw);
}

// Controls
document.querySelectorAll('.btn[data-proj]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.btn[data-proj]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentProj = btn.dataset.proj;
  });
});

document.getElementById('spacing').addEventListener('input', function() {
  spacing = parseInt(this.value);
  document.getElementById('spacingVal').textContent = this.value;
});

document.getElementById('radius').addEventListener('input', function() {
  circleRadius = parseInt(this.value);
  document.getElementById('radiusVal').textContent = this.value;
});

document.getElementById('animateCenter').addEventListener('change', function() {
  animateCenter = this.checked;
  if (!this.checked) centerLon = 0;
});

window.reset = function() {
  currentProj = 'mercator'; spacing = 30; circleRadius = 10;
  animateCenter = false; centerLon = 0; time = 0;
  document.getElementById('spacing').value = 30;
  document.getElementById('spacingVal').textContent = '30';
  document.getElementById('radius').value = 10;
  document.getElementById('radiusVal').textContent = '10';
  document.getElementById('animateCenter').checked = false;
  document.querySelectorAll('.btn[data-proj]').forEach(b => b.classList.remove('active'));
  document.querySelector('[data-proj="mercator"]').classList.add('active');
};

requestAnimationFrame(draw);
</script>
<script src="../assets/js/enhance.js"></script>
</body>
</html>
