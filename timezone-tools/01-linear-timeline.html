<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linear Timeline - Working Hours Across Timezones | CCAB</title>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&family=Nunito:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --sage: #8A9A5B;
            --moss: #606C38;
            --earth: #DDA15E;
            --cream: #FEFAE0;
            --terracotta: #BC6C25;
            --dark-moss: #3d4423;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #FEFAE0 0%, #F4F1DE 50%, #EDE8D5 100%);
            color: var(--moss);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Organic morphing shapes */
        .organic-shape {
            position: fixed;
            border-radius: 63% 37% 54% 46% / 55% 48% 52% 45%;
            opacity: 0.08;
            animation: morph 30s infinite ease-in-out;
            z-index: 0;
            pointer-events: none;
        }

        .shape-1 {
            width: 600px;
            height: 600px;
            background: var(--sage);
            top: -150px;
            left: -150px;
        }

        .shape-2 {
            width: 400px;
            height: 400px;
            background: var(--earth);
            bottom: -100px;
            right: -100px;
            animation-delay: -10s;
        }

        @keyframes morph {
            0%, 100% {
                border-radius: 63% 37% 54% 46% / 55% 48% 52% 45%;
                transform: rotate(0deg) scale(1);
            }
            25% {
                border-radius: 40% 60% 70% 30% / 40% 40% 60% 60%;
                transform: rotate(90deg) scale(1.05);
            }
            50% {
                border-radius: 50% 50% 33% 67% / 55% 27% 73% 45%;
                transform: rotate(180deg) scale(1);
            }
            75% {
                border-radius: 70% 30% 50% 50% / 30% 65% 35% 70%;
                transform: rotate(270deg) scale(0.95);
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        /* Back Link */
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--moss);
            text-decoration: none;
            font-size: 0.95rem;
            font-weight: 500;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            transition: all 0.3s ease;
            margin-bottom: 2rem;
        }

        .back-link:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateX(-4px);
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        h1 {
            font-family: 'Lora', serif;
            font-size: clamp(1.8rem, 4vw, 2.5rem);
            font-weight: 600;
            color: var(--moss);
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: var(--terracotta);
            font-size: 1rem;
        }

        /* Controls */
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .control-group label {
            font-weight: 500;
            color: var(--dark-moss);
        }

        input[type="date"] {
            padding: 0.6rem 1rem;
            border: 2px solid var(--sage);
            border-radius: 10px;
            font-family: 'Nunito', sans-serif;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.8);
            color: var(--dark-moss);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        input[type="date"]:hover,
        input[type="date"]:focus {
            border-color: var(--moss);
            background: white;
            outline: none;
        }

        .preset-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--sage);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.6);
            color: var(--moss);
            font-family: 'Nunito', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .preset-btn:hover {
            background: var(--sage);
            color: white;
        }

        .preset-btn.active {
            background: var(--moss);
            border-color: var(--moss);
            color: white;
        }

        /* Canvas Container */
        .canvas-container {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }

        #timeline-canvas {
            display: block;
            width: 100%;
            height: auto;
        }

        /* Legend */
        .legend {
            display: flex;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .legend-color {
            width: 20px;
            height: 12px;
            border-radius: 3px;
        }

        /* Info Panel */
        .info-panel {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
        }

        .current-time {
            font-family: 'Lora', serif;
            font-size: 1.3rem;
            color: var(--moss);
            margin-bottom: 1rem;
        }

        .overlap-info {
            font-size: 1rem;
            color: var(--terracotta);
            font-weight: 500;
        }

        .overlap-hours {
            font-size: 1.1rem;
            color: var(--dark-moss);
            margin-top: 0.5rem;
        }

        /* City Colors */
        .city-miami { background: #FF6B6B; }
        .city-london { background: #4ECDC4; }
        .city-malta { background: #45B7D1; }
        .city-moscow { background: #96CEB4; }
        .city-dubai { background: #DDA15E; }

        /* Loading State */
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1000;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(96, 108, 56, 0.2);
            border-top-color: var(--moss);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden { display: none; }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .controls {
                flex-direction: column;
                gap: 1rem;
            }

            .legend {
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Organic background shapes -->
    <div class="organic-shape shape-1"></div>
    <div class="organic-shape shape-2"></div>

    <!-- Loading State -->
    <div id="loading">
        <div class="spinner"></div>
        <p>Loading timeline...</p>
    </div>

    <div class="container" id="main-content" style="opacity: 0;">
        <a href="index.html" class="back-link">
            <span>&#8592;</span>
            <span>Back to Timezone Tools</span>
        </a>

        <header class="header">
            <h1>Working Hours Timeline</h1>
            <p class="subtitle">Visualize overlapping business hours across timezones</p>
        </header>

        <div class="controls">
            <div class="control-group">
                <label for="date-picker">Select Date:</label>
                <input type="date" id="date-picker">
            </div>
            <div class="control-group">
                <button class="preset-btn" data-date="summer">Summer (Jul 15)</button>
                <button class="preset-btn" data-date="winter">Winter (Jan 15)</button>
                <button class="preset-btn" data-date="today">Today</button>
            </div>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color city-miami"></div>
                <span>Miami</span>
            </div>
            <div class="legend-item">
                <div class="legend-color city-london"></div>
                <span>London</span>
            </div>
            <div class="legend-item">
                <div class="legend-color city-malta"></div>
                <span>Malta</span>
            </div>
            <div class="legend-item">
                <div class="legend-color city-moscow"></div>
                <span>Moscow</span>
            </div>
            <div class="legend-item">
                <div class="legend-color city-dubai"></div>
                <span>Dubai</span>
            </div>
        </div>

        <div class="canvas-container">
            <canvas id="timeline-canvas"></canvas>
        </div>

        <div class="info-panel">
            <div class="current-time" id="current-time">Loading...</div>
            <div class="overlap-info" id="overlap-info">Calculating overlap...</div>
            <div class="overlap-hours" id="overlap-hours"></div>
        </div>
    </div>

    <script>
        // City configuration with DST rules
        const cities = [
            {
                name: 'Miami',
                color: '#FF6B6B',
                // US DST: Second Sunday of March to First Sunday of November
                getDSTOffset: (date) => isUSDST(date) ? -4 : -5
            },
            {
                name: 'London',
                color: '#4ECDC4',
                // UK DST: Last Sunday of March to Last Sunday of October
                getDSTOffset: (date) => isUKDST(date) ? 1 : 0
            },
            {
                name: 'Malta',
                color: '#45B7D1',
                // EU DST: Last Sunday of March to Last Sunday of October
                getDSTOffset: (date) => isEUDST(date) ? 2 : 1
            },
            {
                name: 'Moscow',
                color: '#96CEB4',
                // No DST since 2011, permanently UTC+3
                getDSTOffset: () => 3
            },
            {
                name: 'Dubai',
                color: '#DDA15E',
                // No DST, permanently UTC+4
                getDSTOffset: () => 4
            }
        ];

        // DST calculation functions
        function getNthSundayOfMonth(year, month, n) {
            const date = new Date(year, month, 1);
            const dayOfWeek = date.getDay();
            const firstSunday = dayOfWeek === 0 ? 1 : 8 - dayOfWeek;
            return new Date(year, month, firstSunday + (n - 1) * 7);
        }

        function getLastSundayOfMonth(year, month) {
            const date = new Date(year, month + 1, 0); // Last day of month
            const dayOfWeek = date.getDay();
            return new Date(year, month, date.getDate() - dayOfWeek);
        }

        function isUSDST(date) {
            const year = date.getFullYear();
            const dstStart = getNthSundayOfMonth(year, 2, 2); // Second Sunday of March
            const dstEnd = getNthSundayOfMonth(year, 10, 1); // First Sunday of November
            dstStart.setHours(2, 0, 0, 0);
            dstEnd.setHours(2, 0, 0, 0);
            return date >= dstStart && date < dstEnd;
        }

        function isUKDST(date) {
            const year = date.getFullYear();
            const dstStart = getLastSundayOfMonth(year, 2); // Last Sunday of March
            const dstEnd = getLastSundayOfMonth(year, 9); // Last Sunday of October
            dstStart.setHours(1, 0, 0, 0);
            dstEnd.setHours(2, 0, 0, 0);
            return date >= dstStart && date < dstEnd;
        }

        function isEUDST(date) {
            const year = date.getFullYear();
            const dstStart = getLastSundayOfMonth(year, 2); // Last Sunday of March
            const dstEnd = getLastSundayOfMonth(year, 9); // Last Sunday of October
            dstStart.setHours(2, 0, 0, 0);
            dstEnd.setHours(3, 0, 0, 0);
            return date >= dstStart && date < dstEnd;
        }

        // Canvas setup
        const canvas = document.getElementById('timeline-canvas');
        const ctx = canvas.getContext('2d');
        const dpr = window.devicePixelRatio || 1;

        // Layout constants
        const PADDING = { top: 60, right: 40, bottom: 50, left: 100 };
        const ROW_HEIGHT = 50;
        const WORKING_START = 9; // 9 AM
        const WORKING_END = 18; // 6 PM

        let selectedDate = new Date();
        let animationId = null;

        function resizeCanvas() {
            const container = canvas.parentElement;
            const width = container.clientWidth - 48; // Account for padding
            const height = PADDING.top + cities.length * ROW_HEIGHT + PADDING.bottom;

            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';
            canvas.width = width * dpr;
            canvas.height = height * dpr;

            ctx.scale(dpr, dpr);
        }

        function getLocalWorkingHoursInUTC(city, date) {
            const offset = city.getDSTOffset(date);
            // Working hours in local time are 9-18
            // Convert to UTC
            const startUTC = (WORKING_START - offset + 24) % 24;
            const endUTC = (WORKING_END - offset + 24) % 24;
            return { startUTC, endUTC, offset };
        }

        function drawTimeline() {
            const width = canvas.width / dpr;
            const height = canvas.height / dpr;

            // Clear canvas
            ctx.clearRect(0, 0, width, height);

            const chartWidth = width - PADDING.left - PADDING.right;
            const chartHeight = height - PADDING.top - PADDING.bottom;
            const hourWidth = chartWidth / 24;

            // Draw background grid
            ctx.strokeStyle = 'rgba(96, 108, 56, 0.1)';
            ctx.lineWidth = 1;

            for (let h = 0; h <= 24; h++) {
                const x = PADDING.left + h * hourWidth;
                ctx.beginPath();
                ctx.moveTo(x, PADDING.top);
                ctx.lineTo(x, PADDING.top + chartHeight);
                ctx.stroke();
            }

            // Draw hour labels
            ctx.font = '12px Nunito, sans-serif';
            ctx.fillStyle = '#606C38';
            ctx.textAlign = 'center';

            for (let h = 0; h <= 24; h += 2) {
                const x = PADDING.left + h * hourWidth;
                const label = h === 24 ? '00' : h.toString().padStart(2, '0');
                ctx.fillText(label + ':00', x, PADDING.top - 10);
            }

            // UTC label
            ctx.font = '14px Nunito, sans-serif';
            ctx.fillStyle = '#BC6C25';
            ctx.fillText('UTC Time', PADDING.left + chartWidth / 2, 20);

            // Calculate overlap region
            let overlapStart = 0;
            let overlapEnd = 24;
            const cityWorkingHours = [];

            cities.forEach(city => {
                const { startUTC, endUTC } = getLocalWorkingHoursInUTC(city, selectedDate);
                cityWorkingHours.push({ city, startUTC, endUTC });
            });

            // Find overlap (this is complex for wrap-around cases)
            // Simplified: find the UTC hours where all cities are working
            const overlapHours = [];
            for (let h = 0; h < 24; h++) {
                let allWorking = true;
                for (const { startUTC, endUTC } of cityWorkingHours) {
                    const isWorking = startUTC <= endUTC
                        ? (h >= startUTC && h < endUTC)
                        : (h >= startUTC || h < endUTC);
                    if (!isWorking) {
                        allWorking = false;
                        break;
                    }
                }
                if (allWorking) overlapHours.push(h);
            }

            // Draw overlap highlight
            if (overlapHours.length > 0) {
                ctx.fillStyle = 'rgba(138, 154, 91, 0.15)';
                overlapHours.forEach(h => {
                    const x = PADDING.left + h * hourWidth;
                    ctx.fillRect(x, PADDING.top, hourWidth, chartHeight);
                });
            }

            // Draw city rows
            cities.forEach((city, index) => {
                const y = PADDING.top + index * ROW_HEIGHT;
                const { startUTC, endUTC, offset } = getLocalWorkingHoursInUTC(city, selectedDate);

                // City name label
                ctx.font = '14px Nunito, sans-serif';
                ctx.fillStyle = '#3d4423';
                ctx.textAlign = 'right';
                ctx.fillText(city.name, PADDING.left - 10, y + ROW_HEIGHT / 2 + 5);

                // UTC offset indicator
                ctx.font = '11px Nunito, sans-serif';
                ctx.fillStyle = '#8A9A5B';
                const offsetStr = offset >= 0 ? `+${offset}` : `${offset}`;
                ctx.fillText(`UTC${offsetStr}`, PADDING.left - 10, y + ROW_HEIGHT / 2 + 20);

                // Draw working hours bar
                ctx.fillStyle = city.color;
                const barHeight = ROW_HEIGHT - 16;
                const barY = y + 8;

                if (startUTC <= endUTC) {
                    // Normal case: working hours don't wrap around midnight
                    const x = PADDING.left + startUTC * hourWidth;
                    const barWidth = (endUTC - startUTC) * hourWidth;
                    ctx.beginPath();
                    ctx.roundRect(x, barY, barWidth, barHeight, 6);
                    ctx.fill();
                } else {
                    // Wrap-around case: working hours span midnight UTC
                    // Draw from startUTC to 24
                    const x1 = PADDING.left + startUTC * hourWidth;
                    const barWidth1 = (24 - startUTC) * hourWidth;
                    ctx.beginPath();
                    ctx.roundRect(x1, barY, barWidth1, barHeight, [6, 0, 0, 6]);
                    ctx.fill();

                    // Draw from 0 to endUTC
                    const x2 = PADDING.left;
                    const barWidth2 = endUTC * hourWidth;
                    ctx.beginPath();
                    ctx.roundRect(x2, barY, barWidth2, barHeight, [0, 6, 6, 0]);
                    ctx.fill();
                }

                // Draw row separator
                ctx.strokeStyle = 'rgba(96, 108, 56, 0.1)';
                ctx.beginPath();
                ctx.moveTo(PADDING.left, y + ROW_HEIGHT);
                ctx.lineTo(width - PADDING.right, y + ROW_HEIGHT);
                ctx.stroke();
            });

            // Draw current time indicator
            const now = new Date();
            const currentUTCHour = now.getUTCHours() + now.getUTCMinutes() / 60;
            const timeX = PADDING.left + currentUTCHour * hourWidth;

            ctx.strokeStyle = '#BC6C25';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(timeX, PADDING.top - 5);
            ctx.lineTo(timeX, PADDING.top + chartHeight + 5);
            ctx.stroke();
            ctx.setLineDash([]);

            // Current time marker triangle
            ctx.fillStyle = '#BC6C25';
            ctx.beginPath();
            ctx.moveTo(timeX, PADDING.top - 8);
            ctx.lineTo(timeX - 6, PADDING.top - 18);
            ctx.lineTo(timeX + 6, PADDING.top - 18);
            ctx.closePath();
            ctx.fill();

            // Update info panel
            updateInfoPanel(overlapHours, cityWorkingHours);
        }

        function updateInfoPanel(overlapHours, cityWorkingHours) {
            const now = new Date();
            const utcTime = now.toUTCString().slice(17, 22);
            document.getElementById('current-time').textContent =
                `Current UTC Time: ${utcTime}`;

            if (overlapHours.length > 0) {
                const ranges = getRangesFromHours(overlapHours);
                const rangeStr = ranges.map(r =>
                    `${r.start.toString().padStart(2, '0')}:00 - ${r.end.toString().padStart(2, '0')}:00 UTC`
                ).join(', ');

                document.getElementById('overlap-info').textContent =
                    `All 5 cities overlap for ${overlapHours.length} hour${overlapHours.length > 1 ? 's' : ''}`;
                document.getElementById('overlap-hours').textContent = rangeStr;
            } else {
                document.getElementById('overlap-info').textContent =
                    'No overlap period where all 5 cities are within working hours';
                document.getElementById('overlap-hours').textContent = '';
            }
        }

        function getRangesFromHours(hours) {
            if (hours.length === 0) return [];
            const sorted = [...hours].sort((a, b) => a - b);
            const ranges = [];
            let start = sorted[0];
            let end = sorted[0];

            for (let i = 1; i < sorted.length; i++) {
                if (sorted[i] === end + 1) {
                    end = sorted[i];
                } else {
                    ranges.push({ start, end: end + 1 });
                    start = sorted[i];
                    end = sorted[i];
                }
            }
            ranges.push({ start, end: end + 1 });
            return ranges;
        }

        function animate() {
            drawTimeline();
            animationId = requestAnimationFrame(animate);
        }

        function setDate(date) {
            selectedDate = date;
            document.getElementById('date-picker').value = date.toISOString().split('T')[0];
            updatePresetButtons();
        }

        function updatePresetButtons() {
            const dateStr = selectedDate.toISOString().split('T')[0];
            const today = new Date().toISOString().split('T')[0];
            const summer = `${selectedDate.getFullYear()}-07-15`;
            const winter = `${selectedDate.getFullYear()}-01-15`;

            document.querySelectorAll('.preset-btn').forEach(btn => {
                const preset = btn.dataset.date;
                if (preset === 'today' && dateStr === today) {
                    btn.classList.add('active');
                } else if (preset === 'summer' && dateStr === summer) {
                    btn.classList.add('active');
                } else if (preset === 'winter' && dateStr === winter) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // Event listeners
        document.getElementById('date-picker').addEventListener('change', (e) => {
            const parts = e.target.value.split('-');
            selectedDate = new Date(parts[0], parts[1] - 1, parts[2]);
            updatePresetButtons();
        });

        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const preset = btn.dataset.date;
                const year = new Date().getFullYear();
                if (preset === 'summer') {
                    setDate(new Date(year, 6, 15));
                } else if (preset === 'winter') {
                    setDate(new Date(year, 0, 15));
                } else {
                    setDate(new Date());
                }
            });
        });

        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                resizeCanvas();
            }, 150);
        });

        // Initialize
        function init() {
            resizeCanvas();
            setDate(new Date());

            document.getElementById('loading').classList.add('hidden');
            document.getElementById('main-content').style.opacity = '1';
            document.getElementById('main-content').style.transition = 'opacity 0.5s ease';

            animate();
        }

        // Polyfill for roundRect if not supported
        if (!ctx.roundRect) {
            ctx.roundRect = function(x, y, w, h, radii) {
                const r = Array.isArray(radii) ? radii : [radii, radii, radii, radii];
                this.beginPath();
                this.moveTo(x + r[0], y);
                this.lineTo(x + w - r[1], y);
                this.quadraticCurveTo(x + w, y, x + w, y + r[1]);
                this.lineTo(x + w, y + h - r[2]);
                this.quadraticCurveTo(x + w, y + h, x + w - r[2], y + h);
                this.lineTo(x + r[3], y + h);
                this.quadraticCurveTo(x, y + h, x, y + h - r[3]);
                this.lineTo(x, y + r[0]);
                this.quadraticCurveTo(x, y, x + r[0], y);
                this.closePath();
            };
        }

        // Expose for enhance.js keyboard shortcuts
        window.reset = function() { init(); };

        init();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
