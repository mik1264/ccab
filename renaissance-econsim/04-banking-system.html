<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Renaissance EconSim: Banking & Credit</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            color: #ecf0f1;
            overflow: hidden;
            height: 100vh;
            display: flex;
        }
        #sidebar {
            width: 350px;
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            overflow-y: auto;
        }
        h1 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #f39c12;
        }
        .controls {
            margin-bottom: 20px;
        }
        .control-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            color: #bdc3c7;
        }
        input[type="range"] {
            width: 100%;
        }
        button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            background: #f39c12;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #e67e22;
        }
        .stats {
            font-size: 12px;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            padding: 5px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }
        .bank-list {
            margin-top: 15px;
        }
        .bank-item {
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(243, 156, 18, 0.1);
            border-left: 3px solid #f39c12;
            border-radius: 3px;
            font-size: 11px;
        }
        .bank-name {
            font-weight: bold;
            color: #f39c12;
            margin-bottom: 5px;
        }
        .bank-metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
            color: #bdc3c7;
        }
        #main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }
        .chart-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-container {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
        }
        .chart-title {
            font-size: 14px;
            margin-bottom: 10px;
            color: #f39c12;
            text-align: center;
        }
        canvas {
            display: block;
            border-radius: 5px;
        }
        .info {
            font-size: 11px;
            color: #95a5a6;
            margin-top: 15px;
            line-height: 1.4;
        }
        .loan-viz {
            flex: 2;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <h1>Medici Banking System</h1>
        <div class="info">
            Simulating Renaissance banking innovations: double-entry bookkeeping, bills of exchange, and the evolution of modern finance.
        </div>

        <div class="controls">
            <button id="resetBtn">Reset Banking System</button>
            <button id="pauseBtn">Pause</button>

            <div class="control-group">
                <label>Base Interest Rate: <span id="interestDisplay">0.15</span></label>
                <input type="range" id="interestSlider" min="5" max="30" value="15">
            </div>

            <div class="control-group">
                <label>Default Risk: <span id="riskDisplay">0.05</span></label>
                <input type="range" id="riskSlider" min="1" max="20" value="5">
            </div>

            <div class="control-group">
                <label>Loan Demand: <span id="demandDisplay">5</span></label>
                <input type="range" id="demandSlider" min="1" max="10" value="5">
            </div>

            <div class="control-group">
                <label>Reserve Requirement: <span id="reserveDisplay">0.20</span></label>
                <input type="range" id="reserveSlider" min="10" max="50" value="20">
            </div>
        </div>

        <div class="stats">
            <h3 style="margin-bottom: 10px; color: #f39c12;">System Metrics</h3>
            <div class="stat-item">
                <span>Total Deposits:</span>
                <span id="totalDeposits">0</span>
            </div>
            <div class="stat-item">
                <span>Total Loans:</span>
                <span id="totalLoans">0</span>
            </div>
            <div class="stat-item">
                <span>Outstanding Debt:</span>
                <span id="outstandingDebt">0</span>
            </div>
            <div class="stat-item">
                <span>Default Rate:</span>
                <span id="defaultRate">0%</span>
            </div>
            <div class="stat-item">
                <span>System Profit:</span>
                <span id="systemProfit">0</span>
            </div>
            <div class="stat-item">
                <span>Credit Multiplier:</span>
                <span id="multiplier">0.0x</span>
            </div>
        </div>

        <div class="bank-list">
            <h3 style="margin-bottom: 10px; color: #f39c12;">Major Banks</h3>
            <div id="bankListContainer"></div>
        </div>
    </div>

    <div id="main-content">
        <div class="chart-row">
            <div class="chart-container">
                <div class="chart-title">Money Supply Over Time</div>
                <canvas id="moneyCanvas" width="400" height="200"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">Interest Rate vs Default Rate</div>
                <canvas id="rateCanvas" width="400" height="200"></canvas>
            </div>
        </div>

        <div class="loan-viz">
            <div class="chart-title">Active Loans Visualization</div>
            <canvas id="loanCanvas" width="1200" height="500"></canvas>
            <div class="info">
                Banks (gold circles) issue loans to borrowers (blue circles). Lines show active loans, color indicates risk level.
                Historical context: The Medici bank pioneered fractional reserve banking, issuing more in loans than they held in deposits.
            </div>
        </div>
    </div>

    <script>
        const moneyCanvas = document.getElementById('moneyCanvas');
        const rateCanvas = document.getElementById('rateCanvas');
        const loanCanvas = document.getElementById('loanCanvas');

        const moneyCtx = moneyCanvas.getContext('2d');
        const rateCtx = rateCanvas.getContext('2d');
        const loanCtx = loanCanvas.getContext('2d');

        let paused = false;
        let time = 0;

        const banks = [
            { name: 'Medici Bank', capital: 5000, loans: [], deposits: 3000, x: 200, y: 250 },
            { name: 'Peruzzi Bank', capital: 3000, loans: [], deposits: 2000, x: 400, y: 250 },
            { name: 'Bardi Bank', capital: 2500, loans: [], deposits: 1800, x: 600, y: 250 },
            { name: 'Strozzi Bank', capital: 2000, loans: [], deposits: 1500, x: 800, y: 250 },
            { name: 'Pazzi Bank', capital: 1800, loans: [], deposits: 1200, x: 1000, y: 250 }
        ];

        const borrowers = [];
        const moneyHistory = [];
        const interestHistory = [];
        const defaultHistory = [];

        class Borrower {
            constructor() {
                this.x = Math.random() * (loanCanvas.width - 100) + 50;
                this.y = 350 + Math.random() * 100;
                this.creditScore = 0.5 + Math.random() * 0.5;
                this.wealth = 100 + Math.random() * 500;
                this.loans = [];
            }

            canRepay() {
                const totalDebt = this.loans.reduce((sum, l) => sum + l.amount * (1 + l.rate), 0);
                return this.wealth > totalDebt;
            }
        }

        function initBorrowers() {
            borrowers.length = 0;
            for (let i = 0; i < 30; i++) {
                borrowers.push(new Borrower());
            }
        }

        function processLoans() {
            const baseRate = parseFloat(document.getElementById('interestSlider').value) / 100;
            const riskFactor = parseFloat(document.getElementById('riskSlider').value) / 100;
            const loanDemand = parseFloat(document.getElementById('demandSlider').value);
            const reserveReq = parseFloat(document.getElementById('reserveSlider').value) / 100;

            // New loan originations
            if (Math.random() < loanDemand / 20) {
                const bank = banks[Math.floor(Math.random() * banks.length)];
                const borrower = borrowers[Math.floor(Math.random() * borrowers.length)];

                const availableCapital = bank.capital * (1 - reserveReq);
                const loanAmount = Math.min(availableCapital * 0.2, 100 + Math.random() * 400);

                if (availableCapital > loanAmount) {
                    const rate = baseRate + (1 - borrower.creditScore) * 0.1;
                    const loan = {
                        amount: loanAmount,
                        rate: rate,
                        term: 50 + Math.floor(Math.random() * 100),
                        age: 0,
                        bank: bank,
                        borrower: borrower,
                        defaulted: false
                    };

                    bank.loans.push(loan);
                    borrower.loans.push(loan);
                    bank.capital -= loanAmount;
                    borrower.wealth += loanAmount;
                }
            }

            // Process existing loans
            let totalDefaults = 0;
            let totalLoans = 0;

            banks.forEach(bank => {
                bank.loans = bank.loans.filter(loan => {
                    loan.age++;
                    totalLoans++;

                    // Check for default
                    if (!loan.defaulted && Math.random() < riskFactor * (1 - loan.borrower.creditScore)) {
                        loan.defaulted = true;
                        totalDefaults++;
                        bank.capital -= loan.amount * 0.5; // Partial loss
                        return false;
                    }

                    // Loan maturity
                    if (loan.age >= loan.term) {
                        if (!loan.defaulted && loan.borrower.canRepay()) {
                            const payment = loan.amount * (1 + loan.rate);
                            bank.capital += payment;
                            bank.deposits += payment * 0.1;
                            loan.borrower.wealth -= payment;
                        }
                        return false;
                    }

                    // Interest payments
                    if (loan.age % 10 === 0 && !loan.defaulted) {
                        const interest = loan.amount * loan.rate * 0.1;
                        bank.capital += interest;
                        loan.borrower.wealth -= interest;
                    }

                    return true;
                });

                // Deposit growth
                bank.deposits += bank.deposits * 0.001;
                bank.capital += bank.deposits * 0.005;
            });

            // Track metrics
            const totalMoney = banks.reduce((sum, b) => sum + b.capital + b.deposits, 0);
            moneyHistory.push(totalMoney);
            interestHistory.push(baseRate);
            defaultHistory.push(totalLoans > 0 ? (totalDefaults / totalLoans) * 100 : 0);

            if (moneyHistory.length > 200) {
                moneyHistory.shift();
                interestHistory.shift();
                defaultHistory.shift();
            }
        }

        function updateStats() {
            const totalDeposits = banks.reduce((sum, b) => sum + b.deposits, 0);
            const totalLoans = banks.reduce((sum, b) => sum + b.loans.length, 0);
            const outstandingDebt = banks.reduce((sum, b) =>
                sum + b.loans.reduce((s, l) => s + l.amount, 0), 0);
            const systemProfit = banks.reduce((sum, b) => sum + b.capital, 0) - 14300; // Initial capital
            const multiplier = totalDeposits > 0 ? outstandingDebt / totalDeposits : 0;

            const recentDefaults = defaultHistory.slice(-10);
            const avgDefault = recentDefaults.length > 0
                ? recentDefaults.reduce((sum, d) => sum + d, 0) / recentDefaults.length
                : 0;

            document.getElementById('totalDeposits').textContent = totalDeposits.toFixed(0);
            document.getElementById('totalLoans').textContent = totalLoans;
            document.getElementById('outstandingDebt').textContent = outstandingDebt.toFixed(0);
            document.getElementById('defaultRate').textContent = avgDefault.toFixed(2) + '%';
            document.getElementById('systemProfit').textContent = systemProfit.toFixed(0);
            document.getElementById('multiplier').textContent = multiplier.toFixed(2) + 'x';

            // Update bank list
            const bankList = banks
                .sort((a, b) => b.capital - a.capital)
                .map(bank => `
                    <div class="bank-item">
                        <div class="bank-name">${bank.name}</div>
                        <div class="bank-metric">
                            <span>Capital:</span>
                            <span>${bank.capital.toFixed(0)} florins</span>
                        </div>
                        <div class="bank-metric">
                            <span>Deposits:</span>
                            <span>${bank.deposits.toFixed(0)} florins</span>
                        </div>
                        <div class="bank-metric">
                            <span>Active Loans:</span>
                            <span>${bank.loans.length}</span>
                        </div>
                    </div>
                `).join('');

            document.getElementById('bankListContainer').innerHTML = bankList;
        }

        function drawTimeSeries(canvas, ctx, history, color, label) {
            ctx.fillStyle = '#0a1612';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (history.length < 2) return;

            const chartW = canvas.width - 60;
            const chartH = canvas.height - 50;
            const maxVal = Math.max(...history, 1);
            const minVal = Math.min(...history, 0);
            const range = maxVal - minVal || 1;

            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.beginPath();

            history.forEach((val, i) => {
                const x = 40 + (i / (history.length - 1)) * chartW;
                const y = canvas.height - 30 - ((val - minVal) / range) * chartH;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });

            ctx.stroke();

            // Axes
            ctx.strokeStyle = '#ecf0f1';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(40, 20);
            ctx.lineTo(40, canvas.height - 30);
            ctx.lineTo(40 + chartW, canvas.height - 30);
            ctx.stroke();

            // Labels
            ctx.fillStyle = '#ecf0f1';
            ctx.font = '10px Arial';
            ctx.textAlign = 'right';
            ctx.fillText(maxVal.toFixed(0), 35, 25);
            ctx.fillText(minVal.toFixed(0), 35, canvas.height - 30);
        }

        function drawLoans() {
            loanCtx.fillStyle = '#0a1612';
            loanCtx.fillRect(0, 0, loanCanvas.width, loanCanvas.height);

            // Draw loan connections
            banks.forEach(bank => {
                bank.loans.forEach(loan => {
                    const risk = 1 - loan.borrower.creditScore;
                    const age = loan.age / loan.term;

                    loanCtx.strokeStyle = loan.defaulted
                        ? '#e74c3c'
                        : `rgba(52, 152, 219, ${0.3 + risk * 0.7})`;
                    loanCtx.lineWidth = 1 + loan.amount / 100;

                    loanCtx.beginPath();
                    loanCtx.moveTo(bank.x, bank.y);
                    loanCtx.lineTo(loan.borrower.x, loan.borrower.y);
                    loanCtx.stroke();
                });
            });

            // Draw banks
            banks.forEach(bank => {
                const size = 15 + bank.capital / 200;

                // Glow
                const gradient = loanCtx.createRadialGradient(bank.x, bank.y, 0, bank.x, bank.y, size * 2);
                gradient.addColorStop(0, 'rgba(243, 156, 18, 0.6)');
                gradient.addColorStop(1, 'rgba(243, 156, 18, 0)');
                loanCtx.fillStyle = gradient;
                loanCtx.fillRect(bank.x - size * 2, bank.y - size * 2, size * 4, size * 4);

                loanCtx.fillStyle = '#f39c12';
                loanCtx.beginPath();
                loanCtx.arc(bank.x, bank.y, size, 0, Math.PI * 2);
                loanCtx.fill();

                loanCtx.strokeStyle = '#ecf0f1';
                loanCtx.lineWidth = 2;
                loanCtx.stroke();

                loanCtx.fillStyle = '#ecf0f1';
                loanCtx.font = '11px Arial';
                loanCtx.textAlign = 'center';
                loanCtx.fillText(bank.name, bank.x, bank.y - size - 8);
            });

            // Draw borrowers
            borrowers.forEach(borrower => {
                const size = 5 + borrower.creditScore * 5;
                loanCtx.fillStyle = borrower.canRepay() ? '#3498db' : '#e74c3c';
                loanCtx.beginPath();
                loanCtx.arc(borrower.x, borrower.y, size, 0, Math.PI * 2);
                loanCtx.fill();

                // Borrower wealth increases over time
                borrower.wealth += 1 + Math.random() * 3;
            });
        }

        function animate() {
            if (!paused) {
                processLoans();

                if (time % 5 === 0) {
                    updateStats();
                    drawTimeSeries(moneyCanvas, moneyCtx, moneyHistory, '#27ae60', 'Money Supply');
                    drawTimeSeries(rateCanvas, rateCtx, defaultHistory, '#e74c3c', 'Default Rate');
                    drawLoans();
                }

                time++;
            }

            requestAnimationFrame(animate);
        }

        // Controls
        document.getElementById('resetBtn').addEventListener('click', () => {
            banks.forEach(bank => {
                bank.loans = [];
                bank.capital = [5000, 3000, 2500, 2000, 1800][banks.indexOf(bank)];
                bank.deposits = [3000, 2000, 1800, 1500, 1200][banks.indexOf(bank)];
            });
            initBorrowers();
            moneyHistory.length = 0;
            interestHistory.length = 0;
            defaultHistory.length = 0;
            time = 0;
        });

        document.getElementById('pauseBtn').addEventListener('click', (e) => {
            paused = !paused;
            e.target.textContent = paused ? 'Resume' : 'Pause';
        });

        document.getElementById('interestSlider').addEventListener('input', (e) => {
            document.getElementById('interestDisplay').textContent = (e.target.value / 100).toFixed(2);
        });

        document.getElementById('riskSlider').addEventListener('input', (e) => {
            document.getElementById('riskDisplay').textContent = (e.target.value / 100).toFixed(2);
        });

        document.getElementById('demandSlider').addEventListener('input', (e) => {
            document.getElementById('demandDisplay').textContent = e.target.value;
        });

        document.getElementById('reserveSlider').addEventListener('input', (e) => {
            document.getElementById('reserveDisplay').textContent = (e.target.value / 100).toFixed(2);
        });

        // Initialize
        initBorrowers();
        animate();
    </script>
</body>
</html>
