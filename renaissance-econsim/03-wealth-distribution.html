<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Renaissance EconSim: Wealth Distribution</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: #ecf0f1;
            overflow-x: hidden;
            padding: 20px;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: #3498db;
            font-size: 28px;
        }
        .subtitle {
            text-align: center;
            color: #95a5a6;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .controls {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            align-items: center;
        }
        .control-group {
            flex: 1;
            min-width: 200px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            color: #bdc3c7;
        }
        input[type="range"] {
            width: 100%;
        }
        button {
            padding: 12px 24px;
            background: #3498db;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #2980b9;
        }
        .charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-container {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
        }
        .chart-title {
            font-size: 16px;
            margin-bottom: 15px;
            color: #3498db;
            text-align: center;
        }
        canvas {
            display: block;
            margin: 0 auto;
            border-radius: 5px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-label {
            font-size: 12px;
            color: #95a5a6;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }
        .agent-view {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
        }
        .info-text {
            font-size: 11px;
            color: #95a5a6;
            line-height: 1.6;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Renaissance Wealth Distribution Simulator</h1>
        <div class="subtitle">Exploring economic inequality in Renaissance society through agent-based modeling</div>

        <div class="controls">
            <div class="control-group">
                <label>Population: <span id="popDisplay">100</span></label>
                <input type="range" id="popSlider" min="50" max="500" value="100">
            </div>
            <div class="control-group">
                <label>Tax Rate: <span id="taxDisplay">0.10</span></label>
                <input type="range" id="taxSlider" min="0" max="50" value="10">
            </div>
            <div class="control-group">
                <label>Inheritance Tax: <span id="inheritDisplay">0.20</span></label>
                <input type="range" id="inheritSlider" min="0" max="80" value="20">
            </div>
            <div class="control-group">
                <label>Trade Volatility: <span id="volatilityDisplay">0.15</span></label>
                <input type="range" id="volatilitySlider" min="1" max="50" value="15">
            </div>
            <div>
                <button id="resetBtn">Reset Simulation</button>
            </div>
            <div>
                <button id="pauseBtn">Pause</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Gini Coefficient</div>
                <div class="stat-value" id="giniValue">0.00</div>
                <div class="info-text">Measures inequality (0=equal, 1=unequal)</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Top 10% Wealth Share</div>
                <div class="stat-value" id="top10Value">0%</div>
                <div class="info-text">Wealth held by richest 10%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Median Wealth</div>
                <div class="stat-value" id="medianValue">0</div>
                <div class="info-text">Middle person's wealth</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Poverty Rate</div>
                <div class="stat-value" id="povertyValue">0%</div>
                <div class="info-text">% below 50 florins</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Wealth</div>
                <div class="stat-value" id="totalWealthValue">0</div>
                <div class="info-text">Sum of all wealth</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Simulation Time</div>
                <div class="stat-value" id="timeValue">0</div>
                <div class="info-text">Years elapsed</div>
            </div>
        </div>

        <div class="charts">
            <div class="chart-container">
                <div class="chart-title">Wealth Distribution Histogram</div>
                <canvas id="histogramCanvas" width="700" height="300"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">Lorenz Curve (Inequality Measure)</div>
                <canvas id="lorenzCanvas" width="700" height="300"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">Gini Coefficient Over Time</div>
                <canvas id="giniCanvas" width="700" height="300"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">Top 10% Wealth Share Trend</div>
                <canvas id="top10Canvas" width="700" height="300"></canvas>
            </div>
        </div>

        <div class="agent-view">
            <div class="chart-title">Agent Population Visualization</div>
            <canvas id="agentCanvas" width="1520" height="200"></canvas>
            <div class="info-text">
                Each circle represents a person. Size indicates wealth. Color: Red (merchants), Gold (bankers), Blue (artisans), Gray (peasants).
                Historical note: Renaissance society had extreme inequality - the Medici family controlled more wealth than entire city districts combined.
            </div>
        </div>
    </div>

    <script>
        const histogramCanvas = document.getElementById('histogramCanvas');
        const lorenzCanvas = document.getElementById('lorenzCanvas');
        const giniCanvas = document.getElementById('giniCanvas');
        const top10Canvas = document.getElementById('top10Canvas');
        const agentCanvas = document.getElementById('agentCanvas');

        const histCtx = histogramCanvas.getContext('2d');
        const lorenzCtx = lorenzCanvas.getContext('2d');
        const giniCtx = giniCanvas.getContext('2d');
        const top10Ctx = top10Canvas.getContext('2d');
        const agentCtx = agentCanvas.getContext('2d');

        let agents = [];
        let time = 0;
        let paused = false;
        let giniHistory = [];
        let top10History = [];

        const CLASSES = [
            { name: 'merchant', color: '#e74c3c', probability: 0.2 },
            { name: 'banker', color: '#f39c12', probability: 0.1 },
            { name: 'artisan', color: '#3498db', probability: 0.3 },
            { name: 'peasant', color: '#95a5a6', probability: 0.4 }
        ];

        function createAgent() {
            const rand = Math.random();
            let cumProb = 0;
            let agentClass = CLASSES[3];

            for (const cls of CLASSES) {
                cumProb += cls.probability;
                if (rand <= cumProb) {
                    agentClass = cls;
                    break;
                }
            }

            const baseWealth = {
                merchant: 100 + Math.random() * 200,
                banker: 150 + Math.random() * 300,
                artisan: 50 + Math.random() * 100,
                peasant: 10 + Math.random() * 40
            };

            return {
                class: agentClass.name,
                wealth: baseWealth[agentClass.name],
                age: Math.random() * 60
            };
        }

        function initAgents() {
            const population = parseInt(document.getElementById('popSlider').value);
            agents = [];
            for (let i = 0; i < population; i++) {
                agents.push(createAgent());
            }
            time = 0;
            giniHistory = [];
            top10History = [];
        }

        function calculateGini() {
            const sorted = agents.map(a => a.wealth).sort((a, b) => a - b);
            const n = sorted.length;
            let sum = 0;
            let weightedSum = 0;

            for (let i = 0; i < n; i++) {
                sum += sorted[i];
                weightedSum += (i + 1) * sorted[i];
            }

            if (sum === 0) return 0;
            return (2 * weightedSum) / (n * sum) - (n + 1) / n;
        }

        function calculateTop10Share() {
            const sorted = agents.map(a => a.wealth).sort((a, b) => b - a);
            const top10Count = Math.max(1, Math.floor(sorted.length * 0.1));
            const top10Wealth = sorted.slice(0, top10Count).reduce((sum, w) => sum + w, 0);
            const totalWealth = sorted.reduce((sum, w) => sum + w, 0);
            return totalWealth > 0 ? (top10Wealth / totalWealth) * 100 : 0;
        }

        function updateEconomy() {
            const taxRate = parseFloat(document.getElementById('taxSlider').value) / 100;
            const inheritTax = parseFloat(document.getElementById('inheritSlider').value) / 100;
            const volatility = parseFloat(document.getElementById('volatilitySlider').value) / 100;

            agents.forEach(agent => {
                // Economic activity based on class
                const baseGain = {
                    merchant: 5 + Math.random() * 10,
                    banker: 8 + Math.random() * 15,
                    artisan: 3 + Math.random() * 6,
                    peasant: 1 + Math.random() * 3
                };

                let gain = baseGain[agent.class];

                // Add volatility
                gain *= (1 + (Math.random() - 0.5) * volatility);

                // Apply taxes
                const tax = gain * taxRate;
                agent.wealth += (gain - tax);

                // Aging and inheritance
                agent.age += 0.1;
                if (agent.age > 70 && Math.random() < 0.05) {
                    const inheritedWealth = agent.wealth * (1 - inheritTax);
                    agent.wealth = baseGain[agent.class] * 10;
                    agent.age = 20 + Math.random() * 10;

                    // Wealth redistribution (simplified)
                    const heir = agents[Math.floor(Math.random() * agents.length)];
                    heir.wealth += inheritedWealth;
                }

                // Prevent negative wealth
                agent.wealth = Math.max(0, agent.wealth);
            });

            time++;
        }

        function drawHistogram() {
            const ctx = histCtx;
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, histogramCanvas.width, histogramCanvas.height);

            const bins = 20;
            const maxWealth = Math.max(...agents.map(a => a.wealth), 1);
            const binSize = maxWealth / bins;
            const counts = new Array(bins).fill(0);

            agents.forEach(agent => {
                const bin = Math.min(bins - 1, Math.floor(agent.wealth / binSize));
                counts[bin]++;
            });

            const maxCount = Math.max(...counts, 1);
            const barWidth = (histogramCanvas.width - 40) / bins;
            const chartHeight = histogramCanvas.height - 60;

            ctx.fillStyle = '#3498db';
            counts.forEach((count, i) => {
                const barHeight = (count / maxCount) * chartHeight;
                const x = 30 + i * barWidth;
                const y = histogramCanvas.height - 40 - barHeight;
                ctx.fillRect(x, y, barWidth - 2, barHeight);
            });

            // Axes
            ctx.strokeStyle = '#ecf0f1';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(30, histogramCanvas.height - 40);
            ctx.lineTo(histogramCanvas.width - 10, histogramCanvas.height - 40);
            ctx.moveTo(30, 20);
            ctx.lineTo(30, histogramCanvas.height - 40);
            ctx.stroke();

            // Labels
            ctx.fillStyle = '#ecf0f1';
            ctx.font = '11px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('0', 30, histogramCanvas.height - 25);
            ctx.fillText(maxWealth.toFixed(0), histogramCanvas.width - 10, histogramCanvas.height - 25);
            ctx.fillText('Wealth (florins)', histogramCanvas.width / 2, histogramCanvas.height - 5);

            ctx.save();
            ctx.translate(10, histogramCanvas.height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Population', 0, 0);
            ctx.restore();
        }

        function drawLorenzCurve() {
            const ctx = lorenzCtx;
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, lorenzCanvas.width, lorenzCanvas.height);

            const sorted = agents.map(a => a.wealth).sort((a, b) => a - b);
            const totalWealth = sorted.reduce((sum, w) => sum + w, 0);

            const chartW = lorenzCanvas.width - 60;
            const chartH = lorenzCanvas.height - 60;

            // Perfect equality line
            ctx.strokeStyle = '#95a5a6';
            ctx.setLineDash([5, 5]);
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(40, lorenzCanvas.height - 40);
            ctx.lineTo(40 + chartW, 20);
            ctx.stroke();
            ctx.setLineDash([]);

            // Lorenz curve
            ctx.strokeStyle = '#3498db';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(40, lorenzCanvas.height - 40);

            let cumWealth = 0;
            sorted.forEach((wealth, i) => {
                cumWealth += wealth;
                const x = 40 + (i / sorted.length) * chartW;
                const y = lorenzCanvas.height - 40 - (cumWealth / totalWealth) * chartH;
                ctx.lineTo(x, y);
            });

            ctx.stroke();

            // Axes
            ctx.strokeStyle = '#ecf0f1';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(40, 20);
            ctx.lineTo(40, lorenzCanvas.height - 40);
            ctx.lineTo(40 + chartW, lorenzCanvas.height - 40);
            ctx.stroke();

            // Labels
            ctx.fillStyle = '#ecf0f1';
            ctx.font = '11px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Cumulative % of Population', lorenzCanvas.width / 2, lorenzCanvas.height - 5);

            ctx.save();
            ctx.translate(10, lorenzCanvas.height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Cumulative % of Wealth', 0, 0);
            ctx.restore();
        }

        function drawTimeSeries(canvas, ctx, history, label, color) {
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (history.length < 2) return;

            const chartW = canvas.width - 60;
            const chartH = canvas.height - 60;
            const maxVal = Math.max(...history, 0.1);
            const minVal = Math.min(...history, 0);

            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.beginPath();

            history.forEach((val, i) => {
                const x = 40 + (i / (history.length - 1)) * chartW;
                const y = canvas.height - 40 - ((val - minVal) / (maxVal - minVal)) * chartH;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });

            ctx.stroke();

            // Axes
            ctx.strokeStyle = '#ecf0f1';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(40, 20);
            ctx.lineTo(40, canvas.height - 40);
            ctx.lineTo(40 + chartW, canvas.height - 40);
            ctx.stroke();

            // Labels
            ctx.fillStyle = '#ecf0f1';
            ctx.font = '11px Arial';
            ctx.textAlign = 'right';
            ctx.fillText(maxVal.toFixed(2), 35, 25);
            ctx.fillText(minVal.toFixed(2), 35, canvas.height - 40);
        }

        function drawAgents() {
            const ctx = agentCtx;
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, agentCanvas.width, agentCanvas.height);

            const sorted = [...agents].sort((a, b) => b.wealth - a.wealth);
            const maxWealth = Math.max(...agents.map(a => a.wealth), 1);

            const spacing = agentCanvas.width / agents.length;

            sorted.forEach((agent, i) => {
                const x = i * spacing + spacing / 2;
                const size = 3 + (agent.wealth / maxWealth) * 15;
                const y = agentCanvas.height / 2;

                const colors = {
                    merchant: '#e74c3c',
                    banker: '#f39c12',
                    artisan: '#3498db',
                    peasant: '#95a5a6'
                };

                ctx.fillStyle = colors[agent.class];
                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        function updateStats() {
            const gini = calculateGini();
            const top10 = calculateTop10Share();
            const sorted = agents.map(a => a.wealth).sort((a, b) => a - b);
            const median = sorted[Math.floor(sorted.length / 2)];
            const poverty = (agents.filter(a => a.wealth < 50).length / agents.length) * 100;
            const totalWealth = agents.reduce((sum, a) => sum + a.wealth, 0);

            document.getElementById('giniValue').textContent = gini.toFixed(3);
            document.getElementById('top10Value').textContent = top10.toFixed(1) + '%';
            document.getElementById('medianValue').textContent = median.toFixed(0);
            document.getElementById('povertyValue').textContent = poverty.toFixed(1) + '%';
            document.getElementById('totalWealthValue').textContent = totalWealth.toFixed(0);
            document.getElementById('timeValue').textContent = time;

            giniHistory.push(gini);
            top10History.push(top10);

            if (giniHistory.length > 200) giniHistory.shift();
            if (top10History.length > 200) top10History.shift();
        }

        function animate() {
            if (!paused) {
                updateEconomy();

                if (time % 5 === 0) {
                    updateStats();
                    drawHistogram();
                    drawLorenzCurve();
                    drawTimeSeries(giniCanvas, giniCtx, giniHistory, 'Gini', '#e74c3c');
                    drawTimeSeries(top10Canvas, top10Ctx, top10History, 'Top 10%', '#f39c12');
                    drawAgents();
                }
            }

            requestAnimationFrame(animate);
        }

        // Controls
        document.getElementById('resetBtn').addEventListener('click', initAgents);

        document.getElementById('pauseBtn').addEventListener('click', (e) => {
            paused = !paused;
            e.target.textContent = paused ? 'Resume' : 'Pause';
        });

        document.getElementById('popSlider').addEventListener('input', (e) => {
            document.getElementById('popDisplay').textContent = e.target.value;
        });

        document.getElementById('taxSlider').addEventListener('input', (e) => {
            document.getElementById('taxDisplay').textContent = (e.target.value / 100).toFixed(2);
        });

        document.getElementById('inheritSlider').addEventListener('input', (e) => {
            document.getElementById('inheritDisplay').textContent = (e.target.value / 100).toFixed(2);
        });

        document.getElementById('volatilitySlider').addEventListener('input', (e) => {
            document.getElementById('volatilityDisplay').textContent = (e.target.value / 100).toFixed(2);
        });

        window.reset = initAgents;
        // Initialize
        initAgents();
        animate();
    </script>
    <script src="../assets/js/enhance.js" defer></script>
</body>
</html>
