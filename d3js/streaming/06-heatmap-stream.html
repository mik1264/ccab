<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streaming Heatmap</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            overflow: hidden;
        }
        h1 {
            color: #00ff00;
            text-align: center;
            margin-bottom: 10px;
        }
        .info {
            color: #88ff88;
            text-align: center;
            margin-bottom: 20px;
        }
        svg {
            display: block;
            margin: 0 auto;
            background: #0a0a0a;
            border-radius: 10px;
            border: 2px solid #00ff00;
        }
        .cell {
            stroke: #1a1a1a;
            stroke-width: 1px;
        }
        .time-label {
            fill: #00ff00;
            font-size: 10px;
        }
        .service-label {
            fill: #00ff00;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <h1>Live Service Activity Monitor</h1>
    <p class="info">Real-time service request heatmap (lighter = more active)</p>
    <svg id="heatmap"></svg>

    <script>
        const margin = {top: 50, right: 50, bottom: 30, left: 100};
        const width = window.innerWidth - 40 - margin.left - margin.right;
        const height = window.innerHeight - 140 - margin.top - margin.bottom;

        const svg = d3.select("#heatmap")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        const services = [
            "API Gateway",
            "Auth Service",
            "Database",
            "Cache",
            "Message Queue",
            "File Storage",
            "Analytics",
            "Logging"
        ];

        const timeSlots = 60; // Show last 60 seconds
        const cellWidth = width / timeSlots;
        const cellHeight = height / services.length;

        let data = [];
        let currentTime = 0;

        // Initialize data
        for (let t = 0; t < timeSlots; t++) {
            for (let s = 0; s < services.length; s++) {
                data.push({
                    time: t,
                    service: s,
                    value: 0
                });
            }
        }

        const colorScale = d3.scaleSequential(d3.interpolateGreens)
            .domain([0, 100]);

        // Y axis labels
        svg.selectAll(".service-label")
            .data(services)
            .join("text")
            .attr("class", "service-label")
            .attr("x", -10)
            .attr("y", (d, i) => i * cellHeight + cellHeight / 2)
            .attr("dy", ".35em")
            .attr("text-anchor", "end")
            .text(d => d);

        function update() {
            currentTime++;

            // Shift data left
            data.forEach(d => {
                if (d.time > 0) {
                    d.time--;
                }
            });

            // Remove oldest column
            data = data.filter(d => d.time < timeSlots);

            // Add new column with random activity
            services.forEach((service, i) => {
                // Simulate varying activity levels
                let value = Math.random() * 100;

                // Some services are naturally busier
                if (i === 0 || i === 2) value *= 1.5; // API Gateway and Database

                // Add some correlation over time
                const prevValue = data.find(d => d.time === timeSlots - 1 && d.service === i)?.value || 0;
                value = value * 0.3 + prevValue * 0.7;

                data.push({
                    time: timeSlots - 1,
                    service: i,
                    value: Math.min(100, value)
                });
            });

            // Render cells
            const cells = svg.selectAll(".cell")
                .data(data, d => `${d.time}-${d.service}`);

            cells.exit().remove();

            cells.enter()
                .append("rect")
                .attr("class", "cell")
                .merge(cells)
                .transition()
                .duration(200)
                .attr("x", d => d.time * cellWidth)
                .attr("y", d => d.service * cellHeight)
                .attr("width", cellWidth)
                .attr("height", cellHeight)
                .attr("fill", d => colorScale(d.value));

            cells.append("title")
                .text(d => `${services[d.service]}\n${Math.round(d.value)} req/s`);

            // Update time labels (show every 10 seconds)
            svg.selectAll(".time-label").remove();
            svg.selectAll(".time-label")
                .data([0, 15, 30, 45])
                .join("text")
                .attr("class", "time-label")
                .attr("x", d => d * cellWidth)
                .attr("y", -5)
                .attr("text-anchor", "middle")
                .text(d => `-${timeSlots - d}s`);
        }

        // Add current time indicator
        svg.append("text")
            .attr("x", width - 30)
            .attr("y", -5)
            .attr("fill", "#00ff00")
            .attr("font-size", "10px")
            .attr("text-anchor", "end")
            .text("NOW");

        setInterval(update, 1000);
        update();
    </script>
    <script src="../../assets/js/enhance.js" defer></script>
</body>
</html>
